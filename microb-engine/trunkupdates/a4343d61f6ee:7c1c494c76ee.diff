diff -r a4343d61f6ee browser/app/profile/firefox.js
--- a/browser/app/profile/firefox.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/app/profile/firefox.js	Sat Nov 15 19:43:12 2008 -0500
@@ -215,16 +215,21 @@ pref("browser.urlbar.doubleClickSelectsA
 #endif
 pref("browser.urlbar.autoFill", false);
 pref("browser.urlbar.matchOnlyTyped", false);
 // 0: Match anywhere (e.g., middle of words)
 // 1: Match on word boundaries and then try matching anywhere
 // 2: Match only on word boundaries (e.g., after / or .)
 // 3: Match at the beginning of the url or title
 pref("browser.urlbar.matchBehavior", 1);
+// 0: Search nothing
+// 1: Search history (visited pages)
+// 2: Search bookmarks
+// 3: Search both history and bookmarks
+pref("browser.urlbar.search.sources", 3);
 pref("browser.urlbar.filter.javascript", true);
 
 // the maximum number of results to show in autocomplete when doing richResults
 pref("browser.urlbar.maxRichResults", 12);
 // Size of "chunks" affects the number of places to process between each search
 // timeout (ms). Too big and the UI will be unresponsive; too small and we'll
 // be waiting on the timeout too often without many results.
 pref("browser.urlbar.search.chunkSize", 1000);
diff -r a4343d61f6ee browser/base/content/aboutRobots-icon-rtl.png
Binary file browser/base/content/aboutRobots-icon-rtl.png has changed
diff -r a4343d61f6ee browser/base/content/browser-tabPreviews.js
--- a/browser/base/content/browser-tabPreviews.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/base/content/browser-tabPreviews.js	Sat Nov 15 19:43:12 2008 -0500
@@ -429,17 +429,19 @@ var ctrlTab = {
     this.selectedIndex = 0;
     this.page = 0;
     this.advanceSelected();
   },
 
   onKeyPress: function ctrlTab__onKeyPress(event) {
     var isOpen = this.isOpen;
 
-    if (isOpen && event.target == this.searchField)
+    if (isOpen &&
+        event.target == this.searchField &&
+        event.keyCode != event.DOM_VK_ESCAPE)
       return;
 
     if (isOpen) {
       event.preventDefault();
       event.stopPropagation();
     }
 
     switch (event.keyCode) {
@@ -610,38 +612,44 @@ var ctrlTab = {
           this.removeClosingTabFromUI(event.target);
         break;
       case "keypress":
         this.onKeyPress(event);
         break;
       case "keydown":
       case "keyup":
         if (event.target == this.searchField) {
-          if (event.keyCode == event.DOM_VK_RETURN ||
-              event.keyCode == event.DOM_VK_ESCAPE)
-            this.panel.focus();
+          if (event.keyCode == event.DOM_VK_RETURN) {
+            // If there's a pending search, kick it off now.
+            if (this.searchField._timer)
+              this.search();
+            this.selectThumbnail();
+          }
         } else {
           // Manually consume the events, as the panel is open but doesn't
           // necessarily have focus.
           event.stopPropagation();
           event.preventDefault();
         }
 
         if (!this.sticky &&
             event.type == "keyup" &&
             event.keyCode == event.DOM_VK_CONTROL)
           this.selectThumbnail();
         break;
       case "popupshown":
-        if (this.sticky)
+        if (this.sticky && event.target == this.panel)
           this.searchField.focus();
         break;
       case "popuphiding":
-        this.onPopupHiding();
+        if (event.target == this.panel)
+          this.onPopupHiding();
         break;
       case "popuphidden":
-        // Destroy the widget in order to prevent outdated content
-        // when re-opening the panel.
-        this.panel.hidden = true;
+        if (event.target == this.panel) {
+          // Destroy the widget in order to prevent outdated content
+          // when re-opening the panel.
+          this.panel.hidden = true;
+        }
         break;
     }
   }
 };
diff -r a4343d61f6ee browser/base/content/browser-tabPreviews.xml
--- a/browser/base/content/browser-tabPreviews.xml	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/base/content/browser-tabPreviews.xml	Sat Nov 15 19:43:12 2008 -0500
@@ -44,11 +44,18 @@
   <binding id="ctrlTab-thumbnail">
     <content align="center">
       <children/>
       <xul:label xbl:inherits="value=label,crop"/>
     </content>
     <handlers>
       <handler event="click" button="0" action="ctrlTab.selectThumbnail(this);"/>
       <handler event="click" button="1" action="gBrowser.removeTab(this._tab);"/>
+#ifdef XP_MACOSX
+# Control+click is a right click on OS X
+      <handler event="click" button="2"><![CDATA[
+        if (!ctrlTab.sticky)
+          ctrlTab.selectThumbnail(this);
+      ]]></handler>
+#endif
     </handlers>
   </binding>
 </bindings>
diff -r a4343d61f6ee browser/base/content/browser.js
--- a/browser/base/content/browser.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/base/content/browser.js	Sat Nov 15 19:43:12 2008 -0500
@@ -2089,16 +2089,21 @@ function losslessDecodeURI(aURI) {
                 //    a sequence that survived decodeURI, i.e. one for:
                 //    ';', '/', '?', ':', '@', '&', '=', '+', '$', ',', '#'
                 //    (RFC 3987 section 3.2)
                 // 2. Re-encode whitespace so that it doesn't get eaten away
                 //    by the location bar (bug 410726).
                 .replace(/%(?!3B|2F|3F|3A|40|26|3D|2B|24|2C|23)|[\r\n\t]/ig,
                          encodeURIComponent);
     } catch (e) {}
+
+  // Encode invisible characters (invisible control characters, soft hyphen,
+  // zero-width space, BOM, line separator, paragraph separator) (bug 452979)
+  value = value.replace(/[\v\x0c\x1c\x1d\x1e\x1f\u00ad\u200b\ufeff\u2028\u2029]/g,
+                        encodeURIComponent);
 
   // Encode bidirectional formatting characters.
   // (RFC 3987 sections 3.2 and 4.1 paragraph 6)
   value = value.replace(/[\u200e\u200f\u202a\u202b\u202c\u202d\u202e]/g,
                         encodeURIComponent);
   return value;
 }
 
@@ -6835,27 +6840,33 @@ let gPrivateBrowsingUI = {
         docElement.getAttribute("titlemodifier_privatebrowsing"));
       docElement.setAttribute("titledefault", "");
 #else
       docElement.setAttribute("title",
         docElement.getAttribute("title_privatebrowsing"));
       docElement.setAttribute("titlemodifier",
         docElement.getAttribute("titlemodifier_privatebrowsing"));
 #endif
+      docElement.setAttribute("browsingmode", "private");
     }
     else {
       // Disable the menu item in auto-start mode
       if (pbMenuItem)
         pbMenuItem.setAttribute("disabled", "true");
       document.getElementById("Tools:PrivateBrowsing")
               .setAttribute("disabled", "true");
     }
   },
 
   onExitPrivateBrowsing: function PBUI_onExitPrivateBrowsing() {
+    if (BrowserSearch.searchBar)
+      BrowserSearch.searchBar.textbox.reset();
+
+    gFindBar.getElement("findbar-textbox").reset();
+
     let pbMenuItem = document.getElementById("privateBrowsingItem");
     if (pbMenuItem)
       pbMenuItem.removeAttribute("checked");
 
     if (!this._privateBrowsingAutoStarted) {
       // Adjust the window's title
       let docElement = document.documentElement;
 #ifdef XP_MACOSX // see bug 411929 comment 38 for the reason behind this
@@ -6863,16 +6874,17 @@ let gPrivateBrowsingUI = {
       docElement.setAttribute("titledefault",
         docElement.getAttribute("titlemodifier_normal"));
 #else
       docElement.setAttribute("title",
         docElement.getAttribute("title_normal"));
       docElement.setAttribute("titlemodifier",
         docElement.getAttribute("titlemodifier_normal"));
 #endif
+      docElement.setAttribute("browsingmode", "normal");
     }
     else
       this._privateBrowsingAutoStarted = false;
   },
 
   toggleMode: function PBUI_toggleMode() {
     // prompt the users on entering the private mode, if needed
     if (!this.privateBrowsingEnabled)
diff -r a4343d61f6ee browser/base/content/browser.xul
--- a/browser/base/content/browser.xul	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/base/content/browser.xul	Sat Nov 15 19:43:12 2008 -0500
@@ -69,16 +69,17 @@
         title_normal="&mainWindow.title;"
         title_privatebrowsing="&mainWindowPrivateBrowsing.titlemodifier;"
         titlemodifier="&mainWindow.titlemodifier;"
         titlemodifier_normal="&mainWindow.titlemodifier;"
         titlemodifier_privatebrowsing="&mainWindowPrivateBrowsing.titlemodifier;"
         titlemenuseparator="&mainWindow.titlemodifiermenuseparator;"
         windowtype="navigator:browser"
         screenX="4" screenY="4"
+        browsingmode="normal"
         persist="screenX screenY width height sizemode"> 
 
 # All JS files which are not content (only) dependent that browser.xul
 # wishes to include *must* go into the global-scripts.inc file
 # so that they can be shared by macBrowserOverlay.xul.
 #include global-scripts.inc
 <script type="application/x-javascript" src="chrome://browser/content/nsContextMenu.js"/>
 
@@ -228,22 +229,17 @@
         </vbox>
       </hbox>
     </panel>
 
     <tooltip id="urlTooltip">
       <label crop="center" flex="1" class="tooltip-label"/>
     </tooltip>
 
-    <panel id="ctrlTab-panel" class="KUI-panel" hidden="true" norestorefocus="true"
-#ifdef XP_WIN
-# XXX bug 457997
-      noautohide="true"
-#endif
-    >
+    <panel id="ctrlTab-panel" class="KUI-panel" hidden="true" norestorefocus="true" ignorekeys="true">
       <hbox pack="center">
         <textbox id="ctrlTab-search"
                  type="search"
                  emptytext="&ctrlTab.search.emptyText;"
                  oncommand="ctrlTab.search();"
                  onfocus="ctrlTab.sticky = true;"/>
       </hbox>
       <hbox class="ctrlTab-row">
diff -r a4343d61f6ee browser/base/content/sanitize.xul
--- a/browser/base/content/sanitize.xul	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/base/content/sanitize.xul	Sat Nov 15 19:43:12 2008 -0500
@@ -97,33 +97,27 @@
           var itemArray = itemBranch.getChildList("", itemCount);
           itemArray.forEach(function (name) {
             cpdBranch.setBoolPref(name, itemBranch.getBoolPref(name));
           });
         },
         
         sanitize: function ()
         {
+          // Update pref values before handing off to the sanitizer (bug 453440)
+          this.updatePrefs();
           var s = new Sanitizer();
           s.ignoreTimespan = false;
           s.prefDomain = "privacy.cpd.";
-          var sanitizePreferences = document.getElementById("sanitizePreferences");
-          var preference, name;
-          for (var i = 0; i < sanitizePreferences.childNodes.length; ++i) {
-            preference = sanitizePreferences.childNodes[i];
-            if (preference.value) {
-              name = s.getNameFromPreference(preference.name);
-              try {
-                s.clearItem(name);
-              } catch(er) {
-                dump(er + " sanitizing " + name); 
-                // TODO: give user feedback about partially failed sanitization
-              }
-            }
+          try {
+            s.sanitize();
+          } catch (er) {
+            Components.utils.reportError("Exception during sanitize: " + er);
           }
+          return true;
         },
         
         onReadGeneric: function ()
         {
           var preferences = document.getElementById("sanitizePreferences");
           var found = false;
           for (var i = 0; i < preferences.childNodes.length; ++i) {
             var preference = preferences.childNodes[i];
@@ -163,16 +157,28 @@
           let downloads = document.getElementById("downloads-checkbox");
           let history = document.getElementById("history-checkbox");
           let s = new Sanitizer();
           downloads.disabled = history.checked ||
                                !s.canClearItem("downloads");
           if (history.checked)
             downloads.checked = true;
         },
+        
+        updatePrefs : function ()
+        {
+          var tsPref = document.getElementById("privacy.sanitize.timeSpan");
+          Sanitizer.prefs.setIntPref("timeSpan", tsPref.value);
+          var sanitizePreferences = document.getElementById("sanitizePreferences");
+          var prefs = sanitizePreferences.rootBranch;
+          for (var i = 0; i < sanitizePreferences.childNodes.length; ++i) {
+            var p = sanitizePreferences.childNodes[i];
+            prefs.setBoolPref(p.name, p.value);
+          }
+        }
       };
     ]]>
     </script>
 
     <preferences id="sanitizePreferences">
       <preference id="privacy.cpd.history"               name="privacy.cpd.history"               type="bool"/>
       <preference id="privacy.cpd.formdata"              name="privacy.cpd.formdata"              type="bool"/>
       <preference id="privacy.cpd.passwords"             name="privacy.cpd.passwords"             type="bool"/>
diff -r a4343d61f6ee browser/base/content/test/browser_ctrlTab.js
--- a/browser/base/content/test/browser_ctrlTab.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/base/content/test/browser_ctrlTab.js	Sat Nov 15 19:43:12 2008 -0500
@@ -86,22 +86,41 @@ function test() {
     EventUtils.synthesizeKey("f", { ctrlKey: true });
     is(document.activeElement, ctrlTab.searchField.inputField,
        "Ctrl+Tab -> Ctrl+F focuses the panel's search field");
 
     releaseCtrl();
     ok(isOpen(),
        "panel is sticky after focusing the search field and releasing the Ctrl key");
 
+    EventUtils.synthesizeKey("f", {});
+    EventUtils.synthesizeKey("o", {});
+    EventUtils.synthesizeKey("o", {});
+    is(ctrlTab.searchField.value, "foo",
+       "text entered into search field");
+
+    EventUtils.synthesizeKey("VK_RETURN", {});
+    ok(isOpen(),
+       "Enter key kicks pending search off; the panel stays open as there's no match");
+    is(ctrlTab.searchField.value, "foo",
+       "search field value persists after Enter pressed");
+
+    EventUtils.synthesizeKey("VK_ESCAPE", {});
+    is(ctrlTab.searchField.value, "",
+       "ESC key clears the search field");
+    ok(isOpen(),
+       "Clearing the search field with ESC keeps the panel open");
+
     // blur the search field
     EventUtils.synthesizeKey("VK_TAB", {});
     isnot(document.activeElement, ctrlTab.searchField.inputField,
           "Tab key blurs the panel's search field");
 
     // advance selection and close panel
+    EventUtils.synthesizeKey("VK_TAB", {});
     EventUtils.synthesizeKey("VK_TAB", {});
     EventUtils.synthesizeKey("VK_RETURN", {});
     ok(!isOpen(),
        "Enter key closes the panel");
     is(gBrowser.tabContainer.selectedIndex, 1,
        "Tab key advances the selection while the panel is sticky");
 
     gBrowser.removeCurrentTab();
diff -r a4343d61f6ee browser/build.mk
--- a/browser/build.mk	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/build.mk	Sat Nov 15 19:43:12 2008 -0500
@@ -61,16 +61,22 @@ install::
 	@$(MAKE) -C browser/installer install
 
 clean::
 	@$(MAKE) -C browser/installer clean
 
 distclean::
 	@$(MAKE) -C browser/installer distclean
 
+source-package::
+	@$(MAKE) -C browser/installer source-package
+
+upload::
+	@$(MAKE) -C browser/installer upload
+
 ifdef ENABLE_TESTS
 # Implemented in testing/testsuite-targets.mk
 
 # Browser tests live in a slightly different location, so we correct the path
 ifdef TEST_PATH
 BROWSER_TEST_PATH = --test-path=../browser/$(TEST_PATH)
 else
 BROWSER_TEST_PATH =
diff -r a4343d61f6ee browser/components/nsBrowserGlue.js
--- a/browser/components/nsBrowserGlue.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/components/nsBrowserGlue.js	Sat Nov 15 19:43:12 2008 -0500
@@ -17,16 +17,17 @@
 # Giorgio Maone
 # Portions created by the Initial Developer are Copyright (C) 2005
 # the Initial Developer. All Rights Reserved.
 #
 # Contributor(s):
 #   Giorgio Maone <g.maone@informaction.com>
 #   Seth Spitzer <sspitzer@mozilla.com>
 #   Asaf Romano <mano@mozilla.com>
+#   Marco Bonardo <mak77@bonardo.net>
 #
 # Alternatively, the contents of this file may be used under the terms of
 # either the GNU General Public License Version 2 or later (the "GPL"), or
 # the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
 # in which case the provisions of the GPL or the LGPL are applicable instead
 # of those above. If you wish to allow use of your version of this file only
 # under the terms of either the GPL or the LGPL, and not to allow others to
 # use your version of this file under the terms of the MPL, indicate your
@@ -122,16 +123,19 @@ BrowserGlue.prototype = {
           this._setPrefToSaveSession();
         }
         break;
       case "session-save":
         this._setPrefToSaveSession();
         subject.QueryInterface(Ci.nsISupportsPRBool);
         subject.data = true;
         break;
+      case "places-init-complete":
+        this._initPlaces();
+        break;
       case "idle":
         if (this.idleService.idleTime > BOOKMARKS_ARCHIVE_IDLE_TIME * 1000) {
           // Back up bookmarks.
           this._archiveBookmarks();
         }
         break;
     }
   }, 
@@ -146,16 +150,17 @@ BrowserGlue.prototype = {
     osvr.addObserver(this, "xpcom-shutdown", false);
     osvr.addObserver(this, "prefservice:after-app-defaults", false);
     osvr.addObserver(this, "final-ui-startup", false);
     osvr.addObserver(this, "sessionstore-windows-restored", false);
     osvr.addObserver(this, "browser:purge-session-history", false);
     osvr.addObserver(this, "quit-application-requested", false);
     osvr.addObserver(this, "quit-application-granted", false);
     osvr.addObserver(this, "session-save", false);
+    osvr.addObserver(this, "places-init-complete", false);
   },
 
   // cleanup (called on application shutdown)
   _dispose: function() 
   {
     // observer removal 
     const osvr = Cc['@mozilla.org/observer-service;1'].
                  getService(Ci.nsIObserverService);
@@ -163,16 +168,17 @@ BrowserGlue.prototype = {
     osvr.removeObserver(this, "xpcom-shutdown");
     osvr.removeObserver(this, "prefservice:after-app-defaults");
     osvr.removeObserver(this, "final-ui-startup");
     osvr.removeObserver(this, "sessionstore-windows-restored");
     osvr.removeObserver(this, "browser:purge-session-history");
     osvr.removeObserver(this, "quit-application-requested");
     osvr.removeObserver(this, "quit-application-granted");
     osvr.removeObserver(this, "session-save");
+    osvr.removeObserver(this, "places-init-complete");
   },
 
   _onAppDefaults: function()
   {
     // apply distribution customizations (prefs)
     // other customizations are applied in _onProfileStartup()
     var distro = new DistributionCustomizer();
     distro.applyPrefDefaults();
@@ -186,19 +192,16 @@ BrowserGlue.prototype = {
     var app = Cc["@mozilla.org/xre/app-info;1"].getService(Ci.nsIXULAppInfo).
               QueryInterface(Ci.nsIXULRuntime);
     if (app.inSafeMode) {
       var ww = Cc["@mozilla.org/embedcomp/window-watcher;1"].
                getService(Ci.nsIWindowWatcher);
       ww.openWindow(null, "chrome://browser/content/safeMode.xul", 
                     "_blank", "chrome,centerscreen,modal,resizable=no", null);
     }
-
-    // initialize Places
-    this._initPlaces();
 
     // apply distribution customizations
     // prefs are applied in _onAppDefaults()
     var distro = new DistributionCustomizer();
     distro.applyCustomizations();
 
     // handle any UI migration
     this._migrateUI();
@@ -421,17 +424,17 @@ BrowserGlue.prototype = {
                       accessKey: buttonAccessKey,
                       popup:     null,
                       callback: function(aNotificationBar, aButton) {
                         browser.selectedTab = browser.addTab("about:rights");
                       }
                     }
                   ];
 
-    // Set pref to indicate we've shown the notficiation.
+    // Set pref to indicate we've shown the notification.
     var currentVersion = this._prefs.getIntPref("browser.rights.version");
     this._prefs.setBoolPref("browser.rights." + currentVersion + ".shown", true);
 
     notifyBox.appendNotification(notifyText, "about-rights", null, notifyBox.PRIORITY_INFO_LOW, buttons);
   },
 
   // returns the (cached) Sanitizer constructor
   get Sanitizer() 
@@ -449,103 +452,126 @@ BrowserGlue.prototype = {
     if (!this._idleService)
       this._idleService = Cc["@mozilla.org/widget/idleservice;1"].
                           getService(Ci.nsIIdleService);
     return this._idleService;
   },
 
   /**
    * Initialize Places
-   * - imports the bookmarks html file if bookmarks datastore is empty
+   * - imports the bookmarks html file if bookmarks database is empty, try to
+   *   restore bookmarks from a JSON backup if the backend indicates that the
+   *   database was corrupt.
    *
-   * These prefs are set by the backend services upon creation (or recreation)
-   * of the Places db:
+   * These prefs can be set up by the frontend:
+   *
+   * WARNING: setting these preferences to true will overwite existing bookmarks
+   *
    * - browser.places.importBookmarksHTML
-   *   Set to false by the history service to indicate we need to re-import.
+   *   Set to true will import the bookmarks.html file from the profile folder.
    * - browser.places.smartBookmarksVersion
    *   Set during HTML import to indicate that Smart Bookmarks were created.
    *   Set to -1 to disable Smart Bookmarks creation.
    *   Set to 0 to restore current Smart Bookmarks.
-   *
-   * These prefs are set up by the frontend:
    * - browser.bookmarks.restore_default_bookmarks
    *   Set to true by safe-mode dialog to indicate we must restore default
    *   bookmarks.
    */
   _initPlaces: function bg__initPlaces() {
-    // we need to instantiate the history service before checking
-    // the browser.places.importBookmarksHTML pref, as
-    // nsNavHistory::ForceMigrateBookmarksDB() will set that pref
-    // if we need to force a migration (due to a schema change)
+    // We must instantiate the history service since it will tell us if we
+    // need to import or restore bookmarks due to first-run, corruption or
+    // forced migration (due to a major schema change).
     var histsvc = Cc["@mozilla.org/browser/nav-history-service;1"].
                   getService(Ci.nsINavHistoryService);
+    var databaseStatus = histsvc.databaseStatus;
 
-    var importBookmarks = false;
+    // If the database is corrupt or has been newly created we should
+    // import bookmarks.
+    var importBookmarks = databaseStatus != histsvc.DATABASE_STATUS_OK;
+
+    // Check if user or an extension has required to import bookmarks.html
+    var importBookmarksHTML = false;
+    try {
+      importBookmarksHTML =
+        this._prefs.getBoolPref("browser.places.importBookmarksHTML");
+      if (importBookmarksHTML)
+        importBookmarks = true;
+    } catch(ex) {}
+
+    // Check if Safe Mode or the user has required to restore bookmarks from
+    // default profile's bookmarks.html
     var restoreDefaultBookmarks = false;
     try {
-      restoreDefaultBookmarks = this._prefs.getBoolPref("browser.bookmarks.restore_default_bookmarks");
+      restoreDefaultBookmarks =
+        this._prefs.getBoolPref("browser.bookmarks.restore_default_bookmarks");
+      if (restoreDefaultBookmarks) {
+        // Ensure that we already have a bookmarks backup for today
+        this._archiveBookmarks();
+        importBookmarks = true;
+      }
     } catch(ex) {}
 
-    if (restoreDefaultBookmarks) {
-      // Ensure that we already have a bookmarks backup for today
-      this._archiveBookmarks();
-      // we will restore bookmarks from html
-      importBookmarks = true;
-    }
-    else {
-      try {
-        importBookmarks = this._prefs.getBoolPref("browser.places.importBookmarksHTML");
-      } catch(ex) {}
+    // If the user did not require to restore default bookmarks, or import
+    // from bookmarks.html, we will try to restore from JSON
+    if (importBookmarks && !restoreDefaultBookmarks && !importBookmarksHTML) {
+      // get latest JSON backup
+      Cu.import("resource://gre/modules/utils.js");
+      var bookmarksFile = PlacesUtils.getMostRecentBackup();
+      if (bookmarksFile && bookmarksFile.leafName.match("\.json$")) {
+        // restore from JSON backup
+        PlacesUtils.restoreBookmarksFromJSONFile(bookmarksFile);
+        importBookmarks = false;
+      }
+      else {
+        // No backup was available we will try to import from bookmarks.html
+        importBookmarks = true;
+      }
     }
 
     if (!importBookmarks) {
       // Call it here for Fx3 profiles created before the Places folder
       // has been added, otherwise it's called during import.
       this.ensurePlacesDefaultQueriesInitialized();
     }
     else {
-      // get latest backup
-      Cu.import("resource://gre/modules/utils.js");
-      var bookmarksFile = PlacesUtils.getMostRecentBackup();
+      // Create a new Organizer left pane folder root, the old will not be
+      // valid anymore.
+      this._prefs.setIntPref("browser.places.leftPaneFolderId", -1);
 
-      if (!restoreDefaultBookmarks &&
-          bookmarksFile && bookmarksFile.leafName.match("\.json$")) {
-        // restore a JSON backup
-        PlacesUtils.restoreBookmarksFromJSONFile(bookmarksFile);
+      // ensurePlacesDefaultQueriesInitialized() is called by import.
+      this._prefs.setIntPref("browser.places.smartBookmarksVersion", 0);
+
+      // Get bookmarks folder
+      var dirService = Cc["@mozilla.org/file/directory_service;1"].
+                       getService(Ci.nsIProperties);
+      var bookmarksFile = dirService.get("BMarks", Ci.nsILocalFile);
+
+      // User wants to restore default bookmarks
+      if (restoreDefaultBookmarks || !bookmarksFile.exists()) {
+        // get bookmarks.html file from default profile folder
+        bookmarksFile = dirService.get("profDef", Ci.nsILocalFile);
+        bookmarksFile.append("bookmarks.html");
       }
-      else {
-        // if there's no JSON backup or we are restoring default bookmarks
 
-        // ensurePlacesDefaultQueriesInitialized() is called by import.
-        this._prefs.setIntPref("browser.places.smartBookmarksVersion", 0);
+      // import the file
+      try {
+        var importer = Cc["@mozilla.org/browser/places/import-export-service;1"].
+                       getService(Ci.nsIPlacesImportExportService);
+        importer.importHTMLFromFile(bookmarksFile, true /* overwrite existing */);
+      } catch (err) {
+        // Report the error, but ignore it.
+        Cu.reportError(err);
+      }
 
-        var dirService = Cc["@mozilla.org/file/directory_service;1"].
-                         getService(Ci.nsIProperties);
-
-        var bookmarksFile = dirService.get("BMarks", Ci.nsILocalFile);
-        if (restoreDefaultBookmarks || !bookmarksFile.exists()) {
-          // get bookmarks.html file from default profile folder
-          bookmarksFile = dirService.get("profDef", Ci.nsILocalFile);
-          bookmarksFile.append("bookmarks.html");
-        }
-
-        // import the file
-        try {
-          var importer = Cc["@mozilla.org/browser/places/import-export-service;1"].
-                         getService(Ci.nsIPlacesImportExportService);
-          importer.importHTMLFromFile(bookmarksFile, true /* overwrite existing */);
-        } catch (err) {
-          // Report the error, but ignore it.
-          Cu.reportError(err);
-        }
+      // Reset preferences, so we won't try to import again at next run
+      if (importBookmarksHTML)
         this._prefs.setBoolPref("browser.places.importBookmarksHTML", false);
-        if (restoreDefaultBookmarks)
-          this._prefs.setBoolPref("browser.bookmarks.restore_default_bookmarks",
-                                 false);
-      }
+      if (restoreDefaultBookmarks)
+        this._prefs.setBoolPref("browser.bookmarks.restore_default_bookmarks",
+                                false);
     }
 
     // Initialize bookmark archiving on idle.
     // Once a day, either on idle or shutdown, bookmarks are backed up.
     this.idleService.addIdleObserver(this, BOOKMARKS_ARCHIVE_IDLE_TIME);
   },
 
   /**
@@ -918,21 +944,16 @@ GeolocationPrompt.prototype = {
       var browserBundle = bundleService.createBundle("chrome://browser/locale/browser.properties");
 
       var buttons = [{
         label: browserBundle.GetStringFromName("geolocation.exactLocation"),
         accessKey: browserBundle.GetStringFromName("geolocation.exactLocationKey"),
         callback: function() request.allow() ,
         },
         {
-        label: browserBundle.GetStringFromName("geolocation.neighborhoodLocation"),
-        accessKey: browserBundle.GetStringFromName("geolocation.neighborhoodLocationKey"),
-        callback: function() request.allowButFuzz() ,
-        },
-        {
         label: browserBundle.GetStringFromName("geolocation.nothingLocation"),
         accessKey: browserBundle.GetStringFromName("geolocation.nothingLocationKey"),
         callback: function() request.cancel() ,
         }];
       
       var message = browserBundle.formatStringFromName("geolocation.requestMessage",
                                                        [request.requestingURI.spec], 1);      
       notificationBox.appendNotification(message,
diff -r a4343d61f6ee browser/components/places/content/editBookmarkOverlay.js
--- a/browser/components/places/content/editBookmarkOverlay.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/components/places/content/editBookmarkOverlay.js	Sat Nov 15 19:43:12 2008 -0500
@@ -688,16 +688,17 @@ var gEditItemOverlay = {
     try {
       uri = PlacesUIUtils.createFixedURI(this._element("locationField").value);
     }
     catch(ex) { return; }
 
     if (!this._uri.equals(uri)) {
       var txn = PlacesUIUtils.ptm.editBookmarkURI(this._itemId, uri);
       PlacesUIUtils.ptm.doTransaction(txn);
+      this._uri = uri;
     }
   },
 
   onKeywordFieldBlur: function EIO_onKeywordFieldBlur() {
     var keyword = this._element("keywordField").value;
     if (keyword != PlacesUtils.bookmarks.getKeywordForBookmark(this._itemId)) {
       var txn = PlacesUIUtils.ptm.editBookmarkKeyword(this._itemId, keyword);
       PlacesUIUtils.ptm.doTransaction(txn);
diff -r a4343d61f6ee browser/components/places/content/editBookmarkOverlay.xul
--- a/browser/components/places/content/editBookmarkOverlay.xul	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/components/places/content/editBookmarkOverlay.xul	Sat Nov 15 19:43:12 2008 -0500
@@ -173,16 +173,17 @@
 
         <row align="center" id="editBMPanel_tagsRow">
           <label value="&editBookmarkOverlay.tags.label;"
                  accesskey="&editBookmarkOverlay.tags.accesskey;"
                  control="editBMPanel_tagsField"
                  observes="paneElementsBroadcaster"/>
           <textbox id="editBMPanel_tagsField"
                    type="autocomplete"
+                   class="padded"
                    autocompletesearch="places-tag-autocomplete" 
                    completedefaultindex="true"
                    tabscrolling="true"
                    showcommentcolumn="true"
                    onblur="gEditItemOverlay.onTagsFieldBlur();"
                    observes="paneElementsBroadcaster"
                    emptytext="&editBookmarkOverlay.tagsEmptyDesc.label;"/>
           <button id="editBMPanel_tagsSelectorExpander"
diff -r a4343d61f6ee browser/components/places/content/places.js
--- a/browser/components/places/content/places.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/components/places/content/places.js	Sat Nov 15 19:43:12 2008 -0500
@@ -410,38 +410,41 @@ var PlacesOrganizer = {
     var restorePopup = document.getElementById("fileRestorePopup");
 
     // remove existing menu items
     // last item is the restoreFromFile item
     while (restorePopup.childNodes.length > 1)
       restorePopup.removeChild(restorePopup.firstChild);
 
     // get list of files
+    var localizedFilename = PlacesUtils.getString("bookmarksArchiveFilename");
+    var localizedFilenamePrefix = localizedFilename.substr(0, localizedFilename.indexOf("-"));
     var fileList = [];
     var files = this.bookmarksBackupDir.directoryEntries;
     while (files.hasMoreElements()) {
       var f = files.getNext().QueryInterface(Ci.nsIFile);
-      if (!f.isHidden() && f.leafName.match(/^bookmarks-.+json$/))
+      var rx = new RegExp("^(bookmarks|" + localizedFilenamePrefix + ")-.+\.json");
+      if (!f.isHidden() && f.leafName.match(rx))
         fileList.push(f);
     }
 
     fileList.sort(function PO_fileList_compare(a, b) {
       return b.lastModifiedTime - a.lastModifiedTime;
     });
 
     if (fileList.length == 0)
       return;
 
     // populate menu
     for (var i = 0; i < fileList.length; i++) {
       var m = restorePopup.insertBefore
         (document.createElement("menuitem"),
          document.getElementById("restoreFromFile"));
-      var dateStr = fileList[i].leafName.replace("bookmarks-", "").
-        replace(/\.json$/, "");
+      var rx = new RegExp("^(bookmarks|" + localizedFilenamePrefix + ")-");
+      var dateStr = fileList[i].leafName.replace(rx, "").replace(/\.json$/, "");
       if (!dateStr.length)
         dateStr = fileList[i].leafName;
       m.setAttribute("label", dateStr);
       m.setAttribute("value", fileList[i].leafName);
       m.setAttribute("oncommand",
                      "PlacesOrganizer.onRestoreMenuItemClick(this);");
     }
     restorePopup.insertBefore(document.createElement("menuseparator"),
diff -r a4343d61f6ee browser/components/privatebrowsing/content/aboutPrivateBrowsing.xhtml
--- a/browser/components/privatebrowsing/content/aboutPrivateBrowsing.xhtml	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/components/privatebrowsing/content/aboutPrivateBrowsing.xhtml	Sat Nov 15 19:43:12 2008 -0500
@@ -48,16 +48,32 @@
 ]>
 
 <html xmlns="http://www.w3.org/1999/xhtml">
   <head>
     <title>&privatebrowsingpage.tabtitle;</title>
     <link rel="stylesheet" href="chrome://global/skin/netError.css" type="text/css" media="all"/>
     <link rel="stylesheet" href="chrome://browser/skin/aboutPrivateBrowsing.css" type="text/css" media="all"/>
     <link rel="icon" type="image/png" href="chrome://browser/skin/Privacy-16.png"/>
+    <script type="application/x-javascript;version=1.7"><![CDATA[
+      const Cc = Components.classes;
+      const Ci = Components.interfaces;
+
+      function openSanitizeDialog() {
+        let mainWindow = window.QueryInterface(Ci.nsIInterfaceRequestor)
+                               .getInterface(Ci.nsIWebNavigation)
+                               .QueryInterface(Ci.nsIDocShellTreeItem)
+                               .rootTreeItem
+                               .QueryInterface(Ci.nsIInterfaceRequestor)
+                               .getInterface(Ci.nsIDOMWindow); 
+        let browserGlue = Cc["@mozilla.org/browser/browserglue;1"].
+                          getService(Ci.nsIBrowserGlue);
+        browserGlue.sanitize(mainWindow || null);
+      }
+    ]]></script>
   </head>
 
   <body dir="&locale.dir;">
 
     <!-- PAGE CONTAINER (for styling purposes only) -->
     <div id="errorPageContainer">
     
       <!-- Error Title -->
@@ -73,27 +89,24 @@
           <p id="errorShortDescText">&privatebrowsingpage.issueDesc;</p>
         </div>
 
         <!-- Long Description (Note: See netError.dtd for used XHTML tags) -->
         <div id="errorLongDesc">
           <p>&privatebrowsingpage.longDesc;</p>
         </div>
 
-# XXX do not show the clear recent history section until bug 453440 is fixed
-#if 0
         <!-- Clear Recent History -->
         <div id="clearRecentHistoryDesc">
           <p>&privatebrowsingpage.clearRecentHistoryDesc;</p>
           <button xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
                   id="showClearRecentHistory" label="&privatebrowsingpage.recentHistory.label;"
                   accesskey="&privatebrowsingpage.recentHistory.accesskey;"
-                  disabled="true"/>
+                  oncommand="openSanitizeDialog();"/>
         </div>
-#endif
 
         <!-- Footer -->
         <div id="footerDesc">
           <p>&privatebrowsingpage.howToStopDesc;</p>
           <p id="enjoyDesc">&privatebrowsingpage.footerDesc;</p>
         </div>
       </div>
     </div>
diff -r a4343d61f6ee browser/components/privatebrowsing/src/nsPrivateBrowsingService.js
--- a/browser/components/privatebrowsing/src/nsPrivateBrowsingService.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/components/privatebrowsing/src/nsPrivateBrowsingService.js	Sat Nov 15 19:43:12 2008 -0500
@@ -35,26 +35,39 @@
 #
 # ***** END LICENSE BLOCK *****
 
 Components.utils.import("resource://gre/modules/XPCOMUtils.jsm");
 
 ////////////////////////////////////////////////////////////////////////////////
 //// Utilities
 
-String.prototype.endsWith = function endsWith(aString)
+/**
+ * Returns true if the string passed in is part of the root domain of the
+ * current string.  For example, if this is "www.mozilla.org", and we pass in
+ * "mozilla.org", this will return true.  It would return false the other way
+ * around.
+ */
+String.prototype.hasRootDomain = function hasRootDomain(aDomain)
 {
-  let index = this.indexOf(aString);
-  // If it is not found, we know it doesn't end with it.
+  let index = this.indexOf(aDomain);
+  // If aDomain is not found, we know we do not have it as a root domain.
   if (index == -1)
     return false;
 
-  // Otherwise, we end with the given string iff the index is aString.length
-  // subtracted from our length.
-  return index == (this.length - aString.length);
+  // If the strings are the same, we obviously have a match.
+  if (this == aDomain)
+    return true;
+
+  // Otherwise, we have aDomain as our root domain iff the index of aDomain is
+  // aDomain.length subtracted from our length and (since we do not have an
+  // exact match) the character before the index is a dot or slash.
+  let prevChar = this[index - 1];
+  return (index == (this.length - aDomain.length)) &&
+         (prevChar == "." || prevChar == "/");
 }
 
 ////////////////////////////////////////////////////////////////////////////////
 //// Constants
 
 const Cc = Components.classes;
 const Ci = Components.interfaces;
 const Cu = Components.utils;
@@ -323,29 +336,29 @@ PrivateBrowsingService.prototype = {
     }
 
     // Cookies
     let (cm = Cc["@mozilla.org/cookiemanager;1"].
               getService(Ci.nsICookieManager)) {
       let enumerator = cm.enumerator;
       while (enumerator.hasMoreElements()) {
         let cookie = enumerator.getNext().QueryInterface(Ci.nsICookie);
-        if (cookie.host.endsWith(aDomain))
+        if (cookie.host.hasRootDomain(aDomain))
           cm.remove(cookie.host, cookie.name, cookie.path, false);
       }
     }
 
     // Downloads
     let (dm = Cc["@mozilla.org/download-manager;1"].
               getService(Ci.nsIDownloadManager)) {
       // Active downloads
       let enumerator = dm.activeDownloads;
       while (enumerator.hasMoreElements()) {
         let dl = enumerator.getNext().QueryInterface(Ci.nsIDownload);
-        if (dl.source.host.endsWith(aDomain)) {
+        if (dl.source.host.hasRootDomain(aDomain)) {
           dm.cancelDownload(dl.id);
           dm.removeDownload(dl.id);
         }
       }
 
       // Completed downloads
       let db = dm.DBConnection;
       // NOTE: This is lossy, but we feel that it is OK to be lossy here and not
@@ -374,36 +387,41 @@ PrivateBrowsingService.prototype = {
                getService(Ci.nsIObserverService);
       os.notifyObservers(null, "download-manager-remove-download", null);
     }
 
     // Passwords
     let (lm = Cc["@mozilla.org/login-manager;1"].
               getService(Ci.nsILoginManager)) {
       // Clear all passwords for domain
-      let logins = lm.getAllLogins({});
-      for (let i = 0; i < logins.length; i++)
-        if (logins[i].hostname.endsWith(aDomain))
-          lm.removeLogin(logins[i]);
+      try {
+        let logins = lm.getAllLogins({});
+        for (let i = 0; i < logins.length; i++)
+          if (logins[i].hostname.hasRootDomain(aDomain))
+            lm.removeLogin(logins[i]);
+      }
+      // XXXehsan: is there a better way to do this rather than this
+      // hacky comparison?
+      catch (ex if ex == "User canceled Master Password entry") {}
 
       // Clear any "do not save for this site" for this domain
       let disabledHosts = lm.getAllDisabledHosts({});
       for (let i = 0; i < disabledHosts.length; i++)
-        if (disabledHosts[i].endsWith(aDomain))
+        if (disabledHosts[i].hasRootDomain(aDomain))
           lm.setLoginSavingEnabled(disabledHosts, true);
     }
 
     // Permissions
     let (pm = Cc["@mozilla.org/permissionmanager;1"].
               getService(Ci.nsIPermissionManager)) {
       // Enumerate all of the permissions, and if one matches, remove it
       let enumerator = pm.enumerator;
       while (enumerator.hasMoreElements()) {
         let perm = enumerator.getNext().QueryInterface(Ci.nsIPermission);
-        if (perm.host.endsWith(aDomain))
+        if (perm.host.hasRootDomain(aDomain))
           pm.remove(perm.host, perm.type);
       }
     }
 
     // Content Preferences
     let (cp = Cc["@mozilla.org/content-pref/service;1"].
               getService(Ci.nsIContentPrefService)) {
       let db = cp.DBConnection;
@@ -413,17 +431,18 @@ PrivateBrowsingService.prototype = {
         "SELECT name " +
         "FROM groups " +
         "WHERE name LIKE ?1 ESCAPE '/'"
       );
       let pattern = stmt.escapeStringForLIKE(aDomain, "/");
       stmt.bindStringParameter(0, "%" + pattern);
       try {
         while (stmt.executeStep())
-          names.push(stmt.getString(0));
+          if (stmt.getString(0).hasRootDomain(aDomain))
+            names.push(stmt.getString(0));
       }
       finally {
         stmt.finalize();
       }
 
       // Now, for each name we got back, remove all of its prefs.
       for (let i = 0; i < names.length; i++) {
         // The service only cares about the host of the URI, so we don't need a
diff -r a4343d61f6ee browser/components/privatebrowsing/test/browser/Makefile.in
--- a/browser/components/privatebrowsing/test/browser/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/components/privatebrowsing/test/browser/Makefile.in	Sat Nov 15 19:43:12 2008 -0500
@@ -41,16 +41,19 @@ VPATH		= @srcdir@
 VPATH		= @srcdir@
 relativesrcdir  = browser/components/privatebrowsing/test/browser
 
 include $(DEPTH)/config/autoconf.mk
 include $(topsrcdir)/config/rules.mk
 
 _BROWSER_TEST_FILES =  \
 		browser_console_clear.js \
+		browser_privatebrowsing_theming.js \
+		browser_privatebrowsing_searchbar.js \
+		browser_privatebrowsing_findbar.js \
 		$(NULL)
 
 ifeq (,$(filter mac cocoa,$(MOZ_WIDGET_TOOLKIT)))
 _BROWSER_TEST_FILES += browser_privatebrowsing_ui.js \
     $(NULL)
 endif
 
 libs:: $(_BROWSER_TEST_FILES)
diff -r a4343d61f6ee browser/components/privatebrowsing/test/browser/browser_privatebrowsing_findbar.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_findbar.js	Sat Nov 15 19:43:12 2008 -0500
@@ -0,0 +1,75 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Private Browsing Tests.
+ *
+ * The Initial Developer of the Original Code is
+ * Ehsan Akhgari.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Ehsan Akhgari <ehsan.akhgari@gmail.com> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either of the GNU General Public License Version 2 or later (the "GPL"),
+ * or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+// This test makes sure that the find bar is cleared when leaving the
+// private browsing mode.
+
+function test() {
+  // initialization
+  let prefBranch = Cc["@mozilla.org/preferences-service;1"].
+                   getService(Ci.nsIPrefBranch);
+  prefBranch.setBoolPref("browser.privatebrowsing.keep_current_session", true);
+  let pb = Cc["@mozilla.org/privatebrowsing;1"].
+           getService(Ci.nsIPrivateBrowsingService);
+
+  // fill in the find bar with something
+  const kTestSearchString = "privatebrowsing";
+  let findBox = gFindBar.getElement("findbar-textbox");
+  gFindBar.startFind(gFindBar.FIND_NORMAL);
+  for (let i = 0; i < kTestSearchString.length; ++ i)
+    EventUtils.synthesizeKey(kTestSearchString[i], {});
+
+  // enter private browsing mode
+  pb.privateBrowsingEnabled = true;
+
+  is(findBox.value, kTestSearchString,
+    "entering the private browsing mode should not clear the findbar");
+  ok(findBox.editor.transactionManager.numberOfUndoItems > 0,
+    "entering the private browsing mode should not reset the undo list of the findbar control");
+
+  // leave private browsing mode
+  pb.privateBrowsingEnabled = false;
+
+  is(findBox.value, "",
+    "leaving the private browsing mode should clear the findbar");
+  is(findBox.editor.transactionManager.numberOfUndoItems, 0,
+    "leaving the private browsing mode should reset the undo list of the findbar control");
+
+  // cleanup
+  prefBranch.clearUserPref("browser.privatebrowsing.keep_current_session");
+  gFindBar.close();
+}
diff -r a4343d61f6ee browser/components/privatebrowsing/test/browser/browser_privatebrowsing_searchbar.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_searchbar.js	Sat Nov 15 19:43:12 2008 -0500
@@ -0,0 +1,82 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Private Browsing Tests.
+ *
+ * The Initial Developer of the Original Code is
+ * Ehsan Akhgari.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Ehsan Akhgari <ehsan.akhgari@gmail.com> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either of the GNU General Public License Version 2 or later (the "GPL"),
+ * or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+// This test makes sure that the search bar is cleared when leaving the
+// private browsing mode.
+
+function test() {
+  // initialization
+  let prefBranch = Cc["@mozilla.org/preferences-service;1"].
+                   getService(Ci.nsIPrefBranch);
+  prefBranch.setBoolPref("browser.privatebrowsing.keep_current_session", true);
+  let pb = Cc["@mozilla.org/privatebrowsing;1"].
+           getService(Ci.nsIPrivateBrowsingService);
+
+  // fill in the search bar with something
+  const kTestSearchString = "privatebrowsing";
+  let searchBar = BrowserSearch.searchBar;
+  searchBar.value = kTestSearchString;
+
+  // enter private browsing mode
+  pb.privateBrowsingEnabled = true;
+
+  is(searchBar.value, kTestSearchString,
+    "entering the private browsing mode should not clear the search bar");
+  /*
+    XXXehsan: uncomment this code when bug 418874 is fixed.
+              can't use todo, because it would pass unexpectedly!
+
+  ok(searchBar.textbox.editor.transactionManager.numberOfUndoItems > 0,
+    "entering the private browsing mode should not reset the undo list of the searchbar control");
+  */
+
+  // leave private browsing mode
+  pb.privateBrowsingEnabled = false;
+
+  is(searchBar.value, "",
+    "leaving the private browsing mode should clear the search bar");
+  /*
+    XXXehsan: uncomment this code when bug 418874 is fixed.
+              can't use todo_is, because it would pass unexpectedly!
+
+  is(searchBar.textbox.editor.transactionManager.numberOfUndoItems, 0,
+    "leaving the private browsing mode should reset the undo list of the searchbar control");
+  */
+
+  // cleanup
+  prefBranch.clearUserPref("browser.privatebrowsing.keep_current_session");
+}
diff -r a4343d61f6ee browser/components/privatebrowsing/test/browser/browser_privatebrowsing_theming.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/browser/components/privatebrowsing/test/browser/browser_privatebrowsing_theming.js	Sat Nov 15 19:43:12 2008 -0500
@@ -0,0 +1,67 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Private Browsing Tests.
+ *
+ * The Initial Developer of the Original Code is
+ * Ehsan Akhgari.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Ehsan Akhgari <ehsan.akhgari@gmail.com> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either of the GNU General Public License Version 2 or later (the "GPL"),
+ * or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+// This test makes sure that browsingmode attribute of the window is correctly
+// switched with private browsing mode changes.
+
+function test() {
+  // initialization
+  let prefBranch = Cc["@mozilla.org/preferences-service;1"].
+                   getService(Ci.nsIPrefBranch);
+  prefBranch.setBoolPref("browser.privatebrowsing.keep_current_session", true);
+  let pb = Cc["@mozilla.org/privatebrowsing;1"].
+           getService(Ci.nsIPrivateBrowsingService);
+  let docRoot = document.documentElement;
+
+  is(docRoot.getAttribute("browsingmode"), "normal",
+    "browsingmode should be \"normal\" initially");
+
+  // enter private browsing mode
+  pb.privateBrowsingEnabled = true;
+
+  is(docRoot.getAttribute("browsingmode"), "private",
+    "browsingmode should be \"private\" inside the private browsing mode");
+
+  // leave private browsing mode
+  pb.privateBrowsingEnabled = false;
+
+  is(docRoot.getAttribute("browsingmode"), "normal",
+    "browsingmode should be \"normal\" outside the private browsing mode");
+
+  // cleanup
+  prefBranch.clearUserPref("browser.privatebrowsing.keep_current_session");
+}
diff -r a4343d61f6ee browser/components/privatebrowsing/test/unit/head_privatebrowsing.js
--- a/browser/components/privatebrowsing/test/unit/head_privatebrowsing.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/components/privatebrowsing/test/unit/head_privatebrowsing.js	Sat Nov 15 19:43:12 2008 -0500
@@ -40,14 +40,71 @@ const Cr = Components.results;
 const Cr = Components.results;
 const Cu = Components.utils;
 
 const kPrivateBrowsingNotification = "private-browsing";
 const kPrivateBrowsingCancelVoteNotification = "private-browsing-cancel-vote";
 const kEnter = "enter";
 const kExit = "exit";
 
+const NS_APP_USER_PROFILE_50_DIR = "ProfD";
+const NS_APP_HISTORY_50_FILE = "UHist";
+
 function LOG(aMsg) {
   aMsg = ("*** PRIVATEBROWSING TESTS: " + aMsg);
   Cc["@mozilla.org/consoleservice;1"].getService(Ci.nsIConsoleService).
                                       logStringMessage(aMsg);
   print(aMsg);
 }
+
+// If there's no location registered for the profile direcotry, register one now.
+var dirSvc = Cc["@mozilla.org/file/directory_service;1"].getService(Ci.nsIProperties);
+var profileDir = null;
+try {
+  profileDir = dirSvc.get(NS_APP_USER_PROFILE_50_DIR, Ci.nsIFile);
+} catch (e) {}
+if (!profileDir) {
+  // Register our own provider for the profile directory.
+  // It will simply return the current directory.
+  var provider = {
+    getFile: function(prop, persistent) {
+      persistent.value = true;
+      if (prop == NS_APP_USER_PROFILE_50_DIR) {
+        return dirSvc.get("CurProcD", Ci.nsIFile);
+      }
+      if (prop == NS_APP_HISTORY_50_FILE) {
+        var histFile = dirSvc.get("CurProcD", Ci.nsIFile);
+        histFile.append("history.dat");
+        return histFile;
+      }
+      throw Cr.NS_ERROR_FAILURE;
+    },
+    QueryInterface: function(iid) {
+      if (iid.equals(Ci.nsIDirectoryServiceProvider) ||
+          iid.equals(Ci.nsISupports)) {
+        return this;
+      }
+      throw Cr.NS_ERROR_NO_INTERFACE;
+    }
+  };
+  dirSvc.QueryInterface(Ci.nsIDirectoryService).registerProvider(provider);
+}
+
+/**
+ * Removes any files that could make our tests fail.
+ */
+function cleanUp()
+{
+  let files = [
+    "downloads.sqlite",
+    "places.sqlite",
+    "cookies.sqlite",
+    "signons.sqlite",
+  ];
+
+  for (let i = 0; i < files.length; i++) {
+    let file = dirSvc.get("ProfD", Ci.nsIFile);
+    file.append(files[i]);
+    if (file.exists())
+      file.remove(false);
+  }
+}
+cleanUp();
diff -r a4343d61f6ee browser/components/privatebrowsing/test/unit/test_privatebrowsing_exit.js
--- a/browser/components/privatebrowsing/test/unit/test_privatebrowsing_exit.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/components/privatebrowsing/test/unit/test_privatebrowsing_exit.js	Sat Nov 15 19:43:12 2008 -0500
@@ -39,18 +39,16 @@
 // shutdown.
 
 function run_test() {
   // initialization
   var os = Cc["@mozilla.org/observer-service;1"].
            getService(Ci.nsIObserverService);
   var pb = Cc["@mozilla.org/privatebrowsing;1"].
            getService(Ci.nsIPrivateBrowsingService);
-  var appStartup = Cc["@mozilla.org/toolkit/app-startup;1"].
-                   getService(Ci.nsIAppStartup);
   var prefBranch = Cc["@mozilla.org/preferences-service;1"].
                    getService(Ci.nsIPrefBranch);
   prefBranch.setBoolPref("browser.privatebrowsing.keep_current_session", true);
 
   var expectedQuitting;
   var called = 0;
   var observer = {
     observe: function(aSubject, aTopic, aData) {
@@ -87,13 +85,13 @@ function run_test() {
   // exit the private browsing mode
   expectedQuitting = false;
   pb.privateBrowsingEnabled = false;
   do_check_eq(called, 1);
 
   // enter the private browsing mode
   pb.privateBrowsingEnabled = true;
 
-  // exit and leave the test pending
+  // Simulate an exit
   expectedQuitting = true;
   do_test_pending();
-  appStartup.quit(Ci.nsIAppStartup.eForceQuit);
+  os.notifyObservers(null, "quit-application-granted", null);
 }
diff -r a4343d61f6ee browser/components/privatebrowsing/test/unit/test_removeDataFromDomain.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/browser/components/privatebrowsing/test/unit/test_removeDataFromDomain.js	Sat Nov 15 19:43:12 2008 -0500
@@ -0,0 +1,618 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-
+ * vim: sw=2 ts=2 sts=2
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Private Browsing Tests.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Shawn Wilsher <me@shawnwilsher.com> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either of the GNU General Public License Version 2 or later (the "GPL"),
+ * or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+/**
+ * Test added with bug 460086 to test the behavior of the new API that was added
+ * to remove all traces of visiting a site.
+ */
+
+////////////////////////////////////////////////////////////////////////////////
+//// Constants
+
+let pb = Cc["@mozilla.org/privatebrowsing;1"].
+         getService(Ci.nsIPrivateBrowsingService);
+
+const COOKIE_EXPIRY = Math.round(Date.now() / 1000) + 60;
+const COOKIE_NAME = "testcookie";
+const COOKIE_PATH = "/";
+
+const LOGIN_USERNAME = "username";
+const LOGIN_PASSWORD = "password";
+const LOGIN_USERNAME_FIELD = "username_field";
+const LOGIN_PASSWORD_FIELD = "password_field";
+
+const PERMISSION_TYPE = "test-perm";
+const PERMISSION_VALUE = Ci.nsIPermissionManager.ALLOW_ACTION;
+
+const PREFERENCE_NAME = "test-pref";
+
+////////////////////////////////////////////////////////////////////////////////
+//// Utility Functions
+
+/**
+ * Creates an nsIURI object for the given string representation of a URI.
+ *
+ * @param aURIString
+ *        The spec of the URI to create.
+ * @returns an nsIURI representing aURIString.
+ */
+function uri(aURIString)
+{
+  return Cc["@mozilla.org/network/io-service;1"].
+         getService(Ci.nsIIOService).
+         newURI(aURIString, null, null);
+}
+
+/**
+ * Adds a visit to history.
+ *
+ * @param aURI
+ *        The URI to add.
+ */
+function add_visit(aURI)
+{
+  check_visited(aURI, false);
+  let bh = Cc["@mozilla.org/browser/global-history;2"].
+           getService(Ci.nsIBrowserHistory);
+  bh.addPageWithDetails(aURI, aURI.spec, Date.now() * 1000);
+  check_visited(aURI, true);
+}
+
+/**
+ * Checks to ensure a URI string is visited or not.
+ *
+ * @param aURI
+ *        The URI to check.
+ * @param aIsVisited
+ *        True if the URI should be visited, false otherwise.
+ */
+function check_visited(aURI, aIsVisited)
+{
+  let gh = Cc["@mozilla.org/browser/global-history;2"].
+           getService(Ci.nsIGlobalHistory2);
+  let checker = aIsVisited ? do_check_true : do_check_false;
+  checker(gh.isVisited(aURI));
+}
+
+/**
+ * Add a cookie to the cookie service.
+ *
+ * @param aDomain
+ */
+function add_cookie(aDomain)
+{
+  check_cookie_exists(aDomain, false);
+  let cm = Cc["@mozilla.org/cookiemanager;1"].getService(Ci.nsICookieManager2);
+  cm.add(aDomain, COOKIE_PATH, COOKIE_NAME, "", false, false, false,
+         COOKIE_EXPIRY);
+  check_cookie_exists(aDomain, true);
+}
+
+/**
+ * Checks to ensure that a cookie exists or not for a domain.
+ *
+ * @param aDomain
+ *        The domain to check for the cookie.
+ * @param aExists
+ *        True if the cookie should exist, false otherwise.
+ */
+function check_cookie_exists(aDomain, aExists)
+{
+  let cm = Cc["@mozilla.org/cookiemanager;1"].getService(Ci.nsICookieManager2);
+  let cookie = {
+    host: aDomain,
+    name: COOKIE_NAME,
+    path: COOKIE_PATH
+  }
+  let checker = aExists ? do_check_true : do_check_false;
+  checker(cm.cookieExists(cookie));
+}
+
+/**
+ * Adds a download to download history.
+ *
+ * @param aURIString
+ *        The string of the URI to add.
+ * @param aIsActive
+ *        If it should be set to an active state in the database.  This does not
+ *        make it show up in the list of active downloads however!
+ */
+function add_download(aURIString, aIsActive)
+{
+  check_downloaded(aURIString, false);
+  let db = Cc["@mozilla.org/download-manager;1"].
+           getService(Ci.nsIDownloadManager).
+           DBConnection;
+  let stmt = db.createStatement(
+    "INSERT INTO moz_downloads (source, state) " +
+    "VALUES (:source, :state)"
+  );
+  stmt.params.source = aURIString;
+  stmt.params.state = aIsActive ? Ci.nsIDownloadManager.DOWNLOAD_DOWNLOADING :
+                                  Ci.nsIDownloadManager.DOWNLOAD_FINISHED;
+  try {
+    stmt.execute();
+  }
+  finally {
+    stmt.finalize();
+  }
+  check_downloaded(aURIString, true);
+}
+
+/**
+ * Checks to ensure a URI string is in download history or not.
+ *
+ * @param aURIString
+ *        The string of the URI to check.
+ * @param aIsDownloaded
+ *        True if the URI should be downloaded, false otherwise.
+ */
+function check_downloaded(aURIString, aIsDownloaded)
+{
+  let db = Cc["@mozilla.org/download-manager;1"].
+           getService(Ci.nsIDownloadManager).
+           DBConnection;
+  let stmt = db.createStatement(
+    "SELECT * " +
+    "FROM moz_downloads " +
+    "WHERE source = :source"
+  );
+  stmt.params.source = aURIString;
+
+  let checker = aIsDownloaded ? do_check_true : do_check_false;
+  try {
+    checker(stmt.step());
+  }
+  finally {
+    stmt.finalize();
+  }
+}
+
+/**
+ * Adds a disabled host to the login manager.
+ *
+ * @param aHost
+ *        The host to add to the list of disabled hosts.
+ */
+function add_disabled_host(aHost)
+{
+  check_disabled_host(aHost, false);
+  let lm = Cc["@mozilla.org/login-manager;1"].
+           getService(Ci.nsILoginManager);
+  lm.setLoginSavingEnabled(aHost, false);
+  check_disabled_host(aHost, true);
+}
+
+/**
+ * Checks to see if a host is disabled for storing logins or not.
+ *
+ * @param aHost
+ *        The host to check if it is disabled.
+ * @param aIsDisabled
+ *        True if the host should be disabled, false otherwise.
+ */
+function check_disabled_host(aHost, aIsDisabled)
+{
+  let lm = Cc["@mozilla.org/login-manager;1"].
+           getService(Ci.nsILoginManager);
+  let checker = aIsDisabled ? do_check_false : do_check_true;
+  checker(lm.getLoginSavingEnabled(aHost));
+}
+
+/**
+ * Adds a login for the specified host to the login manager.
+ *
+ * @param aHost
+ *        The host to add the login for.
+ */
+function add_login(aHost)
+{
+  check_login_exists(aHost, false);
+  let login = Cc["@mozilla.org/login-manager/loginInfo;1"].
+              createInstance(Ci.nsILoginInfo);
+  login.init(aHost, "", null, LOGIN_USERNAME, LOGIN_PASSWORD,
+             LOGIN_USERNAME_FIELD, LOGIN_PASSWORD_FIELD);
+  let lm = Cc["@mozilla.org/login-manager;1"].
+           getService(Ci.nsILoginManager);
+  lm.addLogin(login);
+  check_login_exists(aHost, true);
+}
+
+/**
+ * Checks to see if a login exists for a host.
+ *
+ * @param aHost
+ *        The host to check for the test login.
+ * @param aExists
+ *        True if the login should exist, false otherwise.
+ */
+function check_login_exists(aHost, aExists)
+{
+  let lm = Cc["@mozilla.org/login-manager;1"].
+           getService(Ci.nsILoginManager);
+  let count = { value: 0 };
+  lm.findLogins(count, aHost, "", null);
+  do_check_eq(count.value, aExists ? 1 : 0);
+}
+
+/**
+ * Adds a permission for the specified URI to the permission manager.
+ *
+ * @param aURI
+ *        The URI to add the test permission for.
+ */
+function add_permission(aURI)
+{
+  check_permission_exists(aURI, false);
+  let pm = Cc["@mozilla.org/permissionmanager;1"].
+           getService(Ci.nsIPermissionManager);
+  pm.add(aURI, PERMISSION_TYPE, PERMISSION_VALUE);
+  check_permission_exists(aURI, true);
+}
+
+/**
+ * Checks to see if a permission exists for the given URI.
+ *
+ * @param aURI
+ *        The URI to check if a permission exists.
+ * @param aExists
+ *        True if the permission should exist, false otherwise.
+ */
+function check_permission_exists(aURI, aExists)
+{
+  let pm = Cc["@mozilla.org/permissionmanager;1"].
+           getService(Ci.nsIPermissionManager);
+  let perm = pm.testExactPermission(aURI, PERMISSION_TYPE);
+  let checker = aExists ? do_check_eq : do_check_neq;
+  checker(perm, PERMISSION_VALUE);
+}
+
+/**
+ * Adds a content preference for the specified URI.
+ *
+ * @param aURI
+ *        The URI to add a preference for.
+ */
+function add_preference(aURI)
+{
+  check_preference_exists(aURI, false);
+  let cp = Cc["@mozilla.org/content-pref/service;1"].
+           getService(Ci.nsIContentPrefService);
+  cp.setPref(aURI, PREFERENCE_NAME, "foo");
+  check_preference_exists(aURI, true);
+}
+
+/**
+ * Checks to see if a preference exists for the given URI.
+ *
+ * @param aURI
+ *        The URI to check if a preference exists.
+ * @param aExists
+ *        True if the permission should exist, false otherwise.
+ */
+function check_preference_exists(aURI, aExists)
+{
+  let cp = Cc["@mozilla.org/content-pref/service;1"].
+           getService(Ci.nsIContentPrefService);
+  let checker = aExists ? do_check_true : do_check_false;
+  checker(cp.hasPref(aURI, PREFERENCE_NAME));
+}
+
+////////////////////////////////////////////////////////////////////////////////
+//// Test Functions
+
+// History
+function test_history_cleared_with_direct_match()
+{
+  const TEST_URI = uri("http://mozilla.org/foo");
+  add_visit(TEST_URI);
+  pb.removeDataFromDomain("mozilla.org");
+  check_visited(TEST_URI, false);
+}
+
+function test_history_cleared_with_subdomain()
+{
+  const TEST_URI = uri("http://www.mozilla.org/foo");
+  add_visit(TEST_URI);
+  pb.removeDataFromDomain("mozilla.org");
+  check_visited(TEST_URI, false);
+}
+
+function test_history_not_cleared_with_uri_contains_domain()
+{
+  const TEST_URI = uri("http://ilovemozilla.org/foo");
+  add_visit(TEST_URI);
+  pb.removeDataFromDomain("mozilla.org");
+  check_visited(TEST_URI, true);
+
+  // Clear history since we left something there from this test.
+  let bh = Cc["@mozilla.org/browser/global-history;2"].
+           getService(Ci.nsIBrowserHistory);
+  bh.removeAllPages();
+}
+
+// Cookie Service
+function test_cookie_cleared_with_direct_match()
+{
+  const TEST_DOMAIN = "mozilla.org";
+  add_cookie(TEST_DOMAIN);
+  pb.removeDataFromDomain("mozilla.org");
+  check_cookie_exists(TEST_DOMAIN, false);
+}
+
+function test_cookie_cleared_with_subdomain()
+{
+  const TEST_DOMAIN = "www.mozilla.org";
+  add_cookie(TEST_DOMAIN);
+  pb.removeDataFromDomain("mozilla.org");
+  check_cookie_exists(TEST_DOMAIN, false);
+}
+
+function test_cookie_not_cleared_with_uri_contains_domain()
+{
+  const TEST_DOMAIN = "ilovemozilla.org";
+  add_cookie(TEST_DOMAIN);
+  pb.removeDataFromDomain("mozilla.org");
+  check_cookie_exists(TEST_DOMAIN, true);
+}
+
+// Download Manager
+function test_download_history_cleared_with_direct_match()
+{
+  const TEST_URI = "http://mozilla.org/foo";
+  add_download(TEST_URI, false);
+  pb.removeDataFromDomain("mozilla.org");
+  check_downloaded(TEST_URI, false);
+}
+
+function test_download_history_cleared_with_subdomain()
+{
+  const TEST_URI = "http://www.mozilla.org/foo";
+  add_download(TEST_URI, false);
+  pb.removeDataFromDomain("mozilla.org");
+  check_downloaded(TEST_URI, false);
+}
+
+function test_download_history_not_cleared_with_active_direct_match()
+{
+  // Tests that downloads marked as active in the db are not deleted from the db
+  const TEST_URI = "http://mozilla.org/foo";
+  add_download(TEST_URI, true);
+  pb.removeDataFromDomain("mozilla.org");
+  check_downloaded(TEST_URI, true);
+
+  // Reset state
+  let db = Cc["@mozilla.org/download-manager;1"].
+           getService(Ci.nsIDownloadManager).
+           DBConnection;
+  db.executeSimpleSQL("DELETE FROM moz_downloads");
+  check_downloaded(TEST_URI, false);
+}
+
+// Login Manager
+function test_login_manager_disabled_hosts_cleared_with_direct_match()
+{
+  const TEST_HOST = "http://mozilla.org";
+  add_disabled_host(TEST_HOST);
+  pb.removeDataFromDomain("mozilla.org");
+  check_disabled_host(TEST_HOST, false);
+}
+
+function test_login_manager_disabled_hosts_cleared_with_subdomain()
+{
+  const TEST_HOST = "http://www.mozilla.org";
+  add_disabled_host(TEST_HOST);
+  pb.removeDataFromDomain("mozilla.org");
+  check_disabled_host(TEST_HOST, false);
+}
+
+function test_login_manager_disabled_hosts_not_cleared_with_uri_contains_domain()
+{
+  const TEST_HOST = "http://ilovemozilla.org";
+  add_disabled_host(TEST_HOST);
+  pb.removeDataFromDomain("mozilla.org");
+  check_disabled_host(TEST_HOST, true);
+
+  // Reset state
+  let lm = Cc["@mozilla.org/login-manager;1"].
+           getService(Ci.nsILoginManager);
+  lm.setLoginSavingEnabled(TEST_HOST, true);
+  check_disabled_host(TEST_HOST, false);
+}
+
+function test_login_manager_logins_cleared_with_direct_match()
+{
+  const TEST_HOST = "http://mozilla.org";
+  add_login(TEST_HOST);
+  pb.removeDataFromDomain("mozilla.org");
+  check_login_exists(TEST_HOST, false);
+}
+
+function test_login_manager_logins_cleared_with_subdomain()
+{
+  const TEST_HOST = "http://www.mozilla.org";
+  add_login(TEST_HOST);
+  pb.removeDataFromDomain("mozilla.org");
+  check_login_exists(TEST_HOST, false);
+}
+
+function tets_login_manager_logins_not_cleared_with_uri_contains_domain()
+{
+  const TEST_HOST = "http://ilovemozilla.org";
+  add_login(TEST_HOST);
+  pb.removeDataFromDomain("mozilla.org");
+  check_login_exists(TEST_HOST, true);
+
+  let lm = Cc["@mozilla.org/login-manager;1"].
+           getService(Ci.nsILoginManager);
+  lm.removeAllLogins();
+  check_login_exists(TEST_HOST, false);
+}
+
+// Permission Manager
+function test_permission_manager_cleared_with_direct_match()
+{
+  const TEST_URI = uri("http://mozilla.org");
+  add_permission(TEST_URI);
+  pb.removeDataFromDomain("mozilla.org");
+  check_permission_exists(TEST_URI, false);
+}
+
+function test_permission_manager_cleared_with_subdomain()
+{
+  const TEST_URI = uri("http://www.mozilla.org");
+  add_permission(TEST_URI);
+  pb.removeDataFromDomain("mozilla.org");
+  check_permission_exists(TEST_URI, false);
+}
+
+function test_permission_manager_not_cleared_with_uri_contains_domain()
+{
+  const TEST_URI = uri("http://ilovemozilla.org");
+  add_permission(TEST_URI);
+  pb.removeDataFromDomain("mozilla.org");
+  check_permission_exists(TEST_URI, true);
+
+  // Reset state
+  let pm = Cc["@mozilla.org/permissionmanager;1"].
+           getService(Ci.nsIPermissionManager);
+  pm.removeAll();
+  check_permission_exists(TEST_URI, false);
+}
+
+// Content Preferences
+function test_content_preferences_cleared_with_direct_match()
+{
+  const TEST_URI = uri("http://mozilla.org");
+  add_preference(TEST_URI);
+  pb.removeDataFromDomain("mozilla.org");
+  check_preference_exists(TEST_URI, false);
+}
+
+function test_content_preferences_cleared_with_subdomain()
+{
+  const TEST_URI = uri("http://www.mozilla.org");
+  add_preference(TEST_URI);
+  pb.removeDataFromDomain("mozilla.org");
+  check_preference_exists(TEST_URI, false);
+}
+
+function test_content_preferecnes_not_cleared_with_uri_contains_domain()
+{
+  const TEST_URI = uri("http://ilovemozilla.org");
+  add_preference(TEST_URI);
+  pb.removeDataFromDomain("mozilla.org");
+  check_preference_exists(TEST_URI, true);
+
+  // Reset state
+  let cp = Cc["@mozilla.org/content-pref/service;1"].
+           getService(Ci.nsIContentPrefService);
+  cp.removePref(TEST_URI, PREFERENCE_NAME);
+  check_preference_exists(TEST_URI, false);
+}
+
+// Cache
+function test_cache_cleared()
+{
+  // Because this test is asynchronous, it should be the last test
+  do_check_eq(tests[tests.length - 1], arguments.callee);
+
+  // NOTE: We could be more extensive with this test and actually add an entry
+  //       to the cache, and then make sure it is gone.  However, we trust that
+  //       the API is well tested, and that when we get the observer
+  //       notification, we have actually cleared the cache.
+  // This seems to happen asynchronously...
+  let os = Cc["@mozilla.org/observer-service;1"].
+           getService(Ci.nsIObserverService);
+  let observer = {
+    observe: function(aSubject, aTopic, aData)
+    {
+      os.removeObserver(observer, "cacheservice:empty-cache");
+      do_test_finished();
+    }
+  };
+  os.addObserver(observer, "cacheservice:empty-cache", false);
+  pb.removeDataFromDomain("mozilla.org");
+  do_test_pending();
+}
+
+let tests = [
+  // History
+  test_history_cleared_with_direct_match,
+  test_history_cleared_with_subdomain,
+  test_history_not_cleared_with_uri_contains_domain,
+
+  // Cookie Service
+  test_cookie_cleared_with_direct_match,
+  test_cookie_cleared_with_subdomain,
+  test_cookie_not_cleared_with_uri_contains_domain,
+
+  // Download Manager
+  // Note: active downloads tested in test_removeDataFromDomain_activeDownloads.js
+  test_download_history_cleared_with_direct_match,
+  test_download_history_cleared_with_subdomain,
+  test_download_history_not_cleared_with_active_direct_match,
+
+  // Login Manager
+  test_login_manager_disabled_hosts_cleared_with_direct_match,
+  test_login_manager_disabled_hosts_cleared_with_subdomain,
+  test_login_manager_disabled_hosts_not_cleared_with_uri_contains_domain,
+  test_login_manager_logins_cleared_with_direct_match,
+  test_login_manager_logins_cleared_with_subdomain,
+  tets_login_manager_logins_not_cleared_with_uri_contains_domain,
+
+  // Permission Manager
+  test_permission_manager_cleared_with_direct_match,
+  test_permission_manager_cleared_with_subdomain,
+  test_permission_manager_not_cleared_with_uri_contains_domain,
+
+  // Content Preferences
+  test_content_preferences_cleared_with_direct_match,
+  test_content_preferences_cleared_with_subdomain,
+  test_content_preferecnes_not_cleared_with_uri_contains_domain,
+
+  // Cache
+  test_cache_cleared,
+];
+
+function run_test()
+{
+  for (let i = 0; i < tests.length; i++)
+    tests[i]();
+}
diff -r a4343d61f6ee browser/components/privatebrowsing/test/unit/test_removeDataFromDomain_activeDownloads.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/browser/components/privatebrowsing/test/unit/test_removeDataFromDomain_activeDownloads.js	Sat Nov 15 19:43:12 2008 -0500
@@ -0,0 +1,158 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-
+ * vim: sw=2 ts=2 sts=2
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Private Browsing Tests.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Shawn Wilsher <me@shawnwilsher.com> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either of the GNU General Public License Version 2 or later (the "GPL"),
+ * or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+/**
+ * Test added with bug 460086 to test the behavior of the new API that was added
+ * to remove all traces of visiting a site.
+ */
+
+////////////////////////////////////////////////////////////////////////////////
+//// Constants
+
+let pb = Cc["@mozilla.org/privatebrowsing;1"].
+         getService(Ci.nsIPrivateBrowsingService);
+
+////////////////////////////////////////////////////////////////////////////////
+//// Utility Functions
+
+/**
+ * Creates an nsIURI object for the given file.
+ *
+ * @param aFile
+ *        The nsIFile of the URI to create.
+ * @returns an nsIURI representing aFile.
+ */
+function uri(aFile)
+{
+  return Cc["@mozilla.org/network/io-service;1"].
+         getService(Ci.nsIIOService).
+         newFileURI(aFile);
+}
+
+/**
+ * Checks to ensure a URI string is in download history or not.
+ *
+ * @param aURIString
+ *        The string of the URI to check.
+ * @param aIsActive
+ *        True if the URI should be actively downloaded, false otherwise.
+ */
+function check_active_download(aURIString, aIsActive)
+{
+  let dm = Cc["@mozilla.org/download-manager;1"].
+           getService(Ci.nsIDownloadManager);
+  let enumerator = dm.activeDownloads;
+  let found = false;
+  while (enumerator.hasMoreElements()) {
+    let dl = enumerator.getNext().QueryInterface(Ci.nsIDownload);
+    if (dl.source.spec == aURIString)
+      found = true;
+  }
+  let checker = aIsActive ? do_check_true : do_check_false;
+  checker(found);
+}
+
+////////////////////////////////////////////////////////////////////////////////
+//// Test Functions
+
+let destFile = dirSvc.get("TmpD", Ci.nsIFile);
+destFile.append("dm-test-file");
+destFile = uri(destFile);
+let data = [
+  { source: "http://mozilla.org/direct_match",
+    target: destFile.spec,
+    removed: true
+  },
+  { source: "http://www.mozilla.org/subdomain",
+    target: destFile.spec,
+    removed: true
+  },
+  { source: "http://ilovemozilla.org/contains_domain",
+    target: destFile.spec,
+    removed: false
+  },
+];
+
+function run_test()
+{
+  // We add this data to the database first, but we cannot instantiate the
+  // download manager service, otherwise these downloads will not be placed in
+  // the active downloads array.
+
+  // Copy the empty downloads database to our profile directory
+  let downloads = do_get_file("toolkit/components/downloads/test/downloads.empty.sqlite");
+  downloads.copyTo(dirSvc.get("ProfD", Ci.nsIFile), "downloads.sqlite");
+
+  // Open the database
+  let ss = Cc["@mozilla.org/storage/service;1"].
+           getService(Ci.mozIStorageService);
+  let file = dirSvc.get("ProfD", Ci.nsIFile);
+  file.append("downloads.sqlite");
+  let db = ss.openDatabase(file);
+
+  // Insert the data
+  let stmt = db.createStatement(
+    "INSERT INTO moz_downloads (source, target, state, autoResume, entityID) " +
+    "VALUES (:source, :target, :state, :autoResume, :entityID)"
+  );
+  for (let i = 0; i < data.length; i++) {
+    stmt.params.source = data[i].source;
+    stmt.params.target = data[i].target;
+    stmt.params.state = Ci.nsIDownloadManager.DOWNLOAD_PAUSED;
+    stmt.params.autoResume = 0; // DONT_RESUME is 0
+    stmt.params.entityID = "foo" // just has to be non-null for our test
+    stmt.execute();
+    stmt.reset();
+  }
+  stmt.finalize();
+  stmt = null;
+  db.close();
+  db = null;
+
+  // Check to make sure it's all there
+  for (let i = 0; i < data.length; i++)
+    check_active_download(data[i].source, true);
+
+  // Dispatch the remove call
+  pb.removeDataFromDomain("mozilla.org");
+
+  // And check our data
+  for (let i = 0; i < data.length; i++)
+    check_active_download(data[i].source, !data[i].removed);
+}
diff -r a4343d61f6ee browser/components/sessionstore/src/nsSessionStore.js
--- a/browser/components/sessionstore/src/nsSessionStore.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/components/sessionstore/src/nsSessionStore.js	Sat Nov 15 19:43:12 2008 -0500
@@ -339,16 +339,19 @@ SessionStoreService.prototype = {
       this._lastClosedWindows = null;
       this._clearDisk();
       // give the tabbrowsers a chance to clear their histories first
       var win = this._getMostRecentBrowserWindow();
       if (win)
         win.setTimeout(function() { _this.saveState(true); }, 0);
       else if (this._loadState == STATE_RUNNING)
         this.saveState(true);
+      // Delete the private browsing backed up state, if any
+      if ("_stateBackup" in this)
+        delete this._stateBackup;
       break;
     case "nsPref:changed": // catch pref changes
       switch (aData) {
       // if the user decreases the max number of closed tabs they want
       // preserved update our internal states to match that max
       case "sessionstore.max_tabs_undo":
         var ix;
         for (ix in this._windows) {
@@ -393,16 +396,18 @@ SessionStoreService.prototype = {
           // save the backed up state with session set to stopped,
           // otherwise resuming next time would look like a crash
           if ("_stateBackup" in this) {
             var oState = this._stateBackup;
             oState.session = { state: STATE_STOPPED_STR };
 
             this._saveStateObject(oState);
           }
+          // make sure to restore the non-private session upon resuming
+          this._prefBranch.setBoolPref("sessionstore.resume_session_once", true);
         }
         else
           this._inPrivateBrowsing = false;
         delete this._stateBackup;
         break;
       }
       break;
     }
@@ -480,29 +485,26 @@ SessionStoreService.prototype = {
       
       // restore a crashed session resp. resume the last session if requested
       if (this._initialState) {
         // make sure that the restored tabs are first in the window
         this._initialState._firstTabs = true;
         this._restoreCount = this._initialState.windows ? this._initialState.windows.length : 0;
         this.restoreWindow(aWindow, this._initialState, this._isCmdLineEmpty(aWindow));
         delete this._initialState;
-        
-        // mark ourselves as running
-        this.saveState(true);
       }
       else {
         // Nothing to restore, notify observers things are complete.
         var observerService = Cc["@mozilla.org/observer-service;1"].
                               getService(Ci.nsIObserverService);
         observerService.notifyObservers(null, NOTIFY_WINDOWS_RESTORED, "");
-        
-        // the next delayed save request should execute immediately
-        this._lastSaveTime -= this._interval;
       }
+      
+      // mark ourselves as running
+      this.saveState(true);
     }
     // this window was opened by _openWindowWithState
     else if (!this._isWindowLoaded(aWindow)) {
       let followUp = this._statesToRestore[aWindow.__SS_restoreID].windows.length == 1;
       this.restoreWindow(aWindow, this._statesToRestore[aWindow.__SS_restoreID], true, followUp);
     }
     
     var tabbrowser = aWindow.getBrowser();
@@ -1950,17 +1952,17 @@ SessionStoreService.prototype = {
     if (!aEvent || !aEvent.originalTarget || !aEvent.originalTarget.defaultView || aEvent.originalTarget.defaultView != aEvent.originalTarget.defaultView.top) {
       return;
     }
     
     // restore text data saved by Firefox 2.0/3.0
     var textArray = this.__SS_restore_text ? this.__SS_restore_text.split(" ") : [];
     function restoreTextData(aContent, aPrefix) {
       textArray.forEach(function(aEntry) {
-        if (/^((?:\d+\|)*)(#?)([^\s=]+)=(.*)$/.test(aEntry) && (!RegExp.$1 || RegExp.$1 == aPrefix)) {
+        if (/^((?:\d+\|)*)(#?)([^\s=]+)=(.*)$/.test(aEntry) && RegExp.$1 == aPrefix) {
           var document = aContent.document;
           var node = RegExp.$2 ? document.getElementById(RegExp.$3) : document.getElementsByName(RegExp.$3)[0] || null;
           if (node && "value" in node) {
             node.value = decodeURI(RegExp.$4);
             
             var event = document.createEvent("UIEvents");
             event.initUIEvent("input", true, true, aContent, 0);
             node.dispatchEvent(event);
@@ -2016,17 +2018,17 @@ SessionStoreService.prototype = {
       if (aData.scroll && /(\d+),(\d+)/.test(aData.scroll)) {
         aContent.scrollTo(RegExp.$1, RegExp.$2);
       }
       Array.forEach(aContent.document.styleSheets, function(aSS) {
         aSS.disabled = aSS.title && aSS.title != selectedPageStyle;
       });
       for (var i = 0; i < aContent.frames.length; i++) {
         if (aData.children && aData.children[i]) {
-          restoreTextDataAndScrolling(aContent.frames[i], aData.children[i], i + "|" + aPrefix);
+          restoreTextDataAndScrolling(aContent.frames[i], aData.children[i], aPrefix + i + "|");
         }
       }
     }
     
     // don't restore text data and scrolling state if the user has navigated
     // away before the loading completed (except for in-page navigation)
     if (!this.__SS_restore_data.url || this.currentURI.spec.replace(/#.*/, "") ==
                                        this.__SS_restore_data.url.replace(/#.*/, "")) {
diff -r a4343d61f6ee browser/components/sessionstore/test/browser/Makefile.in
--- a/browser/components/sessionstore/test/browser/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/components/sessionstore/test/browser/Makefile.in	Sat Nov 15 19:43:12 2008 -0500
@@ -58,12 +58,14 @@ _BROWSER_TEST_FILES = \
 	browser_393716.js \
 	browser_408470.js \
 	browser_408470_sample.html \
 	browser_448741.js \
 	browser_454908.js \
 	browser_454908_sample.html \
 	browser_456342.js \
 	browser_456342_sample.xhtml \
+	browser_463206.js \
+	browser_463206_sample.html \
 	$(NULL)
 
 libs:: $(_BROWSER_TEST_FILES)
 	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/browser/$(relativesrcdir)
diff -r a4343d61f6ee browser/components/sessionstore/test/browser/browser_248970_a.js
--- a/browser/components/sessionstore/test/browser/browser_248970_a.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/components/sessionstore/test/browser/browser_248970_a.js	Sat Nov 15 19:43:12 2008 -0500
@@ -40,16 +40,19 @@ function test() {
 
   // test setup
   waitForExplicitFinish();
 
   // private browsing service
   let pb = Cc["@mozilla.org/privatebrowsing;1"].
            getService(Ci.nsIPrivateBrowsingService);
   gPrefService.setBoolPref("browser.privatebrowsing.keep_current_session", true);
+  let profilePath = Cc["@mozilla.org/file/directory_service;1"].
+                    getService(Ci.nsIProperties).
+                    get("ProfD", Ci.nsIFile);
 
   function getSessionstorejsModificationTime() {
     // directory service
     let file = Cc["@mozilla.org/file/directory_service;1"].
                getService(Ci.nsIProperties).
                get("ProfD", Ci.nsIFile);
 
     // access sessionstore.js
@@ -60,43 +63,58 @@ function test() {
     else
       return -1;
   }
 
   // sessionstore service
   let ss = Cc["@mozilla.org/browser/sessionstore;1"].
            getService(Ci.nsISessionStore);
   let ss_interval = gPrefService.getIntPref("browser.sessionstore.interval");
-  let start_mod_time = getSessionstorejsModificationTime();
+  // Remove the sessionstore.js file before setting the interval to 0
+  let sessionStoreJS = profilePath.clone();
+  sessionStoreJS.append("sessionstore.js");
+  if (sessionStoreJS.exists())
+    sessionStoreJS.remove(false);
+  // Make sure that sessionstore.js can be forced to be created by setting
+  // the interval pref to 0
   gPrefService.setIntPref("browser.sessionstore.interval", 0);
-  isnot(start_mod_time, getSessionstorejsModificationTime(),
-    "sessionstore.js should be modified when setting the interval to 0");
+  // sessionstore.js should be re-created at this point
+  sessionStoreJS = profilePath.clone();
+  sessionStoreJS.append("sessionstore.js");
+  ok(sessionStoreJS.exists(),
+    "sessionstore.js should be re-created after setting the interval to 0");
 
   //////////////////////////////////////////////////////////////////
   // Test (A) : No data recording while in private browsing mode  //
   //////////////////////////////////////////////////////////////////
 
   // public session, add a new tab: (A)
   const testURL_A = "http://example.org/";
   let tab_A = gBrowser.addTab(testURL_A);
 
   tab_A.linkedBrowser.addEventListener("load", function (aEvent) {
     this.removeEventListener("load", arguments.callee, true);
 
-    let prePBModeTimeStamp = getSessionstorejsModificationTime();
+    // remove sessionstore.js to make sure it's created again when entering
+    // the private browsing mode.
+    let sessionStoreJS = profilePath.clone();
+    sessionStoreJS.append("sessionstore.js");
+    ok(sessionStoreJS.exists(),
+      "sessionstore.js should exist prior to entering the private browsing mode");
+    sessionStoreJS.remove(false);
+
     // enter private browsing mode
     pb.privateBrowsingEnabled = true;
     ok(pb.privateBrowsingEnabled, "private browsing enabled");
 
-    // sessionstore.js should be modified at this point
-    /* XXX this strangely fails!
-       TODO filed bug 462986
-    isnot(prePBModeTimeStamp, getSessionstorejsModificationTime(),
-      "sessionstore.js should be modified when entering the private browsing mode");
-    */
+    // sessionstore.js should be re-created at this point
+    sessionStoreJS = profilePath.clone();
+    sessionStoreJS.append("sessionstore.js");
+    ok(sessionStoreJS.exists(),
+      "sessionstore.js should be re-created after entering the private browsing mode");
 
     // record the time stamp of sessionstore.js in the private session
     let startPBModeTimeStamp = getSessionstorejsModificationTime();
 
     // private browsing session, add new tab: (B)
     const testURL_B = "http://test1.example.org/";
     let tab_B = gBrowser.addTab(testURL_B);
 
diff -r a4343d61f6ee browser/components/sessionstore/test/browser/browser_463206.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/browser/components/sessionstore/test/browser/browser_463206.js	Sat Nov 15 19:43:12 2008 -0500
@@ -0,0 +1,94 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is sessionstore test code.
+ *
+ * The Initial Developer of the Original Code is
+ * Simon Bünzli <zeniko@gmail.com>.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+function test() {
+  /** Test for Bug 463206 **/
+  
+  waitForExplicitFinish();
+  
+  let testURL = "http://localhost:8888/browser/" +
+    "browser/components/sessionstore/test/browser/browser_463206_sample.html";
+  
+  var frameCount = 0;
+  let tab = gBrowser.addTab(testURL);
+  tab.linkedBrowser.addEventListener("load", function(aEvent) {
+    // wait for all frames to load completely
+    if (frameCount++ < 5)
+      return;
+    this.removeEventListener("load", arguments.callee, true);
+    
+    function typeText(aTextField, aValue) {
+      aTextField.value = aValue;
+      
+      let event = aTextField.ownerDocument.createEvent("UIEvents");
+      event.initUIEvent("input", true, true, aTextField.ownerDocument.defaultView, 0);
+      aTextField.dispatchEvent(event);
+    }
+    
+    let doc = tab.linkedBrowser.contentDocument;
+    typeText(doc.getElementById("out1"), Date.now());
+    typeText(doc.getElementsByName("1|#out2")[0], Math.random());
+    typeText(doc.defaultView.frames[0].frames[1].document.getElementById("in1"), new Date());
+    
+    frameCount = 0;
+    let tab2 = gBrowser.duplicateTab(tab);
+    tab2.linkedBrowser.addEventListener("load", function(aEvent) {
+      // wait for all frames to load completely
+      if (frameCount++ < 5)
+        return;
+      
+      let doc = tab2.linkedBrowser.contentDocument;
+      let win = tab2.linkedBrowser.contentWindow;
+      isnot(doc.getElementById("out1").value,
+            win.frames[1].document.getElementById("out1").value,
+            "text isn't reused for frames");
+      isnot(doc.getElementsByName("1|#out2")[0].value, "",
+            "text containing | and # is correctly restored");
+      is(win.frames[1].document.getElementById("out2").value, "",
+            "id prefixes can't be faked");
+      isnot(win.frames[0].frames[1].document.getElementById("in1").value, "",
+            "id prefixes aren't mixed up");
+      is(win.frames[1].frames[0].document.getElementById("in1").value, "",
+            "id prefixes aren't mixed up");
+      
+      // clean up
+      gBrowser.removeTab(tab2);
+      gBrowser.removeTab(tab);
+      
+      finish();
+    }, true);
+  }, true);
+}
diff -r a4343d61f6ee browser/components/sessionstore/test/browser/browser_463206_sample.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/browser/components/sessionstore/test/browser/browser_463206_sample.html	Sat Nov 15 19:43:12 2008 -0500
@@ -0,0 +1,10 @@
+<!-- Testcase originally by <moz_bug_r_a4@yahoo.com> -->
+
+<!DOCTYPE html>
+<title>Test for bug 463206</title>
+
+<iframe src="data:text/html,<iframe></iframe><iframe%20src='data:text/html,<input%2520id=%2522in1%2522>'></iframe>"></iframe>
+<iframe src="data:text/html,<input%20id='out1'><input%20id='out2'><iframe%20src='data:text/html,<input%2520id=%2522in1%2522>'>"></iframe>
+
+<input id="out1">
+<input name="1|#out2">
diff -r a4343d61f6ee browser/fuel/test/Makefile.in
--- a/browser/fuel/test/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/fuel/test/Makefile.in	Sat Nov 15 19:43:12 2008 -0500
@@ -45,15 +45,16 @@ include $(topsrcdir)/config/rules.mk
 include $(topsrcdir)/config/rules.mk
 
 _BROWSER_FILES =browser_Application.js \
 		browser_ApplicationPrefs.js \
 		browser_ApplicationStorage.js \
 		browser_ApplicationQuitting.js \
 		browser_Browser.js \
 		browser_Bookmarks.js \
+		browser_Extensions.js \
 		ContentA.html \
 		ContentB.html \
 		ContentWithFrames.html \
 		$(NULL)
 
 libs::	$(_BROWSER_FILES)
 	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/browser/$(relativesrcdir)
diff -r a4343d61f6ee browser/fuel/test/browser_Application.js
--- a/browser/fuel/test/browser_Application.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/fuel/test/browser_Application.js	Sat Nov 15 19:43:12 2008 -0500
@@ -1,28 +1,86 @@ const Ci = Components.interfaces;
 const Ci = Components.interfaces;
 const Cc = Components.classes;
+
+// This listens for the next opened window and checks it is of the right url.
+// opencallback is called when the new window is fully loaded
+// closecallback is called when the window is closed
+function WindowOpenListener(url, opencallback, closecallback) {
+  this.url = url;
+  this.opencallback = opencallback;
+  this.closecallback = closecallback;
+
+  var wm = Cc["@mozilla.org/appshell/window-mediator;1"].
+           getService(Ci.nsIWindowMediator);
+  wm.addListener(this);
+}
+
+WindowOpenListener.prototype = {
+  url: null,
+  opencallback: null,
+  closecallback: null,
+  window: null,
+  domwindow: null,
+
+  handleEvent: function(event) {
+    is(this.domwindow.document.location.href, this.url, "Should have opened the correct window");
+
+    this.domwindow.removeEventListener("load", this, false);
+    // Allow any other load handlers to execute
+    var self = this;
+    executeSoon(function() { self.opencallback(self.domwindow); } );
+  },
+
+  onWindowTitleChange: function(window, title) {
+  },
+
+  onOpenWindow: function(window) {
+    if (this.window)
+      return;
+
+    this.window = window;
+    this.domwindow = window.QueryInterface(Ci.nsIInterfaceRequestor)
+                           .getInterface(Ci.nsIDOMWindowInternal);
+    this.domwindow.addEventListener("load", this, false);
+  },
+
+  onCloseWindow: function(window) {
+    if (this.window != window)
+      return;
+
+    var wm = Cc["@mozilla.org/appshell/window-mediator;1"].
+             getService(Ci.nsIWindowMediator);
+    wm.removeListener(this);
+    this.opencallback = null;
+    this.window = null;
+    this.domwindow = null;
+
+    // Let the window close complete
+    executeSoon(this.closecallback);
+    this.closecallback = null;
+  }
+};
 
 function test() {
   ok(Application, "Check global access to Application");
   
   // I'd test these against a specific value, but that is bound to flucuate
   ok(Application.id, "Check to see if an ID exists for the Application");
   ok(Application.name, "Check to see if a name exists for the Application");
   ok(Application.version, "Check to see if a version exists for the Application");
   
   var wMediator = Cc["@mozilla.org/appshell/window-mediator;1"].getService(Ci.nsIWindowMediator);
   var console = wMediator.getMostRecentWindow("global:console");
   waitForExplicitFinish();
-  if (!console) {
-    Application.console.open();
-  }
-  setTimeout(checkConsole, 500);
+  ok(!console, "Console should not already be open");
+
+  new WindowOpenListener("chrome://global/content/console.xul", consoleOpened, consoleClosed);
+  Application.console.open();
 }
 
-function checkConsole() {
-  var wMediator = Cc["@mozilla.org/appshell/window-mediator;1"].getService(Ci.nsIWindowMediator);
-  var console = wMediator.getMostRecentWindow("global:console");
-  ok(console, "Check to see if the console window opened");
-  if (console)
-    console.close();
+function consoleOpened(win) {
+  win.close();
+}
+
+function consoleClosed() {
   finish();
 }
diff -r a4343d61f6ee browser/fuel/test/browser_Browser.js
--- a/browser/fuel/test/browser_Browser.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/fuel/test/browser_Browser.js	Sat Nov 15 19:43:12 2008 -0500
@@ -1,99 +1,132 @@ const Ci = Components.interfaces;
 const Ci = Components.interfaces;
 const Cc = Components.classes;
 
 function url(spec) {
   var ios = Cc["@mozilla.org/network/io-service;1"].getService(Ci.nsIIOService);
   return ios.newURI(spec, null, null);
 }
+
+var gPageA = null;
+var gPageB = null;
 
 var gTabOpenCount = 0;
 var gTabCloseCount = 0;
 var gTabMoveCount = 0;
 var gPageLoadCount = 0;
 
 function test() {
   var windows = Application.windows;
   ok(windows, "Check access to browser windows");
   ok(windows.length, "There should be at least one browser window open");
 
   var activeWin = Application.activeWindow;
   activeWin.events.addListener("TabOpen", onTabOpen);
   activeWin.events.addListener("TabClose", onTabClose);
   activeWin.events.addListener("TabMove", onTabMove);
 
-  var pageA = activeWin.open(url("chrome://mochikit/content/browser/browser/fuel/test/ContentA.html"));
-  var pageB = activeWin.open(url("chrome://mochikit/content/browser/browser/fuel/test/ContentB.html"));
-  pageB.focus();
+  gPageA = activeWin.open(url("chrome://mochikit/content/browser/browser/fuel/test/ContentA.html"));
+  gPageA.events.addListener("load", onPageAFirstLoad);
 
-  is(activeWin.tabs.length, 3, "Checking length of 'Browser.tabs' after opening 2 additional tabs");
-  is(activeWin.activeTab.index, pageB.index, "Checking 'Browser.activeTab' after setting focus");
+  is(activeWin.tabs.length, 2, "Checking length of 'Browser.tabs' after opening 1 additional tab");
 
   waitForExplicitFinish();
-  setTimeout(afterOpen, 1000);
+
+  function onPageAFirstLoad(event) {
+    gPageA.events.removeListener("load", onPageAFirstLoad);
+
+    gPageB = activeWin.open(url("chrome://mochikit/content/browser/browser/fuel/test/ContentB.html"));
+    gPageB.events.addListener("load", function() {
+      executeSoon(afterOpen);
+    });
+    gPageB.focus();
+
+    is(activeWin.tabs.length, 3, "Checking length of 'Browser.tabs' after opening a second additional tab");
+    is(activeWin.activeTab.index, gPageB.index, "Checking 'Browser.activeTab' after setting focus");
+  }
 
   // need to wait for the url's to be refreshed during the load
-  function afterOpen() {
-    is(pageA.uri.spec, "chrome://mochikit/content/browser/browser/fuel/test/ContentA.html", "Checking 'BrowserTab.uri' after opening");
-    is(pageB.uri.spec, "chrome://mochikit/content/browser/browser/fuel/test/ContentB.html", "Checking 'BrowserTab.uri' after opening");
+  function afterOpen(event) {
+    gPageB.events.removeListener("load", afterOpen);
+
+    is(gPageA.uri.spec, "chrome://mochikit/content/browser/browser/fuel/test/ContentA.html", "Checking 'BrowserTab.uri' after opening");
+    is(gPageB.uri.spec, "chrome://mochikit/content/browser/browser/fuel/test/ContentB.html", "Checking 'BrowserTab.uri' after opening");
 
     // check event
     is(gTabOpenCount, 2, "Checking event handler for tab open");
 
     // test document access
-    var test1 = pageA.document.getElementById("test1");
+    var test1 = gPageA.document.getElementById("test1");
     ok(test1, "Checking existence of element in content DOM");
     is(test1.innerHTML, "A", "Checking content of element in content DOM");
 
     // test moving tab
-    pageA.moveToEnd();
-    is(pageA.index, 2, "Checking index after moving tab");
+    gPageA.moveToEnd();
+    is(gPageA.index, 2, "Checking index after moving tab");
 
     // check event
     is(gTabMoveCount, 1, "Checking event handler for tab move");
 
-    // test loading new content into a tab
-    // the event will be checked in onPageLoad
-    pageA.events.addListener("load", onPageLoad);
-    pageA.load(pageB.uri);
+    let browser = gBrowser.getBrowserAtIndex(gPageB.index);
+    browser.addProgressListener({
+      onStateChange: function(webProgress, request, stateFlags, status) {
+        const complete = Ci.nsIWebProgressListener.STATE_IS_WINDOW +
+                         Ci.nsIWebProgressListener.STATE_IS_NETWORK +
+                         Ci.nsIWebProgressListener.STATE_STOP;
+        if ((stateFlags & complete) == complete) {
+          browser.removeProgressListener(this);
+          onPageBLoadComplete();
+        }
+      },
+
+      QueryInterface: function(iid) {
+        if (iid.equals(Ci.nsISupportsWeakReference) ||
+           iid.equals(Ci.nsIWebProgressListener) ||
+           iid.equals(Ci.nsISupports))
+           return this;
+
+        throw Components.results.NS_ERROR_NO_INTERFACE;
+      }
+    });
 
     // test loading new content with a frame into a tab
     // the event will be checked in afterClose
-    pageB.events.addListener("load", onPageLoadWithFrames);
-    pageB.load(url("chrome://mochikit/content/browser/browser/fuel/test/ContentWithFrames.html"));
+    gPageB.events.addListener("load", onPageBLoadWithFrames);
+    gPageB.load(url("chrome://mochikit/content/browser/browser/fuel/test/ContentWithFrames.html"));
   }
 
-  function onPageLoad(event) {
-    is(pageA.uri.spec, "chrome://mochikit/content/browser/browser/fuel/test/ContentB.html", "Checking 'BrowserTab.uri' after loading new content");
+  function onPageBLoadWithFrames(event) {
+    gPageLoadCount++;
+  }
+
+  function onPageBLoadComplete() {
+    gPageB.events.removeListener("load", onPageBLoadWithFrames);
+    // check page load with frame event
+    is(gPageLoadCount, 1, "Checking load count after loading new content with a frame");
+
+    // test loading new content into a tab
+    // the event will be checked in onPageLoad
+    gPageA.events.addListener("load", onPageASecondLoad);
+    gPageA.load(url("chrome://mochikit/content/browser/browser/fuel/test/ContentB.html"));
+  }
+
+  function onPageASecondLoad(event) {
+    gPageA.events.removeListener("load", onPageASecondLoad);
+    is(gPageA.uri.spec, "chrome://mochikit/content/browser/browser/fuel/test/ContentB.html", "Checking 'BrowserTab.uri' after loading new content");
 
     // start testing closing tabs
     // the event will be checked in afterClose
-    // use a setTimeout so the pageloadwithframes
+    // use executeSoon so the onPageASecondLoad
     // has a chance to finish first
-    setTimeout(function() {
-      pageA.close();
-      pageB.close();
-      setTimeout(afterClose, 1000);
-     }, 1000);
-  }
+    gPageA.close();
+    gPageB.close();
 
-  function onPageLoadWithFrames(event) {
-    gPageLoadCount++;
-  }
-  
-  function afterClose() {
-    // check close event
-    is(gTabCloseCount, 2, "Checking event handler for tab close");
-
-    // check page load with frame event
-    is(gPageLoadCount, 1, "Checking 'BrowserTab.uri' after loading new content with a frame");
-
+    is(gTabCloseCount, 2, "Checking that tabs closed");
     is(activeWin.tabs.length, 1, "Checking length of 'Browser.tabs' after closing 2 tabs");
-
     finish();
   }
 }
 
 function onTabOpen(event) {
   gTabOpenCount++;
 }
 
diff -r a4343d61f6ee browser/installer/unix/packages-static
--- a/browser/installer/unix/packages-static	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/installer/unix/packages-static	Sat Nov 15 19:43:12 2008 -0500
@@ -152,17 +152,16 @@ bin/components/necko.xpt
 #ifdef MOZ_OJI
 bin/components/oji.xpt
 #endif
 bin/components/loginmgr.xpt
 bin/components/places.xpt
 bin/components/plugin.xpt
 bin/components/prefetch.xpt
 bin/components/pref.xpt
-bin/components/privatebrowsing.xpt
 bin/components/proxyObjInst.xpt
 bin/components/toolkitremote.xpt
 bin/components/rdf.xpt
 bin/components/satchel.xpt
 bin/components/saxparser.xpt
 bin/components/shistory.xpt
 bin/components/spellchecker.xpt
 bin/components/storage.xpt
diff -r a4343d61f6ee browser/installer/windows/packages-static
--- a/browser/installer/windows/packages-static	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/installer/windows/packages-static	Sat Nov 15 19:43:12 2008 -0500
@@ -158,17 +158,16 @@ bin\components\necko_viewsource.xpt
 #ifdef MOZ_OJI
 bin\components\oji.xpt
 #endif
 bin\components\loginmgr.xpt
 bin\components\places.xpt
 bin\components\plugin.xpt
 bin\components\pref.xpt
 bin\components\prefetch.xpt
-bin\components\privatebrowsing.xpt
 bin\components\profile.xpt
 bin\components\proxyObject.xpt
 bin\components\rdf.xpt
 bin\components\satchel.xpt
 bin\components\saxparser.xpt
 bin\components\shistory.xpt
 bin\components\storage.xpt
 bin\components\toolkitprofile.xpt
diff -r a4343d61f6ee browser/locales/Makefile.in
--- a/browser/locales/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/locales/Makefile.in	Sat Nov 15 19:43:12 2008 -0500
@@ -72,23 +72,29 @@ endif
 
 AB = $(firstword $(subst -, ,$(AB_CD)))
 
 APP_VERSION := $(shell cat $(srcdir)/../config/version.txt)
 
 PWD := $(shell pwd)
 core_abspath = $(if $(findstring :,$(1)),$(1),$(if $(filter /%,$(1)),$(1),$(PWD)/$(1)))
 
+# ZIP_IN is defaulted to be compatible with the files the wget-en-US target
+# pulls. You may override ZIP_IN if you provide your own files. You also _must_
+# override ZIP_IN when MOZ_PKG_PRETTYNAMES is defined - the default will not
+# work in that case.
+ZIP_IN ?= $(_ABS_DIST)/$(PACKAGE)
+
 DEFINES += \
 	-DAB_CD=$(AB_CD) \
 	-DMOZ_LANGPACK_EID=langpack-$(AB_CD)@firefox.mozilla.org \
 	-DMOZ_APP_VERSION=$(MOZ_APP_VERSION) \
 	-DLOCALE_SRCDIR=$(call core_abspath,$(LOCALE_SRCDIR)) \
-	-DPKG_BASENAME=$(PKG_BASENAME) \
-	-DPKG_INST_BASENAME=$(PKG_INST_BASENAME) \
+	-DPKG_BASENAME="$(PKG_BASENAME)" \
+	-DPKG_INST_BASENAME="$(PKG_INST_BASENAME)" \
 	$(NULL)
 
 ifndef MOZ_BRANDING_DIRECTORY
 DEFINES += -DMOZ_USE_GENERIC_BRANDING
 endif
 
 ifeq (,$(filter-out pref,$(MOZ_EXTENSIONS)))
 DEFINES += -DEXTENSION_PREF
@@ -207,26 +213,26 @@ MOZ_PKG_MAC_ICON=$(_ABS_DIST)/branding/d
 MOZ_PKG_MAC_ICON=$(_ABS_DIST)/branding/disk.icns
 MOZ_PKG_MAC_EXTRA=--symlink "/Applications:/ "
 endif
 
 PACKAGER_NO_LIBS = 1
 include $(topsrcdir)/toolkit/mozapps/installer/packager.mk
 include $(call EXPAND_LOCALE_SRCDIR,toolkit/locales)/installer/windows/charset.mk
 
-repackage-win32-installer: WIN32_INSTALLER_OUT=$(_ABS_DIST)/$(PKG_INST_PATH)$(PKG_INST_BASENAME).exe
+repackage-win32-installer: WIN32_INSTALLER_OUT="$(_ABS_DIST)/$(PKG_INST_PATH)$(PKG_INST_BASENAME).exe"
 repackage-win32-installer: $(WIN32_INSTALLER_IN) $(SUBMAKEFILES)
 	@echo "Repackaging $(WIN32_INSTALLER_IN) into $(WIN32_INSTALLER_OUT)."
 ifdef MOZ_BRANDING_DIRECTORY
 	$(MAKE) -C $(DEPTH)/$(MOZ_BRANDING_DIRECTORY) export
 else
 	$(MAKE) -C ../installer/windows export
 endif
-	if test ! -d $(dir $(WIN32_INSTALLER_OUT)); then \
-	  $(NSINSTALL) -D $(dir $(WIN32_INSTALLER_OUT)); \
+	if test ! -d $(_ABS_DIST)/$(PKG_INST_PATH); then \
+	  $(NSINSTALL) -D $(_ABS_DIST)/$(PKG_INST_PATH); \
 	fi
 	$(RM) -rf l10n-stage
 	$(NSINSTALL) -D l10n-stage
 	$(CYGWIN_WRAPPER) 7z x -ol10n-stage $(WIN32_INSTALLER_IN)
 	$(RM) -r l10n-stage/localized
 	$(RM) l10n-stage/setup.exe
 	cp -r $(DIST)/xpi-stage/locale-$(AB_CD) l10n-stage/localized
 	$(MAKE) -C ../installer/windows CONFIG_DIR=l10ngen l10ngen/setup.exe l10ngen/7zSD.sfx
@@ -251,49 +257,60 @@ endif
 
 ifneq (,$(filter mac cocoa,$(MOZ_WIDGET_TOOLKIT)))
 STAGEDIST = $(_ABS_DIST)/l10n-stage/$(MOZ_PKG_APPNAME)/$(_APPNAME)/Contents/MacOS
 else
 STAGEDIST = $(_ABS_DIST)/l10n-stage/$(MOZ_PKG_APPNAME)
 endif
 
 $(STAGEDIST): AB_CD:=en-US
-$(STAGEDIST): UNPACKAGE=$(_ABS_DIST)/$(PACKAGE)
-$(STAGEDIST): $(_ABS_DIST)/$(PACKAGE)
+$(STAGEDIST): UNPACKAGE=$(ZIP_IN)
+$(STAGEDIST): $(ZIP_IN)
 # only mac needs to remove the parent of STAGEDIST...
 ifneq (,$(filter mac cocoa,$(MOZ_WIDGET_TOOLKIT)))
 	if test -d $(DIST)/l10n-stage; then \
 	  $(RM) -r -v $(DIST)/l10n-stage; \
 	fi
 else
 # ... and windows doesn't like removing STAGEDIST itself, remove all children
 	if test -d $(DIST)/l10n-stage; then \
 	  find $(STAGEDIST) -maxdepth 1 -print0 | xargs -0 $(RM) -r ; \
 	fi
 endif
 	$(NSINSTALL) -D $(DIST)/l10n-stage
 	cd $(DIST)/l10n-stage && \
 	  $(UNMAKE_PACKAGE)
+ifdef MOZ_PKG_PRETTYNAMES
+ifneq (,$(filter WINNT Linux,$(OS_ARCH)))
+# Linux and Windows unpack to a directory named after the MOZ_APP_NAME
+# they were built with. This is fine when when MOZ_PKG_PRETTYNAMES
+# isn't defined, because MOZ_PKG_APPNAME will be the same as MOZ_APP_NAME.
+# However, when MOZ_PKG_PRETTYNAMES is passed MOZ_PKG_APPNAME inherits
+# from MOZ_PKG_DISPLAYNAME, which is not always the same as MOZ_APP_NAME.
+	cd $(DIST)/l10n-stage && \
+      mv $(MOZ_APP_NAME) $(MOZ_PKG_APPNAME)
+endif
+endif
 	make clobber-zip AB_CD=en-US
 
 clobber-zip:
 	$(RM) $(STAGEDIST)/chrome/$(AB_CD).jar \
 	  $(STAGEDIST)/chrome/$(AB_CD).manifest \
 	  $(STAGEDIST)/defaults/pref/firefox-l10n.js
 	$(RM) -r $(STAGEDIST)/microsummary-generators \
 	  $(STAGEDIST)/searchplugins \
 	  $(STAGEDIST)/dictionaries \
 	  $(STAGEDIST)/defaults/profile \
 	  $(STAGEDIST)/chrome/$(AB_CD)
 
 unpack: $(STAGEDIST)
 	@echo done unpacking
 
-repackage-zip: ZIP_OUT=$(_ABS_DIST)/$(PACKAGE)
-repackage-zip: UNPACKAGE=$(ZIP_IN)
+repackage-zip: ZIP_OUT="$(_ABS_DIST)/$(PACKAGE)"
+repackage-zip: UNPACKAGE="$(ZIP_IN)"
 repackage-zip:
 ifeq (WINNT,$(OS_ARCH))
 	$(RM) -r $(STAGEDIST)/uninstall
 	$(NSINSTALL) -D $(STAGEDIST)/uninstall
 	cp ../installer/windows/l10ngen/helper.exe $(STAGEDIST)/uninstall
 endif
 	cd $(DIST)/xpi-stage/locale-$(AB_CD) && \
 	  tar $(TAR_CREATE_FLAGS) - * | ( cd $(STAGEDIST) && tar -xf - )
@@ -308,17 +325,17 @@ endif
 	# packaging done, undo l10n stuff
 ifneq (en,$(AB))
 ifneq (,$(filter mac cocoa,$(MOZ_WIDGET_TOOLKIT)))
 	mv $(_ABS_DIST)/l10n-stage/$(MOZ_PKG_APPNAME)/$(_APPNAME)/Contents/Resources/$(AB).lproj $(_ABS_DIST)/l10n-stage/$(MOZ_PKG_APPNAME)/$(_APPNAME)/Contents/Resources/en.lproj
 endif
 endif
 	$(MAKE) clobber-zip AB_CD=$(AB_CD)
 	$(NSINSTALL) -D $(DIST)/$(PKG_PATH)
-	mv -f $(DIST)/l10n-stage/$(PACKAGE) $(DIST)/$(PACKAGE)
+	mv -f "$(DIST)/l10n-stage/$(PACKAGE)" "$(DIST)/$(PACKAGE)"
 
 repackage-zip-%: ZIP_IN=$(_ABS_DIST)/$(PACKAGE)
 repackage-zip-%: $(ZIP_IN) $(STAGEDIST) libs-%
 	@$(MAKE) repackage-zip AB_CD=$* ZIP_IN=$(ZIP_IN)
 
 langpack-%: LANGPACK_FILE=$(_ABS_DIST)/$(PKG_LANGPACK_PATH)$(PKG_LANGPACK_BASENAME).xpi
 langpack-%: AB_CD=$*
 langpack-%: XPI_NAME=locale-$*
diff -r a4343d61f6ee browser/locales/en-US/chrome/browser/browser.properties
--- a/browser/locales/en-US/chrome/browser/browser.properties	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/locales/en-US/chrome/browser/browser.properties	Sat Nov 15 19:43:12 2008 -0500
@@ -138,18 +138,16 @@ editBookmarkPanel.editBookmarkTitle=Edit
 # Geolocation UI
 # LOCALIZATION NOTE (exactLocation, neighborhoodLocation): These do not have to be
 # exact value, instead approximations would be fine.
 # examples: Neighborhood (within 2 km)
 #           Exact Location (within 3 m)
 #
 geolocation.exactLocation=Exact Location (within 10 feet)
 geolocation.exactLocationKey=E
-geolocation.neighborhoodLocation=Neighborhood (within 1 mile)
-geolocation.neighborhoodLocationKey=N
 geolocation.nothingLocation=Nothing
 geolocation.nothingLocationKey=o
 geolocation.requestMessage=%S wants to know where you are.  Tell them:
 
 # Phishing/Malware Notification Bar.
 # LOCALIZATION NOTE (notAForgery, notAnAttack)
 # The two button strings will never be shown at the same time, so
 # it's okay for them to have the same access key
diff -r a4343d61f6ee browser/locales/en-US/searchplugins/google.xml
--- a/browser/locales/en-US/searchplugins/google.xml	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/locales/en-US/searchplugins/google.xml	Sat Nov 15 19:43:12 2008 -0500
@@ -1,13 +1,13 @@
 <SearchPlugin xmlns="http://www.mozilla.org/2006/browser/search/">
 <ShortName>Google</ShortName>
 <Description>Google Search</Description>
 <InputEncoding>UTF-8</InputEncoding>
-<Image width="16" height="16">data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAaRJREFUeNpiVIg5JRURw0A0YAHio943kYV%2B%2Ff33%2BdvvX7%2F%2FMjEx8nKycrGzwKXOiPKzICvdeezLhCV3jp15%2Bfv%2FX0YGhv8MDDxMX2qKTIw0RK10eYD6QYqATvoPBkt3f5K0W9Ew4fjTFz%2F%2Bw8Dm3W8UPeZxqFa%2BevsFyD0twgfVsOfkRxHrtfV9u5BVQ8Crd98%2FffkGYQM1QJ20%2FfSPv79eNxQGYfpSVJADmcvEAHbr7oOX2dj%2FERNKIA2%2F%2F%2Fz%2FxfCDhYVoDUDw5P6vf9%2B5iY0HVmZGQWm%2BN3fff%2Fn2k4eLHS739x%2FDiRs%2Ff%2F%2F5x8HO%2FOHzN3djfqgNjIwMgc6qzLx%2Fpy47j2zY%2Feff06tXhOUucgxeun33AUZGpHh4%2Bvo7t8EyIJqz%2FhpasD59%2B5dNrqdnznZIsEL9ICXCsWuBCwvTv%2FymS5PWPP32ExEALz%2F%2BB5r848cPCJcRaMP9xaYQzofPPzfuvrnj0Jst%2B5%2F8%2Bc4sLPeDkYlRgJc93VPE18NIXkYUmJYQSQMZ%2FP3379uPH7%2F%2F%2FEETBzqJ0WqLGvFpe2LCC4AAAwAyjg7ENzDDWAAAAABJRU5ErkJggg%3D%3D</Image>
+<Image width="16" height="16">data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8%2F9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAt5JREFUeNpsU1tIVFEU3fc1jnd8MONjRvOVaKJoGGiCEYJgoBBB0EOILIrCPoJ%2Bish%2Bwo8%2BiigiIqKGLCiSQsLoR8QwsVTUtGFwHEcdnTvjPK7Oe%2B7jnO4MKFp3c86Bs9l7nb3W3ofAGMO2YSSBLEYh5SNJZVGAMKP4SaAoSrkjIAgCgEhGpw6gYZf1PjSDPVIFbBoDckhqFhJiR4GpvJSUsWhfdiV4fj4R3Zh90GfuWSstLfgfYIULgZOtBVM6c8c29fncwuyX3mxDETLVnL7rWR53rfx50wViYiMev72TswdAQ5GQReBaecPSO%2FfzcTfFsO9iER04HWPZBlPNdY0jnYaYWwAI7uSQuwGQiAB5%2BYZQIAoJMczrciqgqb0HTFlZ%2FYYMDcgSPiqLAYU9pQ4gJCSYnpxwuEMs5Jka25N6GcsKobiiRQpyFpCDTisB2yKqUCAAQcA1M0oJ1v7CkrYuSeAWkLg5JqPwvSXrwHsA7yeM2GS%2F1CsgCAyllYdkv2v4%2FO%2BpR90kjY6kiXh47udLHA9aOvPLzkS0mftS7VatgNJpobi1Daqb6mPzI33Ped%2FaV5sjYNfnHK6UE7GWbGPzCJLWASFZvYIUOUUfQ27R2fK6Cx9zi1qf2C0D07SGLSg70DkU4H51xCMeIEhKvQJlAkkdyC%2BU1zstEx9uxSKeb4Icd%2FtYY0tVw02zRr%2F%2FWXx9sJYgmLAKAAa9obGO93CXJkdf3acg8rTs4GWADBOgTdsgtz56Iy2zpE8RKjmCNhUAAuKSEewrfsjNqy4ExgDltVeVCBkYLQ28cyLPNvt2EYkKh1193EOBWxiaW51zvi6vOHExJAhGr391QMfmhdMEX%2F2W33oswP24RpJSMNludQ2EceRfGrkSDY1%2Fzzc2HI8F1075ha1gJLg4zXtnTkoJn41i6F1T8A8Amy6BXh9S%2FrTdHHbzZoLSkoBFhLEEWawAWCsDTdPKZnZy%2FgowAP1SVhbvUfi1AAAAAElFTkSuQmCC</Image>
 <Url type="application/x-suggestions+json" method="GET" template="http://suggestqueries.google.com/complete/search?output=firefox&amp;client=firefox&amp;hl={moz:locale}&amp;q={searchTerms}"/>
 <Url type="text/html" method="GET" template="http://www.google.com/search">
   <Param name="q" value="{searchTerms}"/>
   <Param name="ie" value="utf-8"/>
   <Param name="oe" value="utf-8"/>
   <Param name="aq" value="t"/>
   <!-- Dynamic parameters -->
   <Param name="rls" value="{moz:distributionID}:{moz:locale}:{moz:official}"/>
diff -r a4343d61f6ee browser/locales/shipped-locales
--- a/browser/locales/shipped-locales	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/locales/shipped-locales	Sat Nov 15 19:43:12 2008 -0500
@@ -1,37 +1,55 @@ be
+af
+ar
 be
+bg
+bn-IN
 ca
 cs
+cy
 de
+el
+en-GB
 en-US
 eo
 es-AR
 es-ES
+et
 eu
 fi
 fr
 fy-NL
 ga-IE
+gu-IN
 he
 hi-IN
 hu
 id
+is
 it
 ja linux win32
 ja-JP-mac osx
+ka
+kn
 ko
 lt
+lv
+mr
 nb-NO
 nl
 nn-NO
 pa-IN
 pl
 pt-BR
 pt-PT
 ro
 ru
 si
 sk
+sl
+sq
 sv-SE
+te
+tr
 uk
 zh-CN
 zh-TW
diff -r a4343d61f6ee browser/themes/gnomestripe/browser/Privacy-16.png
Binary file browser/themes/gnomestripe/browser/Privacy-16.png has changed
diff -r a4343d61f6ee browser/themes/gnomestripe/browser/Privacy-32.png
Binary file browser/themes/gnomestripe/browser/Privacy-32.png has changed
diff -r a4343d61f6ee browser/themes/gnomestripe/browser/Privacy-48.png
Binary file browser/themes/gnomestripe/browser/Privacy-48.png has changed
diff -r a4343d61f6ee browser/themes/gnomestripe/browser/Privacy-64.png
Binary file browser/themes/gnomestripe/browser/Privacy-64.png has changed
diff -r a4343d61f6ee browser/themes/gnomestripe/browser/Search-glass-rtl.png
Binary file browser/themes/gnomestripe/browser/Search-glass-rtl.png has changed
diff -r a4343d61f6ee browser/themes/gnomestripe/browser/Toolbar-small.png
Binary file browser/themes/gnomestripe/browser/Toolbar-small.png has changed
diff -r a4343d61f6ee browser/themes/gnomestripe/browser/Toolbar.png
Binary file browser/themes/gnomestripe/browser/Toolbar.png has changed
diff -r a4343d61f6ee browser/themes/gnomestripe/browser/identity.png
Binary file browser/themes/gnomestripe/browser/identity.png has changed
diff -r a4343d61f6ee browser/themes/gnomestripe/browser/jar.mn
--- a/browser/themes/gnomestripe/browser/jar.mn	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/themes/gnomestripe/browser/jar.mn	Sat Nov 15 19:43:12 2008 -0500
@@ -11,19 +11,17 @@ classic.jar:
   skin/classic/browser/identity.png
   skin/classic/browser/Info.png
   skin/classic/browser/monitor.png
   skin/classic/browser/monitor_16-10.png
 * skin/classic/browser/pageInfo.css
   skin/classic/browser/pageInfo.png
   skin/classic/browser/page-livemarks.png
   skin/classic/browser/Privacy-16.png
-  skin/classic/browser/Privacy-32.png
   skin/classic/browser/Privacy-48.png
-  skin/classic/browser/Privacy-64.png
   skin/classic/browser/searchbar.css                  (searchbar.css)
   skin/classic/browser/Search-glass.png
   skin/classic/browser/Search-glass-rtl.png
   skin/classic/browser/section_collapsed.png
   skin/classic/browser/section_expanded.png
   skin/classic/browser/Secure.png
   skin/classic/browser/Security-broken.png
   skin/classic/browser/setDesktopBackground.css
diff -r a4343d61f6ee browser/themes/gnomestripe/browser/pageInfo.png
Binary file browser/themes/gnomestripe/browser/pageInfo.png has changed
diff -r a4343d61f6ee browser/themes/gnomestripe/browser/preferences/Options.png
Binary file browser/themes/gnomestripe/browser/preferences/Options.png has changed
diff -r a4343d61f6ee browser/themes/gnomestripe/browser/preferences/preferences.css
--- a/browser/themes/gnomestripe/browser/preferences/preferences.css	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/themes/gnomestripe/browser/preferences/preferences.css	Sat Nov 15 19:43:12 2008 -0500
@@ -66,25 +66,16 @@ radio[pane=panePrivacy] {
 }
 
 radio[pane=paneSecurity] {
   -moz-image-region: rect(0px, 192px,  32px, 160px)
 }
 
 radio[pane=paneAdvanced] {
   -moz-image-region: rect(0px, 224px, 32px, 192px)
-}
-
-/* General Pane */
-#browserHomePage {
-  padding-top: 2px;
-  padding-bottom: 3px;
-  -moz-padding-start: 4px;
-  -moz-padding-end: 2px;
-  background-color: -moz-Dialog;
 }
 
 /* Applications Pane */
 #BrowserPreferences[animated="true"] #handlersView {
   height: 25em;
 }
 
 #BrowserPreferences[animated="false"] #handlersView {
diff -r a4343d61f6ee browser/themes/gnomestripe/browser/preview.png
Binary file browser/themes/gnomestripe/browser/preview.png has changed
diff -r a4343d61f6ee browser/themes/gnomestripe/browser/tabbrowser/newtab.png
Binary file browser/themes/gnomestripe/browser/tabbrowser/newtab.png has changed
diff -r a4343d61f6ee browser/themes/pinstripe/browser/Privacy-16.png
Binary file browser/themes/pinstripe/browser/Privacy-16.png has changed
diff -r a4343d61f6ee browser/themes/pinstripe/browser/Privacy-32.png
Binary file browser/themes/pinstripe/browser/Privacy-32.png has changed
diff -r a4343d61f6ee browser/themes/pinstripe/browser/Privacy-48.png
Binary file browser/themes/pinstripe/browser/Privacy-48.png has changed
diff -r a4343d61f6ee browser/themes/pinstripe/browser/Privacy-64.png
Binary file browser/themes/pinstripe/browser/Privacy-64.png has changed
diff -r a4343d61f6ee browser/themes/pinstripe/browser/jar.mn
--- a/browser/themes/pinstripe/browser/jar.mn	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/themes/pinstripe/browser/jar.mn	Sat Nov 15 19:43:12 2008 -0500
@@ -33,19 +33,17 @@ classic.jar:
   skin/classic/browser/menu-back.png
   skin/classic/browser/menu-forward.png
   skin/classic/browser/page-livemarks.png
   skin/classic/browser/livemark-item.png
   skin/classic/browser/pageInfo.css
   skin/classic/browser/pageInfo.png
   skin/classic/browser/Popup-blocked.png
   skin/classic/browser/Privacy-16.png
-  skin/classic/browser/Privacy-32.png
   skin/classic/browser/Privacy-48.png
-  skin/classic/browser/Privacy-64.png
   skin/classic/browser/searchbar.css
   skin/classic/browser/Search.png
   skin/classic/browser/Search-addengines.png
   skin/classic/browser/Search-bar.png
   skin/classic/browser/search-bar-background-left.png
   skin/classic/browser/search-bar-background-mid.png
   skin/classic/browser/search-bar-background-right.png
   skin/classic/browser/section_collapsed.png
diff -r a4343d61f6ee browser/themes/pinstripe/browser/tabbrowser/newtab.png
Binary file browser/themes/pinstripe/browser/tabbrowser/newtab.png has changed
diff -r a4343d61f6ee browser/themes/winstripe/browser/Privacy-16-aero.png
Binary file browser/themes/winstripe/browser/Privacy-16-aero.png has changed
diff -r a4343d61f6ee browser/themes/winstripe/browser/Privacy-16.png
Binary file browser/themes/winstripe/browser/Privacy-16.png has changed
diff -r a4343d61f6ee browser/themes/winstripe/browser/Privacy-32-aero.png
Binary file browser/themes/winstripe/browser/Privacy-32-aero.png has changed
diff -r a4343d61f6ee browser/themes/winstripe/browser/Privacy-32.png
Binary file browser/themes/winstripe/browser/Privacy-32.png has changed
diff -r a4343d61f6ee browser/themes/winstripe/browser/Privacy-48-aero.png
Binary file browser/themes/winstripe/browser/Privacy-48-aero.png has changed
diff -r a4343d61f6ee browser/themes/winstripe/browser/Privacy-48.png
Binary file browser/themes/winstripe/browser/Privacy-48.png has changed
diff -r a4343d61f6ee browser/themes/winstripe/browser/Privacy-64-aero.png
Binary file browser/themes/winstripe/browser/Privacy-64-aero.png has changed
diff -r a4343d61f6ee browser/themes/winstripe/browser/Privacy-64.png
Binary file browser/themes/winstripe/browser/Privacy-64.png has changed
diff -r a4343d61f6ee browser/themes/winstripe/browser/aboutCertError.css
--- a/browser/themes/winstripe/browser/aboutCertError.css	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/themes/winstripe/browser/aboutCertError.css	Sat Nov 15 19:43:12 2008 -0500
@@ -81,15 +81,15 @@ body[dir="rtl"] #errorPageContainer {
   -moz-margin-start: 80px;
 }
 
 #errorLongContent {
   -moz-margin-start: 80px;
 }
 
 #technicalContent > h2, #expertContent > h2 {
-  background : url("chrome://browser/skin/section_expanded.png") left 0 no-repeat;
+  background : url("chrome://browser/skin/section_expanded.png") left center no-repeat;
 }
 
 #technicalContent[collapsed] > h2,
 #expertContent[collapsed] > h2{
   background-image: url("chrome://browser/skin/section_collapsed.png");
 }
diff -r a4343d61f6ee browser/themes/winstripe/browser/jar.mn
--- a/browser/themes/winstripe/browser/jar.mn	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/themes/winstripe/browser/jar.mn	Sat Nov 15 19:43:12 2008 -0500
@@ -13,19 +13,17 @@ classic.jar:
         skin/classic/browser/KUI-background.png
         skin/classic/browser/pageInfo.css
         skin/classic/browser/pageInfo.png                            (pageInfo.png)
         skin/classic/browser/page-livemarks.png                      (feeds/feedIcon16.png)
         skin/classic/browser/livemark-item.png                       (livemark-item.png)
         skin/classic/browser/livemark-folder.png                     (livemark-folder.png)
         skin/classic/browser/Bookmarks-folder.png                    (Bookmarks-folder.png)
         skin/classic/browser/Privacy-16.png
-        skin/classic/browser/Privacy-32.png
         skin/classic/browser/Privacy-48.png
-        skin/classic/browser/Privacy-64.png
         skin/classic/browser/Secure.png                              (Secure.png)
         skin/classic/browser/Secure24.png                            (Secure24.png)
         skin/classic/browser/Security-broken.png                     (Security-broken.png)
         skin/classic/browser/Throbber.gif
         skin/classic/browser/Throbber.png
         skin/classic/browser/Throbber-small.png
         skin/classic/browser/Toolbar.png                             (Toolbar.png)
         skin/classic/browser/Toolbar-small.png                       (Toolbar-small.png)
@@ -108,34 +106,34 @@ classic.jar:
         skin/classic/aero/browser/identity.png                       (identity-aero.png)
         skin/classic/aero/browser/KUI-background.png
         skin/classic/aero/browser/pageInfo.css
         skin/classic/aero/browser/pageInfo.png                       (pageInfo-aero.png)
         skin/classic/aero/browser/page-livemarks.png                 (feeds/feedIcon16-aero.png)
         skin/classic/aero/browser/livemark-item.png                  (livemark-item-aero.png)
         skin/classic/aero/browser/livemark-folder.png                (livemark-folder-aero.png)
         skin/classic/aero/browser/Bookmarks-folder.png               (Bookmarks-folder-aero.png)
-        skin/classic/aero/browser/Privacy-16.png
-        skin/classic/aero/browser/Privacy-32.png
-        skin/classic/aero/browser/Privacy-48.png
-        skin/classic/aero/browser/Privacy-64.png
+        skin/classic/aero/browser/Privacy-16.png                     (Privacy-16-aero.png)
+        skin/classic/aero/browser/Privacy-48.png                     (Privacy-48-aero.png)
         skin/classic/aero/browser/Secure.png                         (Secure-aero.png)
         skin/classic/aero/browser/Secure24.png                       (Secure24-aero.png)
         skin/classic/aero/browser/Security-broken.png                (Security-broken-aero.png)
         skin/classic/aero/browser/Throbber.gif
         skin/classic/aero/browser/Throbber.png
         skin/classic/aero/browser/Throbber-small.png
         skin/classic/aero/browser/Toolbar.png                        (Toolbar-aero.png)
         skin/classic/aero/browser/Toolbar-small.png                  (Toolbar-small-aero.png)
         skin/classic/aero/browser/Go-arrow.png                       (Go-arrow-aero.png)
         skin/classic/aero/browser/Go-arrow-rtl.png                   (Go-arrow-rtl-aero.png)
 *       skin/classic/aero/browser/searchbar.css                      (searchbar.css)
         skin/classic/aero/browser/Search-glass.png                   (Search-glass-aero.png)
         skin/classic/aero/browser/Search-glass-rtl.png               (Search-glass-rtl-aero.png)
         skin/classic/aero/browser/Search-addengines.png
+        skin/classic/aero/browser/section_collapsed.png
+        skin/classic/aero/browser/section_expanded.png
         skin/classic/aero/browser/setDesktopBackground.css
         skin/classic/aero/browser/menu-back.png                      (menu-back-aero.png)
         skin/classic/aero/browser/menu-forward.png                   (menu-forward-aero.png)
         skin/classic/aero/browser/monitor.png
         skin/classic/aero/browser/monitor_16-10.png
         skin/classic/aero/browser/navbar-textbox-buttons.png         (navbar-textbox-buttons-aero.png)
         skin/classic/aero/browser/urlbar-favicon-glow.png
         skin/classic/aero/browser/feeds/feed-icons-16.png            (feeds/feed-icons-16-aero.png)
diff -r a4343d61f6ee browser/themes/winstripe/browser/places/organizer-aero.css
--- a/browser/themes/winstripe/browser/places/organizer-aero.css	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/themes/winstripe/browser/places/organizer-aero.css	Sat Nov 15 19:43:12 2008 -0500
@@ -54,8 +54,14 @@
 
 #placesView:-moz-system-metric(windows-default-theme),
 #searchModifiers:-moz-system-metric(windows-default-theme),
 #infoPane:-moz-system-metric(windows-default-theme),
 #placesList:-moz-system-metric(windows-default-theme),
 #placeContent:-moz-system-metric(windows-default-theme) {
   background-color: #EEF3FA;
 }
+
+/**** Vista default theme: Library's search box needs to be vertically centered ****/
+#searchFilter:-moz-system-metric(windows-default-theme) {
+  padding-top: 3px;
+  padding-bottom: 2px;
+}
diff -r a4343d61f6ee browser/themes/winstripe/browser/preferences/preferences.css
--- a/browser/themes/winstripe/browser/preferences/preferences.css	Thu Nov 06 18:33:22 2008 +0100
+++ b/browser/themes/winstripe/browser/preferences/preferences.css	Sat Nov 15 19:43:12 2008 -0500
@@ -93,25 +93,16 @@ radio[pane=paneSecurity][selected="true"
 }
 
 radio[pane=paneAdvanced] {
 	-moz-image-region: rect(0px, 224px, 32px, 192px)
 }
 radio[pane=paneAdvanced]:hover, 
 radio[pane=paneAdvanced][selected="true"] {
 	-moz-image-region: rect(32px, 224px, 64px, 192px)
-}
-
-/* General Pane */
-#browserHomePage {
-  padding-top: 2px;
-  padding-bottom: 3px;
-  -moz-padding-start: 4px;
-  -moz-padding-end: 2px;
-  background-color: -moz-Dialog;
 }
 
 /* Applications Pane */
 #BrowserPreferences[animated="true"] #handlersView {
   height: 25em;
 }
 
 #BrowserPreferences[animated="false"] #handlersView {
diff -r a4343d61f6ee browser/themes/winstripe/browser/tabbrowser/newtab-aero.png
Binary file browser/themes/winstripe/browser/tabbrowser/newtab-aero.png has changed
diff -r a4343d61f6ee browser/themes/winstripe/browser/tabbrowser/newtab.png
Binary file browser/themes/winstripe/browser/tabbrowser/newtab.png has changed
diff -r a4343d61f6ee build/leaktest.py.in
--- a/build/leaktest.py.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/build/leaktest.py.in	Sat Nov 15 19:43:12 2008 -0500
@@ -74,12 +74,13 @@ if __name__ == '__main__':
     automation.initializeProfile(PROFILE_DIRECTORY)
     browserEnv = dict(os.environ)
 
     browserEnv["NO_EM_RESTART"] = "1"
     browserEnv["XPCOM_DEBUG_BREAK"] = "warn"
     if automation.UNIXISH:
         browserEnv["LD_LIBRARY_PATH"] = os.path.join(SCRIPT_DIR, DIST_BIN)
         browserEnv["MOZILLA_FIVE_HOME"] = os.path.join(SCRIPT_DIR, DIST_BIN)
+        browserEnv["GNOME_DISABLE_CRASH_DIALOG"] = "1"
 
     automation.runApp("http://localhost:%d/bloatcycle.html" % PORT, browserEnv,
                       os.path.join(SCRIPT_DIR, automation.DEFAULT_APP),
                       PROFILE_DIRECTORY, extraArgs)
diff -r a4343d61f6ee build/upload.py
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/build/upload.py	Sat Nov 15 19:43:12 2008 -0500
@@ -0,0 +1,196 @@
+#!/usr/bin/python
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is mozilla.org code.
+#
+# The Initial Developer of the Original Code is
+# The Mozilla Foundation 
+# Portions created by the Initial Developer are Copyright (C) 2008
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#  Ted Mielczarek <ted.mielczarek@gmail.com>
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+#
+# When run directly, this script expects the following environment variables
+# to be set:
+# UPLOAD_HOST    : host to upload files to
+# UPLOAD_USER    : username on that host
+# UPLOAD_PATH    : path on that host to put the files in
+#
+# And will use the following optional environment variables if set:
+# UPLOAD_SSH_KEY : path to a ssh private key to use
+# UPLOAD_PORT    : port to use for ssh
+# POST_UPLOAD_CMD: a commandline to run on the remote host after uploading.
+#                  UPLOAD_PATH and the full paths of all files uploaded will
+#                  be appended to the commandline.
+#
+# All files to be uploaded should be passed as commandline arguments to this
+# script. The script takes one other parameter, --base-path, which you can use
+# to indicate that files should be uploaded including their paths relative
+# to the base path.
+
+import sys, os
+from optparse import OptionParser
+from util import check_call
+
+def RequireEnvironmentVariable(v):
+    """Return the value of the environment variable named v, or print
+    an error and exit if it's unset (or empty)."""
+    if not v in os.environ or os.environ[v] == "":
+        print "Error: required environment variable %s not set" % v
+        sys.exit(1)
+    return os.environ[v]
+
+def OptionalEnvironmentVariable(v):
+    """Return the value of the environment variable named v, or None
+    if it's unset (or empty)."""
+    if v in os.environ and os.environ[v] != "":
+        return os.environ[v]
+    return None
+
+def FixupMsysPath(path):
+    """MSYS helpfully translates absolute pathnames in environment variables
+    and commandline arguments into Windows native paths. This sucks if you're
+    trying to pass an absolute path on a remote server. This function attempts
+    to un-mangle such paths."""
+    if 'OSTYPE' in os.environ and os.environ['OSTYPE'] == 'msys':
+        # sort of awful, find out where our shell is (should be in msys/bin)
+        # and strip the first part of that path out of the other path
+        if 'SHELL' in os.environ:
+            sh = os.environ['SHELL']
+            msys = sh[:sh.find('/bin')]
+            if path.startswith(msys):
+                path = path[len(msys):]
+    return path
+
+def WindowsPathToMsysPath(path):
+    """Translate a Windows pathname to an MSYS pathname.
+    Necessary because we call out to ssh/scp, which are MSYS binaries
+    and expect MSYS paths."""
+    if sys.platform != 'win32':
+        return path
+    (drive, path) = os.path.splitdrive(os.path.abspath(path))     
+    return "/" + drive[0] + path.replace('\\','/')
+
+def AppendOptionalArgsToSSHCommandline(cmdline, port, ssh_key):
+    """Given optional port and ssh key values, append valid OpenSSH
+    commandline arguments to the list cmdline if the values are not None."""
+    if port is not None:
+        cmdline.append("-P%d" % port)
+    if ssh_key is not None:
+        cmdline.extend(["-i", WindowsPathToMsysPath(ssh_key)])
+
+def DoSSHCommand(command, user, host, port=None, ssh_key=None):
+    """Execute command on user@host using ssh. Optionally use
+    port and ssh_key, if provided."""
+    cmdline = ["ssh"]
+    AppendOptionalArgsToSSHCommandline(cmdline, port, ssh_key)
+    cmdline.extend(["%s@%s" % (user, host), command])
+    check_call(cmdline)
+
+def DoSCPFile(file, remote_path, user, host, port=None, ssh_key=None):
+    """Upload file to user@host:remote_path using scp. Optionally use
+    port and ssh_key, if provided."""
+    cmdline = ["scp"]
+    AppendOptionalArgsToSSHCommandline(cmdline, port, ssh_key)
+    cmdline.extend([WindowsPathToMsysPath(file),
+                    "%s@%s:%s" % (user, host, remote_path)])
+    check_call(cmdline)
+
+def GetRemotePath(path, local_file, base_path):
+    """Given a remote path to upload to, a full path to a local file, and an
+    optional full path that is a base path of the local file, construct the
+    full remote path to place the file in. If base_path is not None, include
+    the relative path from base_path to file."""
+    if base_path is None or not local_file.startswith(base_path):
+        return path
+    dir = os.path.dirname(local_file)
+    # strip base_path + extra slash and make it unixy
+    dir = dir[len(base_path)+1:].replace('\\','/')
+    return path + dir
+
+def UploadFiles(user, host, path, files, verbose=False, port=None, ssh_key=None, base_path=None, post_upload_command=None):
+    """Upload each file in the list files to user@host:path. Optionally pass
+    port and ssh_key to the ssh commands. If base_path is not None, upload
+    files including their path relative to base_path. If post_upload_command
+    is not None, execute that command on the remote host after uploading
+    all files, passing it the upload path, and the full paths to all files
+    uploaded. If verbose is True, print status updates while working."""
+    if not path.endswith("/"):
+        path += "/"
+    if base_path is not None:
+        base_path = os.path.abspath(base_path)
+    remote_files = []
+    for file in files:
+        file = os.path.abspath(file)
+        if not os.path.isfile(file):
+            raise IOError("File not found: %s" % file)
+        # first ensure that path exists remotely
+        remote_path = GetRemotePath(path, file, base_path)
+        DoSSHCommand("mkdir -p " + remote_path, user, host, port=port, ssh_key=ssh_key)
+        if verbose:
+            print "Uploading " + file
+        DoSCPFile(file, remote_path, user, host, port=port, ssh_key=ssh_key)
+        remote_files.append(remote_path + '/' + os.path.basename(file))
+    if post_upload_command is not None:
+        if verbose:
+            print "Running post-upload command: " + post_upload_command
+        file_list = '"' + '" "'.join(remote_files) + '"'
+        DoSSHCommand('%s "%s" %s' % (post_upload_command, path, file_list), user, host, port=port, ssh_key=ssh_key)
+    if verbose:
+        print "Upload complete"
+
+if __name__ == '__main__':
+    host = RequireEnvironmentVariable('UPLOAD_HOST')
+    user = RequireEnvironmentVariable('UPLOAD_USER')
+    path = RequireEnvironmentVariable('UPLOAD_PATH')
+    port = int(OptionalEnvironmentVariable('UPLOAD_PORT'))
+    key = OptionalEnvironmentVariable('UPLOAD_SSH_KEY')
+    post_upload_command = OptionalEnvironmentVariable('POST_UPLOAD_CMD')
+    if sys.platform == 'win32':
+        path = FixupMsysPath(path)
+        post_upload_command = FixupMsysPath(post_upload_command)
+
+    parser = OptionParser(usage="usage: %prog [options] <files>")
+    parser.add_option("-b", "--base-path",
+                      action="store", dest="base_path",
+                      help="Preserve file paths relative to this path when uploading. If unset, all files will be uploaded directly to UPLOAD_PATH.")
+    (options, args) = parser.parse_args()
+    if len(args) < 1:
+        print "You must specify at least one file to upload"
+        sys.exit(1)
+    try:
+        UploadFiles(user, host, path, args, base_path=options.base_path,
+                    port=port, ssh_key=key, post_upload_command=post_upload_command,
+                    verbose=True)
+    except IOError, (strerror):
+        print strerror
+    except Exception, (err):
+        print err
+
diff -r a4343d61f6ee build/util.py
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/build/util.py	Sat Nov 15 19:43:12 2008 -0500
@@ -0,0 +1,50 @@
+#!/usr/bin/python
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is mozilla.org code.
+#
+# The Initial Developer of the Original Code is
+# The Mozilla Foundation 
+# Portions created by the Initial Developer are Copyright (C) 2008
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#  Ted Mielczarek <ted.mielczarek@gmail.com>
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+try:
+    from subprocess import check_call
+except ImportError:
+    import subprocess
+    def check_call(*popenargs, **kwargs):
+        retcode = subprocess.call(*popenargs, **kwargs)
+        if retcode:
+            cmd = kwargs.get("args")
+            if cmd is None:
+                cmd = popenargs[0]
+                raise Exception("Command '%s' returned non-zero exit status %i" % (cmd, retcode))
diff -r a4343d61f6ee chrome/src/nsChromeRegistry.cpp
--- a/chrome/src/nsChromeRegistry.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/chrome/src/nsChromeRegistry.cpp	Sat Nov 15 19:43:12 2008 -0500
@@ -745,18 +745,18 @@ nsChromeRegistry::ConvertChromeURL(nsIUR
   rv = chromeURL->GetHostPort(package);
   NS_ENSURE_SUCCESS(rv, rv);
 
   rv = GetProviderAndPath(chromeURL, provider, path);
   NS_ENSURE_SUCCESS(rv, rv);
 
   PackageEntry* entry =
     static_cast<PackageEntry*>(PL_DHashTableOperate(&mPackagesHash,
-                                                       & (nsACString&) package,
-                                                       PL_DHASH_LOOKUP));
+                                                    & (nsACString&) package,
+                                                    PL_DHASH_LOOKUP));
 
   if (PL_DHASH_ENTRY_IS_FREE(entry)) {
     if (!mInitialized)
       return NS_ERROR_NOT_INITIALIZED;
 
     LogMessage("No chrome package registered for chrome://%s/%s/%s",
                package.get(), provider.get(), path.get());
 
@@ -1319,16 +1319,42 @@ nsChromeRegistry::CheckForNewChrome()
       nsCAutoString path;
       lmanifest->GetNativePath(path);
       LogMessage("Failed to process chrome manifest: '%s'.",
                  path.get());
     }
   }
 
   return NS_OK;
+}
+
+NS_IMETHODIMP_(PRBool)
+nsChromeRegistry::WrappersEnabled(nsIURI *aURI)
+{
+  nsCOMPtr<nsIURL> chromeURL (do_QueryInterface(aURI));
+  if (!chromeURL)
+    return PR_FALSE;
+
+  PRBool isChrome = PR_FALSE;
+  nsresult rv = chromeURL->SchemeIs("chrome", &isChrome);
+  if (NS_FAILED(rv) || !isChrome)
+    return PR_FALSE;
+
+  nsCAutoString package;
+  rv = chromeURL->GetHostPort(package);
+  if (NS_FAILED(rv))
+    return PR_FALSE;
+
+  PackageEntry* entry =
+    static_cast<PackageEntry*>(PL_DHashTableOperate(&mPackagesHash,
+                                                    & (nsACString&) package,
+                                                    PL_DHASH_LOOKUP));
+
+  return PL_DHASH_ENTRY_IS_LIVE(entry) &&
+         entry->flags & PackageEntry::XPCNATIVEWRAPPERS;
 }
 
 nsresult
 nsChromeRegistry::ProcessNewChromeFile(nsILocalFile *aListFile, nsIURI* aManifest)
 {
   nsresult rv;
 
   PRFileDesc *file;
diff -r a4343d61f6ee client.py
--- a/client.py	Thu Nov 06 18:33:22 2008 +0100
+++ b/client.py	Sat Nov 15 19:43:12 2008 -0500
@@ -6,32 +6,21 @@ NSS_DIRS  = ('dbm',
              'security/coreconf',
              'security/dbm')
 
 import os
 import sys
 import datetime
 import shutil
 from optparse import OptionParser
+from build.util import check_call
 
 topsrcdir = os.path.dirname(__file__)
 if topsrcdir == '':
     topsrcdir = '.'
-
-try:
-    from subprocess import check_call
-except ImportError:
-    import subprocess
-    def check_call(*popenargs, **kwargs):
-        retcode = subprocess.call(*popenargs, **kwargs)
-        if retcode:
-            cmd = kwargs.get("args")
-            if cmd is None:
-                cmd = popenargs[0]
-                raise Exception("Command '%s' returned non-zero exit status %i" % (cmd, retcode))
 
 def check_call_noisy(cmd, *args, **kwargs):
     print "Executing command:", cmd
     check_call(cmd, *args, **kwargs)
 
 def do_hg_pull(dir, repository, hg):
     fulldir = os.path.join(topsrcdir, dir)
     # clone if the dir doesn't exist, pull if it does
diff -r a4343d61f6ee config/Makefile.in
--- a/config/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/config/Makefile.in	Sat Nov 15 19:43:12 2008 -0500
@@ -57,18 +57,18 @@ endif
 
 PLSRCS		= nfspwd.pl revdepth.pl
 
 TARGETS		= $(HOST_PROGRAM) $(PLSRCS:.pl=) $(SIMPLE_PROGRAMS)
 
 ifndef CROSS_COMPILE
 ifdef USE_ELF_DYNSTR_GC
 TARGETS		+= elf-dynstr-gc
-MAKE_DIRS	+= $(MDDEPDIR)
-GARBAGE_DIRS	+= $(MDDEPDIR)
+# Compiling the above will create dependency files.
+NEED_MDDEPDIR	= 1
 endif
 endif
 
 # IMPORTANT: Disable NSBUILDROOT for this directory only, otherwise we have
 # a recursive rule for finding nsinstall and the Perl scripts.
 ifdef NSBUILDROOT
 override NSBUILDROOT :=
 endif
diff -r a4343d61f6ee config/autoconf.mk.in
--- a/config/autoconf.mk.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/config/autoconf.mk.in	Sat Nov 15 19:43:12 2008 -0500
@@ -154,16 +154,18 @@ MOZ_SAFE_BROWSING = @MOZ_SAFE_BROWSING@
 MOZ_SAFE_BROWSING = @MOZ_SAFE_BROWSING@
 MOZ_URL_CLASSIFIER = @MOZ_URL_CLASSIFIER@
 MOZ_ZIPWRITER = @MOZ_ZIPWRITER@
 MOZ_MORK = @MOZ_MORK@
 MOZ_MORKREADER = @MOZ_MORKREADER@
 MOZ_NO_XPCOM_OBSOLETE = @MOZ_NO_XPCOM_OBSOLETE@
 MOZ_NO_FAST_LOAD = @MOZ_NO_FAST_LOAD@
 MOZ_OGG = @MOZ_OGG@
+MOZ_SYDNEYAUDIO = @MOZ_SYDNEYAUDIO@
+MOZ_WAVE = @MOZ_WAVE@
 MOZ_MEDIA = @MOZ_MEDIA@
 NS_PRINTING = @NS_PRINTING@
 MOZ_CRASHREPORTER = @MOZ_CRASHREPORTER@
 MOZ_HELP_VIEWER = @MOZ_HELP_VIEWER@
 MOC= @MOC@
 
 MOZ_JAVAXPCOM = @MOZ_JAVAXPCOM@
 JAVA_INCLUDE_PATH="@JAVA_INCLUDE_PATH@"
diff -r a4343d61f6ee config/rules.mk
--- a/config/rules.mk	Thu Nov 06 18:33:22 2008 +0100
+++ b/config/rules.mk	Sat Nov 15 19:43:12 2008 -0500
@@ -350,16 +350,19 @@ endif
 
 XPIDL_GEN_DIR		= _xpidlgen
 
 ifdef MOZ_UPDATE_XTERM
 # Its good not to have a newline at the end of the titlebar string because it
 # makes the make -s output easier to read.  Echo -n does not work on all
 # platforms, but we can trick sed into doing it.
 UPDATE_TITLE = sed -e "s!Y!$@ in $(shell $(BUILD_TOOLS)/print-depth-path.sh)/$(dir)!" $(MOZILLA_DIR)/config/xterm.str;
+UPDATE_TITLE_export = sed -e "s!Y!export in $(shell $(BUILD_TOOLS)/print-depth-path.sh)/$*!" $(MOZILLA_DIR)/config/xterm.str;
+UPDATE_TITLE_libs = sed -e "s!Y!libs in $(shell $(BUILD_TOOLS)/print-depth-path.sh)/$*!" $(MOZILLA_DIR)/config/xterm.str;
+UPDATE_TITLE_tools = sed -e "s!Y!tools in $(shell $(BUILD_TOOLS)/print-depth-path.sh)/$*!" $(MOZILLA_DIR)/config/xterm.str;
 endif
 
 LOOP_OVER_DIRS = \
     @$(EXIT_ON_ERROR) \
     $(foreach dir,$(DIRS),$(UPDATE_TITLE) $(MAKE) -C $(dir) $@; ) true
 
 # we only use this for the makefiles target and other stuff that doesn't matter
 LOOP_OVER_PARALLEL_DIRS = \
@@ -391,18 +394,20 @@ PROGOBJS		= $(OBJS)
 PROGOBJS		= $(OBJS)
 endif
 
 ifndef HOST_PROGOBJS
 HOST_PROGOBJS		= $(HOST_OBJS)
 endif
 
 # MAKE_DIRS: List of directories to build while looping over directories.
-ifneq (,$(OBJS)$(XPIDLSRCS)$(SDK_XPIDLSRCS)$(SIMPLE_PROGRAMS))
-MAKE_DIRS		+= $(MDDEPDIR)
+# A Makefile that needs $(MDDEPDIR) created but doesn't set any of these
+# variables we know to check can just set NEED_MDDEPDIR explicitly.
+ifneq (,$(OBJS)$(XPIDLSRCS)$(SDK_XPIDLSRCS)$(SIMPLE_PROGRAMS)$(NEED_MDDEPDIR))
+MAKE_DIRS		+= $(CURDIR)/$(MDDEPDIR)
 GARBAGE_DIRS		+= $(MDDEPDIR)
 endif
 
 #
 # Tags: emacs (etags), vi (ctags)
 # TAG_PROGRAM := ctags -L -
 #
 TAG_PROGRAM		= xargs etags -a
@@ -692,28 +697,28 @@ ifneq (,$(DIRS)$(TOOL_DIRS)$(PARALLEL_DI
 	+$(LOOP_OVER_DIRS)
 	+$(LOOP_OVER_TOOL_DIRS)
 endif
 
 ifdef PARALLEL_DIRS
 export:: $(PARALLEL_DIRS_export)
 
 $(PARALLEL_DIRS_export): %_export: %/Makefile
-	+$(MAKE) -C $* export
+	+@$(UPDATE_TITLE_export) $(MAKE) -C $* export
 endif
 
 export:: $(SUBMAKEFILES) $(MAKE_DIRS) $(if $(EXPORTS)$(XPIDLSRCS)$(SDK_HEADERS)$(SDK_XPIDLSRCS),$(PUBLIC)) $(if $(SDK_HEADERS)$(SDK_XPIDLSRCS),$(SDK_PUBLIC)) $(if $(XPIDLSRCS),$(IDL_DIR)) $(if $(SDK_XPIDLSRCS),$(SDK_IDL_DIR))
 	+$(LOOP_OVER_DIRS)
 	+$(LOOP_OVER_TOOL_DIRS)
 
 ifdef PARALLEL_DIRS
 tools:: $(PARALLEL_DIRS_tools)
 
 $(PARALLEL_DIRS_tools): %_tools: %/Makefile
-	+$(MAKE) -C $* tools
+	+@$(UPDATE_TITLE_tools) $(MAKE) -C $* tools
 endif
 
 tools:: $(SUBMAKEFILES) $(MAKE_DIRS)
 	+$(LOOP_OVER_DIRS)
 ifdef TOOL_DIRS
 	@$(EXIT_ON_ERROR) \
 	$(foreach dir,$(TOOL_DIRS),$(UPDATE_TITLE) $(MAKE) -C $(dir) libs; ) true
 endif
@@ -742,17 +747,17 @@ HOST_LIBS_DEPS = $(filter %.$(LIB_SUFFIX
 HOST_LIBS_DEPS = $(filter %.$(LIB_SUFFIX), $(HOST_LIBS))
 DSO_LDOPTS_DEPS = $(EXTRA_DSO_LIBS) $(filter %.$(LIB_SUFFIX), $(EXTRA_DSO_LDOPTS))
 
 ##############################################
 ifdef PARALLEL_DIRS
 libs:: $(PARALLEL_DIRS_libs)
 
 $(PARALLEL_DIRS_libs): %_libs: %/Makefile
-	+$(MAKE) -C $* libs
+	+@$(UPDATE_TITLE_libs) $(MAKE) -C $* libs
 endif
 
 libs:: $(SUBMAKEFILES) $(MAKE_DIRS) $(HOST_LIBRARY) $(LIBRARY) $(SHARED_LIBRARY) $(IMPORT_LIBRARY) $(HOST_PROGRAM) $(PROGRAM) $(HOST_SIMPLE_PROGRAMS) $(SIMPLE_PROGRAMS) $(JAVA_LIBRARY)
 ifndef NO_DIST_INSTALL
 ifdef LIBRARY
 ifdef EXPORT_LIBRARY # Stage libs that will be linked into a static build
 ifdef IS_COMPONENT
 	$(INSTALL) $(IFLAGS1) $(LIBRARY) $(DEPTH)/staticlib/components
@@ -1480,17 +1485,16 @@ endif
 endif
 endif
 
 ifneq ($(XPI_NAME),)
 $(FINAL_TARGET):
 	$(NSINSTALL) -D $@
 
 export:: $(FINAL_TARGET)
-	$(NSINSTALL) -D $(FINAL_TARGET)
 endif
 
 ifndef NO_DIST_INSTALL
 ifneq ($(EXPORTS),)
 export:: $(EXPORTS) $(PUBLIC)
 	$(INSTALL) $(IFLAGS1) $^
 endif 
 
@@ -2036,17 +2040,23 @@ endif # COMPILER_DEPEND
 
 
 #############################################################################
 # MDDEPDIR is the subdirectory where all the dependency files are placed.
 #   This uses a make rule (instead of a macro) to support parallel
 #   builds (-jN). If this were done in the LOOP_OVER_DIRS macro, two
 #   processes could simultaneously try to create the same directory.
 #
-$(MDDEPDIR):
+#   We use $(CURDIR) in the rule's target to ensure that we don't find
+#   a dependency directory in the source tree via VPATH (perhaps from
+#   a previous build in the source tree) and thus neglect to create a
+#   dependency directory in the object directory, where we really need
+#   it.
+
+$(CURDIR)/$(MDDEPDIR):
 	@if test ! -d $@; then echo Creating $@; rm -rf $@; mkdir $@; else true; fi
 
 ifneq (,$(filter-out all chrome default export realchrome tools clean clobber clobber_all distclean realclean,$(MAKECMDGOALS)))
 ifneq (,$(OBJS)$(XPIDLSRCS)$(SDK_XPIDLSRCS)$(SIMPLE_PROGRAMS))
 MDDEPEND_FILES		:= $(strip $(wildcard $(MDDEPDIR)/*.pp))
 
 ifneq (,$(MDDEPEND_FILES))
 ifdef PERL
diff -r a4343d61f6ee configure.in
--- a/configure.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/configure.in	Sat Nov 15 19:43:12 2008 -0500
@@ -4303,16 +4303,18 @@ MOZ_MORK=1
 MOZ_MORK=1
 MOZ_MORKREADER=
 MOZ_AUTH_EXTENSION=1
 MOZ_NO_ACTIVEX_SUPPORT=1
 MOZ_NO_INSPECTOR_APIS=
 MOZ_NO_XPCOM_OBSOLETE=
 MOZ_NO_FAST_LOAD=
 MOZ_OGG=1
+MOZ_SYDNEYAUDIO=
+MOZ_WAVE=1
 MOZ_MEDIA=
 MOZ_OJI=1
 MOZ_PERMISSIONS=1
 MOZ_PLACES=
 MOZ_PLAINTEXT_EDITOR_ONLY=
 MOZ_PLUGINS=1
 MOZ_PREF_EXTENSIONS=1
 MOZ_PROFILELOCKING=1
@@ -5275,43 +5277,76 @@ MOZ_ARG_DISABLE_BOOL(xpcom-fastload,
 
 AC_SUBST(MOZ_NO_FAST_LOAD)
 
 if test -n "$MOZ_NO_FAST_LOAD"; then
     AC_DEFINE(MOZ_NO_FAST_LOAD)
 fi
 
 dnl ========================================================
-dnl = Enable Ogg Codecs
+dnl = Disable Ogg Codecs
 dnl ========================================================
 MOZ_ARG_DISABLE_BOOL(ogg,
 [  --disable-ogg           Disable Ogg Codec support],
     MOZ_OGG=,
     MOZ_OGG=1)
 
 AC_SUBST(MOZ_OGG)
 
 if test -n "$MOZ_OGG"; then
     AC_DEFINE(MOZ_OGG)
+    MOZ_SYDNEYAUDIO=1
     MOZ_MEDIA=1
+fi
+
+dnl ========================================================
+dnl = Disable Wave decoder support
+dnl ========================================================
+MOZ_ARG_ENABLE_BOOL(wave,
+[  --disable-wave          Disable Wave decoder support],
+    MOZ_WAVE=,
+    MOZ_WAVE=1)
+
+AC_SUBST(MOZ_WAVE)
+
+if test -n "$MOZ_WAVE"; then
+    AC_DEFINE(MOZ_WAVE)
+    MOZ_SYDNEYAUDIO=1
+    MOZ_MEDIA=1
+fi
+
+dnl ========================================================
+dnl = Handle dependent SYDNEYAUDIO and MEDIA defines
+dnl ========================================================
+
+AC_SUBST(MOZ_SYDNEYAUDIO)
+
+if test -n "$MOZ_SYDNEYAUDIO"; then
+    AC_DEFINE(MOZ_SYDNEYAUDIO)
 fi
 
 AC_SUBST(MOZ_MEDIA)
 
 if test -n "$MOZ_MEDIA"; then
     AC_DEFINE(MOZ_MEDIA)
 fi
 
-dnl If using Ogg with Linux, ensure that the alsa library is available
-if test -n "$MOZ_OGG"; then
+dnl ========================================================
+dnl = Check alsa availability on Linux if using sydneyaudio
+dnl ========================================================
+
+dnl If using sydneyaudio with Linux, ensure that the alsa library is available
+if test "$COMPILE_ENVIRONMENT"; then
+if test -n "$MOZ_SYDNEYAUDIO"; then
    case "$target_os" in
 linux*)
       AC_CHECK_LIB(asound, snd_pcm_open,,AC_MSG_ERROR([Ogg support on Linux requires the alsa library]))
       ;;
    esac
+fi
 fi
 
 dnl ========================================================
 dnl Permissions System
 dnl ========================================================
 MOZ_ARG_DISABLE_BOOL(permissions,
 [  --disable-permissions   Disable permissions (popup and cookie blocking)],
     MOZ_PERMISSIONS=,
diff -r a4343d61f6ee content/base/public/nsContentUtils.h
--- a/content/base/public/nsContentUtils.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/public/nsContentUtils.h	Sat Nov 15 19:43:12 2008 -0500
@@ -802,16 +802,30 @@ public:
                                         const PRUnichar **aParams,
                                         PRUint32 aParamsLength,
                                         nsXPIDLString& aResult);
 
   /**
    * Returns true if aDocument is a chrome document
    */
   static PRBool IsChromeDoc(nsIDocument *aDocument);
+
+  /**
+   * Get the script file name to use when compiling the script
+   * referenced by aURI. In cases where there's no need for any extra
+   * security wrapper automation the script file name that's returned
+   * will be the spec in aURI, else it will be the spec in aDocument's
+   * URI followed by aURI's spec, separated by " -> ". Returns PR_TRUE
+   * if the script file name was modified, PR_FALSE if it's aURI's
+   * spec.
+   */
+  static PRBool GetWrapperSafeScriptFilename(nsIDocument *aDocument,
+                                             nsIURI *aURI,
+                                             nsACString& aScriptURI);
+
 
   /**
    * Returns true if aDocument belongs to a chrome docshell for
    * display purposes.  Returns false for null documents or documents
    * which do not belong to a docshell.
    */
   static PRBool IsInChromeDocshell(nsIDocument *aDocument);
 
diff -r a4343d61f6ee content/base/public/nsIChromeRegistry.idl
--- a/content/base/public/nsIChromeRegistry.idl	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/public/nsIChromeRegistry.idl	Sat Nov 15 19:43:12 2008 -0500
@@ -38,17 +38,17 @@
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 #include "nsISupports.idl"
 
 interface nsIURI;
 
-[scriptable, uuid(68389281-f6d0-4533-841d-344a2018140c)]
+[scriptable, uuid(249fb5ad-ae29-4e2c-a728-ba5cf464d188)]
 interface nsIChromeRegistry : nsISupports
 {
   const PRInt32 NONE = 0;
   const PRInt32 PARTIAL = 1;
   const PRInt32 FULL = 2;
 
   /**
    * Resolve a chrome URL to an loadable URI using the information in the
@@ -68,16 +68,21 @@ interface nsIChromeRegistry : nsISupport
    * @param aChromeURL the URL that is to be converted.
    */
   nsIURI convertChromeURL(in nsIURI aChromeURL);
 
   /**
    * refresh the chrome list at runtime, looking for new packages/etc
    */
   void checkForNewChrome();
+
+  /**
+   * returns whether XPCNativeWrappers are enabled for aURI.
+   */
+  [notxpcom] boolean wrappersEnabled(in nsIURI aURI);
 };
 
 [scriptable, uuid(2860e205-490e-4b06-90b6-87160d35a5a7)]
 interface nsIXULChromeRegistry : nsIChromeRegistry
 {
   /* Should be called when locales change to reload all chrome (including XUL). */
   void reloadChrome();
   
diff -r a4343d61f6ee content/base/public/nsIContent.h
--- a/content/base/public/nsIContent.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/public/nsIContent.h	Sat Nov 15 19:43:12 2008 -0500
@@ -897,39 +897,26 @@ NS_DEFINE_STATIC_IID_ACCESSOR(nsIContent
 
 // Some cycle-collecting helper macros for nsIContent subclasses
 
 #define NS_IMPL_CYCLE_COLLECTION_TRAVERSE_LISTENERMANAGER \
   if (tmp->HasFlag(NODE_HAS_LISTENERMANAGER)) {           \
     nsContentUtils::TraverseListenerManager(tmp, cb);     \
   }
 
-#define NS_IMPL_CYCLE_COLLECTION_TRAVERSE_PRESERVED_WRAPPER      \
-  {                                                              \
-    nsISupports *preservedWrapper = nsnull;                      \
-    if (tmp->GetOwnerDoc())                                      \
-      preservedWrapper = tmp->GetOwnerDoc()->GetReference(tmp);  \
-    NS_CYCLE_COLLECTION_NOTE_EDGE_NAME(cb, "[preserved wrapper]");\
-    cb.NoteXPCOMChild(preservedWrapper);                         \
-  }
-
 #define NS_IMPL_CYCLE_COLLECTION_TRAVERSE_USERDATA \
   if (tmp->HasProperties()) {                      \
     nsNodeUtils::TraverseUserData(tmp, cb);        \
   }
 
 #define NS_IMPL_CYCLE_COLLECTION_UNLINK_LISTENERMANAGER \
   if (tmp->HasFlag(NODE_HAS_LISTENERMANAGER)) {         \
     nsContentUtils::RemoveListenerManager(tmp);         \
     tmp->UnsetFlags(NODE_HAS_LISTENERMANAGER);          \
   }
 
-#define NS_IMPL_CYCLE_COLLECTION_UNLINK_PRESERVED_WRAPPER \
-  if (tmp->GetOwnerDoc())                                 \
-    tmp->GetOwnerDoc()->RemoveReference(tmp);
-
 #define NS_IMPL_CYCLE_COLLECTION_UNLINK_USERDATA \
   if (tmp->HasProperties()) {                    \
     nsNodeUtils::UnlinkUserData(tmp);            \
   }
 
 
 #endif /* nsIContent_h___ */
diff -r a4343d61f6ee content/base/public/nsIDocument.h
--- a/content/base/public/nsIDocument.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/public/nsIDocument.h	Sat Nov 15 19:43:12 2008 -0500
@@ -92,18 +92,18 @@ class nsBindingManager;
 class nsBindingManager;
 class nsIDOMNodeList;
 class mozAutoSubtreeModified;
 struct JSObject;
 class nsFrameLoader;
 
 // IID for the nsIDocument interface
 #define NS_IDOCUMENT_IID      \
-{ 0x6304ae8e, 0x2634, 0x45ed, \
-  { 0x9e, 0x09, 0x83, 0x09, 0x5b, 0x46, 0x72, 0x8b } }
+{ 0x92b19d1c, 0x8f37, 0x4d4b, \
+  { 0xa3, 0x42, 0xb5, 0xc6, 0x8b, 0x54, 0xde, 0x6c } }
 
 // Flag for AddStyleSheet().
 #define NS_STYLESHEET_FROM_CATALOG                (1 << 0)
 
 //----------------------------------------------------------------------
 
 // Document interface.  This is implemented by all document objects in
 // Gecko.
@@ -672,20 +672,16 @@ public:
 
   /**
    * Reset this document to aURI, aLoadGroup, and aPrincipal.  aURI must not be
    * null.  If aPrincipal is null, a codebase principal based on aURI will be
    * used.
    */
   virtual void ResetToURI(nsIURI *aURI, nsILoadGroup* aLoadGroup,
                           nsIPrincipal* aPrincipal) = 0;
-
-  virtual void AddReference(void *aKey, nsISupports *aReference) = 0;
-  virtual nsISupports *GetReference(void *aKey) = 0;
-  virtual void RemoveReference(void *aKey) = 0;
 
   /**
    * Set the container (docshell) for this document.
    */
   void SetContainer(nsISupports *aContainer)
   {
     mDocumentContainer = do_GetWeakReference(aContainer);
   }
diff -r a4343d61f6ee content/base/public/nsINode.h
--- a/content/base/public/nsINode.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/public/nsINode.h	Sat Nov 15 19:43:12 2008 -0500
@@ -39,16 +39,17 @@
 #define nsINode_h___
 
 #include "nsPIDOMEventTarget.h"
 #include "nsEvent.h"
 #include "nsPropertyTable.h"
 #include "nsTObserverArray.h"
 #include "nsINodeInfo.h"
 #include "nsCOMPtr.h"
+#include "nsWrapperCache.h"
 
 class nsIContent;
 class nsIDocument;
 class nsIDOMEvent;
 class nsIPresShell;
 class nsPresContext;
 class nsEventChainVisitor;
 class nsEventChainPreVisitor;
@@ -145,26 +146,27 @@ inline nsINode* NODE_FROM(C& aContent, D
   if (aContent)
     return static_cast<nsINode*>(aContent);
   return static_cast<nsINode*>(aDocument);
 }
 
 
 // IID for the nsINode interface
 #define NS_INODE_IID \
-{ 0x2593b0d5, 0x9a06, 0x4d6b, \
-  { 0x9a, 0x10, 0xb1, 0x39, 0x9f, 0x1b, 0xa0, 0x8e } }
-
+{ 0x0f7b2557, 0xa09d, 0x468f, \
+  { 0x93, 0x92, 0xf1, 0xf1, 0xd1, 0xfa, 0x31, 0x78 } }
 
 /**
  * An internal interface that abstracts some DOMNode-related parts that both
  * nsIContent and nsIDocument share.  An instance of this interface has a list
  * of nsIContent children and provides access to them.
  */
-class nsINode : public nsPIDOMEventTarget {
+class nsINode : public nsPIDOMEventTarget,
+                public nsWrapperCache
+{
 public:
   NS_DECLARE_STATIC_IID_ACCESSOR(NS_INODE_IID)
 
   friend class nsNodeUtils;
   friend class nsNodeWeakReference;
   friend class nsNodeSupportsWeakRefTearoff;
 
 #ifdef MOZILLA_INTERNAL_API
@@ -845,9 +847,17 @@ extern const nsIID kThisPtrOffsetsSID;
     NS_INTERFACE_TABLE_ENTRY(_class, _i7)                                     \
     NS_INTERFACE_TABLE_ENTRY(_class, _i8)                                     \
   NS_OFFSET_AND_INTERFACE_TABLE_END                                           \
   NS_OFFSET_AND_INTERFACE_TABLE_TO_MAP_SEGUE
 
 
 NS_DEFINE_STATIC_IID_ACCESSOR(nsINode, NS_INODE_IID)
 
+
+#define NS_IMPL_CYCLE_COLLECTION_TRAVERSE_PRESERVED_WRAPPER \
+   tmp->TraverseWrapper(cb);
+
+#define NS_IMPL_CYCLE_COLLECTION_UNLINK_PRESERVED_WRAPPER \
+  tmp->ReleaseWrapper();
+
+
 #endif /* nsINode_h___ */
diff -r a4343d61f6ee content/base/src/nsContentList.cpp
--- a/content/base/src/nsContentList.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/src/nsContentList.cpp	Sat Nov 15 19:43:12 2008 -0500
@@ -353,16 +353,17 @@ nsContentList::~nsContentList()
     // Clean up mData
     (*mDestroyFunc)(mData);
   }
 }
 
 
 // QueryInterface implementation for nsContentList
 NS_INTERFACE_TABLE_HEAD(nsContentList)
+  NS_WRAPPERCACHE_INTERFACE_MAP_ENTRY
   NS_NODELIST_OFFSET_AND_INTERFACE_TABLE_BEGIN(nsContentList)
     NS_CONTENT_LIST_INTERFACES(nsContentList)
     NS_INTERFACE_TABLE_ENTRY(nsContentList, nsIHTMLCollection)
     NS_INTERFACE_TABLE_ENTRY(nsContentList, nsIDOMHTMLCollection)
     NS_INTERFACE_TABLE_ENTRY(nsContentList, nsIMutationObserver)
   NS_OFFSET_AND_INTERFACE_TABLE_END
   NS_OFFSET_AND_INTERFACE_TABLE_TO_MAP_SEGUE
   NS_INTERFACE_MAP_ENTRY_CONTENT_CLASSINFO(ContentList)
diff -r a4343d61f6ee content/base/src/nsContentList.h
--- a/content/base/src/nsContentList.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/src/nsContentList.h	Sat Nov 15 19:43:12 2008 -0500
@@ -49,16 +49,17 @@
 #include "nsString.h"
 #include "nsIHTMLCollection.h"
 #include "nsIDOMNodeList.h"
 #include "nsINodeList.h"
 #include "nsStubMutationObserver.h"
 #include "nsIAtom.h"
 #include "nsINameSpaceManager.h"
 #include "nsCycleCollectionParticipant.h"
+#include "nsWrapperCache.h"
 
 // Magic namespace id that means "match all namespaces".  This is
 // negative so it won't collide with actual namespace constants.
 #define kNameSpaceID_Wildcard PR_INT32_MIN
 
 // This is a callback function type that can be used to implement an
 // arbitrary matching algorithm.  aContent is the content that may
 // match the list, while aNamespaceID, aAtom, and aData are whatever
@@ -177,17 +178,18 @@ protected:
 
 /**
  * Class that implements a live NodeList that matches Elements in the
  * tree based on some criterion.
  */
 class nsContentList : public nsBaseContentList,
                       protected nsContentListKey,
                       public nsIHTMLCollection,
-                      public nsStubMutationObserver
+                      public nsStubMutationObserver,
+                      public nsWrapperCache
 {
 public:
   NS_DECL_ISUPPORTS_INHERITED
 
   /**
    * @param aRootNode The node under which to limit our search.
    * @param aMatchAtom An atom whose meaning depends on aMatchNameSpaceId.
    *                   The special value "*" always matches whatever aMatchAtom
diff -r a4343d61f6ee content/base/src/nsContentSink.cpp
--- a/content/base/src/nsContentSink.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/src/nsContentSink.cpp	Sat Nov 15 19:43:12 2008 -0500
@@ -97,16 +97,18 @@
 #include "nsThreadUtils.h"
 #include "nsPresShellIterator.h"
 #include "nsPIDOMWindow.h"
 #include "mozAutoDocUpdate.h"
 #include "nsIWebNavigation.h"
 #include "nsIDocumentLoader.h"
 #include "nsICachingChannel.h"
 #include "nsICacheEntryDescriptor.h"
+#include "nsGenericHTMLElement.h"
+#include "nsHTMLDNSPrefetch.h"
 
 PRLogModuleInfo* gContentSinkLogModuleInfo;
 
 class nsScriptLoaderObserverProxy : public nsIScriptLoaderObserver
 {
 public:
   nsScriptLoaderObserverProxy(nsIScriptLoaderObserver* aInner)
     : mInner(do_GetWeakReference(aInner))
@@ -717,16 +719,20 @@ nsContentSink::ProcessLink(nsIContent* a
   nsStyleLinkElement::ParseLinkTypes(aRel, linkTypes);
 
   PRBool hasPrefetch = (linkTypes.IndexOf(NS_LITERAL_STRING("prefetch")) != -1);
   // prefetch href if relation is "next" or "prefetch"
   if (hasPrefetch || linkTypes.IndexOf(NS_LITERAL_STRING("next")) != -1) {
     PrefetchHref(aHref, aElement, hasPrefetch);
   }
 
+  if ((!aHref.IsEmpty()) && linkTypes.IndexOf(NS_LITERAL_STRING("dns-prefetch")) != -1) {
+    PrefetchDNS(aHref);
+  }
+
   // is it a stylesheet link?
   if (linkTypes.IndexOf(NS_LITERAL_STRING("stylesheet")) == -1) {
     return NS_OK;
   }
 
   PRBool isAlternate = linkTypes.IndexOf(NS_LITERAL_STRING("alternate")) != -1;
   return ProcessStyleLink(aElement, aHref, isAlternate, aTitle, aType,
                           aMedia);
@@ -845,16 +851,33 @@ nsContentSink::PrefetchHref(const nsAStr
     nsCOMPtr<nsIURI> uri;
     NS_NewURI(getter_AddRefs(uri), aHref,
               charset.IsEmpty() ? nsnull : PromiseFlatCString(charset).get(),
               mDocumentBaseURI);
     if (uri) {
       nsCOMPtr<nsIDOMNode> domNode = do_QueryInterface(aSource);
       prefetchService->PrefetchURI(uri, mDocumentURI, domNode, aExplicit);
     }
+  }
+}
+
+void
+nsContentSink::PrefetchDNS(const nsAString &aHref)
+{
+  nsAutoString hostname;
+
+  if (StringBeginsWith(aHref, NS_LITERAL_STRING("//")))  {
+    hostname = Substring(aHref, 2);
+  }
+  else
+    nsGenericHTMLElement::GetHostnameFromHrefString(aHref, hostname);
+      
+  nsRefPtr<nsHTMLDNSPrefetch> prefetch = new nsHTMLDNSPrefetch(hostname, mDocument);
+  if (prefetch) {
+    prefetch->PrefetchLow();
   }
 }
 
 nsresult
 nsContentSink::GetChannelCacheKey(nsIChannel* aChannel, nsACString& aCacheKey)
 {
   aCacheKey.Truncate();
 
diff -r a4343d61f6ee content/base/src/nsContentSink.h
--- a/content/base/src/nsContentSink.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/src/nsContentSink.h	Sat Nov 15 19:43:12 2008 -0500
@@ -190,16 +190,20 @@ protected:
                                     PRBool aAlternate,
                                     const nsSubstring& aTitle,
                                     const nsSubstring& aType,
                                     const nsSubstring& aMedia);
 
   void PrefetchHref(const nsAString &aHref, nsIContent *aSource,
                     PRBool aExplicit);
 
+  // aHref can either be the usual URI format or of the form "//www.hostname.com"
+  // without a scheme.
+  void PrefetchDNS(const nsAString &aHref);
+
   // Gets the cache key (used to identify items in a cache) of the channel.
   nsresult GetChannelCacheKey(nsIChannel* aChannel, nsACString& aCacheKey);
 
   // There is an offline cache manifest attribute specified and the
   // document is allowed to use the offline cache.  Process the cache
   // selection algorithm for this document and the manifest. Result is
   // an action that must be taken on the manifest, see
   // CacheSelectionAction enum above.
diff -r a4343d61f6ee content/base/src/nsContentUtils.cpp
--- a/content/base/src/nsContentUtils.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/src/nsContentUtils.cpp	Sat Nov 15 19:43:12 2008 -0500
@@ -155,16 +155,17 @@ static NS_DEFINE_CID(kXTFServiceCID, NS_
 #include "nsAttrValue.h"
 #include "nsReferencedElement.h"
 #include "nsIUGenCategory.h"
 #include "nsIDragService.h"
 #include "nsIChannelEventSink.h"
 #include "nsIInterfaceRequestor.h"
 #include "nsIOfflineCacheUpdate.h"
 #include "nsCPrefetchService.h"
+#include "nsIChromeRegistry.h"
 
 #ifdef IBMBIDI
 #include "nsIBidiKeyboard.h"
 #endif
 #include "nsCycleCollectionParticipant.h"
 
 // for ReportToConsole
 #include "nsIStringBundle.h"
@@ -1101,25 +1102,16 @@ nsContentUtils::doReparentContentWrapper
 
   nsresult rv;
 
   rv = sXPConnect->ReparentWrappedNativeIfFound(cx, aOldGlobal, aNewGlobal,
                                                 aNode,
                                                 getter_AddRefs(old_wrapper));
   NS_ENSURE_SUCCESS(rv, rv);
 
-  if (aOldDocument) {
-    nsCOMPtr<nsISupports> old_ref = aOldDocument->GetReference(aNode);
-    if (old_ref) {
-      // Transfer the reference from aOldDocument to aNewDocument
-      aOldDocument->RemoveReference(aNode);
-      aNewDocument->AddReference(aNode, old_ref);
-    }
-  }
-
   // Whether or not aChild is already wrapped we must iterate through
   // its descendants since there's no guarantee that a descendant isn't
   // wrapped even if this child is not wrapped. That used to be true
   // when every DOM node's JSObject was parented at the DOM node's
   // parent's JSObject, but that's no longer the case.
 
   PRUint32 i, count = aNode->GetChildCount();
 
@@ -2910,16 +2902,63 @@ nsContentUtils::IsChromeDoc(nsIDocument 
   if (!aDocument) {
     return PR_FALSE;
   }
   
   nsCOMPtr<nsIPrincipal> systemPrincipal;
   sSecurityManager->GetSystemPrincipal(getter_AddRefs(systemPrincipal));
 
   return aDocument->NodePrincipal() == systemPrincipal;
+}
+
+PRBool
+nsContentUtils::GetWrapperSafeScriptFilename(nsIDocument *aDocument,
+                                             nsIURI *aURI,
+                                             nsACString& aScriptURI)
+{
+  PRBool scriptFileNameModified = PR_FALSE;
+  aURI->GetSpec(aScriptURI);
+
+  if (IsChromeDoc(aDocument)) {
+    nsCOMPtr<nsIChromeRegistry> chromeReg =
+      do_GetService(NS_CHROMEREGISTRY_CONTRACTID);
+
+    if (!chromeReg) {
+      // If we're running w/o a chrome registry we won't modify any
+      // script file names.
+
+      return scriptFileNameModified;
+    }
+
+    PRBool docWrappersEnabled =
+      chromeReg->WrappersEnabled(aDocument->GetDocumentURI());
+
+    PRBool uriWrappersEnabled = chromeReg->WrappersEnabled(aURI);
+
+    nsIURI *docURI = aDocument->GetDocumentURI();
+
+    if (docURI && docWrappersEnabled && !uriWrappersEnabled) {
+      // aURI is a script from a URL that doesn't get wrapper
+      // automation. aDocument is a chrome document that does get
+      // wrapper automation. Prepend the chrome document's URI
+      // followed by the string " -> " to the URI of the script we're
+      // loading here so that script in that URI gets the same wrapper
+      // automation that the chrome document expects.
+      nsCAutoString spec;
+      docURI->GetSpec(spec);
+      spec.AppendASCII(" -> ");
+      spec.Append(aScriptURI);
+
+      aScriptURI = spec;
+
+      scriptFileNameModified = PR_TRUE;
+    }
+  }
+
+  return scriptFileNameModified;
 }
 
 // static
 PRBool
 nsContentUtils::IsInChromeDocshell(nsIDocument *aDocument)
 {
   if (!aDocument) {
     return PR_FALSE;
diff -r a4343d61f6ee content/base/src/nsDOMAttribute.cpp
--- a/content/base/src/nsDOMAttribute.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/src/nsDOMAttribute.cpp	Sat Nov 15 19:43:12 2008 -0500
@@ -96,16 +96,17 @@ NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(ns
     NS_RELEASE(tmp->mChild);
   }
   NS_IMPL_CYCLE_COLLECTION_UNLINK_LISTENERMANAGER
   NS_IMPL_CYCLE_COLLECTION_UNLINK_USERDATA
   NS_IMPL_CYCLE_COLLECTION_UNLINK_PRESERVED_WRAPPER
 NS_IMPL_CYCLE_COLLECTION_UNLINK_END
 // QueryInterface implementation for nsDOMAttribute
 NS_INTERFACE_TABLE_HEAD(nsDOMAttribute)
+  NS_WRAPPERCACHE_INTERFACE_MAP_ENTRY
   NS_NODE_INTERFACE_TABLE7(nsDOMAttribute, nsIDOMAttr, nsIAttribute, nsINode,
                            nsIDOMNode, nsIDOM3Node, nsIDOM3Attr,
                            nsPIDOMEventTarget)
   NS_INTERFACE_MAP_ENTRIES_CYCLE_COLLECTION(nsDOMAttribute)
   NS_INTERFACE_MAP_ENTRY_TEAROFF(nsISupportsWeakReference,
                                  new nsNodeSupportsWeakRefTearoff(this))
   NS_INTERFACE_MAP_ENTRY_CONTENT_CLASSINFO(Attr)
 NS_INTERFACE_MAP_END
diff -r a4343d61f6ee content/base/src/nsDocument.cpp
--- a/content/base/src/nsDocument.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/src/nsDocument.cpp	Sat Nov 15 19:43:12 2008 -0500
@@ -1562,23 +1562,22 @@ nsDocument::~nsDocument()
   }
 
   delete mHeaderData;
 
   if (mBoxObjectTable) {
     mBoxObjectTable->EnumerateRead(ClearAllBoxObjects, nsnull);
     delete mBoxObjectTable;
   }
-
-  delete mContentWrapperHash;
 }
 
 NS_IMPL_CYCLE_COLLECTION_CLASS(nsDocument)
 
 NS_INTERFACE_TABLE_HEAD(nsDocument)
+  NS_WRAPPERCACHE_INTERFACE_MAP_ENTRY
   NS_DOCUMENT_INTERFACE_TABLE_BEGIN(nsDocument)
     NS_INTERFACE_TABLE_ENTRY(nsDocument, nsINode)
     NS_INTERFACE_TABLE_ENTRY(nsDocument, nsIDocument)
     NS_INTERFACE_TABLE_ENTRY(nsDocument, nsIDOM3DocumentEvent)
     NS_INTERFACE_TABLE_ENTRY(nsDocument, nsIDOMDocumentStyle)
     NS_INTERFACE_TABLE_ENTRY(nsDocument, nsIDOMNSDocumentStyle)
     NS_INTERFACE_TABLE_ENTRY(nsDocument, nsIDOMDocumentRange)
     NS_INTERFACE_TABLE_ENTRY(nsDocument, nsIDOMDocumentXBL)
@@ -1748,19 +1747,17 @@ NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN(
     tmp->mLinkMap.EnumerateEntries(LinkMapTraverser, &cb);
   }
 
   // Traverse all our nsCOMArrays.
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMARRAY(mStyleSheets)
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMARRAY(mCatalogSheets)
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMARRAY(mVisitednessChangedURIs)
 
-  // Traverse any associated preserved wrapper.
-  NS_CYCLE_COLLECTION_NOTE_EDGE_NAME(cb, "[preserved wrapper]");
-  cb.NoteXPCOMChild(tmp->GetReference(tmp));
+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE_PRESERVED_WRAPPER
 
   if (tmp->mSubDocuments && tmp->mSubDocuments->ops) {
     PL_DHashTableEnumerate(tmp->mSubDocuments, SubDocTraverser, &cb);
   }
 NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
 
 
 NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(nsDocument)
@@ -1781,21 +1778,19 @@ NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(ns
     tmp->mChildren.RemoveChildAt(indx);
   }
 
   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mCachedRootContent)
   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mDisplayDocument)
 
   NS_IMPL_CYCLE_COLLECTION_UNLINK_USERDATA
 
-  // Drop the content hash.
-  delete tmp->mContentWrapperHash;
-  tmp->mContentWrapperHash = nsnull;
-
   tmp->mParentDocument = nsnull;
+
+  NS_IMPL_CYCLE_COLLECTION_UNLINK_PRESERVED_WRAPPER
 
   // nsDocument has a pretty complex destructor, so we're going to
   // assume that *most* cycles you actually want to break somewhere
   // else, and not unlink an awful lot here.
   //
   // In rare cases where you think an unlink will help here, add one
   // manually.
 NS_IMPL_CYCLE_COLLECTION_UNLINK_END
@@ -6234,51 +6229,16 @@ nsDocument::FlushPendingNotifications(mo
 
   nsPresShellIterator iter(this);
   nsCOMPtr<nsIPresShell> shell;
   while ((shell = iter.GetNextShell())) {
     shell->FlushPendingNotifications(aType);
   }
 }
 
-void
-nsDocument::AddReference(void *aKey, nsISupports *aReference)
-{
-  if (mScriptGlobalObject) {
-    if (!mContentWrapperHash) {
-      mContentWrapperHash = new nsInterfaceHashtable<nsVoidPtrHashKey, nsISupports>;
-      if (mContentWrapperHash) {
-        mContentWrapperHash->Init(10);
-      }
-    }
-    
-    if (mContentWrapperHash)
-      mContentWrapperHash->Put(aKey, aReference);
-  }
-}
-
-nsISupports*
-nsDocument::GetReference(void *aKey)
-{
-  // NB: This method is part of content cycle collection,
-  // and must *not* Addref its return value.
-    
-  if (mContentWrapperHash)
-    return mContentWrapperHash->GetWeak(aKey);
-  return nsnull;
-}
-
-void
-nsDocument::RemoveReference(void *aKey)
-{
-  if (mContentWrapperHash) {
-    mContentWrapperHash->Remove(aKey);
-  }
-}
-
 nsIScriptEventManager*
 nsDocument::GetScriptEventManager()
 {
   if (!mScriptEventManager) {
     mScriptEventManager = new nsScriptEventManager(this);
     // automatically AddRefs
   }
 
@@ -6567,16 +6527,17 @@ nsDocument::RetrieveRelevantHeaders(nsIC
     }
 
     static const char *const headers[] = {
       "default-style",
       "content-style-type",
       "content-language",
       "content-disposition",
       "refresh",
+      "x-dns-prefetch-control",
       // add more http headers if you need
       // XXXbz don't add content-location support without reading bug
       // 238654 and its dependencies/dups first.
       0
     };
     
     nsCAutoString headerVal;
     const char *const *name = headers;
@@ -6882,20 +6843,17 @@ nsDocument::Destroy()
 
   // Shut down our external resource map.  We might not need this for
   // leak-fixing if we fix DocumentViewerImpl to do cycle-collection, but
   // tearing down all those frame trees right now is the right thing to do.
   mExternalResourceMap.Shutdown();
 
   // XXX We really should let cycle collection do this, but that currently still
   //     leaks (see https://bugzilla.mozilla.org/show_bug.cgi?id=406684).
-  //     When we start relying on cycle collection again we should remove the
-  //     check for mScriptGlobalObject in AddReference.
-  delete mContentWrapperHash;
-  mContentWrapperHash = nsnull;
+  ReleaseWrapper();
 }
 
 void
 nsDocument::RemovedFromDocShell()
 {
   if (mRemovedFromDocShell)
     return;
 
diff -r a4343d61f6ee content/base/src/nsDocument.h
--- a/content/base/src/nsDocument.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/src/nsDocument.h	Sat Nov 15 19:43:12 2008 -0500
@@ -745,19 +745,16 @@ public:
                                 nsIStyleRule* aOldStyleRule,
                                 nsIStyleRule* aNewStyleRule);
   virtual void StyleRuleAdded(nsIStyleSheet* aStyleSheet,
                               nsIStyleRule* aStyleRule);
   virtual void StyleRuleRemoved(nsIStyleSheet* aStyleSheet,
                                 nsIStyleRule* aStyleRule);
 
   virtual void FlushPendingNotifications(mozFlushType aType);
-  virtual void AddReference(void *aKey, nsISupports *aReference);
-  virtual nsISupports *GetReference(void *aKey);
-  virtual void RemoveReference(void *aKey);
   virtual nsIScriptEventManager* GetScriptEventManager();
   virtual void SetXMLDeclaration(const PRUnichar *aVersion,
                                  const PRUnichar *aEncoding,
                                  const PRInt32 aStandalone);
   virtual void GetXMLDeclaration(nsAString& aVersion,
                                  nsAString& aEncoding,
                                  nsAString& Standalone);
   virtual PRBool IsScriptEnabled();
@@ -1159,17 +1156,16 @@ protected:
                  "Shouldn't be called if table is already live!");
     ++mIdMissCount;
     return IdTableIsLive();
   }
 
   PRUint8 mIdMissCount;
 
   nsInterfaceHashtable<nsVoidPtrHashKey, nsPIBoxObject> *mBoxObjectTable;
-  nsInterfaceHashtable<nsVoidPtrHashKey, nsISupports> *mContentWrapperHash;
 
   // The channel that got passed to StartDocumentLoad(), if any
   nsCOMPtr<nsIChannel> mChannel;
   nsRefPtr<nsHTMLStyleSheet> mAttrStyleSheet;
   nsCOMPtr<nsIHTMLCSSStyleSheet> mStyleAttrStyleSheet;
   nsRefPtr<nsXMLEventsManager> mXMLEventsManager;
 
   nsCOMPtr<nsIScriptEventManager> mScriptEventManager;
diff -r a4343d61f6ee content/base/src/nsGenericDOMDataNode.cpp
--- a/content/base/src/nsGenericDOMDataNode.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/src/nsGenericDOMDataNode.cpp	Sat Nov 15 19:43:12 2008 -0500
@@ -100,17 +100,19 @@ NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
 NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
 
 NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(nsGenericDOMDataNode)
   NS_IMPL_CYCLE_COLLECTION_UNLINK_LISTENERMANAGER
   NS_IMPL_CYCLE_COLLECTION_UNLINK_USERDATA
   NS_IMPL_CYCLE_COLLECTION_UNLINK_PRESERVED_WRAPPER
 NS_IMPL_CYCLE_COLLECTION_UNLINK_END
 
-NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(nsGenericDOMDataNode)
+NS_INTERFACE_MAP_BEGIN(nsGenericDOMDataNode)
+  NS_WRAPPERCACHE_INTERFACE_MAP_ENTRY
+  NS_INTERFACE_MAP_ENTRIES_CYCLE_COLLECTION(nsGenericDOMDataNode)
   NS_INTERFACE_MAP_ENTRY(nsIContent)
   NS_INTERFACE_MAP_ENTRY(nsINode)
   NS_INTERFACE_MAP_ENTRY(nsPIDOMEventTarget)
   NS_INTERFACE_MAP_ENTRY_TEAROFF(nsIDOMEventTarget,
                                  nsDOMEventRTTearoff::Create(this))
   NS_INTERFACE_MAP_ENTRY_TEAROFF(nsIDOM3EventTarget,
                                  nsDOMEventRTTearoff::Create(this))
   NS_INTERFACE_MAP_ENTRY_TEAROFF(nsIDOMNSEventTarget,
@@ -853,16 +855,19 @@ void
 void
 nsGenericDOMDataNode::SaveSubtreeState()
 {
 }
 
 void
 nsGenericDOMDataNode::DestroyContent()
 {
+  // XXX We really should let cycle collection do this, but that currently still
+  //     leaks (see https://bugzilla.mozilla.org/show_bug.cgi?id=406684).
+  ReleaseWrapper();
 }
 
 #ifdef DEBUG
 void
 nsGenericDOMDataNode::List(FILE* out, PRInt32 aIndent) const
 {
 }
 
diff -r a4343d61f6ee content/base/src/nsGenericElement.cpp
--- a/content/base/src/nsGenericElement.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/src/nsGenericElement.cpp	Sat Nov 15 19:43:12 2008 -0500
@@ -457,16 +457,17 @@ nsIContent::FindFirstNonNativeAnonymous(
 }
 
 //----------------------------------------------------------------------
 
 NS_IMPL_ADDREF(nsChildContentList)
 NS_IMPL_RELEASE(nsChildContentList)
 
 NS_INTERFACE_TABLE_HEAD(nsChildContentList)
+  NS_WRAPPERCACHE_INTERFACE_MAP_ENTRY
   NS_NODELIST_OFFSET_AND_INTERFACE_TABLE_BEGIN(nsChildContentList)
     NS_INTERFACE_TABLE_ENTRY(nsChildContentList, nsINodeList)
     NS_INTERFACE_TABLE_ENTRY(nsChildContentList, nsIDOMNodeList)
   NS_OFFSET_AND_INTERFACE_TABLE_END
   NS_OFFSET_AND_INTERFACE_TABLE_TO_MAP_SEGUE
   NS_INTERFACE_MAP_ENTRY_CONTENT_CLASSINFO(NodeList)
 NS_INTERFACE_MAP_END
 
@@ -3468,16 +3469,20 @@ nsGenericElement::DestroyContent()
 nsGenericElement::DestroyContent()
 {
   nsIDocument *document = GetOwnerDoc();
   if (document) {
     document->BindingManager()->ChangeDocumentFor(this, document, nsnull);
     document->ClearBoxObjectFor(this);
   }
 
+  // XXX We really should let cycle collection do this, but that currently still
+  //     leaks (see https://bugzilla.mozilla.org/show_bug.cgi?id=406684).
+  ReleaseWrapper();
+
   PRUint32 i, count = mAttrsAndChildren.ChildCount();
   for (i = 0; i < count; ++i) {
     // The child can remove itself from the parent in BindToTree.
     mAttrsAndChildren.ChildAt(i)->DestroyContent();
   }
 }
 
 void
@@ -4061,17 +4066,19 @@ NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN(
         cb.NoteXPCOMChild(slots->mControllers);
       cb.NoteXPCOMChild(
         static_cast<nsIDOMNodeList*>(slots->mChildrenList.get()));
     }
   }
 NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
 
 
-NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(nsGenericElement)
+NS_INTERFACE_MAP_BEGIN(nsGenericElement)
+  NS_WRAPPERCACHE_INTERFACE_MAP_ENTRY
+  NS_INTERFACE_MAP_ENTRIES_CYCLE_COLLECTION(nsGenericElement)
   NS_INTERFACE_MAP_ENTRY(nsIContent)
   NS_INTERFACE_MAP_ENTRY(nsINode)
   NS_INTERFACE_MAP_ENTRY(nsPIDOMEventTarget)
   NS_INTERFACE_MAP_ENTRY_TEAROFF(nsIDOM3Node, new nsNode3Tearoff(this))
   NS_INTERFACE_MAP_ENTRY_TEAROFF(nsIDOMNSElement, new nsNSElementTearoff(this))
   NS_INTERFACE_MAP_ENTRY_TEAROFF(nsIDOMEventTarget,
                                  nsDOMEventRTTearoff::Create(this))
   NS_INTERFACE_MAP_ENTRY_TEAROFF(nsIDOM3EventTarget,
diff -r a4343d61f6ee content/base/src/nsGenericElement.h
--- a/content/base/src/nsGenericElement.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/src/nsGenericElement.h	Sat Nov 15 19:43:12 2008 -0500
@@ -84,17 +84,18 @@ typedef unsigned long PtrBits;
 typedef unsigned long PtrBits;
 
 /**
  * Class that implements the nsIDOMNodeList interface (a list of children of
  * the content), by holding a reference to the content and delegating GetLength
  * and Item to its existing child list.
  * @see nsIDOMNodeList
  */
-class nsChildContentList : public nsINodeList
+class nsChildContentList : public nsINodeList,
+                           public nsWrapperCache
 {
 public:
   nsChildContentList(nsINode* aNode)
     : mNode(aNode)
   {
   }
 
   NS_DECL_ISUPPORTS
@@ -103,16 +104,37 @@ public:
   NS_DECL_NSIDOMNODELIST
 
   // nsINodeList interface
   virtual nsINode* GetNodeAt(PRUint32 aIndex);  
   
   void DropReference()
   {
     mNode = nsnull;
+  }
+
+  nsISupports* GetParentObject()
+  {
+    return mNode;
+  }
+
+  static nsChildContentList* FromSupports(nsISupports* aSupports)
+  {
+    nsINodeList* list = static_cast<nsINodeList*>(aSupports);
+#ifdef DEBUG
+    {
+      nsCOMPtr<nsINodeList> list_qi = do_QueryInterface(aSupports);
+
+      // If this assertion fires the QI implementation for the object in
+      // question doesn't use the nsINodeList pointer as the nsISupports
+      // pointer. That must be fixed, or we'll crash...
+      NS_ASSERTION(list_qi == list, "Uh, fix QI!");
+    }
+#endif
+    return static_cast<nsChildContentList*>(list);
   }
 
 private:
   // The node whose children make up the list (weak reference)
   nsINode* mNode;
 };
 
 /**
diff -r a4343d61f6ee content/base/src/nsGkAtomList.h
--- a/content/base/src/nsGkAtomList.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/src/nsGkAtomList.h	Sat Nov 15 19:43:12 2008 -0500
@@ -982,16 +982,17 @@ GK_ATOM(where, "where")
 GK_ATOM(where, "where")
 GK_ATOM(widget, "widget")
 GK_ATOM(width, "width")
 GK_ATOM(window, "window")
 GK_ATOM(headerWindowTarget, "window-target")
 GK_ATOM(withParam, "with-param")
 GK_ATOM(wizard, "wizard")
 GK_ATOM(wrap, "wrap")
+GK_ATOM(headerDNSPrefetchControl,"x-dns-prefetch-control")
 GK_ATOM(xml, "xml")
 GK_ATOM(xmlns, "xmlns")
 GK_ATOM(xmp, "xmp")
 GK_ATOM(xulcontentsgenerated, "xulcontentsgenerated")
 GK_ATOM(yes, "yes")
 GK_ATOM(z_index, "z-index")
 GK_ATOM(zeroDigit, "zero-digit")
 
diff -r a4343d61f6ee content/base/src/nsNodeUtils.cpp
--- a/content/base/src/nsNodeUtils.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/src/nsNodeUtils.cpp	Sat Nov 15 19:43:12 2008 -0500
@@ -559,36 +559,25 @@ nsNodeUtils::CloneAndAdopt(nsINode *aNod
     else if (aDeep && clone->IsNodeOfType(nsINode::eDOCUMENT)) {
       // After cloning the document itself, we want to clone the children into
       // the cloned document (somewhat like cloning and importing them into the
       // cloned document).
       nodeInfoManager = clone->mNodeInfo->NodeInfoManager();
     }
   }
   else if (nodeInfoManager) {
-    nsCOMPtr<nsISupports> oldRef;
     nsIDocument* oldDoc = aNode->GetOwnerDoc();
-    if (oldDoc) {
-      if (aNode->IsNodeOfType(nsINode::eELEMENT)) {
-        oldDoc->ClearBoxObjectFor(static_cast<nsIContent*>(aNode));
-      }
-      oldRef = oldDoc->GetReference(aNode);
-      if (oldRef) {
-        oldDoc->RemoveReference(aNode);
-      }
+    if (oldDoc && aNode->IsNodeOfType(nsINode::eELEMENT)) {
+      oldDoc->ClearBoxObjectFor(static_cast<nsIContent*>(aNode));
     }
 
     aNode->mNodeInfo.swap(newNodeInfo);
 
     nsIDocument* newDoc = aNode->GetOwnerDoc();
     if (newDoc) {
-      if (oldRef) {
-        newDoc->AddReference(aNode, oldRef);
-      }
-
       nsPIDOMWindow* window = newDoc->GetInnerWindow();
       if (window) {
         nsCOMPtr<nsIEventListenerManager> elm;
         aNode->GetListenerManager(PR_FALSE, getter_AddRefs(elm));
         if (elm) {
           window->SetMutationListeners(elm->MutationListenerBits());
           if (elm->MayHavePaintEventListener()) {
             window->SetHasPaintEventListeners();
diff -r a4343d61f6ee content/base/src/nsScriptLoader.cpp
--- a/content/base/src/nsScriptLoader.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/src/nsScriptLoader.cpp	Sat Nov 15 19:43:12 2008 -0500
@@ -103,16 +103,17 @@ public:
 
   nsCOMPtr<nsIScriptElement> mElement;
   PRPackedBool mLoading;             // Are we still waiting for a load to complete?
   PRPackedBool mDefer;               // Is execution defered?
   PRPackedBool mIsInline;            // Is the script inline or loaded?
   nsString mScriptText;              // Holds script for loaded scripts
   PRUint32 mJSVersion;
   nsCOMPtr<nsIURI> mURI;
+  nsCOMPtr<nsIURI> mFinalURI;
   PRInt32 mLineNo;
 };
 
 // The nsScriptLoadRequest is passed as the context to necko, and thus
 // it needs to be threadsafe. Necko won't do anything with this
 // context, but it will AddRef and Release it on other threads.
 NS_IMPL_THREADSAFE_ISUPPORTS0(nsScriptLoadRequest)
 
@@ -617,31 +618,27 @@ nsScriptLoader::EvaluateScript(nsScriptL
   // Make sure context is a strong reference since we access it after
   // we've executed a script, which may cause all other references to
   // the context to go away.
   nsCOMPtr<nsIScriptContext> context = globalObject->GetScriptContext(stid);
   if (!context) {
     return NS_ERROR_FAILURE;
   }
 
-  nsCAutoString url;
-
-  if (aRequest->mURI) {
-    rv = aRequest->mURI->GetSpec(url);
-    if (NS_FAILED(rv)) {
-      return rv;
-    }
-  }
+  nsIURI* uri = aRequest->mFinalURI ? aRequest->mFinalURI : aRequest->mURI;
 
   PRBool oldProcessingScriptTag = context->GetProcessingScriptTag();
   context->SetProcessingScriptTag(PR_TRUE);
 
   // Update our current script.
   nsCOMPtr<nsIScriptElement> oldCurrent = mCurrentScript;
   mCurrentScript = aRequest->mElement;
+
+  nsCAutoString url;
+  nsContentUtils::GetWrapperSafeScriptFilename(mDocument, uri, url);
 
   PRBool isUndefined;
   rv = context->EvaluateString(aScript,
                           globalObject->GetScriptGlobal(stid),
                           mDocument->NodePrincipal(), url.get(),
                           aRequest->mLineNo, aRequest->mJSVersion, nsnull,
                           &isUndefined);
 
@@ -907,16 +904,17 @@ nsScriptLoader::PrepareLoadedRequest(nsS
     PRBool requestSucceeded;
     rv = httpChannel->GetRequestSucceeded(&requestSucceeded);
     if (NS_SUCCEEDED(rv) && !requestSucceeded) {
       return NS_ERROR_NOT_AVAILABLE;
     }
   }
 
   nsCOMPtr<nsIChannel> channel = do_QueryInterface(req);
+  NS_GetFinalChannelURI(channel, getter_AddRefs(aRequest->mFinalURI));
   if (aStringLen) {
     // Check the charset attribute to determine script charset.
     nsAutoString hintCharset;
     if (!aRequest->IsPreload()) {
       aRequest->mElement->GetScriptCharset(hintCharset);
     } else {
       nsTArray<PreloadInfo>::index_type i =
         mPreloads.IndexOf(aRequest, 0, PreloadRequestComparator());
diff -r a4343d61f6ee content/base/src/nsXMLHttpRequest.cpp
--- a/content/base/src/nsXMLHttpRequest.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/src/nsXMLHttpRequest.cpp	Sat Nov 15 19:43:12 2008 -0500
@@ -525,52 +525,42 @@ GetDocumentFromScriptContext(nsIScriptCo
   return doc;
 }
 
 /////////////////////////////////////////////
 
 NS_IMPL_CYCLE_COLLECTION_CLASS(nsXHREventTarget)
 
 NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN(nsXHREventTarget)
-  if (tmp->mOwner) {
-    nsCOMPtr<nsIDocument> doc =
-      do_QueryInterface(tmp->mOwner->GetExtantDocument());
-    if (doc) {
-      cb.NoteXPCOMChild(doc->GetReference(tmp));
-    }
-  }
+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE_PRESERVED_WRAPPER
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mOnLoadListener)
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mOnErrorListener)
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mOnAbortListener)
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mOnLoadStartListener)
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mOnProgressListener)
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mListenerManager)
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mScriptContext)
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mOwner)
 NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
 
 NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(nsXHREventTarget)
-  if (tmp->mOwner) {
-    nsCOMPtr<nsIDocument> doc =
-      do_QueryInterface(tmp->mOwner->GetExtantDocument());
-    if (doc) {
-      doc->RemoveReference(tmp);
-    }
-  }
+  NS_IMPL_CYCLE_COLLECTION_UNLINK_PRESERVED_WRAPPER
   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mOnLoadListener)
   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mOnErrorListener)
   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mOnAbortListener)
   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mOnLoadStartListener)
   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mOnProgressListener)
   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mListenerManager)
   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mScriptContext)
   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mOwner)
 NS_IMPL_CYCLE_COLLECTION_UNLINK_END
 
-NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(nsXHREventTarget)
+NS_INTERFACE_MAP_BEGIN(nsXHREventTarget)
+  NS_WRAPPERCACHE_INTERFACE_MAP_ENTRY
+  NS_INTERFACE_MAP_ENTRIES_CYCLE_COLLECTION(nsXHREventTarget)
   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIXMLHttpRequestEventTarget)
   NS_INTERFACE_MAP_ENTRY(nsIXMLHttpRequestEventTarget)
   NS_INTERFACE_MAP_ENTRY(nsPIDOMEventTarget)
   NS_INTERFACE_MAP_ENTRY(nsIDOMEventTarget)
   NS_INTERFACE_MAP_ENTRY(nsIDOMNSEventTarget)
 NS_INTERFACE_MAP_END
 
 NS_IMPL_CYCLE_COLLECTING_ADDREF_AMBIGUOUS(nsXHREventTarget,
@@ -1564,16 +1554,27 @@ nsXMLHttpRequest::GetAllResponseHeaders(
 
 /* ACString getResponseHeader (in AUTF8String header); */
 NS_IMETHODIMP
 nsXMLHttpRequest::GetResponseHeader(const nsACString& header,
                                     nsACString& _retval)
 {
   nsresult rv = NS_OK;
   _retval.Truncate();
+
+  // See bug #380418. Hide "Set-Cookie" headers from non-chrome scripts.
+  PRBool chrome = PR_FALSE; // default to false in case IsCapabilityEnabled fails
+  IsCapabilityEnabled("UniversalXPConnect", &chrome);
+  if (!chrome &&
+       (header.LowerCaseEqualsASCII("set-cookie") ||
+        header.LowerCaseEqualsASCII("set-cookie2"))) {
+    NS_WARNING("blocked access to response header");
+    _retval.SetIsVoid(PR_TRUE);
+    return NS_OK;
+  }
 
   // Check for dangerous headers
   if (mState & XML_HTTP_REQUEST_USE_XSITE_AC) {
     
     // Make sure we don't leak header information from denied cross-site
     // requests.
     if (mChannel) {
       nsresult status;
@@ -3348,20 +3349,29 @@ nsXMLHttpRequest::StartProgressEventTime
   }
 }
 
 NS_IMPL_ISUPPORTS1(nsXMLHttpRequest::nsHeaderVisitor, nsIHttpHeaderVisitor)
 
 NS_IMETHODIMP nsXMLHttpRequest::
 nsHeaderVisitor::VisitHeader(const nsACString &header, const nsACString &value)
 {
-    mHeaders.Append(header);
-    mHeaders.Append(": ");
-    mHeaders.Append(value);
-    mHeaders.Append('\n');
+    // See bug #380418. Hide "Set-Cookie" headers from non-chrome scripts.
+    PRBool chrome = PR_FALSE; // default to false in case IsCapabilityEnabled fails
+    IsCapabilityEnabled("UniversalXPConnect", &chrome);
+    if (!chrome &&
+         (header.LowerCaseEqualsASCII("set-cookie") ||
+          header.LowerCaseEqualsASCII("set-cookie2"))) {
+        NS_WARNING("blocked access to response header");
+    } else {
+        mHeaders.Append(header);
+        mHeaders.Append(": ");
+        mHeaders.Append(value);
+        mHeaders.Append('\n');
+    }
     return NS_OK;
 }
 
 // DOM event class to handle progress notifications
 nsXMLHttpProgressEvent::nsXMLHttpProgressEvent(nsIDOMProgressEvent* aInner,
                                                PRUint64 aCurrentProgress,
                                                PRUint64 aMaxProgress)
 {
diff -r a4343d61f6ee content/base/src/nsXMLHttpRequest.h
--- a/content/base/src/nsXMLHttpRequest.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/src/nsXMLHttpRequest.h	Sat Nov 15 19:43:12 2008 -0500
@@ -68,16 +68,17 @@
 #include "nsHashKeys.h"
 #include "prclist.h"
 #include "prtime.h"
 #include "nsIEventListenerManager.h"
 #include "nsIDOMNSEvent.h"
 #include "nsITimer.h"
 #include "nsIPrivateDOMEvent.h"
 #include "nsDOMProgressEvent.h"
+#include "nsIScriptGlobalObject.h"
 
 class nsILoadGroup;
 
 class nsAccessControlLRUCache
 {
 public:
   struct TokenTime
   {
@@ -154,17 +155,18 @@ public:
 
   nsIDOMEventListener* GetInner() { return mListener; }
 protected:
   nsCOMPtr<nsIDOMEventListener> mListener;
 };
 
 class nsXHREventTarget : public nsIXMLHttpRequestEventTarget,
                          public nsPIDOMEventTarget,
-                         public nsIDOMNSEventTarget
+                         public nsIDOMNSEventTarget,
+                         public nsWrapperCache
 {
 public:
   nsXHREventTarget() : mLang(nsIProgrammingLanguage::JAVASCRIPT) {}
   virtual ~nsXHREventTarget() {}
   NS_DECL_CYCLE_COLLECTING_ISUPPORTS
   NS_DECL_CYCLE_COLLECTION_CLASS_AMBIGUOUS(nsXHREventTarget,
                                            nsIXMLHttpRequestEventTarget)
   NS_DECL_NSIDOMNSEVENTTARGET
@@ -202,16 +204,46 @@ public:
       NS_ASSERTION(mOwner->IsInnerWindow(), "Should have inner window here!\n");
       nsPIDOMWindow* outer = mOwner->GetOuterWindow();
       if (!outer || outer->GetCurrentInnerWindow() != mOwner) {
         return NS_ERROR_FAILURE;
       }
     }
     return NS_OK;
   }
+
+  void GetParentObject(nsIScriptGlobalObject **aParentObject)
+  {
+    if (mOwner) {
+      CallQueryInterface(mOwner, aParentObject);
+    }
+    else {
+      *aParentObject = nsnull;
+    }
+  }
+
+  static nsXHREventTarget* FromSupports(nsISupports* aSupports)
+  {
+    nsIXMLHttpRequestEventTarget* target =
+      static_cast<nsIXMLHttpRequestEventTarget*>(aSupports);
+#ifdef DEBUG
+    {
+      nsCOMPtr<nsIXMLHttpRequestEventTarget> target_qi =
+        do_QueryInterface(aSupports);
+
+      // If this assertion fires the QI implementation for the object in
+      // question doesn't use the nsIXMLHttpRequestEventTarget pointer as the
+      // nsISupports pointer. That must be fixed, or we'll crash...
+      NS_ASSERTION(target_qi == target, "Uh, fix QI!");
+    }
+#endif
+
+    return static_cast<nsXHREventTarget*>(target);
+  }
+
 protected:
   nsRefPtr<nsDOMEventListenerWrapper> mOnLoadListener;
   nsRefPtr<nsDOMEventListenerWrapper> mOnErrorListener;
   nsRefPtr<nsDOMEventListenerWrapper> mOnAbortListener;
   nsRefPtr<nsDOMEventListenerWrapper> mOnLoadStartListener;
   nsRefPtr<nsDOMEventListenerWrapper> mOnProgressListener;
   nsCOMPtr<nsIEventListenerManager> mListenerManager;
   PRUint32 mLang;
diff -r a4343d61f6ee content/base/test/Makefile.in
--- a/content/base/test/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/test/Makefile.in	Sat Nov 15 19:43:12 2008 -0500
@@ -249,16 +249,22 @@ _TEST_FILES = 	test_bug5141.html \
 		test_CrossSiteXHR_cache.html \
 		file_CrossSiteXHR_cache_server.sjs \
 		test_XHRDocURI.html \
 		file_XHRDocURI.xml \
 		file_XHRDocURI.xml^headers^ \
 		file_XHRDocURI.text \
 		file_XHRDocURI.text^headers^ \
 		test_bug459424.html \
+		bug461735-redirect1.sjs \
+		bug461735-redirect2.sjs \
+		bug461735-post-redirect.js \
+		test_bug461735.html \
+		test_bug380418.html \
+		test_bug380418.html^headers^ \
 		$(NULL)
 
 # Disabled for now. Mochitest isn't reliable enough for these.
 # test_bug444546.html \
 # bug444546.sjs \
 
 libs:: $(_TEST_FILES)
 	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
diff -r a4343d61f6ee content/base/test/bug461735-post-redirect.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/content/base/test/bug461735-post-redirect.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,3 @@
+var a = 0;
+var b = 0;
+c();
\ No newline at end of file
diff -r a4343d61f6ee content/base/test/bug461735-redirect1.sjs
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/content/base/test/bug461735-redirect1.sjs	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,4 @@
+function handleRequest(request, response) {
+  response.setStatusLine(null, 302, "Found");
+  response.setHeader("Location", "http://example.com/tests/content/base/test/bug461735-post-redirect.js", false);
+}
diff -r a4343d61f6ee content/base/test/bug461735-redirect2.sjs
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/content/base/test/bug461735-redirect2.sjs	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,4 @@
+function handleRequest(request, response) {
+  response.setStatusLine(null, 302, "Found");
+  response.setHeader("Location", "http://localhost:8888/tests/content/base/test/bug461735-post-redirect.js", false);
+}
diff -r a4343d61f6ee content/base/test/test_CrossSiteXHR.html
--- a/content/base/test/test_CrossSiteXHR.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/base/test/test_CrossSiteXHR.html	Sat Nov 15 19:43:13 2008 -0500
@@ -35,22 +35,16 @@ var origins =
 
 window.addEventListener("message", function(e) {
   gen.send(e.data);
 }, false);
 
 gen = runTest();
 
 function runTest() {
-  if (navigator.platform == "MacIntel") {
-    todo(false, "httpd.js fails on Mac");
-    SimpleTest.finish();
-    yield;
-  }
-
   var loader = document.getElementById('loader');
   var loaderWindow = loader.contentWindow;
   loader.onload = function () { gen.next() };
 
   // Test preflight-less requests
   baseURL = "http://localhost:8888/tests/content/base/test/" +
              "file_CrossSiteXHR_server.sjs?";
   for each(originPair in origins) {
diff -r a4343d61f6ee content/base/test/test_bug380418.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/content/base/test/test_bug380418.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,51 @@
+<!DOCTYPE HTML>
+<html>
+<!-- https://bugzilla.mozilla.org/show_bug.cgi?id=380418 -->
+<head>
+  <title>Test for Bug 380418</title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>        
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=380418">Mozilla Bug 380418</a>
+<p id="display"></p>
+<div id="content" style="display: none">
+  
+</div>
+<pre id="test">
+<script class="testbody" type="text/javascript">
+
+	SimpleTest.waitForExplicitFinish();
+	
+	var request = new XMLHttpRequest();
+	request.open("GET", window.location.href, false);
+	request.send(null);
+	
+	// Try reading headers in privileged context
+	netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect UniversalBrowserRead");
+	is(request.getResponseHeader("Set-Cookie"), "test", "Reading Set-Cookie response header in privileged context");
+	is(request.getResponseHeader("Set-Cookie2"), "test2", "Reading Set-Cookie2 response header in privileged context");
+	is(request.getResponseHeader("X-Dummy"), "test", "Reading X-Dummy response header in privileged context");
+	
+	ok(/\bSet-Cookie:/i.test(request.getAllResponseHeaders()), "Looking for Set-Cookie in all response headers in privileged context");
+	ok(/\bSet-Cookie2:/i.test(request.getAllResponseHeaders()), "Looking for Set-Cookie2 in all response headers in privileged context");
+	ok(/\bX-Dummy:/i.test(request.getAllResponseHeaders()), "Looking for X-Dummy in all response headers in privileged context");
+	
+	// Try reading headers in unprivileged context
+	setTimeout(function() {
+	  is(request.getResponseHeader("Set-Cookie"), null, "Reading Set-Cookie response header in unprivileged context");
+	  is(request.getResponseHeader("Set-Cookie2"), null, "Reading Set-Cookie2 response header in unprivileged context");
+	  is(request.getResponseHeader("X-Dummy"), "test", "Reading X-Dummy response header in unprivileged context");
+	  
+	  ok(!/\bSet-Cookie:/i.test(request.getAllResponseHeaders()), "Looking for Set-Cookie in all response headers in unprivileged context");
+	  ok(!/\bSet-Cookie2:/i.test(request.getAllResponseHeaders()), "Looking for Set-Cookie2 in all response headers in unprivileged context");
+	  ok(/\bX-Dummy:/i.test(request.getAllResponseHeaders()), "Looking for X-Dummy in all response headers in unprivileged context");
+	
+	  SimpleTest.finish();
+	}, 0);
+
+</script>
+</pre>
+</body>
+</html>
diff -r a4343d61f6ee content/base/test/test_bug380418.html^headers^
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/content/base/test/test_bug380418.html^headers^	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,4 @@
+Set-Cookie: test
+Set-Cookie2: test2
+X-Dummy: test
+Cache-Control: max-age=0
diff -r a4343d61f6ee content/base/test/test_bug461735.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/content/base/test/test_bug461735.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,37 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=461735
+-->
+<head>
+  <title>Test for Bug 461735</title>
+  <script type="application/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css"/>
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=461735">Mozilla Bug 461735</a>
+<p id="display"></p>
+<div id="content" style="display: none">
+  
+</div>
+<pre id="test">
+<script type="application/javascript">
+window.onerror = function(message, uri, line) {
+  is(message, "Script error.", "Should have empty error message");
+  is(uri, "http://example.com/tests/content/base/test/bug461735-post-redirect.js", "Unexpected error location URI");
+  is(line, 0, "Shouldn't have a line here");
+}
+</script>
+<script src="bug461735-redirect1.sjs"></script>
+<script type="application/javascript">
+window.onerror = function(message, uri, line) {
+  is(message, "c is not defined", "Should have correct error message");
+  is(uri, "http://localhost:8888/tests/content/base/test/bug461735-post-redirect.js", "Unexpected error location URI");
+  is(line, 3, "Should have a line here");
+}
+</script>
+<script src="bug461735-redirect2.sjs"></script>
+</pre>
+</body>
+</html>
diff -r a4343d61f6ee content/html/content/src/Makefile.in
--- a/content/html/content/src/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/html/content/src/Makefile.in	Sat Nov 15 19:43:13 2008 -0500
@@ -78,16 +78,17 @@ REQUIRES	= xpcom \
 
 EXPORTS		= \
 		nsImageMapUtils.h \
 		nsClientRect.h \
 		$(NULL)
 
 CPPSRCS		= \
 		nsClientRect.cpp \
+		nsHTMLDNSPrefetch.cpp \
 		nsGenericHTMLElement.cpp \
 		nsFormSubmission.cpp \
 		nsImageMapUtils.cpp \
 		nsHTMLAnchorElement.cpp \
 		nsHTMLAreaElement.cpp \
 		nsHTMLBRElement.cpp \
 		nsHTMLBodyElement.cpp \
 		nsHTMLButtonElement.cpp \
diff -r a4343d61f6ee content/html/content/src/nsHTMLAnchorElement.cpp
--- a/content/html/content/src/nsHTMLAnchorElement.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/html/content/src/nsHTMLAnchorElement.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -58,16 +58,18 @@
 // For GetText().
 #include "nsIContentIterator.h"
 #include "nsIDOMText.h"
 #include "nsIEnumerator.h"
 
 #include "nsCOMPtr.h"
 #include "nsIPresShell.h"
 #include "nsIDocument.h"
+
+#include "nsHTMLDNSPrefetch.h"
 
 nsresult NS_NewContentIterator(nsIContentIterator** aInstancePtrResult);
 
 class nsHTMLAnchorElement : public nsGenericHTMLElement,
                             public nsIDOMHTMLAnchorElement,
                             public nsIDOMNSHTMLAnchorElement2,
                             public nsILink
 {
@@ -130,21 +132,36 @@ public:
   virtual nsresult UnsetAttr(PRInt32 aNameSpaceID, nsIAtom* aAttribute,
                              PRBool aNotify);
 
   virtual nsresult Clone(nsINodeInfo *aNodeInfo, nsINode **aResult) const;
 
 protected:
   // The cached visited state
   nsLinkState mLinkState;
+
+  void PrefetchDNS();
 };
 
 
 NS_IMPL_NS_NEW_HTML_ELEMENT(Anchor)
 
+void
+nsHTMLAnchorElement::PrefetchDNS()
+{
+  nsCOMPtr<nsIURI> hrefURI;
+  GetHrefURI(getter_AddRefs(hrefURI));
+
+  if (hrefURI) {
+    nsRefPtr<nsHTMLDNSPrefetch> prefetch = 
+      new nsHTMLDNSPrefetch(hrefURI, GetOwnerDoc());
+    if (prefetch) 
+      prefetch->PrefetchLow();
+  }
+}
 
 nsHTMLAnchorElement::nsHTMLAnchorElement(nsINodeInfo *aNodeInfo)
   : nsGenericHTMLElement(aNodeInfo),
     mLinkState(eLinkState_Unknown)
 {
 }
 
 nsHTMLAnchorElement::~nsHTMLAnchorElement()
@@ -207,16 +224,17 @@ nsHTMLAnchorElement::BindToTree(nsIDocum
                                                  aBindingParent,
                                                  aCompileEventHandlers);
   NS_ENSURE_SUCCESS(rv, rv);
 
   if (aDocument) {
     RegUnRegAccessKey(PR_TRUE);
   }
 
+  PrefetchDNS();
   return rv;
 }
 
 void
 nsHTMLAnchorElement::UnbindFromTree(PRBool aDeep, PRBool aNullParent)
 {
   if (IsInDoc()) {
     RegUnRegAccessKey(PR_FALSE);
diff -r a4343d61f6ee content/html/content/src/nsHTMLMediaElement.cpp
--- a/content/html/content/src/nsHTMLMediaElement.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/html/content/src/nsHTMLMediaElement.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -66,16 +66,19 @@
 #include "nsEventDispatcher.h"
 #include "nsIDOMDocumentEvent.h"
 #include "nsIDOMProgressEvent.h"
 #include "nsHTMLMediaError.h"
 #include "nsICategoryManager.h"
 
 #ifdef MOZ_OGG
 #include "nsOggDecoder.h"
+#endif
+#ifdef MOZ_WAVE
+#include "nsWaveDecoder.h"
 #endif
 
 class nsAsyncEventRunner : public nsRunnable
 {
 private:
   nsString mName;
   nsCOMPtr<nsHTMLMediaElement> mElement;
   PRPackedBool mProgress;
@@ -482,21 +485,43 @@ static PRBool IsOggType(const nsACString
   for (PRUint32 i = 0; i < NS_ARRAY_LENGTH(gOggTypes); ++i) {
     if (aType.EqualsASCII(gOggTypes[i]))
       return PR_TRUE;
   }
   return PR_FALSE;
 }
 #endif
 
+#ifdef MOZ_WAVE
+static const char gWaveTypes[][16] = {
+  "audio/x-wav",
+  "audio/wav",
+  "audio/wave",
+  "audio/x-pn-wav"
+};
+
+static PRBool IsWaveType(const nsACString& aType)
+{
+  for (PRUint32 i = 0; i < NS_ARRAY_LENGTH(gWaveTypes); ++i) {
+    if (aType.EqualsASCII(gWaveTypes[i]))
+      return PR_TRUE;
+  }
+  return PR_FALSE;
+}
+#endif
+
 /* static */
 PRBool nsHTMLMediaElement::CanHandleMediaType(const char* aMIMEType)
 {
 #ifdef MOZ_OGG
   if (IsOggType(nsDependentCString(aMIMEType)))
+    return PR_TRUE;
+#endif
+#ifdef MOZ_WAVE
+  if (IsWaveType(nsDependentCString(aMIMEType)))
     return PR_TRUE;
 #endif
   return PR_FALSE;
 }
 
 /* static */
 void nsHTMLMediaElement::InitMediaTypes()
 {
@@ -505,38 +530,58 @@ void nsHTMLMediaElement::InitMediaTypes(
   if (NS_SUCCEEDED(rv)) {
 #ifdef MOZ_OGG
     for (PRUint32 i = 0; i < NS_ARRAY_LENGTH(gOggTypes); i++) {
       catMan->AddCategoryEntry("Gecko-Content-Viewers", gOggTypes[i],
                                "@mozilla.org/content/document-loader-factory;1",
                                PR_FALSE, PR_TRUE, nsnull);
     }
 #endif
+#ifdef MOZ_WAVE
+    for (PRUint32 i = 0; i < NS_ARRAY_LENGTH(gWaveTypes); i++) {
+      catMan->AddCategoryEntry("Gecko-Content-Viewers", gWaveTypes[i],
+                               "@mozilla.org/content/document-loader-factory;1",
+                               PR_FALSE, PR_TRUE, nsnull);
+    }
+#endif
   }
 }
 
 /* static */
 void nsHTMLMediaElement::ShutdownMediaTypes()
 {
   nsresult rv;
   nsCOMPtr<nsICategoryManager> catMan(do_GetService(NS_CATEGORYMANAGER_CONTRACTID, &rv));
   if (NS_SUCCEEDED(rv)) {
 #ifdef MOZ_OGG
     for (PRUint32 i = 0; i < NS_ARRAY_LENGTH(gOggTypes); i++) {
       catMan->DeleteCategoryEntry("Gecko-Content-Viewers", gOggTypes[i], PR_FALSE);
     }
 #endif
+#ifdef MOZ_WAVE
+    for (PRUint32 i = 0; i < NS_ARRAY_LENGTH(gWaveTypes); i++) {
+      catMan->DeleteCategoryEntry("Gecko-Content-Viewers", gWaveTypes[i], PR_FALSE);
+    }
+#endif
   }
 }
 
 PRBool nsHTMLMediaElement::CreateDecoder(const nsACString& aType)
 {
 #ifdef MOZ_OGG
   if (IsOggType(aType)) {
     mDecoder = new nsOggDecoder();
+    if (mDecoder && !mDecoder->Init()) {
+      mDecoder = nsnull;
+    }
+  }
+#endif
+#ifdef MOZ_WAVE
+  if (IsWaveType(aType)) {
+    mDecoder = new nsWaveDecoder();
     if (mDecoder && !mDecoder->Init()) {
       mDecoder = nsnull;
     }
   }
 #endif
   return mDecoder != nsnull;
 }
 
diff -r a4343d61f6ee content/html/content/src/nsHTMLSelectElement.cpp
--- a/content/html/content/src/nsHTMLSelectElement.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/html/content/src/nsHTMLSelectElement.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -686,34 +686,40 @@ nsHTMLSelectElement::GetType(nsAString& 
 }
 
 NS_IMETHODIMP
 nsHTMLSelectElement::GetLength(PRUint32* aLength)
 {
   return mOptions->GetLength(aLength);
 }
 
+#define MAX_DYNAMIC_SELECT_LENGTH 10000
+
 NS_IMETHODIMP
 nsHTMLSelectElement::SetLength(PRUint32 aLength)
 {
   nsresult rv=NS_OK;
 
   PRUint32 curlen;
-  PRInt32 i;
+  PRUint32 i;
 
   rv = GetLength(&curlen);
   if (NS_FAILED(rv)) {
     curlen = 0;
   }
 
-  if (curlen && (curlen > aLength)) { // Remove extra options
-    for (i = (curlen - 1); (i >= (PRInt32)aLength) && NS_SUCCEEDED(rv); i--) {
-      rv = Remove(i);
+  if (curlen > aLength) { // Remove extra options
+    for (i = curlen; i > aLength && NS_SUCCEEDED(rv); --i) {
+      rv = Remove(i-1);
     }
-  } else if (aLength) {
+  } else if (aLength > curlen) {
+    if (aLength > MAX_DYNAMIC_SELECT_LENGTH) {
+      return NS_ERROR_DOM_NOT_SUPPORTED_ERR;
+    }
+    
     // This violates the W3C DOM but we do this for backwards compatibility
     nsCOMPtr<nsINodeInfo> nodeInfo;
 
     nsContentUtils::NameChanged(mNodeInfo, nsGkAtoms::option,
                                 getter_AddRefs(nodeInfo));
 
     nsCOMPtr<nsIContent> element = NS_NewHTMLOptionElement(nodeInfo);
     if (!element) {
@@ -724,17 +730,17 @@ nsHTMLSelectElement::SetLength(PRUint32 
     rv = NS_NewTextNode(getter_AddRefs(text), mNodeInfo->NodeInfoManager());
     NS_ENSURE_SUCCESS(rv, rv);
 
     rv = element->AppendChildTo(text, PR_FALSE);
     NS_ENSURE_SUCCESS(rv, rv);
 
     nsCOMPtr<nsIDOMNode> node(do_QueryInterface(element));
 
-    for (i = curlen; i < (PRInt32)aLength; i++) {
+    for (i = curlen; i < aLength; i++) {
       nsCOMPtr<nsIDOMNode> tmpNode;
 
       rv = AppendChild(node, getter_AddRefs(tmpNode));
       NS_ENSURE_SUCCESS(rv, rv);
 
       if (i < ((PRInt32)aLength - 1)) {
         nsCOMPtr<nsIDOMNode> newNode;
 
diff -r a4343d61f6ee content/html/document/src/nsHTMLContentSink.cpp
--- a/content/html/document/src/nsHTMLContentSink.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/html/document/src/nsHTMLContentSink.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -2945,16 +2945,23 @@ HTMLContentSink::ProcessLINKTag(const ns
         PRBool hasPrefetch = (linkTypes.IndexOf(NS_LITERAL_STRING("prefetch")) != -1);
         if (hasPrefetch || linkTypes.IndexOf(NS_LITERAL_STRING("next")) != -1) {
           nsAutoString hrefVal;
           element->GetAttr(kNameSpaceID_None, nsGkAtoms::href, hrefVal);
           if (!hrefVal.IsEmpty()) {
             PrefetchHref(hrefVal, element, hasPrefetch);
           }
         }
+        if (linkTypes.IndexOf(NS_LITERAL_STRING("dns-prefetch")) != -1) {
+          nsAutoString hrefVal;
+          element->GetAttr(kNameSpaceID_None, nsGkAtoms::href, hrefVal);
+          if (!hrefVal.IsEmpty()) {
+            PrefetchDNS(hrefVal);
+          }
+        }
       }
     }
   }
 
   return result;
 }
 
 /* 
diff -r a4343d61f6ee content/media/video/public/Makefile.in
--- a/content/media/video/public/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/public/Makefile.in	Sat Nov 15 19:43:13 2008 -0500
@@ -42,19 +42,35 @@ include $(DEPTH)/config/autoconf.mk
 include $(DEPTH)/config/autoconf.mk
 
 MODULE		= content
 
 EXPORTS		= \
 		nsMediaDecoder.h \
 		$(NULL)
 
+ifdef MOZ_MEDIA
+EXPORTS		+= \
+		nsChannelToPipeListener.h \
+		nsMediaStream.h \
+		$(NULL)
+endif
+
+ifdef MOZ_SYDNEYAUDIO
+EXPORTS		+= \
+		nsAudioStream.h \
+		$(NULL)
+endif
+
 ifdef MOZ_OGG
 EXPORTS		+= \
-		nsAudioStream.h \
 		nsChannelReader.h \
-		nsChannelToPipeListener.h \
-		nsMediaStream.h \
 		nsOggDecoder.h \
 		$(NULL)
 endif
 
+ifdef MOZ_WAVE
+EXPORTS		+= \
+		nsWaveDecoder.h \
+		$(NULL)
+endif
+
 include $(topsrcdir)/config/rules.mk
diff -r a4343d61f6ee content/media/video/public/nsAudioStream.h
--- a/content/media/video/public/nsAudioStream.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/public/nsAudioStream.h	Sat Nov 15 19:43:13 2008 -0500
@@ -30,58 +30,93 @@
  * under the terms of either the GPL or the LGPL, and not to allow others to
  * use your version of this file under the terms of the MPL, indicate your
  * decision by deleting the provisions above and replace them with the notice
  * and other provisions required by the GPL or the LGPL. If you do not delete
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
+#if !defined(nsAudioStream_h_)
+#define nsAudioStream_h_
+
 #include "nscore.h"
 #include "prlog.h"
 
 extern PRLogModuleInfo* gAudioStreamLog;
 
 class nsAudioStream 
 {
  public:
-  // Initialize Audio Library. Some Audio backends (eg. PortAudio) require initializing
+  enum SampleFormat
+  {
+    FORMAT_U8,
+    FORMAT_S16_LE,
+    FORMAT_FLOAT32_LE
+  };
+
+  // Initialize Audio Library. Some Audio backends require initializing the
   // library before using it. 
   static void InitLibrary();
 
-  // Shutdown Audio Library. Some Audio backends (eg. PortAudio) require shutting down
-  // the library after using it. 
+  // Shutdown Audio Library. Some Audio backends require shutting down the
+  // library after using it.
   static void ShutdownLibrary();
 
   nsAudioStream();
 
   // Initialize the audio stream. aNumChannels is the number of audio channels 
   // (1 for mono, 2 for stereo, etc) and aRate is the frequency of the sound 
   // samples (22050, 44100, etc).
-  void Init(PRInt32 aNumChannels, PRInt32 aRate);
+  void Init(PRInt32 aNumChannels, PRInt32 aRate, SampleFormat aFormat);
 
   // Closes the stream. All future use of the stream is an error.
   void Shutdown();
 
-  // Write sound data to the audio hardware. aBuf is an array of floats of
-  // length aCount. aCount should be evenly divisible by the number of 
-  // channels in this audio stream.
-  void Write(float* aBuf, PRUint32 count);
+  // Write sound data to the audio hardware.  aBuf is an array of samples in
+  // the format specified by mFormat of length aCount.  aCount should be
+  // evenly divisible by the number of channels in this audio stream.
+  void Write(const void* aBuf, PRUint32 aCount);
 
   // Return the number of sound samples that can be written to the audio device
   // without blocking.
   PRInt32 Available();
 
   // Store in aVolume the value of the volume setting. This is a value from
   // 0 (meaning muted) to 1 (meaning full volume).
   float GetVolume();
 
   // Set the current volume of the audio playback. This is a value from
   // 0 (meaning muted) to 1 (meaning full volume).
   void SetVolume(float aVolume);
 
+  // Block until buffered audio data has been consumed.
+  void Drain();
+
+  // Pause sound playback.
+  void Pause();
+
+  // Resume sound playback.
+  void Resume();
+
+  // Return the position (in seconds) of the audio sample currently being
+  // played by the audio hardware.
+  double GetTime();
+
  private:
   double mVolume;
   void* mAudioHandle;
   int mRate;
   int mChannels;
-  PRPackedBool mMute;
+
+  // The byte position in the audio buffer where playback was last paused.
+  PRInt64 mSavedPauseBytes;
+  PRInt64 mPauseBytes;
+
+  float mStartTime;
+  float mPauseTime;
+  PRInt64 mSamplesBuffered;
+
+  SampleFormat mFormat;
+
+  PRPackedBool mPaused;
 };
+#endif
diff -r a4343d61f6ee content/media/video/public/nsChannelToPipeListener.h
--- a/content/media/video/public/nsChannelToPipeListener.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/public/nsChannelToPipeListener.h	Sat Nov 15 19:43:13 2008 -0500
@@ -62,17 +62,19 @@ class nsChannelToPipeListener : public n
 
   // IRequestObserver
   NS_DECL_NSIREQUESTOBSERVER
 
   // IStreamListener
   NS_DECL_NSISTREAMLISTENER
 
   public:
-  nsChannelToPipeListener(nsMediaDecoder* aDecoder);
+  // If aSeeking is PR_TRUE then this listener was created as part of a
+  // seek request and is expecting a byte range partial result.
+  nsChannelToPipeListener(nsMediaDecoder* aDecoder, PRBool aSeeking = PR_FALSE);
   nsresult Init();
   nsresult GetInputStream(nsIInputStream** aStream);
   void Stop();
   void Cancel();
 
   // Return the download rate in bytes per second. Returns 
   // less than zero if the download has complated.
   double BytesPerSecond() const;
@@ -90,11 +92,14 @@ private:
   PRIntervalTime mIntervalStart;
 
   // Interval when last downloaded bytes occurred. Used in computer
   // bytes per second download rate.
   PRIntervalTime mIntervalEnd;
 
   // Total bytes transferred so far
   PRInt64 mTotalBytes;
+
+  // PR_TRUE if this listener is expecting a byte range request result
+  PRPackedBool mSeeking;
 };
 
 #endif
diff -r a4343d61f6ee content/media/video/public/nsMediaDecoder.h
--- a/content/media/video/public/nsMediaDecoder.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/public/nsMediaDecoder.h	Sat Nov 15 19:43:13 2008 -0500
@@ -122,30 +122,39 @@ class nsMediaDecoder : public nsIObserve
   // RGB buffer doesn't have to be exposed publically.
   // The current video frame is drawn to fill aRect.
   // Called in the main thread only.
   virtual void Paint(gfxContext* aContext, const gfxRect& aRect);
 
   // Called when the video file has completed downloading.
   virtual void ResourceLoaded() = 0;
 
+  // Called if the media file encounters a network error.
+  virtual void NetworkError() = 0;
+
   // Call from any thread safely. Return PR_TRUE if we are currently
   // seeking in the media resource.
   virtual PRBool IsSeeking() const = 0;
 
   // Return the current number of bytes loaded from the video file.
   // This is used for progress events.
   virtual PRUint64 GetBytesLoaded() = 0;
 
   // Return the size of the video file in bytes. Return 0 if the
   // size is unknown or the stream is infinite.
   virtual PRInt64 GetTotalBytes() = 0;
 
   // Set the size of the video file in bytes.
   virtual void SetTotalBytes(PRInt64 aBytes) = 0;
+
+  // Set a flag indicating whether seeking is supported
+  virtual void SetSeekable(PRBool aSeekable) = 0;
+
+  // Return PR_TRUE if seeking is supported.
+  virtual PRBool GetSeekable() = 0;
 
   // Called when the HTML DOM element is bound.
   virtual void ElementAvailable(nsHTMLMediaElement* anElement);
 
   // Called when the HTML DOM element is unbound.
   virtual void ElementUnavailable();
 
   // Invalidate the frame.
diff -r a4343d61f6ee content/media/video/public/nsOggDecoder.h
--- a/content/media/video/public/nsOggDecoder.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/public/nsOggDecoder.h	Sat Nov 15 19:43:13 2008 -0500
@@ -326,22 +326,32 @@ class nsOggDecoder : public nsMediaDecod
   virtual nsIPrincipal* GetCurrentPrincipal();
 
   virtual void UpdateBytesDownloaded(PRUint64 aBytes);
 
   // Called when the video file has completed downloading.
   // Call on the main thread only.
   void ResourceLoaded();
 
+  // Called if the media file encounters a network error.
+  // Call on the main thread only.
+  void NetworkError();
+
   // Call from any thread safely. Return PR_TRUE if we are currently
   // seeking in the media resource.
   virtual PRBool IsSeeking() const;
 
   // Get the size of the media file in bytes. Called on the main thread only.
   virtual void SetTotalBytes(PRInt64 aBytes);
+
+  // Set a flag indicating whether seeking is supported
+  virtual void SetSeekable(PRBool aSeekable);
+
+  // Return PR_TRUE if seeking is supported.
+  virtual PRBool GetSeekable();
 
 protected:
   // Change to a new play state. This updates the mState variable and
   // notifies any thread blocking on this objects monitor of the
   // change. Can be called on any thread.
   void ChangeState(PlayState aState);
 
   // Returns the monitor for other threads to synchronise access to
@@ -441,18 +451,27 @@ private:
   // started this is reset to negative.
   float mRequestedSeekTime;
 
   // Size of the media file in bytes. Set on the first non-byte range
   // HTTP request from nsChannelToPipe Listener. Accessed on the
   // main thread only.
   PRInt64 mContentLength;
 
+  // Duration of the media resource. Set to -1 if unknown.
+  // Set when the Ogg metadata is loaded. Accessed on the main thread
+  // only.
+  PRInt64 mDuration;
+
   // True if we are registered with the observer service for shutdown.
   PRPackedBool mNotifyOnShutdown;
+
+  // True if the media resource is seekable (server supports byte range
+  // requests).
+  PRPackedBool mSeekable;
 
   /******
    * The following member variables can be accessed from any thread.
    ******/
 
   // The state machine object for handling the decoding via
   // oggplay. It is safe to call methods of this object from other
   // threads. Its internal data is synchronised on a monitor. The
diff -r a4343d61f6ee content/media/video/public/nsWaveDecoder.h
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/content/media/video/public/nsWaveDecoder.h	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,268 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim:set ts=2 sw=2 sts=2 et cindent: */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: ML 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Mozilla code.
+ *
+ * The Initial Developer of the Original Code is the Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *  Matthew Gregan <kinetik@flim.org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+#if !defined(nsWaveDecoder_h_)
+#define nsWaveDecoder_h_
+
+#include "nsISupports.h"
+#include "nsCOMPtr.h"
+#include "nsMediaDecoder.h"
+#include "nsMediaStream.h"
+
+/*
+  nsWaveDecoder provides an implementation of the abstract nsMediaDecoder
+  class that supports parsing and playback of Waveform Audio (WAVE) chunks
+  embedded in Resource Interchange File Format (RIFF) bitstreams as
+  specified by the Multimedia Programming Interface and Data Specification
+  1.0.
+
+  Each decoder instance starts one thread (the playback thread).  A single
+  nsWaveStateMachine event is dispatched to this thread to start the
+  thread's state machine running.  The Run method of the event is a loop
+  that executes the current state.  The state can be changed by the state
+  machine, or from the main thread via threadsafe methods on the event.
+  During playback, the playback thread reads data from the network and
+  writes it to the audio backend, attempting to keep the backend's audio
+  buffers full.  It is also responsible for seeking, buffering, and
+  pausing/resuming audio.
+
+  The decoder also owns an nsMediaStream instance that provides a threadsafe
+  blocking interface to read from network channels.  The state machine is
+  the primary user of this stream and holds a weak (raw) pointer to it as
+  the thread, state machine, and stream's lifetimes are all managed by the
+  decoder.
+
+  nsWaveStateMachine has the following states:
+
+  LOADING_METADATA
+    RIFF/WAVE chunks are being read from the stream, the metadata describing
+    the audio data is parsed.
+
+  BUFFERING
+    Playback is paused while waiting for additional data.
+
+  PLAYING
+    If data is available in the stream and the audio backend can consume
+    more data, it is read from the stream and written to the audio backend.
+    Sleep until approximately half of the backend's buffers have drained.
+
+  SEEKING
+    Decoder is seeking to a specified time in the media.
+
+  PAUSED
+    Pause the audio backend, then wait for a state transition.
+
+  ENDED
+    Expected PCM data (or stream EOF) reached, wait for the audio backend to
+    play any buffered data, then wait for shutdown.
+
+  ERROR
+    Metadata loading/parsing failed, wait for shutdown.
+
+  SHUTDOWN
+    Close the audio backend and return from the run loop.
+
+  State transitions within the state machine are:
+
+  LOADING_METADATA -> PLAYING
+                   -> PAUSED
+                   -> ERROR
+
+  BUFFERING        -> PLAYING
+                   -> PAUSED
+
+  PLAYING          -> BUFFERING
+                   -> ENDED
+
+  SEEKING          -> PLAYING
+                   -> PAUSED
+
+  PAUSED           -> waits for caller to play, seek, or shutdown
+
+  ENDED            -> waits for caller to shutdown
+
+  ERROR            -> waits for caller to shutdown
+
+  SHUTDOWN         -> exits state machine
+
+  In addition, the following methods cause state transitions:
+
+  Shutdown(), Play(), Pause(), Seek(float)
+
+  The decoder implementation is currently limited to Linear PCM encoded
+  audio data with one or two channels of 8- or 16-bit samples at sample
+  rates from 100 Hz to 96 kHz.  The number of channels is limited by what
+  the audio backend (sydneyaudio via nsAudioStream) currently supports.  The
+  supported sample rate is artificially limited to arbitrarily selected sane
+  values.  Support for additional channels (and other new features) would
+  require extending nsWaveDecoder to support parsing the newer
+  WAVE_FORMAT_EXTENSIBLE chunk format.
+ */
+
+class nsWaveStateMachine;
+
+class nsWaveDecoder : public nsMediaDecoder
+{
+  friend class nsWaveStateMachine;
+
+  NS_DECL_ISUPPORTS
+  NS_DECL_NSIOBSERVER
+
+ public:
+  nsWaveDecoder();
+  ~nsWaveDecoder();
+
+  virtual void GetCurrentURI(nsIURI** aURI);
+  virtual nsIPrincipal* GetCurrentPrincipal();
+
+  // Return the current playback position in the media in seconds.
+  virtual float GetCurrentTime();
+
+  // Return the total playback length of the media in seconds.
+  virtual float GetDuration();
+
+  // Get the current audio playback volume; result in range [0.0, 1.0].
+  virtual float GetVolume();
+
+  // Set the audio playback volume; must be in range [0.0, 1.0].
+  virtual void SetVolume(float aVolume);
+
+  virtual nsresult Play();
+  virtual void Stop();
+  virtual void Pause();
+
+  // Set the current time of the media to aTime.  This may cause mStream to
+  // create a new channel to fetch data from the appropriate position in the
+  // stream.
+  virtual nsresult Seek(float aTime);
+
+  // Report whether the decoder is currently seeking.
+  virtual PRBool IsSeeking() const;
+
+  // Start downloading the media at the specified URI.  The media's metadata
+  // will be parsed and made available as the load progresses.
+  virtual nsresult Load(nsIURI* aURI, nsIChannel* aChannel, nsIStreamListener** aStreamListener);
+
+  // Called by mStream (and possibly the nsChannelToPipeListener used
+  // internally by mStream) when the stream has completed loading.
+  virtual void ResourceLoaded();
+
+  // Called by mStream (and possibly the nsChannelToPipeListener used
+  // internally by mStream) if the stream encounters a network error.
+  virtual void NetworkError();
+
+  // Element is notifying us that the requested playback rate has changed.
+  virtual nsresult PlaybackRateChanged();
+
+  // Getter/setter for mContentLength.
+  virtual PRInt64 GetTotalBytes();
+  virtual void SetTotalBytes(PRInt64 aBytes);
+
+  // Getter/setter for mSeekable.
+  virtual void SetSeekable(PRBool aSeekable);
+  virtual PRBool GetSeekable();
+
+  // Getter/setter for mBytesDownloaded.
+  virtual PRUint64 GetBytesLoaded();
+  virtual void UpdateBytesDownloaded(PRUint64 aBytes);
+
+  // Must be called by the owning object before disposing the decoder.
+  virtual void Shutdown();
+
+private:
+  // Notifies the nsHTMLMediaElement that buffering has started.
+  void BufferingStarted();
+
+  // Notifies the element that buffering has stopped.
+  void BufferingStopped();
+
+  // Notifies the element that seeking has started.
+  void SeekingStarted();
+
+  // Notifies the element that seeking has completed.
+  void SeekingStopped();
+
+  // Notifies the element that metadata loading has completed.  Only fired
+  // if metadata is valid.
+  void MetadataLoaded();
+
+  // Notifies the element that playback has completed.
+  void PlaybackEnded();
+
+  // Notifies the element that metadata loading has failed.
+  void MediaErrorDecode();
+
+  void RegisterShutdownObserver();
+  void UnregisterShutdownObserver();
+
+  // Length of the current resource, or -1 if not available.
+  PRInt64 mContentLength;
+
+  // Total bytes downloaded by mStream so far.
+  PRUint64 mBytesDownloaded;
+
+  // Volume that the audio backend will be initialized with.
+  float mInitialVolume;
+
+  // URI of the current resource.
+  nsCOMPtr<nsIURI> mURI;
+
+  // Thread that handles audio playback, including data download.
+  nsCOMPtr<nsIThread> mPlaybackThread;
+
+  // State machine that runs on mPlaybackThread.  Methods on this object are
+  // safe to call from any thread.
+  nsCOMPtr<nsWaveStateMachine> mPlaybackStateMachine;
+
+  // Threadsafe wrapper around channels that provides seeking based on the
+  // underlying channel type.
+  nsAutoPtr<nsMediaStream> mStream;
+
+  // Copy of the current time and duration when the state machine was
+  // disposed.  Used to respond to time and duration queries with sensible
+  // values after playback has ended.
+  float mEndedCurrentTime;
+  float mEndedDuration;
+
+  // True if we have registered a shutdown observer.
+  PRPackedBool mNotifyOnShutdown;
+
+  // True if the media resource is seekable.
+  PRPackedBool mSeekable;
+};
+
+#endif
diff -r a4343d61f6ee content/media/video/src/Makefile.in
--- a/content/media/video/src/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/src/Makefile.in	Sat Nov 15 19:43:13 2008 -0500
@@ -77,23 +77,39 @@ REQUIRES	= \
 		cairo \
 		libpixman \
 		$(NULL)
 
 CPPSRCS		= \
 		nsMediaDecoder.cpp \
 		$(NULL)
 
+ifdef MOZ_MEDIA
+CPPSRCS		+= \
+		nsChannelToPipeListener.cpp \
+		nsMediaStream.cpp \
+		$(NULL)
+endif
+
+ifdef MOZ_SYDNEYAUDIO
+CPPSRCS		+= \
+		nsAudioStream.cpp \
+		$(NULL)
+endif
+
 ifdef MOZ_OGG
 CPPSRCS		+= \
-		nsAudioStream.cpp \
 		nsChannelReader.cpp \
-		nsChannelToPipeListener.cpp \
-		nsMediaStream.cpp \
 		nsOggDecoder.cpp \
+		$(NULL)
+endif
+
+ifdef MOZ_WAVE
+CPPSRCS		+= \
+		nsWaveDecoder.cpp \
 		$(NULL)
 endif
 
 FORCE_STATIC_LIB = 1
 
 include $(topsrcdir)/config/rules.mk
 
 INCLUDES	+= \
diff -r a4343d61f6ee content/media/video/src/nsAudioStream.cpp
--- a/content/media/video/src/nsAudioStream.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/src/nsAudioStream.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -36,116 +36,240 @@
  *
  * ***** END LICENSE BLOCK ***** */
 #include <stdio.h>
 #include <math.h>
 #include "prlog.h"
 #include "prmem.h"
 #include "nsAutoPtr.h"
 #include "nsAudioStream.h"
+#include "nsAlgorithm.h"
 extern "C" {
 #include "sydneyaudio/sydney_audio.h"
 }
 
 #ifdef PR_LOGGING
 PRLogModuleInfo* gAudioStreamLog = nsnull;
 #endif
+
+#define FAKE_BUFFER_SIZE 176400
+
+static float CurrentTimeInSeconds()
+{
+  return PR_IntervalToMilliseconds(PR_IntervalNow()) / 1000.0;
+}
 
 void nsAudioStream::InitLibrary()
 {
 #ifdef PR_LOGGING
   gAudioStreamLog = PR_NewLogModule("nsAudioStream");
 #endif
 }
 
 void nsAudioStream::ShutdownLibrary()
 {
 }
 
 nsAudioStream::nsAudioStream() :
   mVolume(1.0),
   mAudioHandle(0),
   mRate(0),
-  mChannels(0)
+  mChannels(0),
+  mSavedPauseBytes(0),
+  mPauseBytes(0),
+  mPauseTime(0.0),
+  mSamplesBuffered(0),
+  mFormat(FORMAT_S16_LE),
+  mPaused(PR_FALSE)
 {
 }
 
-void nsAudioStream::Init(PRInt32 aNumChannels, PRInt32 aRate)
+void nsAudioStream::Init(PRInt32 aNumChannels, PRInt32 aRate, SampleFormat aFormat)
 {
   mRate = aRate;
   mChannels = aNumChannels;
+  mFormat = aFormat;
+  mStartTime = CurrentTimeInSeconds();
   if (sa_stream_create_pcm(reinterpret_cast<sa_stream_t**>(&mAudioHandle),
                            NULL, 
                            SA_MODE_WRONLY, 
                            SA_PCM_FORMAT_S16_LE,
                            aRate,
                            aNumChannels) != SA_SUCCESS) {
     mAudioHandle = nsnull;
     PR_LOG(gAudioStreamLog, PR_LOG_ERROR, ("nsAudioStream: sa_stream_create_pcm error"));
     return;
   }
   
-  if (sa_stream_open(reinterpret_cast<sa_stream_t*>(mAudioHandle)) != SA_SUCCESS) {
-    sa_stream_destroy((sa_stream_t*)mAudioHandle);
+  if (sa_stream_open(static_cast<sa_stream_t*>(mAudioHandle)) != SA_SUCCESS) {
+    sa_stream_destroy(static_cast<sa_stream_t*>(mAudioHandle));
     mAudioHandle = nsnull;
     PR_LOG(gAudioStreamLog, PR_LOG_ERROR, ("nsAudioStream: sa_stream_open error"));
     return;
   }
 }
 
 void nsAudioStream::Shutdown()
 {
   if (!mAudioHandle) 
     return;
 
-  sa_stream_destroy(reinterpret_cast<sa_stream_t*>(mAudioHandle));
+  sa_stream_destroy(static_cast<sa_stream_t*>(mAudioHandle));
   mAudioHandle = nsnull;
 }
 
-void nsAudioStream::Write(float* aBuf, PRUint32 aCount)
+void nsAudioStream::Write(const void* aBuf, PRUint32 aCount)
 {
+  NS_ABORT_IF_FALSE(aCount % mChannels == 0,
+                    "Buffer size must be divisible by channel count");
+
+  mSamplesBuffered += aCount;
+
   if (!mAudioHandle)
     return;
 
-  // Convert array of floats, to an array of signed shorts
   nsAutoArrayPtr<short> s_data(new short[aCount]);
 
   if (s_data) {
-    for (PRUint32 i=0; i <  aCount; ++i) {
-      float scaled_value = floorf(0.5 + 32768 * aBuf[i] * mVolume);
-      if (aBuf[i] < 0.0) {
-        s_data[i] = (scaled_value < -32768.0) ? 
-          -32768 : 
-          short(scaled_value);
+    switch (mFormat) {
+    case FORMAT_U8: {
+      const PRUint8* buf = static_cast<const PRUint8*>(aBuf);
+      PRInt32 volume = PRInt32((1 << 16) * mVolume);
+      for (PRUint32 i = 0; i < aCount; ++i) {
+        s_data[i] = short(((PRInt32(buf[i]) - 128) * volume) >> 8);
       }
-      else {
-        s_data[i] = (scaled_value > 32767.0) ? 
-          32767 : 
-          short(scaled_value);
+      break;
+    }
+    case FORMAT_S16_LE: {
+      const short* buf = static_cast<const short*>(aBuf);
+      PRInt32 volume = PRInt32((1 << 16) * mVolume);
+      for (PRUint32 i = 0; i < aCount; ++i) {
+        s_data[i] = short((PRInt32(buf[i]) * volume) >> 16);
       }
+      break;
     }
-    
-    if (sa_stream_write(reinterpret_cast<sa_stream_t*>(mAudioHandle), s_data.get(), aCount * sizeof(short)) != SA_SUCCESS) {
+    case FORMAT_FLOAT32_LE: {
+      const float* buf = static_cast<const float*>(aBuf);
+      for (PRUint32 i= 0; i <  aCount; ++i) {
+        float scaled_value = floorf(0.5 + 32768 * buf[i] * mVolume);
+        if (buf[i] < 0.0) {
+          s_data[i] = (scaled_value < -32768.0) ?
+            -32768 :
+            short(scaled_value);
+        } else {
+          s_data[i] = (scaled_value > 32767.0) ?
+            32767 :
+            short(scaled_value);
+        }
+      }
+      break;
+    }
+    }
+
+    if (sa_stream_write(static_cast<sa_stream_t*>(mAudioHandle), s_data.get(), aCount * sizeof(short)) != SA_SUCCESS) {
       PR_LOG(gAudioStreamLog, PR_LOG_ERROR, ("nsAudioStream: sa_stream_write error"));
       Shutdown();
-    }     
+    }
   }
 }
 
 PRInt32 nsAudioStream::Available()
 {
+  // If the audio backend failed to open, lie and say we'll accept some
+  // data.
   if (!mAudioHandle)
-    return 0;
+    return FAKE_BUFFER_SIZE;
 
   size_t s = 0; 
-  sa_stream_get_write_size(reinterpret_cast<sa_stream_t*>(mAudioHandle), &s);
+  sa_stream_get_write_size(static_cast<sa_stream_t*>(mAudioHandle), &s);
   return s / sizeof(short);
 }
 
 float nsAudioStream::GetVolume()
 {
   return mVolume;
 }
 
 void nsAudioStream::SetVolume(float aVolume)
 {
+  NS_ASSERTION(aVolume >= 0.0 && aVolume <= 1.0, "Invalid volume");
   mVolume = aVolume;
 }
+
+void nsAudioStream::Drain()
+{
+  if (!mAudioHandle) {
+    PRUint32 drainTime = (float(mSamplesBuffered) / mRate / mChannels - GetTime()) * 1000.0;
+    PR_Sleep(PR_MillisecondsToInterval(drainTime));
+    return;
+  }
+
+  if (sa_stream_drain(static_cast<sa_stream_t*>(mAudioHandle)) != SA_SUCCESS) {
+        PR_LOG(gAudioStreamLog, PR_LOG_ERROR, ("nsAudioStream: sa_stream_drain error"));
+        Shutdown();
+  }
+}
+
+void nsAudioStream::Pause()
+{
+  if (mPaused)
+    return;
+
+  // Save the elapsed playback time.  Used to offset the wall-clock time
+  // when resuming.
+  mPauseTime = CurrentTimeInSeconds() - mStartTime;
+
+  mPaused = PR_TRUE;
+
+  if (!mAudioHandle)
+    return;
+
+  int64_t bytes = 0;
+#if !defined(WIN32)
+  sa_stream_get_position(static_cast<sa_stream_t*>(mAudioHandle), SA_POSITION_WRITE_SOFTWARE, &bytes);
+#endif
+  mSavedPauseBytes = bytes;
+
+  sa_stream_pause(static_cast<sa_stream_t*>(mAudioHandle));
+}
+
+void nsAudioStream::Resume()
+{
+  if (!mPaused)
+    return;
+
+  // Reset the start time to the current time offset backwards by the
+  // elapsed time saved when the stream paused.
+  mStartTime = CurrentTimeInSeconds() - mPauseTime;
+
+  mPaused = PR_FALSE;
+
+  if (!mAudioHandle)
+    return;
+
+  sa_stream_resume(static_cast<sa_stream_t*>(mAudioHandle));
+
+#if !defined(WIN32)
+  mPauseBytes += mSavedPauseBytes;
+#endif
+}
+
+double nsAudioStream::GetTime()
+{
+  // If the audio backend failed to open, emulate the current playback
+  // position using the system clock.
+  if (!mAudioHandle) {
+    if (mPaused) {
+      return mPauseTime;
+    }
+    float curTime = CurrentTimeInSeconds() - mStartTime;
+    float maxTime = float(mSamplesBuffered) / mRate / mChannels;
+    return NS_MIN(curTime, maxTime);
+  }
+
+  int64_t bytes = 0;
+#if defined(WIN32)
+  sa_stream_get_position(static_cast<sa_stream_t*>(mAudioHandle), SA_POSITION_WRITE_HARDWARE, &bytes);
+#else
+  sa_stream_get_position(static_cast<sa_stream_t*>(mAudioHandle), SA_POSITION_WRITE_SOFTWARE, &bytes);
+#endif
+  return double(bytes + mPauseBytes) / (sizeof(short) * mChannels * mRate);
+}
diff -r a4343d61f6ee content/media/video/src/nsChannelToPipeListener.cpp
--- a/content/media/video/src/nsChannelToPipeListener.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/src/nsChannelToPipeListener.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -37,21 +37,27 @@
  * ***** END LICENSE BLOCK ***** */
 #include "nsAString.h"
 #include "nsNetUtil.h"
 #include "nsMediaDecoder.h"
 #include "nsIScriptSecurityManager.h"
 #include "nsChannelToPipeListener.h"
 #include "nsICachingChannel.h"
 
-nsChannelToPipeListener::nsChannelToPipeListener(nsMediaDecoder* aDecoder) :
+#define HTTP_OK_CODE 200
+#define HTTP_PARTIAL_RESPONSE_CODE 206
+
+nsChannelToPipeListener::nsChannelToPipeListener(
+    nsMediaDecoder* aDecoder,
+    PRBool aSeeking) :
   mDecoder(aDecoder),
   mIntervalStart(0),
   mIntervalEnd(0),
-  mTotalBytes(0)
+  mTotalBytes(0),
+  mSeeking(aSeeking)
 {
 }
 
 nsresult nsChannelToPipeListener::Init() 
 {
   nsresult rv = NS_NewPipe(getter_AddRefs(mInput), 
                            getter_AddRefs(mOutput),
                            0, 
@@ -93,20 +99,35 @@ nsresult nsChannelToPipeListener::OnStar
   mIntervalStart = PR_IntervalNow();
   mIntervalEnd = mIntervalStart;
   mTotalBytes = 0;
   mDecoder->UpdateBytesDownloaded(mTotalBytes);
   nsCOMPtr<nsIHttpChannel> hc = do_QueryInterface(aRequest);
   if (hc) {
     PRUint32 responseStatus = 0; 
     hc->GetResponseStatus(&responseStatus);
-    if (responseStatus == 200) {
+    if (mSeeking && responseStatus == HTTP_OK_CODE) {
+      // If we get an OK response but we were seeking,
+      // and therefore expecting a partial response of
+      // HTTP_PARTIAL_RESPONSE_CODE, tell the decoder
+      // we don't support seeking.
+      mDecoder->SetSeekable(PR_FALSE);
+    }
+    else if (!mSeeking && 
+             (responseStatus == HTTP_OK_CODE ||
+              responseStatus == HTTP_PARTIAL_RESPONSE_CODE)) {
+      // We weren't seeking and got a valid response status,
+      // set the length of the content.
       PRInt32 cl = 0;
       hc->GetContentLength(&cl);
       mDecoder->SetTotalBytes(cl);
+
+      // If we get an HTTP_OK_CODE response to our byte range
+      // request, then we don't support seeking.
+      mDecoder->SetSeekable(responseStatus == HTTP_PARTIAL_RESPONSE_CODE);
     }
   }
 
   nsCOMPtr<nsICachingChannel> cc = do_QueryInterface(aRequest);
   if (cc) {
     PRBool fromCache = PR_FALSE;
     nsresult rv = cc->IsFromCache(&fromCache);
 
@@ -130,18 +151,22 @@ nsresult nsChannelToPipeListener::OnStar
   }
 
   return NS_OK;
 }
 
 nsresult nsChannelToPipeListener::OnStopRequest(nsIRequest* aRequest, nsISupports* aContext, nsresult aStatus) 
 {
   mOutput = nsnull;
-  if (mDecoder) {
-    mDecoder->ResourceLoaded();
+  if (aStatus != NS_BINDING_ABORTED && mDecoder) {
+    if (NS_SUCCEEDED(aStatus)) {
+      mDecoder->ResourceLoaded();
+    } else {
+      mDecoder->NetworkError();
+    }
   }
   return NS_OK;
 }
 
 nsresult nsChannelToPipeListener::OnDataAvailable(nsIRequest* aRequest, 
                                                 nsISupports* aContext, 
                                                 nsIInputStream* aStream,
                                                 PRUint32 aOffset,
diff -r a4343d61f6ee content/media/video/src/nsMediaStream.cpp
--- a/content/media/video/src/nsMediaStream.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/src/nsMediaStream.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -56,17 +56,18 @@
 // seeked forward is less than this value then a read is
 // done rather than a byte range request.
 #define SEEK_VS_READ_THRESHOLD (32*1024)
 
 class nsDefaultStreamStrategy : public nsStreamStrategy
 {
 public:
   nsDefaultStreamStrategy(nsMediaDecoder* aDecoder, nsIChannel* aChannel, nsIURI* aURI) :
-    nsStreamStrategy(aDecoder, aChannel, aURI)
+    nsStreamStrategy(aDecoder, aChannel, aURI),
+    mPosition(0)
   {
   }
   
   // These methods have the same thread calling requirements 
   // as those with the same name in nsMediaStream
   virtual nsresult Open(nsIStreamListener** aStreamListener);
   virtual nsresult Close();
   virtual nsresult Read(char* aBuffer, PRUint32 aCount, PRUint32* aBytes);
@@ -82,16 +83,20 @@ private:
   // media data asynchronously and store it in the pipe. The 
   // data is obtainable via the mPipeInput member. Use on 
   // main thread only.
   nsCOMPtr<nsChannelToPipeListener> mListener;
 
   // Input stream for the media data currently downloaded 
   // and stored in the pipe. This can be used from any thread.
   nsCOMPtr<nsIInputStream>  mPipeInput;
+
+  // Current seek position. Need to compute this manually because
+  // the underlying channel may not offer this information.
+  PRInt64 mPosition;
 };
 
 nsresult nsDefaultStreamStrategy::Open(nsIStreamListener** aStreamListener)
 {
   if (aStreamListener) {
     *aStreamListener = nsnull;
   }
 
@@ -106,16 +111,18 @@ nsresult nsDefaultStreamStrategy::Open(n
     NS_ADDREF(mListener);
   } else {
     rv = mChannel->AsyncOpen(mListener, nsnull);
     NS_ENSURE_SUCCESS(rv, rv);
   }
 
   rv = mListener->GetInputStream(getter_AddRefs(mPipeInput));
   NS_ENSURE_SUCCESS(rv, rv);
+
+  mPosition = 0;
 
   return NS_OK;
 }
 
 nsresult nsDefaultStreamStrategy::Close()
 {
   nsAutoLock lock(mLock);
   if (mChannel) {
@@ -132,29 +139,35 @@ nsresult nsDefaultStreamStrategy::Close(
 }
 
 nsresult nsDefaultStreamStrategy::Read(char* aBuffer, PRUint32 aCount, PRUint32* aBytes)
 {
   // The read request pulls from the pipe, not the channels input
   // stream. This allows calling from any thread as the pipe is
   // threadsafe.
   nsAutoLock lock(mLock);
-  return mPipeInput ? mPipeInput->Read(aBuffer, aCount, aBytes) : NS_ERROR_FAILURE;
+  if (!mPipeInput)
+    return NS_ERROR_FAILURE;
+
+  nsresult rv = mPipeInput->Read(aBuffer, aCount, aBytes);
+  NS_ENSURE_SUCCESS(rv, rv);
+  mPosition += *aBytes;
+
+  return NS_OK;
 }
 
 nsresult nsDefaultStreamStrategy::Seek(PRInt32 aWhence, PRInt64 aOffset) 
 {
   // Default streams cannot be seeked
   return NS_ERROR_FAILURE;
 }
 
 PRInt64 nsDefaultStreamStrategy::Tell()
 {
-  // Default streams cannot be seeked
-  return 0;
+  return mPosition;
 }
 
 PRUint32 nsDefaultStreamStrategy::Available()
 {
   // The request pulls from the pipe, not the channels input
   // stream. This allows calling from any thread as the pipe is
   // threadsafe.
   nsAutoLock lock(mLock);
@@ -420,16 +433,26 @@ nsresult nsHttpStreamStrategy::Open(nsIS
 
   nsresult rv = mListener->Init();
   NS_ENSURE_SUCCESS(rv, rv);
   
   if (aStreamListener) {
     *aStreamListener = mListener;
     NS_ADDREF(*aStreamListener);
   } else {
+    // Use a byte range request from the start of the resource.
+    // This enables us to detect if the stream supports byte range
+    // requests, and therefore seeking, early.
+    nsCOMPtr<nsIHttpChannel> hc = do_QueryInterface(mChannel);
+    if (hc) {
+      hc->SetRequestHeader(NS_LITERAL_CSTRING("Range"),
+          NS_LITERAL_CSTRING("bytes=0-"),
+          PR_FALSE);
+    }
+ 
     rv = mChannel->AsyncOpen(mListener, nsnull);
     NS_ENSURE_SUCCESS(rv, rv);
   }
   
   rv = mListener->GetInputStream(getter_AddRefs(mPipeInput));
   NS_ENSURE_SUCCESS(rv, rv);
 
   mPosition = 0;
@@ -520,17 +543,17 @@ public:
     nsCOMPtr<nsIHttpChannel> hc = do_QueryInterface(mChannel);
     if (hc) {
       nsCAutoString rangeString("bytes=");
       rangeString.AppendInt(mOffset);
       rangeString.Append("-");
       hc->SetRequestHeader(NS_LITERAL_CSTRING("Range"), rangeString, PR_FALSE);
     }
 
-    mListener = new nsChannelToPipeListener(mDecoder);
+    mListener = new nsChannelToPipeListener(mDecoder, PR_TRUE);
     NS_ENSURE_TRUE(mListener, NS_ERROR_OUT_OF_MEMORY);
 
     mResult = mListener->Init();
     NS_ENSURE_SUCCESS(mResult, mResult);
 
     mResult = mChannel->AsyncOpen(mListener, nsnull);
     NS_ENSURE_SUCCESS(mResult, mResult);
 
diff -r a4343d61f6ee content/media/video/src/nsOggDecoder.cpp
--- a/content/media/video/src/nsOggDecoder.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/src/nsOggDecoder.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -30,16 +30,17 @@
  * under the terms of either the GPL or the LGPL, and not to allow others to
  * use your version of this file under the terms of the MPL, indicate your
  * decision by deleting the provisions above and replace them with the notice
  * and other provisions required by the GPL or the LGPL. If you do not delete
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
+#include <limits>
 #include "prlog.h"
 #include "prmem.h"
 #include "nsIFrame.h"
 #include "nsIDocument.h"
 #include "nsThreadUtils.h"
 #include "nsIDOMHTMLMediaElement.h"
 #include "nsNetUtil.h"
 #include "nsAudioStream.h"
@@ -261,16 +262,28 @@ public:
   // Play the audio data from the given frame. The decode monitor must
   // be locked when calling this method. Returns PR_FALSE if unable to
   // write to the audio device without blocking.
   PRBool PlayAudio(FrameData* aFrame);
 
   // Called from the main thread to get the current frame time. The decoder
   // monitor must be obtained before calling this.
   float GetCurrentTime();
+
+  // Called from the main thread to get the duration. The decoder monitor
+  // must be obtained before calling this. It is in units of milliseconds.
+  PRInt64 GetDuration();
+
+  // Called from the main thread to set the content length of the media
+  // resource. The decoder monitor must be obtained before calling this.
+  void SetContentLength(PRInt64 aLength);
+
+  // Called from the main thread to set whether the media resource can
+  // be seeked. The decoder monitor must be obtained before calling this.
+  void SetSeekable(PRBool aSeekable);
 
   // Get and set the audio volume. The decoder monitor must be
   // obtained before calling this.
   float GetVolume();
   void SetVolume(float aVolume);
 
   // Clear the flag indicating that a playback position change event
   // is currently queued. This is called from the main thread and must
@@ -422,16 +435,30 @@ private:
   // time value. Synchronised via decoder monitor.
   float mCurrentFrameTime;
 
   // Volume of playback. 0.0 = muted. 1.0 = full volume. Read/Written
   // from the decode and main threads. Synchronised via decoder
   // monitor.
   float mVolume;
 
+  // Duration of the media resource. It is accessed from the decoder and main
+  // threads. Synchronised via decoder monitor. It is in units of
+  // milliseconds.
+  PRInt64 mDuration;
+
+  // Content Length of the media resource if known. If it is -1 then the
+  // size is unknown. Accessed from the decoder and main threads. Synchronised
+  // via decoder monitor.
+  PRInt64 mContentLength;
+
+  // PR_TRUE if the media resource can be seeked. Accessed from the decoder
+  // and main threads. Synchronised via decoder monitor.
+  PRPackedBool mSeekable;
+
   // PR_TRUE if an event to notify about a change in the playback
   // position has been queued, but not yet run. It is set to PR_FALSE when
   // the event is run. This allows coalescing of these events as they can be
   // produced many times per second. Synchronised via decoder monitor.
   PRPackedBool mPositionChangeQueued;
 };
 
 nsOggDecodeStateMachine::nsOggDecodeStateMachine(nsOggDecoder* aDecoder, nsChannelReader* aReader) :
@@ -450,16 +477,19 @@ nsOggDecodeStateMachine::nsOggDecodeStat
   mReader(aReader),
   mBufferingStart(0),
   mBufferingBytes(0),
   mLastFrameTime(0),
   mState(DECODER_STATE_DECODING_METADATA),
   mSeekTime(0.0),
   mCurrentFrameTime(0.0),
   mVolume(1.0),
+  mDuration(-1),
+  mContentLength(-1),
+  mSeekable(PR_TRUE),
   mPositionChangeQueued(PR_FALSE)
 {
 }
 
 nsOggDecodeStateMachine::~nsOggDecodeStateMachine()
 {
   while (!mDecodedFrames.IsEmpty()) {
     delete mDecodedFrames.Pop();
@@ -673,17 +703,17 @@ void nsOggDecodeStateMachine::OpenAudioS
 void nsOggDecodeStateMachine::OpenAudioStream()
 {
   //  NS_ASSERTION(PR_InMonitor(mDecoder->GetMonitor()), "OpenAudioStream() called without acquiring decoder monitor");
   mAudioStream = new nsAudioStream();
   if (!mAudioStream) {
     LOG(PR_LOG_ERROR, ("Could not create audio stream"));
   }
   else {
-    mAudioStream->Init(mAudioChannels, mAudioRate);
+    mAudioStream->Init(mAudioChannels, mAudioRate, nsAudioStream::FORMAT_FLOAT32_LE);
     mAudioStream->SetVolume(mVolume);
   }
 }
 
 void nsOggDecodeStateMachine::CloseAudioStream()
 {
   //  NS_ASSERTION(PR_InMonitor(mDecoder->GetMonitor()), "CloseAudioStream() called without acquiring decoder monitor");
   if (mAudioStream) {
@@ -768,16 +798,33 @@ void nsOggDecodeStateMachine::SetVolume(
 }
 
 float nsOggDecodeStateMachine::GetCurrentTime()
 {
   //  NS_ASSERTION(PR_InMonitor(mDecoder->GetMonitor()), "GetCurrentTime() called without acquiring decoder monitor");
   return mCurrentFrameTime;
 }
 
+PRInt64 nsOggDecodeStateMachine::GetDuration()
+{
+  //  NS_ASSERTION(PR_InMonitor(mDecoder->GetMonitor()), "GetDuration() called without acquiring decoder monitor");
+  return mDuration;
+}
+
+void nsOggDecodeStateMachine::SetContentLength(PRInt64 aLength)
+{
+  //  NS_ASSERTION(PR_InMonitor(mDecoder->GetMonitor()), "SetContentLength() called without acquiring decoder monitor");
+  mContentLength = aLength;
+}
+
+void nsOggDecodeStateMachine::SetSeekable(PRBool aSeekable)
+{
+   //  NS_ASSERTION(PR_InMonitor(mDecoder->GetMonitor()), "SetSeekable() called without acquiring decoder monitor");
+  mSeekable = aSeekable;
+}
 
 void nsOggDecodeStateMachine::Shutdown()
 {
   // oggplay_prepare_for_close cannot be undone. Once called, the
   // mPlayer object cannot decode any more frames. Once we've entered
   // the shutdown state here there's no going back.
   nsAutoMonitor mon(mDecoder->GetMonitor());
   if (mPlayer) {
@@ -961,17 +1008,17 @@ nsresult nsOggDecodeStateMachine::Run()
       break;
 
     case DECODER_STATE_BUFFERING:
       if ((PR_IntervalToMilliseconds(PR_IntervalNow() - mBufferingStart) < BUFFERING_WAIT*1000) &&
           mReader->DownloadRate() >= 0 &&            
           mReader->Available() < mBufferingBytes) {
         LOG(PR_LOG_DEBUG, 
             ("Buffering data until %d bytes available or %d milliseconds", 
-             (long)(mBufferingBytes - mReader->Available()),
+             mBufferingBytes - mReader->Available(),
              BUFFERING_WAIT*1000 - (PR_IntervalToMilliseconds(PR_IntervalNow() - mBufferingStart))));
         mon.Wait(PR_MillisecondsToInterval(1000));
         if (mState == DECODER_STATE_SHUTDOWN)
           continue;
       }
       else {
         mState = DECODER_STATE_DECODING;
       }
@@ -1039,29 +1086,50 @@ void nsOggDecodeStateMachine::LoadOggHea
       }
       else if (mAudioTrack == -1 && oggplay_get_track_type(mPlayer, i) == OGGZ_CONTENT_VORBIS) {
         mAudioTrack = i;
         oggplay_set_offset(mPlayer, i, OGGPLAY_AUDIO_OFFSET);
         oggplay_get_audio_samplerate(mPlayer, i, &mAudioRate);
         oggplay_get_audio_channels(mPlayer, i, &mAudioChannels);
         LOG(PR_LOG_DEBUG, ("samplerate: %d, channels: %d", mAudioRate, mAudioChannels));
       }
-      
+ 
       if (oggplay_set_track_active(mPlayer, i) < 0)  {
         LOG(PR_LOG_ERROR, ("Could not set track %d active", i));
       }
     }
-    
+
     if (mVideoTrack == -1) {
       oggplay_set_callback_num_frames(mPlayer, mAudioTrack, OGGPLAY_FRAMES_PER_CALLBACK);
       mCallbackPeriod = 1.0 / (float(mAudioRate) / OGGPLAY_FRAMES_PER_CALLBACK);
     }
     LOG(PR_LOG_DEBUG, ("Callback Period: %f", mCallbackPeriod));
 
     oggplay_use_buffer(mPlayer, OGGPLAY_BUFFER_SIZE);
+
+    // Get the duration from the Ogg file. We only do this if the
+    // content length of the resource is known as we need to seek
+    // to the end of the file to get the last time field. We also
+    // only do this if the resource is seekable.
+    {
+      nsAutoMonitor mon(mDecoder->GetMonitor());
+      if (mState != DECODER_STATE_SHUTDOWN &&
+          mContentLength >= 0 && 
+          mSeekable) {
+        // Don't hold the monitor during the duration
+        // call as it can issue seek requests
+        // and blocks until these are completed.
+        mon.Exit();
+        PRInt64 d = oggplay_get_duration(mPlayer);
+        mon.Enter();
+        mDuration = d;
+      }
+      if (mState == DECODER_STATE_SHUTDOWN)
+        return;
+    }
 
     // Inform the element that we've loaded the Ogg metadata
     nsCOMPtr<nsIRunnable> metadataLoadedEvent = 
       NS_NEW_RUNNABLE_METHOD(nsOggDecoder, mDecoder, MetadataLoaded); 
     
     NS_DispatchToMainThread(metadataLoadedEvent, NS_DISPATCH_NORMAL);
   }
 }
@@ -1092,30 +1160,32 @@ void nsOggDecoder::SetVolume(float volum
 
   if (mDecodeStateMachine) {
     mDecodeStateMachine->SetVolume(volume);
   }
 }
 
 float nsOggDecoder::GetDuration()
 {
-  // Currently not implemented. Video Spec says to return
-  // NaN if unknown.
-  // TODO: return NaN
-  return 0.0;
+  if (mDuration >= 0) {
+     return static_cast<float>(mDuration) / 1000.0;
+  }
+
+  return std::numeric_limits<float>::quiet_NaN();
 }
 
 nsOggDecoder::nsOggDecoder() :
   nsMediaDecoder(),
   mBytesDownloaded(0),
   mCurrentTime(0.0),
   mInitialVolume(0.0),
   mRequestedSeekTime(-1.0),
-  mContentLength(0),
+  mContentLength(-1),
   mNotifyOnShutdown(PR_FALSE),
+  mSeekable(PR_TRUE),
   mReader(0),
   mMonitor(0),
   mPlayState(PLAY_STATE_PAUSED),
   mNextState(PLAY_STATE_PAUSED)
 {
   MOZ_COUNT_CTOR(nsOggDecoder);
 }
 
@@ -1196,16 +1266,21 @@ nsresult nsOggDecoder::Load(nsIURI* aURI
 
   nsresult rv = mReader->Init(this, mURI, aChannel, aStreamListener);
   NS_ENSURE_SUCCESS(rv, rv);
 
   rv = NS_NewThread(getter_AddRefs(mDecodeThread));
   NS_ENSURE_SUCCESS(rv, rv);
 
   mDecodeStateMachine = new nsOggDecodeStateMachine(this, mReader);
+  {
+    nsAutoMonitor mon(mMonitor);
+    mDecodeStateMachine->SetContentLength(mContentLength);
+    mDecodeStateMachine->SetSeekable(mSeekable);
+  }
 
   ChangeState(PLAY_STATE_LOADING);
 
   return mDecodeThread->Dispatch(mDecodeStateMachine, NS_DISPATCH_NORMAL);
 }
 
 nsresult nsOggDecoder::Play()
 {
@@ -1297,16 +1372,21 @@ nsIPrincipal* nsOggDecoder::GetCurrentPr
     return nsnull;
   }
 
   return mReader->GetCurrentPrincipal();
 }
 
 void nsOggDecoder::MetadataLoaded()
 {
+  {
+    nsAutoMonitor mon(mMonitor);
+    mDuration = mDecodeStateMachine ? mDecodeStateMachine->GetDuration() : -1;
+  }
+
   if (mElement) {
     mElement->MetadataLoaded();
   }
 }
 
 void nsOggDecoder::FirstFrameLoaded()
 {
   if (mElement) {
@@ -1329,16 +1409,23 @@ void nsOggDecoder::FirstFrameLoaded()
 }
 
 void nsOggDecoder::ResourceLoaded()
 {
   if (mElement) {
     mElement->ResourceLoaded();
   }
   StopProgress();
+}
+
+void nsOggDecoder::NetworkError()
+{
+  if (mElement)
+    mElement->NetworkError();
+  Stop();
 }
 
 PRBool nsOggDecoder::IsSeeking() const
 {
   return mPlayState == PLAY_STATE_SEEKING;
 }
 
 void nsOggDecoder::PlaybackEnded()
@@ -1368,16 +1455,20 @@ PRInt64 nsOggDecoder::GetTotalBytes()
 PRInt64 nsOggDecoder::GetTotalBytes()
 {
   return mContentLength;
 }
 
 void nsOggDecoder::SetTotalBytes(PRInt64 aBytes)
 {
   mContentLength = aBytes;
+  if (mDecodeStateMachine) {
+    nsAutoMonitor mon(mMonitor);
+    mDecodeStateMachine->SetContentLength(aBytes);
+  } 
 }
 
 void nsOggDecoder::UpdateBytesDownloaded(PRUint64 aBytes)
 {
   mBytesDownloaded = aBytes;
 }
 
 void nsOggDecoder::BufferingStopped()
@@ -1535,8 +1626,23 @@ void nsOggDecoder::PlaybackPositionChang
   // event runs JavaScript that queries the media size, the
   // frame has reflowed and the size updated beforehand.
   Invalidate();
 
   if (mElement && lastTime != mCurrentTime) {
     mElement->DispatchSimpleEvent(NS_LITERAL_STRING("timeupdate"));
   }
 }
+
+void nsOggDecoder::SetSeekable(PRBool aSeekable)
+{
+  mSeekable = aSeekable;
+  if (mDecodeStateMachine) {
+    nsAutoMonitor mon(mMonitor);
+    mDecodeStateMachine->SetSeekable(aSeekable);
+  }
+}
+
+PRBool nsOggDecoder::GetSeekable()
+{
+  return mSeekable;
+}
+
diff -r a4343d61f6ee content/media/video/src/nsWaveDecoder.cpp
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/content/media/video/src/nsWaveDecoder.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,1283 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim:set ts=2 sw=2 sts=2 et cindent: */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: ML 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Mozilla code.
+ *
+ * The Initial Developer of the Original Code is the Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *  Matthew Gregan <kinetik@flim.org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+#include "limits"
+#include "prlog.h"
+#include "prmem.h"
+#include "nsIDOMHTMLMediaElement.h"
+#include "nsIDocument.h"
+#include "nsIFrame.h"
+#include "nsIObserver.h"
+#include "nsIObserverService.h"
+#include "nsISeekableStream.h"
+#include "nsAudioStream.h"
+#include "nsAutoLock.h"
+#include "nsHTMLMediaElement.h"
+#include "nsNetUtil.h"
+#include "nsThreadUtils.h"
+#include "nsWaveDecoder.h"
+
+// Maximum number of seconds to wait when buffering.
+#define BUFFERING_TIMEOUT 3
+
+// The number of seconds of buffer data before buffering happens
+// based on current playback rate.
+#define BUFFERING_SECONDS_LOW_WATER_MARK 1
+
+// Magic values that identify RIFF chunks we're interested in.
+#define RIFF_CHUNK_MAGIC 0x52494646
+#define WAVE_CHUNK_MAGIC 0x57415645
+#define FRMT_CHUNK_MAGIC 0x666d7420
+#define DATA_CHUNK_MAGIC 0x64617461
+
+// Size of RIFF chunk header.  4 byte chunk header type and 4 byte size field.
+#define RIFF_CHUNK_HEADER_SIZE 8
+
+// Size of RIFF header.  RIFF chunk and 4 byte RIFF type.
+#define RIFF_INITIAL_SIZE (RIFF_CHUNK_HEADER_SIZE + 4)
+
+// Size of required part of format chunk.  Actual format chunks may be
+// extended (for non-PCM encodings), but we skip any extended data.
+#define WAVE_FORMAT_CHUNK_SIZE 16
+
+// Size of format chunk including RIFF chunk header.
+#define WAVE_FORMAT_SIZE (RIFF_CHUNK_HEADER_SIZE + WAVE_FORMAT_CHUNK_SIZE)
+
+// PCM encoding type from format chunk.  Linear PCM is the only encoding
+// supported by nsAudioStream.
+#define WAVE_FORMAT_ENCODING_PCM 1
+
+/*
+  A single nsWaveStateMachine instance is owned by the decoder, created
+   on-demand at load time.  Upon creation, the decoder immediately
+   dispatches the state machine event to the decode thread to begin
+   execution.  Once running, metadata loading begins immediately.  If this
+   completes successfully, the state machine will move into a paused state
+   awaiting further commands.  The state machine provides a small set of
+   threadsafe methods enabling the main thread to play, pause, seek, and
+   query parameters.
+
+   An weak (raw) pointer to the decoder's nsMediaStream is used by the state
+   machine to read data, seek, and query stream information.  The decoder is
+   responsible for creating and opening the stream, and may also cancel it.
+   Every other stream operation is performed on the playback thread by the
+   state machine.  A cancel from the main thread will force any in-flight
+   stream operations to abort.
+ */
+class nsWaveStateMachine : public nsRunnable
+{
+public:
+  enum State {
+    STATE_LOADING_METADATA,
+    STATE_BUFFERING,
+    STATE_PLAYING,
+    STATE_SEEKING,
+    STATE_PAUSED,
+    STATE_ENDED,
+    STATE_ERROR,
+    STATE_SHUTDOWN
+  };
+
+  nsWaveStateMachine(nsWaveDecoder* aDecoder, nsMediaStream* aStream,
+                     PRUint32 aBufferWaitTime, float aInitialVolume);
+  ~nsWaveStateMachine();
+
+  // Return current audio volume from the audio backend.  Result in range
+  // [0.0, 1.0].  Threadsafe.
+  float GetVolume();
+
+  // Set specified volume.  aVolume must be in range [0.0, 1.0].
+  // Threadsafe.
+  void SetVolume(float aVolume);
+
+  /*
+    The following four member functions initiate the appropriate state
+    transition suggested by the function name.  Threadsafe.
+   */
+  void Play();
+  void Pause();
+  void Seek(float aTime);
+  void Shutdown();
+
+  // Returns the playback length of the audio data in seconds, calculated
+  // from the length extracted from the metadata.  Returns NaN if called
+  // before metadata validation has completed.  Threadsafe.
+  float GetDuration();
+
+  // Returns the current playback position in the audio stream in seconds.
+  // Threadsafe.
+  float GetCurrentTime();
+
+  // Returns true if the state machine is seeking.  Threadsafe.
+  PRBool IsSeeking();
+
+  // Called by the decoder to indicate that the media stream has closed.
+  void StreamEnded();
+
+  // Main state machine loop.  Runs forever, until shutdown state is reached.
+  NS_IMETHOD Run();
+
+private:
+  // Change the current state and wake the playback thread if it is waiting
+  // on mMonitor.  Used by public member functions called from both threads,
+  // so must hold mMonitor.  Threadsafe.
+  void ChangeState(State aState);
+
+  // Create and initialize audio stream using current audio parameters.
+  void OpenAudioStream();
+
+  // Shut down and dispose audio stream.
+  void CloseAudioStream();
+
+  // Read RIFF_INITIAL_SIZE from the beginning of the stream and verify that
+  // the stream data is a RIFF bitstream containing WAVE data.
+  PRBool LoadRIFFChunk();
+
+  // Scan forward in the stream looking for the WAVE format chunk.  If
+  // found, parse and validate required metadata, then use it to set
+  // mSampleRate, mChannels, mSampleSize, and mSampleFormat.
+  PRBool LoadFormatChunk();
+
+  // Scan forward in the stream looking for the start of the PCM data.  If
+  // found, record the data length and offset in mWaveLength and
+  // mWavePCMOffset.
+  PRBool FindDataOffset();
+
+  // Returns the number of seconds that aBytes represents based on the
+  // current audio parameters.  e.g.  176400 bytes is 1 second at 16-bit
+  // stereo 44.1kHz.
+  float BytesToTime(PRUint32 aBytes) const
+  {
+    NS_ABORT_IF_FALSE(mMetadataValid, "Requires valid metadata");
+    return float(aBytes) / mSampleRate / mSampleSize;
+  }
+
+  // Returns the number of bytes that aTime represents based on the current
+  // audio parameters.  e.g.  1 second is 176400 bytes at 16-bit stereo
+  // 44.1kHz.
+  PRUint32 TimeToBytes(float aTime) const
+  {
+    NS_ABORT_IF_FALSE(mMetadataValid, "Requires valid metadata");
+    return PRUint32(aTime * mSampleRate * mSampleSize);
+  }
+
+  // Rounds aBytes down to the nearest complete sample.  Assumes beginning
+  // of byte range is already sample aligned by caller.
+  PRUint32 RoundDownToSample(PRUint32 aBytes) const
+  {
+    NS_ABORT_IF_FALSE(mMetadataValid, "Requires valid metadata");
+    return aBytes - (aBytes % mSampleSize);
+  }
+
+  // Weak (raw) pointer to our decoder instance.  The decoder manages the
+  // lifetime of the state machine object, so it is guaranteed that the
+  // state machine will not outlive the decoder.  The decoder is not
+  // threadsafe, so this pointer must only be used to create runnable events
+  // targeted at the main thread.
+  nsWaveDecoder* mDecoder;
+
+  // Weak (raw) pointer to a media stream.  The decoder manages the lifetime
+  // of the stream, so it is guaranteed that the stream will live as long as
+  // the state machine.  The stream is threadsafe, but is only used on the
+  // playback thread except for create, open, and cancel, which are called
+  // from the main thread.
+  nsMediaStream* mStream;
+
+  // Our audio stream.  Created on demand when entering playback state.  It
+  // is destroyed when seeking begins and will not be reinitialized until
+  // playback resumes, so it is possible for this to be null.
+  nsAutoPtr<nsAudioStream> mAudioStream;
+
+  // Maximum time in milliseconds to spend waiting for data during buffering.
+  PRUint32 mBufferingWait;
+
+  // Maximum number of bytes to wait for during buffering.
+  PRUint32 mBufferingBytes;
+
+  // Machine time that buffering began, used with mBufferingWait to time out
+  // buffering.
+  PRIntervalTime mBufferingStart;
+
+  // Maximum number of bytes mAudioStream buffers internally.  Used to
+  // calculate next wakeup time after refilling audio buffers.
+  PRUint32 mAudioBufferSize;
+
+  /*
+    Metadata extracted from the WAVE header.  Used to initialize the audio
+    stream, and for byte<->time domain conversions.
+  */
+
+  // Number of samples per second.  Limited to range [100, 96000] in LoadFormatChunk.
+  PRUint32 mSampleRate;
+
+  // Number of channels.  Limited to range [1, 2] in LoadFormatChunk.
+  PRUint32 mChannels;
+
+  // Size of a single sample segment, which includes a sample for each
+  // channel (interleaved).
+  PRUint32 mSampleSize;
+
+  // The sample format of the PCM data.
+  nsAudioStream::SampleFormat mSampleFormat;
+
+  // Size of PCM data stored in the WAVE as reported by the data chunk in
+  // the media.
+  PRUint32 mWaveLength;
+
+  // Start offset of the PCM data in the media stream.  Extends mWaveLength
+  // bytes.
+  PRUint32 mWavePCMOffset;
+
+  /*
+    All member variables following this comment are accessed by both
+    threads and must be synchronized via mMonitor.
+  */
+  PRMonitor* mMonitor;
+
+  // The state to enter when the state machine loop iterates next.
+  State mState;
+
+  // A queued state transition.  This is used to record the next state
+  // transition when play or pause is requested during seeking or metadata
+  // loading to ensure a completed metadata load or seek returns to the most
+  // recently requested state on completion.
+  State mNextState;
+
+  // Volume that the audio backend will be initialized with.
+  float mInitialVolume;
+
+  // Time position (in seconds) to offset current time from audio stream.
+  // Set by calling Seek(float) when seeking, and when the stream is closed
+  // during shutdown.
+  float mTimeOffset;
+
+  // Set when StreamEnded has fired to indicate that we should not expect
+  // any more data from mStream than what is already buffered (i.e. what
+  // Available() reports).
+  PRPackedBool mExpectMoreData;
+
+  // True once metadata has been parsed and validated. Users of mSampleRate,
+  // mChannels, mSampleSize, mSampleFormat, mWaveLength, mWavePCMOffset must
+  // check this flag before assuming the values are valid.
+  PRPackedBool mMetadataValid;
+};
+
+nsWaveStateMachine::nsWaveStateMachine(nsWaveDecoder* aDecoder, nsMediaStream* aStream,
+                                       PRUint32 aBufferWaitTime, float aInitialVolume)
+  : mDecoder(aDecoder),
+    mStream(aStream),
+    mBufferingWait(aBufferWaitTime),
+    mBufferingBytes(0),
+    mBufferingStart(0),
+    mAudioBufferSize(0),
+    mSampleRate(0),
+    mChannels(0),
+    mSampleSize(0),
+    mSampleFormat(nsAudioStream::FORMAT_S16_LE),
+    mWaveLength(0),
+    mWavePCMOffset(0),
+    mMonitor(nsnull),
+    mState(STATE_LOADING_METADATA),
+    mNextState(STATE_PAUSED),
+    mInitialVolume(aInitialVolume),
+    mTimeOffset(0.0),
+    mExpectMoreData(PR_TRUE),
+    mMetadataValid(PR_FALSE)
+{
+  mMonitor = nsAutoMonitor::NewMonitor("nsWaveStateMachine");
+}
+
+nsWaveStateMachine::~nsWaveStateMachine()
+{
+  nsAutoMonitor::DestroyMonitor(mMonitor);
+}
+
+void
+nsWaveStateMachine::Shutdown()
+{
+  ChangeState(STATE_SHUTDOWN);
+}
+
+void
+nsWaveStateMachine::Play()
+{
+  nsAutoMonitor monitor(mMonitor);
+  if (mState == STATE_LOADING_METADATA || mState == STATE_SEEKING) {
+    mNextState = STATE_PLAYING;
+  } else {
+    ChangeState(STATE_PLAYING);
+  }
+}
+
+float
+nsWaveStateMachine::GetVolume()
+{
+  float volume = mInitialVolume;
+  if (mAudioStream) {
+    volume = mAudioStream->GetVolume();
+  }
+  return volume;
+}
+
+void
+nsWaveStateMachine::SetVolume(float aVolume)
+{
+  nsAutoMonitor monitor(mMonitor);
+  mInitialVolume = aVolume;
+  if (mAudioStream) {
+    mAudioStream->SetVolume(aVolume);
+  }
+}
+
+void
+nsWaveStateMachine::Pause()
+{
+  nsAutoMonitor monitor(mMonitor);
+  if (mState == STATE_LOADING_METADATA || mState == STATE_SEEKING) {
+    mNextState = STATE_PAUSED;
+  } else {
+    ChangeState(STATE_PAUSED);
+  }
+}
+
+void
+nsWaveStateMachine::Seek(float aTime)
+{
+  nsAutoMonitor monitor(mMonitor);
+  mNextState = mState;
+  mTimeOffset = aTime;
+  ChangeState(STATE_SEEKING);
+}
+
+float
+nsWaveStateMachine::GetDuration()
+{
+  nsAutoMonitor monitor(mMonitor);
+  if (mMetadataValid) {
+    return BytesToTime(mWaveLength);
+  }
+  return std::numeric_limits<float>::quiet_NaN();
+}
+
+float
+nsWaveStateMachine::GetCurrentTime()
+{
+  nsAutoMonitor monitor(mMonitor);
+  double time = 0.0;
+  if (mAudioStream) {
+    time = mAudioStream->GetTime();
+  }
+  return float(time + mTimeOffset);
+}
+
+PRBool
+nsWaveStateMachine::IsSeeking()
+{
+  nsAutoMonitor monitor(mMonitor);
+  return mState == STATE_SEEKING;
+}
+
+void
+nsWaveStateMachine::StreamEnded()
+{
+  nsAutoMonitor monitor(mMonitor);
+  mExpectMoreData = PR_FALSE;
+}
+
+NS_IMETHODIMP
+nsWaveStateMachine::Run()
+{
+  // Monitor is held by this thread almost permanently, but must be manually
+  // dropped during long operations to prevent the main thread from blocking
+  // when calling methods on the state machine object.
+  nsAutoMonitor monitor(mMonitor);
+
+  for (;;) {
+    switch (mState) {
+    case STATE_LOADING_METADATA:
+      {
+        monitor.Exit();
+        PRBool loaded = LoadRIFFChunk() && LoadFormatChunk() && FindDataOffset();
+        monitor.Enter();
+
+        if (mState == STATE_LOADING_METADATA) {
+          nsCOMPtr<nsIRunnable> event;
+          State newState;
+
+          if (loaded) {
+            mMetadataValid = PR_TRUE;
+            event = NS_NEW_RUNNABLE_METHOD(nsWaveDecoder, mDecoder, MetadataLoaded);
+            newState = mNextState;
+          } else {
+            event = NS_NEW_RUNNABLE_METHOD(nsWaveDecoder, mDecoder, MediaErrorDecode);
+            newState = STATE_ERROR;
+          }
+
+          NS_DispatchToMainThread(event, NS_DISPATCH_NORMAL);
+          ChangeState(newState);
+        }
+      }
+      break;
+
+    case STATE_BUFFERING:
+      if ((PR_IntervalToMilliseconds(PR_IntervalNow() - mBufferingStart) < mBufferingWait) &&
+          mStream->DownloadRate() >= 0 &&
+          mStream->Available() < mBufferingBytes) {
+        LOG(PR_LOG_DEBUG, ("Buffering data until %d bytes or %d milliseconds (rate %f)\n",
+                           mBufferingBytes - mStream->Available(),
+                           mBufferingWait - (PR_IntervalToMilliseconds(PR_IntervalNow() - mBufferingStart)),
+                           mStream->DownloadRate()));
+        monitor.Wait(PR_MillisecondsToInterval(1000));
+      } else {
+        ChangeState(mNextState);
+        nsCOMPtr<nsIRunnable> event =
+          NS_NEW_RUNNABLE_METHOD(nsWaveDecoder, mDecoder, BufferingStopped);
+        NS_DispatchToMainThread(event, NS_DISPATCH_NORMAL);
+      }
+
+      break;
+
+    case STATE_PLAYING:
+      if (!mAudioStream) {
+        OpenAudioStream();
+      } else {
+        mAudioStream->Resume();
+      }
+
+      if (mStream->DownloadRate() >= 0 &&
+          mStream->Available() < mStream->PlaybackRate() * BUFFERING_SECONDS_LOW_WATER_MARK) {
+        nsCOMPtr<nsIRunnable> event =
+          NS_NEW_RUNNABLE_METHOD(nsWaveDecoder, mDecoder, BufferingStarted);
+        NS_DispatchToMainThread(event, NS_DISPATCH_NORMAL);
+
+        // Buffer until mBufferingWait milliseconds of data is available.
+        mBufferingBytes = TimeToBytes(float(mBufferingWait) / 1000.0);
+        mBufferingStart = PR_IntervalNow();
+        ChangeState(STATE_BUFFERING);
+      }
+
+      if (!mExpectMoreData && mStream->Available() < mSampleSize) {
+        // Media stream has ended and there is less data available than a
+        // single sample so end playback.
+        ChangeState(STATE_ENDED);
+      } else {
+        // Assuming enough data is available from the network, we aim to
+        // completely fill the audio backend's buffers with data.  This
+        // allows us plenty of time to wake up and refill the buffers
+        // without an underrun occurring.
+        PRUint32 len = RoundDownToSample(NS_MIN(mStream->Available(),
+                                                PRUint32(mAudioStream->Available() * sizeof(short))));
+        if (len) {
+          nsAutoArrayPtr<char> buf(new char[len]);
+          PRUint32 got = 0;
+
+          monitor.Exit();
+          if (NS_FAILED(mStream->Read(buf.get(), len, &got))) {
+            NS_WARNING("Stream read failed");
+          }
+
+          if (got == 0) {
+            ChangeState(STATE_ENDED);
+          }
+
+          // If we got less data than requested, go ahead and write what we
+          // got to the audio hardware.  It's unlikely that this can happen
+          // since we never attempt to read more data than what is already
+          // buffered.
+          len = RoundDownToSample(got);
+
+          // Calculate difference between the current media stream position
+          // and the expected end of the PCM data.
+          PRInt64 endDelta = mWavePCMOffset + mWaveLength - mStream->Tell();
+          if (endDelta < 0) {
+            // Read past the end of PCM data.  Adjust len to avoid playing
+            // back trailing data.
+            len -= -endDelta;
+            if (RoundDownToSample(len) != len) {
+              NS_WARNING("PCM data does not end with complete sample");
+              len = RoundDownToSample(len);
+            }
+            ChangeState(STATE_ENDED);
+          }
+
+          PRUint32 lengthInSamples = len;
+          if (mSampleFormat == nsAudioStream::FORMAT_S16_LE) {
+            lengthInSamples /= sizeof(short);
+          }
+          mAudioStream->Write(buf.get(), lengthInSamples);
+          monitor.Enter();
+        }
+
+        // To avoid waking up too frequently to top up these buffers,
+        // calculate the duration of the currently buffered data and sleep
+        // until most of the buffered data has been consumed.  We can't
+        // sleep for the entire duration because we might not wake up in
+        // time to refill the buffers, causing an underrun.  To avoid this,
+        // wake up when approximately half the buffered data has been
+        // consumed.  This could be made smarter, but at least avoids waking
+        // up frequently to perform small buffer refills.
+        float nextWakeup = BytesToTime(mAudioBufferSize - mAudioStream->Available() * sizeof(short)) * 1000.0 / 2.0;
+        monitor.Wait(PR_MillisecondsToInterval(PRUint32(nextWakeup)));
+      }
+      break;
+
+    case STATE_SEEKING:
+      {
+        CloseAudioStream();
+
+        monitor.Exit();
+        nsCOMPtr<nsIRunnable> startEvent =
+          NS_NEW_RUNNABLE_METHOD(nsWaveDecoder, mDecoder, SeekingStarted);
+        NS_DispatchToMainThread(startEvent, NS_DISPATCH_SYNC);
+        monitor.Enter();
+
+        if (mState == STATE_SHUTDOWN) {
+          break;
+        }
+
+        PRInt64 position = RoundDownToSample(TimeToBytes(mTimeOffset)) + mWavePCMOffset;
+
+        monitor.Exit();
+        nsresult rv = mStream->Seek(nsISeekableStream::NS_SEEK_SET, position);
+        if (NS_FAILED(rv)) {
+          NS_WARNING("Seek failed");
+        }
+        monitor.Enter();
+
+        if (mState == STATE_SHUTDOWN) {
+          break;
+        }
+
+        monitor.Exit();
+        nsCOMPtr<nsIRunnable> stopEvent =
+          NS_NEW_RUNNABLE_METHOD(nsWaveDecoder, mDecoder, SeekingStopped);
+        NS_DispatchToMainThread(stopEvent, NS_DISPATCH_SYNC);
+        monitor.Enter();
+
+        if (mState != STATE_SHUTDOWN) {
+          ChangeState(mNextState);
+        }
+      }
+      break;
+
+    case STATE_PAUSED:
+      if (mAudioStream) {
+        mAudioStream->Pause();
+      }
+      monitor.Wait();
+      break;
+
+    case STATE_ENDED:
+      if (mAudioStream) {
+        monitor.Exit();
+        mAudioStream->Drain();
+        monitor.Enter();
+        mTimeOffset = mAudioStream->GetTime();
+      }
+
+      // Dispose the audio stream early (before SHUTDOWN) so that
+      // GetCurrentTime no longer attempts to query the audio backend for
+      // stream time.
+      CloseAudioStream();
+
+      if (mState != STATE_SHUTDOWN) {
+        nsCOMPtr<nsIRunnable> event =
+          NS_NEW_RUNNABLE_METHOD(nsWaveDecoder, mDecoder, PlaybackEnded);
+        NS_DispatchToMainThread(event, NS_DISPATCH_NORMAL);
+      }
+
+      while (mState != STATE_SHUTDOWN) {
+        monitor.Wait();
+      }
+      break;
+
+    case STATE_ERROR:
+      monitor.Wait();
+      if (mState != STATE_SHUTDOWN) {
+        NS_WARNING("Invalid state transition");
+        ChangeState(STATE_ERROR);
+      }
+      break;
+
+    case STATE_SHUTDOWN:
+      if (mAudioStream) {
+        mTimeOffset = mAudioStream->GetTime();
+      }
+      CloseAudioStream();
+      return NS_OK;
+    }
+  }
+
+  return NS_OK;
+}
+
+void
+nsWaveStateMachine::ChangeState(State aState)
+{
+  nsAutoMonitor monitor(mMonitor);
+  mState = aState;
+  monitor.NotifyAll();
+}
+
+void
+nsWaveStateMachine::OpenAudioStream()
+{
+  mAudioStream = new nsAudioStream();
+  if (!mAudioStream) {
+    LOG(PR_LOG_ERROR, ("Could not create audio stream"));
+  } else {
+    NS_ABORT_IF_FALSE(mMetadataValid,
+                      "Attempting to initialize audio stream with invalid metadata");
+    mAudioStream->Init(mChannels, mSampleRate, mSampleFormat);
+    mAudioStream->SetVolume(mInitialVolume);
+    mAudioBufferSize = mAudioStream->Available() * sizeof(short);
+  }
+}
+
+void
+nsWaveStateMachine::CloseAudioStream()
+{
+  if (mAudioStream) {
+    mAudioStream->Shutdown();
+    mAudioStream = nsnull;
+  }
+}
+
+static PRUint32
+ReadUint32BE(const char** aBuffer)
+{
+  PRUint32 result =
+    PRUint8((*aBuffer)[0]) << 24 |
+    PRUint8((*aBuffer)[1]) << 16 |
+    PRUint8((*aBuffer)[2]) << 8 |
+    PRUint8((*aBuffer)[3]);
+  *aBuffer += sizeof(PRUint32);
+  return result;
+}
+
+static PRUint32
+ReadUint32LE(const char** aBuffer)
+{
+  PRUint32 result =
+    PRUint8((*aBuffer)[3]) << 24 |
+    PRUint8((*aBuffer)[2]) << 16 |
+    PRUint8((*aBuffer)[1]) << 8 |
+    PRUint8((*aBuffer)[0]);
+  *aBuffer += sizeof(PRUint32);
+  return result;
+}
+
+static PRUint16
+ReadUint16LE(const char** aBuffer)
+{
+  PRUint16 result =
+    PRUint8((*aBuffer)[1]) << 8 |
+    PRUint8((*aBuffer)[0]) << 0;
+  *aBuffer += sizeof(PRUint16);
+  return result;
+}
+
+static PRBool
+ReadAll(nsMediaStream* aStream, char* aBuf, PRUint32 aSize)
+{
+  PRUint32 got = 0;
+  do {
+    PRUint32 read = 0;
+    if (NS_FAILED(aStream->Read(aBuf + got, aSize - got, &read))) {
+      NS_WARNING("Stream read failed");
+      return PR_FALSE;
+    }
+    got += read;
+  } while (got != aSize);
+  return PR_TRUE;
+}
+
+PRBool
+nsWaveStateMachine::LoadRIFFChunk()
+{
+  char riffHeader[RIFF_INITIAL_SIZE];
+  const char* p = riffHeader;
+
+  NS_ABORT_IF_FALSE(mStream->Tell() == 0,
+                    "LoadRIFFChunk called when stream in invalid state");
+
+  if (!ReadAll(mStream, riffHeader, sizeof(riffHeader))) {
+    return PR_FALSE;
+  }
+
+  if (ReadUint32BE(&p) != RIFF_CHUNK_MAGIC) {
+    NS_WARNING("Stream data not in RIFF format");
+    return PR_FALSE;
+  }
+
+  // Skip over RIFF size field.
+  p += 4;
+
+  if (ReadUint32BE(&p) != WAVE_CHUNK_MAGIC) {
+    NS_WARNING("Expected WAVE chunk");
+    return PR_FALSE;
+  }
+
+  return PR_TRUE;
+}
+
+PRBool
+nsWaveStateMachine::LoadFormatChunk()
+{
+  PRUint32 rate, channels, sampleSize, sampleFormat;
+  char waveFormat[WAVE_FORMAT_SIZE];
+  const char* p = waveFormat;
+
+  // RIFF chunks are always word (two byte) aligned.
+  NS_ABORT_IF_FALSE(mStream->Tell() % 2 == 0,
+                    "LoadFormatChunk called with unaligned stream");
+
+  if (!ReadAll(mStream, waveFormat, sizeof(waveFormat))) {
+    return PR_FALSE;
+  }
+
+  if (ReadUint32BE(&p) != FRMT_CHUNK_MAGIC) {
+    NS_WARNING("Expected format chunk");
+    return PR_FALSE;
+  }
+
+  PRUint32 fmtsize = ReadUint32LE(&p);
+
+  if (ReadUint16LE(&p) != WAVE_FORMAT_ENCODING_PCM) {
+    NS_WARNING("WAVE is not uncompressed PCM, compressed encodings are not supported");
+    return PR_FALSE;
+  }
+
+  channels = ReadUint16LE(&p);
+  rate = ReadUint32LE(&p);
+
+  // Skip over average bytes per second field.
+  p += 4;
+
+  sampleSize = ReadUint16LE(&p);
+
+  sampleFormat = ReadUint16LE(&p);
+
+  // PCM encoded WAVEs are not expected to have an extended "format" chunk,
+  // but I have found WAVEs that have a extended "format" chunk with an
+  // extension size of 0 bytes.  Be polite and handle this rather than
+  // considering the file invalid.  This code skips any extension of the
+  // "format" chunk.
+  if (fmtsize > WAVE_FORMAT_CHUNK_SIZE) {
+    char extLength[2];
+    const char* p = extLength;
+
+    if (!ReadAll(mStream, extLength, sizeof(extLength))) {
+      return PR_FALSE;
+    }
+
+    PRUint16 extra = ReadUint16LE(&p);
+    if (fmtsize - (WAVE_FORMAT_CHUNK_SIZE + 2) != extra) {
+      NS_WARNING("Invalid extended format chunk size");
+      return PR_FALSE;
+    }
+    extra += extra % 2;
+
+    if (extra > 0) {
+      nsAutoArrayPtr<char> chunkExtension(new char[extra]);
+      if (!ReadAll(mStream, chunkExtension.get(), extra)) {
+        return PR_FALSE;
+      }
+    }
+  }
+
+  // RIFF chunks are always word (two byte) aligned.
+  NS_ABORT_IF_FALSE(mStream->Tell() % 2 == 0,
+                    "LoadFormatChunk left stream unaligned");
+
+  // Make sure metadata is fairly sane.  The rate check is fairly arbitrary,
+  // but the channels check is intentionally limited to mono or stereo
+  // because that's what the audio backend currently supports.
+  if (rate < 100 || rate > 96000 ||
+      channels < 1 || channels > 2 ||
+      (sampleSize != 1 && sampleSize != 2 && sampleSize != 4) ||
+      (sampleFormat != 8 && sampleFormat != 16)) {
+    NS_WARNING("Invalid WAVE metadata");
+    return PR_FALSE;
+  }
+
+  nsAutoMonitor monitor(mMonitor);
+  mSampleRate = rate;
+  mChannels = channels;
+  mSampleSize = sampleSize;
+  if (sampleFormat == 8) {
+    mSampleFormat = nsAudioStream::FORMAT_U8;
+  } else {
+    mSampleFormat = nsAudioStream::FORMAT_S16_LE;
+  }
+  return PR_TRUE;
+}
+
+PRBool
+nsWaveStateMachine::FindDataOffset()
+{
+  PRUint32 length;
+  PRInt64 offset;
+
+  // RIFF chunks are always word (two byte) aligned.
+  NS_ABORT_IF_FALSE(mStream->Tell() % 2 == 0,
+                    "FindDataOffset called with unaligned stream");
+
+  // The "data" chunk may not directly follow the "format" chunk, so skip
+  // over any intermediate chunks.
+  for (;;) {
+    char chunkHeader[8];
+    const char* p = chunkHeader;
+
+    if (!ReadAll(mStream, chunkHeader, sizeof(chunkHeader))) {
+      return PR_FALSE;
+    }
+
+    PRUint32 magic = ReadUint32BE(&p);
+
+    if (magic == DATA_CHUNK_MAGIC) {
+      length = ReadUint32LE(&p);
+      break;
+    }
+
+    if (magic == FRMT_CHUNK_MAGIC) {
+      LOG(PR_LOG_ERROR, ("Invalid WAVE: expected \"data\" chunk but found \"format\" chunk"));
+      return PR_FALSE;
+    }
+
+    PRUint32 size = ReadUint32LE(&p);
+    size += size % 2;
+
+    nsAutoArrayPtr<char> chunk(new char[size]);
+    if (!ReadAll(mStream, chunk.get(), size)) {
+      return PR_FALSE;
+    }
+  }
+
+  offset = mStream->Tell();
+  if (!offset) {
+    NS_WARNING("PCM data offset not found");
+    return PR_FALSE;
+  }
+
+  if (offset < 0 || offset > PR_UINT32_MAX) {
+    NS_WARNING("offset out of range");
+    return PR_FALSE;
+  }
+
+  nsAutoMonitor monitor(mMonitor);
+  mWaveLength = length;
+  mWavePCMOffset = PRUint32(offset);
+  return PR_TRUE;
+}
+
+NS_IMPL_THREADSAFE_ISUPPORTS1(nsWaveDecoder, nsIObserver)
+
+nsWaveDecoder::nsWaveDecoder()
+  : mBytesDownloaded(0),
+    mInitialVolume(1.0),
+    mStream(nsnull),
+    mEndedCurrentTime(0.0),
+    mEndedDuration(std::numeric_limits<float>::quiet_NaN()),
+    mNotifyOnShutdown(PR_FALSE),
+    mSeekable(PR_TRUE)
+{
+  MOZ_COUNT_CTOR(nsWaveDecoder);
+}
+
+nsWaveDecoder::~nsWaveDecoder()
+{
+  MOZ_COUNT_DTOR(nsWaveDecoder);
+}
+
+void
+nsWaveDecoder::GetCurrentURI(nsIURI** aURI)
+{
+  NS_IF_ADDREF(*aURI = mURI);
+}
+
+nsIPrincipal*
+nsWaveDecoder::GetCurrentPrincipal()
+{
+  if (!mStream) {
+    return nsnull;
+  }
+  return mStream->GetCurrentPrincipal();
+}
+
+float
+nsWaveDecoder::GetCurrentTime()
+{
+  if (mPlaybackStateMachine) {
+    return mPlaybackStateMachine->GetCurrentTime();
+  }
+  return mEndedCurrentTime;
+}
+
+nsresult
+nsWaveDecoder::Seek(float aTime)
+{
+  if (mPlaybackStateMachine && aTime >= 0.0) {
+    mPlaybackStateMachine->Seek(aTime);
+    return NS_OK;
+  }
+  return NS_ERROR_FAILURE;
+}
+
+nsresult
+nsWaveDecoder::PlaybackRateChanged()
+{
+  return NS_ERROR_NOT_IMPLEMENTED;
+}
+
+float
+nsWaveDecoder::GetDuration()
+{
+  if (mPlaybackStateMachine) {
+    return mPlaybackStateMachine->GetDuration();
+  }
+  return mEndedDuration;
+}
+
+void
+nsWaveDecoder::Pause()
+{
+  if (mPlaybackStateMachine) {
+    mPlaybackStateMachine->Pause();
+  }
+}
+
+float
+nsWaveDecoder::GetVolume()
+{
+  if (!mPlaybackStateMachine) {
+    return mInitialVolume;
+  }
+  return mPlaybackStateMachine->GetVolume();
+}
+
+void
+nsWaveDecoder::SetVolume(float aVolume)
+{
+  mInitialVolume = aVolume;
+  if (mPlaybackStateMachine) {
+    mPlaybackStateMachine->SetVolume(aVolume);
+  }
+}
+
+nsresult
+nsWaveDecoder::Play()
+{
+  if (!mPlaybackStateMachine) {
+    Load(mURI, nsnull, nsnull);
+  }
+
+  if (mPlaybackStateMachine) {
+    mPlaybackStateMachine->Play();
+    return NS_OK;
+  }
+
+  return NS_ERROR_FAILURE;
+}
+
+void
+nsWaveDecoder::Stop()
+{
+  StopProgress();
+
+  if (mPlaybackStateMachine) {
+    mPlaybackStateMachine->Shutdown();
+  }
+
+  if (mStream) {
+    mStream->Cancel();
+  }
+
+  if (mPlaybackThread) {
+    mEndedCurrentTime = mPlaybackStateMachine->GetCurrentTime();
+    mEndedDuration = mPlaybackStateMachine->GetDuration();
+    mPlaybackThread->Shutdown();
+  }
+
+  mPlaybackThread = nsnull;
+  mPlaybackStateMachine = nsnull;
+  mStream = nsnull;
+
+  UnregisterShutdownObserver();
+}
+
+nsresult
+nsWaveDecoder::Load(nsIURI* aURI, nsIChannel* aChannel, nsIStreamListener** aStreamListener)
+{
+  if (aStreamListener) {
+    *aStreamListener = nsnull;
+  }
+
+  if (aURI) {
+    NS_ASSERTION(!aStreamListener, "No listener should be requested here");
+    mURI = aURI;
+  } else {
+    NS_ASSERTION(aChannel, "Either a URI or a channel is required");
+    NS_ASSERTION(aStreamListener, "A listener should be requested here");
+
+    nsresult rv = NS_GetFinalChannelURI(aChannel, getter_AddRefs(mURI));
+    NS_ENSURE_SUCCESS(rv, rv);
+  }
+
+  StartProgress();
+  RegisterShutdownObserver();
+
+  mStream = new nsMediaStream();
+  NS_ENSURE_TRUE(mStream, NS_ERROR_OUT_OF_MEMORY);
+
+  nsresult rv = mStream->Open(this, aURI, aChannel, aStreamListener);
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  rv = NS_NewThread(getter_AddRefs(mPlaybackThread));
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  mPlaybackStateMachine = new nsWaveStateMachine(this, mStream.get(),
+                                                 BUFFERING_TIMEOUT * 1000,
+                                                 mInitialVolume);
+  rv = mPlaybackThread->Dispatch(mPlaybackStateMachine, NS_DISPATCH_NORMAL);
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  return NS_OK;
+}
+
+void
+nsWaveDecoder::MetadataLoaded()
+{
+  if (mElement) {
+    mElement->MetadataLoaded();
+    mElement->FirstFrameLoaded();
+  }
+}
+
+void
+nsWaveDecoder::PlaybackEnded()
+{
+  Stop();
+  if (mElement) {
+    mElement->PlaybackEnded();
+  }
+}
+
+void
+nsWaveDecoder::ResourceLoaded()
+{
+  if (mElement) {
+    mElement->ResourceLoaded();
+  }
+  if (mPlaybackStateMachine) {
+    mPlaybackStateMachine->StreamEnded();
+  }
+  StopProgress();
+}
+
+void
+nsWaveDecoder::NetworkError()
+{
+  if (mElement) {
+    mElement->NetworkError();
+  }
+  if (mPlaybackStateMachine) {
+    mPlaybackStateMachine->StreamEnded();
+  }
+  Stop();
+}
+
+PRBool
+nsWaveDecoder::IsSeeking() const
+{
+  if (mPlaybackStateMachine) {
+    return mPlaybackStateMachine->IsSeeking();
+  }
+  return PR_FALSE;
+}
+
+PRUint64
+nsWaveDecoder::GetBytesLoaded()
+{
+  return mBytesDownloaded;
+}
+
+PRInt64
+nsWaveDecoder::GetTotalBytes()
+{
+  return mContentLength;
+}
+
+void
+nsWaveDecoder::SetTotalBytes(PRInt64 aBytes)
+{
+  mContentLength = aBytes;
+}
+
+void
+nsWaveDecoder::UpdateBytesDownloaded(PRUint64 aBytes)
+{
+  mBytesDownloaded = aBytes;
+}
+
+// An event that gets posted to the main thread, when the media element is
+// being destroyed, to destroy the decoder. Since the decoder shutdown can
+// block and post events this cannot be done inside destructor calls. So
+// this event is posted asynchronously to the main thread to perform the
+// shutdown. It keeps a strong reference to the decoder to ensure it does
+// not get deleted when the element is deleted.
+class nsWaveDecoderShutdown : public nsRunnable
+{
+public:
+  nsWaveDecoderShutdown(nsWaveDecoder* aDecoder)
+    : mDecoder(aDecoder)
+  {
+  }
+
+  NS_IMETHOD Run()
+  {
+    mDecoder->Stop();
+    return NS_OK;
+  }
+
+private:
+  nsRefPtr<nsWaveDecoder> mDecoder;
+};
+
+void
+nsWaveDecoder::Shutdown()
+{
+  nsMediaDecoder::Shutdown();
+
+  nsCOMPtr<nsIRunnable> event = new nsWaveDecoderShutdown(this);
+  NS_DispatchToMainThread(event, NS_DISPATCH_NORMAL);
+}
+
+nsresult
+nsWaveDecoder::Observe(nsISupports* aSubject, const char* aTopic, const PRUnichar* aData)
+{
+  if (strcmp(aTopic, NS_XPCOM_SHUTDOWN_OBSERVER_ID) == 0) {
+    Shutdown();
+  }
+  return NS_OK;
+}
+
+void
+nsWaveDecoder::BufferingStarted()
+{
+  if (mElement) {
+    mElement->ChangeReadyState(nsIDOMHTMLMediaElement::DATA_UNAVAILABLE);
+  }
+}
+
+void
+nsWaveDecoder::BufferingStopped()
+{
+  if (mElement) {
+    mElement->ChangeReadyState(nsIDOMHTMLMediaElement::CAN_SHOW_CURRENT_FRAME);
+  }
+}
+
+void
+nsWaveDecoder::SeekingStarted()
+{
+  if (mElement) {
+    mElement->SeekStarted();
+  }
+}
+
+void
+nsWaveDecoder::SeekingStopped()
+{
+  if (mElement) {
+    mElement->SeekCompleted();
+  }
+}
+
+void
+nsWaveDecoder::RegisterShutdownObserver()
+{
+  if (!mNotifyOnShutdown) {
+    nsCOMPtr<nsIObserverService> observerService =
+      do_GetService("@mozilla.org/observer-service;1");
+    if (observerService) {
+      mNotifyOnShutdown =
+        NS_SUCCEEDED(observerService->AddObserver(this,
+                                                  NS_XPCOM_SHUTDOWN_OBSERVER_ID,
+                                                  PR_FALSE));
+    } else {
+      NS_WARNING("Could not get an observer service. Audio playback may not shutdown cleanly.");
+    }
+  }
+}
+
+void
+nsWaveDecoder::UnregisterShutdownObserver()
+{
+  if (mNotifyOnShutdown) {
+    nsCOMPtr<nsIObserverService> observerService =
+      do_GetService("@mozilla.org/observer-service;1");
+    if (observerService) {
+      mNotifyOnShutdown = PR_FALSE;
+      observerService->RemoveObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID);
+    }
+  }
+}
+
+void
+nsWaveDecoder::MediaErrorDecode()
+{
+#if 0
+  if (mElement) {
+    mElement->MediaErrorDecode();
+  }
+#else
+  NS_WARNING("MediaErrorDecode fired, but not implemented.");
+#endif
+}
+
+void
+nsWaveDecoder::SetSeekable(PRBool aSeekable)
+{
+  mSeekable = aSeekable;
+}
+
+PRBool
+nsWaveDecoder::GetSeekable()
+{
+  return mSeekable;
+}
diff -r a4343d61f6ee content/media/video/test/Makefile.in
--- a/content/media/video/test/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/test/Makefile.in	Sat Nov 15 19:43:13 2008 -0500
@@ -43,16 +43,17 @@ include $(DEPTH)/config/autoconf.mk
 include $(DEPTH)/config/autoconf.mk
 include $(topsrcdir)/config/rules.mk
 
 _TEST_FILES = 	test_autoplay.html \
                 test_bug461281.html \
                 test_constants.html \
                 test_controls.html \
                 test_currentTime.html \
+                test_duration1.html \
                 test_ended1.html \
                 test_ended2.html \
                 test_networkState.html \
                 test_paused.html \
                 test_readyState.html \
                 test_seek1.html \
                 test_seek2.html \
                 test_seek3.html \
@@ -61,16 +62,20 @@ _TEST_FILES = 	test_autoplay.html \
                 test_seek6.html \
                 test_seek7.html \
                 test_seek8.html \
                 test_standalone.html \
                 test_timeupdate1.html \
                 test_timeupdate2.html \
                 test_timeupdate3.html \
                 test_volume.html \
+                test_wav_8bit.html \
+                test_wav_ended1.html \
                 320x240.ogg \
                 bug461281.ogg \
                 seek.ogg \
+                r11025_s16_c1.wav \
+                r11025_u8_c1.wav \
 #                test_bug448534.html \
                 $(NULL)
 
 libs:: $(_TEST_FILES)
 	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
diff -r a4343d61f6ee content/media/video/test/r11025_s16_c1.wav
Binary file content/media/video/test/r11025_s16_c1.wav has changed
diff -r a4343d61f6ee content/media/video/test/r11025_u8_c1.wav
Binary file content/media/video/test/r11025_u8_c1.wav has changed
diff -r a4343d61f6ee content/media/video/test/test_bug448534.html
--- a/content/media/video/test/test_bug448534.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/test/test_bug448534.html	Sat Nov 15 19:43:13 2008 -0500
@@ -18,17 +18,16 @@ https://bugzilla.mozilla.org/show_bug.cg
        onloadedmetadata='return loaded();'
        onplay='return started();' 
        onpause='return stopped();'></video>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 var v = document.getElementById('v');
 var played = false;
 var completed = false;
-var timeout;
 
 function loaded() {
   if (completed)
     return false;
 
   v.play();
   return false;
 }
@@ -44,24 +43,17 @@ function started() {
 }
 
 function stopped() {
   if (completed)
     return false;
 
   completed = true;
   ok(v.paused, "Video should be paused after removing from the Document");
-  clearTimeout(timeout);
   SimpleTest.finish();
   return false;
 }
-
-var timeout = setTimeout(function () {
-                ok(false, "Video test timed out");
-                SimpleTest.finish();
-                return false;
-              }, 30000);
 
 SimpleTest.waitForExplicitFinish();
 </script>
 </pre>
 </body>
 </html>
diff -r a4343d61f6ee content/media/video/test/test_bug461281.html
--- a/content/media/video/test/test_bug461281.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/test/test_bug461281.html	Sat Nov 15 19:43:13 2008 -0500
@@ -12,38 +12,32 @@
        onloadedmetadata='return startTest();'
        onended='return playbackEnded();'></video>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 // Test if the ended event occurs with media without an eos marker
 var v = document.getElementById('v');
 var endPassed = false;
 var completed = false;
-var timeout;
 
 function startTest() {
   if (completed)
     return false;
 
   v.play();
   return false;
 }
 
 function playbackEnded() {
   if (completed)
     return false
 
   completed = true;
   ok(v.ended, "Checking playback has ended");
-  clearTimeout(timeout);
   SimpleTest.finish();
   return false;
 }
-timeout = setTimeout(function () {
-                       ok(false, "Test timed out");
-                       SimpleTest.finish();
-                     }, 30000);
 
 SimpleTest.waitForExplicitFinish();
 </script>
 </pre>
 </body>
 </html>
diff -r a4343d61f6ee content/media/video/test/test_duration1.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/content/media/video/test/test_duration1.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,39 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+  <title>Media test: seek test 1</title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<video id='v'
+       src='seek.ogg'
+       onloadedmetadata='return startTest();'></video>
+<pre id="test">
+<script class="testbody" type="text/javascript">
+// Test that getting the duration from a file works
+var completed = false;
+var timeout;
+
+function startTest() {
+  if (completed)
+    return false;
+  var v = document.getElementById('v');
+  ok(Math.round(v.duration*1000) == 3833, "Check duration of video: " + v.duration);
+  completed = true;
+  clearTimeout(timeout);
+  SimpleTest.finish();
+  return false;
+}
+
+timeout = setTimeout(function () {
+		       ok(false, "Test timed out");
+		       SimpleTest.finish();
+		     }, 60000);
+
+SimpleTest.waitForExplicitFinish();
+</script>
+</pre>
+</body>
+</html>
diff -r a4343d61f6ee content/media/video/test/test_ended1.html
--- a/content/media/video/test/test_ended1.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/test/test_ended1.html	Sat Nov 15 19:43:13 2008 -0500
@@ -12,17 +12,16 @@
        onloadedmetadata='return startTest();'
        onended='return playbackEnded();'></video>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 // Test if the ended event works correctly.
 var v = document.getElementById('v');
 var endPassed = false;
 var completed = false;
-var timeout;
 
 function startTest() {
   if (completed)
     return false;
 
   v.play();
   return false;
 }
@@ -30,22 +29,17 @@ function playbackEnded() {
 function playbackEnded() {
   if (completed)
     return false
 
   completed = true;
   ok(v.currentTime >= 3.9 && v.currentTime <= 4.0,
      "Checking currentTime at end: " + v.currentTime);
   ok(v.ended, "Checking playback has ended");
-  clearTimeout(timeout);
   SimpleTest.finish();
   return false;
 }
-timeout = setTimeout(function () {
-                       ok(false, "Test timed out");
-                       SimpleTest.finish();
-                     }, 30000);
 
 SimpleTest.waitForExplicitFinish();
 </script>
 </pre>
 </body>
 </html>
diff -r a4343d61f6ee content/media/video/test/test_ended2.html
--- a/content/media/video/test/test_ended2.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/test/test_ended2.html	Sat Nov 15 19:43:13 2008 -0500
@@ -13,17 +13,16 @@
        onplay='return playbackStarted();'
        onended='return playbackEnded();'></video>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 // Test if video can be replayed after ended.
 var v = document.getElementById('v');
 var completed = false;
 var playCount = 0;
-var timeout;
 
 function startTest() {
   if (completed)
     return false;
 
   v.play();
   return false;
 }
@@ -43,23 +42,18 @@ function playbackEnded() {
      "Checking currentTime at end: " + v.currentTime);
   ok(v.ended, "Checking playback has ended");
   if (playCount < 2) {
     v.play();
   }
   else {
     ok(playCount == 2, "Check playback after ended event");
     completed = true;
-    clearTimeout(timeout);
     SimpleTest.finish();
   }
   return false;
 }
-timeout = setTimeout(function () {
-                       ok(false, "Test timed out");
-                       SimpleTest.finish();
-                     }, 30000);
 
 SimpleTest.waitForExplicitFinish();
 </script>
 </pre>
 </body>
 </html>
diff -r a4343d61f6ee content/media/video/test/test_seek1.html
--- a/content/media/video/test/test_seek1.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/test/test_seek1.html	Sat Nov 15 19:43:13 2008 -0500
@@ -16,17 +16,16 @@
 <pre id="test">
 <script class="testbody" type="text/javascript">
 var startPassed = false;
 var endPassed = false;
 var seekFlagStart = false;
 var seekFlagEnd = false;
 var readonly = true;
 var completed = false;
-var timeout;
 
 ok(!document.getElementById('v').seeking, "seeking should default to false");
 try {
   v1.seeking = 1;
   readonly = false;
 }
 catch(e) {
   readonly = true;
@@ -68,23 +67,17 @@ function playbackEnded() {
   if (completed)
     return false;
 
   completed = true;
   ok(startPassed, "seeking event");
   ok(endPassed, "seeked event");
   ok(seekFlagStart, "seeking flag on start should be true");
   ok(!seekFlagEnd, "seeking flag on end should be false");
-  clearTimeout(timeout);
   SimpleTest.finish();
   return false;
 }
-
-timeout = setTimeout(function () {
-		       ok(false, "Test timed out");
-		       SimpleTest.finish();
-		     }, 30000);
 
 SimpleTest.waitForExplicitFinish();
 </script>
 </pre>
 </body>
 </html>
diff -r a4343d61f6ee content/media/video/test/test_seek3.html
--- a/content/media/video/test/test_seek3.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/test/test_seek3.html	Sat Nov 15 19:43:13 2008 -0500
@@ -15,17 +15,16 @@
        onseeked='return seekEnded();'></video>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 // Test seeking works if current time is set before video is
 // playing.
 var startPassed = false;
 var endPassed = false;
 var completed = false;
-var timeout;
 
 function startTest() {
   if (completed)
     return false;
 
   var v = document.getElementById('v');
   v.currentTime=2;
   v.play();
@@ -52,22 +51,17 @@ function seekEnded() {
 
 function playbackEnded() {
   if (completed)
     return false
 
   completed = true;
   ok(startPassed, "send seeking event");
   ok(endPassed, "send seeked event");
-  clearTimeout(timeout);
   SimpleTest.finish();
   return false;
 }
-timeout = setTimeout(function () {
-                       ok(false, "Test timed out");
-                       SimpleTest.finish();
-                     }, 30000);
 
 SimpleTest.waitForExplicitFinish();
 </script>
 </pre>
 </body>
 </html>
diff -r a4343d61f6ee content/media/video/test/test_seek4.html
--- a/content/media/video/test/test_seek4.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/test/test_seek4.html	Sat Nov 15 19:43:13 2008 -0500
@@ -12,17 +12,16 @@
        onloadedmetadata='return startTest();'
        onseeking='return seekStarted();'
        onseeked='return seekEnded();'></video>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 // Test seeking works if current time is set but video is not played.
 var startPassed = false;
 var completed = false;
-var timeout;
 
 function startTest() {
   if (completed)
     return false;
 
   var v = document.getElementById('v');
   v.currentTime=2;
   return false;
@@ -38,23 +37,17 @@ function seekStarted() {
 
 function seekEnded() {
   if (completed)
     return false;
 
   var t = document.getElementById('v').currentTime;
   ok(t >= 2 && t<= 3, "Video currentTime should be around 2: " + t);
   completed = true;
-  clearTimeout(timeout);
   SimpleTest.finish();
   return false;
 }
-
-timeout = setTimeout(function () {
-                       ok(false, "Test timed out");
-                       SimpleTest.finish();
-                     }, 30000);
 
 SimpleTest.waitForExplicitFinish();
 </script>
 </pre>
 </body>
 </html>
diff -r a4343d61f6ee content/media/video/test/test_seek5.html
--- a/content/media/video/test/test_seek5.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/test/test_seek5.html	Sat Nov 15 19:43:13 2008 -0500
@@ -15,17 +15,16 @@
 <pre id="test">
 <script class="testbody" type="text/javascript">
 // Test for a seek, followed by another seek before the first is complete.
 var startPassed = false;
 var seek1Passed = false;
 var seek2Passed = false;
 var seekCount = 0;
 var completed = false;
-var timeout;
 
 function startTest() {
   if (completed)
     return false;
 
   var v = document.getElementById('v');
   v.currentTime=2;
   return false;
@@ -52,26 +51,20 @@ function seekEnded() {
   }
 
   if(seekCount == 2) {
     if (v.currentTime >= 1 && v.currentTime <= 1.2)
       seek2Passed = true;
 
     ok(seek1Passed, "First seek");
     ok(seek2Passed, "Second seek");
-    clearTimeout(timeout);
     completed = true;
     SimpleTest.finish();
   }
 
   return false;
 }
 
-timeout = setTimeout(function () {
-                       ok(false, "Test timed out");
-                       SimpleTest.finish();
-                     }, 30000);
-
 SimpleTest.waitForExplicitFinish();
 </script>
 </pre>
 </body>
 </html>
diff -r a4343d61f6ee content/media/video/test/test_seek6.html
--- a/content/media/video/test/test_seek6.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/test/test_seek6.html	Sat Nov 15 19:43:13 2008 -0500
@@ -14,17 +14,16 @@
        onseeking='return seekStarted();'
        onseeked='return seekEnded();'></video>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 // Test for a seek, followed by a play before the seek completes, ensure we play at the end of the seek.
 var startPassed = false;
 var completed = false;
 var seekCount = 0;
-var timeout;
 
 function startTest() {
   if (completed)
     return false;
 
   var v = document.getElementById('v');
   v.currentTime=2;
   return false;
@@ -47,23 +46,17 @@ function seekEnded() {
   return false;
 }
 
 function playbackEnded() {
   if (completed)
     return false;
   ok(true, "Playback ended");
   completed = true;
-  clearTimeout(timeout);
   SimpleTest.finish();
   return false;
 }
-
-timeout = setTimeout(function () {
-                       ok(false, "Test timed out");
-                       SimpleTest.finish();
-                     }, 30000);
 
 SimpleTest.waitForExplicitFinish();
 </script>
 </pre>
 </body>
 </html>
diff -r a4343d61f6ee content/media/video/test/test_seek7.html
--- a/content/media/video/test/test_seek7.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/test/test_seek7.html	Sat Nov 15 19:43:13 2008 -0500
@@ -14,17 +14,16 @@
 <pre id="test">
 <script class="testbody" type="text/javascript">
 // Test for bug identified by Chris Pearce in comment 40 on
 // bug 449159.
 var v = document.getElementById('v');
 var seekCount = 0;
 var completed = false;
 var interval;
-var timeout;
 
 function startTest() {
   if (completed)
     return false;
 
   interval = setInterval(function() { v.currentTime=Math.random()*3; }, 10);
   return false;
 }
@@ -32,25 +31,19 @@ function seekEnded() {
 function seekEnded() {
   if (completed)
     return false;
 
   seekCount++;
   ok(true, "Seek " + seekCount);
   if (seekCount == 3) {
     clearInterval(interval);
-    clearTimeout(timeout);
     completed = true;
     SimpleTest.finish();
   }
   return false;
 }
 
-timeout = setTimeout(function () {
-                       ok(false, "Test timed out");
-                       SimpleTest.finish();
-                     }, 30000);
-
 SimpleTest.waitForExplicitFinish();
 </script>
 </pre>
 </body>
 </html>
diff -r a4343d61f6ee content/media/video/test/test_seek8.html
--- a/content/media/video/test/test_seek8.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/test/test_seek8.html	Sat Nov 15 19:43:13 2008 -0500
@@ -11,17 +11,16 @@
        src='seek.ogg'
        onloadedmetadata='return startTest();'></video>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 // If a NaN is passed to currentTime, make sure this is caught
 // otherwise an infinite loop in the Ogg backend occurs.
 var v = document.getElementById('v');
 var completed = false;
-var timeout;
 var thrown1 = false;
 var thrown2 = false;
 var thrown3 = false;
 
 function startTest() {
   if (completed)
     return false;
 
@@ -38,27 +37,21 @@ function startTest() {
   }
 
   try {
     v.currentTime = Math.random;
   } catch(e) {
     thrown3 = true;
   }
 
-  clearTimeout(timeout);
   completed = true;
   ok(thrown1, "Setting currentTime to invalid value of NaN");
   ok(thrown2, "Setting currentTime to invalid value of -1");
   ok(thrown2, "Setting currentTime to invalid value of a function");
   SimpleTest.finish();
   return false;
 }
 
-timeout = setTimeout(function () {
-                       ok(false, "Test timed out");
-                       SimpleTest.finish();
-                     }, 30000);
-
 SimpleTest.waitForExplicitFinish();
 </script>
 </pre>
 </body>
 </html>
diff -r a4343d61f6ee content/media/video/test/test_timeupdate1.html
--- a/content/media/video/test/test_timeupdate1.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/test/test_timeupdate1.html	Sat Nov 15 19:43:13 2008 -0500
@@ -13,17 +13,16 @@
        onended='return playbackEnded();'
        ontimeupdate='return timeUpdated();'></video>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 // Test if timeupdate is dispatched and the current time during the
 // update is increasing.
 var lastTime = 0.0;
 var completed = false;
-var timeout;
 
 function startTest() {
   if (completed)
     return false;
 
   var v = document.getElementById('v');
   v.play();
   return false;
@@ -46,18 +45,14 @@ function playbackEnded() {
 function playbackEnded() {
   if (completed)
     return false
 
   completed = true;
   SimpleTest.finish();
   return false;
 }
-timeout = setTimeout(function () {
-                       ok(false, "Test timed out");
-                       SimpleTest.finish();
-                     }, 30000);
 
 SimpleTest.waitForExplicitFinish();
 </script>
 </pre>
 </body>
 </html>
diff -r a4343d61f6ee content/media/video/test/test_timeupdate2.html
--- a/content/media/video/test/test_timeupdate2.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/test/test_timeupdate2.html	Sat Nov 15 19:43:13 2008 -0500
@@ -10,17 +10,16 @@
 <video id='v'
        src='seek.ogg'
        onloadedmetadata='return startTest();'
        ontimeupdate='return timeUpdated();'></video>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 // Test if the media size during the first timeupdate is correct.
 var completed = false;
-var timeout;
 
 function startTest() {
   if (completed)
     return false;
 
   var v = document.getElementById('v');
   v.play();
   return false;
@@ -34,18 +33,13 @@ function timeUpdated() {
   ok(v.videoHeight == 240, "Check video height of " + v.videoHeight + " is 240");
   ok(v.videoWidth == 320, "Check video width of " + v.videoWidth + " is 320");
   completed = true;
   v.pause();
   SimpleTest.finish();
   return false;
 }
 
-timeout = setTimeout(function () {
-                       ok(false, "Test timed out");
-                       SimpleTest.finish();
-                     }, 30000);
-
 SimpleTest.waitForExplicitFinish();
 </script>
 </pre>
 </body>
 </html>
diff -r a4343d61f6ee content/media/video/test/test_timeupdate3.html
--- a/content/media/video/test/test_timeupdate3.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/media/video/test/test_timeupdate3.html	Sat Nov 15 19:43:13 2008 -0500
@@ -12,17 +12,16 @@
        onloadedmetadata='return startTest();'
        onseeking='return startSeek();'
        ontimeupdate='return timeUpdated();'></video>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 // Test if the media size during the first timeupdate is correct.
 var completed = false;
 var seeking = false;
-var timeout;
 
 function startTest() {
   if (completed)
     return false;
 
   var v = document.getElementById('v');
   v.currentTime=2.0;
   return false;
@@ -44,18 +43,13 @@ function timeUpdated() {
   ok(v.currentTime >= 1.8 && v.currentTime <= 2.2,
      "Check currentTime of " + v.currentTime + " is within range in timeupdate after seek");
   completed = true;
   v.pause();
   SimpleTest.finish();
   return false;
 }
 
-timeout = setTimeout(function () {
-                       ok(false, "Test timed out");
-                       SimpleTest.finish();
-                     }, 30000);
-
 SimpleTest.waitForExplicitFinish();
 </script>
 </pre>
 </body>
 </html>
diff -r a4343d61f6ee content/media/video/test/test_wav_8bit.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/content/media/video/test/test_wav_8bit.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,46 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+  <title>Wave Media test: 8-bit sample format</title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<audio id='v'
+       onloadedmetadata='return startTest();'
+       onended='return playbackEnded();'>
+  <source type='audio/x-wav' src='r11025_u8_c1.wav'>
+</audio>
+<pre id="test">
+<script class="testbody" type="text/javascript">
+// Test if the ended event works correctly.
+var v = document.getElementById('v');
+var endPassed = false;
+var completed = false;
+
+function startTest() {
+  if (completed)
+    return false;
+
+  v.play();
+  return false;
+}
+
+function playbackEnded() {
+  if (completed)
+    return false
+
+  completed = true;
+  ok(v.currentTime >= 0.9 && v.currentTime <= 1.1,
+     "Checking currentTime at end: " + v.currentTime);
+  ok(v.ended, "Checking playback has ended");
+  SimpleTest.finish();
+  return false;
+}
+
+SimpleTest.waitForExplicitFinish();
+</script>
+</pre>
+</body>
+</html>
diff -r a4343d61f6ee content/media/video/test/test_wav_ended1.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/content/media/video/test/test_wav_ended1.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,46 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+  <title>Wave Media test: ended</title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<audio id='v'
+       onloadedmetadata='return startTest();'
+       onended='return playbackEnded();'>
+  <source type='audio/x-wav' src='r11025_s16_c1.wav'>
+</audio>
+<pre id="test">
+<script class="testbody" type="text/javascript">
+// Test if the ended event works correctly.
+var v = document.getElementById('v');
+var endPassed = false;
+var completed = false;
+
+function startTest() {
+  if (completed)
+    return false;
+
+  v.play();
+  return false;
+}
+
+function playbackEnded() {
+  if (completed)
+    return false
+
+  completed = true;
+  ok(v.currentTime >= 0.9 && v.currentTime <= 1.1,
+     "Checking currentTime at end: " + v.currentTime);
+  ok(v.ended, "Checking playback has ended");
+  SimpleTest.finish();
+  return false;
+}
+
+SimpleTest.waitForExplicitFinish();
+</script>
+</pre>
+</body>
+</html>
diff -r a4343d61f6ee content/svg/content/test/Makefile.in
--- a/content/svg/content/test/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/svg/content/test/Makefile.in	Sat Nov 15 19:43:13 2008 -0500
@@ -46,16 +46,17 @@ include $(topsrcdir)/config/rules.mk
 
 _TEST_FILES = \
 		test_bbox.xhtml \
 		bbox-helper.svg \
 		test_dataTypes.html \
 		dataTypes-helper.svg \
 		test_getSubStringLength.xhtml \
 		getSubStringLength-helper.svg \
+		test_pathSeg.xhtml \
 		test_scientific.html \
 		scientific-helper.svg \
 		test_text.html \
 		text-helper.svg \
 		$(NULL)
 
 libs:: $(_TEST_FILES)
 	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
diff -r a4343d61f6ee content/svg/content/test/test_pathSeg.xhtml
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/content/svg/content/test/test_pathSeg.xhtml	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,143 @@
+<!DOCTYPE html>
+<html xmlns="http://www.w3.org/1999/xhtml">
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=459953
+-->
+<head>
+  <title>Test for Bug 459953</title>
+  <script type="application/javascript" src="/MochiKit/packed.js"></script>
+  <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=459953">Mozilla Bug 459953</a>
+<p id="display"></p>
+
+<pre id="test">
+<script class="testbody" type="application/javascript">
+<![CDATA[
+SimpleTest.waitForExplicitFinish();
+
+function runTest()
+{
+  var svgns="http://www.w3.org/2000/svg";
+
+  var path1=document.createElementNS(svgns, "path");
+
+  var sseg;
+  
+  var a=10,s=20,d=30,z=9; //Arbitrary numbers for arguments
+  
+  var whatever=true; //This is often so, but here it does not matter
+  
+  sseg=path1.createSVGPathSegMovetoAbs(a, s);
+  path1.pathSegList.appendItem(sseg);
+  sseg=path1.createSVGPathSegMovetoRel(a, s);
+  path1.pathSegList.appendItem(sseg);
+  sseg=path1.createSVGPathSegLinetoAbs(a, s);
+  path1.pathSegList.appendItem(sseg);
+  sseg=path1.createSVGPathSegLinetoRel(a, s);
+  path1.pathSegList.appendItem(sseg);
+  sseg=path1.createSVGPathSegLinetoVerticalAbs(a);
+  path1.pathSegList.appendItem(sseg);
+  sseg=path1.createSVGPathSegLinetoVerticalRel(a);
+  path1.pathSegList.appendItem(sseg);
+  sseg=path1.createSVGPathSegLinetoHorizontalAbs(a);
+  path1.pathSegList.appendItem(sseg);
+  sseg=path1.createSVGPathSegLinetoHorizontalRel(a);
+  path1.pathSegList.appendItem(sseg);
+  sseg=path1.createSVGPathSegCurvetoCubicAbs(a, s, d, z, a, s);
+  path1.pathSegList.appendItem(sseg);
+  sseg=path1.createSVGPathSegCurvetoCubicRel(a, s, d, z, a, s);
+  path1.pathSegList.appendItem(sseg);
+  sseg=path1.createSVGPathSegCurvetoCubicSmoothAbs(a, s, d, z);
+  path1.pathSegList.appendItem(sseg);
+  sseg=path1.createSVGPathSegCurvetoCubicSmoothRel(a, s, d, z);
+  path1.pathSegList.appendItem(sseg);
+  sseg=path1.createSVGPathSegCurvetoQuadraticAbs(a, s, d, z);
+  path1.pathSegList.appendItem(sseg);
+  sseg=path1.createSVGPathSegCurvetoQuadraticRel(a, s, d, z);
+  path1.pathSegList.appendItem(sseg);
+  sseg=path1.createSVGPathSegCurvetoQuadraticSmoothAbs(a, s);
+  path1.pathSegList.appendItem(sseg);
+  sseg=path1.createSVGPathSegCurvetoQuadraticSmoothRel(a, s);
+  path1.pathSegList.appendItem(sseg);
+  sseg=path1.createSVGPathSegArcAbs(a, s, d, z, a, whatever, whatever);
+  path1.pathSegList.appendItem(sseg);
+  sseg=path1.createSVGPathSegArcRel(a, s, d, z, a, whatever, whatever);
+  path1.pathSegList.appendItem(sseg);
+  sseg=path1.createSVGPathSegClosePath();
+  path1.pathSegList.appendItem(sseg);
+  
+  for(var i=0;i<path1.pathSegList.numberOfItems;i++){
+    var seg=path1.pathSegList.getItem(i);
+    switch(seg.pathSegType){
+    case seg.PATHSEG_MOVETO_ABS:
+      is(seg.pathSegTypeAsLetter, "M", "wrong path segment letter");      
+      break;
+    case seg.PATHSEG_MOVETO_REL:
+      is(seg.pathSegTypeAsLetter, "m", "wrong path segment letter");      
+      break;
+    case seg.PATHSEG_CLOSEPATH:
+      is(seg.pathSegTypeAsLetter, "z", "wrong path segment letter");      
+      break;
+    case seg.PATHSEG_LINETO_ABS:
+      is(seg.pathSegTypeAsLetter, "L", "wrong path segment letter");      
+      break;
+    case seg.PATHSEG_LINETO_REL:
+      is(seg.pathSegTypeAsLetter, "l", "wrong path segment letter");      
+      break;
+    case seg.PATHSEG_LINETO_VERTICAL_ABS:
+      is(seg.pathSegTypeAsLetter, "V", "wrong path segment letter");      
+      break;
+    case seg.PATHSEG_LINETO_VERTICAL_REL:
+      is(seg.pathSegTypeAsLetter, "v", "wrong path segment letter");      
+      break;
+    case seg.PATHSEG_LINETO_HORIZONTAL_ABS:
+      is(seg.pathSegTypeAsLetter, "H", "wrong path segment letter");      
+      break;
+    case seg.PATHSEG_LINETO_HORIZONTAL_REL:
+      is(seg.pathSegTypeAsLetter, "h", "wrong path segment letter");      
+      break;
+    case seg.PATHSEG_CURVETO_CUBIC_ABS:
+      is(seg.pathSegTypeAsLetter, "C", "wrong path segment letter");      
+      break;
+    case seg.PATHSEG_CURVETO_CUBIC_REL:
+      is(seg.pathSegTypeAsLetter, "c", "wrong path segment letter");      
+      break;
+    case seg.PATHSEG_CURVETO_CUBIC_SMOOTH_ABS:
+      is(seg.pathSegTypeAsLetter, "S", "wrong path segment letter");      
+      break;
+    case seg.PATHSEG_CURVETO_CUBIC_SMOOTH_REL:
+      is(seg.pathSegTypeAsLetter, "s", "wrong path segment letter");      
+      break;
+    case seg.PATHSEG_CURVETO_QUADRATIC_ABS:
+      is(seg.pathSegTypeAsLetter, "Q", "wrong path segment letter");      
+      break;
+    case seg.PATHSEG_CURVETO_QUADRATIC_REL:
+      is(seg.pathSegTypeAsLetter, "q", "wrong path segment letter");      
+      break;
+    case seg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_ABS:
+      is(seg.pathSegTypeAsLetter, "T", "wrong path segment letter");      
+      break;
+    case seg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_REL:
+      is(seg.pathSegTypeAsLetter, "t", "wrong path segment letter");      
+      break;
+    case seg.PATHSEG_ARC_ABS:
+      is(seg.pathSegTypeAsLetter, "A", "wrong path segment letter");      
+      break;
+    case seg.PATHSEG_ARC_REL:
+      is(seg.pathSegTypeAsLetter, "a", "wrong path segment letter");      
+      break;
+      
+    }
+  }
+  SimpleTest.finish();
+}
+
+window.addEventListener("load", runTest, false);
+]]>
+</script>
+</pre>
+</body>
+</html>
diff -r a4343d61f6ee content/xbl/src/nsXBLProtoImpl.cpp
--- a/content/xbl/src/nsXBLProtoImpl.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/xbl/src/nsXBLProtoImpl.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -59,17 +59,17 @@ nsXBLProtoImpl::InstallImplementation(ns
   if (!mMembers && !mFields)  // Constructor and destructor also live in mMembers
     return NS_OK; // Nothing to do, so let's not waste time.
 
   // If the way this gets the script context changes, fix
   // nsXBLProtoImplAnonymousMethod::Execute
   nsIDocument* document = aBoundElement->GetOwnerDoc();
   if (!document) return NS_OK;
 
-  nsIScriptGlobalObject *global = document->GetScriptGlobalObject();
+  nsIScriptGlobalObject *global = document->GetScopeObject();
   if (!global) return NS_OK;
 
   nsCOMPtr<nsIScriptContext> context = global->GetContext();
   if (!context) return NS_OK;
 
   // InitTarget objects gives us back the JS object that represents the bound element and the
   // class object in the bound document that represents the concrete version of this implementation.
   // This function also has the side effect of building up the prototype implementation if it has
@@ -117,19 +117,17 @@ nsXBLProtoImpl::InitTargetObjects(nsXBLP
 
     if (!mClassObject)
       return NS_OK; // This can be ok, if all we've got are fields (and no methods/properties).
   }
 
   nsIDocument *ownerDoc = aBoundElement->GetOwnerDoc();
   nsIScriptGlobalObject *sgo;
 
-  if (!ownerDoc || !(sgo = ownerDoc->GetScriptGlobalObject())) {
-    NS_ERROR("Can't find global object for bound content!");
-
+  if (!ownerDoc || !(sgo = ownerDoc->GetScopeObject())) {
     return NS_ERROR_UNEXPECTED;
   }
 
   // Because our prototype implementation has a class, we need to build up a corresponding
   // class for the concrete implementation in the bound document.
   JSContext* jscontext = (JSContext*)aContext->GetNativeContext();
   JSObject* global = sgo->GetGlobalJSObject();
   nsCOMPtr<nsIXPConnectJSObjectHolder> wrapper;
@@ -146,23 +144,17 @@ nsXBLProtoImpl::InitTargetObjects(nsXBLP
   // concrete base class.  We need to alter the object so that our concrete class is interposed
   // between the object and its base class.  We become the new base class of the object, and the
   // object's old base class becomes the new class' base class.
   rv = aBinding->InitClass(mClassName, jscontext, global, object,
                            aTargetClassObject);
   if (NS_FAILED(rv))
     return rv;
 
-  // Root ourselves in the document.
-  nsIDocument* doc = aBoundElement->GetOwnerDoc();
-  if (doc) {
-    nsCOMPtr<nsIXPConnectWrappedNative> nativeWrapper(do_QueryInterface(wrapper));
-    if (nativeWrapper)
-      doc->AddReference(aBoundElement, nativeWrapper);
-  }
+  aBoundElement->PreserveWrapper();
 
   wrapper.swap(*aScriptObjectHolder);
   
   return rv;
 }
 
 nsresult
 nsXBLProtoImpl::CompilePrototypeMembers(nsXBLPrototypeBinding* aBinding)
diff -r a4343d61f6ee content/xbl/src/nsXBLProtoImplMethod.cpp
--- a/content/xbl/src/nsXBLProtoImplMethod.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/xbl/src/nsXBLProtoImplMethod.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -127,19 +127,17 @@ nsXBLProtoImplMethod::InstallMember(nsIS
 {
   NS_PRECONDITION(IsCompiled(),
                   "Should not be installing an uncompiled method");
   JSContext* cx = (JSContext*) aContext->GetNativeContext();
 
   nsIDocument *ownerDoc = aBoundElement->GetOwnerDoc();
   nsIScriptGlobalObject *sgo;
 
-  if (!ownerDoc || !(sgo = ownerDoc->GetScriptGlobalObject())) {
-    NS_ERROR("Can't find global object for bound content!");
- 
+  if (!ownerDoc || !(sgo = ownerDoc->GetScopeObject())) {
     return NS_ERROR_UNEXPECTED;
   }
 
   JSObject * scriptObject = (JSObject *) aScriptObject;
   NS_ASSERTION(scriptObject, "uh-oh, script Object should NOT be null or bad things will happen");
   if (!scriptObject)
     return NS_ERROR_FAILURE;
 
diff -r a4343d61f6ee content/xbl/src/nsXBLProtoImplProperty.cpp
--- a/content/xbl/src/nsXBLProtoImplProperty.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/xbl/src/nsXBLProtoImplProperty.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -155,19 +155,17 @@ nsXBLProtoImplProperty::InstallMember(ns
 {
   NS_PRECONDITION(mIsCompiled,
                   "Should not be installing an uncompiled property");
   JSContext* cx = (JSContext*) aContext->GetNativeContext();
 
   nsIDocument *ownerDoc = aBoundElement->GetOwnerDoc();
   nsIScriptGlobalObject *sgo;
 
-  if (!ownerDoc || !(sgo = ownerDoc->GetScriptGlobalObject())) {
-    NS_ERROR("Can't find global object for bound content!");
- 
+  if (!ownerDoc || !(sgo = ownerDoc->GetScopeObject())) {
     return NS_ERROR_UNEXPECTED;
   }
 
   JSObject * scriptObject = (JSObject *) aScriptObject;
   NS_ASSERTION(scriptObject, "uh-oh, script Object should NOT be null or bad things will happen");
   if (!scriptObject)
     return NS_ERROR_FAILURE;
 
diff -r a4343d61f6ee content/xbl/src/nsXBLPrototypeHandler.cpp
--- a/content/xbl/src/nsXBLPrototypeHandler.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/xbl/src/nsXBLPrototypeHandler.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -297,21 +297,19 @@ nsXBLPrototypeHandler::ExecuteHandler(ns
       nsCOMPtr<nsIContent> content(do_QueryInterface(aTarget));
       if (!content)
         return NS_OK;
       boundDocument = content->GetOwnerDoc();
       if (!boundDocument)
         return NS_OK;
     }
 
-    boundGlobal = boundDocument->GetScriptGlobalObject();
+    boundGlobal = boundDocument->GetScopeObject();
   }
 
-  // If we still don't have a 'boundGlobal', we're doomed. bug 95465.
-  NS_ASSERTION(boundGlobal, "failed to get the nsIScriptGlobalObject. bug 95465?");
   if (!boundGlobal)
     return NS_OK;
 
   nsIScriptContext *boundContext = boundGlobal->GetScriptContext(stID);
   if (!boundContext)
     return NS_OK;
 
   nsScriptObjectHolder handler(boundContext);
diff -r a4343d61f6ee content/xbl/src/nsXBLService.cpp
--- a/content/xbl/src/nsXBLService.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/xbl/src/nsXBLService.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -543,16 +543,24 @@ nsXBLService::LoadBindings(nsIContent* a
   nsresult rv;
 
   nsCOMPtr<nsIDocument> document = aContent->GetOwnerDoc();
 
   // XXX document may be null if we're in the midst of paint suppression
   if (!document)
     return NS_OK;
 
+  nsCAutoString urlspec;
+  if (nsContentUtils::GetWrapperSafeScriptFilename(document, aURL, urlspec)) {
+    // Block an attempt to load a binding that has special wrapper
+    // automation needs.
+
+    return NS_OK;
+  }
+
   nsBindingManager *bindingManager = document->BindingManager();
   
   nsXBLBinding *binding = bindingManager->GetBinding(aContent);
   if (binding && !aAugmentFlag) {
     nsXBLBinding *styleBinding = binding->GetFirstStyleBinding();
     if (styleBinding) {
       if (binding->MarkedForDeath()) {
         FlushStyleBindings(aContent);
@@ -677,38 +685,16 @@ nsXBLService::ResolveTag(nsIContent* aCo
     NS_IF_ADDREF(*aResult);
   }
   else {
     *aNameSpaceID = aContent->GetNameSpaceID();
     NS_ADDREF(*aResult = aContent->Tag());
   }
 
   return NS_OK;
-}
-
-nsIXBLDocumentInfo*
-nsXBLService::GetXBLDocumentInfo(nsIURI* aURI, nsIContent* aBoundElement)
-{
-#ifdef MOZ_XUL
-  nsXULPrototypeCache* cache = nsXULPrototypeCache::GetInstance();
-  if (cache && cache->IsEnabled()) { 
-    // The first line of defense is the chrome cache.  
-    // This cache crosses the entire product, so any XBL bindings that are
-    // part of chrome will be reused across all XUL documents.
-    return cache->GetXBLDocumentInfo(aURI);
-  }
-#endif
-
-  // The second line of defense is the binding manager's document table.
-  nsIDocument* boundDocument = aBoundElement->GetOwnerDoc();
-  if (boundDocument) {
-    return boundDocument->BindingManager()->GetXBLDocumentInfo(aURI);
-  }
-
-  return nsnull;
 }
 
 
 //
 // AttachGlobalKeyHandler
 //
 // Creates a new key handler and prepares to listen to key events on the given
 // event receiver (either a document or an content node). If the receiver is content,
diff -r a4343d61f6ee content/xbl/src/nsXBLService.h
--- a/content/xbl/src/nsXBLService.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/xbl/src/nsXBLService.h	Sat Nov 15 19:43:13 2008 -0500
@@ -103,19 +103,16 @@ protected:
   // Release any memory that we can
   nsresult FlushMemory();
   
   // This method synchronously loads and parses an XBL file.
   nsresult FetchBindingDocument(nsIContent* aBoundElement, nsIDocument* aBoundDocument,
                                 nsIURI* aDocumentURI, nsIURI* aBindingURI, 
                                 PRBool aForceSyncLoad, nsIDocument** aResult);
 
-  nsIXBLDocumentInfo* GetXBLDocumentInfo(nsIURI* aURI,
-                                         nsIContent* aBoundElement);
-
   /**
    * This method calls the one below with an empty |aDontExtendURIs| array.
    */
   nsresult GetBinding(nsIContent* aBoundElement, nsIURI* aURI,
                       PRBool aPeekFlag, nsIPrincipal* aOriginPrincipal,
                       PRBool* aIsReady, nsXBLBinding** aResult);
 
   /**
diff -r a4343d61f6ee content/xml/document/src/nsXMLContentSink.cpp
--- a/content/xml/document/src/nsXMLContentSink.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/xml/document/src/nsXMLContentSink.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -650,16 +650,28 @@ nsXMLContentSink::CloseElement(nsIConten
     if (ssle) {
       ssle->SetEnableUpdates(PR_TRUE);
       PRBool willNotify;
       PRBool isAlternate;
       rv = ssle->UpdateStyleSheet(this, &willNotify, &isAlternate);
       if (NS_SUCCEEDED(rv) && willNotify && !isAlternate) {
         ++mPendingSheetCount;
         mScriptLoader->AddExecuteBlocker();
+      }
+    }
+    // Look for <link rel="dns-prefetch" href="hostname">
+    if (nodeInfo->Equals(nsGkAtoms::link, kNameSpaceID_XHTML)) {
+      nsAutoString relVal;
+      aContent->GetAttr(kNameSpaceID_None, nsGkAtoms::rel, relVal);
+      if (relVal.EqualsLiteral("dns-prefetch")) {
+        nsAutoString hrefVal;
+        aContent->GetAttr(kNameSpaceID_None, nsGkAtoms::href, hrefVal);
+        if (!hrefVal.IsEmpty()) {
+          PrefetchDNS(hrefVal);
+        }
       }
     }
   }
 
   return rv;
 }  
 
 nsresult
diff -r a4343d61f6ee content/xul/content/src/nsXULElement.cpp
--- a/content/xul/content/src/nsXULElement.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/content/xul/content/src/nsXULElement.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -3124,17 +3124,17 @@ nsXULPrototypeScript::Compile(const PRUn
 
         context = global->GetScriptContext(mScriptObject.mLangID);
         NS_ASSERTION(context != nsnull, "no context for script global");
         if (! context)
             return NS_ERROR_UNEXPECTED;
     }
 
     nsCAutoString urlspec;
-    aURI->GetSpec(urlspec);
+    nsContentUtils::GetWrapperSafeScriptFilename(aDocument, aURI, urlspec);
 
     // Ok, compile it to create a prototype script object!
 
     nsScriptObjectHolder newScriptObject(context);
     rv = context->CompileScript(aText,
                                 aTextLength,
                                 nsnull,
                                 // Use the enclosing document's principal
diff -r a4343d61f6ee dom/public/Makefile.in
--- a/dom/public/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/dom/public/Makefile.in	Sat Nov 15 19:43:13 2008 -0500
@@ -66,11 +66,12 @@ EXPORTS=nsIScriptContext.h		\
 	nsDOMError.h			\
 	nsIJSEventListener.h		\
 	nsIDOMClassInfo.h		\
 	nsDOMClassInfoID.h		\
 	nsIBaseDOMException.h		\
 	nsDOMString.h			\
 	nsDOMJSUtils.h			\
 	nsDOMScriptObjectHolder.h	\
+	nsWrapperCache.h	\
 	$(NULL)
 
 include $(topsrcdir)/config/rules.mk
diff -r a4343d61f6ee dom/public/idl/geolocation/nsIDOMGeoGeolocation.idl
--- a/dom/public/idl/geolocation/nsIDOMGeoGeolocation.idl	Thu Nov 06 18:33:22 2008 +0100
+++ b/dom/public/idl/geolocation/nsIDOMGeoGeolocation.idl	Sat Nov 15 19:43:13 2008 -0500
@@ -36,23 +36,23 @@
 
 #include "domstubs.idl"
 
 interface nsIDOMGeoPosition;
 interface nsIDOMGeoPositionOptions;
 interface nsIDOMGeoPositionCallback;
 interface nsIDOMGeoPositionErrorCallback;
 
-[scriptable, function, uuid(CE495440-C8B9-42DE-B67C-60E6928C0F40)]
+[scriptable, function, uuid(0EC70F3F-7E15-45E0-84E9-CDE078CB150A)]
 interface nsIDOMGeoGeolocation : nsISupports
 {
   readonly attribute nsIDOMGeoPosition lastPosition;
 
   void getCurrentPosition(in nsIDOMGeoPositionCallback successCallback,
                           [optional] in nsIDOMGeoPositionErrorCallback errorCallback,
                           [optional] in nsIDOMGeoPositionOptions options);
 
-  unsigned short watchPosition(in nsIDOMGeoPositionCallback successCallback,
-                               [optional] in nsIDOMGeoPositionErrorCallback errorCallback,
-                               [optional] in nsIDOMGeoPositionOptions options);
+  long watchPosition(in nsIDOMGeoPositionCallback successCallback,
+                     [optional] in nsIDOMGeoPositionErrorCallback errorCallback,
+                     [optional] in nsIDOMGeoPositionOptions options);
 
-  void clearWatch(in unsigned short watchId);
+  void clearWatch(in long watchId);
 };
diff -r a4343d61f6ee dom/public/idl/geolocation/nsIDOMGeoPositionError.idl
--- a/dom/public/idl/geolocation/nsIDOMGeoPositionError.idl	Thu Nov 06 18:33:22 2008 +0100
+++ b/dom/public/idl/geolocation/nsIDOMGeoPositionError.idl	Sat Nov 15 19:43:13 2008 -0500
@@ -32,14 +32,19 @@
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 
 #include "domstubs.idl"
 
-[scriptable, uuid(39928BF8-4466-4A64-BF5F-97114A5CD171)]
+[scriptable, uuid(1B493214-4E58-4A40-AA4C-1AB70C6DDBEC)]
 interface nsIDOMGeoPositionError : nsISupports
 {
+  const unsigned short UNKNOWN_ERROR = 0;
+  const unsigned short PERMISSION_DENIED  = 1;
+  const unsigned short POSITION_UNAVAILABLE = 2;
+  const unsigned short TIMEOUT = 3;
+
   readonly attribute short code;
   readonly attribute DOMString message;
 };
diff -r a4343d61f6ee dom/public/idl/geolocation/nsIGeolocationProvider.idl
--- a/dom/public/idl/geolocation/nsIGeolocationProvider.idl	Thu Nov 06 18:33:22 2008 +0100
+++ b/dom/public/idl/geolocation/nsIGeolocationProvider.idl	Sat Nov 15 19:43:13 2008 -0500
@@ -43,25 +43,24 @@ interface nsIDOMGeoPosition;
 interface nsIDOMGeoPosition;
 interface nsIGeolocationPrompt;
 
 /**
  * Interface allows access to a geolocation and is passed to
  * the nsIGeolocationPrompt so that the application can approve
  * or deny the request.
  */
-[scriptable, function, uuid(D681C322-C075-4C6E-9765-C22711A4A60E)]
+[scriptable, function, uuid(F2AEFDE1-8E38-48B3-BBB8-BD6C4AE1AC8A)]
 interface nsIGeolocationRequest : nsISupports {
 
   readonly attribute nsIURI requestingURI;
   readonly attribute nsIDOMWindow requestingWindow;
 
   void cancel();
   void allow();
-  void allowButFuzz();
 };
 
 /**
  * Interface provides a way for the application to handle
  * the UI prompts associated with geo position.
  */
 [scriptable, function, uuid(2300C895-1BEE-4297-912C-A57082F3E936)]
 interface nsIGeolocationPrompt : nsISupports {
diff -r a4343d61f6ee dom/public/nsWrapperCache.h
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/dom/public/nsWrapperCache.h	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,146 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Gecko DOM code.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *    Peter Van der Beken <peterv@propagandism.org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#ifndef nsWrapperCache_h___
+#define nsWrapperCache_h___
+
+#include "nsCycleCollectionParticipant.h"
+
+typedef unsigned long PtrBits;
+
+#define NS_WRAPPERCACHE_IID \
+{ 0x3a51ca81, 0xddab, 0x422c, \
+  { 0x95, 0x3a, 0x13, 0x06, 0x28, 0x0e, 0xee, 0x14 } }
+
+/**
+ * Class to store the XPCWrappedNative for an object. This can only be used
+ * with objects that only have one XPCWrappedNative at a time (usually ensured
+ * by setting an explicit parent in the PreCreate hook for the class). This
+ * object can be gotten by calling QueryInterface, note that this breaks XPCOM
+ * rules a bit (this object doesn't derive from nsISupports).
+ */
+class nsWrapperCache
+{
+public:
+  NS_DECLARE_STATIC_IID_ACCESSOR(NS_WRAPPERCACHE_IID)
+
+  nsWrapperCache() : mWrapperPtrBits(0)
+  {
+  }
+  ~nsWrapperCache()
+  {
+    if (PreservingWrapper()) {
+      GetWrapper()->Release();
+    }
+  }
+
+  /**
+   * This method returns an nsIXPConnectWrappedNative, but we want to avoid
+   * including nsIXPConnect, because we don't want to make everyone require
+   * JS and XPConnect.
+   */
+  nsISupports* GetWrapper()
+  {
+    return reinterpret_cast<nsISupports*>(mWrapperPtrBits & ~kWrapperBitMask);
+  }
+
+  /**
+   * This method takes an nsIXPConnectWrappedNative, but we want to avoid
+   * including nsIXPConnect, because we don't want to make everyone require
+   * JS and XPConnect.
+   */
+  void SetWrapper(nsISupports* aWrapper)
+  {
+    NS_ASSERTION(!mWrapperPtrBits, "Already have a wrapper!");
+    mWrapperPtrBits = reinterpret_cast<PtrBits>(aWrapper);
+  }
+
+  void ClearWrapper()
+  {
+    if (PreservingWrapper()) {
+      GetWrapper()->Release();
+    }
+    mWrapperPtrBits = 0;
+  }
+
+  void PreserveWrapper()
+  {
+    NS_ASSERTION(mWrapperPtrBits, "No wrapper to preserve?");
+    if (!PreservingWrapper()) {
+      NS_ADDREF(reinterpret_cast<nsISupports*>(mWrapperPtrBits));
+      mWrapperPtrBits |= WRAPPER_BIT_PRESERVED;
+    }
+  }
+
+  void ReleaseWrapper()
+  {
+    if (PreservingWrapper()) {
+      nsISupports* wrapper = GetWrapper();
+      mWrapperPtrBits = reinterpret_cast<PtrBits>(wrapper);
+      NS_RELEASE(wrapper);
+    }
+  }
+
+  void TraverseWrapper(nsCycleCollectionTraversalCallback &cb)
+  {
+    if (PreservingWrapper()) {
+      NS_CYCLE_COLLECTION_NOTE_EDGE_NAME(cb, "mWrapper");
+      cb.NoteXPCOMChild(GetWrapper());
+    }
+  }
+
+private:
+  PRBool PreservingWrapper()
+  {
+    return mWrapperPtrBits & WRAPPER_BIT_PRESERVED;
+  }
+
+  enum { WRAPPER_BIT_PRESERVED = 1 << 0 };
+  enum { kWrapperBitMask = 0x1 };
+
+  PtrBits mWrapperPtrBits;
+};
+
+NS_DEFINE_STATIC_IID_ACCESSOR(nsWrapperCache, NS_WRAPPERCACHE_IID)
+
+#define NS_WRAPPERCACHE_INTERFACE_MAP_ENTRY                                   \
+  if ( aIID.Equals(NS_GET_IID(nsWrapperCache)) ) {                            \
+    *aInstancePtr = static_cast<nsWrapperCache*>(this);                       \
+    return NS_OK;                                                             \
+  }
+
+#endif /* nsWrapperCache_h___ */
diff -r a4343d61f6ee dom/src/base/nsDOMClassInfo.cpp
--- a/dom/src/base/nsDOMClassInfo.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/dom/src/base/nsDOMClassInfo.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -166,16 +166,17 @@
 #include "nsIDOMHTMLOptionElement.h"
 #include "nsIDOMNSHTMLOptionElement.h"
 #include "nsIDOMHTMLOptionsCollection.h"
 #include "nsIDOMNSHTMLOptionCollectn.h"
 #include "nsIDOMHTMLOptionsCollection.h"
 
 // ContentList includes
 #include "nsContentList.h"
+#include "nsGenericElement.h"
 
 // Event related includes
 #include "nsIEventListenerManager.h"
 #include "nsIDOMEventTarget.h"
 #include "nsIDOMNSEventTarget.h"
 
 // CSS related includes
 #include "nsIDOMStyleSheet.h"
@@ -207,17 +208,17 @@
 #include "nsIDOMXPathEvaluator.h"
 #include "nsIXSLTProcessor.h"
 #include "nsIXSLTProcessorObsolete.h"
 #include "nsIXSLTProcessorPrivate.h"
 
 #include "nsIDOMLSProgressEvent.h"
 #include "nsIDOMParser.h"
 #include "nsIDOMSerializer.h"
-#include "nsIXMLHttpRequest.h"
+#include "nsXMLHttpRequest.h"
 
 // includes needed for the prototype chain interfaces
 #include "nsIDOMNavigator.h"
 #include "nsIDOMBarProp.h"
 #include "nsIDOMScreen.h"
 #include "nsIDOMDocumentType.h"
 #include "nsIDOMDOMImplementation.h"
 #include "nsIDOMDocumentFragment.h"
@@ -487,17 +488,18 @@ static const char kDOMStringBundleURL[] 
   nsIXPCScriptable::WANT_OUTER_OBJECT |                                       \
   nsIXPCScriptable::WANT_INNER_OBJECT |                                       \
   nsIXPCScriptable::DONT_ENUM_QUERY_INTERFACE)
 
 #define NODE_SCRIPTABLE_FLAGS                                                 \
  ((DOM_DEFAULT_SCRIPTABLE_FLAGS |                                             \
    nsIXPCScriptable::WANT_GETPROPERTY |                                       \
    nsIXPCScriptable::WANT_ADDPROPERTY |                                       \
-   nsIXPCScriptable::WANT_SETPROPERTY) &                                      \
+   nsIXPCScriptable::WANT_SETPROPERTY |                                       \
+   nsIXPCScriptable::WANT_FINALIZE) &                                         \
   ~nsIXPCScriptable::USE_JSSTUB_FOR_ADDPROPERTY)
 
 // We need to let JavaScript QI elements to interfaces that are not in
 // the classinfo since XBL can be used to dynamically implement new
 // unknown interfaces on elements, accessibility relies on this being
 // possible.
 
 #define ELEMENT_SCRIPTABLE_FLAGS                                              \
@@ -511,24 +513,31 @@ static const char kDOMStringBundleURL[] 
    nsIXPCScriptable::WANT_SETPROPERTY |                                       \
    nsIXPCScriptable::WANT_CALL)
 
 #define DOCUMENT_SCRIPTABLE_FLAGS                                             \
   (NODE_SCRIPTABLE_FLAGS |                                                    \
    nsIXPCScriptable::WANT_ADDPROPERTY |                                       \
    nsIXPCScriptable::WANT_DELPROPERTY |                                       \
    nsIXPCScriptable::WANT_GETPROPERTY |                                       \
-   nsIXPCScriptable::WANT_ENUMERATE   |                                       \
-   nsIXPCScriptable::WANT_POSTCREATE  |                                       \
-   nsIXPCScriptable::WANT_FINALIZE)
+   nsIXPCScriptable::WANT_ENUMERATE)
 
 #define ARRAY_SCRIPTABLE_FLAGS                                                \
   (DOM_DEFAULT_SCRIPTABLE_FLAGS       |                                       \
    nsIXPCScriptable::WANT_GETPROPERTY |                                       \
    nsIXPCScriptable::WANT_ENUMERATE)
+
+#define NODELIST_SCRIPTABLE_FLAGS                                             \
+  (ARRAY_SCRIPTABLE_FLAGS             |                                       \
+   nsIXPCScriptable::WANT_FINALIZE)
+
+#define EVENTTARGET_SCRIPTABLE_FLAGS                                          \
+  (DOM_DEFAULT_SCRIPTABLE_FLAGS       |                                       \
+   nsIXPCScriptable::WANT_ADDPROPERTY |                                       \
+   nsIXPCScriptable::WANT_FINALIZE)
 
 #define DOMCLASSINFO_STANDARD_FLAGS                                           \
   (nsIClassInfo::MAIN_THREAD_ONLY | nsIClassInfo::DOM_OBJECT)
 
 
 #ifdef NS_DEBUG
 #define NS_DEFINE_CLASSINFO_DATA_DEBUG(_class)                                \
     eDOMClassInfo_##_class##_id,
@@ -630,17 +639,17 @@ static nsDOMClassInfoData sClassInfoData
   NS_DEFINE_CLASSINFO_DATA(Text, nsNodeSH,
                            NODE_SCRIPTABLE_FLAGS)
   NS_DEFINE_CLASSINFO_DATA(Comment, nsNodeSH,
                            NODE_SCRIPTABLE_FLAGS)
   NS_DEFINE_CLASSINFO_DATA(CDATASection, nsNodeSH, NODE_SCRIPTABLE_FLAGS)
   NS_DEFINE_CLASSINFO_DATA(ProcessingInstruction, nsNodeSH,
                            NODE_SCRIPTABLE_FLAGS)
   NS_DEFINE_CLASSINFO_DATA(Notation, nsNodeSH, NODE_SCRIPTABLE_FLAGS)
-  NS_DEFINE_CLASSINFO_DATA(NodeList, nsNodeListSH, ARRAY_SCRIPTABLE_FLAGS)
+  NS_DEFINE_CLASSINFO_DATA(NodeList, nsNodeListSH, NODELIST_SCRIPTABLE_FLAGS)
   NS_DEFINE_CLASSINFO_DATA(NamedNodeMap, nsNamedNodeMapSH,
                            ARRAY_SCRIPTABLE_FLAGS)
 
   // Misc Core related classes
 
   // StyleSheet classes
   NS_DEFINE_CLASSINFO_DATA_WITH_NAME(DocumentStyleSheetList, StyleSheetList,
                                      nsStyleSheetListSH,
@@ -881,19 +890,17 @@ static nsDOMClassInfoData sClassInfoData
 
   NS_DEFINE_CLASSINFO_DATA(RangeException, nsDOMGenericSH,
                            DOM_DEFAULT_SCRIPTABLE_FLAGS)
 
   NS_DEFINE_CLASSINFO_DATA(CSSValueList, nsCSSValueListSH,
                            ARRAY_SCRIPTABLE_FLAGS)
 
   NS_DEFINE_CLASSINFO_DATA_WITH_NAME(ContentList, HTMLCollection,
-                                     nsContentListSH,
-                                     ARRAY_SCRIPTABLE_FLAGS |
-                                     nsIXPCScriptable::WANT_PRECREATE)
+                                     nsContentListSH, NODELIST_SCRIPTABLE_FLAGS)
 
   NS_DEFINE_CLASSINFO_DATA(XMLStylesheetProcessingInstruction, nsNodeSH,
                            NODE_SCRIPTABLE_FLAGS)
 
   NS_DEFINE_CLASSINFO_DATA(ImageDocument, nsHTMLDocumentSH,
                            DOCUMENT_SCRIPTABLE_FLAGS)
 
 #ifdef MOZ_XUL
@@ -1204,18 +1211,17 @@ static nsDOMClassInfoData sClassInfoData
   NS_DEFINE_CLASSINFO_DATA(DOMParser, nsDOMGenericSH,
                            DOM_DEFAULT_SCRIPTABLE_FLAGS)
   NS_DEFINE_CLASSINFO_DATA(XMLSerializer, nsDOMGenericSH,
                            DOM_DEFAULT_SCRIPTABLE_FLAGS)
 
   NS_DEFINE_CLASSINFO_DATA(XMLHttpProgressEvent, nsDOMGenericSH,
                            DOM_DEFAULT_SCRIPTABLE_FLAGS)
   NS_DEFINE_CLASSINFO_DATA(XMLHttpRequest, nsEventTargetSH,
-                           DOM_DEFAULT_SCRIPTABLE_FLAGS |
-                           nsIXPCScriptable::WANT_ADDPROPERTY)
+                           EVENTTARGET_SCRIPTABLE_FLAGS)
 
   NS_DEFINE_CLASSINFO_DATA(ClientRect, nsDOMGenericSH,
                            DOM_DEFAULT_SCRIPTABLE_FLAGS)
   NS_DEFINE_CLASSINFO_DATA(ClientRectList, nsClientRectListSH,
                            ARRAY_SCRIPTABLE_FLAGS)
 
 #ifdef MOZ_SVG
   NS_DEFINE_CLASSINFO_DATA(SVGForeignObjectElement, nsElementSH,
@@ -1276,18 +1282,17 @@ static nsDOMClassInfoData sClassInfoData
   NS_DEFINE_CLASSINFO_DATA(HTMLAudioElement, nsHTMLElementSH,
                            ELEMENT_SCRIPTABLE_FLAGS)
 #endif
 
   NS_DEFINE_CLASSINFO_DATA(ProgressEvent, nsDOMGenericSH,
                            DOM_DEFAULT_SCRIPTABLE_FLAGS)
 
   NS_DEFINE_CLASSINFO_DATA(XMLHttpRequestUpload, nsEventTargetSH,
-                           DOM_DEFAULT_SCRIPTABLE_FLAGS |
-                           nsIXPCScriptable::WANT_ADDPROPERTY)
+                           EVENTTARGET_SCRIPTABLE_FLAGS)
 
   // DOM Traversal NodeIterator class  
   NS_DEFINE_CLASSINFO_DATA(NodeIterator, nsDOMGenericSH,
                            DOM_DEFAULT_SCRIPTABLE_FLAGS)
 
   // data transfer for drag and drop
   NS_DEFINE_CLASSINFO_DATA(DataTransfer, nsDOMGenericSH,
                            DOM_DEFAULT_SCRIPTABLE_FLAGS)
@@ -4203,38 +4208,24 @@ nsDOMClassInfo::GetClassInfoInstance(nsD
     NS_ADDREF(aData->mCachedClassInfo);
     aData->mCachedClassInfo = MARK_EXTERNAL(aData->mCachedClassInfo);
   }
 
   return GET_CLEAN_CI_PTR(aData->mCachedClassInfo);
 }
 
 // static
-nsresult
+void
 nsDOMClassInfo::PreserveNodeWrapper(nsIXPConnectWrappedNative *aWrapper)
 {
-   nsISupports *native = aWrapper->Native();
-   nsCOMPtr<nsIDOMNode> node(do_QueryInterface(native));
-   
-   nsCOMPtr<nsIDocument> doc;
-   if (node) {
-     nsCOMPtr<nsIDOMDocument> domdoc;
-     node->GetOwnerDocument(getter_AddRefs(domdoc));
-     doc = do_QueryInterface(domdoc);
-  }
-
-   if (!doc) {
-     doc = do_QueryInterface(native);
-   }
-
-   if (doc) {
-     nsCOMPtr<nsINode> n(do_QueryInterface(node));
-     doc->AddReference(n, aWrapper);
-   }
-   return NS_OK;
+  nsWrapperCache* cache = nsnull;
+  CallQueryInterface(aWrapper->Native(), &cache);
+  if (cache) {
+    cache->PreserveWrapper();
+  }
 }
 
 
 // static
 void
 nsDOMClassInfo::ShutDown()
 {
   if (sClassInfoData[0].u.mConstructorFptr) {
@@ -6968,31 +6959,48 @@ nsNodeSH::PreCreate(nsISupports *nativeO
                            getter_AddRefs(holder));
 
   *parentObj = JSVAL_TO_OBJECT(v);
 
   return rv;
 }
 
 NS_IMETHODIMP
+nsNodeSH::PostCreate(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
+                     JSObject *obj)
+{
+  nsINode* node = static_cast<nsINode*>(wrapper->Native());
+  node->SetWrapper(wrapper);
+
+  return nsEventReceiverSH::PostCreate(wrapper, cx, obj);
+}
+
+NS_IMETHODIMP
 nsNodeSH::AddProperty(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
                       JSObject *obj, jsval id, jsval *vp, PRBool *_retval)
 {
   nsDOMClassInfo::PreserveNodeWrapper(wrapper);
   return nsEventReceiverSH::AddProperty(wrapper, cx, obj, id, vp, _retval);
 }
 
 NS_IMETHODIMP
 nsNodeSH::NewResolve(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
                      JSObject *obj, jsval id, PRUint32 flags,
                      JSObject **objp, PRBool *_retval)
 {
   if ((id == sBaseURIObject_id || id == sNodePrincipal_id) &&
       IsPrivilegedScript()) {
     return DefineVoidProp(cx, obj, id, objp);
+  }
+
+  if (id == sOnload_id || id == sOnerror_id) {
+    // Make sure that this node can't go away while waiting for a
+    // network load that could fire an event handler.
+    nsINode* node = static_cast<nsINode*>(wrapper->Native());
+    node->PreserveWrapper();
   }
 
   return nsEventReceiverSH::NewResolve(wrapper, cx, obj, id, flags, objp,
                                        _retval);
 }
 
 NS_IMETHODIMP
 nsNodeSH::GetProperty(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
@@ -7053,16 +7061,26 @@ NS_IMETHODIMP
 NS_IMETHODIMP
 nsNodeSH::GetFlags(PRUint32 *aFlags)
 {
   *aFlags = DOMCLASSINFO_STANDARD_FLAGS | nsIClassInfo::CONTENT_NODE;
 
   return NS_OK;
 }
 
+NS_IMETHODIMP
+nsNodeSH::Finalize(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
+                   JSObject *obj)
+{
+  nsINode* node = static_cast<nsINode*>(wrapper->Native());
+  node->ClearWrapper();
+
+  return NS_OK;
+}
+ 
 // EventReceiver helper
 
 // static
 PRBool
 nsEventReceiverSH::ReallyIsEventName(jsval id, jschar aFirstChar)
 {
   // I wonder if this is faster than using a hash...
 
@@ -7303,22 +7321,16 @@ nsEventReceiverSH::DefineAddEventListene
   return fnc ? NS_OK : NS_ERROR_UNEXPECTED;
 }
 
 NS_IMETHODIMP
 nsEventReceiverSH::NewResolve(nsIXPConnectWrappedNative *wrapper,
                               JSContext *cx, JSObject *obj, jsval id,
                               PRUint32 flags, JSObject **objp, PRBool *_retval)
 {
-  if (id == sOnload_id || id == sOnerror_id) {    
-    // Make sure that this node can't go away while waiting for a
-    // network load that could fire an event handler.
-    nsDOMClassInfo::PreserveNodeWrapper(wrapper);
-  }
-
   if (!JSVAL_IS_STRING(id)) {
     return NS_OK;
   }
 
   if (flags & JSRESOLVE_ASSIGNING) {
     if (!IsEventName(id)) {
       // Bail out.  We don't care about this assignment.
       return NS_OK;
@@ -7394,16 +7406,40 @@ nsEventReceiverSH::AddProperty(nsIXPConn
                                jsval *vp, PRBool *_retval)
 {
   return nsEventReceiverSH::SetProperty(wrapper, cx, obj, id, vp, _retval);
 }
 
 // EventTarget helper
 
 NS_IMETHODIMP
+nsEventTargetSH::PreCreate(nsISupports *nativeObj, JSContext *cx,
+                           JSObject *globalObj, JSObject **parentObj)
+{
+  nsXHREventTarget *target = nsXHREventTarget::FromSupports(nativeObj);
+
+  nsCOMPtr<nsIScriptGlobalObject> native_parent;
+  target->GetParentObject(getter_AddRefs(native_parent));
+
+  *parentObj = native_parent ? native_parent->GetGlobalJSObject() : globalObj;
+
+  return NS_OK;
+}
+
+NS_IMETHODIMP
+nsEventTargetSH::PostCreate(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
+                            JSObject *obj)
+{
+  nsXHREventTarget *target = nsXHREventTarget::FromSupports(wrapper->Native());
+  target->SetWrapper(wrapper);
+
+  return nsDOMGenericSH::PostCreate(wrapper, cx, obj);
+}
+
+NS_IMETHODIMP
 nsEventTargetSH::NewResolve(nsIXPConnectWrappedNative *wrapper,
                             JSContext *cx, JSObject *obj, jsval id,
                             PRUint32 flags, JSObject **objp, PRBool *_retval)
 {
   if ((flags & JSRESOLVE_ASSIGNING) || !JSVAL_IS_STRING(id)) {
     return NS_OK;
   }
   if (id == sAddEventListener_id) {
@@ -7415,35 +7451,33 @@ nsEventTargetSH::NewResolve(nsIXPConnect
 
 NS_IMETHODIMP
 nsEventTargetSH::AddProperty(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
                              JSObject *obj, jsval id, jsval *vp, PRBool *_retval)
 {
   if (id == sAddEventListener_id) {
     return NS_OK;
   }
-  nsISupports* native = wrapper->Native();
-  nsCOMPtr<nsPIDOMEventTarget> target = do_QueryInterface(native);
-  if (target) {
-    nsCOMPtr<nsIScriptContext> scriptContext;
-    target->GetContextForEventHandlers(getter_AddRefs(scriptContext));
-    if (scriptContext) {
-      nsCOMPtr<nsPIDOMWindow> window =
-        do_QueryInterface(scriptContext->GetGlobalObject());
-      if (window) {
-        nsCOMPtr<nsIDocument> doc =
-          do_QueryInterface(window->GetExtantDocument());
-        if (doc) {
-          doc->AddReference(native, wrapper);
-        }
-      }
-    }
-  }
-  return NS_OK;
-}
+
+  nsXHREventTarget *target = nsXHREventTarget::FromSupports(wrapper->Native());
+  target->PreserveWrapper();
+
+  return NS_OK;
+}
+
+NS_IMETHODIMP
+nsEventTargetSH::Finalize(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
+                          JSObject *obj)
+{
+  nsXHREventTarget *target = nsXHREventTarget::FromSupports(wrapper->Native());
+  target->ClearWrapper();
+
+  return NS_OK;
+}
+
 
 // Element helper
 
 NS_IMETHODIMP
 nsElementSH::PostCreate(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
                         JSObject *obj)
 {
   nsresult rv = nsNodeSH::PostCreate(wrapper, cx, obj);
@@ -7708,16 +7742,59 @@ nsArraySH::GetProperty(nsIXPConnectWrapp
 
   return rv;
 }
 
 
 // NodeList scriptable helper
 
 nsresult
+nsNodeListSH::PreCreate(nsISupports *nativeObj, JSContext *cx,
+                        JSObject *globalObj, JSObject **parentObj)
+{
+  nsWrapperCache* cache = nsnull;
+  CallQueryInterface(nativeObj, &cache);
+  if (!cache) {
+    *parentObj = globalObj;
+    return NS_OK;
+  }
+
+  // nsChildContentList is the only class that uses nsNodeListSH and has a
+  // cached wrapper.
+  nsChildContentList *list = nsChildContentList::FromSupports(nativeObj);
+  nsISupports *native_parent = list->GetParentObject();
+  if (!native_parent) {
+    return NS_ERROR_FAILURE;
+  }
+
+  jsval v;
+  nsCOMPtr<nsIXPConnectJSObjectHolder> holder;
+  nsresult rv = WrapNative(cx, globalObj, native_parent,
+                           NS_GET_IID(nsISupports), &v,
+                           getter_AddRefs(holder));
+
+  *parentObj = JSVAL_TO_OBJECT(v);
+
+  return rv;
+}
+
+NS_IMETHODIMP
+nsNodeListSH::PostCreate(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
+                         JSObject *obj)
+{
+  nsWrapperCache* cache = nsnull;
+  CallQueryInterface(wrapper->Native(), &cache);
+  if (cache) {
+    cache->SetWrapper(wrapper);
+  }
+
+  return nsArraySH::PostCreate(wrapper, cx, obj);
+}
+
+nsresult
 nsNodeListSH::GetLength(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
                         JSObject *obj, PRUint32 *length)
 {
   nsINodeList* list = static_cast<nsINodeList*>(wrapper->Native());
 #ifdef DEBUG
   {
     nsCOMPtr<nsINodeList> list_qi = do_QueryWrappedNative(wrapper);
 
@@ -7743,16 +7820,29 @@ nsNodeListSH::GetItemAt(nsISupports *aNa
     // If this assertion fires the QI implementation for the object in
     // question doesn't use the nsINodeList pointer as the nsISupports
     // pointer. That must be fixed, or we'll crash...
     NS_ASSERTION(list_qi == list, "Uh, fix QI!");
   }
 #endif
 
   return list->GetNodeAt(aIndex);
+}
+
+NS_IMETHODIMP
+nsNodeListSH::Finalize(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
+                       JSObject *obj)
+{
+  nsWrapperCache* cache = nsnull;
+  CallQueryInterface(wrapper->Native(), &cache);
+  if (cache) {
+    cache->ClearWrapper();
+  }
+
+  return NS_OK;
 }
 
 
 // StringList scriptable helper
 
 nsresult
 nsStringListSH::GetStringAt(nsISupports *aNative, PRInt32 aIndex,
                             nsAString& aResult)
@@ -7882,31 +7972,40 @@ nsresult
 nsresult
 nsContentListSH::PreCreate(nsISupports *nativeObj, JSContext *cx,
                            JSObject *globalObj, JSObject **parentObj)
 {
   nsContentList *contentList = nsContentList::FromSupports(nativeObj);
   nsISupports *native_parent = contentList->GetParentObject();
 
   if (!native_parent) {
-    *parentObj = globalObj;
-    return NS_OK;
+    return NS_ERROR_FAILURE;
   }
 
   jsval v;
   nsCOMPtr<nsIXPConnectJSObjectHolder> holder;
   nsresult rv = WrapNative(cx, globalObj, native_parent,
                            NS_GET_IID(nsISupports), &v,
                            getter_AddRefs(holder));
 
   *parentObj = JSVAL_TO_OBJECT(v);
 
   return rv;
 }
 
+NS_IMETHODIMP
+nsContentListSH::PostCreate(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
+                            JSObject *obj)
+{
+  nsContentList *list = nsContentList::FromSupports(wrapper->Native());
+  list->SetWrapper(wrapper);
+
+  return nsNamedArraySH::PostCreate(wrapper, cx, obj);
+}
+
 nsresult
 nsContentListSH::GetLength(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
                            JSObject *obj, PRUint32 *length)
 {
   nsContentList *list = nsContentList::FromSupports(wrapper->Native());
 
   return list->GetLength(length);
 }
@@ -7924,16 +8023,25 @@ nsContentListSH::GetNamedItem(nsISupport
 nsContentListSH::GetNamedItem(nsISupports *aNative, const nsAString& aName,
                               nsresult *aResult)
 {
   nsContentList *list = nsContentList::FromSupports(aNative);
 
   return list->GetNamedItem(aName, aResult);
 }
 
+NS_IMETHODIMP
+nsContentListSH::Finalize(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
+                          JSObject *obj)
+{
+  nsContentList *list = nsContentList::FromSupports(wrapper->Native());
+  list->ClearWrapper();
+
+  return NS_OK;
+}
 
 // Document helper for document.location and document.on*
 
 NS_IMETHODIMP
 nsDocumentSH::AddProperty(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
                           JSObject *obj, jsval id, jsval *vp,
                           PRBool *_retval)
 {
@@ -8148,17 +8256,17 @@ nsDocumentSH::Finalize(nsIXPConnectWrapp
 {
   nsCOMPtr<nsIDocument> doc = do_QueryWrappedNative(wrapper);
   if (!doc) {
     return NS_ERROR_UNEXPECTED;
   }
 
   doc->SetJSObject(nsnull);
 
-  return NS_OK;
+  return nsNodeSH::Finalize(wrapper, cx, obj);
 }
 
 // HTMLDocument helper
 
 // static
 nsresult
 nsHTMLDocumentSH::ResolveImpl(JSContext *cx,
                               nsIXPConnectWrappedNative *wrapper, jsval id,
diff -r a4343d61f6ee dom/src/base/nsDOMClassInfo.h
--- a/dom/src/base/nsDOMClassInfo.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/dom/src/base/nsDOMClassInfo.h	Sat Nov 15 19:43:13 2008 -0500
@@ -168,17 +168,17 @@ public:
                       "Must know what the XPCNativeWrapper class is!");
     }
 #endif
 
     return sXPCNativeWrapperClass &&
       ::JS_GET_CLASS(cx, obj) == sXPCNativeWrapperClass;
   }
 
-  static nsresult PreserveNodeWrapper(nsIXPConnectWrappedNative *aWrapper);
+  static void PreserveNodeWrapper(nsIXPConnectWrappedNative *aWrapper);
 
 protected:
   friend nsIClassInfo* NS_GetDOMClassInfoInstance(nsDOMClassInfoID aID);
 
   const nsDOMClassInfoData* mData;
 
   static nsresult Init();
   static nsresult RegisterClassName(PRInt32 aDOMClassInfoID);
@@ -396,21 +396,27 @@ protected:
   nsEventTargetSH(nsDOMClassInfoData* aData) : nsDOMGenericSH(aData)
   {
   }
 
   virtual ~nsEventTargetSH()
   {
   }
 public:
+  NS_IMETHOD PreCreate(nsISupports *nativeObj, JSContext *cx,
+                       JSObject *globalObj, JSObject **parentObj);
+  NS_IMETHOD PostCreate(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
+                        JSObject *obj);
   NS_IMETHOD NewResolve(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
                         JSObject *obj, jsval id, PRUint32 flags,
                         JSObject **objp, PRBool *_retval);
   NS_IMETHOD AddProperty(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
                          JSObject *obj, jsval id, jsval *vp, PRBool *_retval);
+  NS_IMETHOD Finalize(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
+                      JSObject *obj);
 
   static nsIClassInfo *doCreate(nsDOMClassInfoData* aData)
   {
     return new nsEventTargetSH(aData);
   }
 };
 
 // Window scriptable helper
@@ -552,26 +558,30 @@ protected:
   // we're defining on, |id| is the name of the prop.  This must be a string
   // jsval.  |objp| is the out param if we define successfully.
   nsresult DefineVoidProp(JSContext* cx, JSObject* obj, jsval id,
                           JSObject** objp);
 
 public:
   NS_IMETHOD PreCreate(nsISupports *nativeObj, JSContext *cx,
                        JSObject *globalObj, JSObject **parentObj);
+  NS_IMETHOD PostCreate(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
+                        JSObject *obj);
   NS_IMETHOD AddProperty(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
                          JSObject *obj, jsval id, jsval *vp, PRBool *_retval);
   NS_IMETHOD NewResolve(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
                         JSObject *obj, jsval id, PRUint32 flags,
                         JSObject **objp, PRBool *_retval);
   NS_IMETHOD GetProperty(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
                          JSObject *obj, jsval id, jsval *vp, PRBool *_retval);
   NS_IMETHOD SetProperty(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
                          JSObject *obj, jsval id, jsval *vp, PRBool *_retval);
   NS_IMETHOD GetFlags(PRUint32 *aFlags);
+  NS_IMETHOD Finalize(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
+                      JSObject *obj);
 
   static nsIClassInfo *doCreate(nsDOMClassInfoData* aData)
   {
     return new nsNodeSH(aData);
   }
 };
 
 
@@ -664,16 +674,23 @@ class nsNodeListSH : public nsArraySH
 class nsNodeListSH : public nsArraySH
 {
 protected:
   nsNodeListSH(nsDOMClassInfoData* aData) : nsArraySH(aData)
   {
   }
 
 public:
+  NS_IMETHOD PreCreate(nsISupports *nativeObj, JSContext *cx,
+                       JSObject *globalObj, JSObject **parentObj);
+  NS_IMETHOD PostCreate(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
+                        JSObject *obj);
+  NS_IMETHOD Finalize(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
+                      JSObject *obj);
+
   virtual nsresult GetLength(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
                              JSObject *obj, PRUint32 *length);
   virtual nsISupports* GetItemAt(nsISupports *aNative, PRUint32 aIndex,
                                  nsresult *aResult);
  
   static nsIClassInfo *doCreate(nsDOMClassInfoData* aData)
   {
     return new nsNodeListSH(aData);
@@ -775,16 +792,20 @@ protected:
 protected:
   nsContentListSH(nsDOMClassInfoData* aData) : nsNamedArraySH(aData)
   {
   }
 
 public:
   NS_IMETHOD PreCreate(nsISupports *nativeObj, JSContext *cx,
                        JSObject *globalObj, JSObject **parentObj);
+  NS_IMETHOD PostCreate(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
+                        JSObject *obj);
+  NS_IMETHOD Finalize(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
+                      JSObject *obj);
 
   virtual nsresult GetLength(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
                              JSObject *obj, PRUint32 *length);
   virtual nsISupports* GetItemAt(nsISupports *aNative, PRUint32 aIndex,
                                  nsresult *aResult);
   virtual nsISupports* GetNamedItem(nsISupports *aNative,
                                     const nsAString& aName,
                                     nsresult *aResult);
diff -r a4343d61f6ee dom/src/base/nsGlobalWindow.cpp
--- a/dom/src/base/nsGlobalWindow.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/dom/src/base/nsGlobalWindow.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -1011,23 +1011,16 @@ NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN(
 
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mOpenerScriptPrincipal)
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mListenerManager)
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mSessionStorage)
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mApplicationCache)
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mDocumentPrincipal)
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mDoc)
 
-  // Traverse any associated preserved wrappers.
-  {
-    if (tmp->mDoc) {
-      cb.NoteXPCOMChild(tmp->mDoc->GetReference(tmp));
-    }
-  }
-
   // Traverse stuff from nsPIDOMWindow
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mChromeEventHandler)
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mDocument)
 
   // Traverse mDummyJavaPluginOwner
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mDummyJavaPluginOwner)
 
 NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
@@ -1049,22 +1042,16 @@ NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(ns
     NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mInnerWindowHolders[i])
   }
 
   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mOpenerScriptPrincipal)
   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mListenerManager)
   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mSessionStorage)
   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mApplicationCache)
   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mDocumentPrincipal)
-
-  // Unlink any associated preserved wrapper.
-  if (tmp->mDoc) {
-    tmp->mDoc->RemoveReference(tmp);
-    NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mDoc)
-  }
 
   // Unlink stuff from nsPIDOMWindow
   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mChromeEventHandler)
   NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mDocument)
 
   // Unlink mDummyJavaPluginOwner
   if (tmp->mDummyJavaPluginOwner) {
     tmp->mDummyJavaPluginOwner->Destroy();
diff -r a4343d61f6ee dom/src/base/nsJSEnvironment.cpp
--- a/dom/src/base/nsJSEnvironment.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/dom/src/base/nsJSEnvironment.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -3372,17 +3372,18 @@ nsJSContext::ScriptExecuted()
   ScriptEvaluated(!::JS_IsRunning(mContext));
 
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsJSContext::PreserveWrapper(nsIXPConnectWrappedNative *aWrapper)
 {
-  return nsDOMClassInfo::PreserveNodeWrapper(aWrapper);
+  nsDOMClassInfo::PreserveNodeWrapper(aWrapper);
+  return NS_OK;
 }
 
 //static
 void
 nsJSContext::CC()
 {
   ++sCCollectCount;
 #ifdef DEBUG_smaug
diff -r a4343d61f6ee dom/src/base/nsMimeTypeArray.cpp
--- a/dom/src/base/nsMimeTypeArray.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/dom/src/base/nsMimeTypeArray.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -77,34 +77,34 @@ nsMimeTypeArray::GetLength(PRUint32* aLe
 nsMimeTypeArray::GetLength(PRUint32* aLength)
 {
   if (!mInited) {
     nsresult rv = GetMimeTypes();
     if (rv != NS_OK)
       return rv;
   }
 
-  NS_ASSERTION(mPluginMimeTypeCount <= mMimeTypeArray.Count(),
+  NS_ASSERTION(mPluginMimeTypeCount <= (PRUint32)mMimeTypeArray.Count(),
                "The number of total mimetypes should be equal to or higher "
                "than the number of plugin mimetypes.");
  
   *aLength = mPluginMimeTypeCount;
   return NS_OK;
 }
 
 nsIDOMMimeType*
 nsMimeTypeArray::GetItemAt(PRUint32 aIndex, nsresult *aResult)
 {
   if (!mInited) {
     *aResult = GetMimeTypes();
     if (*aResult != NS_OK)
       return nsnull;
   }
 
-  NS_ASSERTION(mPluginMimeTypeCount <= mMimeTypeArray.Count(),
+  NS_ASSERTION(mPluginMimeTypeCount <= (PRUint32)mMimeTypeArray.Count(),
                "The number of total mimetypes should be equal to or higher "
                "than the number of plugin mimetypes.");
 
   if (aIndex >= mPluginMimeTypeCount) {
     *aResult = NS_ERROR_FAILURE;
 
     return nsnull;
   }
@@ -128,17 +128,17 @@ nsMimeTypeArray::GetNamedItem(const nsAS
 nsMimeTypeArray::GetNamedItem(const nsAString& aName, nsresult* aResult)
 {
   if (!mInited) {
     *aResult = GetMimeTypes();
     if (*aResult != NS_OK)
       return nsnull;
   }
 
-  NS_ASSERTION(mPluginMimeTypeCount <= mMimeTypeArray.Count(),
+  NS_ASSERTION(mPluginMimeTypeCount <= (PRUint32)mMimeTypeArray.Count(),
                "The number of total mimetypes should be equal to or higher "
                "than the number of plugin mimetypes.");
 
   *aResult = NS_OK;
 
   nsAutoString type;
 
   for (PRInt32 i = 0; i < mMimeTypeArray.Count(); i++) {
diff -r a4343d61f6ee dom/src/geolocation/MaemoLocationProvider.cpp
--- a/dom/src/geolocation/MaemoLocationProvider.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/dom/src/geolocation/MaemoLocationProvider.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -33,16 +33,105 @@
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 
 
 #include "MaemoLocationProvider.h"
 #include "nsGeolocation.h"
+
+
+////////////////////////////////////////////////////
+// nsGeoPosition
+////////////////////////////////////////////////////
+
+/**
+ * Simple object that holds a single point in space.
+ */ 
+class nsGeoPosition : public nsIDOMGeoPosition
+{
+public:
+  NS_DECL_ISUPPORTS
+  NS_DECL_NSIDOMGEOPOSITION
+
+    nsGeoPosition(double aLat, double aLong, double aAlt, double aHError, double aVError, double aHeading, double aSpeed, long long aTimestamp)
+    : mLat(aLat), mLong(aLong), mAlt(aAlt), mHError(aHError), mVError(aVError), mHeading(aHeading), mSpeed(aSpeed), mTimestamp(aTimestamp){};
+
+private:
+  ~nsGeoPosition(){}
+  double mLat, mLong, mAlt, mHError, mVError, mHeading, mSpeed;
+  long long mTimestamp;
+};
+
+NS_INTERFACE_MAP_BEGIN(nsGeoPosition)
+  NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIDOMGeoPosition)
+  NS_INTERFACE_MAP_ENTRY(nsIDOMGeoPosition)
+  NS_DOM_INTERFACE_MAP_ENTRY_CLASSINFO(GeoPosition)
+NS_INTERFACE_MAP_END
+
+NS_IMPL_THREADSAFE_ADDREF(nsGeoPosition)
+NS_IMPL_THREADSAFE_RELEASE(nsGeoPosition)
+
+NS_IMETHODIMP
+nsGeoPosition::GetLatitude(double *aLatitude)
+{
+  *aLatitude = mLat;
+  return NS_OK;
+}
+
+NS_IMETHODIMP
+nsGeoPosition::GetLongitude(double *aLongitude)
+{
+  *aLongitude = mLong;
+  return NS_OK;
+}
+
+NS_IMETHODIMP
+nsGeoPosition::GetAltitude(double *aAltitude)
+{
+  *aAltitude = mAlt;
+  return NS_OK;
+}
+
+NS_IMETHODIMP
+nsGeoPosition::GetAccuracy(double *aAccuracy)
+{
+  *aAccuracy = mHError;
+  return NS_OK;
+}
+
+NS_IMETHODIMP
+nsGeoPosition::GetAltitudeAccuracy(double *aAltitudeAccuracy)
+{
+  *aAltitudeAccuracy = mVError;
+  return NS_OK;
+}
+
+NS_IMETHODIMP
+nsGeoPosition::GetHeading(double *aHeading)
+{
+  *aHeading = mHeading;
+  return NS_OK;
+}
+
+NS_IMETHODIMP
+nsGeoPosition::GetSpeed(double *aSpeed)
+{
+  *aSpeed = mSpeed;
+  return NS_OK;
+}
+
+NS_IMETHODIMP
+nsGeoPosition::GetTimestamp(DOMTimeStamp* aTimestamp)
+{
+  *aTimestamp = mTimestamp;
+  return NS_OK;
+}
+
 
 NS_IMPL_ISUPPORTS1(MaemoLocationProvider, nsIGeolocationProvider)
 
 MaemoLocationProvider::MaemoLocationProvider()
 : mGPSDevice(nsnull), mLocationCallbackHandle(0), mHasSeenLocation(PR_FALSE)
 {
 }
 
diff -r a4343d61f6ee dom/src/geolocation/nsGeolocation.cpp
--- a/dom/src/geolocation/nsGeolocation.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/dom/src/geolocation/nsGeolocation.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -53,16 +53,20 @@
 
 #ifdef NS_MAEMO_LOCATION
 #include "MaemoLocationProvider.h"
 #endif
 
 #include "nsIDOMDocument.h"
 #include "nsIDocument.h"
 
+// Some limit to the number of get or watch geolocation requests
+// that a window can make.
+#define MAX_GEO_REQUESTS_PER_WINDOW  1500
+
 ////////////////////////////////////////////////////
 // nsDOMGeoPositionError
 ////////////////////////////////////////////////////
 
 class nsDOMGeoPositionError : public nsIDOMGeoPositionError
 {
 public:
   NS_DECL_ISUPPORTS
@@ -130,29 +134,44 @@ nsDOMGeoPositionError::NotifyCallback(ns
 ////////////////////////////////////////////////////
 
 nsGeolocationRequest::nsGeolocationRequest(nsGeolocation* aLocator,
                                            nsIDOMGeoPositionCallback* aCallback,
                                            nsIDOMGeoPositionErrorCallback* aErrorCallback,
                                            nsIDOMGeoPositionOptions* aOptions)
   : mAllowed(PR_FALSE),
     mCleared(PR_FALSE),
-    mFuzzLocation(PR_FALSE),
     mHasSentData(PR_FALSE),
     mCallback(aCallback),
     mErrorCallback(aErrorCallback),
     mOptions(aOptions),
     mLocator(aLocator)
 {
 }
 
 nsGeolocationRequest::~nsGeolocationRequest()
 {
 }
 
+nsresult
+nsGeolocationRequest::Init()
+{
+  // This method is called before the user has given permission for this request.
+
+  // check to see if we have a geolocation provider, if not, notify an error and bail.
+  nsRefPtr<nsGeolocationService> geoService = nsGeolocationService::GetInstance();
+  if (!geoService->HasGeolocationProvider()) {
+    NotifyError(nsIDOMGeoPositionError::POSITION_UNAVAILABLE);
+    return NS_ERROR_FAILURE;;
+  }
+
+  return NS_OK;
+}
+
+
 NS_INTERFACE_MAP_BEGIN(nsGeolocationRequest)
   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIGeolocationRequest)
   NS_INTERFACE_MAP_ENTRY(nsIGeolocationRequest)
   NS_INTERFACE_MAP_ENTRY(nsITimerCallback)
 NS_INTERFACE_MAP_END
 
 NS_IMPL_ADDREF(nsGeolocationRequest)
 NS_IMPL_RELEASE(nsGeolocationRequest)
@@ -172,17 +191,17 @@ NS_IMETHODIMP
 NS_IMETHODIMP
 nsGeolocationRequest::Notify(nsITimer* aTimer)
 {
   // If we haven't gotten an answer from the geolocation
   // provider yet, cancel the request.  Same logic as
   // ::Cancel, just a different error
   
   if (!mHasSentData) {
-    NotifyError(NS_GEO_ERROR_CODE_TIMEOUT);
+    NotifyError(nsIDOMGeoPositionError::TIMEOUT);
     // remove ourselves from the locator's callback lists.
     mLocator->RemoveRequest(this);
   }
 
   mTimeoutTimer = nsnull;
   return NS_OK;
 }
  
@@ -202,114 +221,70 @@ nsGeolocationRequest::GetRequestingWindo
   *aRequestingWindow = mLocator->GetOwner();
   NS_IF_ADDREF(*aRequestingWindow);
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsGeolocationRequest::Cancel()
 {
-  NotifyError(NS_GEO_ERROR_CODE_PERMISSION_ERROR);
+  NotifyError(nsIDOMGeoPositionError::PERMISSION_DENIED);
 
   // remove ourselves from the locators callback lists.
   mLocator->RemoveRequest(this);
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsGeolocationRequest::Allow()
 {
   // Kick off the geo device, if it isn't already running
   nsRefPtr<nsGeolocationService> geoService = nsGeolocationService::GetInstance();
   nsresult rv = geoService->StartDevice();
   
   if (NS_FAILED(rv)) {
     // Location provider error
-    NotifyError(NS_GEO_ERROR_CODE_LOCATION_PROVIDER_ERROR);
+    NotifyError(nsIDOMGeoPositionError::POSITION_UNAVAILABLE);
     return NS_OK;
   }
 
   PRUint32 timeout;
   if (mOptions && NS_SUCCEEDED(mOptions->GetTimeout(&timeout)) && timeout > 0) {
       mTimeoutTimer = do_CreateInstance("@mozilla.org/timer;1");
       mTimeoutTimer->InitWithCallback(this, timeout, nsITimer::TYPE_ONE_SHOT);
   }
 
   mAllowed = PR_TRUE;
   return NS_OK;
-}
-
-NS_IMETHODIMP
-nsGeolocationRequest::AllowButFuzz()
-{
-  mFuzzLocation = PR_TRUE;
-  return Allow();
 }
 
 void
 nsGeolocationRequest::MarkCleared()
 {
   mCleared = PR_TRUE;
 }
 
 void
 nsGeolocationRequest::SendLocation(nsIDOMGeoPosition* aPosition)
 {
   if (mCleared || !mAllowed)
     return;
 
+  // we should not pass null back to the DOM.
+  if (!aPosition) {
+    NotifyError(nsIDOMGeoPositionError::POSITION_UNAVAILABLE);
+    return;
+  }
+
   // Ensure that the proper context is on the stack (bug 452762)
   nsCOMPtr<nsIJSContextStack> stack(do_GetService("@mozilla.org/js/xpc/ContextStack;1"));
   if (!stack || NS_FAILED(stack->Push(nsnull)))
     return; // silently fail
   
-  //TODO mFuzzLocation.  Needs to be defined what we do here.
-  if (mFuzzLocation)
-  {
-    // need to make a copy because nsIDOMGeoPosition is
-    // readonly, and we are not sure of its implementation.
-
-    double lat, lon, alt, herror, verror, heading, speed;
-    DOMTimeStamp time;
-    aPosition->GetLatitude(&lat);
-    aPosition->GetLongitude(&lon);
-    aPosition->GetAltitude(&alt);
-    aPosition->GetAccuracy(&herror);
-    aPosition->GetAltitudeAccuracy(&verror);
-    aPosition->GetHeading(&heading);
-    aPosition->GetSpeed(&speed);
-    aPosition->GetTimestamp(&time); 
-
-    // Truncate ?
-    // lat = floor(lat*10+.5)/10;
-    // lon = floor(lon*10+.5)/10;
-    // herror = 1600; /* about 1 mile */
-
-    lat = 0;
-    lon = 0;
-    herror = 0;
-    heading = 0; 
-    speed = 0;
-    alt = 0;
-    verror = 0;
-
-    nsRefPtr<nsGeoPosition> somewhere = new nsGeoPosition(lat,
-                                                          lon,
-                                                          alt,
-                                                          herror,
-                                                          verror,
-                                                          heading,
-                                                          speed,
-                                                          time);
-    mCallback->HandleEvent(somewhere);
-  }
-  else
-  {
-    mCallback->HandleEvent(aPosition);
-  }
+  mCallback->HandleEvent(aPosition);
 
   // remove the stack
   JSContext* cx;
   stack->Pop(&cx);
 
   mHasSentData = PR_TRUE;
 }
 
@@ -317,103 +292,45 @@ nsGeolocationRequest::Shutdown()
 nsGeolocationRequest::Shutdown()
 {
   mCleared = PR_TRUE;
   mCallback = nsnull;
   mErrorCallback = nsnull;
 }
 
 ////////////////////////////////////////////////////
-// nsGeoPosition
-////////////////////////////////////////////////////
-NS_INTERFACE_MAP_BEGIN(nsGeoPosition)
-  NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIDOMGeoPosition)
-  NS_INTERFACE_MAP_ENTRY(nsIDOMGeoPosition)
-  NS_DOM_INTERFACE_MAP_ENTRY_CLASSINFO(GeoPosition)
-NS_INTERFACE_MAP_END
-
-NS_IMPL_THREADSAFE_ADDREF(nsGeoPosition)
-NS_IMPL_THREADSAFE_RELEASE(nsGeoPosition)
-
-NS_IMETHODIMP
-nsGeoPosition::GetLatitude(double *aLatitude)
-{
-  *aLatitude = mLat;
-  return NS_OK;
-}
-
-NS_IMETHODIMP
-nsGeoPosition::GetLongitude(double *aLongitude)
-{
-  *aLongitude = mLong;
-  return NS_OK;
-}
-
-NS_IMETHODIMP
-nsGeoPosition::GetAltitude(double *aAltitude)
-{
-  *aAltitude = mAlt;
-  return NS_OK;
-}
-
-NS_IMETHODIMP
-nsGeoPosition::GetAccuracy(double *aAccuracy)
-{
-  *aAccuracy = mHError;
-  return NS_OK;
-}
-
-NS_IMETHODIMP
-nsGeoPosition::GetAltitudeAccuracy(double *aAltitudeAccuracy)
-{
-  *aAltitudeAccuracy = mVError;
-  return NS_OK;
-}
-
-NS_IMETHODIMP
-nsGeoPosition::GetHeading(double *aHeading)
-{
-  *aHeading = mHeading;
-  return NS_OK;
-}
-
-NS_IMETHODIMP
-nsGeoPosition::GetSpeed(double *aSpeed)
-{
-  *aSpeed = mSpeed;
-  return NS_OK;
-}
-
-NS_IMETHODIMP
-nsGeoPosition::GetTimestamp(DOMTimeStamp* aTimestamp)
-{
-  *aTimestamp = mTimestamp;
-  return NS_OK;
-}
-
-////////////////////////////////////////////////////
 // nsGeolocationService
 ////////////////////////////////////////////////////
 NS_INTERFACE_MAP_BEGIN(nsGeolocationService)
   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIGeolocationUpdate)
   NS_INTERFACE_MAP_ENTRY(nsIGeolocationUpdate)
   NS_INTERFACE_MAP_ENTRY(nsIObserver)
 NS_INTERFACE_MAP_END
 
 NS_IMPL_THREADSAFE_ADDREF(nsGeolocationService)
 NS_IMPL_THREADSAFE_RELEASE(nsGeolocationService)
 
 nsGeolocationService::nsGeolocationService()
+ : mProviderStarted(PR_FALSE)
 {
   nsCOMPtr<nsIObserverService> obs = do_GetService("@mozilla.org/observer-service;1");
   if (obs) {
     obs->AddObserver(this, "quit-application", false);
   }
 
   mTimeout = nsContentUtils::GetIntPref("geo.timeout", 6000);
+
+  mProvider = do_GetService(NS_GEOLOCATION_PROVIDER_CONTRACTID);
+  
+  // if NS_MAEMO_LOCATION, see if we should try the MAEMO location provider
+#ifdef NS_MAEMO_LOCATION
+  if (!mProvider)
+    mProvider = new MaemoLocationProvider();
+#endif
+
 }
 
 nsGeolocationService::~nsGeolocationService()
 {
 }
 
 NS_IMETHODIMP
 nsGeolocationService::Observe(nsISupports* aSubject,
@@ -457,68 +374,46 @@ NS_IMETHODIMP
 NS_IMETHODIMP
 nsGeolocationService::Update(nsIDOMGeoPosition *aSomewhere)
 {
   for (PRUint32 i = 0; i< mGeolocators.Length(); i++)
     mGeolocators[i]->Update(aSomewhere);
   return NS_OK;
 }
 
-already_AddRefed<nsIDOMGeoPosition>
-nsGeolocationService::GetLastKnownPosition()
+PRBool
+nsGeolocationService::HasGeolocationProvider()
 {
-  nsIDOMGeoPosition* p = nsnull;
-  if (mProvider)
-    mProvider->GetCurrentPosition(&p);
-
-  return p;
-}
-
-PRBool
-nsGeolocationService::IsDeviceReady()
-{
-  PRBool ready = PR_FALSE;
-  if (mProvider)
-    mProvider->IsReady(&ready);
-
-  return ready;
+  return (mProvider != nsnull);
 }
 
 nsresult
 nsGeolocationService::StartDevice()
 {
   if (!mProvider)
-  {
-    // Check to see if there is an override in place. if so, use it.
-    mProvider = do_GetService(NS_GEOLOCATION_PROVIDER_CONTRACTID);
+    return NS_ERROR_NOT_AVAILABLE;
+  
+  if (!mProviderStarted) {
 
-    // if NS_MAEMO_LOCATION, see if we should try the MAEMO location provider
-#ifdef NS_MAEMO_LOCATION
-    if (!mProvider)
-    {
-      // guess not, lets try a default one:  
-      mProvider = new MaemoLocationProvider();
-    }
-#endif
-
-    if (!mProvider)
-      return NS_ERROR_NOT_AVAILABLE;
-    
     // if we have one, start it up.
     nsresult rv = mProvider->Startup();
     if (NS_FAILED(rv)) 
       return NS_ERROR_NOT_AVAILABLE;
- 
+  
     // lets monitor it for any changes.
     mProvider->Watch(this);
-    
+
+    // remember that we are started up
+    mProviderStarted = PR_TRUE;
+
     // we do not want to keep the geolocation devices online
     // indefinitely.  Close them down after a reasonable period of
     // inactivivity
     SetDisconnectTimer();
+
   }
 
   return NS_OK;
 }
 
 void
 nsGeolocationService::SetDisconnectTimer()
 {
@@ -532,17 +427,17 @@ nsGeolocationService::SetDisconnectTimer
                          nsITimer::TYPE_ONE_SHOT);
 }
 
 void 
 nsGeolocationService::StopDevice()
 {
   if (mProvider) {
     mProvider->Shutdown();
-    mProvider = nsnull;
+    mProviderStarted = PR_FALSE;
   }
 
   if(mDisconnectTimer) {
     mDisconnectTimer->Cancel();
     mDisconnectTimer = nsnull;
   }
 }
 
@@ -695,57 +590,72 @@ nsGeolocation::GetLastPosition(nsIDOMGeo
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsGeolocation::GetCurrentPosition(nsIDOMGeoPositionCallback *callback,
                                   nsIDOMGeoPositionErrorCallback *errorCallback,
                                   nsIDOMGeoPositionOptions *options)
 {
-
   nsCOMPtr<nsIGeolocationPrompt> prompt = do_GetService(NS_GEOLOCATION_PROMPT_CONTRACTID);
   if (prompt == nsnull)
+    return NS_ERROR_NOT_AVAILABLE;
+
+  if (mPendingCallbacks.Length() > MAX_GEO_REQUESTS_PER_WINDOW)
     return NS_ERROR_NOT_AVAILABLE;
 
   nsRefPtr<nsGeolocationRequest> request = new nsGeolocationRequest(this, callback, errorCallback, options);
   if (!request)
     return NS_ERROR_OUT_OF_MEMORY;
+
+  if (NS_FAILED(request->Init()))
+    return NS_OK;
 
   prompt->Prompt(request);
 
   // What if you have a location provider that only sends a location once, then stops.?  fix.
   mPendingCallbacks.AppendElement(request);
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsGeolocation::WatchPosition(nsIDOMGeoPositionCallback *aCallback,
                              nsIDOMGeoPositionErrorCallback *aErrorCallback,
                              nsIDOMGeoPositionOptions *aOptions, 
-                             PRUint16 *_retval NS_OUTPARAM)
+                             PRInt32 *_retval NS_OUTPARAM)
 {
   nsCOMPtr<nsIGeolocationPrompt> prompt = do_GetService(NS_GEOLOCATION_PROMPT_CONTRACTID);
   if (prompt == nsnull)
     return NS_ERROR_NOT_AVAILABLE;
-    
+
+  if (mWatchingCallbacks.Length() > MAX_GEO_REQUESTS_PER_WINDOW)
+    return NS_ERROR_NOT_AVAILABLE;
+
   nsRefPtr<nsGeolocationRequest> request = new nsGeolocationRequest(this, aCallback, aErrorCallback, aOptions);
   if (!request)
     return NS_ERROR_OUT_OF_MEMORY;
+
+  if (NS_FAILED(request->Init()))
+    return NS_OK;
 
   prompt->Prompt(request);
 
   // need to hand back an index/reference.
   mWatchingCallbacks.AppendElement(request);
   *_retval = mWatchingCallbacks.Length() - 1;
   return NS_OK;
 }
 
 NS_IMETHODIMP
-nsGeolocation::ClearWatch(PRUint16 aWatchId)
+nsGeolocation::ClearWatch(PRInt32 aWatchId)
 {
+  PRUint32 count = mWatchingCallbacks.Length();
+  if (aWatchId < 0 || count == 0 || aWatchId > count)
+    return NS_ERROR_FAILURE;
+
   mWatchingCallbacks[aWatchId]->MarkCleared();
   return NS_OK;
 }
 
 PRBool
 nsGeolocation::OwnerStillExists()
 {
   if (!mOwner)
diff -r a4343d61f6ee dom/src/geolocation/nsGeolocation.h
--- a/dom/src/geolocation/nsGeolocation.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/dom/src/geolocation/nsGeolocation.h	Sat Nov 15 19:43:13 2008 -0500
@@ -50,76 +50,52 @@
 #include "nsIDOMGeoPositionErrorCallback.h"
 #include "nsIDOMGeoPositionOptions.h"
 #include "nsIDOMNavigatorGeolocation.h"
 
 #include "nsPIDOMWindow.h"
 
 #include "nsIGeolocationProvider.h"
 
-#define NS_GEO_ERROR_CODE_PERMISSION_ERROR        1
-#define NS_GEO_ERROR_CODE_LOCATION_PROVIDER_ERROR 2
-#define NS_GEO_ERROR_CODE_POSITION_NOT_FOUND      3
-#define NS_GEO_ERROR_CODE_TIMEOUT                 4
-
 class nsGeolocationService;
 class nsGeolocation;
 
 class nsGeolocationRequest : public nsIGeolocationRequest, public nsITimerCallback
 {
  public:
   NS_DECL_ISUPPORTS
   NS_DECL_NSIGEOLOCATIONREQUEST
   NS_DECL_NSITIMERCALLBACK
  
   nsGeolocationRequest(nsGeolocation* locator,
                        nsIDOMGeoPositionCallback* callback,
                        nsIDOMGeoPositionErrorCallback* errorCallback,
                        nsIDOMGeoPositionOptions* options);
+  nsresult Init();
   void Shutdown();
 
   void SendLocation(nsIDOMGeoPosition* location);
   void MarkCleared();
   PRBool Allowed() {return mAllowed;}
 
   ~nsGeolocationRequest();
 
  private:
 
   void NotifyError(PRInt16 errorCode);
   PRPackedBool mAllowed;
   PRPackedBool mCleared;
-  PRPackedBool mFuzzLocation;
   PRPackedBool mHasSentData;
 
   nsCOMPtr<nsITimer> mTimeoutTimer;
   nsCOMPtr<nsIDOMGeoPositionCallback> mCallback;
   nsCOMPtr<nsIDOMGeoPositionErrorCallback> mErrorCallback;
   nsCOMPtr<nsIDOMGeoPositionOptions> mOptions;
 
   nsGeolocation* mLocator; // The locator exists longer than this object.
-
-};
-
-/**
- * Simple object that holds a single point in space.
- */ 
-class nsGeoPosition : public nsIDOMGeoPosition
-{
-public:
-  NS_DECL_ISUPPORTS
-  NS_DECL_NSIDOMGEOPOSITION
-
-    nsGeoPosition(double aLat, double aLong, double aAlt, double aHError, double aVError, double aHeading, double aSpeed, long long aTimestamp)
-    : mLat(aLat), mLong(aLong), mAlt(aAlt), mHError(aHError), mVError(aVError), mHeading(aHeading), mSpeed(aSpeed), mTimestamp(aTimestamp){};
-
-private:
-  ~nsGeoPosition(){}
-  double mLat, mLong, mAlt, mHError, mVError, mHeading, mSpeed;
-  long long mTimestamp;
 };
 
 /**
  * Singleton that manages the geolocation provider
  */
 class nsGeolocationService : public nsIGeolocationUpdate, public nsIObserver
 {
 public:
@@ -133,22 +109,18 @@ public:
   NS_DECL_NSIOBSERVER
 
   nsGeolocationService();
 
   // Management of the nsGeolocation objects
   void AddLocator(nsGeolocation* locator);
   void RemoveLocator(nsGeolocation* locator);
 
-  // Returns the last geolocation we have seen since calling StartDevice()
-  already_AddRefed<nsIDOMGeoPosition> GetLastKnownPosition();
-  
-  // Returns true if the we have successfully found and started a
-  // geolocation device
-  PRBool   IsDeviceReady();
+  // Returns true if there is a geolocation provider registered.
+  PRBool   HasGeolocationProvider();
 
   // Find and startup a geolocation device (gps, nmea, etc.)
   nsresult StartDevice();
 
   // Stop the started geolocation device (gps, nmea, etc.)
   void     StopDevice();
   
   // create, or reinitalize the callback timer
@@ -163,16 +135,19 @@ private:
   // case, we disable the disconnect timer.
   nsCOMPtr<nsITimer> mDisconnectTimer;
 
   // Time, in milliseconds, to wait for the location provider to spin up.
   PRInt32 mTimeout;
 
   // The object providing geo location information to us.
   nsCOMPtr<nsIGeolocationProvider> mProvider;
+
+  // A flag that lets us know if the mProvider has been started up.
+  PRBool mProviderStarted;
 
   // mGeolocators are not owned here.  Their constructor
   // addes them to this list, and their destructor removes
   // them from this list.
   nsTArray<nsGeolocation*> mGeolocators;
 };
 
 
diff -r a4343d61f6ee dom/src/json/test/unit/test_wrappers.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/dom/src/json/test/unit/test_wrappers.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,205 @@
+
+// returns a list of [string, object] pairs to test encoding
+function getTestPairs() {
+  var testPairs = [
+    ["{}", {}],
+    ["[]", []],
+    ['{"foo":"bar"}', {"foo":"bar"}],
+    ['{"null":null}', {"null":null}],
+    ['{"five":5}', {"five":5}],
+    ['{"five":5,"six":6}', {"five":5, "six":6}],
+    ['{"x":{"y":"z"}}', {"x":{"y":"z"}}],
+    ['{"w":{"x":{"y":"z"}}}', {"w":{"x":{"y":"z"}}}],
+    ['[1,2,3]', [1,2,3]],
+    ['{"w":{"x":{"y":[1,2,3]}}}', {"w":{"x":{"y":[1,2,3]}}}],
+    ['{"false":false}', {"false":false}],
+    ['{"true":true}', {"true":true}],
+    ['{"child has two members":{"this":"one","2":"and this one"}}',
+     {"child has two members": {"this":"one", 2:"and this one"}}],
+    ['{"x":{"a":"b","c":{"y":"z"},"f":"g"}}',
+     {"x":{"a":"b","c":{"y":"z"},"f":"g"}}],
+    ['{"x":[1,{"y":"z"},3]}', {"x":[1,{"y":"z"},3]}],
+    ['["hmm"]', [new String("hmm")]],
+    ['[true]', [new Boolean(true)]],
+    ['[42]', [new Number(42)]],
+    ['["1978-09-13T12:24:34.023Z"]', [new Date(Date.UTC(1978, 8, 13, 12, 24, 34, 23))]],
+    ['[1,null,3]',[1,,3]],
+    ['{"mm\\\"mm":"hmm"}',{"mm\"mm":"hmm"}],
+    ['{"mm\\\"mm\\\"mm":"hmm"}',{"mm\"mm\"mm":"hmm"}],
+    ['{"\\\"":"hmm"}',{'"':"hmm"}],
+    ['{"\\\\":"hmm"}',{'\\':"hmm"}],
+    ['{"mmm\\\\mmm":"hmm"}',{'mmm\\mmm':"hmm"}],
+    ['{"mmm\\\\mmm\\\\mmm":"hmm"}',{'mmm\\mmm\\mmm':"hmm"}],
+    ['{"mm\\u000bmm":"hmm"}',{"mm\u000bmm":"hmm"}],
+    ['{"mm\\u0000mm":"hmm"}',{"mm\u0000mm":"hmm"}]
+  ];
+
+  var x = {"free":"variable"}
+  testPairs.push(['{"free":"variable"}', x]);
+  testPairs.push(['{"y":{"free":"variable"}}', {"y":x}]);
+
+  // array prop
+  var x = {
+    a: [1,2,3]
+  }
+  testPairs.push(['{"a":[1,2,3]}', x])
+
+  var y = {
+    foo: function(hmm) { return hmm; }
+  }
+  testPairs.push(['{"y":{}}',{"y":y}]);
+
+  // test toJSON
+  var hmm = {
+    toJSON: function() { return {"foo":"bar"}}
+  }
+  testPairs.push(['{"hmm":{"foo":"bar"}}', {"hmm":hmm}]);
+  testPairs.push(['{"foo":"bar"}', hmm]); // on the root
+
+  // toJSON on prototype
+  var Y = function() {
+    this.d = "e";
+  }
+  Y.prototype = {
+    not:"there?",
+    toJSON: function() { return {"foo":"bar"}}
+  };
+  var y = new Y();
+  testPairs.push(['{"foo":"bar"}', y.toJSON()]);
+  testPairs.push(['{"foo":"bar"}', y]);
+
+  // return undefined from toJSON
+  var hmm = {
+    toJSON: function() { return; }
+  }
+  testPairs.push(['{}', {"hmm":hmm}]);
+
+  // array with named prop
+  var x= new Array();
+  x[0] = 1;
+  x.foo = "bar";
+  testPairs.push(['[1]', x]);
+
+  // prototype
+  var X = function() { this.a = "b" }
+  X.prototype = {c:"d"}
+  var y = new X();
+  testPairs.push(['{"a":"b","c":"d"}', y]);
+
+  // custom iterator: JS 1.7+
+  var x = {
+   "a": "foo",
+   b: "not included",
+   c: "bar",
+   "4": "qux",
+   __iterator__: function() { return (function() { yield "a"; yield "c"; yield 4; })() }
+  }
+  do_check_eq('{"a":"foo","c":"bar","4":"qux"}', JSON.stringify(x));
+
+  return testPairs;
+}
+
+function testStringEncode() {
+  var pairs = getTestPairs();
+  for each(pair in pairs) {
+    print(pair)
+    var nativeResult = JSON.stringify(pair[1]);
+    var crockfordResult = crockfordJSON.stringify(pair[1]);
+    do_check_eq(pair[0], nativeResult);
+    
+    // Don't follow json2.js handling of non-objects
+    if (pair[1] && (typeof pair[1] == "object")) {
+      do_check_eq(crockfordResult, nativeResult);
+    }
+  }
+}
+
+function decode_strings() {
+  // empty object
+  var x = JSON.parse("{}");
+  do_check_eq(typeof x, "object");
+
+  // empty array
+  x = JSON.parse("[]");
+  do_check_eq(typeof x, "object");
+  do_check_eq(x.length, 0);
+  do_check_eq(x.constructor, Array);
+
+  // one element array
+  x = JSON.parse("[[]]");
+  do_check_eq(typeof x, "object");
+  do_check_eq(x.length, 1);
+  do_check_eq(x.constructor, Array);
+  do_check_eq(x[0].constructor, Array);
+
+  // multiple arrays
+  x = JSON.parse("[[],[],[]]");
+  do_check_eq(typeof x, "object");
+  do_check_eq(x.length, 3);
+  do_check_eq(x.constructor, Array);
+  do_check_eq(x[0].constructor, Array);
+  do_check_eq(x[1].constructor, Array);
+  do_check_eq(x[2].constructor, Array);
+
+  // array key/value
+  x = JSON.parse('{"foo":[]}');
+  do_check_eq(typeof x, "object");
+  do_check_eq(typeof x.foo, "object");
+  do_check_eq(x.foo.constructor, Array);
+  x = JSON.parse('{"foo":[], "bar":[]}');
+  do_check_eq(typeof x, "object");
+  do_check_eq(typeof x.foo, "object");
+  do_check_eq(x.foo.constructor, Array);
+  do_check_eq(typeof x.bar, "object");
+  do_check_eq(x.bar.constructor, Array);
+
+  // nesting
+  x = JSON.parse('{"foo":[{}]}');
+  do_check_eq(x.foo.constructor, Array);
+  do_check_eq(x.foo.length, 1);
+  do_check_eq(typeof x.foo[0], "object");
+  x = JSON.parse('{"foo":[{"foo":[{"foo":{}}]}]}');
+  do_check_eq(x.foo[0].foo[0].foo.constructor, Object);
+  x = JSON.parse('{"foo":[{"foo":[{"foo":[]}]}]}');
+  do_check_eq(x.foo[0].foo[0].foo.constructor, Array);
+
+  // strings
+  x = JSON.parse('{"foo":"bar"}');
+  do_check_eq(x.foo, "bar");
+  x = JSON.parse('["foo", "bar", "baz"]');
+  do_check_eq(x[0], "foo");
+  do_check_eq(x[1], "bar");
+  do_check_eq(x[2], "baz");
+
+  // numbers
+  x = JSON.parse('{"foo":5.5, "bar":5}');
+  do_check_eq(x.foo, 5.5);
+  do_check_eq(x.bar, 5);
+  
+  // keywords
+  x = JSON.parse('{"foo": true, "bar":false, "baz":null}');
+  do_check_eq(x.foo, true);
+  do_check_eq(x.bar, false);
+  do_check_eq(x.baz, null);
+  
+  // short escapes
+  x = JSON.parse('{"foo": "\\"", "bar":"\\\\", "baz":"\\b","qux":"\\f", "quux":"\\n", "quuux":"\\r","quuuux":"\\t"}');
+  do_check_eq(x.foo, '"');
+  do_check_eq(x.bar, '\\');
+  do_check_eq(x.baz, '\b');
+  do_check_eq(x.qux, '\f');
+  do_check_eq(x.quux, "\n");
+  do_check_eq(x.quuux, "\r");
+  do_check_eq(x.quuuux, "\t");
+
+  // unicode escape
+  x = JSON.parse('{"foo":"hmm\\u006dmm"}');
+  do_check_eq("hmm\u006dmm", x.foo);
+
+  x = JSON.parse('{"JSON Test Pattern pass3": {"The outermost value": "must be an object or array.","In this test": "It is an object." }}');
+}
+
+function run_test() {
+  testStringEncode();
+  decode_strings();
+}
diff -r a4343d61f6ee dom/tests/mochitest/ajax/offline/test_obsolete.html
--- a/dom/tests/mochitest/ajax/offline/test_obsolete.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/dom/tests/mochitest/ajax/offline/test_obsolete.html	Sat Nov 15 19:43:13 2008 -0500
@@ -35,16 +35,19 @@ req.onreadystatechange = function() {
   if (req.readyState == 4) {
     // now this will properly load the manifest.
     gTestWin = window.open("obsolete.html");
   }
 }
 
 function finish()
 {
+  netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
+  pm.remove(uri.asciiHost, "offline-app");
+
   gTestWin.close();
   SimpleTest.finish();
 }
 
 SimpleTest.waitForExplicitFinish();
 
 </script>
 
diff -r a4343d61f6ee dom/tests/mochitest/geolocation/Makefile.in
--- a/dom/tests/mochitest/geolocation/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/dom/tests/mochitest/geolocation/Makefile.in	Sat Nov 15 19:43:13 2008 -0500
@@ -47,16 +47,17 @@ _TEST_FILES	= \
 _TEST_FILES	= \
 		test_lastPosition.html \
 		test_manyWindows.html \
 		test_allowCurrent.html \
 		test_allowWatch.html \
 		test_cancelCurrent.html \
 		test_cancelWatch.html \
 		test_clearWatch.html \
+		test_clearWatch_invalid.html \
 		test_geoPrompt.html \
 		test_timeoutWatch.html \
 		prompt_common.js       \
 		geolocation_common.js  \
 		geolocation.html \
 		test_optional_api_params.html \
 		$(NULL)
 
diff -r a4343d61f6ee dom/tests/mochitest/geolocation/test_allowWatch.html
--- a/dom/tests/mochitest/geolocation/test_allowWatch.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/dom/tests/mochitest/geolocation/test_allowWatch.html	Sat Nov 15 19:43:13 2008 -0500
@@ -20,29 +20,37 @@ https://bugzilla.mozilla.org/show_bug.cg
 </div>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 
 var numCallbacks = 5;
 var callbackCounter = new Array(numCallbacks);
 var watchID = new Array(numCallbacks);
 
+function failureCallback(error)
+{
+  ok(error.code == 2, "Failure was something other than position unavailable");
+  removePrompt();
+  SimpleTest.finish();
+}
+
+
 // define success callbacks
 for(var i = 0; i < numCallbacks; i++) {
   eval("function successCallback" + i + "(position) {" +
           "callbackCounter[" + i + "]++;" +
           "success_callback(position);" +
        "}"
   );
 }
 
 function registerWatches() {
   for(var i = 0; i < numCallbacks; i++) {
     watchID[i] = eval("navigator.geolocation.watchPosition(successCallback"
-                       + i + ", null, null);"
+                       + i + ", failureCallback, null);"
     );
   }
 }
 
 function clearWatches() {
   for(var i = 0; i < numCallbacks; i++)
     navigator.geolocation.clearWatch(watchID[i]);
 }
diff -r a4343d61f6ee dom/tests/mochitest/geolocation/test_cancelCurrent.html
--- a/dom/tests/mochitest/geolocation/test_cancelCurrent.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/dom/tests/mochitest/geolocation/test_cancelCurrent.html	Sat Nov 15 19:43:13 2008 -0500
@@ -18,16 +18,23 @@ https://bugzilla.mozilla.org/show_bug.cg
 <div id="content" style="display: none">
   
 </div>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 
 var numCallbacks = 5;
 var callbackCounter = new Array(numCallbacks);
+
+function failureCallback(error)
+{
+  ok(error.code == 2, "Failure was something other than position unavailable");
+  removePrompt();
+  SimpleTest.finish();
+}
 
 // define success callbacks
 for(var i = 0; i < numCallbacks; i++) {
   eval("function successCallback" + i + "(position) {" +
           "callbackCounter[" + i + "]++;" +
           "success_callback(position);" +
        "}"
   );
@@ -45,17 +52,17 @@ attachPrompt();
 attachPrompt();
 
 ok(navigator.geolocation, "Ensure that the geolocation object is present");
 
 promptOption = DECLINE;
 
 // one-shot position requests
 for(var i = 0; i < numCallbacks; i++) {
-  eval("navigator.geolocation.getCurrentPosition(successCallback" + i + ", null, null);");
+  eval("navigator.geolocation.getCurrentPosition(successCallback" + i + ", failureCallback, null);");
 }
 
 // wait for position change
 setTimeout(testDeclined, timeout);
 
 </script>
 </pre>
 </body>
diff -r a4343d61f6ee dom/tests/mochitest/geolocation/test_cancelWatch.html
--- a/dom/tests/mochitest/geolocation/test_cancelWatch.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/dom/tests/mochitest/geolocation/test_cancelWatch.html	Sat Nov 15 19:43:13 2008 -0500
@@ -20,29 +20,36 @@ https://bugzilla.mozilla.org/show_bug.cg
 </div>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 
 var numCallbacks = 5;
 var callbackCounter = new Array(numCallbacks);
 var watchID = new Array(numCallbacks);
 
+function failureCallback(error)
+{
+  ok(error.code == 2, "Failure was something other than position unavailable");
+  removePrompt();
+  SimpleTest.finish();
+}
+
 // define success callbacks
 for(var i = 0; i < numCallbacks; i++) {
   eval("function successCallback" + i + "(position) {" +
           "callbackCounter[" + i + "]++;" +
           "success_callback(position);" +
        "}"
   );
 }
 
 function registerWatches() {
   for(var i = 0; i < numCallbacks; i++) {
     watchID[i] = eval("navigator.geolocation.watchPosition(successCallback"
-                       + i + ", null, null);"
+                       + i + ", failureCallback, null);"
     );
   }
 }
 
 function clearWatches() {
   for(var i = 0; i < numCallbacks; i++)
     navigator.geolocation.clearWatch(watchID[i]);
 }
diff -r a4343d61f6ee dom/tests/mochitest/geolocation/test_clearWatch.html
--- a/dom/tests/mochitest/geolocation/test_clearWatch.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/dom/tests/mochitest/geolocation/test_clearWatch.html	Sat Nov 15 19:43:13 2008 -0500
@@ -20,29 +20,36 @@ https://bugzilla.mozilla.org/show_bug.cg
 </div>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 
 var numCallbacks = 5;
 var callbackCounter = new Array(numCallbacks);
 var watchID = new Array(numCallbacks);
 
+function failureCallback(error)
+{
+  ok(error.code == 2, "Failure was something other than position unavailable");
+  removePrompt();
+  SimpleTest.finish();
+}
+
 // define success callbacks
 for(var i = 0; i < numCallbacks; i++) {
   eval("function successCallback" + i + "(position) {" +
           "callbackCounter[" + i + "]++;" +
           "success_callback(position);" +
        "}"
   );
 }
 
 function registerWatches() {
   for(var i = 0; i < numCallbacks; i++) {
     watchID[i] = eval("navigator.geolocation.watchPosition(successCallback"
-                       + i + ", null, null);"
+                       + i + ", failureCallback, null);"
     );
   }
 }
 
 function clearWatches() {
   for(var i = 0; i < numCallbacks; i++)
     navigator.geolocation.clearWatch(watchID[i]);
 }
diff -r a4343d61f6ee dom/tests/mochitest/geolocation/test_clearWatch_invalid.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/dom/tests/mochitest/geolocation/test_clearWatch_invalid.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,52 @@
+ <!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=463039
+-->
+<head>
+  <title>Test for Bug 463039</title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="text/javascript" src="prompt_common.js"></script>
+  <script type="text/javascript" src="geolocation_common.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=463039">Mozilla Bug 463039</a>
+<p id="display"></p>
+<div id="content" style="display: none">
+  
+</div>
+<pre id="test">
+<script class="testbody" type="text/javascript">
+
+/** Test for Bug 463039 **/
+
+ok(navigator.geolocation, "Should have geolocation");
+
+
+// there are no watches, so this should always throw
+for (x=-10; x<10; x++) {
+    try {
+        navigator.geolocation.clearWatch(x);
+        ok(0, "clearWatch should throw");
+    } catch (ex) {
+        ok(1, "clearWatch with a bad value did throw");
+    }
+}
+
+// lets try something huge
+try {
+    navigator.geolocation.clearWatch(Number.MAX_VALUE);
+    ok(0, "clearWatch should throw");
+} catch (ex) {
+    ok(1, "clearWatch with a bad value did throw");
+}
+
+
+    
+</script>
+</pre>
+</body>
+</html>
+
diff -r a4343d61f6ee gfx/cairo/README
--- a/gfx/cairo/README	Thu Nov 06 18:33:22 2008 +0100
+++ b/gfx/cairo/README	Sat Nov 15 19:43:13 2008 -0500
@@ -25,15 +25,19 @@ nonfatal-assertions.patch: Make assertio
 nonfatal-assertions.patch: Make assertions non-fatal
 
 buggy-repeat.patch: Unconditionally turn on buggy-repeat handling to bandaid bug 413583.
 
 tmpfile_wince.patch: Make Windows CE use tmpfile() on windows mobile due to the lack of _open_osfhandle and no fs permissions.
 
 cairo-version-fixes.patch: fix up cairo-version.c/cairo-version.h for in-place builds
 
+win32-ddb-dib.patch: fix for bug 455513; not upstream yet pending feebdack
+
+qpainter-type.patch: add SURFACE_TYPE_QPAINTER to cairo.h
+
 ==== pixman patches ====
 
 endian.patch: include cairo-platform.h for endian macros
 
 ==== disable printing patch ====
 
 disable-printing.patch:  allows us to use NS_PRINTING to disable printing.
diff -r a4343d61f6ee gfx/cairo/cairo/src/cairo-image-surface.c
--- a/gfx/cairo/cairo/src/cairo-image-surface.c	Thu Nov 06 18:33:22 2008 +0100
+++ b/gfx/cairo/cairo/src/cairo-image-surface.c	Sat Nov 15 19:43:13 2008 -0500
@@ -319,17 +319,17 @@ _cairo_image_surface_create_with_pixman_
 						pixman_format_code_t	 pixman_format,
 						int			 width,
 						int			 height,
 						int			 stride)
 {
     cairo_surface_t *surface;
     pixman_image_t *pixman_image;
 
-    pixman_image = pixman_image_create_bits (pixman_format, width, height,
+    pixman_image = pixman_image_create_bits (pixman_format, width ? width : 1, height ? height : 1,
 					     (uint32_t *) data, stride);
 
     if (pixman_image == NULL)
 	return _cairo_surface_create_in_error (_cairo_error (CAIRO_STATUS_NO_MEMORY));
 
     surface = _cairo_image_surface_create_for_pixman_image (pixman_image,
 							    pixman_format);
     if (cairo_surface_status (surface))
diff -r a4343d61f6ee gfx/cairo/cairo/src/cairo-qpainter-surface.cpp
--- a/gfx/cairo/cairo/src/cairo-qpainter-surface.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/gfx/cairo/cairo/src/cairo-qpainter-surface.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -596,16 +596,18 @@ _cairo_qpainter_surface_release_dest_ima
 
 static cairo_status_t
 _cairo_qpainter_surface_clone_similar (void *abstract_surface,
                                        cairo_surface_t *src,
                                        int              src_x,
                                        int              src_y,
                                        int              width,
                                        int              height,
+                                       int              *clone_offset_x,
+                                       int              *clone_offset_y,
                                        cairo_surface_t **clone_out)
 {
     cairo_qpainter_surface_t *qs = (cairo_qpainter_surface_t *) abstract_surface;
     cairo_surface_t *new_surf = NULL;
 
     // For non-image targets, always try to create a QPixmap first
     if (qs->image == NULL && (!_qpixmaps_have_no_alpha || src->content == CAIRO_CONTENT_COLOR))
     {
@@ -638,16 +640,18 @@ _cairo_qpainter_surface_clone_similar (v
 
     _cairo_pattern_fini (&upat.base);
 
     if (status) {
         cairo_surface_destroy (new_surf);
         new_surf = NULL;
     }
 
+    *clone_offset_x = 0;
+    *clone_offset_y = 0;
     *clone_out = new_surf;
     return (cairo_status_t) status;
 }
 
 static cairo_int_status_t
 _cairo_qpainter_surface_get_extents (void *abstract_surface,
                                      cairo_rectangle_int_t *extents)
 {
diff -r a4343d61f6ee gfx/cairo/cairo/src/cairo-win32-private.h
--- a/gfx/cairo/cairo/src/cairo-win32-private.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/gfx/cairo/cairo/src/cairo-win32-private.h	Sat Nov 15 19:43:13 2008 -0500
@@ -112,16 +112,19 @@ enum {
     /* Whether we can use StretchBlt with this surface */
     CAIRO_WIN32_SURFACE_CAN_STRETCHBLT = (1<<4),
 
     /* Whether we can use StretchDIBits with this surface */
     CAIRO_WIN32_SURFACE_CAN_STRETCHDIB = (1<<5),
 
     /* Whether we can use GradientFill rectangles with this surface */
     CAIRO_WIN32_SURFACE_CAN_RECT_GRADIENT = (1<<6),
+
+    /* if this DDB surface can be converted to a DIB if necessary */
+    CAIRO_WIN32_SURFACE_CAN_CONVERT_TO_DIB = (1<<7),
 };
 
 cairo_status_t
 _cairo_win32_print_gdi_error (const char *context);
 
 cairo_bool_t
 _cairo_surface_is_win32 (cairo_surface_t *surface);
 
diff -r a4343d61f6ee gfx/cairo/cairo/src/cairo-win32-surface.c
--- a/gfx/cairo/cairo/src/cairo-win32-surface.c	Thu Nov 06 18:33:22 2008 +0100
+++ b/gfx/cairo/cairo/src/cairo-win32-surface.c	Sat Nov 15 19:43:13 2008 -0500
@@ -555,24 +555,85 @@ _cairo_win32_surface_get_subimage (cairo
 	FillRect(local->dc, &r, (HBRUSH)GetStockObject(WHITE_BRUSH));
     }
 
     *local_out = local;
 
     return CAIRO_STATUS_SUCCESS;
 }
 
+static void
+_cairo_win32_convert_ddb_to_dib (cairo_win32_surface_t *surface)
+{
+    cairo_win32_surface_t *new_surface;
+    int width = surface->extents.width;
+    int height = surface->extents.height;
+
+    BOOL ok;
+    HBITMAP oldbitmap;
+
+    new_surface = (cairo_win32_surface_t*)
+	_cairo_win32_surface_create_for_dc (surface->dc,
+					    surface->format,
+					    width,
+					    height);
+
+    if (new_surface->base.status)
+	return;
+
+    /* DDB can't be 32bpp, so BitBlt is safe */
+    ok = BitBlt (new_surface->dc,
+		 0, 0, width, height,
+		 surface->dc,
+		 0, 0, SRCCOPY);
+
+    if (!ok)
+	goto out;
+
+    /* Now swap around new_surface and surface's internal bitmap
+     * pointers. */
+    DeleteDC (new_surface->dc);
+    new_surface->dc = NULL;
+
+    oldbitmap = SelectObject (surface->dc, new_surface->bitmap);
+    DeleteObject (oldbitmap);
+
+    surface->image = new_surface->image;
+    surface->is_dib = new_surface->is_dib;
+    surface->bitmap = new_surface->bitmap;
+
+    new_surface->bitmap = NULL;
+    new_surface->image = NULL;
+
+    /* Finally update flags */
+    surface->flags = _cairo_win32_flags_for_dc (surface->dc);
+
+  out:
+    cairo_surface_destroy ((cairo_surface_t*)new_surface);
+}
+
 static cairo_status_t
 _cairo_win32_surface_acquire_source_image (void                    *abstract_surface,
 					   cairo_image_surface_t  **image_out,
 					   void                   **image_extra)
 {
     cairo_win32_surface_t *surface = abstract_surface;
     cairo_win32_surface_t *local = NULL;
     cairo_status_t status;
+
+    if (!surface->image && !surface->is_dib && surface->bitmap &&
+	(surface->flags & CAIRO_WIN32_SURFACE_CAN_CONVERT_TO_DIB) != 0)
+    {
+	/* This is a DDB, and we're being asked to use it as a source for
+	 * something that we couldn't support natively.  So turn it into
+	 * a DIB, so that we have an equivalent image surface, as long
+	 * as we're allowed to via flags.
+	 */
+	_cairo_win32_convert_ddb_to_dib (surface);
+    }
 
     if (surface->image) {
 	*image_out = (cairo_image_surface_t *)surface->image;
 	*image_extra = NULL;
 
 	return CAIRO_STATUS_SUCCESS;
     }
 
@@ -2128,8 +2189,66 @@ _cairo_win32_debug_dump_hrgn (HRGN rgn, 
     for (z = 0; z < rd->rdh.nCount; z++) {
 	RECT r = ((RECT*)rd->Buffer)[z];
 	fprintf (stderr, " [%d]: [%d %d %d %d]\n", z, r.left, r.top, r.right - r.left, r.bottom - r.top);
     }
 
     free(rd);
     fflush (stderr);
 }
+
+/**
+ * cairo_win32_surface_set_can_convert_to_dib
+ * @surface: a #cairo_surface_t
+ * @can_convert: a #cairo_bool_t indicating whether this surface can
+ *               be coverted to a DIB if necessary
+ *
+ * A DDB surface with this flag set can be converted to a DIB if it's
+ * used as a source in a way that GDI can't natively handle; for
+ * example, drawing a RGB24 DDB onto an ARGB32 DIB.  Doing this
+ * conversion results in a significant speed optimization, because we
+ * can call on pixman to perform the operation natively, instead of
+ * reading the data from the DC each time.
+ *
+ * Return value: %CAIRO_STATUS_SUCCESS if the flag was successfully
+ * changed, or an error otherwise.
+ * 
+ */
+cairo_status_t
+cairo_win32_surface_set_can_convert_to_dib (cairo_surface_t *asurface, cairo_bool_t can_convert)
+{
+    cairo_win32_surface_t *surface = (cairo_win32_surface_t*) asurface;
+    if (surface->base.type != CAIRO_SURFACE_TYPE_WIN32)
+	return CAIRO_STATUS_SURFACE_TYPE_MISMATCH;
+
+    if (surface->bitmap) {
+	if (can_convert)
+	    surface->flags |= CAIRO_WIN32_SURFACE_CAN_CONVERT_TO_DIB;
+	else
+	    surface->flags &= ~CAIRO_WIN32_SURFACE_CAN_CONVERT_TO_DIB;
+    }
+
+    return CAIRO_STATUS_SUCCESS;
+}
+
+/**
+ * cairo_win32_surface_get_can_convert_to_dib
+ * @surface: a #cairo_surface_t
+ * @can_convert: a #cairo_bool_t* that receives the return value
+ *
+ * Returns the value of the flag indicating whether the surface can be
+ * converted to a DIB if necessary, as set by
+ * cairo_win32_surface_set_can_convert_to_dib.
+ *
+ * Return value: %CAIRO_STATUS_SUCCESS if the flag was successfully
+ * retreived, or an error otherwise.
+ * 
+ */
+cairo_status_t
+cairo_win32_surface_get_can_convert_to_dib (cairo_surface_t *asurface, cairo_bool_t *can_convert)
+{
+    cairo_win32_surface_t *surface = (cairo_win32_surface_t*) asurface;
+    if (surface->base.type != CAIRO_SURFACE_TYPE_WIN32)
+	return CAIRO_STATUS_SURFACE_TYPE_MISMATCH;
+
+    *can_convert = ((surface->flags & CAIRO_WIN32_SURFACE_CAN_CONVERT_TO_DIB) != 0);
+    return CAIRO_STATUS_SUCCESS;
+}
diff -r a4343d61f6ee gfx/cairo/cairo/src/cairo-win32.h
--- a/gfx/cairo/cairo/src/cairo-win32.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/gfx/cairo/cairo/src/cairo-win32.h	Sat Nov 15 19:43:13 2008 -0500
@@ -69,16 +69,22 @@ cairo_win32_surface_get_image (cairo_sur
 cairo_win32_surface_get_image (cairo_surface_t *surface);
 
 #if CAIRO_HAS_WIN32_FONT
 
 /*
  * Win32 font support
  */
 
+cairo_public cairo_status_t
+cairo_win32_surface_set_can_convert_to_dib (cairo_surface_t *surface, cairo_bool_t can_convert);
+
+cairo_public cairo_status_t
+cairo_win32_surface_get_can_convert_to_dib (cairo_surface_t *surface, cairo_bool_t *can_convert);
+
 cairo_public cairo_font_face_t *
 cairo_win32_font_face_create_for_logfontw (LOGFONTW *logfont);
 
 cairo_public cairo_font_face_t *
 cairo_win32_font_face_create_for_hfont (HFONT font);
 
 cairo_public cairo_font_face_t *
 cairo_win32_font_face_create_for_logfontw_hfont (LOGFONTW *logfont, HFONT font);
diff -r a4343d61f6ee gfx/cairo/cairo/src/cairo.h
--- a/gfx/cairo/cairo/src/cairo.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/gfx/cairo/cairo/src/cairo.h	Sat Nov 15 19:43:13 2008 -0500
@@ -1870,16 +1870,17 @@ cairo_surface_status (cairo_surface_t *s
  * @CAIRO_SURFACE_TYPE_QUARTZ: The surface is of type quartz
  * @CAIRO_SURFACE_TYPE_WIN32: The surface is of type win32
  * @CAIRO_SURFACE_TYPE_BEOS: The surface is of type beos
  * @CAIRO_SURFACE_TYPE_DIRECTFB: The surface is of type directfb
  * @CAIRO_SURFACE_TYPE_SVG: The surface is of type svg
  * @CAIRO_SURFACE_TYPE_OS2: The surface is of type os2
  * @CAIRO_SURFACE_TYPE_WIN32_PRINTING: The surface is a win32 printing surface
  * @CAIRO_SURFACE_TYPE_QUARTZ_IMAGE: The surface is of type quartz_image
+ * @CAIRO_SURFACE_TYPE_QPAINTER: The surface is of type qpainter
  *
  * #cairo_surface_type_t is used to describe the type of a given
  * surface. The surface types are also known as "backends" or "surface
  * backends" within cairo.
  *
  * The type of a surface is determined by the function used to create
  * it, which will generally be of the form cairo_<emphasis>type</emphasis>_surface_create(),
  * (though see cairo_surface_create_similar() as well).
@@ -1908,17 +1909,18 @@ typedef enum _cairo_surface_type {
     CAIRO_SURFACE_TYPE_GLITZ,
     CAIRO_SURFACE_TYPE_QUARTZ,
     CAIRO_SURFACE_TYPE_WIN32,
     CAIRO_SURFACE_TYPE_BEOS,
     CAIRO_SURFACE_TYPE_DIRECTFB,
     CAIRO_SURFACE_TYPE_SVG,
     CAIRO_SURFACE_TYPE_OS2,
     CAIRO_SURFACE_TYPE_WIN32_PRINTING,
-    CAIRO_SURFACE_TYPE_QUARTZ_IMAGE
+    CAIRO_SURFACE_TYPE_QUARTZ_IMAGE,
+    CAIRO_SURFACE_TYPE_QPAINTER
 } cairo_surface_type_t;
 
 cairo_public cairo_surface_type_t
 cairo_surface_get_type (cairo_surface_t *surface);
 
 cairo_public cairo_content_t
 cairo_surface_get_content (cairo_surface_t *surface);
 
diff -r a4343d61f6ee gfx/cairo/qpainter-type.patch
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/gfx/cairo/qpainter-type.patch	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,21 @@
+diff --git a/gfx/cairo/cairo/src/cairo.h b/gfx/cairo/cairo/src/cairo.h
+--- a/gfx/cairo/cairo/src/cairo.h
++++ b/gfx/cairo/cairo/src/cairo.h
+@@ -1875,6 +1875,7 @@
+  * @CAIRO_SURFACE_TYPE_OS2: The surface is of type os2
+  * @CAIRO_SURFACE_TYPE_WIN32_PRINTING: The surface is a win32 printing surface
+  * @CAIRO_SURFACE_TYPE_QUARTZ_IMAGE: The surface is of type quartz_image
++ * @CAIRO_SURFACE_TYPE_QPAINTER: The surface is of type qpainter
+  *
+  * #cairo_surface_type_t is used to describe the type of a given
+  * surface. The surface types are also known as "backends" or "surface
+@@ -1913,7 +1914,8 @@
+     CAIRO_SURFACE_TYPE_SVG,
+     CAIRO_SURFACE_TYPE_OS2,
+     CAIRO_SURFACE_TYPE_WIN32_PRINTING,
+-    CAIRO_SURFACE_TYPE_QUARTZ_IMAGE
++    CAIRO_SURFACE_TYPE_QUARTZ_IMAGE,
++    CAIRO_SURFACE_TYPE_QPAINTER
+ } cairo_surface_type_t;
+ 
+ cairo_public cairo_surface_type_t
diff -r a4343d61f6ee gfx/cairo/win32-ddb-dib.patch
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/gfx/cairo/win32-ddb-dib.patch	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,182 @@
+b=455513; add optional flag to allow converting a DDB to a DIB internally, if the surface is every used as a source; r=jmuizelaar
+
+If a DDB is used as a source for an operation that can't be handled
+natively by GDI, we end up needing to take a really slow path (creating a
+temporary surface for acquire_source) for each operation.  If we convert
+the DDB to a DIB, we then end up having a real image buffer and can hand
+things off to pixman directly.
+
+This isn't the default mode because I'm not sure if there are cases where a
+DDB is explicitly needed (e.g. for printing), and it would change
+current cairo behaviour.  It might become the default at some point in the
+future.
+
+diff --git a/gfx/cairo/cairo/src/cairo-win32-private.h b/gfx/cairo/cairo/src/cairo-win32-private.h
+--- a/gfx/cairo/cairo/src/cairo-win32-private.h
++++ b/gfx/cairo/cairo/src/cairo-win32-private.h
+@@ -117,6 +117,9 @@
+ 
+     /* Whether we can use GradientFill rectangles with this surface */
+     CAIRO_WIN32_SURFACE_CAN_RECT_GRADIENT = (1<<6),
++
++    /* if this DDB surface can be converted to a DIB if necessary */
++    CAIRO_WIN32_SURFACE_CAN_CONVERT_TO_DIB = (1<<7),
+ };
+ 
+ cairo_status_t
+diff --git a/gfx/cairo/cairo/src/cairo-win32-surface.c b/gfx/cairo/cairo/src/cairo-win32-surface.c
+--- a/gfx/cairo/cairo/src/cairo-win32-surface.c
++++ b/gfx/cairo/cairo/src/cairo-win32-surface.c
+@@ -560,6 +560,56 @@
+     return CAIRO_STATUS_SUCCESS;
+ }
+ 
++static void
++_cairo_win32_convert_ddb_to_dib (cairo_win32_surface_t *surface)
++{
++    cairo_win32_surface_t *new_surface;
++    int width = surface->extents.width;
++    int height = surface->extents.height;
++
++    BOOL ok;
++    HBITMAP oldbitmap;
++
++    new_surface = (cairo_win32_surface_t*)
++	_cairo_win32_surface_create_for_dc (surface->dc,
++					    surface->format,
++					    width,
++					    height);
++
++    if (new_surface->base.status)
++	return;
++
++    /* DDB can't be 32bpp, so BitBlt is safe */
++    ok = BitBlt (new_surface->dc,
++		 0, 0, width, height,
++		 surface->dc,
++		 0, 0, SRCCOPY);
++
++    if (!ok)
++	goto out;
++
++    /* Now swap around new_surface and surface's internal bitmap
++     * pointers. */
++    DeleteDC (new_surface->dc);
++    new_surface->dc = NULL;
++
++    oldbitmap = SelectObject (surface->dc, new_surface->bitmap);
++    DeleteObject (oldbitmap);
++
++    surface->image = new_surface->image;
++    surface->is_dib = new_surface->is_dib;
++    surface->bitmap = new_surface->bitmap;
++
++    new_surface->bitmap = NULL;
++    new_surface->image = NULL;
++
++    /* Finally update flags */
++    surface->flags = _cairo_win32_flags_for_dc (surface->dc);
++
++  out:
++    cairo_surface_destroy ((cairo_surface_t*)new_surface);
++}
++
+ static cairo_status_t
+ _cairo_win32_surface_acquire_source_image (void                    *abstract_surface,
+ 					   cairo_image_surface_t  **image_out,
+@@ -568,6 +618,17 @@
+     cairo_win32_surface_t *surface = abstract_surface;
+     cairo_win32_surface_t *local = NULL;
+     cairo_status_t status;
++
++    if (!surface->image && !surface->is_dib && surface->bitmap &&
++	(surface->flags & CAIRO_WIN32_SURFACE_CAN_CONVERT_TO_DIB) != 0)
++    {
++	/* This is a DDB, and we're being asked to use it as a source for
++	 * something that we couldn't support natively.  So turn it into
++	 * a DIB, so that we have an equivalent image surface, as long
++	 * as we're allowed to via flags.
++	 */
++	_cairo_win32_convert_ddb_to_dib (surface);
++    }
+ 
+     if (surface->image) {
+ 	*image_out = (cairo_image_surface_t *)surface->image;
+@@ -2133,3 +2194,61 @@
+     free(rd);
+     fflush (stderr);
+ }
++
++/**
++ * cairo_win32_surface_set_can_convert_to_dib
++ * @surface: a #cairo_surface_t
++ * @can_convert: a #cairo_bool_t indicating whether this surface can
++ *               be coverted to a DIB if necessary
++ *
++ * A DDB surface with this flag set can be converted to a DIB if it's
++ * used as a source in a way that GDI can't natively handle; for
++ * example, drawing a RGB24 DDB onto an ARGB32 DIB.  Doing this
++ * conversion results in a significant speed optimization, because we
++ * can call on pixman to perform the operation natively, instead of
++ * reading the data from the DC each time.
++ *
++ * Return value: %CAIRO_STATUS_SUCCESS if the flag was successfully
++ * changed, or an error otherwise.
++ * 
++ */
++cairo_status_t
++cairo_win32_surface_set_can_convert_to_dib (cairo_surface_t *asurface, cairo_bool_t can_convert)
++{
++    cairo_win32_surface_t *surface = (cairo_win32_surface_t*) asurface;
++    if (surface->base.type != CAIRO_SURFACE_TYPE_WIN32)
++	return CAIRO_STATUS_SURFACE_TYPE_MISMATCH;
++
++    if (surface->bitmap) {
++	if (can_convert)
++	    surface->flags |= CAIRO_WIN32_SURFACE_CAN_CONVERT_TO_DIB;
++	else
++	    surface->flags &= ~CAIRO_WIN32_SURFACE_CAN_CONVERT_TO_DIB;
++    }
++
++    return CAIRO_STATUS_SUCCESS;
++}
++
++/**
++ * cairo_win32_surface_get_can_convert_to_dib
++ * @surface: a #cairo_surface_t
++ * @can_convert: a #cairo_bool_t* that receives the return value
++ *
++ * Returns the value of the flag indicating whether the surface can be
++ * converted to a DIB if necessary, as set by
++ * cairo_win32_surface_set_can_convert_to_dib.
++ *
++ * Return value: %CAIRO_STATUS_SUCCESS if the flag was successfully
++ * retreived, or an error otherwise.
++ * 
++ */
++cairo_status_t
++cairo_win32_surface_get_can_convert_to_dib (cairo_surface_t *asurface, cairo_bool_t *can_convert)
++{
++    cairo_win32_surface_t *surface = (cairo_win32_surface_t*) asurface;
++    if (surface->base.type != CAIRO_SURFACE_TYPE_WIN32)
++	return CAIRO_STATUS_SURFACE_TYPE_MISMATCH;
++
++    *can_convert = ((surface->flags & CAIRO_WIN32_SURFACE_CAN_CONVERT_TO_DIB) != 0);
++    return CAIRO_STATUS_SUCCESS;
++}
+diff --git a/gfx/cairo/cairo/src/cairo-win32.h b/gfx/cairo/cairo/src/cairo-win32.h
+--- a/gfx/cairo/cairo/src/cairo-win32.h
++++ b/gfx/cairo/cairo/src/cairo-win32.h
+@@ -74,6 +74,12 @@
+  * Win32 font support
+  */
+ 
++cairo_public cairo_status_t
++cairo_win32_surface_set_can_convert_to_dib (cairo_surface_t *surface, cairo_bool_t can_convert);
++
++cairo_public cairo_status_t
++cairo_win32_surface_get_can_convert_to_dib (cairo_surface_t *surface, cairo_bool_t *can_convert);
++
+ cairo_public cairo_font_face_t *
+ cairo_win32_font_face_create_for_logfontw (LOGFONTW *logfont);
+ 
diff -r a4343d61f6ee gfx/src/thebes/nsThebesImage.cpp
--- a/gfx/src/thebes/nsThebesImage.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/gfx/src/thebes/nsThebesImage.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -490,17 +490,17 @@ nsThebesImage::Draw(gfxContext*        a
             gfxMatrix imageSpaceToUserSpace = userSpaceToImageSpace;
             imageSpaceToUserSpace.Invert();
             fill = imageSpaceToUserSpace.Transform(sourceRect);
   
             surface = ThebesSurface();
             format = mFormat;
             subimage = subimage.Intersect(available) - gfxPoint(aPadding.left, aPadding.top);
             userSpaceToImageSpace.Multiply(
-                gfxMatrix().Translate(gfxPoint(aPadding.left, aPadding.top)));
+                gfxMatrix().Translate(-gfxPoint(aPadding.left, aPadding.top)));
             sourceRect = sourceRect - gfxPoint(aPadding.left, aPadding.top);
             imageRect = gfxRect(0, 0, mWidth, mHeight);
         } else {
             // Create a temporary surface
             gfxIntSize size(PRInt32(imageRect.Width()),
                             PRInt32(imageRect.Height()));
             // Give this surface an alpha channel because there are
             // transparent pixels in the padding or undecoded area
diff -r a4343d61f6ee gfx/thebes/public/gfxPangoFonts.h
--- a/gfx/thebes/public/gfxPangoFonts.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/gfx/thebes/public/gfxPangoFonts.h	Sat Nov 15 19:43:13 2008 -0500
@@ -38,42 +38,31 @@
 
 #ifndef GFX_PANGOFONTS_H
 #define GFX_PANGOFONTS_H
 
 #include "cairo.h"
 #include "gfxTypes.h"
 #include "gfxFont.h"
 
+#include "nsAutoRef.h"
+
 #include <pango/pango.h>
+#include <fontconfig/fontconfig.h>
 
 // Control when we bypass Pango
 // Enable this to use FreeType to glyph-convert 8bit-only textruns, but use Pango
 // to shape any textruns with non-8bit characters
 // XXX
 #define ENABLE_FAST_PATH_8BIT
 // Enable this to bypass Pango shaping for all textruns.  Don't expect
 // anything other than simple Latin work though!
 //#define ENABLE_FAST_PATH_ALWAYS
 
-#include "nsDataHashtable.h"
-#include "nsClassHashtable.h"
-
-class gfxPangoTextRun;
-
-// stub class until fuller implementation is flushed out
-class gfxPangoFontEntry : public gfxFontEntry {
-public:
-    gfxPangoFontEntry(const nsAString& aName)
-        : gfxFontEntry(aName)
-    { }
-
-    ~gfxPangoFontEntry() {}
-        
-};
+class gfxFcPangoFontSet;
 
 class THEBES_API gfxPangoFontGroup : public gfxFontGroup {
 public:
     gfxPangoFontGroup (const nsAString& families,
                        const gfxFontStyle *aStyle,
                        gfxUserFontSet *aUserFontSet);
     virtual ~gfxPangoFontGroup ();
 
@@ -84,19 +73,43 @@ public:
                                     const Parameters *aParams, PRUint32 aFlags);
     virtual gfxTextRun *MakeTextRun(const PRUint8 *aString, PRUint32 aLength,
                                     const Parameters *aParams, PRUint32 aFlags);
 
     virtual gfxFont *GetFontAt(PRInt32 i);
 
     static void Shutdown();
 
+    // Interfaces used internally
+    // (but public so that they can be accessed from non-member functions):
+
+    // The FontGroup holds the reference to the PangoFont (through the FontSet).
+    PangoFont *GetBasePangoFont();
+
+    // A language guessed from the gfxFontStyle
+    PangoLanguage *GetPangoLanguage() { return mPangoLanguage; }
+
+    // @param aLang [in] language to use for pref fonts and system default font
+    //        selection, or NULL for the language guessed from the gfxFontStyle.
+    // The FontGroup holds a reference to this set.
+    gfxFcPangoFontSet *GetFontSet(PangoLanguage *aLang = NULL);
+
 protected:
-    PangoFont *mBasePangoFont;
-    gfxFloat mAdjustedSize;
+    class FontSetByLangEntry {
+    public:
+        FontSetByLangEntry(PangoLanguage *aLang, gfxFcPangoFontSet *aFontSet);
+        PangoLanguage *mLang;
+        nsRefPtr<gfxFcPangoFontSet> mFontSet;
+    };
+    // There is only one of entry in this array unless characters from scripts
+    // of other languages are measured.
+    nsAutoTArray<FontSetByLangEntry,1> mFontSets;
+
+    gfxFloat mSizeAdjustFactor;
+    PangoLanguage *mPangoLanguage;
 
     // ****** Textrun glyph conversion helpers ******
 
     /**
      * Fill in the glyph-runs for the textrun.
      * @param aTake8BitPath the text contains only characters below 0x100
      * (TEXT_IS_8BIT can return false when the characters are all below 0x100
      * but stored in UTF16 format)
@@ -118,60 +131,29 @@ protected:
                                   const gchar *aUTF8, PRUint32 aUTF8Length,
                                   PRUint32 aUTF8HeaderLength);
 #if defined(ENABLE_FAST_PATH_8BIT) || defined(ENABLE_FAST_PATH_ALWAYS)
     PRBool CanTakeFastPath(PRUint32 aFlags);
     nsresult CreateGlyphRunsFast(gfxTextRun *aTextRun,
                                  const gchar *aUTF8, PRUint32 aUTF8Length);
 #endif
 
-    void GetFcFamilies(nsAString &aFcFamilies);
-    PangoFont *GetBasePangoFont();
+    void GetFcFamilies(nsStringArray *aFcFamilyList,
+                       const nsACString& aLangGroup);
 
-    // Check GetStyle()->sizeAdjust != 0.0 before calling this 
-    gfxFloat GetAdjustedSize()
+    // @param aLang [in] language to use for pref fonts and system font
+    //        resolution, or NULL to guess a language from the gfxFontStyle.
+    // @param aMatchPattern [out] if non-NULL, will return the pattern used.
+    already_AddRefed<gfxFcPangoFontSet>
+    MakeFontSet(PangoLanguage *aLang, gfxFloat aSizeAdjustFactor,
+                nsAutoRef<FcPattern> *aMatchPattern = NULL);
+
+    gfxFcPangoFontSet *GetBaseFontSet();
+
+    gfxFloat GetSizeAdjustFactor()
     {
-        if (!mBasePangoFont)
-            GetBasePangoFont();
-        return mAdjustedSize;
+        if (mFontSets.Length() == 0)
+            GetBaseFontSet();
+        return mSizeAdjustFactor;
     }
 };
 
-class gfxPangoFontWrapper {
-public:
-    gfxPangoFontWrapper(PangoFont *aFont) {
-        mFont = aFont;
-        g_object_ref(mFont);
-    }
-    ~gfxPangoFontWrapper() {
-        if (mFont)
-            g_object_unref(mFont);
-    }
-    PangoFont* Get() { return mFont; }
-private:
-    PangoFont *mFont;
-};
-
-class gfxPangoFontCache
-{
-public:
-    gfxPangoFontCache();
-    ~gfxPangoFontCache();
-
-    static gfxPangoFontCache* GetPangoFontCache() {
-        if (!sPangoFontCache)
-            sPangoFontCache = new gfxPangoFontCache();
-        return sPangoFontCache;
-    }
-    static void Shutdown() {
-        if (sPangoFontCache)
-            delete sPangoFontCache;
-        sPangoFontCache = nsnull;
-    }
-
-    void Put(const PangoFontDescription *aFontDesc, PangoFont *aPangoFont);
-    PangoFont* Get(const PangoFontDescription *aFontDesc);
-private:
-    static gfxPangoFontCache *sPangoFontCache;
-    nsClassHashtable<nsUint32HashKey,  gfxPangoFontWrapper> mPangoFonts;
-};
-
 #endif /* GFX_PANGOFONTS_H */
diff -r a4343d61f6ee gfx/thebes/public/gfxPlatformGtk.h
--- a/gfx/thebes/public/gfxPlatformGtk.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/gfx/thebes/public/gfxPlatformGtk.h	Sat Nov 15 19:43:13 2008 -0500
@@ -35,29 +35,35 @@
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 #ifndef GFX_PLATFORM_GTK_H
 #define GFX_PLATFORM_GTK_H
 
 #include "gfxPlatform.h"
+#include "nsAutoRef.h"
 
 extern "C" {
     typedef struct _GdkDrawable GdkDrawable;
 }
 
 class gfxFontconfigUtils;
 #ifndef MOZ_PANGO
 class FontFamily;
 class FontEntry;
 typedef struct FT_LibraryRec_ *FT_Library;
 #endif
 
-
+template <class T>
+class gfxGObjectRefTraits : public nsPointerRefTraits<T> {
+public:
+    static void Release(T *aPtr) { g_object_unref(aPtr); }
+    static void AddRef(T *aPtr) { g_object_ref(aPtr); }
+};
 
 class THEBES_API gfxPlatformGtk : public gfxPlatform {
 public:
     gfxPlatformGtk();
     virtual ~gfxPlatformGtk();
 
     static gfxPlatformGtk *GetPlatform() {
         return (gfxPlatformGtk*) gfxPlatform::GetPlatform();
diff -r a4343d61f6ee gfx/thebes/src/cairo-xlib-utils.c
--- a/gfx/thebes/src/cairo-xlib-utils.c	Thu Nov 06 18:33:22 2008 +0100
+++ b/gfx/thebes/src/cairo-xlib-utils.c	Sat Nov 15 19:43:13 2008 -0500
@@ -53,16 +53,18 @@
 #include <gdk/gdkx.h>
 
 #if 0
 #include <stdio.h>
 #define CAIRO_GDK_DRAWING_NOTE(m) fprintf(stderr, m)
 #else
 #define CAIRO_GDK_DRAWING_NOTE(m) do {} while (0)
 #endif
+
+#define GDK_PIXMAP_SIZE_MAX 32767
 
 static cairo_user_data_key_t pixmap_free_key;
 static void pixmap_free_func (void *data)
 {
     GdkPixmap *pixmap = (GdkPixmap *) data;
     g_object_unref(pixmap);
 }
 
@@ -312,16 +314,20 @@ _draw_with_xlib_direct (cairo_t *cr,
     return ret;
 }
 
 static cairo_surface_t *
 _create_temp_xlib_surface (cairo_t *cr, Display *dpy, int width, int height,
                            cairo_gdk_drawing_support_t capabilities)
 {
     cairo_surface_t *result = NULL;
+
+    if (width >= GDK_PIXMAP_SIZE_MAX ||
+        height >= GDK_PIXMAP_SIZE_MAX)
+        return NULL;
 
     /* base the temp surface on the *screen* surface, not any intermediate
      * group surface, because the screen surface is more likely to have
      * characteristics that the xlib-using code is likely to be happy with */
     cairo_surface_t *target = cairo_get_target (cr);
     Drawable target_drawable = cairo_xlib_surface_get_drawable (target);
     GdkDrawable *gdk_target_drawable = GDK_DRAWABLE(gdk_xid_table_lookup(target_drawable));
 
diff -r a4343d61f6ee gfx/thebes/src/gfxFontconfigUtils.cpp
--- a/gfx/thebes/src/gfxFontconfigUtils.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/gfx/thebes/src/gfxFontconfigUtils.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -72,26 +72,41 @@ gfxFontconfigUtils::GetThebesStyle(FcPat
             return FONT_STYLE_ITALIC;
         if (slant == FC_SLANT_OBLIQUE)
             return FONT_STYLE_OBLIQUE;
     }
 
     return FONT_STYLE_NORMAL;
 }
 
+/* static */ int
+gfxFontconfigUtils::GetFcSlant(const gfxFontStyle& aFontStyle)
+{
+    if (aFontStyle.style == FONT_STYLE_ITALIC)
+        return FC_SLANT_ITALIC;
+    if (aFontStyle.style == FONT_STYLE_OBLIQUE)
+        return FC_SLANT_OBLIQUE;
+
+    return FC_SLANT_ROMAN;
+}
+
 // OS/2 weight classes were introduced in fontconfig-2.1.93 (2003).
 #ifndef FC_WEIGHT_THIN 
 #define FC_WEIGHT_THIN              0 // 2.1.93
 #define FC_WEIGHT_EXTRALIGHT        40 // 2.1.93
 #define FC_WEIGHT_REGULAR           80 // 2.1.93
 #define FC_WEIGHT_EXTRABOLD         205 // 2.1.93
 #endif
 // book was introduced in fontconfig-2.2.90 (and so fontconfig-2.3.0 in 2005)
 #ifndef FC_WEIGHT_BOOK
 #define FC_WEIGHT_BOOK              75
+#endif
+// extra black was introduced in fontconfig-2.4.91 (2007)
+#ifndef FC_WEIGHT_EXTRABLACK
+#define FC_WEIGHT_EXTRABLACK        215
 #endif
 
 /* static */ PRUint16
 gfxFontconfigUtils::GetThebesWeight(FcPattern *aPattern)
 {
     int weight;
     if (FcPatternGetInteger(aPattern, FC_WEIGHT, 0, &weight) != FcResultMatch)
         return FONT_WEIGHT_NORMAL;
@@ -111,48 +126,161 @@ gfxFontconfigUtils::GetThebesWeight(FcPa
         return 600;
     if (weight <= (FC_WEIGHT_BOLD + FC_WEIGHT_EXTRABOLD) / 2)
         return 700;
     if (weight <= (FC_WEIGHT_EXTRABOLD + FC_WEIGHT_BLACK) / 2)
         return 800;
     if (weight <= FC_WEIGHT_BLACK)
         return 900;
 
-    // FC_WEIGHT_EXTRABLACK was introduced in fontconfig-2.4.91 (2007)
+    // including FC_WEIGHT_EXTRABLACK
     return 901;
+}
+
+/* static */ int
+gfxFontconfigUtils::FcWeightForBaseWeight(PRInt8 aBaseWeight)
+{
+    switch (aBaseWeight) {
+        case 2:
+            return FC_WEIGHT_EXTRALIGHT;
+        case 3:
+            return FC_WEIGHT_LIGHT;
+        case 4:
+            return FC_WEIGHT_REGULAR;
+        case 5:
+            return FC_WEIGHT_MEDIUM;
+        case 6:
+            return FC_WEIGHT_DEMIBOLD;
+        case 7:
+            return FC_WEIGHT_BOLD;
+        case 8:
+            return FC_WEIGHT_EXTRABOLD;
+        case 9:
+            return FC_WEIGHT_BLACK;
+    }
+
+    // extremes
+    return aBaseWeight < 2 ? FC_WEIGHT_THIN : FC_WEIGHT_EXTRABLACK;
+}
+
+// This makes a guess at an FC_WEIGHT corresponding to a base weight and
+// offset (without any knowledge of which weights are available).
+
+/* static */ int
+GuessFcWeight(const gfxFontStyle& aFontStyle)
+{
+    /*
+     * weights come in two parts crammed into one
+     * integer -- the "base" weight is weight / 100,
+     * the rest of the value is the "offset" from that
+     * weight -- the number of steps to move to adjust
+     * the weight in the list of supported font weights,
+     * this value can be negative or positive.
+     */
+    PRInt8 weight;
+    PRInt8 offset;
+    aFontStyle.ComputeWeightAndOffset(&weight, &offset);
+
+    // ComputeWeightAndOffset trimmed the range of weights for us
+    NS_ASSERTION(weight >= 0 && weight <= 10,
+                 "base weight out of range");
+
+    // Most font families do not support every weight.  The tables here are
+    // chosen such that a normal (4) base weight and an offset of +1 will
+    // guess bold.
+
+    // Mapping from weight to a guess of the nearest available lighter weight
+    static const int lighterGuess[11] =
+        { 0, 0, 1, 1, 2, 3, 4, 4, 6, 7, 8 };
+    // Mapping from weight to a guess of the nearest available bolder weight
+    static const int bolderGuess[11] =
+        { 2, 3, 4, 6, 7, 7, 8, 9, 10, 10, 10 };
+
+    while (offset < 0) {
+        weight = lighterGuess[weight];
+        offset++;
+    }
+    while (offset > 0) {
+        weight = bolderGuess[weight];
+        offset--;
+    }
+
+    return gfxFontconfigUtils::FcWeightForBaseWeight(weight);
+}
+
+static void
+AddString(FcPattern *aPattern, const char *object, const char *aString)
+{
+    // Cast from signed chars used in nsString to unsigned in fontconfig
+    const FcChar8 *fcString = gfxFontconfigUtils::ToFcChar8(aString);
+    // and cast away the const for fontconfig, that will merely make a copy.
+    FcPatternAddString(aPattern, object, const_cast<FcChar8*>(fcString));
+}
+
+static void
+AddLangGroup(FcPattern *aPattern, const nsACString& aLangGroup)
+{
+    // Translate from mozilla's internal mapping into fontconfig's
+    nsCAutoString lang;
+    gfxFontconfigUtils::GetSampleLangForGroup(aLangGroup, &lang);
+
+    if (!lang.IsEmpty()) {
+        AddString(aPattern, FC_LANG, lang.get());
+    }
+}
+
+
+nsReturnRef<FcPattern>
+gfxFontconfigUtils::NewPattern(const nsStringArray& aFamilies,
+                               const gfxFontStyle& aFontStyle,
+                               const char *aLang)
+{
+    nsAutoRef<FcPattern> pattern(FcPatternCreate());
+    if (!pattern)
+        return nsReturnRef<FcPattern>();
+
+    FcPatternAddDouble(pattern, FC_PIXEL_SIZE, aFontStyle.size);
+    FcPatternAddInteger(pattern, FC_SLANT, GetFcSlant(aFontStyle));
+    FcPatternAddInteger(pattern, FC_WEIGHT, GuessFcWeight(aFontStyle));
+
+    if (aLang) {
+        AddString(pattern, FC_LANG, aLang);
+    }
+
+    for (PRInt32 i = 0; i < aFamilies.Count(); ++i) {
+        NS_ConvertUTF16toUTF8 family(*aFamilies[i]);
+        AddString(pattern, FC_FAMILY, family.get());
+    }
+
+    return pattern.out();
 }
 
 gfxFontconfigUtils::gfxFontconfigUtils()
     : mLastConfig(NULL)
 {
-    mAliasTable.Init(50);
+    mFontsByFamily.Init(50);
+    mLangSupportTable.Init(20);
+    UpdateFontListInternal();
 }
 
 nsresult
 gfxFontconfigUtils::GetFontList(const nsACString& aLangGroup,
                                 const nsACString& aGenericFamily,
                                 nsStringArray& aListOfFonts)
 {
     aListOfFonts.Clear();
 
-    nsresult rv = UpdateFontListInternal();
+    nsCStringArray fonts;
+    nsresult rv = GetFontListInternal(fonts, aLangGroup);
     if (NS_FAILED(rv))
         return rv;
 
-    nsCStringArray tmpFonts;
-    nsCStringArray *fonts = &mFonts;
-    if (!aLangGroup.IsEmpty() || !aGenericFamily.IsEmpty()) {
-        rv = GetFontListInternal(tmpFonts, &aLangGroup);
-        if (NS_FAILED(rv))
-            return rv;
-        fonts = &tmpFonts;
+    for (PRInt32 i = 0; i < fonts.Count(); ++i) {
+        aListOfFonts.AppendString(NS_ConvertUTF8toUTF16(*fonts.CStringAt(i)));
     }
-
-    for (PRInt32 i = 0; i < fonts->Count(); ++i)
-         aListOfFonts.AppendString(NS_ConvertUTF8toUTF16(*fonts->CStringAt(i)));
 
     aListOfFonts.Sort();
 
     PRInt32 serif = 0, sansSerif = 0, monospace = 0;
 
     // Fontconfig supports 3 generic fonts, "serif", "sans-serif", and
     // "monospace", slightly different from CSS's 5.
     if (aGenericFamily.IsEmpty())
@@ -249,17 +377,17 @@ TryLangForGroup(const nsACString& aOSLan
 /* static */ void
 gfxFontconfigUtils::GetSampleLangForGroup(const nsACString& aLangGroup,
                                           nsACString *aFcLang)
 {
     NS_PRECONDITION(aFcLang != nsnull, "aFcLang must not be NULL");
 
     const MozLangGroupData *langGroup = nsnull;
 
-    for (unsigned int i=0; i < NS_ARRAY_LENGTH(MozLangGroups); ++i) {
+    for (unsigned int i = 0; i < NS_ARRAY_LENGTH(MozLangGroups); ++i) {
         if (aLangGroup.Equals(MozLangGroups[i].mozLangGroup,
                               nsCaseInsensitiveCStringComparator())) {
             langGroup = &MozLangGroups[i];
             break;
         }
     }
 
     if (!langGroup) {
@@ -304,35 +432,19 @@ gfxFontconfigUtils::GetSampleLangForGrou
 
     if (langGroup->defaultLang) {
         aFcLang->Assign(langGroup->defaultLang);
     } else {
         aFcLang->Truncate();
     }
 }
 
-static void
-AddLangGroup(FcPattern *aPattern, const nsACString& aLangGroup)
-{
-    // Translate from mozilla's internal mapping into fontconfig's
-    nsCAutoString lang;
-    gfxFontconfigUtils::GetSampleLangForGroup(aLangGroup, &lang);
-
-    if (!lang.IsEmpty()) {
-        // cast from signed chars used in nsString to unsigned in fontconfig
-        const FcChar8 *fcString = reinterpret_cast<const FcChar8*>(lang.get());
-        // and cast away the const for fontconfig, that will merely make a copy.
-        FcPatternAddString(aPattern, FC_LANG, const_cast<FcChar8*>(fcString));
-    }
-}
-
-
 nsresult
 gfxFontconfigUtils::GetFontListInternal(nsCStringArray& aListOfFonts,
-                                        const nsACString *aLangGroup)
+                                        const nsACString& aLangGroup)
 {
     FcPattern *pat = NULL;
     FcObjectSet *os = NULL;
     FcFontSet *fs = NULL;
     nsresult rv = NS_ERROR_FAILURE;
 
     aListOfFonts.Clear();
 
@@ -340,18 +452,18 @@ gfxFontconfigUtils::GetFontListInternal(
     if (!pat)
         goto end;
 
     os = FcObjectSetBuild(FC_FAMILY, NULL);
     if (!os)
         goto end;
 
     // take the pattern and add the lang group to it
-    if (aLangGroup && !aLangGroup->IsEmpty()) {
-        AddLangGroup(pat, *aLangGroup);
+    if (!aLangGroup.IsEmpty()) {
+        AddLangGroup(pat, aLangGroup);
     }
 
     fs = FcFontList(NULL, pat, os);
     if (!fs)
         goto end;
 
     for (int i = 0; i < fs->nfont; i++) {
         char *family;
@@ -408,26 +520,48 @@ gfxFontconfigUtils::UpdateFontListIntern
     // before destroying the old config, so the only way that we'd miss an
     // update is if fontconfig did more than one update and the memory for the
     // most recent config happened to be at the same location as the original
     // config.
     FcConfig *currentConfig = FcConfigGetCurrent();
     if (currentConfig == mLastConfig)
         return NS_OK;
 
-    mFonts.Clear();
-    mAliasForSingleFont.Clear();
+    // This FcFontSet is owned by fontconfig
+    FcFontSet *fontSet = FcConfigGetFonts(currentConfig, FcSetSystem);
+
+    mFontsByFamily.Clear();
+    mLangSupportTable.Clear();
     mAliasForMultiFonts.Clear();
-    mNonExistingFonts.Clear();
 
-    mAliasTable.Clear();
+    // Record the existing font families
+    for (int f = 0; f < fontSet->nfont; ++f) {
+        FcPattern *font = fontSet->fonts[f];
 
-    nsresult rv = GetFontListInternal(mFonts);
-    if (NS_FAILED(rv))
-        return rv;
+        FcChar8 *family;
+        for (int v = 0;
+             FcPatternGetString(font, FC_FAMILY, v, &family) == FcResultMatch;
+             ++v) {
+            FontsByFcStrEntry *entry = mFontsByFamily.PutEntry(family);
+            if (entry) {
+                PRBool added = entry->AddFont(font);
+
+                if (!entry->mKey) {
+                    // The reference to the font pattern keeps the pointer to
+                    // string for the key valid.  If adding the font failed
+                    // then the entry must be removed.
+                    if (added) {
+                        entry->mKey = family;
+                    } else {
+                        mFontsByFamily.RawRemoveEntry(entry);
+                    }
+                }
+            }
+        }
+    }
 
     // XXX we don't support all alias names.
     // Because if we don't check whether the given font name is alias name,
     // fontconfig converts the non existing font to sans-serif.
     // This is not good if the web page specifies font-family
     // that has Windows font name in the first.
     nsCOMPtr<nsIPrefService> prefs = do_GetService(NS_PREFSERVICE_CONTRACTID);
     if (!prefs)
@@ -458,80 +592,18 @@ gfxFontconfigUtils::UpdateFontListIntern
                 /* nothing */ ;
             nsCAutoString name(Substring(start, p));
             name.CompressWhitespace(PR_FALSE, PR_TRUE);
             mAliasForMultiFonts.AppendCString(name);
             p++;
         }
     }
 
-    for (PRInt32 i = 0; i < mAliasForMultiFonts.Count(); i++) {
-        nsRefPtr<gfxFontNameList> fonts = new gfxFontNameList;
-        nsCAutoString fontname(*mAliasForMultiFonts.CStringAt(i));
-        rv = GetResolvedFonts(fontname, fonts);
-        if (NS_FAILED(rv))
-            return rv;
-
-        nsCAutoString key;
-        ToLowerCase(fontname, key);
-        mAliasTable.Put(key, fonts);
-    }
-
     mLastConfig = currentConfig;
     return NS_OK;
-}
-
-nsresult
-gfxFontconfigUtils::GetResolvedFonts(const nsACString& aName,
-                                     gfxFontNameList* aResult)
-{
-    FcPattern *pat = NULL;
-    FcFontSet *fs = NULL;
-    FcResult fresult;
-    aResult->Clear();
-    nsresult rv = NS_ERROR_FAILURE;
-
-    pat = FcPatternCreate();
-    if (!pat)
-        goto end;
-
-    FcDefaultSubstitute(pat);
-    FcPatternAddString(pat, FC_FAMILY,
-                       (FcChar8 *)nsPromiseFlatCString(aName).get());
-    // Delete the lang param. We need lang independent alias list.
-    FcPatternDel(pat, FC_LANG);
-    FcConfigSubstitute(NULL, pat, FcMatchPattern);
-
-    fs = FcFontSort(NULL, pat, FcTrue, NULL, &fresult);
-    if (!fs)
-        goto end;
-
-    rv = NS_OK;
-    for (int i = 0; i < fs->nfont; i++) {
-        char *family;
-
-        if (FcPatternGetString(fs->fonts[i], FC_FAMILY, 0,
-                               (FcChar8 **) &family) != FcResultMatch ||
-            mAliasForMultiFonts.IndexOfIgnoreCase(nsDependentCString(family)) >= 0 ||
-            IsExistingFont(nsDependentCString(family)) == 0)
-        {
-            continue;
-        }
-        NS_ConvertUTF8toUTF16 actualName(family);
-        if (aResult->Exists(actualName))
-            continue;
-        aResult->AppendElement(actualName);
-    }
-
-  end:
-    if (pat)
-        FcPatternDestroy(pat);
-    if (fs)
-        FcFontSetDestroy(fs);
-    return rv;
 }
 
 nsresult
 gfxFontconfigUtils::GetStandardFamilyName(const nsAString& aFontName, nsAString& aFamilyName)
 {
     aFamilyName.Truncate();
 
     // The fontconfig has generic family names in the font list.
@@ -543,22 +615,18 @@ gfxFontconfigUtils::GetStandardFamilyNam
     }
 
     nsresult rv = UpdateFontListInternal();
     if (NS_FAILED(rv))
         return rv;
 
     NS_ConvertUTF16toUTF8 fontname(aFontName);
 
-    if (mFonts.IndexOf(fontname) >= 0) {
-        aFamilyName.Assign(aFontName);
-        return NS_OK;
-    }
-
-    if (mNonExistingFonts.IndexOf(fontname) >= 0)
+    // return empty string if no such family exists
+    if (!IsExistingFamily(fontname))
         return NS_OK;
 
     FcPattern *pat = NULL;
     FcObjectSet *os = NULL;
     FcFontSet *givenFS = NULL;
     nsCStringArray candidates;
     FcFontSet *candidateFS = NULL;
     rv = NS_ERROR_FAILURE;
@@ -650,100 +718,215 @@ gfxFontconfigUtils::ResolveFontName(cons
 {
     aAborted = PR_FALSE;
 
     nsresult rv = UpdateFontListInternal();
     if (NS_FAILED(rv))
         return rv;
 
     NS_ConvertUTF16toUTF8 fontname(aFontName);
-    if (mAliasForMultiFonts.IndexOfIgnoreCase(fontname) >= 0) {
-        nsCAutoString key;
-        ToLowerCase(fontname, key);
-        nsRefPtr<gfxFontNameList> fonts;
-        if (!mAliasTable.Get(key, &fonts))
-            NS_ERROR("The mAliasTable was broken!");
-        for (PRUint32 i = 0; i < fonts->Length(); i++) {
-            aAborted = !(*aCallback)(fonts->ElementAt(i), aClosure);
-            if (aAborted)
-                break;
-        }
-    } else {
-        PRInt32 result = IsExistingFont(fontname);
-        if (result < 0)
-            return NS_ERROR_FAILURE;
-
-        if (result > 0)
-            aAborted = !(*aCallback)(aFontName, aClosure);
-    }
+    // Sometimes, the font has two or more names (e.g., "Sazanami Gothic" has
+    // Japanese localized name).  We should not resolve to a single name
+    // because different names sometimes have different behavior. e.g., with
+    // the default settings of "Sazanami" on Fedora Core 5, the non-localized
+    // name uses anti-alias, but the localized name uses it.  So, we should
+    // check just whether the font is existing, without resolving to regular
+    // name.
+    //
+    // The family names in mAliasForMultiFonts are names understood by
+    // fontconfig.  The actual font to which they resolve depends on the
+    // entire match pattern.  That info is not available here, but there
+    // will be a font so leave the resolving to the gfxFontGroup.
+    if (IsExistingFamily(fontname) ||
+        mAliasForMultiFonts.IndexOfIgnoreCase(fontname))
+        aAborted = !(*aCallback)(aFontName, aClosure);
 
     return NS_OK;
 }
 
-PRInt32
-gfxFontconfigUtils::IsExistingFont(const nsACString &aFontName)
+PRBool
+gfxFontconfigUtils::IsExistingFamily(const nsCString& aFamilyName)
 {
-    // Very many sites may specify the font-family only for Windows and Mac.
-    // We should check negative cache at first.
-    if (mNonExistingFonts.IndexOf(aFontName) >= 0)
-        return 0;
-    if (mAliasForSingleFont.IndexOf(aFontName) >= 0)
-        return 1;
-    if (mFonts.IndexOf(aFontName) >= 0)
-        return 1;
+    return mFontsByFamily.GetEntry(ToFcChar8(aFamilyName.get())) != nsnull;
+}
 
-    // XXX Sometimes, the font has two or more names (e.g., "Sazanami Gothic"
-    // has Japanese localized name). The another name doesn't including the
-    // cache. Therefore, we need to check the name.
-    // But we don't need to resolve the name. Because both names are not same
-    // behavior. E.g., the default settings of "Sazanami" on Fedora Core 5,
-    // the non-localized name uses Anti-alias, but the localized name uses it.
-    // So, we should check just whether the font is existing, don't resolve
-    // to regular name.
+const nsTArray< nsCountedRef<FcPattern> >&
+gfxFontconfigUtils::GetFontsForFamily(const FcChar8 *aFamilyName)
+{
+    FontsByFcStrEntry *entry = mFontsByFamily.GetEntry(aFamilyName);
 
-    FcPattern *pat = NULL;
-    FcObjectSet *os = NULL;
-    FcFontSet *fs = NULL;
-    PRInt32 result = -1;
+    if (!entry)
+        return mEmptyPatternArray;
 
-    pat = FcPatternCreate();
-    if (!pat)
-        goto end;
+    return entry->GetFonts();
+}
 
-    FcPatternAddString(pat, FC_FAMILY,
-                       (FcChar8 *)nsPromiseFlatCString(aFontName).get());
+static FcLangResult
+CompareLangString(const FcChar8 *aLangA, const FcChar8 *aLangB) {
+    FcLangResult result = FcLangDifferentLang;
+    for (PRUint32 i = 0; ; ++i) {
+        FcChar8 a = FcToLower(aLangA[i]);
+        FcChar8 b = FcToLower(aLangB[i]);
 
-    os = FcObjectSetBuild(FC_FAMILY, NULL);
-    if (!os)
-        goto end;
+        if (a != b) {
+            if ((a == '\0' && b == '-') || (a == '-' && b == '\0'))
+                return FcLangDifferentCountry;
 
-    fs = FcFontList(NULL, pat, os);
-    if (!fs)
-        goto end;
+            return result;
+        }
+        if (a == '\0')
+            return FcLangEqual;
 
-    // There can be more than one matching set of family names: see bug 393819.
-    if (fs->nfont > 0) {
-        mAliasForSingleFont.AppendCString(aFontName);
-        result = 1;
-    } else {
-        mNonExistingFonts.AppendCString(aFontName);
-        result = 0;
+        if (a == '-') {
+            result = FcLangDifferentCountry;
+        }
+    }
+}
+
+/* static */
+FcLangResult
+gfxFontconfigUtils::GetLangSupport(FcPattern *aFont, const FcChar8 *aLang)
+{
+    // When fontconfig builds a pattern for the font, it will set a single
+    // LangSet property value for the font.  That value may be removed and
+    // additional string values may be added through FcConfigSubsitute with
+    // FcMatchScan.  Values that are neither LangSet nor string are considered
+    // errors in fontconfig sort and match functions.
+    FcValue value;
+    FcLangResult best = FcLangDifferentLang;
+    int v = 0;
+    while (FcPatternGet(aFont, FC_LANG, v, &value) == FcResultMatch) {
+        ++v;
+
+        FcLangResult support;
+        switch (value.type) {
+            case FcTypeLangSet:
+                support = FcLangSetHasLang(value.u.l, aLang);
+                break;
+            case FcTypeString:
+                support = CompareLangString(value.u.s, aLang);
+                break;
+            default:
+                // error
+                return FcLangEqual;
+        }
+
+        if (support < best) { // lower is better
+            if (support == FcLangEqual)
+                return support;
+            best = support;
+        }        
     }
 
-  end:
-    if (pat)
-        FcPatternDestroy(pat);
-    if (os)
-        FcObjectSetDestroy(os);
-    if (fs)
-        FcFontSetDestroy(fs);
-    return result;
+    // A missing FC_LANG property is considered a match in fontconfig sort
+    // and match functions.
+    if (v == 0)
+        return FcLangEqual;        
+
+    return best;
+}
+
+gfxFontconfigUtils::LangSupportEntry *
+gfxFontconfigUtils::GetLangSupportEntry(const FcChar8 *aLang, PRBool aWithFonts)
+{
+    // Currently any unrecognized languages from documents will be converted
+    // to x-unicode by nsILanguageAtomService, so there is a limit on the
+    // langugages that will be added here.  Reconsider when/if document
+    // languages are passed to this routine.
+
+    LangSupportEntry *entry = mLangSupportTable.PutEntry(aLang);
+    if (!entry)
+        return nsnull;
+
+    FcLangResult best = FcLangDifferentLang;
+
+    if (!entry->IsKeyInitialized()) {
+        entry->InitKey(aLang);
+    } else {
+        // mSupport is already initialized.
+        if (!aWithFonts)
+            return entry;
+
+        best = entry->mSupport;
+        // If there is support for this language, an empty font list indicates
+        // that the list hasn't been initialized yet.
+        if (best == FcLangDifferentLang || entry->mFonts.Length() > 0)
+            return entry;
+    }
+
+    // This FcFontSet is owned by fontconfig
+    FcFontSet *fontSet = FcConfigGetFonts(NULL, FcSetSystem);
+
+    nsAutoTArray<FcPattern*,100> fonts;
+
+    for (int f = 0; f < fontSet->nfont; ++f) {
+        FcPattern *font = fontSet->fonts[f];
+
+        FcLangResult support = GetLangSupport(font, aLang);
+
+        if (support < best) { // lower is better
+            best = support;
+            if (aWithFonts) {
+                fonts.Clear();
+            } else if (best == FcLangEqual) {
+                break;
+            }
+        }
+
+        // The font list in the LangSupportEntry is expected to be used only
+        // when no default fonts support the language.  There would be a large
+        // number of fonts in entries for languages using Latin script but
+        // these do not need to be created because default fonts already
+        // support these languages.
+        if (aWithFonts && support != FcLangDifferentLang && support == best) {
+            fonts.AppendElement(font);
+        }
+    }
+
+    entry->mSupport = best;
+    if (aWithFonts) {
+        if (fonts.Length() != 0) {
+            entry->mFonts.AppendElements(fonts.Elements(), fonts.Length());
+        } else if (best != FcLangDifferentLang) {
+            // Previously there was a font that supported this language at the
+            // level of entry->mSupport, but it has now disappeared.  At least
+            // entry->mSupport needs to be recalculated, but this is an
+            // indication that the set of installed fonts has changed, so
+            // update all caches.
+            mLastConfig = NULL; // invalidates caches
+            UpdateFontListInternal(PR_TRUE);
+            return GetLangSupportEntry(aLang, aWithFonts);
+        }
+    }
+
+    return entry;
+}
+
+FcLangResult
+gfxFontconfigUtils::GetBestLangSupport(const FcChar8 *aLang)
+{
+    UpdateFontListInternal();
+
+    LangSupportEntry *entry = GetLangSupportEntry(aLang, PR_FALSE);
+    if (!entry)
+        return FcLangEqual;
+
+    return entry->mSupport;
+}
+
+const nsTArray< nsCountedRef<FcPattern> >&
+gfxFontconfigUtils::GetFontsForLang(const FcChar8 *aLang)
+{
+    LangSupportEntry *entry = GetLangSupportEntry(aLang, PR_TRUE);
+    if (!entry)
+        return mEmptyPatternArray;
+
+    return entry->mFonts;
 }
 
 PRBool
 gfxFontNameList::Exists(nsAString& aName) {
     for (PRUint32 i = 0; i < Length(); i++) {
         if (aName.Equals(ElementAt(i)))
             return PR_TRUE;
     }
     return PR_FALSE;
 }
-
diff -r a4343d61f6ee gfx/thebes/src/gfxFontconfigUtils.h
--- a/gfx/thebes/src/gfxFontconfigUtils.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/gfx/thebes/src/gfxFontconfigUtils.h	Sat Nov 15 19:43:13 2008 -0500
@@ -15,16 +15,17 @@
  * The Original Code is Mozilla Japan code.
  *
  * The Initial Developer of the Original Code is Mozilla Japan.
  * Portions created by the Initial Developer are Copyright (C) 2007
  * the Initial Developer. All Rights Reserved.
  *
  * Contributor(s):
  *   Masayuki Nakano <masayuki@d-toybox.com>
+ *   Karl Tomlinson <karlt+@karlt.net>, Mozilla Corporation
  *
  * Alternatively, the contents of this file may be used under the terms of
  * either the GNU General Public License Version 2 or later (the "GPL"), or
  * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
  * in which case the provisions of the GPL or the LGPL are applicable instead
  * of those above. If you wish to allow use of your version of this file only
  * under the terms of either the GPL or the LGPL, and not to allow others to
  * use your version of this file under the terms of the MPL, indicate your
@@ -35,25 +36,50 @@
  *
  * ***** END LICENSE BLOCK ***** */
 
 #ifndef GFX_FONTCONFIG_UTILS_H
 #define GFX_FONTCONFIG_UTILS_H
 
 #include "gfxPlatform.h"
 
+#include "nsAutoRef.h"
 #include "nsTArray.h"
-#include "nsDataHashtable.h"
+#include "nsTHashtable.h"
 
 #include <fontconfig/fontconfig.h>
+
+
+NS_SPECIALIZE_TEMPLATE
+class nsAutoRefTraits<FcPattern> : public nsPointerRefTraits<FcPattern>
+{
+public:
+    static void Release(FcPattern *ptr) { FcPatternDestroy(ptr); }
+    static void AddRef(FcPattern *ptr) { FcPatternReference(ptr); }
+};
+
+NS_SPECIALIZE_TEMPLATE
+class nsAutoRefTraits<FcFontSet> : public nsPointerRefTraits<FcFontSet>
+{
+public:
+    static void Release(FcFontSet *ptr) { FcFontSetDestroy(ptr); }
+};
+
+NS_SPECIALIZE_TEMPLATE
+class nsAutoRefTraits<FcCharSet> : public nsPointerRefTraits<FcCharSet>
+{
+public:
+    static void Release(FcCharSet *ptr) { FcCharSetDestroy(ptr); }
+};
+
 
 class gfxFontNameList : public nsTArray<nsString>
 {
 public:
-    THEBES_INLINE_DECL_REFCOUNTING(gfxFontList)
+    THEBES_INLINE_DECL_REFCOUNTING(gfxFontNameList)
     PRBool Exists(nsAString& aName);
 };
 
 class gfxFontconfigUtils {
 public:
     gfxFontconfigUtils();
 
     static gfxFontconfigUtils* GetFontconfigUtils() {
@@ -71,41 +97,185 @@ public:
     nsresult UpdateFontList();
 
     nsresult ResolveFontName(const nsAString& aFontName,
                              gfxPlatform::FontResolverCallback aCallback,
                              void *aClosure, PRBool& aAborted);
 
     nsresult GetStandardFamilyName(const nsAString& aFontName, nsAString& aFamilyName);
 
+    const nsTArray< nsCountedRef<FcPattern> >&
+    GetFontsForFamily(const FcChar8 *aFamilyName);
+
+    // Returns the best support that any font offers for |aLang|. 
+    FcLangResult GetBestLangSupport(const FcChar8 *aLang);
+    // Returns the fonts offering this best level of support.
+    const nsTArray< nsCountedRef<FcPattern> >&
+    GetFontsForLang(const FcChar8 *aLang);
+
+    // Retuns the language support for a fontconfig font pattern
+    static FcLangResult GetLangSupport(FcPattern *aFont, const FcChar8 *aLang);
+
+    // Conversions between FcChar8*, which is unsigned char*,
+    // and (signed) char*, that check the type of the argument.
+    static const FcChar8 *ToFcChar8(const char *aCharPtr)
+    {
+        return reinterpret_cast<const FcChar8*>(aCharPtr);
+    }
+    static const char *ToCString(const FcChar8 *aChar8Ptr)
+    {
+        return reinterpret_cast<const char*>(aChar8Ptr);
+    }
+
     static PRUint8 GetThebesStyle(FcPattern *aPattern); // slant
     static PRUint16 GetThebesWeight(FcPattern *aPattern);
+
+    static int GetFcSlant(const gfxFontStyle& aFontStyle);
+    // Returns a precise FC_WEIGHT from CSS weight |aBaseWeight|.
+    static int FcWeightForBaseWeight(PRInt8 aBaseWeight);
+
+    // This doesn't consider which faces exist, and so initializes the pattern
+    // using a guessed weight, and doesn't consider sizeAdjust.
+    static nsReturnRef<FcPattern>
+    NewPattern(const nsStringArray& aFamilies, const gfxFontStyle& aFontStyle,
+               const char *aLang);
 
     /**
      * @param aLangGroup [in] a Mozilla langGroup.
      * @param aFcLang [out] returns a language suitable for fontconfig
      *        matching |aLangGroup| or an empty string if no match is found.
      */
     static void GetSampleLangForGroup(const nsACString& aLangGroup,
                                       nsACString *aFcLang);
 
 protected:
+    // Base class for hash table entries with case-insensitive FcChar8
+    // string keys.
+    class FcStrEntryBase : public PLDHashEntryHdr {
+    public:
+        typedef const FcChar8 *KeyType;
+        typedef const FcChar8 *KeyTypePointer;
+
+        static KeyTypePointer KeyToPointer(KeyType aKey) { return aKey; }
+        // Case-insensitive hash.
+        //
+        // fontconfig always ignores case of ASCII characters in family
+        // names and languages, but treatment of whitespace in families is
+        // not consistent.  FcFontSort and FcFontMatch ignore whitespace
+        // except for whitespace in the first character, while FcFontList
+        // and config subsitution tests require whitespace to match
+        // exactly.  CSS 2.1 implies that whitespace is important in the
+        // font-family property.  FcStrCmpIgnoreCase considers whitespace
+        // important.
+        static PLDHashNumber HashKey(const FcChar8 *aKey) {
+            PRUint32 hash = 0;
+            for (const FcChar8 *c = aKey; *c != '\0'; ++c) {
+                hash = PR_ROTATE_LEFT32(hash, 3) ^ FcToLower(*c);
+            }
+            return hash;
+        }
+        enum { ALLOW_MEMMOVE = PR_TRUE };
+    };
+
+public:
+    // Hash entry with a dependent const FcChar8* pointer to an external
+    // string for a key (and no data).  The user must ensure that the string
+    // associated with the pointer is not destroyed.  This entry type is
+    // useful for family name keys as the family name string is held in the
+    // font pattern.
+    class DepFcStrEntry : public FcStrEntryBase {
+    public:
+        // When constructing a new entry in the hashtable, the key is left
+        // blank.  The caller of PutEntry() must fill in mKey when NULL.  This
+        // provides a mechanism for the caller of PutEntry() to determine
+        // whether the entry has been initialized.
+        DepFcStrEntry(KeyTypePointer aName)
+            : mKey(NULL) { }
+
+        DepFcStrEntry(const DepFcStrEntry& toCopy)
+            : mKey(toCopy.mKey) { }
+
+        PRBool KeyEquals(KeyTypePointer aKey) const {
+            return FcStrCmpIgnoreCase(aKey, mKey) == 0;
+        }
+
+        const FcChar8 *mKey;
+    };
+
+    // Hash entry that uses a copy of an FcChar8 string to store the key.
+    // This entry type is useful for language keys, as languages are usually
+    // not stored as strings in font patterns.
+    class CopiedFcStrEntry : public FcStrEntryBase {
+    public:
+        // When constructing a new entry in the hashtable, the key is void.
+        // The caller of PutEntry() must call InitKey() when IsKeyInitialized()
+        // returns false.  This provides a mechanism for the caller of
+        // PutEntry() to determine whether the entry has been initialized.
+        CopiedFcStrEntry(KeyTypePointer aName) {
+            mKey.SetIsVoid(PR_TRUE);
+        }
+
+        CopiedFcStrEntry(const CopiedFcStrEntry& toCopy)
+            : mKey(toCopy.mKey) { }
+
+        PRBool KeyEquals(KeyTypePointer aKey) const {
+            return FcStrCmpIgnoreCase(aKey, ToFcChar8(mKey.get())) == 0;
+        }
+
+        PRBool IsKeyInitialized() { return !mKey.IsVoid(); }
+        void InitKey(const FcChar8* aKey) { mKey.Assign(ToCString(aKey)); }
+
+    private:
+        nsCString mKey;
+    };
+
+protected:
+    class FontsByFcStrEntry : public DepFcStrEntry {
+    public:
+        FontsByFcStrEntry(KeyTypePointer aName)
+            : DepFcStrEntry(aName) { }
+
+        FontsByFcStrEntry(const FontsByFcStrEntry& toCopy)
+            : DepFcStrEntry(toCopy), mFonts(toCopy.mFonts) { }
+
+        PRBool AddFont(FcPattern *aFont) {
+            return mFonts.AppendElement(aFont) != nsnull;
+        }
+        const nsTArray< nsCountedRef<FcPattern> >& GetFonts() {
+            return mFonts;
+        }
+    private:
+        nsTArray< nsCountedRef<FcPattern> > mFonts;
+    };
+
+    class LangSupportEntry : public CopiedFcStrEntry {
+    public:
+        LangSupportEntry(KeyTypePointer aName)
+            : CopiedFcStrEntry(aName) { }
+
+        LangSupportEntry(const LangSupportEntry& toCopy)
+            : CopiedFcStrEntry(toCopy), mSupport(toCopy.mSupport) { }
+
+        FcLangResult mSupport;
+        nsTArray< nsCountedRef<FcPattern> > mFonts;
+    };
+
     static gfxFontconfigUtils* sUtils;
 
-    PRInt32 IsExistingFont(const nsACString& aFontName);
-    nsresult GetResolvedFonts(const nsACString& aName,
-                              gfxFontNameList* aResult);
+    PRBool IsExistingFamily(const nsCString& aFamilyName);
 
     nsresult GetFontListInternal(nsCStringArray& aListOfFonts,
-                                 const nsACString *aLangGroup = nsnull);
+                                 const nsACString& aLangGroup);
     nsresult UpdateFontListInternal(PRBool aForce = PR_FALSE);
 
-    nsCStringArray mFonts;
-    nsCStringArray mNonExistingFonts;
-    nsCStringArray mAliasForSingleFont;
+    LangSupportEntry *GetLangSupportEntry(const FcChar8 *aLang,
+                                          PRBool aWithFonts);
+
+    nsTHashtable<FontsByFcStrEntry> mFontsByFamily;
+    nsTHashtable<LangSupportEntry> mLangSupportTable;
+    const nsTArray< nsCountedRef<FcPattern> > mEmptyPatternArray;
+
     nsCStringArray mAliasForMultiFonts;
-
-    nsDataHashtable<nsCStringHashKey, nsRefPtr<gfxFontNameList> > mAliasTable;
 
     FcConfig *mLastConfig;
 };
 
 #endif /* GFX_FONTCONFIG_UTILS_H */
diff -r a4343d61f6ee gfx/thebes/src/gfxPangoFonts.cpp
--- a/gfx/thebes/src/gfxPangoFonts.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/gfx/thebes/src/gfxPangoFonts.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -44,16 +44,18 @@
 
 #define PANGO_ENABLE_BACKEND
 
 #include "prtypes.h"
 #include "prlink.h"
 #include "gfxTypes.h"
 
 #include "nsMathUtils.h"
+#include "nsServiceManagerUtils.h"
+#include "nsILanguageAtomService.h"
 
 #include "gfxContext.h"
 #include "gfxPlatformGtk.h"
 #include "gfxPangoFonts.h"
 #include "gfxFontconfigUtils.h"
 
 #include <freetype/tttables.h>
 
@@ -83,23 +85,38 @@
 #define IS_MISSING_GLYPH(g) ((g) & PANGO_GLYPH_UNKNOWN_FLAG)
 #define IS_EMPTY_GLYPH(g) ((g) == PANGO_GLYPH_EMPTY)
 
 // Same as pango_units_from_double from Pango 1.16 (but not in older versions)
 int moz_pango_units_from_double(double d) {
     return NS_lround(d * FLOAT_PANGO_SCALE);
 }
 
-static PangoLanguage *GetPangoLanguage(const nsACString& aLangGroup);
+static PangoLanguage *GuessPangoLanguage(const nsACString& aLangGroup);
 
 static cairo_scaled_font_t *CreateScaledFont(FcPattern *aPattern);
 
-/* static */ gfxPangoFontCache* gfxPangoFontCache::sPangoFontCache = nsnull;
+static PangoFontMap *gPangoFontMap;
+static PangoFontMap *GetPangoFontMap();
 
-static PangoFontMap *gPangoFontMap;
+static nsILanguageAtomService* gLangService;
+
+NS_SPECIALIZE_TEMPLATE
+class nsAutoRefTraits<PangoFont> : public gfxGObjectRefTraits<PangoFont> { };
+
+// stub class until fuller implementation is flushed out
+class gfxPangoFontEntry : public gfxFontEntry {
+public:
+    gfxPangoFontEntry(const nsAString& aName)
+        : gfxFontEntry(aName)
+    { }
+
+    ~gfxPangoFontEntry() {}
+        
+};
 
 /*
  * gfxFcFont
  *
  * This is a gfxFont implementation using a CAIRO_FONT_TYPE_FT
  * cairo_scaled_font created from an FcPattern.
  */
 
@@ -168,16 +185,20 @@ private:
     FT_Face mFace;
 };
 
 /**
  * gfxPangoFcFont:
  *
  * An implementation of PangoFcFont that wraps a gfxFont so that it can be
  * passed to PangoRenderFc shapers.
+ *
+ * Many of these will be created for pango_itemize, but most will only be
+ * tested for coverage of individual characters (and sometimes not even that).
+ * Therefore the gfxFont is only constructed if and when needed.
  */
 
 #define GFX_TYPE_PANGO_FC_FONT              (gfx_pango_fc_font_get_type())
 #define GFX_PANGO_FC_FONT(object)           (G_TYPE_CHECK_INSTANCE_CAST ((object), GFX_TYPE_PANGO_FC_FONT, gfxPangoFcFont))
 #define GFX_IS_PANGO_FC_FONT(object)        (G_TYPE_CHECK_INSTANCE_TYPE ((object), GFX_TYPE_PANGO_FC_FONT))
 
 /* static */
 GType gfx_pango_fc_font_get_type (void);
@@ -185,23 +206,91 @@ GType gfx_pango_fc_font_get_type (void);
 #define GFX_PANGO_FC_FONT_CLASS(klass)      (G_TYPE_CHECK_CLASS_CAST ((klass), GFX_TYPE_PANGO_FC_FONT, gfxPangoFcFontClass))
 #define GFX_IS_PANGO_FC_FONT_CLASS(klass)   (G_TYPE_CHECK_CLASS_TYPE ((klass), GFX_TYPE_PANGO_FC_FONT))
 #define GFX_PANGO_FC_FONT_GET_CLASS(obj)    (G_TYPE_INSTANCE_GET_CLASS ((obj), GFX_TYPE_PANGO_FC_FONT, gfxPangoFcFontClass))
 
 // This struct is POD so that it can be used as a GObject.
 struct gfxPangoFcFont {
     PangoFcFont parent_instance;
 
+    FcPattern *mRequestedPattern;
     gfxFcFont *mGfxFont;
+
+    static nsReturnRef<PangoFont>
+    NewFont(FcPattern *aRequestedPattern, FcPattern *aFontPattern)
+    {
+        // A pattern is needed for pango_fc_font_finalize.
+        //
+        // Adding a ref to the requested pattern and one of fontconfig's
+        // patterns uses much less memory than using the fully resolved
+        // pattern here, and saves calling FcFontRenderPrepare when the
+        // PangoFont is only tested for character coverage.
+        //
+        // Normally the is_hinted field of the PangoFcFont is set based on the
+        // FC_HINTING property on the pattern at construction, but this
+        // property is not known until after RenderPrepare.  is_hinted is used
+        // by pango_fc_font_kern_glyphs, which is sometimes used by
+        // pango_ot_buffer_output.  is_hinted will be set when the gfxFont is
+        // constructed for PangoFcFont::lock_face.
+        gfxPangoFcFont *font = static_cast<gfxPangoFcFont*>
+            (g_object_new(GFX_TYPE_PANGO_FC_FONT,
+                          "pattern", aFontPattern, NULL));
+
+        // Save the requested pattern for FcFontRenderPrepare.
+        FcPatternReference(aRequestedPattern);
+        font->mRequestedPattern = aRequestedPattern;
+
+        // pango_fc_font::get_coverage wants a FcFontMap.  (PangoFcFontMap
+        // usually sets this after calling PangoFcFontMap::create_font().)
+        PangoFcFont *fc_font = &font->parent_instance;
+        fc_font->fontmap = GetPangoFontMap();
+        g_object_ref(fc_font->fontmap);
+
+        return nsReturnRef<PangoFont>(PANGO_FONT(font));
+    }
 
     static gfxFcFont *GfxFont(gfxPangoFcFont *self)
     {
         if (!self->mGfxFont) {
-            FcPattern *pattern = PANGO_FC_FONT(self)->font_pattern;
-            self->mGfxFont = gfxFcFont::GetOrMakeFont(pattern).get();
+            PangoFcFont *fc_font = &self->parent_instance;
+
+            if (NS_LIKELY(self->mRequestedPattern)) {
+                // Created with gfxPangoFcFont::NewFont()
+                nsAutoRef<FcPattern> renderPattern
+                    (FcFontRenderPrepare(NULL, self->mRequestedPattern,
+                                         fc_font->font_pattern));
+                if (!renderPattern)
+                    return nsnull;
+
+                FcBool hinting = FcTrue;
+                FcPatternGetBool(renderPattern, FC_HINTING, 0, &hinting);
+                fc_font->is_hinted = hinting;
+
+                // is_transformed does not appear to be used anywhere but looks
+                // like it should be set.
+                FcMatrix *matrix;
+                FcResult result = FcPatternGetMatrix(renderPattern,
+                                                     FC_MATRIX, 0, &matrix);
+                fc_font->is_transformed =
+                    result == FcResultMatch &&
+                    (matrix->xy != 0.0 || matrix->yx != 0.0 ||
+                     matrix->xx != 1.0 || matrix->yy != 1.0);
+
+                self->mGfxFont = gfxFcFont::GetOrMakeFont(renderPattern).get();
+                if (self->mGfxFont) {
+                    // Finished with the requested pattern
+                    FcPatternDestroy(self->mRequestedPattern);
+                    self->mRequestedPattern = NULL;
+                }
+
+            } else {
+                // Created with gfxPangoFontMap::create_font()
+                self->mGfxFont =
+                    gfxFcFont::GetOrMakeFont(fc_font->font_pattern).get();
+            }                
         }
         return self->mGfxFont;
     }
 
     static cairo_scaled_font_t *CairoFont(gfxPangoFcFont *self)
     {
         return gfxPangoFcFont::GfxFont(self)->CairoScaledFont();
     }
@@ -209,30 +298,67 @@ struct gfxPangoFcFont {
 
 struct gfxPangoFcFontClass {
     PangoFcFontClass parent_class;
 };
 
 G_DEFINE_TYPE (gfxPangoFcFont, gfx_pango_fc_font, PANGO_TYPE_FC_FONT)
 
 static void
-gfx_pango_fc_font_init(gfxPangoFcFont *fontset)
+gfx_pango_fc_font_init(gfxPangoFcFont *font)
 {
 }
 
 
 static void
 gfx_pango_fc_font_finalize(GObject *object)
 {
     gfxPangoFcFont *self = GFX_PANGO_FC_FONT(object);
 
-    if (self->mGfxFont)
-        self->mGfxFont->Release();
+    if (self->mRequestedPattern)
+        FcPatternDestroy(self->mRequestedPattern);
+    NS_IF_RELEASE(self->mGfxFont);
+
+    // The parent class removes the reference to parent_instance->fontmap.
 
     G_OBJECT_CLASS(gfx_pango_fc_font_parent_class)->finalize(object);
+}
+
+static PangoFontDescription *
+gfx_pango_fc_font_describe(PangoFont *font)
+{
+    gfxPangoFcFont *self = GFX_PANGO_FC_FONT(font);
+    PangoFcFont *fcFont = &self->parent_instance;
+    PangoFontDescription *result =
+        pango_font_description_copy(fcFont->description);
+
+    gfxFcFont *gfxFont = gfxPangoFcFont::GfxFont(self);
+    if (gfxFont) {
+        double pixelsize = gfxFont->GetStyle()->size;
+        double dpi = gfxPlatformGtk::DPI();
+        gint size = moz_pango_units_from_double(pixelsize * dpi / 72.0);
+        pango_font_description_set_size(result, size);
+    }
+    return result;
+}
+
+static PangoFontDescription *
+gfx_pango_fc_font_describe_absolute(PangoFont *font)
+{
+    gfxPangoFcFont *self = GFX_PANGO_FC_FONT(font);
+    PangoFcFont *fcFont = &self->parent_instance;
+    PangoFontDescription *result =
+        pango_font_description_copy(fcFont->description);
+
+    gfxFcFont *gfxFont = gfxPangoFcFont::GfxFont(self);
+    if (gfxFont) {
+        double size = gfxFont->GetStyle()->size * PANGO_SCALE;
+        pango_font_description_set_absolute_size(result, size);
+    }
+    return result;
 }
 
 static void
 gfx_pango_fc_font_get_glyph_extents(PangoFont *font, PangoGlyph glyph,
                                     PangoRectangle *ink_rect,
                                     PangoRectangle *logical_rect)
 {
     gfxPangoFcFont *self = GFX_PANGO_FC_FONT(font);
@@ -280,26 +406,45 @@ gfx_pango_fc_font_get_glyph_extents(Pang
         ink_rect->height = moz_pango_units_from_double(extents.height);
     }
     if (logical_rect) {
         logical_rect->x = 0;
         logical_rect->width = moz_pango_units_from_double(extents.x_advance);
     }
 }
 
-#ifdef DEBUG
 static PangoFontMetrics *
 gfx_pango_fc_font_get_metrics(PangoFont *font, PangoLanguage *language)
 {
-    NS_WARNING("Using PangoFcFont::get_metrics");
+    gfxPangoFcFont *self = GFX_PANGO_FC_FONT(font);
 
-    return PANGO_FONT_CLASS(gfx_pango_fc_font_parent_class)->
-        get_metrics(font, language);
+    // This uses g_slice_alloc which will abort on OOM rather than return NULL.
+    PangoFontMetrics *result = pango_font_metrics_new();
+
+    gfxFcFont *gfxFont = gfxPangoFcFont::GfxFont(self);
+    if (gfxFont) {
+        const gfxFont::Metrics& metrics = gfxFont->GetMetrics();
+
+        result->ascent = moz_pango_units_from_double(metrics.maxAscent);
+        result->descent = moz_pango_units_from_double(metrics.maxDescent);
+        result->approximate_char_width =
+            moz_pango_units_from_double(metrics.aveCharWidth);
+        result->approximate_digit_width =
+            moz_pango_units_from_double(metrics.zeroOrAveCharWidth);
+        result->underline_position =
+            moz_pango_units_from_double(metrics.underlineOffset);
+        result->underline_thickness =
+            moz_pango_units_from_double(metrics.underlineSize);
+        result->strikethrough_position =
+            moz_pango_units_from_double(metrics.strikeoutOffset);
+        result->strikethrough_thickness =
+            moz_pango_units_from_double(metrics.strikeoutSize);
+    }
+    return result;
 }
-#endif
 
 static FT_Face
 gfx_pango_fc_font_lock_face(PangoFcFont *font)
 {
     gfxPangoFcFont *self = GFX_PANGO_FC_FONT(font);
     return cairo_ft_scaled_font_lock_face(gfxPangoFcFont::CairoFont(self));
 }
 
@@ -317,54 +462,486 @@ gfx_pango_fc_font_class_init (gfxPangoFc
     PangoFontClass *font_class = PANGO_FONT_CLASS (klass);
     PangoFcFontClass *fc_font_class = PANGO_FC_FONT_CLASS (klass);
 
     object_class->finalize = gfx_pango_fc_font_finalize;
 
 #if 0
     // This will need overriding for user fonts to defeat the PangoFcFontMap
     // caching, unless each user font is guaranteed to have a unique filename.
-    font_class->get_coverage =
+    font_class->get_coverage = gfx_pango_fc_font_get_coverage;
 #endif
+    // describe is called on errors in pango_shape.
+    font_class->describe = gfx_pango_fc_font_describe;
     font_class->get_glyph_extents = gfx_pango_fc_font_get_glyph_extents;
-#ifdef DEBUG
-    // non-DEBUG inherits from fc_font_class as this won't be used anyway.
+    // get_metrics and describe_absolute are not likely to be used but
+    //   implemented because the class makes them available.
     font_class->get_metrics = gfx_pango_fc_font_get_metrics;
-#endif
+    font_class->describe_absolute = gfx_pango_fc_font_describe_absolute;
+    // font_class->find_shaper,get_font_map are inherited from PangoFcFontClass
+
     // fc_font_class->has_char,get_glyph are inherited
     fc_font_class->lock_face = gfx_pango_fc_font_lock_face;
     fc_font_class->unlock_face = gfx_pango_fc_font_unlock_face;
 }
 
 /**
- * Recording a base PangoFont on a PangoContext
+ * Recording a gfxPangoFontGroup on a PangoContext
  */
 
-static GQuark GetBaseFontQuark()
+static GQuark GetFontGroupQuark()
 {
     // Not using g_quark_from_static_string() because this module may be
     // unloaded (which would leave a dangling pointer).  Using
     // g_quark_from_string() instead, which creates a small shutdown leak.
-    static GQuark quark = g_quark_from_string("moz-base-font");
+    static GQuark quark = g_quark_from_string("moz-font-group");
     return quark;
 }
 
-static PangoFont *
-GetBaseFont(PangoContext *aContext)
+static void
+gfxFontGroup_unref(gpointer data)
 {
-    return static_cast<PangoFont*>
-        (g_object_get_qdata(G_OBJECT(aContext), GetBaseFontQuark()));
+    gfxPangoFontGroup *fontGroup = static_cast<gfxPangoFontGroup*>(data);
+    NS_RELEASE(fontGroup);
 }
 
 static void
-SetBaseFont(PangoContext *aContext, PangoFont *aBaseFont)
+SetFontGroup(PangoContext *aContext, gfxPangoFontGroup *aFontGroup)
 {
-    g_object_ref(aBaseFont);
-    g_object_set_qdata_full(G_OBJECT(aContext), GetBaseFontQuark(),
-                            aBaseFont, g_object_unref);
+    NS_ADDREF(aFontGroup);
+    g_object_set_qdata_full(G_OBJECT(aContext), GetFontGroupQuark(),
+                            aFontGroup, gfxFontGroup_unref);
+}
+
+static gfxPangoFontGroup *
+GetFontGroup(PangoContext *aContext)
+{
+    return static_cast<gfxPangoFontGroup*>
+        (g_object_get_qdata(G_OBJECT(aContext), GetFontGroupQuark()));
+}
+
+/**
+ * gfxFcPangoFontSet:
+ *
+ * Translation from a desired FcPattern to a sorted set of font references
+ * (fontconfig cache data) and (when needed) PangoFonts.
+ */
+
+class gfxFcPangoFontSet {
+public:
+    THEBES_INLINE_DECL_REFCOUNTING(gfxFcPangoFontSet)
+    
+    explicit gfxFcPangoFontSet(FcPattern *aPattern)
+        : mSortPattern(aPattern),
+          mFcFontSet(SortPreferredFonts()), mFcFontsTrimmed(0),
+          mHaveFallbackFonts(PR_FALSE)
+    {
+    }
+
+    // A reference is held by the FontSet.
+    // The caller may add a ref to keep the font alive longer than the FontSet.
+    PangoFont *GetFontAt(PRUint32 i)
+    {
+        if (i >= mFonts.Length() || !mFonts[i].mFont) { 
+            // GetFontPatternAt sets up mFonts
+            FcPattern *fontPattern = GetFontPatternAt(i);
+            if (!fontPattern)
+                return NULL;
+
+            mFonts[i].mFont =
+                gfxPangoFcFont::NewFont(mSortPattern, fontPattern);
+        }
+        return mFonts[i].mFont;
+    }
+
+    FcPattern *GetFontPatternAt(PRUint32 i);
+
+private:
+    nsReturnRef<FcFontSet> SortPreferredFonts();
+    nsReturnRef<FcFontSet> SortFallbackFonts();
+
+    struct FontEntry {
+        explicit FontEntry(FcPattern *aPattern) : mPattern(aPattern) {}
+        nsCountedRef<FcPattern> mPattern;
+        nsCountedRef<PangoFont> mFont;
+    };
+
+    struct LangSupportEntry {
+        LangSupportEntry(FcChar8 *aLang, FcLangResult aSupport) :
+            mLang(aLang), mBestSupport(aSupport) {}
+        FcChar8 *mLang;
+        FcLangResult mBestSupport;
+    };
+
+public:
+    // public for nsTArray
+    class LangComparator {
+    public:
+        PRBool Equals(const LangSupportEntry& a, const FcChar8 *b) const
+        {
+            return FcStrCmpIgnoreCase(a.mLang, b) == 0;
+        }
+    };
+
+private:
+    // The requested pattern
+    nsCountedRef<FcPattern> mSortPattern;
+    // A (trimmed) list of font patterns and PangoFonts that is built up as
+    // required.
+    nsTArray<FontEntry> mFonts;
+    // Holds a list of font patterns that will be trimmed.  This is first set
+    // to a list of preferred fonts.  Then, if/when all the preferred fonts
+    // have been trimmed and added to mFonts, this is set to a list of
+    // fallback fonts.
+    nsAutoRef<FcFontSet> mFcFontSet;
+    // The set of characters supported by the fonts in mFonts.
+    nsAutoRef<FcCharSet> mCharSet;
+    // The index of the next font in mFcFontSet that has not yet been
+    // considered for mFonts.
+    int mFcFontsTrimmed;
+    // True iff fallback fonts are either stored in mFcFontSet or have been
+    // trimmed and added to mFonts (so that mFcFontSet is NULL).
+    PRPackedBool mHaveFallbackFonts;
+};
+
+typedef FcBool (*FcPatternRemoveFunction)(FcPattern *p, const char *object,
+                                          int id);
+
+static FcPatternRemoveFunction
+GetFcPatternRemove()
+{
+    PRLibrary *lib = nsnull;
+    PRFuncPtr result =
+        PR_FindFunctionSymbolAndLibrary("FcPatternRemove", &lib);
+    if (lib) {
+        PR_UnloadLibrary(lib);
+    }
+
+    return reinterpret_cast<FcPatternRemoveFunction>(result);
+}
+
+// FcPatternRemove is available in fontconfig-2.3.0 (2005)
+// CentOS 5 has fontconfig-2.4.1
+static FcBool
+moz_FcPatternRemove(FcPattern *p, const char *object, int id)
+{
+    static FcPatternRemoveFunction sFcPatternRemovePtr = GetFcPatternRemove();
+
+    if (!sFcPatternRemovePtr)
+        return FcFalse;
+
+    return (*sFcPatternRemovePtr)(p, object, id);
+}
+
+// fontconfig always prefers a matching family to a matching slant, but CSS
+// mostly prioritizes slant.  The logic here is from CSS 2.1.
+static PRBool
+SlantIsAcceptable(FcPattern *aFont, int aRequestedSlant)
+{
+    // CSS accepts (possibly synthetic) oblique for italic.
+    if (aRequestedSlant == FC_SLANT_ITALIC)
+        return PR_TRUE;
+
+    int slant;
+    FcResult result = FcPatternGetInteger(aFont, FC_SLANT, 0, &slant);
+    // Not having a value would be strange.
+    // fontconfig sort and match functions would consider no value a match.
+    if (result != FcResultMatch)
+        return PR_TRUE;
+
+    switch (aRequestedSlant) {
+        case FC_SLANT_ROMAN:
+            // CSS requires an exact match
+            return slant == aRequestedSlant;
+        case FC_SLANT_OBLIQUE:
+            // Accept synthetic oblique from Roman,
+            // but CSS doesn't accept italic.
+            return slant != FC_SLANT_ITALIC;
+    }
+
+    return PR_TRUE;
+}
+
+// fontconfig prefers a matching family or lang to pixelsize of bitmap
+// fonts.  CSS suggests a tolerance of 20% on pixelsize.
+static PRBool
+SizeIsAcceptable(FcPattern *aFont, double aRequestedSize)
+{
+    double size;
+    int v = 0;
+    while (FcPatternGetDouble(aFont,
+                              FC_PIXEL_SIZE, v, &size) == FcResultMatch) {
+        ++v;
+        if (5.0 * fabs(size - aRequestedSize) < aRequestedSize)
+            return PR_TRUE;
+    }
+
+    // No size means scalable
+    return v == 0;
+}
+
+// Sorting only the preferred fonts first usually saves having to sort through
+// every font on the system.
+nsReturnRef<FcFontSet>
+gfxFcPangoFontSet::SortPreferredFonts()
+{
+    gfxFontconfigUtils *utils = gfxFontconfigUtils::GetFontconfigUtils();
+    if (!utils)
+        return nsReturnRef<FcFontSet>();
+
+    // The list of families in mSortPattern has values with both weak and
+    // strong bindings.  Values with strong bindings should be preferred.
+    // Values with weak bindings are default fonts that should be considered
+    // only when the font provides the best support for a requested language
+    // or after other fonts have satisfied all the requested languages.
+    //
+    // There are no direct fontconfig APIs to get the binding type.  The
+    // binding only takes effect in the sort and match functions.
+
+    // |requiredLangs| is a list of requested languages that have not yet been
+    // satisfied.  gfxFontconfigUtils only sets one FC_LANG property value,
+    // but FcConfigSubstitute may add more values (e.g. prepending "en" to
+    // "ja" will use western fonts to render Latin/Arabic numerals in Japanese
+    // text.)
+    nsAutoTArray<LangSupportEntry,10> requiredLangs;
+    for (int v = 0; ; ++v) {
+        FcChar8 *lang;
+        FcResult result = FcPatternGetString(mSortPattern, FC_LANG, v, &lang);
+        if (result != FcResultMatch) {
+            // No need to check FcPatternGetLangSet() because
+            // gfxFontconfigUtils sets only a string value for FC_LANG and
+            // FcConfigSubstitute cannot add LangSets.
+            NS_ASSERTION(result != FcResultTypeMismatch,
+                         "Expected a string for FC_LANG");
+            break;
+        }
+
+        if (!requiredLangs.Contains(lang, LangComparator())) {
+            FcLangResult bestLangSupport = utils->GetBestLangSupport(lang);
+            if (bestLangSupport != FcLangDifferentLang) {
+                requiredLangs.
+                    AppendElement(LangSupportEntry(lang, bestLangSupport));
+            }
+        }
+    }
+
+    nsAutoRef<FcFontSet> fontSet(FcFontSetCreate());
+    if (!fontSet)
+        return fontSet.out();
+
+    // FcDefaultSubstitute() ensures a slant on mSortPattern, but, if that ever
+    // doesn't happen, Roman will be used.
+    int requestedSlant = FC_SLANT_ROMAN;
+    FcPatternGetInteger(mSortPattern, FC_SLANT, 0, &requestedSlant);
+    double requestedSize = -1.0;
+    FcPatternGetDouble(mSortPattern, FC_PIXEL_SIZE, 0, &requestedSize);
+
+    nsTHashtable<gfxFontconfigUtils::DepFcStrEntry> existingFamilies;
+    existingFamilies.Init(50);
+    FcChar8 *family;
+    for (int v = 0;
+         FcPatternGetString(mSortPattern,
+                            FC_FAMILY, v, &family) == FcResultMatch; ++v) {
+        const nsTArray< nsCountedRef<FcPattern> >& familyFonts =
+            utils->GetFontsForFamily(family);
+
+        if (familyFonts.Length() == 0) {
+            // There are no fonts matching this family, so there is not point
+            // in searching for this family in the FontSort.
+            //
+            // Perhaps the original pattern should be retained for
+            // FcFontRenderPrepare.  However, the only a useful config
+            // substitution test against missing families that i can imagine
+            // would only be interested in the preferred family
+            // (qual="first"), so always keep the first family and use the
+            // same pattern for Sort and RenderPrepare.
+            if (v != 0 && moz_FcPatternRemove(mSortPattern, FC_FAMILY, v)) {
+                --v;
+            }
+            continue;
+        }
+
+        // Aliases seem to often end up occurring more than once, but
+        // duplicate families can't be removed from the sort pattern without
+        // knowing whether duplicates have the same binding.
+        gfxFontconfigUtils::DepFcStrEntry *entry =
+            existingFamilies.PutEntry(family);
+        if (entry) {
+            if (entry->mKey) // old entry
+                continue;
+
+            entry->mKey = family; // initialize new entry
+        }
+
+        for (PRUint32 f = 0; f < familyFonts.Length(); ++f) {
+            FcPattern *font = familyFonts[f];
+
+            if (!SlantIsAcceptable(font, requestedSlant))
+                continue;
+            if (requestedSize != -1.0 && !SizeIsAcceptable(font, requestedSize))
+                continue;
+
+            for (PRUint32 r = 0; r < requiredLangs.Length(); ++r) {
+                const LangSupportEntry& entry = requiredLangs[r];
+                FcLangResult support =
+                    gfxFontconfigUtils::GetLangSupport(font, entry.mLang);
+                if (support <= entry.mBestSupport) { // lower is better
+                    requiredLangs.RemoveElementAt(r);
+                    --r;
+                }
+            }
+
+            // FcFontSetDestroy will remove a reference but FcFontSetAdd
+            // does _not_ take a reference!
+            if (FcFontSetAdd(fontSet, font)) {
+                FcPatternReference(font);
+            }
+        }
+    }
+
+    FcPattern *truncateMarker = NULL;
+    for (PRUint32 r = 0; r < requiredLangs.Length(); ++r) {
+        const nsTArray< nsCountedRef<FcPattern> >& langFonts =
+            utils->GetFontsForLang(requiredLangs[r].mLang);
+
+        PRBool haveLangFont = PR_FALSE;
+        for (PRUint32 f = 0; f < langFonts.Length(); ++f) {
+            FcPattern *font = langFonts[f];
+            if (!SlantIsAcceptable(font, requestedSlant))
+                continue;
+            if (requestedSize != -1.0 && !SizeIsAcceptable(font, requestedSize))
+                continue;
+
+            haveLangFont = PR_TRUE;
+            if (FcFontSetAdd(fontSet, font)) {
+                FcPatternReference(font);
+            }
+        }
+
+        if (!haveLangFont && langFonts.Length() > 0) {
+            // There is a font that supports this language but it didn't pass
+            // the slant and size criteria.  Weak default font families should
+            // not be considered until the language has been satisfied.
+            //
+            // Insert a font that supports the language so that it will mark
+            // the position of fonts from weak families in the sorted set and
+            // they can be removed.  The language and weak families will be
+            // considered in the fallback fonts, which use fontconfig's
+            // algorithm.
+            //
+            // Of the fonts that don't meet slant and size criteria, strong
+            // default font families should be considered before (other) fonts
+            // for this language, so this marker font will be removed (as well
+            // as the fonts from weak families), and strong families will be
+            // reconsidered in the fallback fonts.
+            FcPattern *font = langFonts[0];
+            if (FcFontSetAdd(fontSet, font)) {
+                FcPatternReference(font);
+                truncateMarker = font;
+            }
+            break;
+        }
+    }
+
+    FcFontSet *sets[1] = { fontSet };
+    FcResult result;
+    fontSet.own(FcFontSetSort(NULL, sets, 1, mSortPattern,
+                              FcFalse, NULL, &result));
+
+    if (truncateMarker != NULL && fontSet) {
+        nsAutoRef<FcFontSet> truncatedSet(FcFontSetCreate());
+
+        for (int f = 0; f < fontSet->nfont; ++f) {
+            FcPattern *font = fontSet->fonts[f];
+            if (font == truncateMarker)
+                break;
+
+            if (FcFontSetAdd(truncatedSet, font)) {
+                FcPatternReference(font);
+            }
+        }
+
+        fontSet.steal(truncatedSet);
+    }
+
+    return fontSet.out();
+}
+
+nsReturnRef<FcFontSet>
+gfxFcPangoFontSet::SortFallbackFonts()
+{
+    // Setting trim to FcTrue would provide a much smaller (~ 1/10) FcFontSet,
+    // but would take much longer due to comparing all the character sets.
+    //
+    // The references to fonts in this FcFontSet are almost free
+    // as they are pointers into mmaped cache files.
+    //
+    // GetFontPatternAt() will trim lazily if and as needed, which will also
+    // remove duplicates of preferred fonts.
+    FcResult result;
+    return nsReturnRef<FcFontSet>(FcFontSort(NULL, mSortPattern,
+                                             FcFalse, NULL, &result));
+}
+
+// GetFontAt relies on this setting up all patterns up to |i|.
+FcPattern *
+gfxFcPangoFontSet::GetFontPatternAt(PRUint32 i)
+{
+    while (i >= mFonts.Length()) {
+        while (!mFcFontSet) {
+            if (mHaveFallbackFonts)
+                return nsnull;
+
+            mFcFontSet = SortFallbackFonts();
+            mHaveFallbackFonts = PR_TRUE;
+            mFcFontsTrimmed = 0;
+            // Loop to test that mFcFontSet is non-NULL.
+        }
+
+        while (mFcFontsTrimmed < mFcFontSet->nfont) {
+            FcPattern *font = mFcFontSet->fonts[mFcFontsTrimmed];
+            ++mFcFontsTrimmed;
+
+            if (mFonts.Length() != 0) {
+                // See if the next font provides support for any extra
+                // characters.  Most often the next font is not going to
+                // support more characters so check for a SubSet first before
+                // allocating a new CharSet with Union.
+                FcCharSet *supportedChars = mCharSet;
+                if (!supportedChars) {
+                    FcPatternGetCharSet(mFonts[mFonts.Length() - 1].mPattern,
+                                        FC_CHARSET, 0, &supportedChars);
+                }
+
+                if (supportedChars) {
+                    FcCharSet *newChars = NULL;
+                    FcPatternGetCharSet(font, FC_CHARSET, 0, &newChars);
+                    if (newChars) {
+                        if (FcCharSetIsSubset(newChars, supportedChars))
+                            continue;
+
+                        mCharSet.own(FcCharSetUnion(supportedChars, newChars));
+                    } else if (!mCharSet) {
+                        mCharSet.own(FcCharSetCopy(supportedChars));
+                    }
+                }
+            }
+
+            mFonts.AppendElement(font);
+            if (mFonts.Length() >= i)
+                break;
+        }
+
+        if (mFcFontsTrimmed == mFcFontSet->nfont) {
+            // finished with this font set
+            mFcFontSet.reset();
+        }
+    }
+
+    return mFonts[i].mPattern;
 }
 
 /**
  * gfxPangoFontset: An implementation of a PangoFontset for gfxPangoFontMap
  */
 
 #define GFX_TYPE_PANGO_FONTSET              (gfx_pango_fontset_get_type())
 #define GFX_PANGO_FONTSET(object)           (G_TYPE_CHECK_INSTANCE_CAST ((object), GFX_TYPE_PANGO_FONTSET, gfxPangoFontset))
@@ -376,219 +953,234 @@ GType gfx_pango_fontset_get_type (void);
 #define GFX_PANGO_FONTSET_CLASS(klass)      (G_TYPE_CHECK_CLASS_CAST ((klass), GFX_TYPE_PANGO_FONTSET, gfxPangoFontsetClass))
 #define GFX_IS_PANGO_FONTSET_CLASS(klass)   (G_TYPE_CHECK_CLASS_TYPE ((klass), GFX_TYPE_PANGO_FONTSET))
 #define GFX_PANGO_FONTSET_GET_CLASS(obj)    (G_TYPE_INSTANCE_GET_CLASS ((obj), GFX_TYPE_PANGO_FONTSET, gfxPangoFontsetClass))
 
 // This struct is POD so that it can be used as a GObject.
 struct gfxPangoFontset {
     PangoFontset parent_instance;
 
-    PangoFontMap *mFontMap;
-    PangoContext *mContext;
-    PangoFontDescription *mFontDesc;
     PangoLanguage *mLanguage;
+    gfxFcPangoFontSet *mGfxFontSet;
     PangoFont *mBaseFont;
-    PangoFontset *mFallbackFontset;
+    gfxPangoFontGroup *mFontGroup;
 
     static PangoFontset *
-    NewFontset(PangoFontMap *aFontMap,
-               PangoContext *aContext,
-               const PangoFontDescription *aFontDesc,
+    NewFontset(gfxPangoFontGroup *aFontGroup,
                PangoLanguage *aLanguage)
     {
         gfxPangoFontset *fontset = static_cast<gfxPangoFontset *>
             (g_object_new(GFX_TYPE_PANGO_FONTSET, NULL));
 
-        fontset->mFontMap = aFontMap;
-        g_object_ref(aFontMap);
-
-        fontset->mContext = aContext;
-        g_object_ref(aContext);
-
-        fontset->mFontDesc = pango_font_description_copy(aFontDesc);
         fontset->mLanguage = aLanguage;
 
-        fontset->mBaseFont = GetBaseFont(aContext);
-        if(fontset->mBaseFont)
-            g_object_ref(fontset->mBaseFont);
+        // Use the font group's fontset if the language matches
+        if (aFontGroup->GetPangoLanguage() == aLanguage) {
+            fontset->mGfxFontSet = aFontGroup->GetFontSet();
+            NS_IF_ADDREF(fontset->mGfxFontSet);
+
+        } else {
+            // Otherwise, fallback fonts depend on the language so get
+            // another font-set for the language if/when the base font is
+            // not suitable.  Save the font group for this.
+            fontset->mFontGroup = aFontGroup;
+            NS_ADDREF(fontset->mFontGroup);
+
+            // Using the same base font irrespective of the language that
+            // Pango chooses for the script means that PANGO_SCRIPT_COMMON
+            // characters are consistently rendered with the same font.
+            // (Bug 339513 and bug 416725).
+            //
+            // However, use the default Pango behavior (selecting generic
+            // fonts from the script of the characters) in two situations:
+            //
+            //   1. When we don't have a language to make a good choice for
+            //      the primary font.
+            //
+            //   2. For system fonts, use the default Pango behavior to give
+            //      consistency with other apps.  (This probably wouldn't be
+            //      necessary but for bug 91190.)
+            if (aFontGroup->GetPangoLanguage() &&
+                !aFontGroup->GetStyle()->systemFont) {
+                fontset->mBaseFont = aFontGroup->GetBasePangoFont();
+                if (fontset->mBaseFont)
+                    g_object_ref(fontset->mBaseFont);
+            }
+        }
 
         return PANGO_FONTSET(fontset);
     }
 };
 
 struct gfxPangoFontsetClass {
     PangoFontsetClass parent_class;
 };
 
 G_DEFINE_TYPE (gfxPangoFontset, gfx_pango_fontset, PANGO_TYPE_FONTSET)
 
 static void
 gfx_pango_fontset_init(gfxPangoFontset *fontset)
 {
 }
 
-
 static void
 gfx_pango_fontset_finalize(GObject *object)
 {
     gfxPangoFontset *self = GFX_PANGO_FONTSET(object);
 
-    if (self->mContext)
-        g_object_unref(self->mContext);
-    if (self->mFontDesc)
-        pango_font_description_free(self->mFontDesc);
     if (self->mBaseFont)
         g_object_unref(self->mBaseFont);
-    if (self->mFontMap)
-        g_object_unref(self->mFontMap);
-    if (self->mFallbackFontset)
-        g_object_unref(self->mFallbackFontset);
+    NS_IF_RELEASE(self->mGfxFontSet);
+    NS_IF_RELEASE(self->mFontGroup);
 
     G_OBJECT_CLASS(gfx_pango_fontset_parent_class)->finalize(object);
 }
 
 static PangoLanguage *
 gfx_pango_fontset_get_language(PangoFontset *fontset)
 {
     gfxPangoFontset *self = GFX_PANGO_FONTSET(fontset);
     return self->mLanguage;
 }
 
-struct ForeachExceptBaseData {
-    PangoFont *mBaseFont;
-    PangoFontset *mFontset;
-    PangoFontsetForeachFunc mFunc;
-    gpointer mData;
-};
+static gfxFcPangoFontSet *
+GetGfxFontSet(gfxPangoFontset *self)
+{
+    if (!self->mGfxFontSet && self->mFontGroup) {
+        self->mGfxFontSet = self->mFontGroup->GetFontSet(self->mLanguage);
+        // Finished with the font group
+        NS_RELEASE(self->mFontGroup);
 
-static gboolean
-foreach_except_base_cb(PangoFontset *fontset, PangoFont *font, gpointer data)
-{
-    ForeachExceptBaseData *baseData =
-        static_cast<ForeachExceptBaseData *>(data);
-    
-    // returning false means continue with the other fonts in the set
-    return font != baseData->mBaseFont &&
-        (*baseData->mFunc)(baseData->mFontset, font, baseData->mData);
-}
+        if (!self->mGfxFontSet)
+            return nsnull;
 
-static PangoFontset *
-gfx_pango_font_map_load_fallback_fontset(PangoFontMap *fontmap,
-                                         PangoContext *context,
-                                         const PangoFontDescription *desc,
-                                         PangoLanguage *language);
-
-static PangoFontset *
-EnsureFallbackFontset(gfxPangoFontset *self)
-{
-    if (!self->mFallbackFontset) {
-        // To consider:
-        //
-        // * If this is happening often (e.g. Chinese/Japanese pages where a
-        //   Latin font is specified first), and Pango's 64-entry pattern
-        //   cache is not large enough, then a fontset cache here could be
-        //   helpful.  Ideally we'd only cache the fonts that are actually
-        //   accessed rather than all the fonts from the FcFontSort.
-        //
-        // * Mozilla's langGroup font prefs could be used to specify preferred
-        //   fallback fonts for the script of the characters (as indicated by
-        //   Pango in mLanguage), by doing the conversion from gfxFontGroup
-        //   "families" to PangoFcFontMap "family" here.
-        self->mFallbackFontset =
-            gfx_pango_font_map_load_fallback_fontset(self->mFontMap,
-                                                     self->mContext,
-                                                     self->mFontDesc,
-                                                     self->mLanguage);
+        NS_ADDREF(self->mGfxFontSet);
     }
-    return self->mFallbackFontset;
+    return self->mGfxFontSet;
 }
 
 static void
 gfx_pango_fontset_foreach(PangoFontset *fontset, PangoFontsetForeachFunc func,
                           gpointer data)
 {
     gfxPangoFontset *self = GFX_PANGO_FONTSET(fontset);
 
-    if (self->mBaseFont && (*func)(fontset, self->mBaseFont, data))
+    FcPattern *baseFontPattern = NULL;
+    if (self->mBaseFont) {
+        if ((*func)(fontset, self->mBaseFont, data))
+            return;
+
+        baseFontPattern = PANGO_FC_FONT(self->mBaseFont)->font_pattern;
+    }        
+
+    // Falling back to secondary fonts
+    gfxFcPangoFontSet *gfxFontSet = GetGfxFontSet(self);
+    if (!gfxFontSet)
         return;
 
-    // Falling back to secondary fonts
-    PangoFontset *childFontset = EnsureFallbackFontset(self);
-    ForeachExceptBaseData baseData = { self->mBaseFont, fontset, func, data };
-    pango_fontset_foreach(childFontset, foreach_except_base_cb, &baseData);
+    for (PRUint32 i = 0;
+         FcPattern *pattern = gfxFontSet->GetFontPatternAt(i);
+         ++i) {
+        // Skip this font if it is the same face as the base font
+        if (pattern == baseFontPattern) {
+            continue;
+        }
+        PangoFont *font = gfxFontSet->GetFontAt(i);
+        if (font) {
+            if ((*func)(fontset, font, data))
+                return;
+        }
+    }
+}
+
+static PRBool HasChar(FcPattern *aFont, FcChar32 wc)
+{
+    FcCharSet *charset = NULL;
+    FcPatternGetCharSet(aFont, FC_CHARSET, 0, &charset);
+
+    return charset && FcCharSetHasChar(charset, wc);
 }
 
 static PangoFont *
 gfx_pango_fontset_get_font(PangoFontset *fontset, guint wc)
 {
     gfxPangoFontset *self = GFX_PANGO_FONTSET(fontset);
 
-    PangoCoverageLevel baseLevel = PANGO_COVERAGE_NONE;
+    PangoFont *result = NULL;
+
+    FcPattern *baseFontPattern = NULL;
     if (self->mBaseFont) {
-        // PangoFcFontMap caches this:
-        PangoCoverage *coverage =
-            pango_font_get_coverage(self->mBaseFont, self->mLanguage);
-        if (coverage) {
-            baseLevel = pango_coverage_get(coverage, wc);
-            pango_coverage_unref(coverage);
+        baseFontPattern = PANGO_FC_FONT(self->mBaseFont)->font_pattern;
+
+        if (HasChar(baseFontPattern, wc)) {
+            result = self->mBaseFont;
         }
     }
 
-    if (baseLevel != PANGO_COVERAGE_EXACT) {
-        PangoFontset *childFontset = EnsureFallbackFontset(self);
-        PangoFont *childFont = pango_fontset_get_font(childFontset, wc);
-        if (!self->mBaseFont || childFont == self->mBaseFont)
-            return childFont;
+    if (!result) {
+        // Falling back to secondary fonts
+        gfxFcPangoFontSet *gfxFontSet = GetGfxFontSet(self);
 
-        if (childFont) {
-            PangoCoverage *coverage =
-                pango_font_get_coverage(childFont, self->mLanguage);
-            if (coverage) {
-                PangoCoverageLevel childLevel =
-                    pango_coverage_get(coverage, wc);
-                pango_coverage_unref(coverage);
+        if (gfxFontSet) {
+            for (PRUint32 i = 0;
+                 FcPattern *pattern = gfxFontSet->GetFontPatternAt(i);
+                 ++i) {
+                // Skip this font if it is the same face as the base font
+                if (pattern == baseFontPattern) {
+                    continue;
+                }
 
-                // Only use the child font if better than the base font.
-                if (childLevel > baseLevel)
-                    return childFont;
+                if (HasChar(pattern, wc)) {
+                    result = gfxFontSet->GetFontAt(i);
+                    break;
+                }
             }
-            g_object_unref(childFont);
+        }
+
+        if (!result) {
+            // Nothing found.  Return the first font.
+            if (self->mBaseFont) {
+                result = self->mBaseFont;
+            } else if (gfxFontSet) {
+                result = gfxFontSet->GetFontAt(0);
+            }
         }
     }
 
-    g_object_ref(self->mBaseFont);
-    return self->mBaseFont;
+    if (!result)
+        return NULL;
+
+    g_object_ref(result);
+    return result;
 }
 
 static void
 gfx_pango_fontset_class_init (gfxPangoFontsetClass *klass)
 {
     GObjectClass *object_class = G_OBJECT_CLASS (klass);
     PangoFontsetClass *fontset_class = PANGO_FONTSET_CLASS (klass);
 
     object_class->finalize = gfx_pango_fontset_finalize;
+    // get_font is not likely to be used but implemented because the class
+    //   makes it available.
     fontset_class->get_font = gfx_pango_fontset_get_font;
-    // inherit fontset_class->get_metrics (which won't be used anyway)
+    // inherit fontset_class->get_metrics (which is not likely to be used)
     fontset_class->get_language = gfx_pango_fontset_get_language;
     fontset_class->foreach = gfx_pango_fontset_foreach;
 }
 
 /**
  * gfxPangoFontMap: An implementation of a PangoFontMap.
  *
- * This allows the primary (base) font to be specified.  There are two
- * advantages to this:
+ * This is passed to pango_itemize() through the PangoContext parameter, and
+ * provides font selection through the gfxPangoFontGroup.
  *
- * 1. Always using the same base font irrespective of the language that Pango
- *    chooses for the script means that PANGO_SCRIPT_COMMON characters are
- *    consistently rendered with the same font.  (Bug 339513 and bug 416725)
- *
- * 2. We normally have the base font from the gfxFont cache so this saves a
- *    FcFontSort when the entry has expired from Pango's much smaller pattern
- *    cache.
+ * It is intended that the font group is recorded on the PangoContext with
+ * SetFontGroup().  The font group is then queried for fonts, with
+ * gfxFcPangoFontSet doing the font selection.
  */
 
 #define GFX_TYPE_PANGO_FONT_MAP              (gfx_pango_font_map_get_type())
 #define GFX_PANGO_FONT_MAP(object)           (G_TYPE_CHECK_INSTANCE_CAST ((object), GFX_TYPE_PANGO_FONT_MAP, gfxPangoFontMap))
 #define GFX_IS_PANGO_FONT_MAP(object)        (G_TYPE_CHECK_INSTANCE_TYPE ((object), GFX_TYPE_PANGO_FONT_MAP))
 
 GType gfx_pango_font_map_get_type (void);
 
@@ -621,136 +1213,124 @@ gfx_pango_font_map_init(gfxPangoFontMap 
 gfx_pango_font_map_init(gfxPangoFontMap *fontset)
 {
 }
 
 static PangoFont *
 gfx_pango_font_map_load_font(PangoFontMap *fontmap, PangoContext *context,
                              const PangoFontDescription *description)
 {
-    PangoFont *baseFont = GetBaseFont(context);
-    if (baseFont) {
+    gfxPangoFontGroup *fontGroup = GetFontGroup(context);
+    if (NS_UNLIKELY(!fontGroup)) {
+        return PANGO_FONT_MAP_CLASS(gfx_pango_font_map_parent_class)->
+            load_font(fontmap, context, description);
+    }
+        
+    PangoFont *baseFont = fontGroup->GetBasePangoFont();
+    if (NS_LIKELY(baseFont)) {
         g_object_ref(baseFont);
-        return baseFont;
     }
-
-    return PANGO_FONT_MAP_CLASS(gfx_pango_font_map_parent_class)->
-        load_font(fontmap, context, description);
+    return baseFont;
 }
 
 static PangoFontset *
 gfx_pango_font_map_load_fontset(PangoFontMap *fontmap, PangoContext *context,
-                               const PangoFontDescription *desc,
-                               PangoLanguage *language)
+                                const PangoFontDescription *desc,
+                                PangoLanguage *language)
 {
-    return gfxPangoFontset::NewFontset(fontmap, context, desc, language);
-}
+    gfxPangoFontGroup *fontGroup = GetFontGroup(context);
+    if (NS_UNLIKELY(!fontGroup)) {
+        return PANGO_FONT_MAP_CLASS(gfx_pango_font_map_parent_class)->
+            load_fontset(fontmap, context, desc, language);
+    }
 
-static PangoFontset *
-gfx_pango_font_map_load_fallback_fontset(PangoFontMap *fontmap,
-                                         PangoContext *context,
-                                         const PangoFontDescription *desc,
-                                         PangoLanguage *language)
-{
-    return PANGO_FONT_MAP_CLASS(gfx_pango_font_map_parent_class)->
-        load_fontset(fontmap, context, desc, language);
-}
-
-static void
-gfx_pango_font_map_list_families(PangoFontMap *fontmap,
-                                 PangoFontFamily ***families, int *n_families)
-{
-    return PANGO_FONT_MAP_CLASS(gfx_pango_font_map_parent_class)->
-        list_families(fontmap, families, n_families);
+    return gfxPangoFontset::NewFontset(fontGroup, language);
 }
 
 static double
 gfx_pango_font_map_get_resolution(PangoFcFontMap *fcfontmap,
                                   PangoContext *context)
 {
     // This merely enables the FC_SIZE field of the pattern to be accurate.
     // We use gfxPlatformGtk::DPI() much of the time...
     return gfxPlatformGtk::DPI();
 }
 
+// Apply user settings and defaults to pattern in preparation for matching.
+static void
+PrepareSortPattern(FcPattern *aPattern, double aFallbackSize,
+                   double aSizeAdjustFactor)
+{
+    FcConfigSubstitute(NULL, aPattern, FcMatchPattern);
+
+    // This gets cairo_font_options_t for the Screen.  We should have
+    // different font options for printing (no hinting) but we are not told
+    // what we are measuring for.
+    //
+    // If cairo adds support for lcd_filter, gdk will not provide the default
+    // setting for that option.  We could get the default setting by creating
+    // an xlib surface once, recording its font_options, and then merging the
+    // gdk options.
+    const cairo_font_options_t *options =
+        gdk_screen_get_font_options(gdk_screen_get_default());
+
+    cairo_ft_font_options_substitute(options, aPattern);
+
+    // Protect against any fontconfig settings that may have incorrectly
+    // modified the pixelsize, and consider aSizeAdjustFactor.
+    double size = aFallbackSize;
+    if (FcPatternGetDouble(aPattern, FC_PIXEL_SIZE, 0, &size) != FcResultMatch
+        || aSizeAdjustFactor != 1.0) {
+        FcPatternDel(aPattern, FC_PIXEL_SIZE);
+        FcPatternAddDouble(aPattern, FC_PIXEL_SIZE, size * aSizeAdjustFactor);
+    }
+
+    FcDefaultSubstitute(aPattern);
+}
+
 static void
 gfx_pango_font_map_context_substitute(PangoFcFontMap *fontmap,
                                       PangoContext *context,
                                       FcPattern *pattern)
 {
-    FcConfigSubstitute(NULL, pattern, FcMatchPattern);
-
-    // XXXkt This gets cairo_font_options_t for the Screen.  We should have
-    // different font options for printing (no hinting) but we are not told
-    // what we are measuring for.
-    const cairo_font_options_t *options =
-        gdk_screen_get_font_options(gdk_screen_get_default());
-
-    cairo_ft_font_options_substitute(options, pattern);
-
-    FcDefaultSubstitute(pattern);
+    // owned by the context
+    PangoFontDescription *desc = pango_context_get_font_description(context);
+    double size = pango_font_description_get_size(desc) / FLOAT_PANGO_SCALE;
+    PrepareSortPattern(pattern, size, 1.0);
 }
 
 static PangoFcFont *
 gfx_pango_font_map_create_font(PangoFcFontMap *fontmap,
                                PangoContext *context,
                                const PangoFontDescription *desc,
                                FcPattern *pattern)
 {
-    // A pattern is needed for pango_fc_font_finalize.
-    //
-    // Adding a ref to one of fontconfig's patterns would use much less memory
-    // than using the fully resolved pattern here.  This could be done by
-    // setting the PangoFcFont field is_hinted directly.  (is_hinted is used
-    // by pango_fc_font_kern_glyphs, which is sometimes used by
-    // pango_ot_buffer_output.)  is_transformed is not used but maybe it
-    // should be set too.  describe_absolute would need to be overridden if
-    // required, and description would need to be set if describe is required
-    // but not overridden.
-    //
-    // An alternative memory-saving effort might remove elements from the
-    // resolved pattern that are unnecessary.
-
-    // Protect against any fontconfig settings that may have incorrectly
-    // modified the pixelsize.
-    PRBool newPattern = PR_FALSE;
-    double size;
-    if (FcPatternGetDouble(pattern, FC_PIXEL_SIZE, 0, &size) != FcResultMatch) {
-        size = pango_font_description_get_size(desc) / FLOAT_PANGO_SCALE;
-        pattern = FcPatternDuplicate(pattern);
-        newPattern = PR_TRUE;
-        FcPatternDel(pattern, FC_PIXEL_SIZE);
-        FcPatternAddDouble(pattern, FC_PIXEL_SIZE, size);
-    }
-
-    PangoFcFont *font = PANGO_FC_FONT(g_object_new(GFX_TYPE_PANGO_FC_FONT,
-                                                   "pattern", pattern, NULL));
-
-    if (newPattern) {
-        FcPatternDestroy(pattern);
-    }
-    return font;
+    return PANGO_FC_FONT(g_object_new(GFX_TYPE_PANGO_FC_FONT,
+                                      "pattern", pattern, NULL));
 }
 
 static void
 gfx_pango_font_map_class_init(gfxPangoFontMapClass *klass)
 {
-    // inherit GObjectClass::finalize from the parent as there is nothing to
-    // finalize in this object.
+    // inherit GObjectClass::finalize from parent as this class adds no data.
 
     PangoFontMapClass *fontmap_class = PANGO_FONT_MAP_CLASS (klass);
     fontmap_class->load_font = gfx_pango_font_map_load_font;
+    // inherit fontmap_class->list_families (which is not likely to be used)
+    //   from PangoFcFontMap
     fontmap_class->load_fontset = gfx_pango_font_map_load_fontset;
-    fontmap_class->list_families = gfx_pango_font_map_list_families;
     // inherit fontmap_class->shape_engine_type from PangoFcFontMap
 
     PangoFcFontMapClass *fcfontmap_class = PANGO_FC_FONT_MAP_CLASS (klass);
     fcfontmap_class->get_resolution = gfx_pango_font_map_get_resolution;
     // context_key_* virtual functions are only necessary if we want to
     // dynamically respond to changes in the screen cairo_font_options_t.
+
+    // context_substitute and get_font are not likely to be used but
+    //   implemented because the class makes them available.
     fcfontmap_class->context_substitute = gfx_pango_font_map_context_substitute;
     fcfontmap_class->create_font = gfx_pango_font_map_create_font;
 }
 
 /**
  ** gfxPangoFontGroup
  **/
 
@@ -782,74 +1362,126 @@ FontCallback (const nsAString& fontName,
 
     return PR_TRUE;
 }
 
 gfxPangoFontGroup::gfxPangoFontGroup (const nsAString& families,
                                       const gfxFontStyle *aStyle,
                                       gfxUserFontSet *aUserFontSet)
     : gfxFontGroup(families, aStyle, aUserFontSet),
-      mBasePangoFont(nsnull), mAdjustedSize(0)
+      mPangoLanguage(GuessPangoLanguage(aStyle->langGroup))
 {
     mFonts.AppendElements(1);
 }
 
 gfxPangoFontGroup::~gfxPangoFontGroup()
 {
-    if (mBasePangoFont)
-        g_object_unref(mBasePangoFont);
 }
 
 gfxFontGroup *
 gfxPangoFontGroup::Copy(const gfxFontStyle *aStyle)
 {
     return new gfxPangoFontGroup(mFamilies, aStyle, mUserFontSet);
 }
 
-// A string of family names suitable for fontconfig
+// An array of family names suitable for fontconfig
 void
-gfxPangoFontGroup::GetFcFamilies(nsAString& aFcFamilies)
+gfxPangoFontGroup::GetFcFamilies(nsStringArray *aFcFamilyList,
+                                 const nsACString& aLangGroup)
 {
-    nsStringArray familyArray;
-
     // Leave non-existing fonts in the list so that fontconfig can get the
     // best match.
-    ForEachFontInternal(mFamilies, mStyle.langGroup, PR_TRUE, PR_FALSE,
-                        FontCallback, &familyArray);
+    ForEachFontInternal(mFamilies, aLangGroup, PR_TRUE, PR_FALSE,
+                        FontCallback, aFcFamilyList);
+}
 
-    if (familyArray.Count()) {
-        int i = 0;
-        while (1) {
-            aFcFamilies.Append(*familyArray[i]);
-            ++i;
-            if (i >= familyArray.Count())
-                break;
-            aFcFamilies.Append(NS_LITERAL_STRING(","));
-        }
-    }
-    else {
-        // XXX If there are no fonts, we should use dummy family.
-        // Pango will resolve from this.
-        // behdad: yep, looks good.
-        // printf("%s(%s)\n", NS_ConvertUTF16toUTF8(families).get(),
-        //                    aStyle->langGroup.get());
-        aFcFamilies.Append(NS_LITERAL_STRING("sans-serif"));
-    }
+PangoFont *
+gfxPangoFontGroup::GetBasePangoFont()
+{
+    return GetBaseFontSet()->GetFontAt(0);
 }
 
 gfxFont *
 gfxPangoFontGroup::GetFontAt(PRInt32 i) {
     NS_PRECONDITION(i == 0, "Only have one font");
 
     if (!mFonts[0]) {
         PangoFont *pangoFont = GetBasePangoFont();
         mFonts[0] = gfxPangoFcFont::GfxFont(GFX_PANGO_FC_FONT(pangoFont));
     }
 
     return mFonts[0];
+}
+
+already_AddRefed<gfxFcPangoFontSet>
+gfxPangoFontGroup::MakeFontSet(PangoLanguage *aLang, gfxFloat aSizeAdjustFactor,
+                               nsAutoRef<FcPattern> *aMatchPattern)
+{
+    const char *lang = pango_language_to_string(aLang);
+
+    const char *langGroup = nsnull;
+    if (aLang != mPangoLanguage) {
+        // Set up langGroup for Mozilla's font prefs.
+        if (!gLangService) {
+            CallGetService(NS_LANGUAGEATOMSERVICE_CONTRACTID, &gLangService);
+        }
+        if (gLangService) {
+            nsIAtom *atom =
+                gLangService->LookupLanguage(NS_ConvertUTF8toUTF16(lang));
+            if (atom) {
+                atom->GetUTF8String(&langGroup);
+            }
+        }
+    }
+
+    nsStringArray fcFamilyList;
+    GetFcFamilies(&fcFamilyList,
+                  langGroup ? nsDependentCString(langGroup) : mStyle.langGroup);
+
+    // To consider: A fontset cache here could be helpful.
+
+    // Get a pattern suitable for matching.
+    nsAutoRef<FcPattern> pattern
+        (gfxFontconfigUtils::NewPattern(fcFamilyList, mStyle, lang));
+
+    PrepareSortPattern(pattern, mStyle.size, aSizeAdjustFactor);
+
+    nsRefPtr<gfxFcPangoFontSet> fontset = new gfxFcPangoFontSet(pattern);
+
+    if (aMatchPattern)
+        aMatchPattern->steal(pattern);
+
+    return fontset.forget();
+}
+
+gfxPangoFontGroup::
+FontSetByLangEntry::FontSetByLangEntry(PangoLanguage *aLang,
+                                       gfxFcPangoFontSet *aFontSet)
+    : mLang(aLang), mFontSet(aFontSet)
+{
+}
+
+gfxFcPangoFontSet *
+gfxPangoFontGroup::GetFontSet(PangoLanguage *aLang)
+{
+    GetBaseFontSet(); // sets mSizeAdjustFactor and mFontSets[0]
+
+    if (!aLang)
+        return mFontSets[0].mFontSet;
+
+    for (PRUint32 i = 0; i < mFontSets.Length(); ++i) {
+        if (mFontSets[i].mLang == aLang)
+            return mFontSets[i].mFontSet;
+    }
+
+    nsRefPtr<gfxFcPangoFontSet> fontSet =
+        MakeFontSet(aLang, mSizeAdjustFactor);
+    mFontSets.AppendElement(FontSetByLangEntry(aLang, fontSet));
+
+    return fontSet;
 }
 
 /**
  ** gfxFcFont
  **/
 
 cairo_user_data_key_t gfxFcFont::sGfxFontKey;
 
@@ -868,107 +1500,39 @@ gfxFcFont::~gfxFcFont()
 {
     cairo_scaled_font_set_user_data(mCairoFont, &sGfxFontKey, NULL, NULL);
     cairo_scaled_font_destroy(mCairoFont);
 }
 
 /* static */ void
 gfxPangoFontGroup::Shutdown()
 {
-    gfxPangoFontCache::Shutdown();
-
     if (gPangoFontMap) {
         if (PANGO_IS_FC_FONT_MAP (gPangoFontMap)) {
             // This clears circular references from the fontmap to itself
             // through its fonts.
             pango_fc_font_map_shutdown(PANGO_FC_FONT_MAP(gPangoFontMap));
         }
         g_object_unref(gPangoFontMap);
         gPangoFontMap = NULL;
     }
+
+    NS_IF_RELEASE(gLangService);
 }
 
-static PangoStyle
-ThebesStyleToPangoStyle (const gfxFontStyle *fs)
+static double
+GetPixelSize(FcPattern *aPattern)
 {
-    if (fs->style == FONT_STYLE_ITALIC)
-        return PANGO_STYLE_ITALIC;
-    if (fs->style == FONT_STYLE_OBLIQUE)
-        return PANGO_STYLE_OBLIQUE;
+    double size;
+    if (FcPatternGetDouble(aPattern,
+                           FC_PIXEL_SIZE, 0, &size) == FcResultMatch)
+        return size;
 
-    return PANGO_STYLE_NORMAL;
-}
-
-static PangoWeight
-ThebesStyleToPangoWeight (const gfxFontStyle *fs)
-{
-    PRInt32 w = fs->weight;
-
-    /*
-     * weights come in two parts crammed into one
-     * integer -- the "base" weight is weight / 100,
-     * the rest of the value is the "offset" from that
-     * weight -- the number of steps to move to adjust
-     * the weight in the list of supported font weights,
-     * this value can be negative or positive.
-     */
-    PRInt32 baseWeight = (w + 50) / 100;
-    PRInt32 offset = w - baseWeight * 100;
-
-    /* clip weights to range 0 to 9 */
-    if (baseWeight < 0)
-        baseWeight = 0;
-    if (baseWeight > 9)
-        baseWeight = 9;
-
-    /* Map from weight value to fcWeights index */
-    static const int fcWeightLookup[10] = {
-        0, 0, 0, 0, 1, 1, 2, 3, 3, 4,
-    };
-
-    PRInt32 fcWeight = fcWeightLookup[baseWeight];
-
-    /*
-     * adjust by the offset value, make sure we stay inside the 
-     * fcWeights table
-     */
-    fcWeight += offset;
-
-    if (fcWeight < 0)
-        fcWeight = 0;
-    if (fcWeight > 4)
-        fcWeight = 4;
-
-    /* Map to final PANGO_WEIGHT value */
-    static const int fcWeights[5] = {
-        349,
-        449,
-        649,
-        749,
-        900
-    };
-
-    return (PangoWeight)fcWeights[fcWeight];
-}
-
-/* Note this doesn't check sizeAdjust */
-static PangoFontDescription *
-NewPangoFontDescription(const nsAString &aName, const gfxFontStyle *aFontStyle)
-{
-    PangoFontDescription *fontDesc = pango_font_description_new();
-
-    pango_font_description_set_family(fontDesc,
-                                      NS_ConvertUTF16toUTF8(aName).get());
-    pango_font_description_set_absolute_size
-        (fontDesc, moz_pango_units_from_double(aFontStyle->size));
-    pango_font_description_set_style(fontDesc,
-                                     ThebesStyleToPangoStyle(aFontStyle));
-    pango_font_description_set_weight(fontDesc,
-                                      ThebesStyleToPangoWeight(aFontStyle));
-    return fontDesc;
+    NS_NOTREACHED("No size on pattern");
+    return 0.0;
 }
 
 /**
  * The following gfxPangoFonts are accessed from the PangoFont, not from the
  * gfxFontCache hash table.  The gfxFontCache hash table is keyed by desired
  * family and style, whereas here we only know actual family and style.  There
  * may be more than one of these fonts with the same family and style, but
  * different PangoFont and actual font face.
@@ -984,22 +1548,17 @@ gfxFcFont::GetOrMakeFont(FcPattern *aPat
 gfxFcFont::GetOrMakeFont(FcPattern *aPattern)
 {
     cairo_scaled_font_t *cairoFont = CreateScaledFont(aPattern);
 
     nsRefPtr<gfxFcFont> font = static_cast<gfxFcFont*>
         (cairo_scaled_font_get_user_data(cairoFont, &sGfxFontKey));
 
     if (!font) {
-        double size;
-        if (FcPatternGetDouble(aPattern,
-                               FC_PIXEL_SIZE, 0, &size) != FcResultMatch) {
-            NS_NOTREACHED("No size on pattern");
-            size = 0.0;
-        }
+        gfxFloat size = GetPixelSize(aPattern);
 
         // Shouldn't actually need to take too much care about the correct
         // name or style, as size is the only thing expected to be important.
         PRUint8 style = gfxFontconfigUtils::GetThebesStyle(aPattern);
         PRUint16 weight = gfxFontconfigUtils::GetThebesWeight(aPattern);
 
         // The LangSet in the FcPattern does not have an order so there is no
         // one particular language to choose and converting the set to a
@@ -1007,17 +1566,17 @@ gfxFcFont::GetOrMakeFont(FcPattern *aPat
         NS_NAMED_LITERAL_CSTRING(langGroup, "x-unicode");
         gfxFontStyle fontStyle(style, weight, size, langGroup, 0.0,
                                PR_TRUE, PR_FALSE);
 
         FcChar8 *fc_file; // unsigned char
         const char *file; // signed for Mozilla string APIs
         if (FcPatternGetString(aPattern,
                                FC_FILE, 0, &fc_file) == FcResultMatch) {
-            file = reinterpret_cast<char*>(fc_file);
+            file = gfxFontconfigUtils::ToCString(fc_file);
         } else {
             // cairo won't know which font to open without a file.
             // (We don't create fonts from an FT_Face.)
             NS_NOTREACHED("Fonts without a file are not supported");
             static const char *noFile = "NO FILE";
             file = noFile;
         }
         int index;
@@ -1046,95 +1605,78 @@ gfxFcFont::GetOrMakeFont(FcPattern *aPat
         // that affect rendering but are not included in the gfxFontStyle.
         font = new gfxFcFont(cairoFont, fe, &fontStyle);
     }
 
     cairo_scaled_font_destroy(cairoFont);
     return font.forget();
 }
 
+static PangoFontMap *
+GetPangoFontMap()
+{
+    if (!gPangoFontMap) {
+        gPangoFontMap = gfxPangoFontMap::NewFontMap();
+    }
+    return gPangoFontMap;
+}
+
 static PangoContext *
 GetPangoContext()
 {
     PangoContext *context = pango_context_new();
-
-    // Change the font map to recognize a base font on the context
-    if (!gPangoFontMap) {
-        gPangoFontMap = gfxPangoFontMap::NewFontMap();
-    }
-    pango_context_set_font_map(context, gPangoFontMap);
-
+    pango_context_set_font_map(context, GetPangoFontMap());
     return context;
 }
 
-static PangoFont*
-LoadPangoFont(PangoContext *aPangoCtx, const PangoFontDescription *aPangoFontDesc)
+gfxFcPangoFontSet *
+gfxPangoFontGroup::GetBaseFontSet()
 {
-    gfxPangoFontCache *cache = gfxPangoFontCache::GetPangoFontCache();
-    if (!cache)
-        return nsnull; // Error
-    PangoFont* pangoFont = cache->Get(aPangoFontDesc);
-    if (!pangoFont) {
-        pangoFont = pango_context_load_font(aPangoCtx, aPangoFontDesc);
-        if (pangoFont) {
-            cache->Put(aPangoFontDesc, pangoFont);
-        }
-    }
-    return pangoFont;
-}
+    if (mFontSets.Length() > 0)
+        return mFontSets[0].mFontSet;
 
-// The font group holds the reference to the PangoFont
-PangoFont *
-gfxPangoFontGroup::GetBasePangoFont()
-{
-    if (mBasePangoFont)
-        return mBasePangoFont;
+    mSizeAdjustFactor = 1.0; // will be adjusted below if necessary
+    nsAutoRef<FcPattern> pattern;
+    nsRefPtr<gfxFcPangoFontSet> fontSet =
+        MakeFontSet(mPangoLanguage, mSizeAdjustFactor, &pattern);
 
-    nsAutoString fcFamilies;
-    GetFcFamilies(fcFamilies);
-    PangoFontDescription *pangoFontDesc = 
-        NewPangoFontDescription(fcFamilies, GetStyle());
+    double size = GetPixelSize(pattern);
+    if (size != 0.0 && mStyle.sizeAdjust != 0.0) {
+        gfxFcFont *font =
+            gfxPangoFcFont::GfxFont(GFX_PANGO_FC_FONT(fontSet->GetFontAt(0)));
+        if (font) {
+            const gfxFont::Metrics& metrics = font->GetMetrics();
 
-    PangoContext *pangoCtx = GetPangoContext();
+            // The factor of 0.1 ensures that xHeight is sane so fonts don't
+            // become huge.  Strictly ">" ensures that xHeight and emHeight are
+            // not both zero.
+            if (metrics.xHeight > 0.1 * metrics.emHeight) {
+                mSizeAdjustFactor =
+                    mStyle.sizeAdjust * metrics.emHeight / metrics.xHeight;
 
-    if (!GetStyle()->langGroup.IsEmpty()) {
-        PangoLanguage *lang = GetPangoLanguage(GetStyle()->langGroup);
-        if (lang)
-            pango_context_set_language(pangoCtx, lang);
-    }
+                size *= mSizeAdjustFactor;
+                FcPatternDel(pattern, FC_PIXEL_SIZE);
+                FcPatternAddDouble(pattern, FC_PIXEL_SIZE, size);
 
-    PangoFont *pangoFont = LoadPangoFont(pangoCtx, pangoFontDesc);
-
-    gfxFloat size = GetStyle()->size;
-    if (size != 0.0 && GetStyle()->sizeAdjust != 0.0) {
-        LockedFTFace
-            face(gfxPangoFcFont::GfxFont(GFX_PANGO_FC_FONT(pangoFont)));
-        // Could try xHeight from TrueType/OpenType fonts.
-        cairo_text_extents_t extents;
-        if (face.GetCharExtents('x', &extents) &&
-            extents.y_bearing < 0.0) {
-            gfxFloat aspect = -extents.y_bearing / size;
-            size = GetStyle()->GetAdjustedSize(aspect);
-
-            pango_font_description_set_absolute_size
-                (pangoFontDesc, moz_pango_units_from_double(size));
-            g_object_unref(pangoFont);
-            pangoFont = LoadPangoFont(pangoCtx, pangoFontDesc);
+                fontSet = new gfxFcPangoFontSet(pattern);
+            }
         }
     }
 
-    if (pangoFontDesc)
-        pango_font_description_free(pangoFontDesc);
-    if (pangoCtx)
-        g_object_unref(pangoCtx);
+    PangoLanguage *pangoLang = mPangoLanguage;
+    FcChar8 *fcLang;
+    if (!pangoLang &&
+        FcPatternGetString(pattern, FC_LANG, 0, &fcLang) == FcResultMatch) {
+        pangoLang =
+            pango_language_from_string(gfxFontconfigUtils::ToCString(fcLang));
+    }
 
-    mBasePangoFont = pangoFont;
-    mAdjustedSize = size;
+    mFontSets.AppendElement(FontSetByLangEntry(pangoLang, fontSet));
 
-    return pangoFont;
+    return fontSet;
 }
 
 void
 gfxFcFont::GetGlyphExtents(PRUint32 aGlyph, cairo_text_extents_t* aExtents)
 {
     NS_PRECONDITION(aExtents != NULL, "aExtents must not be NULL");
 
     cairo_glyph_t glyphs[1];
@@ -1581,22 +2123,17 @@ gfxPangoFontGroup::InitTextRun(gfxTextRu
 #endif
 }
 
 // This will fetch an existing scaled_font if one exists.
 static cairo_scaled_font_t *
 CreateScaledFont(FcPattern *aPattern)
 {
     cairo_font_face_t *face = cairo_ft_font_face_create_for_pattern(aPattern);
-    double size;
-    if (FcPatternGetDouble(aPattern,
-                           FC_PIXEL_SIZE, 0, &size) != FcResultMatch) {
-        NS_NOTREACHED("No size on pattern");
-        size = 0.0;
-    }
+    double size = GetPixelSize(aPattern);
         
     cairo_matrix_t fontMatrix;
     FcMatrix *fcMatrix;
     if (FcPatternGetMatrix(aPattern, FC_MATRIX, 0, &fcMatrix) == FcResultMatch)
         cairo_matrix_init(&fontMatrix, fcMatrix->xx, -fcMatrix->yx, -fcMatrix->xy, fcMatrix->yy, 0, 0);
     else
         cairo_matrix_init_identity(&fontMatrix);
     cairo_matrix_scale(&fontMatrix, size, size);
@@ -2152,50 +2689,41 @@ gfxPangoFontGroup::CreateGlyphRunsFast(g
 }
 #endif
 
 void 
 gfxPangoFontGroup::CreateGlyphRunsItemizing(gfxTextRun *aTextRun,
                                             const gchar *aUTF8, PRUint32 aUTF8Length,
                                             PRUint32 aUTF8HeaderLen)
 {
+    // This font group and gfxPangoFontMap are recorded on the PangoContext
+    // passed to pango_itemize_with_base_dir().
+    //
+    // pango_itemize_with_base_dir() divides the string into substrings for
+    // each language, and queries gfxPangoFontMap::load_fontset() to provide
+    // ordered lists of fonts for each language.  gfxPangoFontMap passes the
+    // request back to this font group, which returns a gfxFcPangoFontSet
+    // handling the font sorting/selection.
+    //
+    // For each character, pango_itemize_with_base_dir searches through these
+    // lists of fonts for a font with support for the character.  The
+    // PangoItems returned represent substrings (or runs) of consectutive
+    // characters to be shaped with the same PangoFont and having the same
+    // script.
+    //
+    // The PangoFonts in the PangoItems are from the gfxPangoFontMap and so
+    // each have a gfxFont.  This gfxFont represents the same face as the
+    // PangoFont and so can render the same glyphs in the same way as
+    // pango_shape measures.
 
     PangoContext *context = GetPangoContext();
-
-    // The font description could be cached on the gfxPangoFontGroup...
-    nsAutoString fcFamilies;
-    GetFcFamilies(fcFamilies);
-    PangoFontDescription *fontDesc =
-        NewPangoFontDescription(fcFamilies, GetStyle());
-    if (GetStyle()->sizeAdjust != 0.0) {
-        gfxFloat size = GetAdjustedSize();
-        pango_font_description_set_absolute_size
-            (fontDesc, moz_pango_units_from_double(size));
-    }
-
-    pango_context_set_font_description(context, fontDesc);
-    pango_font_description_free(fontDesc);
-
-    PangoLanguage *lang = GetPangoLanguage(GetStyle()->langGroup);
-
     // we should set this to null if we don't have a text language from the page...
     // except that we almost always have something...
-    pango_context_set_language(context, lang);
-
-    // Set the primary font for consistent font selection for common
-    // characters, but use the default Pango behavior
-    // (selecting generic fonts from the script of the characters)
-    // in two situations:
-    //   1. When we don't have a language to make a good choice for the
-    //      primary font.
-    //   2. For system fonts, use the default Pango behavior
-    //      to give consistency with other apps.
-    if (lang && !GetStyle()->systemFont) {
-        SetBaseFont(context, GetBasePangoFont());
-    }
+    pango_context_set_language(context, mPangoLanguage);
+    SetFontGroup(context, this);
 
     PangoDirection dir = aTextRun->IsRightToLeft() ? PANGO_DIRECTION_RTL : PANGO_DIRECTION_LTR;
     GList *items = pango_itemize_with_base_dir(context, dir, aUTF8, 0, aUTF8Length, nsnull, nsnull);
 
     PRUint32 utf16Offset = 0;
 #ifdef DEBUG
     PRBool isRTL = aTextRun->IsRightToLeft();
 #endif
@@ -2264,53 +2792,20 @@ out:
     if (items)
         g_list_free(items);
 
     g_object_unref(context);
 }
 
 /* static */
 PangoLanguage *
-GetPangoLanguage(const nsACString& aLangGroup)
+GuessPangoLanguage(const nsACString& aLangGroup)
 {
-    // see if the lang group needs to be translated from mozilla's
+    // See if the lang group needs to be translated from Mozilla's
     // internal mapping into fontconfig's
     nsCAutoString lang;
     gfxFontconfigUtils::GetSampleLangForGroup(aLangGroup, &lang);
 
     if (lang.IsEmpty())
         return NULL;
 
     return pango_language_from_string(lang.get());
 }
-
-gfxPangoFontCache::gfxPangoFontCache()
-{
-    mPangoFonts.Init(500);
-}
-
-gfxPangoFontCache::~gfxPangoFontCache()
-{
-}
-
-void
-gfxPangoFontCache::Put(const PangoFontDescription *aFontDesc, PangoFont *aPangoFont)
-{
-    if (mPangoFonts.Count() > 5000)
-        mPangoFonts.Clear();
-    PRUint32 key = pango_font_description_hash(aFontDesc);
-    gfxPangoFontWrapper *value = new gfxPangoFontWrapper(aPangoFont);
-    if (!value)
-        return;
-    mPangoFonts.Put(key, value);
-}
-
-PangoFont*
-gfxPangoFontCache::Get(const PangoFontDescription *aFontDesc)
-{
-    PRUint32 key = pango_font_description_hash(aFontDesc);
-    gfxPangoFontWrapper *value;
-    if (!mPangoFonts.Get(key, &value))
-        return nsnull;
-    PangoFont *font = value->Get();
-    g_object_ref(font);
-    return font;
-}
diff -r a4343d61f6ee gfx/thebes/src/gfxPlatformGtk.cpp
--- a/gfx/thebes/src/gfxPlatformGtk.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/gfx/thebes/src/gfxPlatformGtk.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -73,16 +73,18 @@
 #endif
 
 #include <fontconfig/fontconfig.h>
 
 #include "nsMathUtils.h"
 
 #include "lcms.h"
 
+#define GDK_PIXMAP_SIZE_MAX 32767
+
 #ifndef MOZ_PANGO
 #include <ft2build.h>
 #include FT_FREETYPE_H
 #endif
 
 double gfxPlatformGtk::sDPI = -1.0;
 gfxFontconfigUtils *gfxPlatformGtk::sFontconfigUtils = nsnull;
 
@@ -144,16 +146,21 @@ gfxPlatformGtk::~gfxPlatformGtk()
 #endif
 }
 
 already_AddRefed<gfxASurface>
 gfxPlatformGtk::CreateOffscreenSurface(const gfxIntSize& size,
                                        gfxASurface::gfxImageFormat imageFormat)
 {
     nsRefPtr<gfxASurface> newSurface = nsnull;
+    PRBool sizeOk = PR_TRUE;
+
+    if (size.width >= GDK_PIXMAP_SIZE_MAX ||
+        size.height >= GDK_PIXMAP_SIZE_MAX)
+        sizeOk = PR_FALSE;
 
 #ifdef MOZ_X11
     int glitzf;
     int xrenderFormatID;
     switch (imageFormat) {
         case gfxASurface::ImageFormatARGB32:
             glitzf = 0; // GLITZ_STANDARD_ARGB32;
             xrenderFormatID = PictStandardARGB32;
@@ -180,17 +187,17 @@ gfxPlatformGtk::CreateOffscreenSurface(c
     Display* display = GDK_DISPLAY();
     if (!display)
         return nsnull;
 
     GdkPixmap* pixmap = nsnull;
     XRenderPictFormat* xrenderFormat =
         XRenderFindStandardFormat(display, xrenderFormatID);
 
-    if (xrenderFormat) {
+    if (xrenderFormat && sizeOk) {
         pixmap = gdk_pixmap_new(nsnull, size.width, size.height,
                                 xrenderFormat->depth);
 
         if (pixmap) {
             gdk_drawable_set_colormap(GDK_DRAWABLE(pixmap), nsnull);
             newSurface = new gfxXlibSurface(display,
                                             GDK_PIXMAP_XID(GDK_DRAWABLE(pixmap)),
                                             xrenderFormat,
@@ -206,27 +213,30 @@ gfxPlatformGtk::CreateOffscreenSurface(c
             // Ignore and let's fall back to image surfaces.
             newSurface = nsnull;
         }
 
         // always unref; SetGdkDrawable takes its own ref
         if (pixmap)
             g_object_unref(pixmap);
     }
-
-    if (!newSurface) {
-        // We don't have Render or we couldn't create an xlib surface for
-        // whatever reason; fall back to image surface for the data.
-        newSurface = new gfxImageSurface(gfxIntSize(size.width, size.height), imageFormat);
-    }
 #endif
 
 #ifdef MOZ_DFB
-    newSurface = new gfxDirectFBSurface(size, imageFormat);
+    if (sizeOk)
+        newSurface = new gfxDirectFBSurface(size, imageFormat);
 #endif
+
+
+    if (!newSurface) {
+        // We couldn't create a native surface for whatever reason;
+        // e.g., no RENDER, bad size, etc.
+        // Fall back to image surface for the data.
+        newSurface = new gfxImageSurface(gfxIntSize(size.width, size.height), imageFormat);
+    }
 
     if (newSurface) {
         gfxContext tmpCtx(newSurface);
         tmpCtx.SetOperator(gfxContext::OPERATOR_CLEAR);
         tmpCtx.Paint();
     }
 
     return newSurface.forget();
diff -r a4343d61f6ee js/src/Makefile.in
--- a/js/src/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/Makefile.in	Sat Nov 15 19:43:13 2008 -0500
@@ -258,17 +258,17 @@ endif
 endif
 
 DEFINES += -DFEATURE_NANOJIT -DJS_TRACER
 endif
 
 ifdef HAVE_DTRACE
 INSTALLED_HEADERS += \
 		jsdtracef.h \
-		javascript-trace.h \
+		$(CURDIR)/javascript-trace.h \
 		$(NULL)
 endif
 
 ifeq (,$(filter-out WINNT WINCE,$(OS_ARCH)))
 INSTALLED_HEADERS += jscpucfg.h
 endif
 
 JS_SAFE_ARENA	= 1
@@ -634,25 +634,31 @@ endif
 endif
 ifneq (,$(IMPORT_LIBRARY))
 	$(SYSINSTALL) $(IFLAGS2) $(IMPORT_LIBRARY) $(libdir)
 endif
 
 # Extra dependancies and rules for auto-generated headers
 host_jskwgen.$(OBJ_SUFFIX): jsversion.h jskeyword.tbl
 
-jsautokw.h: host_jskwgen$(HOST_BIN_SUFFIX)
+# Use CURDIR to avoid finding a jsautokw.h in the source tree (from a
+# previous build?) via VPATH when we're building in a separate tree.
+$(CURDIR)/jsautokw.h: host_jskwgen$(HOST_BIN_SUFFIX)
 	./host_jskwgen$(HOST_BIN_SUFFIX) $@
 
 host_jsoplengen.$(OBJ_SUFFIX): jsopcode.tbl
 
-jsautooplen.h: host_jsoplengen$(HOST_BIN_SUFFIX)
+# Use CURDIR to avoid finding a jsautooplen.h in the source tree (from
+# a previous build?) via VPATH when we're building in a separate tree.
+$(CURDIR)/jsautooplen.h: host_jsoplengen$(HOST_BIN_SUFFIX)
 	./host_jsoplengen$(HOST_BIN_SUFFIX) $@
 
 # Force auto-header generation before compiling any source that may use them
-$(CPPSRCS:%.cpp=%.$(OBJ_SUFFIX)): jsautokw.h jsautooplen.h
+$(CPPSRCS:%.cpp=%.$(OBJ_SUFFIX)): $(CURDIR)/jsautokw.h $(CURDIR)/jsautooplen.h
 
 ifdef HAVE_DTRACE
-javascript-trace.h: $(srcdir)/javascript-trace.d
+$(CURDIR)/javascript-trace.h: $(srcdir)/javascript-trace.d
 	dtrace -h -s $(srcdir)/javascript-trace.d -o javascript-trace.h.in
 	sed 's/if _DTRACE_VERSION/ifdef INCLUDE_MOZILLA_DTRACE/' \
 	    javascript-trace.h.in > javascript-trace.h
+
+$(CPPSRCS:%.cpp=%.$(OBJ_SUFFIX)): $(CURDIR)/javascript-trace.h
 endif
diff -r a4343d61f6ee js/src/Makefile.ref
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/Makefile.ref	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,483 @@
+# -*- Mode: makefile -*-
+# vim: ft=make
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#   Michael Ang <mang@subcarrier.org>
+#   Kevin Buhr <buhr@stat.wisc.edu>
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either of the GNU General Public License Version 2 or later (the "GPL"),
+# or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# JSRef GNUmake makefile.
+#
+# Note: dependency rules are missing for some files (some
+#       .h, all .msg, etc.)  Re-make clean if in doubt.
+#
+
+
+DEPTH = .
+
+include config.mk
+
+#NS_USE_NATIVE = 1
+
+ifndef NANOJIT_ARCH
+$(warning NANOJIT_ARCH not defined in config/$(OS_CONFIG).mk, JIT disabled)
+else
+ifdef DISABLE_JIT
+$(warning disabling JIT per build specification)
+else
+ENABLE_JIT=1
+endif
+endif
+
+ifdef ENABLE_JIT
+DEFINES += -DJS_TRACER
+DEFINES += -DFEATURE_NANOJIT
+INCLUDES += -Inanojit
+endif
+
+#ifndef BUILD_OPT
+#DEFINES += -Ivprof
+#endif
+
+ifdef NARCISSUS
+DEFINES += -DNARCISSUS
+endif
+
+# Look in OBJDIR to find jsautocfg.h, jsautokw.h, and js-config.h
+INCLUDES   += -I. -I$(OBJDIR)
+
+ifdef JS_THREADSAFE
+DEFINES += -DJS_THREADSAFE
+INCLUDES += -I$(DIST)/include/nspr
+ifdef USE_MSVC
+OTHER_LIBS += $(DIST)/lib/libnspr$(NSPR_LIBSUFFIX).lib
+else
+OTHER_LIBS += -L$(DIST)/lib -lnspr$(NSPR_LIBSUFFIX)
+endif
+endif
+
+ifdef JS_NO_THIN_LOCKS
+DEFINES += -DJS_USE_ONLY_NSPR_LOCKS
+endif
+
+ifdef JS_HAS_FILE_OBJECT
+DEFINES += -DJS_HAS_FILE_OBJECT
+endif
+
+ifdef JS_GC_ZEAL
+DEFINES += -DJS_GC_ZEAL
+endif
+
+#
+# XCFLAGS may be set in the environment or on the gmake command line
+#
+#CFLAGS += -DDEBUG -DDEBUG_brendan -DJS_ARENAMETER -DJS_HASHMETER -DJS_DUMP_PROPTREE_STATS -DJS_DUMP_SCOPE_METERS -DJS_SCOPE_DEPTH_METER -DJS_BASIC_STATS
+CFLAGS          += $(OS_CFLAGS) $(DEFINES) $(INCLUDES) $(XCFLAGS)
+
+LDFLAGS		= $(XLDFLAGS)
+LDFLAGS += $(OS_LDFLAGS)
+
+ifdef MOZ_SHARK
+DEFINES += -DMOZ_SHARK
+CFLAGS += -F/System/Library/PrivateFrameworks
+LDFLAGS += -F/System/Library/PrivateFrameworks -framework CHUD
+endif
+ifdef MOZ_CALLGRIND
+DEFINES += -DMOZ_CALLGRIND
+endif
+ifdef MOZ_VTUNE
+DEFINES += -DMOZ_VTUNE
+CXXFLAGS += -IC:/Program\ Files/Intel/VTune/Analyzer/Include
+OTHER_LIBS += C:/Program\ Files/Intel/VTune/Analyzer/Lib/VtuneApi.lib
+endif
+
+ifndef NO_LIBM
+LDFLAGS += -lm
+endif
+
+# Prevent floating point errors caused by VC++ optimizations
+ifeq ($(OS_ARCH),WINNT)
+_MSC_VER = $(shell $(CXX) 2>&1 | sed -n 's/.*Compiler Version \([0-9]*\)\.\([0-9]*\).*/\1\2/p')
+ifeq (,$(filter-out 1200 1300 1310,$(_MSC_VER)))
+CFLAGS += -Op
+else
+CFLAGS += -fp:precise
+endif
+endif # WINNT
+
+#
+#	Server-related changes :
+#
+ifdef NES40
+DEFINES += -DNES40
+endif
+
+#
+# Line editing support.
+# Define JS_READLINE or JS_EDITLINE to enable line editing in the
+# js command-line interpreter.
+#
+ifdef JS_READLINE
+# For those platforms with the readline library installed.
+DEFINES += -DEDITLINE
+PROG_LIBS += -lreadline -ltermcap
+else
+ifdef JS_EDITLINE
+# Use the editline library, built locally.
+PREDIRS += editline
+DEFINES += -DEDITLINE
+PROG_LIBS += $(OBJDIR)/editline/libedit.a
+endif
+endif
+
+# For purify
+PURE_CFLAGS     = -DXP_UNIX $(OPTIMIZER) $(PURE_OS_CFLAGS) $(DEFINES) \
+                  $(INCLUDES) $(XCFLAGS)
+
+#
+# JS file lists
+#
+JS_HFILES =		\
+	jsarray.h	\
+	jsatom.h	\
+	jsbool.h	\
+	jscntxt.h	\
+	jsdate.h	\
+	jsemit.h	\
+	jsexn.h		\
+	jsfun.h		\
+	jsgc.h		\
+	jsinterp.h	\
+	jsiter.h	\
+	jslibmath.h	\
+	jslock.h	\
+	jsmath.h	\
+	jsnum.h		\
+	jsobj.h		\
+	json.h		\
+	jsopcode.h	\
+	jsparse.h	\
+	jsarena.h	\
+	jsclist.h	\
+	jsdhash.h	\
+	jsdtoa.h	\
+	jshash.h	\
+	jslong.h	\
+	jstypes.h	\
+	jsprvtd.h	\
+	jspubtd.h	\
+	jsregexp.h	\
+	jsscan.h	\
+	jsscope.h	\
+	jsscript.h	\
+	jsstr.h		\
+	jsversion.h	\
+	jsxdrapi.h	\
+	jsxml.h		\
+	$(NULL)
+
+ifdef ENABLE_JIT
+JS_HFILES +=			\
+	jstracer.h		\
+	nanojit/Assembler.h     \
+	nanojit/LIR.h		\
+	nanojit/Native$(NANOJIT_ARCH).h	\
+	nanojit/avmplus.h	\
+	nanojit/vm_fops.h	\
+	nanojit/Fragmento.h	\
+	nanojit/Native.h	\
+	nanojit/RegAlloc.h	\
+	nanojit/nanojit.h	\
+	nanojit/TraceTreeDrawer.h \
+	$(NULL)
+endif
+
+ifndef BUILD_OPT
+#JS_HFILES +=            \
+#        vprof/vprof.h   \
+#        $(NULL)
+endif
+
+API_HFILES =		\
+	jsapi.h		\
+	jsdbgapi.h	\
+	$(NULL)
+
+OTHER_HFILES =		\
+	jsbit.h		\
+	jscompat.h	\
+	jscpucfg.h	\
+	jsotypes.h	\
+	jsstddef.h	\
+	prmjtime.h	\
+	resource.h	\
+	jsopcode.tbl	\
+	jsproto.tbl     \
+	js.msg		\
+	jsshell.msg	\
+	jskeyword.tbl	\
+	$(NULL)
+
+ifdef ENABLE_JIT
+OTHER_HFILES += builtins.tbl
+endif
+
+ifndef PREBUILT_CPUCFG
+OTHER_HFILES += $(OBJDIR)/jsautocfg.h
+endif
+OTHER_HFILES += $(OBJDIR)/jsautokw.h $(OBJDIR)/js-config.h
+
+HFILES = $(JS_HFILES) $(API_HFILES) $(OTHER_HFILES)
+
+JS_CPPFILES =		\
+	jsapi.cpp	\
+	jsarena.cpp	\
+	jsarray.cpp	\
+	jsatom.cpp	\
+	jsbool.cpp	\
+	jscntxt.cpp	\
+	jsdate.cpp	\
+	jsdbgapi.cpp	\
+	jsdhash.cpp	\
+	jsdtoa.cpp	\
+	jsemit.cpp	\
+	jsexn.cpp	\
+	jsfun.cpp	\
+	jsgc.cpp	\
+	jshash.cpp	\
+	jsinterp.cpp	\
+	jsinvoke.cpp    \
+	jsiter.cpp	\
+	jslock.cpp	\
+	jslog2.cpp	\
+	jslong.cpp	\
+	jsmath.cpp	\
+	jsnum.cpp	\
+	jsobj.cpp	\
+	json.cpp	\
+	jsopcode.cpp	\
+	jsparse.cpp	\
+	jsprf.cpp	\
+	jsregexp.cpp	\
+	jsscan.cpp	\
+	jsscope.cpp	\
+	jsscript.cpp	\
+	jsstr.cpp	\
+	jsutil.cpp	\
+	jsxdrapi.cpp	\
+	jsxml.cpp	\
+	prmjtime.cpp	\
+	$(NULL)
+
+ifdef ENABLE_JIT
+JS_CPPFILES +=		       \
+	jsbuiltins.cpp         \
+	jstracer.cpp	       \
+	nanojit/Assembler.cpp  \
+	nanojit/Fragmento.cpp  \
+	nanojit/LIR.cpp        \
+	nanojit/Native$(NANOJIT_ARCH).cpp \
+	nanojit/RegAlloc.cpp   \
+	nanojit/avmplus.cpp    \
+	$(NULL)
+
+ifdef DEBUG
+JS_CPPFILES += nanojit/TraceTreeDrawer.cpp
+endif
+endif
+
+ifndef BUILD_OPT
+#JS_CPPFILES +=                 \
+#        vprof/vprof.cpp        \
+#        $(NULL)
+endif
+
+ifdef JS_LIVECONNECT
+DIRS      += liveconnect
+endif
+
+ifdef JS_HAS_FILE_OBJECT
+JS_CPPFILES += jsfile.cpp
+JS_HFILES += jsfile.h
+endif
+
+LIB_CPPFILES  = $(JS_CPPFILES)
+LIB_ASFILES := $(wildcard *_$(OS_ARCH).s)
+PROG_CPPFILES = js.cpp
+
+ifdef USE_MSVC
+LIBRARY = $(OBJDIR)/js32.lib
+SHARED_LIBRARY = $(OBJDIR)/js32.dll
+PROGRAM = $(OBJDIR)/js.exe
+else
+LIBRARY = $(OBJDIR)/libjs.a
+SHARED_LIBRARY = $(OBJDIR)/libjs.$(SO_SUFFIX)
+PROGRAM = $(OBJDIR)/js
+endif
+
+include rules.mk
+
+MOZ_DEPTH = ../..
+include jsconfig.mk
+
+nsinstall-target:
+	cd ../../config; $(MAKE) OBJDIR=$(OBJDIR) OBJDIR_NAME=$(OBJDIR)
+
+#
+# Automatic header generation
+#
+
+AUTO_HEADERS =					\
+	$(OBJDIR)/jsautokw.h			\
+	$(OBJDIR)/jsautooplen.h			\
+	$(NULL)
+
+$(OBJDIR)/jsautokw.h: jskeyword.tbl
+
+$(OBJDIR)/jsautooplen.h: jsopcode.tbl
+
+GARBAGE += $(AUTO_HEADERS)
+GARBAGE	+= $(AUTO_HEADERS:$(OBJDIR)/jsauto%.h=$(OBJDIR)/js%gen$(HOST_BIN_SUFFIX))
+
+ifdef USE_MSVC
+
+GARBAGE	+= $(AUTO_HEADERS:$(OBJDIR)/jsauto%.h=$(OBJDIR)/js%gen.obj)
+
+$(AUTO_HEADERS): $(OBJDIR)/jsauto%.h: js%gen.cpp
+	@$(MAKE_OBJDIR)
+	$(CXX) -Fo$(OBJDIR)/ -c $(CFLAGS) $(OPTIMIZER) $<
+	link.exe -out:"$(OBJDIR)/js$*gen$(HOST_BIN_SUFFIX)" $(EXE_LINK_FLAGS) $(OBJDIR)/js$*gen.obj
+	$(OBJDIR)/js$*gen$(HOST_BIN_SUFFIX) $@
+else
+
+GARBAGE	+= $(AUTO_HEADERS:$(OBJDIR)/jsauto%.h=$(OBJDIR)/js%gen.d)
+$(AUTO_HEADERS): $(OBJDIR)/jsauto%.h: js%gen.cpp
+	@$(MAKE_OBJDIR)
+	$(CXX) -o $(OBJDIR)/js$*gen$(HOST_BIN_SUFFIX) $(CFLAGS) $(OPTIMIZER) $(LDFLAGS) $<
+	$(OBJDIR)/js$*gen$(HOST_BIN_SUFFIX) $@
+
+endif
+
+# force creation of autoheaders before compiling any source that may use them
+$(LIB_OBJS) : $(AUTO_HEADERS)
+
+#
+# An installed header file describing configuration options that affect
+# the API.
+#
+
+# Avoid rebuilding unless js-config.h's contents actually change.  The
+# timestamp on js-config.h.stamp corresponds to the last time we
+# checked that js-config.h was up to date.  If the stamp changes but
+# js-config.h does not, then make concludes that targets depending on
+# js-config.h don't need to be rebuilt.  The dummy '@true' rule here
+# keeps make from concluding that js-config.h never changes.
+$(OBJDIR)/js-config.h: $(OBJDIR)/js-config.h.stamp
+	@true
+
+js-config-switch=$(if $(value $($1)),-e 's/\#undef $1/\#define $1/')
+$(OBJDIR)/js-config.h.stamp: js-config.h.in Makefile.ref
+	sed < $< > $(@:.stamp=.tmp)			\
+	    $(call js-config-switch,JS_THREADSAFE)	\
+	    $(call js-config-switch,JS_GC_ZEAL)		\
+	    -e :dummy
+	if ! [ -f $(@:.stamp=) ] || ! cmp $(@:.stamp=.tmp) $(@:.stamp=); then \
+	    mv $(@:.stamp=.tmp) $(@:.stamp=);				      \
+	fi
+	touch $@
+
+GARBAGE += $(OBJDIR)/js-config.h $(OBJDIR)/js-config.h.stamp
+
+# Force creation of js-config.h before compiling any source that may use it.
+$(LIB_OBJS) : $(OBJDIR)/js-config.h
+
+#
+# JS shell executable
+#
+
+ifdef USE_MSVC
+$(PROGRAM): $(PROG_OBJS) $(LIBRARY)
+	link.exe -out:"$@" $(EXE_LINK_FLAGS) $^
+else
+$(PROGRAM): $(PROG_OBJS) $(LIBRARY)
+	$(CXX) -o $@ $(CFLAGS) $(PROG_OBJS) $(LIBRARY) $(LDFLAGS) $(OTHER_LIBS) \
+	    $(PROG_LIBS)
+endif
+
+$(PROGRAM).pure: $(PROG_OBJS) $(LIBRARY)
+	purify $(PUREFLAGS) \
+	    $(CXX) -o $@ $(PURE_OS_CFLAGS) $(PROG_OBJS) $(LIBRARY) $(LDFLAGS) \
+		$(OTHER_LIBS) $(PROG_LIBS)
+
+ifndef PREBUILT_CPUCFG
+$(filter-out jscpucfg.h $(OBJDIR)/jsautocfg.h, $(HFILES)) $(CPPFILES): $(OBJDIR)/jsautocfg.h
+
+$(OBJDIR)/jsautocfg.h: $(OBJDIR)/jscpucfg
+	rm -f $@
+	$(OBJDIR)/jscpucfg > $@
+
+$(OBJDIR)/jscpucfg: $(OBJDIR)/jscpucfg.o
+	$(CXX) $(OS_LDFLAGS) -o $@ $(OBJDIR)/jscpucfg.o
+
+GARBAGE += $(OBJDIR)/jsautocfg.h $(OBJDIR)/jscpucfg \
+	   $(OBJDIR)/jscpucfg.o $(OBJDIR)/jscpucfg.d
+endif
+
+# Automatic make dependencies files
+DEPENDENCIES    = $(CPPFILES:%.cpp=$(OBJDIR)/%.d)
+
+#
+# Hardwire dependencies for some files 
+#
+ifdef USE_MSVC
+OBJ=obj
+else
+OBJ=o
+endif
+
+$(OBJDIR)/jsinvoke.$(OBJ): jsinterp.h jsinterp.cpp
+$(OBJDIR)/jsinvoke.obj : jsinterp.h jsinterp.cpp
+
+-include $(DEPENDENCIES)
+
+TARNAME = jsref.tar
+TARFILES = files `cat files`
+
+SUFFIXES: .i
+%.i: %.cpp
+	$(CXX) -C -E $(CFLAGS) $< > $*.i
diff -r a4343d61f6ee js/src/builtins.tbl
--- a/js/src/builtins.tbl	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/builtins.tbl	Sat Nov 15 19:43:13 2008 -0500
@@ -86,11 +86,12 @@ BUILTIN2(FRIEND, BOOL,      js_CloseIter
 BUILTIN2(FRIEND, BOOL,      js_CloseIterator, CONTEXT, JSVAL,                   0, 0)
 BUILTIN2(extern, SIDEEXIT,  js_CallTree, INTERPSTATE, FRAGMENT,                 0, 0)
 BUILTIN2(extern, OBJECT,    js_FastNewObject, CONTEXT, OBJECT,                  0, 0)
 BUILTIN3(extern, BOOL,      js_AddProperty, CONTEXT, OBJECT, SCOPEPROP,         0, 0)
 BUILTIN3(extern, BOOL,      js_HasNamedProperty, CONTEXT, OBJECT, STRING,       0, 0)
 BUILTIN3(extern, JSVAL,     js_CallGetter, CONTEXT, OBJECT, SCOPEPROP,          0, 0)
 BUILTIN2(extern, STRING,    js_TypeOfObject, CONTEXT, OBJECT,                   1, 1)
 BUILTIN2(extern, STRING,    js_TypeOfBoolean, CONTEXT, INT32,                   1, 1)
-BUILTIN2(extern, DOUBLE,    js_BooleanToNumber, CONTEXT, INT32,                 1, 1)
+BUILTIN2(extern, DOUBLE,    js_BooleanOrUndefinedToNumber, CONTEXT, INT32,      1, 1)
+BUILTIN2(extern, STRING,    js_BooleanOrUndefinedToString, CONTEXT, INT32,      1, 1)
 BUILTIN2(extern, STRING,    js_ObjectToString, CONTEXT, OBJECT,                 0, 0)
 BUILTIN1(extern, OBJECT,    js_Arguments, CONTEXT,                              0, 0)
diff -r a4343d61f6ee js/src/config.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/config.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,206 @@
+# -*- Mode: makefile -*-
+# 
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+# 
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+# 
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998-1999
+# the Initial Developer. All Rights Reserved.
+# 
+# Contributor(s):
+# 
+# Alternatively, the contents of this file may be used under the terms of
+# either of the GNU General Public License Version 2 or later (the "GPL"),
+# or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+# 
+# ***** END LICENSE BLOCK *****
+
+ifdef JS_DIST
+DIST = $(JS_DIST)
+else
+DIST = $(DEPTH)/../../dist
+endif
+
+# Set os+release dependent make variables
+OS_ARCH         := $(subst /,_,$(shell uname -s | sed /\ /s//_/))
+
+# Attempt to differentiate between SunOS 5.4 and x86 5.4
+OS_CPUARCH      := $(shell uname -m)
+ifeq ($(OS_CPUARCH),i86pc)
+OS_RELEASE      := $(shell uname -r)_$(OS_CPUARCH)
+else
+ifeq ($(OS_ARCH),AIX)
+OS_RELEASE      := $(shell uname -v).$(shell uname -r)
+else
+OS_RELEASE      := $(shell uname -r)
+endif
+endif
+ifeq ($(OS_ARCH),IRIX64)
+OS_ARCH         := IRIX
+endif
+
+# Handle output from win32 unames other than Netscape's version
+ifeq (,$(filter-out Windows_95 Windows_98 CYGWIN_95-4.0 CYGWIN_98-4.10, $(OS_ARCH)))
+	OS_ARCH   := WIN95
+endif
+ifeq ($(OS_ARCH),WIN95)
+	OS_ARCH	   := WINNT
+	OS_RELEASE := 4.0
+endif
+ifeq ($(OS_ARCH), Windows_NT)
+	OS_ARCH    := WINNT
+	OS_MINOR_RELEASE := $(shell uname -v)
+	ifeq ($(OS_MINOR_RELEASE),00)
+		OS_MINOR_RELEASE = 0
+	endif
+	OS_RELEASE := $(OS_RELEASE).$(OS_MINOR_RELEASE)
+endif
+ifeq (CYGWIN_NT,$(findstring CYGWIN_NT,$(OS_ARCH)))
+	OS_RELEASE := $(patsubst CYGWIN_NT-%,%,$(OS_ARCH))
+	OS_ARCH    := WINNT
+endif
+ifeq ($(OS_ARCH), CYGWIN32_NT)
+	OS_ARCH    := WINNT
+endif
+ifeq (MINGW32_NT,$(findstring MINGW32_NT,$(OS_ARCH)))
+	OS_RELEASE := $(patsubst MINGW32_NT-%,%,$(OS_ARCH))
+	OS_ARCH    := WINNT
+endif
+
+# Virtually all Linux versions are identical.
+# Any distinctions are handled in linux.h
+ifeq ($(OS_ARCH),Linux)
+OS_CONFIG      := Linux_All
+else
+ifeq ($(OS_ARCH),dgux)
+OS_CONFIG      := dgux
+else
+ifeq ($(OS_ARCH),Darwin)
+OS_CONFIG      := Darwin
+else
+ifeq ($(OS_ARCH),Darwin64)
+OS_CONFIG       := Darwin64
+else
+OS_CONFIG       := $(OS_ARCH)$(OS_OBJTYPE)$(OS_RELEASE)
+endif
+endif
+endif
+endif
+
+ASFLAGS         =
+DEFINES         =
+
+ifeq ($(OS_ARCH), WINNT)
+INSTALL = nsinstall
+CP = cp
+else
+INSTALL	= $(DIST)/bin/nsinstall
+CP = cp
+endif
+
+ifdef BUILD_OPT
+ifdef USE_MSVC
+OPTIMIZER  = -O2 -GL
+INTERP_OPTIMIZER = -O2 -GL
+BUILTINS_OPTIMIZER = -O2 -GL
+LDFLAGS    += -LTCG
+else
+OPTIMIZER           = -Os -fstrict-aliasing -fno-exceptions -fno-rtti -Wstrict-aliasing=2
+BUILTINS_OPTIMIZER  = -O9 -fstrict-aliasing -fno-exceptions -fno-rtti
+INTERP_OPTIMIZER    = -O3 -fstrict-aliasing -fno-exceptions -fno-rtti
+endif
+DEFINES    += -UDEBUG -DNDEBUG -UDEBUG_$(USER)
+OBJDIR_TAG = _OPT
+else
+ifdef USE_MSVC
+OPTIMIZER  = -Zi
+INTERP_OPTIMIZER = -Zi
+BUILTINS_OPTIMIZER = $(INTERP_OPTIMIZER)
+else
+OPTIMIZER          = -g3 -fstrict-aliasing -fno-exceptions -fno-rtti -Wstrict-aliasing=2
+INTERP_OPTIMIZER   = -g3 -fstrict-aliasing -fno-exceptions -fno-rtti
+BUILTINS_OPTIMIZER = $(INTERP_OPTIMIZER)
+endif
+DEFINES    += -DDEBUG -DDEBUG_$(USER)
+OBJDIR_TAG = _DBG
+endif
+
+SO_SUFFIX = so
+
+NS_USE_NATIVE = 1
+
+# Java stuff
+CLASSDIR     = $(DEPTH)/liveconnect/classes
+JAVA_CLASSES = $(patsubst %.java,%.class,$(JAVA_SRCS))
+TARGETS     += $(addprefix $(CLASSDIR)/$(OBJDIR)/$(JARPATH)/, $(JAVA_CLASSES))
+JAVAC        = $(JDK)/bin/javac
+JAVAC_FLAGS  = -classpath "$(CLASSPATH)" -d $(CLASSDIR)/$(OBJDIR)
+ifeq ($(OS_ARCH), WINNT)
+  SEP        = ;
+else
+  SEP        = :
+endif
+CLASSPATH    = $(JDK)/lib/classes.zip$(SEP)$(CLASSDIR)/$(OBJDIR)
+
+include $(DEPTH)/ref-config/$(OS_CONFIG).mk
+
+ifndef OBJ_SUFFIX
+ifdef USE_MSVC
+OBJ_SUFFIX = obj
+else
+OBJ_SUFFIX = o
+endif
+endif
+
+ifndef HOST_BIN_SUFFIX
+ifeq ($(OS_ARCH),WINNT)
+HOST_BIN_SUFFIX = .exe
+else
+HOST_BIN_SUFFIX =
+endif
+endif
+
+# Name of the binary code directories
+ifdef OBJROOT
+# prepend $(DEPTH) to the root unless it is an absolute path
+OBJDIR = $(if $(filter /%,$(OBJROOT)),$(OBJROOT),$(DEPTH)/$(OBJROOT))
+else
+ifeq ($(DEPTH),.)
+OBJDIR = $(OS_CONFIG)$(OBJDIR_TAG).$(if $(BUILD_IDG),OBJD,OBJ)
+else
+OBJDIR = $(DEPTH)/$(OS_CONFIG)$(OBJDIR_TAG).$(if $(BUILD_IDG),OBJD,OBJ)
+endif
+endif
+
+VPATH = $(OBJDIR)
+
+LCJAR = js15lc30.jar
+
+# Library name
+LIBDIR := lib
+ifeq ($(CPU_ARCH), x86_64)
+LIBDIR := lib64
+endif
+
diff -r a4343d61f6ee js/src/config/rules.mk
--- a/js/src/config/rules.mk	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/config/rules.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -350,16 +350,19 @@ endif
 
 XPIDL_GEN_DIR		= _xpidlgen
 
 ifdef MOZ_UPDATE_XTERM
 # Its good not to have a newline at the end of the titlebar string because it
 # makes the make -s output easier to read.  Echo -n does not work on all
 # platforms, but we can trick sed into doing it.
 UPDATE_TITLE = sed -e "s!Y!$@ in $(shell $(BUILD_TOOLS)/print-depth-path.sh)/$(dir)!" $(MOZILLA_DIR)/config/xterm.str;
+UPDATE_TITLE_export = sed -e "s!Y!export in $(shell $(BUILD_TOOLS)/print-depth-path.sh)/$*!" $(MOZILLA_DIR)/config/xterm.str;
+UPDATE_TITLE_libs = sed -e "s!Y!libs in $(shell $(BUILD_TOOLS)/print-depth-path.sh)/$*!" $(MOZILLA_DIR)/config/xterm.str;
+UPDATE_TITLE_tools = sed -e "s!Y!tools in $(shell $(BUILD_TOOLS)/print-depth-path.sh)/$*!" $(MOZILLA_DIR)/config/xterm.str;
 endif
 
 LOOP_OVER_DIRS = \
     @$(EXIT_ON_ERROR) \
     $(foreach dir,$(DIRS),$(UPDATE_TITLE) $(MAKE) -C $(dir) $@; ) true
 
 # we only use this for the makefiles target and other stuff that doesn't matter
 LOOP_OVER_PARALLEL_DIRS = \
@@ -391,18 +394,20 @@ PROGOBJS		= $(OBJS)
 PROGOBJS		= $(OBJS)
 endif
 
 ifndef HOST_PROGOBJS
 HOST_PROGOBJS		= $(HOST_OBJS)
 endif
 
 # MAKE_DIRS: List of directories to build while looping over directories.
-ifneq (,$(OBJS)$(XPIDLSRCS)$(SDK_XPIDLSRCS)$(SIMPLE_PROGRAMS))
-MAKE_DIRS		+= $(MDDEPDIR)
+# A Makefile that needs $(MDDEPDIR) created but doesn't set any of these
+# variables we know to check can just set NEED_MDDEPDIR explicitly.
+ifneq (,$(OBJS)$(XPIDLSRCS)$(SDK_XPIDLSRCS)$(SIMPLE_PROGRAMS)$(NEED_MDDEPDIR))
+MAKE_DIRS		+= $(CURDIR)/$(MDDEPDIR)
 GARBAGE_DIRS		+= $(MDDEPDIR)
 endif
 
 #
 # Tags: emacs (etags), vi (ctags)
 # TAG_PROGRAM := ctags -L -
 #
 TAG_PROGRAM		= xargs etags -a
@@ -692,28 +697,28 @@ ifneq (,$(DIRS)$(TOOL_DIRS)$(PARALLEL_DI
 	+$(LOOP_OVER_DIRS)
 	+$(LOOP_OVER_TOOL_DIRS)
 endif
 
 ifdef PARALLEL_DIRS
 export:: $(PARALLEL_DIRS_export)
 
 $(PARALLEL_DIRS_export): %_export: %/Makefile
-	+$(MAKE) -C $* export
+	+@$(UPDATE_TITLE_export) $(MAKE) -C $* export
 endif
 
 export:: $(SUBMAKEFILES) $(MAKE_DIRS) $(if $(EXPORTS)$(XPIDLSRCS)$(SDK_HEADERS)$(SDK_XPIDLSRCS),$(PUBLIC)) $(if $(SDK_HEADERS)$(SDK_XPIDLSRCS),$(SDK_PUBLIC)) $(if $(XPIDLSRCS),$(IDL_DIR)) $(if $(SDK_XPIDLSRCS),$(SDK_IDL_DIR))
 	+$(LOOP_OVER_DIRS)
 	+$(LOOP_OVER_TOOL_DIRS)
 
 ifdef PARALLEL_DIRS
 tools:: $(PARALLEL_DIRS_tools)
 
 $(PARALLEL_DIRS_tools): %_tools: %/Makefile
-	+$(MAKE) -C $* tools
+	+@$(UPDATE_TITLE_tools) $(MAKE) -C $* tools
 endif
 
 tools:: $(SUBMAKEFILES) $(MAKE_DIRS)
 	+$(LOOP_OVER_DIRS)
 ifdef TOOL_DIRS
 	@$(EXIT_ON_ERROR) \
 	$(foreach dir,$(TOOL_DIRS),$(UPDATE_TITLE) $(MAKE) -C $(dir) libs; ) true
 endif
@@ -742,17 +747,17 @@ HOST_LIBS_DEPS = $(filter %.$(LIB_SUFFIX
 HOST_LIBS_DEPS = $(filter %.$(LIB_SUFFIX), $(HOST_LIBS))
 DSO_LDOPTS_DEPS = $(EXTRA_DSO_LIBS) $(filter %.$(LIB_SUFFIX), $(EXTRA_DSO_LDOPTS))
 
 ##############################################
 ifdef PARALLEL_DIRS
 libs:: $(PARALLEL_DIRS_libs)
 
 $(PARALLEL_DIRS_libs): %_libs: %/Makefile
-	+$(MAKE) -C $* libs
+	+@$(UPDATE_TITLE_libs) $(MAKE) -C $* libs
 endif
 
 libs:: $(SUBMAKEFILES) $(MAKE_DIRS) $(HOST_LIBRARY) $(LIBRARY) $(SHARED_LIBRARY) $(IMPORT_LIBRARY) $(HOST_PROGRAM) $(PROGRAM) $(HOST_SIMPLE_PROGRAMS) $(SIMPLE_PROGRAMS) $(JAVA_LIBRARY)
 ifndef NO_DIST_INSTALL
 ifdef LIBRARY
 ifdef EXPORT_LIBRARY # Stage libs that will be linked into a static build
 ifdef IS_COMPONENT
 	$(INSTALL) $(IFLAGS1) $(LIBRARY) $(DEPTH)/staticlib/components
@@ -1480,17 +1485,16 @@ endif
 endif
 endif
 
 ifneq ($(XPI_NAME),)
 $(FINAL_TARGET):
 	$(NSINSTALL) -D $@
 
 export:: $(FINAL_TARGET)
-	$(NSINSTALL) -D $(FINAL_TARGET)
 endif
 
 ifndef NO_DIST_INSTALL
 ifneq ($(EXPORTS),)
 export:: $(EXPORTS) $(PUBLIC)
 	$(INSTALL) $(IFLAGS1) $^
 endif 
 
@@ -2036,17 +2040,23 @@ endif # COMPILER_DEPEND
 
 
 #############################################################################
 # MDDEPDIR is the subdirectory where all the dependency files are placed.
 #   This uses a make rule (instead of a macro) to support parallel
 #   builds (-jN). If this were done in the LOOP_OVER_DIRS macro, two
 #   processes could simultaneously try to create the same directory.
 #
-$(MDDEPDIR):
+#   We use $(CURDIR) in the rule's target to ensure that we don't find
+#   a dependency directory in the source tree via VPATH (perhaps from
+#   a previous build in the source tree) and thus neglect to create a
+#   dependency directory in the object directory, where we really need
+#   it.
+
+$(CURDIR)/$(MDDEPDIR):
 	@if test ! -d $@; then echo Creating $@; rm -rf $@; mkdir $@; else true; fi
 
 ifneq (,$(filter-out all chrome default export realchrome tools clean clobber clobber_all distclean realclean,$(MAKECMDGOALS)))
 ifneq (,$(OBJS)$(XPIDLSRCS)$(SDK_XPIDLSRCS)$(SIMPLE_PROGRAMS))
 MDDEPEND_FILES		:= $(strip $(wildcard $(MDDEPDIR)/*.pp))
 
 ifneq (,$(MDDEPEND_FILES))
 ifdef PERL
diff -r a4343d61f6ee js/src/jitstats.tbl
--- a/js/src/jitstats.tbl	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jitstats.tbl	Sat Nov 15 19:43:13 2008 -0500
@@ -44,8 +44,9 @@ JITSTAT(traceTriggered)
 JITSTAT(traceTriggered)
 JITSTAT(globalShapeMismatchAtEntry)
 JITSTAT(treesTrashed)
 JITSTAT(slotPromoted)
 JITSTAT(unstableLoopVariable)
 JITSTAT(breakLoopExits)
 JITSTAT(returnLoopExits)
 JITSTAT(mergedLoopExits)
+JITSTAT(noCompatInnerTrees)
diff -r a4343d61f6ee js/src/js.cpp
--- a/js/src/js.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/js.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -3792,17 +3792,17 @@ MakeAbsolutePathname(JSContext *cx, cons
 
     if (!slash) {
         /* We were given a leaf or |from| was empty. */
         return JS_strdup(cx, leaf);
     }
 
     /* Else, we were given a real pathname, return that + the leaf. */
     dirlen = slash - from + 1;
-    dir = JS_malloc(cx, dirlen + strlen(leaf) + 1);
+    dir = (char*) JS_malloc(cx, dirlen + strlen(leaf) + 1);
     if (!dir)
         return NULL;
 
     strncpy(dir, from, dirlen);
     strcpy(dir + dirlen, leaf); /* Note: we can't use strcat here. */
 
     return dir;
 }
@@ -3840,17 +3840,17 @@ snarf(JSContext *cx, JSObject *obj, uint
     } else {
         if (fseek(file, 0, SEEK_END) == EOF) {
             JS_ReportError(cx, "can't seek end of %s", pathname);
         } else {
             len = ftell(file);
             if (len == -1 || fseek(file, 0, SEEK_SET) == EOF) {
                 JS_ReportError(cx, "can't seek start of %s", pathname);
             } else {
-                buf = JS_malloc(cx, len + 1);
+                buf = (char*) JS_malloc(cx, len + 1);
                 if (buf) {
                     cc = fread(buf, 1, len, file);
                     if (cc != len) {
                         JS_free(cx, buf);
                         JS_ReportError(cx, "can't read %s: %s", pathname,
                                        (cc < 0) ? strerror(errno)
                                                 : "short read");
                     } else {
diff -r a4343d61f6ee js/src/jsapi.cpp
--- a/js/src/jsapi.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsapi.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -545,16 +545,23 @@ JS_ValueToConstructor(JSContext *cx, jsv
 
 JS_PUBLIC_API(JSString *)
 JS_ValueToString(JSContext *cx, jsval v)
 {
     CHECK_REQUEST(cx);
     return js_ValueToString(cx, v);
 }
 
+JS_PUBLIC_API(JSString *)
+JS_ValueToSource(JSContext *cx, jsval v)
+{
+    CHECK_REQUEST(cx);
+    return js_ValueToSource(cx, v);
+}
+
 JS_PUBLIC_API(JSBool)
 JS_ValueToNumber(JSContext *cx, jsval v, jsdouble *dp)
 {
     JSTempValueRooter tvr;
 
     CHECK_REQUEST(cx);
     JS_PUSH_SINGLE_TEMP_ROOT(cx, v, &tvr);
     *dp = js_ValueToNumber(cx, &tvr.u.value);
@@ -658,17 +665,17 @@ JS_TypeOfValue(JSContext *cx, jsval v)
                     : ops->call != NULL) {
                     type = JSTYPE_FUNCTION;
                 } else {
 #ifdef NARCISSUS
                     JSAutoResolveFlags rf(cx, JSRESOLVE_QUALIFIED);
 
                     if (!OBJ_GET_PROPERTY(cx, obj,
                                           ATOM_TO_JSID(cx->runtime->atomState
-                                                       .callAtom),
+                                                       .__call__Atom),
                                           &v)) {
                         JS_ClearPendingException(cx);
                     } else if (VALUE_IS_FUNCTION(cx, v)) {
                         type = JSTYPE_FUNCTION;
                     }
 #endif
                 }
             }
diff -r a4343d61f6ee js/src/jsapi.h
--- a/js/src/jsapi.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsapi.h	Sat Nov 15 19:43:13 2008 -0500
@@ -333,16 +333,19 @@ extern JS_PUBLIC_API(JSFunction *)
 extern JS_PUBLIC_API(JSFunction *)
 JS_ValueToFunction(JSContext *cx, jsval v);
 
 extern JS_PUBLIC_API(JSFunction *)
 JS_ValueToConstructor(JSContext *cx, jsval v);
 
 extern JS_PUBLIC_API(JSString *)
 JS_ValueToString(JSContext *cx, jsval v);
+
+extern JS_PUBLIC_API(JSString *)
+JS_ValueToSource(JSContext *cx, jsval v);
 
 extern JS_PUBLIC_API(JSBool)
 JS_ValueToNumber(JSContext *cx, jsval v, jsdouble *dp);
 
 /*
  * Convert a value to a number, then to an int32, according to the ECMA rules
  * for ToInt32.
  */
diff -r a4343d61f6ee js/src/jsarray.cpp
--- a/js/src/jsarray.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsarray.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -1542,16 +1542,26 @@ Array_p_join(JSContext* cx, JSObject* ob
 Array_p_join(JSContext* cx, JSObject* obj, JSString *str)
 {
     jsval v;
     if (!array_join_sub(cx, obj, TO_STRING, str, &v))
         return NULL;
     JS_ASSERT(JSVAL_IS_STRING(v));
     return JSVAL_TO_STRING(v);
 }
+
+static JSString* FASTCALL
+Array_p_toString(JSContext* cx, JSObject* obj)
+{
+    jsval v;
+    if (!array_join_sub(cx, obj, TO_STRING, NULL, &v))
+        return NULL;
+    JS_ASSERT(JSVAL_IS_STRING(v));
+    return JSVAL_TO_STRING(v);
+}
 #endif
 
 /*
  * Perl-inspired join, reverse, and sort.
  */
 static JSBool
 array_join(JSContext *cx, uintN argc, jsval *vp)
 {
@@ -2962,28 +2972,30 @@ array_every(JSContext *cx, uintN argc, j
 #endif
 
 static JSPropertySpec array_props[] = {
     {js_length_str,   -1,   JSPROP_SHARED | JSPROP_PERMANENT,
                             array_length_getter,    array_length_setter},
     {0,0,0,0,0}
 };
 
+JS_DEFINE_TRCINFO_1(array_toString,
+    (2, (static, STRING_FAIL, Array_p_toString, CONTEXT, THIS,      0, 0)))
 JS_DEFINE_TRCINFO_1(array_join,
     (3, (static, STRING_FAIL, Array_p_join, CONTEXT, THIS, STRING,  0, 0)))
 JS_DEFINE_TRCINFO_1(array_push,
-    (3, (static, JSVAL_FAIL, Array_p_push1, CONTEXT, THIS, JSVAL,  0, 0)))
+    (3, (static, JSVAL_FAIL, Array_p_push1, CONTEXT, THIS, JSVAL,   0, 0)))
 JS_DEFINE_TRCINFO_1(array_pop,
-    (2, (static, JSVAL_FAIL, Array_p_pop, CONTEXT, THIS,           0, 0)))
+    (2, (static, JSVAL_FAIL, Array_p_pop, CONTEXT, THIS,            0, 0)))
 
 static JSFunctionSpec array_methods[] = {
 #if JS_HAS_TOSOURCE
     JS_FN(js_toSource_str,      array_toSource,     0,0),
 #endif
-    JS_FN(js_toString_str,      array_toString,     0,0),
+    JS_TN(js_toString_str,      array_toString,     0,0, array_toString_trcinfo),
     JS_FN(js_toLocaleString_str,array_toLocaleString,0,0),
 
     /* Perl-ish methods. */
     JS_TN("join",               array_join,         1,JSFUN_GENERIC_NATIVE, array_join_trcinfo),
     JS_FN("reverse",            array_reverse,      0,JSFUN_GENERIC_NATIVE),
     JS_FN("sort",               array_sort,         1,JSFUN_GENERIC_NATIVE),
     JS_TN("push",               array_push,         1,JSFUN_GENERIC_NATIVE, array_push_trcinfo),
     JS_TN("pop",                array_pop,          0,JSFUN_GENERIC_NATIVE, array_pop_trcinfo),
diff -r a4343d61f6ee js/src/jsatom.cpp
--- a/js/src/jsatom.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsatom.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -63,46 +63,52 @@ js_AtomToPrintableString(JSContext *cx, 
     return js_ValueToPrintableString(cx, ATOM_KEY(atom));
 }
 
 #define JS_PROTO(name,code,init) const char js_##name##_str[] = #name;
 #include "jsproto.tbl"
 #undef JS_PROTO
 
 /*
- * Names for common atoms defined in JSAtomState starting from
+ * String constants for common atoms defined in JSAtomState starting from
  * JSAtomState.emptyAtom until JSAtomState.lazy.
  *
  * The elements of the array after the first empty string define strings
- * corresponding to JSType enumerators from jspubtd.h and to two boolean
- * literals, false and true. The following assert insists that JSType defines
- * exactly 8 types.
+ * corresponding to the two boolean literals, false and true, followed by the
+ * JSType enumerators from jspubtd.h starting with "undefined" for JSTYPE_VOID
+ * (which is pseudo-boolean 2) and continuing as initialized below. The static
+ * asserts check these relations.
  */
 JS_STATIC_ASSERT(JSTYPE_LIMIT == 8);
+JS_STATIC_ASSERT(JSVAL_TO_BOOLEAN(JSVAL_VOID) == 2);
+JS_STATIC_ASSERT(JSTYPE_VOID == 0);
+
 const char *const js_common_atom_names[] = {
     "",                         /* emptyAtom                    */
+    js_false_str,               /* booleanAtoms[0]              */
+    js_true_str,                /* booleanAtoms[1]              */
     js_undefined_str,           /* typeAtoms[JSTYPE_VOID]       */
     js_object_str,              /* typeAtoms[JSTYPE_OBJECT]     */
     js_function_str,            /* typeAtoms[JSTYPE_FUNCTION]   */
     "string",                   /* typeAtoms[JSTYPE_STRING]     */
     "number",                   /* typeAtoms[JSTYPE_NUMBER]     */
     "boolean",                  /* typeAtoms[JSTYPE_BOOLEAN]    */
     js_null_str,                /* typeAtoms[JSTYPE_NULL]       */
     "xml",                      /* typeAtoms[JSTYPE_XML]        */
-    js_false_str,               /* booleanAtoms[0]              */
-    js_true_str,                /* booleanAtoms[1]              */
     js_null_str,                /* nullAtom                     */
 
 #define JS_PROTO(name,code,init) js_##name##_str,
 #include "jsproto.tbl"
 #undef JS_PROTO
 
     js_anonymous_str,           /* anonymousAtom                */
+    js_apply_str,               /* applyAtom                    */
     js_arguments_str,           /* argumentsAtom                */
     js_arity_str,               /* arityAtom                    */
+    js_call_str,                /* callAtom                     */
     js_callee_str,              /* calleeAtom                   */
     js_caller_str,              /* callerAtom                   */
     js_class_prototype_str,     /* classPrototypeAtom           */
     js_constructor_str,         /* constructorAtom              */
     js_count_str,               /* countAtom                    */
     js_each_str,                /* eachAtom                     */
     js_eval_str,                /* evalAtom                     */
     js_fileName_str,            /* fileNameAtom                 */
@@ -138,29 +144,40 @@ const char *const js_common_atom_names[]
     js_stago_str,               /* stagoAtom                    */
     js_star_str,                /* starAtom                     */
     js_starQualifier_str,       /* starQualifierAtom            */
     js_tagc_str,                /* tagcAtom                     */
     js_xml_str,                 /* xmlAtom                      */
 #endif
 
 #ifdef NARCISSUS
-    js_call_str,                /* callAtom                     */
-    js_construct_str,           /* constructAtom                */
-    js_hasInstance_str,         /* hasInstanceAtom              */
+    js___call___str,            /* __call__Atom                 */
+    js___construct___str,       /* __construct__Atom            */
+    js___hasInstance___str,     /* __hasInstance__Atom          */
     js_ExecutionContext_str,    /* ExecutionContextAtom         */
     js_current_str,             /* currentAtom                  */
 #endif
 };
+
 JS_STATIC_ASSERT(JS_ARRAY_LENGTH(js_common_atom_names) * sizeof(JSAtom *) ==
                  LAZY_ATOM_OFFSET_START - ATOM_OFFSET_START);
 
+/*
+ * Interpreter macros called by the trace recorder assume common atom indexes
+ * fit in one byte of immediate operand.
+ */
+JS_STATIC_ASSERT(JS_ARRAY_LENGTH(js_common_atom_names) < 256);
+
+const size_t js_common_atom_count = JS_ARRAY_LENGTH(js_common_atom_names);
+
 const char js_anonymous_str[]       = "anonymous";
+const char js_apply_str[]           = "apply";
 const char js_arguments_str[]       = "arguments";
 const char js_arity_str[]           = "arity";
+const char js_call_str[]            = "call";
 const char js_callee_str[]          = "callee";
 const char js_caller_str[]          = "caller";
 const char js_class_prototype_str[] = "prototype";
 const char js_constructor_str[]     = "constructor";
 const char js_count_str[]           = "__count__";
 const char js_each_str[]            = "each";
 const char js_eval_str[]            = "eval";
 const char js_fileName_str[]        = "fileName";
@@ -202,19 +219,19 @@ const char js_xml_str[]             = "x
 #endif
 
 #if JS_HAS_GENERATORS
 const char js_close_str[]           = "close";
 const char js_send_str[]            = "send";
 #endif
 
 #ifdef NARCISSUS
-const char js_call_str[]             = "__call__";
-const char js_construct_str[]        = "__construct__";
-const char js_hasInstance_str[]      = "__hasInstance__";
+const char js___call___str[]         = "__call__";
+const char js___construct___str[]    = "__construct__";
+const char js___hasInstance___str[]  = "__hasInstance__";
 const char js_ExecutionContext_str[] = "ExecutionContext";
 const char js_current_str[]          = "current";
 #endif
 
 /*
  * JSAtomState.doubleAtoms and JSAtomState.stringAtoms hashtable entry. To
  * support pinned and interned string atoms, we use the lowest bits of the
  * keyAndFlags field to store ATOM_PINNED and ATOM_INTERNED flags.
diff -r a4343d61f6ee js/src/jsatom.h
--- a/js/src/jsatom.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsatom.h	Sat Nov 15 19:43:13 2008 -0500
@@ -157,28 +157,33 @@ struct JSAtomState {
      * js_common_atom_names defined in jsatom.c contains C strings for atoms
      * in the order of atom fields here. Therefore you must update that array
      * if you change member order here.
      */
 
     /* The rt->emptyString atom, see jsstr.c's js_InitRuntimeStringState. */
     JSAtom              *emptyAtom;
 
-    /* Type names and value literals. */
+    /*
+     * Literal value and type names.
+     * NB: booleanAtoms must come right before typeAtoms!
+     */
+    JSAtom              *booleanAtoms[2];
     JSAtom              *typeAtoms[JSTYPE_LIMIT];
-    JSAtom              *booleanAtoms[2];
     JSAtom              *nullAtom;
 
     /* Standard class constructor or prototype names. */
     JSAtom              *classAtoms[JSProto_LIMIT];
 
     /* Various built-in or commonly-used atoms, pinned on first context. */
     JSAtom              *anonymousAtom;
+    JSAtom              *applyAtom;
     JSAtom              *argumentsAtom;
     JSAtom              *arityAtom;
+    JSAtom              *callAtom;
     JSAtom              *calleeAtom;
     JSAtom              *callerAtom;
     JSAtom              *classPrototypeAtom;
     JSAtom              *constructorAtom;
     JSAtom              *countAtom;
     JSAtom              *eachAtom;
     JSAtom              *evalAtom;
     JSAtom              *fileNameAtom;
@@ -214,19 +219,19 @@ struct JSAtomState {
     JSAtom              *stagoAtom;
     JSAtom              *starAtom;
     JSAtom              *starQualifierAtom;
     JSAtom              *tagcAtom;
     JSAtom              *xmlAtom;
 #endif
 
 #ifdef NARCISSUS
-    JSAtom              *callAtom;
-    JSAtom              *constructAtom;
-    JSAtom              *hasInstanceAtom;
+    JSAtom              *__call__Atom;
+    JSAtom              *__construct__Atom;
+    JSAtom              *__hasInstance__Atom;
     JSAtom              *ExecutionContextAtom;
     JSAtom              *currentAtom;
 #endif
 
     /* Less frequently used atoms, pinned lazily by JS_ResolveStandardClass. */
     struct {
         JSAtom          *InfinityAtom;
         JSAtom          *NaNAtom;
@@ -256,52 +261,60 @@ struct JSAtomState {
     } lazy;
 };
 
 #define ATOM_OFFSET_START       offsetof(JSAtomState, emptyAtom)
 #define LAZY_ATOM_OFFSET_START  offsetof(JSAtomState, lazy)
 #define ATOM_OFFSET_LIMIT       (sizeof(JSAtomState))
 
 #define COMMON_ATOMS_START(state)                                             \
-    (JSAtom **)((uint8 *)(state) + ATOM_OFFSET_START)
+    ((JSAtom **)((uint8 *)(state) + ATOM_OFFSET_START))
+#define COMMON_ATOM_INDEX(name)                                               \
+    ((offsetof(JSAtomState, name##Atom) - ATOM_OFFSET_START)                  \
+     / sizeof(JSAtom*))
+#define COMMON_TYPE_ATOM_INDEX(type)                                          \
+    ((offsetof(JSAtomState, typeAtoms[type]) - ATOM_OFFSET_START)             \
+     / sizeof(JSAtom*))
 
 /* Start and limit offsets should correspond to atoms. */
 JS_STATIC_ASSERT(ATOM_OFFSET_START % sizeof(JSAtom *) == 0);
 JS_STATIC_ASSERT(ATOM_OFFSET_LIMIT % sizeof(JSAtom *) == 0);
 
 #define ATOM_OFFSET(name)       offsetof(JSAtomState, name##Atom)
 #define OFFSET_TO_ATOM(rt,off)  (*(JSAtom **)((char*)&(rt)->atomState + (off)))
 #define CLASS_ATOM_OFFSET(name) offsetof(JSAtomState,classAtoms[JSProto_##name])
 
 #define CLASS_ATOM(cx,name) \
     ((cx)->runtime->atomState.classAtoms[JSProto_##name])
 
 extern const char *const js_common_atom_names[];
+extern const size_t      js_common_atom_count;
 
 /*
  * Macros to access C strings for JSType and boolean literals together with
- * checks that type names and booleans starts from index 1 and 1+JSTYPE_LIMIT
- * correspondingly.
+ * checks that boolean names start from index 1 and type names from 1+2.
  */
-#define JS_TYPE_STR(type)    (js_common_atom_names[1 + (type)])
-#define JS_BOOLEAN_STR(type) (js_common_atom_names[1 + JSTYPE_LIMIT + (type)])
+#define JS_BOOLEAN_STR(type) (js_common_atom_names[1 + (type)])
+#define JS_TYPE_STR(type)    (js_common_atom_names[1 + 2 + (type)])
 
 JS_STATIC_ASSERT(1 * sizeof(JSAtom *) ==
+                 offsetof(JSAtomState, booleanAtoms) - ATOM_OFFSET_START);
+JS_STATIC_ASSERT((1 + 2) * sizeof(JSAtom *) ==
                  offsetof(JSAtomState, typeAtoms) - ATOM_OFFSET_START);
-JS_STATIC_ASSERT((1 + JSTYPE_LIMIT) * sizeof(JSAtom *) ==
-                 offsetof(JSAtomState, booleanAtoms) - ATOM_OFFSET_START);
 
 /* Well-known predefined C strings. */
 #define JS_PROTO(name,code,init) extern const char js_##name##_str[];
 #include "jsproto.tbl"
 #undef JS_PROTO
 
 extern const char   js_anonymous_str[];
+extern const char   js_apply_str[];
 extern const char   js_arguments_str[];
 extern const char   js_arity_str[];
+extern const char   js_call_str[];
 extern const char   js_callee_str[];
 extern const char   js_caller_str[];
 extern const char   js_class_prototype_str[];
 extern const char   js_close_str[];
 extern const char   js_constructor_str[];
 extern const char   js_count_str[];
 extern const char   js_etago_str[];
 extern const char   js_each_str[];
@@ -337,19 +350,19 @@ extern const char   js_toString_str[];
 extern const char   js_toString_str[];
 extern const char   js_toLocaleString_str[];
 extern const char   js_undefined_str[];
 extern const char   js_valueOf_str[];
 extern const char   js_toJSON_str[];
 extern const char   js_xml_str[];
 
 #ifdef NARCISSUS
-extern const char   js_call_str[];
-extern const char   js_construct_str[];
-extern const char   js_hasInstance_str[];
+extern const char   js___call___str[];
+extern const char   js___construct___str[];
+extern const char   js___hasInstance___str[];
 extern const char   js_ExecutionContext_str[];
 extern const char   js_current_str[];
 #endif
 
 /*
  * Initialize atom state. Return true on success, false on failure to allocate
  * memory. The caller must zero rt->atomState before calling this function and
  * only call it after js_InitGC successfully returns.
diff -r a4343d61f6ee js/src/jsbuiltins.cpp
--- a/js/src/jsbuiltins.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsbuiltins.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -260,17 +260,17 @@ js_CallTree(InterpState* state, Fragment
     JS_ASSERT(u.code);
 
     GuardRecord* rec;
 #if defined(JS_NO_FASTCALL) && defined(NANOJIT_IA32)
     SIMULATE_FASTCALL(rec, state, NULL, u.func);
 #else
     rec = u.func(state, NULL);
 #endif
-    SideExit* lr = rec->exit;
+    VMSideExit* lr = (VMSideExit*)rec->exit;
 
     if (lr->exitType == NESTED_EXIT) {
         /* This only occurs once a tree call guard mismatches and we unwind the tree call stack.
            We store the first (innermost) tree call guard in state and we will try to grow
            the outer tree the failing call was in starting at that guard. */
         if (!state->lastTreeCallGuard) {
             state->lastTreeCallGuard = lr;
             FrameInfo* rp = (FrameInfo*)state->rp;
@@ -427,21 +427,28 @@ js_TypeOfBoolean(JSContext* cx, int32 un
 {
     jsval boxed = BOOLEAN_TO_JSVAL(unboxed);
     JS_ASSERT(JSVAL_IS_VOID(boxed) || JSVAL_IS_BOOLEAN(boxed));
     JSType type = JS_TypeOfValue(cx, boxed);
     return ATOM_TO_STRING(cx->runtime->atomState.typeAtoms[type]);
 }
 
 jsdouble FASTCALL
-js_BooleanToNumber(JSContext* cx, int32 unboxed)
+js_BooleanOrUndefinedToNumber(JSContext* cx, int32 unboxed)
 {
     if (unboxed == JSVAL_TO_BOOLEAN(JSVAL_VOID))
         return js_NaN;
     return unboxed;
+}
+
+JSString* FASTCALL
+js_BooleanOrUndefinedToString(JSContext *cx, int32 unboxed)
+{
+    JS_ASSERT(uint32(unboxed) <= 2);
+    return ATOM_TO_STRING(cx->runtime->atomState.booleanAtoms[unboxed]);
 }
 
 JSString* FASTCALL
 js_ObjectToString(JSContext* cx, JSObject* obj)
 {
     if (!obj)
         return ATOM_TO_STRING(cx->runtime->atomState.nullAtom);
     jsval v;
diff -r a4343d61f6ee js/src/jsbuiltins.h
--- a/js/src/jsbuiltins.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsbuiltins.h	Sat Nov 15 19:43:13 2008 -0500
@@ -38,16 +38,17 @@
  * ***** END LICENSE BLOCK ***** */
 
 #ifndef jsbuiltins_h___
 #define jsbuiltins_h___
 
 #ifdef JS_TRACER
 
 #include "nanojit/nanojit.h"
+#include "jstracer.h"
 
 enum JSTNErrType { INFALLIBLE, FAIL_NULL, FAIL_NEG, FAIL_VOID, FAIL_JSVAL };
 enum { JSTN_ERRTYPE_MASK = 7, JSTN_MORE = 8 };
 
 #define JSTN_ERRTYPE(jstn)  ((jstn)->flags & JSTN_ERRTYPE_MASK)
 
 /*
  * |prefix| and |argtypes| declare what arguments should be passed to the
@@ -155,18 +156,18 @@ struct JSTraceableNative {
 #define _JS_CTYPE_DOUBLE           _JS_CTYPE(jsdouble,               _JS_F64, "","d", INFALLIBLE)
 #define _JS_CTYPE_STRING           _JS_CTYPE(JSString *,             _JS_PTR, "","s", INFALLIBLE)
 #define _JS_CTYPE_STRING_FAIL      _JS_CTYPE(JSString *,             _JS_PTR, --, --, FAIL_NULL)
 #define _JS_CTYPE_OBJECT           _JS_CTYPE(JSObject *,             _JS_PTR, "","o", INFALLIBLE)
 #define _JS_CTYPE_OBJECT_FAIL_NULL _JS_CTYPE(JSObject *,             _JS_PTR, --, --, FAIL_NULL)
 #define _JS_CTYPE_OBJECT_FAIL_VOID _JS_CTYPE(JSObject *,             _JS_PTR, --, --, FAIL_VOID)
 #define _JS_CTYPE_REGEXP           _JS_CTYPE(JSObject *,             _JS_PTR, "","r", INFALLIBLE)
 #define _JS_CTYPE_SCOPEPROP        _JS_CTYPE(JSScopeProperty *,      _JS_PTR, --, --, INFALLIBLE)
-#define _JS_CTYPE_SIDEEXIT         _JS_CTYPE(nanojit::SideExit *,    _JS_PTR, --, --, INFALLIBLE)
-#define _JS_CTYPE_INTERPSTATE      _JS_CTYPE(avmplus::InterpState *, _JS_PTR, --, --, INFALLIBLE)
+#define _JS_CTYPE_SIDEEXIT         _JS_CTYPE(SideExit *,             _JS_PTR, --, --, INFALLIBLE)
+#define _JS_CTYPE_INTERPSTATE      _JS_CTYPE(InterpState *,          _JS_PTR, --, --, INFALLIBLE)
 #define _JS_CTYPE_FRAGMENT         _JS_CTYPE(nanojit::Fragment *,    _JS_PTR, --, --, INFALLIBLE)
 
 #define _JS_EXPAND(tokens)  tokens
 
 #define _JS_CTYPE_TYPE2(t,s,p,a,f)      t
 #define _JS_CTYPE_TYPE(tyname)          _JS_EXPAND(_JS_CTYPE_TYPE2    _JS_CTYPE_##tyname)
 #define _JS_CTYPE_RETSIZE2(t,s,p,a,f)   s##_RETSIZE
 #define _JS_CTYPE_RETSIZE(tyname)       _JS_EXPAND(_JS_CTYPE_RETSIZE2 _JS_CTYPE_##tyname)
diff -r a4343d61f6ee js/src/jscntxt.cpp
--- a/js/src/jscntxt.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jscntxt.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -915,17 +915,17 @@ js_ReportOutOfMemory(JSContext *cx)
 
     /*
      * Walk stack until we find a frame that is associated with some script
      * rather than a native frame.
      */
     for (fp = cx->fp; fp; fp = fp->down) {
         if (fp->regs) {
             report.filename = fp->script->filename;
-            report.lineno = js_PCToLineNumber(cx, fp->script, fp->regs->pc);
+            report.lineno = js_FramePCToLineNumber(cx, fp);
             break;
         }
     }
 
     /*
      * If debugErrorHook is present then we give it a chance to veto sending
      * the error on to the regular ErrorReporter. We also clear a pending
      * exception if any now so the hooks can replace the out-of-memory error
@@ -985,17 +985,17 @@ js_ReportErrorVA(JSContext *cx, uintN fl
     report.flags = flags;
     report.errorNumber = JSMSG_USER_DEFINED_ERROR;
     report.ucmessage = ucmessage = js_InflateString(cx, message, &messagelen);
 
     /* Find the top-most active script frame, for best line number blame. */
     for (fp = cx->fp; fp; fp = fp->down) {
         if (fp->regs) {
             report.filename = fp->script->filename;
-            report.lineno = js_PCToLineNumber(cx, fp->script, fp->regs->pc);
+            report.lineno = js_FramePCToLineNumber(cx, fp);
             break;
         }
     }
 
     warning = JSREPORT_IS_WARNING(report.flags);
     if (warning && JS_HAS_WERROR_OPTION(cx)) {
         report.flags &= ~JSREPORT_WARNING;
         warning = JS_FALSE;
@@ -1197,17 +1197,17 @@ js_ReportErrorNumberVA(JSContext *cx, ui
 
     /*
      * If we can't find out where the error was based on the current frame,
      * see if the next frame has a script/pc combo we can use.
      */
     for (fp = cx->fp; fp; fp = fp->down) {
         if (fp->regs) {
             report.filename = fp->script->filename;
-            report.lineno = js_PCToLineNumber(cx, fp->script, fp->regs->pc);
+            report.lineno = js_FramePCToLineNumber(cx, fp);
             break;
         }
     }
 
     if (!js_ExpandErrorArguments(cx, callback, userRef, errorNumber,
                                  &message, &report, &warning, charArgs, ap)) {
         return JS_FALSE;
     }
diff -r a4343d61f6ee js/src/jscntxt.h
--- a/js/src/jscntxt.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jscntxt.h	Sat Nov 15 19:43:13 2008 -0500
@@ -103,28 +103,16 @@ typedef Queue<uint16> SlotList;
 typedef Queue<uint16> SlotList;
 class TypeMap;
 
 # define CLS(T)  T*
 #else
 # define CLS(T)  void*
 #endif
 
-/* 
- * Fragment quick cache entry.
- */
-typedef struct JSFragmentCacheEntry {
-    jsbytecode*             pc;
-    CLS(nanojit::Fragment)  fragment;
-} JSFragmentCacheEntry;
-
-#define JS_FRAGMENT_CACHE_LOG2  2
-#define JS_FRAGMENT_CACHE_SIZE  JS_BIT(JS_FRAGMENT_CACHE_LOG2)
-#define JS_FRAGMENT_CACHE_MASK  JS_BITMASK(JS_FRAGMENT_CACHE_LOG2)
-
 /*
  * Trace monitor. Every JSThread (if JS_THREADSAFE) or JSRuntime (if not
  * JS_THREADSAFE) has an associated trace monitor that keeps track of loop
  * frequencies for all JavaScript code loaded into that runtime.
  */
 typedef struct JSTraceMonitor {
     /*
      * Flag set when running (or recording) JIT-compiled code. This prevents
@@ -133,20 +121,23 @@ typedef struct JSTraceMonitor {
      * JS_ReportOutOfMemory when failing due to runtime limits.
      */
     JSBool                  onTrace;
     CLS(nanojit::Fragmento) fragmento;
     CLS(TraceRecorder)      recorder;
     uint32                  globalShape;
     CLS(SlotList)           globalSlots;
     CLS(TypeMap)            globalTypeMap;
-    JSFragmentCacheEntry    fcache[JS_FRAGMENT_CACHE_SIZE];
     jsval                   *recoveryDoublePool;
     jsval                   *recoveryDoublePoolPtr;
-    uint32                  jitCacheGen;
+
+    /* Fragmento for the regular expression compiler. This is logically
+     * a distinct compiler but needs to be managed in exactly the same
+     * way as the real tracing Fragmento. */
+    CLS(nanojit::Fragmento) reFragmento;
 } JSTraceMonitor;
 
 #ifdef JS_TRACER
 # define JS_ON_TRACE(cx)   (JS_TRACE_MONITOR(cx).onTrace)
 #else
 # define JS_ON_TRACE(cx)   JS_FALSE
 #endif
 
diff -r a4343d61f6ee js/src/jsconfig.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/jsconfig.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,181 @@
+# -*- Mode: makefile -*-
+# 
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+# 
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+# 
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998-1999
+# the Initial Developer. All Rights Reserved.
+# 
+# Contributor(s):
+# 
+# Alternatively, the contents of this file may be used under the terms of
+# either of the GNU General Public License Version 2 or later (the "GPL"),
+# or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+# 
+# ***** END LICENSE BLOCK *****
+
+ifndef OBJDIR
+  ifdef OBJDIR_NAME
+    OBJDIR = $(OBJDIR_NAME)
+  endif
+endif
+
+NSPR_VERSION = v4.0
+NSPR_LIBSUFFIX = 4
+
+NSPR_LOCAL       = $(MOZ_DEPTH)/dist/$(OBJDIR)/nspr
+NSPR_DIST        = $(MOZ_DEPTH)/dist/$(OBJDIR)
+NSPR_OBJDIR      = $(OBJDIR)
+ifeq ($(OS_ARCH), SunOS)
+  NSPR_OBJDIR   := $(subst _sparc,,$(NSPR_OBJDIR))
+endif
+ifeq ($(OS_ARCH), Linux)
+  LINUX_REL     := $(shell uname -r)
+  ifneq (,$(findstring 2.0,$(LINUX_REL)))
+    NSPR_OBJDIR := $(subst _All,2.0_x86_glibc_PTH,$(NSPR_OBJDIR))
+  else
+    NSPR_OBJDIR := $(subst _All,2.2_x86_glibc_PTH,$(NSPR_OBJDIR))
+  endif
+endif
+ifeq ($(OS_ARCH), AIX)
+  NSPR_OBJDIR   := $(subst 4.1,4.2,$(NSPR_OBJDIR))
+endif
+ifeq ($(OS_CONFIG), IRIX6.2)
+  NSPR_OBJDIR   := $(subst 6.2,6.2_n32_PTH,$(NSPR_OBJDIR))
+endif
+ifeq ($(OS_CONFIG), IRIX6.5)
+  NSPR_OBJDIR   := $(subst 6.5,6.5_n32_PTH,$(NSPR_OBJDIR))
+endif
+ifeq ($(OS_ARCH), WINNT)
+  ifeq ($(OBJDIR), WIN32_D.OBJ)
+    NSPR_OBJDIR  = WINNT4.0_DBG.OBJ
+  endif
+  ifeq ($(OBJDIR), WIN32_O.OBJ)
+    NSPR_OBJDIR  = WINNT4.0_OPT.OBJ
+  endif
+endif
+NSPR_SHARED      = /share/builds/components/nspr20/$(NSPR_VERSION)/$(NSPR_OBJDIR)
+ifeq ($(OS_ARCH), WINNT)
+  NSPR_SHARED    = nspr20/$(NSPR_VERSION)/$(NSPR_OBJDIR)
+endif
+NSPR_VERSIONFILE = $(NSPR_LOCAL)/Version
+NSPR_CURVERSION := $(shell cat $(NSPR_VERSIONFILE) 2>/dev/null)
+
+get_nspr:
+	@echo "Grabbing NSPR component..."
+ifeq ($(NSPR_VERSION), $(NSPR_CURVERSION))
+	@echo "No need, NSPR is up to date in this tree (ver=$(NSPR_VERSION))."
+else
+	mkdir -p $(NSPR_LOCAL)
+	mkdir -p $(NSPR_DIST)
+  ifneq ($(OS_ARCH), WINNT)
+	cp       $(NSPR_SHARED)/*.jar $(NSPR_LOCAL)
+  else
+	sh       $(MOZ_DEPTH)/../reltools/compftp.sh $(NSPR_SHARED) $(NSPR_LOCAL) *.jar
+  endif
+	unzip -o $(NSPR_LOCAL)/mdbinary.jar -d $(NSPR_DIST)
+	mkdir -p $(NSPR_DIST)/include
+	unzip -o $(NSPR_LOCAL)/mdheader.jar -d $(NSPR_DIST)/include
+	rm -rf   $(NSPR_DIST)/META-INF
+	rm -rf   $(NSPR_DIST)/include/META-INF
+	echo $(NSPR_VERSION) > $(NSPR_VERSIONFILE)
+endif
+
+SHIP_DIST  = $(MOZ_DEPTH)/dist/$(OBJDIR)
+SHIP_DIR   = $(SHIP_DIST)/SHIP
+
+SHIP_LIBS      = libjs.$(SO_SUFFIX) libjs.a
+ifdef JS_LIVECONNECT
+  SHIP_LIBS   += libjsj.$(SO_SUFFIX) libjsj.a
+endif
+ifeq ($(OS_ARCH), WINNT)
+  SHIP_LIBS    = js32.dll js32.lib
+  ifdef JS_LIVECONNECT
+    SHIP_LIBS += jsj.dll jsj.lib
+  endif
+endif
+SHIP_LIBS     += $(LCJAR)
+SHIP_LIBS     := $(addprefix $(SHIP_DIST)/lib/, $(SHIP_LIBS))
+
+SHIP_INCS      = js*.h prmjtime.h resource.h *.msg *.tbl
+ifdef JS_LIVECONNECT
+  SHIP_INCS   += netscape*.h nsC*.h nsI*.h
+endif
+SHIP_INCS     := $(addprefix $(SHIP_DIST)/include/, $(SHIP_INCS))
+
+SHIP_BINS      = js
+ifdef JS_LIVECONNECT
+  SHIP_BINS   += lcshell
+endif
+ifeq ($(OS_ARCH), WINNT)
+  SHIP_BINS   := $(addsuffix .exe, $(SHIP_BINS))
+endif
+SHIP_BINS     := $(addprefix $(SHIP_DIST)/bin/, $(SHIP_BINS))
+
+ifdef BUILD_OPT
+  JSREFJAR = jsref_opt.jar
+else
+ifdef BUILD_IDG
+  JSREFJAR = jsref_idg.jar
+else
+  JSREFJAR = jsref_dbg.jar
+endif
+endif
+
+ship:
+	mkdir -p $(SHIP_DIR)/$(LIBDIR)
+	mkdir -p $(SHIP_DIR)/include
+	mkdir -p $(SHIP_DIR)/bin
+	cp $(SHIP_LIBS) $(SHIP_DIR)/$(LIBDIR)
+	cp $(SHIP_INCS) $(SHIP_DIR)/include
+	cp $(SHIP_BINS) $(SHIP_DIR)/bin
+	cd $(SHIP_DIR); \
+	  zip -r $(JSREFJAR) bin lib include
+ifdef BUILD_SHIP
+	cp $(SHIP_DIR)/$(JSREFJAR) $(BUILD_SHIP)
+endif
+
+CWD = $(shell pwd)
+shipSource: $(SHIP_DIR)/jsref_src.lst .FORCE
+	mkdir -p $(SHIP_DIR)
+	cd $(MOZ_DEPTH)/.. ; \
+	  zip $(CWD)/$(SHIP_DIR)/jsref_src.jar -@ < $(CWD)/$(SHIP_DIR)/jsref_src.lst
+ifdef BUILD_SHIP
+	cp $(SHIP_DIR)/jsref_src.jar $(BUILD_SHIP)
+endif
+
+JSREFSRCDIRS := $(shell cat $(DEPTH)/SpiderMonkey.rsp)
+$(SHIP_DIR)/jsref_src.lst: .FORCE
+	mkdir -p $(SHIP_DIR)
+	rm -f $@
+	touch $@
+	for d in $(JSREFSRCDIRS); do                                \
+	  cd $(MOZ_DEPTH)/..;                                       \
+	  ls -1 -d $$d | grep -v CVS | grep -v \.OBJ >> $(CWD)/$@;  \
+	  cd $(CWD);                                                \
+	done
+
+.FORCE:
diff -r a4343d61f6ee js/src/jsdate.cpp
--- a/js/src/jsdate.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsdate.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -1963,52 +1963,75 @@ date_toString(JSContext *cx, uintN argc,
 {
     jsdouble utctime;
 
     if (!GetUTCTime(cx, JS_THIS_OBJECT(cx, vp), vp, &utctime))
         return JS_FALSE;
     return date_format(cx, utctime, FORMATSPEC_FULL, vp);
 }
 
+#ifdef JS_TRACER
+static jsval FASTCALL
+date_valueOf_tn(JSContext* cx, JSObject* obj, JSString* str)
+{
+    JS_ASSERT(JS_InstanceOf(cx, obj, &js_DateClass, NULL));
+    jsdouble t = *JSVAL_TO_DOUBLE(obj->fslots[JSSLOT_UTC_TIME]);
+
+    JSString* number_str = ATOM_TO_STRING(cx->runtime->atomState.typeAtoms[JSTYPE_NUMBER]);
+    jsval v;
+    if (js_EqualStrings(str, number_str)) {
+        if (!js_NewNumberInRootedValue(cx, t, &v))
+            return JSVAL_ERROR_COOKIE;
+    } else {
+        if (!date_format(cx, t, FORMATSPEC_FULL, &v))
+            return JSVAL_ERROR_COOKIE;
+    }
+    return v;
+}
+#endif
+
 static JSBool
 date_valueOf(JSContext *cx, uintN argc, jsval *vp)
 {
-    JSString *str, *str2;
+    JSString *str, *number_str;
 
     /* It is an error to call date_valueOf on a non-date object, but we don't
      * need to check for that explicitly here because every path calls
      * GetUTCTime, which does the check.
      */
 
     /* If called directly with no arguments, convert to a time number. */
     if (argc == 0)
         return date_getTime(cx, argc, vp);
 
     /* Convert to number only if the hint was given, otherwise favor string. */
     str = js_ValueToString(cx, vp[2]);
     if (!str)
         return JS_FALSE;
-    str2 = ATOM_TO_STRING(cx->runtime->atomState.typeAtoms[JSTYPE_NUMBER]);
-    if (js_EqualStrings(str, str2))
+    number_str = ATOM_TO_STRING(cx->runtime->atomState.typeAtoms[JSTYPE_NUMBER]);
+    if (js_EqualStrings(str, number_str))
         return date_getTime(cx, argc, vp);
     return date_toString(cx, argc, vp);
 }
 
 JS_DEFINE_CALLINFO_2(extern, OBJECT, js_FastNewDate, CONTEXT, OBJECT, 0, 0)
 
 // Don't really need an argument here, but we don't support arg-less builtins
 JS_DEFINE_TRCINFO_1(date_now,
     (1, (static, DOUBLE, date_now_tn, CONTEXT, 0, 0)))
 
 static JSFunctionSpec date_static_methods[] = {
     JS_FN("UTC",                 date_UTC,                MAXARGS,0),
     JS_FN("parse",               date_parse,              1,0),
     JS_TN("now",                 date_now,                0,0, date_now_trcinfo),
     JS_FS_END
 };
+
+JS_DEFINE_TRCINFO_1(date_valueOf,
+    (3, (static, JSVAL_FAIL, date_valueOf_tn, CONTEXT, THIS, STRING, 0, 0)))
 
 static JSFunctionSpec date_methods[] = {
     JS_FN("getTime",             date_getTime,            0,0),
     JS_FN("getTimezoneOffset",   date_getTimezoneOffset,  0,0),
     JS_FN("getYear",             date_getYear,            0,0),
     JS_FN("getFullYear",         date_getFullYear,        0,0),
     JS_FN("getUTCFullYear",      date_getUTCFullYear,     0,0),
     JS_FN("getMonth",            date_getMonth,           0,0),
@@ -2050,17 +2073,17 @@ static JSFunctionSpec date_methods[] = {
     JS_FN("toTimeString",        date_toTimeString,       0,0),
     JS_FN("toISOString",         date_toISOString,        0,0),
     JS_FN(js_toJSON_str,         date_toISOString,        0,0),
 
 #if JS_HAS_TOSOURCE
     JS_FN(js_toSource_str,       date_toSource,           0,0),
 #endif
     JS_FN(js_toString_str,       date_toString,           0,0),
-    JS_FN(js_valueOf_str,        date_valueOf,            0,0),
+    JS_TN(js_valueOf_str,        date_valueOf,            0,0, date_valueOf_trcinfo),
     JS_FS_END
 };
 
 static jsdouble *
 date_constructor(JSContext *cx, JSObject* obj)
 {
     jsdouble *date;
 
diff -r a4343d61f6ee js/src/jsemit.cpp
--- a/js/src/jsemit.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsemit.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -2361,24 +2361,24 @@ EmitPropOp(JSContext *cx, JSParseNode *p
                   case JSOP_GETARG:
                     op = JSOP_GETARGPROP;
                     goto do_indexconst;
                   case JSOP_GETLOCAL:
                     op = JSOP_GETLOCALPROP;
                   do_indexconst: {
                         JSAtomListElement *ale;
                         jsatomid atomIndex;
-                        
+
                         ale = js_IndexAtom(cx, pn->pn_atom, &cg->atomList);
                         if (!ale)
                             return JS_FALSE;
                         atomIndex = ALE_INDEX(ale);
                         return EmitSlotIndexOp(cx, op, pn2->pn_slot, atomIndex, cg);
                     }
-                    
+
                   default:;
                 }
             }
         }
     }
 
     /*
      * If the object operand is also a dotted property reference, reverse the
@@ -3845,37 +3845,19 @@ GettableNoteForNextOp(JSCodeGenerator *c
 /* Top-level named functions need a nop for decompilation. */
 static JSBool
 EmitFunctionDefNop(JSContext *cx, JSCodeGenerator *cg, uintN index)
 {
     return js_NewSrcNote2(cx, cg, SRC_FUNCDEF, (ptrdiff_t)index) >= 0 &&
            js_Emit1(cx, cg, JSOP_NOP) >= 0;
 }
 
-/* FIXME: 458851 -- that bug's patch should re-inline this into one place. */
-static JSBool
-EmitForInLoopBody(JSContext *cx, JSCodeGenerator *cg, JSStmtInfo *stmt,
-                  JSParseNode *body, intN noteIndex, ptrdiff_t jmp)
-{
-    /* Set the first srcnote offset so we can find the start of the loop body. */
-    if (!js_SetSrcNoteOffset(cx, cg, (uintN)noteIndex, 0, CG_OFFSET(cg) - jmp))
-        return JS_FALSE;
-
-    /* Emit code for the loop body. */
-    if (!js_EmitTree(cx, cg, body))
-        return JS_FALSE;
-
-    /* Set loop and enclosing "update" offsets, for continue. */
-    do {
-        stmt->update = CG_OFFSET(cg);
-    } while ((stmt = stmt->down) != NULL && stmt->type == STMT_LABEL);
-
-    CHECK_AND_SET_JUMP_OFFSET_AT(cx, cg, jmp);
-    return JS_TRUE;
-}
+/* See the SRC_FOR source note offsetBias comments later in this file. */
+JS_STATIC_ASSERT(JSOP_NOP_LENGTH == 1);
+JS_STATIC_ASSERT(JSOP_POP_LENGTH == 1);
 
 JSBool
 js_EmitTree(JSContext *cx, JSCodeGenerator *cg, JSParseNode *pn)
 {
     JSBool ok, useful, wantval;
     JSStmtInfo *stmt, stmtInfo;
     ptrdiff_t top, off, tmp, beq, jmp;
     JSParseNode *pn2, *pn3;
@@ -3950,17 +3932,17 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
         js_InitCodeGenerator(cx, cg2, cg->treeContext.parseContext,
                              cg->codePool, cg->notePool,
                              pn->pn_pos.begin.lineno);
         cg2->treeContext.flags = (uint16) (pn->pn_flags | TCF_IN_FUNCTION);
         cg2->treeContext.u.fun = fun;
         cg2->staticDepth = cg->staticDepth + 1;
         cg2->parent = cg;
 
-        /* We metered the max scope depth when parsed the function. */ 
+        /* We metered the max scope depth when parsed the function. */
         JS_SCOPE_DEPTH_METERING(cg2->treeContext.maxScopeDepth = (uintN) -1);
         if (!js_EmitFunctionScript(cx, cg2, pn->pn_body)) {
             pn = NULL;
         } else {
             /*
              * We need an activation object if an inner peeks out, or if such
              * inner-peeking caused one of our inners to become heavyweight.
              */
@@ -4235,17 +4217,17 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
                 return JS_FALSE;
 
             /*
              * Emit a bytecode to convert top of stack value to the iterator
              * object depending on the loop variant (for-in, for-each-in, or
              * destructuring for-in).
              */
             JS_ASSERT(pn->pn_op == JSOP_ITER);
-            if (js_Emit2(cx, cg, PN_OP(pn), (uint8) pn->pn_iflags) < 0)
+            if (js_Emit2(cx, cg, JSOP_ITER, (uint8) pn->pn_iflags) < 0)
                 return JS_FALSE;
 
             /* Annotate so the decompiler can find the loop-closing jump. */
             noteIndex = js_NewSrcNote(cx, cg, SRC_FOR_IN);
             if (noteIndex < 0)
                 return JS_FALSE;
 
             /*
@@ -4253,16 +4235,20 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
              * least one iteration, as the other loop forms do.
              */
             jmp = EmitJump(cx, cg, JSOP_GOTO, 0);
             if (jmp < 0)
                 return JS_FALSE;
 
             top = CG_OFFSET(cg);
             SET_STATEMENT_TOP(&stmtInfo, top);
+
+#ifdef DEBUG
+            intN loopDepth = cg->stackDepth;
+#endif
 
             /*
              * Compile a JSOP_FOR* bytecode based on the left hand side.
              *
              * Initialize op to JSOP_SETNAME in case of |for ([a, b] in o)...|
              * or similar, to signify assignment, rather than declaration, to
              * the decompiler.  EmitDestructuringOps takes a prolog bytecode
              * parameter and emits the appropriate source note, defaulting to
@@ -4287,34 +4273,31 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
                     goto destructuring_for;
                 }
 #else
                 JS_ASSERT(pn3->pn_type == TOK_NAME);
 #endif
                 /* FALL THROUGH */
 
               case TOK_NAME:
-                if (!EmitForInLoopBody(cx, cg, &stmtInfo, pn->pn_right, noteIndex, jmp))
-                    return JS_FALSE;
-
                 /*
                  * Always annotate JSOP_FORLOCAL if given input of the form
                  * 'for (let x in * o)' -- the decompiler must not hoist the
                  * 'let x' out of the loop head, or x will be bound in the
                  * wrong scope.  Likewise, but in this case only for the sake
                  * of higher decompilation fidelity only, do not hoist 'var x'
                  * when given 'for (var x in o)'.
                  */
                 if ((
 #if JS_HAS_BLOCK_SCOPE
                      type == TOK_LET ||
 #endif
                      (type == TOK_VAR && !pn3->pn_expr)) &&
                     js_NewSrcNote2(cx, cg, SRC_DECL,
-                                   type == TOK_VAR
+                                   (type == TOK_VAR)
                                    ? SRC_DECL_VAR
                                    : SRC_DECL_LET) < 0) {
                     return JS_FALSE;
                 }
                 if (pn3->pn_slot >= 0) {
                     op = PN_OP(pn3);
                     switch (op) {
                       case JSOP_GETARG:   /* FALL THROUGH */
@@ -4329,17 +4312,19 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
                     pn3->pn_op = JSOP_FORNAME;
                     if (!BindNameToSlot(cx, cg, pn3))
                         return JS_FALSE;
                     op = PN_OP(pn3);
                 }
                 if (pn3->pn_slot >= 0) {
                     if (pn3->pn_const) {
                         JS_ASSERT(op == JSOP_FORLOCAL);
-                        op = JSOP_FORCONST;
+                        js_ReportCompileErrorNumber(cx, CG_TS(cg), pn3, JSREPORT_ERROR,
+                                                    JSMSG_BAD_FOR_LEFTSIDE);
+                        return JS_FALSE;
                     }
                     atomIndex = (jsatomid) pn3->pn_slot;
                     EMIT_UINT16_IMM_OP(op, atomIndex);
                 } else {
                     if (!EmitAtomOp(cx, pn3, op, cg))
                         return JS_FALSE;
                 }
                 break;
@@ -4348,41 +4333,30 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
                 /*
                  * 'for (o.p in q)' can use JSOP_FORPROP only if evaluating 'o'
                  * has no side effects.
                  */
                 useful = JS_FALSE;
                 if (!CheckSideEffects(cx, cg, pn3->pn_expr, &useful))
                     return JS_FALSE;
                 if (!useful) {
-                    if (!EmitForInLoopBody(cx, cg, &stmtInfo, pn->pn_right, noteIndex, jmp))
-                        return JS_FALSE;
                     if (!EmitPropOp(cx, pn3, JSOP_FORPROP, cg, JS_FALSE))
                         return JS_FALSE;
                     break;
                 }
                 /* FALL THROUGH */
 
 #if JS_HAS_DESTRUCTURING
               destructuring_for:
 #endif
               default:
-                /*
-                 * We separate the first/next bytecode from the enumerator
-                 * variable binding to avoid any side-effects in the index
-                 * expression (e.g., for (x[i++] in {}) should not bind x[i]
-                 * or increment i at all).
-                 *
-                 * At this point, JSOP_FORELEM (emitted after the loop body)
-                 * has pushed the next value to iterate, but it is downstream
-                 * of us in js_Emit* order, so we must adjust the stack depth
-                 * manually.
-                 */
-                if ((uintN) ++cg->stackDepth > cg->maxStackDepth)
-                    cg->maxStackDepth = cg->stackDepth;
+                if (js_Emit1(cx, cg, JSOP_FORELEM) < 0)
+                    return JS_FALSE;
+                JS_ASSERT(cg->stackDepth >= 3);
+
 #if JS_HAS_DESTRUCTURING
                 if (pn3->pn_type == TOK_RB || pn3->pn_type == TOK_RC) {
                     if (!EmitDestructuringOps(cx, cg, op, pn3))
                         return JS_FALSE;
                     if (js_Emit1(cx, cg, JSOP_POP) < 0)
                         return JS_FALSE;
                 } else
 #endif
@@ -4401,34 +4375,42 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
                     if (!js_EmitTree(cx, cg, pn3))
                         return JS_FALSE;
                     if (js_Emit1(cx, cg, JSOP_ENUMELEM) < 0)
                         return JS_FALSE;
                 } else
 #endif
                 if (!EmitElemOp(cx, pn3, JSOP_ENUMELEM, cg))
                     return JS_FALSE;
-
-                if (!EmitForInLoopBody(cx, cg, &stmtInfo, pn->pn_right, noteIndex, jmp))
-                    return JS_FALSE;
-
-                /*
-                 * JSOP_FORELEM has nuses 1, ndefs 3, modeling the case where
-                 * it pushes the next value and then true, to keep iterating.
-                 * For symmetry here, we manually drop cg->stackDepth after to
-                 * reflect the fact that we've emitted JSOP_ENUMELEM already.
-                 */
-                if (js_Emit1(cx, cg, JSOP_FORELEM) < 0)
-                    return JS_FALSE;
-                JS_ASSERT(cg->stackDepth >= 3);
-                --cg->stackDepth;
-                break;
-            }
-
-            /* Pop and test the loop condition generated by JSOP_FOR*. */
+                break;
+            }
+
+            /* The stack should be balanced around the JSOP_FOR* opcode sequence. */
+            JS_ASSERT(cg->stackDepth == loopDepth);
+
+            /* Set the first srcnote offset so we can find the start of the loop body. */
+            if (!js_SetSrcNoteOffset(cx, cg, (uintN)noteIndex, 0, CG_OFFSET(cg) - jmp))
+                return JS_FALSE;
+
+            /* Emit code for the loop body. */
+            if (!js_EmitTree(cx, cg, pn->pn_right))
+                return JS_FALSE;
+
+            /* Set loop and enclosing "update" offsets, for continue. */
+            stmt = &stmtInfo;
+            do {
+                stmt->update = CG_OFFSET(cg);
+            } while ((stmt = stmt->down) != NULL && stmt->type == STMT_LABEL);
+
+            /*
+             * Fixup the goto that starts the loop to jump down to JSOP_NEXTITER.
+             */
+            CHECK_AND_SET_JUMP_OFFSET_AT(cx, cg, jmp);
+            if (js_Emit1(cx, cg, JSOP_NEXTITER) < 0)
+                return JS_FALSE;
             beq = EmitJump(cx, cg, JSOP_IFNE, top - CG_OFFSET(cg));
             if (beq < 0)
                 return JS_FALSE;
 
             /* Set the second srcnote offset so we can find the closing jump. */
             if (!js_SetSrcNoteOffset(cx, cg, (uintN)noteIndex, 1, beq - jmp))
                 return JS_FALSE;
         } else {
@@ -4458,39 +4440,46 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
                          */
                         JS_ASSERT(pn3->pn_arity == PN_LIST);
                         if (pn3->pn_extra & PNX_GROUPINIT)
                             op = JSOP_NOP;
                     }
                 }
                 cg->treeContext.flags &= ~TCF_IN_FOR_INIT;
             }
+
+            /*
+             * NB: the SRC_FOR note has offsetBias 1 (JSOP_{NOP,POP}_LENGTH).
+             * Use tmp to hold the biased srcnote "top" offset, which differs
+             * from the top local variable by the length of the JSOP_GOTO{,X}
+             * emitted in between tmp and top if this loop has a condition.
+             */
             noteIndex = js_NewSrcNote(cx, cg, SRC_FOR);
-            if (noteIndex < 0 ||
-                js_Emit1(cx, cg, op) < 0) {
-                return JS_FALSE;
-            }
+            if (noteIndex < 0 || js_Emit1(cx, cg, op) < 0)
+                return JS_FALSE;
+            tmp = CG_OFFSET(cg);
 
             if (pn2->pn_kid2) {
                 /* Goto the loop condition, which branches back to iterate. */
                 jmp = EmitJump(cx, cg, JSOP_GOTO, 0);
                 if (jmp < 0)
                     return JS_FALSE;
             }
+
             top = CG_OFFSET(cg);
             SET_STATEMENT_TOP(&stmtInfo, top);
 
             /* Emit code for the loop body. */
             if (!js_EmitTree(cx, cg, pn->pn_right))
                 return JS_FALSE;
 
             /* Set the second note offset so we can find the update part. */
             JS_ASSERT(noteIndex != -1);
             if (!js_SetSrcNoteOffset(cx, cg, (uintN)noteIndex, 1,
-                                     CG_OFFSET(cg) - top)) {
+                                     CG_OFFSET(cg) - tmp)) {
                 return JS_FALSE;
             }
 
             /* Set loop and enclosing "update" offsets, for continue. */
             stmt = &stmtInfo;
             do {
                 stmt->update = CG_OFFSET(cg);
             } while ((stmt = stmt->down) != NULL && stmt->type == STMT_LABEL);
@@ -4500,50 +4489,50 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
             if (pn3) {
                 op = JSOP_POP;
 #if JS_HAS_DESTRUCTURING
                 if (pn3->pn_type == TOK_ASSIGN &&
                     !MaybeEmitGroupAssignment(cx, cg, op, pn3, &op)) {
                     return JS_FALSE;
                 }
 #endif
-                if (op == JSOP_POP) {
-                    if (!js_EmitTree(cx, cg, pn3))
-                        return JS_FALSE;
-                    if (js_Emit1(cx, cg, op) < 0)
-                        return JS_FALSE;
-                }
+                if (op == JSOP_POP && !js_EmitTree(cx, cg, pn3))
+                    return JS_FALSE;
+
+                /* Always emit the POP or NOP, to help the decompiler. */
+                if (js_Emit1(cx, cg, op) < 0)
+                    return JS_FALSE;
 
                 /* Restore the absolute line number for source note readers. */
                 off = (ptrdiff_t) pn->pn_pos.end.lineno;
                 if (CG_CURRENT_LINE(cg) != (uintN) off) {
                     if (js_NewSrcNote2(cx, cg, SRC_SETLINE, off) < 0)
                         return JS_FALSE;
                     CG_CURRENT_LINE(cg) = (uintN) off;
                 }
             }
 
             /* Set the first note offset so we can find the loop condition. */
             if (!js_SetSrcNoteOffset(cx, cg, (uintN)noteIndex, 0,
-                                     CG_OFFSET(cg) - top)) {
+                                     CG_OFFSET(cg) - tmp)) {
                 return JS_FALSE;
             }
 
             if (pn2->pn_kid2) {
                 /* Fix up the goto from top to target the loop condition. */
                 JS_ASSERT(jmp >= 0);
                 CHECK_AND_SET_JUMP_OFFSET_AT(cx, cg, jmp);
 
                 if (!js_EmitTree(cx, cg, pn2->pn_kid2))
                     return JS_FALSE;
             }
 
             /* The third note offset helps us find the loop-closing jump. */
             if (!js_SetSrcNoteOffset(cx, cg, (uintN)noteIndex, 2,
-                                     CG_OFFSET(cg) - top)) {
+                                     CG_OFFSET(cg) - tmp)) {
                 return JS_FALSE;
             }
 
             if (pn2->pn_kid2) {
                 beq = EmitJump(cx, cg, JSOP_IFNE, top - CG_OFFSET(cg));
                 if (beq < 0)
                     return JS_FALSE;
             } else {
@@ -4555,22 +4544,23 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
         }
 
         /* Now fixup all breaks and continues (before for/in's JSOP_ENDITER). */
         if (!js_PopStatementCG(cx, cg))
             return JS_FALSE;
 
         if (pn2->pn_type == TOK_IN) {
             /*
-             * JSOP_ENDITER needs a slot to save an exception thrown from the
-             * body of for-in loop when closing the iterator object.
-             */
-            JS_ASSERT(js_CodeSpec[JSOP_ENDITER].format & JOF_TMPSLOT);
-            if (!NewTryNote(cx, cg, JSTRY_ITER, cg->stackDepth, top,
-                            CG_OFFSET(cg)) ||
+             * JSOP_ENDITER must have a slot to save an exception thrown from
+             * the body of for-in loop when closing the iterator object, and
+             * fortunately it does: the slot that was set by JSOP_NEXTITER to
+             * the return value of iterator.next().
+             */
+            JS_ASSERT(js_CodeSpec[JSOP_ENDITER].nuses == 2);
+            if (!NewTryNote(cx, cg, JSTRY_ITER, cg->stackDepth, top, CG_OFFSET(cg)) ||
                 js_Emit1(cx, cg, JSOP_ENDITER) < 0) {
                 return JS_FALSE;
             }
         }
         break;
 
       case TOK_BREAK:
         stmt = cg->treeContext.topStmt;
@@ -5852,17 +5842,17 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
         }
         cg->treeContext.flags |= oldflags & TCF_IN_FOR_INIT;
         if (js_NewSrcNote2(cx, cg, SRC_PCBASE, CG_OFFSET(cg) - off) < 0)
             return JS_FALSE;
 
         argc = pn->pn_count - 1;
         if (js_Emit3(cx, cg, PN_OP(pn), ARGC_HI(argc), ARGC_LO(argc)) < 0)
             return JS_FALSE;
-        if (PN_OP(pn) == JSOP_EVAL) 
+        if (PN_OP(pn) == JSOP_EVAL)
             EMIT_UINT16_IMM_OP(JSOP_LINENO, pn->pn_pos.begin.lineno);
         break;
       }
 
       case TOK_LEXICALSCOPE:
       {
         JSParsedObjectBox *pob;
         uintN count;
@@ -6372,17 +6362,20 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
     }
 
     if (ok && --cg->emitLevel == 0 && cg->spanDeps)
         ok = OptimizeSpanDeps(cx, cg);
 
     return ok;
 }
 
-/* XXX get rid of offsetBias, it's used only by SRC_FOR and SRC_DECL */
+/*
+ * We should try to get rid of offsetBias (always 0 or 1, where 1 is
+ * JSOP_{NOP,POP}_LENGTH), which is used only by SRC_FOR and SRC_DECL.
+ */
 JS_FRIEND_DATA(JSSrcNoteSpec) js_SrcNoteSpec[] = {
     {"null",            0,      0,      0},
     {"if",              0,      0,      0},
     {"if-else",         2,      0,      1},
     {"for",             3,      1,      1},
     {"while",           1,      0,      1},
     {"continue",        0,      0,      0},
     {"decl",            1,      1,      1},
diff -r a4343d61f6ee js/src/jsexn.cpp
--- a/js/src/jsexn.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsexn.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -333,17 +333,17 @@ InitExnPrivate(JSContext *cx, JSObject *
             memcpy(values, fp->argv, fp->argc * sizeof(jsval));
             values += fp->argc;
         }
         elem->ulineno = 0;
         elem->filename = NULL;
         if (fp->script) {
             elem->filename = fp->script->filename;
             if (fp->regs)
-                elem->ulineno = js_PCToLineNumber(cx, fp->script, fp->regs->pc);
+                elem->ulineno = js_FramePCToLineNumber(cx, fp);
         }
         ++elem;
     }
     JS_ASSERT(priv->stackElems + stackDepth == elem);
     JS_ASSERT(GetStackTraceValueBuffer(priv) + valueCount == values);
 
     STOBJ_SET_SLOT(exnObject, JSSLOT_PRIVATE, PRIVATE_TO_JSVAL(priv));
 
@@ -799,19 +799,17 @@ Exception(JSContext *cx, JSObject *obj, 
     /* Set the 'lineNumber' property. */
     if (argc > 2) {
         lineno = js_ValueToECMAUint32(cx, &argv[2]);
         if (JSVAL_IS_NULL(argv[2]))
             return JS_FALSE;
     } else {
         if (!fp)
             fp = JS_GetScriptedCaller(cx, NULL);
-        lineno = (fp && fp->regs)
-                 ? js_PCToLineNumber(cx, fp->script, fp->regs->pc)
-                 : 0;
+        lineno = (fp && fp->regs) ? js_FramePCToLineNumber(cx, fp) : 0;
     }
 
     return (OBJ_GET_CLASS(cx, obj) != &js_ErrorClass) ||
             InitExnPrivate(cx, obj, message, filename, lineno, NULL);
 }
 
 /*
  * Convert to string.
diff -r a4343d61f6ee js/src/jsfun.cpp
--- a/js/src/jsfun.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsfun.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -1580,20 +1580,18 @@ fun_toString(JSContext *cx, uintN argc, 
 #if JS_HAS_TOSOURCE
 static JSBool
 fun_toSource(JSContext *cx, uintN argc, jsval *vp)
 {
     return fun_toStringHelper(cx, JS_DONT_PRETTY_PRINT, argc, vp);
 }
 #endif
 
-static const char call_str[] = "call";
-
-static JSBool
-fun_call(JSContext *cx, uintN argc, jsval *vp)
+JSBool
+js_fun_call(JSContext *cx, uintN argc, jsval *vp)
 {
     JSObject *obj;
     jsval fval, *argv, *invokevp;
     JSString *str;
     void *mark;
     JSBool ok;
 
     obj = JS_THIS_OBJECT(cx, vp);
@@ -1604,17 +1602,17 @@ fun_call(JSContext *cx, uintN argc, jsva
     if (!VALUE_IS_FUNCTION(cx, fval)) {
         str = JS_ValueToString(cx, fval);
         if (str) {
             const char *bytes = js_GetStringBytes(cx, str);
 
             if (bytes) {
                 JS_ReportErrorNumber(cx, js_GetErrorMessage, NULL,
                                      JSMSG_INCOMPATIBLE_PROTO,
-                                     js_Function_str, call_str,
+                                     js_Function_str, js_call_str,
                                      bytes);
             }
         }
         return JS_FALSE;
     }
 
     argv = vp + 2;
     if (argc == 0) {
@@ -1654,33 +1652,33 @@ js_fun_apply(JSContext *cx, uintN argc, 
     JSString *str;
     jsuint length;
     JSBool arraylike, ok;
     void *mark;
     uintN i;
 
     if (argc == 0) {
         /* Will get globalObject as 'this' and no other arguments. */
-        return fun_call(cx, argc, vp);
+        return js_fun_call(cx, argc, vp);
     }
 
     obj = JS_THIS_OBJECT(cx, vp);
     if (!obj || !OBJ_DEFAULT_VALUE(cx, obj, JSTYPE_FUNCTION, &vp[1]))
         return JS_FALSE;
     fval = vp[1];
 
     if (!VALUE_IS_FUNCTION(cx, fval)) {
         str = JS_ValueToString(cx, fval);
         if (str) {
             const char *bytes = js_GetStringBytes(cx, str);
 
             if (bytes) {
                 JS_ReportErrorNumber(cx, js_GetErrorMessage, NULL,
                                      JSMSG_INCOMPATIBLE_PROTO,
-                                     js_Function_str, "apply",
+                                     js_Function_str, js_apply_str,
                                      bytes);
             }
         }
         return JS_FALSE;
     }
 
     /* Quell GCC overwarnings. */
     aobj = NULL;
@@ -1695,17 +1693,17 @@ js_fun_apply(JSContext *cx, uintN argc, 
             arraylike = JS_FALSE;
             if (!JSVAL_IS_PRIMITIVE(vp[3])) {
                 aobj = JSVAL_TO_OBJECT(vp[3]);
                 if (!js_IsArrayLike(cx, aobj, &arraylike, &length))
                     return JS_FALSE;
             }
             if (!arraylike) {
                 JS_ReportErrorNumber(cx, js_GetErrorMessage, NULL,
-                                     JSMSG_BAD_APPLY_ARGS, "apply");
+                                     JSMSG_BAD_APPLY_ARGS, js_apply_str);
                 return JS_FALSE;
             }
         }
     }
 
     /* Convert the first arg to 'this' and skip over it. */
     if (!JSVAL_IS_PRIMITIVE(vp[2]))
         obj = JSVAL_TO_OBJECT(vp[2]);
@@ -1782,20 +1780,20 @@ out:
 }
 #endif
 
 static JSFunctionSpec function_methods[] = {
 #if JS_HAS_TOSOURCE
     JS_FN(js_toSource_str,   fun_toSource,   0,0),
 #endif
     JS_FN(js_toString_str,   fun_toString,   0,0),
-    JS_FN("apply",           js_fun_apply,   2,0),
-    JS_FN(call_str,          fun_call,       1,0),
+    JS_FN(js_apply_str,      js_fun_apply,   2,0),
+    JS_FN(js_call_str,       js_fun_call,    1,0),
 #ifdef NARCISSUS
-    JS_FN("__applyConstructor__", fun_applyConstructor, 0,1,0),
+    JS_FN("__applyConstructor__", fun_applyConstructor, 1,0),
 #endif
     JS_FS_END
 };
 
 static JSBool
 Function(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSStackFrame *fp, *caller;
diff -r a4343d61f6ee js/src/jsfun.h
--- a/js/src/jsfun.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsfun.h	Sat Nov 15 19:43:13 2008 -0500
@@ -279,11 +279,18 @@ js_GetLocalNameArray(JSContext *cx, JSFu
     ((JSAtom *) ((nameWord) & ~(jsuword) 1))
 
 #define JS_LOCAL_NAME_IS_CONST(nameWord)                                      \
     ((((nameWord) & (jsuword) 1)) != 0)
 
 extern void
 js_FreezeLocalNames(JSContext *cx, JSFunction *fun);
 
+extern JSBool
+js_fun_apply(JSContext *cx, uintN argc, jsval *vp);
+
+extern JSBool
+js_fun_call(JSContext *cx, uintN argc, jsval *vp);
+
+
 JS_END_EXTERN_C
 
 #endif /* jsfun_h___ */
diff -r a4343d61f6ee js/src/jsgc.cpp
--- a/js/src/jsgc.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsgc.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -2997,18 +2997,22 @@ js_TraceContext(JSTracer *trc, JSContext
 
     if (acx->sharpObjectMap.depth > 0)
         js_TraceSharpMap(trc, &acx->sharpObjectMap);
 }
 
 void
 js_TraceTraceMonitor(JSTracer *trc, JSTraceMonitor *tm)
 {
-    if (IS_GC_MARKING_TRACER(trc))
+    if (IS_GC_MARKING_TRACER(trc)) {
         tm->recoveryDoublePoolPtr = tm->recoveryDoublePool;
+        /* Make sure the global shape changes and will force a flush
+           of the code cache. */
+        tm->globalShape = -1; 
+    }
 }
 
 void
 js_TraceRuntime(JSTracer *trc, JSBool allAtoms)
 {
     JSRuntime *rt = trc->context->runtime;
     JSContext *iter, *acx;
 
@@ -3352,20 +3356,19 @@ js_GC(JSContext *cx, JSGCInvocationKind 
     rt->gcMallocBytes = 0;
 
 #ifdef JS_DUMP_SCOPE_METERS
   { extern void js_DumpScopeMeters(JSRuntime *rt);
     js_DumpScopeMeters(rt);
   }
 #endif
 
-    /* Clear property and JIT caches (only for cx->thread if JS_THREADSAFE). */
+    /* Clear property and JIT oracle caches (only for cx->thread if JS_THREADSAFE). */
     js_FlushPropertyCache(cx);
 #ifdef JS_TRACER
-    js_FlushJITCache(cx);
     js_FlushJITOracle(cx);
 #endif
 
     /* Destroy eval'ed scripts. */
     DestroyScriptsToGC(cx, &JS_SCRIPTS_TO_GC(cx));
 
 #ifdef JS_THREADSAFE
     /*
@@ -3380,17 +3383,17 @@ js_GC(JSContext *cx, JSGCInvocationKind 
      */
     iter = NULL;
     while ((acx = js_ContextIterator(rt, JS_FALSE, &iter)) != NULL) {
         if (!acx->thread || acx->thread == cx->thread)
             continue;
         GSN_CACHE_CLEAR(&acx->thread->gsnCache);
         js_FlushPropertyCache(acx);
 #ifdef JS_TRACER
-        js_FlushJITCache(acx);
+        js_FlushJITOracle(acx);
 #endif
         DestroyScriptsToGC(cx, &acx->thread->scriptsToGC);
     }
 #else
     /* The thread-unsafe case just has to clear the runtime's GSN cache. */
     GSN_CACHE_CLEAR(&rt->gsnCache);
 #endif
 
diff -r a4343d61f6ee js/src/jsinterp.cpp
--- a/js/src/jsinterp.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsinterp.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -304,17 +304,18 @@ js_FullTestPropertyCache(JSContext *cx, 
     JSOp op;
     const JSCodeSpec *cs;
     ptrdiff_t pcoff;
     JSAtom *atom;
     JSObject *obj, *pobj, *tmp;
     JSPropCacheEntry *entry;
     uint32 vcap;
 
-    JS_ASSERT(JS_UPTRDIFF(pc, cx->fp->script->code) < cx->fp->script->length);
+    JS_ASSERT(uintN((cx->fp->imacpc ? cx->fp->imacpc : pc) - cx->fp->script->code)
+              < cx->fp->script->length);
 
     op = (JSOp) *pc;
     cs = &js_CodeSpec[op];
     if (op == JSOP_LENGTH) {
         atom = cx->runtime->atomState.lengthAtom;
     } else {
         pcoff = (JOF_TYPE(cs->format) == JOF_SLOTATOM) ? 2 : 0;
         GET_ATOM_FROM_BYTECODE(cx->fp->script, pc, pcoff, atom);
@@ -1255,16 +1256,17 @@ have_fun:
     frame.argv = argv;
 
     /* Default return value for a constructor is the new object. */
     frame.rval = (flags & JSINVOKE_CONSTRUCT) ? vp[1] : JSVAL_VOID;
     frame.down = cx->fp;
     frame.annotation = NULL;
     frame.scopeChain = NULL;    /* set below for real, after cx->fp is set */
     frame.regs = NULL;
+    frame.imacpc = NULL;
     frame.slots = NULL;
     frame.sharpDepth = 0;
     frame.sharpArray = NULL;
     frame.flags = flags | rootedArgsFlag;
     frame.dormantNext = NULL;
     frame.xmlNamespace = NULL;
     frame.blockChain = NULL;
 
@@ -1487,16 +1489,18 @@ js_Execute(JSContext *cx, JSObject *chai
         frame.callee = NULL;
         frame.fun = NULL;
         frame.thisp = chain;
         frame.argc = 0;
         frame.argv = NULL;
         frame.annotation = NULL;
         frame.sharpArray = NULL;
     }
+
+    frame.imacpc = NULL;
     if (script->nslots != 0) {
         frame.slots = js_AllocRawStack(cx, script->nslots, &mark);
         if (!frame.slots) {
             ok = JS_FALSE;
             goto out;
         }
         memset(frame.slots, 0, script->nfixed * sizeof(jsval));
     } else {
@@ -1997,18 +2001,16 @@ js_TraceOpcode(JSContext *cx, jsint len)
     tracefp = (FILE *) cx->tracefp;
     JS_ASSERT(tracefp);
     fp = cx->fp;
     regs = fp->regs;
     if (len != 0) {
         prevop = (JSOp) regs->pc[-len];
         ndefs = js_CodeSpec[prevop].ndefs;
         if (ndefs != 0) {
-            if (prevop == JSOP_FORELEM && regs->sp[-1] == JSVAL_FALSE)
-                --ndefs;
             for (n = -ndefs; n < 0; n++) {
                 char *bytes = js_DecompileValueGenerator(cx, n, regs->sp[n],
                                                          NULL);
                 if (bytes) {
                     fprintf(tracefp, "%s %s",
                             (n == -ndefs) ? "  output:" : ",",
                             bytes);
                     JS_free(cx, bytes);
@@ -2023,17 +2025,18 @@ js_TraceOpcode(JSContext *cx, jsint len)
                 fputs("<null>", tracefp);
             else
                 js_FileEscapedString(tracefp, str, 0);
             fputc(' ', tracefp);
         }
         fputc('\n', tracefp);
     }
 
-    fprintf(tracefp, "%4u: ", js_PCToLineNumber(cx, fp->script, regs->pc));
+    fprintf(tracefp, "%4u: ",
+            js_PCToLineNumber(cx, fp->script, fp->imacpc ? fp->imacpc : regs->pc));
     js_Disassemble1(cx, fp->script, regs->pc,
                     PTRDIFF(regs->pc, fp->script->code, jsbytecode),
                     JS_FALSE, tracefp);
     op = (JSOp) *regs->pc;
     nuses = js_CodeSpec[op].nuses;
     if (nuses != 0) {
         for (n = -nuses; n < 0; n++) {
             char *bytes = js_DecompileValueGenerator(cx, n, regs->sp[n],
@@ -2567,17 +2570,16 @@ js_Interpret(JSContext *cx)
 # define ADD_EMPTY_CASE(OP) BEGIN_CASE(OP)
 # define END_EMPTY_CASES    goto advance_pc_by_one;
 
 #endif /* !JS_THREADED_INTERP */
 
 #ifdef JS_TRACER
     /* We had better not be entering the interpreter from JIT-compiled code. */
     TraceRecorder *tr = NULL;
-    uint32 jitCacheGen = JS_TRACE_MONITOR(cx).jitCacheGen;
     if (JS_ON_TRACE(cx)) {
         tr = TRACE_RECORDER(cx);
         SET_TRACE_RECORDER(cx, NULL);
         JS_TRACE_MONITOR(cx).onTrace = JS_FALSE;
     }
 #endif
 
     /* Check for too deep of a native thread stack. */
@@ -2599,19 +2601,22 @@ js_Interpret(JSContext *cx)
      * the atom map to turn frequently executed LOAD_ATOM into simple array
      * access. For less frequent object and regexp loads we have to recover
      * the segment from atoms pointer first.
      */
     atoms = script->atomMap.vector;
 
 #define LOAD_ATOM(PCOFF)                                                      \
     JS_BEGIN_MACRO                                                            \
-        JS_ASSERT((size_t)(atoms - script->atomMap.vector) <                  \
-                  (size_t)(script->atomMap.length -                           \
-                           GET_INDEX(regs.pc + PCOFF)));                      \
+        JS_ASSERT(fp->imacpc                                                  \
+                  ? atoms == COMMON_ATOMS_START(&rt->atomState) &&            \
+                    GET_INDEX(regs.pc + PCOFF) < js_common_atom_count         \
+                  : (size_t)(atoms - script->atomMap.vector) <                \
+                    (size_t)(script->atomMap.length -                         \
+                             GET_INDEX(regs.pc + PCOFF)));                    \
         atom = atoms[GET_INDEX(regs.pc + PCOFF)];                             \
     JS_END_MACRO
 
 #define GET_FULL_INDEX(PCOFF)                                                 \
     (atoms - script->atomMap.vector + GET_INDEX(regs.pc + PCOFF))
 
 #define LOAD_OBJECT(PCOFF)                                                    \
     JS_GET_SCRIPT_OBJECT(script, GET_FULL_INDEX(PCOFF), obj)
@@ -2937,16 +2942,33 @@ js_Interpret(JSContext *cx)
 
           BEGIN_CASE(JSOP_RETRVAL)    /* fp->rval already set */
           BEGIN_CASE(JSOP_STOP)
             /*
              * When the inlined frame exits with an exception or an error, ok
              * will be false after the inline_return label.
              */
             ASSERT_NOT_THROWING(cx);
+
+            if (fp->imacpc) {
+                /*
+                 * If we are at the end of an imacro, return to its caller in
+                 * the current frame.
+                 */
+                JS_ASSERT(op == JSOP_STOP);
+
+              end_imacro:
+                JS_ASSERT((uintN)(regs.sp - fp->slots) <= script->nslots);
+                regs.pc = fp->imacpc + js_CodeSpec[*fp->imacpc].length;
+                fp->imacpc = NULL;
+                atoms = script->atomMap.vector;
+                op = JSOp(*regs.pc);
+                DO_OP();
+            }
+
             JS_ASSERT(regs.sp == StackBase(fp));
             if ((fp->flags & JSFRAME_CONSTRUCTING) &&
                 JSVAL_IS_PRIMITIVE(fp->rval)) {
                 if (!fp->fun) {
                     JS_ReportErrorNumber(cx, js_GetErrorMessage, NULL,
                                          JSMSG_BAD_NEW_RESULT,
                                          js_ValueToPrintableString(cx, rval));
                     goto error;
@@ -3037,20 +3059,17 @@ js_Interpret(JSContext *cx)
 
                 /* Restore the calling script's interpreter registers. */
                 script = fp->script;
                 atoms = script->atomMap.vector;
 
                 /* Resume execution in the calling frame. */
                 inlineCallCount--;
                 if (JS_LIKELY(ok)) {
-#ifdef JS_TRACER
-                    if (TRACE_RECORDER(cx))
-                        RECORD(LeaveFrame);
-#endif
+                    TRACE_0(LeaveFrame);
                     JS_ASSERT(js_CodeSpec[*regs.pc].length == JSOP_CALL_LENGTH);
                     len = JSOP_CALL_LENGTH;
                     DO_NEXT_OP(len);
                 }
                 goto error;
             }
             goto exit;
 
@@ -3187,154 +3206,121 @@ js_Interpret(JSContext *cx)
             if (prop)
                 OBJ_DROP_PROPERTY(cx, obj2, prop);
             TRY_BRANCH_AFTER_COND(cond, 2);
             regs.sp--;
             STORE_OPND(-1, BOOLEAN_TO_JSVAL(cond));
           END_CASE(JSOP_IN)
 
           BEGIN_CASE(JSOP_ITER)
+            JS_ASSERT(regs.sp > StackBase(fp));
             flags = regs.pc[1];
-            JS_ASSERT(regs.sp > StackBase(fp));
             if (!js_ValueToIterator(cx, flags, &regs.sp[-1]))
                 goto error;
+            LOAD_INTERRUPT_HANDLER(cx);
             JS_ASSERT(!JSVAL_IS_PRIMITIVE(regs.sp[-1]));
+            PUSH(JSVAL_VOID);
           END_CASE(JSOP_ITER)
 
+          BEGIN_CASE(JSOP_NEXTITER)
+            JS_ASSERT(regs.sp - 2 >= StackBase(fp));
+            JS_ASSERT(!JSVAL_IS_PRIMITIVE(regs.sp[-2]));
+            if (!js_CallIteratorNext(cx, JSVAL_TO_OBJECT(regs.sp[-2]), &regs.sp[-1]))
+                goto error;
+            LOAD_INTERRUPT_HANDLER(cx);
+            rval = BOOLEAN_TO_JSVAL(regs.sp[-1] != JSVAL_HOLE);
+            PUSH(rval);
+            TRACE_0(IteratorNextComplete);
+          END_CASE(JSOP_NEXTITER)
+
+          BEGIN_CASE(JSOP_ENDITER)
+            /*
+             * Decrease the stack pointer even when !ok -- see comments in the
+             * exception capturing code for details.
+             */
+            JS_ASSERT(regs.sp - 2 >= StackBase(fp));
+            ok = js_CloseIterator(cx, regs.sp[-2]);
+            regs.sp -= 2;
+            if (!ok)
+                goto error;
+          END_CASE(JSOP_ENDITER)
+
+          BEGIN_CASE(JSOP_FORARG)
+            JS_ASSERT(regs.sp - 2 >= StackBase(fp));
+            slot = GET_ARGNO(regs.pc);
+            JS_ASSERT(slot < fp->fun->nargs);
+            fp->argv[slot] = regs.sp[-1];
+          END_CASE(JSOP_FORARG)
+
+          BEGIN_CASE(JSOP_FORLOCAL)
+            JS_ASSERT(regs.sp - 2 >= StackBase(fp));
+            slot = GET_SLOTNO(regs.pc);
+            JS_ASSERT(slot < fp->script->nslots);
+            vp = &fp->slots[slot];
+            GC_POKE(cx, *vp);
+            *vp = regs.sp[-1];
+          END_CASE(JSOP_FORLOCAL)
+
+          BEGIN_CASE(JSOP_FORNAME)
+            JS_ASSERT(regs.sp - 2 >= StackBase(fp));
+            LOAD_ATOM(0);
+            id = ATOM_TO_JSID(atom);
+            if (!js_FindProperty(cx, id, &obj, &obj2, &prop))
+                goto error;
+            if (prop)
+                OBJ_DROP_PROPERTY(cx, obj2, prop);
+            ok = OBJ_SET_PROPERTY(cx, obj, id, &regs.sp[-1]);
+            if (!ok)
+                goto error;
+          END_CASE(JSOP_FORNAME)
+
           BEGIN_CASE(JSOP_FORPROP)
-            /*
-             * Handle JSOP_FORPROP first, so the cost of the goto do_forinloop
-             * is not paid for the more common cases.
-             */
-            LOAD_ATOM(0);
-            id = ATOM_TO_JSID(atom);
-            i = -2;
-            goto do_forinloop;
-
-          BEGIN_CASE(JSOP_FORNAME)
-            LOAD_ATOM(0);
-            id = ATOM_TO_JSID(atom);
-            /* FALL THROUGH */
-
-          BEGIN_CASE(JSOP_FORARG)
-          BEGIN_CASE(JSOP_FORCONST)
-          BEGIN_CASE(JSOP_FORLOCAL)
-            /*
-             * These bytecodes don't require any lval computation here,
-             * because they address slots on the stack (in fp->args or
-             * fp->slots).
-             */
-            /* FALL THROUGH */
+            JS_ASSERT(regs.sp - 2 >= StackBase(fp));
+            LOAD_ATOM(0);
+            id = ATOM_TO_JSID(atom);
+            FETCH_OBJECT(cx, -1, lval, obj);
+            ok = OBJ_SET_PROPERTY(cx, obj, id, &regs.sp[-2]);
+            if (!ok)
+                goto error;
+            regs.sp--;
+          END_CASE(JSOP_FORPROP)
 
           BEGIN_CASE(JSOP_FORELEM)
             /*
-             * JSOP_FORELEM simply initializes or updates the iteration state
-             * and leaves the index expression evaluation and assignment to the
-             * enumerator until after the next property has been acquired, via
-             * a JSOP_ENUMELEM bytecode.
-             */
-            i = -1;
-
-          do_forinloop:
-            /*
-             * Reach under the top of stack to find our property iterator, a
-             * JSObject that contains the iteration state.
-             */
-            JS_ASSERT(!JSVAL_IS_PRIMITIVE(regs.sp[i]));
-            if (!js_CallIteratorNext(cx, JSVAL_TO_OBJECT(regs.sp[i]), &rval))
-                goto error;
-            if (rval == JSVAL_HOLE) {
-                rval = JSVAL_FALSE;
-#ifdef JS_TRACER
-                if (TRACE_RECORDER(cx)) {
-                    js_AbortRecording(cx, "Untraceable for-in loop");
-                    ENABLE_TRACER(0);
-                }
-#endif
-                goto end_forinloop;
-            }
-
-            switch (op) {
-              case JSOP_FORARG:
-                slot = GET_ARGNO(regs.pc);
-                JS_ASSERT(slot < fp->fun->nargs);
-                fp->argv[slot] = rval;
-                break;
-
-              case JSOP_FORCONST:
-                /* Don't update the const slot. */
-                break;
-
-              case JSOP_FORLOCAL:
-                slot = GET_SLOTNO(regs.pc);
-                JS_ASSERT(slot < fp->script->nslots);
-                vp = &fp->slots[slot];
-                GC_POKE(cx, *vp);
-                *vp = rval;
-                break;
-
-              case JSOP_FORELEM:
-                /* FORELEM is not a SET operation, it's more like BINDNAME. */
-                PUSH_OPND(rval);
-                break;
-
-              case JSOP_FORPROP:
-                /*
-                 * We fetch object here to ensure that the iterator is called
-                 * even if lval is null or undefined that throws in
-                 * FETCH_OBJECT. See bug 372331.
-                 */
-                FETCH_OBJECT(cx, -1, lval, obj);
-                goto set_for_property;
-
-              default:
-                JS_ASSERT(op == JSOP_FORNAME);
-
-                /*
-                 * We find property here after the iterator call to ensure
-                 * that we take into account side effects of the iterator
-                 * call. See bug 372331.
-                 */
-                if (!js_FindProperty(cx, id, &obj, &obj2, &prop))
-                    goto error;
-                if (prop)
-                    OBJ_DROP_PROPERTY(cx, obj2, prop);
-
-              set_for_property:
-                /* Set the variable obj[id] to refer to rval. */
-                fp->flags |= JSFRAME_ASSIGNING;
-                ok = OBJ_SET_PROPERTY(cx, obj, id, &rval);
-                fp->flags &= ~JSFRAME_ASSIGNING;
-                if (!ok)
-                    goto error;
-                break;
-            }
-
-            /* Push true to keep looping through properties. */
-            rval = JSVAL_TRUE;
-
-          end_forinloop:
-            regs.sp += i + 1;
-            PUSH_OPND(rval);
-            len = js_CodeSpec[op].length;
-            DO_NEXT_OP(len);
+             * JSOP_FORELEM simply dups the property identifier at top of stack
+             * and lets the subsequent JSOP_ENUMELEM opcode sequence handle the
+             * left-hand side expression evaluation and assignment. This opcode
+             * exists solely to help the decompiler.
+             */
+            JS_ASSERT(regs.sp - 2 >= StackBase(fp));
+            rval = FETCH_OPND(-1);
+            PUSH(rval);
+          END_CASE(JSOP_FORELEM)
 
           BEGIN_CASE(JSOP_DUP)
             JS_ASSERT(regs.sp > StackBase(fp));
             rval = FETCH_OPND(-1);
             PUSH(rval);
           END_CASE(JSOP_DUP)
 
           BEGIN_CASE(JSOP_DUP2)
             JS_ASSERT(regs.sp - 2 >= StackBase(fp));
             lval = FETCH_OPND(-2);
             rval = FETCH_OPND(-1);
             PUSH(lval);
             PUSH(rval);
           END_CASE(JSOP_DUP2)
+
+          BEGIN_CASE(JSOP_SWAP)
+            JS_ASSERT(regs.sp - 2 >= StackBase(fp));
+            lval = FETCH_OPND(-2);
+            rval = FETCH_OPND(-1);
+            STORE_OPND(-1, lval);
+            STORE_OPND(-2, rval);
+          END_CASE(JSOP_SWAP)
 
 #define PROPERTY_OP(n, call)                                                  \
     JS_BEGIN_MACRO                                                            \
         /* Fetch the left part and resolve it to a non-null object. */        \
         FETCH_OBJECT(cx, n, lval, obj);                                       \
                                                                               \
         /* Get or set the property. */                                        \
         if (!call)                                                            \
@@ -3510,16 +3496,21 @@ js_Interpret(JSContext *cx)
                 }
                 id = ATOM_TO_JSID(atom);
                 obj = js_FindIdentifierBase(cx, id, entry);
                 if (!obj)
                     goto error;
             } while (0);
             PUSH_OPND(OBJECT_TO_JSVAL(obj));
           END_CASE(JSOP_BINDNAME)
+
+          BEGIN_CASE(JSOP_IMACOP)
+            JS_ASSERT(JS_UPTRDIFF(fp->imacpc, script->code) < script->length);
+            op = JSOp(*fp->imacpc);
+            DO_OP();
 
 #define BITWISE_OP(OP)                                                        \
     JS_BEGIN_MACRO                                                            \
         FETCH_INT(cx, -2, i);                                                 \
         FETCH_INT(cx, -1, j);                                                 \
         i = i OP j;                                                           \
         regs.sp--;                                                            \
         STORE_INT(cx, -1, i);                                                 \
@@ -4783,20 +4774,136 @@ js_Interpret(JSContext *cx)
             }
 
             if (!js_InvokeConstructor(cx, argc, JS_FALSE, vp))
                 goto error;
             regs.sp = vp + 1;
             LOAD_INTERRUPT_HANDLER(cx);
           END_CASE(JSOP_NEW)
 
+          BEGIN_CASE(JSOP_APPLY)
+          {
+            argc = GET_ARGC(regs.pc);
+            vp = regs.sp - (argc + 2);
+            lval = *vp;
+            if (!VALUE_IS_FUNCTION(cx, lval))
+                goto do_call;
+            obj = JSVAL_TO_OBJECT(lval);
+            fun = GET_FUNCTION_PRIVATE(cx, obj);
+            if (FUN_INTERPRETED(fun))
+                goto do_call;
+
+            bool apply = (JSFastNative)fun->u.n.native == js_fun_apply;
+            if (!apply && (JSFastNative)fun->u.n.native != js_fun_call)
+                goto do_call;
+
+            /* 
+             * If the second arg to apply is null or void, treat it as an empty
+             * array.
+             */
+            jsuint applylen = 0;
+            if (apply && argc >= 2 &&
+                !JSVAL_IS_VOID(vp[3]) && !JSVAL_IS_NULL(vp[3])) {
+                /* 
+                 * Fall back on js_Invoke when the array argument has a wrong
+                 * type or when it has too many elements to fit into the
+                 * current stack chunk.
+                 */
+                if (!JSVAL_IS_OBJECT(vp[3]))
+                    goto do_call;
+
+                JSBool arraylike;
+                JSObject* aobj = JSVAL_TO_OBJECT(vp[3]);
+                if (!js_IsArrayLike(cx, aobj, &arraylike, &applylen))
+                    goto error;
+                if (!arraylike || applylen > ARGC_LIMIT)
+                    goto do_call;
+
+                JSArena *a = cx->stackPool.current;
+                JS_ASSERT(jsuword(vp + 2) <= a->limit);
+
+                /*
+                 * We need space for applylen elements plus an extra slot to
+                 * temporary root the array object when we unpack its elements
+                 * using OBJ_GET_PROPERTY below.
+                 */
+                if (a->limit - jsuword(vp + 2) < (applylen + 1) * sizeof(jsval))
+                    goto do_call;
+            }
+
+            if (!VALUE_IS_FUNCTION(cx, vp[1]))
+                goto do_call;
+            vp[0] = vp[1];
+
+            if (argc == 0) {
+                /* 
+                 * Call fun with its global object as the 'this' param if 
+                 * no args. 
+                 */
+                obj = NULL;
+            } else {
+                /* Convert the first arg to 'this'. */
+                if (!JSVAL_IS_PRIMITIVE(vp[2]))
+                    obj = JSVAL_TO_OBJECT(vp[2]);
+                else if (!js_ValueToObject(cx, vp[2], &obj))
+                    goto error;
+            }
+            vp[1] = OBJECT_TO_JSVAL(obj);
+
+            if (!apply) {
+                if (argc != 0) {
+                    --argc;
+                    memmove(vp + 2, vp + 3, argc * sizeof *vp);
+                }
+            } else if (applylen == 0) {
+                argc = 0;
+            } else {
+                /* 
+                 * Make room for missing arguments to the right including the
+                 * temporary root nulling any extra stack slots for GC safety.
+                 */
+                jsval* newsp = vp + 2 + applylen + 1;
+                if (newsp > regs.sp) {
+                    JSArena *a = cx->stackPool.current;
+                    JS_ASSERT(jsuword(newsp) <= a->limit); /* see above */
+                    if ((jsuword) newsp > a->avail)
+                        a->avail = (jsuword) newsp;
+                    memset(vp + 2 + argc, 0, (applylen - argc) * sizeof(jsval));
+                }
+
+                JSObject *aobj = JSVAL_TO_OBJECT(vp[3]);
+                newsp[-1] = vp[3];
+                regs.sp = newsp;
+
+                /* Expand array content onto the stack. */
+                for (i = 0; i < jsint(applylen); i++) {
+                    id = INT_TO_JSID(i);
+                    if (!OBJ_GET_PROPERTY(cx, aobj, id, &vp[2 + i])) {
+                        /* 
+                         * There is no good way to restore the original stack
+                         * state here, but it is in a reasonable  state with
+                         * either original elements or nulls for all arguments
+                         * we didn't unpack yet, so we leave it at that.
+                         */
+                        goto error;
+                    }
+                }
+                argc = applylen;
+            }
+            regs.sp = vp + 2 + argc;
+            goto do_call_with_specified_vp_and_argc;
+          }
+          
           BEGIN_CASE(JSOP_CALL)
           BEGIN_CASE(JSOP_EVAL)
+          do_call:
             argc = GET_ARGC(regs.pc);
             vp = regs.sp - (argc + 2);
+            
+          do_call_with_specified_vp_and_argc:
             lval = *vp;
             if (VALUE_IS_FUNCTION(cx, lval)) {
                 obj = JSVAL_TO_OBJECT(lval);
                 fun = GET_FUNCTION_PRIVATE(cx, obj);
 
                 /* Clear frame flags since this is not a constructor call. */
                 flags = 0;
                 if (FUN_INTERPRETED(fun))
@@ -4905,16 +5012,17 @@ js_Interpret(JSContext *cx)
                     newifp->mark = newmark;
 
                     /* Compute the 'this' parameter now that argv is set. */
                     JS_ASSERT(!JSFUN_BOUND_METHOD_TEST(fun->flags));
                     JS_ASSERT(JSVAL_IS_OBJECT(vp[1]));
                     newifp->frame.thisp = (JSObject *)vp[1];
 
                     newifp->frame.regs = NULL;
+                    newifp->frame.imacpc = NULL;
                     newifp->frame.slots = newsp;
 
                     /* Push void to initialize local variables. */
                     nvars = fun->u.i.nvars;
                     while (nvars--)
                         *newsp++ = JSVAL_VOID;
 
                     /* Call the debugger hook if present. */
@@ -4944,20 +5052,17 @@ js_Interpret(JSContext *cx)
                     /* Push the frame and set interpreter registers. */
                     newifp->callerRegs = regs;
                     fp->regs = &newifp->callerRegs;
                     regs.sp = newsp;
                     regs.pc = script->code;
                     newifp->frame.regs = &regs;
                     cx->fp = fp = &newifp->frame;
 
-#ifdef JS_TRACER
-                    if (TRACE_RECORDER(cx))
-                        RECORD(EnterFrame);
-#endif
+                    TRACE_0(EnterFrame);
 
                     inlineCallCount++;
                     JS_RUNTIME_METER(rt, inlineCalls);
 
 #ifdef INCLUDE_MOZILLA_DTRACE
                     /* DTrace function entry, inlines */
                     if (JAVASCRIPT_FUNCTION_ENTRY_ENABLED())
                         jsdtrace_function_entry(cx, fp, fun);
@@ -6706,27 +6811,16 @@ js_Interpret(JSContext *cx)
             if (op == JSOP_LEAVEBLOCKEXPR) {
                 JS_ASSERT(StackBase(fp) + blockDepth == regs.sp - 1);
                 STORE_OPND(-1, rval);
             } else {
                 JS_ASSERT(StackBase(fp) + blockDepth == regs.sp);
             }
           }
           END_CASE(JSOP_LEAVEBLOCK)
-
-          BEGIN_CASE(JSOP_ENDITER)
-            /*
-             * Decrease the stack pointer even when !ok, see comments in the
-             * exception capturing code for details.
-             */
-            ok = js_CloseIterator(cx, regs.sp[-1]);
-            regs.sp--;
-            if (!ok)
-                goto error;
-          END_CASE(JSOP_ENDITER)
 
 #if JS_HAS_GENERATORS
           BEGIN_CASE(JSOP_GENERATOR)
             ASSERT_NOT_THROWING(cx);
             regs.pc += JSOP_GENERATOR_LENGTH;
             obj = js_NewGenerator(cx, fp);
             if (!obj)
                 goto error;
@@ -6818,29 +6912,26 @@ js_Interpret(JSContext *cx)
           L_JSOP_TOATTRNAME:
           L_JSOP_QNAME:
           L_JSOP_QNAMECONST:
           L_JSOP_QNAMEPART:
           L_JSOP_ANYNAME:
           L_JSOP_DEFXMLNS:
 # endif
 
-          L_JSOP_UNUSED74:
-          L_JSOP_UNUSED76:
-          L_JSOP_UNUSED77:
-          L_JSOP_UNUSED78:
-          L_JSOP_UNUSED79:
           L_JSOP_UNUSED131:
           L_JSOP_UNUSED201:
           L_JSOP_UNUSED202:
           L_JSOP_UNUSED203:
           L_JSOP_UNUSED204:
           L_JSOP_UNUSED205:
           L_JSOP_UNUSED206:
           L_JSOP_UNUSED207:
+          L_JSOP_UNUSED208:
+          L_JSOP_UNUSED209:
           L_JSOP_UNUSED219:
           L_JSOP_UNUSED226:
 
 #else /* !JS_THREADED_INTERP */
           default:
 #endif
           {
             char numBuf[12];
@@ -6866,16 +6957,35 @@ js_Interpret(JSContext *cx)
 
 #if !JS_THREADED_INTERP
 
         } /* switch (op) */
     }
 #endif /* !JS_THREADED_INTERP */
 
   error:
+    if (fp->imacpc && cx->throwing) {
+        // To keep things simple, we hard-code imacro exception handlers here.
+        if (*fp->imacpc == JSOP_NEXTITER) {
+            JS_ASSERT(*regs.pc == JSOP_CALL);
+            if (js_ValueIsStopIteration(cx->exception)) {
+                cx->throwing = JS_FALSE;
+                cx->exception = JSVAL_VOID;
+                regs.sp[-1] = JSVAL_HOLE;
+                PUSH(JSVAL_FALSE);
+                goto end_imacro;
+            }
+        }
+
+        // Handle other exceptions as if they came from the imacro-calling pc.
+        regs.pc = fp->imacpc;
+        fp->imacpc = NULL;
+        atoms = script->atomMap.vector;
+    }
+
     JS_ASSERT((size_t)(regs.pc - script->code) < script->length);
     if (!cx->throwing) {
         /* This is an error, not a catchable exception, quit the frame ASAP. */
         ok = JS_FALSE;
     } else {
         JSTrapHandler handler;
         JSTryNote *tn, *tnlimit;
         uint32 offset;
@@ -6979,22 +7089,24 @@ js_Interpret(JSContext *cx)
                 PUSH(JSVAL_TRUE);
                 PUSH(cx->exception);
                 cx->throwing = JS_FALSE;
                 len = 0;
                 DO_NEXT_OP(len);
 
               case JSTRY_ITER:
                 /*
-                 * This is similar to JSOP_ENDITER in the interpreter loop
-                 * except the code now uses a reserved stack slot to save and
-                 * restore the exception.
+                 * This is similar to JSOP_ENDITER in the interpreter loop,
+                 * except the code now uses the stack slot normally used by
+                 * JSOP_NEXTITER, namely regs.sp[-1] before the regs.sp -= 2
+                 * adjustment and regs.sp[1] after, to save and restore the
+                 * pending exception.
                  */
                 JS_ASSERT(*regs.pc == JSOP_ENDITER);
-                PUSH(cx->exception);
+                regs.sp[-1] = cx->exception;
                 cx->throwing = JS_FALSE;
                 ok = js_CloseIterator(cx, regs.sp[-2]);
                 regs.sp -= 2;
                 if (!ok)
                     goto error;
                 cx->throwing = JS_TRUE;
                 cx->exception = regs.sp[1];
             }
@@ -7072,18 +7184,16 @@ js_Interpret(JSContext *cx)
         js_SetVersion(cx, originalVersion);
     --cx->interpLevel;
 
 #ifdef JS_TRACER
     if (tr) {
         JS_TRACE_MONITOR(cx).onTrace = JS_TRUE;
         SET_TRACE_RECORDER(cx, tr);
         tr->deepAbort();
-        if (jitCacheGen != JS_TRACE_MONITOR(cx).jitCacheGen)
-            tr->safeCleanup();
     }
 #endif
     return ok;
 
   atom_not_defined:
     {
         const char *printable;
 
diff -r a4343d61f6ee js/src/jsinterp.h
--- a/js/src/jsinterp.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsinterp.h	Sat Nov 15 19:43:13 2008 -0500
@@ -63,16 +63,17 @@ typedef struct JSFrameRegs {
  *
  * NB: This struct is manually initialized in jsinterp.c and jsiter.c.  If you
  * add new members, update both files.  But first, try to remove members.  The
  * sharp* and xml* members should be moved onto the stack as local variables
  * with well-known slots, if possible.
  */
 struct JSStackFrame {
     JSFrameRegs     *regs;
+    jsbytecode      *imacpc;        /* null or interpreter macro call pc */
     jsval           *slots;         /* variables, locals and operand stack */
     JSObject        *callobj;       /* lazily created Call object */
     JSObject        *argsobj;       /* lazily created arguments object */
     JSObject        *varobj;        /* variables object, where vars go */
     JSObject        *callee;        /* function or script object */
     JSScript        *script;        /* script being interpreted */
     JSFunction      *fun;           /* function being called or null */
     JSObject        *thisp;         /* "this" pointer if in method */
@@ -89,16 +90,26 @@ struct JSStackFrame {
     JSObject        *xmlNamespace;  /* null or default xml namespace in E4X */
     JSObject        *blockChain;    /* active compile-time block scopes */
     JSStackFrame    *displaySave;   /* previous value of display entry for
                                        script->staticDepth */
 #ifdef DEBUG
     jsrefcount      pcDisabledSave; /* for balanced property cache control */
 #endif
 };
+
+#ifdef DEBUG
+#ifdef __cplusplus
+static JS_INLINE uintN
+FramePCOffset(JSStackFrame* fp)
+{
+    return uintN((fp->imacpc ? fp->imacpc : fp->regs->pc) - fp->script->code);
+}
+#endif
+#endif
 
 static JS_INLINE jsval *
 StackBase(JSStackFrame *fp)
 {
     return fp->slots + fp->script->nfixed;
 }
 
 static JS_INLINE uintN
diff -r a4343d61f6ee js/src/jsiter.cpp
--- a/js/src/jsiter.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsiter.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -607,39 +607,34 @@ js_CallIteratorNext(JSContext *cx, JSObj
             return JS_FALSE;
     } else {
         jsid id = ATOM_TO_JSID(cx->runtime->atomState.nextAtom);
 
         if (!JS_GetMethodById(cx, iterobj, id, &iterobj, rval))
             return JS_FALSE;
         if (!js_InternalCall(cx, iterobj, *rval, 0, NULL, rval)) {
             /* Check for StopIteration. */
-            if (!cx->throwing ||
-                JSVAL_IS_PRIMITIVE(cx->exception) ||
-                OBJ_GET_CLASS(cx, JSVAL_TO_OBJECT(cx->exception))
-                    != &js_StopIterationClass) {
+            if (!cx->throwing || !js_ValueIsStopIteration(cx->exception))
                 return JS_FALSE;
-            }
 
             /* Inline JS_ClearPendingException(cx). */
             cx->throwing = JS_FALSE;
             cx->exception = JSVAL_VOID;
             *rval = JSVAL_HOLE;
             return JS_TRUE;
         }
     }
 
     return JS_TRUE;
 }
 
 static JSBool
 stopiter_hasInstance(JSContext *cx, JSObject *obj, jsval v, JSBool *bp)
 {
-    *bp = !JSVAL_IS_PRIMITIVE(v) &&
-          OBJ_GET_CLASS(cx, JSVAL_TO_OBJECT(v)) == &js_StopIterationClass;
+    *bp = js_ValueIsStopIteration(v);
     return JS_TRUE;
 }
 
 JSClass js_StopIterationClass = {
     js_StopIteration_str,
     JSCLASS_HAS_CACHED_PROTO(JSProto_StopIteration),
     JS_PropertyStub,  JS_PropertyStub,
     JS_PropertyStub,  JS_PropertyStub,
@@ -712,29 +707,28 @@ JSClass js_GeneratorClass = {
  * from *fp.  We know that upon return, the JSOP_GENERATOR opcode will return
  * from the activation in fp, so we can steal away fp->callobj and fp->argsobj
  * if they are non-null.
  */
 JSObject *
 js_NewGenerator(JSContext *cx, JSStackFrame *fp)
 {
     JSObject *obj;
-    uintN argc, nargs, nvars, nslots;
+    uintN argc, nargs, nslots;
     JSGenerator *gen;
     jsval *slots;
 
     /* After the following return, failing control flow must goto bad. */
     obj = js_NewObject(cx, &js_GeneratorClass, NULL, NULL, 0);
     if (!obj)
         return NULL;
 
     /* Load and compute stack slot counts. */
     argc = fp->argc;
     nargs = JS_MAX(argc, fp->fun->nargs);
-    nvars = fp->fun->u.i.nvars;
     nslots = 2 + nargs + fp->script->nslots;
 
     /* Allocate obj's private data struct. */
     gen = (JSGenerator *)
           JS_malloc(cx, sizeof(JSGenerator) + (nslots - 1) * sizeof(jsval));
     if (!gen)
         goto bad;
 
@@ -775,16 +769,17 @@ js_NewGenerator(JSContext *cx, JSStackFr
     slots += 2 + nargs;
     memcpy(slots, fp->slots, fp->script->nfixed * sizeof(jsval));
 
     /* Initialize or copy virtual machine state. */
     gen->frame.down = NULL;
     gen->frame.annotation = NULL;
     gen->frame.scopeChain = fp->scopeChain;
 
+    gen->frame.imacpc = NULL;
     gen->frame.slots = slots;
     JS_ASSERT(StackBase(fp) == fp->regs->sp);
     gen->savedRegs.sp = slots + fp->script->nfixed;
     gen->savedRegs.pc = fp->regs->pc;
     gen->frame.regs = &gen->savedRegs;
 
     /* Copy remaining state (XXX sharp* and xml* should be local vars). */
     gen->frame.sharpDepth = 0;
diff -r a4343d61f6ee js/src/jsiter.h
--- a/js/src/jsiter.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsiter.h	Sat Nov 15 19:43:13 2008 -0500
@@ -120,14 +120,21 @@ js_NewGenerator(JSContext *cx, JSStackFr
 js_NewGenerator(JSContext *cx, JSStackFrame *fp);
 
 #endif
 
 extern JSClass          js_GeneratorClass;
 extern JSClass          js_IteratorClass;
 extern JSClass          js_StopIterationClass;
 
+static inline bool
+js_ValueIsStopIteration(jsval v)
+{
+    return !JSVAL_IS_PRIMITIVE(v) &&
+           STOBJ_GET_CLASS(JSVAL_TO_OBJECT(v)) == &js_StopIterationClass;
+}
+
 extern JSObject *
 js_InitIteratorClasses(JSContext *cx, JSObject *obj);
 
 JS_END_EXTERN_C
 
 #endif /* jsiter_h___ */
diff -r a4343d61f6ee js/src/jsmath.cpp
--- a/js/src/jsmath.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsmath.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -600,16 +600,22 @@ math_toSource(JSContext *cx, uintN argc,
 
 MATH_BUILTIN_1(sin)
 MATH_BUILTIN_1(cos)
 MATH_BUILTIN_1(sqrt)
 MATH_BUILTIN_1(floor)
 MATH_BUILTIN_1(ceil)
 
 static jsdouble FASTCALL
+math_abs_tn(jsdouble d)
+{
+    return fabs(d);
+}
+
+static jsdouble FASTCALL
 math_log_tn(jsdouble d)
 {
 #if defined(SOLARIS) && defined(__GNUC__)
     if (d < 0)
         return js_NaN;
 #endif
     return log(d);
 }
@@ -643,46 +649,56 @@ math_random_tn(JSRuntime* rt)
 {
     JS_LOCK_RUNTIME(rt);
     js_random_init(rt);
     jsdouble z = js_random_nextDouble(rt);
     JS_UNLOCK_RUNTIME(rt);
     return z;
 }
 
+static jsdouble FASTCALL
+math_round_tn(jsdouble x)
+{
+    return js_copysign(floor(x + 0.5), x);
+}
+
+JS_DEFINE_TRCINFO_1(math_abs,
+    (1, (static, DOUBLE, math_abs_tn, DOUBLE,           1, 1)))
 JS_DEFINE_TRCINFO_1(math_log,
     (1, (static, DOUBLE, math_log_tn, DOUBLE,           1, 1)))
 JS_DEFINE_TRCINFO_1(math_max,
     (2, (static, DOUBLE, math_max_tn, DOUBLE, DOUBLE,   1, 1)))
 JS_DEFINE_TRCINFO_1(math_pow,
     (2, (static, DOUBLE, math_pow_tn, DOUBLE, DOUBLE,   1, 1)))
 JS_DEFINE_TRCINFO_1(math_random,
     (1, (static, DOUBLE, math_random_tn, RUNTIME,       0, 0)))
+JS_DEFINE_TRCINFO_1(math_round,
+    (1, (static, DOUBLE, math_round_tn, DOUBLE,         1, 1)))
 
 #endif /* JS_TRACER */
 
 static JSFunctionSpec math_static_methods[] = {
 #if JS_HAS_TOSOURCE
     JS_FN(js_toSource_str,  math_toSource,        0, 0),
 #endif
-    JS_FN("abs",            math_abs,             1, 0),
+    JS_TN("abs",            math_abs,             1, 0, math_abs_trcinfo),
     JS_FN("acos",           math_acos,            1, 0),
     JS_FN("asin",           math_asin,            1, 0),
     JS_FN("atan",           math_atan,            1, 0),
     JS_FN("atan2",          math_atan2,           2, 0),
     JS_TN("ceil",           math_ceil,            1, 0, math_ceil_trcinfo),
     JS_TN("cos",            math_cos,             1, 0, math_cos_trcinfo),
     JS_FN("exp",            math_exp,             1, 0),
     JS_TN("floor",          math_floor,           1, 0, math_floor_trcinfo),
     JS_TN("log",            math_log,             1, 0, math_log_trcinfo),
     JS_TN("max",            math_max,             2, 0, math_max_trcinfo),
     JS_FN("min",            math_min,             2, 0),
     JS_TN("pow",            math_pow,             2, 0, math_pow_trcinfo),
     JS_TN("random",         math_random,          0, 0, math_random_trcinfo),
-    JS_FN("round",          math_round,           1, 0),
+    JS_TN("round",          math_round,           1, 0, math_round_trcinfo),
     JS_TN("sin",            math_sin,             1, 0, math_sin_trcinfo),
     JS_TN("sqrt",           math_sqrt,            1, 0, math_sqrt_trcinfo),
     JS_FN("tan",            math_tan,             1, 0),
     JS_FS_END
 };
 
 JSObject *
 js_InitMathClass(JSContext *cx, JSObject *obj)
diff -r a4343d61f6ee js/src/jsobj.cpp
--- a/js/src/jsobj.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsobj.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -1166,18 +1166,17 @@ js_ComputeFilename(JSContext *cx, JSStac
         *linenop = 0;
         return principals->codebase;
     }
 
     if (caller->regs && *caller->regs->pc == JSOP_EVAL) {
         JS_ASSERT(caller->regs->pc[JSOP_EVAL_LENGTH] == JSOP_LINENO);
         *linenop = GET_UINT16(caller->regs->pc + JSOP_EVAL_LENGTH);
     } else {
-        *linenop = js_PCToLineNumber(cx, caller->script,
-                                     caller->regs ? caller->regs->pc : NULL);
+        *linenop = js_FramePCToLineNumber(cx, caller);
     }
     return caller->script->filename;
 }
 
 static JSBool
 obj_eval(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
 {
     JSStackFrame *fp, *caller;
@@ -3409,17 +3408,17 @@ js_LookupPropertyWithFlags(JSContext *cx
                     newresolve = (JSNewResolveOp)resolve;
                     if (flags == JSRESOLVE_INFER && cx->fp && cx->fp->regs) {
                         flags = 0;
                         pc = cx->fp->regs->pc;
                         cs = &js_CodeSpec[*pc];
                         format = cs->format;
                         if (JOF_MODE(format) != JOF_NAME)
                             flags |= JSRESOLVE_QUALIFIED;
-                        if ((format & JOF_ASSIGNING) ||
+                        if ((format & (JOF_SET | JOF_FOR)) ||
                             (cx->fp->flags & JSFRAME_ASSIGNING)) {
                             flags |= JSRESOLVE_ASSIGNING;
                         } else {
                             pc += cs->length;
                             if (Detecting(cx, pc))
                                 flags |= JSRESOLVE_DETECTING;
                         }
                         if (format & JOF_DECLARING)
@@ -4616,17 +4615,17 @@ js_Call(JSContext *cx, JSObject *obj, ui
     if (!clasp->call) {
 #ifdef NARCISSUS
         JSObject *callee, *args;
         jsval fval, nargv[3];
         JSBool ok;
 
         callee = JSVAL_TO_OBJECT(argv[-2]);
         if (!OBJ_GET_PROPERTY(cx, callee,
-                              ATOM_TO_JSID(cx->runtime->atomState.callAtom),
+                              ATOM_TO_JSID(cx->runtime->atomState.__call__Atom),
                               &fval)) {
             return JS_FALSE;
         }
         if (VALUE_IS_FUNCTION(cx, fval)) {
             if (!GetCurrentExecutionContext(cx, obj, &nargv[2]))
                 return JS_FALSE;
             args = js_GetArgsObject(cx, cx->fp);
             if (!args)
@@ -4659,17 +4658,17 @@ js_Construct(JSContext *cx, JSObject *ob
 #ifdef NARCISSUS
         JSObject *callee, *args;
         jsval cval, nargv[2];
         JSBool ok;
 
         callee = JSVAL_TO_OBJECT(argv[-2]);
         if (!OBJ_GET_PROPERTY(cx, callee,
                               ATOM_TO_JSID(cx->runtime->atomState
-                                           .constructAtom),
+                                           .__construct__Atom),
                               &cval)) {
             return JS_FALSE;
         }
         if (VALUE_IS_FUNCTION(cx, cval)) {
             if (!GetCurrentExecutionContext(cx, obj, &nargv[1]))
                 return JS_FALSE;
             args = js_GetArgsObject(cx, cx->fp);
             if (!args)
@@ -4699,17 +4698,17 @@ js_HasInstance(JSContext *cx, JSObject *
     if (clasp->hasInstance)
         return clasp->hasInstance(cx, obj, v, bp);
 #ifdef NARCISSUS
     {
         jsval fval, rval;
 
         if (!OBJ_GET_PROPERTY(cx, obj,
                               ATOM_TO_JSID(cx->runtime->atomState
-                                           .hasInstanceAtom),
+                                           .__hasInstance__Atom),
                               &fval)) {
             return JS_FALSE;
         }
         if (VALUE_IS_FUNCTION(cx, fval)) {
             if (!js_InternalCall(cx, obj, fval, 1, &v, &rval))
                 return JS_FALSE;
             *bp = js_ValueToBoolean(rval);
             return JS_TRUE;
diff -r a4343d61f6ee js/src/json.cpp
--- a/js/src/json.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/json.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -78,78 +78,86 @@ js_json_parse(JSContext *cx, uintN argc,
     JSBool ok = jp != NULL;
 
     if (ok) {
         ok = js_ConsumeJSONText(cx, jp, JS_GetStringChars(s), JS_GetStringLength(s));
         ok &= js_FinishJSONParse(cx, jp);
     }
 
     if (!ok)
-        JS_ReportError(cx, "Error parsing JSON.");
+        JS_ReportError(cx, "Error parsing JSON");
 
     return ok;
 }
 
-struct StringifyClosure
+class StringifyClosure : JSAutoTempValueRooter
 {
-    StringifyClosure(JSContext *aCx, jsval *str) : cx(aCx), s(str)
+public:
+    StringifyClosure(JSContext *cx, size_t len, jsval *vec)
+        : JSAutoTempValueRooter(cx, len, vec), cx(cx), s(vec)
     {
     }
 
     JSContext *cx;
     jsval *s;
 };
 
 static JSBool
 WriteCallback(const jschar *buf, uint32 len, void *data)
 {
     StringifyClosure *sc = static_cast<StringifyClosure*>(data);
-    JSString *s1 = JSVAL_TO_STRING(*sc->s);
+    JSString *s1 = JSVAL_TO_STRING(sc->s[0]);
     JSString *s2 = js_NewStringCopyN(sc->cx, buf, len);
     if (!s2)
         return JS_FALSE;
+
+    sc->s[1] = STRING_TO_JSVAL(s2);
 
     s1 = js_ConcatStrings(sc->cx, s1, s2);
     if (!s1)
         return JS_FALSE;
 
-    *sc->s = STRING_TO_JSVAL(s1);
+    sc->s[0] = STRING_TO_JSVAL(s1);
+    sc->s[1] = JSVAL_VOID;
+
     return JS_TRUE;
 }
 
 JSBool
 js_json_stringify(JSContext *cx, uintN argc, jsval *vp)
 {
     JSObject *obj;
     jsval *argv = vp + 2;
     
     // Must throw an Error if there isn't a first arg
     if (!JS_ConvertArguments(cx, argc, argv, "o", &obj))
         return JS_FALSE;
 
     // Only use objects and arrays as the root for now
-    jsval v = OBJECT_TO_JSVAL(obj);
-    JSBool ok = js_TryJSON(cx, &v);
+    *vp = OBJECT_TO_JSVAL(obj);
+    
+    JSBool ok = js_TryJSON(cx, vp);
     JSType type;
-    if (!(ok && !JSVAL_IS_PRIMITIVE(v) &&
-          (type = JS_TypeOfValue(cx, v)) != JSTYPE_FUNCTION &&
-          type != JSTYPE_XML)) {
-        JS_ReportError(cx, "Invalid argument.");
+    if (!ok ||
+        JSVAL_IS_PRIMITIVE(*vp) ||
+        ((type = JS_TypeOfValue(cx, *vp)) == JSTYPE_FUNCTION ||
+        type == JSTYPE_XML)) {
+        JS_ReportError(cx, "Invalid argument");
         return JS_FALSE;
     }
     
     JSString *s = JS_NewStringCopyN(cx, "", 0);
     if (!s)
         ok = JS_FALSE;
 
     if (ok) {
-        jsval sv = STRING_TO_JSVAL(s);
-        StringifyClosure sc(cx, &sv);
-        JSAutoTempValueRooter tvr(cx, 1, sc.s);
-        ok = js_Stringify(cx, &v, NULL, &WriteCallback, &sc, 0);
+        jsval vec[2] = {STRING_TO_JSVAL(s), JSVAL_VOID};
+        StringifyClosure sc(cx, 2, vec);
+        JSAutoTempValueRooter resultTvr(cx, 1, sc.s);
+        ok = js_Stringify(cx, vp, NULL, &WriteCallback, &sc, 0);
         *vp = *sc.s;
     }
 
     return ok;
 }
 
 JSBool
 js_TryJSON(JSContext *cx, jsval *vp)
@@ -183,23 +191,25 @@ write_string(JSContext *cx, JSONWriteCal
             if (!callback(&buf[mark], i - mark, data) || !callback(&backslash, 1, data) ||
                 !callback(&buf[i], 1, data)) {
                 return JS_FALSE;
             }
             mark = i + 1;
         } else if (buf[i] <= 31 || buf[i] == 127) {
             if (!callback(&buf[mark], i - mark, data) || !callback(unicodeEscape, 4, data))
                 return JS_FALSE;
-            char ubuf[10];
-            unsigned int len = JS_snprintf(ubuf, sizeof(ubuf), "%.2x", buf[i]);
+            char ubuf[3];
+            size_t len = JS_snprintf(ubuf, sizeof(ubuf), "%.2x", buf[i]);
             JS_ASSERT(len == 2);
-            // TODO: don't allocate a JSString just to inflate (js_InflateStringToBuffer on static?)
-            JSString *us = JS_NewStringCopyN(cx, ubuf, len);
-            if (!callback(JS_GetStringChars(us), len, data))
+            jschar wbuf[3];
+            size_t wbufSize = JS_ARRAY_LENGTH(wbuf);
+            if (!js_InflateStringToBuffer(cx, ubuf, len, wbuf, &wbufSize) ||
+                !callback(wbuf, wbufSize, data)) {
                 return JS_FALSE;
+            }
             mark = i + 1;
         }
     }
 
     if (mark < len && !callback(&buf[mark], len - mark, data))
         return JS_FALSE;
 
     if (!callback(&quote, 1, data))
@@ -241,17 +251,18 @@ js_Stringify(JSContext *cx, jsval *vp, J
     jsval key;
     JSBool memberWritten = JS_FALSE;
     do {
         outputValue = JSVAL_VOID;
 
         if (isArray) {
             if ((jsuint)i >= length)
                 break;
-            ok = JS_GetElement(cx, obj, i++, &outputValue);
+            ok = OBJ_GET_PROPERTY(cx, obj, INT_TO_JSID(i), &outputValue);
+            i++;
         } else {
             ok = js_CallIteratorNext(cx, iterObj, &key);
             if (!ok)
                 break;
             if (key == JSVAL_HOLE)
                 break;
 
             JSString *ks;
@@ -354,28 +365,33 @@ js_Stringify(JSContext *cx, jsval *vp, J
                 outputString = s;
             } else if (JSVAL_IS_NULL(outputValue)) {
                 outputString = JS_NewStringCopyN(cx, "null", 4);
             } else {
                 ok = JS_FALSE; // encoding error
                 break;
             }
 
+            if (!outputString) {
+                ok = JS_FALSE;
+                break;
+            }
+
             ok = callback(JS_GetStringChars(outputString), JS_GetStringLength(outputString), data);
         }
     } while (ok);
 
     if (iterObj) {
         // Always close the iterator, but make sure not to stomp on OK
         ok &= js_CloseIterator(cx, *vp);
         // encoding error or propagate? FIXME: Bug 408838.
     }
 
     if (!ok) {
-        JS_ReportError(cx, "Error during JSON encoding.");
+        JS_ReportError(cx, "Error during JSON encoding");
         return JS_FALSE;
     }
 
     output = jschar(isArray ? ']' : '}');
     ok = callback(&output, 1, data);
 
     return ok;
 }
@@ -405,17 +421,22 @@ js_BeginJSONParse(JSContext *cx, jsval *
     if (!js_AddRoot(cx, &jp->objectStack, "JSON parse stack"))
         goto bad;
 
     jp->hexChar = 0;
     jp->numHex = 0;
     jp->statep = jp->stateStack;
     *jp->statep = JSON_PARSE_STATE_INIT;
     jp->rootVal = rootVal;
-    jp->objectKey = NULL;
+
+    jp->objectKey = (JSStringBuffer*) JS_malloc(cx, sizeof(JSStringBuffer));
+    if (!jp->objectKey)
+        goto bad;
+    js_InitStringBuffer(jp->objectKey);
+    
     jp->buffer = (JSStringBuffer*) JS_malloc(cx, sizeof(JSStringBuffer));
     if (!jp->buffer)
         goto bad;
     js_InitStringBuffer(jp->buffer);
 
     return jp;
 bad:
     JS_free(cx, jp->buffer);
@@ -424,20 +445,24 @@ bad:
 }
 
 JSBool
 js_FinishJSONParse(JSContext *cx, JSONParser *jp)
 {
     if (!jp)
         return JS_TRUE;
 
+    if (jp->objectKey)
+        js_FinishStringBuffer(jp->objectKey);
+    JS_free(cx, jp->objectKey);
+
     if (jp->buffer)
         js_FinishStringBuffer(jp->buffer);
-
     JS_free(cx, jp->buffer);
+    
     if (!js_RemoveRoot(cx->runtime, &jp->objectStack))
         return JS_FALSE;
     JSBool ok = *jp->statep == JSON_PARSE_STATE_FINISHED;
     JS_free(cx, jp);
 
     return ok;
 }
 
@@ -475,69 +500,81 @@ PushValue(JSContext *cx, JSONParser *jp,
 PushValue(JSContext *cx, JSONParser *jp, JSObject *parent, jsval value)
 {
     JSAutoTempValueRooter tvr(cx, 1, &value);
  
     JSBool ok;
     if (OBJ_IS_ARRAY(cx, parent)) {
         jsuint len;
         ok = js_GetLengthProperty(cx, parent, &len);
-        if (ok)
-            ok = JS_SetElement(cx, parent, len, &value);
+        if (ok) {
+            ok = OBJ_DEFINE_PROPERTY(cx, parent, INT_TO_JSID(len), value,
+                                     NULL, NULL, JSPROP_ENUMERATE, NULL);
+        }
     } else {
-        ok = JS_DefineUCProperty(cx, parent, JS_GetStringChars(jp->objectKey),
-                                 JS_GetStringLength(jp->objectKey), value,
+        ok = JS_DefineUCProperty(cx, parent, jp->objectKey->base,
+                                 STRING_BUFFER_OFFSET(jp->objectKey), value,
                                  NULL, NULL, JSPROP_ENUMERATE);
+        js_FinishStringBuffer(jp->objectKey);
+        js_InitStringBuffer(jp->objectKey);
     }
 
     return ok;
 }
 
 static JSBool
 PushObject(JSContext *cx, JSONParser *jp, JSObject *obj)
 {
     jsuint len;
     if (!js_GetLengthProperty(cx, jp->objectStack, &len))
         return JS_FALSE;
     if (len >= JSON_MAX_DEPTH)
         return JS_FALSE; // decoding error
 
     jsval v = OBJECT_TO_JSVAL(obj);
+    JSAutoTempValueRooter tvr(cx, v);
 
     // Check if this is the root object
     if (len == 0) {
         *jp->rootVal = v;
-        if (!JS_SetElement(cx, jp->objectStack, 0, jp->rootVal))
+        // This property must be enumerable to keep the array dense
+        if (!OBJ_DEFINE_PROPERTY(cx, jp->objectStack, INT_TO_JSID(0), *jp->rootVal,
+                                 NULL, NULL, JSPROP_ENUMERATE, NULL)) {
             return JS_FALSE;
+        }
         return JS_TRUE;
     }
 
     jsval p;
-    if (!JS_GetElement(cx, jp->objectStack, len - 1, &p))
+    if (!OBJ_GET_PROPERTY(cx, jp->objectStack, INT_TO_JSID(len - 1), &p))
         return JS_FALSE;
+
     JS_ASSERT(JSVAL_IS_OBJECT(p));
     JSObject *parent = JSVAL_TO_OBJECT(p);
     if (!PushValue(cx, jp, parent, OBJECT_TO_JSVAL(obj)))
         return JS_FALSE;
 
-    if (!JS_SetElement(cx, jp->objectStack, len, &v))
+    // This property must be enumerable to keep the array dense
+    if (!OBJ_DEFINE_PROPERTY(cx, jp->objectStack, INT_TO_JSID(len), v,
+                             NULL, NULL, JSPROP_ENUMERATE, NULL)) {
         return JS_FALSE;
+    }
 
     return JS_TRUE;
 }
 
 static JSObject *
 GetTopOfObjectStack(JSContext *cx, JSONParser *jp)
 {
     jsuint length;
     if (!js_GetLengthProperty(cx, jp->objectStack, &length))
         return NULL;
     
     jsval o;
-    if (!JS_GetElement(cx, jp->objectStack, length - 1, &o))
+    if (!OBJ_GET_PROPERTY(cx, jp->objectStack, INT_TO_JSID(length - 1), &o))
         return NULL;
     
     JS_ASSERT(!JSVAL_IS_PRIMITIVE(o));
     return JSVAL_TO_OBJECT(o);
 }
 
 static JSBool
 OpenObject(JSContext *cx, JSONParser *jp)
@@ -628,36 +665,39 @@ HandleKeyword(JSContext *cx, JSONParser 
     JSObject *obj = GetTopOfObjectStack(cx, jp);
     if (!obj)
         return JS_FALSE;
 
     return PushValue(cx, jp, obj, keyword);
 }
 
 static JSBool
-HandleData(JSContext *cx, JSONParser *jp, JSONDataType type, const jschar *buf, uint32 len)
+HandleData(JSContext *cx, JSONParser *jp, JSONDataType type)
 {
   JSBool ok = JS_FALSE;
 
+  if (!STRING_BUFFER_OK(jp->buffer))
+      return JS_FALSE;
+
   switch (type) {
     case JSON_DATA_STRING:
-      ok = HandleString(cx, jp, buf, len);
+      ok = HandleString(cx, jp, jp->buffer->base, STRING_BUFFER_OFFSET(jp->buffer));
       break;
 
     case JSON_DATA_KEYSTRING:
-      jp->objectKey = js_NewStringCopyN(cx, buf, len);
-      ok = JS_TRUE;
+      js_AppendUCString(jp->objectKey, jp->buffer->base, STRING_BUFFER_OFFSET(jp->buffer));
+      ok = STRING_BUFFER_OK(jp->objectKey);
       break;
 
     case JSON_DATA_NUMBER:
-      ok = HandleNumber(cx, jp, buf, len);
+      ok = HandleNumber(cx, jp, jp->buffer->base, STRING_BUFFER_OFFSET(jp->buffer));
       break;
 
     case JSON_DATA_KEYWORD:
-      ok = HandleKeyword(cx, jp, buf, len);
+      ok = HandleKeyword(cx, jp, jp->buffer->base, STRING_BUFFER_OFFSET(jp->buffer));
       break;
 
     default:
       JS_NOT_REACHED("Should have a JSON data type");
   }
 
   js_FinishStringBuffer(jp->buffer);
   js_InitStringBuffer(jp->buffer);
@@ -778,17 +818,17 @@ js_ConsumeJSONText(JSContext *cx, JSONPa
                     if (!PopState(jp))
                         return JS_FALSE;
                     JSONDataType jdt;
                     if (*jp->statep == JSON_PARSE_STATE_OBJECT_IN_PAIR) {
                         jdt = JSON_DATA_KEYSTRING;
                     } else {
                         jdt = JSON_DATA_STRING;
                     }
-                    if (!HandleData(cx, jp, jdt, jp->buffer->base, STRING_BUFFER_OFFSET(jp->buffer)))
+                    if (!HandleData(cx, jp, jdt))
                         return JS_FALSE;
                 } else if (c == '\\') {
                     *jp->statep = JSON_PARSE_STATE_STRING_ESCAPE;
                 } else {
                     js_AppendChar(jp->buffer, c);
                 }
                 break;
 
@@ -840,30 +880,30 @@ js_ConsumeJSONText(JSContext *cx, JSONPa
                 if (JS7_ISLET(c)) {
                     js_AppendChar(jp->buffer, c);
                 } else {
                     // this character isn't part of the keyword, process it again
                     i--;
                     if (!PopState(jp))
                         return JS_FALSE;
 
-                    if (!HandleData(cx, jp, JSON_DATA_KEYWORD, jp->buffer->base, STRING_BUFFER_OFFSET(jp->buffer)))
+                    if (!HandleData(cx, jp, JSON_DATA_KEYWORD))
                         return JS_FALSE;
                 }
                 break;
 
             case JSON_PARSE_STATE_NUMBER:
                 if (IsNumChar(c)) {
                     js_AppendChar(jp->buffer, c);
                 } else {
                     // this character isn't part of the number, process it again
                     i--;
                     if (!PopState(jp))
                         return JS_FALSE;
-                    if (!HandleData(cx, jp, JSON_DATA_NUMBER, jp->buffer->base, STRING_BUFFER_OFFSET(jp->buffer)))
+                    if (!HandleData(cx, jp, JSON_DATA_NUMBER))
                         return JS_FALSE;
                 }
                 break;
 
             case JSON_PARSE_STATE_FINISHED:
                 if (!JS_ISXMLSPACE(c))
                   return JS_FALSE; // extra input
 
diff -r a4343d61f6ee js/src/json.h
--- a/js/src/json.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/json.h	Sat Nov 15 19:43:13 2008 -0500
@@ -83,17 +83,17 @@ struct JSONParser {
 struct JSONParser {
     /* Used while handling \uNNNN in strings */
     jschar hexChar;
     uint8 numHex;
 
     JSONParserState *statep;
     JSONParserState stateStack[JSON_MAX_DEPTH];
     jsval *rootVal;
-    JSString *objectKey;
+    JSStringBuffer *objectKey;
     JSStringBuffer *buffer;
     JSObject *objectStack;
 };
 
 extern JSONParser *
 js_BeginJSONParse(JSContext *cx, jsval *rootVal);
 
 extern JSBool
diff -r a4343d61f6ee js/src/jsopcode.cpp
--- a/js/src/jsopcode.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsopcode.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -67,16 +67,17 @@
 #include "jsobj.h"
 #include "jsopcode.h"
 #include "jsregexp.h"
 #include "jsscan.h"
 #include "jsscope.h"
 #include "jsscript.h"
 #include "jsstr.h"
 #include "jsstaticcheck.h"
+#include "jstracer.h"
 
 #include "jsautooplen.h"
 
 /* Verify JSOP_XXX_LENGTH constant definitions. */
 #define OPDEF(op,val,name,token,length,nuses,ndefs,prec,format)               \
     JS_STATIC_ASSERT(op##_LENGTH == length);
 #include "jsopcode.tbl"
 #undef OPDEF
@@ -99,19 +100,20 @@ uintN js_NumCodeSpecs = JS_ARRAY_LENGTH(
  */
 static const char *CodeToken[] = {
 #define OPDEF(op,val,name,token,length,nuses,ndefs,prec,format) \
     token,
 #include "jsopcode.tbl"
 #undef OPDEF
 };
 
-#ifdef DEBUG
-/*
- * Array of JS bytecode names used by DEBUG-only js_Disassemble.
+#if defined(DEBUG) || defined(JS_JIT_SPEW)
+/*
+ * Array of JS bytecode names used by DEBUG-only js_Disassemble and by
+ * JIT debug spew.
  */
 const char *js_CodeName[] = {
 #define OPDEF(op,val,name,token,length,nuses,ndefs,prec,format) \
     name,
 #include "jsopcode.tbl"
 #undef OPDEF
 };
 #endif
@@ -208,17 +210,18 @@ js_GetVariableStackUseLength(JSOp op, js
         return GET_UINT16(pc);
       case JSOP_LEAVEBLOCKEXPR:
         return GET_UINT16(pc) + 1;
       case JSOP_NEWARRAY:
         return GET_UINT24(pc);
       default:
         /* stack: fun, this, [argc arguments] */
         JS_ASSERT(op == JSOP_NEW || op == JSOP_CALL ||
-                  op == JSOP_EVAL || op == JSOP_SETCALL);
+                  op == JSOP_EVAL || op == JSOP_SETCALL ||
+                  op == JSOP_APPLY);
         return 2 + GET_ARGC(pc);
     }
 }
 
 #ifdef DEBUG
 
 JS_FRIEND_API(JSBool)
 js_Disassemble(JSContext *cx, JSScript *script, JSBool lines, FILE *fp)
@@ -1735,16 +1738,17 @@ Decompile(SprintStack *ss, jsbytecode *p
     JSBool foreach, inXML, quoteAttr;
 #else
 #define inXML JS_FALSE
 #endif
     jsval val;
 
     static const char exception_cookie[] = "/*EXCEPTION*/";
     static const char retsub_pc_cookie[] = "/*RETSUB_PC*/";
+    static const char iter_cookie[]      = "/*ITER*/";
     static const char forelem_cookie[]   = "/*FORELEM*/";
     static const char with_cookie[]      = "/*WITH*/";
     static const char dot_format[]       = "%s.%s";
     static const char index_format[]     = "%s[%s]";
     static const char predot_format[]    = "%s%s.%s";
     static const char postdot_format[]   = "%s.%s%s";
     static const char preindex_format[]  = "%s%s[%s]";
     static const char postindex_format[] = "%s[%s]%s";
@@ -1755,16 +1759,17 @@ Decompile(SprintStack *ss, jsbytecode *p
     JS_STATIC_ASSERT(ARGNO_LEN == SLOTNO_LEN);
 
 /*
  * Local macros
  */
 #define LOCAL_ASSERT(expr)    LOCAL_ASSERT_RV(expr, NULL)
 #define DECOMPILE_CODE(pc,nb) if (!Decompile(ss, pc, nb, JSOP_NOP)) return NULL
 #define NEXT_OP(pc)           (((pc) + (len) == endpc) ? nextop : pc[len])
+#define TOP_STR()             GetStr(ss, ss->top - 1)
 #define POP_STR()             PopStr(ss, op)
 #define POP_STR_PREC(prec)    PopStrPrec(ss, prec)
 
 /*
  * Pop a condition expression for if/for/while. JSOP_IFEQ's precedence forces
  * extra parens around assignment, which avoids a strict-mode warning.
  */
 #define POP_COND_STR()                                                        \
@@ -2080,59 +2085,73 @@ Decompile(SprintStack *ss, jsbytecode *p
                     len = js_CodeSpec[*pc].length;
                     todo = -2;
                     break;
 
                   case SRC_FOR:
                     rval = "";
 
                   do_forloop:
+                    JS_ASSERT(SN_TYPE(sn) == SRC_FOR);
+
                     /* Skip the JSOP_NOP or JSOP_POP bytecode. */
-                    pc++;
+                    pc += JSOP_NOP_LENGTH;
 
                     /* Get the cond, next, and loop-closing tail offsets. */
                     cond = js_GetSrcNoteOffset(sn, 0);
                     next = js_GetSrcNoteOffset(sn, 1);
                     tail = js_GetSrcNoteOffset(sn, 2);
 
                     /*
                      * If this loop has a condition, then pc points at a goto
                      * targeting the condition.
                      */
+                    pc2 = pc;
                     if (cond != tail) {
                         LOCAL_ASSERT(*pc == JSOP_GOTO || *pc == JSOP_GOTOX);
-                        pc += (*pc == JSOP_GOTO)
-                              ? JSOP_GOTO_LENGTH
-                              : JSOP_GOTOX_LENGTH;
-                    }
-                    LOCAL_ASSERT(tail == -GetJumpOffset(pc+tail, pc+tail));
+                        pc2 += (*pc == JSOP_GOTO) ? JSOP_GOTO_LENGTH : JSOP_GOTOX_LENGTH;
+                    }
+                    LOCAL_ASSERT(tail + GetJumpOffset(pc+tail, pc+tail) == pc2 - pc);
 
                     /* Print the keyword and the possibly empty init-part. */
                     js_printf(jp, "\tfor (%s;", rval);
 
                     if (cond != tail) {
                         /* Decompile the loop condition. */
                         DECOMPILE_CODE(pc + cond, tail - cond);
                         js_printf(jp, " %s", POP_STR());
                     }
 
                     /* Need a semicolon whether or not there was a cond. */
                     js_puts(jp, ";");
 
                     if (next != cond) {
-                        /* Decompile the loop updater. */
-                        DECOMPILE_CODE(pc + next,
-                                       cond - next - JSOP_POP_LENGTH);
-                        js_printf(jp, " %s", POP_STR());
+                        /*
+                         * Decompile the loop updater. It may end in a JSOP_POP
+                         * that we skip; or in a JSOP_POPN that we do not skip,
+                         * followed by a JSOP_NOP (skipped as if it's a POP).
+                         * We cope with the difference between these two cases
+                         * by checking for stack imbalance and popping if there
+                         * is an rval.
+                         */
+                        uintN saveTop = ss->top;
+
+                        DECOMPILE_CODE(pc + next, cond - next - JSOP_POP_LENGTH);
+                        LOCAL_ASSERT(ss->top - saveTop <= 1U);
+                        rval = (ss->top == saveTop)
+                               ? ss->sprinter.base + ss->sprinter.offset
+                               : POP_STR();
+                        js_printf(jp, " %s", rval);
                     }
 
                     /* Do the loop body. */
                     js_printf(jp, ") {\n");
                     jp->indent += 4;
-                    DECOMPILE_CODE(pc, next);
+                    next -= pc2 - pc;
+                    DECOMPILE_CODE(pc2, next);
                     jp->indent -= 4;
                     js_printf(jp, "\t}\n");
 
                     /* Set len so pc skips over the entire loop. */
                     len = tail + js_CodeSpec[pc[tail]].length;
                     break;
 
                   case SRC_LABEL:
@@ -2283,93 +2302,104 @@ Decompile(SprintStack *ss, jsbytecode *p
                                    ? ", " : rval) < 0) {
                             return NULL;
                         }
                     }
                     if (SprintPut(&ss->sprinter, "]", 1) < 0)
                         return NULL;
 
                     /*
-                     * Kill newtop before the end_groupassignment: label by
-                     * retracting/popping early.  Control will either jump to
-                     * do_forloop: or do_letheadbody: or else break from our
-                     * case JSOP_POPN: after the switch (*pc2) below.
-                     */
-                    if (newtop < oldtop) {
+                     * If this is an empty group assignment, we have no stack
+                     * budget into which we can push our result string. Adjust
+                     * ss->sprinter.offset so that our consumer can find the
+                     * empty group assignment decompilation.
+                     */
+                    if (newtop == oldtop) {
+                        ss->sprinter.offset = todo;
+                    } else {
+                        /*
+                         * Kill newtop before the end_groupassignment: label by
+                         * retracting/popping early.  Control will either jump
+                         * to do_forloop: or do_letheadbody: or else break from
+                         * our case JSOP_POPN: after the switch (*pc2) below.
+                         */
+                        LOCAL_ASSERT(newtop < oldtop);
                         ss->sprinter.offset = GetOff(ss, newtop);
                         ss->top = newtop;
                     }
 
                   end_groupassignment:
+                    LOCAL_ASSERT(*pc == JSOP_POPN);
+
                     /*
                      * Thread directly to the next opcode if we can, to handle
                      * the special cases of a group assignment in the first or
                      * last part of a for(;;) loop head, or in a let block or
                      * expression head.
                      *
                      * NB: todo at this point indexes space in ss->sprinter
                      * that is liable to be overwritten.  The code below knows
                      * exactly how long rval lives, or else copies it down via
                      * SprintCString.
                      */
                     rval = OFF2STR(&ss->sprinter, todo);
                     todo = -2;
                     pc2 = pc + oplen;
-                    switch (*pc2) {
-                      case JSOP_NOP:
-                        /* First part of for(;;) or let block/expr head. */
+                    if (*pc2 == JSOP_NOP) {
                         sn = js_GetSrcNote(jp->script, pc2);
                         if (sn) {
                             if (SN_TYPE(sn) == SRC_FOR) {
+                                op = JSOP_NOP;
                                 pc = pc2;
                                 goto do_forloop;
                             }
+
                             if (SN_TYPE(sn) == SRC_DECL) {
                                 if (ss->top == StackDepth(jp->script)) {
                                     /*
                                      * This must be an empty destructuring
                                      * in the head of a let whose body block
                                      * is also empty.
                                      */
-                                    pc = pc2 + 1;
+                                    pc = pc2 + JSOP_NOP_LENGTH;
                                     len = js_GetSrcNoteOffset(sn, 0);
                                     LOCAL_ASSERT(pc[len] == JSOP_LEAVEBLOCK);
                                     js_printf(jp, "\tlet (%s) {\n", rval);
                                     js_printf(jp, "\t}\n");
-                                    goto end_popn;
+                                    break;
                                 }
                                 todo = SprintCString(&ss->sprinter, rval);
                                 if (todo < 0 || !PushOff(ss, todo, JSOP_NOP))
                                     return NULL;
                                 op = JSOP_POP;
-                                pc = pc2 + 1;
+                                pc = pc2 + JSOP_NOP_LENGTH;
                                 goto do_letheadbody;
                             }
-                        }
-                        break;
-
-                      case JSOP_GOTO:
-                      case JSOP_GOTOX:
-                        /* Third part of for(;;) loop head. */
-                        cond = GetJumpOffset(pc2, pc2);
-                        sn = js_GetSrcNote(jp->script, pc2 + cond - 1);
-                        if (sn && SN_TYPE(sn) == SRC_FOR) {
+                        } else {
+                            /*
+                             * An unnannotated NOP following a POPN must be the
+                             * third part of for(;;) loop head. If the POPN's
+                             * immediate operand is 0, then we may have no slot
+                             * on the sprint-stack in which to push our result
+                             * string. In this case the result can be recovered
+                             * at ss->sprinter.base + ss->sprinter.offset.
+                             */
+                            if (GET_UINT16(pc) == 0)
+                                break;
                             todo = SprintCString(&ss->sprinter, rval);
                             saveop = JSOP_NOP;
                         }
-                        break;
                     }
 
                     /*
                      * If control flow reaches this point with todo still -2,
                      * just print rval as an expression statement.
                      */
                     if (todo == -2)
                         js_printf(jp, "\t%s;\n", rval);
-                  end_popn:
                     break;
                 }
 #endif
                 if (newtop < oldtop) {
                     ss->sprinter.offset = GetOff(ss, newtop);
                     ss->top = newtop;
                 }
                 break;
@@ -2446,27 +2476,27 @@ Decompile(SprintStack *ss, jsbytecode *p
                         jp->indent += 4;
                         DECOMPILE_CODE(pc, len);
                         jp->indent -= 4;
                         js_printf(jp, "\t}\n");
                         todo = -2;
                     } else {
                         LOCAL_ASSERT(pc[len] == JSOP_LEAVEBLOCKEXPR);
 
-                        lval = JS_strdup(cx, POP_STR());
+                        lval = JS_strdup(cx, PopStr(ss, JSOP_NOP));
                         if (!lval)
                             return NULL;
 
                         /* Set saveop to reflect what we will push. */
                         saveop = JSOP_LEAVEBLOCKEXPR;
                         if (!Decompile(ss, pc, len, saveop)) {
                             JS_free(cx, (char *)lval);
                             return NULL;
                         }
-                        rval = POP_STR();
+                        rval = PopStr(ss, JSOP_SETNAME);
                         todo = Sprint(&ss->sprinter,
                                       (*rval == '{')
                                       ? "let (%s) (%s)"
                                       : "let (%s) %s",
                                       lval, rval);
                         JS_free(cx, (char *)lval);
                     }
                     break;
@@ -2495,24 +2525,16 @@ Decompile(SprintStack *ss, jsbytecode *p
                     } else {
                         LOCAL_ASSERT(*rval == '\0' ||
                                      strcmp(rval, exception_cookie) == 0);
                     }
                     todo = -2;
                     break;
                 }
                 sn = NULL;
-                break;
-
-              case JSOP_ENDITER:
-                sn = js_GetSrcNote(jp->script, pc);
-                todo = -2;
-                if (sn && SN_TYPE(sn) == SRC_HIDDEN)
-                    break;
-                (void) PopOff(ss, op);
                 break;
 
               case JSOP_ENTERWITH:
                 LOCAL_ASSERT(!js_GetSrcNote(jp->script, pc));
                 rval = POP_STR();
                 js_printf(jp, "\twith (%s) {\n", rval);
                 jp->indent += 4;
                 todo = Sprint(&ss->sprinter, with_cookie);
@@ -2718,42 +2740,49 @@ Decompile(SprintStack *ss, jsbytecode *p
                 ss->sprinter.offset = GetOff(ss, top);
                 if (op == JSOP_LEAVEBLOCKEXPR)
                     todo = SprintCString(&ss->sprinter, rval);
                 break;
               }
 
               case JSOP_CALLUPVAR:
               case JSOP_GETUPVAR:
+
+                if (!jp->fun)
+                    JS_GET_SCRIPT_FUNCTION(jp->script, 0, jp->fun);
+
+                if (!jp->localNames)
+                    jp->localNames = js_GetLocalNameArray(cx, jp->fun, &jp->pool);
+
                 i = JS_UPVAR_LOCAL_NAME_START(jp->fun) + GET_UINT16(pc);
                 if (i >= JS_GET_LOCAL_NAME_COUNT(jp->fun)) {
-                    JSStackFrame *fp;
                     JSUpvarArray *uva;
-
+#ifdef DEBUG
                     /*
                      * We must be in an eval called from jp->fun, where
                      * jp->script is the eval-compiled script.
                      *
                      * However, it's possible that a js_Invoke already
                      * pushed a frame trying to call js_Construct on an
                      * object that's not a constructor, causing us to be
                      * called with an intervening frame on the stack.
                      */
-                    fp = cx->fp;
-                    while (!(fp->flags & JSFRAME_EVAL))
-                        fp = fp->down;
-                    JS_ASSERT(fp->script == jp->script);
-                    JS_ASSERT(fp->down->fun == jp->fun);
-                    JS_ASSERT(FUN_INTERPRETED(jp->fun));
-                    JS_ASSERT(jp->script != jp->fun->u.i.script);
-                    JS_ASSERT(jp->script->upvarsOffset != 0);
-
+                    JSStackFrame *fp = cx->fp;
+                    if (fp) {
+                        while (!(fp->flags & JSFRAME_EVAL))
+                            fp = fp->down;
+                        JS_ASSERT(fp->script == jp->script);
+                        JS_ASSERT(fp->down->fun == jp->fun);
+                        JS_ASSERT(FUN_INTERPRETED(jp->fun));
+                        JS_ASSERT(jp->script != jp->fun->u.i.script);
+                        JS_ASSERT(jp->script->upvarsOffset != 0);
+                    }
+#endif
                     uva = JS_SCRIPT_UPVARS(jp->script);
                     i = GET_UINT16(pc);
-                    JS_ASSERT(UPVAR_FRAME_SKIP(uva->vector[i]) == 1);
                     i = UPVAR_FRAME_SLOT(uva->vector[i]);
                 }
                 atom = GetArgOrVarAtom(jp, i);
                 goto do_name;
 
               case JSOP_CALLLOCAL:
               case JSOP_GETLOCAL:
                 if (IsVarSlot(jp, pc, &i)) {
@@ -2878,27 +2907,27 @@ Decompile(SprintStack *ss, jsbytecode *p
                 /*
                  * Skip the for loop head stacked by JSOP_FORLOCAL until we hit
                  * a block local slot (note empty destructuring patterns result
                  * in unit-count blocks).
                  */
                 pos = ss->top;
                 while (pos != 0) {
                     op = (JSOp) ss->opcodes[--pos];
-                    if (op != JSOP_FORLOCAL)
+                    if (op == JSOP_ENTERBLOCK)
                         break;
                 }
                 JS_ASSERT(op == JSOP_ENTERBLOCK);
 
                 /*
                  * Here, forpos must index the space before the left-most |for|
                  * in the single string of accumulated |for| heads and optional
                  * final |if (condition)|.
                  */
-                forpos = pos + 1;
+                forpos = pos + 2;
                 LOCAL_ASSERT(forpos < ss->top);
 
                 /*
                  * Now move pos downward over the block's local slots. Even an
                  * empty destructuring pattern has one (dummy) local.
                  */
                 while (ss->opcodes[pos] == JSOP_ENTERBLOCK) {
                     if (pos == 0)
@@ -2960,66 +2989,87 @@ Decompile(SprintStack *ss, jsbytecode *p
                 sn = js_GetSrcNote(jp->script, pc);
                 todo = -2;
                 if (sn && SN_TYPE(sn) == SRC_HIDDEN)
                     break;
                 rval = POP_STR();
                 js_printf(jp, "\t%s %s;\n", js_throw_str, rval);
                 break;
 
+              case JSOP_ITER:
+                foreach = (pc[1] & (JSITER_FOREACH | JSITER_KEYVALUE)) ==
+                          JSITER_FOREACH;
+                todo = SprintCString(&ss->sprinter, iter_cookie);
+                break;
+
+              case JSOP_NEXTITER:
+                JS_NOT_REACHED("JSOP_NEXTITER");
+                break;
+
+              case JSOP_ENDITER:
+                sn = js_GetSrcNote(jp->script, pc);
+                todo = -2;
+                if (sn && SN_TYPE(sn) == SRC_HIDDEN)
+                    break;
+                (void) PopOff(ss, op);
+                (void) PopOff(ss, op);
+                break;
+
               case JSOP_GOTO:
               case JSOP_GOTOX:
                 sn = js_GetSrcNote(jp->script, pc);
                 switch (sn ? SN_TYPE(sn) : SRC_NULL) {
                   case SRC_FOR_IN:
                     /*
                      * The loop back-edge carries +1 stack balance, for the
                      * flag processed by JSOP_IFNE. We do not decompile the
-                     * JSOP_IFNE, and instead pass the left-hand side of 'in'
-                     * along the loop edge in this pushed stack slot.
+                     * JSOP_IFNE, and instead push the left-hand side of 'in'
+                     * after the loop edge in this stack slot (the JSOP_FOR*
+                     * opcodes' decompilers do this pushing).
                      */
                     cond = GetJumpOffset(pc, pc);
                     next = js_GetSrcNoteOffset(sn, 0);
                     tail = js_GetSrcNoteOffset(sn, 1);
-                    DECOMPILE_CODE(pc + cond, tail - cond);
+                    JS_ASSERT(pc[cond] == JSOP_NEXTITER);
                     DECOMPILE_CODE(pc + oplen, next - oplen);
+                    lval = POP_STR();
                     if (ss->inArrayInit || ss->inGenExp) {
-                        lval = POP_STR();
-                        rval = POP_STR();
-                        if (ss->opcodes[ss->top - 1] == JSOP_FORLOCAL) {
-                            ss->sprinter.offset -= PAREN_SLOP;
+                        (void) PopOff(ss, JSOP_NOP);
+                        rval = TOP_STR();
+                        LOCAL_ASSERT(ss->top >= 2);
+                        if (ss->opcodes[ss->top - 2] == JSOP_FORLOCAL) {
+                            ss->sprinter.offset = ss->offsets[ss->top - 1] - PAREN_SLOP;
                             if (Sprint(&ss->sprinter, " %s (%s in %s)",
                                        foreach ? js_for_each_str : js_for_str,
                                        lval, rval) < 0) {
                                 return NULL;
                             }
                             
                             /*
                              * Do not AddParentSlop here, as we will push the
                              * top-most offset again, which will add paren slop
                              * for us. We must push to balance the stack budget
                              * when nesting for heads in a comprehension.
                              */
                             todo = ss->offsets[ss->top - 1];
                         } else {
-                            LOCAL_ASSERT(ss->opcodes[ss->top - 1] == JSOP_ENTERBLOCK);
+                            LOCAL_ASSERT(ss->opcodes[ss->top - 2] == JSOP_ENTERBLOCK);
                             todo = Sprint(&ss->sprinter, " %s (%s in %s)",
                                           foreach ? js_for_each_str : js_for_str,
                                           lval, rval);
                         }
                         if (todo < 0 || !PushOff(ss, todo, JSOP_FORLOCAL))
                             return NULL;
                         DECOMPILE_CODE(pc + next, cond - next);
                     } else {
                         /*
                          * As above, rval or an extension of it must remain
                          * stacked during loop body decompilation.
                          */
-                        lval = POP_STR();
-                        rval = GetStr(ss, ss->top - 1);
+                        rval = GetStr(ss, ss->top - 2);
                         js_printf(jp, "\t%s (%s in %s) {\n",
                                   foreach ? js_for_each_str : js_for_str,
                                   lval, rval);
                         jp->indent += 4;
                         DECOMPILE_CODE(pc + next, cond - next);
                         jp->indent -= 4;
                         js_printf(jp, "\t}\n");
                     }
@@ -3217,17 +3267,16 @@ Decompile(SprintStack *ss, jsbytecode *p
                 xval = "&&";
                 goto do_logical_connective;
 
               case JSOP_FORARG:
                 sn = NULL;
                 i = GET_ARGNO(pc);
                 goto do_forvarslot;
 
-              case JSOP_FORCONST:
               case JSOP_FORLOCAL:
                 sn = js_GetSrcNote(jp->script, pc);
                 if (!IsVarSlot(jp, pc, &i)) {
                     JS_ASSERT(op == JSOP_FORLOCAL);
                     todo = Sprint(&ss->sprinter, ss_format, VarPrefix(sn), GetStr(ss, i));
                     break;
                 }
 
@@ -3265,17 +3314,16 @@ Decompile(SprintStack *ss, jsbytecode *p
                     if (todo < 0)
                         return NULL;
                     if (!QuoteString(&ss->sprinter, ATOM_TO_STRING(atom), 0))
                         return NULL;
                 }
                 break;
 
               case JSOP_FORELEM:
-                LOCAL_ASSERT(pc[1] == JSOP_IFNE || pc[1] == JSOP_IFNEX);
                 todo = SprintCString(&ss->sprinter, forelem_cookie);
                 break;
 
               case JSOP_ENUMELEM:
               case JSOP_ENUMCONSTELEM:
                 /*
                  * The stack has the object under the (top) index expression.
                  * The "rval" property id is underneath those two on the stack.
@@ -3393,16 +3441,17 @@ Decompile(SprintStack *ss, jsbytecode *p
                     js_printf(jp, "\t%s;\n", rval);
                     todo = -2;
                 }
                 break;
 
               case JSOP_NEW:
               case JSOP_CALL:
               case JSOP_EVAL:
+              case JSOP_APPLY:
 #if JS_HAS_LVALUE_RETURN
               case JSOP_SETCALL:
 #endif
                 /* Turn off most parens (all if there's only one argument). */
                 argc = GET_ARGC(pc);
                 op = (argc == 1) ? JSOP_NOP : JSOP_SETNAME;
                 argv = (char **)
                     JS_malloc(cx, (size_t)(argc + 1) * sizeof *argv);
@@ -3423,17 +3472,19 @@ Decompile(SprintStack *ss, jsbytecode *p
                 /*
                  * Special case: new (x(y)(z)) must be parenthesized like so.
                  * Same for new (x(y).z) -- contrast with new x(y).z.
                  * See PROPAGATE_CALLNESS.
                  */
                 op = (JSOp) ss->opcodes[ss->top-1];
                 lval = PopStr(ss,
                               (saveop == JSOP_NEW &&
-                               (op == JSOP_CALL || op == JSOP_EVAL ||
+                               (op == JSOP_CALL || 
+                                op == JSOP_EVAL ||
+                                op == JSOP_APPLY ||
                                 (js_CodeSpec[op].format & JOF_CALLOP)))
                               ? JSOP_NAME
                               : saveop);
                 op = saveop;
 
                 argv[0] = JS_strdup(cx, lval);
                 if (!argv[i])
                     ok = JS_FALSE;
@@ -4315,24 +4366,20 @@ Decompile(SprintStack *ss, jsbytecode *p
                 break;
               }
 
               {
                 JSBool isFirst;
                 const char *maybeComma;
 
               case JSOP_INITELEM:
-                /* Turn off most parens (all if there's only one initialiser). */
-                LOCAL_ASSERT(pc + len < endpc);
                 isFirst = (ss->opcodes[ss->top - 3] == JSOP_NEWINIT);
-                op = (isFirst &&
-                      GetStr(ss, ss->top - 2)[0] == '0' &&
-                      (JSOp) pc[len] == JSOP_ENDINIT)
-                     ? JSOP_NOP
-                     : JSOP_SETNAME;
+
+                /* Turn off most parens. */
+                op = JSOP_SETNAME;
                 rval = POP_STR();
 
                 /* Turn off all parens for xval and lval, which we control. */
                 op = JSOP_NOP;
                 xval = POP_STR();
                 lval = POP_STR();
                 sn = js_GetSrcNote(jp->script, pc);
 
@@ -4531,22 +4578,16 @@ Decompile(SprintStack *ss, jsbytecode *p
                 break;
 
               case JSOP_TOXMLLIST:
                 op = JSOP_NOP;           /* turn off parens */
                 todo = Sprint(&ss->sprinter, "<>%s</>", POP_STR());
                 inXML = JS_FALSE;
                 break;
 
-              case JSOP_ITER:
-                foreach = (pc[1] & (JSITER_FOREACH | JSITER_KEYVALUE)) ==
-                          JSITER_FOREACH;
-                todo = -2;
-                break;
-
               case JSOP_TOXML:
               case JSOP_CALLXMLNAME:
               case JSOP_XMLNAME:
               case JSOP_FILTER:
                 /* These ops indicate the end of XML expressions. */
                 inXML = JS_FALSE;
                 todo = -2;
                 break;
@@ -4634,17 +4675,19 @@ Decompile(SprintStack *ss, jsbytecode *p
     }
 
 /*
  * Undefine local macros.
  */
 #undef inXML
 #undef DECOMPILE_CODE
 #undef NEXT_OP
+#undef TOP_STR
 #undef POP_STR
+#undef POP_STR_PREC
 #undef LOCAL_ASSERT
 #undef ATOM_IS_IDENTIFIER
 #undef GET_QUOTE_AND_FMT
 #undef GET_ATOM_QUOTE_AND_FMT
 
     return pc;
 }
 
diff -r a4343d61f6ee js/src/jsopcode.h
--- a/js/src/jsopcode.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsopcode.h	Sat Nov 15 19:43:13 2008 -0500
@@ -92,17 +92,17 @@ typedef enum JSOp {
 #define JOF_VARPROP       (5U<<5) /* x.prop for this, arg, var, or local x */
 #define JOF_MODEMASK      (7U<<5) /* mask for above addressing modes */
 #define JOF_SET           (1U<<8) /* set (i.e., assignment) operation */
 #define JOF_DEL           (1U<<9) /* delete operation */
 #define JOF_DEC          (1U<<10) /* decrement (--, not ++) opcode */
 #define JOF_INC          (2U<<10) /* increment (++, not --) opcode */
 #define JOF_INCDEC       (3U<<10) /* increment or decrement opcode */
 #define JOF_POST         (1U<<12) /* postorder increment or decrement */
-#define JOF_FOR          (1U<<13) /* for-in property op */
+#define JOF_FOR          (1U<<13) /* for-in property op (akin to JOF_SET) */
 #define JOF_ASSIGNING     JOF_SET /* hint for JSClass.resolve, used for ops
                                      that do simplex assignment */
 #define JOF_DETECTING    (1U<<14) /* object detection for JSNewResolveOp */
 #define JOF_BACKPATCH    (1U<<15) /* backpatch placeholder during codegen */
 #define JOF_LEFTASSOC    (1U<<16) /* left-associative operator */
 #define JOF_DECLARING    (1U<<17) /* var, const, or function declaration op */
 #define JOF_INDEXBASE    (1U<<18) /* atom segment base setting prefix op */
 #define JOF_CALLOP       (1U<<19) /* call operation that pushes function and
@@ -112,18 +112,16 @@ typedef enum JSOp {
 #define JOF_INVOKE       (1U<<21) /* JSOP_CALL, JSOP_NEW, JSOP_EVAL */
 #define JOF_TMPSLOT      (1U<<22) /* interpreter uses extra temporary slot
                                      to root intermediate objects besides
                                      the slots opcode uses */
 #define JOF_TMPSLOT2     (2U<<22) /* interpreter uses extra 2 temporary slot
                                      besides the slots opcode uses */
 #define JOF_TMPSLOT_SHIFT 22
 #define JOF_TMPSLOT_MASK  (JS_BITMASK(2) << JOF_TMPSLOT_SHIFT)
-
-#define JOF_RETVAL       (1U<<24) /* op leaves jsval return value on stack */
 
 /* Shorthands for type from format and type from opcode. */
 #define JOF_TYPE(fmt)   ((fmt) & JOF_TYPEMASK)
 #define JOF_OPTYPE(op)  JOF_TYPE(js_CodeSpec[op].format)
 
 /* Shorthands for mode from format and mode from opcode. */
 #define JOF_MODE(fmt)   ((fmt) & JOF_MODEMASK)
 #define JOF_OPMODE(op)  JOF_MODE(js_CodeSpec[op].format)
diff -r a4343d61f6ee js/src/jsopcode.tbl
--- a/js/src/jsopcode.tbl	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsopcode.tbl	Sat Nov 15 19:43:13 2008 -0500
@@ -59,41 +59,50 @@
  * image        C string containing "image" for pretty-printer, null if ugly
  * length       Number of bytes including any immediate operands
  * nuses        Number of stack slots consumed by bytecode, -1 if variadic
  * ndefs        Number of stack slots produced by bytecode, -1 if variadic
  * prec         Operator precedence, zero if not an operator
  * format       Bytecode plus immediate operand encoding format
  *
  * Precedence   Operators               Opcodes
- *  1           let (x = y) z, yield w  JSOP_LEAVEBLOCKEXPR, JSOP_YIELD
+ *  1           yield w                 JSOP_YIELD
  *  2           ,                       JSOP_POP with SRC_PCDELTA, JSOP_RETURN
- *  3           =, +=, etc.             JSOP_SETNAME, etc. (all JOF_SET)
+ *  3           =, +=, etc.             JSOP_SETNAME, etc. (all JOF_SET);
+ *                let (...) ...           and JSOP_LEAVEBLOCKEXPR
  *  4           ?:                      JSOP_IFEQ, JSOP_IFEQX
  *  5           ||                      JSOP_OR, JSOP_ORX
  *  6           &&                      JSOP_AND, JSOP_ANDX
  *  7           |                       JSOP_BITOR
  *  8           ^                       JSOP_BITXOR
  *  9           &                       JSOP_BITAND
  * 10           ==, !=, etc.            JSOP_EQ, JSOP_NE, etc.
  * 11           <, in, etc.             JSOP_LT, JSOP_IN, etc.
  * 12           <<, >>, >>>             JSOP_LSH, JSOP_RSH, JSOP_URSH
  * 13           +, -, etc.              JSOP_ADD, JSOP_SUB, etc.
  * 14           *, /, %                 JSOP_MUL, JSOP_DIV, JSOP_MOD
  * 15           !, ~, delete, etc.      JSOP_NOT, JSOP_BITNOT, JSOP_DEL*, etc.
  * 16           3.14, 0, etc.           JSOP_DOUBLE, JSOP_ZERO, etc.
  * 17           new                     JSOP_NEW
  * 18           x.y, f(), etc.          JSOP_GETPROP, JSOP_CALL, etc.
- * 19           x, null, etc.           JSOP_NAME, JSOP_NULL, etc.
+ * 19           x, null,                JSOP_NAME, JSOP_NULL, etc.;
+ *               function (...) ...       and JSOP_ANONFUNOBJ, JSOP_NAMEDFUNOBJ
  *
  * The push-numeric-constant operators, JSOP_ZERO, JSOP_DOUBLE, etc., have
  * lower precedence than the member operators emitted for the . operator, to
  * cause the decompiler to parenthesize the . left operand, e.g. (0).foo.
- * Otherwise the . could be taken as a decimal point.  We use the same level
- * 16 for function expressions too, to force parenthesization.
+ * Otherwise the . could be taken as a decimal point.
+ *
+ * Let expressions are "primary" when viewed from the left, but they eat up ops
+ * to the right as if assignment expressions and therefore have precedence 3.
+ * This makes the decompiler retain the parentheses in (let (a=0) x) ? a : 0
+ * but omit the superfluous ones in (let (a=0) x), a.
+ *
+ * Yield expressions must be parenthesized even in comma-expressions and
+ * argument lists, so they have the lowest precedence.
  *
  * This file is best viewed with 128 columns:
 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678
  */
 
 /* legend: op         val name          image       len use def prec  format */
 
 /* Longstanding JavaScript bytecodes. */
@@ -106,40 +115,40 @@ OPDEF(JSOP_GOTO,      6,  "goto",       
 OPDEF(JSOP_GOTO,      6,  "goto",       NULL,         3,  0,  0,  0,  JOF_JUMP)
 OPDEF(JSOP_IFEQ,      7,  "ifeq",       NULL,         3,  1,  0,  4,  JOF_JUMP|JOF_DETECTING)
 OPDEF(JSOP_IFNE,      8,  "ifne",       NULL,         3,  1,  0,  0,  JOF_JUMP|JOF_PARENHEAD)
 
 /* Get the arguments object for the current, lightweight function activation. */
 OPDEF(JSOP_ARGUMENTS, 9, js_arguments_str, js_arguments_str, 1, 0, 1, 18, JOF_BYTE)
 
 /* ECMA-compliant for-in loop with argument or local loop control. */
-OPDEF(JSOP_FORARG,    10, "forarg",     NULL,         3,  0,  1, 19,  JOF_QARG|JOF_NAME|JOF_FOR)
-OPDEF(JSOP_FORLOCAL,  11, "forlocal",   NULL,         3,  0,  1, 19,  JOF_LOCAL|JOF_NAME|JOF_FOR)
+OPDEF(JSOP_FORARG,    10, "forarg",     NULL,         3,  2,  2, 19,  JOF_QARG|JOF_NAME|JOF_FOR)
+OPDEF(JSOP_FORLOCAL,  11, "forlocal",   NULL,         3,  2,  2, 19,  JOF_LOCAL|JOF_NAME|JOF_FOR)
 
 /* More longstanding bytecodes. */
 OPDEF(JSOP_DUP,       12, "dup",        NULL,         1,  1,  2,  0,  JOF_BYTE)
 OPDEF(JSOP_DUP2,      13, "dup2",       NULL,         1,  2,  4,  0,  JOF_BYTE)
 OPDEF(JSOP_SETCONST,  14, "setconst",   NULL,         3,  1,  1,  3,  JOF_ATOM|JOF_NAME|JOF_SET)
-OPDEF(JSOP_BITOR,     15, "bitor",      "|",          1,  2,  1,  7,  JOF_BYTE|JOF_LEFTASSOC)
-OPDEF(JSOP_BITXOR,    16, "bitxor",     "^",          1,  2,  1,  8,  JOF_BYTE|JOF_LEFTASSOC)
-OPDEF(JSOP_BITAND,    17, "bitand",     "&",          1,  2,  1,  9,  JOF_BYTE|JOF_LEFTASSOC)
+OPDEF(JSOP_BITOR,     15, "bitor",      "|",          1,  2,  1,  7,  JOF_BYTE|JOF_LEFTASSOC|JOF_TMPSLOT2)
+OPDEF(JSOP_BITXOR,    16, "bitxor",     "^",          1,  2,  1,  8,  JOF_BYTE|JOF_LEFTASSOC|JOF_TMPSLOT2)
+OPDEF(JSOP_BITAND,    17, "bitand",     "&",          1,  2,  1,  9,  JOF_BYTE|JOF_LEFTASSOC|JOF_TMPSLOT2)
 OPDEF(JSOP_EQ,        18, "eq",         "==",         1,  2,  1,  10,  JOF_BYTE|JOF_LEFTASSOC|JOF_DETECTING)
 OPDEF(JSOP_NE,        19, "ne",         "!=",         1,  2,  1,  10,  JOF_BYTE|JOF_LEFTASSOC|JOF_DETECTING)
 OPDEF(JSOP_LT,        20, "lt",         "<",          1,  2,  1, 11,  JOF_BYTE|JOF_LEFTASSOC)
 OPDEF(JSOP_LE,        21, "le",         "<=",         1,  2,  1, 11,  JOF_BYTE|JOF_LEFTASSOC)
 OPDEF(JSOP_GT,        22, "gt",         ">",          1,  2,  1, 11,  JOF_BYTE|JOF_LEFTASSOC)
 OPDEF(JSOP_GE,        23, "ge",         ">=",         1,  2,  1, 11,  JOF_BYTE|JOF_LEFTASSOC)
-OPDEF(JSOP_LSH,       24, "lsh",        "<<",         1,  2,  1, 12,  JOF_BYTE|JOF_LEFTASSOC)
-OPDEF(JSOP_RSH,       25, "rsh",        ">>",         1,  2,  1, 12,  JOF_BYTE|JOF_LEFTASSOC)
-OPDEF(JSOP_URSH,      26, "ursh",       ">>>",        1,  2,  1, 12,  JOF_BYTE|JOF_LEFTASSOC)
-OPDEF(JSOP_ADD,       27, "add",        "+",          1,  2,  1, 13,  JOF_BYTE|JOF_LEFTASSOC)
-OPDEF(JSOP_SUB,       28, "sub",        "-",          1,  2,  1, 13,  JOF_BYTE|JOF_LEFTASSOC)
-OPDEF(JSOP_MUL,       29, "mul",        "*",          1,  2,  1, 14,  JOF_BYTE|JOF_LEFTASSOC)
-OPDEF(JSOP_DIV,       30, "div",        "/",          1,  2,  1, 14,  JOF_BYTE|JOF_LEFTASSOC)
-OPDEF(JSOP_MOD,       31, "mod",        "%",          1,  2,  1, 14,  JOF_BYTE|JOF_LEFTASSOC)
+OPDEF(JSOP_LSH,       24, "lsh",        "<<",         1,  2,  1, 12,  JOF_BYTE|JOF_LEFTASSOC|JOF_TMPSLOT2)
+OPDEF(JSOP_RSH,       25, "rsh",        ">>",         1,  2,  1, 12,  JOF_BYTE|JOF_LEFTASSOC|JOF_TMPSLOT2)
+OPDEF(JSOP_URSH,      26, "ursh",       ">>>",        1,  2,  1, 12,  JOF_BYTE|JOF_LEFTASSOC|JOF_TMPSLOT2)
+OPDEF(JSOP_ADD,       27, "add",        "+",          1,  2,  1, 13,  JOF_BYTE|JOF_LEFTASSOC|JOF_TMPSLOT2)
+OPDEF(JSOP_SUB,       28, "sub",        "-",          1,  2,  1, 13,  JOF_BYTE|JOF_LEFTASSOC|JOF_TMPSLOT2)
+OPDEF(JSOP_MUL,       29, "mul",        "*",          1,  2,  1, 14,  JOF_BYTE|JOF_LEFTASSOC|JOF_TMPSLOT2)
+OPDEF(JSOP_DIV,       30, "div",        "/",          1,  2,  1, 14,  JOF_BYTE|JOF_LEFTASSOC|JOF_TMPSLOT2)
+OPDEF(JSOP_MOD,       31, "mod",        "%",          1,  2,  1, 14,  JOF_BYTE|JOF_LEFTASSOC|JOF_TMPSLOT2)
 OPDEF(JSOP_NOT,       32, "not",        "!",          1,  1,  1, 15,  JOF_BYTE|JOF_DETECTING)
 OPDEF(JSOP_BITNOT,    33, "bitnot",     "~",          1,  1,  1, 15,  JOF_BYTE)
 OPDEF(JSOP_NEG,       34, "neg",        "- ",         1,  1,  1, 15,  JOF_BYTE)
 OPDEF(JSOP_NEW,       35, js_new_str,   NULL,         3, -1,  1, 17,  JOF_UINT16|JOF_INVOKE)
 OPDEF(JSOP_DELNAME,   36, "delname",    NULL,         3,  0,  1, 15,  JOF_ATOM|JOF_NAME|JOF_DEL)
 OPDEF(JSOP_DELPROP,   37, "delprop",    NULL,         3,  1,  1, 15,  JOF_ATOM|JOF_PROP|JOF_DEL)
 OPDEF(JSOP_DELELEM,   38, "delelem",    NULL,         1,  2,  1, 15,  JOF_BYTE |JOF_ELEM|JOF_DEL)
 OPDEF(JSOP_TYPEOF,    39, js_typeof_str,NULL,         1,  1,  1, 15,  JOF_BYTE|JOF_DETECTING)
@@ -158,17 +167,17 @@ OPDEF(JSOP_PROPDEC,   51, "propdec",    
 OPDEF(JSOP_PROPDEC,   51, "propdec",    NULL,         3,  1,  1, 15,  JOF_ATOM|JOF_PROP|JOF_DEC|JOF_POST|JOF_TMPSLOT2)
 OPDEF(JSOP_ELEMDEC,   52, "elemdec",    NULL,         1,  2,  1, 15,  JOF_BYTE |JOF_ELEM|JOF_DEC|JOF_POST|JOF_TMPSLOT2)
 
 OPDEF(JSOP_GETPROP,   53, "getprop",    NULL,         3,  1,  1, 18,  JOF_ATOM|JOF_PROP)
 OPDEF(JSOP_SETPROP,   54, "setprop",    NULL,         3,  2,  1,  3,  JOF_ATOM|JOF_PROP|JOF_SET|JOF_DETECTING)
 OPDEF(JSOP_GETELEM,   55, "getelem",    NULL,         1,  2,  1, 18,  JOF_BYTE |JOF_ELEM|JOF_LEFTASSOC)
 OPDEF(JSOP_SETELEM,   56, "setelem",    NULL,         1,  3,  1,  3,  JOF_BYTE |JOF_ELEM|JOF_SET|JOF_DETECTING)
 OPDEF(JSOP_CALLNAME,  57, "callname",   NULL,         3,  0,  2, 19,  JOF_ATOM|JOF_NAME|JOF_CALLOP)
-OPDEF(JSOP_CALL,      58, "call",       NULL,         3, -1,  1, 18,  JOF_UINT16|JOF_INVOKE|JOF_RETVAL)
+OPDEF(JSOP_CALL,      58, "call",       NULL,         3, -1,  1, 18,  JOF_UINT16|JOF_INVOKE)
 OPDEF(JSOP_NAME,      59, "name",       NULL,         3,  0,  1, 19,  JOF_ATOM|JOF_NAME)
 OPDEF(JSOP_DOUBLE,    60, "double",     NULL,         3,  0,  1, 16,  JOF_ATOM)
 OPDEF(JSOP_STRING,    61, "string",     NULL,         3,  0,  1, 19,  JOF_ATOM)
 OPDEF(JSOP_ZERO,      62, "zero",       "0",          1,  0,  1, 16,  JOF_BYTE)
 OPDEF(JSOP_ONE,       63, "one",        "1",          1,  0,  1, 16,  JOF_BYTE)
 OPDEF(JSOP_NULL,      64, js_null_str,  js_null_str,  1,  0,  1, 19,  JOF_BYTE)
 OPDEF(JSOP_THIS,      65, js_this_str,  js_this_str,  1,  0,  1, 19,  JOF_BYTE)
 OPDEF(JSOP_FALSE,     66, js_false_str, js_false_str, 1,  0,  1, 19,  JOF_BYTE)
@@ -179,25 +188,37 @@ OPDEF(JSOP_AND,       69, "and",        
 /* The switch bytecodes have variable length. */
 OPDEF(JSOP_TABLESWITCH,  70, "tableswitch",  NULL,   -1,  1,  0,  0,  JOF_TABLESWITCH|JOF_DETECTING|JOF_PARENHEAD)
 OPDEF(JSOP_LOOKUPSWITCH, 71, "lookupswitch", NULL,   -1,  1,  0,  0,  JOF_LOOKUPSWITCH|JOF_DETECTING|JOF_PARENHEAD)
 
 /* New, infallible/transitive identity ops. */
 OPDEF(JSOP_STRICTEQ,  72, "stricteq",   "===",        1,  2,  1, 10,  JOF_BYTE|JOF_DETECTING|JOF_LEFTASSOC)
 OPDEF(JSOP_STRICTNE,  73, "strictne",   "!==",        1,  2,  1, 10,  JOF_BYTE|JOF_DETECTING|JOF_LEFTASSOC)
 
-OPDEF(JSOP_UNUSED74,  74, "unused74",   NULL,         1,  0,  0,  0,  JOF_BYTE)
+/* Variant of JSOP_NULL for default (global) |this| parameter pushing. */
+OPDEF(JSOP_NULLTHIS,  74, js_null_str,  js_null_str,  1,  0,  1, 19,  JOF_BYTE)
 
-/* Variant of JSOP_NULL for default (global) |this| parameter pushing. */
-OPDEF(JSOP_NULLTHIS,  75, js_null_str,  js_null_str,  1,  0,  1, 19,  JOF_BYTE)
+/*
+ * JSOP_ITER sets up a for-in or for-each-in loop using the JSITER_* flag bits
+ * in this op's uint8 immediate operand. It replaces the top of stack object
+ * with an iterator for that object, and pushes a slot used by JSOP_NEXTITER.
+ *
+ * JSOP_NEXTITER stores the next iterated value in the top of stack slot which
+ * was allocated by JSOP_ITER and pushes true, or stores JSVAL_HOLE and pushes
+ * false. It is followed immediately by JSOP_IFNE{,X}.
+ *
+ * JSOP_ENDITER cleans up after the loop. It uses the slot above the iterator
+ * for temporary GC rooting.
+ */
+OPDEF(JSOP_ITER,      75, "iter",       NULL,         2,  1,  2,  0,  JOF_UINT8)
+OPDEF(JSOP_NEXTITER,  76, "nextiter",   NULL,         1,  2,  3,  0,  JOF_BYTE)
+OPDEF(JSOP_ENDITER,   77, "enditer",    NULL,         1,  2,  0,  0,  JOF_BYTE)
 
-OPDEF(JSOP_UNUSED76,  76, "unused76",   NULL,         1,  0,  0,  0,  JOF_BYTE)
-OPDEF(JSOP_UNUSED77,  77, "unused77",   NULL,         1,  0,  0,  0,  JOF_BYTE)
-OPDEF(JSOP_UNUSED78,  78, "unused78",   NULL,         1,  0,  0,  0,  JOF_BYTE)
-OPDEF(JSOP_UNUSED79,  79, "unused79",   NULL,         1,  0,  0,  0,  JOF_BYTE)
+OPDEF(JSOP_APPLY,     78, "apply",      NULL,         3, -1,  1, 18,  JOF_UINT16|JOF_INVOKE)
+OPDEF(JSOP_SWAP,      79, "swap",       NULL,         1,  2,  2,  0,  JOF_BYTE)
 
 /* Push object literal. */
 OPDEF(JSOP_OBJECT,    80, "object",     NULL,         3,  0,  1, 19,  JOF_OBJECT)
 
 /* Pop value and discard it. */
 OPDEF(JSOP_POP,       81, "pop",        NULL,         1,  1,  0,  2,  JOF_BYTE)
 
 /* Convert value to number, for unary +. */
@@ -229,26 +250,22 @@ OPDEF(JSOP_ARGINC,    97, "arginc",     
 OPDEF(JSOP_ARGINC,    97, "arginc",     NULL,         3,  0,  1, 15,  JOF_QARG |JOF_NAME|JOF_INC|JOF_POST)
 OPDEF(JSOP_ARGDEC,    98, "argdec",     NULL,         3,  0,  1, 15,  JOF_QARG |JOF_NAME|JOF_DEC|JOF_POST)
 
 OPDEF(JSOP_INCLOCAL,  99, "inclocal",   NULL,         3,  0,  1, 15,  JOF_LOCAL|JOF_NAME|JOF_INC)
 OPDEF(JSOP_DECLOCAL,  100,"declocal",   NULL,         3,  0,  1, 15,  JOF_LOCAL|JOF_NAME|JOF_DEC)
 OPDEF(JSOP_LOCALINC,  101,"localinc",   NULL,         3,  0,  1, 15,  JOF_LOCAL|JOF_NAME|JOF_INC|JOF_POST)
 OPDEF(JSOP_LOCALDEC,  102,"localdec",   NULL,         3,  0,  1, 15,  JOF_LOCAL|JOF_NAME|JOF_DEC|JOF_POST)
 
-/*
- * Initialize for-in iterator using the JSITER_* flag bits in this op's uint8
- * immediate operand. See also JSOP_ENDITER.
- */
-OPDEF(JSOP_ITER,      103,"iter",       NULL,         2,  1,  1,  0,  JOF_UINT8)
+OPDEF(JSOP_IMACOP,    103,"imacop",     NULL,         1,  0,  0,  0,  JOF_BYTE)
 
 /* ECMA-compliant for/in ops. */
-OPDEF(JSOP_FORNAME,   104,"forname",    NULL,         3,  0,  1, 19,  JOF_ATOM|JOF_NAME|JOF_FOR)
-OPDEF(JSOP_FORPROP,   105,"forprop",    NULL,         3,  1,  1, 18,  JOF_ATOM|JOF_PROP|JOF_FOR)
-OPDEF(JSOP_FORELEM,   106,"forelem",    NULL,         1,  1,  3, 18,  JOF_BYTE |JOF_ELEM|JOF_FOR)
+OPDEF(JSOP_FORNAME,   104,"forname",    NULL,         3,  2,  2, 19,  JOF_ATOM|JOF_NAME|JOF_FOR)
+OPDEF(JSOP_FORPROP,   105,"forprop",    NULL,         3,  3,  2, 18,  JOF_ATOM|JOF_PROP|JOF_FOR)
+OPDEF(JSOP_FORELEM,   106,"forelem",    NULL,         1,  2,  3, 18,  JOF_BYTE |JOF_ELEM|JOF_FOR)
 OPDEF(JSOP_POPN,      107,"popn",       NULL,         3, -1,  0,  0,  JOF_UINT16)
 
 /* ECMA-compliant assignment ops. */
 OPDEF(JSOP_BINDNAME,  108,"bindname",   NULL,         3,  0,  1,  0,  JOF_ATOM|JOF_NAME|JOF_SET)
 OPDEF(JSOP_SETNAME,   109,"setname",    NULL,         3,  2,  1,  3,  JOF_ATOM|JOF_NAME|JOF_SET|JOF_DETECTING)
 
 /* Exception handling ops. */
 OPDEF(JSOP_THROW,     110,js_throw_str, NULL,         1,  1,  0,  0,  JOF_BYTE)
@@ -469,22 +486,22 @@ OPDEF(JSOP_LEAVEBLOCK,    200,"leavebloc
 OPDEF(JSOP_LEAVEBLOCK,    200,"leaveblock",  NULL,    3, -1,  0,  0,  JOF_UINT16)
 OPDEF(JSOP_UNUSED201,     201,"unused201",   NULL,    1,  0,  0,  0,  JOF_BYTE)
 OPDEF(JSOP_UNUSED202,     202,"unused202",   NULL,    1,  0,  0,  0,  JOF_BYTE)
 OPDEF(JSOP_UNUSED203,     203,"unused203",   NULL,    1,  0,  0,  0,  JOF_BYTE)
 OPDEF(JSOP_UNUSED204,     204,"unused204",   NULL,    1,  0,  0,  0,  JOF_BYTE)
 OPDEF(JSOP_UNUSED205,     205,"unused205",   NULL,    1,  0,  0,  0,  JOF_BYTE)
 OPDEF(JSOP_UNUSED206,     206,"unused206",   NULL,    1,  0,  0,  0,  JOF_BYTE)
 OPDEF(JSOP_UNUSED207,     207,"unused207",   NULL,    1,  0,  0,  0,  JOF_BYTE)
+OPDEF(JSOP_UNUSED208,     208,"unused208",   NULL,    1,  0,  0,  0,  JOF_BYTE)
+OPDEF(JSOP_UNUSED209,     209,"unused209",   NULL,    1,  0,  0,  0,  JOF_BYTE)
 
 /*
- * Iterator, generator, and array comprehension support.
+ * Generator and array comprehension support.
  */
-OPDEF(JSOP_FORCONST,      208,"forconst",    NULL,    3,  0,  1, 19,  JOF_LOCAL|JOF_NAME|JOF_FOR)
-OPDEF(JSOP_ENDITER,       209,"enditer",     NULL,    1,  1,  0,  0,  JOF_BYTE|JOF_TMPSLOT)
 OPDEF(JSOP_GENERATOR,     210,"generator",   NULL,    1,  0,  0,  0,  JOF_BYTE)
 OPDEF(JSOP_YIELD,         211,"yield",       NULL,    1,  1,  1,  1,  JOF_BYTE)
 OPDEF(JSOP_ARRAYPUSH,     212,"arraypush",   NULL,    3,  1,  0,  3,  JOF_LOCAL)
 
 /*
  * In the forthcoming great opcode reorg, this should go next to JSOP_GETUPVAR.
  */
 OPDEF(JSOP_CALLUPVAR,     213, "callupvar",  NULL,    3,  0,  2, 19,  JOF_UINT16|JOF_NAME|JOF_CALLOP)
@@ -493,17 +510,17 @@ OPDEF(JSOP_CALLUPVAR,     213, "callupva
  * Variant of JSOP_ENUMELEM for destructuring const (const [a, b] = ...).
  */
 OPDEF(JSOP_ENUMCONSTELEM, 214,"enumconstelem",NULL,   1,  3,  0,  3,  JOF_BYTE|JOF_SET)
 
 /*
  * Variant of JSOP_LEAVEBLOCK has a result on the stack above the locals,
  * which must be moved down when the block pops.
  */
-OPDEF(JSOP_LEAVEBLOCKEXPR,215,"leaveblockexpr",NULL,  3, -1,  1,  1,  JOF_UINT16)
+OPDEF(JSOP_LEAVEBLOCKEXPR,215,"leaveblockexpr",NULL,  3, -1,  1,  3,  JOF_UINT16)
 
 /*
  * Optimize common JSOP_{THIS,GET{ARG,LOCAL}} -> JSOP_GETPROP cliches.
  */
 OPDEF(JSOP_GETTHISPROP,   216,"getthisprop",   NULL,  3,  0,  1, 18,  JOF_ATOM|JOF_VARPROP)
 OPDEF(JSOP_GETARGPROP,    217,"getargprop",    NULL,  5,  0,  1, 18,  JOF_SLOTATOM|JOF_VARPROP)
 OPDEF(JSOP_GETLOCALPROP,  218,"getlocalprop",  NULL,  5,  0,  1, 18,  JOF_SLOTATOM|JOF_VARPROP)
 OPDEF(JSOP_UNUSED219,     219,"unused219",     NULL,  1,  0,  0,  0,  JOF_BYTE)
diff -r a4343d61f6ee js/src/jsparse.cpp
--- a/js/src/jsparse.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsparse.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -538,16 +538,28 @@ js_CompileScript(JSContext *cx, JSObject
     js_InitCodeGenerator(cx, &cg, &pc, &codePool, &notePool,
                          pc.tokenStream.lineno);
 
     MUST_FLOW_THROUGH("out");
     cg.treeContext.flags |= (uint16) tcflags;
     cg.treeContext.u.scopeChain = scopeChain;
     cg.staticDepth = TCF_GET_STATIC_DEPTH(tcflags);
 
+    if ((tcflags & TCF_COMPILE_N_GO) && callerFrame && callerFrame->fun) {
+        /*
+         * An eval script in a caller frame needs to have its enclosing function
+         * captured in case it uses an upvar reference, and someone wishes to
+         * decompile it while running.
+         */
+        JSParsedObjectBox *pob = js_NewParsedObjectBox(cx, &pc, callerFrame->callee);
+        pob->emitLink = cg.objectList.lastPob;
+        cg.objectList.lastPob = pob;
+        cg.objectList.length++;
+    }
+
     /* Inline Statements() to emit as we go to save space. */
     for (;;) {
         pc.tokenStream.flags |= TSF_OPERAND;
         tt = js_PeekToken(cx, &pc.tokenStream);
         pc.tokenStream.flags &= ~TSF_OPERAND;
         if (tt <= TOK_EOF) {
             if (tt == TOK_EOF)
                 break;
@@ -1664,17 +1676,17 @@ BindVarOrConst(JSContext *cx, BindData *
 }
 
 static JSBool
 MakeSetCall(JSContext *cx, JSParseNode *pn, JSTreeContext *tc, uintN msg)
 {
     JSParseNode *pn2;
 
     JS_ASSERT(pn->pn_arity == PN_LIST);
-    JS_ASSERT(pn->pn_op == JSOP_CALL || pn->pn_op == JSOP_EVAL);
+    JS_ASSERT(pn->pn_op == JSOP_CALL || pn->pn_op == JSOP_EVAL || pn->pn_op == JSOP_APPLY);
     pn2 = pn->pn_head;
     if (pn2->pn_type == TOK_FUNCTION && (pn2->pn_flags & TCF_GENEXP_LAMBDA)) {
         js_ReportCompileErrorNumber(cx, TS(tc->parseContext), pn,
                                     JSREPORT_ERROR, msg);
         return JS_FALSE;
     }
     pn->pn_op = JSOP_SETCALL;
     return JS_TRUE;
@@ -3974,17 +3986,17 @@ SetLvalKid(JSContext *cx, JSTokenStream 
            const char *name)
 {
     while (kid->pn_type == TOK_RP)
         kid = kid->pn_kid;
     if (kid->pn_type != TOK_NAME &&
         kid->pn_type != TOK_DOT &&
 #if JS_HAS_LVALUE_RETURN
         (kid->pn_type != TOK_LP ||
-         (kid->pn_op != JSOP_CALL && kid->pn_op != JSOP_EVAL)) &&
+         (kid->pn_op != JSOP_CALL && kid->pn_op != JSOP_EVAL && kid->pn_op != JSOP_APPLY)) &&
 #endif
 #if JS_HAS_XML_SUPPORT
         (kid->pn_type != TOK_UNARYOP || kid->pn_op != JSOP_XMLNAME) &&
 #endif
         kid->pn_type != TOK_LB) {
         js_ReportCompileErrorNumber(cx, ts, NULL, JSREPORT_ERROR,
                                     JSMSG_BAD_OPERAND, name);
         return NULL;
@@ -4610,23 +4622,28 @@ MemberExpr(JSContext *cx, JSTokenStream 
                 pn2->pn_left = pn;
                 pn2->pn_right = pn3;
             } while (0);
         } else if (allowCallSyntax && tt == TOK_LP) {
             pn2 = NewParseNode(cx, ts, PN_LIST, tc);
             if (!pn2)
                 return NULL;
 
-            /* Pick JSOP_EVAL and flag tc as heavyweight if eval(...). */
             pn2->pn_op = JSOP_CALL;
             if (pn->pn_op == JSOP_NAME &&
                 pn->pn_atom == cx->runtime->atomState.evalAtom) {
+                /* Pick JSOP_EVAL and flag tc as heavyweight if eval(...). */
                 pn2->pn_op = JSOP_EVAL;
                 tc->flags |= TCF_FUN_HEAVYWEIGHT;
-            }
+            } else if (pn->pn_op == JSOP_GETPROP &&
+                       (pn->pn_atom == cx->runtime->atomState.applyAtom ||
+                        pn->pn_atom == cx->runtime->atomState.callAtom)) {
+                /* Pick JSOP_APPLY if apply(...). */
+                pn2->pn_op = JSOP_APPLY;
+            } 
 
             PN_INIT_LIST_1(pn2, pn);
             pn2->pn_pos.begin = pn->pn_pos.begin;
 
             if (!ArgumentList(cx, ts, tc, pn2))
                 return NULL;
             if (pn2->pn_count > ARGC_LIMIT) {
                 JS_ReportErrorNumber(cx, js_GetErrorMessage, NULL,
@@ -6334,22 +6351,27 @@ js_FoldConstants(JSContext *cx, JSParseN
         tc->flags = (uint16) pn->pn_flags;
         if (!js_FoldConstants(cx, pn->pn_body, tc))
             return JS_FALSE;
         tc->flags = oldflags;
         break;
       }
 
       case PN_LIST:
+      {
+        /* Propagate inCond through logical connectives. */
+        bool cond = inCond && (pn->pn_type == TOK_OR || pn->pn_type == TOK_AND);
+
         /* Save the list head in pn1 for later use. */
         for (pn1 = pn2 = pn->pn_head; pn2; pn2 = pn2->pn_next) {
-            if (!js_FoldConstants(cx, pn2, tc))
-                return JS_FALSE;
-        }
-        break;
+            if (!js_FoldConstants(cx, pn2, tc, cond))
+                return JS_FALSE;
+        }
+        break;
+      }
 
       case PN_TERNARY:
         /* Any kid may be null (e.g. for (;;)). */
         pn1 = pn->pn_kid1;
         pn2 = pn->pn_kid2;
         pn3 = pn->pn_kid3;
         if (pn1 && !js_FoldConstants(cx, pn1, tc, pn->pn_type == TOK_IF))
             return JS_FALSE;
diff -r a4343d61f6ee js/src/jsregexp.cpp
--- a/js/src/jsregexp.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsregexp.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -60,16 +60,33 @@
 #include "jslock.h"
 #include "jsnum.h"
 #include "jsobj.h"
 #include "jsopcode.h"
 #include "jsregexp.h"
 #include "jsscan.h"
 #include "jsscope.h"
 #include "jsstr.h"
+
+#ifdef JS_TRACER
+#include "jstracer.h"
+using namespace avmplus;
+using namespace nanojit;
+
+/* 
+ * FIXME  Duplicated with jstracer.cpp, doing it this way for now
+ *        to keep it private to files that need it. 
+ */
+#ifdef JS_JIT_SPEW
+static bool verbose_debug = getenv("TRACEMONKEY") && strstr(getenv("TRACEMONKEY"), "verbose");
+#define debug_only_v(x) if (verbose_debug) { x; }
+#else
+#define debug_only_v(x)
+#endif
+#endif
 
 typedef enum REOp {
 #define REOP_DEF(opcode, name) opcode,
 #include "jsreops.tbl"
 #undef REOP_DEF
     REOP_LIMIT /* META: no operator >= to this */
 } REOp;
 
@@ -1596,26 +1613,39 @@ SetForwardJumpOffset(jsbytecode *jump, j
     if ((size_t)offset > OFFSET_MAX)
         return JS_FALSE;
 
     jump[0] = JUMP_OFFSET_HI(offset);
     jump[1] = JUMP_OFFSET_LO(offset);
     return JS_TRUE;
 }
 
+/* Copy the charset data from a character class node to the charset list
+ * in the regexp object. */
+static JS_ALWAYS_INLINE RECharSet *
+InitNodeCharSet(JSRegExp *re, RENode *node)
+{
+    RECharSet *charSet = &re->classList[node->u.ucclass.index];
+    charSet->converted = JS_FALSE;
+    charSet->length = node->u.ucclass.bmsize;
+    charSet->u.src.startIndex = node->u.ucclass.startIndex;
+    charSet->u.src.length = node->u.ucclass.kidlen;
+    charSet->sense = node->u.ucclass.sense;
+    return charSet;
+}
+
 /*
  * Generate bytecode for the tree rooted at t using an explicit stack instead
  * of recursion.
  */
 static jsbytecode *
 EmitREBytecode(CompilerState *state, JSRegExp *re, size_t treeDepth,
                jsbytecode *pc, RENode *t)
 {
     EmitStateStackEntry *emitStateSP, *emitStateStack;
-    RECharSet *charSet;
     REOp op;
 
     if (treeDepth == 0) {
         emitStateStack = NULL;
     } else {
         emitStateStack =
             (EmitStateStackEntry *)JS_malloc(state->context,
                                              sizeof(EmitStateStackEntry) *
@@ -1895,22 +1925,17 @@ EmitREBytecode(CompilerState *state, JSR
             if (!SetForwardJumpOffset(emitStateSP->nextTermFixup, pc))
                 goto jump_too_big;
             break;
 
           case REOP_CLASS:
             if (!t->u.ucclass.sense)
                 pc[-1] = REOP_NCLASS;
             pc = WriteCompactIndex(pc, t->u.ucclass.index);
-            charSet = &re->classList[t->u.ucclass.index];
-            charSet->converted = JS_FALSE;
-            charSet->length = t->u.ucclass.bmsize;
-            charSet->u.src.startIndex = t->u.ucclass.startIndex;
-            charSet->u.src.length = t->u.ucclass.kidlen;
-            charSet->sense = t->u.ucclass.sense;
+            InitNodeCharSet(re, t);
             break;
 
           default:
             break;
         }
 
         t = t->next;
         if (t) {
@@ -1930,16 +1955,283 @@ EmitREBytecode(CompilerState *state, JSR
     return pc;
 
   jump_too_big:
     ReportRegExpError(state, JSREPORT_ERROR, JSMSG_REGEXP_TOO_COMPLEX);
     pc = NULL;
     goto cleanup;
 }
 
+#ifdef JS_TRACER
+typedef List<LIns*, LIST_NonGCObjects> LInsList;
+
+/* Dummy GC for nanojit placement new. */
+static GC gc;
+
+class RegExpNativeCompiler {
+ private:
+    JSRegExp*        re;   /* Careful: not fully initialized */
+    CompilerState*   cs;   /* RegExp to compile */
+    Fragment*        fragment;
+    LirWriter*       lir;
+
+    LIns*            state;
+    LIns*            gdata;
+    LIns*            cpend;
+
+    JSBool isCaseInsensitive() const { return cs->flags & JSREG_FOLD; }
+
+    void targetCurrentPoint(LIns* ins) { ins->target(lir->ins0(LIR_label)); }
+
+    void targetCurrentPoint(LInsList& fails) 
+    {
+        LIns* fail = lir->ins0(LIR_label);
+        for (size_t i = 0; i < fails.size(); ++i) {
+            fails[i]->target(fail);
+        }
+        fails.clear();
+    }
+
+    /* 
+     * These functions return the new position after their match operation,
+     * or NULL if there was an error.
+     */
+    LIns* compileEmpty(RENode* node, LIns* pos, LInsList& fails) 
+    {
+        return pos;
+    }
+
+    LIns* compileFlatSingleChar(RENode* node, LIns* pos, LInsList& fails) 
+    {
+        /* 
+         * Fast case-insensitive test for ASCII letters: convert text
+         * char to lower case by bit-or-ing in 32 and compare.
+         */
+        JSBool useFastCI = JS_FALSE;
+        jschar ch = node->u.flat.chr; /* char to test for */
+        jschar ch2 = ch;              /* 2nd char to test for if ci */
+        if (cs->flags & JSREG_FOLD) {
+            if (L'A' <= ch && ch <= L'Z' || L'a' <= ch || ch <= L'z') {
+                ch |= 32;
+                ch2 = ch;
+                useFastCI = JS_TRUE;
+            } else if (JS_TOLOWER(ch) != ch) {
+                ch2 = JS_TOLOWER(ch);
+                ch = JS_TOUPPER(ch);
+            }
+        }
+
+        LIns* to_fail = lir->insBranch(LIR_jf, lir->ins2(LIR_lt, pos, cpend), 0);
+        fails.add(to_fail);
+        LIns* text_ch = lir->insLoad(LIR_ldcs, pos, lir->insImm(0));
+        LIns* comp_ch = useFastCI ? 
+            lir->ins2(LIR_or, text_ch, lir->insImm(32)) : 
+            text_ch;
+        if (ch == ch2) {
+            fails.add(lir->insBranch(LIR_jf, lir->ins2(LIR_eq, comp_ch, lir->insImm(ch)), 0));
+        } else {
+            LIns* to_ok = lir->insBranch(LIR_jt, lir->ins2(LIR_eq, comp_ch, lir->insImm(ch)), 0);
+            fails.add(lir->insBranch(LIR_jf, lir->ins2(LIR_eq, comp_ch, lir->insImm(ch2)), 0));
+            targetCurrentPoint(to_ok);
+        }
+
+        return lir->ins2(LIR_piadd, pos, lir->insImm(2));
+    }
+
+    LIns* compileClass(RENode* node, LIns* pos, LInsList& fails) 
+    {
+        if (!node->u.ucclass.sense) 
+            return JS_FALSE;
+
+        RECharSet* charSet = InitNodeCharSet(re, node);
+        LIns* to_fail = lir->insBranch(LIR_jf, lir->ins2(LIR_lt, pos, cpend), 0);
+        fails.add(to_fail);
+        LIns* text_ch = lir->insLoad(LIR_ldcs, pos, lir->insImm(0));
+        fails.add(lir->insBranch(LIR_jf, lir->ins2(LIR_le, text_ch, lir->insImm(charSet->length)), 0));
+        LIns* byteIndex = lir->ins2(LIR_rsh, text_ch, lir->insImm(3));
+        LIns* bitmap = lir->insLoad(LIR_ld, lir->insImmPtr(charSet), (int) offsetof(RECharSet, u.bits));
+        LIns* byte = lir->insLoad(LIR_ldcb, lir->ins2(LIR_piadd, bitmap, byteIndex), (int) 0);
+        LIns* bitMask = lir->ins2(LIR_lsh, lir->insImm(1),
+                               lir->ins2(LIR_and, text_ch, lir->insImm(0x7)));
+        LIns* test = lir->ins2(LIR_eq, lir->ins2(LIR_and, byte, bitMask), lir->insImm(0));
+        
+        LIns* to_next = lir->insBranch(LIR_jt, test, 0);
+        fails.add(to_next);
+        return lir->ins2(LIR_piadd, pos, lir->insImm(2));
+    }
+
+    LIns* compileAlt(RENode* node, LIns* pos, LInsList& fails) 
+    {
+        LInsList kidFails(NULL);
+        if (!compileNode((RENode *) node->kid, pos, kidFails)) 
+            return JS_FALSE;
+        if (!compileNode(node->next, pos, kidFails)) 
+            return JS_FALSE;
+
+        targetCurrentPoint(kidFails);
+        if (!compileNode(node->u.altprereq.kid2, pos, fails)) 
+            return JS_FALSE;
+        /* 
+         * Disable compilation for any regexp where something follows an
+         * alternation. To make this work, we need to redesign to either
+         * (a) pass around continuations so we know the right place to go
+         * when we logically return, or (b) generate explicit backtracking
+         * code. 
+         */
+        if (node->next) 
+            return JS_FALSE;
+        return pos;
+    }
+
+    JSBool compileNode(RENode* node, LIns* pos, LInsList& fails) 
+    {
+        for (; node; node = node->next) {
+            if (fragment->lirbuf->outOmem()) 
+                return JS_FALSE;
+
+            switch (node->op) {
+            case REOP_EMPTY:
+                pos = compileEmpty(node, pos, fails);
+                break;
+            case REOP_FLAT:
+                if (node->u.flat.length != 1) 
+                    return JS_FALSE;
+                pos = compileFlatSingleChar(node, pos, fails);
+                break;
+            case REOP_ALT:
+            case REOP_ALTPREREQ:
+                pos = compileAlt(node, pos, fails);
+                break;
+            case REOP_CLASS:
+                pos = compileClass(node, pos, fails);
+                break;
+            default:
+                return JS_FALSE;
+            }
+            if (!pos) 
+                return JS_FALSE;
+        }
+
+        lir->insStorei(pos, state, (int) offsetof(REMatchState, cp));
+        lir->ins1(LIR_ret, state);
+        return JS_TRUE;
+    }
+
+    JSBool compileSticky(RENode* root, LIns* start) 
+    {
+        LInsList fails(NULL);
+        if (!compileNode(root, start, fails)) 
+            return JS_FALSE;
+        targetCurrentPoint(fails);
+        lir->ins1(LIR_ret, lir->insImm(0));
+        return JS_TRUE;
+    }
+
+    JSBool compileAnchoring(RENode* root, LIns* start) 
+    {
+        /* Even at the end, the empty regexp would match. */
+        LIns* to_next = lir->insBranch(LIR_jf, 
+                                       lir->ins2(LIR_le, start, cpend), 0);
+        LInsList fails(NULL);
+        if (!compileNode(root, start, fails)) 
+            return JS_FALSE;
+
+        targetCurrentPoint(to_next);
+        lir->ins1(LIR_ret, lir->insImm(0));
+        
+        targetCurrentPoint(fails);
+        lir->insStorei(lir->ins2(LIR_piadd, start, lir->insImm(2)), gdata, 
+                       (int) offsetof(REGlobalData, skipped));
+        
+        return JS_TRUE;
+    }
+
+    inline LIns*
+    addName(LirBuffer* lirbuf, LIns* ins, const char* name)
+    {
+        debug_only_v(lirbuf->names->addName(ins, name);)
+        return ins;
+    }
+
+ public:
+    RegExpNativeCompiler(JSRegExp *re, CompilerState *cs) 
+        : re(re), cs(cs), fragment(NULL) {  }
+
+    JSBool compile(JSContext* cx) 
+    {
+        GuardRecord* guard;
+        LIns* skip;
+        LIns* start;
+        bool oom = false;
+        
+        Fragmento* fragmento = JS_TRACE_MONITOR(cx).reFragmento;
+        fragment = fragmento->getLoop(re);
+        if (!fragment) {
+            fragment = fragmento->getAnchor(re);
+            fragment->lirbuf = new (&gc) LirBuffer(fragmento, NULL);
+            /* Scary: required to have the onDestroy method delete the lirbuf. */
+            fragment->root = fragment;
+        }
+        LirBuffer* lirbuf = fragment->lirbuf;
+        LirBufWriter* lirb;
+        if (lirbuf->outOmem()) goto fail2;
+        /* FIXME Use bug 463260 smart pointer when available. */
+        lir = lirb = new (&gc) LirBufWriter(lirbuf);
+
+        /* FIXME Use bug 463260 smart pointer when available. */
+        debug_only_v(fragment->lirbuf->names = new (&gc) LirNameMap(&gc, NULL, fragmento->labels);)
+        /* FIXME Use bug 463260 smart pointer when available. */
+        debug_only_v(lir = new (&gc) VerboseWriter(&gc, lir, lirbuf->names);)
+
+        lir->ins0(LIR_start);
+        lirbuf->state = state = addName(lirbuf, lir->insParam(0, 0), "state");
+        lirbuf->param1 = gdata = addName(lirbuf, lir->insParam(1, 0), "gdata");
+        start = addName(lirbuf, lir->insLoad(LIR_ldp, lirbuf->param1, (int) offsetof(REGlobalData, skipped)), "start");
+        cpend = addName(lirbuf, lir->insLoad(LIR_ldp, lirbuf->param1, offsetof(REGlobalData, cpend)), "cpend");
+
+        if (cs->flags & JSREG_STICKY) {
+            if (!compileSticky(cs->result, start)) goto fail;
+        } else {
+            if (!compileAnchoring(cs->result, start)) goto fail;
+        }
+
+        /* Create fake guard record for loop edge. */
+        skip = lirb->skip(sizeof(GuardRecord) + sizeof(SideExit));
+        guard = (GuardRecord *) skip->payload();
+        memset(guard, 0, sizeof(*guard));
+        guard->exit = (SideExit *) guard+1;
+        guard->exit->target = fragment;
+        fragment->lastIns = lir->insGuard(LIR_loop, lir->insImm(1), skip);
+
+        ::compile(fragmento->assm(), fragment);
+        if (fragmento->assm()->error() != nanojit::None) {
+            oom = fragmento->assm()->error() == nanojit::OutOMem;
+            goto fail;
+        }
+
+        delete lirb;
+        debug_only_v(delete lir;)
+        return JS_TRUE;
+    fail:
+        delete lirb;
+        debug_only_v(delete lir;)
+    fail2:
+        if (lirbuf->outOmem() || oom) 
+            fragmento->clearFrags();
+        return JS_FALSE;
+    }
+};
+
+static inline JSBool
+js_CompileRegExpToNative(JSContext *cx, JSRegExp *re, CompilerState *cs)
+{
+    RegExpNativeCompiler rc(re, cs);
+    return rc.compile(cx);
+}
+#endif
 
 JSRegExp *
 js_NewRegExp(JSContext *cx, JSTokenStream *ts,
              JSString *str, uintN flags, JSBool flat)
 {
     JSRegExp *re;
     void *mark;
     CompilerState state;
@@ -1977,16 +2269,17 @@ js_NewRegExp(JSContext *cx, JSTokenStrea
         state.result->kid = (void *) state.cpbegin;
         /* Flat bytecode: REOP_FLAT compact(string_offset) compact(len). */
         state.progLength += 1 + GetCompactIndexWidth(0)
                           + GetCompactIndexWidth(len);
     } else {
         if (!ParseRegExp(&state))
             goto out;
     }
+
     resize = offsetof(JSRegExp, program) + state.progLength + 1;
     re = (JSRegExp *) JS_malloc(cx, resize);
     if (!re)
         goto out;
 
     re->nrefs = 1;
     JS_ASSERT(state.classBitmapsMem <= CLASS_BITMAPS_MEM_LIMIT);
     re->classCount = state.classCount;
@@ -1998,36 +2291,53 @@ js_NewRegExp(JSContext *cx, JSTokenStrea
             re = NULL;
             goto out;
         }
         for (i = 0; i < re->classCount; i++)
             re->classList[i].converted = JS_FALSE;
     } else {
         re->classList = NULL;
     }
+
+#ifdef JS_TRACER
+    /*
+     * Try compiling the native code version. For the time being we also 
+     * compile the bytecode version in case we evict the native code
+     * version from the code cache.
+     */
+    if (TRACING_ENABLED(cx))
+        js_CompileRegExpToNative(cx, re, &state);
+#endif
+    /* Compile the bytecode version. */
     endPC = EmitREBytecode(&state, re, state.treeDepth, re->program, state.result);
     if (!endPC) {
         js_DestroyRegExp(cx, re);
         re = NULL;
         goto out;
     }
     *endPC++ = REOP_END;
     /*
      * Check whether size was overestimated and shrink using realloc.
      * This is safe since no pointers to newly parsed regexp or its parts
      * besides re exist here.
+     */
+#if 0 
+    /*
+     * FIXME: Until bug 464866 is fixed, we can't move the re object so
+     * don't shrink it for now.
      */
     if ((size_t)(endPC - re->program) != state.progLength + 1) {
         JSRegExp *tmp;
         JS_ASSERT((size_t)(endPC - re->program) < state.progLength + 1);
         resize = offsetof(JSRegExp, program) + (endPC - re->program);
         tmp = (JSRegExp *) JS_realloc(cx, re, resize);
         if (tmp)
             re = tmp;
     }
+#endif    
 
     re->flags = flags;
     re->parenCount = state.parenCount;
     re->source = str;
 
 out:
     JS_ARENA_RELEASE(&cx->tempPool, mark);
     return re;
@@ -2533,16 +2843,22 @@ ProcessCharSet(REGlobalData *gData, RECh
     }
     return JS_TRUE;
 }
 
 void
 js_DestroyRegExp(JSContext *cx, JSRegExp *re)
 {
     if (JS_ATOMIC_DECREMENT(&re->nrefs) == 0) {
+#ifdef JS_TRACER
+        /* Don't reuse this compiled code for some new regexp at same addr. */
+        Fragment* fragment = JS_TRACE_MONITOR(cx).reFragmento->getLoop(re);
+        if (fragment) 
+            fragment->blacklist();
+#endif
         if (re->classList) {
             uintN i;
             for (i = 0; i < re->classCount; i++) {
                 if (re->classList[i].converted)
                     JS_free(cx, re->classList[i].u.bits);
                 re->classList[i].u.bits = NULL;
             }
             JS_free(cx, re->classList);
@@ -3339,17 +3655,46 @@ good:
 
 static REMatchState *
 MatchRegExp(REGlobalData *gData, REMatchState *x)
 {
     REMatchState *result;
     const jschar *cp = x->cp;
     const jschar *cp2;
     uintN j;
-
+#ifdef JS_TRACER
+    Fragment *fragment;
+
+    /* Run with native regexp if possible. */
+    if (TRACING_ENABLED(gData->cx) &&
+        ((fragment = JS_TRACE_MONITOR(gData->cx).reFragmento->getLoop(gData->regexp)) != NULL)
+        && fragment->code() && !fragment->isBlacklisted()) {
+        union { NIns *code; REMatchState* (FASTCALL *func)(void*, void*); } u;
+        u.code = fragment->code();
+        REMatchState *lr;
+        gData->skipped = (ptrdiff_t) x->cp;
+
+        debug_only_v(printf("entering REGEXP trace at %s:%u@%u, code: %p\n",
+                            gData->cx->fp->script->filename,
+                            js_FramePCToLineNumber(gData->cx, gData->cx->fp),
+                            FramePCOffset(gData->cx->fp),
+                            fragment->code()););
+
+#if defined(JS_NO_FASTCALL) && defined(NANOJIT_IA32)
+        SIMULATE_FASTCALL(lr, x, gData, u.func);
+#else
+        lr = u.func(x, gData);
+#endif
+
+        debug_only_v(printf("leaving REGEXP trace\n"));
+
+        gData->skipped = ((const jschar *) gData->skipped) - cp;
+        return lr;
+    }
+#endif
     /*
      * Have to include the position beyond the last character
      * in order to detect end-of-input/line condition.
      */
     for (cp2 = cp; cp2 <= gData->cpend; cp2++) {
         gData->skipped = cp2 - cp;
         x->cp = cp2;
         for (j = 0; j < gData->regexp->parenCount; j++)
diff -r a4343d61f6ee js/src/jsscan.cpp
--- a/js/src/jsscan.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsscan.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -744,16 +744,32 @@ js_AppendChar(JSStringBuffer *sb, jschar
     if (!ENSURE_STRING_BUFFER(sb, 1))
         return;
     bp = sb->ptr;
     *bp++ = c;
     *bp = 0;
     sb->ptr = bp;
 }
 
+void
+js_AppendUCString(JSStringBuffer *sb, const jschar *buf, uintN len)
+{
+    jschar *bp;
+
+    if (!STRING_BUFFER_OK(sb))
+        return;
+    if (len == 0 || !ENSURE_STRING_BUFFER(sb, len))
+        return;
+    bp = sb->ptr;
+    js_strncpy(bp, buf, len);
+    bp += len;
+    *bp = 0;
+    sb->ptr = bp;
+}
+
 #if JS_HAS_XML_SUPPORT
 
 void
 js_RepeatChar(JSStringBuffer *sb, jschar c, uintN count)
 {
     jschar *bp;
 
     if (!STRING_BUFFER_OK(sb) || count == 0)
@@ -781,29 +797,17 @@ js_AppendCString(JSStringBuffer *sb, con
         *bp++ = (jschar) *asciiz++;
     *bp = 0;
     sb->ptr = bp;
 }
 
 void
 js_AppendJSString(JSStringBuffer *sb, JSString *str)
 {
-    size_t length;
-    jschar *bp;
-
-    if (!STRING_BUFFER_OK(sb))
-        return;
-    length = JSSTRING_LENGTH(str);
-    if (length == 0 || !ENSURE_STRING_BUFFER(sb, length))
-        return;
-    bp = sb->ptr;
-    js_strncpy(bp, JSSTRING_CHARS(str), length);
-    bp += length;
-    *bp = 0;
-    sb->ptr = bp;
+    js_AppendUCString(sb, JSSTRING_CHARS(str), JSSTRING_LENGTH(str));
 }
 
 static JSBool
 GetXMLEntity(JSContext *cx, JSTokenStream *ts)
 {
     ptrdiff_t offset, length, i;
     int32 c, d;
     JSBool ispair;
diff -r a4343d61f6ee js/src/jsscan.h
--- a/js/src/jsscan.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsscan.h	Sat Nov 15 19:43:13 2008 -0500
@@ -175,16 +175,19 @@ extern void
 extern void
 js_AppendChar(JSStringBuffer *sb, jschar c);
 
 extern void
 js_RepeatChar(JSStringBuffer *sb, jschar c, uintN count);
 
 extern void
 js_AppendCString(JSStringBuffer *sb, const char *asciiz);
+
+extern void
+js_AppendUCString(JSStringBuffer *sb, const jschar *buf, uintN len);
 
 extern void
 js_AppendJSString(JSStringBuffer *sb, JSString *str);
 
 struct JSTokenPtr {
     uint16              index;          /* index of char in physical line */
     uint16              lineno;         /* physical line number */
 };
diff -r a4343d61f6ee js/src/jsscript.cpp
--- a/js/src/jsscript.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsscript.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -1738,16 +1738,22 @@ js_GetSrcNoteCached(JSContext *cx, JSScr
             JS_METER_GSN_CACHE(cx, fills);
         }
     }
 
     return result;
 }
 
 uintN
+js_FramePCToLineNumber(JSContext *cx, JSStackFrame *fp)
+{
+    return js_PCToLineNumber(cx, fp->script, fp->imacpc ? fp->imacpc : fp->regs->pc);
+}
+
+uintN
 js_PCToLineNumber(JSContext *cx, JSScript *script, jsbytecode *pc)
 {
     JSFunction *fun;
     uintN lineno;
     ptrdiff_t offset, target;
     jssrcnote *sn;
     JSSrcNoteType type;
 
diff -r a4343d61f6ee js/src/jsscript.h
--- a/js/src/jsscript.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsscript.h	Sat Nov 15 19:43:13 2008 -0500
@@ -154,25 +154,30 @@ StackDepth(JSScript *script)
 
 #define JS_SCRIPT_TRYNOTES(script)                                            \
     (JS_ASSERT((script)->trynotesOffset != 0),                                \
      (JSTryNoteArray *)((uint8 *)(script) + (script)->trynotesOffset))
 
 #define JS_GET_SCRIPT_ATOM(script, index, atom)                               \
     JS_BEGIN_MACRO                                                            \
         JSAtomMap *atoms_ = &(script)->atomMap;                               \
-        JS_ASSERT((uint32)(index) < atoms_->length);                          \
-        (atom) = atoms_->vector[(index)];                                     \
+        if (cx->fp && cx->fp->imacpc) {                                       \
+            JS_ASSERT((size_t)(index) < js_common_atom_count);                \
+            (atom) = COMMON_ATOMS_START(&cx->runtime->atomState)[index];      \
+        } else {                                                              \
+            JS_ASSERT((uint32)(index) < atoms_->length);                      \
+            (atom) = atoms_->vector[index];                                   \
+        }                                                                     \
     JS_END_MACRO
 
 #define JS_GET_SCRIPT_OBJECT(script, index, obj)                              \
     JS_BEGIN_MACRO                                                            \
         JSObjectArray *objects_ = JS_SCRIPT_OBJECTS(script);                  \
         JS_ASSERT((uint32)(index) < objects_->length);                        \
-        (obj) = objects_->vector[(index)];                                    \
+        (obj) = objects_->vector[index];                                      \
     JS_END_MACRO
 
 #define JS_GET_SCRIPT_FUNCTION(script, index, fun)                            \
     JS_BEGIN_MACRO                                                            \
         JSObject *funobj_;                                                    \
                                                                               \
         JS_GET_SCRIPT_OBJECT(script, index, funobj_);                         \
         JS_ASSERT(HAS_FUNCTION_CLASS(funobj_));                               \
@@ -180,17 +185,17 @@ StackDepth(JSScript *script)
         (fun) = (JSFunction *) funobj_;                                       \
         JS_ASSERT(FUN_INTERPRETED(fun));                                      \
     JS_END_MACRO
 
 #define JS_GET_SCRIPT_REGEXP(script, index, obj)                              \
     JS_BEGIN_MACRO                                                            \
         JSObjectArray *regexps_ = JS_SCRIPT_REGEXPS(script);                  \
         JS_ASSERT((uint32)(index) < regexps_->length);                        \
-        (obj) = regexps_->vector[(index)];                                    \
+        (obj) = regexps_->vector[index];                                      \
         JS_ASSERT(STOBJ_GET_CLASS(obj) == &js_RegExpClass);                   \
     JS_END_MACRO
 
 /*
  * Check if pc is inside a try block that has finally code. GC calls this to
  * check if it is necessary to schedule generator.close() invocation for an
  * unreachable generator.
  */
@@ -286,17 +291,24 @@ js_TraceScript(JSTracer *trc, JSScript *
  * cache without adding an explicit cx parameter.  Thus js_GetSrcNote becomes
  * a macro that uses cx from its calls' lexical environments.
  */
 #define js_GetSrcNote(script,pc) js_GetSrcNoteCached(cx, script, pc)
 
 extern jssrcnote *
 js_GetSrcNoteCached(JSContext *cx, JSScript *script, jsbytecode *pc);
 
-/* XXX need cx to lock function objects declared by prolog bytecodes. */
+/*
+ * NOTE: use js_FramePCToLineNumber(cx, fp) when you have an active fp, in
+ * preference to js_PCToLineNumber (cx, fp->script  fp->regs->pc), because
+ * fp->imacpc may be non-null, indicating an active imacro.
+ */
+extern uintN
+js_FramePCToLineNumber(JSContext *cx, JSStackFrame *fp);
+
 extern uintN
 js_PCToLineNumber(JSContext *cx, JSScript *script, jsbytecode *pc);
 
 extern jsbytecode *
 js_LineNumberToPC(JSScript *script, uintN lineno);
 
 extern JS_FRIEND_API(uintN)
 js_GetScriptLineExtent(JSScript *script);
diff -r a4343d61f6ee js/src/jsstr.cpp
--- a/js/src/jsstr.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsstr.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -784,16 +784,26 @@ str_substring(JSContext *cx, uintN argc,
             return JS_FALSE;
     }
     *vp = STRING_TO_JSVAL(str);
     return JS_TRUE;
 }
 
 #ifdef JS_TRACER
 static JSString* FASTCALL
+String_p_toString(JSContext* cx, JSObject* obj)
+{
+    if (!JS_InstanceOf(cx, obj, &js_StringClass, NULL))
+        return NULL;
+    jsval v = OBJ_GET_SLOT(cx, obj, JSSLOT_PRIVATE);
+    JS_ASSERT(JSVAL_IS_STRING(v));
+    return JSVAL_TO_STRING(v);
+}
+
+static JSString* FASTCALL
 String_p_substring(JSContext* cx, JSString* str, int32 begin, int32 end)
 {
     JS_ASSERT(JS_ON_TRACE(cx));
 
     size_t length = JSSTRING_LENGTH(str);
     return SubstringTail(cx, str, length, begin, end);
 }
 
@@ -2466,16 +2476,18 @@ js_String_getelem(JSContext* cx, JSStrin
         return NULL;
     return js_GetUnitString(cx, str, (size_t)i);
 }
 #endif
 
 JS_DEFINE_CALLINFO_2(extern, BOOL,   js_EqualStrings, STRING, STRING,                       1, 1)
 JS_DEFINE_CALLINFO_2(extern, INT32,  js_CompareStrings, STRING, STRING,                     1, 1)
 
+JS_DEFINE_TRCINFO_1(str_toString,
+    (2, (extern, STRING_FAIL,      String_p_toString, CONTEXT, THIS,                        1, 1)))
 JS_DEFINE_TRCINFO_2(str_substring,
     (4, (static, STRING_FAIL,      String_p_substring, CONTEXT, THIS_STRING, INT32, INT32,   1, 1)),
     (3, (static, STRING_FAIL,      String_p_substring_1, CONTEXT, THIS_STRING, INT32,        1, 1)))
 JS_DEFINE_TRCINFO_1(str_charAt,
     (3, (extern, STRING_FAIL,      js_String_getelem, CONTEXT, THIS_STRING, INT32,           1, 1)))
 JS_DEFINE_TRCINFO_1(str_charCodeAt,
     (2, (extern, INT32_FAIL,       js_String_p_charCodeAt, THIS_STRING, INT32,               1, 1)))
 JS_DEFINE_TRCINFO_4(str_concat,
@@ -2503,17 +2515,17 @@ JS_DEFINE_TRCINFO_1(str_toUpperCase,
 
 static JSFunctionSpec string_methods[] = {
 #if JS_HAS_TOSOURCE
     JS_FN("quote",             str_quote,             0,GENERIC_PRIMITIVE),
     JS_FN(js_toSource_str,     str_toSource,          0,JSFUN_THISP_STRING),
 #endif
 
     /* Java-like methods. */
-    JS_FN(js_toString_str,     str_toString,          0,JSFUN_THISP_STRING),
+    JS_TN(js_toString_str,     str_toString,          0,JSFUN_THISP_STRING, str_toString_trcinfo),
     JS_FN(js_valueOf_str,      str_toString,          0,JSFUN_THISP_STRING),
     JS_FN(js_toJSON_str,       str_toString,          0,JSFUN_THISP_STRING),
     JS_TN("substring",         str_substring,         2,GENERIC_PRIMITIVE, str_substring_trcinfo),
     JS_TN("toLowerCase",       str_toLowerCase,       0,GENERIC_PRIMITIVE, str_toLowerCase_trcinfo),
     JS_TN("toUpperCase",       str_toUpperCase,       0,GENERIC_PRIMITIVE, str_toUpperCase_trcinfo),
     JS_TN("charAt",            str_charAt,            1,GENERIC_PRIMITIVE, str_charAt_trcinfo),
     JS_TN("charCodeAt",        str_charCodeAt,        1,GENERIC_PRIMITIVE, str_charCodeAt_trcinfo),
     JS_FN("indexOf",           str_indexOf,           1,GENERIC_PRIMITIVE),
diff -r a4343d61f6ee js/src/jstracer.cpp
--- a/js/src/jstracer.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jstracer.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -90,34 +90,43 @@ static const char typeChar[] = "OIDVS?B?
 
 /* Number of times we wait to exit on a side exit before we try to extend the tree. */
 #define HOTEXIT 1
 
 /* Max call depths for inlining. */
 #define MAX_CALLDEPTH 10
 
 /* Max number of type mismatchs before we trash the tree. */
-#define MAX_MISMATCH 5
+#define MAX_MISMATCH 20
+
+/* Max blacklist level of inner tree immediate recompiling  */
+#define MAX_INNER_RECORD_BLACKLIST  -16
 
 /* Max native stack size. */
 #define MAX_NATIVE_STACK_SLOTS 1024
 
 /* Max call stack size. */
 #define MAX_CALL_STACK_ENTRIES 64
 
 /* Max number of branches per tree. */
 #define MAX_BRANCHES 16
 
-#ifdef DEBUG
+/* Macros for demote slot lists */
+#define ALLOCA_UNDEMOTE_SLOTLIST(num)     (unsigned*)alloca(((num) + 1) * sizeof(unsigned))
+#define ADD_UNDEMOTE_SLOT(list, slot)     list[++list[0]] = slot
+#define NUM_UNDEMOTE_SLOTS(list)          list[0]
+#define CLEAR_UNDEMOTE_SLOTLIST(list)     list[0] = 0
+
+#ifdef JS_JIT_SPEW
 #define ABORT_TRACE(msg)   do { debug_only_v(fprintf(stdout, "abort: %d: %s\n", __LINE__, msg);)  return false; } while (0)
 #else
 #define ABORT_TRACE(msg)   return false
 #endif
 
-#ifdef DEBUG
+#ifdef JS_JIT_SPEW
 struct __jitstats {
 #define JITSTAT(x) uint64 x;
 #include "jitstats.tbl"
 #undef JITSTAT
 } jitstats = { 0LL, };
 
 JS_STATIC_ASSERT(sizeof(jitstats) % sizeof(uint64) == 0);
 
@@ -151,17 +160,17 @@ jitstats_getProperty(JSContext *cx, JSOb
     if (JSVAL_IS_INT(id))
         index = JSVAL_TO_INT(id);
 
     uint64 result = 0;
     switch (index) {
 #define JITSTAT(x) case STAT ## x ## ID: result = jitstats.x; break;
 #include "jitstats.tbl"
 #undef JITSTAT
-    default:
+      default:
         *vp = JSVAL_VOID;
         return JS_TRUE;
     }
 
     if (result < JSVAL_INT_MAX) {
         *vp = INT_TO_JSVAL(result);
         return JS_TRUE;
     }
@@ -185,45 +194,54 @@ js_InitJITStatsClass(JSContext *cx, JSOb
 js_InitJITStatsClass(JSContext *cx, JSObject *glob)
 {
     JS_InitClass(cx, glob, NULL, &jitstats_class, NULL, 0, jitstats_props, NULL, NULL, NULL);
 }
 
 #define AUDIT(x) (jitstats.x++)
 #else
 #define AUDIT(x) ((void)0)
-#endif
+#endif /* JS_JIT_SPEW */
 
 #define INS_CONST(c)    addName(lir->insImm(c), #c)
 #define INS_CONSTPTR(p) addName(lir->insImmPtr((void*) (p)), #p)
 
 using namespace avmplus;
 using namespace nanojit;
 
 static GC gc = GC();
 static avmplus::AvmCore s_core = avmplus::AvmCore();
 static avmplus::AvmCore* core = &s_core;
 
+#ifdef JS_JIT_SPEW
+void
+js_DumpPeerStability(Fragmento* frago, const void* ip);
+#endif
+
 /* We really need a better way to configure the JIT. Shaver, where is my fancy JIT object? */
 static bool nesting_enabled = true;
-static bool oracle_enabled = true;
 #if defined(NANOJIT_IA32)
 static bool did_we_check_sse2 = false;
 #endif
 
-#if defined(DEBUG) || defined(INCLUDE_VERBOSE_OUTPUT)
+#ifdef JS_JIT_SPEW
 static bool verbose_debug = getenv("TRACEMONKEY") && strstr(getenv("TRACEMONKEY"), "verbose");
 #define debug_only_v(x) if (verbose_debug) { x; }
 #else
 #define debug_only_v(x)
 #endif
 
 /* The entire VM shares one oracle. Collisions and concurrent updates are tolerated and worst
    case cause performance regressions. */
 static Oracle oracle;
+
+/* Blacklists the root peer fragment at a fragment's PC.  This is so blacklisting stays at the 
+   top of the peer list and not scattered around. */
+void
+js_BlacklistPC(Fragmento* frago, Fragment* frag);
 
 Tracker::Tracker()
 {
     pagelist = 0;
 }
 
 Tracker::~Tracker()
 {
@@ -321,17 +339,17 @@ static inline bool isInt32(jsval v)
     jsdouble d = asNumber(v);
     jsint i;
     return JSDOUBLE_IS_INT(d, i);
 }
 
 /* Return JSVAL_DOUBLE for all numbers (int and double) and the tag otherwise. */
 static inline uint8 getPromotedType(jsval v) 
 {
-    return JSVAL_IS_INT(v) ? JSVAL_DOUBLE : JSVAL_TAG(v);
+    return JSVAL_IS_INT(v) ? JSVAL_DOUBLE : uint8(JSVAL_TAG(v));
 }
 
 /* Return JSVAL_INT for all whole numbers that fit into signed 32-bit and the tag otherwise. */
 static inline uint8 getCoercedType(jsval v)
 {
     return isInt32(v) ? JSVAL_INT : (uint8) JSVAL_TAG(v);
 }
 
@@ -341,17 +359,17 @@ Oracle::markGlobalSlotUndemotable(JSScri
 {
     _dontDemote.set(&gc, (slot % ORACLE_SIZE));
 }
 
 /* Consult with the oracle whether we shouldn't demote a certain global variable. */
 bool
 Oracle::isGlobalSlotUndemotable(JSScript* script, unsigned slot) const
 {
-    return !oracle_enabled || _dontDemote.get(slot % ORACLE_SIZE);
+    return _dontDemote.get(slot % ORACLE_SIZE);
 }
 
 /* Tell the oracle that a certain slot at a certain bytecode location should not be demoted. */
 void
 Oracle::markStackSlotUndemotable(JSScript* script, jsbytecode* ip, unsigned slot)
 {
     uint32 hash = uint32(intptr_t(ip)) + (slot << 5);
     hash %= ORACLE_SIZE;
@@ -359,17 +377,17 @@ Oracle::markStackSlotUndemotable(JSScrip
 }
 
 /* Consult with the oracle whether we shouldn't demote a certain slot. */
 bool
 Oracle::isStackSlotUndemotable(JSScript* script, jsbytecode* ip, unsigned slot) const
 {
     uint32 hash = uint32(intptr_t(ip)) + (slot << 5);
     hash %= ORACLE_SIZE;
-    return !oracle_enabled || _dontDemote.get(hash);
+    return _dontDemote.get(hash);
 }
 
 /* Clear the oracle. */
 void
 Oracle::clear()
 {
     _dontDemote.reset();
 }
@@ -766,17 +784,17 @@ public:
                 return callArgN(s0, 0);
         }
         return out->insCall(ci, args);
     }
 };
 
 /* In debug mode vpname contains a textual description of the type of the
    slot during the forall iteration over al slots. */
-#if defined(DEBUG) || defined(INCLUDE_VERBOSE_OUTPUT)
+#ifdef JS_JIT_SPEW
 #define DEF_VPNAME          const char* vpname; unsigned vpnum
 #define SET_VPNAME(name)    do { vpname = name; vpnum = 0; } while(0)
 #define INC_VPNUM()         do { ++vpnum; } while(0)
 #else
 #define DEF_VPNAME          do {} while (0)
 #define vpname ""
 #define vpnum 0
 #define SET_VPNAME(name)    ((void)0)
@@ -926,16 +944,17 @@ TypeMap::captureStackTypes(JSContext* cx
     uint8* map = data();
     uint8* m = map;
     FORALL_SLOTS_IN_PENDING_FRAMES(cx, callDepth,
         uint8 type = getCoercedType(*vp);
         if ((type == JSVAL_INT) &&
             oracle.isStackSlotUndemotable(cx->fp->script, cx->fp->regs->pc, unsigned(m - map))) {
             type = JSVAL_DOUBLE;
         }
+        debug_only_v(printf("capture %s%d: %d\n", vpname, vpnum, type);)
         *m++ = type;
     );
 }
 
 /* Compare this type map to another one and see whether they match. */
 bool
 TypeMap::matches(TypeMap& other) const
 {
@@ -955,43 +974,43 @@ mergeTypeMaps(uint8** partial, unsigned*
     memcpy(mem + l, complete + l, (clength - l) * sizeof(uint8));
     *partial = mem;
     *plength = clength;
 }
 
 static void
 js_TrashTree(JSContext* cx, Fragment* f);
 
-TraceRecorder::TraceRecorder(JSContext* cx, SideExit* _anchor, Fragment* _fragment,
+TraceRecorder::TraceRecorder(JSContext* cx, VMSideExit* _anchor, Fragment* _fragment,
         TreeInfo* ti, unsigned ngslots, uint8* globalTypeMap, uint8* stackTypeMap,
-        SideExit* innermostNestedGuard)
+        VMSideExit* innermostNestedGuard, Fragment* outerToBlacklist)
 {
     JS_ASSERT(!_fragment->vmprivate && ti);
 
     this->cx = cx;
     this->traceMonitor = &JS_TRACE_MONITOR(cx);
     this->globalObj = JS_GetGlobalForObject(cx, cx->fp->scopeChain);
     this->anchor = _anchor;
     this->fragment = _fragment;
     this->lirbuf = _fragment->lirbuf;
     this->treeInfo = ti;
-    this->callDepth = _fragment->calldepth;
-    JS_ASSERT(!_anchor || _anchor->calldepth == _fragment->calldepth);
+    this->callDepth = _anchor ? _anchor->calldepth : 0;
     this->atoms = cx->fp->script->atomMap.vector;
     this->deepAborted = false;
     this->applyingArguments = false;
     this->trashTree = false;
     this->whichTreeToTrash = _fragment->root;
     this->global_dslots = this->globalObj->dslots;
     this->terminate = false;
-    this->isRootFragment = _fragment == _fragment->root;
-
-    debug_only_v(printf("recording starting from %s:%u@%u\n", cx->fp->script->filename,
-                        js_PCToLineNumber(cx, cx->fp->script, cx->fp->regs->pc),
-                        cx->fp->regs->pc - cx->fp->script->code););
+    this->outerToBlacklist = outerToBlacklist;
+
+    debug_only_v(printf("recording starting from %s:%u@%u\n",
+                        cx->fp->script->filename,
+                        js_FramePCToLineNumber(cx, cx->fp),
+                        FramePCOffset(cx->fp));)
     debug_only_v(printf("globalObj=%p, shape=%d\n", this->globalObj, OBJ_SHAPE(this->globalObj));)
 
     lir = lir_buf_writer = new (&gc) LirBufWriter(lirbuf);
 #ifdef DEBUG
     if (verbose_debug)
         lir = verbose_filter = new (&gc) VerboseWriter(&gc, lir, lirbuf->names);
 #endif
 #ifdef NJ_SOFTFLOAT
@@ -1020,45 +1039,46 @@ TraceRecorder::TraceRecorder(JSContext* 
     if (_anchor && _anchor->exitType == NESTED_EXIT) {
         LIns* nested_ins = addName(lir->insLoad(LIR_ldp, lirbuf->state, 
                                                 offsetof(InterpState, lastTreeExitGuard)), 
                                                 "lastTreeExitGuard");
         guard(true, lir->ins2(LIR_eq, nested_ins, INS_CONSTPTR(innermostNestedGuard)), NESTED_EXIT);
     }
 }
 
+TreeInfo::~TreeInfo()
+{
+    UnstableExit* temp;
+
+    while (unstableExits) {
+        temp = unstableExits->next;
+        delete unstableExits;
+        unstableExits = temp;
+    }
+}
+
 TraceRecorder::~TraceRecorder()
 {
-    JS_ASSERT(treeInfo);
-    if (fragment) {
-        if (isRootFragment && !fragment->root->code()) {
-            JS_ASSERT(!fragment->root->vmprivate);
-            delete treeInfo;
-        }
-        if (trashTree)
-            js_TrashTree(cx, whichTreeToTrash);
-    } else if (isRootFragment) {
+    JS_ASSERT(treeInfo && fragment);
+    if (fragment == fragment->root && !fragment->root->code()) {
+        JS_ASSERT(!fragment->root->vmprivate);
         delete treeInfo;
     }
+    if (trashTree)
+        js_TrashTree(cx, whichTreeToTrash);
 #ifdef DEBUG
     delete verbose_filter;
 #endif
     delete cse_filter;
     delete expr_filter;
     delete func_filter;
 #ifdef NJ_SOFTFLOAT
     delete float_filter;
 #endif
     delete lir_buf_writer;
-}
-
-void
-TraceRecorder::safeCleanup()
-{
-    fragment = NULL;
 }
 
 /* Add debug information to a LIR instruction as we emit it. */
 inline LIns*
 TraceRecorder::addName(LIns* ins, const char* name)
 {
 #ifdef DEBUG
     lirbuf->names->addName(ins, name);
@@ -1167,136 +1187,117 @@ done:
    execution. */
 void
 TraceRecorder::trackNativeStackUse(unsigned slots)
 {
     if (slots > treeInfo->maxNativeStackSlots)
         treeInfo->maxNativeStackSlots = slots;
 }
 
-/* Unbox a jsval into a slot. Slots are wide enough to hold double values
-   directly (instead of storing a pointer to them). */
-static bool
+/* Unbox a jsval into a slot. Slots are wide enough to hold double values directly (instead of 
+   storing a pointer to them). We now assert instead of type checking, the caller must ensure the 
+   types are compatible. */
+static void
 ValueToNative(JSContext* cx, jsval v, uint8 type, double* slot)
 {
     unsigned tag = JSVAL_TAG(v);
     switch (type) {
       case JSVAL_INT:
         jsint i;
         if (JSVAL_IS_INT(v))
             *(jsint*)slot = JSVAL_TO_INT(v);
         else if ((tag == JSVAL_DOUBLE) && JSDOUBLE_IS_INT(*JSVAL_TO_DOUBLE(v), i))
             *(jsint*)slot = i;
-        else if (v == JSVAL_VOID)
-            *(jsint*)slot = 0;
-        else {
-            debug_only_v(printf("int != tag%lu(value=%lu) ", JSVAL_TAG(v), v);)
-            return false;
-        }
+        else
+            JS_ASSERT(JSVAL_IS_INT(v));
         debug_only_v(printf("int<%d> ", *(jsint*)slot);)
-        return true;
+        return;
       case JSVAL_DOUBLE:
         jsdouble d;
         if (JSVAL_IS_INT(v))
             d = JSVAL_TO_INT(v);
-        else if (tag == JSVAL_DOUBLE)
+        else
             d = *JSVAL_TO_DOUBLE(v);
-        else if (v == JSVAL_VOID)
-            d = js_NaN;
-        else {
-            debug_only_v(printf("double != tag%lu ", JSVAL_TAG(v));)
-            return false;
-        }
+        JS_ASSERT(JSVAL_IS_INT(v) || JSVAL_IS_DOUBLE(v));
         *(jsdouble*)slot = d;
         debug_only_v(printf("double<%g> ", d);)
-        return true;
+        return;
       case JSVAL_BOOLEAN:
-        if (tag != JSVAL_BOOLEAN) {
-             debug_only_v(printf("bool != tag%u ", tag);)
-             return false;
-        }
+        JS_ASSERT(tag == JSVAL_BOOLEAN);
         *(JSBool*)slot = JSVAL_TO_BOOLEAN(v);
         debug_only_v(printf("boolean<%d> ", *(JSBool*)slot);)
-        return true;
+        return;
       case JSVAL_STRING:
         if (v == JSVAL_VOID) {
             *(JSString**)slot = ATOM_TO_STRING(cx->runtime->atomState.typeAtoms[JSTYPE_VOID]); 
-            return true;
+            return;
         } 
-        if (tag != JSVAL_STRING) {
-            debug_only_v(printf("string != tag%u ", tag);)
-            return false;
-        }
+        JS_ASSERT(tag == JSVAL_STRING);
         *(JSString**)slot = JSVAL_TO_STRING(v);
         debug_only_v(printf("string<%p> ", *(JSString**)slot);)
-        return true;
+        return;
       default:
         /* Note: we should never see JSVAL_BOXED in an entry type map. */
         JS_ASSERT(type == JSVAL_OBJECT);
-        if (v == JSVAL_VOID) {
-            *(JSObject**)slot = NULL;
-            return true;
-        }
-        if (tag != JSVAL_OBJECT) {
-            debug_only_v(printf("object != tag%u ", tag);)
-            return false;
-        }
+        JS_ASSERT(tag == JSVAL_OBJECT);
         *(JSObject**)slot = JSVAL_TO_OBJECT(v);
         debug_only_v(printf("object<%p:%s> ", JSVAL_TO_OBJECT(v),
                             JSVAL_IS_NULL(v)
                             ? "null"
                             : STOBJ_GET_CLASS(JSVAL_TO_OBJECT(v))->name);)
-        return true;
-    }
-}
-
-/* We maintain an emergency reserve pool of doubles so we can recover safely if a trace runs
+        return;
+    }
+}
+
+/* We maintain an emergency recovery pool of doubles so we can recover safely if a trace runs
    out of memory (doubles or objects). */
 static jsval
-AllocateDoubleFromReservePool(JSContext* cx)
+AllocateDoubleFromRecoveryPool(JSContext* cx)
 {
     JSTraceMonitor* tm = &JS_TRACE_MONITOR(cx);
     JS_ASSERT(tm->recoveryDoublePoolPtr > tm->recoveryDoublePool);
     return *--tm->recoveryDoublePoolPtr;
 }
 
 static bool
-ReplenishReservePool(JSContext* cx, JSTraceMonitor* tm, bool& didGC)
+js_ReplenishRecoveryPool(JSContext* cx, JSTraceMonitor* tm)
 {
     /* We should not be called with a full pool. */
     JS_ASSERT((size_t) (tm->recoveryDoublePoolPtr - tm->recoveryDoublePool) <
               MAX_NATIVE_STACK_SLOTS);
 
     /*
      * When the GC runs in js_NewDoubleInRootedValue, it resets
-     * tm->recoveryDoublePoolPtr back to tm->recoveryDoublePool. We tolerate
-     * that only once.
+     * tm->recoveryDoublePoolPtr back to tm->recoveryDoublePool. 
      */
     JSRuntime* rt = cx->runtime;
     uintN gcNumber = rt->gcNumber;
-    didGC = false;
-    for (; tm->recoveryDoublePoolPtr < tm->recoveryDoublePool + MAX_NATIVE_STACK_SLOTS;
-         ++tm->recoveryDoublePoolPtr) {
-        if (!js_NewDoubleInRootedValue(cx, 0.0, tm->recoveryDoublePoolPtr)) {
-            didGC = true;
+    jsval* ptr = tm->recoveryDoublePoolPtr; 
+    while (ptr < tm->recoveryDoublePool + MAX_NATIVE_STACK_SLOTS) {
+        if (!js_NewDoubleInRootedValue(cx, 0.0, ptr)) 
+            goto oom;
+        if (rt->gcNumber != gcNumber) {
             JS_ASSERT(tm->recoveryDoublePoolPtr == tm->recoveryDoublePool);
-            return false;
-        }
-        if (tm->recoveryDoublePoolPtr == tm->recoveryDoublePool) {
-            if (gcNumber != rt->gcNumber) {
-                if (didGC)
-                    return false;
-                didGC = true;
-            }
-        } else {
-            JS_ASSERT(rt->gcNumber == gcNumber ||
-                      (rt->gcNumber - gcNumber == (unsigned) 1 && didGC));
-        }
-    }
-    return true;
+            ptr = tm->recoveryDoublePool;
+            if (uintN(rt->gcNumber - gcNumber) > uintN(1))
+                goto oom;
+            continue;
+        }
+        ++ptr;
+    }
+    tm->recoveryDoublePoolPtr = ptr;
+    return true;
+
+oom:
+    /*
+     * Already massive GC pressure, no need to hold doubles back.
+     * We won't run any native code anyway.
+     */
+    tm->recoveryDoublePoolPtr = tm->recoveryDoublePool;
+    return false;
 }
 
 /* Box a value from the native stack back into the jsval format. Integers
    that are too large to fit into a jsval are automatically boxed into
    heap-allocated doubles. */
 static bool
 NativeToValue(JSContext* cx, jsval& v, uint8 type, double* slot)
 {
@@ -1328,17 +1329,17 @@ NativeToValue(JSContext* cx, jsval& v, u
         if (cx->doubleFreeList) {
 #ifdef DEBUG
             bool ok =
 #endif
                 js_NewDoubleInRootedValue(cx, d, &v);
             JS_ASSERT(ok);
             return true;
         }
-        v = AllocateDoubleFromReservePool(cx);
+        v = AllocateDoubleFromRecoveryPool(cx);
         JS_ASSERT(JSVAL_IS_DOUBLE(v) && *JSVAL_TO_DOUBLE(v) == 0.0);
         *JSVAL_TO_DOUBLE(v) = d;
         return true;
       }
       case JSVAL_STRING:
         v = STRING_TO_JSVAL(*(JSString**)slot);
         JS_ASSERT(JSVAL_TAG(v) == JSVAL_STRING); /* if this fails the pointer was not aligned */
         debug_only_v(printf("string<%p> ", *(JSString**)slot);)
@@ -1355,45 +1356,39 @@ NativeToValue(JSContext* cx, jsval& v, u
                             JSVAL_IS_NULL(v)
                             ? "null"
                             : STOBJ_GET_CLASS(JSVAL_TO_OBJECT(v))->name);)
         break;
     }
     return true;
 }
 
-/* Attempt to unbox the given list of interned globals onto the native global frame, checking
-   along the way that the supplied type-mao holds. */
-static bool
+/* Attempt to unbox the given list of interned globals onto the native global frame. */
+static void
 BuildNativeGlobalFrame(JSContext* cx, unsigned ngslots, uint16* gslots, uint8* mp, double* np)
 {
     debug_only_v(printf("global: ");)
     FORALL_GLOBAL_SLOTS(cx, ngslots, gslots,
-        if (!ValueToNative(cx, *vp, *mp, np + gslots[n]))
-            return false;
+        ValueToNative(cx, *vp, *mp, np + gslots[n]);
         ++mp;
     );
     debug_only_v(printf("\n");)
-    return true;
-}
-
-/* Attempt to unbox the given JS frame onto a native frame, checking along the way that the
-   supplied type-map holds. */
-static bool
+}
+
+/* Attempt to unbox the given JS frame onto a native frame. */
+static void
 BuildNativeStackFrame(JSContext* cx, unsigned callDepth, uint8* mp, double* np)
 {
     debug_only_v(printf("stack: ");)
     FORALL_SLOTS_IN_PENDING_FRAMES(cx, callDepth,
         debug_only_v(printf("%s%u=", vpname, vpnum);)
-        if (!ValueToNative(cx, *vp, *mp, np))
-            return false;
+        ValueToNative(cx, *vp, *mp, np);
         ++mp; ++np;
     );
     debug_only_v(printf("\n");)
-    return true;
 }
 
 /* Box the given native frame into a JS frame. This only fails due to a hard error
    (out of memory for example). */
 static int
 FlushNativeGlobalFrame(JSContext* cx, unsigned ngslots, uint16* gslots, uint8* mp, double* np)
 {
     uint8* mp_base = mp;
@@ -1517,17 +1512,18 @@ TraceRecorder::import(LIns* base, ptrdif
 
     if (mark)
         JS_ARENA_RELEASE(&cx->tempPool, mark);
     addName(ins, name);
 
     static const char* typestr[] = {
         "object", "int", "double", "3", "string", "5", "boolean", "any"
     };
-    debug_only_v(printf("import vp=%p name=%s type=%s flags=%d\n", p, name, typestr[t & 7], t >> 3););
+    debug_only_v(printf("import vp=%p name=%s type=%s flags=%d\n",
+                        p, name, typestr[t & 7], t >> 3);)
 #endif
 }
 
 void
 TraceRecorder::import(TreeInfo* treeInfo, LIns* sp, unsigned ngslots, unsigned callDepth,
                       uint8* globalTypeMap, uint8* stackTypeMap)
 {
     /* If we get a partial list that doesn't have all the types (i.e. recording from a side
@@ -1687,112 +1683,148 @@ js_IsLoopExit(jsbytecode* pc, jsbytecode
     return false;
 }
 
 /* Determine whether the current branch is a loop edge (taken or not taken). */
 static bool
 js_IsLoopEdge(jsbytecode* pc, jsbytecode* header)
 {
     switch (*pc) {
-    case JSOP_IFEQ:
-    case JSOP_IFNE:
+      case JSOP_IFEQ:
+      case JSOP_IFNE:
         return ((pc + GET_JUMP_OFFSET(pc)) == header);
-    case JSOP_IFEQX:
-    case JSOP_IFNEX:
+      case JSOP_IFEQX:
+      case JSOP_IFNEX:
         return ((pc + GET_JUMPX_OFFSET(pc)) == header);
-    default:
+      default:
         JS_ASSERT((*pc == JSOP_AND) || (*pc == JSOP_ANDX) || 
                   (*pc == JSOP_OR) || (*pc == JSOP_ORX));
     }
     return false;
 }
 
 /* Promote slots if necessary to match the called tree' type map and report error if thats
    impossible. */
 bool
-TraceRecorder::adjustCallerTypes(Fragment* f)
+TraceRecorder::adjustCallerTypes(Fragment* f, unsigned* demote_slots, bool& trash)
 {
     JSTraceMonitor* tm = traceMonitor;
     uint8* m = tm->globalTypeMap->data();
     uint16* gslots = traceMonitor->globalSlots->data();
     unsigned ngslots = traceMonitor->globalSlots->length();
-    JSScript* script = ((TreeInfo*)f->vmprivate)->script;
     uint8* map = ((TreeInfo*)f->vmprivate)->stackTypeMap.data();
     bool ok = true;
+    trash = false;
     FORALL_GLOBAL_SLOTS(cx, ngslots, gslots, 
         LIns* i = get(vp);
         bool isPromote = isPromoteInt(i);
         if (isPromote && *m == JSVAL_DOUBLE) 
             lir->insStorei(get(vp), gp_ins, nativeGlobalOffset(vp));
         else if (!isPromote && *m == JSVAL_INT) {
-            oracle.markGlobalSlotUndemotable(script, nativeGlobalOffset(vp)/sizeof(double));
+            oracle.markGlobalSlotUndemotable(cx->fp->script, nativeGlobalOffset(vp)/sizeof(double));
+            trash = true;
             ok = false;
         }
         ++m;
     );
     m = map;
     FORALL_SLOTS_IN_PENDING_FRAMES(cx, 0,
         LIns* i = get(vp);
         bool isPromote = isPromoteInt(i);
-        if (isPromote && *m == JSVAL_DOUBLE) 
+        if (isPromote && *m == JSVAL_DOUBLE) {
             lir->insStorei(get(vp), lirbuf->sp, 
                            -treeInfo->nativeStackBase + nativeStackOffset(vp));
-        else if (!isPromote && *m == JSVAL_INT) {
-            oracle.markStackSlotUndemotable(script, (jsbytecode*)f->root->ip, unsigned(m - map));
+            /* Aggressively undo speculation so the inner tree will compile if this fails. */
+            ADD_UNDEMOTE_SLOT(demote_slots, unsigned(m - map));
+        } else if (!isPromote && *m == JSVAL_INT) {
+            debug_only_v(printf("adjusting will fail, %s%d, slot %d\n", vpname, vpnum, m - map);)
             ok = false;
+            ADD_UNDEMOTE_SLOT(demote_slots, unsigned(m - map));
+        } else if (JSVAL_IS_INT(*vp) && *m == JSVAL_DOUBLE) {
+            /* Aggressively undo speculation so the inner tree will compile if this fails. */
+            ADD_UNDEMOTE_SLOT(demote_slots, unsigned(m - map));
         }
         ++m;
     );
+    /* If this isn't okay, tell the oracle. */
+    if (!ok) {
+        for (unsigned i = 1; i <= NUM_UNDEMOTE_SLOTS(demote_slots); i++)
+            oracle.markStackSlotUndemotable(cx->fp->script, cx->fp->regs->pc, demote_slots[i]);
+    }
     JS_ASSERT(f == f->root);
-    if (!ok) {
-        trashTree = true;
-        whichTreeToTrash = f;
-    }
     return ok;
-}
-
-/* Find a peer fragment that we can call, considering our current type distribution. */
-bool TraceRecorder::selectCallablePeerFragment(Fragment** first)
-{
-    /* Until we have multiple trees per start point this is always the first fragment. */
-    return (*first)->code();
 }
 
 uint8 
 TraceRecorder::determineSlotType(jsval* vp) const
 {
     uint8 m;
     LIns* i = get(vp);
     m = isNumber(*vp)
         ? (isPromoteInt(i) ? JSVAL_INT : JSVAL_DOUBLE)
         : JSVAL_TAG(*vp);
     JS_ASSERT((m != JSVAL_INT) || isInt32(*vp));
     return m;
 }
 
+#define IMACRO_PC_ADJ_BITS   8
+#define SCRIPT_PC_ADJ_BITS   (32 - IMACRO_PC_ADJ_BITS)
+
+// The stored imacro_pc_adj byte offset is biased by 1.
+#define IMACRO_PC_ADJ_LIMIT  (JS_BIT(IMACRO_PC_ADJ_BITS) - 1)
+#define SCRIPT_PC_ADJ_LIMIT  JS_BIT(SCRIPT_PC_ADJ_BITS)
+
+#define IMACRO_PC_ADJ(ip)    ((uintptr_t)(ip) >> SCRIPT_PC_ADJ_BITS)
+#define SCRIPT_PC_ADJ(ip)    ((ip) & JS_BITMASK(SCRIPT_PC_ADJ_BITS))
+
+#define FI_SCRIPT_PC(fi,fp)  ((fp)->script->code + SCRIPT_PC_ADJ((fi).ip_adj))
+
+#define FI_IMACRO_PC(fi,fp)  (IMACRO_PC_ADJ((fi).ip_adj)                      \
+                              ? imacro_code[*FI_SCRIPT_PC(fi, fp)] +          \
+                                IMACRO_PC_ADJ((fi).ip_adj)                    \
+                              : NULL)
+
+#define IMACRO_PC_OK(fp,pc)  JS_ASSERT(uintN((pc)-imacro_code[*(fp)->imacpc]) \
+                                       < JS_BIT(IMACRO_PC_ADJ_BITS))
+#define ENCODE_IP_ADJ(fp,pc) ((fp)->imacpc                                    \
+                              ? (IMACRO_PC_OK(fp, pc),                        \
+                                 (((pc) - imacro_code[*(fp)->imacpc])         \
+                                  << SCRIPT_PC_ADJ_BITS) +                    \
+                                 (fp)->imacpc - (fp)->script->code)           \
+                              : (pc) - (fp)->script->code)
+
+#define DECODE_IP_ADJ(ip,fp) (IMACRO_PC_ADJ(ip)                               \
+                              ? (fp)->imacpc = (fp)->script->code +           \
+                                               SCRIPT_PC_ADJ(ip),             \
+                                (fp)->regs->pc = imacro_code[*(fp)->imacpc] + \
+                                                 IMACRO_PC_ADJ(ip)            \
+                              : (fp)->regs->pc = (fp)->script->code + (ip))
+
+static jsbytecode* imacro_code[JSOP_LIMIT];
+
 LIns*
 TraceRecorder::snapshot(ExitType exitType)
 {
     JSStackFrame* fp = cx->fp;
     JSFrameRegs* regs = fp->regs;
     jsbytecode* pc = regs->pc;
     if (exitType == BRANCH_EXIT && js_IsLoopExit(pc, (jsbytecode*)fragment->root->ip))
         exitType = LOOP_EXIT;
 
     /* Check for a return-value opcode that needs to restart at the next instruction. */
     const JSCodeSpec& cs = js_CodeSpec[*pc];
 
     /* WARNING: don't return before restoring the original pc if (resumeAfter). */
     bool resumeAfter = (pendingTraceableNative &&
                         JSTN_ERRTYPE(pendingTraceableNative) == FAIL_JSVAL);
     if (resumeAfter) {
-        JS_ASSERT(cs.format & JOF_RETVAL);
+        JS_ASSERT(*pc == JSOP_CALL || *pc == JSOP_APPLY || *pc == JSOP_NEXTITER);
         pc += cs.length;
         regs->pc = pc;
-        MUST_FLOW_THROUGH(restore_pc);
+        MUST_FLOW_THROUGH("restore_pc");
     }
 
     /* Generate the entry map for the (possibly advanced) pc and stash it in the trace. */
     unsigned stackSlots = js_NativeStackSlots(cx, callDepth);
 
     /* It's sufficient to track the native stack use here since all stores above the
        stack watermark defined by guards are killed. */
     trackNativeStackUse(stackSlots + 1);
@@ -1806,68 +1838,69 @@ TraceRecorder::snapshot(ExitType exitTyp
     /* Determine the type of a store by looking at the current type of the actual value the
        interpreter is using. For numbers we have to check what kind of store we used last
        (integer or double) to figure out what the side exit show reflect in its typemap. */
     FORALL_SLOTS(cx, ngslots, traceMonitor->globalSlots->data(), callDepth,
         *m++ = determineSlotType(vp);
     );
     JS_ASSERT(unsigned(m - typemap) == ngslots + stackSlots);
 
-    /* If we are capturing the stack state on a JOF_RETVAL instruction, the value on top of
-       the stack is a boxed value. */
+    /* If we are capturing the stack state on a specific instruction, the value on or near
+       the top of the stack is a boxed value. Either pc[-cs.length] is JSOP_NEXTITER and we
+       want one below top of stack, or else it's JSOP_CALL and we want top of stack. */
     if (resumeAfter) {
-        m[-1] = JSVAL_BOXED;
+        m[(pc[-cs.length] == JSOP_NEXTITER) ? -2 : -1] = JSVAL_BOXED;
 
         /* Now restore the the original pc (after which early returns are ok). */
         MUST_FLOW_LABEL(restore_pc);
         regs->pc = pc - cs.length;
     } else {
         /* If we take a snapshot on a goto, advance to the target address. This avoids inner
            trees returning on a break goto, which the outer recorder then would confuse with
            a break in the outer tree. */
         if (*pc == JSOP_GOTO) 
             pc += GET_JUMP_OFFSET(pc);
         else if (*pc == JSOP_GOTOX)
             pc += GET_JUMPX_OFFSET(pc);
     }
-    int ip_adj = pc - (jsbytecode*)fragment->root->ip;
+    intptr_t ip_adj = ENCODE_IP_ADJ(fp, pc);
 
     /* Check if we already have a matching side exit. If so use that side exit structure,
        otherwise we have to create our own. */
-    SideExit** exits = treeInfo->sideExits.data();
+    VMSideExit** exits = treeInfo->sideExits.data();
     unsigned nexits = treeInfo->sideExits.length();
     if (exitType == LOOP_EXIT) {
         for (unsigned n = 0; n < nexits; ++n) {
-            SideExit* e = exits[n];
+            VMSideExit* e = exits[n];
             if (e->ip_adj == ip_adj && 
                 !memcmp(getTypeMap(exits[n]), typemap, typemap_size)) {
                 LIns* data = lir_buf_writer->skip(sizeof(GuardRecord));
                 GuardRecord* rec = (GuardRecord*)data->payload();
                 /* setup guard record structure with shared side exit */
                 memset(rec, 0, sizeof(GuardRecord));
-                SideExit* exit = exits[n];
+                VMSideExit* exit = exits[n];
                 rec->exit = exit;
                 exit->addGuard(rec);
                 AUDIT(mergedLoopExits);
                 return data;
             }
         }
     }
 
     /* We couldn't find a matching side exit, so create our own side exit structure. */
     LIns* data = lir_buf_writer->skip(sizeof(GuardRecord) +
-                                      sizeof(SideExit) + 
+                                      sizeof(VMSideExit) + 
                                       (stackSlots + ngslots) * sizeof(uint8));
     GuardRecord* rec = (GuardRecord*)data->payload();
-    SideExit* exit = (SideExit*)(rec + 1);
+    VMSideExit* exit = (VMSideExit*)(rec + 1);
     /* setup guard record structure */
     memset(rec, 0, sizeof(GuardRecord));
     rec->exit = exit;
     /* setup side exit structure */
-    memset(exit, 0, sizeof(SideExit));
+    memset(exit, 0, sizeof(VMSideExit));
     exit->from = fragment;
     exit->calldepth = callDepth;
     exit->numGlobalSlots = ngslots;
     exit->numStackSlots = stackSlots;
     exit->numStackSlotsBelowCurrentFrame = cx->fp->callee
         ? nativeStackOffset(&cx->fp->argv[-2])/sizeof(double)
         : 0;
     exit->exitType = exitType;
@@ -1884,178 +1917,496 @@ TraceRecorder::snapshot(ExitType exitTyp
     if (exitType == LOOP_EXIT)
         treeInfo->sideExits.add(exit);
     return data;
 }
 
 /* Emit a guard for condition (cond), expecting to evaluate to boolean result (expected)
    and using the supplied side exit if the conditon doesn't hold. */
 LIns*
-TraceRecorder::guard(bool expected, nanojit::LIns* cond, nanojit::LIns* exit)
+TraceRecorder::guard(bool expected, LIns* cond, LIns* exit)
 {
     return lir->insGuard(expected ? LIR_xf : LIR_xt, cond, exit);
 }
 
 /* Emit a guard for condition (cond), expecting to evaluate to boolean result (expected)
    and generate a side exit with type exitType to jump to if the condition does not hold. */
 LIns*
 TraceRecorder::guard(bool expected, LIns* cond, ExitType exitType)
 {
     return guard(expected, cond, snapshot(exitType));
 }
 
 /* Try to match the type of a slot to type t. checkType is used to verify that the type of
-   values flowing into the loop edge is compatible with the type we expect in the loop header. */
-bool
-TraceRecorder::checkType(jsval& v, uint8 t, bool& unstable)
+ * values flowing into the loop edge is compatible with the type we expect in the loop header.
+ *
+ * @param v             Value.
+ * @param t             Typemap entry for value.
+ * @param stage_val     Outparam for set() address.
+ * @param stage_ins     Outparam for set() instruction.
+ * @param stage_count   Outparam for set() buffer count.
+ * @return              True if types are compatible, false otherwise.
+ */
+bool
+TraceRecorder::checkType(jsval& v, uint8 t, jsval*& stage_val, LIns*& stage_ins, 
+                         unsigned& stage_count)
 {
     if (t == JSVAL_INT) { /* initially all whole numbers cause the slot to be demoted */
+        debug_only_v(printf("checkType(tag=1, t=%d, isnum=%d, i2f=%d) stage_count=%d\n", 
+                            t,
+                            isNumber(v),
+                            isPromoteInt(get(&v)),
+                            stage_count);)
         if (!isNumber(v))
             return false; /* not a number? type mismatch */
         LIns* i = get(&v);
-        if (!isPromoteInt(i)) {
-            debug_only_v(printf("int slot is !isInt32, slot #%d, triggering re-compilation\n",
-                                !isGlobal(&v)
-                                ? nativeStackOffset(&v)
-                                : nativeGlobalOffset(&v)););
-            AUDIT(slotPromoted);
-            unstable = true;
-            return true; /* keep checking types, but request re-compilation */
-        }
+        /* This is always a type mismatch, we can't close a double to an int. */
+        if (!isPromoteInt(i))
+            return false;
         /* Looks good, slot is an int32, the last instruction should be promotable. */
         JS_ASSERT(isInt32(v) && isPromoteInt(i));
         /* Overwrite the value in this slot with the argument promoted back to an integer. */
-        set(&v, f2i(i));
+        stage_val = &v;
+        stage_ins = f2i(i);
+        stage_count++;
         return true;
     }
     if (t == JSVAL_DOUBLE) {
+        debug_only_v(printf("checkType(tag=2, t=%d, isnum=%d, promote=%d) stage_count=%d\n",
+                            t,
+                            isNumber(v),
+                            isPromoteInt(get(&v)),
+                            stage_count);)
         if (!isNumber(v))
             return false; /* not a number? type mismatch */
         LIns* i = get(&v);
         /* We sink i2f conversions into the side exit, but at the loop edge we have to make
            sure we promote back to double if at loop entry we want a double. */
-        if (isPromoteInt(i)) 
-            set(&v, lir->ins1(LIR_i2f, i));
+        if (isPromoteInt(i)) {
+            stage_val = &v;
+            stage_ins = lir->ins1(LIR_i2f, i);
+            stage_count++;
+        }
         return true;
     }
     /* for non-number types we expect a precise match of the type */
 #ifdef DEBUG
     if (JSVAL_TAG(v) != t) {
         debug_only_v(printf("Type mismatch: val %c, map %c ", typeChar[JSVAL_TAG(v)],
-                            typeChar[t]););
-    }
-#endif
+                            typeChar[t]);)
+    }
+#endif
+    debug_only_v(printf("checkType(tag=%d, t=%d) stage_count=%d\n",
+                        (int) JSVAL_TAG(v), t, stage_count);)
     return JSVAL_TAG(v) == t;
 }
 
-/* Make sure that the current values in the given stack frame and all stack frames
-   up and including entryFrame are type-compatible with the entry map. */
-bool
-TraceRecorder::verifyTypeStability()
-{
+/**
+ * Make sure that the current values in the given stack frame and all stack frames
+ * up and including entryFrame are type-compatible with the entry map.
+ *
+ * @param root_peer         First fragment in peer list.
+ * @param stable_peer       Outparam for first type stable peer.
+ * @param trash             Whether to trash the tree (demotion).
+ * @param demotes           Array to store demotable stack slots.
+ * @return                  True if type stable, false otherwise.
+ */
+bool
+TraceRecorder::deduceTypeStability(Fragment* root_peer, Fragment** stable_peer, unsigned* demotes)
+{
+    uint8* m;
+    uint8* typemap;
     unsigned ngslots = traceMonitor->globalSlots->length();
     uint16* gslots = traceMonitor->globalSlots->data();
-    uint8* typemap = traceMonitor->globalTypeMap->data();
     JS_ASSERT(traceMonitor->globalTypeMap->length() == ngslots);
-    bool recompile = false;
-    uint8* m = typemap;
+
+    if (stable_peer)
+        *stable_peer = NULL;
+
+    CLEAR_UNDEMOTE_SLOTLIST(demotes);
+
+    /*
+     * Rather than calculate all of this stuff twice, it gets cached locally.  The "stage" buffers 
+     * are for calls to set() that will change the exit types.
+     */
+    bool success;
+    bool unstable_from_undemotes;
+    unsigned stage_count;
+    jsval** stage_vals = (jsval**)alloca(sizeof(jsval*) * (ngslots + treeInfo->stackTypeMap.length()));
+    LIns** stage_ins = (LIns**)alloca(sizeof(LIns*) * (ngslots + treeInfo->stackTypeMap.length()));
+
+    /* First run through and see if we can close ourselves - best case! */
+    stage_count = 0;
+    success = false;
+    unstable_from_undemotes = false;
+
+    debug_only_v(printf("Checking type stability against self=%p\n", fragment);)
+
+    m = typemap = traceMonitor->globalTypeMap->data();
     FORALL_GLOBAL_SLOTS(cx, ngslots, gslots,
-        bool demote = false;
-        if (!checkType(*vp, *m, demote))
-            return false;
-        if (demote) {
-            oracle.markGlobalSlotUndemotable(cx->fp->script, gslots[n]);
-            recompile = true;
-        }
-        ++m
-    );
-    typemap = treeInfo->stackTypeMap.data();
-    m = typemap;
-    FORALL_SLOTS_IN_PENDING_FRAMES(cx, callDepth,
-        bool demote = false;
-        if (!checkType(*vp, *m, demote))
-            return false;
-        if (demote) {
-            oracle.markStackSlotUndemotable(cx->fp->script, (jsbytecode*)fragment->root->ip,
-                    unsigned(m - typemap));
-            recompile = true;
-        }
-        ++m
-    );
-    if (recompile) 
-        trashTree = true;
-    return !recompile;
+        debug_only_v(printf("%s%d ", vpname, vpnum);)
+        if (!checkType(*vp, *m, stage_vals[stage_count], stage_ins[stage_count], stage_count)) {
+            /* If the failure was an int->double, tell the oracle. */
+            if (*m == JSVAL_INT && isNumber(*vp) && !isPromoteInt(get(vp)))
+                oracle.markGlobalSlotUndemotable(cx->fp->script, gslots[n]);
+            trashTree = true;
+            goto checktype_fail_1;
+        }
+        ++m;
+    );
+    m = typemap = treeInfo->stackTypeMap.data();
+    FORALL_SLOTS_IN_PENDING_FRAMES(cx, 0,
+        debug_only_v(printf("%s%d ", vpname, vpnum);)
+        if (!checkType(*vp, *m, stage_vals[stage_count], stage_ins[stage_count], stage_count)) {
+            if (*m == JSVAL_INT && isNumber(*vp) && !isPromoteInt(get(vp)))
+                ADD_UNDEMOTE_SLOT(demotes, unsigned(m - typemap));
+            else
+                goto checktype_fail_1;
+        }
+        ++m;
+    );
+
+    /*
+     * If there's an exit that's unstable because of undemotable slots, we want to search for 
+     * peers just in case we can make a connection.
+     */
+    if (NUM_UNDEMOTE_SLOTS(demotes))
+        unstable_from_undemotes = true;
+    else
+        success = true;
+
+checktype_fail_1:
+    /* If we got a success and we don't need to recompile, we should just close here. */
+    if (success) {
+        for (unsigned i = 0; i < stage_count; i++)
+            set(stage_vals[i], stage_ins[i]);
+        return true;
+    /* If we need to trash, don't bother checking peers. */
+    } else if (trashTree) {
+        return false;
+    } else {
+        CLEAR_UNDEMOTE_SLOTLIST(demotes);
+    }
+
+    /* At this point the tree is about to be incomplete, so let's see if we can connect to any 
+     * peer fragment that is type stable.
+     */
+    Fragment* f;
+    TreeInfo* ti;
+    for (f = root_peer; f != NULL; f = f->peer) {
+        debug_only_v(printf("Checking type stability against peer=%p (code=%p)\n", f, f->code());)
+        if (!f->code())
+            continue;
+        ti = (TreeInfo*)f->vmprivate;
+        /* Don't allow varying stack depths */
+        if (ti->stackTypeMap.length() != treeInfo->stackTypeMap.length())
+            continue;
+        stage_count = 0;
+        success = false;
+        m = ti->stackTypeMap.data();
+
+        FORALL_SLOTS_IN_PENDING_FRAMES(cx, 0,
+            if (!checkType(*vp, *m, stage_vals[stage_count], stage_ins[stage_count], stage_count))
+                goto checktype_fail_2;
+            ++m;
+        );
+
+        success = true;
+
+checktype_fail_2:
+        if (success) {
+            /*
+             * There was a successful match.  We don't care about restoring the saved staging, but 
+             * we do need to clear the original undemote list.
+             */
+            for (unsigned i = 0; i < stage_count; i++)
+                set(stage_vals[i], stage_ins[i]);
+            if (stable_peer)
+                *stable_peer = f;
+            return false;
+        }
+    }
+
+    JS_ASSERT(NUM_UNDEMOTE_SLOTS(demotes) == 0);
+
+    /*
+     * If this is a loop trace and it would be stable with demotions, build an undemote list 
+     * and return true.  Our caller should sniff this and trash the tree, recording a new one 
+     * that will assumedly stabilize.
+     */
+    if (unstable_from_undemotes && fragment->kind == LoopTrace) {
+        typemap = m = treeInfo->stackTypeMap.data();
+        FORALL_SLOTS_IN_PENDING_FRAMES(cx, 0,
+            if (*m == JSVAL_INT) {
+                JS_ASSERT(isNumber(*vp));
+                if (!isPromoteInt(get(vp)))
+                    ADD_UNDEMOTE_SLOT(demotes, unsigned(m - typemap));
+            } else if (*m == JSVAL_DOUBLE) {
+                JS_ASSERT(isNumber(*vp));
+                ADD_UNDEMOTE_SLOT(demotes, unsigned(m - typemap));
+            } else {
+                JS_ASSERT(*m == JSVAL_TAG(*vp));
+            }
+            m++;
+        );
+        return true;
+    }
+
+    return false;
 }
 
 /* Check whether the current pc location is the loop header of the loop this recorder records. */
 bool
 TraceRecorder::isLoopHeader(JSContext* cx) const
 {
     return cx->fp->regs->pc == fragment->root->ip;
 }
 
 /* Compile the current fragment. */
 void
 TraceRecorder::compile(Fragmento* fragmento)
 {
     if (treeInfo->maxNativeStackSlots >= MAX_NATIVE_STACK_SLOTS) {
         debug_only_v(printf("Trace rejected: excessive stack use.\n"));
-        fragment->blacklist();
+        js_BlacklistPC(fragmento, fragment);
         return;
     }
     ++treeInfo->branchCount;
+    if (lirbuf->outOmem()) {
+        fragmento->assm()->setError(nanojit::OutOMem);
+        return;
+    }
     ::compile(fragmento->assm(), fragment);
     if (anchor) 
         fragmento->assm()->patch(anchor);
+    if (fragmento->assm()->error() != nanojit::None)
+        return;
     JS_ASSERT(fragment->code());
     JS_ASSERT(!fragment->vmprivate);
     if (fragment == fragment->root)
         fragment->vmprivate = treeInfo;
     /* :TODO: windows support */
 #if defined DEBUG && !defined WIN32
-    char* label = (char*)malloc(strlen(cx->fp->script->filename) + 64);
+    char* label = (char*)malloc(strlen(cx->fp->script->filename) + 16);
     sprintf(label, "%s:%u", cx->fp->script->filename,
-            js_PCToLineNumber(cx, cx->fp->script, cx->fp->regs->pc));
+            js_FramePCToLineNumber(cx, cx->fp));
     fragmento->labels->add(fragment, sizeof(Fragment), 0, label);
     free(label);
 #endif
     AUDIT(traceCompleted);
 }
 
+static bool
+js_JoinPeersIfCompatible(Fragmento* frago, Fragment* stableFrag, TreeInfo* stableTree, 
+                         VMSideExit* exit)
+{
+    JS_ASSERT(exit->numStackSlots == stableTree->stackTypeMap.length());
+    /* Must have a matching type unstable exit. */
+    if (memcmp(getTypeMap(exit) + exit->numGlobalSlots,
+               stableTree->stackTypeMap.data(), 
+               stableTree->stackTypeMap.length()) != 0) {
+       return false; 
+    }
+
+    exit->target = stableFrag;
+    frago->assm()->patch(exit);
+
+    stableTree->dependentTrees.addUnique(exit->from->root);
+
+    return true;
+}
+
 /* Complete and compile a trace and link it to the existing tree if appropriate. */
-void
-TraceRecorder::closeLoop(Fragmento* fragmento)
-{
-    if (!verifyTypeStability()) {
+bool
+TraceRecorder::closeLoop(Fragmento* fragmento, bool& demote, unsigned *demotes)
+{
+    bool stable;
+    LIns* exitIns;
+    Fragment* peer;
+    VMSideExit* exit;
+    Fragment* peer_root;
+
+    demote = false;
+    
+    exitIns = snapshot(UNSTABLE_LOOP_EXIT);
+    exit = (VMSideExit*)((GuardRecord*)exitIns->payload())->exit;
+
+    if (callDepth != 0) {
+        debug_only_v(printf("Stack depth mismatch, possible recursion\n");)
+        js_BlacklistPC(fragmento, fragment);
+        trashTree = true;
+        return false;
+    }
+
+    JS_ASSERT(exit->numStackSlots == treeInfo->stackTypeMap.length());
+
+    peer_root = fragmento->getLoop(fragment->root->ip);
+    JS_ASSERT(peer_root != NULL);
+    stable = deduceTypeStability(peer_root, &peer, demotes);
+
+    #if DEBUG
+    if (!stable || NUM_UNDEMOTE_SLOTS(demotes))
         AUDIT(unstableLoopVariable);
-        debug_only_v(printf("Trace rejected: unstable loop variables.\n");)
-        if (!trashTree)
-            fragment->blacklist();
-        return;
-    }
-    LIns* skip = snapshot(LOOP_EXIT);
-    ((GuardRecord*)skip->payload())->exit->target = fragment->root;
-    fragment->lastIns = lir->insGuard(LIR_loop, lir->insImm(1), skip);
+    #endif
+
+    if (trashTree) {
+        debug_only_v(printf("Trashing tree from type instability.\n");)
+        return false;
+    }
+
+    if (stable && NUM_UNDEMOTE_SLOTS(demotes)) {
+        JS_ASSERT(fragment->kind == LoopTrace);
+        demote = true;
+        return false;
+    }
+
+    if (!stable) {
+        fragment->lastIns = lir->insGuard(LIR_x, lir->insImm(1), exitIns);
+
+        /*
+         * If we didn't find a type stable peer, we compile the loop anyway and
+         * hope it becomes stable later.
+         */
+        if (!peer) {
+            /*
+             * If such a fragment does not exist, let's compile the loop ahead
+             * of time anyway.  Later, if the loop becomes type stable, we will
+             * connect these two fragments together.
+             */
+            debug_only_v(printf("Trace has unstable loop variable with no stable peer, "
+                                "compiling anyway.\n");)
+            UnstableExit* uexit = new UnstableExit;
+            uexit->fragment = fragment;
+            uexit->exit = exit;
+            uexit->next = treeInfo->unstableExits;
+            treeInfo->unstableExits = uexit;
+
+            /*
+             * If we walked out of a loop, this exit is wrong. We need to back
+             * up to the if operation.
+             */
+            if (walkedOutOfLoop())
+                exit->ip_adj = terminate_ip_adj;
+
+            /* If we were trying to stabilize a promotable tree, trash it. */
+            if (promotedPeer)
+                js_TrashTree(cx, promotedPeer);
+        } else {
+            JS_ASSERT(peer->code());
+            exit->target = peer;
+            debug_only_v(printf("Joining type-unstable trace to target fragment %p.\n", peer);)
+            stable = true;
+            ((TreeInfo*)peer->vmprivate)->dependentTrees.addUnique(fragment);
+        }
+
+        compile(fragmento);
+    } else {
+        exit->target = fragment->root;
+        fragment->lastIns = lir->insGuard(LIR_loop, lir->insImm(1), exitIns);
+        compile(fragmento);
+    }
+
+    if (fragmento->assm()->error() != nanojit::None)
+        return false;
+
+    joinEdgesToEntry(fragmento, peer_root);
+
+    debug_only_v(printf("recording completed at %s:%u@%u via closeLoop\n",
+                        cx->fp->script->filename,
+                        js_FramePCToLineNumber(cx, cx->fp),
+                        FramePCOffset(cx->fp));)
+    return true;
+}
+
+void
+TraceRecorder::joinEdgesToEntry(Fragmento* fragmento, Fragment* peer_root)
+{
+    if (fragment->kind == LoopTrace) {
+        TreeInfo* ti;
+        Fragment* peer;
+        uint8* t1, *t2;
+        UnstableExit* uexit, **unext;
+
+        unsigned* demotes = (unsigned*)alloca(treeInfo->stackTypeMap.length() * sizeof(unsigned));
+        for (peer = peer_root; peer != NULL; peer = peer->peer) {
+            if (!peer->code())
+                continue;
+            ti = (TreeInfo*)peer->vmprivate;
+            uexit = ti->unstableExits;
+            unext = &ti->unstableExits;
+            while (uexit != NULL) {
+                bool remove = js_JoinPeersIfCompatible(fragmento, fragment, treeInfo, uexit->exit);
+                JS_ASSERT(!remove || fragment != peer);
+                debug_only_v(if (remove) { 
+                             printf("Joining type-stable trace to target exit %p->%p.\n", 
+                                    uexit->fragment, uexit->exit); });
+                if (!remove) {
+                    /* See if this exit contains mismatch demotions, which imply trashing a tree.
+                       This is actually faster than trashing the original tree as soon as the 
+                       instability is detected, since we could have compiled a fairly stable 
+                       tree that ran faster with integers. */
+                    unsigned count = 0;
+                    t1 = treeInfo->stackTypeMap.data();
+                    t2 = getTypeMap(uexit->exit) + uexit->exit->numGlobalSlots;
+                    for (unsigned i = 0; i < uexit->exit->numStackSlots; i++) {
+                        if (t2[i] == JSVAL_INT && t1[i] == JSVAL_DOUBLE) {
+                            demotes[count++] = i;
+                        } else if (t2[i] != t1[i]) {
+                            count = 0;
+                            break;
+                        }
+                    }
+                    if (count) {
+                        for (unsigned i = 0; i < count; i++)
+                            oracle.markStackSlotUndemotable(cx->fp->script, 
+                                                            cx->fp->regs->pc, demotes[i]);
+                        js_TrashTree(cx, uexit->fragment->root);
+                        break;
+                    }
+                }
+                if (remove) {
+                    *unext = uexit->next;
+                    delete uexit;
+                    uexit = *unext;
+                } else {
+                    unext = &uexit->next;
+                    uexit = uexit->next;
+                }
+            } 
+        } 
+    }
+
+    debug_only_v(js_DumpPeerStability(fragmento, peer_root->ip);)
+}
+
+/* Emit an always-exit guard and compile the tree (used for break statements. */
+void
+TraceRecorder::endLoop(Fragmento* fragmento)
+{
+    LIns* exitIns = snapshot(LOOP_EXIT);
+
+    if (callDepth != 0) {
+        debug_only_v(printf("Stack depth mismatch, possible recursion\n");)
+        js_BlacklistPC(fragmento, fragment);
+        trashTree = true;
+        return;
+    }
+
+    fragment->lastIns = lir->insGuard(LIR_x, lir->insImm(1), exitIns);
     compile(fragmento);
 
-    debug_only_v(printf("recording completed at %s:%u@%u via closeLoop\n", cx->fp->script->filename,
-                        js_PCToLineNumber(cx, cx->fp->script, cx->fp->regs->pc),
-                        cx->fp->regs->pc - cx->fp->script->code););
-}
-
-/* Emit an always-exit guard and compile the tree (used for break statements. */
-void
-TraceRecorder::endLoop(Fragmento* fragmento)
-{
-    fragment->lastIns = lir->insGuard(LIR_x, lir->insImm(1), snapshot(LOOP_EXIT));
-    compile(fragmento);
-
-    debug_only_v(printf("recording completed at %s:%u@%u via endLoop\n", cx->fp->script->filename,
-                        js_PCToLineNumber(cx, cx->fp->script, cx->fp->regs->pc),
-                        cx->fp->regs->pc - cx->fp->script->code););
+    if (fragmento->assm()->error() != nanojit::None)
+        return;
+
+    joinEdgesToEntry(fragmento, fragmento->getLoop(fragment->root->ip));
+
+    debug_only_v(printf("recording completed at %s:%u@%u via endLoop\n",
+                        cx->fp->script->filename,
+                        js_FramePCToLineNumber(cx, cx->fp),
+                        FramePCOffset(cx->fp));)
 }
 
 /* Emit code to adjust the stack to match the inner tree's stack expectations. */
 void
 TraceRecorder::prepareTreeCall(Fragment* inner)
 {
     TreeInfo* ti = (TreeInfo*)inner->vmprivate;
     inner_sp_ins = lirbuf->sp;
@@ -2090,17 +2441,17 @@ TraceRecorder::prepareTreeCall(Fragment*
                 lirbuf->state, offsetof(InterpState, sp));
         lir->insStorei(lir->ins2i(LIR_piadd, lirbuf->rp, rp_adj),
                 lirbuf->state, offsetof(InterpState, rp));
     }
 }
 
 /* Record a call to an inner tree. */
 void
-TraceRecorder::emitTreeCall(Fragment* inner, SideExit* exit)
+TraceRecorder::emitTreeCall(Fragment* inner, VMSideExit* exit)
 {
     TreeInfo* ti = (TreeInfo*)inner->vmprivate;
     /* Invoke the inner tree. */
     LIns* args[] = { INS_CONSTPTR(inner), lirbuf->state }; /* reverse order */
     LIns* ret = lir->insCall(&js_CallTree_ci, args);
     /* Read back all registers, in case the called tree changed any of them. */
     import(ti, inner_sp_ins, exit->numGlobalSlots, exit->calldepth,
            getTypeMap(exit), getTypeMap(exit) + exit->numGlobalSlots);
@@ -2135,34 +2486,43 @@ TraceRecorder::trackCfgMerges(jsbytecode
 
 /* Invert the direction of the guard if this is a loop edge that is not 
    taken (thin loop). */
 void
 TraceRecorder::flipIf(jsbytecode* pc, bool& cond)
 {
     if (js_IsLoopEdge(pc, (jsbytecode*)fragment->root->ip)) {
         switch (*pc) {
-        case JSOP_IFEQ:
-        case JSOP_IFEQX:
+          case JSOP_IFEQ:
+          case JSOP_IFEQX:
             if (!cond)
                 return;
             break;
-        case JSOP_IFNE:
-        case JSOP_IFNEX:
+          case JSOP_IFNE:
+          case JSOP_IFNEX:
             if (cond)
                 return;
             break;
-        default:
+          default:
             JS_NOT_REACHED("flipIf");
         }
         /* We are about to walk out of the loop, so terminate it with
            an inverse loop condition. */
         debug_only_v(printf("Walking out of the loop, terminating it anyway.\n");)
         cond = !cond;
         terminate = true;
+        /* If when we get to closeLoop the tree is decided to be type unstable, we need to 
+           reverse this logic because the loop won't be closed after all.  Store the real 
+           value of the IP the interpreter expects, so we can use it in our final LIR_x.
+         */
+        if (*pc == JSOP_IFEQX || *pc == JSOP_IFNEX)
+            pc += GET_JUMPX_OFFSET(pc);
+        else
+            pc += GET_JUMP_OFFSET(pc);
+        terminate_ip_adj = ENCODE_IP_ADJ(cx->fp, pc);
     }
 }
 
 /* Emit code for a fused IFEQ/IFNE. */
 void
 TraceRecorder::fuseIf(jsbytecode* pc, bool cond, LIns* x)
 {
     if (x->isconst()) // no need to guard if condition is constant
@@ -2172,43 +2532,100 @@ TraceRecorder::fuseIf(jsbytecode* pc, bo
         guard(cond, x, BRANCH_EXIT);
         trackCfgMerges(pc); 
     } else if (*pc == JSOP_IFNE) {
         flipIf(pc, cond);
         guard(cond, x, BRANCH_EXIT);
     }
 }
 
+bool
+TraceRecorder::hasMethod(JSObject* obj, jsid id)
+{
+    if (!obj)
+        return false;
+
+    JSObject* pobj;
+    JSProperty* prop;
+    int protoIndex = OBJ_LOOKUP_PROPERTY(cx, obj, id, &pobj, &prop);
+    if (protoIndex < 0 || !prop)
+        return false;
+
+    bool found = false;
+    if (OBJ_IS_NATIVE(pobj)) {
+        JSScope* scope = OBJ_SCOPE(pobj);
+        JSScopeProperty* sprop = (JSScopeProperty*) prop;
+
+        if (SPROP_HAS_STUB_GETTER(sprop) &&
+            SPROP_HAS_VALID_SLOT(sprop, scope)) {
+            jsval v = LOCKED_OBJ_GET_SLOT(pobj, sprop->slot);
+            if (VALUE_IS_FUNCTION(cx, v)) {
+                found = true;
+                if (!SCOPE_IS_BRANDED(scope)) {
+                    SCOPE_MAKE_UNIQUE_SHAPE(cx, scope);
+                    SCOPE_SET_BRANDED(scope);
+                }
+            }
+        }
+    }
+
+    OBJ_DROP_PROPERTY(cx, pobj, prop);
+    return found;
+}
+
+bool
+TraceRecorder::hasToStringMethod(JSObject* obj)
+{
+    JS_ASSERT(cx->fp->regs->sp + 1 <= cx->fp->slots + cx->fp->script->nslots);
+
+    return hasMethod(obj, ATOM_TO_JSID(cx->runtime->atomState.toStringAtom));
+}
+
+bool
+TraceRecorder::hasValueOfMethod(JSObject* obj)
+{
+    JS_ASSERT(cx->fp->regs->sp + 2 <= cx->fp->slots + cx->fp->script->nslots);
+
+    return hasMethod(obj, ATOM_TO_JSID(cx->runtime->atomState.valueOfAtom));
+}
+
+bool
+TraceRecorder::hasIteratorMethod(JSObject* obj)
+{
+    JS_ASSERT(cx->fp->regs->sp + 2 <= cx->fp->slots + cx->fp->script->nslots);
+
+    return hasMethod(obj, ATOM_TO_JSID(cx->runtime->atomState.iteratorAtom));
+}
+
 int
 nanojit::StackFilter::getTop(LInsp guard)
 {
+    VMSideExit* e = (VMSideExit*)guard->record()->exit;
     if (sp == lirbuf->sp)
-        return guard->record()->exit->sp_adj;
+        return e->sp_adj;
     JS_ASSERT(sp == lirbuf->rp);
-    return guard->record()->exit->rp_adj;
+    return e->rp_adj;
 }
 
 #if defined NJ_VERBOSE
 void
 nanojit::LirNameMap::formatGuard(LIns *i, char *out)
 {
-    uint32_t ip;
-    SideExit *x;
-
-    x = (SideExit *)i->record()->exit;
-    ip = intptr_t(x->from->ip) + x->ip_adj;
+    VMSideExit *x;
+
+    x = (VMSideExit *)i->record()->exit;
     sprintf(out,
-        "%s: %s %s -> %s sp%+ld rp%+ld",
-        formatRef(i),
-        lirNames[i->opcode()],
-        i->oprnd1()->isCond() ? formatRef(i->oprnd1()) : "",
-        labels->format((void *)ip),
-        (long int)x->sp_adj,
-        (long int)x->rp_adj
-        );
+            "%s: %s %s -> %lu:%lu sp%+ld rp%+ld",
+            formatRef(i),
+            lirNames[i->opcode()],
+            i->oprnd1()->isCond() ? formatRef(i->oprnd1()) : "",
+            IMACRO_PC_ADJ(x->ip_adj),
+            SCRIPT_PC_ADJ(x->ip_adj),
+            (long int)x->sp_adj,
+            (long int)x->rp_adj);
 }
 #endif
 
 void
 nanojit::Fragment::onDestroy()
 {
     if (root == this) {
         delete mergeCounts;
@@ -2225,36 +2642,52 @@ js_DeleteRecorder(JSContext* cx)
     /* Aborting and completing a trace end up here. */
     JS_ASSERT(tm->onTrace);
     tm->onTrace = false;
 
     delete tm->recorder;
     tm->recorder = NULL;
 }
 
-static bool
-js_StartRecorder(JSContext* cx, SideExit* anchor, Fragment* f, TreeInfo* ti,
-        unsigned ngslots, uint8* globalTypeMap, uint8* stackTypeMap, 
-        SideExit* expectedInnerExit)
+/**
+ * Checks whether the shape of the global object has changed.
+ */
+static inline bool
+js_CheckGlobalObjectShape(JSContext* cx, JSTraceMonitor* tm, JSObject* globalObj)
+{
+    /* Check the global shape. */
+    if (tm->globalSlots->length() && (OBJ_SHAPE(globalObj) != tm->globalShape)) {
+        AUDIT(globalShapeMismatchAtEntry);
+        debug_only_v(printf("Global shape mismatch (%u vs. %u), flushing cache.\n",
+                            OBJ_SHAPE(globalObj), tm->globalShape);)
+        return false;
+    }
+    return true;
+}
+
+static bool
+js_StartRecorder(JSContext* cx, VMSideExit* anchor, Fragment* f, TreeInfo* ti,
+                 unsigned ngslots, uint8* globalTypeMap, uint8* stackTypeMap, 
+                 VMSideExit* expectedInnerExit, Fragment* outer)
 {
     JSTraceMonitor* tm = &JS_TRACE_MONITOR(cx);
 
     /*
      * Emulate on-trace semantics and avoid rooting headaches while recording,
      * by suppressing last-ditch GC attempts while recording a trace. This does
      * means that trace recording must not nest or the following assertion will
      * botch.
      */
     JS_ASSERT(!tm->onTrace);
     tm->onTrace = true;
 
     /* start recording if no exception during construction */
     tm->recorder = new (&gc) TraceRecorder(cx, anchor, f, ti,
                                            ngslots, globalTypeMap, stackTypeMap,
-                                           expectedInnerExit);
+                                           expectedInnerExit, outer);
     if (cx->throwing) {
         js_AbortRecording(cx, "setting up recorder failed");
         return false;
     }
     /* clear any leftover error state */
     tm->fragmento->assm()->setError(None);
     return true;
 }
@@ -2284,18 +2717,22 @@ js_SynthesizeFrame(JSContext* cx, const 
 js_SynthesizeFrame(JSContext* cx, const FrameInfo& fi)
 {
     JS_ASSERT(HAS_FUNCTION_CLASS(fi.callee));
 
     JSFunction* fun = GET_FUNCTION_PRIVATE(cx, fi.callee);
     JS_ASSERT(FUN_INTERPRETED(fun));
 
     /* Assert that we have a correct sp distance from cx->fp->slots in fi. */
-    JS_ASSERT(js_ReconstructStackDepth(cx, cx->fp->script, fi.callpc) ==
-              uintN(fi.s.spdist - cx->fp->script->nfixed));
+    JS_ASSERT(js_ReconstructStackDepth(cx, cx->fp->script,
+                                       FI_IMACRO_PC(fi, cx->fp)
+                                       ? FI_SCRIPT_PC(fi, cx->fp) +
+                                         js_CodeSpec[*FI_SCRIPT_PC(fi, cx->fp)].length
+                                       : FI_SCRIPT_PC(fi, cx->fp))
+              == uintN(fi.s.spdist - cx->fp->script->nfixed));
 
     uintN nframeslots = JS_HOWMANY(sizeof(JSInlineFrame), sizeof(jsval));
     JSScript* script = fun->u.i.script;
     size_t nbytes = (nframeslots + script->nslots) * sizeof(jsval);
 
     /* Code duplicated from inline_call: case in js_Interpret (FIXME). */
     JSArena* a = cx->stackPool.current;
     void* newmark = (void*) a->avail;
@@ -2356,20 +2793,24 @@ js_SynthesizeFrame(JSContext* cx, const 
     newifp->frame.callobj = NULL;
     newifp->frame.argsobj = NULL;
     newifp->frame.varobj = NULL;
     newifp->frame.script = script;
     newifp->frame.callee = fi.callee;
     newifp->frame.fun = fun;
 
     bool constructing = fi.s.argc & 0x8000;
-    
     newifp->frame.argc = argc;
-    newifp->callerRegs.pc = fi.callpc;
+
+    jsbytecode* imacro_pc = FI_IMACRO_PC(fi, cx->fp);
+    jsbytecode* script_pc = FI_SCRIPT_PC(fi, cx->fp);
+    newifp->callerRegs.pc = imacro_pc ? imacro_pc : script_pc;
     newifp->callerRegs.sp = cx->fp->slots + fi.s.spdist;
+    cx->fp->imacpc = imacro_pc ? script_pc : NULL;
+
     newifp->frame.argv = newifp->callerRegs.sp - argc;
     JS_ASSERT(newifp->frame.argv);
 #ifdef DEBUG
     // Initialize argv[-1] to a known-bogus value so we'll catch it if
     // someone forgets to initialize it later.
     newifp->frame.argv[-1] = JSVAL_HOLE;
 #endif
     JS_ASSERT(newifp->frame.argv >= StackBase(cx->fp) + 2);
@@ -2385,16 +2826,17 @@ js_SynthesizeFrame(JSContext* cx, const 
     newifp->frame.xmlNamespace = NULL;
     newifp->frame.blockChain = NULL;
     newifp->mark = newmark;
     newifp->frame.thisp = NULL; // will be set by js_ExecuteTree -> FlushNativeStackFrame
 
     newifp->frame.regs = cx->fp->regs;
     newifp->frame.regs->pc = script->code;
     newifp->frame.regs->sp = newsp + script->nfixed;
+    newifp->frame.imacpc = NULL;
     newifp->frame.slots = newsp;
     if (script->staticDepth < JS_DISPLAY_SIZE) {
         JSStackFrame **disp = &cx->display[script->staticDepth];
         newifp->frame.displaySave = *disp;
         *disp = &newifp->frame;
     }
 #ifdef DEBUG
     newifp->frame.pcDisabledSave = 0;
@@ -2435,97 +2877,162 @@ js_SynthesizeFrame(JSContext* cx, const 
     // callee's, including missing arguments. Could we shift everything down to the caller's
     // fp->slots (where vars start) and avoid some of the complexity?
     return (fi.s.spdist - cx->fp->down->script->nfixed) +
            ((fun->nargs > cx->fp->argc) ? fun->nargs - cx->fp->argc : 0) +
            script->nfixed;
 }
 
 bool
-js_RecordTree(JSContext* cx, JSTraceMonitor* tm, Fragment* f)
-{
+js_RecordTree(JSContext* cx, JSTraceMonitor* tm, Fragment* f, Fragment* outer, unsigned* demotes)
+{
+    /* Avoid recording loops in overlarge scripts. */
+    if (cx->fp->script->length >= SCRIPT_PC_ADJ_LIMIT) {
+        js_AbortRecording(cx, "script too large");
+        return false;
+    }
+
     /* Make sure the global type map didn't change on us. */
-    uint32 globalShape = OBJ_SHAPE(JS_GetGlobalForObject(cx, cx->fp->scopeChain));
-    if (tm->globalShape != globalShape) {
-        AUDIT(globalShapeMismatchAtEntry);
-        debug_only_v(printf("Global shape mismatch (%u vs. %u) in RecordTree, flushing cache.\n",
-                          globalShape, tm->globalShape);)
+    JSObject* globalObj = JS_GetGlobalForObject(cx, cx->fp->scopeChain);
+    if (!js_CheckGlobalObjectShape(cx, tm, globalObj)) {
         js_FlushJITCache(cx);
         return false;
     }
     TypeMap current;
     current.captureGlobalTypes(cx, *tm->globalSlots);
     if (!current.matches(*tm->globalTypeMap)) {
         js_FlushJITCache(cx);
         debug_only_v(printf("Global type map mismatch in RecordTree, flushing cache.\n");)
         return false;
     }
-    
+
     AUDIT(recorderStarted);
 
     /* Try to find an unused peer fragment, or allocate a new one. */
     while (f->code() && f->peer)
         f = f->peer;
     if (f->code())
-        f = JS_TRACE_MONITOR(cx).fragmento->getAnchor(f->ip);
-
-    f->calldepth = 0;
+        f = JS_TRACE_MONITOR(cx).fragmento->getAnchor(f->root->ip);
+
+    f->recordAttempts++;
     f->root = f;
     /* allocate space to store the LIR for this tree */
     if (!f->lirbuf) {
         f->lirbuf = new (&gc) LirBuffer(tm->fragmento, NULL);
 #ifdef DEBUG
         f->lirbuf->names = new (&gc) LirNameMap(&gc, NULL, tm->fragmento->labels);
 #endif
     }
 
+    if (f->lirbuf->outOmem()) {
+        js_FlushJITCache(cx);
+        debug_only_v(printf("Out of memory recording new tree, flushing cache.\n");)
+        return false;
+    }
+
     JS_ASSERT(!f->code() && !f->vmprivate);
 
     /* setup the VM-private treeInfo structure for this fragment */
     TreeInfo* ti = new (&gc) TreeInfo(f);
 
     /* capture the coerced type of each active slot in the stack type map */
     ti->stackTypeMap.captureStackTypes(cx, 0/*callDepth*/);
+
+    if (demotes) {
+        /* If we get a list of demotions, an outer tree is telling us our types are not callable. */
+        uint8* typeMap = ti->stackTypeMap.data();
+        for (unsigned i = 1; i <= NUM_UNDEMOTE_SLOTS(demotes); i++) {
+            JS_ASSERT(demotes[i] < ti->stackTypeMap.length());
+            if (typeMap[demotes[i]] == JSVAL_INT)
+                typeMap[demotes[i]] = JSVAL_DOUBLE;
+        }
+    }
+
+    /* Check for duplicate entry type maps.  This is always wrong and hints at trace explosion 
+       since we are trying to stabilize something without properly connecting peer edges. */
+    #ifdef DEBUG
+    TreeInfo* ti_other;
+    for (Fragment* peer = tm->fragmento->getLoop(f->root->ip); peer != NULL; peer = peer->peer) {
+        if (!peer->code() || peer == f)
+            continue;
+        ti_other = (TreeInfo*)peer->vmprivate;
+        JS_ASSERT(ti_other);
+        JS_ASSERT(!ti->stackTypeMap.matches(ti_other->stackTypeMap));
+    }
+    #endif
 
     /* determine the native frame layout at the entry point */
     unsigned entryNativeStackSlots = ti->stackTypeMap.length();
     JS_ASSERT(entryNativeStackSlots == js_NativeStackSlots(cx, 0/*callDepth*/));
     ti->nativeStackBase = (entryNativeStackSlots -
             (cx->fp->regs->sp - StackBase(cx->fp))) * sizeof(double);
     ti->maxNativeStackSlots = entryNativeStackSlots;
     ti->maxCallDepth = 0;
     ti->script = cx->fp->script;
 
     /* recording primary trace */
-    return js_StartRecorder(cx, NULL, f, ti,
-                            tm->globalSlots->length(), tm->globalTypeMap->data(), 
-                            ti->stackTypeMap.data(), NULL);
-}
-
-static bool
-js_AttemptToExtendTree(JSContext* cx, SideExit* anchor, SideExit* exitedFrom)
+    if (!js_StartRecorder(cx, NULL, f, ti,
+                          tm->globalSlots->length(), tm->globalTypeMap->data(), 
+                          ti->stackTypeMap.data(), NULL, outer)) {
+        return false;
+    }
+
+    return true;
+}
+
+static bool
+js_AttemptToStabilizeTree(JSContext* cx, VMSideExit* exit, Fragment* outer)
+{
+    JSTraceMonitor* tm = &JS_TRACE_MONITOR(cx);
+    Fragment* from = exit->from->root;
+    unsigned* demotes;
+
+    JS_ASSERT(exit->from->root->code());
+    
+    demotes = ALLOCA_UNDEMOTE_SLOTLIST(exit->numStackSlots);
+    CLEAR_UNDEMOTE_SLOTLIST(demotes);
+
+    uint8* t2 = getTypeMap(exit) + exit->numGlobalSlots;
+    for (unsigned i = 0; i < exit->numStackSlots; i++) {
+        if (t2[i] == JSVAL_DOUBLE)
+            ADD_UNDEMOTE_SLOT(demotes, i);
+    }
+
+    if (!NUM_UNDEMOTE_SLOTS(demotes))
+        demotes = NULL;
+
+    if (!js_RecordTree(cx, tm, from->first, outer, demotes))
+        return false;
+
+    tm->recorder->setPromotedPeer(demotes ? from : NULL);
+
+    return true;
+}
+
+static bool
+js_AttemptToExtendTree(JSContext* cx, VMSideExit* anchor, VMSideExit* exitedFrom, Fragment* outer)
 {
     Fragment* f = anchor->from->root;
     JS_ASSERT(f->vmprivate);
     TreeInfo* ti = (TreeInfo*)f->vmprivate;
 
     /* Don't grow trees above a certain size to avoid code explosion due to tail duplication. */
     if (ti->branchCount >= MAX_BRANCHES)
         return false;
     
-    debug_only_v(printf("trying to attach another branch to the tree\n");)
-
     Fragment* c;
     if (!(c = anchor->target)) {
         c = JS_TRACE_MONITOR(cx).fragmento->createBranch(anchor, cx->fp->regs->pc);
         c->spawnedFrom = anchor;
         c->parent = f;
         anchor->target = c;
         c->root = f;
     }
+
+    debug_only_v(printf("trying to attach another branch to the tree (hits = %d)\n", c->hits());)
 
     if (++c->hits() >= HOTEXIT) {
         /* start tracing secondary trace from this point */
         c->lirbuf = f->lirbuf;
         unsigned ngslots;
         uint8* globalTypeMap;
         uint8* stackTypeMap;
         TypeMap fullMap;
@@ -2535,244 +3042,473 @@ js_AttemptToExtendTree(JSContext* cx, Si
             ngslots = anchor->numGlobalSlots;
             globalTypeMap = getTypeMap(anchor);
             stackTypeMap = globalTypeMap + ngslots;
         } else {
             /* If we side-exited on a loop exit and continue on a nesting guard, the nesting
                guard (anchor) has the type information for everything below the current scope, 
                and the actual guard we exited from has the types for everything in the current
                scope (and whatever it inlined). We have to merge those maps here. */
-            SideExit* e1 = anchor;
-            SideExit* e2 = exitedFrom;
+            VMSideExit* e1 = anchor;
+            VMSideExit* e2 = exitedFrom;
             fullMap.add(getTypeMap(e1) + e1->numGlobalSlots, e1->numStackSlotsBelowCurrentFrame);
             fullMap.add(getTypeMap(e2) + e2->numGlobalSlots, e2->numStackSlots);
             ngslots = e2->numGlobalSlots;
             globalTypeMap = getTypeMap(e2);
             stackTypeMap = fullMap.data();
         } 
         return js_StartRecorder(cx, anchor, c, (TreeInfo*)f->vmprivate,
-                                ngslots, globalTypeMap, stackTypeMap, exitedFrom);
-    }
-    return false;
-}
-
-static SideExit*
-js_ExecuteTree(JSContext* cx, Fragment** treep, uintN& inlineCallCount, 
-               SideExit** innermostNestedGuardp);
-
-static void
+                                ngslots, globalTypeMap, stackTypeMap, exitedFrom, outer);
+    }
+    return false;
+}
+
+static VMSideExit*
+js_ExecuteTree(JSContext* cx, Fragment* f, uintN& inlineCallCount, 
+               VMSideExit** innermostNestedGuardp);
+
+static Fragment*
+js_FindVMCompatiblePeer(JSContext* cx, Fragment* f);
+
+static bool
 js_CloseLoop(JSContext* cx)
 {
     JSTraceMonitor* tm = &JS_TRACE_MONITOR(cx);
     Fragmento* fragmento = tm->fragmento;
     TraceRecorder* r = tm->recorder;
     JS_ASSERT(fragmento && r);
 
     if (fragmento->assm()->error()) {
         js_AbortRecording(cx, "Error during recording");
+
         /* If we ran out of memory, flush the code cache and abort. */
         if (fragmento->assm()->error() == OutOMem)
             js_FlushJITCache(cx);
-        return;
-    }
-    r->closeLoop(fragmento);
+        return false;
+    }
+
+    bool demote;
+    Fragment* f = r->getFragment();
+    TreeInfo* ti = r->getTreeInfo();
+    unsigned* demotes = ALLOCA_UNDEMOTE_SLOTLIST(ti->stackTypeMap.length());
+    r->closeLoop(fragmento, demote, demotes);
+    JS_ASSERT(!demote || NUM_UNDEMOTE_SLOTS(demotes));
     js_DeleteRecorder(cx);
+    if (demote)
+        return js_RecordTree(cx, tm, f, NULL, demotes);
+    return false;
 }
 
 bool
 js_RecordLoopEdge(JSContext* cx, TraceRecorder* r, uintN& inlineCallCount)
 {
 #ifdef JS_THREADSAFE
     if (OBJ_SCOPE(JS_GetGlobalForObject(cx, cx->fp->scopeChain))->title.ownercx != cx) {
         js_AbortRecording(cx, "Global object not owned by this context");
         return false; /* we stay away from shared global objects */
     }
 #endif
     Fragmento* fragmento = JS_TRACE_MONITOR(cx).fragmento;
     /* If we hit our own loop header, close the loop and compile the trace. */
-    if (r->isLoopHeader(cx)) {
-        js_CloseLoop(cx);
-        return false; /* done recording */
-    }
+    if (r->isLoopHeader(cx))
+        return js_CloseLoop(cx);
     /* does this branch go to an inner loop? */
     Fragment* f = fragmento->getLoop(cx->fp->regs->pc);
-    if (nesting_enabled && 
-        f && /* must have a fragment at that location */
-        r->selectCallablePeerFragment(&f) && /* is there a potentially matching peer fragment? */
-        r->adjustCallerTypes(f)) { /* make sure we can make our arguments fit */
+    Fragment* peer_root = f;
+    if (nesting_enabled && f) {
+        JSTraceMonitor* tm = &JS_TRACE_MONITOR(cx);
+        
+        /* Make sure inner tree call will not run into an out-of-memory condition. */
+        if (tm->recoveryDoublePoolPtr < (tm->recoveryDoublePool + MAX_NATIVE_STACK_SLOTS) &&
+            !js_ReplenishRecoveryPool(cx, tm)) {
+            js_AbortRecording(cx, "Couldn't call inner tree (out of memory)");
+            return false; 
+        }
+        
+        /* Make sure the shape of the global object still matches (this might flush 
+           the JIT cache). */
+        JSObject* globalObj = JS_GetGlobalForObject(cx, cx->fp->scopeChain);
+        if (!js_CheckGlobalObjectShape(cx, tm, globalObj)) {
+            js_AbortRecording(cx, "Couldn't call inner tree (prep failed)");
+            return false;
+        }
+        
+        debug_only_v(printf("Looking for type-compatible peer (%s:%d@%d)\n",
+                            cx->fp->script->filename,
+                            js_FramePCToLineNumber(cx, cx->fp),
+                            FramePCOffset(cx->fp));)
+
+        /* Find an acceptable peer, make sure our types fit. */
+        Fragment* empty;
+        bool trash = false;
+        bool success = false;
+        unsigned* demotes = NULL;
+
+        f = r->findNestedCompatiblePeer(f, &empty);
+        if (f && f->code()) {
+            TreeInfo* ti = (TreeInfo*)f->vmprivate;
+            /* alloca docs says it lasts out of scopes. */
+            demotes = ALLOCA_UNDEMOTE_SLOTLIST(ti->stackTypeMap.length());
+            CLEAR_UNDEMOTE_SLOTLIST(demotes);
+            success = r->adjustCallerTypes(f, demotes, trash);
+        }
+
+        if (!success) {
+            AUDIT(noCompatInnerTrees);
+            debug_only_v(printf("No compatible inner tree (%p).\n", f);)
+
+            if (trash) {
+                js_AbortRecording(cx, "No compatible inner tree (global demotions");
+                return false;
+            }
+
+            Fragment* old = fragmento->getLoop(tm->recorder->getFragment()->root->ip);
+            if (old == NULL)
+                old = tm->recorder->getFragment();
+            js_AbortRecording(cx, "No compatible inner tree");
+            if (!f && ++peer_root->hits() < MAX_INNER_RECORD_BLACKLIST)
+                return false;
+            if (old->recordAttempts < MAX_MISMATCH)
+                old->resetHits();
+            f = empty ? empty : tm->fragmento->getAnchor(cx->fp->regs->pc);
+            return js_RecordTree(cx, tm, f, old, demotes);
+        }
+
         r->prepareTreeCall(f);
-        SideExit* innermostNestedGuard = NULL;
-        SideExit* lr = js_ExecuteTree(cx, &f, inlineCallCount, &innermostNestedGuard);
+        VMSideExit* innermostNestedGuard = NULL;
+        VMSideExit* lr = js_ExecuteTree(cx, f, inlineCallCount, &innermostNestedGuard);
         if (!lr) {
-            /* js_ExecuteTree might have flushed the cache and aborted us already. */
-            if (JS_TRACE_MONITOR(cx).recorder)
-                js_AbortRecording(cx, "Couldn't call inner tree");
-            return false;
-        }
+            js_AbortRecording(cx, "Couldn't call inner tree");
+            return false;
+        }
+        Fragment* old;
         switch (lr->exitType) {
-        case LOOP_EXIT:
+          case LOOP_EXIT:
             /* If the inner tree exited on an unknown loop exit, grow the tree around it. */
             if (innermostNestedGuard) {
                 js_AbortRecording(cx, "Inner tree took different side exit, abort recording");
-                return js_AttemptToExtendTree(cx, innermostNestedGuard, lr);
+                return js_AttemptToExtendTree(cx, innermostNestedGuard, lr, NULL);
             }
             /* emit a call to the inner tree and continue recording the outer tree trace */
             r->emitTreeCall(f, lr);
             return true;
+        case UNSTABLE_LOOP_EXIT:
+            /* abort recording so the inner loop can become type stable. */
+            old = fragmento->getLoop(tm->recorder->getFragment()->root->ip);
+            js_AbortRecording(cx, "Inner tree is trying to stabilize, abort outer recording");
+            old->resetHits();
+            return js_AttemptToStabilizeTree(cx, lr, old);
         case BRANCH_EXIT:
             /* abort recording the outer tree, extend the inner tree */
+            old = fragmento->getLoop(tm->recorder->getFragment()->root->ip);
             js_AbortRecording(cx, "Inner tree is trying to grow, abort outer recording");
-            return js_AttemptToExtendTree(cx, lr, NULL);
+            old->resetHits();
+            return js_AttemptToExtendTree(cx, lr, NULL, old);
         default:
             debug_only_v(printf("exit_type=%d\n", lr->exitType);)
             js_AbortRecording(cx, "Inner tree not suitable for calling");
             return false;
         }
     }
+
     /* not returning to our own loop header, not an inner loop we can call, abort trace */
     AUDIT(returnToDifferentLoopHeader);
+    JS_ASSERT(!cx->fp->imacpc);
     debug_only_v(printf("loop edge to %d, header %d\n",
                  cx->fp->regs->pc - cx->fp->script->code,
                  (jsbytecode*)r->getFragment()->root->ip - cx->fp->script->code));
     js_AbortRecording(cx, "Loop edge does not return to header");
     return false;
 }
 
-static inline SideExit*
-js_ExecuteTree(JSContext* cx, Fragment** treep, uintN& inlineCallCount, 
-               SideExit** innermostNestedGuardp)
-{
-    Fragment* f = *treep;
-
-    /* if we don't have a compiled tree available for this location, bail out */
-    if (!f->code()) {
-        JS_ASSERT(!f->vmprivate);
-        return NULL;
-    }
-    JS_ASSERT(f->vmprivate);
-
-    AUDIT(traceTriggered);
-
-    /* execute previously recorded trace */
+static bool
+js_IsEntryTypeCompatible(jsval* vp, uint8* m)
+{
+    unsigned tag = JSVAL_TAG(*vp);
+
+    debug_only_v(printf("%c/%c ", "OIDISIBI"[tag], "OID?S?B?"[*m]);)
+
+    switch (*m) {
+      case JSVAL_INT:
+        jsint i;
+        if (JSVAL_IS_INT(*vp))
+            return true;
+        if ((tag == JSVAL_DOUBLE) && JSDOUBLE_IS_INT(*JSVAL_TO_DOUBLE(*vp), i))
+            return true;
+        debug_only_v(printf("int != tag%u(value=%lu) ", tag, *vp);)
+        return false;
+      case JSVAL_DOUBLE:
+        if (JSVAL_IS_INT(*vp) || tag == JSVAL_DOUBLE)
+            return true;
+        debug_only_v(printf("double != tag%u ", tag);)
+        return false;
+      case JSVAL_BOOLEAN:
+        if (tag == JSVAL_BOOLEAN)
+            return true;
+        debug_only_v(printf("bool != tag%u", tag);)
+        return false;
+      case JSVAL_STRING:
+        if (*vp == JSVAL_VOID || tag == JSVAL_STRING)
+            return true;
+        debug_only_v(printf("string != tag%u", tag);)
+        return false;
+      default:
+        JS_ASSERT(*m == JSVAL_OBJECT);
+        if (tag == JSVAL_OBJECT)
+            return true;
+        debug_only_v(printf("object != tag%u", tag);)
+        return false;
+    }
+}
+
+Fragment* TraceRecorder::findNestedCompatiblePeer(Fragment* f, Fragment** empty)
+{
+    Fragment* demote;
+    JSTraceMonitor* tm;
+    unsigned max_demotes;
+
+    if (empty)
+        *empty = NULL;
+    demote = NULL;
+
+    tm = &JS_TRACE_MONITOR(cx);
+    unsigned int ngslots = tm->globalSlots->length();
+    uint16* gslots = tm->globalSlots->data();
+    uint8* m = tm->globalTypeMap->data();
+
+    if (ngslots) {
+        FORALL_GLOBAL_SLOTS(cx, ngslots, gslots,
+            debug_only_v(printf("%s%d=", vpname, vpnum);)
+            if (!js_IsEntryTypeCompatible(vp, m))
+                return NULL;
+            m++;
+        );
+    }
+
+    /* We keep a maximum tally - we want to select the peer most likely to work so we don't keep 
+     * recording.
+     */
+    max_demotes = 0;
+
+    TreeInfo* ti;
+    for (; f != NULL; f = f->peer) {
+        if (!f->code()) {
+            if (empty)
+                *empty = f;
+            continue;
+        }
+
+        unsigned demotes = 0;
+        ti = (TreeInfo*)f->vmprivate;
+        m = ti->stackTypeMap.data();
+
+        debug_only_v(printf("checking nested types %p: ", f);)
+
+        FORALL_SLOTS_IN_PENDING_FRAMES(cx, 0,
+            debug_only_v(printf("%s%d=", vpname, vpnum);)
+            if (!js_IsEntryTypeCompatible(vp, m))
+                goto check_fail;
+            if (*m == JSVAL_STRING && *vp == JSVAL_VOID)
+                goto check_fail;
+            if (*m == JSVAL_INT && !isPromoteInt(get(vp)))
+                demotes++;
+            m++;
+        );
+        JS_ASSERT(unsigned(m - ti->stackTypeMap.data()) == ti->stackTypeMap.length());
+
+        debug_only_v(printf(" (demotes %d)\n", demotes);)
+
+        if (demotes) {
+            if (demotes > max_demotes) {
+                demote = f;
+                max_demotes = demotes;
+            }
+            continue;
+        } else {
+            return f;
+        }
+
+check_fail:
+        debug_only_v(printf("\n"));
+        continue;
+    }
+
+    if (demote)
+        return demote;
+
+   return NULL;
+}
+
+/**
+ * Check if types are usable for trace execution.
+ *
+ * @param cx            Context.
+ * @param ti            Tree info of peer we're testing.
+ * @return              True if compatible (with or without demotions), false otherwise.
+ */
+static bool
+js_CheckEntryTypes(JSContext* cx, TreeInfo* ti)
+{
+    JSTraceMonitor* tm;
+
+    tm = &JS_TRACE_MONITOR(cx);
+    unsigned int ngslots = tm->globalSlots->length();
+    uint16* gslots = tm->globalSlots->data();
+    uint8* m = tm->globalTypeMap->data();
+
+    if (ngslots) {
+        FORALL_GLOBAL_SLOTS(cx, ngslots, gslots,
+            debug_only_v(printf("%s%d=", vpname, vpnum);)
+            if (!js_IsEntryTypeCompatible(vp, m))
+                goto check_fail;
+            m++;
+        );
+    }
+
+    m = ti->stackTypeMap.data();
+    FORALL_SLOTS_IN_PENDING_FRAMES(cx, 0,
+        debug_only_v(printf("%s%d=", vpname, vpnum);)
+        if (!js_IsEntryTypeCompatible(vp, m))
+            goto check_fail;
+        m++;
+    );
+    JS_ASSERT(unsigned(m - ti->stackTypeMap.data()) == ti->stackTypeMap.length());
+
+    debug_only_v(printf("\n");)
+    return true;
+
+check_fail:
+    debug_only_v(printf("\n");)
+    return false;
+}
+
+/**
+ * Find an acceptable entry tree given a PC.
+ *
+ * @param cx            Context.
+ * @param f             First peer fragment.
+ * @param nodemote      If true, will try to find a peer that does not require demotion.
+ */
+static Fragment*
+js_FindVMCompatiblePeer(JSContext* cx, Fragment* f)
+{
+    for (; f != NULL; f = f->peer) {
+        if (f->vmprivate == NULL) 
+            continue;
+        debug_only_v(printf("checking vm types %p (ip: %p): ", f, f->ip);)
+        if (js_CheckEntryTypes(cx, (TreeInfo*)f->vmprivate))
+            return f;
+    }
+    return NULL;
+}
+
+/**
+ * Executes a tree.
+ */
+static VMSideExit*
+js_ExecuteTree(JSContext* cx, Fragment* f, uintN& inlineCallCount, 
+               VMSideExit** innermostNestedGuardp)
+{
+    JS_ASSERT(f->code() && f->vmprivate);
+
+    JSTraceMonitor* tm = &JS_TRACE_MONITOR(cx);
+    JSObject* globalObj = JS_GetGlobalForObject(cx, cx->fp->scopeChain);
     TreeInfo* ti = (TreeInfo*)f->vmprivate;
-
+    unsigned ngslots = tm->globalSlots->length();
+    uint16* gslots = tm->globalSlots->data();
+    unsigned globalFrameSize = STOBJ_NSLOTS(globalObj);
+    double* global = (double*)alloca((globalFrameSize+1) * sizeof(double));
+    double stack_buffer[MAX_NATIVE_STACK_SLOTS];
+    double* stack = stack_buffer;
+
+    /* Make sure the global object is sane. */
+    JS_ASSERT(!ngslots || (OBJ_SHAPE(JS_GetGlobalForObject(cx, cx->fp->scopeChain)) == tm->globalShape)); 
+    /* Make sure our caller replenished the double pool. */
+    JS_ASSERT(tm->recoveryDoublePoolPtr >= tm->recoveryDoublePool + MAX_NATIVE_STACK_SLOTS);
+
+#ifdef DEBUG
+    memset(stack_buffer, 0xCD, sizeof(stack_buffer));
+    memset(global, 0xCD, (globalFrameSize+1)*sizeof(double));
+#endif    
+
+    debug_only(*(uint64*)&global[globalFrameSize] = 0xdeadbeefdeadbeefLL;)
     debug_only_v(printf("entering trace at %s:%u@%u, native stack slots: %u code: %p\n",
                         cx->fp->script->filename,
-                        js_PCToLineNumber(cx, cx->fp->script, cx->fp->regs->pc),
-                        cx->fp->regs->pc - cx->fp->script->code, ti->maxNativeStackSlots,
-                        f->code()););
-
-    JSTraceMonitor* tm = &JS_TRACE_MONITOR(cx);
-    unsigned ngslots = tm->globalSlots->length();
-    uint16* gslots = tm->globalSlots->data();
-    JSObject* globalObj = JS_GetGlobalForObject(cx, cx->fp->scopeChain);
-    unsigned globalFrameSize = STOBJ_NSLOTS(globalObj);
-    double* global = (double*)alloca((globalFrameSize+1) * sizeof(double));
-    debug_only(*(uint64*)&global[globalFrameSize] = 0xdeadbeefdeadbeefLL;)
-    double* stack = (double*)alloca(MAX_NATIVE_STACK_SLOTS * sizeof(double));
-
-    /* If any of our trees uses globals, the shape of the global object must not change and
-       the global type map must remain applicable at all times (we expect absolute type 
-       stability for globals). */
-    if (ngslots &&
-        (OBJ_SHAPE(globalObj) != tm->globalShape || 
-         !BuildNativeGlobalFrame(cx, ngslots, gslots, tm->globalTypeMap->data(), global))) {
-        AUDIT(globalShapeMismatchAtEntry);
-        debug_only_v(printf("Global shape mismatch (%u vs. %u), flushing cache.\n",
-                            OBJ_SHAPE(globalObj), tm->globalShape);)
-        const void* ip = f->ip;
-        js_FlushJITCache(cx);
-        *treep = tm->fragmento->getAnchor(ip);
-        return NULL;
-    }
-
-    if (!BuildNativeStackFrame(cx, 0/*callDepth*/, ti->stackTypeMap.data(), stack)) {
-        AUDIT(typeMapMismatchAtEntry);
-        debug_only_v(printf("type-map mismatch.\n");)
-        if (++ti->mismatchCount > MAX_MISMATCH) {
-            debug_only_v(printf("excessive mismatches, flushing tree.\n"));
-            js_TrashTree(cx, f);
-            f->blacklist();
-        }
-        return NULL;
-    }
-
-    /* replenish the reserve pool (this might trigger a GC */
-    if (tm->recoveryDoublePoolPtr < tm->recoveryDoublePool + MAX_NATIVE_STACK_SLOTS) {
-        bool didGC;
-        const void* ip = f->ip;
-        if (!ReplenishReservePool(cx, tm, didGC) || didGC) {
-            *treep = tm->fragmento->getAnchor(ip);
-            return NULL;
-        }
-    }
-    
-    ti->mismatchCount = 0;
+                        js_FramePCToLineNumber(cx, cx->fp),
+                        FramePCOffset(cx->fp),
+                        ti->maxNativeStackSlots,
+                        f->code());)
+    
+    if (ngslots)
+        BuildNativeGlobalFrame(cx, ngslots, gslots, tm->globalTypeMap->data(), global);
+    BuildNativeStackFrame(cx, 0/*callDepth*/, ti->stackTypeMap.data(), stack);
 
     double* entry_sp = &stack[ti->nativeStackBase/sizeof(double)];
-    FrameInfo* callstack = (FrameInfo*) alloca(MAX_CALL_STACK_ENTRIES * sizeof(FrameInfo));
+    FrameInfo callstack_buffer[MAX_CALL_STACK_ENTRIES];
+    FrameInfo* callstack = callstack_buffer;
 
     InterpState state;
     state.sp = (void*)entry_sp;
     state.eos = ((double*)state.sp) + MAX_NATIVE_STACK_SLOTS;
     state.rp = callstack;
     state.eor = callstack + MAX_CALL_STACK_ENTRIES;
     state.gp = global;
     state.cx = cx;
     state.lastTreeExitGuard = NULL;
     state.lastTreeCallGuard = NULL;
     state.rpAtLastTreeCall = NULL;
     union { NIns *code; GuardRecord* (FASTCALL *func)(InterpState*, Fragment*); } u;
     u.code = f->code();
 
-#ifdef DEBUG
+#ifdef JS_JIT_SPEW
 #if defined(NANOJIT_IA32) || (defined(NANOJIT_AMD64) && defined(__GNUC__))
     uint64 start = rdtsc();
 #endif
 #endif
 
     /*
      * We may be called from js_MonitorLoopEdge while not recording, or while
      * recording. Rather than over-generalize by using a counter instead of a
      * flag, we simply sample and update tm->onTrace if necessary.
      */
     bool onTrace = tm->onTrace;
     if (!onTrace)
         tm->onTrace = true;
-    SideExit* lr;
+    VMSideExit* lr;
     
     debug_only(fflush(NULL);)
     GuardRecord* rec;
 #if defined(JS_NO_FASTCALL) && defined(NANOJIT_IA32)
     SIMULATE_FASTCALL(rec, &state, NULL, u.func);
 #else
     rec = u.func(&state, NULL);
 #endif
-    lr = rec->exit;
+    lr = (VMSideExit*)rec->exit;
+
+    AUDIT(traceTriggered);
 
     JS_ASSERT(lr->exitType != LOOP_EXIT || !lr->calldepth);
 
-    if (!onTrace)
-        tm->onTrace = false;
+    tm->onTrace = onTrace;
 
     /* Except if we find that this is a nested bailout, the guard the call returned is the
        one we have to use to adjust pc and sp. */
-    SideExit* innermost = lr;
+    VMSideExit* innermost = lr;
 
     /* While executing a tree we do not update state.sp and state.rp even if they grow. Instead,
        guards tell us by how much sp and rp should be incremented in case of a side exit. When
        calling a nested tree, however, we actively adjust sp and rp. If we have such frames
        from outer trees on the stack, then rp will have been adjusted. Before we can process
        the stack of the frames of the tree we directly exited from, we have to first work our
        way through the outer frames and generate interpreter frames for them. Once the call
        stack (rp) is empty, we can process the final frames (which again are not directly
        visible and only the guard we exited on will tells us about). */
     FrameInfo* rp = (FrameInfo*)state.rp;
     if (lr->exitType == NESTED_EXIT) {
-        SideExit* nested = state.lastTreeCallGuard;
+        VMSideExit* nested = state.lastTreeCallGuard;
         if (!nested) {
             /* If lastTreeCallGuard is not set in state, we only have a single level of
                nesting in this exit, so lr itself is the innermost and outermost nested
                guard, and hence we set nested to lr. The calldepth of the innermost guard
                is not added to state.rp, so we do it here manually. For a nesting depth
                greater than 1 the CallTree builtin already added the innermost guard's
                calldepth to state.rpAtLastTreeCall. */
             nested = lr;
@@ -2786,27 +3522,30 @@ js_ExecuteTree(JSContext* cx, Fragment**
         innermost = state.lastTreeExitGuard;
         if (innermostNestedGuardp)
             *innermostNestedGuardp = nested;
         JS_ASSERT(nested);
         JS_ASSERT(nested->exitType == NESTED_EXIT);
         JS_ASSERT(state.lastTreeExitGuard);
         JS_ASSERT(state.lastTreeExitGuard->exitType != NESTED_EXIT);
     }
+
     while (callstack < rp) {
         /* Synthesize a stack frame and write out the values in it using the type map pointer
            on the native call stack. */
         if (js_SynthesizeFrame(cx, *callstack) < 0)
             return NULL;
         int slots = FlushNativeStackFrame(cx, 1/*callDepth*/, callstack->typemap, stack, cx->fp);
 #ifdef DEBUG
         JSStackFrame* fp = cx->fp;
         debug_only_v(printf("synthesized deep frame for %s:%u@%u, slots=%d\n",
-                            fp->script->filename, js_PCToLineNumber(cx, fp->script, fp->regs->pc),
-                            fp->regs->pc - fp->script->code, slots);)
+                            fp->script->filename,
+                            js_FramePCToLineNumber(cx, fp),
+                            FramePCOffset(fp),
+                            slots);)
 #endif        
         if (slots < 0)
             return NULL;
         /* Keep track of the additional frames we put on the interpreter stack and the native
            stack slots we consumed. */
         ++inlineCallCount;
         ++callstack;
         stack += slots;
@@ -2821,44 +3560,47 @@ js_ExecuteTree(JSContext* cx, Fragment**
         int nslots = js_SynthesizeFrame(cx, callstack[n]);
         if (nslots < 0)
             return NULL;
         calldepth_slots += nslots;
         ++inlineCallCount;
 #ifdef DEBUG        
         JSStackFrame* fp = cx->fp;
         debug_only_v(printf("synthesized shallow frame for %s:%u@%u\n",
-                            fp->script->filename, js_PCToLineNumber(cx, fp->script, fp->regs->pc),
-                            fp->regs->pc - fp->script->code);)
+                            fp->script->filename, js_FramePCToLineNumber(cx, fp),
+                            FramePCOffset(fp));)
 #endif        
     }
 
-    /* Adjust sp and pc relative to the tree we exited from (not the tree we entered
-       into). These are our final values for sp and pc since js_SynthesizeFrame has
-       already taken care of all frames in between. */
+    /* Adjust sp and pc relative to the tree we exited from (not the tree we entered into).
+       These are our final values for sp and pc since js_SynthesizeFrame has already taken
+       care of all frames in between. */
     JSStackFrame* fp = cx->fp;
 
     /* If we are not exiting from an inlined frame the state->sp is spbase, otherwise spbase
        is whatever slots frames around us consume. */
-    fp->regs->pc = (jsbytecode*)innermost->from->root->ip + innermost->ip_adj;
+    DECODE_IP_ADJ(innermost->ip_adj, fp);
     fp->regs->sp = StackBase(fp) + (innermost->sp_adj / sizeof(double)) - calldepth_slots;
-    JS_ASSERT(fp->slots + fp->script->nfixed +
-              js_ReconstructStackDepth(cx, fp->script, fp->regs->pc) == fp->regs->sp);
-
-#if defined(DEBUG) && (defined(NANOJIT_IA32) || (defined(NANOJIT_AMD64) && defined(__GNUC__)))
+    JS_ASSERT_IF(!fp->imacpc,
+                 fp->slots + fp->script->nfixed +
+                 js_ReconstructStackDepth(cx, fp->script, fp->regs->pc) == fp->regs->sp);
+                                              
+
+#if defined(JS_JIT_SPEW) && (defined(NANOJIT_IA32) || (defined(NANOJIT_AMD64) && defined(__GNUC__)))
     uint64 cycles = rdtsc() - start;
-#elif defined(DEBUG)
+#elif defined(JS_JIT_SPEW)
     uint64 cycles = 0;
 #endif
 
     debug_only_v(printf("leaving trace at %s:%u@%u, op=%s, lr=%p, exitType=%d, sp=%d, "
                         "calldepth=%d, cycles=%llu\n",
-                        fp->script->filename, js_PCToLineNumber(cx, fp->script, fp->regs->pc),
-                        fp->regs->pc - fp->script->code,
-                        js_CodeName[*fp->regs->pc],
+                        fp->script->filename,
+                        js_FramePCToLineNumber(cx, fp),
+                        FramePCOffset(fp),
+                        js_CodeName[fp->imacpc ? *fp->imacpc : *fp->regs->pc],
                         lr,
                         lr->exitType,
                         fp->regs->sp - StackBase(fp), 
                         calldepth,
                         cycles));
 
     /* If this trace is part of a tree, later branches might have added additional globals for
        with we don't have any type information available in the side exit. We merge in this
@@ -2876,18 +3618,19 @@ js_ExecuteTree(JSContext* cx, Fragment**
     /* write back interned globals */
     int slots = FlushNativeGlobalFrame(cx, exit_gslots, gslots, globalTypeMap, global);
     if (slots < 0)
         return NULL;
     JS_ASSERT_IF(ngslots != 0, globalFrameSize == STOBJ_NSLOTS(globalObj));
     JS_ASSERT(*(uint64*)&global[globalFrameSize] == 0xdeadbeefdeadbeefLL);
 
     /* write back native stack frame */
-    slots = FlushNativeStackFrame(cx, innermost->calldepth, getTypeMap(innermost) + 
-                                                            innermost->numGlobalSlots, stack, NULL);
+    slots = FlushNativeStackFrame(cx, innermost->calldepth,
+                                  getTypeMap(innermost) + innermost->numGlobalSlots,
+                                  stack, NULL);
     if (slots < 0)
         return NULL;
     JS_ASSERT(unsigned(slots) == innermost->numStackSlots);
 
 #ifdef DEBUG
     // Verify that our state restoration worked
     for (JSStackFrame* fp = cx->fp; fp; fp = fp->down) {
         JS_ASSERT(!fp->callee || JSVAL_IS_OBJECT(fp->argv[-1]));
@@ -2908,81 +3651,96 @@ js_MonitorLoopEdge(JSContext* cx, uintN&
     /* Is the recorder currently active? */
     if (tm->recorder) {
         if (js_RecordLoopEdge(cx, tm->recorder, inlineCallCount))
             return true;
         /* recording was aborted, treat like a regular loop edge hit */
     }
     JS_ASSERT(!tm->recorder);
 
-    /* Do an up-front global shape check, since we'll blow away the jit cache
-       on global shape mismatch, wasting all the other work this method does,
-       if we end up in either js_RecordTree or js_ExecuteTree */
-    uint32 globalShape = OBJ_SHAPE(JS_GetGlobalForObject(cx, cx->fp->scopeChain));
-    if (tm->globalShape != globalShape) {
-        debug_only_v(printf("Global shape mismatch (%u vs. %u) in js_MonitorLoopEdge, flushing cache.\n",
-                            globalShape, tm->globalShape);)
+    
+    /* Check the recovery pool of doubles (this might trigger a GC). */
+    if (tm->recoveryDoublePoolPtr < (tm->recoveryDoublePool + MAX_NATIVE_STACK_SLOTS) &&
+        !js_ReplenishRecoveryPool(cx, tm)) {
+        return false; /* Out of memory, don't try to record now. */
+    }
+    
+    /* Make sure the shape of the global object still matches (this might flush the JIT cache). */
+    JSObject* globalObj = JS_GetGlobalForObject(cx, cx->fp->scopeChain);
+    if (!js_CheckGlobalObjectShape(cx, tm, globalObj))
         js_FlushJITCache(cx);
-        // Press on to at least increment a hit count
-    }
-
-    /* check if our quick cache has an entry for this ip, otherwise ask fragmento. */
+    
     jsbytecode* pc = cx->fp->regs->pc;
+    Fragmento* fragmento = tm->fragmento;
     Fragment* f;
-    JSFragmentCacheEntry* cacheEntry = &tm->fcache[jsuword(pc) & JS_FRAGMENT_CACHE_MASK];
-    if (cacheEntry->pc == pc) {
-        f = cacheEntry->fragment;
-    } else {
-        f = tm->fragmento->getLoop(pc);
-        if (!f)
-            f = tm->fragmento->getAnchor(pc);
-        cacheEntry->pc = pc;
-        cacheEntry->fragment = f;
-    }
-
-    /* If there is a chance that js_ExecuteTree will actually succeed, invoke it (either the
-       first fragment must contain some code, or at least it must have a peer fragment). */
-    SideExit* lr = NULL;
-    SideExit* innermostNestedGuard = NULL;
-    if (f->code() || f->peer)
-        lr = js_ExecuteTree(cx, &f, inlineCallCount, &innermostNestedGuard);
-    if (!lr) {
-        JS_ASSERT(!tm->recorder);
-        /* If we don't have compiled code for this entry point (none recorded or we trashed it),
-           count the number of hits and trigger the recorder if appropriate. */
-        if (!f->code() && (++f->hits() >= HOTLOOP))
-            return js_RecordTree(cx, tm, f);
-        return false;
-    }
+    f = fragmento->getLoop(pc);
+    if (!f)
+        f = fragmento->getAnchor(pc);
+
+    /* If we have no code in the anchor and no peers, we definitively won't be able to 
+       activate any trees so increment the hit counter and start compiling if appropriate. */
+    if (!f->code() && !f->peer) {
+monitor_loop:
+        if (++f->hits() >= HOTLOOP) {
+            /* We can give RecordTree the root peer. If that peer is already taken, it will
+               walk the peer list and find us a free slot or allocate a new tree if needed. */
+            return js_RecordTree(cx, tm, f->first, NULL, NULL);
+        }
+        /* Threshold not reached yet. */
+        return false;
+    }
+    
+    debug_only_v(printf("Looking for compat peer %d@%d, from %p (ip: %p, hits=%d)\n",
+                        js_FramePCToLineNumber(cx, cx->fp), 
+                        FramePCOffset(cx->fp),
+                        f, f->ip, f->hits());)
+    Fragment* match = js_FindVMCompatiblePeer(cx, f);
+    /* If we didn't find a tree that actually matched, keep monitoring the loop. */
+    if (!match) 
+        goto monitor_loop;
+
+    VMSideExit* lr = NULL;
+    VMSideExit* innermostNestedGuard = NULL;
+
+    lr = js_ExecuteTree(cx, match, inlineCallCount, &innermostNestedGuard);
+    if (!lr)
+        return false;
+
     /* If we exit on a branch, or on a tree call guard, try to grow the inner tree (in case
        of a branch exit), or the tree nested around the tree we exited from (in case of the
        tree call guard). */
     switch (lr->exitType) {
-    case BRANCH_EXIT:
-        return js_AttemptToExtendTree(cx, lr, NULL);
-    case LOOP_EXIT:
+      case UNSTABLE_LOOP_EXIT:
+        return js_AttemptToStabilizeTree(cx, lr, NULL);
+      case BRANCH_EXIT:
+        return js_AttemptToExtendTree(cx, lr, NULL, NULL);
+      case LOOP_EXIT:
         if (innermostNestedGuard)
-            return js_AttemptToExtendTree(cx, innermostNestedGuard, lr);
-        return false;
-    default:
+            return js_AttemptToExtendTree(cx, innermostNestedGuard, lr, NULL);
+        return false;
+      default:
         /* No, this was an unusual exit (i.e. out of memory/GC), so just resume interpretation. */
         return false;
     }
 }
 
 bool
 js_MonitorRecording(TraceRecorder* tr)
 {
     JSContext* cx = tr->cx;
 
-    if (tr->walkedOutOfLoop()) {
-        js_CloseLoop(cx);
-        return false;
-    }
-    
+    if (tr->lirbuf->outOmem()) {
+        js_AbortRecording(cx, "no more LIR memory");
+        js_FlushJITCache(cx);
+        return false;
+    }
+
+    if (tr->walkedOutOfLoop())
+        return js_CloseLoop(cx);
+
     // Clear one-shot state used to communicate between record_JSOP_CALL and mid- and post-
     // opcode-case-guts record hooks (record_EnterFrame, record_FastNativeCallComplete).
     tr->applyingArguments = false;
     tr->pendingTraceableNative = NULL;
 
     // In the future, handle dslots realloc by computing an offset from dslots instead.
     if (tr->global_dslots != tr->globalObj->dslots) {
         js_AbortRecording(cx, "globalObj->dslots reallocated");
@@ -3016,35 +3774,51 @@ js_MonitorRecording(TraceRecorder* tr)
         js_DeleteRecorder(cx);
         return false; /* done recording */
     }
 
     /* If it's not a break or a return from a loop, continue recording and follow the trace. */
     return true;
 }
 
+/* If used on a loop trace, blacklists the root peer instead of the given fragment. */
+void
+js_BlacklistPC(Fragmento* frago, Fragment* frag)
+{
+    if (frag->kind == LoopTrace)
+        frag = frago->getLoop(frag->ip);
+    frag->blacklist();
+}
+
 void
 js_AbortRecording(JSContext* cx, const char* reason)
 {
     JSTraceMonitor* tm = &JS_TRACE_MONITOR(cx);
     JS_ASSERT(tm->recorder != NULL);
     AUDIT(recorderAborted);
+
     /* Abort the trace and blacklist its starting point. */
-    if (cx->fp) {
+    JSStackFrame* fp = cx->fp;
+    if (fp) {
         debug_only_v(printf("Abort recording (line %d, pc %d): %s.\n",
-                            js_PCToLineNumber(cx, cx->fp->script, cx->fp->regs->pc),
-                            cx->fp->regs->pc - cx->fp->script->code, reason);)
+                            js_FramePCToLineNumber(cx, fp),
+                            FramePCOffset(fp),
+                            reason);)
     }
     Fragment* f = tm->recorder->getFragment();
     if (!f) {
         js_DeleteRecorder(cx);
         return;
     }
     JS_ASSERT(!f->vmprivate);
-    f->blacklist();
+    js_BlacklistPC(tm->fragmento, f);
+    Fragment* outer = tm->recorder->getOuterToBlacklist();
+    /* Give outer two chances to stabilize before we start blacklisting. */
+    if (outer != NULL && outer->recordAttempts >= 2)
+        js_BlacklistPC(tm->fragmento, outer);
     js_DeleteRecorder(cx);
     /* If this is the primary trace and we didn't succeed compiling, trash the TreeInfo object. */
     if (!f->code() && (f->root == f)) 
         js_TrashTree(cx, f);
 }
 
 #if defined NANOJIT_IA32
 static bool
@@ -3056,39 +3830,41 @@ js_CheckForSSE2()
     {
         pushad
         mov eax, 1
         cpuid
         mov features, edx
         popad
     }
 #elif defined __GNUC__
-    asm("pusha\n"
+    asm("xchg %%esi, %%ebx\n" /* we can't clobber ebx on gcc (PIC register) */
         "mov $0x01, %%eax\n"
         "cpuid\n"
         "mov %%edx, %0\n"
-        "popa\n"
+        "xchg %%esi, %%ebx\n" 
         : "=m" (features)
-        /* We have no inputs */
-        /* We don't clobber anything */
+        : /* We have no inputs */
+        : "%eax", "%esi", "%ecx", "%edx"
        );
 #elif defined __SUNPRO_C || defined __SUNPRO_CC
     asm("push %%ebx\n"
         "mov $0x01, %%eax\n"
         "cpuid\n"
         "pop %%ebx\n"
         : "=d" (features)
         : /* We have no inputs */
         : "%eax", "%ecx"
        );
 #endif
     return (features & (1<<26)) != 0;
 }
 #endif
 
+static void InitIMacroCode();
+
 extern void
 js_InitJIT(JSTraceMonitor *tm)
 {
 #if defined NANOJIT_IA32
     if (!did_we_check_sse2) {
         avmplus::AvmCore::cmov_available =
         avmplus::AvmCore::sse2_available = js_CheckForSSE2();
         did_we_check_sse2 = true;
@@ -3098,82 +3874,91 @@ js_InitJIT(JSTraceMonitor *tm)
         JS_ASSERT(!tm->globalSlots && !tm->globalTypeMap && !tm->recoveryDoublePool);
         Fragmento* fragmento = new (&gc) Fragmento(core, 24);
         verbose_only(fragmento->labels = new (&gc) LabelMap(core, NULL);)
         tm->fragmento = fragmento;
         tm->globalSlots = new (&gc) SlotList();
         tm->globalTypeMap = new (&gc) TypeMap();
         tm->recoveryDoublePoolPtr = tm->recoveryDoublePool = new jsval[MAX_NATIVE_STACK_SLOTS];
     }
+    if (!tm->reFragmento) {
+        Fragmento* fragmento = new (&gc) Fragmento(core, 20);
+        verbose_only(fragmento->labels = new (&gc) LabelMap(core, NULL);)
+        tm->reFragmento = fragmento;
+    }
+    InitIMacroCode();
 #if !defined XP_WIN
     debug_only(memset(&jitstats, 0, sizeof(jitstats)));
 #endif
 }
 
 extern void
 js_FinishJIT(JSTraceMonitor *tm)
 {
-#ifdef DEBUG
+#ifdef JS_JIT_SPEW
     printf("recorder: started(%llu), aborted(%llu), completed(%llu), different header(%llu), "
            "trees trashed(%llu), slot promoted(%llu), unstable loop variable(%llu), "
-           "breaks(%llu), returns(%llu)\n",
+           "breaks(%llu), returns(%llu), unstableInnerCalls(%llu)\n",
            jitstats.recorderStarted, jitstats.recorderAborted, jitstats.traceCompleted,
            jitstats.returnToDifferentLoopHeader, jitstats.treesTrashed, jitstats.slotPromoted,
-           jitstats.unstableLoopVariable, jitstats.breakLoopExits, jitstats.returnLoopExits);
+           jitstats.unstableLoopVariable, jitstats.breakLoopExits, jitstats.returnLoopExits,
+           jitstats.noCompatInnerTrees);
     printf("monitor: triggered(%llu), exits(%llu), type mismatch(%llu), "
            "global mismatch(%llu)\n", jitstats.traceTriggered, jitstats.sideExitIntoInterpreter,
            jitstats.typeMapMismatchAtEntry, jitstats.globalShapeMismatchAtEntry);
 #endif
     if (tm->fragmento != NULL) {
         JS_ASSERT(tm->globalSlots && tm->globalTypeMap && tm->recoveryDoublePool);
         verbose_only(delete tm->fragmento->labels;)
         delete tm->fragmento;
         tm->fragmento = NULL;
         delete tm->globalSlots;
         tm->globalSlots = NULL;
         delete tm->globalTypeMap;
         tm->globalTypeMap = NULL;
         delete[] tm->recoveryDoublePool;
         tm->recoveryDoublePool = tm->recoveryDoublePoolPtr = NULL;
     }
+    if (tm->reFragmento != NULL) {
+        verbose_only(delete tm->reFragmento->labels;)
+        delete tm->reFragmento;
+    }
 }
 
 extern void
 js_FlushJITOracle(JSContext* cx)
 {
     if (!TRACING_ENABLED(cx))
         return;
     oracle.clear();
 }
 
 extern void
 js_FlushJITCache(JSContext* cx)
 {
     if (!TRACING_ENABLED(cx))
         return;
-    debug_only_v(printf("Flushing cache.\n"););
+    debug_only_v(printf("Flushing cache.\n");)
     JSTraceMonitor* tm = &JS_TRACE_MONITOR(cx);
     if (tm->recorder)
         js_AbortRecording(cx, "flush cache");
     Fragmento* fragmento = tm->fragmento;
     if (fragmento) {
         fragmento->clearFrags();
 #ifdef DEBUG
         JS_ASSERT(fragmento->labels);
         delete fragmento->labels;
         fragmento->labels = new (&gc) LabelMap(core, NULL);
 #endif
     }
-    memset(&tm->fcache, 0, sizeof(tm->fcache));
     if (cx->fp) {
         tm->globalShape = OBJ_SHAPE(JS_GetGlobalForObject(cx, cx->fp->scopeChain));
         tm->globalSlots->clear();
         tm->globalTypeMap->clear();
     }
-    tm->jitCacheGen++;
 }
 
 jsval&
 TraceRecorder::argval(unsigned n) const
 {
     JS_ASSERT(n < cx->fp->fun->nargs);
     return cx->fp->argv[n];
 }
@@ -3310,16 +4095,54 @@ LIns* TraceRecorder::makeNumberInt32(LIn
     LIns* x;
     if (!isPromote(f)) {
         x = f2i(f);
         guard(true, lir->ins2(LIR_feq, f, lir->ins1(LIR_i2f, x)), MISMATCH_EXIT);
     } else {
         x = ::demote(lir, f);
     }
     return x;
+}
+
+LIns*
+TraceRecorder::stringify(jsval& v)
+{
+    LIns* v_ins = get(&v);
+    if (JSVAL_IS_STRING(v))
+        return v_ins;
+
+    LIns* args[] = { v_ins, cx_ins };
+    const CallInfo* ci;
+    if (JSVAL_IS_NUMBER(v)) {
+        ci = &js_NumberToString_ci;
+    } else if (JSVAL_TAG(v) == JSVAL_BOOLEAN) {
+        ci = &js_BooleanOrUndefinedToString_ci;
+    } else {
+        JS_ASSERT(JSVAL_IS_OBJECT(v));
+        // This is unsafe until we are able to abort if we re-enter the interpreter.
+        // FIXME: 456511
+        // ci = &js_ObjectToString_ci;
+        return NULL;
+    }
+    v_ins = lir->insCall(ci, args);
+    guard(false, lir->ins_eq0(v_ins), OOM_EXIT);
+    return v_ins;
+}
+
+bool
+TraceRecorder::call_imacro(jsbytecode* imacro)
+{
+    JSStackFrame* fp = cx->fp;
+    JSFrameRegs* regs = fp->regs;
+
+    JS_ASSERT(!fp->imacpc);
+    fp->imacpc = regs->pc;
+    regs->pc = imacro;
+    atoms = COMMON_ATOMS_START(&cx->runtime->atomState);
+    return false;
 }
 
 bool
 TraceRecorder::ifop()
 {
     jsval& v = stackval(-1);
     LIns* v_ins = get(&v);
     bool cond;
@@ -3577,33 +4400,33 @@ TraceRecorder::cmp(LOpcode op, int flags
         } else if (JSVAL_TAG(l) == JSVAL_BOOLEAN) {
             /*
              * What I really want here is for undefined to be type-specialized
              * differently from real booleans.  Failing that, I want to be able
              * to cmov on quads.  Failing that, I want to have small forward
              * branched.  Failing that, I want to be able to ins_choose on quads
              * without cmov.  Failing that, eat flaming builtin!
              */
-            l_ins = lir->insCall(&js_BooleanToNumber_ci, args);
+            l_ins = lir->insCall(&js_BooleanOrUndefinedToNumber_ci, args);
         } else if (!isNumber(l)) {
             ABORT_TRACE("unsupported LHS type for cmp vs number");
         }
         lnum = js_ValueToNumber(cx, &tmp[0]);
 
         args[0] = r_ins;
         args[1] = cx_ins;
         if (r == JSVAL_NULL) {
             jsdpun u;
             u.d = js_NaN;
             r_ins = lir->insImmq(u.u64);
         } else if (JSVAL_IS_STRING(r)) {
             r_ins = lir->insCall(&js_StringToNumber_ci, args);
         } else if (JSVAL_TAG(r) == JSVAL_BOOLEAN) {
             // See above for the sob story.
-            r_ins = lir->insCall(&js_BooleanToNumber_ci, args);
+            r_ins = lir->insCall(&js_BooleanOrUndefinedToNumber_ci, args);
         } else if (!isNumber(r)) {
             ABORT_TRACE("unsupported RHS type for cmp vs number");
         }
         rnum = js_ValueToNumber(cx, &tmp[1]);
         cond = evalCmp(op, lnum, rnum);
     } else if ((JSVAL_TAG(l) == JSVAL_BOOLEAN) && (JSVAL_TAG(r) == JSVAL_BOOLEAN)) {
         // The well-known values of JSVAL_TRUE and JSVAL_FALSE make this very easy.
         // In particular: JSVAL_TO_BOOLEAN(0) < JSVAL_TO_BOOLEAN(1) so all of these comparisons do
@@ -3689,21 +4512,69 @@ TraceRecorder::unary(LOpcode op)
         if (intop)
             a = lir->ins1(LIR_i2f, a);
         set(&v, a);
         return true;
     }
     return false;
 }
 
+static struct {
+    jsbytecode obj_any[13];
+    jsbytecode any_obj[11];
+    jsbytecode obj_obj[22];
+} binary_imacros = {
+    {
+        JSOP_SWAP,
+        JSOP_CALLPROP, 0, COMMON_ATOM_INDEX(valueOf),
+        JSOP_STRING, 0, COMMON_TYPE_ATOM_INDEX(JSTYPE_NUMBER),
+        JSOP_CALL, 0, 1,
+        JSOP_SWAP,
+        JSOP_IMACOP,
+        JSOP_STOP
+    },
+
+    {
+        JSOP_CALLPROP, 0, COMMON_ATOM_INDEX(valueOf),
+        JSOP_STRING, 0, COMMON_TYPE_ATOM_INDEX(JSTYPE_NUMBER),
+        JSOP_CALL, 0, 1,
+        JSOP_IMACOP,
+        JSOP_STOP
+    },
+
+    {
+        JSOP_SWAP,
+        JSOP_CALLPROP, 0, COMMON_ATOM_INDEX(valueOf),
+        JSOP_STRING, 0, COMMON_TYPE_ATOM_INDEX(JSTYPE_NUMBER),
+        JSOP_CALL, 0, 1,
+        JSOP_SWAP,
+        JSOP_CALLPROP, 0, COMMON_ATOM_INDEX(valueOf),
+        JSOP_STRING, 0, COMMON_TYPE_ATOM_INDEX(JSTYPE_NUMBER),
+        JSOP_CALL, 0, 1,
+        JSOP_IMACOP,
+        JSOP_STOP
+    }
+};
+
+JS_STATIC_ASSERT(sizeof(binary_imacros) < IMACRO_PC_ADJ_LIMIT);
+
 bool
 TraceRecorder::binary(LOpcode op)
 {
     jsval& r = stackval(-1);
     jsval& l = stackval(-2);
+
+    if (JSVAL_IS_OBJECT(l) && hasValueOfMethod(l)) {
+        if (JSVAL_IS_OBJECT(r) && hasValueOfMethod(r))
+            return call_imacro(binary_imacros.obj_obj);
+        return call_imacro(binary_imacros.obj_any);
+    }
+    if (JSVAL_IS_OBJECT(r) && hasValueOfMethod(r))
+        return call_imacro(binary_imacros.any_obj);
+
     bool intop = !(op & LIR64);
     LIns* a = get(&l);
     LIns* b = get(&r);
     bool leftNumber = isNumber(l), rightNumber = isNumber(r);
     if ((op >= LIR_sub && op <= LIR_ush) ||  // sub, mul, (callh), or, xor, (not,) lsh, rsh, ush
         (op >= LIR_fsub && op <= LIR_fdiv)) { // fsub, fmul, fdiv
         LIns* args[2];
         if (JSVAL_IS_STRING(l)) {
@@ -3714,22 +4585,24 @@ TraceRecorder::binary(LOpcode op)
         }
         if (JSVAL_IS_STRING(r)) {
             args[0] = b;
             args[1] = cx_ins;
             b = lir->insCall(&js_StringToNumber_ci, args);
             rightNumber = true;
         }
     }
-    if (l == JSVAL_VOID) {
-        a = lir->insImmq(0);
+    if (JSVAL_TAG(l) == JSVAL_BOOLEAN) {
+        LIns* args[] = { a, cx_ins };
+        a = lir->insCall(&js_BooleanOrUndefinedToNumber_ci, args);
         leftNumber = true;
     }
-    if (r == JSVAL_VOID) {
-        b = lir->insImmq(0);
+    if (JSVAL_TAG(r) == JSVAL_BOOLEAN) {
+        LIns* args[] = { b, cx_ins };
+        b = lir->insCall(&js_BooleanOrUndefinedToNumber_ci, args);
         rightNumber = true;
     }
     if (leftNumber && rightNumber) {
         if (intop) {
             LIns *args[] = { a };
             a = lir->insCall(op == LIR_ush ? &js_DoubleToUint32_ci : &js_DoubleToInt32_ci, args);
             b = f2i(b);
         }
@@ -3878,17 +4751,17 @@ TraceRecorder::test_property_cache(JSObj
         JS_ASSERT(entry->kshape == jsuword(aobj));
 #endif
         if (aobj != globalObj) {
             guard(true, addName(lir->ins2i(LIR_eq, obj_ins, entry->kshape), "guard(kobj)"),
                   MISMATCH_EXIT);
         }
     }
 
-    // For any hit that goes up the scope and or proto chains, we will need to
+    // For any hit that goes up the scope and/or proto chains, we will need to
     // guard on the shape of the object containing the property.
     if (PCVCAP_TAG(entry->vcap) >= 1) {
         jsuword vcap = entry->vcap;
         uint32 vshape = PCVCAP_SHAPE(vcap);
         JS_ASSERT(OBJ_SHAPE(obj2) == vshape);
 
         LIns* obj2_ins;
         if (PCVCAP_TAG(entry->vcap) == 1) {
@@ -4095,34 +4968,33 @@ TraceRecorder::getThis(LIns*& this_ins)
         guard(false, lir->ins_eq0(this_ins), MISMATCH_EXIT);
     } else { /* in global code */
         this_ins = scopeChain();
     }
     return true;
 }
 
 bool
-TraceRecorder::guardClass(JSObject* obj, LIns* obj_ins, JSClass* clasp)
+TraceRecorder::guardClass(JSObject* obj, LIns* obj_ins, JSClass* clasp, ExitType exitType)
 {
     bool cond = STOBJ_GET_CLASS(obj) == clasp;
 
     LIns* class_ins = lir->insLoad(LIR_ldp, obj_ins, offsetof(JSObject, classword));
     class_ins = lir->ins2(LIR_piand, class_ins, lir->insImm(~3));
 
     char namebuf[32];
     JS_snprintf(namebuf, sizeof namebuf, "guard(class is %s)", clasp->name);
-    guard(cond, addName(lir->ins2(LIR_eq, class_ins, INS_CONSTPTR(clasp)), namebuf),
-          MISMATCH_EXIT);
+    guard(cond, addName(lir->ins2(LIR_eq, class_ins, INS_CONSTPTR(clasp)), namebuf), exitType);
     return cond;
 }
 
 bool
-TraceRecorder::guardDenseArray(JSObject* obj, LIns* obj_ins)
-{
-    return guardClass(obj, obj_ins, &js_ArrayClass);
+TraceRecorder::guardDenseArray(JSObject* obj, LIns* obj_ins, ExitType exitType)
+{
+    return guardClass(obj, obj_ins, &js_ArrayClass, exitType);
 }
 
 bool
 TraceRecorder::guardDenseArrayIndex(JSObject* obj, jsint idx, LIns* obj_ins,
                                     LIns* dslots_ins, LIns* idx_ins, ExitType exitType)
 {
     jsuint length = ARRAY_DENSE_LENGTH(obj);
 
@@ -4256,17 +5128,17 @@ TraceRecorder::record_EnterFrame()
         ABORT_TRACE("exceeded maximum call depth");
     // FIXME: Allow and attempt to inline a single level of recursion until we compile 
     //        recursive calls as independent trees (459301).
     if (fp->script == fp->down->script && fp->down->down && fp->down->down->script == fp->script)
         ABORT_TRACE("recursive call");
     
     debug_only_v(printf("EnterFrame %s, callDepth=%d\n",
                         js_AtomToPrintableString(cx, cx->fp->fun->atom),
-                        callDepth););
+                        callDepth);)
     LIns* void_ins = INS_CONST(JSVAL_TO_BOOLEAN(JSVAL_VOID));
 
     jsval* vp = &fp->argv[fp->argc];
     jsval* vpstop = vp + ptrdiff_t(fp->fun->nargs) - ptrdiff_t(fp->argc);
     if (applyingArguments) {
         applyingArguments = false;
         while (vp < vpstop) {
             JS_ASSERT(vp >= fp->down->regs->sp);
@@ -4303,17 +5175,18 @@ TraceRecorder::record_LeaveFrame()
 
     // LeaveFrame gets called after the interpreter popped the frame and
     // stored rval, so cx->fp not cx->fp->down, and -1 not 0.
     atoms = cx->fp->script->atomMap.vector;
     set(&stackval(-1), rval_ins, true);
     return true;
 }
 
-bool TraceRecorder::record_JSOP_INTERRUPT()
+bool
+TraceRecorder::record_JSOP_INTERRUPT()
 {
     return false;
 }
 
 bool
 TraceRecorder::record_JSOP_PUSH()
 {
     stack(0, INS_CONST(JSVAL_TO_BOOLEAN(JSVAL_VOID)));
@@ -4331,37 +5204,40 @@ TraceRecorder::record_JSOP_POPV()
     // Store it in cx->fp->rval. NB: Tricky dependencies. cx->fp is the right
     // frame because POPV appears only in global and eval code and we don't
     // trace JSOP_EVAL or leaving the frame where tracing started.
     LIns *fp_ins = lir->insLoad(LIR_ldp, cx_ins, offsetof(JSContext, fp));
     lir->insStorei(rval_ins, fp_ins, offsetof(JSStackFrame, rval));
     return true;
 }
 
-bool TraceRecorder::record_JSOP_ENTERWITH()
-{
-    return false;
-}
-bool TraceRecorder::record_JSOP_LEAVEWITH()
+bool
+TraceRecorder::record_JSOP_ENTERWITH()
+{
+    return false;
+}
+
+bool
+TraceRecorder::record_JSOP_LEAVEWITH()
 {
     return false;
 }
 
 bool
 TraceRecorder::record_JSOP_RETURN()
 {
     jsval& rval = stackval(-1);
     JSStackFrame *fp = cx->fp;
     if ((cx->fp->flags & JSFRAME_CONSTRUCTING) && JSVAL_IS_PRIMITIVE(rval)) {
         JS_ASSERT(OBJECT_TO_JSVAL(fp->thisp) == fp->argv[-1]);
         rval_ins = get(&fp->argv[-1]);
     } else {
         rval_ins = get(&rval);
     }
-    debug_only_v(printf("returning from %s\n", js_AtomToPrintableString(cx, cx->fp->fun->atom)););
+    debug_only_v(printf("returning from %s\n", js_AtomToPrintableString(cx, cx->fp->fun->atom));)
     clearFrameSlotsFromCache();
     return true;
 }
 
 bool
 TraceRecorder::record_JSOP_GOTO()
 {
     return true;
@@ -4405,16 +5281,28 @@ TraceRecorder::record_JSOP_DUP2()
 TraceRecorder::record_JSOP_DUP2()
 {
     stack(0, get(&stackval(-2)));
     stack(1, get(&stackval(-1)));
     return true;
 }
 
 bool
+TraceRecorder::record_JSOP_SWAP()
+{
+    jsval& l = stackval(-2);
+    jsval& r = stackval(-1);
+    LIns* l_ins = get(&l);
+    LIns* r_ins = get(&r);
+    set(&r, l_ins);
+    set(&l, r_ins);
+    return true;
+}
+
+bool
 TraceRecorder::record_JSOP_SETCONST()
 {
     return false;
 }
 
 bool
 TraceRecorder::record_JSOP_BITOR()
 {
@@ -4482,43 +5370,75 @@ TraceRecorder::record_JSOP_RSH()
 }
 
 bool
 TraceRecorder::record_JSOP_URSH()
 {
     return binary(LIR_ush);
 }
 
+static struct {
+    jsbytecode obj_any[10];
+    jsbytecode any_obj[8];
+    jsbytecode obj_obj[16];
+} add_imacros = {
+    {
+        JSOP_SWAP,
+        JSOP_CALLPROP, 0, COMMON_ATOM_INDEX(toString),
+        JSOP_CALL, 0, 0,
+        JSOP_SWAP,
+        JSOP_ADD,
+        JSOP_STOP
+    },
+
+    {
+        JSOP_CALLPROP, 0, COMMON_ATOM_INDEX(toString),
+        JSOP_CALL, 0, 0,
+        JSOP_ADD,
+        JSOP_STOP
+    },
+
+    {
+        JSOP_SWAP,
+        JSOP_CALLPROP, 0, COMMON_ATOM_INDEX(toString),
+        JSOP_CALL, 0, 0,
+        JSOP_SWAP,
+        JSOP_CALLPROP, 0, COMMON_ATOM_INDEX(toString),
+        JSOP_CALL, 0, 0,
+        JSOP_ADD,
+        JSOP_STOP
+    }
+};
+
+JS_STATIC_ASSERT(sizeof(add_imacros) < IMACRO_PC_ADJ_LIMIT);
+
 bool
 TraceRecorder::record_JSOP_ADD()
 {
     jsval& r = stackval(-1);
     jsval& l = stackval(-2);
-    if (JSVAL_IS_STRING(l)) {
-        LIns* args[] = { NULL, get(&l), cx_ins };
-        if (JSVAL_IS_STRING(r)) {
-            args[0] = get(&r);
-        } else {
-            LIns* args2[] = { get(&r), cx_ins };
-            if (JSVAL_IS_NUMBER(r)) {
-                args[0] = lir->insCall(&js_NumberToString_ci, args2);
-            } else if (JSVAL_IS_OBJECT(r)) {
-                args[0] = lir->insCall(&js_ObjectToString_ci, args2);
-            } else {
-                ABORT_TRACE("untraceable right operand to string-JSOP_ADD");
-            }
-            guard(false, lir->ins_eq0(args[0]), OOM_EXIT);
-        }
+
+    if (JSVAL_IS_OBJECT(l) && hasToStringMethod(l)) {
+        if (JSVAL_IS_OBJECT(r) && hasToStringMethod(r))
+            return call_imacro(add_imacros.obj_obj);
+        return call_imacro(add_imacros.obj_any);
+    }
+    if (JSVAL_IS_OBJECT(r) && hasToStringMethod(r))
+        return call_imacro(add_imacros.any_obj);
+
+    if (JSVAL_IS_STRING(l) || JSVAL_IS_STRING(r)) {
+        LIns* args[] = { stringify(r), stringify(l), cx_ins };
+        if (!args[0] || !args[1])
+            ABORT_TRACE("can't stringify objects");
         LIns* concat = lir->insCall(&js_ConcatStrings_ci, args);
         guard(false, lir->ins_eq0(concat), OOM_EXIT);
         set(&l, concat);
         return true;
     }
-    if (JSVAL_IS_STRING(r))
-        ABORT_TRACE("right hand side string not supported in JSOP_ADD");
+
     return binary(LIR_fadd);
 }
 
 bool
 TraceRecorder::record_JSOP_SUB()
 {
     return binary(LIR_fsub);
 }
@@ -4535,16 +5455,25 @@ TraceRecorder::record_JSOP_DIV()
     return binary(LIR_fdiv);
 }
 
 bool
 TraceRecorder::record_JSOP_MOD()
 {
     jsval& r = stackval(-1);
     jsval& l = stackval(-2);
+
+    if (JSVAL_IS_OBJECT(l) && hasValueOfMethod(l)) {
+        if (JSVAL_IS_OBJECT(r) && hasValueOfMethod(r))
+            return call_imacro(binary_imacros.obj_obj);
+        return call_imacro(binary_imacros.obj_any);
+    }
+    if (JSVAL_IS_OBJECT(r) && hasValueOfMethod(r))
+        return call_imacro(binary_imacros.any_obj);
+
     if (isNumber(l) && isNumber(r)) {
         LIns* l_ins = get(&l);
         LIns* r_ins = get(&r);
         LIns* x;
         /* We can't demote this in a filter since we need the actual values of l and r. */
         if (isPromote(l_ins) && isPromote(r_ins) && asNumber(l) >= 0 && asNumber(r) > 0) {
             LIns* args[] = { ::demote(lir, r_ins), ::demote(lir, l_ins) };
             x = lir->insCall(&js_imod_ci, args);
@@ -4630,18 +5559,22 @@ js_fun_apply(JSContext* cx, uintN argc, 
 js_fun_apply(JSContext* cx, uintN argc, jsval* vp);
 
 bool
 TraceRecorder::functionCall(bool constructing)
 {
     JSStackFrame* fp = cx->fp;
     jsbytecode *pc = fp->regs->pc;
     uintN argc = GET_ARGC(pc);
+
     jsval& fval = stackval(0 - (2 + argc));
     JS_ASSERT(&fval >= StackBase(fp));
+
+    if (!VALUE_IS_FUNCTION(cx, fval))
+        ABORT_TRACE("callee is not a function");
 
     jsval& tval = stackval(0 - (argc + 1));
     LIns* this_ins = get(&tval);
 
     if (this_ins->isconstp() && !this_ins->constvalp() && !guardShapelessCallee(fval))
         return false;
 
     /*
@@ -4650,17 +5583,16 @@ TraceRecorder::functionCall(bool constru
      * or JSOP_CALLPROP that callee is a *particular* function, since these hit
      * the property cache and guard on the object (this) in which the callee
      * was found. So it's sufficient to test here that the particular function
      * is interpreted, not guard on that condition.
      *
      * Bytecode sequences that push shapeless callees must guard on the callee
      * class being Function and the function being interpreted.
      */
-    JS_ASSERT(VALUE_IS_FUNCTION(cx, fval));
     JSFunction* fun = GET_FUNCTION_PRIVATE(cx, JSVAL_TO_OBJECT(fval));
 
     if (FUN_INTERPRETED(fun)) {
         if (constructing) {
             LIns* args[] = { get(&fval), cx_ins };
             LIns* tv_ins = lir->insCall(&js_FastNewObject_ci, args);
             guard(false, lir->ins_eq0(tv_ins), OOM_EXIT);
             set(&tval, tv_ins);
@@ -4738,17 +5670,17 @@ TraceRecorder::functionCall(bool constru
         if (FUN_INTERPRETED(tfun))
             ABORT_TRACE("can't trace Function.prototype.apply for scripted functions");
 
         if (!(tfun->flags & JSFUN_TRACEABLE))
             ABORT_TRACE("Function.prototype.apply on untraceable native");
 
         thisval = oval;
         this_ins = get(&oval);
-        arg1_ins = callArgN(aval_ins, 1);
+        arg1_ins = callArgN(aval_ins, 2);
         arg1 = aobj->dslots[0];
         fun = tfun;
         argc = 1;
     }
 
     if (!constructing && !(fun->flags & JSFUN_TRACEABLE))
         ABORT_TRACE("untraceable native");
 
@@ -4817,17 +5749,17 @@ TraceRecorder::functionCall(bool constru
                 *argp = this_ins;
             } else {
                 JS_NOT_REACHED("unknown prefix arg type");
             }
             argp--;
         }
 
         for (i = knownargc; i--; ) {
-            jsval& arg = (!constructing && i == 0 && arg1_ins) ? arg1 : stackval(-(i + 1));
+            jsval& arg = (!constructing && i == 0 && arg1_ins) ? arg1 : stackval(0 - (i + 1));
             *argp = (!constructing && i == 0 && arg1_ins) ? arg1_ins : get(&arg);
 
             argtype = known->argtypes[i];
             if (argtype == 'd' || argtype == 'i') {
                 if (!isNumber(arg))
                     goto next_specialization;
                 if (argtype == 'i')
                     *argp = f2i(*argp);
@@ -5192,17 +6124,17 @@ TraceRecorder::record_JSOP_GETELEM()
 
     /* Property access using a string name. */
     if (JSVAL_IS_STRING(idx)) {
         if (!js_ValueToStringId(cx, idx, &id))
             return false;
         // Store the interned string to the stack to save the interpreter from redoing this work.
         idx = ID_TO_VALUE(id);
         jsuint index;
-        if (js_IdIsIndex(idx, &index) && guardDenseArray(obj, obj_ins)) {
+        if (js_IdIsIndex(idx, &index) && guardDenseArray(obj, obj_ins, BRANCH_EXIT)) {
             v = (index >= ARRAY_DENSE_LENGTH(obj)) ? JSVAL_HOLE : obj->dslots[index];
             if (v == JSVAL_HOLE)
                 ABORT_TRACE("can't see through hole in dense array");
         } else {
             if (!guardElemOp(obj, obj_ins, id, offsetof(JSObjectOps, getProperty), &v))
                 return false;
         }
         LIns* args[] = { idx_ins, obj_ins, cx_ins };
@@ -5277,17 +6209,17 @@ TraceRecorder::record_JSOP_SETELEM()
         LIns* ok_ins = lir->insCall(&js_Any_setprop_ci, args);
         guard(false, lir->ins_eq0(ok_ins), MISMATCH_EXIT);    
     } else if (JSVAL_IS_INT(idx)) {
         if (JSVAL_TO_INT(idx) < 0)
             ABORT_TRACE("negative JSOP_SETELEM index");
         idx_ins = makeNumberInt32(idx_ins);
         LIns* args[] = { boxed_v_ins, idx_ins, obj_ins, cx_ins };
         LIns* res_ins;
-        if (guardDenseArray(obj, obj_ins)) {
+        if (guardDenseArray(obj, obj_ins, BRANCH_EXIT)) {
             res_ins = lir->insCall(&js_Array_dense_setelem_ci, args);
         } else {
             if (!js_IndexToId(cx, JSVAL_TO_INT(idx), &id))
                 return false;
             idx = ID_TO_VALUE(id);
             if (!guardElemOp(obj, obj_ins, id, offsetof(JSObjectOps, setProperty), NULL))
                 return false;
             res_ins = lir->insCall(&js_Any_setelem_ci, args);
@@ -5308,17 +6240,17 @@ TraceRecorder::record_JSOP_CALLNAME()
 TraceRecorder::record_JSOP_CALLNAME()
 {
     JSObject* obj = cx->fp->scopeChain;
     if (obj != globalObj) {
         jsval* vp;
         if (!activeCallOrGlobalSlot(obj, vp))
             return false;
         stack(0, get(vp));
-        stack(1, INS_CONSTPTR(NULL));
+        stack(1, INS_CONSTPTR(globalObj));
         return true;
     }
 
     LIns* obj_ins = scopeChain();
     JSObject* obj2;
     jsuword pcval;
     if (!test_property_cache(obj, obj_ins, obj2, pcval))
         return false;
@@ -5342,19 +6274,16 @@ TraceRecorder::record_JSOP_CALLUPVAR()
 TraceRecorder::record_JSOP_CALLUPVAR()
 {
     ABORT_TRACE("CALLUPVAR");
 }
 
 bool
 TraceRecorder::guardShapelessCallee(jsval& callee)
 {
-    if (!VALUE_IS_FUNCTION(cx, callee))
-        ABORT_TRACE("shapeless callee is not a function");
-
     guard(true,
           addName(lir->ins2(LIR_eq, get(&callee), INS_CONSTPTR(JSVAL_TO_OBJECT(callee))),
                   "guard(shapeless callee)"),
           MISMATCH_EXIT);
     return true;
 }
 
 bool
@@ -5383,77 +6312,84 @@ TraceRecorder::interpretedFunctionCall(j
         *m++ = determineSlotType(vp);
     );
 
     if (argc >= 0x8000)
         ABORT_TRACE("too many arguments");
 
     FrameInfo fi = {
         JSVAL_TO_OBJECT(fval),
-        fp->regs->pc,
+        ENCODE_IP_ADJ(fp, fp->regs->pc),
         typemap,
         { { fp->regs->sp - fp->slots, argc | (constructing ? 0x8000 : 0) } }
     };
 
     unsigned callDepth = getCallDepth();
     if (callDepth >= treeInfo->maxCallDepth)
         treeInfo->maxCallDepth = callDepth + 1;
 
     lir->insStorei(INS_CONSTPTR(fi.callee), lirbuf->rp,
                    callDepth * sizeof(FrameInfo) + offsetof(FrameInfo, callee));
-    lir->insStorei(INS_CONSTPTR(fi.callpc), lirbuf->rp,
-                   callDepth * sizeof(FrameInfo) + offsetof(FrameInfo, callpc));
+    lir->insStorei(INS_CONSTPTR(fi.ip_adj), lirbuf->rp,
+                   callDepth * sizeof(FrameInfo) + offsetof(FrameInfo, ip_adj));
     lir->insStorei(INS_CONSTPTR(fi.typemap), lirbuf->rp,
                    callDepth * sizeof(FrameInfo) + offsetof(FrameInfo, typemap));
     lir->insStorei(INS_CONST(fi.word), lirbuf->rp,
                    callDepth * sizeof(FrameInfo) + offsetof(FrameInfo, word));
 
     atoms = fun->u.i.script->atomMap.vector;
     return true;
 }
 
 bool
 TraceRecorder::record_JSOP_CALL()
 {
     return functionCall(false);
 }
 
 bool
+TraceRecorder::record_JSOP_APPLY()
+{
+    return functionCall(false);
+}
+
+bool
 TraceRecorder::record_FastNativeCallComplete()
 {
     JS_ASSERT(pendingTraceableNative);
     
     /* At this point the generated code has already called the native function
        and we can no longer fail back to the original pc location (JSOP_CALL)
        because that would cause the interpreter to re-execute the native 
        function, which might have side effects.
 
        Instead, snapshot(), which is invoked from unbox_jsval(), will see that
-       we are currently parked on a JOF_RETVAL instruction, and it will advance
-       the pc to restore by the length of the current opcode, and indicate in
-       the type map that the element on top of the stack is a boxed value which
-       doesn't need to be boxed if the type guard generated by unbox_jsval()
-       fails. */
-    JS_ASSERT(js_CodeSpec[*cx->fp->regs->pc].format & JOF_RETVAL);
+       we are currently parked on a traceable native's JSOP_CALL instruction,
+       and it will advance the pc to restore by the length of the current
+       opcode, and indicate in the type map that the element on top of the
+       stack is a boxed value which doesn't need to be boxed if the type guard
+       generated by unbox_jsval() fails. */
+    JS_ASSERT(*cx->fp->regs->pc == JSOP_CALL || 
+              *cx->fp->regs->pc == JSOP_APPLY);
 
     jsval& v = stackval(-1);
     LIns* v_ins = get(&v);
     
     bool ok = true;
     switch (JSTN_ERRTYPE(pendingTraceableNative)) {
-    case FAIL_JSVAL:
+      case FAIL_JSVAL:
         ok = unbox_jsval(v, v_ins);
         if (ok)
             set(&v, v_ins);
         break;
-    case FAIL_NEG:
+      case FAIL_NEG:
         /* Already added i2f in functionCall. */
         JS_ASSERT(JSVAL_IS_NUMBER(v));
         break;
-    default:
+      default:
         /* Convert the result to double if the builtin returns int32. */
         if (JSVAL_IS_NUMBER(v) &&
             (pendingTraceableNative->builtin->_argtypes & 3) == nanojit::ARGSIZE_LO) {
             set(&v, lir->ins1(LIR_i2f, v_ins));
         }
     }
 
     // We'll null pendingTraceableNative in js_MonitorRecording, on the next op cycle.
@@ -5948,100 +6884,176 @@ TraceRecorder::record_JSOP_ARGDEC()
 
 bool
 TraceRecorder::record_JSOP_LOCALDEC()
 {
     return inc(varval(GET_SLOTNO(cx->fp->regs->pc)), -1, false);
 }
 
 bool
+TraceRecorder::record_JSOP_IMACOP()
+{
+    JS_ASSERT(cx->fp->imacpc);
+    return true;
+}
+
+static struct {
+    jsbytecode for_in[10];
+    jsbytecode for_each[10];
+} iter_imacros = {
+    {
+        JSOP_CALLPROP, 0, COMMON_ATOM_INDEX(iterator),
+        JSOP_INT8, JSITER_ENUMERATE,
+        JSOP_CALL, 0, 1,
+        JSOP_PUSH,
+        JSOP_STOP
+    },
+
+    {
+        JSOP_CALLPROP, 0, COMMON_ATOM_INDEX(iterator),
+        JSOP_INT8, JSITER_ENUMERATE | JSITER_FOREACH,
+        JSOP_CALL, 0, 1,
+        JSOP_PUSH,
+        JSOP_STOP
+    }
+};
+
+JS_STATIC_ASSERT(sizeof(iter_imacros) < IMACRO_PC_ADJ_LIMIT);
+
+bool
 TraceRecorder::record_JSOP_ITER()
 {
     jsval& v = stackval(-1);
     if (!JSVAL_IS_PRIMITIVE(v)) {
         jsuint flags = cx->fp->regs->pc[1];
-        LIns* args[] = { get(&v), INS_CONST(flags), cx_ins };
-        LIns* v_ins = lir->insCall(&js_FastValueToIterator_ci, args);
-        guard(false, lir->ins_eq0(v_ins), MISMATCH_EXIT);
+
+        if (!hasIteratorMethod(v)) {
+            LIns* args[] = { get(&v), INS_CONST(flags), cx_ins };
+            LIns* v_ins = lir->insCall(&js_FastValueToIterator_ci, args);
+            guard(false, lir->ins_eq0(v_ins), MISMATCH_EXIT);
+            set(&v, v_ins);
+
+            LIns* void_ins = INS_CONST(JSVAL_TO_BOOLEAN(JSVAL_VOID));
+            stack(0, void_ins);
+            return true;
+        }
+
+        if (flags == JSITER_ENUMERATE)
+            return call_imacro(iter_imacros.for_in);
+        if (flags == (JSITER_ENUMERATE | JSITER_FOREACH))
+            return call_imacro(iter_imacros.for_each);
+        ABORT_TRACE("unimplemented JSITER_* flags");
+    }
+
+    ABORT_TRACE("for-in on a primitive value");
+}
+
+static JSTraceableNative js_FastCallIteratorNext_tn = {
+    NULL,                               // JSFastNative            native;
+    &js_FastCallIteratorNext_ci,        // const nanojit::CallInfo *builtin;
+    "C",                                // const char              *prefix;
+    "o",                                // const char              *argtypes;
+    FAIL_JSVAL                          // uintN                   flags;
+};
+
+static jsbytecode nextiter_imacro[] = {
+    JSOP_POP,
+    JSOP_DUP,
+    JSOP_CALLPROP, 0, COMMON_ATOM_INDEX(next),
+    JSOP_CALL, 0, 0,
+    JSOP_TRUE,
+    JSOP_STOP
+};
+
+JS_STATIC_ASSERT(sizeof(nextiter_imacro) < IMACRO_PC_ADJ_LIMIT);
+
+bool
+TraceRecorder::record_JSOP_NEXTITER()
+{
+    jsval& iterobj_val = stackval(-2);
+    if (!JSVAL_IS_PRIMITIVE(iterobj_val)) {
+        LIns* iterobj_ins = get(&iterobj_val);
+
+        if (guardClass(JSVAL_TO_OBJECT(iterobj_val), iterobj_ins, &js_IteratorClass, BRANCH_EXIT)) {
+            LIns* args[] = { iterobj_ins, cx_ins };
+            LIns* v_ins = lir->insCall(&js_FastCallIteratorNext_ci, args);
+            guard(false, lir->ins2(LIR_eq, v_ins, INS_CONST(JSVAL_ERROR_COOKIE)), OOM_EXIT);
+
+            LIns* flag_ins = lir->ins_eq0(lir->ins2(LIR_eq, v_ins, INS_CONST(JSVAL_HOLE)));
+            stack(-1, v_ins);
+            stack(0, flag_ins);
+
+            pendingTraceableNative = &js_FastCallIteratorNext_tn;
+            return true;
+        }
+
+        // Custom iterator, possibly a generator.
+        return call_imacro(nextiter_imacro);
+    }
+
+    ABORT_TRACE("for-in on a primitive value");
+}
+
+bool
+TraceRecorder::record_IteratorNextComplete()
+{
+    JS_ASSERT(*cx->fp->regs->pc == JSOP_NEXTITER);
+    JS_ASSERT(pendingTraceableNative == &js_FastCallIteratorNext_tn);
+
+    jsval& v = stackval(-2);
+    LIns* v_ins = get(&v);
+    if (unbox_jsval(v, v_ins)) {
         set(&v, v_ins);
         return true;
     }
-
-    ABORT_TRACE("for-in on a primitive value");
-}
-
-bool
-TraceRecorder::forInLoop(jsval* vp)
-{
-    jsval& iterobj_val = stackval(-1);
-    if (!JSVAL_IS_PRIMITIVE(iterobj_val)) {
-        LIns* args[] = { get(&iterobj_val), cx_ins };
-        LIns* v_ins = lir->insCall(&js_FastCallIteratorNext_ci, args);
-        guard(false, lir->ins2(LIR_eq, v_ins, INS_CONST(JSVAL_ERROR_COOKIE)), OOM_EXIT);
-
-        LIns* flag_ins = lir->ins_eq0(lir->ins2(LIR_eq, v_ins, INS_CONST(JSVAL_HOLE)));
-        LIns* iter_ins = get(vp);
-        jsval expected = JSVAL_IS_VOID(*vp) ? JSVAL_STRING : JSVAL_TAG(*vp);
-        if (!box_jsval(expected, iter_ins))
-            return false;
-        iter_ins = lir->ins_choose(flag_ins, v_ins, iter_ins);
-        if (!unbox_jsval(expected, iter_ins))
-            return false;
-        set(vp, iter_ins);
-        stack(0, flag_ins);
-        return true;
-    }
-
-    ABORT_TRACE("for-in on a primitive value");
+    return false;
 }
 
 bool
 TraceRecorder::record_JSOP_ENDITER()
 {
-    LIns* args[] = { stack(-1), cx_ins };
+    LIns* args[] = { stack(-2), cx_ins };
     LIns* ok_ins = lir->insCall(&js_CloseIterator_ci, args);
     guard(false, lir->ins_eq0(ok_ins), MISMATCH_EXIT);
     return true;
 }
 
 bool
 TraceRecorder::record_JSOP_FORNAME()
 {
     jsval* vp;
-    return name(vp) && forInLoop(vp);
+    if (name(vp)) {
+        set(vp, stack(-1));
+        return true;
+    }
+    return false;
 }
 
 bool
 TraceRecorder::record_JSOP_FORPROP()
 {
     return false;
 }
 
 bool
 TraceRecorder::record_JSOP_FORELEM()
 {
-    return false;
+    return record_JSOP_DUP();
 }
 
 bool
 TraceRecorder::record_JSOP_FORARG()
 {
-    return forInLoop(&argval(GET_ARGNO(cx->fp->regs->pc)));
+    return record_JSOP_SETARG();
 }
 
 bool
 TraceRecorder::record_JSOP_FORLOCAL()
 {
-    return forInLoop(&varval(GET_SLOTNO(cx->fp->regs->pc)));
-}
-
-bool
-TraceRecorder::record_JSOP_FORCONST()
-{
-    return false;
+    return record_JSOP_SETLOCAL();
 }
 
 bool
 TraceRecorder::record_JSOP_POPN()
 {
     return true;
 }
 
@@ -6106,24 +7118,25 @@ TraceRecorder::record_JSOP_IN()
         if (!JSVAL_IS_STRING(lval))
             ABORT_TRACE("non-string left operand to JSOP_IN");
         if (!js_ValueToStringId(cx, lval, &id))
             return false;
     }
 
     // Expect what we see at trace recording time (hit or miss) to be the same
     // when executing the trace. Use a builtin helper for named properties, as
-    // forInLoop does. First, handle indexes in dense arrays as a special case.
+    // the for-in tracing code does. First, handle indexes in dense arrays as a
+    // special case.
     JSObject* obj = JSVAL_TO_OBJECT(rval);
     LIns* obj_ins = get(&rval);
 
     bool cond;
     LIns* x;
     do {
-        if (guardDenseArray(obj, obj_ins)) {
+        if (guardDenseArray(obj, obj_ins, BRANCH_EXIT)) {
             if (JSVAL_IS_INT(lval)) {
                 jsint idx = JSVAL_TO_INT(lval);
                 LIns* idx_ins = f2i(get(&lval));
                 LIns* dslots_ins = lir->insLoad(LIR_ldp, obj_ins, offsetof(JSObject, dslots));
                 if (!guardDenseArrayIndex(obj, idx, obj_ins, dslots_ins, idx_ins, MISMATCH_EXIT))
                     ABORT_TRACE("dense array index out of bounds");
 
                 // We can't "see through" a hole to a possible Array.prototype
@@ -6826,25 +7839,33 @@ TraceRecorder::record_JSOP_CALLELEM()
 TraceRecorder::record_JSOP_CALLELEM()
 {
     return false;
 }
 
 bool
 TraceRecorder::record_JSOP_STOP()
 {
+    JSStackFrame *fp = cx->fp;
+
+    if (fp->imacpc) {
+        // End of imacro, so return true to the interpreter immediately. The
+        // interpreter's JSOP_STOP case will return from the imacro, back to
+        // the pc after the calling op, still in the same JSStackFrame.
+        return true;
+    }
+
     /*
      * We know falling off the end of a constructor returns the new object that
      * was passed in via fp->argv[-1], while falling off the end of a function
      * returns undefined.
      *
      * NB: we do not support script rval (eval, API users who want the result
      * of the last expression-statement, debugger API calls).
      */
-    JSStackFrame *fp = cx->fp;
     if (fp->flags & JSFRAME_CONSTRUCTING) {
         JS_ASSERT(OBJECT_TO_JSVAL(fp->thisp) == fp->argv[-1]);
         rval_ins = get(&fp->argv[-1]);
     } else {
         rval_ins = INS_CONST(JSVAL_TO_BOOLEAN(JSVAL_VOID));
     }
     clearFrameSlotsFromCache();
     return true;
@@ -6891,16 +7912,39 @@ TraceRecorder::record_JSOP_LEAVEBLOCK()
 {
     return false;
 }
 
 bool
 TraceRecorder::record_JSOP_GENERATOR()
 {
     return false;
+#if 0
+    JSStackFrame* fp = cx->fp;
+    if (fp->callobj || fp->argsobj || fp->varobj)
+        ABORT_TRACE("can't trace hard-case generator");
+
+    // Generate a type map for the outgoing frame and stash it in the LIR
+    unsigned stackSlots = js_NativeStackSlots(cx, 0/*callDepth*/);
+    LIns* data = lir_buf_writer->skip(stackSlots * sizeof(uint8));
+    uint8* typemap = (uint8 *)data->payload();
+    uint8* m = typemap;
+    /* Determine the type of a store by looking at the current type of the actual value the
+       interpreter is using. For numbers we have to check what kind of store we used last
+       (integer or double) to figure out what the side exit show reflect in its typemap. */
+    FORALL_SLOTS_IN_PENDING_FRAMES(cx, 0/*callDepth*/,
+        *m++ = determineSlotType(vp);
+    );
+    FlushNativeStackFrame(cx, 0, typemap, state.???, NULL);
+
+    LIns* args[] = { INS_CONST(fp->argc), INS_CONSTPTR(fp->callee), cx_ins };
+    LIns* g_ins = lir->insCall(&js_FastNewGenerator_ci, args);
+    guard(false, lir->ins_eq0(g_ins), OOM_EXIT);
+    return true;
+#endif
 }
 
 bool
 TraceRecorder::record_JSOP_YIELD()
 {
     return false;
 }
 
@@ -7075,25 +8119,85 @@ TraceRecorder::record_JSOP_NEWARRAY()
 
 bool
 TraceRecorder::record_JSOP_HOLE()
 {
     stack(0, INS_CONST(JSVAL_TO_BOOLEAN(JSVAL_HOLE)));
     return true;
 }
 
+#ifdef JS_JIT_SPEW
+/* Prints information about entry typemaps and unstable exits for all peers at a PC */
+void
+js_DumpPeerStability(Fragmento* frago, const void* ip)
+{
+    Fragment* f;
+    TreeInfo* ti;
+    bool looped = false;
+    unsigned length = 0;
+
+    for (f = frago->getLoop(ip); f != NULL; f = f->peer) {
+        if (!f->vmprivate)
+            continue;
+        printf("fragment %p:\nENTRY: ", f);
+        ti = (TreeInfo*)f->vmprivate;
+        if (looped)
+            JS_ASSERT(ti->stackTypeMap.length() == length);
+        for (unsigned i = 0; i < ti->stackTypeMap.length(); i++)
+            printf("%d ", ti->stackTypeMap.data()[i]);
+        printf("\n");
+        UnstableExit* uexit = ti->unstableExits;
+        while (uexit != NULL) {
+            printf("EXIT:  ");
+            uint8* m = getTypeMap(uexit->exit) + uexit->exit->numGlobalSlots;
+            for (unsigned i = 0; i < uexit->exit->numStackSlots; i++)
+                printf("%d ", m[i]);
+            printf("\n");
+            uexit = uexit->next;
+        }
+        length = ti->stackTypeMap.length();
+        looped = true;
+    }
+}
+#endif
+
+/*
+ * 17 potentially-converting binary operators:
+ *  | ^ & == != < <= > >= << >> >>> + - * / %
+ */
+JS_STATIC_ASSERT((uintN)(JSOP_MOD - JSOP_BITOR) == 16);
+
+/*
+ * Use an old <ctype.h> trick: bias imacro_code[op] by -1 to allow zero high
+ * FrameInfo.ip_adj byte to mean "not in an imacro".
+ */
+static void
+InitIMacroCode()
+{
+    if (imacro_code[JSOP_NEXTITER]) {
+        JS_ASSERT(imacro_code[JSOP_NEXTITER] == nextiter_imacro - 1);
+        return;
+    }
+
+    for (uintN op = JSOP_BITOR; op <= JSOP_MOD; op++)
+        imacro_code[op] = (jsbytecode*)&binary_imacros - 1;
+
+    // NB: above loop mis-set JSOP_ADD's entry, so order here is crucial.
+    imacro_code[JSOP_ADD] = (jsbytecode*)&add_imacros - 1;
+
+    imacro_code[JSOP_ITER] = (jsbytecode*)&iter_imacros - 1;
+    imacro_code[JSOP_NEXTITER] = nextiter_imacro - 1;
+}
+
 #define UNUSED(n) bool TraceRecorder::record_JSOP_UNUSED##n() { return false; }
 
-UNUSED(74)
-UNUSED(76)
-UNUSED(77)
-UNUSED(78)
-UNUSED(79)
 UNUSED(131)
 UNUSED(201)
 UNUSED(202)
 UNUSED(203)
 UNUSED(204)
 UNUSED(205)
 UNUSED(206)
 UNUSED(207)
+UNUSED(208)
+UNUSED(209)
 UNUSED(219)
 UNUSED(226)
diff -r a4343d61f6ee js/src/jstracer.h
--- a/js/src/jstracer.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jstracer.h	Sat Nov 15 19:43:13 2008 -0500
@@ -39,79 +39,84 @@
  *
  * ***** END LICENSE BLOCK ***** */
 
 #ifndef jstracer_h___
 #define jstracer_h___
 
 #ifdef JS_TRACER
 
+#include "jscntxt.h"
 #include "jsstddef.h"
 #include "jstypes.h"
 #include "jslock.h"
 #include "jsnum.h"
 #include "jsinterp.h"
 #include "jsbuiltins.h"
 
+#if defined(DEBUG) && !defined(JS_JIT_SPEW)
+#define JS_JIT_SPEW
+#endif
+
 template <typename T>
-class Queue : public GCObject {
+class Queue : public avmplus::GCObject {
     T* _data;
     unsigned _len;
     unsigned _max;
-    
+
     void ensure(unsigned size) {
-        while (_max < size) 
+        while (_max < size)
             _max <<= 1;
         _data = (T*)realloc(_data, _max * sizeof(T));
     }
 public:
     Queue(unsigned max = 16) {
         this->_max = max;
         this->_len = 0;
         this->_data = (T*)malloc(max * sizeof(T));
     }
-    
+
     ~Queue() {
         free(_data);
     }
-    
+
     bool contains(T a) {
         for (unsigned n = 0; n < _len; ++n)
             if (_data[n] == a)
                 return true;
         return false;
     }
-    
+
     void add(T a) {
         ensure(_len + 1);
         JS_ASSERT(_len <= _max);
         _data[_len++] = a;
     }
-    
+
     void add(T* chunk, unsigned size) {
         ensure(_len + size);
         JS_ASSERT(_len <= _max);
         memcpy(&_data[_len], chunk, size * sizeof(T));
         _len += size;
     }
-    
+
     void addUnique(T a) {
         if (!contains(a))
             add(a);
     }
-    
+
     void setLength(unsigned len) {
         ensure(len + 1);
         _len = len;
     }
-    
+
     void clear() {
         _len = 0;
     }
-    
+
     unsigned length() const {
         return _len;
     }
 
     T* data() const {
         return _data;
     }
 };
@@ -138,17 +143,17 @@ public:
     bool            has(const void* v) const;
     nanojit::LIns*  get(const void* v) const;
     void            set(const void* v, nanojit::LIns* ins);
     void            clear();
 };
 
 /*
  * The oracle keeps track of slots that should not be demoted to int because we know them
- * to overflow or they result in type-unstable traces. We are using a simple hash table. 
+ * to overflow or they result in type-unstable traces. We are using a simple hash table.
  * Collisions lead to loss of optimization (demotable slots are not demoted) but have no
  * correctness implications.
  */
 #define ORACLE_SIZE 4096
 
 class Oracle {
     avmplus::BitSet _dontDemote;
 public:
@@ -163,57 +168,107 @@ typedef Queue<uint16> SlotList;
 
 class TypeMap : public Queue<uint8> {
 public:
     void captureGlobalTypes(JSContext* cx, SlotList& slots);
     void captureStackTypes(JSContext* cx, unsigned callDepth);
     bool matches(TypeMap& other) const;
 };
 
+enum ExitType {
+    BRANCH_EXIT, 
+    LOOP_EXIT, 
+    NESTED_EXIT,
+    MISMATCH_EXIT,
+    OOM_EXIT,
+    OVERFLOW_EXIT,
+    UNSTABLE_LOOP_EXIT,
+    TIMEOUT_EXIT
+};
+
+struct VMSideExit : public nanojit::SideExit
+{
+    intptr_t ip_adj;
+    intptr_t sp_adj;
+    intptr_t rp_adj;
+    int32_t calldepth;
+    uint32 numGlobalSlots;
+    uint32 numStackSlots;
+    uint32 numStackSlotsBelowCurrentFrame;
+    ExitType exitType;
+};
+
+static inline uint8* getTypeMap(nanojit::SideExit* exit) 
+{ 
+    return (uint8*)(((VMSideExit*)exit) + 1); 
+}
+
+struct InterpState
+{
+    void* sp; /* native stack pointer, stack[0] is spbase[0] */
+    void* rp; /* call stack pointer */
+    void* gp; /* global frame pointer */
+    JSContext *cx; /* current VM context handle */
+    void* eos; /* first unusable word after the native stack */
+    void* eor; /* first unusable word after the call stack */
+    VMSideExit* lastTreeExitGuard; /* guard we exited on during a tree call */
+    VMSideExit* lastTreeCallGuard; /* guard we want to grow from if the tree
+                                      call exit guard mismatched */
+    void* rpAtLastTreeCall; /* value of rp at innermost tree call guard */
+}; 
+
+struct UnstableExit
+{
+    nanojit::Fragment* fragment;
+    VMSideExit* exit;
+    UnstableExit* next;
+};
+
 class TreeInfo MMGC_SUBCLASS_DECL {
     nanojit::Fragment*      fragment;
 public:
     JSScript*               script;
     unsigned                maxNativeStackSlots;
     ptrdiff_t               nativeStackBase;
     unsigned                maxCallDepth;
     TypeMap                 stackTypeMap;
-    unsigned                mismatchCount;
     Queue<nanojit::Fragment*> dependentTrees;
     unsigned                branchCount;
-    Queue<nanojit::SideExit*> sideExits;
+    Queue<VMSideExit*>      sideExits;
+    UnstableExit*           unstableExits;
 
-    TreeInfo(nanojit::Fragment* _fragment) { 
+    TreeInfo(nanojit::Fragment* _fragment) : unstableExits(NULL) {
         fragment = _fragment;
     }
+    ~TreeInfo();
 };
 
 struct FrameInfo {
     JSObject*       callee;     // callee function object
-    jsbytecode*     callpc;     // pc of JSOP_CALL in caller script
+    intptr_t        ip_adj;     // callee script-based pc index and imacro pc
     uint8*          typemap;    // typemap for the stack frame
     union {
         struct {
             uint16  spdist;     // distance from fp->slots to fp->regs->sp at JSOP_CALL
             uint16  argc;       // actual argument count, may be < fun->nargs
         } s;
         uint32      word;       // for spdist/argc LIR store in record_JSOP_CALL
     };
 };
- 
-class TraceRecorder : public GCObject {
+
+class TraceRecorder : public avmplus::GCObject {
     JSContext*              cx;
     JSTraceMonitor*         traceMonitor;
     JSObject*               globalObj;
     Tracker                 tracker;
     Tracker                 nativeFrameTracker;
     char*                   entryTypeMap;
     unsigned                callDepth;
     JSAtom**                atoms;
-    nanojit::SideExit*      anchor;
+    VMSideExit*             anchor;
     nanojit::Fragment*      fragment;
     TreeInfo*               treeInfo;
     nanojit::LirBuffer*     lirbuf;
     nanojit::LirWriter*     lir;
     nanojit::LirBufWriter*  lir_buf_writer;
     nanojit::LirWriter*     verbose_filter;
     nanojit::LirWriter*     cse_filter;
     nanojit::LirWriter*     expr_filter;
@@ -230,39 +285,43 @@ class TraceRecorder : public GCObject {
     bool                    deepAborted;
     bool                    applyingArguments;
     bool                    trashTree;
     nanojit::Fragment*      whichTreeToTrash;
     Queue<jsbytecode*>      cfgMerges;
     jsval*                  global_dslots;
     JSTraceableNative*      pendingTraceableNative;
     bool                    terminate;
-    bool                    isRootFragment;
+    intptr_t                terminate_ip_adj;
+    nanojit::Fragment*      outerToBlacklist;
+    nanojit::Fragment*      promotedPeer;
 
     bool isGlobal(jsval* p) const;
     ptrdiff_t nativeGlobalOffset(jsval* p) const;
     ptrdiff_t nativeStackOffset(jsval* p) const;
-    void import(nanojit::LIns* base, ptrdiff_t offset, jsval* p, uint8& t, 
+    void import(nanojit::LIns* base, ptrdiff_t offset, jsval* p, uint8& t,
                 const char *prefix, uintN index, JSStackFrame *fp);
-    void import(TreeInfo* treeInfo, nanojit::LIns* sp, unsigned ngslots, unsigned callDepth, 
+    void import(TreeInfo* treeInfo, nanojit::LIns* sp, unsigned ngslots, unsigned callDepth,
                 uint8* globalTypeMap, uint8* stackTypeMap);
     void trackNativeStackUse(unsigned slots);
 
     bool lazilyImportGlobalSlot(unsigned slot);
 
-    nanojit::LIns* guard(bool expected, nanojit::LIns* cond, nanojit::ExitType exitType);
+    nanojit::LIns* guard(bool expected, nanojit::LIns* cond, ExitType exitType);
     nanojit::LIns* guard(bool expected, nanojit::LIns* cond, nanojit::LIns* exit);
     nanojit::LIns* addName(nanojit::LIns* ins, const char* name);
 
     nanojit::LIns* get(jsval* p) const;
     nanojit::LIns* writeBack(nanojit::LIns* i, nanojit::LIns* base, ptrdiff_t offset);
     void set(jsval* p, nanojit::LIns* l, bool initializing = false);
 
-    bool checkType(jsval& v, uint8 type, bool& recompile);
-    bool verifyTypeStability();
+    bool checkType(jsval& v, uint8 t, jsval*& stage_val, nanojit::LIns*& stage_ins,
+                   unsigned& stage_count);
+    bool deduceTypeStability(nanojit::Fragment* root_peer, nanojit::Fragment** stable_peer,
+                             unsigned* demotes);
 
     jsval& argval(unsigned n) const;
     jsval& varval(unsigned n) const;
     jsval& stackval(int n) const;
 
     nanojit::LIns* scopeChain() const;
     bool activeCallOrGlobalSlot(JSObject* obj, jsval*& vp);
 
@@ -270,17 +329,20 @@ class TraceRecorder : public GCObject {
     void arg(unsigned n, nanojit::LIns* i);
     nanojit::LIns* var(unsigned n);
     void var(unsigned n, nanojit::LIns* i);
     nanojit::LIns* stack(int n);
     void stack(int n, nanojit::LIns* i);
 
     nanojit::LIns* f2i(nanojit::LIns* f);
     nanojit::LIns* makeNumberInt32(nanojit::LIns* f);
-    
+    nanojit::LIns* stringify(jsval& v);
+
+    bool call_imacro(jsbytecode* imacro);
+
     bool ifop();
     bool switchop();
     bool inc(jsval& v, jsint incr, bool pre = true);
     bool inc(jsval& v, nanojit::LIns*& v_ins, jsint incr, bool pre = true);
     bool incProp(jsint incr, bool pre = true);
     bool incElem(jsint incr, bool pre = true);
     bool incName(jsint incr, bool pre = true);
 
@@ -304,111 +366,144 @@ class TraceRecorder : public GCObject {
                         nanojit::LIns*& dslots_ins, nanojit::LIns* v_ins);
     nanojit::LIns* stobj_get_fslot(nanojit::LIns* obj_ins, unsigned slot);
     nanojit::LIns* stobj_get_slot(nanojit::LIns* obj_ins, unsigned slot,
                                   nanojit::LIns*& dslots_ins);
     bool native_set(nanojit::LIns* obj_ins, JSScopeProperty* sprop,
                     nanojit::LIns*& dslots_ins, nanojit::LIns* v_ins);
     bool native_get(nanojit::LIns* obj_ins, nanojit::LIns* pobj_ins, JSScopeProperty* sprop,
                     nanojit::LIns*& dslots_ins, nanojit::LIns*& v_ins);
-    
+
     bool name(jsval*& vp);
     bool prop(JSObject* obj, nanojit::LIns* obj_ins, uint32& slot, nanojit::LIns*& v_ins);
     bool elem(jsval& oval, jsval& idx, jsval*& vp, nanojit::LIns*& v_ins, nanojit::LIns*& addr_ins);
 
     bool getProp(JSObject* obj, nanojit::LIns* obj_ins);
     bool getProp(jsval& v);
     bool getThis(nanojit::LIns*& this_ins);
 
     bool box_jsval(jsval v, nanojit::LIns*& v_ins);
     bool unbox_jsval(jsval v, nanojit::LIns*& v_ins);
-    bool guardClass(JSObject* obj, nanojit::LIns* obj_ins, JSClass* clasp);
-    bool guardDenseArray(JSObject* obj, nanojit::LIns* obj_ins);
+    bool guardClass(JSObject* obj, nanojit::LIns* obj_ins, JSClass* clasp,
+                    ExitType exitType = MISMATCH_EXIT);
+    bool guardDenseArray(JSObject* obj, nanojit::LIns* obj_ins,
+                         ExitType exitType = MISMATCH_EXIT);
     bool guardDenseArrayIndex(JSObject* obj, jsint idx, nanojit::LIns* obj_ins,
-                              nanojit::LIns* dslots_ins, nanojit::LIns* idx_ins, 
-                              nanojit::ExitType exitType);
+                              nanojit::LIns* dslots_ins, nanojit::LIns* idx_ins,
+                              ExitType exitType);
     bool guardElemOp(JSObject* obj, nanojit::LIns* obj_ins, jsid id, size_t op_offset, jsval* vp);
     void clearFrameSlotsFromCache();
     bool guardShapelessCallee(jsval& callee);
     bool interpretedFunctionCall(jsval& fval, JSFunction* fun, uintN argc, bool constructing);
     bool functionCall(bool constructing);
-    bool forInLoop(jsval* vp);
 
     void trackCfgMerges(jsbytecode* pc);
     void flipIf(jsbytecode* pc, bool& cond);
     void fuseIf(jsbytecode* pc, bool cond, nanojit::LIns* x);
 
+    bool hasMethod(JSObject* obj, jsid id);
+    bool hasToStringMethod(JSObject* obj);
+    bool hasToStringMethod(jsval v) {
+        JS_ASSERT(JSVAL_IS_OBJECT(v));
+        return hasToStringMethod(JSVAL_TO_OBJECT(v));
+    }
+    bool hasValueOfMethod(JSObject* obj);
+    bool hasValueOfMethod(jsval v) {
+        JS_ASSERT(JSVAL_IS_OBJECT(v));
+        return hasValueOfMethod(JSVAL_TO_OBJECT(v));
+    }
+    bool hasIteratorMethod(JSObject* obj);
+    bool hasIteratorMethod(jsval v) {
+        JS_ASSERT(JSVAL_IS_OBJECT(v));
+        return hasIteratorMethod(JSVAL_TO_OBJECT(v));
+    }
+
 public:
     friend bool js_MonitorRecording(TraceRecorder* tr);
 
-    TraceRecorder(JSContext* cx, nanojit::SideExit*, nanojit::Fragment*, TreeInfo*,
-            unsigned ngslots, uint8* globalTypeMap, uint8* stackTypeMap, 
-            nanojit::SideExit* expectedInnerExit);
+    TraceRecorder(JSContext* cx, VMSideExit*, nanojit::Fragment*, TreeInfo*,
+                  unsigned ngslots, uint8* globalTypeMap, uint8* stackTypeMap,
+                  VMSideExit* expectedInnerExit, nanojit::Fragment* outerToBlacklist);
     ~TraceRecorder();
 
     uint8 determineSlotType(jsval* vp) const;
-    nanojit::LIns* snapshot(nanojit::ExitType exitType);
+    nanojit::LIns* snapshot(ExitType exitType);
     nanojit::Fragment* getFragment() const { return fragment; }
     bool isLoopHeader(JSContext* cx) const;
     void compile(nanojit::Fragmento* fragmento);
-    void closeLoop(nanojit::Fragmento* fragmento);
+    bool closeLoop(nanojit::Fragmento* fragmento, bool& demote, unsigned *demotes);
     void endLoop(nanojit::Fragmento* fragmento);
+    void joinEdgesToEntry(nanojit::Fragmento* fragmento, nanojit::Fragment* peer_root);
     void blacklist() { fragment->blacklist(); }
-    bool adjustCallerTypes(nanojit::Fragment* f);
-    bool selectCallablePeerFragment(nanojit::Fragment** first);
+    bool adjustCallerTypes(nanojit::Fragment* f, unsigned* demote_slots, bool& trash);
+    nanojit::Fragment* findNestedCompatiblePeer(nanojit::Fragment* f, nanojit::Fragment** empty);
     void prepareTreeCall(nanojit::Fragment* inner);
-    void emitTreeCall(nanojit::Fragment* inner, nanojit::SideExit* exit);
+    void emitTreeCall(nanojit::Fragment* inner, VMSideExit* exit);
     unsigned getCallDepth() const;
-    void safeCleanup();
-    
+
     bool record_EnterFrame();
     bool record_LeaveFrame();
     bool record_SetPropHit(JSPropCacheEntry* entry, JSScopeProperty* sprop);
     bool record_SetPropMiss(JSPropCacheEntry* entry);
     bool record_DefLocalFunSetSlot(uint32 slot, JSObject* obj);
     bool record_FastNativeCallComplete();
-    
+    bool record_IteratorNextComplete();
+
+    nanojit::Fragment* getOuterToBlacklist() { return outerToBlacklist; }
     void deepAbort() { deepAborted = true; }
     bool wasDeepAborted() { return deepAborted; }
     bool walkedOutOfLoop() { return terminate; }
-    
+    void setPromotedPeer(nanojit::Fragment* peer) { promotedPeer = peer; }
+    TreeInfo* getTreeInfo() { return treeInfo; }
+
 #define OPDEF(op,val,name,token,length,nuses,ndefs,prec,format)               \
     bool record_##op();
 # include "jsopcode.tbl"
 #undef OPDEF
 };
 
 #define TRACING_ENABLED(cx)       JS_HAS_OPTION(cx, JSOPTION_JIT)
 #define TRACE_RECORDER(cx)        (JS_TRACE_MONITOR(cx).recorder)
 #define SET_TRACE_RECORDER(cx,tr) (JS_TRACE_MONITOR(cx).recorder = (tr))
 
-// See jsinterp.cpp for the ENABLE_TRACER definition.
+#define JSOP_IS_BINARY(op) ((uintN)((op) - JSOP_BITOR) <= (uintN)(JSOP_MOD - JSOP_BITOR))
+
+/*
+ * See jsinterp.cpp for the ENABLE_TRACER definition. Also note how comparing x
+ * to JSOP_* constants specializes trace-recording code at compile time either
+ * to include imacro support, or exclude it altogether for this particular x.
+ */
 #define RECORD_ARGS(x,args)                                                   \
     JS_BEGIN_MACRO                                                            \
-        TraceRecorder* tr_ = TRACE_RECORDER(cx);                              \
-        if (!js_MonitorRecording(tr_))                                        \
+        if (!js_MonitorRecording(TRACE_RECORDER(cx))) {                       \
             ENABLE_TRACER(0);                                                 \
-        else                                                                  \
-            TRACE_ARGS_(tr_,x,args);                                          \
+        } else {                                                              \
+            TRACE_ARGS_(x, args,                                              \
+                if (fp->imacpc &&                                             \
+                    (x == JSOP_ITER || x == JSOP_NEXTITER ||                  \
+                    JSOP_IS_BINARY(x))) {                                     \
+                    atoms = COMMON_ATOMS_START(&rt->atomState);               \
+                    op = JSOp(*regs.pc);                                      \
+                    DO_OP();                                                  \
+                }                                                             \
+            );                                                                \
+         }                                                                    \
     JS_END_MACRO
 
-#define TRACE_ARGS_(tr,x,args)                                                \
+#define TRACE_ARGS_(x,args,onfalse)                                           \
     JS_BEGIN_MACRO                                                            \
-        if (!tr->record_##x args) {                                           \
+        TraceRecorder* tr_ = TRACE_RECORDER(cx);                              \
+        if (tr_ && !tr_->record_##x args) {                                   \
+            onfalse                                                           \
             js_AbortRecording(cx, #x);                                        \
             ENABLE_TRACER(0);                                                 \
         }                                                                     \
     JS_END_MACRO
 
-#define TRACE_ARGS(x,args)                                                    \
-    JS_BEGIN_MACRO                                                            \
-        TraceRecorder* tr_ = TRACE_RECORDER(cx);                              \
-        if (tr_)                                                              \
-            TRACE_ARGS_(tr_, x, args);                                        \
-    JS_END_MACRO
+#define TRACE_ARGS(x,args)      TRACE_ARGS_(x, args, )
 
 #define RECORD(x)               RECORD_ARGS(x, ())
 #define TRACE_0(x)              TRACE_ARGS(x, ())
 #define TRACE_1(x,a)            TRACE_ARGS(x, (a))
 #define TRACE_2(x,a,b)          TRACE_ARGS(x, (a, b))
 
 extern bool
 js_MonitorLoopEdge(JSContext* cx, uintN& inlineCallCount);
diff -r a4343d61f6ee js/src/jsxdrapi.h
--- a/js/src/jsxdrapi.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsxdrapi.h	Sat Nov 15 19:43:13 2008 -0500
@@ -199,17 +199,17 @@ JS_XDRFindClassById(JSXDRState *xdr, uin
  * Bytecode version number. Increment the subtrahend whenever JS bytecode
  * changes incompatibly.
  *
  * This version number should be XDR'ed once near the front of any file or
  * larger storage unit containing XDR'ed bytecode and other data, and checked
  * before deserialization of bytecode.  If the saved version does not match
  * the current version, abort deserialization and invalidate the file.
  */
-#define JSXDR_BYTECODE_VERSION      (0xb973c0de - 35)
+#define JSXDR_BYTECODE_VERSION      (0xb973c0de - 37)
 
 /*
  * Library-private functions.
  */
 extern JSBool
 js_XDRAtom(JSXDRState *xdr, JSAtom **atomp);
 
 extern JSBool
diff -r a4343d61f6ee js/src/jsxml.cpp
--- a/js/src/jsxml.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/jsxml.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -1876,17 +1876,17 @@ ParseXMLSource(JSContext *cx, JSString *
     for (fp = cx->fp; fp && !fp->regs; fp = fp->down)
         JS_ASSERT(!fp->script);
     filename = NULL;
     lineno = 1;
     if (fp) {
         op = (JSOp) *fp->regs->pc;
         if (op == JSOP_TOXML || op == JSOP_TOXMLLIST) {
             filename = fp->script->filename;
-            lineno = js_PCToLineNumber(cx, fp->script, fp->regs->pc);
+            lineno = js_FramePCToLineNumber(cx, fp);
             for (endp = srcp + srclen; srcp < endp; srcp++) {
                 if (*srcp == '\n')
                     --lineno;
             }
         }
     }
 
     if (!js_InitParseContext(cx, &pc, NULL, NULL, chars, length, NULL,
diff -r a4343d61f6ee js/src/nanojit/Assembler.cpp
--- a/js/src/nanojit/Assembler.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/nanojit/Assembler.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -291,16 +291,18 @@ namespace nanojit
 			nMarkExecute(page);
 			_stats.pages++;
 		}
 		else
 		{
 			// return prior page (to allow overwrites) and mark out of mem 
 			page = list;
 			setError(OutOMem);
+			if (!list)
+				return NULL;
 		}
 		return &page->code[sizeof(page->code)/sizeof(NIns)]; // just past the end
 	}
 	
 	void Assembler::pageReset()
 	{
 		pagesFree(_nativePages);		
 		pagesFree(_nativeExitPages);
@@ -658,30 +660,49 @@ namespace nanojit
 		registerAlloc(rmask(r));
 		_allocator.addFree(r);
 	}
 
     void Assembler::patch(GuardRecord *lr)
     {
         Fragment *frag = lr->exit->target;
 		NanoAssert(frag->fragEntry != 0);
-		NIns* was = asm_adjustBranch((NIns*)lr->jmp, frag->fragEntry);
+		NIns* was = nPatchBranch((NIns*)lr->jmpToTarget, frag->fragEntry);
 		verbose_only(verbose_outputf("patching jump at %p to target %p (was %p)\n",
-			lr->jmp, frag->fragEntry, was);)
+			lr->jmpToTarget, frag->fragEntry, was);)
+		(void)was;
     }
 
     void Assembler::patch(SideExit *exit)
     {
         GuardRecord *rec = exit->guards;
         AvmAssert(rec);
         while (rec) {
             patch(rec);
             rec = rec->next;
         }
     }
+
+	void Assembler::disconnectLoop(GuardRecord *lr)
+	{
+        NanoAssert(lr->stubEntry);
+        NIns* was = nPatchBranch((NIns*)lr->jmpToStub, (NIns*)lr->stubEntry);
+        verbose_only(verbose_outputf("disconnected loop-jump at %p: exiting to %p (was looping to %p)\n",
+                                     lr->jmpToStub, lr->stubEntry, was);)
+        NanoAssert(lr->exit->from->loopEntry == was);
+	}
+
+	void Assembler::reconnectLoop(GuardRecord *lr)
+	{
+        NanoAssert(lr->exit->from->loopEntry);
+        NIns* was = nPatchBranch((NIns*)lr->jmpToStub, lr->exit->from->loopEntry);
+        verbose_only(verbose_outputf("reconnected loop-jump at %p: looping to %p (was exiting to %p)\n",
+                                     lr->jmpToStub, lr->exit->from->loopEntry, was);)
+        NanoAssert(lr->stubEntry == was);
+	}
     
     NIns* Assembler::asm_exit(LInsp guard)
     {
 		SideExit *exit = guard->record()->exit;
 		NIns* at = 0;
 		if (!_branchStateMap->get(exit))
 		{
 			at = asm_leave_trace(guard);
@@ -719,49 +740,46 @@ namespace nanojit
 		swapptrs();
 		_inExit = true;
 		
 		//verbose_only( verbose_outputf("         LIR_xend swapptrs, _nIns is now %08X(%08X), _nExitIns is now %08X(%08X)",_nIns, *_nIns,_nExitIns,*_nExitIns) );
 		debug_only( _sv_fpuStkDepth = _fpuStkDepth; _fpuStkDepth = 0; )
 
 		nFragExit(guard);
 
-		// restore the callee-saved register (aka saved params)
-		assignSavedParams();
-
-        // restore first parameter, the only one we use
-        LInsp state = _thisfrag->lirbuf->state;
-        findSpecificRegFor(state, argRegs[state->imm8()]); 
+		// restore the callee-saved register and parameters
+		assignSavedRegs();
+		assignParamRegs();
 
 		intersectRegisterState(capture);
 
 		// this can be useful for breaking whenever an exit is taken
 		//INT3();
 		//NOP();
 
 		// we are done producing the exit logic for the guard so demark where our exit block code begins
-		NIns* jmpTarget = _nIns;	 // target in exit path for our mainline conditional jump 
+		guard->record()->stubEntry = _nIns;	 // target in exit path for our mainline conditional jump 
 
 		// swap back pointers, effectively storing the last location used in the exit path
 		swapptrs();
 		_inExit = false;
 		
 		//verbose_only( verbose_outputf("         LIR_xt/xf swapptrs, _nIns is now %08X(%08X), _nExitIns is now %08X(%08X)",_nIns, *_nIns,_nExitIns,*_nExitIns) );
-		verbose_only( verbose_outputf("        %p:",jmpTarget);)
+		verbose_only( verbose_outputf("        %p:",guard->record()->stubEntry);)
 		verbose_only( verbose_outputf("--------------------------------------- exit block (LIR_xt|LIR_xf)") );
 
 #ifdef NANOJIT_IA32
-		NanoAssertMsgf(_fpuStkDepth == _sv_fpuStkDepth, "LIR_xtf, _fpuStkDepth=%d, expect %d\n",_fpuStkDepth, _sv_fpuStkDepth);
+		NanoAssertMsgf(_fpuStkDepth == _sv_fpuStkDepth, "LIR_xtf, _fpuStkDepth=%d, expect %d",_fpuStkDepth, _sv_fpuStkDepth);
 		debug_only( _fpuStkDepth = _sv_fpuStkDepth; _sv_fpuStkDepth = 9999; )
 #endif
 
         verbose_only( _verbose = priorVerbose; )
         verbose_only(_stats.exitnative += (_stats.native-nativeSave));
 
-        return jmpTarget;
+        return (NIns*) guard->record()->stubEntry;
     }
 	
 	void Assembler::beginAssembly(Fragment *frag, RegAllocMap* branchStateMap)
 	{
         _thisfrag = frag;
 		_activation.lowwatermark = 1;
 		_activation.tos = _activation.lowwatermark;
 		_activation.highwatermark = _activation.tos;
@@ -804,33 +822,33 @@ namespace nanojit
 	void Assembler::assemble(Fragment* frag,  NInsList& loopJumps)
 	{
 		if (error()) return;	
 		AvmCore *core = _frago->core();
         _thisfrag = frag;
 
 		// set up backwards pipeline: assembler -> StackFilter -> LirReader
 		LirReader bufreader(frag->lastIns);
-		GC *gc = core->gc;
+		avmplus::GC *gc = core->gc;
 		StackFilter storefilter1(&bufreader, gc, frag->lirbuf, frag->lirbuf->sp);
 		StackFilter storefilter2(&storefilter1, gc, frag->lirbuf, frag->lirbuf->rp);
 		DeadCodeFilter deadfilter(&storefilter2, frag->lirbuf->_functions);
 		LirFilter* rdr = &deadfilter;
 		verbose_only(
 			VerboseBlockReader vbr(rdr, this, frag->lirbuf->names);
 			if (verbose_enabled())
 				rdr = &vbr;
 		)
 
 		verbose_only(_thisfrag->compileNbr++; )
 		verbose_only(_frago->_stats.compiles++; )
 		verbose_only(_frago->_stats.totalCompiles++; )
 		_inExit = false;	
         gen(rdr, loopJumps);
-		frag->fragEntry = _nIns;
+		frag->loopEntry = _nIns;
 		//frag->outbound = core->config.tree_opt? _latestGuard : 0;
 		//fprintf(stderr, "assemble frag %X entry %X\n", (int)frag, (int)frag->fragEntry);
 
         if (!error()) {
 		    // patch all branches
 		    while(!_patches.isEmpty())
 		    {
 			    NIns* where = _patches.lastKey();
@@ -847,62 +865,63 @@ namespace nanojit
 		    }
         }
 	}
 
 	void Assembler::endAssembly(Fragment* frag, NInsList& loopJumps)
 	{
 	    NIns* SOT = 0;
 	    if (frag->isRoot()) {
-	        SOT = _nIns;
+	        SOT = frag->loopEntry;
             verbose_only( verbose_outputf("        %p:",_nIns); )
 	    } else {
 	        SOT = frag->root->fragEntry;
 	    }
         AvmAssert(SOT);
 		while(!loopJumps.isEmpty())
 		{
 			NIns* loopJump = (NIns*)loopJumps.removeLast();
             verbose_only( verbose_outputf("patching %p to %p", loopJump, SOT); )
 			nPatchBranch(loopJump, SOT);
 		}
 
-		NIns* patchEntry = 0;
+		NIns* fragEntry = 0;
+		
 		if (!error())
 		{
-			patchEntry = genPrologue();
+			fragEntry = genPrologue();
 			verbose_only( verbose_outputf("        %p:",_nIns); )
 			verbose_only( verbose_output("        prologue"); )
 		}
 		
 		// something bad happened?
 		if (!error())
 		{
 			// check for resource leaks 
 			debug_only( 
 				for(uint32_t i=_activation.lowwatermark;i<_activation.highwatermark; i++) {
-					NanoAssertMsgf(_activation.entry[i] == 0, "frame entry %d wasn't freed\n",-4*i);
+					NanoAssertMsgf(_activation.entry[i] == 0, "frame entry %d wasn't freed",-4*i);
 				}
 			)
 
-            frag->fragEntry = patchEntry;
+            frag->fragEntry = fragEntry;
 			NIns* code = _nIns;
 #ifdef PERFM
 			_nvprof("code", codeBytes());  // requires that all pages are released between begin/endAssembly()otherwise we double count
 #endif
 			// let the fragment manage the pages if we're using trees and there are branches
 			Page* manage = (_frago->core()->config.tree_opt) ? handoverPages() : 0;			
 			frag->setCode(code, manage); // root of tree should manage all pages
 			//fprintf(stderr, "endAssembly frag %X entry %X\n", (int)frag, (int)frag->fragEntry);
 		}
 		
-		NanoAssertMsgf(error() || _fpuStkDepth == 0,"_fpuStkDepth %d\n",_fpuStkDepth);
+		NanoAssertMsgf(error() || _fpuStkDepth == 0,"_fpuStkDepth %d",_fpuStkDepth);
 
 		internalReset();  // clear the reservation tables and regalloc
-		NanoAssert(_branchStateMap->isEmpty());
+		NanoAssert(!_branchStateMap || _branchStateMap->isEmpty());
 		_branchStateMap = 0;
 
 #ifdef AVMPLUS_ARM
 		// If we've modified the code, we need to flush so we don't end up trying 
 		// to execute junk
 # if defined(UNDER_CE)
 		FlushInstructionCache(GetCurrentProcess(), NULL, NULL);
 # elif defined(AVMPLUS_UNIX)
@@ -1014,47 +1033,47 @@ namespace nanojit
 		NanoAssert(reader->pos()->isop(LIR_x) || reader->pos()->isop(LIR_loop));
 		 
 		for (LInsp ins = reader->read(); ins != 0 && !error(); ins = reader->read())
 		{
 			LOpcode op = ins->opcode();			
 			switch(op)
 			{
 				default:
-					NanoAssertMsgf(false, "unsupported LIR instruction: %d (~0x40: %d)\n", op, op&~LIR64);
+					NanoAssertMsgf(false, "unsupported LIR instruction: %d (~0x40: %d)", op, op&~LIR64);
 					break;
 					
                 case LIR_live: {
                     countlir_live();
                     pending_lives.add(ins->oprnd1());
                     break;
                 }
 
                 case LIR_ret:  {
                     countlir_ret();
                     if (_nIns != _epilogue) {
                         JMP(_epilogue);
                     }
-                    assignSavedParams();
+                    assignSavedRegs();
 #ifdef NANOJIT_ARM
                     // the epilogue moves R2 to R0; we may want to do this
-                    // after assignSavedParams
+                    // after assignSavedRegs
                     findSpecificRegFor(ins->oprnd1(), R2);
 #else
                     findSpecificRegFor(ins->oprnd1(), retRegs[0]);
 #endif
                     break;
                 }
 
                 case LIR_fret: {
                     countlir_ret();
                     if (_nIns != _epilogue) {
                         JMP(_epilogue);
                     }
-                    assignSavedParams();
+                    assignSavedRegs();
 #ifdef NANOJIT_IA32
                     findSpecificRegFor(ins->oprnd1(), FST0);
 #else
                     NanoAssert(false);
 #endif
                     fpu_pop();
                     break;
                 }
@@ -1125,16 +1144,17 @@ namespace nanojit
 				{
                     countlir_cmov();
 					asm_cmov(ins);
 					break;
 				}				
 				case LIR_ld:
 				case LIR_ldc:
 				case LIR_ldcb:
+				case LIR_ldcs:
 				{
                     countlir_ld();
 					asm_ld(ins);
 					break;
 				}
 				case LIR_ldq:
 				case LIR_ldqc:
 				{
@@ -1280,32 +1300,32 @@ namespace nanojit
 				{
                     countlir_jcc();
 					LInsp to = ins->getTarget();
 					LIns* cond = ins->oprnd1();
                     LabelState *label = _labels.get(to);
                     if (label && label->addr) {
                         // forward jump to known label.  need to merge with label's register state.
                         unionRegisterState(label->regs);
-    					asm_branch(op == LIR_jf, cond, label->addr);
+    					asm_branch(op == LIR_jf, cond, label->addr, false);
                     }
                     else {
                         // back edge.
                         hasLoop = true;
                         handleLoopCarriedExprs();
                         if (!label) {
                             // evict all registers, most conservative approach.
                             evictRegs(~_allocator.free);
                             _labels.add(to, 0, _allocator);
                         } 
                         else {
                             // evict all registers, most conservative approach.
                             intersectRegisterState(label->regs);
                         }
-                        NIns *branch = asm_branch(op == LIR_jf, cond, 0);
+                        NIns *branch = asm_branch(op == LIR_jf, cond, 0, false);
 			            _patches.put(branch,to);
                         verbose_only(
                             verbose_outputf("Loop %s -> %s", 
                                 lirNames[ins->opcode()], 
                                 _thisfrag->lirbuf->names->formatRef(to));
                         )
                     }
 					break;
@@ -1335,32 +1355,34 @@ namespace nanojit
 
                 case LIR_xt:
 				case LIR_xf:
 				{
                     countlir_xcc();
 					// we only support cmp with guard right now, also assume it is 'close' and only emit the branch
                     NIns* exit = asm_exit(ins); // does intersectRegisterState()
 					LIns* cond = ins->oprnd1();
-					asm_branch(op == LIR_xf, cond, exit);
+					asm_branch(op == LIR_xf, cond, exit, false);
 					break;
 				}
 				case LIR_x:
 				{
                     countlir_x();
 		            verbose_only(verbose_output(""));
 					// generate the side exit branch on the main trace.
                     NIns *exit = asm_exit(ins);
 					JMP( exit ); 
 					break;
 				}
 				case LIR_loop:
 				{
                     countlir_loop();
 					asm_loop(ins, loopJumps);
+			        assignSavedRegs();
+			        assignParamRegs();
 					break;
 				}
 
 #ifndef NJ_SOFTFLOAT
 				case LIR_feq:
 				case LIR_fle:
 				case LIR_flt:
 				case LIR_fgt:
@@ -1418,48 +1440,62 @@ namespace nanojit
 					// force the call result to be spilled unnecessarily.
 
 					evictScratchRegs();
 
 					asm_call(ins);
 				}
 			}
 
+			if (error())
+				return;
+
 			// check that all is well (don't check in exit paths since its more complicated)
 			debug_only( pageValidate(); )
 			debug_only( resourceConsistencyCheck();  )
 		}
 	}
 
-    void Assembler::assignSavedParams()
+    void Assembler::assignSavedRegs()
     {
         // restore saved regs
 		releaseRegisters();
         LirBuffer *b = _thisfrag->lirbuf;
         for (int i=0, n = NumSavedRegs; i < n; i++) {
-            LIns *p = b->savedParams[i];
+            LIns *p = b->savedRegs[i];
             if (p)
                 findSpecificRegFor(p, savedRegs[p->imm8()]);
         }
     }
 
-    void Assembler::reserveSavedParams()
+    void Assembler::reserveSavedRegs()
     {
         LirBuffer *b = _thisfrag->lirbuf;
         for (int i=0, n = NumSavedRegs; i < n; i++) {
-            LIns *p = b->savedParams[i];
+            LIns *p = b->savedRegs[i];
             if (p)
                 findMemFor(p);
         }
     }
 
+    // restore parameter registers
+    void Assembler::assignParamRegs()
+    {
+        LInsp state = _thisfrag->lirbuf->state;
+        if (state)
+            findSpecificRegFor(state, argRegs[state->imm8()]); 
+        LInsp param1 = _thisfrag->lirbuf->param1;
+        if (param1)
+            findSpecificRegFor(param1, argRegs[param1->imm8()]);
+    }
+    
     void Assembler::handleLoopCarriedExprs()
     {
         // ensure that exprs spanning the loop are marked live at the end of the loop
-        reserveSavedParams();
+        reserveSavedRegs();
         for (int i=0, n=pending_lives.size(); i < n; i++) {
             findMemFor(pending_lives[i]);
         }
     }
 
 	void Assembler::arFree(uint32_t idx)
 	{
         AR &ar = _activation;
@@ -1846,13 +1882,26 @@ namespace nanojit
         return argc;
     }
 
     void LabelStateMap::add(LIns *label, NIns *addr, RegAlloc &regs) {
         LabelState *st = new (gc) LabelState(addr, regs);
         labels.put(label, st);
     }
 
+    LabelStateMap::~LabelStateMap() {
+        clear();
+    }
+
+    void LabelStateMap::clear() {
+        LabelState *st;
+
+        while (!labels.isEmpty()) {
+            st = labels.removeLast();
+            delete st;
+        }
+    }
+
     LabelState* LabelStateMap::get(LIns *label) {
         return labels.get(label);
     }
 }
 #endif // FEATURE_NANOJIT
diff -r a4343d61f6ee js/src/nanojit/Assembler.h
--- a/js/src/nanojit/Assembler.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/nanojit/Assembler.h	Sat Nov 15 19:43:13 2008 -0500
@@ -137,23 +137,24 @@ namespace nanojit
         RegAlloc regs;
         NIns *addr;
         LabelState(NIns *a, RegAlloc &r) : regs(r), addr(a)
         {}
     };
 
     class LabelStateMap
     {
-        GC *gc;
+        avmplus::GC *gc;
         avmplus::SortedMap<LIns*, LabelState*, avmplus::LIST_GCObjects> labels;
     public:
-        LabelStateMap(GC *gc) : gc(gc), labels(gc)
+        LabelStateMap(avmplus::GC *gc) : gc(gc), labels(gc)
         {}
+        ~LabelStateMap();
 
-        void clear() { labels.clear(); }
+        void clear();
         void add(LIns *label, NIns *addr, RegAlloc &regs);
         LabelState *get(LIns *);
     };
     /**
  	 * Information about the activation record for the method is built up 
  	 * as we generate machine code.  As part of the prologue, we issue
 	 * a stack adjustment instruction and then later patch the adjustment
 	 * value.  Temporary values can be placed into the AR as method calls
@@ -183,16 +184,18 @@ namespace nanojit
 
 			void		assemble(Fragment* frag, NInsList& loopJumps);
 			void		endAssembly(Fragment* frag, NInsList& loopJumps);
 			void		beginAssembly(Fragment *frag, RegAllocMap* map);
 			void		copyRegisters(RegAlloc* copyTo);
 			void		releaseRegisters();
             void        patch(GuardRecord *lr);
             void        patch(SideExit *exit);
+			void        disconnectLoop(GuardRecord *lr);
+			void        reconnectLoop(GuardRecord *lr);
 			AssmError   error()	{ return _err; }
 			void		setError(AssmError e) { _err = e; }
 			void		setCallTable(const CallInfo *functions);
 			void		pageReset();
 			int32_t		codeBytes();
 			Page*		handoverPages(bool exitPages=false);
 
 			debug_only ( void		pageValidate(); )
@@ -244,17 +247,17 @@ namespace nanojit
 			void		reserveReset();
 
 			Reservation* getresv(LIns *x) {
                 uint32_t resv_index = x->resv();
                 return resv_index ? &_resvTable[resv_index] : 0;
             }
 
 			DWB(Fragmento*)		_frago;
-            GC*					_gc;
+			avmplus::GC*		_gc;
             DWB(Fragment*)		_thisfrag;
 			RegAllocMap*		_branchStateMap;
 		
 			const CallInfo	*_functions;
 			
 			NIns*		_nIns;			// current native instruction
 			NIns*		_nExitIns;		// current instruction in exit fragment page
 			NIns*       _epilogue;
@@ -283,17 +286,16 @@ namespace nanojit
             void        asm_store32(LIns *val, int d, LIns *base);
             void        asm_store64(LIns *val, int d, LIns *base);
 			void		asm_restore(LInsp, Reservation*, Register);
 			void		asm_load(int d, Register r);
 			void		asm_spilli(LInsp i, Reservation *resv, bool pop);
 			void		asm_spill(Register rr, int d, bool pop, bool quad);
 			void		asm_load64(LInsp i);
 			void		asm_pusharg(LInsp p);
-			NIns*		asm_adjustBranch(NIns* at, NIns* target);
 			void		asm_quad(LInsp i);
 			void		asm_loop(LInsp i, NInsList& loopJumps);
 			void		asm_fcond(LInsp i);
 			void		asm_cond(LInsp i);
 			void		asm_arith(LInsp i);
 			void		asm_neg_not(LInsp i);
 			void		asm_ld(LInsp i);
 			void		asm_cmov(LInsp i);
@@ -306,29 +308,30 @@ namespace nanojit
 			void		asm_fop(LInsp ins);
 			void		asm_i2f(LInsp ins);
 			void		asm_u2f(LInsp ins);
 			Register	asm_prep_fcall(Reservation *rR, LInsp ins);
 			void		asm_nongp_copy(Register r, Register s);
 			void		asm_call(LInsp);
             void        asm_arg(ArgSize, LInsp, Register);
 			Register	asm_binop_rhs_reg(LInsp ins);
-			NIns*		asm_branch(bool branchOnFalse, LInsp cond, NIns* targ);
-            void        assignSavedParams();
-            void        reserveSavedParams();
+			NIns*		asm_branch(bool branchOnFalse, LInsp cond, NIns* targ, bool far);
+            void        assignSavedRegs();
+            void        reserveSavedRegs();
+            void        assignParamRegs();
             void        handleLoopCarriedExprs();
 
 			// platform specific implementation (see NativeXXX.cpp file)
 			void		nInit(uint32_t flags);
 			void		nInit(AvmCore *);
 			Register	nRegisterAllocFromSet(int32_t set);
 			void		nRegisterResetAll(RegAlloc& a);
 			void		nMarkExecute(Page* page, int32_t count=1, bool enable=true);
 			void		nFrameRestore(RegisterMask rmask);
-			static void	nPatchBranch(NIns* branch, NIns* location);
+			NIns*    	nPatchBranch(NIns* branch, NIns* location);
 			void		nFragExit(LIns* guard);
 
 			// platform specific methods
         public:
 			const static Register savedRegs[NumSavedRegs];
 			DECLARE_PLATFORM_ASSEMBLER()
 
 		private:
diff -r a4343d61f6ee js/src/nanojit/Fragmento.cpp
--- a/js/src/nanojit/Fragmento.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/nanojit/Fragmento.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -57,16 +57,36 @@ namespace nanojit
 	/**
 	 * This is the main control center for creating and managing fragments.
 	 */
 	Fragmento::Fragmento(AvmCore* core, uint32_t cacheSizeLog2) 
 		: _allocList(core->GetGC()),
 			_max_pages(1 << (calcSaneCacheSize(cacheSizeLog2) - NJ_LOG2_PAGE_SIZE)),
 			_pagesGrowth(1)
 	{
+#ifdef _DEBUG
+		{
+			// XXX These belong somewhere else, but I can't find the
+			//     right location right now.
+			NanoStaticAssert((LIR_lt ^ 3) == LIR_ge);
+			NanoStaticAssert((LIR_le ^ 3) == LIR_gt);
+			NanoStaticAssert((LIR_ult ^ 3) == LIR_uge);
+			NanoStaticAssert((LIR_ule ^ 3) == LIR_ugt);
+
+			/* Opcodes must be strictly increasing without holes. */
+			uint32_t count = 0;
+			#define OPDEF(op, number, operands) \
+				NanoAssertMsg(LIR_##op == count++, "misnumbered opcode");
+			#define OPDEF64(op, number, operands) OPDEF(op, number, operands)
+			#include "LIRopcode.tbl"
+			#undef OPDEF
+			#undef OPDEF64
+		}
+#endif
+
 #ifdef MEMORY_INFO
 		_allocList.set_meminfo_name("Fragmento._allocList");
 #endif
 		NanoAssert(_max_pages > _pagesGrowth); // shrink growth if needed 
 		_core = core;
 		GC *gc = core->GetGC();
 		_frags = new (gc) FragmentMap(gc, 128);
 		_assm = new (gc) nanojit::Assembler(this);
@@ -183,33 +203,46 @@ namespace nanojit
 				page = next; 
 			}
 			page->next = 0;
 			NanoAssert(pageCount()==_stats.freePages);
 			//fprintf(stderr,"Fragmento::pageGrow adding page %x ; %d\n", (intptr_t)page, count);
 		}
 	}
 	
+	// Clear the fragment. This *does not* remove the fragment from the
+	// map--the caller must take care of this.
+	void Fragmento::clearFragment(Fragment* f)
+	{
+		Fragment *peer = f->peer;
+		while (peer) {
+			Fragment *next = peer->peer;
+			peer->releaseTreeMem(this);
+			delete peer;
+			peer = next;
+		}
+		f->releaseTreeMem(this);
+		delete f;
+	}
+
+	void Fragmento::clearFrag(const void* ip)
+	{
+		if (_frags->containsKey(ip)) {
+			clearFragment(_frags->remove(ip));
+		}
+	}
+
 	void Fragmento::clearFrags()
 	{
 		// reclaim any dangling native pages
 		_assm->pageReset();
 
         while (!_frags->isEmpty()) {
-            Fragment *f = _frags->removeLast();
-            Fragment *peer = f->peer;
-            while (peer) {
-                Fragment *next = peer->peer;
-                peer->releaseTreeMem(this);
-                delete peer;
-                peer = next;
-            }
-            f->releaseTreeMem(this);
-            delete f;
-		}			
+            clearFragment(_frags->removeLast());
+		}
 
 		verbose_only( enterCounts->clear();)
 		verbose_only( mergeCounts->clear();)
 		verbose_only( _stats.flushes++ );
 		verbose_only( _stats.compiles = 0 );
 		//fprintf(stderr, "Fragmento.clearFrags %d free pages of %d\n", _stats.freePages, _stats.pages);
 	}
 
@@ -268,32 +301,30 @@ namespace nanojit
 				// found existing shared branch on anchor
 				return f;
 			}
 		}
 
 		Fragment *f = newBranch(anchor, ip);
 		f->root = f;
 		f->kind = MergeTrace;
-		f->calldepth = lr->exit->calldepth;
 		verbose_only(
 			int mergeid = 1;
 			for (Fragment *g = anchor->branches; g != 0; g = g->nextbranch)
 				if (g->kind == MergeTrace)
 					mergeid++;
 			addLabel(f, "M", mergeid); 
 		)
         return f;
     }
 
 	Fragment *Fragmento::createBranch(SideExit* exit, const void* ip)
     {
         Fragment *f = newBranch(exit->from, ip);
 		f->kind = BranchTrace;
-		f->calldepth = exit->calldepth;
 		f->treeBranches = f->root->treeBranches;
 		f->root->treeBranches = f;
         return f;
     }
 
 #ifdef NJ_VERBOSE
 	uint32_t Fragmento::pageCount()
 	{
@@ -506,27 +537,34 @@ namespace nanojit
     }
 
 	Fragment::~Fragment()
 	{
         onDestroy();
 		NanoAssert(_pages == 0);
     }
 
+    void Fragment::resetHits()
+    {
+        blacklistLevel >>= 1;
+        _hits = 0;
+    }
+	
     void Fragment::blacklist()
     {
         blacklistLevel++;
         _hits = -(1<<blacklistLevel);
     }
 
     Fragment *Fragmento::newFrag(const void* ip)
     {
 		GC *gc = _core->gc;
         Fragment *f = new (gc) Fragment(ip);
 		f->blacklistLevel = 5;
+        f->recordAttempts = 0;
         return f;
     }
 
 	Fragment *Fragmento::newBranch(Fragment *from, const void* ip)
 	{
 		Fragment *f = newFrag(ip);
 		f->anchor = from->anchor;
 		f->root = from->root;
@@ -540,16 +578,34 @@ namespace nanojit
 			from->branches = f;
 		} else {
 			Fragment *p = from->branches;
 			while (p->nextbranch != 0)
 				p = p->nextbranch;
 			p->nextbranch = f;
 		}
 		return f;
+	}
+
+	void Fragmento::disconnectLoops()
+	{
+		for (int i = 0; i < _frags->size(); ++i) {
+			Fragment* frag = _frags->at(i);
+			if (frag->lastIns->isop(LIR_loop))
+				_assm->disconnectLoop(frag->lastIns->record());
+		}
+	}
+
+	void Fragmento::reconnectLoops()
+	{
+		for (int i = 0; i < _frags->size(); ++i) {
+			Fragment* frag = _frags->at(i);
+			if (frag->lastIns->isop(LIR_loop))
+				_assm->reconnectLoop(frag->lastIns->record());
+		}
 	}
 
 	void Fragment::releaseLirBuffer()
 	{
 		lastIns = 0;	
 	}
 
 	void Fragment::releaseCode(Fragmento* frago)
diff -r a4343d61f6ee js/src/nanojit/Fragmento.h
--- a/js/src/nanojit/Fragmento.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/nanojit/Fragmento.h	Sat Nov 15 19:43:13 2008 -0500
@@ -57,61 +57,68 @@ namespace nanojit
     };
     struct Page: public PageHeader
     {
         union {
             LIns lir[(NJ_PAGE_SIZE-sizeof(PageHeader))/sizeof(LIns)];
             NIns code[(NJ_PAGE_SIZE-sizeof(PageHeader))/sizeof(NIns)];
         };
     };
-    struct AllocEntry : public GCObject
+    struct AllocEntry : public avmplus::GCObject
     {
         Page *page;
         uint32_t allocSize;
     };
 	typedef avmplus::List<AllocEntry*,avmplus::LIST_NonGCObjects>	AllocList;
 
 	typedef avmplus::GCSortedMap<const void*, uint32_t, avmplus::LIST_NonGCObjects> BlockSortedMap;
 	class BlockHist: public BlockSortedMap
 	{
 	public:
-		BlockHist(GC*gc) : BlockSortedMap(gc)
+		BlockHist(avmplus::GC*gc) : BlockSortedMap(gc)
 		{
 		}
 		uint32_t count(const void *p) {
 			uint32_t c = 1+get(p);
 			put(p, c);
 			return c;
 		}
 	};
 
 	struct fragstats;
 	/*
 	 *
 	 * This is the main control center for creating and managing fragments.
 	 */
-	class Fragmento : public GCFinalizedObject
+	class Fragmento : public avmplus::GCFinalizedObject
 	{
 		public:
 			Fragmento(AvmCore* core, uint32_t cacheSizeLog2);
 			~Fragmento();
 
 			void		addMemory(void* firstPage, uint32_t pageCount);  // gives memory to the Assembler
 			Assembler*	assm();
 			AvmCore*	core();
 			Page*		pageAlloc();
 			void		pageFree(Page* page);
 			
             Fragment*   getLoop(const void* ip);
             Fragment*   getAnchor(const void* ip);
+		    // Remove one fragment. The caller is responsible for making sure
+			// that this does not destroy any resources shared with other
+			// fragments (such as a LirBuffer or this fragment itself as a
+			// jump target).
+    		void        clearFrag(const void* ip);
 			void        clearFrags();	// clear all fragments from the cache
             Fragment*   getMerge(GuardRecord *lr, const void* ip);
             Fragment*   createBranch(SideExit *exit, const void* ip);
             Fragment*   newFrag(const void* ip);
             Fragment*   newBranch(Fragment *from, const void* ip);
+            void        disconnectLoops();
+            void        reconnectLoops();
 
             verbose_only ( uint32_t pageCount(); )
 			verbose_only ( void dumpStats(); )
 			verbose_only ( void dumpRatio(const char*, BlockHist*);)
 			verbose_only ( void dumpFragStats(Fragment*, int level, fragstats&); )
 			verbose_only ( void countBlock(BlockHist*, const void* pc); )
 			verbose_only ( void countIL(uint32_t il, uint32_t abc); )
 			verbose_only( void addLabel(Fragment* f, const char *prefix, int id); )
@@ -132,27 +139,28 @@ namespace nanojit
 			
     		#ifdef AVMPLUS_VERBOSE
     		void	drawTrees(char *fileName);
             #endif
 			
 			uint32_t cacheUsed() const { return (_stats.pages-_stats.freePages)<<NJ_LOG2_PAGE_SIZE; }
 			uint32_t cacheUsedMax() const { return (_stats.maxPageUse)<<NJ_LOG2_PAGE_SIZE; }
 		private:
+		    void        clearFragment(Fragment *f);
 			void		pagesGrow(int32_t count);
 			void		trackFree(int32_t delta);
 
 			AvmCore*			_core;
 			DWB(Assembler*)		_assm;
 			DWB(FragmentMap*)	_frags;		/* map from ip -> Fragment ptr  */
 			Page*			_pageList;
 
 			/* unmanaged mem */
 			AllocList	_allocList;
-			GCHeap*		_gcHeap;
+			avmplus::GCHeap* _gcHeap;
 
 			const uint32_t _max_pages;
 			uint32_t _pagesGrowth;
 	};
 
 	enum TraceKind {
 		LoopTrace,
 		BranchTrace,
@@ -161,26 +169,27 @@ namespace nanojit
 	
 	/**
 	 * Fragments are linear sequences of native code that have a single entry 
 	 * point at the start of the fragment and may have one or more exit points 
 	 * 
 	 * It may turn out that that this arrangement causes too much traffic
 	 * between d and i-caches and that we need to carve up the structure differently.
 	 */
-	class Fragment : public GCFinalizedObject
+	class Fragment : public avmplus::GCFinalizedObject
 	{
 		public:
 			Fragment(const void*);
 			~Fragment();
 
 			NIns*			code()							{ return _code; }
 			void			setCode(NIns* codee, Page* pages) { _code = codee; _pages = pages; }
 			GuardRecord*	links()							{ return _links; }
 			int32_t&		hits()							{ return _hits; }
+            void            resetHits();
             void            blacklist();
 			bool			isBlacklisted()		{ return _hits < 0; }
 			debug_only( bool hasOnlyTreeLinks(); )
 			void			releaseLirBuffer();
 			void			releaseCode(Fragmento* frago);
 			void			releaseTreeMem(Fragmento* frago);
 			bool			isAnchor() { return anchor == this; }
 			bool			isRoot() { return root == this; }
@@ -210,19 +219,20 @@ namespace nanojit
             DWB(LirBuffer*) lirbuf;
 			LIns*			lastIns;
 			SideExit*       spawnedFrom;
 			
 			TraceKind kind;
 			const void* ip;
 			uint32_t guardCount;
             uint32_t xjumpCount;
+            uint32_t recordAttempts;
             int32_t blacklistLevel;
             NIns* fragEntry;
-			int32_t calldepth;
+            NIns* loopEntry;
 			void* vmprivate;
 			
 		private:
 			NIns*			_code;		// ptr to start of code
 			GuardRecord*	_links;		// code which is linked (or pending to be) to this fragment
 			int32_t			_hits;
 			Page*			_pages;		// native code pages 
 	};
diff -r a4343d61f6ee js/src/nanojit/LIR.cpp
--- a/js/src/nanojit/LIR.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/nanojit/LIR.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -45,53 +45,38 @@
 #endif /* PERFM */
 
 namespace nanojit
 {
     using namespace avmplus;
 	#ifdef FEATURE_NANOJIT
 
 	const uint8_t operandCount[] = {
-	/* 0 */		/*trace*/0, /*nearskip*/0, /*skip*/0, /*neartramp*/0, /*tramp*/0, 2, 2, 2, 2, /*addp*/2, 
-	/* 10 */	/*param*/0, 2, 2, /*alloc*/0, 2, /*ret*/1, /*live*/1, /*calli*/0, /*call*/0, /*loop*/0,
-	/* 20 */	/*x*/0, 0, 1, 1, /*label*/0, 2, 2, 2, 2, 2,
-	/* 30 */	2, 2, /*short*/0, /*int*/0, 2, 2, /*neg*/1, 2, 2, 2,
-#if defined NANOJIT_64BIT
-	/* 40 */	/*callh*/0, 2, 2, 2, /*not*/1, 2, 2, 2, /*xt*/1, /*xf*/1,
-#else
-	/* 40 */	/*callh*/1, 2, 2, 2, /*not*/1, 2, 2, 2, /*xt*/1, /*xf*/1,
-#endif
-	/* 50 */	/*qlo*/1, /*qhi*/1, 2, /*ov*/1, /*cs*/1, 2, 2, 2, 2, 2,
-	/* 60 */	2, 2, 2, 2, 2, /*file*/1, /*line*/1, 2, 2, 2,
-	/* 70 */	2, 2, 2, 2, 2, 2, 2, 2, 2, /*fret*/1,
-	/* 80 */	2, /*fcalli*/0, /*fcall*/0, 2, 2, 2, 2, 2, 2, 2,
-	/* 90 */	2, 2, 2, 2, 2, 2, 2, /*quad*/0, 2, 2,
-	/* 100 */	/*fneg*/1, 2, 2, 2, 2, 2, /*i2f*/1, /*u2f*/1, 2, 2,
-	/* 110 */	2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
-	/* 120 */	2, 2, 2, 2, 2, 2, 2, 2, 
+#define OPDEF(op, number, operands) \
+        operands,
+#define OPDEF64(op, number, operands) \
+        operands,
+#include "LIRopcode.tbl"
+#undef OPDEF
+#undef OPDEF64
+        0
 	};
 
 	// LIR verbose specific
 	#ifdef NJ_VERBOSE
 
 	const char* lirNames[] = {
-	/* 0-9 */	"start","nearskip","skip","neartramp","tramp","5","6","7","8","addp",
-	/* 10-19 */	"param","st","ld","alloc","sti","ret","live","calli","call","loop",
-	/* 20-29 */ "x","j","jt","jf","label","25","feq","flt","fgt","fle",
-	/* 30-39 */ "fge","cmov","short","int","ldc","","neg","add","sub","mul",
-	/* 40-49 */ "callh","and","or","xor","not","lsh","rsh","ush","xt","xf",
-	/* 50-59 */ "qlo","qhi","ldcb","ov","cs","eq","lt","gt","le","ge",
-	/* 60-63 */ "ult","ugt","ule","uge",
-	/* 64-69 */ "LIR64","file","line","67","68","69",
-	/* 70-79 */ "70","71","72","73","74","stq","ldq","77","stqi","fret",
-	/* 80-89 */ "80","fcalli","fcall","83","84","85","86","87","88","89",
-	/* 90-99 */ "90","91","92","93","94","95","96","quad","ldqc","99",
-	/* 100-109 */ "fneg","fadd","fsub","fmul","fdiv","qjoin","i2f","u2f","qior","qilsh",
-	/* 110-119 */ "110","111","112","113","114","115","116","117","118","119",
-	/* 120-127 */ "120","121","122","123","124","125","126","127"
+#define OPDEF(op, number, operands) \
+        #op,
+#define OPDEF64(op, number, operands) \
+        #op,
+#include "LIRopcode.tbl"
+#undef OPDEF
+#undef OPDEF64
+        NULL
 	};
 
 	#endif /* NANOJIT_VEBROSE */
 	
 	// implementation
 
 #ifdef NJ_PROFILE
 	// @todo fixup move to nanojit.h
@@ -135,18 +120,18 @@ namespace nanojit
 			_start = next;
 			_stats.pages--;
 		}
 		NanoAssert(_stats.pages == 0);
 		_unused = 0;
 		_stats.lir = 0;
 		_noMem = 0;
 		for (int i = 0; i < NumSavedRegs; ++i)
-			savedParams[i] = NULL;
-		explicitSavedParams = false;
+			savedRegs[i] = NULL;
+		explicitSavedRegs = false;
 	}
 
 	#ifdef _DEBUG
 	void LirBuffer::validate() const
 	{
 		uint32_t count = 0;
 		Page *last = 0;
 		Page *page = _start;
@@ -394,18 +379,18 @@ namespace nanojit
         LirBuffer *b = this->_buf;
 		LInsp l = b->next();
 		l->initOpcode(LIR_param);
         NanoAssert(isU8(arg) && isU8(kind));
 		l->c.imm8a = arg;
         l->c.imm8b = kind;
         if (kind) {
             NanoAssert(arg < NumSavedRegs);
-            b->savedParams[arg] = l;
-            b->explicitSavedParams = true;
+            b->savedRegs[arg] = l;
+            b->explicitSavedRegs = true;
         }
 		b->commit(1);
 		b->_stats.lir++;
 		return l;
     }
 	
 	LInsp LirBufWriter::insFar(LOpcode op, LInsp target)
 	{
@@ -593,17 +578,17 @@ namespace nanojit
 	    return isconstq();
 	#else
 	    return isconst();
     #endif
 	}
 
 	bool FASTCALL isCse(LOpcode op) {
 		op = LOpcode(op & ~LIR64);
-		return op >= LIR_feq && op <= LIR_uge;
+		return op >= LIR_ldcs && op <= LIR_uge;
 	}
 
     bool LIns::isCse(const CallInfo *functions) const
     { 
 		return nanojit::isCse(u.code) || isCall() && callInfo()->_cse;
     }
 
 	void LIns::setimm16(int32_t x)
@@ -846,16 +831,21 @@ namespace nanojit
 				v == LIR_xor || v == LIR_or || v == LIR_and ||
 				v == LIR_eq) {
 				// move const to rhs
 				LIns* t = oprnd2;
 				oprnd2 = oprnd1;
 				oprnd1 = t;
 			}
 			else if (v >= LIR_lt && v <= LIR_uge) {
+				NanoStaticAssert((LIR_lt ^ 1) == LIR_gt);
+				NanoStaticAssert((LIR_le ^ 1) == LIR_ge);
+				NanoStaticAssert((LIR_ult ^ 1) == LIR_ugt);
+				NanoStaticAssert((LIR_ule ^ 1) == LIR_uge);
+
 				// move const to rhs, swap the operator
 				LIns *t = oprnd2;
 				oprnd2 = oprnd1;
 				oprnd1 = t;
 				v = LOpcode(v^1);
 			}
 		}
 
@@ -1198,16 +1188,21 @@ namespace nanojit
 			m_used(0), m_cap(kInitialCap), m_gc(gc)
 	{
 #ifdef MEMORY_INFO
 //		m_list.set_meminfo_name("LInsHashSet.list");
 #endif
         LInsp *list = (LInsp*) gc->Alloc(sizeof(LInsp)*m_cap);
         WB(gc, this, &m_list, list);
 	}
+
+    LInsHashSet::~LInsHashSet()
+    {
+        m_gc->Free(m_list);
+    }
 
     void LInsHashSet::clear() {
         memset(m_list, 0, sizeof(LInsp)*m_cap);
         m_used = 0;
     }
 	
 	/*static*/ uint32_t FASTCALL LInsHashSet::hashcode(LInsp i)
 	{
@@ -1863,17 +1858,18 @@ namespace nanojit
 					formatRef(i->oprnd2()->oprnd1()), 
 					formatRef(i->oprnd2()->oprnd2()));
 				break;
 
 			case LIR_ld: 
 			case LIR_ldc: 
 			case LIR_ldq: 
 			case LIR_ldqc: 
-			case LIR_ldcb: 
+			case LIR_ldcb:
+			case LIR_ldcs:
 				sprintf(s, "%s = %s %s[%s]", formatRef(i), lirNames[op],
 					formatRef(i->oprnd1()), 
 					formatRef(i->oprnd2()));
 				break;
 
 			case LIR_st: 
             case LIR_sti:
 			case LIR_stq: 
@@ -2013,24 +2009,27 @@ namespace nanojit
 
 		bool treeCompile = core->config.tree_opt && (triggerFrag->kind == BranchTrace);
 		RegAllocMap regMap(gc);
 		NInsList loopJumps(gc);
 #ifdef MEMORY_INFO
 //		loopJumps.set_meminfo_name("LIR loopjumps");
 #endif
 		assm->beginAssembly(triggerFrag, &regMap);
+		if (assm->error())
+			return;
 
 		//fprintf(stderr, "recompile trigger %X kind %d\n", (int)triggerFrag, triggerFrag->kind);
 		Fragment* root = triggerFrag;
 		if (treeCompile)
 		{
 			// recompile the entire tree
 			root = triggerFrag->root;
 			root->fragEntry = 0;
+			root->loopEntry = 0;
 			root->releaseCode(frago);
 			
 			// do the tree branches
 			Fragment* frag = root->treeBranches;
 			while(frag)
 			{
 				// compile til no more frags
 				if (frag->lastIns)
@@ -2061,16 +2060,17 @@ namespace nanojit
 		assm->endAssembly(root, loopJumps);
 			
 		// reverse output so that assembly is displayed low-to-high
 		verbose_only( assm->_outputCache = 0; )
 		verbose_only(for(int i=asmOutput.size()-1; i>=0; --i) { assm->outputf("%s",asmOutput.get(i)); } );
 
 		if (assm->error()) {
 			root->fragEntry = 0;
+			root->loopEntry = 0;
 		}
     }
 
     LInsp LoadFilter::insLoad(LOpcode v, LInsp base, LInsp disp)
     {
         if (base != sp && base != rp && (v == LIR_ld || v == LIR_ldq)) {
             uint32_t k;
             LInsp found = exprs.find2(v, base, disp, k);
diff -r a4343d61f6ee js/src/nanojit/LIR.h
--- a/js/src/nanojit/LIR.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/nanojit/LIR.h	Sat Nov 15 19:43:13 2008 -0500
@@ -55,132 +55,24 @@ namespace nanojit
 	enum LOpcode
 #if defined(_MSC_VER) && _MSC_VER >= 1400
           : unsigned
 #endif
 	{
 		// flags; upper bits reserved
 		LIR64	= 0x40,			// result is double or quad
 		
-		// special operations (must be 0..N)
-		LIR_start = 0,	
-		LIR_nearskip = 1, // must be LIR_skip-1 and lsb=1
-		LIR_skip = 2,
-        LIR_neartramp = 3, // must be LIR_tramp-1 and lsb=1
-        LIR_tramp = 4,
-
-		// non-pure operations
-		LIR_addp    = 9,
-		LIR_param	= 10,
-		LIR_st		= 11, // 32-bit store
-		LIR_ld		= 12, // 32-bit load
-		LIR_alloc   = 13, // alloca some stack space
-        LIR_sti     = 14,
-		LIR_ret     = 15,
-		LIR_live    = 16, // extend live range of reference
-		LIR_calli   = 17, // indirect call	
-		LIR_call	= 18, // subroutine call returning a 32-bit value
-			
-		// guards
-		LIR_loop    = 19, // loop fragment
-		LIR_x		= 20, // exit always
-
-		// branches
-		LIR_j		= 21, // jump always
-		LIR_jt		= 22, // jump true
-		LIR_jf		= 23, // jump false
-		LIR_label	= 24, // a jump target
-		LIR_ji      = 25, // jump indirect
-		// operators
-
-		// LIR_feq though LIR_fge must only be used on float arguments.  They
-		// return integers.
-		LIR_feq		= 26, // floating-point equality [2 float inputs]
-		LIR_flt		= 27, // floating-point less than: arg1 < arg2
-		LIR_fgt		= 28, // floating-point greater than: arg1 > arg2
-		LIR_fle		= 29, // arg1 <= arg2, both floating-point
-		LIR_fge		= 30, // arg1 >= arg2, both floating-point
-
-		LIR_cmov    = 31, // conditional move (op1=cond, op2=cond(iftrue,iffalse))
-		LIR_short   = 32, // constant 16-bit integer
-		LIR_int		= 33, // constant 32-bit integer
-		LIR_ldc     = 34, // non-volatile load
-		LIR_2       = 35, // wraps a pair of refs
-
-		// LIR_neg through LIR_ush are all integer operations
-		LIR_neg		= 36, // numeric negation [ 1 integer input / integer output ]
-		LIR_add		= 37, // integer addition [ 2 operand integer intputs / integer output ]
-		LIR_sub		= 38, // integer subtraction
-		LIR_mul		= 39, // integer multiplication
-		LIR_callh   = 40, 
-		LIR_and		= 41,
-		LIR_or		= 42,
-		LIR_xor		= 43,
-		LIR_not		= 44,
-		LIR_lsh		= 45,
-		LIR_rsh		= 46,	// >>
-		LIR_ush		= 47,	// >>>
-
-		// conditional guards, op^1 to complement.  Only things that are
-		// isCond() can be passed to these.
-		LIR_xt		= 48, // exit if true   0x30 0011 0000
-		LIR_xf		= 49, // exit if false  0x31 0011 0001
-
-		// qlo and qhi take a single quad argument and return its low and high
-		// 32 bits respectively as 32-bit integers.
-		LIR_qlo		= 50,
-		LIR_qhi		= 51,
-
-		LIR_ldcb    = 52, // non-volatile 8-bit load
-
-        LIR_ov      = 53,
-        LIR_cs      = 54,
-		LIR_eq      = 55, // integer equality
-        // integer (all sizes) relational operators.  op^1 to swap left/right,
-        // op^3 to complement.
-		LIR_lt      = 56, // 0x38 0011 1000
-		LIR_gt      = 57, // 0x39 0011 1001
-		LIR_le		= 58, // 0x3A 0011 1010
-		LIR_ge		= 59, // 0x3B 0011 1011
-		// and the unsigned integer versions
-		LIR_ult		= 60, // 0x3C 0011 1100
-		LIR_ugt		= 61, // 0x3D 0011 1101
-		LIR_ule		= 62, // 0x3E 0011 1110
-		LIR_uge		= 63, // 0x3F 0011 1111
-
-		// non-64bit ops, but we're out of code space below 64
-		LIR_file    = 1 | LIR64,
-		LIR_line    = 2 | LIR64,
-
-		/**
-		 * 64bit operations
-		 */
-		LIR_stq		= LIR_st | LIR64, // quad store
-		LIR_stqi	= LIR_sti | LIR64,
-		LIR_fret    = LIR_ret | LIR64,
-		LIR_quad    = LIR_int | LIR64, // quad constant value
-		LIR_ldq		= LIR_ld    | LIR64, // quad load
-		LIR_ldqc    = LIR_ldc   | LIR64,
-        LIR_qiand   = 24 | LIR64,
-        LIR_qiadd   = 25 | LIR64,
-        LIR_qilsh   = LIR_lsh | LIR64,
-
-		LIR_fcall   = LIR_call  | LIR64, // subroutine call returning quad
-		LIR_fcalli  = LIR_calli | LIR64,
-		LIR_fneg	= LIR_neg  | LIR64, // floating-point numeric negation
-		LIR_fadd	= LIR_add  | LIR64, // floating-point addition
-		LIR_fsub	= LIR_sub  | LIR64, // floating-point subtraction
-		LIR_fmul	= LIR_mul  | LIR64, // floating-point multiplication
-		LIR_fdiv	= 40        | LIR64, // floating-point division
-		LIR_qcmov	= LIR_cmov | LIR64, 
-
-		LIR_qjoin	= 41 | LIR64,
-		LIR_i2f		= 42 | LIR64, // convert an integer to a float
-		LIR_u2f		= 43 | LIR64, // convert an unsigned integer to a float
-        LIR_qior    = 44 | LIR64
+#define OPDEF(op, number, args) \
+        LIR_##op = (number),
+#define OPDEF64(op, number, args) \
+        LIR_##op = ((number) | LIR64),
+#include "LIRopcode.tbl"
+        LIR_sentinel
+#undef OPDEF
+#undef OPDEF64
 	};
 
 	#if defined NANOJIT_64BIT
 	#define LIR_ldp     LIR_ldq
 	#define LIR_stp     LIR_stq
     #define LIR_piadd   LIR_qiadd
     #define LIR_piand   LIR_qiand
     #define LIR_pilsh   LIR_qilsh
@@ -257,21 +149,23 @@ namespace nanojit
     }
 
     inline bool isStore(LOpcode op) {
         op = LOpcode(op & ~LIR64);
         return op == LIR_st || op == LIR_sti;
     }
 
     inline bool isConst(LOpcode op) {
+        NanoStaticAssert((LIR_short & 1) == 0);
+        NanoStaticAssert(LIR_int == LIR_short + 1);
         return (op & ~1) == LIR_short;
     }
 
     inline bool isLoad(LOpcode op) {
-        return op == LIR_ldq || op == LIR_ld || op == LIR_ldc || op == LIR_ldqc;
+        return op == LIR_ldq || op == LIR_ld || op == LIR_ldc || op == LIR_ldqc || op == LIR_ldcs;
     }
 
 	// Low-level Instruction 4B
 	// had to lay it our as a union with duplicate code fields since msvc couldn't figure out how to compact it otherwise.
 	class LIns
 	{
         friend class LirBufWriter;
 		// 3-operand form (backwards reach only)
@@ -529,17 +423,17 @@ namespace nanojit
     bool FASTCALL isFloat(LOpcode v);
 	LIns* FASTCALL callArgN(LInsp i, uint32_t n);
 	extern const uint8_t operandCount[];
 
 	class Fragmento;	// @todo remove this ; needed for minbuild for some reason?!?  Should not be compiling this code at all
 	class LirFilter;
 
 	// make it a GCObject so we can explicitly delete it early
-	class LirWriter : public GCObject
+	class LirWriter : public avmplus::GCObject
 	{
 	public:
 		LirWriter *out;
         const CallInfo *_functions;
 
 		virtual ~LirWriter() {}
 		LirWriter(LirWriter* out) 
 			: out(out), _functions(out?out->_functions : 0) {}
@@ -637,17 +531,17 @@ namespace nanojit
 		void promoteAll(const void *newbase);
     };
 
 	class LirNameMap MMGC_SUBCLASS_DECL
 	{
 		template <class Key>
 		class CountMap : public avmplus::SortedMap<Key, int, avmplus::LIST_NonGCObjects> {
 		public:
-			CountMap(GC*gc) : avmplus::SortedMap<Key, int, avmplus::LIST_NonGCObjects>(gc) {}
+			CountMap(avmplus::GC*gc) : avmplus::SortedMap<Key, int, avmplus::LIST_NonGCObjects>(gc) {}
 			int add(Key k) {
 				int c = 1;
 				if (containsKey(k)) {
 					c = 1+get(k);
 				}
 				put(k,c);
 				return c;
 			}
@@ -664,17 +558,17 @@ namespace nanojit
 			DRCWB(avmplus::String*) name;
 		};
 		avmplus::SortedMap<LInsp, Entry*, avmplus::LIST_GCObjects> names;
 		const CallInfo *_functions;
 		LabelMap *labels;
 		void formatImm(int32_t c, char *buf);
 	public:
 
-		LirNameMap(GC *gc, const CallInfo *_functions, LabelMap *r) 
+		LirNameMap(avmplus::GC *gc, const CallInfo *_functions, LabelMap *r) 
 			: lircounts(gc),
 			funccounts(gc),
 			names(gc),
 			_functions(_functions),
 			labels(r)
 		{}
         ~LirNameMap();
 
@@ -687,17 +581,17 @@ namespace nanojit
 	};
 
 
 	class VerboseWriter : public LirWriter
 	{
 		avmplus::List<LInsp, avmplus::LIST_NonGCObjects> code;
 		DWB(LirNameMap*) names;
     public:
-		VerboseWriter(GC *gc, LirWriter *out, LirNameMap* names) 
+		VerboseWriter(avmplus::GC *gc, LirWriter *out, LirNameMap* names) 
 			: LirWriter(out), code(gc), names(names) 
 		{}
 
 		LInsp add(LInsp i) {
 			if (i)
 				code.add(i);
 			return i;
 		}
@@ -779,26 +673,27 @@ namespace nanojit
 	{
 		// must be a power of 2. 
 		// don't start too small, or we'll waste time growing and rehashing.
 		// don't start too large, will waste memory. 
 		static const uint32_t kInitialCap = 64;	
 
 		LInsp *m_list; // explicit WB's are used, no DWB needed.
 		uint32_t m_used, m_cap;
-		GC* m_gc;
+		avmplus::GC* m_gc;
 
 		static uint32_t FASTCALL hashcode(LInsp i);
 		uint32_t FASTCALL find(LInsp name, uint32_t hash, const LInsp *list, uint32_t cap);
 		static bool FASTCALL equals(LInsp a, LInsp b);
 		void FASTCALL grow();
 
 	public:
 
-		LInsHashSet(GC* gc);
+		LInsHashSet(avmplus::GC* gc);
+		~LInsHashSet();
 		LInsp find32(int32_t a, uint32_t &i);
 		LInsp find64(uint64_t a, uint32_t &i);
 		LInsp find1(LOpcode v, LInsp a, uint32_t &i);
 		LInsp find2(LOpcode v, LInsp a, LInsp b, uint32_t &i);
 		LInsp findcall(const CallInfo *call, uint32_t argc, LInsp args[], uint32_t &i);
 		LInsp add(LInsp i, uint32_t k);
 		void replace(LInsp i);
         void clear();
@@ -809,27 +704,27 @@ namespace nanojit
 		static uint32_t FASTCALL hash2(LOpcode v, LInsp, LInsp);
 		static uint32_t FASTCALL hashcall(const CallInfo *call, uint32_t argc, LInsp args[]);
 	};
 
 	class CseFilter: public LirWriter
 	{
 	public:
 		LInsHashSet exprs;
-		CseFilter(LirWriter *out, GC *gc);
+		CseFilter(LirWriter *out, avmplus::GC *gc);
 	    LIns* insImm(int32_t imm);
 	    LIns* insImmq(uint64_t q);
 		LIns* ins1(LOpcode v, LInsp);
 		LIns* ins2(LOpcode v, LInsp, LInsp);
 		LIns* insLoad(LOpcode v, LInsp b, LInsp d);
 		LIns* insCall(const CallInfo *call, LInsp args[]);
 		LIns* insGuard(LOpcode op, LInsp cond, LIns *x);
 	};
 
-	class LirBuffer : public GCFinalizedObject
+	class LirBuffer : public avmplus::GCFinalizedObject
 	{
 		public:
 			DWB(Fragmento*)		_frago;
 			LirBuffer(Fragmento* frago, const CallInfo* functions);
 			virtual ~LirBuffer();
 			void        clear();
 			LInsp		next();
 			bool		outOmem() { return _noMem != 0; }
@@ -846,18 +741,18 @@ namespace nanojit
 				uint32_t lir;	// # instructions
 				uint32_t pages;	// pages consumed
 			}
 			_stats;
 
 			const CallInfo* _functions;
             AbiKind abi;
             LInsp state,param1,sp,rp;
-            LInsp savedParams[NumSavedRegs];
-            bool explicitSavedParams;
+            LInsp savedRegs[NumSavedRegs];
+            bool explicitSavedRegs;
 			
 		protected:
 			friend class LirBufWriter;
 
 			LInsp		commit(uint32_t count);
 			bool		addPage();
 			Page*		pageAlloc();
 
@@ -940,28 +835,28 @@ namespace nanojit
         void setpos(LIns *i) {
             _i = i;
         }
 	};
 
     class Assembler;
 
     void compile(Assembler *assm, Fragment *frag);
-	verbose_only(void live(GC *gc, LirBuffer *lirbuf);)
+	verbose_only(void live(avmplus::GC *gc, LirBuffer *lirbuf);)
 
 	class StackFilter: public LirFilter
 	{
-		GC *gc;
+	    avmplus::GC *gc;
 		LirBuffer *lirbuf;
 		LInsp sp;
 		avmplus::BitSet stk;
         int top;
 		int getTop(LInsp br);
 	public:
-		StackFilter(LirFilter *in, GC *gc, LirBuffer *lirbuf, LInsp sp); 
+	    StackFilter(LirFilter *in, avmplus::GC *gc, LirBuffer *lirbuf, LInsp sp); 
 		virtual ~StackFilter() {}
 		LInsp read();
 	};
 
 	class CseReader: public LirFilter
 	{
 		LInsHashSet *exprs;
 		const CallInfo *functions;
@@ -973,17 +868,17 @@ namespace nanojit
     // eliminate redundant loads by watching for stores & mutator calls
     class LoadFilter: public LirWriter
     {
     public:
         LInsp sp, rp;
         LInsHashSet exprs;
         void clear(LInsp p);
     public:
-        LoadFilter(LirWriter *out, GC *gc)
+        LoadFilter(LirWriter *out, avmplus::GC *gc)
             : LirWriter(out), exprs(gc) { }
 
         LInsp ins0(LOpcode);
         LInsp insLoad(LOpcode, LInsp base, LInsp disp);
         LInsp insStore(LInsp v, LInsp b, LInsp d);
         LInsp insStorei(LInsp v, LInsp b, int32_t d);
         LInsp insCall(const CallInfo *call, LInsp args[]);
     };
diff -r a4343d61f6ee js/src/nanojit/LIRopcode.tbl
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/nanojit/LIRopcode.tbl	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,248 @@
+/* -*- Mode: C; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-
+ * vim: set ts=8 sw=4 et tw=0 ft=C:
+ *
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is SpiderMonkey nanojit.
+ *
+ * The Initial Developer of the Original Code is
+ * the Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Jeff Walden <jwalden+code@mit.edu>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either of the GNU General Public License Version 2 or later (the "GPL"),
+ * or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+/*
+ * Definitions of LIR opcodes.  If you need to allocate an opcode, look
+ * for a name of the form unused* and claim it.
+ *
+ * Includers must define OPDEF and OPDEF64 macros of the following forms:
+ *
+ * #define   OPDEF(op,val,operands) ...
+ * #define OPDEF64(op,val,operands) ...
+ *
+ * Selected arguments can then be used within the macro expansions.
+ *
+ * Field        Description
+ * op           Bytecode name, token-pasted after "LIR_" to form an LOpcode
+ * val          Bytecode value, which is the LOpcode enumerator value
+ * operands     Number of operands for this instruction
+ *
+ * This file is best viewed with 128 columns:
+12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678
+ */
+
+/*    op    val name        operands */
+
+/* special operations (must be 0..N) */
+OPDEF(start,     0, 0)
+OPDEF(nearskip,  1, 0) // must be skip-1 and lsb=1
+OPDEF(skip,      2, 0)
+OPDEF(neartramp, 3, 0) // must be tramp-1 and lsb=1
+OPDEF(tramp,     4, 0)
+
+OPDEF(unused1,   5, 2)
+OPDEF(unused2,   6, 2)
+OPDEF(unused3,   7, 2)
+OPDEF(unused4,   8, 2)
+
+/* non-pure operations */
+OPDEF(addp,      9, 2)
+OPDEF(param,    10, 0)
+OPDEF(st,       11, 2) // 32-bit store
+OPDEF(ld,       12, 2) // 32-bit load
+OPDEF(alloc,    13, 0) // alloca some stack space
+OPDEF(sti,      14, 2)
+OPDEF(ret,      15, 1)
+OPDEF(live,     16, 1) // extend live range of reference
+OPDEF(calli,    17, 0) // indirect call
+OPDEF(call,     18, 0) // subroutine call returning a 32-bit value
+
+/* guards */
+OPDEF(loop,     19, 0) // loop fragment
+OPDEF(x,        20, 0) // exit always
+
+/* branches */
+OPDEF(j,        21, 0) // jump always
+OPDEF(jt,       22, 1) // jump true
+OPDEF(jf,       23, 1) // jump false
+OPDEF(label,    24, 0) // a jump target
+OPDEF(ji,       25, 2) // jump indirect
+/* operators */
+
+/*
+ * NB: Opcodes ldcs through uge must remain continuous to aid in
+ *     common-subexpression-elimination detection code.
+ */
+
+OPDEF(ldcs, 26, 2) // non-volatile 16-bit load
+
+/*
+ * feq though fge must only be used on float arguments.  They
+ * return integers.  NB: These opcodes must remain continuous
+ * so that comparison-opcode detection works correctly.
+ */
+OPDEF(feq,      27, 2) // floating-point equality [2 float inputs]
+OPDEF(flt,      28, 2) // floating-point less than: arg1 < arg2
+OPDEF(fgt,      29, 2) // floating-point greater than: arg1 > arg2
+OPDEF(fle,      30, 2) // arg1 <= arg2, both floating-point
+OPDEF(fge,      31, 2) // arg1 >= arg2, both floating-point
+
+OPDEF(short,    32, 0) // constant 16-bit integer
+OPDEF(int,      33, 0) // constant 32-bit integer
+OPDEF(cmov,     34, 2) // conditional move (op1=cond, op2=cond(iftrue,iffalse))
+OPDEF(ldc,      35, 2) // non-volatile load
+
+// neg through ush are all integer operations
+OPDEF(neg,      36, 1) // numeric negation [ 1 integer input / integer output ]
+OPDEF(add,      37, 2) // integer addition [ 2 operand integer intputs / integer output ]
+OPDEF(sub,      38, 2) // integer subtraction
+OPDEF(mul,      39, 2) // integer multiplication
+#if defined(NANOJIT_64BIT)
+OPDEF(callh,    40, 0)
+#else
+OPDEF(callh,    40, 1)
+#endif
+OPDEF(and,      41, 2)
+OPDEF(or,       42, 2)
+OPDEF(xor,      43, 2)
+OPDEF(not,      44, 1)
+OPDEF(lsh,      45, 2)
+OPDEF(rsh,      46, 2) // >>
+OPDEF(ush,      47, 2) // >>>
+
+// conditional guards, op^1 to complement.  Only things that are
+// isCond() can be passed to these.
+OPDEF(xt,       48, 1) // exit if true   0x30 0011 0000
+OPDEF(xf,       49, 1) // exit if false  0x31 0011 0001
+
+// qlo and qhi take a single quad argument and return its low and high
+// 32 bits respectively as 32-bit integers.
+OPDEF(qlo,      50, 1)
+OPDEF(qhi,      51, 1)
+
+OPDEF(ldcb,     52, 2) // non-volatile 8-bit load
+
+OPDEF(ov,       53, 1)
+OPDEF(cs,       54, 1)
+
+// Integer (all sizes) relational operators.  (op ^ 1) is the op which flips the
+// left and right sides of the comparison, so (lt ^ 1) == gt, or the operator
+// "<" is xored with 1 to get ">".  Similarly, (op ^ 3) is the complement of
+// op, so (lt ^ 1) == ge, or the complement of the operator "<" is ">=" xored
+// with 3.  'u' prefix indicates the unsigned integer variant.
+// NB: These opcodes must remain continuous so that comparison-opcode detection
+// works correctly.
+OPDEF(eq,       55, 2) // integer equality
+OPDEF(lt,       56, 2) // 0x38 0011 1000
+OPDEF(gt,       57, 2) // 0x39 0011 1001
+OPDEF(le,       58, 2) // 0x3A 0011 1010
+OPDEF(ge,       59, 2) // 0x3B 0011 1011
+OPDEF(ult,      60, 2) // 0x3C 0011 1100
+OPDEF(ugt,      61, 2) // 0x3D 0011 1101
+OPDEF(ule,      62, 2) // 0x3E 0011 1110
+OPDEF(uge,      63, 2) // 0x3F 0011 1111
+
+OPDEF64(2,          0, 2) // wraps a pair of refs
+OPDEF64(file,       1, 2)
+OPDEF64(line,       2, 2)
+OPDEF64(unused3_64, 3, 2)
+
+OPDEF64(unused4_64,   4, 2)
+OPDEF64(unused5_64,   5, 2)
+OPDEF64(unused6_64,   6, 2)
+OPDEF64(unused7_64,   7, 2)
+OPDEF64(unused8_64,   8, 2)
+OPDEF64(unused9_64,   9, 2)
+OPDEF64(unused10_64, 10, 2)
+
+OPDEF64(stq, LIR_st, 2) // quad store
+OPDEF64(ldq, LIR_ld, 2) // quad load
+
+OPDEF64(unused13_64, 13, 2)
+
+OPDEF64(stqi,   LIR_sti, 2)
+OPDEF64(fret,   LIR_ret, 1)
+
+OPDEF64(unused16_64, 16, 2)
+
+OPDEF64(fcalli,      LIR_calli, 0)
+OPDEF64(fcall,       LIR_call, 0) // subroutine call returning quad
+
+OPDEF64(unused19_64, 19, 2)
+OPDEF64(unused20_64, 20, 2)
+OPDEF64(unused21_64, 21, 2)
+OPDEF64(unused22_64, 22, 2)
+OPDEF64(unused23_64, 23, 2)
+OPDEF64(qiand,       24, 2)
+OPDEF64(qiadd,       25, 2)
+OPDEF64(unused26_64, 26, 2)
+OPDEF64(unused27_64, 27, 2)
+OPDEF64(unused28_64, 28, 2)
+OPDEF64(unused29_64, 29, 2)
+OPDEF64(unused30_64, 30, 2)
+OPDEF64(unused31_64, 31, 2)
+OPDEF64(unused32_64, 32, 2)
+
+OPDEF64(quad,  LIR_int,  0) // quad constant value
+OPDEF64(qcmov, LIR_cmov, 2)
+OPDEF64(ldqc,  LIR_ldc,  2)
+
+
+/* floating-point arithmetic operations */
+OPDEF64(fneg,   LIR_neg, 1)
+OPDEF64(fadd,   LIR_add, 2)
+OPDEF64(fsub,   LIR_sub, 2)
+OPDEF64(fmul,   LIR_mul, 2)
+OPDEF64(fdiv,   40,      2)
+
+OPDEF64(qjoin, 41,      2)
+OPDEF64(i2f,   42,      1) // convert an integer to a float
+OPDEF64(u2f,   43,      1) // convert an unsigned integer to a float
+OPDEF64(qior,  44,      2)
+OPDEF64(qilsh, LIR_lsh, 2)
+
+OPDEF64(unused46_64, 46, 2)
+OPDEF64(unused47_64, 47, 2)
+OPDEF64(unused48_64, 48, 2)
+OPDEF64(unused49_64, 49, 2)
+OPDEF64(unused50_64, 50, 2)
+OPDEF64(unused51_64, 51, 2)
+OPDEF64(unused52_64, 52, 2)
+OPDEF64(unused53_64, 53, 2)
+OPDEF64(unused54_64, 54, 2)
+OPDEF64(unused55_64, 55, 2)
+OPDEF64(unused56_64, 56, 2)
+OPDEF64(unused57_64, 57, 2)
+OPDEF64(unused58_64, 58, 2)
+OPDEF64(unused59_64, 59, 2)
+OPDEF64(unused60_64, 60, 2)
+OPDEF64(unused61_64, 61, 2)
+OPDEF64(unused62_64, 62, 2)
+OPDEF64(unused63_64, 63, 2)
diff -r a4343d61f6ee js/src/nanojit/Native.h
--- a/js/src/nanojit/Native.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/nanojit/Native.h	Sat Nov 15 19:43:13 2008 -0500
@@ -54,16 +54,41 @@
 #elif defined(NANOJIT_AMD64)
 #include "NativeAMD64.h"
 #else
 #error "unknown nanojit architecture"
 #endif
 
 namespace nanojit {
 	const uint32_t NJ_PAGE_SIZE = 1 << NJ_LOG2_PAGE_SIZE;
+	
+    class Fragment;
+    struct SideExit;
+    
+    struct GuardRecord 
+    {
+        void* jmpToStub;
+        void* stubEntry;
+        void* jmpToTarget;
+        GuardRecord* next;
+        SideExit* exit;
+    };
+    
+    struct SideExit
+    {
+        GuardRecord* guards;
+        Fragment* from;
+        Fragment* target;
+        
+        void addGuard(GuardRecord* lr) 
+        {
+            lr->next = guards;
+            guards = lr;
+        }
+    };
 }
 
 	#ifdef NJ_STACK_GROWTH_UP
 		#define stack_direction(n)   n
 	#else
 		#define stack_direction(n)  -n
 	#endif
 	
@@ -79,21 +104,23 @@ namespace nanojit {
 			RegAlloc::formatRegisters(_allocator, outline, _thisfrag);\
 			Assembler::output_asm(outline); }
 		//#define PRFX					fprintf(stdout
 		//#define PSFX					fprintf(stdout,"\n")
 		#define asm_output(s)			PRFX,s); PSFX
 		#define asm_output1(s,x)		PRFX,s,x); PSFX
 		#define asm_output2(s,x,y)		PRFX,s,x,y); PSFX
 		#define asm_output3(s,x,y,z)	PRFX,s,x,y,z); PSFX
+		#define asm_output5(s,x,y,z,a,b) PRFX,s,x,y,z,a,b); PSFX
 		#define gpn(r)					regNames[(r)] 
 		#define fpn(r)					regNames[(r)] 
 	#else
 		#define PRFX			
 		#define asm_output(s)
 		#define asm_output1(s,x)	
 		#define asm_output2(s,x,y)	
 		#define asm_output3(s,x,y,z)	
+		#define asm_output5(s,x,y,z,a,b)	
 		#define gpn(r)		
 	#endif /* NJ_VERBOSE */
 
 
 #endif // __nanojit_Native__
diff -r a4343d61f6ee js/src/nanojit/NativeAMD64.h
--- a/js/src/nanojit/NativeAMD64.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/nanojit/NativeAMD64.h	Sat Nov 15 19:43:13 2008 -0500
@@ -224,16 +224,17 @@ namespace nanojit
 #define AMD64_MOV_REG_IMM(x)		(0xB8 | AMD64_ENCODE_REG(x))
 #define AMD64_MOV_REG_RM			0x8B		/* rm/r */
 #define AMD64_MOV_RM_REG			0x89		/* rm/r */
 #define AMD64_MOV_RM_IMM			0xC7		/* rm/0 imm */
 #define AMD64_MOVD_REG_RM			0x660F6E	/* rm/r */
 #define AMD64_MOVD_RM_REG			0x660F7E	/* rm/r */
 #define AMD64_MOVSD_REG_RM			0xF20F10	/* rm/r */
 #define AMD64_MOVZX					0x0FB6		/* rm/r */
+#define AMD64_MOVSZ                 0x0FB7      /* rm/r */
 #define AMD64_MULSD					0xF20F59	/* rm/r */
 #define AMD64_NEG_RM				0xF7		/* rm/3 */
 #define AMD64_NOT_RM				0xF7		/* rm/2 */
 #define AMD64_OR_RAX				0x0D		/* imm */
 #define AMD64_OR_REG_RM				0x0B		/* rm/r */
 #define AMD64_POP_REG(x)			(0x58 | AMD64_ENCODE_REG(x))
 #define AMD64_PUSH_REG(x)			(0x50 | AMD64_ENCODE_REG(x))
 #define AMD64_PUSH_RM				0xFF		/* rm/6 */
@@ -746,17 +747,29 @@ namespace nanojit
 	*(--_nIns) = AMD64_MOVZX & 0xFF;							\
 	*(--_nIns) = AMD64_MOVZX >> 8;								\
 	if (AMD64_NEEDS_REX(r) || AMD64_NEEDS_REX(b)) {				\
 		*(--_nIns) = AMD64_REX(0,r,b);							\
 	}															\
 	asm_output3("movzx %s,%d(%s)", gpn(r),d,gpn(b)); 			\
 	} while(0)
 
+	
+#define LD16Z(r,d,b) do {                                        \
+    underrunProtect(5);                                         \
+    AMD64_MODRM_DISP(r, b, d);                                  \
+    *(--_nIns) = AMD64_MOVSX & 0xFF;                            \
+    *(--_nIns) = AMD64_MOVSX >> 8;                              \
+    if (AMD64_NEEDS_REX(r) || AMD64_NEEDS_REX(b)) {             \
+        *(--_nIns) = AMD64_REX(0,r,b);                          \
+    }                                                           \
+    asm_output3("movsx %s,%d(%s)", gpn(r),d,gpn(b));            \
+    } while(0)
 
+    
 #define LDi(r,i) do { 											\
 	underrunProtect(6);											\
 	IMM32(i);													\
 	*(--_nIns) = AMD64_MODRM_REG(0, r);							\
 	*(--_nIns) = AMD64_MOV_RM_IMM;								\
 	*(--_nIns) = AMD64_REX(1,0,r);							    \
 	asm_output2("mov %s,%d",gpn(r),i);							\
 	} while (0)
diff -r a4343d61f6ee js/src/nanojit/NativeARM.cpp
--- a/js/src/nanojit/NativeARM.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/nanojit/NativeARM.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -80,17 +80,17 @@ Assembler::genPrologue()
 
     // NJ_RESV_OFFSET is space at the top of the stack for us
     // to use for parameter passing (8 bytes at the moment)
     uint32_t stackNeeded = STACK_GRANULARITY * _activation.highwatermark + NJ_STACK_OFFSET;
 
     uint32_t savingMask = rmask(FP) | rmask(LR);
     uint32_t savingCount = 2;
 
-    if (!_thisfrag->lirbuf->explicitSavedParams) {
+    if (!_thisfrag->lirbuf->explicitSavedRegs) {
         for (int i = 0; i < NumSavedRegs; ++i)
             savingMask |= rmask(savedRegs[i]);
         savingCount += NumSavedRegs;
     }
 
     // so for alignment purposes we've pushed return addr and fp
     uint32_t stackPushed = STACK_GRANULARITY * savingCount;
     uint32_t aligned = alignUp(stackNeeded + stackPushed, NJ_ALIGN_STACK);
@@ -112,28 +112,28 @@ void
 void
 Assembler::nFragExit(LInsp guard)
 {
     SideExit* exit = guard->record()->exit;
     Fragment *frag = exit->target;
     GuardRecord *lr;
 
     if (frag && frag->fragEntry) {
-        JMP(frag->fragEntry);
+        JMP_far(frag->fragEntry);
         lr = 0;
     } else {
         // target doesn't exit yet.  emit jump to epilog, and set up to patch later.
         lr = guard->record();
 
-        // we need to know that there's an extra immediate value available
-        // for us; always force a far jump here.
+        // jump to the epilogue; JMP_far will insert an extra dummy insn for later
+        // patching.
         JMP_far(_epilogue);
 
         // stick the jmp pointer to the start of the sequence
-        lr->jmp = _nIns;
+        lr->jmpToTarget = _nIns;
     }
 
     // pop the stack frame first
     MR(SP, FP);
 
 #ifdef NJ_VERBOSE
     if (_frago->core()->config.show_stats) {
         // load R1 with Fragment *fromFrag, target fragment
@@ -152,21 +152,23 @@ Assembler::nFragExit(LInsp guard)
 
 NIns*
 Assembler::genEpilogue()
 {
     BX(LR); // return
 
     RegisterMask savingMask = rmask(FP) | rmask(LR);
 
-    if (!_thisfrag->lirbuf->explicitSavedParams)
+    if (!_thisfrag->lirbuf->explicitSavedRegs)
         for (int i = 0; i < NumSavedRegs; ++i)
             savingMask |= rmask(savedRegs[i]);
 
     POP_mask(savingMask); // regs
+
+    MR(SP,FP);
 
     // this is needed if we jump here from nFragExit
     MR(R0,R2); // return LinkRecord*
 
     return _nIns;
 }
 
 void
@@ -320,39 +322,58 @@ Assembler::nRegisterResetAll(RegAlloc& a
         rmask(R10);
 #ifdef NJ_ARM_VFP
     a.free |= FpRegs;
 #endif
 
     debug_only(a.managed = a.free);
 }
 
-void
-Assembler::nPatchBranch(NIns* branch, NIns* target)
+NIns*
+Assembler::nPatchBranch(NIns* at, NIns* target)
 {
-    // Patch the jump in a loop
+    // Patch the jump in a loop, as emitted by JMP_far.
+    // Figure out which, and do the right thing.
 
-    // This is ALWAYS going to be a long branch (using the BL instruction)
-    // Which is really 2 instructions, so we need to modify both
-    // XXX -- this is B, not BL, at least on non-Thumb..
+    NIns* was = 0;
 
-    int32_t offset = PC_OFFSET_FROM(target, branch);
+    if (at[0] == (NIns)( COND_AL | (0x51<<20) | (PC<<16) | (PC<<12) | (4) )) {
+        // this needed to be emitted with a 32-bit immediate.
+        was = (NIns*) at[1];
+    } else {
+        // nope, just a regular PC-relative B; calculate the destination address
+        // based on at and the offset.
+        NanoAssert((at[0] & 0xff000000) == (COND_AL | (0xA<<24)));
+        was = (NIns*) (((intptr_t)at + 8) + (intptr_t)((at[0] & 0xffffff) << 2));
+    }
 
-    //printf("---patching branch at 0x%08x to location 0x%08x (%d-0x%08x)\n", branch, target, offset, offset);
+    // let's see how we have to emit it
+    intptr_t offs = PC_OFFSET_FROM(target, at);
+    if (isS24(offs>>2)) {
+        // great, just stick it in at[0]
+        at[0] = (NIns)( COND_AL | (0xA<<24) | ((offs >> 2) & 0xffffff) );
+        // and reset at[1] for good measure
+        at[1] = BKPT_insn;
+    } else {
+        at[0] = (NIns)( COND_AL | (0x51<<20) | (PC<<16) | (PC<<12) | (4) );
+        at[1] = (NIns)(target);
+    }
 
-    // We have 2 words to work with here -- if offset is in range of a 24-bit
-    // relative jump, emit that; otherwise, we do a pc-relative load into pc.
-    if (isS24(offset)) {
-        // ARM goodness, using unconditional B
-        *branch = (NIns)( COND_AL | (0xA<<24) | ((offset>>2) & 0xFFFFFF) );
-    } else {
-        // LDR pc,[pc]
-        *branch++ = (NIns)( COND_AL | (0x51<<20) | (PC<<16) | (PC<<12) | ( 0x004 ) );
-        *branch = (NIns)target;
-    }
+#if defined(UNDER_CE)
+    // we changed the code, so we need to do this (sadly)
+    FlushInstructionCache(GetCurrentProcess(), NULL, NULL);
+#elif defined(AVMPLUS_LINUX)
+    __clear_cache((char*)at, (char*)(at+3));
+#endif
+
+#ifdef AVMPLUS_PORTING_API
+    NanoJIT_PortAPI_FlushInstructionCache(at, at+3);
+#endif
+
+    return was;
 }
 
 RegisterMask
 Assembler::hint(LIns* i, RegisterMask allow /* = ~0 */)
 {
     uint32_t op = i->opcode();
     int prefer = ~0;
 
@@ -480,17 +501,17 @@ Assembler::asm_load64(LInsp ins)
 }
 
 void
 Assembler::asm_store64(LInsp value, int dr, LInsp base)
 {
     //asm_output1("<<< store64 (dr: %d)", dr);
 
 #ifdef NJ_ARM_VFP
-    Reservation *valResv = getresv(value);
+    //Reservation *valResv = getresv(value);
     Register rb = findRegFor(base, GpRegs);
 
     if (value->isconstq()) {
         const int32_t* p = (const int32_t*) (value-2);
 
         STR(Scratch, rb, dr);
         LD32_nochk(Scratch, p[0]);
         STR(Scratch, rb, dr+4);
@@ -710,45 +731,16 @@ Assembler::nativePageSetup()
         _nExitIns--;
 
         // constpool starts at top of page and goes down,
         // code starts at bottom of page and moves up
         _nSlot = pageDataStart(_nIns); //(int*)(&((Page*)pageTop(_nIns))->lir[0]);
     }
 }
 
-NIns*
-Assembler::asm_adjustBranch(NIns* at, NIns* target)
-{
-    // This always got emitted as a JMP_far sequence; at points
-    // to the first of 3 instructions.  Ensure that we're where
-    // we think we were..
-    NanoAssert(at[0] == (NIns)( COND_AL | (0x59<<20) | (PC<<16) | (IP<<12) | (0) ));
-    NanoAssert(at[1] == (NIns)( COND_AL | (0x9<<21) | (0xFFF<<8) | (1<<4) | (IP) ));
-
-    NIns* was = (NIns*) at[2];
-
-    //fprintf (stderr, "Adjusting branch @ 0x%8x: 0x%x -> 0x%x\n", at+3, at[3], target);
-
-    at[2] = (NIns)target;
-
-#if defined(UNDER_CE)
-    // we changed the code, so we need to do this (sadly)
-    FlushInstructionCache(GetCurrentProcess(), NULL, NULL);
-#elif defined(AVMPLUS_LINUX)
-    __clear_cache((char*)at, (char*)(at+3));
-#endif
-
-#ifdef AVMPLUS_PORTING_API
-    NanoJIT_PortAPI_FlushInstructionCache(at, at+3);
-#endif
-
-    return was;
-}
-
 void
 Assembler::underrunProtect(int bytes)
 {
     intptr_t u = bytes + sizeof(PageHeader)/sizeof(NIns) + 8;
     if ( (samepage(_nIns,_nSlot) && (((intptr_t)_nIns-u) <= intptr_t(_nSlot+1))) ||
          (!samepage((intptr_t)_nIns-u,_nIns)) )
     {
         NIns* target = _nIns;
@@ -777,78 +769,65 @@ Assembler::underrunProtect(int bytes)
         // make sure that there's always a slot pointer
         _nSlot = pageDataStart(_nIns);
     }
 }
 
 void
 Assembler::JMP_far(NIns* addr)
 {
-    // we have to stick an immediate into the stream
-    underrunProtect(12);
+    // we may have to stick an immediate into the stream, so always
+    // reserve space
+    underrunProtect(8);
 
-    // TODO use a slot in const pool for address, but emit single insn
-    // for branch if offset fits
+    intptr_t offs = PC_OFFSET_FROM(addr,_nIns-2);
 
-    // the address
-    *(--_nIns) = (NIns)((addr));
-    // bx ip             // branch to the address we loaded earlier
-    *(--_nIns) = (NIns)( COND_AL | (0x9<<21) | (0xFFF<<8) | (1<<4) | (IP) );
-    // ldr ip, [pc + #0] // load the address into ip, reading it from [pc]
-    *(--_nIns) = (NIns)( COND_AL | (0x59<<20) | (PC<<16) | (IP<<12) | (0));
+    if (isS24(offs>>2)) {
+        BKPT_nochk();
+        *(--_nIns) = (NIns)( COND_AL | (0xA<<24) | ((offs>>2) & 0xFFFFFF) );
 
-    //fprintf (stderr, "JMP_far sequence @ 0x%08x\n", _nIns);
+        asm_output1("b %p", addr);
+    } else {
+        // the address
+        *(--_nIns) = (NIns)((addr));
+        // ldr pc, [pc - #4] // load the address into pc, reading it from [pc-4] (e.g.,
+        // the next instruction)
+        *(--_nIns) = (NIns)( COND_AL | (0x51<<20) | (PC<<16) | (PC<<12) | (4));
 
-    asm_output1("b %p (32-bit)", addr);
-}
-
-void
-Assembler::BL_far(NIns* addr)
-{
-    // we have to stick an immediate into the stream and make lr
-    // point to the right spot before branching
-    underrunProtect(16);
-
-    // TODO use a slot in const pool for address, but emit single insn
-    // for branch if offset fits
-
-    // the address
-    *(--_nIns) = (NIns)((addr));
-    // bx ip             // branch to the address we loaded earlier
-    *(--_nIns) = (NIns)( COND_AL | (0x9<<21) | (0xFFF<<8) | (1<<4) | (IP) );
-    // add lr, [pc + #4] // set lr to be past the address that we wrote
-    *(--_nIns) = (NIns)( COND_AL | OP_IMM | (1<<23) | (PC<<16) | (LR<<12) | (4) );
-    // ldr ip, [pc + #4] // load the address into ip, reading it from [pc+4]
-    *(--_nIns) = (NIns)( COND_AL | (0x59<<20) | (PC<<16) | (IP<<12) | (4));
-
-    //fprintf (stderr, "BL_far sequence @ 0x%08x\n", _nIns);
-
-    asm_output1("bl %p (32-bit)", addr);
+        asm_output1("b %p (32-bit)", addr);
+    }
 }
 
 void
 Assembler::BL(NIns* addr)
 {
     intptr_t offs = PC_OFFSET_FROM(addr,_nIns-1);
 
     //fprintf (stderr, "BL: 0x%x (offs: %d [%x]) @ 0x%08x\n", addr, offs, offs, (intptr_t)(_nIns-1));
 
-    if (isS24(offs)) {
-        // try to do this with a single S24 call;
-        // recompute offset in case underrunProtect had to allocate a new page
+    // try to do this with a single S24 call
+    if (isS24(offs>>2)) {
         underrunProtect(4);
+
+        // recompute offset in case underrunProtect had to allocate a new page.
         offs = PC_OFFSET_FROM(addr,_nIns-1);
-    }
+        *(--_nIns) = (NIns)( COND_AL | (0xB<<24) | ((offs>>2) & 0xFFFFFF) );
 
-    if (isS24(offs)) {
-        // already did underrunProtect above
-        *(--_nIns) = (NIns)( COND_AL | (0xB<<24) | (((offs)>>2) & 0xFFFFFF) );
         asm_output1("bl %p", addr);
     } else {
-        BL_far(addr);
+        underrunProtect(12);
+
+        // the address
+        *(--_nIns) = (NIns)((addr));
+        // ldr pc, [pc - #4] // load the address into ip, reading it from [pc-4]
+        *(--_nIns) = (NIns)( COND_AL | (0x51<<20) | (PC<<16) | (PC<<12) | (4));
+        // add lr, pc, #4    // set lr to be past the address that we wrote
+        *(--_nIns) = (NIns)( COND_AL | OP_IMM | (1<<23) | (PC<<16) | (LR<<12) | (4) );
+
+        asm_output1("bl %p (32-bit)", addr);
     }
 }
 
 void
 Assembler::LD32_nochk(Register r, int32_t imm)
 {
     if (imm == 0) {
         XOR(r, r);
@@ -885,22 +864,22 @@ Assembler::LD32_nochk(Register r, int32_
 // and emit a jump to jump over it it in case the condition fails.
 //
 // NB: JMP_nochk depends on this not calling samepage() when _c == AL
 void
 Assembler::B_cond_chk(ConditionCode _c, NIns* _t, bool _chk)
 {
     int32_t offs = PC_OFFSET_FROM(_t,_nIns-1);
     //fprintf(stderr, "B_cond_chk target: 0x%08x offset: %d @0x%08x\n", _t, offs, _nIns-1);
-    if (isS24(offs)) {
+    if (isS24(offs>>2)) {
         if (_chk) underrunProtect(4);
         offs = PC_OFFSET_FROM(_t,_nIns-1);
     }
 
-    if (isS24(offs)) {
+    if (isS24(offs>>2)) {
         *(--_nIns) = (NIns)( ((_c)<<28) | (0xA<<24) | (((offs)>>2) & 0xFFFFFF) );
     } else if (_c == AL) {
         if(_chk) underrunProtect(8);
         *(--_nIns) = (NIns)(_t);
         *(--_nIns) = (NIns)( COND_AL | (0x51<<20) | (PC<<16) | (PC<<12) | 0x4 );
     } else if (samepage(_nIns,_nSlot)) {
         if(_chk) underrunProtect(8);
         *(++_nSlot) = (NIns)(_t);
@@ -1111,18 +1090,22 @@ Register
 Register
 Assembler::asm_prep_fcall(Reservation*, LInsp)
 {
     // We have nothing to do here; we do it all in asm_call.
     return UnknownReg;
 }
 
 NIns*
-Assembler::asm_branch(bool branchOnFalse, LInsp cond, NIns* targ)
+Assembler::asm_branch(bool branchOnFalse, LInsp cond, NIns* targ, bool far)
 {
+    // ignore far -- we figure this out on our own.
+    // XXX noone actually uses the far param in nj anyway... (always false)
+    (void)far;
+
     NIns* at = 0;
     LOpcode condop = cond->opcode();
     NanoAssert(cond->isCond());
 
     if (condop >= LIR_feq && condop <= LIR_fge)
     {
         if (branchOnFalse)
             JNE(targ);
@@ -1205,67 +1188,69 @@ Assembler::asm_cmp(LIns *cond)
     NanoAssert(!lhs->isQuad() && !rhs->isQuad());
 
     // ready to issue the compare
     if (rhs->isconst()) {
         int c = rhs->constval();
         if (c == 0 && cond->isop(LIR_eq)) {
             Register r = findRegFor(lhs, GpRegs);
             TEST(r,r);
-			// No 64-bit immediates so fall-back to below
+            // No 64-bit immediates so fall-back to below
         }
         else if (!rhs->isQuad()) {
             Register r = getBaseReg(lhs, c, GpRegs);
             CMPi(r, c);
         }
     } else {
         findRegFor2(GpRegs, lhs, rA, rhs, rB);
         Register ra = rA->reg;
         Register rb = rB->reg;
         CMP(ra, rb);
     }
 }
 
 void
 Assembler::asm_loop(LInsp ins, NInsList& loopJumps)
 {
-    (void)ins;
-    JMP_long_placeholder(); // jump to SOT	
-    verbose_only( if (_verbose && _outputCache) { _outputCache->removeLast(); outputf("         jmp   SOT"); } );
-		
+    GuardRecord* guard = ins->record();
+    SideExit* exit = guard->exit;
+
+    // XXX asm_loop should be in Assembler.cpp!
+
+    // Emit an exit stub that the loop may be patched to jump to (for example if we
+    // want to terminate the loop because a timeout fires).
+    asm_exit(ins);
+
+    // Emit the patchable jump itself.
+    JMP_far(0);
+
     loopJumps.add(_nIns);
+    guard->jmpToStub = _nIns;
 
-#ifdef NJ_VERBOSE
-    // branching from this frag to ourself.
-    if (_frago->core()->config.show_stats)
-        LDi(argRegs[1], int((Fragment*)_thisfrag));
-#endif
-
-    assignSavedParams();
-
-    // restore first parameter, the only one we use
-    LInsp state = _thisfrag->lirbuf->state;
-    findSpecificRegFor(state, argRegs[state->imm8()]);
+    // If the target we are looping to is in a different fragment, we have to restore
+    // SP since we will target fragEntry and not loopEntry.
+    if (exit->target != _thisfrag)
+        MR(SP,FP);
 }
 
 void
 Assembler::asm_fcond(LInsp ins)
 {
     // only want certain regs
     Register r = prepResultReg(ins, AllowableFlagRegs);
 
     SETE(r);
     asm_fcmp(ins);
 }
-				
+
 void
 Assembler::asm_cond(LInsp ins)
 {
     // only want certain regs
-    LOpcode op = ins->opcode();			
+    LOpcode op = ins->opcode();
     Register r = prepResultReg(ins, AllowableFlagRegs);
     // SETcc only sets low 8 bits, so extend
     MOVZX8(r,r);
     if (op == LIR_eq)
         SETE(r);
     else if (op == LIR_ov)
         SETO(r);
     else if (op == LIR_cs)
@@ -1283,21 +1268,21 @@ Assembler::asm_cond(LInsp ins)
     else if (op == LIR_ule)
         SETBE(r);
     else if (op == LIR_ugt)
         SETA(r);
     else // if (op == LIR_uge)
         SETAE(r);
     asm_cmp(ins);
 }
-	
+
 void
 Assembler::asm_arith(LInsp ins)
 {
-    LOpcode op = ins->opcode();			
+    LOpcode op = ins->opcode();
     LInsp lhs = ins->oprnd1();
     LInsp rhs = ins->oprnd2();
 
     Register rb = UnknownReg;
     RegisterMask allow = GpRegs;
     bool forceReg = (op == LIR_mul || !rhs->isconst());
 
     // Arm can't do an immediate op with immediates
@@ -1352,17 +1337,17 @@ Assembler::asm_arith(LInsp ins)
             SHR(rr, rb);
         else
             NanoAssertMsg(0, "Unsupported");
     } else {
         int c = rhs->constval();
         if (op == LIR_add || op == LIR_addp)
             ADDi(rr, c);
         else if (op == LIR_sub)
-					SUBi(rr, c);
+                    SUBi(rr, c);
         else if (op == LIR_and)
             ANDi(rr, c);
         else if (op == LIR_or)
             ORi(rr, c);
         else if (op == LIR_xor)
             XORi(rr, c);
         else if (op == LIR_lsh)
             SHLi(rr, c);
@@ -1372,21 +1357,21 @@ Assembler::asm_arith(LInsp ins)
             SHRi(rr, c);
         else
             NanoAssertMsg(0, "Unsupported");
     }
 
     if (rr != ra)
         MR(rr,ra);
 }
-	
+
 void
 Assembler::asm_neg_not(LInsp ins)
 {
-    LOpcode op = ins->opcode();			
+    LOpcode op = ins->opcode();
     Register rr = prepResultReg(ins, GpRegs);
 
     LIns* lhs = ins->oprnd1();
     Reservation *rA = getresv(lhs);
     // if this is last use of lhs in reg, we can re-use result reg
     Register ra;
     if (rA == 0 || (ra=rA->reg) == UnknownReg)
         ra = findSpecificRegFor(lhs, rr);
@@ -1395,75 +1380,79 @@ Assembler::asm_neg_not(LInsp ins)
     if (op == LIR_not)
         NOT(rr);
     else
         NEG(rr);
 
     if ( rr != ra )
         MR(rr,ra);
 }
-				
+
 void
 Assembler::asm_ld(LInsp ins)
 {
-    LOpcode op = ins->opcode();			
+    LOpcode op = ins->opcode();
     LIns* base = ins->oprnd1();
     LIns* disp = ins->oprnd2();
     Register rr = prepResultReg(ins, GpRegs);
     int d = disp->constval();
     Register ra = getBaseReg(base, d, GpRegs);
-    if (op == LIR_ldcb)
-        LD8Z(rr, d, ra);
+    if (op == LIR_ld || op == LIR_ldc)
+        LD(rr, d, ra);
+    else if (op == LIR_ldcb)
+        LDRB(rr, d, ra);
+    else if (op == LIR_ldcs)
+        LDRH(rr, d, ra);
     else
-        LD(rr, d, ra);
+        NanoAssertMsg(0, "Unsupported instruction in asm_ld");
 }
 
 void
 Assembler::asm_cmov(LInsp ins)
 {
-    LOpcode op = ins->opcode();			
+    LOpcode op = ins->opcode();
     LIns* condval = ins->oprnd1();
     NanoAssert(condval->isCmp());
 
     LIns* values = ins->oprnd2();
 
     NanoAssert(values->opcode() == LIR_2);
     LIns* iftrue = values->oprnd1();
     LIns* iffalse = values->oprnd2();
 
     NanoAssert(op == LIR_qcmov || (!iftrue->isQuad() && !iffalse->isQuad()));
-		
+
     const Register rr = prepResultReg(ins, GpRegs);
 
     // this code assumes that neither LD nor MR nor MRcc set any of the condition flags.
     // (This is true on Intel, is it true on all architectures?)
     const Register iffalsereg = findRegFor(iffalse, GpRegs & ~rmask(rr));
     if (op == LIR_cmov) {
         switch (condval->opcode()) {
             // note that these are all opposites...
-            case LIR_eq:	MRNE(rr, iffalsereg);	break;
+            case LIR_eq:    MRNE(rr, iffalsereg);   break;
             case LIR_ov:    MRNO(rr, iffalsereg);   break;
             case LIR_cs:    MRNC(rr, iffalsereg);   break;
-            case LIR_lt:	MRGE(rr, iffalsereg);	break;
-            case LIR_le:	MRG(rr, iffalsereg);	break;
-            case LIR_gt:	MRLE(rr, iffalsereg);	break;
-            case LIR_ge:	MRL(rr, iffalsereg);	break;
-            case LIR_ult:	MRAE(rr, iffalsereg);	break;
-            case LIR_ule:	MRA(rr, iffalsereg);	break;
-            case LIR_ugt:	MRBE(rr, iffalsereg);	break;
-            case LIR_uge:	MRB(rr, iffalsereg);	break;
-				debug_only( default: NanoAssert(0); break; )
+            case LIR_lt:    MRGE(rr, iffalsereg);   break;
+            case LIR_le:    MRG(rr, iffalsereg);    break;
+            case LIR_gt:    MRLE(rr, iffalsereg);   break;
+            case LIR_ge:    MRL(rr, iffalsereg);    break;
+            case LIR_ult:   MRAE(rr, iffalsereg);   break;
+            case LIR_ule:   MRA(rr, iffalsereg);    break;
+            case LIR_ugt:   MRBE(rr, iffalsereg);   break;
+            case LIR_uge:   MRB(rr, iffalsereg);    break;
+            default: debug_only( NanoAssert(0) );   break;
         }
     } else if (op == LIR_qcmov) {
         NanoAssert(0);
     }
     /*const Register iftruereg =*/ findSpecificRegFor(iftrue, rr);
     asm_cmp(condval);
 }
-				
+
 void
 Assembler::asm_qhi(LInsp ins)
 {
     Register rr = prepResultReg(ins, GpRegs);
     LIns *q = ins->oprnd1();
     int d = findMemFor(q);
     LD(rr, d+4, FP);
 }
@@ -1556,17 +1545,17 @@ Assembler::asm_quad(LInsp ins)
         NanoAssert((rmask(rr) & FpRegs) != 0);
 
         const double d = ins->constvalf();
         const uint64_t q = ins->constvalq();
         if (rmask(rr) & XmmRegs) {
             if (q == 0.0) {
                 // test (int64)0 since -0.0 == 0.0
                 SSE_XORPDr(rr, rr);
-				} else if (d == 1.0) {
+            } else if (d == 1.0) {
                 // 1.0 is extremely frequent and worth special-casing!
                 static const double k_ONE = 1.0;
                 LDSDm(rr, &k_ONE);
             } else {
                 findMemFor(ins);
                 const int d = disp(rR);
                 SSE_LDQ(rr, d, FP);
             }
diff -r a4343d61f6ee js/src/nanojit/NativeARM.h
--- a/js/src/nanojit/NativeARM.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/nanojit/NativeARM.h	Sat Nov 15 19:43:13 2008 -0500
@@ -193,17 +193,16 @@ verbose_only( extern const char* regName
 #define DECLARE_PLATFORM_STATS()
 
 #define DECLARE_PLATFORM_REGALLOC()
 
 #define DECLARE_PLATFORM_ASSEMBLER()                                    \
     const static Register argRegs[4], retRegs[2];                       \
     void LD32_nochk(Register r, int32_t imm);                           \
     void BL(NIns*);                                                     \
-    void BL_far(NIns*);                                                 \
     void JMP_far(NIns*);                                                \
     void B_cond_chk(ConditionCode, NIns*, bool);                        \
     void underrunProtect(int bytes);                                    \
     void nativePageReset();                                             \
     void nativePageSetup();                                             \
     void asm_quad_nochk(Register, const int32_t*);                      \
     void asm_add_imm(Register, Register, int32_t);                      \
     int* _nSlot;                                                        \
@@ -529,25 +528,33 @@ typedef enum {
         } else {                                                        \
             underrunProtect(LD32_size);                                 \
             LD32_nochk(_d, (_imm));                                     \
             asm_output2("ld  %s,0x%x",gpn((_d)),(_imm));                \
         }                                                               \
     } while(0)
 
 
-// load 8-bit, zero extend (aka LDRB)
-// note, only 5-bit offsets (!) are supported for this, but that's all we need at the moment
-// (LDRB actually allows 12-bit offset in ARM mode but constraining to 5-bit gives us advantage for Thumb)
-// @todo, untested!
-#define LD8Z(_d,_off,_b) do {                                           \
-        NanoAssert((d)>=0&&(d)<=31);                                    \
+// load 8-bit, zero extend (aka LDRB) note, only 5-bit offsets (!) are
+// supported for this, but that's all we need at the moment.
+// (LDRB/LDRH actually allow a 12-bit offset in ARM mode but
+// constraining to 5-bit gives us advantage for Thumb)
+#define LDRB(_d,_off,_b) do {                                           \
+        NanoAssert((_off)>=0&&(_off)<=31);                              \
         underrunProtect(4);                                             \
-        *(--_nIns) = (NIns)( COND_AL | (0x5D<<20) | ((_b)<<16) | ((_d)<<12) |  ((_off)&0xfff)  ); \
+        *(--_nIns) = (NIns)( COND_AL | (0x5D<<20) | ((_b)<<16) | ((_d)<<12) | ((_off)&0xfff)  ); \
         asm_output3("ldrb %s,%d(%s)", gpn(_d),(_off),gpn(_b));          \
+    } while(0)
+
+// P and U
+#define LDRH(_d,_off,_b) do {                  \
+        NanoAssert((_off)>=0&&(_off)<=31);      \
+        underrunProtect(4);                     \
+        *(--_nIns) = (NIns)( COND_AL | (0x1D<<20) | ((_b)<<16) | ((_d)<<12) | ((0xB)<<4) | (((_off)&0xf0)<<4) | ((_off)&0xf) ); \
+        asm_output3("ldrsh %s,%d(%s)", gpn(_d),(_off),gpn(_b));         \
     } while(0)
 
 #define STR(_d,_n,_off) do {                                            \
         NanoAssert(!IsFpReg(_d) && isS12(_off));                        \
         underrunProtect(4);                                             \
         if ((_off)<0)   *(--_nIns) = (NIns)( COND_AL | (0x50<<20) | ((_n)<<16) | ((_d)<<12) | ((-(_off))&0xFFF) ); \
         else            *(--_nIns) = (NIns)( COND_AL | (0x58<<20) | ((_n)<<16) | ((_d)<<12) | ((_off)&0xFFF) ); \
         asm_output3("str %s, [%s, #%d]", gpn(_d), gpn(_n), (_off)); \
@@ -588,18 +595,24 @@ typedef enum {
     } while(0)
 
 
 //#define RET()   underrunProtect(1); *(--_nIns) = 0xc3;    asm_output("ret")
 //#define NOP()     underrunProtect(1); *(--_nIns) = 0x90;  asm_output("nop")
 //#define INT3()  underrunProtect(1); *(--_nIns) = 0xcc;  asm_output("int3")
 //#define RET() INT3()
 
+#define BKPT_insn ((NIns)( (0xE<<24) | (0x12<<20) | (0x7<<4) ))
 #define BKPT_nochk() do { \
-        *(--_nIns) = (NIns)( (0xE<<24) | (0x12<<20) | (0x7<<4) ); } while (0)
+        *(--_nIns) = BKPT_insn; } while (0)
+
+// this isn't a armv6t2 NOP -- it's a mov r0,r0
+#define NOP_nochk() do { \
+        *(--_nIns) = (NIns)( COND_AL | (0xD<<21) | ((R0)<<12) | (R0) ); \
+        asm_output("nop"); } while(0)
 
 // this is pushing a reg
 #define PUSHr(_r)  do {                                                 \
         underrunProtect(4);                                             \
         *(--_nIns) = (NIns)( COND_AL | (0x92<<20) | (SP<<16) | (1<<(_r)) ); \
         asm_output1("push %s",gpn(_r)); } while (0)
 
 // STMDB
@@ -636,25 +649,16 @@ typedef enum {
     B_cond_chk(_c,_t,1)
 
 // NB: don't use COND_AL here, we shift the condition into place!
 #define JMP(_t)                                 \
     B_cond_chk(AL,_t,1)
 
 #define JMP_nochk(_t)                           \
     B_cond_chk(AL,_t,0)
-
-// emit a placeholder that will be filled in later by nPatchBranch;
-// emit two breakpoint instructions in case something goes wrong with
-// the patching.
-#define JMP_long_placeholder()  do {            \
-        underrunProtect(8);                     \
-        BKPT_nochk();                           \
-        BKPT_nochk();                           \
-    } while(0)
 
 #define JA(t)   do {B_cond(HI,t); asm_output1("ja 0x%08x",(unsigned int)t); } while(0)
 #define JNA(t)  do {B_cond(LS,t); asm_output1("jna 0x%08x",(unsigned int)t); } while(0)
 #define JB(t)   do {B_cond(CC,t); asm_output1("jb 0x%08x",(unsigned int)t); } while(0)
 #define JNB(t)  do {B_cond(CS,t); asm_output1("jnb 0x%08x",(unsigned int)t); } while(0)
 #define JE(t)   do {B_cond(EQ,t); asm_output1("je 0x%08x",(unsigned int)t); } while(0)
 #define JNE(t)  do {B_cond(NE,t); asm_output1("jne 0x%08x",(unsigned int)t); } while(0)                     
 #define JBE(t)  do {B_cond(LS,t); asm_output1("jbe 0x%08x",(unsigned int)t); } while(0)
diff -r a4343d61f6ee js/src/nanojit/Nativei386.cpp
--- a/js/src/nanojit/Nativei386.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/nanojit/Nativei386.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -105,17 +105,17 @@ namespace nanojit
 		 * Prologue
 		 */
 		uint32_t stackNeeded = STACK_GRANULARITY * _activation.highwatermark;
 
 		uint32_t stackPushed =
             STACK_GRANULARITY + // returnaddr
             STACK_GRANULARITY; // ebp
 		
-		if (!_thisfrag->lirbuf->explicitSavedParams)
+		if (!_thisfrag->lirbuf->explicitSavedRegs)
 			stackPushed += NumSavedRegs * STACK_GRANULARITY;
 		
 		uint32_t aligned = alignUp(stackNeeded + stackPushed, NJ_ALIGN_STACK);
 		uint32_t amt = aligned - stackPushed;
 
 		// Reserve stackNeeded bytes, padded
 		// to preserve NJ_ALIGN_STACK-byte alignment.
 		if (amt) 
@@ -123,33 +123,33 @@ namespace nanojit
 #if defined NANOJIT_IA32
 			SUBi(SP, amt);
 #elif defined NANOJIT_AMD64
 			SUBQi(SP, amt);
 #endif
 		}
 
 		verbose_only( verbose_outputf("        %p:",_nIns); )
-		verbose_only( verbose_output("        patch entry:"); )
-        NIns *patchEntry = _nIns;
+		verbose_only( verbose_output("        frag entry:"); )
+        NIns *fragEntry = _nIns;
 		MR(FP, SP); // Establish our own FP.
         PUSHr(FP); // Save caller's FP.
 
-		if (!_thisfrag->lirbuf->explicitSavedParams) 
+		if (!_thisfrag->lirbuf->explicitSavedRegs) 
 			for (int i = 0; i < NumSavedRegs; ++i)
 				PUSHr(savedRegs[i]);
 
         // align the entry point
         asm_align_code();
 
-		return patchEntry;
+		return fragEntry;
 	}
 
     void Assembler::asm_align_code() {
-        static char nop[][9] = {
+        static uint8_t nop[][9] = {
                 {0x90},
                 {0x66,0x90},
                 {0x0f,0x1f,0x00},
                 {0x0f,0x1f,0x40,0x00},
                 {0x0f,0x1f,0x44,0x00,0x00},
                 {0x66,0x0f,0x1f,0x44,0x00,0x00},
                 {0x0f,0x1f,0x80,0x00,0x00,0x00,0x00},
                 {0x0f,0x1f,0x84,0x00,0x00,0x00,0x00,0x00},
@@ -168,67 +168,54 @@ namespace nanojit
 
 	void Assembler::nFragExit(LInsp guard)
 	{
 		SideExit *exit = guard->record()->exit;
 		bool trees = _frago->core()->config.tree_opt;
         Fragment *frag = exit->target;
         GuardRecord *lr = 0;
 		bool destKnown = (frag && frag->fragEntry);
-		if (destKnown && !trees)
+		if (destKnown && !trees && !guard->isop(LIR_loop))
 		{
 			// already exists, emit jump now.  no patching required.
 			JMP(frag->fragEntry);
             lr = 0;
 		}
 		else
 		{
 			// target doesn't exit yet.  emit jump to epilog, and set up to patch later.
 			lr = guard->record();
 #if defined NANOJIT_AMD64
             /* 8 bytes for address, 4 for imm32, 2 for jmp */
             underrunProtect(14);
             _nIns -= 8;
             *(intptr_t *)_nIns = intptr_t(_epilogue);
-            lr->jmp = _nIns;
+            lr->jmpToTarget = _nIns;
             JMPm_nochk(0);
 #else
             JMP_long(_epilogue);
-			lr->jmp = _nIns;
+            lr->jmpToTarget = _nIns;
 #endif
 		}
 		// first restore ESP from EBP, undoing SUBi(SP,amt) from genPrologue
         MR(SP,FP);
-
-        #ifdef NJ_VERBOSE
-        if (_frago->core()->config.show_stats) {
-			// load EDX (arg1) with Fragment *fromFrag, target fragment
-			// will make use of this when calling fragenter().
-		#if defined NANOJIT_IA32
-            int fromfrag = int((Fragment*)_thisfrag);
-            LDi(argRegs[1], fromfrag);
-		#elif defined NANOJIT_AMD64
-			LDQi(argRegs[1], intptr_t(_thisfrag));
-		#endif
-        }
-        #endif
 
 		// return value is GuardRecord*
 	#if defined NANOJIT_IA32
         LDi(EAX, int(lr));
 	#elif defined NANOJIT_AMD64
 		LDQi(RAX, intptr_t(lr));
 	#endif
 	}
 
     NIns *Assembler::genEpilogue()
     {
         RET();
 
-		if (!_thisfrag->lirbuf->explicitSavedParams) 
+		if (!_thisfrag->lirbuf->explicitSavedRegs) 
 			for (int i = NumSavedRegs - 1; i >= 0; --i)
 				POPr(savedRegs[i]);
 
         POPr(FP); // Restore caller's FP.
         MR(SP,FP); // pop the stack frame
         return  _nIns;
     }
 	
@@ -411,34 +398,40 @@ namespace nanojit
 		a.free = SavedRegs | ScratchRegs;
 #if defined NANOJIT_IA32
         if (!avmplus::AvmCore::use_sse2())
             a.free &= ~XmmRegs;
 #endif
 		debug_only( a.managed = a.free; )
 	}
 
-	void Assembler::nPatchBranch(NIns* branch, NIns* location)
+	NIns* Assembler::nPatchBranch(NIns* branch, NIns* targ)
 	{
 #if defined NANOJIT_IA32
-		intptr_t offset = intptr_t(location) - intptr_t(branch);
-		if (branch[0] == JMPc)
-			*(uint32_t*)&branch[1] = offset - 5;
-		else
-			*(uint32_t*)&branch[2] = offset - 6;
+        NIns* was = 0;
+		intptr_t offset = intptr_t(targ) - intptr_t(branch);
+		if (branch[0] == JMP32) {
+            was = branch + *(int32_t*)&branch[1] + 5;
+		    *(int32_t*)&branch[1] = offset - 5;
+		} else if (branch[0] == JCC32) {
+            was = branch + *(int32_t*)&branch[2] + 6;
+		    *(int32_t*)&branch[2] = offset - 6;
+		} else
+		    NanoAssertMsg(0, "Unknown branch type in nPatchBranch");
 #else
         if (branch[0] == 0xFF && branch[1] == 0x25) {
             NIns *mem;
-
             mem = &branch[6] + *(int32_t *)&branch[2];
-            *(intptr_t *)mem = intptr_t(location);
+            was = *(intptr_t*)mem;
+            *(intptr_t *)mem = intptr_t(targ);
         } else {
             NanoAssertMsg(0, "Unknown branch type in nPatchBranch");
         }
 #endif
+        return was;
 	}
 
 	RegisterMask Assembler::hint(LIns* i, RegisterMask allow)
 	{
 		uint32_t op = i->opcode();
 		int prefer = allow;
         if (op == LIR_call || op == LIR_calli) {
 			prefer &= rmask(retRegs[0]);
@@ -827,77 +820,77 @@ namespace nanojit
             ST(rd, dd+4, t);
             LD(t, ds+4, rs);
             ST(rd, dd, t);
             LD(t, ds, rs);
         }
 #endif
     }
 
-	NIns* Assembler::asm_branch(bool branchOnFalse, LInsp cond, NIns* targ)
+	NIns* Assembler::asm_branch(bool branchOnFalse, LInsp cond, NIns* targ, bool isfar)
 	{
 		NIns* at = 0;
 		LOpcode condop = cond->opcode();
 		NanoAssert(cond->isCond());
 #ifndef NJ_SOFTFLOAT
 		if (condop >= LIR_feq && condop <= LIR_fge)
 		{
 			return asm_jmpcc(branchOnFalse, cond, targ);
 		}
 #endif
 		// produce the branch
 		if (branchOnFalse)
 		{
 			if (condop == LIR_eq)
-				JNE(targ);
+				JNE(targ, isfar);
 			else if (condop == LIR_ov)
-				JNO(targ);
+				JNO(targ, isfar);
 			else if (condop == LIR_cs)
-				JNC(targ);
+				JNC(targ, isfar);
 			else if (condop == LIR_lt)
-				JNL(targ);
+				JNL(targ, isfar);
 			else if (condop == LIR_le)
-				JNLE(targ);
+				JNLE(targ, isfar);
 			else if (condop == LIR_gt)
-				JNG(targ);
+				JNG(targ, isfar);
 			else if (condop == LIR_ge)
-				JNGE(targ);
+				JNGE(targ, isfar);
 			else if (condop == LIR_ult)
-				JNB(targ);
+				JNB(targ, isfar);
 			else if (condop == LIR_ule)
-				JNBE(targ);
+				JNBE(targ, isfar);
 			else if (condop == LIR_ugt)
-				JNA(targ);
+				JNA(targ, isfar);
 			else //if (condop == LIR_uge)
-				JNAE(targ);
+				JNAE(targ, isfar);
 		}
 		else // op == LIR_xt
 		{
 			if (condop == LIR_eq)
-				JE(targ);
+				JE(targ, isfar);
 			else if (condop == LIR_ov)
-				JO(targ);
+				JO(targ, isfar);
 			else if (condop == LIR_cs)
-				JC(targ);
+				JC(targ, isfar);
 			else if (condop == LIR_lt)
-				JL(targ);
+				JL(targ, isfar);
 			else if (condop == LIR_le)
-				JLE(targ);
+				JLE(targ, isfar);
 			else if (condop == LIR_gt)
-				JG(targ);
+				JG(targ, isfar);
 			else if (condop == LIR_ge)
-				JGE(targ);
+				JGE(targ, isfar);
 			else if (condop == LIR_ult)
-				JB(targ);
+				JB(targ, isfar);
 			else if (condop == LIR_ule)
-				JBE(targ);
+				JBE(targ, isfar);
 			else if (condop == LIR_ugt)
-				JA(targ);
+				JA(targ, isfar);
 			else //if (condop == LIR_uge)
-				JAE(targ);
+				JAE(targ, isfar);
 		}
 		at = _nIns;
 		asm_cmp(cond);
 		return at;
 	}
 
 	void Assembler::asm_cmp(LIns *cond)
 	{
@@ -950,41 +943,33 @@ namespace nanojit
 			} else {
 				CMP(ra, rb);
 			}
 		}
 	}
 
 	void Assembler::asm_loop(LInsp ins, NInsList& loopJumps)
 	{
+		GuardRecord* guard = ins->record();
+		SideExit* exit = guard->exit;
+
+		// Emit an exit stub that the loop may be patched to jump to (for example if we
+		// want to terminate the loop because a timeout fires).
+		asm_exit(ins);
+
+		// Emit the patchable jump itself.
 		JMP_long(0);
 
         loopJumps.add(_nIns);
+		guard->jmpToStub = _nIns;
 
 		// If the target we are looping to is in a different fragment, we have to restore
-		// SP since we will target fragEntry and not SOT.
-		Fragment* target = ins->record()->exit->target;
-		if (target != _thisfrag)
+		// SP since we will target fragEntry and not loopEntry.
+		if (exit->target != _thisfrag)
 	        MR(SP,FP);
-		
-		#ifdef NJ_VERBOSE
-		// branching from this frag to ourself.
-		if (_frago->core()->config.show_stats)
-		#if defined NANOJIT_AMD64
-			LDQi(argRegs[1], intptr_t((Fragment*)_thisfrag));
-		#else
-			LDi(argRegs[1], int((Fragment*)_thisfrag));
-		#endif
-		#endif
-
-		assignSavedParams();
-
-		// restore first parameter, the only one we use
-		LInsp state = _thisfrag->lirbuf->state;
-		findSpecificRegFor(state, argRegs[state->imm8()]); 
 	}	
 
 	void Assembler::asm_fcond(LInsp ins)
 	{
 		// only want certain regs 
 		Register r = prepResultReg(ins, AllowableFlagRegs);
 		asm_setcc(r, ins);
 #ifdef NJ_ARM_VFP
@@ -1166,20 +1151,86 @@ namespace nanojit
 				
 	void Assembler::asm_ld(LInsp ins)
 	{
 		LOpcode op = ins->opcode();			
 		LIns* base = ins->oprnd1();
 		LIns* disp = ins->oprnd2();
 		Register rr = prepResultReg(ins, GpRegs);
 		int d = disp->constval();
+
+#ifdef NANOJIT_IA32
+		/* Can't use this on AMD64, no 64-bit immediate addresses. */
+		if (base->isconst()) {
+			intptr_t addr = base->constval();
+			addr += d;
+			if (op == LIR_ldcb)
+				LD8Zdm(rr, addr);
+			else if (op == LIR_ldcs)
+				LD16Zdm(rr, addr);
+			else
+				LDdm(rr, addr);
+			return;
+		}
+
+		/* :TODO: Use this on AMD64 as well. */
+		/* Search for add(X,Y) */
+		if (base->opcode() == LIR_piadd) {
+			int scale = 0;
+			LIns *lhs = base->oprnd1();
+			LIns *rhs = base->oprnd2();
+
+			/* See if we can bypass any SHLs, by searching for 
+			 * add(X, shl(Y,Z)) -> mov r, [X+Y*Z]
+			 */
+			if (rhs->opcode() == LIR_pilsh && rhs->oprnd2()->isconst()) {
+				scale = rhs->oprnd2()->constval();
+				if (scale >= 1 && scale <= 3)
+					rhs = rhs->oprnd1();
+				else
+					scale = 0;
+			}
+
+			Register rleft;
+			Reservation *rL = getresv(lhs);
+
+			/* Does LHS have a register yet? If not, re-use the result reg.
+			 * :TODO: If LHS is const, we could eliminate a register use.  
+			 */
+			if (rL == NULL || rL->reg == UnknownReg)
+				rleft = findSpecificRegFor(lhs, rr);
+			else
+				rleft = rL->reg;
+
+			Register rright = UnknownReg;
+			Reservation *rR = getresv(rhs);
+
+			/* Does RHS have a register yet? If not, try to re-use the result reg. */
+			if (rr != rleft && (rR == NULL || rR->reg == UnknownReg))
+				rright = findSpecificRegFor(rhs, rr);
+			if (rright == UnknownReg)
+				rright = findRegFor(rhs, GpRegs & ~(rmask(rleft)));
+
+			if (op == LIR_ldcb)
+				LD8Zsib(rr, d, rleft, rright, scale);
+			else if (op == LIR_ldcs)
+				LD16Zsib(rr, d, rleft, rright, scale);
+			else
+				LDsib(rr, d, rleft, rright, scale);
+
+			return;
+		}
+#endif
+
 		Register ra = getBaseReg(base, d, GpRegs);
 		if (op == LIR_ldcb)
 			LD8Z(rr, d, ra);
-		else
+		else if (op == LIR_ldcs)
+		    LD16Z(rr, d, ra);
+		else 
 			LD(rr, d, ra); 
 	}
 
 	void Assembler::asm_cmov(LInsp ins)
 	{
 		LOpcode op = ins->opcode();			
 		LIns* condval = ins->oprnd1();
 		NanoAssert(condval->isCmp());
@@ -1808,32 +1859,32 @@ namespace nanojit
                 c = LIR_fgt;
             }
             else if (c == LIR_fle) {
                 LIns *t = lhs; lhs = rhs; rhs = t;
                 c = LIR_fge;
             }
 
             if (c == LIR_fgt) {
-                if (branchOnFalse) { JNA(targ); } else { JA(targ); }
+                if (branchOnFalse) { JNA(targ, false); } else { JA(targ, false); }
             }
             else { // if (c == LIR_fge)
-                if (branchOnFalse) { JNAE(targ); } else { JAE(targ); }
+                if (branchOnFalse) { JNAE(targ, false); } else { JAE(targ, false); }
             }
             NIns *at = _nIns;
             Reservation *rA, *rB;
             findRegFor2(XmmRegs, lhs, rA, rhs, rB);
             SSE_UCOMISD(rA->reg, rB->reg);
             return at;
         }
 
     	if (branchOnFalse)
-			JP(targ);
+			JP(targ, false);
 		else
-			JNP(targ);
+			JNP(targ, false);
 		NIns *at = _nIns;
 		asm_fcmp(cond);
         return at;
     }
 
     void Assembler::asm_setcc(Register r, LIns *cond)
     {
         LOpcode c = cond->opcode();
@@ -1952,34 +2003,16 @@ namespace nanojit
 			    else
 				    FCOMP();
 			    FLDr(FST0); // DUP
 		    }
         }
 #endif
 	}
 	
-	NIns* Assembler::asm_adjustBranch(NIns* at, NIns* target)
-	{
-        NIns* was;
-#if defined NANOJIT_AMD64
-		was = (NIns*)( *(intptr_t*)(at) );
-        *(intptr_t *)(at) = intptr_t(target);
-#else
-		NIns* save = _nIns;
-		was = (NIns*)( (intptr_t)*(int32_t*)(at+1)+(intptr_t)(at+5) );
-		_nIns = at +5; // +5 is size of JMP
-		intptr_t tt = (intptr_t)target - (intptr_t)_nIns;
-		IMM32(tt);
-		*(--_nIns) = JMPc;
-        _nIns = save;
-#endif
-		return was;
-	}
-	
 	void Assembler::nativePageReset()
 	{
 #if defined NANOJIT_AMD64
         /* We store some stuff at the bottom of the page. 
          * We reserve 8-bytes for long jumps just in case we need them.
          */
 		_pageData = 0;
 		_dblNegPtr = NULL;
diff -r a4343d61f6ee js/src/nanojit/Nativei386.h
--- a/js/src/nanojit/Nativei386.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/nanojit/Nativei386.h	Sat Nov 15 19:43:13 2008 -0500
@@ -173,39 +173,84 @@ namespace nanojit
  		} else if (isS8(d)) { \
  			*(--_nIns) = (uint8_t) (d); \
  			*(--_nIns) = (uint8_t) ( 1<<6 | (r)<<3 | (b) ); \
  		} else { \
  			IMM32(d); \
  			*(--_nIns) = (uint8_t) ( 2<<6 | (r)<<3 | (b) ); \
  		} 
 
+#define MODRMSIB(reg,base,index,scale,disp)					\
+		if (disp != 0 || base == EBP) {						\
+			if (isS8(disp)) {								\
+				*(--_nIns) = int8_t(disp);					\
+			} else {										\
+				IMM32(disp);								\
+			}												\
+		}													\
+		*(--_nIns) = uint8_t((scale)<<6|(index)<<3|(base));	\
+		if (disp == 0 && base != EBP) {						\
+			*(--_nIns) = uint8_t(((reg)<<3)|4);				\
+		} else {											\
+			if (isS8(disp))									\
+				*(--_nIns) = uint8_t((1<<6)|(reg<<3)|4);	\
+			else											\
+				*(--_nIns) = uint8_t((2<<6)|(reg<<3)|4);	\
+		}
+
+#define MODRMdm(r,addr)					\
+		NanoAssert(unsigned(r)<8);		\
+		IMM32(addr);					\
+		*(--_nIns) = (uint8_t)( (r)<<3 | 5 );
+
 #define MODRM(d,s) \
 		NanoAssert(((unsigned)(d))<8 && ((unsigned)(s))<8); \
 		*(--_nIns) = (uint8_t) ( 3<<6|(d)<<3|(s) )
 
 #define ALU0(o)				\
 		underrunProtect(1);\
 		*(--_nIns) = (uint8_t) (o)
 
 #define ALUm(c,r,d,b)		\
 		underrunProtect(8); \
 		MODRMm(r,d,b);		\
 		*(--_nIns) = uint8_t(c)
 
+#define ALUdm(c,r,addr)		\
+		underrunProtect(6);	\
+		MODRMdm(r,addr);	\
+		*(--_nIns) = uint8_t(c)
+
+#define ALUsib(c,r,base,index,scale,disp)	\
+		underrunProtect(7);					\
+		MODRMSIB(r,base,index,scale,disp);	\
+		*(--_nIns) = uint8_t(c)
+
 #define ALUm16(c,r,d,b)		\
 		underrunProtect(9); \
 		MODRMm(r,d,b);		\
 		*(--_nIns) = uint8_t(c);\
 		*(--_nIns) = 0x66
 
+#define ALU2dm(c,r,addr)	\
+		underrunProtect(7);	\
+		MODRMdm(r,addr);	\
+        *(--_nIns) = (uint8_t) (c);\
+        *(--_nIns) = (uint8_t) ((c)>>8)
+
 #define ALU2m(c,r,d,b)      \
         underrunProtect(9); \
         MODRMm(r,d,b);      \
         *(--_nIns) = (uint8_t) (c);\
+        *(--_nIns) = (uint8_t) ((c)>>8)
+
+#define ALU2sib(c,r,base,index,scale,disp)	\
+		underrunProtect(8);					\
+		MODRMSIB(r,base,index,scale,disp);	\
+        *(--_nIns) = (uint8_t) (c);			\
         *(--_nIns) = (uint8_t) ((c)>>8)
 
 #define ALU(c,d,s)  \
 		underrunProtect(2);\
 		MODRM(d,s); \
 		*(--_nIns) = (uint8_t) (c)
 
 #define ALUi(c,r,i) \
@@ -315,23 +360,59 @@ namespace nanojit
 // these aren't currently used but left in for reference
 //#define LDEQ(r,d,b) do { ALU2m(0x0f44,r,d,b); asm_output3("cmove %s,%d(%s)", gpn(r),d,gpn(b)); } while(0)
 //#define LDNEQ(r,d,b) do { ALU2m(0x0f45,r,d,b); asm_output3("cmovne %s,%d(%s)", gpn(r),d,gpn(b)); } while(0)
 
 #define LD(reg,disp,base)	do { 	\
 	ALUm(0x8b,reg,disp,base);	\
 	asm_output3("mov %s,%d(%s)",gpn(reg),disp,gpn(base)); } while(0)
 
+#define LDdm(reg,addr) do {		\
+	ALUdm(0x8b,reg,addr);		\
+	asm_output2("mov %s,0(%lx)",gpn(reg),addr); \
+	} while (0)
+
+
+#define SIBIDX(n)	"1248"[n]
+
+#define LDsib(reg,disp,base,index,scale) do {	\
+	ALUsib(0x8b,reg,base,index,scale,disp);		\
+	asm_output5("mov %s,%d(%s+%s*%c)",gpn(reg),disp,gpn(base),gpn(index),SIBIDX(scale)); \
+	} while (0)
+
 // load 16-bit, sign extend
 #define LD16S(r,d,b) do { ALU2m(0x0fbf,r,d,b); asm_output3("movsx %s,%d(%s)", gpn(r),d,gpn(b)); } while(0)
+	
+// load 16-bit, zero extend
+#define LD16Z(r,d,b) do { ALU2m(0x0fb7,r,d,b); asm_output3("movsz %s,%d(%s)", gpn(r),d,gpn(b)); } while(0)
+
+#define LD16Zdm(r,addr) do { ALU2dm(0x0fb7,r,addr); asm_output2("movsz %s,0(%lx)", gpn(r),addr); } while (0)
+
+#define LD16Zsib(r,disp,base,index,scale) do {	\
+	ALU2sib(0x0fb7,r,base,index,scale,disp);	\
+	asm_output5("movsz %s,%d(%s+%s*%c)",gpn(r),disp,gpn(base),gpn(index),SIBIDX(scale)); \
+	} while (0)
 
 // load 8-bit, zero extend
 // note, only 5-bit offsets (!) are supported for this, but that's all we need at the moment
 // (movzx actually allows larger offsets mode but 5-bit gives us advantage in Thumb mode)
 #define LD8Z(r,d,b)	do { NanoAssert((d)>=0&&(d)<=31); ALU2m(0x0fb6,r,d,b); asm_output3("movzx %s,%d(%s)", gpn(r),d,gpn(b)); } while(0)
+
+#define LD8Zdm(r,addr) do { \
+	NanoAssert((d)>=0&&(d)<=31); \
+	ALU2dm(0x0fb6,r,addr); \
+	asm_output2("movzx %s,0(%lx)", gpn(r),addr); \
+	} while(0)
+
+#define LD8Zsib(r,disp,base,index,scale) do {	\
+	NanoAssert((d)>=0&&(d)<=31);				\
+	ALU2sib(0x0fb6,r,base,index,scale,disp);	\
+	asm_output5("movzx %s,%d(%s+%s*%c)",gpn(r),disp,gpn(base),gpn(index),SIBIDX(scale)); \
+	} while(0)
+	
 
 #define LDi(r,i) do { \
 	underrunProtect(5);			\
 	IMM32(i);					\
 	NanoAssert(((unsigned)r)<8); \
 	*(--_nIns) = (uint8_t) (0xb8 | (r) );		\
 	asm_output2("mov %s,%d",gpn(r),i); } while(0)
 
@@ -375,30 +456,34 @@ namespace nanojit
 	asm_output2("push %d(%s)",d,gpn(b)); } while(0)
 
 #define POPr(r) do { \
 	underrunProtect(1);			\
 	NanoAssert(((unsigned)r)<8); \
 	*(--_nIns) = (uint8_t) ( 0x58 | (r) ); \
 	asm_output1("pop %s",gpn(r)); } while(0)
 
-#define JCC(o,t,n) do { \
+#define JCC32 0x0f
+#define JMP8  0xeb
+#define JMP32 0xe9  
+    
+#define JCC(o,t,isfar,n) do { \
 	underrunProtect(6);	\
 	intptr_t tt = (intptr_t)t - (intptr_t)_nIns;	\
-	if (isS8(tt)) { \
+	if (isS8(tt) && !isfar) { \
 		verbose_only( NIns* next = _nIns; (void)next; ) \
 		_nIns -= 2; \
 		_nIns[0] = (uint8_t) ( 0x70 | (o) ); \
 		_nIns[1] = (uint8_t) (tt); \
 		asm_output2("%s %p",(n),(next+tt)); \
 	} else { \
 		verbose_only( NIns* next = _nIns; ) \
 		IMM32(tt); \
 		_nIns -= 2; \
-		_nIns[0] = 0x0f; \
+		_nIns[0] = JCC32; \
 		_nIns[1] = (uint8_t) ( 0x80 | (o) ); \
 		asm_output2("%s %p",(n),(next+tt)); \
 	} } while(0)
 
 #define JMP_long(t) do { \
 	underrunProtect(5);	\
 	intptr_t tt = (intptr_t)t - (intptr_t)_nIns;	\
 	JMP_long_nochk_offset(tt);	\
@@ -406,61 +491,59 @@ namespace nanojit
 	} while(0)
 
 #define JMP(t)		do { 	\
    	underrunProtect(5);	\
 	intptr_t tt = (intptr_t)t - (intptr_t)_nIns;	\
 	if (isS8(tt)) { \
 		verbose_only( NIns* next = _nIns; (void)next; ) \
 		_nIns -= 2; \
-		_nIns[0] = 0xeb; \
+		_nIns[0] = JMP8; \
 		_nIns[1] = (uint8_t) ( (tt)&0xff ); \
 		asm_output1("jmp %p",(next+tt)); \
 	} else { \
 		JMP_long_nochk_offset(tt);	\
 	} } while(0)
 
-#define JMPc 0xe9
-		
 // this should only be used when you can guarantee there is enough room on the page
 #define JMP_long_nochk_offset(o) do {\
 		verbose_only( NIns* next = _nIns; (void)next; ) \
  		IMM32((o)); \
- 		*(--_nIns) = JMPc; \
+ 		*(--_nIns) = JMP32; \
 		asm_output1("jmp %p",(next+(o))); } while(0)
 
-#define JE(t)	JCC(0x04, t, "je")
-#define JNE(t)	JCC(0x05, t, "jne")
-#define JP(t)	JCC(0x0A, t, "jp")
-#define JNP(t)	JCC(0x0B, t, "jnp")
+#define JE(t, isfar)	   JCC(0x04, t, isfar, "je")
+#define JNE(t, isfar)	   JCC(0x05, t, isfar, "jne")
+#define JP(t, isfar)	   JCC(0x0A, t, isfar, "jp")
+#define JNP(t, isfar)	   JCC(0x0B, t, isfar, "jnp")
 
-#define JB(t)	JCC(0x02, t, "jb")
-#define JNB(t)	JCC(0x03, t, "jnb")
-#define JBE(t)	JCC(0x06, t, "jbe")
-#define JNBE(t) JCC(0x07, t, "jnbe")
+#define JB(t, isfar)	   JCC(0x02, t, isfar, "jb")
+#define JNB(t, isfar)	   JCC(0x03, t, isfar, "jnb")
+#define JBE(t, isfar)	   JCC(0x06, t, isfar, "jbe")
+#define JNBE(t, isfar)   JCC(0x07, t, isfar, "jnbe")
 
-#define JA(t)	JCC(0x07, t, "ja")
-#define JNA(t)	JCC(0x06, t, "jna")
-#define JAE(t)	JCC(0x03, t, "jae")
-#define JNAE(t) JCC(0x02, t, "jnae")
+#define JA(t, isfar)	   JCC(0x07, t, isfar, "ja")
+#define JNA(t, isfar)	   JCC(0x06, t, isfar, "jna")
+#define JAE(t, isfar)	   JCC(0x03, t, isfar, "jae")
+#define JNAE(t, isfar)   JCC(0x02, t, isfar, "jnae")
 
-#define JL(t)	JCC(0x0C, t, "jl")
-#define JNL(t)	JCC(0x0D, t, "jnl")
-#define JLE(t)	JCC(0x0E, t, "jle")
-#define JNLE(t)	JCC(0x0F, t, "jnle")
+#define JL(t, isfar)	   JCC(0x0C, t, isfar, "jl")
+#define JNL(t, isfar)	   JCC(0x0D, t, isfar, "jnl")
+#define JLE(t, isfar)	   JCC(0x0E, t, isfar, "jle")
+#define JNLE(t, isfar)   JCC(0x0F, t, isfar, "jnle")
 
-#define JG(t)	JCC(0x0F, t, "jg")
-#define JNG(t)	JCC(0x0E, t, "jng")
-#define JGE(t)	JCC(0x0D, t, "jge")
-#define JNGE(t)	JCC(0x0C, t, "jnge")
+#define JG(t, isfar)	   JCC(0x0F, t, isfar, "jg")
+#define JNG(t, isfar)	   JCC(0x0E, t, isfar, "jng")
+#define JGE(t, isfar)	   JCC(0x0D, t, isfar, "jge")
+#define JNGE(t, isfar)   JCC(0x0C, t, isfar, "jnge")
 
-#define JC(t)   JCC(0x02, t, "jc")
-#define JNC(t)  JCC(0x03, t, "jnc")
-#define JO(t)   JCC(0x00, t, "jo")
-#define JNO(t)  JCC(0x01, t, "jno")
+#define JC(t, isfar)     JCC(0x02, t, isfar, "jc")
+#define JNC(t, isfar)    JCC(0x03, t, isfar, "jnc")
+#define JO(t, isfar)     JCC(0x00, t, isfar, "jo")
+#define JNO(t, isfar)    JCC(0x01, t, isfar, "jno")
 
 // sse instructions 
 #define SSE(c,d,s)  \
 		underrunProtect(9);	\
 		MODRM((d),(s));	\
 		_nIns -= 3; \
  		_nIns[0] = (uint8_t)(((c)>>16)&0xff); \
 		_nIns[1] = (uint8_t)(((c)>>8)&0xff); \
diff -r a4343d61f6ee js/src/nanojit/avmplus.h
--- a/js/src/nanojit/avmplus.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/nanojit/avmplus.h	Sat Nov 15 19:43:13 2008 -0500
@@ -157,196 +157,134 @@ static __inline__ unsigned long long rdt
 
   return(result);
 }
 
 #endif /* architecture */
 
 struct JSContext;
 
-namespace nanojit
-{
-	class Fragment;
-
-	enum ExitType {
-	    BRANCH_EXIT, 
-	    LOOP_EXIT, 
-	    NESTED_EXIT,
-	    MISMATCH_EXIT,
-	    OOM_EXIT,
-	    OVERFLOW_EXIT
-	};
-	
-    class LIns;
-
-    struct SideExit;
+namespace avmplus {
     
-    typedef struct GuardRecord 
+    class GC;
+    
+    class GCObject 
     {
-        void *jmp;
-        GuardRecord* next;
-        SideExit* exit;
+    public:
+        inline void*
+        operator new(size_t size, GC* gc)
+        {
+            return calloc(1, size);
+        }
+    
+        static void operator delete (void *gcObject)
+        {
+            free(gcObject); 
+        }
     };
     
-    typedef struct SideExit
+    #define MMGC_SUBCLASS_DECL : public avmplus::GCObject
+    
+    class GCFinalizedObject : public GCObject
     {
-        GuardRecord* guards;
-        Fragment *from;
-        Fragment *target;
-        intptr_t ip_adj;
-        intptr_t sp_adj;
-        intptr_t rp_adj;
-        int32_t calldepth;
-        uint32 numGlobalSlots;
-        uint32 numStackSlots;
-        uint32 numStackSlotsBelowCurrentFrame;
-        ExitType exitType;
+    public:
+        static void operator delete (void *gcObject)
+        {
+            free(gcObject); 
+        }
+    };
+    
+    class GCHeap
+    {
+    public:
+        int32_t kNativePageSize;
+    
+        GCHeap()
+        {
+    #if defined _SC_PAGE_SIZE
+            kNativePageSize = sysconf(_SC_PAGE_SIZE);
+    #else
+            kNativePageSize = 4096; // @todo: what is this?
+    #endif
+        }
         
-        void addGuard(GuardRecord* lr) 
+        inline void*
+        Alloc(uint32_t pages) 
         {
-            lr->next = guards;
-            guards = lr;
+    #ifdef XP_WIN
+            return VirtualAlloc(NULL, 
+                                pages * kNativePageSize,
+                                MEM_COMMIT | MEM_RESERVE, 
+                                PAGE_EXECUTE_READWRITE);
+    #elif defined AVMPLUS_UNIX
+            /**
+             * Don't use normal heap with mprotect+PROT_EXEC for executable code.
+             * SELinux and friends don't allow this.
+             */
+            return mmap(NULL, 
+                        pages * kNativePageSize,
+                        PROT_READ | PROT_WRITE | PROT_EXEC,
+                        MAP_PRIVATE | MAP_ANON,
+                        -1,
+                        0);
+    #else
+            return valloc(pages * kNativePageSize); 
+    #endif
         }
-	};
+        
+        inline void
+        Free(void* p, uint32_t pages)
+        {
+    #ifdef XP_WIN
+            VirtualFree(p, 0, MEM_RELEASE);
+    #elif defined AVMPLUS_UNIX
+            #if defined SOLARIS
+            munmap((char*)p, pages * kNativePageSize); 
+            #else
+            munmap(p, pages * kNativePageSize); 
+            #endif
+    #else
+            free(p);
+    #endif
+        }
+        
+    };
     
-    static inline uint8* getTypeMap(SideExit* exit) { return (uint8*)(exit + 1); }
-}
-
-class GC;
-
-class GCObject 
-{
-public:
-    inline void*
-    operator new(size_t size, GC* gc)
+    class GC 
     {
-        return calloc(1, size);
-    }
-
-    static void operator delete (void *gcObject)
-    {
-        free(gcObject); 
-    }
-};
-
-#define MMGC_SUBCLASS_DECL : public GCObject
-
-class GCFinalizedObject : public GCObject
-{
-public:
-    static void operator delete (void *gcObject)
-    {
-        free(gcObject); 
-    }
-};
-
-class GCHeap
-{
-public:
-    int32_t kNativePageSize;
-
-    GCHeap()
-    {
-#if defined _SC_PAGE_SIZE
-        kNativePageSize = sysconf(_SC_PAGE_SIZE);
-#else
-        kNativePageSize = 4096; // @todo: what is this?
-#endif
-    }
+        static GCHeap heap;
+        
+    public:
+        static inline void*
+        Alloc(uint32_t bytes)
+        {
+            return calloc(1, bytes);
+        }
     
-    inline void*
-    Alloc(uint32_t pages) 
-    {
-#ifdef XP_WIN
-        return VirtualAlloc(NULL, 
-                            pages * kNativePageSize,
-                            MEM_COMMIT | MEM_RESERVE, 
-                            PAGE_EXECUTE_READWRITE);
-#elif defined AVMPLUS_UNIX
-        /**
-         * Don't use normal heap with mprotect+PROT_EXEC for executable code.
-         * SELinux and friends don't allow this.
-         */
-        return mmap(NULL, 
-                    pages * kNativePageSize,
-                    PROT_READ | PROT_WRITE | PROT_EXEC,
-                    MAP_PRIVATE | MAP_ANON,
-                    -1,
-                    0);
-#else
-        return valloc(pages * kNativePageSize); 
-#endif
-    }
-    
-    inline void
-    Free(void* p, uint32_t pages)
-    {
-#ifdef XP_WIN
-        VirtualFree(p, 0, MEM_RELEASE);
-#elif defined AVMPLUS_UNIX
-        #if defined SOLARIS
-        munmap((char*)p, pages * kNativePageSize); 
-        #else
-        munmap(p, pages * kNativePageSize); 
-        #endif
-#else
-        free(p);
-#endif
-    }
-    
-};
-
-class GC 
-{
-    static GCHeap heap;
-    
-public:
-    static inline void*
-    Alloc(uint32_t bytes)
-    {
-        return calloc(1, bytes);
-    }
-
-    static inline void
-    Free(void* p)
-    {
-        free(p);
-    }
-    
-    static inline GCHeap*
-    GetGCHeap()
-    {
-        return &heap;
-    }
-};
+        static inline void
+        Free(void* p)
+        {
+            free(p);
+        }
+        
+        static inline GCHeap*
+        GetGCHeap()
+        {
+            return &heap;
+        }
+    };
 
 #define DWB(x) x
 #define DRCWB(x) x
 #define WB(gc, container, addr, value) do { *(addr) = (value); } while(0)
 #define WBRC(gc, container, addr, value) do { *(addr) = (value); } while(0)
 
 #define MMGC_MEM_TYPE(x)
 
-typedef int FunctionID;
-
-namespace avmplus
-{
-    struct InterpState
-    {
-        void* sp; /* native stack pointer, stack[0] is spbase[0] */
-        void* rp; /* call stack pointer */
-        void* gp; /* global frame pointer */
-        JSContext *cx; /* current VM context handle */
-        void* eos; /* first unusable word after the native stack */
-        void* eor; /* first unusable word after the call stack */
-        nanojit::SideExit* lastTreeExitGuard; /* guard we exited on during a tree call */
-        nanojit::SideExit* lastTreeCallGuard; /* guard we want to grow from if the tree
-                                                 call exit guard mismatched */
-        void* rpAtLastTreeCall; /* value of rp at innermost tree call guard */
-    };
+    typedef int FunctionID;
 
     class String
     {
     };
 
     typedef class String AvmString;
     
     class StringNullTerminatedUTF8
diff -r a4343d61f6ee js/src/nanojit/nanojit.h
--- a/js/src/nanojit/nanojit.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/nanojit/nanojit.h	Sat Nov 15 19:43:13 2008 -0500
@@ -95,16 +95,30 @@ namespace nanojit
 		#define NanoAssertMsg(a,m)        do { __NanoAssertMsgf(a, __FILE__, __LINE__, "\"%s\": ", m); } while (0)
 		#define NanoAssert(a)             do { __NanoAssertMsgf(a, __FILE__, __LINE__, "%s", ""); } while (0)
 	#else
 		#define NanoAssertMsgf(a,f,...)   do { } while (0) /* no semi */
 		#define NanoAssertMsg(a,m)        do { } while (0) /* no semi */
 		#define NanoAssert(a)             do { } while (0) /* no semi */
 	#endif
 
+	/*
+	 * Sun Studio C++ compiler has a bug
+	 * "sizeof expression not accepted as size of array parameter"
+	 * The bug number is 6688515. It is not public yet.
+	 * Turn off this assert for Sun Studio until this bug is fixed.
+	 */
+	#ifdef __SUNPRO_CC
+		#define NanoStaticAssert(condition)
+	#else
+		#define NanoStaticAssert(condition) \
+			extern void nano_static_assert(int arg[(condition) ? 1 : -1])
+	#endif
+
+
 	/**
 	 * -------------------------------------------
 	 * END AVM bridging definitions
 	 * -------------------------------------------
 	 */
 }
 
 #ifdef AVMPLUS_VERBOSE
diff -r a4343d61f6ee js/src/ref-config/AIX4.1.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/AIX4.1.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,65 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for AIX
+#
+
+CC = xlC_r
+CCC = xlC_r
+
+RANLIB = ranlib
+
+#.c.o:
+#	$(CC) -c -MD $*.d $(CFLAGS) $<
+ARCH := aix
+CPU_ARCH = rs6000
+GFX_ARCH = x
+INLINES = js_compare_and_swap:js_fast_lock1:js_fast_unlock1:js_lock_get_slot:js_lock_set_slot:js_lock_scope1
+
+OS_CFLAGS = -qarch=com -qinline+$(INLINES) -DXP_UNIX -DAIX -DAIXV3 -DSYSV -DHAVE_LOCALTIME_R
+OS_LIBS = -lbsd -lsvld -lm
+#-lpthreads -lc_r
+
+MKSHLIB = $(LD) -bM:SRE -bh:4 -bnoentry -berok
+XLDFLAGS += -lc
+
+ifdef JS_THREADSAFE
+XLDFLAGS += -lsvld
+endif
diff -r a4343d61f6ee js/src/ref-config/AIX4.2.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/AIX4.2.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,64 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for AIX
+#
+
+CC = xlC_r
+CCC = xlC_r
+CFLAGS += -qarch=com -qnoansialias -qinline+$(INLINES) -DXP_UNIX -DAIX -DAIXV3 -DSYSV -DHAVE_LOCALTIME_R
+
+RANLIB = ranlib
+
+#.c.o:
+#	$(CC) -c -MD $*.d $(CFLAGS) $<
+ARCH := aix
+CPU_ARCH = rs6000
+GFX_ARCH = x
+INLINES = js_compare_and_swap:js_fast_lock1:js_fast_unlock1:js_lock_get_slot:js_lock_set_slot:js_lock_scope1
+
+#-lpthreads -lc_r
+
+MKSHLIB = /usr/lpp/xlC/bin/makeC++SharedLib_r -p 0 -G -berok
+
+ifdef JS_THREADSAFE
+XLDFLAGS += -ldl
+endif
+
diff -r a4343d61f6ee js/src/ref-config/AIX4.3.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/AIX4.3.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,65 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for AIX
+#
+
+CC = xlC_r
+CCC = xlC_r
+CFLAGS += -qarch=com -qnoansialias -qinline+$(INLINES) -DXP_UNIX -DAIX -DAIXV3 -DSYSV -DAIX4_3 -DHAVE_LOCALTIME_R
+
+RANLIB = ranlib
+
+#.c.o:
+#	$(CC) -c -MD $*.d $(CFLAGS) $<
+ARCH := aix
+CPU_ARCH = rs6000
+GFX_ARCH = x
+INLINES = js_compare_and_swap:js_fast_lock1:js_fast_unlock1:js_lock_get_slot:js_lock_set_slot:js_lock_scope1
+
+#-lpthreads -lc_r
+
+MKSHLIB_BIN = /usr/ibmcxx/bin/makeC++SharedLib_r
+MKSHLIB = $(MKSHLIB_BIN) -p 0 -G -berok -bM:UR
+
+ifdef JS_THREADSAFE
+XLDFLAGS += -ldl
+endif
+
diff -r a4343d61f6ee js/src/ref-config/Darwin.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/Darwin.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,85 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#   Steve Zellers (zellers@apple.com)
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config for Mac OS X as of PR3
+# Just ripped from Linux config
+#
+
+CC = gcc
+CCC = g++
+CFLAGS +=  -Wall -Wno-format -MMD
+OS_CFLAGS = -DXP_UNIX -DSVR4 -DSYSV -D_BSD_SOURCE -DPOSIX_SOURCE -DDARWIN
+
+RANLIB = ranlib
+MKSHLIB = $(CCC) -dynamiclib $(XMKSHLIBOPTS) -framework System
+
+SO_SUFFIX = dylib
+
+#.c.o:
+#      $(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = $(shell uname -m)
+ifeq (86,$(findstring 86,$(CPU_ARCH)))
+CPU_ARCH = x86
+OS_CFLAGS+= -DX86_LINUX
+OS_CFLAGS += -DAVMPLUS_IA32 -DAVMPLUS_UNIX
+NANOJIT_ARCH = i386
+endif
+GFX_ARCH = x
+
+OS_LIBS = -lc -framework System
+
+ASFLAGS += -x assembler-with-cpp
+
+ifeq ($(CPU_ARCH),alpha)
+
+# Ask the C compiler on alpha linux to let us work with denormalized
+# double values, which are required by the ECMA spec.
+
+OS_CFLAGS += -mieee
+endif
+
+# Use the editline library to provide line-editing support.
+JS_EDITLINE = 1
+
+# Don't allow Makefile.ref to use libmath
+NO_LIBM = 1
+
diff -r a4343d61f6ee js/src/ref-config/Darwin1.3.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/Darwin1.3.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,81 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#   Steve Zellers (zellers@apple.com)
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config for Mac OS X as of PR3
+# Just ripped from Linux config
+#
+
+CC = cc
+CCC = g++
+CFLAGS +=  -Wall -Wno-format
+OS_CFLAGS = -DXP_UNIX -DSVR4 -DSYSV -D_BSD_SOURCE -DPOSIX_SOURCE -DRHAPSODY
+
+RANLIB = ranlib
+MKSHLIB = libtool $(XMKSHLIBOPTS) -framework System
+
+#.c.o:
+#      $(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = $(shell uname -m)
+ifeq (86,$(findstring 86,$(CPU_ARCH)))
+CPU_ARCH = x86
+OS_CFLAGS+= -DX86_LINUX
+endif
+GFX_ARCH = x
+
+OS_LIBS = -lc -framework System
+
+ASFLAGS += -x assembler-with-cpp
+
+ifeq ($(CPU_ARCH),alpha)
+
+# Ask the C compiler on alpha linux to let us work with denormalized
+# double values, which are required by the ECMA spec.
+
+OS_CFLAGS += -mieee
+endif
+
+# Use the editline library to provide line-editing support.
+JS_EDITLINE = 1
+
+# Don't allow Makefile.ref to use libmath
+NO_LIBM = 1
+
diff -r a4343d61f6ee js/src/ref-config/Darwin1.4.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/Darwin1.4.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,41 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#   Mike McCabe <mike+mozilla@meer.net>
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+include $(DEPTH)/config/Darwin1.3.mk
diff -r a4343d61f6ee js/src/ref-config/Darwin5.2.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/Darwin5.2.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,81 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#   Steve Zellers (zellers@apple.com)
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config for Mac OS X as of PR3
+# Just ripped from Linux config
+#
+
+CC = cc
+CCC = g++
+CFLAGS +=  -Wall -Wno-format
+OS_CFLAGS = -DXP_UNIX -DSVR4 -DSYSV -D_BSD_SOURCE -DPOSIX_SOURCE -DDARWIN
+
+RANLIB = ranlib
+MKSHLIB = libtool $(XMKSHLIBOPTS) -framework System
+
+#.c.o:
+#      $(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = $(shell uname -m)
+ifeq (86,$(findstring 86,$(CPU_ARCH)))
+CPU_ARCH = x86
+OS_CFLAGS+= -DX86_LINUX
+endif
+GFX_ARCH = x
+
+OS_LIBS = -lc -framework System
+
+ASFLAGS += -x assembler-with-cpp
+
+ifeq ($(CPU_ARCH),alpha)
+
+# Ask the C compiler on alpha linux to let us work with denormalized
+# double values, which are required by the ECMA spec.
+
+OS_CFLAGS += -mieee
+endif
+
+# Use the editline library to provide line-editing support.
+JS_EDITLINE = 1
+
+# Don't allow Makefile.ref to use libmath
+NO_LIBM = 1
+
diff -r a4343d61f6ee js/src/ref-config/Darwin5.3.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/Darwin5.3.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,81 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#   Steve Zellers (zellers@apple.com)
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config for Mac OS X as of PR3
+# Just ripped from Linux config
+#
+
+CC = cc
+CCC = g++
+CFLAGS +=  -Wall -Wno-format
+OS_CFLAGS = -DXP_UNIX -DSVR4 -DSYSV -D_BSD_SOURCE -DPOSIX_SOURCE -DDARWIN
+
+RANLIB = ranlib
+MKSHLIB = libtool $(XMKSHLIBOPTS) -framework System
+
+#.c.o:
+#      $(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = $(shell uname -m)
+ifeq (86,$(findstring 86,$(CPU_ARCH)))
+CPU_ARCH = x86
+OS_CFLAGS+= -DX86_LINUX
+endif
+GFX_ARCH = x
+
+OS_LIBS = -lc -framework System
+
+ASFLAGS += -x assembler-with-cpp
+
+ifeq ($(CPU_ARCH),alpha)
+
+# Ask the C compiler on alpha linux to let us work with denormalized
+# double values, which are required by the ECMA spec.
+
+OS_CFLAGS += -mieee
+endif
+
+# Use the editline library to provide line-editing support.
+JS_EDITLINE = 1
+
+# Don't allow Makefile.ref to use libmath
+NO_LIBM = 1
+
diff -r a4343d61f6ee js/src/ref-config/Darwin64.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/Darwin64.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,72 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#   Steve Zellers (zellers@apple.com)
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config for Mac OS X as of PR3
+# Just ripped from Linux config
+#
+
+CC = cc
+CCC = g++
+CFLAGS +=  -Wall -Wno-format -MMD
+OS_LDFLAGS += -m64
+OS_CFLAGS = -m64 -DXP_UNIX -DSVR4 -DSYSV -D_BSD_SOURCE -DPOSIX_SOURCE -DDARWIN 
+
+RANLIB = ranlib
+MKSHLIB = $(CCC) -dynamiclib $(XMKSHLIBOPTS) -framework System
+
+SO_SUFFIX = dylib
+
+#.c.o:
+#      $(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = x86_64
+GFX_ARCH = x
+
+OS_LIBS = -lc -framework System
+
+ASFLAGS += -x assembler-with-cpp
+
+# Use the editline library to provide line-editing support.
+JS_EDITLINE = 1
+
+# Don't allow Makefile.ref to use libmath
+NO_LIBM = 1
+
diff -r a4343d61f6ee js/src/ref-config/HP-UXB.10.10.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/HP-UXB.10.10.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,77 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for HPUX
+#
+
+# CC = gcc
+# CCC = g++
+# CFLAGS +=  -Wall -Wno-format -fPIC
+
+CC  = cc -Ae +Z
+CCC = CC -Ae +a1 +eh +Z
+
+RANLIB = echo
+MKSHLIB = $(LD) -b
+
+SO_SUFFIX = sl
+
+#.c.o:
+#	$(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = hppa
+GFX_ARCH = x
+
+OS_CFLAGS = -DXP_UNIX -DHPUX -DSYSV -DHAVE_LOCALTIME_R
+OS_LIBS = -ldld
+
+ifeq ($(OS_RELEASE),B.10)
+PLATFORM_FLAGS		+= -DHPUX10 -Dhpux10
+PORT_FLAGS		+= -DRW_NO_OVERLOAD_SCHAR -DHAVE_MODEL_H
+ifeq ($(OS_VERSION),.10)
+PLATFORM_FLAGS		+= -DHPUX10_10
+endif
+ifeq ($(OS_VERSION),.20)
+PLATFORM_FLAGS		+= -DHPUX10_20
+endif
+ifeq ($(OS_VERSION),.30)
+PLATFORM_FLAGS		+= -DHPUX10_30
+endif
+endif
diff -r a4343d61f6ee js/src/ref-config/HP-UXB.10.20.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/HP-UXB.10.20.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,77 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for HPUX
+#
+
+# CC = gcc
+# CCC = g++
+# CFLAGS +=  -Wall -Wno-format -fPIC
+
+CC  = cc -Ae +Z
+CCC = CC -Ae +a1 +eh +Z
+
+RANLIB = echo
+MKSHLIB = $(LD) -b
+
+SO_SUFFIX = sl
+
+#.c.o:
+#	$(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = hppa
+GFX_ARCH = x
+
+OS_CFLAGS = -DXP_UNIX -DHPUX -DSYSV -DHAVE_LOCALTIME_R
+OS_LIBS = -ldld
+
+ifeq ($(OS_RELEASE),B.10)
+PLATFORM_FLAGS		+= -DHPUX10 -Dhpux10
+PORT_FLAGS		+= -DRW_NO_OVERLOAD_SCHAR -DHAVE_MODEL_H
+ifeq ($(OS_VERSION),.10)
+PLATFORM_FLAGS		+= -DHPUX10_10
+endif
+ifeq ($(OS_VERSION),.20)
+PLATFORM_FLAGS		+= -DHPUX10_20
+endif
+ifeq ($(OS_VERSION),.30)
+PLATFORM_FLAGS		+= -DHPUX10_30
+endif
+endif
diff -r a4343d61f6ee js/src/ref-config/HP-UXB.11.00.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/HP-UXB.11.00.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,80 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for HPUX
+#
+
+ifdef NS_USE_NATIVE
+  CC  = cc +Z +DAportable +DS2.0 +u4
+#  LD  = aCC +Z -b -Wl,+s -Wl,-B,symbolic
+else
+  CC = gcc -Wall -Wno-format -fPIC
+  CCC = g++ -Wall -Wno-format -fPIC
+endif
+
+RANLIB = echo
+MKSHLIB = $(LD) -b
+
+SO_SUFFIX = sl
+
+#.c.o:
+#	$(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = hppa
+GFX_ARCH = x
+
+OS_CFLAGS = -DXP_UNIX -DHPUX -DSYSV -D_HPUX -DNATIVE -D_POSIX_C_SOURCE=199506L -DHAVE_LOCALTIME_R
+OS_LIBS = -ldld
+
+XLDFLAGS = -lpthread
+
+ifeq ($(OS_RELEASE),B.10)
+PLATFORM_FLAGS		+= -DHPUX10 -Dhpux10
+PORT_FLAGS		+= -DRW_NO_OVERLOAD_SCHAR -DHAVE_MODEL_H
+ifeq ($(OS_VERSION),.10)
+PLATFORM_FLAGS		+= -DHPUX10_10
+endif
+ifeq ($(OS_VERSION),.20)
+PLATFORM_FLAGS		+= -DHPUX10_20
+endif
+ifeq ($(OS_VERSION),.30)
+PLATFORM_FLAGS		+= -DHPUX10_30
+endif
+endif
diff -r a4343d61f6ee js/src/ref-config/IRIX.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/IRIX.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,87 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for IRIX
+#
+
+CPU_ARCH = mips
+GFX_ARCH = x
+
+RANLIB = /bin/true
+
+#NS_USE_GCC = 1
+
+ifndef NS_USE_NATIVE
+CC = gcc
+CCC = g++
+AS = $(CC) -x assembler-with-cpp
+ODD_CFLAGS = -Wall -Wno-format
+ifdef BUILD_OPT
+OPTIMIZER = -O6
+endif
+else
+ifeq ($(OS_RELEASE),6.2)
+CC	= cc -n32 -DIRIX6_2
+endif
+ifeq ($(OS_RELEASE),6.3)
+CC	= cc -n32 -DIRIX6_3
+endif
+ifeq ($(OS_RELEASE),6.5)
+CC	= cc -n32 -DIRIX6_5
+endif
+CCC = CC
+# LD  = CC
+ODD_CFLAGS = -fullwarn -xansi
+ifdef BUILD_OPT
+OPTIMIZER += -Olimit 4000
+endif
+endif
+
+# For purify
+HAVE_PURIFY = 1
+PURE_OS_CFLAGS = $(ODD_CFLAGS) -DXP_UNIX -DSVR4 -DSW_THREADS -DIRIX -DHAVE_LOCALTIME_R
+
+OS_CFLAGS = $(PURE_OS_CFLAGS) -MDupdate $(DEPENDENCIES)
+
+BSDECHO	= echo
+MKSHLIB = $(LD) -n32 -shared
+
+# Use the editline library to provide line-editing support.
+JS_EDITLINE = 1
diff -r a4343d61f6ee js/src/ref-config/IRIX5.3.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/IRIX5.3.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,44 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for IRIX5.3
+#
+
+include $(DEPTH)/config/IRIX.mk
diff -r a4343d61f6ee js/src/ref-config/IRIX6.1.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/IRIX6.1.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,44 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for IRIX6.3
+#
+
+include $(DEPTH)/config/IRIX.mk
diff -r a4343d61f6ee js/src/ref-config/IRIX6.2.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/IRIX6.2.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,44 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for IRIX6.3
+#
+
+include $(DEPTH)/config/IRIX.mk
diff -r a4343d61f6ee js/src/ref-config/IRIX6.3.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/IRIX6.3.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,44 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for IRIX6.3
+#
+
+include $(DEPTH)/config/IRIX.mk
diff -r a4343d61f6ee js/src/ref-config/IRIX6.5.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/IRIX6.5.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,44 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for IRIX6.3
+#
+
+include $(DEPTH)/config/IRIX.mk
diff -r a4343d61f6ee js/src/ref-config/Linux_All.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/Linux_All.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,105 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config for all versions of Linux
+#
+
+CC = gcc
+CCC = g++
+LD = g++
+CFLAGS +=  -Wall -Wno-format -MMD
+OS_CFLAGS = -DXP_UNIX -DSVR4 -DSYSV -D_BSD_SOURCE -DPOSIX_SOURCE -DHAVE_LOCALTIME_R -DLINUX
+
+RANLIB = echo
+MKSHLIB = $(LD) -shared $(XMKSHLIBOPTS)
+
+#.c.o:
+#      $(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = $(shell uname -m)
+# don't filter in x86-64 architecture
+ifneq (x86_64,$(CPU_ARCH))
+ifeq (86,$(findstring 86,$(CPU_ARCH)))
+CPU_ARCH = x86
+OS_CFLAGS += -DX86_LINUX -DAVMPLUS_IA32 -DAVMPLUS_UNIX -DAVMPLUS_LINUX
+NANOJIT_ARCH = i386
+endif # 86
+endif # !x86_64
+
+#JIT disabled until x64 port is cleaned up
+#ifeq ($(CPU_ARCH),x86_64)
+#OS_CFLAGS += -DAVMPLUS_AMD64 -DAVMPLUS_64BIT -DAVMPLUS_UNIX -DAVMPLUS_LINUX
+#NANOJIT_ARCH = i386
+#endif
+
+ifeq ($(CPU_ARCH),arm)
+OS_CFLAGS += -DAVMPLUS_ARM -DAVMPLUS_UNIX -DAVMPLUS_LINUX
+NANOJIT_ARCH = ARM
+endif
+
+GFX_ARCH = x
+
+OS_LIBS = -lm -lc
+
+ASFLAGS += -x assembler-with-cpp
+
+
+ifeq ($(CPU_ARCH),alpha)
+
+# Ask the C compiler on alpha linux to let us work with denormalized
+# double values, which are required by the ECMA spec.
+
+OS_CFLAGS += -mieee
+endif
+
+# Use the editline library to provide line-editing support.
+JS_EDITLINE = 1
+
+ifeq ($(CPU_ARCH),x86_64)
+# Use VA_COPY() standard macro on x86-64
+# FIXME: better use it everywhere
+OS_CFLAGS += -DHAVE_VA_COPY -DVA_COPY=va_copy
+endif
+
+ifeq ($(CPU_ARCH),x86_64)
+# We need PIC code for shared libraries
+# FIXME: better patch rules.mk & fdlibm/Makefile*
+OS_CFLAGS += -DPIC -fPIC
+endif
diff -r a4343d61f6ee js/src/ref-config/Mac_OS10.0.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/Mac_OS10.0.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,82 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#   Steve Zellers (zellers@apple.com)
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config for Mac OS X as of PR3
+# Just ripped from Linux config
+#
+
+CC = cc
+CCC = g++
+CFLAGS +=  -Wall -Wno-format
+OS_CFLAGS = -DXP_UNIX -DSVR4 -DSYSV -D_BSD_SOURCE -DPOSIX_SOURCE 
+-DRHAPSODY
+
+RANLIB = ranlib
+MKSHLIB = libtool -dynamic $(XMKSHLIBOPTS) -framework System
+
+#.c.o:
+#      $(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = $(shell uname -m)
+ifeq (86,$(findstring 86,$(CPU_ARCH)))
+CPU_ARCH = x86
+OS_CFLAGS+= -DX86_LINUX
+endif
+GFX_ARCH = x
+
+OS_LIBS = -lc -framework System
+
+ASFLAGS += -x assembler-with-cpp
+
+ifeq ($(CPU_ARCH),alpha)
+
+# Ask the C compiler on alpha linux to let us work with denormalized
+# double values, which are required by the ECMA spec.
+
+OS_CFLAGS += -mieee
+endif
+
+# Use the editline library to provide line-editing support.
+JS_EDITLINE = 1
+
+# Don't allow Makefile.ref to use libmath
+NO_LIBM = 1
+
diff -r a4343d61f6ee js/src/ref-config/OSF1V4.0.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/OSF1V4.0.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,72 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for Data General DG/UX
+#
+
+#
+#  Initial DG/UX port by Marc Fraioli (fraioli@dg-rtp.dg.com)
+#
+
+ifndef NS_USE_NATIVE
+CC = gcc
+CCC = g++
+CFLAGS +=  -mieee -Wall -Wno-format
+else
+CC  = cc
+CCC = cxx
+CFLAGS += -ieee -std
+# LD  = cxx
+endif
+
+RANLIB = echo
+MKSHLIB = $(LD) -shared -taso -all -expect_unresolved "*"
+
+#
+#  _DGUX_SOURCE is needed to turn on a lot of stuff in the headers if 
+#      you're not using DG's compiler.  It shouldn't hurt if you are.
+#
+#  _POSIX4A_DRAFT10_SOURCE is needed to pick up localtime_r, used in
+#      prtime.c
+#
+OS_CFLAGS = -DXP_UNIX -DSVR4 -DSYSV -DDGUX -D_DGUX_SOURCE -D_POSIX4A_DRAFT10_SOURCE -DOSF1 -DHAVE_LOCALTIME_R
+OS_LIBS = -lsocket -lnsl 
+
+NOSUCHFILE = /no-such-file
diff -r a4343d61f6ee js/src/ref-config/OSF1V5.0.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/OSF1V5.0.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,69 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for Tru64 Unix 5.0
+#
+
+#
+#  Initial DG/UX port by Marc Fraioli (fraioli@dg-rtp.dg.com)
+#
+
+ifndef NS_USE_NATIVE
+CC = gcc
+CCC = g++
+CFLAGS +=  -mieee -Wall -Wno-format
+else
+CC  = cc
+CCC = cxx
+CFLAGS += -ieee -std -pthread
+# LD  = cxx
+endif
+
+RANLIB = echo
+MKSHLIB = $(LD) -shared -all -expect_unresolved "*"
+
+#
+#  _POSIX4A_DRAFT10_SOURCE is needed to pick up localtime_r, used in
+#      prtime.c
+#
+OS_CFLAGS = -DXP_UNIX -DSVR4 -DSYSV -D_POSIX4A_DRAFT10_SOURCE -DOSF1 -DHAVE_LOCALTIME_R
+OS_LIBS = -lsocket -lnsl 
+
+NOSUCHFILE = /no-such-file
diff -r a4343d61f6ee js/src/ref-config/SunOS4.1.4.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/SunOS4.1.4.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,101 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for SunOS4.1
+#
+
+CC = gcc
+CCC = g++
+RANLIB = ranlib
+
+#.c.o:
+#	$(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = sparc
+GFX_ARCH = x
+
+# A pile of -D's to build xfe on sunos
+MOZ_CFLAGS = -DSTRINGS_ALIGNED -DNO_REGEX -DNO_ISDIR -DUSE_RE_COMP \
+	     -DNO_REGCOMP -DUSE_GETWD -DNO_MEMMOVE -DNO_ALLOCA \
+	     -DBOGUS_MB_MAX -DNO_CONST
+
+# Purify doesn't like -MDupdate
+NOMD_OS_CFLAGS = -DXP_UNIX -Wall -Wno-format -DSW_THREADS -DSUNOS4 -DNEED_SYSCALL \
+		 $(MOZ_CFLAGS)
+
+OS_CFLAGS = $(NOMD_OS_CFLAGS) -MDupdate $(DEPENDENCIES)
+OS_LIBS = -ldl -lm
+
+MKSHLIB = $(LD) -L$(MOTIF)/lib
+
+HAVE_PURIFY = 1
+MOTIF = /home/motif/usr
+MOTIFLIB = -L$(MOTIF)/lib -lXm
+INCLUDES += -I/usr/X11R5/include -I$(MOTIF)/include
+
+NOSUCHFILE = /solaris-rm-f-sucks
+
+LOCALE_MAP = $(DEPTH)/cmd/xfe/intl/sunos.lm
+
+EN_LOCALE = en_US
+DE_LOCALE = de
+FR_LOCALE = fr
+JP_LOCALE = ja
+SJIS_LOCALE = ja_JP.SJIS
+KR_LOCALE = ko
+CN_LOCALE = zh
+TW_LOCALE = zh_TW
+I2_LOCALE = i2
+IT_LOCALE = it
+SV_LOCALE = sv
+ES_LOCALE = es
+NL_LOCALE = nl
+PT_LOCALE = pt
+
+LOC_LIB_DIR = /usr/openwin/lib/locale
+
+BSDECHO	= echo
+
+#
+# These defines are for building unix plugins
+#
+BUILD_UNIX_PLUGINS = 1
+DSO_LDOPTS =
+DSO_LDFLAGS =
diff -r a4343d61f6ee js/src/ref-config/SunOS5.10.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/SunOS5.10.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,50 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1999
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for SunOS5.10, using vendor gcc and NSPR
+#
+
+include $(DEPTH)/config/SunOS5.5.mk
+
+INCLUDES += -I/usr/sfw/include/mozilla/nspr
+OTHER_LIBS += -L/usr/sfw/lib/mozilla -R/usr/sfw/lib/mozilla
+
+CC=gcc
+
diff -r a4343d61f6ee js/src/ref-config/SunOS5.3.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/SunOS5.3.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,91 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for SunOS5.3
+#
+
+CC = gcc
+CCC = g++
+CFLAGS +=  -Wall -Wno-format
+
+#CC = /opt/SUNWspro/SC3.0.1/bin/cc
+RANLIB = echo
+
+#.c.o:
+#	$(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = sparc
+GFX_ARCH = x
+
+OS_CFLAGS = -DXP_UNIX -DSVR4 -DSYSV -DSOLARIS -DHAVE_LOCALTIME_R
+OS_LIBS = -lsocket -lnsl -ldl
+
+ASFLAGS	        += -P -L -K PIC -D_ASM -D__STDC__=0
+
+HAVE_PURIFY = 1
+
+NOSUCHFILE = /solaris-rm-f-sucks
+
+ifndef JS_NO_ULTRA
+ULTRA_OPTIONS := -xarch=v8plus
+ULTRA_OPTIONSD := -DULTRA_SPARC
+else
+ULTRA_OPTIONS := -xarch=v8
+ULTRA_OPTIONSD :=
+endif
+
+ifeq ($(OS_CPUARCH),sun4u)
+DEFINES 	+= $(ULTRA_OPTIONSD)
+ifeq ($(findstring gcc,$(CC)),gcc)
+DEFINES         += -Wa,$(ULTRA_OPTIONS),$(ULTRA_OPTIONSD)
+else
+ASFLAGS         += $(ULTRA_OPTIONS) $(ULTRA_OPTIONSD)
+endif
+endif
+
+ifeq ($(OS_CPUARCH),sun4m)
+ifeq ($(findstring gcc,$(CC)),gcc)
+DEFINES         += -Wa,-xarch=v8
+else
+ASFLAGS         += -xarch=v8
+endif
+endif
+
+MKSHLIB = $(LD) -G
diff -r a4343d61f6ee js/src/ref-config/SunOS5.4.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/SunOS5.4.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,92 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for SunOS5.4
+#
+
+ifdef NS_USE_NATIVE
+CC = cc
+CCC = CC
+else
+CC = gcc
+CCC = g++
+CFLAGS += -Wall -Wno-format
+endif
+
+RANLIB = echo
+
+CPU_ARCH = sparc
+GFX_ARCH = x
+
+OS_CFLAGS = -DXP_UNIX -DSVR4 -DSYSV -D__svr4 -DSOLARIS -DHAVE_LOCALTIME_R
+OS_LIBS = -lsocket -lnsl -ldl
+
+ASFLAGS	        += -P -L -K PIC -D_ASM -D__STDC__=0
+
+HAVE_PURIFY = 1
+
+NOSUCHFILE = /solaris-rm-f-sucks
+
+ifndef JS_NO_ULTRA
+ULTRA_OPTIONS := -xarch=v8plus
+ULTRA_OPTIONSD := -DULTRA_SPARC
+else
+ULTRA_OPTIONS := -xarch=v8
+ULTRA_OPTIONSD :=
+endif
+
+ifeq ($(OS_CPUARCH),sun4u)
+DEFINES 	+= $(ULTRA_OPTIONSD)
+ifeq ($(findstring gcc,$(CC)),gcc)
+DEFINES         += -Wa,$(ULTRA_OPTIONS),$(ULTRA_OPTIONSD)
+else
+ASFLAGS         += $(ULTRA_OPTIONS) $(ULTRA_OPTIONSD)
+endif
+endif
+
+ifeq ($(OS_CPUARCH),sun4m)
+ifeq ($(findstring gcc,$(CC)),gcc)
+DEFINES         += -Wa,-xarch=v8
+else
+ASFLAGS         += -xarch=v8
+endif
+endif
+
+MKSHLIB = $(LD) -G
diff -r a4343d61f6ee js/src/ref-config/SunOS5.5.1.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/SunOS5.5.1.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,44 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for SunOS5.5.1
+#
+
+include $(DEPTH)/config/SunOS5.5.mk
diff -r a4343d61f6ee js/src/ref-config/SunOS5.5.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/SunOS5.5.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,87 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for SunOS5.5
+#
+
+AS = /usr/ccs/bin/as
+ifndef NS_USE_NATIVE
+CC = gcc
+CCC = g++
+CFLAGS +=  -Wall -Wno-format
+else
+CC = cc
+CCC = CC
+endif
+
+RANLIB = echo
+
+#.c.o:
+#	$(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = sparc
+GFX_ARCH = x
+
+OS_CFLAGS = -DXP_UNIX -DSVR4 -DSYSV -DSOLARIS -DHAVE_LOCALTIME_R
+OS_LIBS = -lsocket -lnsl -ldl
+
+ASFLAGS	        += -P -L -K PIC -D_ASM -D__STDC__=0
+
+HAVE_PURIFY = 1
+
+NOSUCHFILE = /solaris-rm-f-sucks
+
+ifeq ($(OS_CPUARCH),sun4u)	# ultra sparc?
+ifeq ($(CC),gcc)		# using gcc?
+ifndef JS_NO_ULTRA		# do we want ultra?
+ifdef JS_THREADSAFE		# only in thread-safe mode
+DEFINES 	+= -DULTRA_SPARC
+DEFINES         += -Wa,-xarch=v8plus,-DULTRA_SPARC
+else
+ASFLAGS         += -xarch=v8plus -DULTRA_SPARC
+endif
+endif
+endif
+endif
+
+MKSHLIB = $(LD) -G
+
+# Use the editline library to provide line-editing support.
+JS_EDITLINE = 1
diff -r a4343d61f6ee js/src/ref-config/SunOS5.6.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/SunOS5.6.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,89 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for SunOS5.5
+#
+
+AS = /usr/ccs/bin/as
+ifndef NS_USE_NATIVE
+  CC = gcc
+  CCC = g++
+  CFLAGS +=  -Wall -Wno-format
+else
+  CC = cc
+  CCC = CC
+  CFLAGS += -mt -KPIC
+#  LD = CC
+endif
+
+RANLIB = echo
+
+#.c.o:
+#	$(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = sparc
+GFX_ARCH = x
+
+OS_CFLAGS = -DXP_UNIX -DSVR4 -DSYSV -DSOLARIS -DHAVE_LOCALTIME_R
+OS_LIBS = -lsocket -lnsl -ldl
+
+ASFLAGS	        += -P -L -K PIC -D_ASM -D__STDC__=0
+
+HAVE_PURIFY = 1
+
+NOSUCHFILE = /solaris-rm-f-sucks
+
+ifeq ($(OS_CPUARCH),sun4u)	# ultra sparc?
+ifeq ($(CC),gcc)		# using gcc?
+ifndef JS_NO_ULTRA		# do we want ultra?
+ifdef JS_THREADSAFE		# only in thread-safe mode
+DEFINES 	+= -DULTRA_SPARC
+DEFINES         += -Wa,-xarch=v8plus,-DULTRA_SPARC
+else
+ASFLAGS         += -xarch=v8plus -DULTRA_SPARC
+endif
+endif
+endif
+endif
+
+MKSHLIB = $(LD) -G
+
+# Use the editline library to provide line-editing support.
+JS_EDITLINE = 1
diff -r a4343d61f6ee js/src/ref-config/SunOS5.7.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/SunOS5.7.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,44 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1999
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for SunOS5.7
+#
+
+include $(DEPTH)/config/SunOS5.5.mk
diff -r a4343d61f6ee js/src/ref-config/SunOS5.8.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/SunOS5.8.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,44 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1999
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for SunOS5.8
+#
+
+include $(DEPTH)/config/SunOS5.5.mk
diff -r a4343d61f6ee js/src/ref-config/SunOS5.9.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/SunOS5.9.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,44 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1999
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for SunOS5.9
+#
+
+include $(DEPTH)/config/SunOS5.5.mk
diff -r a4343d61f6ee js/src/ref-config/WINNT4.0.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/WINNT4.0.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,118 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config for Windows NT using MS Visual C++ (version?)
+#
+
+CC = cl
+CXX = cl
+
+RANLIB = echo
+
+PDBFILE = $(basename $(@F)).pdb
+
+#.c.o:
+#      $(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = x86 # XXX fixme
+GFX_ARCH = win32
+
+# MSVC compiler options for both debug/optimize
+# -nologo  - suppress copyright message
+# -W3      - Warning level 3
+# -Gm      - enable minimal rebuild
+# -Z7      - put debug info into the executable, not in .pdb file
+# -Zi      - put debug info into .pdb file
+# -YX      - automatic precompiled headers
+# -GX      - enable C++ exception support
+WIN_CFLAGS = -nologo -W3 
+
+# MSVC compiler options for debug builds linked to MSVCRTD.DLL
+# -MDd     - link with MSVCRTD.LIB (Dynamically-linked, multi-threaded, debug C-runtime)
+# -Od      - minimal optimization
+WIN_IDG_CFLAGS = -MDd -Od -Z7 
+
+# MSVC compiler options for debug builds linked to MSVCRT.DLL
+# -MD      - link with MSVCRT.LIB (Dynamically-linked, multi-threaded, debug C-runtime)
+# -Od      - minimal optimization
+WIN_DEBUG_CFLAGS = -MD -Od -Zi -Fd$(OBJDIR)/$(PDBFILE)
+
+# MSVC compiler options for release (optimized) builds
+# -MD      - link with MSVCRT.LIB (Dynamically-linked, multi-threaded, C-runtime)
+# -O2      - Optimize for speed
+# -G5      - Optimize for Pentium
+WIN_OPT_CFLAGS = -MD -O2
+
+ifdef BUILD_OPT
+OPTIMIZER = $(WIN_OPT_CFLAGS)
+else
+ifdef BUILD_IDG
+OPTIMIZER = $(WIN_IDG_CFLAGS)
+else
+OPTIMIZER = $(WIN_DEBUG_CFLAGS)
+endif
+endif
+
+OS_CFLAGS = -D_X86_=1 -DXP_WIN -DXP_WIN32 -DWIN32 -D_WINDOWS -D_WIN32 $(WIN_CFLAGS)
+JSDLL_CFLAGS = -DEXPORT_JS_API
+OS_LIBS = -lm -lc
+
+PREBUILT_CPUCFG = 1
+USE_MSVC = 1
+
+LIB_LINK_FLAGS=kernel32.lib user32.lib gdi32.lib winspool.lib comdlg32.lib\
+ advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib oldnames.lib \
+ winmm.lib \
+ -nologo\
+ -subsystem:windows -dll -debug -pdb:$(OBJDIR)/$(PDBFILE)\
+ -machine:I386\
+ -opt:ref -opt:noicf
+
+EXE_LINK_FLAGS=kernel32.lib user32.lib gdi32.lib winspool.lib comdlg32.lib\
+ advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib oldnames.lib -nologo\
+ -subsystem:console -debug -pdb:$(OBJDIR)/$(PDBFILE)\
+ -machine:I386\
+ -opt:ref -opt:noicf
+
+# CAFEDIR = t:/cafe
+# JCLASSPATH = $(CAFEDIR)/Java/Lib/classes.zip
+# JAVAC = $(CAFEDIR)/Bin/sj.exe
+# JAVAH = $(CAFEDIR)/Java/Bin/javah.exe
+# JCFLAGS = -I$(CAFEDIR)/Java/Include -I$(CAFEDIR)/Java/Include/win32
diff -r a4343d61f6ee js/src/ref-config/WINNT5.0.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/WINNT5.0.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,118 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config for Windows NT using MS Visual C++ (version?)
+#
+
+CC = cl
+CXX = cl
+
+RANLIB = echo
+
+PDBFILE = $(basename $(@F)).pdb
+
+#.c.o:
+#      $(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = x86 # XXX fixme
+GFX_ARCH = win32
+
+# MSVC compiler options for both debug/optimize
+# -nologo  - suppress copyright message
+# -W3      - Warning level 3
+# -Gm      - enable minimal rebuild
+# -Z7      - put debug info into the executable, not in .pdb file
+# -Zi      - put debug info into .pdb file
+# -YX      - automatic precompiled headers
+# -GX      - enable C++ exception support
+WIN_CFLAGS = -nologo -W3 
+
+# MSVC compiler options for debug builds linked to MSVCRTD.DLL
+# -MDd     - link with MSVCRTD.LIB (Dynamically-linked, multi-threaded, debug C-runtime)
+# -Od      - minimal optimization
+WIN_IDG_CFLAGS = -MDd -Od -Z7 
+
+# MSVC compiler options for debug builds linked to MSVCRT.DLL
+# -MD      - link with MSVCRT.LIB (Dynamically-linked, multi-threaded, debug C-runtime)
+# -Od      - minimal optimization
+WIN_DEBUG_CFLAGS = -MD -Od -Zi -Fd$(OBJDIR)/$(PDBFILE)
+
+# MSVC compiler options for release (optimized) builds
+# -MD      - link with MSVCRT.LIB (Dynamically-linked, multi-threaded, C-runtime)
+# -O2      - Optimize for speed
+# -G5      - Optimize for Pentium
+WIN_OPT_CFLAGS = -MD -O2
+
+ifdef BUILD_OPT
+OPTIMIZER = $(WIN_OPT_CFLAGS)
+else
+ifdef BUILD_IDG
+OPTIMIZER = $(WIN_IDG_CFLAGS)
+else
+OPTIMIZER = $(WIN_DEBUG_CFLAGS)
+endif
+endif
+
+OS_CFLAGS = -D_X86_=1 -DXP_WIN -DXP_WIN32 -DWIN32 -D_WINDOWS -D_WIN32 -DWINVER=0x500 -D_WIN32_WINNT=0x500 $(WIN_CFLAGS)
+JSDLL_CFLAGS = -DEXPORT_JS_API
+OS_LIBS = -lm -lc
+
+PREBUILT_CPUCFG = 1
+USE_MSVC = 1
+
+LIB_LINK_FLAGS=kernel32.lib user32.lib gdi32.lib winspool.lib comdlg32.lib\
+ advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib oldnames.lib \
+ winmm.lib \
+ -nologo\
+ -subsystem:windows -dll -debug -pdb:$(OBJDIR)/$(PDBFILE)\
+ -machine:I386\
+ -opt:ref -opt:noicf
+
+EXE_LINK_FLAGS=kernel32.lib user32.lib gdi32.lib winspool.lib comdlg32.lib\
+ advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib oldnames.lib -nologo\
+ -subsystem:console -debug -pdb:$(OBJDIR)/$(PDBFILE)\
+ -machine:I386\
+ -opt:ref -opt:noicf
+
+# CAFEDIR = t:/cafe
+# JCLASSPATH = $(CAFEDIR)/Java/Lib/classes.zip
+# JAVAC = $(CAFEDIR)/Bin/sj.exe
+# JAVAH = $(CAFEDIR)/Java/Bin/javah.exe
+# JCFLAGS = -I$(CAFEDIR)/Java/Include -I$(CAFEDIR)/Java/Include/win32
diff -r a4343d61f6ee js/src/ref-config/WINNT5.1.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/WINNT5.1.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,118 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config for Windows NT using MS Visual C++ (version?)
+#
+
+CC = cl
+CXX = cl
+
+RANLIB = echo
+
+PDBFILE = $(basename $(@F)).pdb
+
+#.c.o:
+#      $(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = x86 # XXX fixme
+GFX_ARCH = win32
+
+# MSVC compiler options for both debug/optimize
+# -nologo  - suppress copyright message
+# -W3      - Warning level 3
+# -Gm      - enable minimal rebuild
+# -Z7      - put debug info into the executable, not in .pdb file
+# -Zi      - put debug info into .pdb file
+# -YX      - automatic precompiled headers
+# -GX      - enable C++ exception support
+WIN_CFLAGS = -nologo -W3 
+
+# MSVC compiler options for debug builds linked to MSVCRTD.DLL
+# -MDd     - link with MSVCRTD.LIB (Dynamically-linked, multi-threaded, debug C-runtime)
+# -Od      - minimal optimization
+WIN_IDG_CFLAGS = -MDd -Od -Z7 
+
+# MSVC compiler options for debug builds linked to MSVCRT.DLL
+# -MD      - link with MSVCRT.LIB (Dynamically-linked, multi-threaded, debug C-runtime)
+# -Od      - minimal optimization
+WIN_DEBUG_CFLAGS = -MD -Od -Zi -Fd$(OBJDIR)/$(PDBFILE)
+
+# MSVC compiler options for release (optimized) builds
+# -MD      - link with MSVCRT.LIB (Dynamically-linked, multi-threaded, C-runtime)
+# -O2      - Optimize for speed
+# -G5      - Optimize for Pentium
+WIN_OPT_CFLAGS = -MD -O2
+
+ifdef BUILD_OPT
+OPTIMIZER = $(WIN_OPT_CFLAGS)
+else
+ifdef BUILD_IDG
+OPTIMIZER = $(WIN_IDG_CFLAGS)
+else
+OPTIMIZER = $(WIN_DEBUG_CFLAGS)
+endif
+endif
+
+OS_CFLAGS = -D_X86_=1 -DXP_WIN -DXP_WIN32 -DWIN32 -D_WINDOWS -D_WIN32 -DWINVER=0x500 -D_WIN32_WINNT=0x500 $(WIN_CFLAGS)
+JSDLL_CFLAGS = -DEXPORT_JS_API
+OS_LIBS = -lm -lc
+
+PREBUILT_CPUCFG = 1
+USE_MSVC = 1
+
+LIB_LINK_FLAGS=kernel32.lib user32.lib gdi32.lib winspool.lib comdlg32.lib\
+ advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib oldnames.lib \
+ winmm.lib \
+ -nologo\
+ -subsystem:windows -dll -debug -pdb:$(OBJDIR)/$(PDBFILE)\
+ -machine:I386\
+ -opt:ref -opt:noicf
+
+EXE_LINK_FLAGS=kernel32.lib user32.lib gdi32.lib winspool.lib comdlg32.lib\
+ advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib oldnames.lib -nologo\
+ -subsystem:console -debug -pdb:$(OBJDIR)/$(PDBFILE)\
+ -machine:I386\
+ -opt:ref -opt:noicf
+
+# CAFEDIR = t:/cafe
+# JCLASSPATH = $(CAFEDIR)/Java/Lib/classes.zip
+# JAVAC = $(CAFEDIR)/Bin/sj.exe
+# JAVAH = $(CAFEDIR)/Java/Bin/javah.exe
+# JCFLAGS = -I$(CAFEDIR)/Java/Include -I$(CAFEDIR)/Java/Include/win32
diff -r a4343d61f6ee js/src/ref-config/WINNT5.2.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/WINNT5.2.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,118 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config for Windows NT using MS Visual C++ (version?)
+#
+
+CC = cl
+CXX = cl
+
+RANLIB = echo
+
+PDBFILE = $(basename $(@F)).pdb
+
+#.c.o:
+#      $(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = x86 # XXX fixme
+GFX_ARCH = win32
+
+# MSVC compiler options for both debug/optimize
+# -nologo  - suppress copyright message
+# -W3      - Warning level 3
+# -Gm      - enable minimal rebuild
+# -Z7      - put debug info into the executable, not in .pdb file
+# -Zi      - put debug info into .pdb file
+# -YX      - automatic precompiled headers
+# -GX      - enable C++ exception support
+WIN_CFLAGS = -nologo -W3 
+
+# MSVC compiler options for debug builds linked to MSVCRTD.DLL
+# -MDd     - link with MSVCRTD.LIB (Dynamically-linked, multi-threaded, debug C-runtime)
+# -Od      - minimal optimization
+WIN_IDG_CFLAGS = -MDd -Od -Z7 
+
+# MSVC compiler options for debug builds linked to MSVCRT.DLL
+# -MD      - link with MSVCRT.LIB (Dynamically-linked, multi-threaded, debug C-runtime)
+# -Od      - minimal optimization
+WIN_DEBUG_CFLAGS = -MD -Od -Zi -Fd$(OBJDIR)/$(PDBFILE)
+
+# MSVC compiler options for release (optimized) builds
+# -MD      - link with MSVCRT.LIB (Dynamically-linked, multi-threaded, C-runtime)
+# -O2      - Optimize for speed
+# -G5      - Optimize for Pentium
+WIN_OPT_CFLAGS = -MD -O2
+
+ifdef BUILD_OPT
+OPTIMIZER = $(WIN_OPT_CFLAGS)
+else
+ifdef BUILD_IDG
+OPTIMIZER = $(WIN_IDG_CFLAGS)
+else
+OPTIMIZER = $(WIN_DEBUG_CFLAGS)
+endif
+endif
+
+OS_CFLAGS = -D_X86_=1 -DXP_WIN -DXP_WIN32 -DWIN32 -D_WINDOWS -D_WIN32 -DWINVER=0x500 -D_WIN32_WINNT=0x500 $(WIN_CFLAGS) -DAVMPLUS_WIN32 -DAVMPLUS_IA32
+JSDLL_CFLAGS = -DEXPORT_JS_API
+OS_LIBS = -lm -lc
+
+PREBUILT_CPUCFG = 1
+USE_MSVC = 1
+
+LIB_LINK_FLAGS=kernel32.lib user32.lib gdi32.lib winspool.lib comdlg32.lib\
+ advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib oldnames.lib \
+ winmm.lib \
+ -nologo\
+ -subsystem:windows -dll -debug -pdb:$(OBJDIR)/$(PDBFILE)\
+ -machine:I386\
+ -opt:ref -opt:noicf
+
+EXE_LINK_FLAGS=kernel32.lib user32.lib gdi32.lib winspool.lib comdlg32.lib\
+ advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib oldnames.lib -nologo\
+ -subsystem:console -debug -pdb:$(OBJDIR)/$(PDBFILE)\
+ -machine:I386\
+ -opt:ref -opt:noicf
+
+# CAFEDIR = t:/cafe
+# JCLASSPATH = $(CAFEDIR)/Java/Lib/classes.zip
+# JAVAC = $(CAFEDIR)/Bin/sj.exe
+# JAVAH = $(CAFEDIR)/Java/Bin/javah.exe
+# JCFLAGS = -I$(CAFEDIR)/Java/Include -I$(CAFEDIR)/Java/Include/win32
diff -r a4343d61f6ee js/src/ref-config/WINNT6.0.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/WINNT6.0.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,118 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config for Windows NT using MS Visual C++ (version?)
+#
+
+CC = cl
+CXX = cl
+
+RANLIB = echo
+
+PDBFILE = $(basename $(@F)).pdb
+
+#.c.o:
+#      $(CC) -c -MD $*.d $(CFLAGS) $<
+
+CPU_ARCH = x86 # XXX fixme
+GFX_ARCH = win32
+
+# MSVC compiler options for both debug/optimize
+# -nologo  - suppress copyright message
+# -W3      - Warning level 3
+# -Gm      - enable minimal rebuild
+# -Z7      - put debug info into the executable, not in .pdb file
+# -Zi      - put debug info into .pdb file
+# -YX      - automatic precompiled headers
+# -GX      - enable C++ exception support
+WIN_CFLAGS = -nologo -W3 
+
+# MSVC compiler options for debug builds linked to MSVCRTD.DLL
+# -MDd     - link with MSVCRTD.LIB (Dynamically-linked, multi-threaded, debug C-runtime)
+# -Od      - minimal optimization
+WIN_IDG_CFLAGS = -MDd -Od -Z7 
+
+# MSVC compiler options for debug builds linked to MSVCRT.DLL
+# -MD      - link with MSVCRT.LIB (Dynamically-linked, multi-threaded, debug C-runtime)
+# -Od      - minimal optimization
+WIN_DEBUG_CFLAGS = -MD -Od -Zi -Fd$(OBJDIR)/$(PDBFILE)
+
+# MSVC compiler options for release (optimized) builds
+# -MD      - link with MSVCRT.LIB (Dynamically-linked, multi-threaded, C-runtime)
+# -O2      - Optimize for speed
+# -G5      - Optimize for Pentium
+WIN_OPT_CFLAGS = -MD -O2
+
+ifdef BUILD_OPT
+OPTIMIZER = $(WIN_OPT_CFLAGS)
+else
+ifdef BUILD_IDG
+OPTIMIZER = $(WIN_IDG_CFLAGS)
+else
+OPTIMIZER = $(WIN_DEBUG_CFLAGS)
+endif
+endif
+
+OS_CFLAGS = -D_X86_=1 -DXP_WIN -DXP_WIN32 -DWIN32 -D_WINDOWS -D_WIN32 -DWINVER=0x500 -D_WIN32_WINNT=0x500 $(WIN_CFLAGS)
+JSDLL_CFLAGS = -DEXPORT_JS_API
+OS_LIBS = -lm -lc
+
+PREBUILT_CPUCFG = 1
+USE_MSVC = 1
+
+LIB_LINK_FLAGS=kernel32.lib user32.lib gdi32.lib winspool.lib comdlg32.lib\
+ advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib oldnames.lib \
+ winmm.lib \
+ -nologo\
+ -subsystem:windows -dll -debug -pdb:$(OBJDIR)/$(PDBFILE)\
+ -machine:I386\
+ -opt:ref -opt:noicf
+
+EXE_LINK_FLAGS=kernel32.lib user32.lib gdi32.lib winspool.lib comdlg32.lib\
+ advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib oldnames.lib -nologo\
+ -subsystem:console -debug -pdb:$(OBJDIR)/$(PDBFILE)\
+ -machine:I386\
+ -opt:ref -opt:noicf
+
+# CAFEDIR = t:/cafe
+# JCLASSPATH = $(CAFEDIR)/Java/Lib/classes.zip
+# JAVAC = $(CAFEDIR)/Bin/sj.exe
+# JAVAH = $(CAFEDIR)/Java/Bin/javah.exe
+# JCFLAGS = -I$(CAFEDIR)/Java/Include -I$(CAFEDIR)/Java/Include/win32
diff -r a4343d61f6ee js/src/ref-config/dgux.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/ref-config/dgux.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,64 @@
+# -*- Mode: makefile -*-
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+#
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+#
+# Config stuff for Data General DG/UX
+#
+
+#
+#  Initial DG/UX port by Marc Fraioli (fraioli@dg-rtp.dg.com)
+#
+
+AS = as
+CC = gcc 
+CCC = g++ 
+
+RANLIB = echo
+
+#
+#  _DGUX_SOURCE is needed to turn on a lot of stuff in the headers if 
+#      you're not using DG's compiler.  It shouldn't hurt if you are.
+#
+#  _POSIX4A_DRAFT10_SOURCE is needed to pick up localtime_r, used in
+#      prtime.c
+#
+OS_CFLAGS = -DXP_UNIX -DSVR4 -DSYSV -DDGUX -D_DGUX_SOURCE -D_POSIX4A_DRAFT10_SOURCE -DHAVE_LOCALTIME_R
+OS_LIBS = -lsocket -lnsl 
+
+NOSUCHFILE = /no-such-file
diff -r a4343d61f6ee js/src/rules.mk
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/rules.mk	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,206 @@
+# -*- Mode: makefile -*-
+# 
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+# 
+# The Original Code is Mozilla Communicator client code, released
+# March 31, 1998.
+# 
+# The Initial Developer of the Original Code is
+# Netscape Communications Corporation.
+# Portions created by the Initial Developer are Copyright (C) 1998-1999
+# the Initial Developer. All Rights Reserved.
+# 
+# Contributor(s):
+#   Michael Ang <mang@subcarrier.org>
+# 
+# Alternatively, the contents of this file may be used under the terms of
+# either of the GNU General Public License Version 2 or later (the "GPL"),
+# or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+# 
+# ***** END LICENSE BLOCK *****
+
+#
+# JSRef GNUmake makefile rules
+#
+
+ifdef USE_MSVC
+LIB_OBJS  = $(addprefix $(OBJDIR)/, $(LIB_CPPFILES:.cpp=.obj))
+PROG_OBJS = $(addprefix $(OBJDIR)/, $(PROG_CPPFILES:.cpp=.obj))
+else
+LIB_OBJS  = $(addprefix $(OBJDIR)/, $(LIB_CPPFILES:.cpp=.o))
+LIB_OBJS  += $(addprefix $(OBJDIR)/, $(LIB_ASFILES:.s=.o))
+PROG_OBJS = $(addprefix $(OBJDIR)/, $(PROG_CPPFILES:.cpp=.o))
+endif
+
+CPPFILES = $(LIB_CPPFILES) $(PROG_CPPFILES)
+OBJS   = $(LIB_OBJS) $(PROG_OBJS)
+
+ifdef USE_MSVC
+# TARGETS = $(LIBRARY)   # $(PROGRAM) not supported for MSVC yet
+TARGETS += $(SHARED_LIBRARY) $(PROGRAM)  # it is now
+else
+TARGETS += $(LIBRARY) $(SHARED_LIBRARY) $(PROGRAM) 
+endif
+
+all:
+	+$(LOOP_OVER_PREDIRS) 
+ifneq "$(strip $(TARGETS))" ""
+	$(MAKE) -f Makefile.ref $(TARGETS)
+endif
+	+$(LOOP_OVER_DIRS)
+
+$(OBJDIR)/%: %.cpp
+	@$(MAKE_OBJDIR)
+	$(CXX) -o $@ $(CFLAGS) $(OPTIMIZER) $< $(LDFLAGS)
+
+# This rule must come before the rule with no dep on header
+$(OBJDIR)/%.o: %.cpp %.h
+	@$(MAKE_OBJDIR)
+	$(CXX) -o $@ -c $(CFLAGS) $(OPTIMIZER) $<
+
+$(OBJDIR)/jsinterp.o: jsinterp.cpp jsinterp.h
+	@$(MAKE_OBJDIR)
+	$(CXX) -o $@ -c $(CFLAGS) $(INTERP_OPTIMIZER) jsinterp.cpp
+
+$(OBJDIR)/jsbuiltins.o: jsbuiltins.cpp jsinterp.h
+	@$(MAKE_OBJDIR)
+	$(CXX) -o $@ -c $(CFLAGS) $(BUILTINS_OPTIMIZER) jsbuiltins.cpp
+
+$(OBJDIR)/%.o: %.cpp
+	@$(MAKE_OBJDIR)
+	$(CXX) -o $@ -c $(CFLAGS) $(OPTIMIZER) $<
+
+$(OBJDIR)/%.o: %.s
+	@$(MAKE_OBJDIR)
+	$(AS) -o $@ $(ASFLAGS) $<
+
+# This rule must come before rule with no dep on header
+$(OBJDIR)/%.obj: %.cpp %.h
+	@$(MAKE_OBJDIR)
+	$(CXX) -Fo$(OBJDIR)/ -c $(CFLAGS) $(JSDLL_CFLAGS) $(OPTIMIZER) $<
+
+$(OBJDIR)/jsinterp.obj: jsinterp.cpp jsinterp.h
+	@$(MAKE_OBJDIR)
+	$(CXX) -Fo$(OBJDIR)/ -c $(CFLAGS) $(JSDLL_CFLAGS) $(INTERP_OPTIMIZER) jsinterp.cpp
+
+$(OBJDIR)/jsbuiltins.obj: jsbuiltins.cpp jsinterp.h
+	@$(MAKE_OBJDIR)
+	$(CXX) -Fo$(OBJDIR)/ -c $(CFLAGS) $(JSDLL_CFLAGS) $(BUILTINS_OPTIMIZER) jsbuiltins.cpp
+
+$(OBJDIR)/%.obj: %.cpp
+	@$(MAKE_OBJDIR)
+	$(CXX) -Fo$(OBJDIR)/ -c $(CFLAGS) $(JSDLL_CFLAGS) $(OPTIMIZER) $<
+
+$(OBJDIR)/js.obj: js.cpp
+	@$(MAKE_OBJDIR)
+	$(CXX) -Fo$(OBJDIR)/ -c $(CFLAGS) $(OPTIMIZER) $<
+
+ifeq ($(OS_ARCH),OS2)
+$(LIBRARY): $(LIB_OBJS)
+	$(AR) $@ $? $(AR_OS2_SUFFIX)
+	$(RANLIB) $@
+else
+ifdef USE_MSVC
+$(SHARED_LIBRARY): $(LIB_OBJS)
+	link.exe $(LIB_LINK_FLAGS) /base:0x61000000 $(OTHER_LIBS) \
+	    /out:"$@" /pdb:none\
+	    /implib:"$(OBJDIR)/$(@F:.dll=.lib)" $^
+else
+$(LIBRARY): $(LIB_OBJS)
+	$(AR) rv $@ $?
+	$(RANLIB) $@
+
+$(SHARED_LIBRARY): $(LIB_OBJS)
+	$(MKSHLIB) -o $@ $(LIB_OBJS) $(LDFLAGS) $(OTHER_LIBS)
+endif
+endif
+
+# Java stuff
+$(CLASSDIR)/$(OBJDIR)/$(JARPATH)/%.class: %.java
+	mkdir -p $(@D)
+	$(JAVAC) $(JAVAC_FLAGS) $<
+
+define MAKE_OBJDIR
+if test ! -d $(@D); then rm -rf $(@D); mkdir -p $(@D); fi
+endef
+
+ifdef DIRS
+LOOP_OVER_DIRS		=					\
+	@for d in $(DIRS); do					\
+		if test -d $$d; then				\
+			set -e;			\
+			echo "cd $$d; $(MAKE) -f Makefile.ref $@"; 		\
+			cd $$d; $(MAKE) -f Makefile.ref $@; cd ..;	\
+			set +e;					\
+		else						\
+			echo "Skipping non-directory $$d...";	\
+		fi;						\
+	done
+endif
+
+ifdef PREDIRS
+LOOP_OVER_PREDIRS	=					\
+	@for d in $(PREDIRS); do				\
+		if test -d $$d; then				\
+			set -e;			\
+			echo "cd $$d; $(MAKE) -f Makefile.ref $@"; 		\
+			cd $$d; $(MAKE) -f Makefile.ref $@; cd ..;	\
+			set +e;					\
+		else						\
+			echo "Skipping non-directory $$d...";	\
+		fi;						\
+	done
+endif
+
+export:
+	+$(LOOP_OVER_PREDIRS)	
+	mkdir -p $(DIST)/include $(DIST)/$(LIBDIR) $(DIST)/bin
+ifneq "$(strip $(HFILES))" ""
+	$(CP) $(HFILES) $(DIST)/include
+endif
+ifneq "$(strip $(LIBRARY))" ""
+	$(CP) $(LIBRARY) $(DIST)/$(LIBDIR)
+endif
+ifneq "$(strip $(JARS))" ""
+	$(CP) $(JARS) $(DIST)/$(LIBDIR)
+endif
+ifneq "$(strip $(SHARED_LIBRARY))" ""
+	$(CP) $(SHARED_LIBRARY) $(DIST)/$(LIBDIR)
+endif
+ifneq "$(strip $(PROGRAM))" ""
+	$(CP) $(PROGRAM) $(DIST)/bin
+endif
+	+$(LOOP_OVER_DIRS)
+
+clean:
+	+$(LOOP_OVER_PREDIRS)
+	rm -rf $(OBJS) $(GARBAGE)
+
+clobber:
+	+$(LOOP_OVER_PREDIRS)
+	rm -rf $(OBJS) $(TARGETS) $(DEPENDENCIES) $(GARBAGE)
+	if test -d $(OBJDIR); then rmdir $(OBJDIR); fi
+
+tar:
+	tar cvf $(TARNAME) $(TARFILES)
+	gzip $(TARNAME)
+
diff -r a4343d61f6ee js/src/trace-test.js
--- a/js/src/trace-test.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/trace-test.js	Sat Nov 15 19:43:13 2008 -0500
@@ -1543,19 +1543,19 @@ function testNestedExitStackOuter() {
     for (var k = 1; k <= RUNLOOP; ++k) {
       counter = testNestedExitStackInner(j, counter);
     }
   }
   return counter;
 }
 testNestedExitStackOuter.expected = 81;
 testNestedExitStackOuter.jitstats = {
-    recorderStarted: 3,
-    recorderAborted: 0,
-    traceTriggered: 7
+    recorderStarted: 5,
+    recorderAborted: 2,
+    traceTriggered: 9
 };
 test(testNestedExitStackOuter);
 
 function testHOTLOOPSize() {
     return HOTLOOP > 1;
 }
 testHOTLOOPSize.expected = true;
 test(testHOTLOOPSize);
@@ -1773,16 +1773,103 @@ function testDestructuring() {
     for (var i = 0; i < HOTLOOP + 1; ++i) {
         var [r, g, b] = [1, 1, 1];
         t += r + g + b;
     }
     return t
 }
 testDestructuring.expected = (HOTLOOP + 1) * 3;
 test(testDestructuring);
+
+function loopWithUndefined1(t, val) {
+    var a = new Array(6);
+    for (var i = 0; i < 6; i++)
+        a[i] = (t > val);
+    return a;
+}
+loopWithUndefined1(5.0, 2);     //compile version with val=int
+
+function testLoopWithUndefined1() {
+    return loopWithUndefined1(5.0).join(",");  //val=undefined
+};
+testLoopWithUndefined1.expected = "false,false,false,false,false,false";
+test(testLoopWithUndefined1);
+
+function loopWithUndefined2(t, dostuff, val) {
+    var a = new Array(6);
+    for (var i = 0; i < 6; i++) {
+        if (dostuff) {
+            val = 1; 
+            a[i] = (t > val);
+        } else {
+            a[i] = (val == undefined);
+        }
+    }
+    return a;
+}
+function testLoopWithUndefined2() {
+    var a = loopWithUndefined2(5.0, true, 2);
+    var b = loopWithUndefined2(5.0, true);
+    var c = loopWithUndefined2(5.0, false, 8);
+    var d = loopWithUndefined2(5.0, false);
+    return [a[0], b[0], c[0], d[0]].join(",");
+}
+testLoopWithUndefined2.expected = "true,true,false,true";
+test(testLoopWithUndefined2);
+
+//test no multitrees assert
+function testBug462388() {
+    var c = 0, v; for each (let x in ["",v,v,v]) { for (c=0;c<4;++c) { } }
+    return true;
+}
+testBug462388.expected = true;
+test(testBug462388);
+
+//test no multitrees assert
+function testBug462407() {
+    for each (let i in [0, {}, 0, 1.5, {}, 0, 1.5, 0, 0]) { }
+    return true;
+}
+testBug462407.expected = true;
+test(testBug462407);
+
+//test no multitrees assert
+function testBug463490() {
+    function f(a, b, d) {
+        for (var i = 0; i < 10; i++) {
+            if (d)
+                b /= 2;
+        }
+        return a + b;
+    }
+    //integer stable loop
+    f(2, 2, false);
+    //double stable loop
+    f(3, 4.5, false);
+    //integer unstable branch
+    f(2, 2, true);
+    return true;
+};
+testBug463490.expected = true;
+test(testBug463490);
+
+// Test no assert (bug 464089)
+function shortRecursiveLoop(b, c) {
+    for (var i = 0; i < c; i++) {
+        if (b)
+            shortRecursiveLoop(c - 1);
+    }
+}
+function testClosingRecursion() {
+    shortRecursiveLoop(false, 1);
+    shortRecursiveLoop(true, 3);
+    return true;
+}
+testClosingRecursion.expected = true;
+test(testClosingRecursion);
 
 // BEGIN MANDELBROT STUFF
 // XXXbz I would dearly like to wrap it up into a function to avoid polluting
 // the global scope, but the function ends up heavyweight, and then we lose on
 // the jit.
 load("mandelbrot-results.js");
 //function testMandelbrotAll() {
   // Configuration options that affect which codepaths we follow.
@@ -2023,24 +2110,16 @@ load("mandelbrot-results.js");
 
   escape = escapeNorm2;
   doImageData = false;  // avoidSparseArray doesn't matter here
   test(createMandelSet);
 //}
 //testMandelbrotAll();
 // END MANDELBROT STUFF
 
-/* Keep this test last, since it screws up all for...in loops after it */
-function testGlobalProtoAccess() {
-    return "ok";
-}
-this.__proto__.a = 3; for (var j = 0; j < 4; ++j) { [a]; }
-testGlobalProtoAccess.expected = "ok";
-test(testGlobalProtoAccess);
-
 function testNewDate()
 {
     // Accessing global.Date for the first time will change the global shape,
     // so do it before the loop starts; otherwise we have to loop an extra time
     // to pick things up.
     var start = new Date();
     var time = new Date();
     for (var j = 0; j < RUNLOOP; ++j) {
@@ -2163,17 +2242,22 @@ function testSubstring() {
     }
     return actual;
 }
 testSubstring.expected = "";
 test(testSubstring);
 
 function testForInLoopChangeIteratorType() {
     for(y in [0,1,2]) y = NaN;
-    (function(){ [].__proto__.u = void 0; for (let y in [5,6,7,8]) y = NaN; })()
+    (function(){
+        [].__proto__.u = void 0;
+        for (let y in [5,6,7,8])
+            y = NaN;
+        delete [].__proto__.u;
+    })()
     return "ok";
 }
 testForInLoopChangeIteratorType.expected = "ok";
 test(testForInLoopChangeIteratorType);
 
 function testGrowDenseArray() {
     var a = new Array();
     for (var i = 0; i < 10; ++i)
@@ -2194,11 +2278,116 @@ function testCallProtoMethod() {
     var s = '';
     for (var i = 0; i < a.length; i++)
         s += a[i].getName();
     return s;
 }
 testCallProtoMethod.expected = 'XXXXY';
 test(testCallProtoMethod);
 
+function testTypeUnstableForIn() {
+    var a = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16];
+    var x = 0;
+    for (var i in a) {
+        i = parseInt(i);
+        x++;
+    }
+    return x;
+}
+testTypeUnstableForIn.expected = 16;
+test(testTypeUnstableForIn);
+
+function testAddUndefined() {
+    for (var j = 0; j < 3; ++j)
+        (0 + void 0) && 0;
+}
+test(testAddUndefined);
+
+function testStringify() {
+    var t = true, f = false, u = undefined, n = 5, d = 5.5, s = "x";
+    var a = [];
+    for (var i = 0; i < 10; ++i) {
+	a[0] = "" + t;
+	a[1] = t + "";
+	a[2] = "" + f;
+	a[3] = f + "";
+	a[4] = "" + u;
+	a[5] = u + "";
+	a[6] = "" + n;
+	a[7] = n + "";
+	a[8] = "" + d;
+	a[9] = d + "";
+	a[10] = "" + s;
+	a[11] = s + "";
+    }
+    return a.join(",");
+}
+testStringify.expected = "true,true,false,false,undefined,undefined,5,5,5.5,5.5,x,x";
+test(testStringify);
+
+function testObjectToString() {
+    var o = {toString: function()"foo"};
+    var s = "";
+    for (var i = 0; i < 10; i++)
+        s += o;
+    return s;
+}
+testObjectToString.expected = "foofoofoofoofoofoofoofoofoofoo";
+test(testObjectToString);
+
+function testObjectToNumber() {
+    var o = {valueOf: function()-3};
+    var x = 0;
+    for (var i = 0; i < 10; i++)
+        x -= o;
+    return x;
+}
+testObjectToNumber.expected = 30;
+test(testObjectToNumber);
+
+function my_iterator_next() {
+    if (this.i == 10) {
+        this.i = 0;
+        throw this.StopIteration;
+    }
+    return this.i++;
+}
+function testCustomIterator() {
+    var o = {
+        __iterator__: function () {
+            return {
+                i: 0,
+                next: my_iterator_next,
+                StopIteration: StopIteration
+            };
+        }
+    };
+    var a=[];
+    for (var k = 0; k < 100; k += 10) {
+        for(var j in o) {
+            a[k + (j >> 0)] = j*k;
+        }
+    }
+    return a.join();
+}
+testCustomIterator.expected = "0,0,0,0,0,0,0,0,0,0,0,10,20,30,40,50,60,70,80,90,0,20,40,60,80,100,120,140,160,180,0,30,60,90,120,150,180,210,240,270,0,40,80,120,160,200,240,280,320,360,0,50,100,150,200,250,300,350,400,450,0,60,120,180,240,300,360,420,480,540,0,70,140,210,280,350,420,490,560,630,0,80,160,240,320,400,480,560,640,720,0,90,180,270,360,450,540,630,720,810";
+test(testCustomIterator);
+
+function bug464403() {
+    print(8);
+    var u = [print, print, function(){}]
+    for each (x in u) for (u.e in [1,1,1,1]);
+    return "ok";
+}
+bug464403.expected = "ok";
+test(bug464403);
+
+/* NOTE: Keep this test last, since it screws up all for...in loops after it. */
+function testGlobalProtoAccess() {
+    return "ok";
+}
+this.__proto__.a = 3; for (var j = 0; j < 4; ++j) { [a]; }
+testGlobalProtoAccess.expected = "ok";
+test(testGlobalProtoAccess);
+
 /* Keep these at the end so that we can see the summary after the trace-debug spew. */
 print("\npassed:", passes.length && passes.join(","));
 print("\nFAILED:", fails.length && fails.join(","));
diff -r a4343d61f6ee js/src/xpconnect/src/XPCNativeWrapper.cpp
--- a/js/src/xpconnect/src/XPCNativeWrapper.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/xpconnect/src/XPCNativeWrapper.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -178,20 +178,16 @@ ShouldBypassNativeWrapper(JSContext *cx,
   XPC_NW_BYPASS_BASE(cx, obj,                                                 \
     JSClass *clasp_ = STOBJ_GET_CLASS(obj);                                  \
     return !clasp_->hook || clasp_->hook args;                                \
   )
 
 static JSBool
 XPC_NW_toString(JSContext *cx, JSObject *obj, uintN argc, jsval *argv,
                 jsval *rval);
-
-static JSBool
-XPCNativeWrapperCtor(JSContext *cx, JSObject *obj, uintN argc, jsval *argv,
-                     jsval *rval);
 
 static inline
 JSBool
 ThrowException(nsresult ex, JSContext *cx)
 {
   XPCThrower::Throw(ex, cx);
 
   return JS_FALSE;
@@ -785,17 +781,17 @@ MirrorWrappedNativeParent(JSContext *cx,
       *result = XPCNativeWrapper::GetNewOrUsed(cx, parent_wrapper, nsnull);
       if (!*result)
         return JS_FALSE;
     }
   }
   return JS_TRUE;
 }
 
-static JSBool
+JSBool
 XPCNativeWrapperCtor(JSContext *cx, JSObject *obj, uintN argc, jsval *argv,
                      jsval *rval)
 {
   if (argc < 1) {
     return ThrowException(NS_ERROR_XPC_NOT_ENOUGH_ARGS, cx);
   }
 
   // |obj| almost always has the wrong proto and parent so we have to create
diff -r a4343d61f6ee js/src/xpconnect/src/XPCWrapper.h
--- a/js/src/xpconnect/src/XPCWrapper.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/xpconnect/src/XPCWrapper.h	Sat Nov 15 19:43:13 2008 -0500
@@ -75,16 +75,20 @@ XPC_XOW_RewrapIfNeeded(JSContext *cx, JS
 XPC_XOW_RewrapIfNeeded(JSContext *cx, JSObject *wrapperObj, jsval *vp);
 
 JSBool
 XPC_XOW_WrapperMoved(JSContext *cx, XPCWrappedNative *innerObj,
                      XPCWrappedNativeScope *newScope);
 
 nsresult
 CanAccessWrapper(JSContext *cx, JSObject *wrappedObj);
+
+JSBool
+XPCNativeWrapperCtor(JSContext *cx, JSObject *obj, uintN argc, jsval *argv,
+                     jsval *rval);
 
 inline JSBool
 XPC_XOW_ClassNeedsXOW(const char *name)
 {
   switch (*name) {
     case 'W':
       return strcmp(++name, "indow") == 0;
     case 'L':
diff -r a4343d61f6ee js/src/xpconnect/src/xpccomponents.cpp
--- a/js/src/xpconnect/src/xpccomponents.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/xpconnect/src/xpccomponents.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -43,16 +43,17 @@
 /* The "Components" xpcom objects for JavaScript. */
 
 #include "xpcprivate.h"
 #include "nsReadableUtils.h"
 #include "xpcIJSModuleLoader.h"
 #include "nsIScriptObjectPrincipal.h"
 #include "nsIDOMWindow.h"
 #include "xpcJSWeakReference.h"
+#include "XPCWrapper.h"
 
 #ifdef MOZ_JSLOADER
 #include "mozJSComponentLoader.h"
 #endif
 
 /***************************************************************************/
 // stuff used by all
 
@@ -2718,16 +2719,31 @@ nsXPCComponents_Utils::GetSandbox(nsIXPC
 {
     NS_ENSURE_ARG_POINTER(aSandbox);
     if (!mSandbox && !(mSandbox = new nsXPCComponents_utils_Sandbox())) {
         *aSandbox = nsnull;
         return NS_ERROR_OUT_OF_MEMORY;
     }
     NS_ADDREF(*aSandbox = mSandbox);
     return NS_OK;
+}
+
+static JSBool
+MethodWrapper(JSContext *cx, JSObject *obj, uintN argc, jsval *argv,
+              jsval *rval)
+{
+    jsval v;
+    if (!JS_GetReservedSlot(cx, JSVAL_TO_OBJECT(argv[-2]), 0, &v) ||
+        !JS_CallFunctionValue(cx, obj, v, argc, argv, rval)) {
+        return JS_FALSE;
+    }
+
+    if (JSVAL_IS_PRIMITIVE(*rval))
+       return JS_TRUE;
+    return XPCNativeWrapperCtor(cx, nsnull, 1, rval, rval);
 }
 
 /* void lookupMethod (); */
 NS_IMETHODIMP
 nsXPCComponents_Utils::LookupMethod()
 {
     nsresult rv;
 
@@ -2826,20 +2842,45 @@ nsXPCComponents_Utils::LookupMethod()
         return NS_ERROR_XPC_BAD_CONVERT_JS;
 
     // get (and perhaps lazily create) the member's cloned function
     jsval funval;
     if(!member->NewFunctionObject(inner_cc, iface, wrapper->GetFlatJSObject(),
                                   &funval))
         return NS_ERROR_XPC_BAD_CONVERT_JS;
 
-    // return the function and let xpconnect know we did so
+    // Stick the function in the return value. This roots it.
     *retval = funval;
+
+    // Callers of this method are implicitly buying into
+    // XPCNativeWrapper-like protection. The easiest way
+    // to enforce this is to use our own wrapper.
+    // Note: We use the outer call context to ensure that we wrap
+    // the function in the right scope.
+    NS_ASSERTION(JSVAL_IS_OBJECT(funval), "Function is not an object");
+    JSContext *outercx;
+    cc->GetJSContext(&outercx);
+    JSFunction *oldfunction = JS_ValueToFunction(outercx, funval);
+    NS_ASSERTION(oldfunction, "Function is not a function");
+
+    JSFunction *f = JS_NewFunction(outercx, MethodWrapper,
+                                   JS_GetFunctionArity(oldfunction), 0,
+                                   JS_GetScopeChain(outercx),
+                                   JS_GetFunctionName(oldfunction));
+    if(!f)
+        return NS_ERROR_FAILURE;
+
+    JSObject *funobj = JS_GetFunctionObject(f);
+    if(!JS_SetReservedSlot(outercx, funobj, 0, funval))
+        return NS_ERROR_FAILURE;
+
+    *retval = OBJECT_TO_JSVAL(funobj);
+
+    // Tell XPConnect that we returned the function through the call context.
     cc->SetReturnValueWasSet(PR_TRUE);
-
     return NS_OK;
 }
 
 /* void reportError (); */
 NS_IMETHODIMP
 nsXPCComponents_Utils::ReportError()
 {
     // This function shall never fail! Silently eat any failure conditions.
@@ -3005,30 +3046,30 @@ SandboxFunForwarder(JSContext *cx, JSObj
     jsval v;
     if (!JS_GetReservedSlot(cx, JSVAL_TO_OBJECT(argv[-2]), 0, &v) ||
         !JS_CallFunctionValue(cx, obj, v, argc, argv, rval)) {
         return JS_FALSE;
     }
 
     if (JSVAL_IS_PRIMITIVE(*rval))
         return JS_TRUE; // nothing more to do.
-    
+
     XPCThrower::Throw(NS_ERROR_NOT_IMPLEMENTED, cx);
     return JS_FALSE;
 }
 
 static JSBool
 SandboxImport(JSContext *cx, JSObject *obj, uintN argc, jsval *argv,
               jsval *rval)
 {
     if (argc < 1) {
         XPCThrower::Throw(NS_ERROR_INVALID_ARG, cx);
         return JS_FALSE;
     }
-    
+
     JSFunction *fun = JS_ValueToFunction(cx, argv[0]);
     if (!fun) {
         XPCThrower::Throw(NS_ERROR_INVALID_ARG, cx);
         return JS_FALSE;
     }
 
     JSString *funname;
     if (argc > 1) {
diff -r a4343d61f6ee js/src/xpconnect/src/xpcconvert.cpp
--- a/js/src/xpconnect/src/xpcconvert.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/xpconnect/src/xpcconvert.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -43,16 +43,17 @@
 /* Data conversion between native and JavaScript types. */
 
 #include "xpcprivate.h"
 #include "nsString.h"
 #include "XPCNativeWrapper.h"
 #include "nsIAtom.h"
 #include "XPCWrapper.h"
 #include "nsJSPrincipals.h"
+#include "nsWrapperCache.h"
 
 //#define STRICT_CHECK_OF_UNICODE
 #ifdef STRICT_CHECK_OF_UNICODE
 #define ILLEGAL_RANGE(c) (0!=((c) & 0xFF80))
 #else // STRICT_CHECK_OF_UNICODE
 #define ILLEGAL_RANGE(c) (0!=((c) & 0xFF00))
 #endif // STRICT_CHECK_OF_UNICODE
 
@@ -1086,25 +1087,40 @@ XPCConvert::NativeInterface2JSObject(XPC
         if(!xpcscope)
             return JS_FALSE;
 
         AutoMarkingNativeInterfacePtr iface(ccx);
         iface = XPCNativeInterface::GetNewOrUsed(ccx, iid);
         if(!iface)
             return JS_FALSE;
 
+        nsresult rv;
         XPCWrappedNative* wrapper;
-        nsresult rv = XPCWrappedNative::GetNewOrUsed(ccx, src, xpcscope,
-                                                     iface, isGlobal,
-                                                     &wrapper);
+        nsWrapperCache* cache = nsnull;
+        CallQueryInterface(src, &cache);
+        if(cache &&
+           (wrapper = static_cast<XPCWrappedNative*>(cache->GetWrapper())))
+        {
+            NS_ADDREF(wrapper);
+            wrapper->FindTearOff(ccx, iface, JS_FALSE, &rv);
+            if(NS_FAILED(rv))
+                NS_RELEASE(wrapper);
+        }
+        else
+        {
+            rv = XPCWrappedNative::GetNewOrUsed(ccx, src, xpcscope, iface,
+                                                isGlobal, &wrapper);
+        }
+
         if(pErr)
             *pErr = rv;
         if(NS_SUCCEEDED(rv) && wrapper)
         {
             uint32 flags = 0;
+            JSObject *flat = wrapper->GetFlatJSObject();
             if (allowNativeWrapper && wrapper->GetScope() != xpcscope)
             {
                 // Cross scope access detected. Check if chrome code
                 // is accessing non-chrome objects, and if so, wrap
                 // the XPCWrappedNative with an XPCNativeWrapper to
                 // prevent user-defined properties from shadowing DOM
                 // properties from chrome code.
 
@@ -1152,17 +1168,16 @@ XPCConvert::NativeInterface2JSObject(XPC
                         callee = nsnull;
                     }
                 }
                 // else don't create XPCNativeWrappers, since we have
                 // no idea what's calling what here.
 
                 flags = script ? JS_GetScriptFilenameFlags(script) : 0;
                 NS_ASSERTION(flags != JSFILENAME_NULL, "null script filename");
-                JSObject *flat = wrapper->GetFlatJSObject();
 
                 if(!JS_IsSystemObject(ccx, flat))
                 {
                     if(flags & JSFILENAME_PROTECTED)
                     {
 #ifdef DEBUG_XPCNativeWrapper
                         {
                             char *s = wrapper->ToString(ccx);
@@ -1260,17 +1275,16 @@ XPCConvert::NativeInterface2JSObject(XPC
 
                     NS_ADDREF(objHolder);
                     NS_RELEASE(wrapper);
                     *dest = objHolder;
                     return JS_TRUE;
                 }
             }
 
-            JSObject *flat = wrapper->GetFlatJSObject();
             const char *name = STOBJ_GET_CLASS(flat)->name;
             if(allowNativeWrapper &&
                !(flags & JSFILENAME_SYSTEM) &&
                !JS_IsSystemObject(ccx, flat) &&
                XPC_XOW_ClassNeedsXOW(name))
             {
                 jsval v = OBJECT_TO_JSVAL(flat);
                 XPCJSObjectHolder *objHolder = nsnull;
diff -r a4343d61f6ee js/src/xpconnect/src/xpcwrappednative.cpp
--- a/js/src/xpconnect/src/xpcwrappednative.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/src/xpconnect/src/xpcwrappednative.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -40,16 +40,17 @@
  * ***** END LICENSE BLOCK ***** */
 
 /* Wrapper object for reflecting native xpcom objects into JavaScript. */
 
 #include "xpcprivate.h"
 #include "nsCRT.h"
 #include "XPCNativeWrapper.h"
 #include "XPCWrapper.h"
+#include "nsWrapperCache.h"
 
 /***************************************************************************/
 
 NS_IMPL_CYCLE_COLLECTION_CLASS(XPCWrappedNative)
 
 NS_IMETHODIMP
 NS_CYCLE_COLLECTION_CLASSNAME(XPCWrappedNative)::RootAndUnlinkJSObjects(void *p)
 {
@@ -584,43 +585,59 @@ nsresult
 nsresult
 XPCWrappedNative::GetUsedOnly(XPCCallContext& ccx,
                               nsISupports* Object,
                               XPCWrappedNativeScope* Scope,
                               XPCNativeInterface* Interface,
                               XPCWrappedNative** resultWrapper)
 {
     NS_ASSERTION(Object, "XPCWrappedNative::GetUsedOnly was called with a null Object");
-    nsCOMPtr<nsISupports> identity;
-#ifdef XPC_IDISPATCH_SUPPORT
-    // XXX See GetNewOrUsed for more info on this
-    if(Interface->GetIID()->Equals(NSID_IDISPATCH))
-        identity = Object;
-    else
-#endif
-        identity = do_QueryInterface(Object);
-
-    if(!identity)
-    {
-        NS_ERROR("This XPCOM object fails in QueryInterface to nsISupports!");
-        return NS_ERROR_FAILURE;
-    }
 
     XPCWrappedNative* wrapper;
-    Native2WrappedNativeMap* map = Scope->GetWrappedNativeMap();
-
-    {   // scoped lock
-        XPCAutoLock lock(Scope->GetRuntime()->GetMapLock());
-        wrapper = map->Find(identity);
+    nsWrapperCache* cache = nsnull;
+    CallQueryInterface(Object, &cache);
+    if(cache)
+    {
+        wrapper = static_cast<XPCWrappedNative*>(cache->GetWrapper());
         if(!wrapper)
         {
             *resultWrapper = nsnull;
             return NS_OK;
         }
         NS_ADDREF(wrapper);
+    }
+    else
+    {
+        nsCOMPtr<nsISupports> identity;
+#ifdef XPC_IDISPATCH_SUPPORT
+        // XXX See GetNewOrUsed for more info on this
+        if(Interface->GetIID()->Equals(NSID_IDISPATCH))
+            identity = Object;
+        else
+#endif
+            identity = do_QueryInterface(Object);
+
+        if(!identity)
+        {
+            NS_ERROR("This XPCOM object fails in QueryInterface to nsISupports!");
+            return NS_ERROR_FAILURE;
+        }
+
+        Native2WrappedNativeMap* map = Scope->GetWrappedNativeMap();
+
+        {   // scoped lock
+            XPCAutoLock lock(Scope->GetRuntime()->GetMapLock());
+            wrapper = map->Find(identity);
+            if(!wrapper)
+            {
+                *resultWrapper = nsnull;
+                return NS_OK;
+            }
+            NS_ADDREF(wrapper);
+        }
     }
 
     nsresult rv;
     if(!wrapper->FindTearOff(ccx, Interface, JS_FALSE, &rv))
     {
         NS_RELEASE(wrapper);
         NS_ASSERTION(NS_FAILED(rv), "returning NS_OK on failure");
         return rv;
diff -r a4343d61f6ee js/tests/e4x/decompilation/regress-461233.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/e4x/decompilation/regress-461233.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,56 @@
+/* -*- Mode: java; tab-width:8; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+gTestfile = 'regress-461233.js';
+
+var summary = 'Decompilation of ({0: (4, <></>)})';
+var BUGNUMBER = 461233;
+var actual = '';
+var expect = '';
+
+printBugNumber(BUGNUMBER);
+START(summary);
+
+var f = (function() { return ({0: (4, <></>) }); });
+
+expect = 'function() { return {0: (4, <></>) }; }';
+actual = f + '';
+
+compareSource(expect, actual, expect)
+
+END();
diff -r a4343d61f6ee js/tests/js1_5/Regress/regress-458851.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/Regress/regress-458851.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,65 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Andreas Gal
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-458851.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 458851;
+var summary = 'TM: for-in loops should not skip every other value sometimes';
+var actual = '';
+var expect = '';
+
+printBugNumber(BUGNUMBER);
+printStatus (summary);
+ 
+jit(true);
+
+function f() {
+  var a = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16];
+  var x = 0;
+  for (var i in a) {
+    i = parseInt(i);
+    x++;
+  }
+  print(actual = x);
+}
+
+expect = 16;
+f();
+
+jit(false);
+
+reportCompare(expect, actual, summary);
diff -r a4343d61f6ee js/tests/js1_5/Regress/regress-459628.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/Regress/regress-459628.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,69 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-459628.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 459628;
+var summary = 'Do not assert: JSVAL_IS_VOID(STOBJ_GET_SLOT(obj, map->freeslot))';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  jit(true);
+
+(function() { 
+  for (var odjoff = 0; odjoff < 4; ++odjoff) { 
+    new Date()[0] = 3; 
+  } 
+})();
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r a4343d61f6ee js/tests/js1_5/Regress/regress-460024.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/Regress/regress-460024.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,74 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Sylvain Pasche
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-460024.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 460024;
+var summary = 'Regression from bug 451154';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  expect = 'PASS';
+  actual = 'FAIL';
+
+  jit(true);
+
+  var js = 'Function.prototype.inherits = function(a) {' +
+  '  actual = "PASS";' +
+  '};' +
+  'function f() { }' +
+  'f.inherits();';
+  function doeval(callback) { callback(js) };
+  doeval(eval);
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r a4343d61f6ee js/tests/js1_5/Regress/regress-460117.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/Regress/regress-460117.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,80 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): David Savage
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-460117.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 460117;
+var summary = 'TM: hasOwnProperty with JIT';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  function t(o, proplist) {
+    var props=proplist.split(/\s+/g);
+    for (var i=0, len=props.length; i<len; i++) {
+      if (o.hasOwnProperty(props[i])) {
+        // do something
+      } else {
+        actual += (props[i]+': '+o.hasOwnProperty(props[i]));
+      }
+    }
+  };
+
+  t({ bar: 123, baz: 123, quux: 123 }, 'bar baz quux');
+
+  reportCompare(expect, actual, summary + ' : nonjit');
+
+  jit(true);
+
+  t({ bar: 123, baz: 123, quux: 123 }, 'bar baz quux');
+
+  jit(false);
+
+  reportCompare(expect, actual, summary + ' : jit');
+
+  exitFunc ('test');
+}
diff -r a4343d61f6ee js/tests/js1_5/Regress/regress-461307.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/Regress/regress-461307.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,66 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-461307.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 461307;
+var summary = 'Do not crash @ QuoteString';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  jit(true);
+
+  print(function() { for(/x/[''] in []) { } });
+
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r a4343d61f6ee js/tests/js1_5/Regress/regress-461723.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/Regress/regress-461723.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,65 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-461723.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 461723;
+var summary = 'Do not assert: (m != JSVAL_INT) || isInt32(*vp)';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  jit(true);
+
+  for (var j = 0; j < 30; ++j) { (0 + void 0) && 0; }
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r a4343d61f6ee js/tests/js1_5/Regress/regress-462292.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/Regress/regress-462292.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,67 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-462292.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 462292;
+var summary = 'Do not assert: pn->pn_op == JSOP_CALL || pn->pn_op == JSOP_EVAL';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  try
+  {
+    [].apply() = 1;
+  }
+  catch(ex)
+  {
+  }
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r a4343d61f6ee js/tests/js1_5/Regress/regress-462989.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/Regress/regress-462989.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,66 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-462989.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 462989;
+var summary = 'Do not assert: need a way to EOT now, since this is trace end';
+var actual = '';
+var expect = '';
+
+printBugNumber(BUGNUMBER);
+printStatus (summary);
+ 
+jit(true);
+
+function a()
+{
+  "".split(";");
+  this.v = true;
+}
+
+function b()
+{    
+  var z = { t: function() { for (var i = 0; i < 5; i++) { a(); } } };
+  z.t();
+}
+
+b();
+
+jit(false);
+
+reportCompare(expect, actual, summary);
diff -r a4343d61f6ee js/tests/js1_5/Regress/regress-463259.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/Regress/regress-463259.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,62 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-463259.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 463259;
+var summary = 'Do not assert: VALUE_IS_FUNCTION(cx, fval)';
+var actual = '';
+var expect = '';
+
+printBugNumber(BUGNUMBER);
+printStatus (summary);
+ 
+jit(true);
+
+try
+{
+  (function(){
+    eval("(function(){ for (var j=0;j<4;++j) if (j==3) undefined(); })();");
+  })();
+}
+catch(ex)
+{
+}
+
+jit(false);
+
+reportCompare(expect, actual, summary);
diff -r a4343d61f6ee js/tests/js1_5/decompilation/regress-460501.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/decompilation/regress-460501.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,71 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-460501.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 460501;
+var summary = 'Decompilation of constant folding with && and valueOf, eval';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  var f = (function() { if ((1 && w.valueOf())) {} });
+
+  expect = 'function() { if (w.valueOf()) {} }';
+  actual = f + '';
+
+  compareSource(expect, actual, summary);
+
+  var f = (function() { if ((1 && w.eval())) {} });
+
+  expect = 'function() { if (w.eval()) {} }';
+  actual = f + '';
+
+  compareSource(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r a4343d61f6ee js/tests/js1_5/decompilation/regress-461108.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/decompilation/regress-461108.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,64 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-461108.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 461108;
+var summary = 'Decompilation of for (i = 0; a = as[i]; ++i)';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  var f = (function() {for (i = 0; attr = attrs[i]; ++i) {} });
+
+  expect = 'function() {for (i = 0; attr = attrs[i]; ++i) {} }';
+  actual = f + '';
+
+  compareSource(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r a4343d61f6ee js/tests/js1_5/decompilation/regress-461110.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/decompilation/regress-461110.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,64 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-461110.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 461110;
+var summary = 'Decompilation of a += b = 3';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  var f = (function() { a += b = 3 });
+
+  expect = 'function() { a += b = 3; }';
+  actual = f + '';
+
+  compareSource(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r a4343d61f6ee js/tests/js1_5/decompilation/regress-461111.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/decompilation/regress-461111.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,64 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-461111.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 461111;
+var summary = 'Decompilation of if (a,b)';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  var f = (function() { if(a, b) { } });
+
+  expect = 'function() { if(a, b) { } }';
+  actual = f + '';
+
+  compareSource(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r a4343d61f6ee js/tests/js1_7/regress/regress-461235.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_7/regress/regress-461235.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,65 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-461235.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 461235;
+var summary = 'Do not assert: pos == GET_UINT16(pc)';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  jit(true);
+
+  print(function() { [1 for (b in [])]; var c; });
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r a4343d61f6ee js/tests/js1_7/regress/regress-461945.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_7/regress/regress-461945.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,65 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-461945.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 461945;
+var summary = 'Do not assert: !ti->stackTypeMap.matches(ti_other->stackTypeMap)';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  jit(true);
+
+  [1 for each (x in {a:1, b:1, c:"", d:"", e:1, f:"", g:""}) if (0)];
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r a4343d61f6ee js/tests/js1_7/regress/regress-462071.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_7/regress/regress-462071.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,65 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-462071.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 462071;
+var summary = 'Do not assert: !ti->stackTypeMap.matches(ti_other->stackTypeMap)';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  jit(true);
+
+  for each (let i in [{}, 0, 0, {}, 0, {}, 0]) { }
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r a4343d61f6ee js/tests/js1_7/regress/regress-462282.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_7/regress/regress-462282.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,65 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-462282.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 462282;
+var summary = 'Do not assert: !ti->stackTypeMap.matches(ti_other->stackTypeMap)';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  jit(true);
+
+  for each (let i in [0, 0, 0, "", 0, 0, "", 0, 0, "", 0]) { }
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r a4343d61f6ee js/tests/js1_7/regress/regress-462388.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_7/regress/regress-462388.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,65 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-462388.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 462388;
+var summary = 'Do not assert: JSVAL_TAG(v) == JSVAL_STRING';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  jit(true);
+
+  var c = 0, v; for each (let x in ["",v,v,v]) { for (c=0;c<4;++c) { } }
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r a4343d61f6ee js/tests/js1_7/regress/regress-462407.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_7/regress/regress-462407.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,54 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-462407.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 462407;
+var summary = 'Do not assert: !ti->stackTypeMap.matches(ti_other->stackTypeMap)';
+var actual = '';
+var expect = '';
+
+printBugNumber(BUGNUMBER);
+printStatus (summary);
+
+jit(true);
+
+(function f() { for each (let i in [0, {}, 0, 1.5, {}, 0, 1.5, 0, 0]) { }})();
+
+jit(false);
+
+reportCompare(expect, actual, summary);
diff -r a4343d61f6ee js/tests/js1_8/decompilation/regress-461233.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_8/decompilation/regress-461233.js	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,64 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jason Orendorff
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-461233.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 461233;
+var summary = 'Decompilation of function () [(1,2)]';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  f = (function() [(1, 2)]);
+
+  expect = 'function() [(1, 2)]';
+  actual = f + '';
+
+  compareSource(expect, actual, expect);
+
+  exitFunc ('test');
+}
diff -r a4343d61f6ee js/tests/js1_8_1/trace/trace-test.js
--- a/js/tests/js1_8_1/trace/trace-test.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/tests/js1_8_1/trace/trace-test.js	Sat Nov 15 19:43:13 2008 -0500
@@ -1618,19 +1618,19 @@ function testNestedExitStackOuter() {
     for (var k = 1; k <= RUNLOOP; ++k) {
       counter = testNestedExitStackInner(j, counter);
     }
   }
   return counter;
 }
 testNestedExitStackOuter.expected = 81;
 testNestedExitStackOuter.jitstats = {
-    recorderStarted: 4,
+    recorderStarted: 3,
     recorderAborted: 0,
-    traceTriggered: 8
+    traceTriggered: 7
 };
 test(testNestedExitStackOuter);
 
 function testHOTLOOPSize() {
     return HOTLOOP > 1;
 }
 testHOTLOOPSize.expected = true;
 test(testHOTLOOPSize);
@@ -1948,15 +1948,87 @@ function testReallyDeepNestedExit()
     for (var i = 0; i < 5; i++) {
         c += reallyDeepNestedExit(schedules[i]);
     }
     return c;
 }
 testReallyDeepNestedExit.expected = 198;
 test(testReallyDeepNestedExit);
 
+function testRegExpTest() {
+    var r = /abc/;
+    var flag = false;
+    for (var i = 0; i < 10; ++i)
+	flag = r.test("abc");
+    return flag;
+}
+testRegExpTest.expected = true;
+test(testRegExpTest);
+
+function testNumToString() {
+    var r = [];
+    var d = 123456789;
+    for (var i = 0; i < 10; ++i) {
+	r = [
+	     d.toString(),
+	     (-d).toString(),
+	     d.toString(10),
+	     (-d).toString(10),
+	     d.toString(16),
+	     (-d).toString(16),
+	     d.toString(36),
+	     (-d).toString(36)
+        ];
+    }
+    return r.join(",");
+}
+testNumToString.expected = "123456789,-123456789,123456789,-123456789,75bcd15,-75bcd15,21i3v9,-21i3v9";
+test(testNumToString);
+
+function testSubstring() {
+    for (var i = 0; i < 5; ++i) {
+        actual = "".substring(5);
+    }
+    return actual;
+}
+testSubstring.expected = "";
+test(testSubstring);
+
+function testForInLoopChangeIteratorType() {
+    for(y in [0,1,2]) y = NaN;
+    (function(){ [].__proto__.u = void 0; for (let y in [5,6,7,8]) y = NaN; })()
+    return "ok";
+}
+testForInLoopChangeIteratorType.expected = "ok";
+test(testForInLoopChangeIteratorType);
+
+function testGrowDenseArray() {
+    var a = new Array();
+    for (var i = 0; i < 10; ++i)
+	a[i] |= 5;
+    return a.join(",");
+}
+testGrowDenseArray.expected = "5,5,5,5,5,5,5,5,5,5";
+test(testGrowDenseArray);
+
+function testCallProtoMethod() {
+    function X() { this.x = 1; }
+    X.prototype.getName = function () { return "X"; }
+
+    function Y() { this.x = 2; }
+    Y.prototype.getName = function() "Y";
+
+    var a = [new X, new X, new X, new X, new Y];
+    var s = '';
+    for (var i = 0; i < a.length; i++)
+        s += a[i].getName();
+    return s;
+}
+testCallProtoMethod.expected = 'XXXXY';
+test(testCallProtoMethod);
+
 jit(false);
 
 /* Keep these at the end so that we can see the summary after the trace-debug spew. */
 if (0) {
   print("\npassed:", passes.length && passes.join(","));
   print("\nFAILED:", fails.length && fails.join(","));
 }
diff -r a4343d61f6ee js/tests/public-failures.txt
--- a/js/tests/public-failures.txt	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/tests/public-failures.txt	Sat Nov 15 19:43:13 2008 -0500
@@ -1,17 +1,36 @@ TEST_ID=e4x/Expressions/11.1.4-08.js, TE
+TEST_ID=e4x/decompilation/decompile-xml-escapes.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Decompiler escapes line breaks/backslashes in E4X literals reason: Type mismatch, expected type boolean, actual type string Expected value 'false', Actual value ''function anonymous() {NL    return <![CDATA[\\\\]]>;NL}' does not contain '<![CDATA[\\]]>'!'
+TEST_ID=e4x/decompilation/decompile-xml-escapes.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Decompiler escapes line breaks/backslashes in E4X literals reason: Type mismatch, expected type boolean, actual type string Expected value 'false', Actual value ''function anonymous() {NL    return <?f bNLNLcNLc?>;NL}' does not contain '<?f bNLNLcNLc?>'!'
+TEST_ID=e4x/decompilation/decompile-xml-escapes.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Decompiler escapes line breaks/backslashes in E4X literals reason: Type mismatch, expected type boolean, actual type string Expected value 'false', Actual value ''function anonymous() {NL    return <?f bNLNLcNLc?>;NL}' does not contain '<?f bNLNLcNLc?>'!'
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 11 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . n : : z ) ; } ', Actual value ' function ( ) { new x ( y ) . n : : z ; } '
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 12 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . n : : z ) ; } ', Actual value ' function ( ) { new x ( y ) . n : : z ; } '
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 14 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . n : : [ z ] ) ; } ', Actual value ' function ( ) { new x ( y ) . n : : [ z ] ; } '
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 15 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . n : : [ z ] ) ; } ', Actual value ' function ( ) { new x ( y ) . n : : [ z ] ; } '
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 2 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) [ z ] ) ; } ', Actual value ' function ( ) { new x ( y ) [ z ] ; } '
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 3 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) [ z ] ) ; } ', Actual value ' function ( ) { new x ( y ) [ z ] ; } '
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 5 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . @ a ) ; } ', Actual value ' function ( ) { new x ( y ) . @ a ; } '
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . @ a ) ; } ', Actual value ' function ( ) { new x ( y ) . @ a ; } '
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 8 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . @ [ n : : a ] ) ; } ', Actual value ' function ( ) { new x ( y ) . @ [ n : : a ] ; } '
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 9 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . @ [ n : : a ] ) ; } ', Actual value ' function ( ) { new x ( y ) . @ [ n : : a ] ; } '
+TEST_ID=e4x/decompilation/regress-352789.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Decompilation of new and .@ reason: Expected value ' function ( ) { return new ( a ( ) . @ z ) ; } ', Actual value ' function ( ) { return new a . @ z ; } '
+TEST_ID=e4x/decompilation/regress-429249.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=trap should not change decompilation <x/> : after trap reason: Expected value ' function g ( ) { return <x/>; } ', Actual value ' function g ( ) { return "<x/>"; } '
+TEST_ID=e4x/decompilation/regress-461233.js, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=function() { return {0: (4, <></>) }; } reason: Expected value ' function ( ) { return { 0 : 4 , <></> } ; } ', Actual value ' function ( ) { return { 0 : ( 4 , <></> ) } ; } '
+TEST_ID=e4x/decompilation/regress-461233.js, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=function() { return {0: (4, <></>) }; } reason: Expected value ' function ( ) { return { 0 : 4 , <></> } ; } ', Actual value ' function ( ) { return { 0 : ( 4 , <></> ) } ; } '
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 50 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 51 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 53 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 54 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 56 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
-TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=e4x/extensions/regress-337226.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=function::globalfunction Section  reason: `.``*`/e4x/extensions/regress-337226.js:`.``*`: reference to undefined XML name @mozilla.org/js/function::parseInt
+TEST_ID=e4x/extensions/regress-337226.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/extensions/regress-337226.js:`.``*`: ReferenceError: reference to undefined XML name @mozilla.org/js/function::parseInt
 TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/GC/regress-324278.js:`.``*`: out of memory
 TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/GC/regress-324278.js:`.``*`: out of memory
 TEST_ID=e4x/Global/13.1.2.1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 4 of test - 13.1.2.1 - isXMLName() reason: Expected value 'exception', Actual value 'no exception'
 TEST_ID=e4x/Global/13.1.2.1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6 of test - 13.1.2.1 - isXMLName() reason: Expected value '', Actual value '0xAA-0xAA : Invalid char accepted as start : Invalid Char accepted as other NL0xB5-0xB5 : Invalid char accepted as start : Invalid Char accepted as other NL0xB7-0xB7 : Other char not acceptedNL0xBA-0xBA : Invalid char accepted as start : Invalid Char accepted as other NL0x132-0x133 : Invalid char accepted as start : Invalid Char accepted as other NL0x13F-0x140 : Invalid char accepted as start : Invalid Char accepted as other NL0x149-0x149 : Invalid char accepted as start : Invalid Char accepted as other NL0x17F-0x17F : Invalid char accepted as start : Invalid Char accepted as other NL0x1C4-0x1CC : Invalid char accepted as start : Invalid Char accepted as other NL0x1F1-0x1F3 : Invalid char accepted as start : Invalid Char accepted as other NL0x2B0-0x2B8 : Invalid Char accepted as other NL0x2BB-0x2C1 : Start char not acceptedNL0x2E0-0x2E4 : Invalid Char accepted as other NL0x37A-0x37A : Invalid Char accepted as other NL0x387-0x387 : Other char not acceptedNL0x559-0x559 : Start char not acceptedNL0x587-0x587 : Invalid char accepted as start : Invalid Char accepted as other NL0x6E5-0x6E6 : Start char not acceptedNL0xEDC-0xEDD : Invalid char accepted as start : Invalid Char accepted as other NL0x1101-0x1101 : Invalid char accepted as start : Invalid Char accepted as other NL0x1104-0x1104 : Invalid char accepted as start : Invalid Char accepted as other NL0x1108-0x1108 : Invalid char accepted as start : Invalid Char accepted as other NL0x110A-0x110A : Invalid char accepted as start : Invalid Char accepted as other NL0x110D-0x110D : Invalid char accepted as start : Invalid Char accepted as other NL0x1113-0x113B : Invalid char accepted as start : Invalid Char accepted as other NL0x113D-0x113D : Invalid char accepted as start : Invalid Char accepted as other NL0x113F-0x113F : Invalid char accepted as start : Invalid Char accepted as other NL0x1141-0x114B : Invalid char accepted as start : Invalid Char accepted as other NL0x114D-0x114D : Invalid char accepted as start : Invalid Char accepted as other NL0x114F-0x114F : Invalid char accepted as start : Invalid Char accepted as other NL0x1151-0x1153 : Invalid char accepted as start : Invalid Char accepted as other NL0x1156-0x1158 : Invalid char accepted as start : Invalid Char accepted as other NL0x1162-0x1162 : Invalid char accepted as start : Invalid Char accepted as other NL0x1164-0x1164 : Invalid char accepted as start : Invalid Char accepted as other NL0x1166-0x1166 : Invalid char accepted as start : Invalid Char accepted as other NL0x1168-0x1168 : Invalid char accepted as start : Invalid Char accepted as other NL0x116A-0x116C : Invalid char accepted as start : Invalid Char accepted as other NL0x116F-0x1171 : Invalid char accepted as start : Invalid Char accepted as other NL0x1174-0x1174 : Invalid char accepted as start : Invalid Char accepted as other NL0x1176-0x119D : Invalid char accepted as start : Invalid Char accepted as other NL0x119F-0x11A2 : Invalid char accepted as start : Invalid Char accepted as other NL0x11A9-0x11AA : Invalid char accepted as start : Invalid Char accepted as other NL0x11AC-0x11AD : Invalid char accepted as start : Invalid Char accepted as other NL0x11B0-0x11B6 : Invalid char accepted as start : Invalid Char accepted as other NL0x11B9-0x11B9 : Invalid char accepted as start : Invalid Char accepted as other NL0x11BB-0x11BB : Invalid char accepted as start : Invalid Char accepted as other NL0x11C3-0x11EA : Invalid char accepted as start : Invalid Char accepted as other NL0x11EC-0x11EF : Invalid char accepted as start : Invalid Char accepted as other NL0x11F1-0x11F8 : Invalid char accepted as start : Invalid Char accepted as other NL0x207F-0x207F : Invalid char accepted as start : Invalid Char accepted as other NL0x20DD-0x20E0 : Invalid Char accepted as other NL0x2102-0x2102 : Invalid char accepted as start : Invalid Char accepted as other NL0x2107-0x2107 : Invalid char accepted as start : Invalid Char accepted as other NL0x210A-0x2113 : Invalid char accepted as start : Invalid Char accepted as other NL0x2115-0x2115 : Invalid char accepted as start : Invalid Char accepted as other NL0x2118-0x211D : Invalid char accepted as start : Invalid Char accepted as other NL0x2124-0x2124 : Invalid char accepted as start : Invalid Char accepted as other NL0x2128-0x2128 : Invalid char accepted as start : Invalid Char accepted as other NL0x212C-0x212D : Invalid char accepted as start : Invalid Char accepted as other NL0x212F-0x2131 : Invalid char accepted as start : Invalid Char accepted as other NL0x2133-0x2138 : Invalid char accepted as start : Invalid Char accepted as other NL0x2160-0x217F : Invalid char accepted as start : Invalid Char accepted as other NL0x309B-0x309C : Invalid Char accepted as other NL0x3131-0x318E : Invalid char accepted as start : Invalid Char accepted as other NL0xF900-0xFA2D : Invalid char accepted as start : Invalid Char accepted as other NL0xFB00-0xFB06 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB13-0xFB17 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB1E-0xFB1E : Invalid Char accepted as other NL0xFB1F-0xFB28 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB2A-0xFB36 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB38-0xFB3C : Invalid char accepted as start : Invalid Char accepted as other NL0xFB3E-0xFB3E : Invalid char accepted as start : Invalid Char accepted as other NL0xFB40-0xFB41 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB43-0xFB44 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB46-0xFBB1 : Invalid char accepted as start : Invalid Char accepted as other NL0xFBD3-0xFD3D : Invalid char accepted as start : Invalid Char accepted as other NL0xFD50-0xFD8F : Invalid char accepted as start : Invalid Char accepted as other NL0xFD92-0xFDC7 : Invalid char accepted as start : Invalid Char accepted as other NL0xFDF0-0xFDFB : Invalid char accepted as start : Invalid Char accepted as other NL0xFE20-0xFE23 : Invalid Char accepted as other NL0xFE70-0xFE72 : Invalid char accepted as start : Invalid Char accepted as other NL0xFE74-0xFE74 : Invalid char accepted as start : Invalid Char accepted as other NL0xFE76-0xFEFC : Invalid char accepted as start : Invalid Char accepted as other NL0xFF10-0xFF19 : Invalid Char accepted as other NL0xFF21-0xFF3A : Invalid char accepted as start : Invalid Char accepted as other NL0xFF41-0xFF5A : Invalid char accepted as start : Invalid Char accepted as other NL0xFF66-0xFF6F : Invalid char accepted as start : Invalid Char accepted as other NL0xFF70-0xFF70 : Invalid Char accepted as other NL0xFF71-0xFF9D : Invalid char accepted as start : Invalid Char accepted as other NL0xFF9E-0xFF9F : Invalid Char accepted as other NL0xFFA0-0xFFBE : Invalid char accepted as start : Invalid Char accepted as other NL0xFFC2-0xFFC7 : Invalid char accepted as start : Invalid Char accepted as other NL0xFFCA-0xFFCF : Invalid char accepted as start : Invalid Char accepted as other NL0xFFD2-0xFFD7 : Invalid char accepted as start : Invalid Char accepted as other NL0xFFDA-0xFFDC : Invalid char accepted as start : Invalid Char accepted as other NL'
 TEST_ID=e4x/Namespace/regress-292863.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Undeclaring namespace prefix should cause parse error reason: Expected value 'error', Actual value 'no error'
 TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
@@ -43,83 +62,40 @@ TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANC
 TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6 of test - 13.4.4.26 - XML normalize() reason: Expected value '<alpha>  </alpha>', Actual value '<alpha/>'
 TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 7 of test - 13.4.4.26 - XML normalize() reason: Expected value '1', Actual value '0'
 TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 8 of test - 13.4.4.26 - XML normalize() reason: Expected value '<alpha>  <bravo> fun </bravo></alpha>', Actual value '<alpha><bravo> fun </bravo></alpha>'
 TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 9 of test - 13.4.4.26 - XML normalize() reason: Expected value '2', Actual value '1'
 TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
 TEST_ID=e4x/XML/regress-376773.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=xmlsimple.stringmethod === xmlsimple.function::stringmethod Section 61 reason: `.``*`/e4x/XML/regress-376773.js:`.``*`: reference to undefined XML name @mozilla.org/js/function::charAt
 TEST_ID=e4x/XML/regress-376773.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=Section 61 of test - xmlsimple.stringmethod === xmlsimple.function::stringmethod reason:
-TEST_ID=e4x/decompilation/decompile-xml-escapes.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Decompiler escapes line breaks/backslashes in E4X literals reason: Type mismatch, expected type boolean, actual type string Expected value 'false', Actual value ''function anonymous() {NL    return <![CDATA[\\\\]]>;NL}' does not contain '<![CDATA[\\]]>'!'
-TEST_ID=e4x/decompilation/decompile-xml-escapes.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Decompiler escapes line breaks/backslashes in E4X literals reason: Type mismatch, expected type boolean, actual type string Expected value 'false', Actual value ''function anonymous() {NL    return <?f bNLNLcNLc?>;NL}' does not contain '<?f bNLNLcNLc?>'!'
-TEST_ID=e4x/decompilation/decompile-xml-escapes.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Decompiler escapes line breaks/backslashes in E4X literals reason: Type mismatch, expected type boolean, actual type string Expected value 'false', Actual value ''function anonymous() {NL    return <?f bNLNLcNLc?>;NL}' does not contain '<?f bNLNLcNLc?>'!'
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 11 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . n : : z ) ; } ', Actual value ' function ( ) { new x ( y ) . n : : z ; } '
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 12 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . n : : z ) ; } ', Actual value ' function ( ) { new x ( y ) . n : : z ; } '
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 14 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . n : : [ z ] ) ; } ', Actual value ' function ( ) { new x ( y ) . n : : [ z ] ; } '
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 15 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . n : : [ z ] ) ; } ', Actual value ' function ( ) { new x ( y ) . n : : [ z ] ; } '
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 2 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) [ z ] ) ; } ', Actual value ' function ( ) { new x ( y ) [ z ] ; } '
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 3 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) [ z ] ) ; } ', Actual value ' function ( ) { new x ( y ) [ z ] ; } '
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 5 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . @ a ) ; } ', Actual value ' function ( ) { new x ( y ) . @ a ; } '
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . @ a ) ; } ', Actual value ' function ( ) { new x ( y ) . @ a ; } '
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 8 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . @ [ n : : a ] ) ; } ', Actual value ' function ( ) { new x ( y ) . @ [ n : : a ] ; } '
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 9 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . @ [ n : : a ] ) ; } ', Actual value ' function ( ) { new x ( y ) . @ [ n : : a ] ; } '
-TEST_ID=e4x/decompilation/regress-352789.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Decompilation of new and .@ reason: Expected value ' function ( ) { return new ( a ( ) . @ z ) ; } ', Actual value ' function ( ) { return new a . @ z ; } '
-TEST_ID=e4x/decompilation/regress-429249.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=trap should not change decompilation <x/> : after trap reason: Expected value ' function g ( ) { return <x/>; } ', Actual value ' function g ( ) { return "<x/>"; } '
-TEST_ID=e4x/extensions/regress-337226.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=function::globalfunction Section  reason: `.``*`/e4x/extensions/regress-337226.js:`.``*`: reference to undefined XML name @mozilla.org/js/function::parseInt
-TEST_ID=e4x/extensions/regress-337226.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/extensions/regress-337226.js:`.``*`: ReferenceError: reference to undefined XML name @mozilla.org/js/function::parseInt
-TEST_ID=ecma/ExecutionContexts/10.2.2-1.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=globalStorage == THIS[globalStorage] reason: wrong value
-TEST_ID=ecma/ExecutionContexts/10.2.2-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=globalStorage == THIS[globalStorage] reason: wrong value
-TEST_ID=ecma/Math/15.8.2.5.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.atan2(-0, 1) reason: wrong value
-TEST_ID=ecma/Math/15.8.2.5.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.atan2(-1, Infinity) reason: wrong value
-TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-0.9) reason: wrong value
-TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-Number.MIN_VALUE) reason: wrong value
-TEST_ID=ecma/String/15.5.4.6-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var f = new Object( String.prototype.indexOf ); f('[object Window @ `.``*` (native @ `.``*`)]') reason: wrong value
-TEST_ID=ecma/TypeConversion/9.2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=!(0/0) reason: wrong value
-TEST_ID=ecma/TypeConversion/9.2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=1000 % 0 ? true : false reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is MEDIUM MATHEMATICAL SPACE a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is MONGOLIAN VOWEL SEPARATOR a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is NARROW NO-BREAK SPACE a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is OGHAM SPACE MARK a space reason: Expected value 'true', Actual value 'false'
 TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-03.js:`.``*`: out of memory
 TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-03.js:`.``*`: out of memory
 TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-04.js:`.``*`: out of memory
 TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-04.js:`.``*`: out of memory
 TEST_ID=ecma_3/Array/regress-387501.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Array.prototype.toString|toSource|toLocaleString is not generic reason: Expected value 'TypeError: Array.prototype.toLocaleString called on incompatible String', Actual value 'f,o,o'
 TEST_ID=ecma_3/Array/regress-387501.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Array.prototype.toString|toSource|toLocaleString is not generic reason: Expected value 'TypeError: Array.prototype.toSource called on incompatible String', Actual value '["f", "o", "o"]'
 TEST_ID=ecma_3/Array/regress-387501.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Array.prototype.toString|toSource|toLocaleString is not generic reason: Expected value 'TypeError: Array.prototype.toString called on incompatible String', Actual value 'f,o,o'
+TEST_ID=ecma_3/Date/15.9.4.3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=15.9.4.3 - Date.UTC edge-case arguments.: date 0 reason: Expected value '31', Actual value '1'
 TEST_ID=ecma_3/Date/15.9.4.3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=15.9.4.3 - Date.UTC edge-case arguments.: date -1 reason: Expected value '30', Actual value '1'
-TEST_ID=ecma_3/Date/15.9.4.3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=15.9.4.3 - Date.UTC edge-case arguments.: date 0 reason: Expected value '31', Actual value '1'
 TEST_ID=ecma_3/Date/15.9.4.3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=15.9.4.3 - Date.UTC edge-case arguments.: date null reason: Expected value '31', Actual value '1'
 TEST_ID=ecma_3/Date/15.9.5.5-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.prototype.toLocaleString should not clamp year: check toLocaleString reason: Expected value '-271821', Actual value 'null'
 TEST_ID=ecma_3/Date/15.9.5.5-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.prototype.toLocaleString should not clamp year: check toLocaleString reason: Expected value '275760', Actual value 'null'
 TEST_ID=ecma_3/ExecutionContexts/10.1.3-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/ecma_3/ExecutionContexts/10.1.3-2.js:`.``*`: x is not a function
 TEST_ID=ecma_3/ExecutionContexts/10.1.3-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/ExecutionContexts/10.1.3-2.js:`.``*`: TypeError: x is not a function
 TEST_ID=ecma_3/ExecutionContexts/regress-448595-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=scope chain var declaration with initialiser in |with| clauses: catch reason: Expected value 'bar', Actual value 'wibble'
 TEST_ID=ecma_3/ExecutionContexts/regress-448595-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=scope chain var declaration with initialiser in |with| clauses: with reason: Expected value 'bar', Actual value 'wibble'
 TEST_ID=ecma_3/Expressions/11.10-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=11.10 - & should evaluate operands in order: order reason: Expected value 'o.valueOf, p.valueOf', Actual value ', p.valueOfo.valueOf'
@@ -129,511 +105,561 @@ TEST_ID=ecma_3/Expressions/11.7.2-01.js,
 TEST_ID=ecma_3/Expressions/11.7.2-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=11.7.2 - >> should evaluate operands in order: order reason: Expected value 'o.valueOf, p.valueOf', Actual value ', p.valueOfo.valueOf'
 TEST_ID=ecma_3/Expressions/11.7.3-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=11.7.3 - >>> should evaluate operands in order: order reason: Expected value 'o.valueOf, p.valueOf', Actual value ', p.valueOfo.valueOf'
 TEST_ID=ecma_3/LexicalConventions/7.9.1.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Automatic Semicolon insertion in postfix expressions: (xNL)-- y reason: Type mismatch, expected type string, actual type number Expected value 'SyntaxError: missing ; before statement', Actual value '0'
 TEST_ID=ecma_3/Number/15.7.4.2-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=3.3.toString.length should be 1 reason: Expected value '1', Actual value '0'
 TEST_ID=ecma_3/Number/15.7.4.2-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=num.toString(), num.toString(10), and num.toString(undefined) should all be equivalent reason: Type mismatch, expected type boolean, actual type object Expected value 'false', Actual value 'Error: illegal radix 0'
 TEST_ID=ecma_3/Operators/11.13.1-002.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=11.13.1 Simple Assignment should return type of RHS reason: Expected value 'string', Actual value 'number'
 TEST_ID=ecma_3/Operators/11.13.1-002.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=11.13.1 Simple Assignment should return type of RHS reason: Expected value 'string', Actual value 'number'
 TEST_ID=ecma_3/Operators/11.4.1-002.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=11.4.1 - The delete Operator - delete f() reason: Type mismatch, expected type boolean, actual type string Expected value 'true', Actual value 'SyntaxError: invalid assignment left-hand side'
-TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.13.2 %= reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
-TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.13.2 /= reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
-TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.5.2 / reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
-TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.5.3 % reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
-TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.10 & reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
 TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.10 ^ reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
 TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.10 | reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
-TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.13.2 &= reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
-TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.13.2 *= reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
+TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.10 & reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
+TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.13.2 ^= reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
 TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.13.2 <<= reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
 TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.13.2 >>= reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
 TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.13.2 >>>= reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
-TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.13.2 ^= reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
 TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.13.2 |= reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
+TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.13.2 *= reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
+TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.13.2 &= reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
 TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.5.1 * reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
 TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.6.2 - reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
 TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.7.1 << reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
 TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.7.2 >> reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
 TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.7.3 >>> reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
+TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.13.2 /= reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
+TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.13.2 %= reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
+TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.5.2 / reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
+TEST_ID=ecma_3/Operators/order-01.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=operator evaluation order: 11.5.3 % reason: Expected value 'left valueOf, left toString, right valueOf, right toString, ', Actual value 'right valueOf, right toString, left valueOf, left toString, '
 TEST_ID=ecma_3/RegExp/15.10.2.12.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=15.10.2.12 - CharacterClassEscape d reason: Expected value 'false', Actual value 'true'
 TEST_ID=ecma_3/RegExp/regress-307456.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/RegExp/regress-330684.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-367888.js:`.``*`: out of memory
-TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-375642.js:`.``*`: out of memory
 TEST_ID=ecma_3/RegExp/regress-375711.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not assert with /[Q-b]/i.exec(""): /[Q-b]/i.exec("") reason: Expected value 'No Error', Actual value 'SyntaxError: invalid range in character class'
 TEST_ID=ecma_3/RegExp/regress-375715-01-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
 TEST_ID=ecma_3/RegExp/regress-375715-01-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
 TEST_ID=ecma_3/RegExp/regress-375715-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
 TEST_ID=ecma_3/RegExp/regress-375715-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
 TEST_ID=ecma_3/RegExp/regress-375715-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
 TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
 TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not assert: (c2 <= cs->length) && (c1 <= c2)(new RegExp("`.``*`", "i")).exec("") reason: Expected value 'SyntaxError: invalid range in character class', Actual value ''
 TEST_ID=ecma_3/Statements/regress-444979.js, TEST_BRANCH=.*, TEST_REPO=CVS, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=switch -0 is same as switch 0: longSwitch reason: Expected value 'y==0', Actual value 'y!=0'
 TEST_ID=ecma_3/Statements/regress-444979.js, TEST_BRANCH=.*, TEST_REPO=CVS, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=switch -0 is same as switch 0: shortSwitch reason: Expected value 'y==0', Actual value 'y!=0'
+TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 7 reason: Expected value '/x/g/x/g/x/g', Actual value 'xnullx'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 42 reason: Expected value 'ok', Actual value 'failure'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 56 reason: Expected value '|x|string|x|string|0|number|xyz|string||y|string||undefined|1|number|xyz|string|z', Actual value '|x|string|x|string|0|number|xyz|string||y|string||string|1|number|xyz|string|z'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 58 reason: Expected value 'xy|z|string||undefined|2|number|xyz|string|', Actual value 'xy|z|string||string|2|number|xyz|string|'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 59 reason: Expected value 'xy|z|string||undefined|2|number|xyz|string|', Actual value 'xy|z|string||string|2|number|xyz|string|'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 60 reason: Expected value 'xy|z|string||undefined|2|number|xyz|string|', Actual value 'xy|z|string||string|2|number|xyz|string|'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 61 reason: Expected value 'xy|z|string||string|2|number|xyz|string|', Actual value 'xyz'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 62 reason: Expected value 'x|y|string|y|string||undefined|1|number|xyz|string|z', Actual value 'x|y|string|y|string||string|1|number|xyz|string|z'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 64 reason: Expected value 'x|y|string|y|string||undefined|1|number|xyyz|string||y|string|y|string||undefined|2|number|xyyz|string|z', Actual value 'x|y|string|y|string||string|1|number|xyyz|string||y|string|y|string||string|2|number|xyyz|string|z'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 66 reason: Expected value 'xyy|z|string||undefined||string|3|number|xyyz|string|', Actual value 'xyy|z|string||string||string|3|number|xyyz|string|'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 67 reason: Expected value 'x|y|string|1|number|xyz|string||string||undefined|y|string|z', Actual value 'x|y|string|1|number|xyz|string||string||string|y|string|z'
-TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 7 reason: Expected value '/x/g/x/g/x/g', Actual value 'xnullx'
 TEST_ID=ecma_3/String/regress-392378.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Regular Expression Non-participating Capture Groups are inaccurate in edge cases: "y".replace(/(x)?\1y/, function($0, $1){ return String($1); }) reason: Expected value 'undefined', Actual value ''
 TEST_ID=ecma_3/String/regress-392378.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Regular Expression Non-participating Capture Groups are inaccurate in edge cases: "y".replace(/(x)?y/, function($0, $1){ return $1; }) reason: Expected value 'undefined', Actual value ''
 TEST_ID=ecma_3/String/regress-392378.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Regular Expression Non-participating Capture Groups are inaccurate in edge cases: "y".replace(/(x)?y/, function($0, $1){ return String($1); }) reason: Expected value 'undefined', Actual value ''
 TEST_ID=ecma_3/Unicode/regress-352044-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=issues with Unicode escape sequences in JavaScript source code reason: Expected value 'SyntaxError: illegal character', Actual value ''
 TEST_ID=ecma_3/Unicode/regress-352044-02-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=issues with Unicode escape sequences in JavaScript source code reason: Expected value 'SyntaxError', Actual value 'No Error'
-TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is MEDIUM MATHEMATICAL SPACE a space reason: Expected value 'true', Actual value 'false'
-TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is MONGOLIAN VOWEL SEPARATOR a space reason: Expected value 'true', Actual value 'false'
-TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is NARROW NO-BREAK SPACE a space reason: Expected value 'true', Actual value 'false'
-TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is OGHAM SPACE MARK a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma/ExecutionContexts/10.2.2-1.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=globalStorage == THIS[globalStorage] reason: wrong value
+TEST_ID=ecma/ExecutionContexts/10.2.2-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=globalStorage == THIS[globalStorage] reason: wrong value
+TEST_ID=ecma/GlobalObject/15.1.2.4.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=escape(String.fromCharCode(`.``*`)) reason: wrong value
+TEST_ID=ecma/GlobalObject/15.1.2.4.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=escape(String.fromCharCode(`.``*`)) reason: wrong value
+TEST_ID=ecma/GlobalObject/15.1.2.4.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=escape(String.fromCharCode(`.``*`)) reason: wrong value
+TEST_ID=ecma/GlobalObject/15.1.2.5-1.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=unescape( `.``*` ) reason: wrong value
+TEST_ID=ecma/GlobalObject/15.1.2.5-1.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=unescape( `.``*` ) reason: wrong value
+TEST_ID=ecma/GlobalObject/15.1.2.5-1.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=unescape( `.``*` ) reason: wrong value
+TEST_ID=ecma/Math/15.8.2.5.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.atan2(-0, 1) reason: wrong value
+TEST_ID=ecma/Math/15.8.2.5.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.atan2(-1, Infinity) reason: wrong value
+TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-0.9) reason: wrong value
+TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-Number.MIN_VALUE) reason: wrong value
+TEST_ID=ecma/String/15.5.4.6-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var f = new Object( String.prototype.indexOf ); f('[object Window @ `.``*` (native @ `.``*`)]') reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', 2.5) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', 2) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', 3) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', 4) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', 5) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', 6) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', Infinity) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', NaN) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', 2.5) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', 2) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', 3) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', 4) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', 5) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', 6) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', Infinity) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', NaN) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', 2.5) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', 2) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', 3) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', 4) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', 5) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', 6) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', Infinity) reason: wrong value
+TEST_ID=ecma/String/15.5.4.7-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var s = new String('hello'); s.lastIndexOf('ll', NaN) reason: wrong value
+TEST_ID=ecma/TypeConversion/9.2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=!(0/0) reason: wrong value
+TEST_ID=ecma/TypeConversion/9.2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=1000 % 0 ? true : false reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
 TEST_ID=js1_2/function/regexparg-1.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=typeof f(/abc/) reason: wrong value
 TEST_ID=js1_2/function/regexparg-1.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=typeof new f(/abc/) reason: wrong value
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 1 of test -  [,1]  reason: Expected value '1', Actual value '01'
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 2 of test -  [,,1]  reason: Expected value '2', Actual value '012'
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 4 of test -  [1,,]  reason: Expected value '0', Actual value '01'
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 1 of test -  [,1]  reason: Expected value '1', Actual value '01'
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 2 of test -  [,,1]  reason: Expected value '2', Actual value '012'
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 4 of test -  [1,,]  reason: Expected value '0', Actual value '01'
 TEST_ID=js1_5/Array/regress-101964.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test -  reason: Expected value 'Truncation took less than 50 ms', Actual value 'Truncation took `.``*` ms'
 TEST_ID=js1_5/Array/regress-157652.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Array/regress-157652.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Array/regress-157652.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
-TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
 TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=fast, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Array/regress-451483.js, TEST_BRANCH=.*, TEST_REPO=CVS, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=[].splice.call(0) == [] reason: Expected value 'true', Actual value 'false'
-TEST_ID=js1_5/Error/regress-354246.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Error/regress-354246.js:`.``*`: x is not defined
-TEST_ID=js1_5/Error/regress-354246.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Error/regress-354246.js:`.``*`: x is not defined
-TEST_ID=js1_5/Exceptions/regress-333728.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Throw ReferenceErrors for typeof(...undef): typeof (!this ? 0 : undef) reason: Expected value 'ReferenceError', Actual value 'undefined'
-TEST_ID=js1_5/Expressions/regress-394673.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Expressions/regress-394673.js:`.``*`: too much recursion
-TEST_ID=js1_5/Expressions/regress-394673.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Expressions/regress-394673.js:`.``*`: InternalError: too much recursion
-TEST_ID=js1_5/Function/regress-338001.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 338121; /js1_5/Function/regress-338121-01.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 338121; /js1_5/Function/regress-338121-01.js:`.``*`: out of memory; ./js1_5/Function/regress-338121-01.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 338121; ./js1_5/Function/regress-338121-01.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 338121; /js1_5/Function/regress-338121-02.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 338121; /js1_5/Function/regress-338121-02.js:`.``*`: out of memory; ./js1_5/Function/regress-338121-02.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 338121; ./js1_5/Function/regress-338121-02.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Function/regress-338121-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-03.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-203278-2.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-203278-2.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-203278-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-203278-2.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-311497.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=;
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=;
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=;
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=;
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=fast, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=fast, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=;
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=;
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 346794; ./js1_5/GC/regress-346794.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 346794; ./js1_5/GC/regress-346794.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=; messages: BUGNUMBER: 346794; ./js1_5/GC/regress-346794.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-348532.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-348532.js:`.``*`: too much recursion
-TEST_ID=js1_5/GC/regress-348532.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`js1_5/GC/regress-348532.js:`.``*`: too much recursion
-TEST_ID=js1_5/GC/regress-348532.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`js1_5/GC/regress-348532.js:`.``*`: too much recursion
-TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=fast, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: :0: uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: :0: uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: :0: uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: :0: uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: :0: uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=fast, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/Regress/regress-203278-1.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-203278-1.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-203278-1.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-203278-1.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=; messages: BUGNUMBER: 271716; /js1_5/Regress/regress-271716-n.js:0: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.* SIGABRT, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 99, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-274035.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-274035.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-274035.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-312588.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=; messages: BUGNUMBER: 312588; /js1_5/Regress/regress-312588.js:0: out of memory
-TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-314401.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-314401.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-314401.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-314401.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-319384.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-319384.js:`.``*`: can't convert "foo" to an integer
-TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: :0: uncaught exception: Permission denied to get property UnnamedClass.classes
-TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=JS_ReportPendingException should reason: Expected value 'Error', Actual value 'No Error'
-TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: javascript:Components.classes:0: Script error.
-TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=JS_ReportPendingException should reason: Expected value 'Error', Actual value 'No Error'
-TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: javascript:Components.classes:0: Script error.
-TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: javascript:Components.classes:0: Script error.
-TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: javascript:Components.classes:0: Script error.
-TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: javascript:Components.classes:0: Script error.
-TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: javascript:Components.classes:0: Script error.
-TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: javascript:Components.classes:0: Script error.
-TEST_ID=js1_5/Regress/regress-329530.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-329530.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-330352.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-346237.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-350268.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=new Function with unbalanced braces: alert(6); } alert(5); reason: Expected value 'SyntaxError', Actual value 'No Error'
-TEST_ID=js1_5/Regress/regress-350268.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=new Function with unbalanced braces: } reason: Expected value 'SyntaxError', Actual value 'No Error'
-TEST_ID=js1_5/Regress/regress-350268.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=new Function with unbalanced braces: } { reason: Expected value 'SyntaxError', Actual value 'No Error'
-TEST_ID=js1_5/Regress/regress-350268.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=new Function with unbalanced braces: }}}}} reason: Expected value 'SyntaxError', Actual value 'No Error'
-TEST_ID=js1_5/Regress/regress-362583.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: caller->fun && !JSFUN_HEAVYWEIGHT_TEST(caller->fun->flags), at `.``*`jsscript.c:
-TEST_ID=js1_5/Regress/regress-362583.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: caller->fun && !JSFUN_HEAVYWEIGHT_TEST(caller->fun->flags), at `.``*`jsscript.c:
-TEST_ID=js1_5/Regress/regress-362583.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-383674.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Statement that implicitly calls toString should not be optimized away as a "useless expression": 1 reason: Expected value 'toString called', Actual value 'toString not called'
-TEST_ID=js1_5/Regress/regress-383674.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Statement that implicitly calls toString should not be optimized away as a "useless expression": 2 reason: Expected value 'toString called', Actual value 'toString not called'
-TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-452742-02.js, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not do overzealous eval inside function optimization in BindNameToSlot reason: Expected value '', Actual value 'Bad result undefined'
 TEST_ID=js1_5/decompilation/regress-351219.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of immutable infinity, NaN decompile Infinity as 1/0 reason: Expected value ' function ( ) { return 1 / 0 ; } ', Actual value ' function ( ) { return Infinity ; } '
 TEST_ID=js1_5/decompilation/regress-351219.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of immutable infinity, NaN: decompile NaN as 0/0 reason: Expected value ' function ( ) { var NaN = 0 / 0 ; return NaN ; } ', Actual value ' function ( ) { var NaN = NaN ; return NaN ; } '
+TEST_ID=js1_5/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of new parenthetic expressions reason: Expected value ' function ( ) { new ( x ( y ) . z ) ; } ', Actual value ' function ( ) { new x ( y ) . z ; } '
 TEST_ID=js1_5/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of new parenthetic expressions reason: Expected value ' function ( ) { new ( x ( y ) ( z ) ) ; } ', Actual value ' function ( ) { new x ( y ) ( z ) ; } '
-TEST_ID=js1_5/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of new parenthetic expressions reason: Expected value ' function ( ) { new ( x ( y ) . z ) ; } ', Actual value ' function ( ) { new x ( y ) . z ; } '
 TEST_ID=js1_5/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of new parenthetic expressions reason: Expected value ' function ( ) { new ( x ( z ) ) ( w ) ; } ', Actual value ' function ( ) { new x ( z ) ( w ) ; } '
+TEST_ID=js1_5/decompilation/regress-352360.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of negative 0: 8 / eval("" + f)() reason: Expected value '-Infinity', Actual value 'Infinity'
 TEST_ID=js1_5/decompilation/regress-352360.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of negative 0 reason: Expected value ' function ( ) { return - 0 ; } ', Actual value ' function ( ) { return 0 ; } '
-TEST_ID=js1_5/decompilation/regress-352360.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of negative 0: 8 / eval("" + f)() reason: Expected value '-Infinity', Actual value 'Infinity'
 TEST_ID=js1_5/decompilation/regress-352453.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/decompilation/regress-352453.js:`.``*`: invalid decrement operand
 TEST_ID=js1_5/decompilation/regress-352453.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/decompilation/regress-352453.js:`.``*`: SyntaxError: invalid decrement operand:
 TEST_ID=js1_5/decompilation/regress-353146.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of new expressions revisited reason: Expected value ' function ( ) { return new ( p ( 2 ) [ 1 ] ) ; } ', Actual value ' function ( ) { return new p ( 2 ) [ 1 ] ; } '
 TEST_ID=js1_5/decompilation/regress-356083.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation for ({this setter: function () { } })  reason: Expected value ' function ( ) { return { this setter : function ( ) { } } ; } ', Actual value ' function ( ) { return { ' this ' setter : function ( ) { } } ; } '
 TEST_ID=js1_5/decompilation/regress-356248.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of object literal with named getter reason: Expected value ' function ( ) { return { set p y ( ) { } } ; } ', Actual value ' function ( ) { return { set py ( ) { } } ; } '
 TEST_ID=js1_5/decompilation/regress-371692.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Keep extra parentheses in conditional tests reason: Expected value ' function ( ) { if ( ( i = 1 ) ) { a = 2 ; } } ', Actual value ' function ( ) { if ( i = 1 ) { a = 2 ; } } '
 TEST_ID=js1_5/decompilation/regress-375882.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of switch with case 0/0 reason: Expected value ' function ( ) { switch ( a ) { case 0 / 0 : a ; case 1 / 0 : b ; case 1 / - 0 : c ; case - 0 : d ; default : ; } } ', Actual value ' function ( ) { switch ( a ) { case NaN : a ; case Infinity : b ; case - Infinity : c ; case 0 : d ; default : ; } } '
 TEST_ID=js1_5/decompilation/regress-376564.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of new (eval()) reason: Expected value ' function ( ) { new ( eval ( ) ) ; } ', Actual value ' function ( ) { new eval ; } '
 TEST_ID=js1_5/decompilation/regress-376564.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of new (eval()) reason: Expected value ' function ( ) { new ( g ( ) ) ; } ', Actual value ' function ( ) { new g ; } '
 TEST_ID=js1_5/decompilation/regress-383721.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompiling Tabs: toString reason: Expected value ' function ( ) { return "\ t "; } ', Actual value ' function ( ) { return " "; } '
 TEST_ID=js1_5/decompilation/regress-383721.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompiling Tabs: uneval reason: Expected value ' ( function ( ) { return "\ t "; } ) ', Actual value ' ( function ( ) { return " "; } ) '
+TEST_ID=js1_5/decompilation/regress-460501.js, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of constant folding with && and valueOf, eval reason: Expected value ' function ( ) { if ( w . eval ( ) ) { } } ', Actual value ' function ( ) { if ( 1 && w . eval ( ) ) { } } '
+TEST_ID=js1_5/decompilation/regress-460501.js, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of constant folding with && and valueOf, eval reason: Expected value ' function ( ) { if ( w . valueOf ( ) ) { } } ', Actual value ' function ( ) { if ( 1 && w . valueOf ( ) ) { } } '
+TEST_ID=js1_5/decompilation/regress-460501.js, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of constant folding with && and valueOf, eval reason: Expected value ' function ( ) { if ( w . eval ( ) ) { } } ', Actual value ' function ( ) { if ( ( 1 && w . eval ( ) ) ) { } } '
+TEST_ID=js1_5/decompilation/regress-460501.js, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of constant folding with && and valueOf, eval reason: Expected value ' function ( ) { if ( w . valueOf ( ) ) { } } ', Actual value ' function ( ) { if ( ( 1 && w . valueOf ( ) ) ) { } } '
+TEST_ID=js1_5/Error/regress-354246.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Error/regress-354246.js:`.``*`: x is not defined
+TEST_ID=js1_5/Error/regress-354246.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Error/regress-354246.js:`.``*`: x is not defined
+TEST_ID=js1_5/Exceptions/regress-333728.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Throw ReferenceErrors for typeof(...undef): typeof (!this ? 0 : undef) reason: Expected value 'ReferenceError', Actual value 'undefined'
+TEST_ID=js1_5/Expressions/regress-394673.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Expressions/regress-394673.js:`.``*`: too much recursion
+TEST_ID=js1_5/Expressions/regress-394673.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Expressions/regress-394673.js:`.``*`: InternalError: too much recursion
+TEST_ID=js1_5/extensions/regress-164697.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=(new Array()).__proto__ == Array.prototype reason: Expected value 'true', Actual value 'false'
 TEST_ID=js1_5/extensions/regress-164697.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=([]).__proto__ == Array.prototype reason: Expected value 'true', Actual value 'false'
-TEST_ID=js1_5/extensions/regress-164697.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=(new Array()).__proto__ == Array.prototype reason: Expected value 'true', Actual value 'false'
 TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
+TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
+TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
 TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
-TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
-TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
 TEST_ID=js1_5/extensions/regress-304897.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=uneval("\t"), uneval("\x09") reason: Expected value '"\t"', Actual value '"\x09"'
 TEST_ID=js1_5/extensions/regress-322957.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=TryMethod should not eat getter exceptions reason: Type mismatch, expected type boolean, actual type number Expected value 'true', Actual value '-1'
 TEST_ID=js1_5/extensions/regress-330569.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-336409-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-336410-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-342960.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-342960.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-342960.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 350531; ./js1_5/extensions/regress-350531.js:`.``*`: out of memory
-TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 350531; ./js1_5/extensions/regress-350531.js:`.``*`: out of memory
-TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 350531; ./js1_5/extensions/regress-350531.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-351448.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-351463-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Treat hyphens as not special adjacent to CharacterClassEscapes in character classes: /([\d-\s]+)/.exec("a0- z") reason: Expected value '0- ,0- ', Actual value 'SyntaxError: invalid range in character class'
 TEST_ID=js1_5/extensions/regress-351463-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Treat hyphens as not special adjacent to CharacterClassEscapes in character classes: /([\d-\S]+)/.exec("a0- z") reason: Expected value 'a0-,a0-', Actual value 'SyntaxError: invalid range in character class'
-TEST_ID=js1_5/extensions/regress-351463-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Treat hyphens as not special adjacent to CharacterClassEscapes in character classes: /([\d-\s]+)/.exec("a0- z") reason: Expected value '0- ,0- ', Actual value 'SyntaxError: invalid range in character class'
 TEST_ID=js1_5/extensions/regress-352455.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Eval object with non-function getters/setters reason: Expected value 'SyntaxError: invalid getter usage', Actual value ''
 TEST_ID=js1_5/extensions/regress-352604.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not assert: !OBJ_GET_PROTO(cx, ctor) reason: Expected value 'function f() {NL}', Actual value 'function () {NL}'
 TEST_ID=js1_5/extensions/regress-353214.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of |function() { (function ([x]) { })(); eval("return 3;") }| reason: Expected value ' function ( ) { ( function ( [ x ] ) { } ( ) ) ; eval ( " return 3 ;" ) ; } ', Actual value ' function ( ) { ( function ( [ x ] ) { } ) ( ) ; eval ( " return 3 ;" ) ; } '
 TEST_ID=js1_5/extensions/regress-355622.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: overwriting, at `.``*`jsscope.c:
 TEST_ID=js1_5/extensions/regress-355622.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: overwriting, at `.``*`jsscope.c:
 TEST_ID=js1_5/extensions/regress-355622.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-355736.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of "[reserved]" has extra quotes: 1: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: invalid assignment left-hand side'
 TEST_ID=js1_5/extensions/regress-355736.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of "[reserved]" has extra quotes: 1 reason: Expected value ' function ( ) { [ super ] = q ; } ', Actual value ' function ( ) { [ " super " ] = q ; } '
-TEST_ID=js1_5/extensions/regress-355736.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of "[reserved]" has extra quotes: 1: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: invalid assignment left-hand side'
 TEST_ID=js1_5/extensions/regress-355736.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of "[reserved]" has extra quotes: 2 reason: Expected value ' function ( ) { return { super getter : function ( ) { } } ; } ', Actual value ' function ( ) { return { ' super ' getter : function ( ) { } } ; } '
+TEST_ID=js1_5/extensions/regress-355736.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of "[reserved]" has extra quotes: 3: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: invalid assignment left-hand side'
 TEST_ID=js1_5/extensions/regress-355736.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of "[reserved]" has extra quotes: 3 reason: Expected value ' function ( ) { [ goto ] = a ; } ', Actual value ' function ( ) { [ " goto " ] = a ; } '
-TEST_ID=js1_5/extensions/regress-355736.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of "[reserved]" has extra quotes: 3: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: invalid assignment left-hand side'
 TEST_ID=js1_5/extensions/regress-356085.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=js_obj_toString for getter/setter reason: Expected value ' ( { set p y ( ) { } } ) ', Actual value ' ( { set p ( ) { } } ) '
 TEST_ID=js1_5/extensions/regress-365869.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=strict warning for object literal with duplicate propery names reason: Expected value 'TypeError: redeclaration of property 1', Actual value 'No warning'
 TEST_ID=js1_5/extensions/regress-365869.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=strict warning for object literal with duplicate propery names reason: Expected value 'TypeError: redeclaration of property a', Actual value 'No warning'
 TEST_ID=js1_5/extensions/regress-367923.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=strict warning for variable redeclares argument reason: Expected value 'TypeError: variable v redeclares argument', Actual value 'TypeError: variable v hides argument'
 TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
-TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
 TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
 TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
 TEST_ID=js1_5/extensions/regress-375801.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=uneval should use "(void 0)" instead of "undefined": uneval reason: Expected value ' ( { a : ( void 0 ) } ) ', Actual value ' ( { a : undefined } ) '
 TEST_ID=js1_5/extensions/regress-376052.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=javascript.options.anonfunfix to allow function (){} expressions: 3 reason: Expected value 'SyntaxError: syntax error', Actual value 'No Error'
+TEST_ID=js1_5/extensions/regress-379523.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of sharp declaration: 1: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: invalid property id'
 TEST_ID=js1_5/extensions/regress-379523.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of sharp declaration: 1 reason: Expected value ' ( function ( ) { return # 1 = [ a ] ; } ) ', Actual value ' ( function ( ) { return # 1 = [ , a ] ; } ) '
 TEST_ID=js1_5/extensions/regress-379523.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of sharp declaration: 1 reason: Expected value ' ( function ( ) { return # 1 = { a : b } ; } ) ', Actual value ' ( function ( ) { return # 1 = { , a : b } ; } ) '
-TEST_ID=js1_5/extensions/regress-379523.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of sharp declaration: 1: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: invalid property id'
 TEST_ID=js1_5/extensions/regress-380831.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=uneval trying to output a getter function that is a sharp definition reason: Expected value ' ( { b getter : # 1 = ( function ( ) { } ) , c getter : # 1 # } ) ', Actual value ' ( { b getter : # 1 = ( ) { } , c getter : # 1 # } ) '
 TEST_ID=js1_5/extensions/regress-380889.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: op == JSOP_LOOKUPSWITCH, at `.``*`js.c:
 TEST_ID=js1_5/extensions/regress-380889.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: op == JSOP_LOOKUPSWITCH, at `.``*`js.c:
 TEST_ID=js1_5/extensions/regress-380889.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-381205.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=uneval with special getter functions: global reason: Expected value '({get x p() {print(4);}})', Actual value '({get x () {print(4);})'
 TEST_ID=js1_5/extensions/regress-381304.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-381304.js:`.``*`: missing : after property id
 TEST_ID=js1_5/extensions/regress-381304.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-381304.js:`.``*`: SyntaxError: missing : after property id
 TEST_ID=js1_5/extensions/regress-385134.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-385134.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-385134.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-394967.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-407019.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not assert: !JS_IsExceptionPending(cx) - Browser only reason: Expected match to '/Illegal operation on WrappedNative prototype object/', Actual value 'TypeError: window.Option is not a function'
+TEST_ID=js1_5/extensions/regress-421621.js, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-421621.js, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=; messages: BUGNUMBER: 421621; ./shell.js:`.``*`: TypeError: gTestcases[i].dump is not a function
 TEST_ID=js1_5/extensions/regress-421621.js, TEST_BRANCH=.*, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (sprop)->slot != SPROP_INVALID_SLOT || !SPROP_HAS_STUB_SETTER(sprop), at `.``*`jsinterp.c:
 TEST_ID=js1_5/extensions/regress-421621.js, TEST_BRANCH=.*, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (sprop)->slot != SPROP_INVALID_SLOT || !SPROP_HAS_STUB_SETTER(sprop), at `.``*`jsinterp.c:
-TEST_ID=js1_5/extensions/regress-421621.js, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-421621.js, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=; messages: BUGNUMBER: 421621; ./shell.js:`.``*`: TypeError: gTestcases[i].dump is not a function
 TEST_ID=js1_5/extensions/regress-422592.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-422592.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-432075.js, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=; messages: BUGNUMBER: 432075; expect:;  function anonymous ( ) { }; actual:;  [ object Function ]; ./shell.js:`.``*`: TypeError: gTestcases[i].dump is not a function
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 1 reason: Expected value 'watcher: propname=length, oldval=0, newval=1; ', Actual value ''
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 2 reason: Expected value 'watcher: propname=length, oldval=1, newval=2; watcher: propname=length, oldval=2, newval=2; ', Actual value 'watcher: propname=length, oldval=undefined, newval=2; '
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 3 reason: Expected value 'watcher: propname=length, oldval=2, newval=1; ', Actual value 'watcher: propname=length, oldval=undefined, newval=1; '
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 4 reason: Expected value 'watcher: propname=length, oldval=1, newval=2; ', Actual value 'watcher: propname=length, oldval=undefined, newval=2; '
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 5 reason: Expected value 'watcher: propname=length, oldval=2, newval=5; ', Actual value 'watcher: propname=length, oldval=undefined, newval=5; '
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 1 reason: Expected value 'watcher: propname=length, oldval=0, newval=1; ', Actual value ''
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 2 reason: Expected value 'watcher: propname=length, oldval=1, newval=2; watcher: propname=length, oldval=2, newval=2; ', Actual value 'watcher: propname=length, oldval=undefined, newval=2; '
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 3 reason: Expected value 'watcher: propname=length, oldval=2, newval=1; ', Actual value 'watcher: propname=length, oldval=undefined, newval=1; '
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 4 reason: Expected value 'watcher: propname=length, oldval=1, newval=2; ', Actual value 'watcher: propname=length, oldval=undefined, newval=2; '
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 5 reason: Expected value 'watcher: propname=length, oldval=2, newval=5; ', Actual value 'watcher: propname=length, oldval=undefined, newval=5; '
 TEST_ID=js1_5/extensions/regress-446386.js, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-452178.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-452178.js:`.``*`: setting a property that has only a getter
 TEST_ID=js1_5/extensions/regress-452178.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-452178.js:`.``*`: TypeError: setting a property that has only a getter
-TEST_ID=js1_5/extensions/regress-452329.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: *fp->regs->pc == JSOP_CALL || *fp->regs->pc == JSOP_NEW, at `.``*`jsstr.c:
 TEST_ID=js1_5/extensions/regress-452329.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: *fp->pc == JSOP_CALL || *fp->pc == JSOP_NEW, at `.``*`jsstr.c:
 TEST_ID=js1_5/extensions/regress-452329.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: *fp->pc == JSOP_CALL || *fp->pc == JSOP_NEW, at `.``*`jsstr.c:
 TEST_ID=js1_5/extensions/regress-452329.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=;
+TEST_ID=js1_5/extensions/regress-452329.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-452329.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`Assertion failure: *fp->regs->pc == JSOP_CALL || *fp->regs->pc == JSOP_NEW, at `.``*`jsstr.c:
+TEST_ID=js1_5/extensions/regress-452329.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: *fp->regs->pc == JSOP_CALL || *fp->regs->pc == JSOP_NEW, at `.``*`jsstr.c:
 TEST_ID=js1_5/extensions/regress-452329.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: *fp->regs->pc == JSOP_CALL || *fp->regs->pc == JSOP_NEW, at `.``*`jsstr.c:
 TEST_ID=js1_5/extensions/regress-452329.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: *fp->regs->pc == JSOP_CALL || *fp->regs->pc == JSOP_NEW, at `.``*`jsstr.c:
 TEST_ID=js1_5/extensions/regress-452329.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=;
-TEST_ID=js1_5/extensions/regress-452329.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`Assertion failure: *fp->regs->pc == JSOP_CALL || *fp->regs->pc == JSOP_NEW, at `.``*`jsstr.c:
-TEST_ID=js1_5/extensions/regress-452329.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-452329.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: *fp->regs->pc == JSOP_CALL || *fp->regs->pc == JSOP_NEW, at `.``*`jsstr.c:
+TEST_ID=js1_5/extensions/regress-452329.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: *fp->regs->pc == JSOP_CALL || *fp->regs->pc == JSOP_NEW, at `.``*`jsstr.c:
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'xxx-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51', Actual value 'xxx-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-1 99', Actual value '-001 -1'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-51 49', Actual value '-051 -51'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value '-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51', Actual value '-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051'
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'xxx-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51', Actual value 'xxx-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'Sat Jan 01 -0051 00:00:00 `.``*`', Actual value 'xxxx-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51'
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-1 99', Actual value '000/ 0/'
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'Sun Jan 01 32767 00:00:00 `.``*`', Actual value 'xxxxx2767276727672767276727672767276727672767276727672767276727672767276727672767'
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'xxxx32767327673276732767327673276732767327673276732767327673276732767327673276732767327673276732767', Actual value 'xxxx2767276727672767276727672767276727672767276727672767276727672767276727672767'
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'xxxx-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999', Actual value 'xxxx'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'Mon Jan 01 -9999 00:00:00 `.``*`', Actual value 'xxxx'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'Sun Jan 01 32767 00:00:00 `.``*`', Actual value 'xxxx2767276727672767276727672767276727672767276727672767276727672767276727672767276727672767'
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'xxx-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51', Actual value 'xxx00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-100 00', Actual value '0/00 00'
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-51 49', Actual value '00+/ +/'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '1851 51', Actual value '1851 ,''
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '1899 99', Actual value '1899 0/'
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-1 99', Actual value '000/ 0/'
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-51 49', Actual value '00+/ +/'
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value '32767327673276732767327673276732767327673276732767327673276732767327673276732767327673276732767', Actual value '2767276727672767276727672767276727672767276727672767276727672767276727672767'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value '-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999', Actual value ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value '32767327673276732767327673276732767327673276732767327673276732767327673276732767327673276732767', Actual value '2767276727672767276727672767276727672767276727672767276727672767276727672767'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value '-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51', Actual value '00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/'
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'xxx-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51', Actual value 'xxx00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/'
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'xxxx-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999', Actual value 'xxxx'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'xxxx32767327673276732767327673276732767327673276732767327673276732767327673276732767327673276732767', Actual value 'xxxx2767276727672767276727672767276727672767276727672767276727672767276727672767'
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'Mon Jan 01 -9999 00:00:00 `.``*`', Actual value 'xxxx'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'Sun Jan 01 32767 00:00:00 `.``*`', Actual value 'xxxx2767276727672767276727672767276727672767276727672767276727672767276727672767276727672767'
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'Sun Jan 01 32767 00:00:00 `.``*`', Actual value 'xxxxx2767276727672767276727672767276727672767276727672767276727672767276727672767'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%C%y") == Date.toLocaleFormat("%Y") reason: Expected value '05', Actual value '2005'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%C%y") == Date.toLocaleFormat("%Y") reason: Expected value 'Sat Jun 04 2005 `.``*`', Actual value '2005'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%C%y") == Date.toLocaleFormat("%Y") reason: Expected value 'Sat Jun 04 2005 `.``*`', Actual value '2005'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%b") == Date.toLocaleFormat("%h") reason: Expected value 'Jun', Actual value 'Sat Jun 04 2005 `.``*`'
 TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%C") reason: Expected value '20', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%e") reason: Expected value ' 4', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%g") reason: Expected value '05', Actual value 'Sat Jun 04 2005 `.``*`'
 TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%G") reason: Expected value '2005', Actual value 'Sat Jun 04 2005 `.``*`'
 TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%H:%M") == Date.toLocaleFormat("%R") reason: Expected value '`.``*`:00', Actual value 'Sat Jun 04 2005 `.``*`'
 TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%H:%M:%S") == Date.toLocaleFormat("%T") reason: Expected value '`.``*`:00:00', Actual value 'Sat Jun 04 2005 `.``*`'
 TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%I:%M:%S %p") == Date.toLocaleFormat("%r") reason: Expected value '`.``*`:00:00 PM', Actual value 'Sat Jun 04 2005 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%V") reason: Expected value '22', Actual value 'Sat Jun 04 2005 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y-%m-%d") == Date.toLocaleFormat("%F") reason: Expected value '2005-06-04', Actual value 'Sat Jun 04 2005 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%b") == Date.toLocaleFormat("%h") reason: Expected value 'Jun', Actual value 'Sat Jun 04 2005 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%e") reason: Expected value ' 4', Actual value 'Sat Jun 04 2005 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%g") reason: Expected value '05', Actual value 'Sat Jun 04 2005 `.``*`'
 TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%m/%d/%y") == Date.toLocaleFormat("%D") reason: Expected value '06/04/05', Actual value 'Sat Jun 04 2005 `.``*`'
 TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%n") == "NL" reason: Expected value 'NL', Actual value 'Sat Jun 04 2005 `.``*`'
 TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%t") == "\t" reason: Expected value '\x09', Actual value 'Sat Jun 04 2005 `.``*`'
 TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%u") reason: Expected value '6', Actual value 'Sat Jun 04 2005 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%C%y") == Date.toLocaleFormat("%Y") reason: Expected value '05', Actual value '2005'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%C%y") == Date.toLocaleFormat("%Y") reason: Expected value 'Sat Jun 04 2005 `.``*`', Actual value '2005'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%C%y") == Date.toLocaleFormat("%Y") reason: Expected value 'Sat Jun 04 2005 `.``*`', Actual value '2005'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%V") reason: Expected value '22', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y-%m-%d") == Date.toLocaleFormat("%F") reason: Expected value '2005-06-04', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/Function/regress-338001.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 338121; /js1_5/Function/regress-338121-01.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 338121; /js1_5/Function/regress-338121-01.js:`.``*`: out of memory; ./js1_5/Function/regress-338121-01.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 338121; ./js1_5/Function/regress-338121-01.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 338121; /js1_5/Function/regress-338121-02.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 338121; /js1_5/Function/regress-338121-02.js:`.``*`: out of memory; ./js1_5/Function/regress-338121-02.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 338121; ./js1_5/Function/regress-338121-02.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-03.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-203278-2.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-203278-2.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-203278-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-203278-2.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-311497.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=;
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=;
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=(TIMED OUT|CRASHED signal 9 SIGKILL), TEST_DESCRIPTION=;
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 346794; ./js1_5/GC/regress-346794.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=; messages: BUGNUMBER: 346794; ./js1_5/GC/regress-346794.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 346794; ./js1_5/GC/regress-346794.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-348532.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-348532.js:`.``*`: too much recursion
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=fast, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: :0: uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: :0: uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: :0: uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: :0: uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=fast, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: :0: uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/Regress/regress-203278-1.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-203278-1.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-203278-1.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-203278-1.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-252892.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=for (var i in o) in heavyweight function f should define i in f's activation reason: Expected value 'true', Actual value 'false'
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=; messages: BUGNUMBER: 271716; /js1_5/Regress/regress-271716-n.js:0: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.* SIGABRT, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 99, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-274035.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-274035.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-274035.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=; messages: BUGNUMBER: 312588; /js1_5/Regress/regress-312588.js:0: out of memory
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-312588.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-314401.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-314401.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-314401.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-314401.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-319384.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-319384.js:`.``*`: can't convert "foo" to an integer
+TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: :0: uncaught exception: Permission denied to get property UnnamedClass.classes
+TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=JS_ReportPendingException should reason: Expected value 'Error', Actual value 'No Error'
+TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: javascript:Components.classes:0: Script error.
+TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: javascript:Components.classes:0: Script error.
+TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: javascript:Components.classes:0: Script error.
+TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: javascript:Components.classes:0: Script error.
+TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: javascript:Components.classes:0: Script error.
+TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: javascript:Components.classes:0: Script error.
+TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=JS_ReportPendingException should reason: Expected value 'Error', Actual value 'No Error'
+TEST_ID=js1_5/Regress/regress-329530.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-329530.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-330352.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-346237.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-350268.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=new Function with unbalanced braces: alert(6); } alert(5); reason: Expected value 'SyntaxError', Actual value 'No Error'
+TEST_ID=js1_5/Regress/regress-350268.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=new Function with unbalanced braces: } { reason: Expected value 'SyntaxError', Actual value 'No Error'
+TEST_ID=js1_5/Regress/regress-350268.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=new Function with unbalanced braces: } reason: Expected value 'SyntaxError', Actual value 'No Error'
+TEST_ID=js1_5/Regress/regress-350268.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=new Function with unbalanced braces: }}}}} reason: Expected value 'SyntaxError', Actual value 'No Error'
+TEST_ID=js1_5/Regress/regress-362583.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: caller->fun && !JSFUN_HEAVYWEIGHT_TEST(caller->fun->flags), at `.``*`jsscript.c:
+TEST_ID=js1_5/Regress/regress-362583.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: caller->fun && !JSFUN_HEAVYWEIGHT_TEST(caller->fun->flags), at `.``*`jsscript.c:
+TEST_ID=js1_5/Regress/regress-362583.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-383674.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Statement that implicitly calls toString should not be optimized away as a "useless expression": 1 reason: Expected value 'toString called', Actual value 'toString not called'
+TEST_ID=js1_5/Regress/regress-383674.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Statement that implicitly calls toString should not be optimized away as a "useless expression": 2 reason: Expected value 'toString called', Actual value 'toString not called'
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-452742-02.js, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not do overzealous eval inside function optimization in BindNameToSlot reason: Expected value '', Actual value 'Bad result undefined'
 TEST_ID=js1_6/Array/regress-320887.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var x should not throw a ReferenceError reason: Expected value 'No error', Actual value 'ReferenceError: x is not defined'
 TEST_ID=js1_6/Array/regress-386030.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Array.reduce should ignore holes: 1 reason: Expected value 'PASS', Actual value 'FAIL, reduce'
 TEST_ID=js1_6/Array/regress-386030.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Array.reduce should ignore holes: 2 reason: Expected value 'PASS', Actual value 'FAIL, reduceRight'
-TEST_ID=js1_6/Regress/regress-353078.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not assert with bogus toString, map, split reason: Expected value 'TypeError: can't convert global to string', Actual value 'No Crash'
+TEST_ID=js1_6/extensions/regress-455464-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=(CRASHED signal 10 SIGBUS|CRASHED signal 11 SIGSEGV|ABNORMAL 11|ABNORMAL 5), TEST_DESCRIPTION=
 TEST_ID=js1_6/extensions/regress-455464-04.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_6/extensions/regress-455464-04.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_6/extensions/regress-455464-04.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: ngslots == tm->globalTypeMap->length(), at `.``*`jstracer.cpp:
-TEST_ID=js1_6/extensions/regress-455464-04.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 10 SIGBUS, TEST_DESCRIPTION=
-TEST_ID=js1_6/extensions/regress-455464-04.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
-TEST_ID=js1_6/extensions/regress-455464-04.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 11, TEST_DESCRIPTION=
-TEST_ID=js1_6/extensions/regress-455464-04.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=
-TEST_ID=js1_6/extensions/regress-455464-04.js, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 5 SIGTRAP, TEST_DESCRIPTION=`.``*`Assertion failure: script->main <= target && target < script->code + script->length, at `.``*`jsopcode.cpp:
+TEST_ID=js1_6/extensions/regress-455464-04.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=(CRASHED signal 10 SIGBUS|CRASHED signal 11 SIGSEGV|ABNORMAL 5|ABNORMAL 11), TEST_DESCRIPTION=
 TEST_ID=js1_6/extensions/regress-456826.js, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_6/extensions/regress-456826.js, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 456826; ./js1_6/extensions/regress-456826.js:`.``*`: out of memory; ./js1_6/extensions/regress-456826.js:`.``*`: out of memory; ./js1_6/extensions/regress-456826.js:`.``*`: Date is not defined; ./shell.js:`.``*`: out of memory
 TEST_ID=js1_6/extensions/regress-456826.js, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=; messages: BUGNUMBER: 456826; ./js1_6/extensions/regress-456826.js:`.``*`: out of memory; ./js1_6/extensions/regress-456826.js:`.``*`: ReferenceError: Date is not defined; ./shell.js:`.``*`: out of memory
-TEST_ID=js1_6/extensions/regress-456826.js, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL [35], TEST_DESCRIPTION=`.``*`./js1_6/extensions/regress-456826.js:`.``*`: out of memory; `.``*`: `(`Date`|`Math`)` is not defined;
-TEST_ID=js1_6/extensions/regress-456826.js, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_6/extensions/regress-456826.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL [35], TEST_DESCRIPTION=`.``*`./js1_6/extensions/regress-456826.js:`.``*`: out of memory; `.``*`: `(`Date`|`Math`)` is not defined;
+TEST_ID=js1_6/extensions/regress-456826.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_6/Regress/regress-353078.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not assert with bogus toString, map, split reason: Expected value 'TypeError: can't convert global to string', Actual value 'No Crash'
 TEST_ID=js1_7/block/order-of-operation.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Test let and order of operation issues reason: Type mismatch, expected type boolean, actual type string Expected value 'false', Actual value 'f1(5):NL  expected:  NaNNL  actual:    6'
 TEST_ID=js1_7/block/regress-352422.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=let declaration must be direct child of block, top-level implicit block, or switch body block reason: Expected value 'SyntaxError', Actual value ''
 TEST_ID=js1_7/block/regress-352609.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=p = {}; (p.z = [let (x = 3, y = 4) x])() reason: Expected match to '/TypeError: (p.z = \[let \(x = 3, y = 4\) x\]|.*Array.*) is not a function/', Actual value 'TypeError: p.z = [(let (x = 3, y = 4) x)] is not a function'
-TEST_ID=js1_7/block/regress-352609.js, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=p = {}; (p.z = let(x) x)() reason: Expected match to '/TypeError: (p.z = \(let \(x\) x\)|.*Undefined.*) is not a function/', Actual value 'TypeError: p.z = let (x) x is not a function'
+TEST_ID=js1_7/block/regress-352609.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=p = {}; (p.z = let(x) x)() reason: Expected match to '/TypeError: (p.z = \(let \(x\) x\)|.*Undefined.*) is not a function/', Actual value 'TypeError: p.z = let (x) x is not a function'
 TEST_ID=js1_7/block/regress-352786.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=let declaration must be direct child of block, top-level implicit block, or switch body block reason: Expected value 'SyntaxError', Actual value ''
 TEST_ID=js1_7/block/regress-352907.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=let declaration must be direct child of block, top-level implicit block, or switch body block reason: Expected value 'SyntaxError', Actual value ''
 TEST_ID=js1_7/block/regress-376410.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=let declaration must be direct child of block, top-level implicit block, or switch body block reason: Expected value 'SyntaxError', Actual value ''
 TEST_ID=js1_7/decompilation/regress-346642-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 14 reason: Expected value ' function ( ) { while ( [ ] = e ) { } } ', Actual value ' function ( ) { while ( ( [ ] = e ) ) { } } '
 TEST_ID=js1_7/decompilation/regress-346642-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 15 reason: Expected value ' function ( ) { while ( [ ] = a ( b ) ) { } } ', Actual value ' function ( ) { while ( ( [ ] = a ( b ) ) ) { } } '
-TEST_ID=js1_7/decompilation/regress-349602.js, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of let with e4x literal reason: Expected value ' function ( ) { ( let ( a = 3 ) <x/> ) ; } ', Actual value ' function ( ) { let ( a = 3 ) <x/>; } '
+TEST_ID=js1_7/decompilation/regress-349602.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of let with e4x literal reason: Expected value ' function ( ) { ( let ( a = 3 ) <x/> ) ; } ', Actual value ' function ( ) { let ( a = 3 ) <x/>; } '
 TEST_ID=js1_7/decompilation/regress-349634.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of {} and let reason: Expected value ' function ( ) { let a = 3 ; { let a = 4 ; } } ', Actual value ' function ( ) { var a = 3 ; { let a = 4 ; } } '
 TEST_ID=js1_7/decompilation/regress-350704.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of let nested in for reason: Expected value ' function ( ) { try { } catch ( y ) { for ( z ( let ( y = 3 ) 4 ) ;; ) { } } } ', Actual value ' function ( ) { try { } catch ( y ) { for ( z ( ( let ( y = 3 ) 4 ) ) ;; ) { } } } '
+TEST_ID=js1_7/decompilation/regress-350991.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of function () { for (let...;...;}}  reason: Expected value ' function ( ) { for ( ( let ( y ) 3 ) ;; ) { } } ', Actual value ' function ( ) { for ( let ( y ) 3 ;; ) { } } '
 TEST_ID=js1_7/decompilation/regress-350991.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of function () { for (let...;...;}}  reason: Expected value ' function ( ) { let x = 5 ; while ( x -- > 0 ) { for ( let x = x , q = 5 ;; ) { } } } ', Actual value ' function ( ) { var x = 5 ; while ( x -- > 0 ) { for ( let x = x , q = 5 ;; ) { } } } '
-TEST_ID=js1_7/decompilation/regress-350991.js, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of function () { for (let...;...;}}  reason: Expected value ' function ( ) { for ( ( let ( y ) 3 ) ;; ) { } } ', Actual value ' function ( ) { for ( let ( y ) 3 ;; ) { } } '
-TEST_ID=js1_7/decompilation/regress-352011.js, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of statements that begin with object literals reason: Expected value ' function ( ) { ( let ( x ) ( { t : x } ) ) ; } ', Actual value ' function ( ) { let ( x ) ( { t : x } ) ; } '
-TEST_ID=js1_7/decompilation/regress-352011.js, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of statements that begin with object literals reason: Expected value ' function ( ) { ( let ( x ) ( { y : z } ) ) ; } ', Actual value ' function ( ) { let ( x ) ( { y : z } ) ; } '
-TEST_ID=js1_7/decompilation/regress-352022.js, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of let, delete and parens reason: Expected value ' function ( ) { g ( h ) = ( ( let ( y ) 3 ) , true ) ; } ', Actual value ' function ( ) { g ( h ) = ( let ( y ) 3 , true ) ; } '
+TEST_ID=js1_7/decompilation/regress-352011.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of statements that begin with object literals reason: Expected value ' function ( ) { ( let ( x ) ( { t : x } ) ) ; } ', Actual value ' function ( ) { let ( x ) ( { t : x } ) ; } '
+TEST_ID=js1_7/decompilation/regress-352011.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of statements that begin with object literals reason: Expected value ' function ( ) { ( let ( x ) ( { y : z } ) ) ; } ', Actual value ' function ( ) { let ( x ) ( { y : z } ) ; } '
+TEST_ID=js1_7/decompilation/regress-352022.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of let, delete and parens reason: Expected value ' function ( ) { g ( h ) = ( ( let ( y ) 3 ) , true ) ; } ', Actual value ' function ( ) { g ( h ) = ( let ( y ) 3 , true ) ; } '
 TEST_ID=js1_7/decompilation/regress-352026.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of yield in argument lists reason: Expected value ' function f ( ) { g ( ( ( let ( a = b ) c ) , d ) , e ) ; } ', Actual value ' function f ( ) { g ( ( let ( a = b ) c , d ) , e ) ; } '
 TEST_ID=js1_7/decompilation/regress-352079.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of various operators reason: Expected value ' function ( ) { f ( let ( y = 3 ) 4 ) ++; } ', Actual value ' function ( ) { f ( ( let ( y = 3 ) 4 ) ) ++; } '
 TEST_ID=js1_7/decompilation/regress-352272.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of |let| in arg to lvalue returning function reason: Expected value ' function ( ) { f ( let ( y = 3 ) 4 ) ++; } ', Actual value ' function ( ) { f ( ( let ( y = 3 ) 4 ) ) ++; } '
+TEST_ID=js1_7/decompilation/regress-355786.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of for (a[b, this] in []) { }: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: missing ; after for-loop initializer'
 TEST_ID=js1_7/decompilation/regress-355786.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of for (a[b, this] in []) { } reason: Expected value ' function ( ) { for ( a [ b , this ] in [ ] ) { } } ', Actual value ' function ( ) { for ( let a [ ( b , this ) ] in [ ] ) { } } '
-TEST_ID=js1_7/decompilation/regress-355786.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of for (a[b, this] in []) { }: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: missing ; after for-loop initializer'
 TEST_ID=js1_7/decompilation/regress-356247.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of let {} = [1] in a loop: g : (function() { for(let x in []) let {} = [1]; }) reason: Expected value ' function ( ) { for ( let x in [ ] ) let [ ] = [ 1 ] ; } ', Actual value ' function ( ) { for ( let x in [ ] ) { let [ ] = [ 1 ] ; } } '
 TEST_ID=js1_7/decompilation/regress-356247.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of let {} = [1] in a loop: g : (function() { while(0) let {} = [1]; }) reason: Expected value ' function ( ) { while ( 0 ) let [ ] = [ 1 ] ; } ', Actual value ' function ( ) { while ( 0 ) { let [ ] = [ 1 ] ; } } '
+TEST_ID=js1_7/decompilation/regress-375794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of array comprehension with catch guard: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: invalid for/in left-hand side'
 TEST_ID=js1_7/decompilation/regress-375794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of array comprehension with catch guard reason: Expected value ' function ( ) { try { } catch ( a if [ b for each ( c in [ ] ) ] ) { } } ', Actual value ' function ( ) { try { } catch ( a if [ b for each ( [ ] in [ ] ) ] ) { } } '
-TEST_ID=js1_7/decompilation/regress-375794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of array comprehension with catch guard: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: invalid for/in left-hand side'
 TEST_ID=js1_7/decompilation/regress-380506.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of nested-for and for-if comprehensions reason: Expected value ' function ( ) { return [ i * i for ( i in [ 0 ] ) if ( i % 2 ) ] ; } ', Actual value ' function ( ) { return [ i * i for ( i in [ 0 ] ) ] ; } '
 TEST_ID=js1_7/decompilation/regress-380506.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of nested-for and for-if comprehensions reason: Expected value ' function ( ) { return [ i * j for ( i in [ 0 ] ) for ( j in [ 1 ] ) ] ; } ', Actual value ' function ( ) { return [ i * j for ( i in [ 0 ] ) ] ; } '
 TEST_ID=js1_7/decompilation/regress-381108.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of object literal should have space following : reason: Expected value 'true', Actual value 'false'
 TEST_ID=js1_7/decompilation/regress-429252.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=trap should not change decompilation of { let x }: after trap reason: Expected value ' function f ( ) { { let x ; } } ', Actual value ' function f ( ) { { let x ; } let x ; } '
-TEST_ID=js1_7/expressions/regress-418051.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (pnkey)->pn_arity == PN_NULLARY && ((pnkey)->pn_type == TOK_NUMBER || (pnkey)->pn_type == TOK_STRING || (pnkey)->pn_type == TOK_NAME), at `.``*`jsparse.c:
+TEST_ID=js1_7/expressions/regress-418051.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (pnkey)->pn_arity == PN_NULLARY && ((pnkey)->pn_type == TOK_NUMBER || (pnkey)->pn_type == TOK_STRING || (pnkey)->pn_type == TOK_NAME), at `.``*`jsparse.c:
+TEST_ID=js1_7/expressions/regress-418051.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 6, TEST_DESCRIPTION=`.``*`Assertion failure: (pnkey)->pn_arity == PN_NULLARY && ((pnkey)->pn_type == TOK_NUMBER || (pnkey)->pn_type == TOK_STRING || (pnkey)->pn_type == TOK_NAME), at `.``*`jsparse.c:
+TEST_ID=js1_7/expressions/regress-418051.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (pnkey)->pn_arity == PN_NULLARY && ((pnkey)->pn_type == TOK_NUMBER || (pnkey)->pn_type == TOK_STRING || (pnkey)->pn_type == TOK_NAME), at `.``*`jsparse.c:
+TEST_ID=js1_7/expressions/regress-418051.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=;
 TEST_ID=js1_7/expressions/regress-418051.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (pnkey)->pn_arity == PN_NULLARY && ((pnkey)->pn_type == TOK_NUMBER || (pnkey)->pn_type == TOK_STRING || (pnkey)->pn_type == TOK_NAME), at `.``*`jsparse.c:
 TEST_ID=js1_7/expressions/regress-418051.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=;
-TEST_ID=js1_7/expressions/regress-418051.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 6, TEST_DESCRIPTION=`.``*`Assertion failure: (pnkey)->pn_arity == PN_NULLARY && ((pnkey)->pn_type == TOK_NUMBER || (pnkey)->pn_type == TOK_STRING || (pnkey)->pn_type == TOK_NAME), at `.``*`jsparse.c:
-TEST_ID=js1_7/expressions/regress-418051.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (pnkey)->pn_arity == PN_NULLARY && ((pnkey)->pn_type == TOK_NUMBER || (pnkey)->pn_type == TOK_STRING || (pnkey)->pn_type == TOK_NAME), at `.``*`jsparse.c:
-TEST_ID=js1_7/expressions/regress-418051.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (pnkey)->pn_arity == PN_NULLARY && ((pnkey)->pn_type == TOK_NUMBER || (pnkey)->pn_type == TOK_STRING || (pnkey)->pn_type == TOK_NAME), at `.``*`jsparse.c:
-TEST_ID=js1_7/expressions/regress-418051.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=;
+TEST_ID=js1_7/expressions/regress-418051.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (pnkey)->pn_arity == PN_NULLARY && ((pnkey)->pn_type == TOK_NUMBER || (pnkey)->pn_type == TOK_STRING || (pnkey)->pn_type == TOK_NAME), at `.``*`jsparse.c:
 TEST_ID=js1_7/expressions/regress-421806.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/expressions/regress-421806.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/expressions/regress-421806.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/extensions/regress-351102-04.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/extensions/regress-351102-04.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/extensions/regress-351102-04.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/extensions/regress-351102-05.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/extensions/regress-351102-05.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/extensions/regress-351102-05.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/extensions/regress-353214-02.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=bug 353214 reason: Expected value ' function ( [ x ] ) { let x ; } ', Actual value ' function ( [ x ] ) { var x ; } '
-TEST_ID=js1_7/extensions/regress-353249.js, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=regression test for bug 353249 reason: Expected value ' function ( ) { ( let ( x ) <x/> . ( ( 1 ) ) < ( let ( z ) eval ( " 3 " ) ) ) ; for ( x in this ) { } } ', Actual value ' function ( ) { let ( x ) <x/> . ( ( 1 ) ) < ( let ( z ) eval ( " 3 " ) ) ; for ( x in this ) { } } '
+TEST_ID=js1_7/extensions/regress-353249.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=regression test for bug 353249 reason: Expected value ' function ( ) { ( let ( x ) <x/> . ( ( 1 ) ) < ( let ( z ) eval ( " 3 " ) ) ) ; for ( x in this ) { } } ', Actual value ' function ( ) { let ( x ) <x/> . ( ( 1 ) ) < ( let ( z ) eval ( " 3 " ) ) ; for ( x in this ) { } } '
 TEST_ID=js1_7/extensions/regress-367629.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of result with native function as getter reason: Expected value '({get h encodeURI() {[native code]}})', Actual value '({get h () {[native code]})'
-TEST_ID=js1_7/extensions/regress-368224.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/extensions/regress-368224.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: pnprop->pn_type == TOK_COLON, at `.``*`jsparse.c:
 TEST_ID=js1_7/extensions/regress-368224.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: pnprop->pn_type == TOK_COLON, at `.``*`jsparse.c:
 TEST_ID=js1_7/extensions/regress-368224.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/extensions/regress-368224.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=js1_7/extensions/regress-368224.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
+TEST_ID=js1_7/extensions/regress-379566.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Keywords after get|set: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: missing ; before statement'
 TEST_ID=js1_7/extensions/regress-379566.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Keywords after get|set reason: Expected value ' ( { in getter : ( function ( ) { return this . for ; } ) , in setter : ( function ( value ) { this . for = value ; } ) } ) ', Actual value ' SyntaxError : missing : after property id '
-TEST_ID=js1_7/extensions/regress-379566.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Keywords after get|set: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: missing ; before statement'
 TEST_ID=js1_7/extensions/regress-380933.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not assert with uneval object with setter with modified proto reason: Expected match to '/TypeError: Array.prototype.toSource called on incompatible Function/', Actual value 'No Error'
 TEST_ID=js1_7/extensions/regress-381301.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=uneval of object with native-function getter reason: Expected value ' ( { get x decodeURI ( ) { [ native code ] } } ) ', Actual value ' ( { get x ( ) { [ native code ] } ) '
 TEST_ID=js1_7/extensions/regress-381303.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=object toSource when a property has both a getter and a setter reason: Expected value ' ( { get inn ( ) { return this . for ; } , set inn ( value ) { this . for = value ; } } ) ', Actual value ' ( { get inn ( ) { return this [ ' for ' ] ; } , set inn ( value ) { this [ ' for ' ] = value ; } } ) '
-TEST_ID=js1_7/extensions/regress-455982-01.js, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 5 SIGTRAP, TEST_DESCRIPTION=`.``*`Assertion failure: JS_ON_TRACE(cx), at `.``*`jsbuiltins.cpp:
-TEST_ID=js1_7/extensions/regress-455982-01.js, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 5 SIGTRAP, TEST_DESCRIPTION=`.``*`Assertion failure: JS_ON_TRACE(cx), at `.``*`jsbuiltins.cpp:
-TEST_ID=js1_7/extensions/regress-455982-01.js, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=
+TEST_ID=js1_7/extensions/regress-455982-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 5 SIGTRAP, TEST_DESCRIPTION=`.``*`Assertion failure: JS_ON_TRACE(cx), at `.``*`jsbuiltins.cpp:
+TEST_ID=js1_7/extensions/regress-455982-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 5 SIGTRAP, TEST_DESCRIPTION=`.``*`Assertion failure: JS_ON_TRACE(cx), at `.``*`jsbuiltins.cpp:
+TEST_ID=js1_7/extensions/regress-455982-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=
 TEST_ID=js1_7/geniter/regress-349012-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/geniter/regress-349012-01.js:`.``*`: yield from closing generator function gen() {try {try {yield 1;} finally {actual += "Inner finally";yield 2;}} finally {actual += ",Outer finally";}}
+TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_7/iterable/regress-415922.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Support exception from withing JSNewEnumerateOp on JSENUMERATE_NEXT reason: Expected value 'Error: its enumeration failed', Actual value 'No exception r: color'
-TEST_ID=js1_7/lexical/regress-346642-03.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 8 reason: Expected value 'TypeError: ++x is not a function', Actual value 'TypeError: ++e1 is not a function'
 TEST_ID=js1_7/lexical/regress-346642-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 2 reason: Expected match to '/TypeError: x.t (has no properties|is undefined)/', Actual value 'TypeError: e1.t has no properties'
 TEST_ID=js1_7/lexical/regress-346642-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 2 reason: Expected match to '/TypeError: x.t (has no properties|is undefined)/', Actual value 'TypeError: e1.t is undefined'
 TEST_ID=js1_7/lexical/regress-346642-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 2 reason: Expected match to '/TypeError: x.t (has no properties|is undefined)/', Actual value 'TypeError: e1.t is undefined'
+TEST_ID=js1_7/lexical/regress-346642-03.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 8 reason: Expected value 'TypeError: ++x is not a function', Actual value 'TypeError: ++e1 is not a function'
 TEST_ID=js1_7/lexical/regress-351515.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Invalid uses of yield, let keywords in js17: global: yield = 1 reason: Expected value 'SyntaxError: syntax error', Actual value 'SyntaxError: yield not in function'
 TEST_ID=js1_7/regexp/yflag.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/regexp/yflag.js:`.``*`: invalid flag after regular expression
 TEST_ID=js1_7/regexp/yflag.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_7/regexp/yflag.js:`.``*`: SyntaxError: invalid flag after regular expression
 TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-350387.js:`.``*`: x is not defined
 TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-350387.js:`.``*`: ReferenceError: x is not defined
+TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-350387.js:`.``*`: x is not defined
+TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: http://test.mozilla.com//tests/mozilla.org/js/js1_7/regress/regress-350387.js:51: x is not defined
 TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`js1_7/regress/regress-350387.js:`.``*`: x is not defined
 TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`js1_7/regress/regress-350387.js:`.``*`: x is not defined
 TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-350387.js:`.``*`: x is not defined
 TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=
-TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-350387.js:`.``*`: x is not defined
-TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: http://test.mozilla.com//tests/mozilla.org/js/js1_7/regress/regress-350387.js:51: x is not defined
 TEST_ID=js1_7/regress/regress-361566.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-361566.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-361566.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
+TEST_ID=js1_7/regress/regress-363040-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-363040-01.js:`.``*`: arr0elms.reduce is not a function
+TEST_ID=js1_7/regress/regress-363040-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=Test reduceRight of empty array without initializer. : TypeError: reduce of empty array with no initial value reason: Expected value 'TypeError: reduce of empty array with no initial value', Actual value 'TypeError: arr0elms.reduceRight is not a function';
 TEST_ID=js1_7/regress/regress-363040-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Test reduce of empty array without initializer. : TypeError: reduce of empty array with no initial value reason: Expected value 'TypeError: reduce of empty array with no initial value', Actual value 'TypeError: arr0elms.reduce is not a function'
 TEST_ID=js1_7/regress/regress-363040-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Test reduceRight of empty array without initializer. : TypeError: reduce of empty array with no initial value reason: Expected value 'TypeError: reduce of empty array with no initial value', Actual value 'TypeError: arr0elms.reduceRight is not a function'
-TEST_ID=js1_7/regress/regress-363040-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-363040-01.js:`.``*`: arr0elms.reduce is not a function
-TEST_ID=js1_7/regress/regress-363040-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=Test reduceRight of empty array without initializer. : TypeError: reduce of empty array with no initial value reason: Expected value 'TypeError: reduce of empty array with no initial value', Actual value 'TypeError: arr0elms.reduceRight is not a function';
 TEST_ID=js1_7/regress/regress-363040-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-363040-02.js:`.``*`: arr.reduce is not a function
 TEST_ID=js1_7/regress/regress-363040-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-363040-02.js:`.``*`: TypeError: arr.reduce is not a function
 TEST_ID=js1_7/regress/regress-372331.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: for-in binds name to early
 TEST_ID=js1_7/regress/regress-372331.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`uncaught exception: for-in binds name to early
 TEST_ID=js1_7/regress/regress-373827-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: OBJ_GET_CLASS(cx, obj) == &js_BlockClass, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-373827-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: OBJ_GET_CLASS(cx, obj) == &js_BlockClass, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-373827-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/regress/regress-373827-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: OBJ_GET_CLASS(cx, obj) == &js_BlockClass, at `.``*`jsinterp.c:
@@ -642,60 +668,57 @@ TEST_ID=js1_7/regress/regress-373828.js,
 TEST_ID=js1_7/regress/regress-373828.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: op == JSOP_LEAVEBLOCKEXPR ? fp->spbase + OBJ_BLOCK_DEPTH(cx, obj) == sp - 1 : fp->spbase + OBJ_BLOCK_DEPTH(cx, obj) == sp, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-373828.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: op == JSOP_LEAVEBLOCKEXPR ? fp->spbase + OBJ_BLOCK_DEPTH(cx, obj) == sp - 1 : fp->spbase + OBJ_BLOCK_DEPTH(cx, obj) == sp, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-373828.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/regress/regress-375695.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-375695.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-375695.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/regress/regress-406477.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=eval of function x() in a function with an argument "x" and "let x" reason: Expected value '', Actual value 'Unexpected test_param_result value: 1NLUnexpected test_var_result value: 1NL'
 TEST_ID=js1_7/regress/regress-410649.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=type for destructuring parameter case reason: Expected value 'function', Actual value 'number'
-TEST_ID=js1_7/regress/regress-420399.js, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Let expression error involving undefined reason: Expected match to '/TypeError: \(let \(a = undefined\) a\) (is undefined|has no properties)/', Actual value 'TypeError: let (a = undefined) a is undefined'
+TEST_ID=js1_7/regress/regress-420399.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Let expression error involving undefined reason: Expected match to '/TypeError: \(let \(a = undefined\) a\) (is undefined|has no properties)/', Actual value 'TypeError: let (a = undefined) a is undefined'
+TEST_ID=js1_8_1/decompilation/regress-349605.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of let inside |for| statements reason: Expected value ' function ( ) { alert ( 1 ) ; for ( ( let ( y = 3 ) ( let ( y = 4 ) y ) ) ; false ; x ++ ) { } alert ( 6 ) ; } ', Actual value ' function ( ) { alert ( 1 ) ; for ( let ( y = 3 ) let ( y = 4 ) y ; false ; x ++ ) { } alert ( 6 ) ; } '
+TEST_ID=js1_8_1/decompilation/regress-352026.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of yield in argument lists reason: Expected value ' function f ( ) { g ( ( ( let ( a = b ) c ) , d ) , e ) ; } ', Actual value ' function f ( ) { g ( ( let ( a = b ) c , d ) , e ) ; } '
+TEST_ID=js1_8_1/decompilation/regress-352026.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of yield in argument lists reason: Expected value ' function ( ) { ( let ( s = 4 ) ( { foo : " bar " } ) ) ; } ', Actual value ' function ( ) { let ( s = 4 ) ( { foo : " bar " } ) ; } '
+TEST_ID=js1_8_1/decompilation/regress-380237-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of generator expressions reason: Expected value ' function ( ) { ( [ yield ] for ( x in [ ] ) ) ; } ', Actual value ' function ( ) { ( [ ( yield ) ] for ( x in [ ] ) ) ; } '
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"a\u205F\u205F\u205F".trim() reason: Expected value 'a', Actual value 'a\u205F\u205F\u205F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"a\u205F\u205F\u205F".trimRight() reason: Expected value 'a', Actual value 'a\u205F\u205F\u205F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205Fa".trimLeft() reason: Expected value 'a', Actual value '\u205F\u205F\u205Fa'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205Fa".trim() reason: Expected value 'a', Actual value '\u205F\u205F\u205Fa'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205Fa\u205F\u205F\u205F".trimLeft() reason: Expected value 'a\u205F\u205F\u205F', Actual value '\u205F\u205F\u205Fa\u205F\u205F\u205F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205Fa\u205F\u205F\u205F".trim() reason: Expected value 'a', Actual value '\u205F\u205F\u205Fa\u205F\u205F\u205F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205Fa\u205F\u205F\u205F".trimRight() reason: Expected value '\u205F\u205F\u205Fa', Actual value '\u205F\u205F\u205Fa\u205F\u205F\u205F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205F".trimLeft() reason: Expected value '', Actual value '\u205F\u205F\u205F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205F".trim() reason: Expected value '', Actual value '\u205F\u205F\u205F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205F".trimRight() reason: Expected value '', Actual value '\u205F\u205F\u205F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"a\u180E\u180E\u180E".trim() reason: Expected value 'a', Actual value 'a\u180E\u180E\u180E'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"a\u180E\u180E\u180E".trimRight() reason: Expected value 'a', Actual value 'a\u180E\u180E\u180E'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180Ea".trimLeft() reason: Expected value 'a', Actual value '\u180E\u180E\u180Ea'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180Ea".trim() reason: Expected value 'a', Actual value '\u180E\u180E\u180Ea'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180Ea\u180E\u180E\u180E".trimLeft() reason: Expected value 'a\u180E\u180E\u180E', Actual value '\u180E\u180E\u180Ea\u180E\u180E\u180E'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180Ea\u180E\u180E\u180E".trim() reason: Expected value 'a', Actual value '\u180E\u180E\u180Ea\u180E\u180E\u180E'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180Ea\u180E\u180E\u180E".trimRight() reason: Expected value '\u180E\u180E\u180Ea', Actual value '\u180E\u180E\u180Ea\u180E\u180E\u180E'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180E".trimLeft() reason: Expected value '', Actual value '\u180E\u180E\u180E'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180E".trim() reason: Expected value '', Actual value '\u180E\u180E\u180E'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180E".trimRight() reason: Expected value '', Actual value '\u180E\u180E\u180E'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"a\u202F\u202F\u202F".trim() reason: Expected value 'a', Actual value 'a\u202F\u202F\u202F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"a\u202F\u202F\u202F".trimRight() reason: Expected value 'a', Actual value 'a\u202F\u202F\u202F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202Fa".trimLeft() reason: Expected value 'a', Actual value '\u202F\u202F\u202Fa'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202Fa".trim() reason: Expected value 'a', Actual value '\u202F\u202F\u202Fa'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202Fa\u202F\u202F\u202F".trimLeft() reason: Expected value 'a\u202F\u202F\u202F', Actual value '\u202F\u202F\u202Fa\u202F\u202F\u202F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202Fa\u202F\u202F\u202F".trim() reason: Expected value 'a', Actual value '\u202F\u202F\u202Fa\u202F\u202F\u202F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202Fa\u202F\u202F\u202F".trimRight() reason: Expected value '\u202F\u202F\u202Fa', Actual value '\u202F\u202F\u202Fa\u202F\u202F\u202F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202F".trimLeft() reason: Expected value '', Actual value '\u202F\u202F\u202F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202F".trim() reason: Expected value '', Actual value '\u202F\u202F\u202F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202F".trimRight() reason: Expected value '', Actual value '\u202F\u202F\u202F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"a\u1680\u1680\u1680".trim() reason: Expected value 'a', Actual value 'a\u1680\u1680\u1680'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"a\u1680\u1680\u1680".trimRight() reason: Expected value 'a', Actual value 'a\u1680\u1680\u1680'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680a".trimLeft() reason: Expected value 'a', Actual value '\u1680\u1680\u1680a'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680a".trim() reason: Expected value 'a', Actual value '\u1680\u1680\u1680a'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680a\u1680\u1680\u1680".trimLeft() reason: Expected value 'a\u1680\u1680\u1680', Actual value '\u1680\u1680\u1680a\u1680\u1680\u1680'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680a\u1680\u1680\u1680".trim() reason: Expected value 'a', Actual value '\u1680\u1680\u1680a\u1680\u1680\u1680'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680a\u1680\u1680\u1680".trimRight() reason: Expected value '\u1680\u1680\u1680a', Actual value '\u1680\u1680\u1680a\u1680\u1680\u1680'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680".trimLeft() reason: Expected value '', Actual value '\u1680\u1680\u1680'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680".trim() reason: Expected value '', Actual value '\u1680\u1680\u1680'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680".trimRight() reason: Expected value '', Actual value '\u1680\u1680\u1680'
+TEST_ID=js1_8/decompilation/regress-443074.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of genexp in for loop condition: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: missing ; after for-loop condition'
 TEST_ID=js1_8/decompilation/regress-443074.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of genexp in for loop condition reason: Expected value ' function ( ) { for ( ; x || ( 1 for each ( y in [ ] ) ) ; ) { } } ', Actual value ' function ( ) { for ( ; x || 1 for each ( y in [ ] ) ; ) { } } '
-TEST_ID=js1_8/decompilation/regress-443074.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of genexp in for loop condition: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: missing ; after for-loop condition'
 TEST_ID=js1_8/genexps/regress-380237-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of generator expressions reason: Expected value ' function ( ) { with ( x for ( x in [ ] ) ) { } } ', Actual value ' function ( ) { with ( ( x for ( x in [ ] ) ) ) { } } '
 TEST_ID=js1_8/genexps/regress-380237-04.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Generator expressions parenthesization test: roundTripTest no round-trip change: section 12 reason: Expected value 'function anonymous() {NL    for (;;) {NL    }NL}', Actual value 'function anonymous() {NL    for (; (x * x for (x in []));) {NL    }NL}'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205F".trim() reason: Expected value '', Actual value '\u205F\u205F\u205F'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205F".trimLeft() reason: Expected value '', Actual value '\u205F\u205F\u205F'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205F".trimRight() reason: Expected value '', Actual value '\u205F\u205F\u205F'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205Fa".trim() reason: Expected value 'a', Actual value '\u205F\u205F\u205Fa'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205Fa".trimLeft() reason: Expected value 'a', Actual value '\u205F\u205F\u205Fa'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205Fa\u205F\u205F\u205F".trim() reason: Expected value 'a', Actual value '\u205F\u205F\u205Fa\u205F\u205F\u205F'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205Fa\u205F\u205F\u205F".trimLeft() reason: Expected value 'a\u205F\u205F\u205F', Actual value '\u205F\u205F\u205Fa\u205F\u205F\u205F'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205Fa\u205F\u205F\u205F".trimRight() reason: Expected value '\u205F\u205F\u205Fa', Actual value '\u205F\u205F\u205Fa\u205F\u205F\u205F'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"a\u205F\u205F\u205F".trim() reason: Expected value 'a', Actual value 'a\u205F\u205F\u205F'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"a\u205F\u205F\u205F".trimRight() reason: Expected value 'a', Actual value 'a\u205F\u205F\u205F'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180E".trim() reason: Expected value '', Actual value '\u180E\u180E\u180E'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180E".trimLeft() reason: Expected value '', Actual value '\u180E\u180E\u180E'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180E".trimRight() reason: Expected value '', Actual value '\u180E\u180E\u180E'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180Ea".trim() reason: Expected value 'a', Actual value '\u180E\u180E\u180Ea'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180Ea".trimLeft() reason: Expected value 'a', Actual value '\u180E\u180E\u180Ea'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180Ea\u180E\u180E\u180E".trim() reason: Expected value 'a', Actual value '\u180E\u180E\u180Ea\u180E\u180E\u180E'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180Ea\u180E\u180E\u180E".trimLeft() reason: Expected value 'a\u180E\u180E\u180E', Actual value '\u180E\u180E\u180Ea\u180E\u180E\u180E'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180Ea\u180E\u180E\u180E".trimRight() reason: Expected value '\u180E\u180E\u180Ea', Actual value '\u180E\u180E\u180Ea\u180E\u180E\u180E'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"a\u180E\u180E\u180E".trim() reason: Expected value 'a', Actual value 'a\u180E\u180E\u180E'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"a\u180E\u180E\u180E".trimRight() reason: Expected value 'a', Actual value 'a\u180E\u180E\u180E'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202F".trim() reason: Expected value '', Actual value '\u202F\u202F\u202F'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202F".trimLeft() reason: Expected value '', Actual value '\u202F\u202F\u202F'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202F".trimRight() reason: Expected value '', Actual value '\u202F\u202F\u202F'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202Fa".trim() reason: Expected value 'a', Actual value '\u202F\u202F\u202Fa'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202Fa".trimLeft() reason: Expected value 'a', Actual value '\u202F\u202F\u202Fa'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202Fa\u202F\u202F\u202F".trim() reason: Expected value 'a', Actual value '\u202F\u202F\u202Fa\u202F\u202F\u202F'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202Fa\u202F\u202F\u202F".trimLeft() reason: Expected value 'a\u202F\u202F\u202F', Actual value '\u202F\u202F\u202Fa\u202F\u202F\u202F'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202Fa\u202F\u202F\u202F".trimRight() reason: Expected value '\u202F\u202F\u202Fa', Actual value '\u202F\u202F\u202Fa\u202F\u202F\u202F'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"a\u202F\u202F\u202F".trim() reason: Expected value 'a', Actual value 'a\u202F\u202F\u202F'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"a\u202F\u202F\u202F".trimRight() reason: Expected value 'a', Actual value 'a\u202F\u202F\u202F'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680".trim() reason: Expected value '', Actual value '\u1680\u1680\u1680'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680".trimLeft() reason: Expected value '', Actual value '\u1680\u1680\u1680'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680".trimRight() reason: Expected value '', Actual value '\u1680\u1680\u1680'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680a".trim() reason: Expected value 'a', Actual value '\u1680\u1680\u1680a'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680a".trimLeft() reason: Expected value 'a', Actual value '\u1680\u1680\u1680a'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680a\u1680\u1680\u1680".trim() reason: Expected value 'a', Actual value '\u1680\u1680\u1680a\u1680\u1680\u1680'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680a\u1680\u1680\u1680".trimLeft() reason: Expected value 'a\u1680\u1680\u1680', Actual value '\u1680\u1680\u1680a\u1680\u1680\u1680'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680a\u1680\u1680\u1680".trimRight() reason: Expected value '\u1680\u1680\u1680a', Actual value '\u1680\u1680\u1680a\u1680\u1680\u1680'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"a\u1680\u1680\u1680".trim() reason: Expected value 'a', Actual value 'a\u1680\u1680\u1680'
-TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"a\u1680\u1680\u1680".trimRight() reason: Expected value 'a', Actual value 'a\u1680\u1680\u1680'
-TEST_ID=js1_8_1/decompilation/regress-349605.js, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of let inside |for| statements reason: Expected value ' function ( ) { alert ( 1 ) ; for ( ( let ( y = 3 ) ( let ( y = 4 ) y ) ) ; false ; x ++ ) { } alert ( 6 ) ; } ', Actual value ' function ( ) { alert ( 1 ) ; for ( let ( y = 3 ) let ( y = 4 ) y ; false ; x ++ ) { } alert ( 6 ) ; } '
-TEST_ID=js1_8_1/decompilation/regress-352026.js, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of yield in argument lists reason: Expected value ' function ( ) { ( let ( s = 4 ) ( { foo : " bar " } ) ) ; } ', Actual value ' function ( ) { let ( s = 4 ) ( { foo : " bar " } ) ; } '
-TEST_ID=js1_8_1/decompilation/regress-352026.js, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of yield in argument lists reason: Expected value ' function f ( ) { g ( ( ( let ( a = b ) c ) , d ) , e ) ; } ', Actual value ' function f ( ) { g ( ( let ( a = b ) c , d ) , e ) ; } '
-TEST_ID=js1_8_1/decompilation/regress-380237-03.js, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of generator expressions reason: Expected value ' function ( ) { ( [ yield ] for ( x in [ ] ) ) ; } ', Actual value ' function ( ) { ( [ ( yield ) ] for ( x in [ ] ) ) ; } '
-TEST_ID=js1_8_1/extensions/regress-437288-01.js, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=for loop turning into a while loop reason: Expected value 'SyntaxError: invalid for/in left-hand side', Actual value 'No Hang'
-TEST_ID=js1_8_1/trace/trace-test.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=missingArgTest reason: Type mismatch, expected type string, actual type number Expected value '1', Actual value '0'
-TEST_ID=js1_8_1/trace/trace-test.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=missingArgTest reason: Type mismatch, expected type string, actual type number Expected value '1', Actual value '0'
diff -r a4343d61f6ee js/tests/universe.data
--- a/js/tests/universe.data	Thu Nov 06 18:33:22 2008 +0100
+++ b/js/tests/universe.data	Sat Nov 15 19:43:13 2008 -0500
@@ -1,312 +1,156 @@ TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.5.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0800, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
diff -r a4343d61f6ee layout/base/nsCSSFrameConstructor.cpp
--- a/layout/base/nsCSSFrameConstructor.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/base/nsCSSFrameConstructor.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -2228,17 +2228,20 @@ nsCSSFrameConstructor::CreateInputFrame(
                                         PRBool                   aHasPseudoParent)
 {
   // Make sure to keep IsSpecialContent in synch with this code
   
   // Note: do not do anything in this method that assumes pseudo-frames have
   // been processed.  If you feel the urge to do something like that, fix
   // callers accordingly.
   nsCOMPtr<nsIFormControl> control = do_QueryInterface(aContent);
-  NS_ASSERTION(control, "input is not an nsIFormControl!");
+  if (!control) {
+    NS_ERROR("input doesn't implement nsIFormControl?");
+    return NS_OK;
+  }
 
   switch (control->GetType()) {
     case NS_FORM_INPUT_SUBMIT:
     case NS_FORM_INPUT_RESET:
     case NS_FORM_INPUT_BUTTON:
     {
       if (gUseXBLForms)
         return NS_OK; // update IsSpecialContent if this becomes functional
diff -r a4343d61f6ee layout/base/nsLayoutUtils.cpp
--- a/layout/base/nsLayoutUtils.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/base/nsLayoutUtils.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -2673,33 +2673,34 @@ MapToFloatImagePixels(const nsIntSize& a
 /* static */ nsresult
 nsLayoutUtils::DrawImage(nsIRenderingContext* aRenderingContext,
                          imgIContainer*       aImage,
                          const nsRect&        aDest,
                          const nsRect&        aFill,
                          const nsPoint&       aAnchor,
                          const nsRect&        aDirty)
 {
-  if (aDest.IsEmpty())
+  if (aDest.IsEmpty() || aFill.IsEmpty())
     return NS_OK;
 
   nsCOMPtr<nsIDeviceContext> dc;
   aRenderingContext->GetDeviceContext(*getter_AddRefs(dc));
   gfxFloat appUnitsPerDevPixel = dc->AppUnitsPerDevPixel();
   gfxContext *ctx = aRenderingContext->ThebesContext();
 
   // Compute the pixel-snapped area that should be drawn
-  gfxRect fill(aFill.x/appUnitsPerDevPixel,
-               aFill.y/appUnitsPerDevPixel,
-               aFill.width/appUnitsPerDevPixel,
-               aFill.height/appUnitsPerDevPixel);
+  gfxRect devPixelFill(aFill.x/appUnitsPerDevPixel,
+                       aFill.y/appUnitsPerDevPixel,
+                       aFill.width/appUnitsPerDevPixel,
+                       aFill.height/appUnitsPerDevPixel);
   PRBool ignoreScale = PR_FALSE;
 #ifdef MOZ_GFX_OPTIMIZE_MOBILE
   ignoreScale = PR_TRUE;
 #endif
+  gfxRect fill = devPixelFill;
   PRBool didSnap = ctx->UserToDevicePixelSnapped(fill, ignoreScale);
 
   // Compute dirty rect in gfx space
   gfxRect dirty(aDirty.x/appUnitsPerDevPixel,
                 aDirty.y/appUnitsPerDevPixel,
                 aDirty.width/appUnitsPerDevPixel,
                 aDirty.height/appUnitsPerDevPixel);
 
@@ -2730,17 +2731,23 @@ nsLayoutUtils::DrawImage(nsIRenderingCon
   // Compute the anchor point and compute final fill rect.
   // This code assumes that pixel-based devices have one pixel per
   // device unit!
   gfxPoint anchorPoint(aAnchor.x/appUnitsPerDevPixel,
                        aAnchor.y/appUnitsPerDevPixel);
   gfxMatrix currentMatrix = ctx->CurrentMatrix();
   gfxRect finalFillRect = fill;
   if (didSnap) {
-    ctx->UserToDevicePixelSnapped(anchorPoint, ignoreScale);
+    NS_ASSERTION(!currentMatrix.HasNonAxisAlignedTransform(),
+                 "How did we snap, then?");
+    anchorPoint.x = fill.pos.x + 
+        (anchorPoint.x - devPixelFill.pos.x)*fill.size.width/devPixelFill.size.width;
+    anchorPoint.y = fill.pos.y +
+        (anchorPoint.y - devPixelFill.pos.y)*fill.size.height/devPixelFill.size.height;
+    anchorPoint.Round();
 
     // This form of Transform is safe to call since non-axis-aligned
     // transforms wouldn't be snapped.
     dirty = currentMatrix.Transform(dirty);
     dirty.RoundOut();
     finalFillRect = fill.Intersect(dirty);
     if (finalFillRect.IsEmpty())
       return NS_OK;
@@ -2793,16 +2800,20 @@ nsLayoutUtils::DrawSingleUnscaledImage(n
     source = *aSourceArea;
   } else {
     source.SizeTo(size.width*appUnitsPerCSSPixel, size.height*appUnitsPerCSSPixel);
   }
 
   nsRect dest(aDest - source.TopLeft(),
     nsSize(size.width*appUnitsPerCSSPixel, size.height*appUnitsPerCSSPixel));
   nsRect fill(aDest, source.Size());
+  // Ensure that only a single image tile is drawn. If aSourceArea extends
+  // outside the image bounds, we want to honor the aSourceArea-to-aDest
+  // translation but we don't want to actually tile the image.
+  fill.IntersectRect(fill, dest);
   return DrawImage(aRenderingContext, aImage, dest, fill, aDest, aDirty);
 }
 
 /* static */ nsresult
 nsLayoutUtils::DrawSingleImage(nsIRenderingContext* aRenderingContext,
                                imgIContainer*       aImage,
                                const nsRect&        aDest,
                                const nsRect&        aDirty,
@@ -2819,17 +2830,22 @@ nsLayoutUtils::DrawSingleImage(nsIRender
   nsRect source;
   if (aSourceArea) {
     source = *aSourceArea;
   } else {
     source.SizeTo(size.width*appUnitsPerCSSPixel, size.height*appUnitsPerCSSPixel);
   }
 
   nsRect dest = GetWholeImageDestination(size, source, aDest);
-  return DrawImage(aRenderingContext, aImage, dest, aDest, aDest.TopLeft(), aDirty);
+  // Ensure that only a single image tile is drawn. If aSourceArea extends
+  // outside the image bounds, we want to honor the aSourceArea-to-aDest
+  // transform but we don't want to actually tile the image.
+  nsRect fill;
+  fill.IntersectRect(aDest, dest);
+  return DrawImage(aRenderingContext, aImage, dest, fill, fill.TopLeft(), aDirty);
 }
 
 /* static */ nsRect
 nsLayoutUtils::GetWholeImageDestination(const nsIntSize& aWholeImageSize,
                                         const nsRect& aImageSourceArea,
                                         const nsRect& aDestArea)
 {
   double scaleX = double(aDestArea.width)/aImageSourceArea.width;
diff -r a4343d61f6ee layout/build/Makefile.in
--- a/layout/build/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/build/Makefile.in	Sat Nov 15 19:43:13 2008 -0500
@@ -148,19 +148,24 @@ endif
 endif
 
 ifdef MOZ_OGG
 SHARED_LIBRARY_LIBS 	+= \
 	$(DEPTH)/media/libfishsound/src/libfishsound/$(LIB_PREFIX)fishsound.$(LIB_SUFFIX) \
 	$(DEPTH)/media/libogg/src/$(LIB_PREFIX)ogg.$(LIB_SUFFIX) \
 	$(DEPTH)/media/liboggplay/src/liboggplay/$(LIB_PREFIX)oggplay.$(LIB_SUFFIX) \
 	$(DEPTH)/media/liboggz/src/liboggz/$(LIB_PREFIX)oggz.$(LIB_SUFFIX) \
-	$(DEPTH)/media/libsydneyaudio/src/$(LIB_PREFIX)sydneyaudio.$(LIB_SUFFIX) \
 	$(DEPTH)/media/libtheora/lib/$(LIB_PREFIX)theora.$(LIB_SUFFIX) \
 	$(DEPTH)/media/libvorbis/lib/$(LIB_PREFIX)vorbis.$(LIB_SUFFIX) \
+	$(NULL)
+endif
+
+ifdef MOZ_SYDNEYAUDIO
+SHARED_LIBRARY_LIBS 	+= \
+	$(DEPTH)/media/libsydneyaudio/src/$(LIB_PREFIX)sydneyaudio.$(LIB_SUFFIX) \
 	$(NULL)
 LOCAL_INCLUDES += -I$(DEPTH)/content/html/content/src
 endif
 
 ifdef NS_PRINTING
 SHARED_LIBRARY_LIBS += \
 		../printing/$(LIB_PREFIX)gkprinting_s.$(LIB_SUFFIX) \
 		$(NULL)
@@ -253,17 +258,17 @@ EXTRA_DSO_LDOPTS += \
 	$(NULL)
 endif
 
 # Add explicit X11 dependency when building against X11 toolkits
 ifneq (,$(filter gtk2,$(MOZ_WIDGET_TOOLKIT)))
 EXTRA_DSO_LDOPTS += $(XLDFLAGS) $(XLIBS)
 endif
 
-ifdef MOZ_OGG
+ifdef MOZ_SYDNEYAUDIO
 ifeq ($(OS_ARCH),Darwin)
 OS_LIBS += -framework CoreAudio -framework AudioToolbox -framework AudioUnit -framework Carbon
 endif
 endif
 
 include $(topsrcdir)/config/rules.mk
 
 LOCAL_INCLUDES	+= -I$(srcdir)/../base \
diff -r a4343d61f6ee layout/build/nsLayoutStatics.cpp
--- a/layout/build/nsLayoutStatics.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/build/nsLayoutStatics.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -78,16 +78,17 @@
 #include "nsCellMap.h"
 #include "nsTextFrameTextRunCache.h"
 #include "nsCCUncollectableMarker.h"
 #include "nsTextFragment.h"
 #include "nsCSSRuleProcessor.h"
 #include "nsXMLHttpRequest.h"
 #include "nsIFocusEventSuppressor.h"
 #include "nsDOMThreadService.h"
+#include "nsHTMLDNSPrefetch.h"
 
 #ifdef MOZ_XUL
 #include "nsXULPopupManager.h"
 #include "nsXULContentUtils.h"
 #include "nsXULElement.h"
 #include "nsXULPrototypeCache.h"
 #include "nsXULTooltipListener.h"
 
@@ -110,17 +111,17 @@ PRBool NS_SVGEnabled();
 #include "nsTextServicesDocument.h"
 #endif
 
 #ifdef MOZ_MEDIA
 #include "nsMediaDecoder.h"
 #include "nsHTMLMediaElement.h"
 #endif
 
-#ifdef MOZ_OGG
+#ifdef MOZ_SYDNEYAUDIO
 #include "nsAudioStream.h"
 #endif
 
 #include "nsError.h"
 #include "nsTraceRefcnt.h"
 
 #include "nsCycleCollector.h"
 #include "nsJSEnvironment.h"
@@ -177,16 +178,22 @@ nsLayoutStatics::Initialize()
   if (NS_FAILED(rv)) {
     NS_ERROR("Could not initialize nsCSSRendering");
     return rv;
   }
 
   rv = nsTextFrameTextRunCache::Init();
   if (NS_FAILED(rv)) {
     NS_ERROR("Could not initialize textframe textrun cache");
+    return rv;
+  }
+
+  rv = nsHTMLDNSPrefetch::Initialize();
+  if (NS_FAILED(rv)) {
+    NS_ERROR("Could not initialize HTML DNS prefetch");
     return rv;
   }
 
 #ifdef MOZ_XUL
   rv = nsXULContentUtils::Init();
   if (NS_FAILED(rv)) {
     NS_ERROR("Could not initialize nsXULContentUtils");
     return rv;
@@ -252,17 +259,17 @@ nsLayoutStatics::Initialize()
   if (NS_FAILED(rv)) {
     NS_ERROR("Could not initialize nsMediaDecoder");
     return rv;
   }
   
   nsHTMLMediaElement::InitMediaTypes();
 #endif
 
-#ifdef MOZ_OGG
+#ifdef MOZ_SYDNEYAUDIO
   nsAudioStream::InitLibrary();
 #endif
 
   return NS_OK;
 }
 
 void
 nsLayoutStatics::Shutdown()
@@ -275,16 +282,17 @@ nsLayoutStatics::Shutdown()
   nsDOMAttribute::Shutdown();
   nsDOMEventRTTearoff::Shutdown();
   nsEventListenerManager::Shutdown();
   nsContentList::Shutdown();
   nsComputedDOMStyle::Shutdown();
   CSSLoaderImpl::Shutdown();
   nsCSSRuleProcessor::FreeSystemMetrics();
   nsTextFrameTextRunCache::Shutdown();
+  nsHTMLDNSPrefetch::Shutdown();
   nsCSSRendering::Shutdown();
 #ifdef DEBUG
   nsFrame::DisplayReflowShutdown();
 #endif
   nsCellMap::Shutdown();
 
   // Release all of our atoms
   nsColorNames::ReleaseTable();
@@ -337,17 +345,17 @@ nsLayoutStatics::Shutdown()
 
   nsDOMThreadService::Shutdown();
 
   NS_ShutdownFocusSuppressor();
 
 #ifdef MOZ_MEDIA
   nsHTMLMediaElement::ShutdownMediaTypes();
 #endif
-#ifdef MOZ_OGG
+#ifdef MOZ_SYDNEYAUDIO
   nsAudioStream::ShutdownLibrary();
 #endif
 
   nsXMLHttpRequest::ShutdownACCache();
 }
 
 void
 nsLayoutStatics::AddRef()
diff -r a4343d61f6ee layout/generic/crashtests/451334-1.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/generic/crashtests/451334-1.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,10 @@
+<!DOCTYPE html>
+<html>
+<head></head>
+<body onload="document.body.style.MozColumnWidth = '1px';">
+
+<div style="display: inline-block;"></div><div style="float: left;"><div style="height: 32px;"></div></div><div>
+<div style="clear: both;"><br></div><div style="float: left;"></div></div>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/generic/crashtests/crashtests.list
--- a/layout/generic/crashtests/crashtests.list	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/generic/crashtests/crashtests.list	Sat Nov 15 19:43:13 2008 -0500
@@ -151,8 +151,9 @@ load 425253-1.html
 load 425253-1.html
 load 426272-1.html
 load 428263-1.html
 load 429981-1.html
 load 430352-1.html
 load 437156-1.html
 load 438259-1.html
 load 448903-1.html
+load 451334-1.html
diff -r a4343d61f6ee layout/generic/nsObjectFrame.cpp
--- a/layout/generic/nsObjectFrame.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/generic/nsObjectFrame.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -3725,31 +3725,57 @@ nsEventStatus nsPluginInstanceOwner::Pro
 #endif
 
 #ifdef XP_WIN
   // this code supports windowless plugins
   nsPluginEvent * pPluginEvent = (nsPluginEvent *)anEvent.nativeMsg;
   // we can get synthetic events from the nsEventStateManager... these
   // have no nativeMsg
   nsPluginEvent pluginEvent;
-  if (!pPluginEvent) {
-    switch (anEvent.message) {
-      case NS_FOCUS_CONTENT:
-        pluginEvent.event = WM_SETFOCUS;
-        pluginEvent.wParam = 0;
-        pluginEvent.lParam = 0;
-        pPluginEvent = &pluginEvent;
-        break;
-      case NS_BLUR_CONTENT:
-        pluginEvent.event = WM_KILLFOCUS;
-        pluginEvent.wParam = 0;
-        pluginEvent.lParam = 0;
-        pPluginEvent = &pluginEvent;
-        break;
-    }
+  switch (anEvent.eventStructType) {
+    case NS_MOUSE_EVENT:
+      // XXX we could synthesize Windows mouse events here for our
+      // synthetic mouse events (i.e. !pPluginEvent)
+      if (pPluginEvent) {
+        // Make event coordinates relative to our enclosing widget,
+        // not the widget they were received on.
+        // See use of nsPluginEvent in widget/src/windows/nsWindow.cpp
+        // for why this assert should be safe
+        NS_ASSERTION(anEvent.message == NS_MOUSE_BUTTON_DOWN ||
+                     anEvent.message == NS_MOUSE_BUTTON_UP ||
+                     anEvent.message == NS_MOUSE_DOUBLECLICK ||
+                     anEvent.message == NS_MOUSE_MOVE,
+                     "Incorrect event type for coordinate translation");
+        nsPoint pt = nsLayoutUtils::GetEventCoordinatesRelativeTo(&anEvent, mOwner);
+        nsPresContext* presContext = mOwner->PresContext();
+        nsIntPoint ptPx(presContext->AppUnitsToDevPixels(pt.x),
+                        presContext->AppUnitsToDevPixels(pt.y));
+        nsIntPoint widgetPtPx = ptPx + mOwner->GetWindowOriginInPixels(PR_TRUE);
+        pPluginEvent->lParam = MAKELPARAM(widgetPtPx.x, widgetPtPx.y);
+      }
+      break;
+
+    case NS_FOCUS_EVENT:
+      if (!pPluginEvent) {
+        switch (anEvent.message) {
+          case NS_FOCUS_CONTENT:
+            pluginEvent.event = WM_SETFOCUS;
+            pluginEvent.wParam = 0;
+            pluginEvent.lParam = 0;
+            pPluginEvent = &pluginEvent;
+            break;
+          case NS_BLUR_CONTENT:
+            pluginEvent.event = WM_KILLFOCUS;
+            pluginEvent.wParam = 0;
+            pluginEvent.lParam = 0;
+            pPluginEvent = &pluginEvent;
+            break;
+        }
+      }
+      break;
   }
 
   if (pPluginEvent) {
     PRBool eventHandled = PR_FALSE;
     mInstance->HandleEvent(pPluginEvent, &eventHandled);
     if (eventHandled)
       rv = nsEventStatus_eConsumeNoDefault;
   }
diff -r a4343d61f6ee layout/reftests/border-image/10x5multicolor.png
Binary file layout/reftests/border-image/10x5multicolor.png has changed
diff -r a4343d61f6ee layout/reftests/border-image/3x3multicolor.png
Binary file layout/reftests/border-image/3x3multicolor.png has changed
diff -r a4343d61f6ee layout/reftests/border-image/4x4multicolor.png
Binary file layout/reftests/border-image/4x4multicolor.png has changed
diff -r a4343d61f6ee layout/reftests/box-properties/abspos-replaced-width-offset-margin-narrow.png
Binary file layout/reftests/box-properties/abspos-replaced-width-offset-margin-narrow.png has changed
diff -r a4343d61f6ee layout/reftests/box-properties/abspos-replaced-width-offset-margin-wide.png
Binary file layout/reftests/box-properties/abspos-replaced-width-offset-margin-wide.png has changed
diff -r a4343d61f6ee layout/reftests/bugs/433640-1-ref.html
--- a/layout/reftests/bugs/433640-1-ref.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/reftests/bugs/433640-1-ref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -23,27 +23,27 @@
 <div class="cell"><p>31.1  x 32</p><div style="width:31px; background-position:-16px -16px;"  class="image"></div></div>
 <div class="cell"><p>31.5  x 32</p><div style="width:32px; background-position:-16px -16px;"  class="image"></div></div>
 <div class="cell"><p>31.8  x 32</p><div style="width:32px; background-position:-16px -16px;"  class="image"></div></div>
 </div>
 
 <div>
 <div class="cell"><p>32    x 32</p><div style="width:32px; background-position:-16px -16px;"  class="image"></div></div>
 <div class="cell"><p>32.1  x 32</p><div style="width:32px; background-position:-16px -16px;"  class="image"></div></div>
-<div class="cell"><p>32.5  x 32</p><div style="width:33px; background-position:-16px -16px;"  class="image"></div></div>
-<div class="cell"><p>32.8  x 32</p><div style="width:33px; background-position:-16px -16px;"  class="image"></div></div>
+<div class="cell"><p>32.5  x 32</p><div style="width:33px; background-position:-15px -16px;"  class="image"></div></div>
+<div class="cell"><p>32.8  x 32</p><div style="width:33px; background-position:-15px -16px;"  class="image"></div></div>
 </div>
 
 <div>
 <div class="cell"><p>32 x 31   </p><div style="height:31px; background-position:-16px -16px;" class="image"></div></div>
 <div class="cell"><p>32 x 31.1 </p><div style="height:31px; background-position:-16px -16px;" class="image"></div></div>
 <div class="cell"><p>32 x 31.5 </p><div style="height:32px; background-position:-16px -16px;" class="image"></div></div>
 <div class="cell"><p>32 x 31.8 </p><div style="height:32px; background-position:-16px -16px;" class="image"></div></div>
 </div>
 
 <div>
 <div class="cell"><p>32 x 32   </p><div style="height:32px; background-position:-16px -16px;" class="image"></div></div>
 <div class="cell"><p>32 x 32.1 </p><div style="height:32px; background-position:-16px -16px;" class="image"></div></div>
-<div class="cell"><p>32 x 32.5 </p><div style="height:33px; background-position:-16px -16px;" class="image"></div></div>
-<div class="cell"><p>32 x 32.8 </p><div style="height:33px; background-position:-16px -16px;" class="image"></div></div>
+<div class="cell"><p>32 x 32.5 </p><div style="height:33px; background-position:-16px -15px;" class="image"></div></div>
+<div class="cell"><p>32 x 32.8 </p><div style="height:33px; background-position:-16px -15px;" class="image"></div></div>
 </div>
 
 </body></html>
diff -r a4343d61f6ee layout/reftests/bugs/456330-1-ref.png
Binary file layout/reftests/bugs/456330-1-ref.png has changed
diff -r a4343d61f6ee layout/reftests/bugs/456330-1.gif
Binary file layout/reftests/bugs/456330-1.gif has changed
diff -r a4343d61f6ee layout/reftests/bugs/463204-1-ref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/bugs/463204-1-ref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,17 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+<style>
+span {
+  background-image: url(data:image/gif;base64,R0lGODlhEwATAKIAAP//AMzMADMzAP8AAAAAAP///wAAAAAAACH5BAEAAAUALAAAAAATABMAAANWWLrUTisyEoC1oUlFr8dQRHykFRad+Y0gdzlv86KVKdsskOUAjHu312rFK5FuxaMNIMgYe85GrVfKZVDAR7DHmVoG4IHn6vqEgZLU90xOq8OazUS7SQAAOw==);
+  display: inline-block;
+  width: 19px;
+  height: 19px;
+  margin-left: 1px;
+}
+</style>
+</head>
+<body>
+<span></span>
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/bugs/463204-1.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/bugs/463204-1.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,19 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+<style>
+span {
+  background-image: url(data:image/gif;base64,R0lGODlhEwATAKIAAP//AMzMADMzAP8AAAAAAP///wAAAAAAACH5BAEAAAUALAAAAAATABMAAANWWLrUTisyEoC1oUlFr8dQRHykFRad+Y0gdzlv86KVKdsskOUAjHu312rFK5FuxaMNIMgYe85GrVfKZVDAR7DHmVoG4IHn6vqEgZLU90xOq8OazUS7SQAAOw==);
+  display: inline-block;
+  background-repeat: no-repeat;
+  background-position: center center;
+  width: 19px;
+  height: 19px;
+  margin-left: 0.6px;
+}
+</style>
+</head>
+<body>
+<span></span>
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/bugs/463217-1-ref.xul
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/bugs/463217-1-ref.xul	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,7 @@
+<?xml version="1.0"?>
+<window xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
+  <vbox style="height:204px; border:2px solid blue;" flex="0">
+    <image style="list-style-image: url(mozilla-banner.gif);"/>
+  </vbox>
+  <vbox/>
+</window>
diff -r a4343d61f6ee layout/reftests/bugs/463217-1.xul
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/bugs/463217-1.xul	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,4 @@
+<?xml version="1.0"?>
+<window xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
+  <image style="border:2px solid blue; list-style-image: url(mozilla-banner.gif); -moz-image-region: rect(0 600px 200px 0);"/>
+</window>
diff -r a4343d61f6ee layout/reftests/bugs/reftest.list
--- a/layout/reftests/bugs/reftest.list	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/reftests/bugs/reftest.list	Sat Nov 15 19:43:13 2008 -0500
@@ -934,16 +934,17 @@ fails == 441259-2.html 441259-2-ref.html
 == 450670-1.html 450670-1-ref.html
 == 451168-1.html 451168-1-ref.html
 == 452964-1.html 452964-1-ref.html
 == 454361.html about:blank
 == 455105-1.html 455105-ref.html
 == 455105-2.html 455105-ref.html
 == 455280-1.xhtml 455280-1-ref.xhtml
 fails-if(MOZ_WIDGET_TOOLKIT=="cocoa") == 456147.xul 456147-ref.html # bug 456147, but not caused by it
+== 456330-1.gif 456330-1-ref.png
 == 456484-1.html 456484-1-ref.html
 == 458487-1a.html 458487-1-ref.html
 == 458487-1b.html 458487-1-ref.html
 == 458487-1c.html 458487-1-ref.html
 == 458487-1d.html 458487-1-ref.html
 == 458487-1e.html 458487-1-ref.html
 == 458487-1f.html 458487-1-ref.html
 == 458487-1g.html 458487-1-ref.html
@@ -952,8 +953,10 @@ fails-if(MOZ_WIDGET_TOOLKIT=="cocoa") ==
 == 458487-3.html 458487-3-ref.html
 == 458487-4a.html 458487-4-ref.html
 == 458487-4b.html 458487-4-ref.html
 == 458487-4c.html 458487-4-ref.html
 == 458487-5a.html 458487-5-ref.html
 == 458487-5b.html 458487-5-ref.html
 == 461266-1.html 461266-1-ref.html
 fails == 461512-1.html 461512-1-ref.html # Bug 461512
+== 463204-1.html 463204-1-ref.html
+== 463217-1.xul 463217-1-ref.xul
diff -r a4343d61f6ee layout/reftests/bugs/solidblue.png
Binary file layout/reftests/bugs/solidblue.png has changed
diff -r a4343d61f6ee layout/reftests/bugs/solidblue2.png
Binary file layout/reftests/bugs/solidblue2.png has changed
diff -r a4343d61f6ee layout/reftests/bugs/square-outline-32x32.png
Binary file layout/reftests/bugs/square-outline-32x32.png has changed
diff -r a4343d61f6ee layout/reftests/css-charset/pass.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/css-charset/pass.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,7 @@
+<!DOCTYPE html>
+<html>
+  <body style="color: green">
+    This should be green
+  </body>
+<html>
+  
diff -r a4343d61f6ee layout/reftests/css-charset/reftest.list
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/css-charset/reftest.list	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,10 @@
+== test-attribute.html pass.html
+== test-charset-quotes.html pass.html
+== test-charset-leading-space.html pass.html
+== test-charset-trailing-space.html pass.html
+== test-charset-utf-16-le-no-bom.html pass.html
+fails == test-charset-utf-16-le-bom.html pass.html
+== test-charset-utf-16-bom-le.html pass.html
+== test-charset-utf-16-be-no-bom.html pass.html
+fails == test-charset-utf-16-be-bom.html pass.html
+== test-charset-utf-16-bom-be.html pass.html
diff -r a4343d61f6ee layout/reftests/css-charset/test-attribute.css
Binary file layout/reftests/css-charset/test-attribute.css has changed
diff -r a4343d61f6ee layout/reftests/css-charset/test-attribute.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/css-charset/test-attribute.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,14 @@
+<!DOCTYPE html>
+<html>
+  <head>
+    <style type="text/css">
+      body { color: red; }
+    </style>
+    <link rel="stylesheet" type="text/css" charset="UTF-16BE"
+          href="test-attribute.css">
+  </head>
+  <body>
+    This should be green
+  </body>
+<html>
+  
diff -r a4343d61f6ee layout/reftests/css-charset/test-charset-leading-space.css
Binary file layout/reftests/css-charset/test-charset-leading-space.css has changed
diff -r a4343d61f6ee layout/reftests/css-charset/test-charset-leading-space.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/css-charset/test-charset-leading-space.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,14 @@
+<!DOCTYPE html>
+<html>
+  <head>
+    <style type="text/css">
+      body { color: green; }
+    </style>
+    <link rel="stylesheet" type="text/css" charset="us-ascii"
+          href="test-charset-leading-space.css">
+  </head>
+  <body>
+    This should be green
+  </body>
+<html>
+  
diff -r a4343d61f6ee layout/reftests/css-charset/test-charset-quotes.css
Binary file layout/reftests/css-charset/test-charset-quotes.css has changed
diff -r a4343d61f6ee layout/reftests/css-charset/test-charset-quotes.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/css-charset/test-charset-quotes.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,14 @@
+<!DOCTYPE html>
+<html>
+  <head>
+    <style type="text/css">
+      body { color: green; }
+    </style>
+    <link rel="stylesheet" type="text/css" charset="us-ascii"
+          href="test-charset-quotes.css">
+  </head>
+  <body>
+    This should be green
+  </body>
+<html>
+  
diff -r a4343d61f6ee layout/reftests/css-charset/test-charset-trailing-space.css
Binary file layout/reftests/css-charset/test-charset-trailing-space.css has changed
diff -r a4343d61f6ee layout/reftests/css-charset/test-charset-trailing-space.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/css-charset/test-charset-trailing-space.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,14 @@
+<!DOCTYPE html>
+<html>
+  <head>
+    <style type="text/css">
+      body { color: green; }
+    </style>
+    <link rel="stylesheet" type="text/css" charset="us-ascii"
+          href="test-charset-trailing-space.css">
+  </head>
+  <body>
+    This should be green
+  </body>
+<html>
+  
diff -r a4343d61f6ee layout/reftests/css-charset/test-charset-utf-16-be-bom.css
Binary file layout/reftests/css-charset/test-charset-utf-16-be-bom.css has changed
diff -r a4343d61f6ee layout/reftests/css-charset/test-charset-utf-16-be-bom.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/css-charset/test-charset-utf-16-be-bom.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,14 @@
+<!DOCTYPE html>
+<html>
+  <head>
+    <style type="text/css">
+      body { color: green; }
+    </style>
+    <link rel="stylesheet" type="text/css" charset="us-ascii"
+          href="test-charset-utf-16-be-bom.css">
+  </head>
+  <body>
+    This should be green
+  </body>
+<html>
+  
diff -r a4343d61f6ee layout/reftests/css-charset/test-charset-utf-16-be-no-bom.css
Binary file layout/reftests/css-charset/test-charset-utf-16-be-no-bom.css has changed
diff -r a4343d61f6ee layout/reftests/css-charset/test-charset-utf-16-be-no-bom.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/css-charset/test-charset-utf-16-be-no-bom.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,14 @@
+<!DOCTYPE html>
+<html>
+  <head>
+    <style type="text/css">
+      body { color: red; }
+    </style>
+    <link rel="stylesheet" type="text/css" charset="us-ascii"
+          href="test-charset-utf-16-be-no-bom.css">
+  </head>
+  <body>
+    This should be green
+  </body>
+<html>
+  
diff -r a4343d61f6ee layout/reftests/css-charset/test-charset-utf-16-bom-be.css
Binary file layout/reftests/css-charset/test-charset-utf-16-bom-be.css has changed
diff -r a4343d61f6ee layout/reftests/css-charset/test-charset-utf-16-bom-be.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/css-charset/test-charset-utf-16-bom-be.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,14 @@
+<!DOCTYPE html>
+<html>
+  <head>
+    <style type="text/css">
+      body { color: red; }
+    </style>
+    <link rel="stylesheet" type="text/css" charset="us-ascii"
+          href="test-charset-utf-16-bom-be.css">
+  </head>
+  <body>
+    This should be green
+  </body>
+<html>
+  
diff -r a4343d61f6ee layout/reftests/css-charset/test-charset-utf-16-bom-le.css
Binary file layout/reftests/css-charset/test-charset-utf-16-bom-le.css has changed
diff -r a4343d61f6ee layout/reftests/css-charset/test-charset-utf-16-bom-le.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/css-charset/test-charset-utf-16-bom-le.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,14 @@
+<!DOCTYPE html>
+<html>
+  <head>
+    <style type="text/css">
+      body { color: red; }
+    </style>
+    <link rel="stylesheet" type="text/css" charset="us-ascii"
+          href="test-charset-utf-16-bom-le.css">
+  </head>
+  <body>
+    This should be green
+  </body>
+<html>
+  
diff -r a4343d61f6ee layout/reftests/css-charset/test-charset-utf-16-le-bom.css
Binary file layout/reftests/css-charset/test-charset-utf-16-le-bom.css has changed
diff -r a4343d61f6ee layout/reftests/css-charset/test-charset-utf-16-le-bom.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/css-charset/test-charset-utf-16-le-bom.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,14 @@
+<!DOCTYPE html>
+<html>
+  <head>
+    <style type="text/css">
+      body { color: green; }
+    </style>
+    <link rel="stylesheet" type="text/css" charset="us-ascii"
+          href="test-charset-utf-16-le-bom.css">
+  </head>
+  <body>
+    This should be green
+  </body>
+<html>
+  
diff -r a4343d61f6ee layout/reftests/css-charset/test-charset-utf-16-le-no-bom.css
Binary file layout/reftests/css-charset/test-charset-utf-16-le-no-bom.css has changed
diff -r a4343d61f6ee layout/reftests/css-charset/test-charset-utf-16-le-no-bom.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/css-charset/test-charset-utf-16-le-no-bom.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,14 @@
+<!DOCTYPE html>
+<html>
+  <head>
+    <style type="text/css">
+      body { color: red; }
+    </style>
+    <link rel="stylesheet" type="text/css" charset="us-ascii"
+          href="test-charset-utf-16-le-no-bom.css">
+  </head>
+  <body>
+    This should be green
+  </body>
+<html>
+  
diff -r a4343d61f6ee layout/reftests/font-face/cross-iframe-1-inner-1.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/cross-iframe-1-inner-1.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,26 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkA";
+		src: url(../fonts/markA.ttf);
+	}
+
+	html, body {
+		margin: 0;
+		padding: 0;
+	}
+
+	</style>
+</head>
+<body>
+
+<p><span style="font-family: MarkA">A</span><span style="font-family: MarkB">B</span><span style="font-family: MarkC">C</span></p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/cross-iframe-1-inner-2.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/cross-iframe-1-inner-2.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,26 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkB";
+		src: url(../fonts/markB.ttf);
+	}
+
+	html, body {
+		margin: 0;
+		padding: 0;
+	}
+
+	</style>
+</head>
+<body>
+
+<p><span style="font-family: MarkA">A</span><span style="font-family: MarkB">B</span><span style="font-family: MarkC">C</span></p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/cross-iframe-1-ref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/cross-iframe-1-ref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,37 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkD";
+		src: url(../fonts/markD.ttf);
+	}
+
+	div {
+		margin: 0;
+		border: none;
+		padding: 0;
+		position: absolute;
+		left: 0;
+	}
+
+	</style>
+</head>
+<body>
+
+<!-- use nonexistent family to prevent kerning -->
+<p><span style="font-family: Nonexistent1">A</span><span style="font-family: Nonexistent2">B</span><span style="font-family: MarkD">D</span></p>
+
+<div style="top: 4em" src="cross-iframe-1-inner-1.html">
+<p><span style="font-family: MarkD">D</span><span style="font-family: Nonexistent2">B</span><span style="font-family: Nonexistent1">C</span></p>
+</div>
+<div style="top: 7em" src="cross-iframe-1-inner-2.html">
+<p><span>A</span><span style="font-family: MarkD">D</span><span>C</span></p>
+</div>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/cross-iframe-1.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/cross-iframe-1.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,32 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkC";
+		src: url(../fonts/markC.ttf);
+	}
+
+	iframe {
+		margin: 0;
+		border: none;
+		padding: 0;
+		position: absolute;
+		left: 0;
+	}
+
+	</style>
+</head>
+<body>
+
+<p><span style="font-family: MarkA">A</span><span style="font-family: MarkB">B</span><span style="font-family: MarkC">C</span></p>
+
+<iframe style="top: 4em" src="cross-iframe-1-inner-1.html"></iframe>
+<iframe style="top: 7em" src="cross-iframe-1-inner-2.html"></iframe>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/download-1-notref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/download-1-notref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,18 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	body { font-family: "MarkA"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/download-1.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/download-1.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkA";
+		src: url(../fonts/markA.ttf);
+	}
+
+	body { font-family: "MarkA"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/download-2-ref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/download-2-ref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkB";
+		src: url(../fonts/markB.ttf);
+	}
+
+	body { font-family: "MarkB"; }
+
+	</style>
+</head>
+<body>
+
+<p>B</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/download-2.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/download-2.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkA";
+		src: url(../fonts/markA.ttf);
+	}
+
+	body { font-family: "MarkA"; }
+
+	</style>
+</head>
+<body>
+
+<p>A</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/fallback-to-system-1-ref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/fallback-to-system-1-ref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,24 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	span {
+		/* to ensure the same vertical positioning of the text */
+		display: inline-block;
+		height: 3em;
+		width: 1em;
+		vertical-align: baseline;
+	}
+
+	</style>
+</head>
+<body>
+
+<p>DEF<span></span></p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/fallback-to-system-1.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/fallback-to-system-1.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,31 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkA";
+		src: url(../fonts/markA.ttf);
+	}
+
+	body { font-family: "MarkA"; line-height: 1.5em; }
+
+	span {
+		/* to ensure the same vertical positioning of the text */
+		display: inline-block;
+		height: 3em;
+		width: 1em;
+		vertical-align: baseline;
+	}
+
+	</style>
+</head>
+<body>
+
+<p>DEF<span></span></p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/multiple-descriptor-1-notref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/multiple-descriptor-1-notref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,14 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+</head>
+<body>
+
+<p>ABC</p>
+<p>ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/multiple-descriptor-1-ref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/multiple-descriptor-1-ref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,24 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	/* The last descriptor in a given rule wins, per CSS 2.0 */
+
+	@font-face {
+		src: url(../fonts/markA.ttf);
+		font-family: "MarkA";
+	}
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+<p style="font-family: MarkA">ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/multiple-descriptor-1.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/multiple-descriptor-1.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,26 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	/* The last descriptor in a given rule wins, per CSS 2.0 */
+
+	@font-face {
+		font-family: "One";
+		src: url(../fonts/markB.ttf);
+		src: url(../fonts/markA.ttf);
+		font-family: "Two";
+	}
+
+	</style>
+</head>
+<body>
+
+<p style="font-family: One">ABC</p>
+<p style="font-family: Two">ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/multiple-in-family-1-notref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/multiple-in-family-1-notref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,26 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkA";
+		src: url(../fonts/markA.ttf);
+	}
+
+	body { font-family: "MarkA"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+<p>A</p>
+<p>B</p>
+<p>C</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/multiple-in-family-1-ref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/multiple-in-family-1-ref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,34 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkA";
+		src: url(../fonts/markA.ttf);
+	}
+
+	@font-face {
+		font-family: "MarkB";
+		src: url(../fonts/markB.ttf);
+	}
+
+	@font-face {
+		font-family: "MarkD";
+		src: url(../fonts/markD.ttf);
+	}
+
+	</style>
+</head>
+<body>
+
+<p style="font-family: MarkD">DDC</p>
+<p style="font-family: MarkA">A</p>
+<p style="font-family: MarkB">B</p>
+<p style="font-family: MarkA">C</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/multiple-in-family-1.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/multiple-in-family-1.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,31 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkA";
+		src: url(../fonts/markA.ttf);
+	}
+
+	@font-face {
+		font-family: "MarkB";
+		src: url(../fonts/markB.ttf);
+	}
+
+	body { font-family: "MarkA", "MarkB"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+<p>A</p>
+<p>B</p>
+<p>C</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/name-override-1-ref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/name-override-1-ref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkD";
+		src: url(../fonts/markD.ttf);
+	}
+
+	body { font-family: "MarkD"; }
+
+	</style>
+</head>
+<body>
+
+<p>DBD</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/name-override-1.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/name-override-1.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "Foobar";
+		src: url(../fonts/markA.ttf), url(../fonts/markC.ttf);
+	}
+
+	body { font-family: "Foobar"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/name-override-simple-1-ref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/name-override-simple-1-ref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkD";
+		src: url(../fonts/markD.ttf);
+	}
+
+	body { font-family: "MarkD"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABD</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/name-override-simple-1.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/name-override-simple-1.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "Foobar";
+		src: url(../fonts/markC.ttf);
+	}
+
+	body { font-family: "Foobar"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/order-1-ref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/order-1-ref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkA";
+		src: url(../fonts/markA.ttf);
+	}
+
+	body { font-family: "MarkA"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/order-1.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/order-1.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,28 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "One";
+		src: url(../fonts/mark2A.ttf);
+	}
+
+	@font-face {
+		font-family: "One";
+		src: url(../fonts/markA.ttf);
+	}
+
+	body { font-family: "One"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/order-2-ref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/order-2-ref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkXMark2Y";
+		src: url(../fonts/markXmark2Y.ttf);
+	}
+
+	body { font-family: "MarkXMark2Y"; }
+
+	</style>
+</head>
+<body>
+
+<p>XYC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/order-2.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/order-2.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,38 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "One";
+		src: url(../fonts/markB.ttf);
+	}
+
+	@font-face {
+		font-family: "One";
+		src: url(../fonts/mark2B.ttf);
+	}
+
+	@font-face {
+		font-family: "One";
+		src: url(../fonts/mark2A.ttf);
+	}
+
+	@font-face {
+		font-family: "One";
+		src: url(../fonts/markA.ttf);
+	}
+
+	body { font-family: "One"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/order-3-ref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/order-3-ref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkXMark2Y";
+		src: url(../fonts/markXmark2Y.ttf);
+	}
+
+	body { font-family: "MarkXMark2Y"; }
+
+	</style>
+</head>
+<body>
+
+<p>XYC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/order-3.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/order-3.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,38 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "One";
+		src: url(../fonts/markB.ttf);
+	}
+
+	@font-face {
+		font-family: "One";
+		src: url(../fonts/mark2A.ttf);
+	}
+
+	@font-face {
+		font-family: "One";
+		src: url(../fonts/mark2B.ttf);
+	}
+
+	@font-face {
+		font-family: "One";
+		src: url(../fonts/markA.ttf);
+	}
+
+	body { font-family: "One"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/prop-order-over-rule-order-1a.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/prop-order-over-rule-order-1a.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,28 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkA";
+		src: url(../fonts/markA.ttf);
+	}
+
+	@font-face {
+		font-family: "MarkB";
+		src: url(../fonts/markB.ttf);
+	}
+
+	body { font-family: "MarkA", "MarkB"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/prop-order-over-rule-order-1b.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/prop-order-over-rule-order-1b.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,28 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkA";
+		src: url(../fonts/markA.ttf);
+	}
+
+	@font-face {
+		font-family: "MarkB";
+		src: url(../fonts/markB.ttf);
+	}
+
+	body { font-family: "MarkB", "MarkA"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/prop-order-over-rule-order-2a.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/prop-order-over-rule-order-2a.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,28 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkB";
+		src: url(../fonts/markB.ttf);
+	}
+
+	@font-face {
+		font-family: "MarkA";
+		src: url(../fonts/markA.ttf);
+	}
+
+	body { font-family: "MarkA", "MarkB"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/prop-order-over-rule-order-2b.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/prop-order-over-rule-order-2b.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,28 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkB";
+		src: url(../fonts/markB.ttf);
+	}
+
+	@font-face {
+		font-family: "MarkA";
+		src: url(../fonts/markA.ttf);
+	}
+
+	body { font-family: "MarkB", "MarkA"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/reftest.list
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/reftest.list	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,29 @@
+# Everything here uses HTTP(..) because they use fonts in ../fonts/.  We
+# can't use file:/// URLs because of cross-directory access restrictions
+# on file: URLs.
+
+fails-if(MOZ_WIDGET_TOOLKIT=="gtk2") HTTP(..) != download-1.html download-1-notref.html
+fails-if(MOZ_WIDGET_TOOLKIT=="gtk2") HTTP(..) == download-2.html download-2-ref.html
+HTTP(..) != download-2.html about:blank
+HTTP(..) == fallback-to-system-1.html fallback-to-system-1-ref.html
+fails-if(MOZ_WIDGET_TOOLKIT=="gtk2") HTTP(..) == name-override-simple-1.html name-override-simple-1-ref.html
+fails-if(MOZ_WIDGET_TOOLKIT=="gtk2") HTTP(..) != name-override-simple-1.html download-1-notref.html
+fails HTTP(..) == name-override-1.html name-override-1-ref.html
+HTTP(..) == multiple-descriptor-1.html multiple-descriptor-1-ref.html
+fails-if(MOZ_WIDGET_TOOLKIT=="gtk2") HTTP(..) != multiple-descriptor-1.html multiple-descriptor-1-notref.html
+fails-if(MOZ_WIDGET_TOOLKIT=="gtk2") HTTP(..) == src-list-1.html src-list-1-ref.html
+fails-if(MOZ_WIDGET_TOOLKIT=="gtk2") random-if(MOZ_WIDGET_TOOLKIT=="cocoa") random-if(MOZ_WIDGET_TOOLKIT=="windows") HTTP(..) == src-list-2.html src-list-2-ref.html # random probably fixed by the font cache patch on bug 457821
+fails HTTP(..) == src-list-format-1.html src-list-format-1-ref.html
+fails HTTP(..) == src-list-format-2.html src-list-format-2-ref.html
+fails-if(MOZ_WIDGET_TOOLKIT=="gtk2") HTTP(..) == src-list-format-3.html src-list-format-3-ref.html
+# FIXME: The behavior here is neither mandated nor specified by the spec, but
+# it really ought to be.
+HTTP(..) == order-1.html order-1-ref.html
+fails HTTP(..) == order-2.html order-2-ref.html
+fails HTTP(..) == order-3.html order-3-ref.html
+fails-if(MOZ_WIDGET_TOOLKIT=="gtk2") fails-if(MOZ_WIDGET_TOOLKIT=="cocoa") random-if(MOZ_WIDGET_TOOLKIT=="windows") HTTP(..) == multiple-in-family-1.html multiple-in-family-1-ref.html
+fails-if(MOZ_WIDGET_TOOLKIT=="gtk2") fails-if(MOZ_WIDGET_TOOLKIT=="cocoa") random-if(MOZ_WIDGET_TOOLKIT=="windows") HTTP(..) != multiple-in-family-1.html multiple-in-family-1-notref.html
+random-if(MOZ_WIDGET_TOOLKIT=="windows") random-if(MOZ_WIDGET_TOOLKIT=="cocoa") HTTP(..) == prop-order-over-rule-order-1a.html prop-order-over-rule-order-2a.html # randomness on cocoa should be fixed by the font cache patch on bug 457821
+random-if(MOZ_WIDGET_TOOLKIT=="windows") HTTP(..) == prop-order-over-rule-order-1b.html prop-order-over-rule-order-2b.html
+random-if(MOZ_WIDGET_TOOLKIT=="windows") fails-if(MOZ_WIDGET_TOOLKIT=="gtk2") HTTP(..) != prop-order-over-rule-order-1a.html prop-order-over-rule-order-1b.html
+fails-if(MOZ_WIDGET_TOOLKIT=="gtk2") HTTP(..) == cross-iframe-1.html cross-iframe-1-ref.html
diff -r a4343d61f6ee layout/reftests/font-face/src-list-1-ref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/src-list-1-ref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkD";
+		src: url(../fonts/markD.ttf);
+	}
+
+	body { font-family: "MarkD"; }
+
+	</style>
+</head>
+<body>
+
+<p>DBC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/src-list-1.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/src-list-1.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "One";
+		src: url(../fonts/markA.ttf), url(../fonts/mark2A.ttf);
+	}
+
+	body { font-family: "One"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/src-list-2-ref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/src-list-2-ref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkD";
+		src: url(../fonts/markD.ttf);
+	}
+
+	body { font-family: MarkD; }
+
+	</style>
+</head>
+<body>
+
+<p>DBC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/src-list-2.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/src-list-2.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "One";
+		src: url(../fonts/markA.ttf), url(../fonts/markB.ttf);
+	}
+
+	body { font-family: "One"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/src-list-format-1-ref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/src-list-format-1-ref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "Mark2D";
+		src: url(../fonts/mark2D.ttf);
+	}
+
+	body { font-family: "Mark2D"; }
+
+	</style>
+</head>
+<body>
+
+<p>DBC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/src-list-format-1.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/src-list-format-1.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "One";
+		src: url(../fonts/markA.ttf) format("unknown"), url(../fonts/mark2A.ttf);
+	}
+
+	body { font-family: "One"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/src-list-format-2-ref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/src-list-format-2-ref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "Mark2D";
+		src: url(../fonts/mark2D.ttf);
+	}
+
+	body { font-family: "Mark2D"; }
+
+	</style>
+</head>
+<body>
+
+<p>DBC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/src-list-format-2.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/src-list-format-2.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "One";
+		src: url(../fonts/markA.ttf) format("unknown"), url(../fonts/mark2A.ttf) format("truetype");
+	}
+
+	body { font-family: "One"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/src-list-format-3-ref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/src-list-format-3-ref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "MarkD";
+		src: url(../fonts/markD.ttf);
+	}
+
+	body { font-family: MarkD; }
+
+	</style>
+</head>
+<body>
+
+<p>DBC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/font-face/src-list-format-3.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/font-face/src-list-format-3.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title></title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<style type="text/css">
+
+	@font-face {
+		font-family: "One";
+		src: url(../fonts/markA.ttf) format("unknown", "truetype"), url(../fonts/mark2A.ttf) format("truetype");
+	}
+
+	body { font-family: "One"; }
+
+	</style>
+</head>
+<body>
+
+<p>ABC</p>
+
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/fonts/mark-generate.py
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/fonts/mark-generate.py	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,87 @@
+#!/usr/bin/python
+# vim: set shiftwidth=4 tabstop=8 autoindent expandtab:
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is mark-generate.py .
+#
+# The Initial Developer of the Original Code is the Mozilla Foundation.
+# Portions created by the Initial Developer are Copyright (C) 2008
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#   L. David Baron <dbaron@dbaron.org>, Mozilla Corporation (original author)
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+# For general fontforge documentation, see:
+#   http://fontforge.sourceforge.net/
+# For fontforge scripting documentation, see:
+#   http://fontforge.sourceforge.net/scripting-tutorial.html
+#   http://fontforge.sourceforge.net/scripting.html
+# and most importantly:
+#   http://fontforge.sourceforge.net/python.html
+
+# To install what you need, on Ubuntu,
+#   sudo apt-get install python-fontforge
+
+import fontforge
+
+# generate a set of fonts, each with our special glyph at one codepoint,
+# and nothing else
+for codepoint in range(ord("A"), ord("D") + 1):
+    for (mark, width) in [("", 1500), ("2", 1800)]:
+        charname = chr(codepoint)
+        f = fontforge.font()
+        n = "Mark" + mark + charname
+        f.fontname = n
+        f.familyname = n
+        f.fullname = n
+        f.copyright = "Copyright (c) 2008 Mozilla Corporation"
+
+        g = f.createChar(codepoint, charname)
+        g.importOutlines("mark" + mark + "-glyph.svg")
+        g.width = width
+
+        f.generate("mark" + mark + charname + ".ttf")
+
+# And, for references, generate markXmark2Y
+f = fontforge.font()
+n = "MarkXMark2Y"
+f.fontname = n
+f.familyname = n
+f.fullname = n
+f.copyright = "Copyright (c) 2008 Mozilla Corporation"
+
+g = f.createChar(ord("X"), "X")
+g.importOutlines("mark-glyph.svg")
+g.width = 1500
+
+g = f.createChar(ord("Y"), "Y")
+g.importOutlines("mark2-glyph.svg")
+g.width = 1800
+
+f.generate("markXmark2Y.ttf")
+
diff -r a4343d61f6ee layout/reftests/fonts/mark-glyph.svg
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/fonts/mark-glyph.svg	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,6 @@
+<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewbox="0 0 1500 1000" width="1500px" height="1000px">
+  <rect x="500" y="100" height="200" width="500" fill="black" />
+  <rect x="300" y="400" height="200" width="900" fill="black" />
+  <!-- baseline defaults to being at 800 -->
+  <rect x="100" y="700" height="200" width="1300" fill="black" />
+</svg>
diff -r a4343d61f6ee layout/reftests/fonts/mark2-glyph.svg
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/fonts/mark2-glyph.svg	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,3 @@
+<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewbox="0 0 1800 1000" width="1800px" height="1000px">
+  <polygon fill="black" points="100,100 100,800 1700,800 1700,100 1500,100 1500,600 300,600 300,100" />
+</svg>
diff -r a4343d61f6ee layout/reftests/fonts/mark2A.ttf
Binary file layout/reftests/fonts/mark2A.ttf has changed
diff -r a4343d61f6ee layout/reftests/fonts/mark2B.ttf
Binary file layout/reftests/fonts/mark2B.ttf has changed
diff -r a4343d61f6ee layout/reftests/fonts/mark2C.ttf
Binary file layout/reftests/fonts/mark2C.ttf has changed
diff -r a4343d61f6ee layout/reftests/fonts/mark2D.ttf
Binary file layout/reftests/fonts/mark2D.ttf has changed
diff -r a4343d61f6ee layout/reftests/fonts/markA.ttf
Binary file layout/reftests/fonts/markA.ttf has changed
diff -r a4343d61f6ee layout/reftests/fonts/markB.ttf
Binary file layout/reftests/fonts/markB.ttf has changed
diff -r a4343d61f6ee layout/reftests/fonts/markC.ttf
Binary file layout/reftests/fonts/markC.ttf has changed
diff -r a4343d61f6ee layout/reftests/fonts/markD.ttf
Binary file layout/reftests/fonts/markD.ttf has changed
diff -r a4343d61f6ee layout/reftests/fonts/markXmark2Y.ttf
Binary file layout/reftests/fonts/markXmark2Y.ttf has changed
diff -r a4343d61f6ee layout/reftests/generated-content/square-outline-32x32.png
Binary file layout/reftests/generated-content/square-outline-32x32.png has changed
diff -r a4343d61f6ee layout/reftests/pixel-rounding/corner-bl.png
Binary file layout/reftests/pixel-rounding/corner-bl.png has changed
diff -r a4343d61f6ee layout/reftests/pixel-rounding/corner-tr.png
Binary file layout/reftests/pixel-rounding/corner-tr.png has changed
diff -r a4343d61f6ee layout/reftests/pixel-rounding/random-10x10.png
Binary file layout/reftests/pixel-rounding/random-10x10.png has changed
diff -r a4343d61f6ee layout/reftests/reftest-sanity/blank.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/reftest-sanity/blank.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,5 @@
+<!DOCTYPE html>
+<html>
+<body>
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/reftest-sanity/reftest.list
--- a/layout/reftests/reftest-sanity/reftest.list	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/reftests/reftest-sanity/reftest.list	Sat Nov 15 19:43:13 2008 -0500
@@ -14,8 +14,21 @@
 != html-vs-xhtml-by-extension.html html-vs-xhtml-by-extension.xhtml
 HTTP != html-vs-xhtml-by-extension.html html-vs-xhtml-by-extension.xhtml
 
 # make sure red and green colors are not the default and are different from
 # each other
 != green.html default.html
 != green.html red.html
 != red.html default.html
+
+# Make sure about:blank works, even via HTTP.
+== blank.html about:blank
+== about:blank blank.html
+HTTP == blank.html about:blank
+HTTP == about:blank blank.html
+# same for data:
+== default.html data:text/html,<div>Text</div>
+== data:text/html,<div>Text</div> default.html
+HTTP == default.html data:text/html,<div>Text</div>
+HTTP == data:text/html,<div>Text</div> default.html
+!= blank.html default.html
+HTTP != blank.html default.html
diff -r a4343d61f6ee layout/reftests/reftest.list
--- a/layout/reftests/reftest.list	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/reftests/reftest.list	Sat Nov 15 19:43:13 2008 -0500
@@ -30,16 +30,19 @@ include bugs/reftest.list
 include bugs/reftest.list
 
 # canvas 2D
 include canvas/reftest.list
 
 # css @import tests
 include css-import/reftest.list
 
+# css character encoding tests
+include css-charset/reftest.list
+
 # columns/
 include columns/reftest.list
 
 # content/
 include ../../content/test/reftest/reftest.list
 
 # counters/
 include counters/reftest.list
@@ -47,16 +50,19 @@ include counters/reftest.list
 # generated-content/
 include generated-content/reftest.list
 
 # first-letter/
 include first-letter/reftest.list
 
 # first-line/
 include first-line/reftest.list
+
+# font-face
+include font-face/reftest.list
 
 # forms
 include forms/reftest.list
 
 # block-inside-inline splits
 include ib-split/reftest.list
 
 # image-region/
diff -r a4343d61f6ee layout/reftests/table-background/repeatable-diagonal-gradient-with-ticks.png
Binary file layout/reftests/table-background/repeatable-diagonal-gradient-with-ticks.png has changed
diff -r a4343d61f6ee layout/reftests/text/font-selection-by-lang-01-ref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/text/font-selection-by-lang-01-ref.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,23 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
+<html>
+<head>
+	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
+	<meta http-equiv="Content-Style-Type" content="text/css">
+	<title>test for font selection by language reference</title>
+	<!-- A unique name is included in font-family
+	     to force a new cache entry for each element.
+	     -->
+	<style type="text/css">
+	p.a {
+	        font-family: sans-serif, font-selection-by-lang-1;
+	}
+	p.b {
+	        font-family: sans-serif, font-selection-by-lang-2;
+	}
+	</style>
+</head>
+<body>
+  <p class="a" lang="ja">0123456789<p>
+  <p class="b" lang="en">0123456789<p>
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/text/font-selection-by-lang-01.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/text/font-selection-by-lang-01.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,20 @@
+<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
+<html>
+<head>
+	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
+	<meta http-equiv="Content-Style-Type" content="text/css">
+	<title>test for font selection by language</title>
+	<!-- Checks that caches do not cause the lang="ja" font to be used for
+	     the lang="en" element.
+	     -->
+	<style type="text/css">
+	p {
+	        font-family: sans-serif;
+	}
+	</style>
+</head>
+<body>
+  <p lang="ja">0123456789<p>
+  <p lang="en">0123456789<p>
+</body>
+</html>
diff -r a4343d61f6ee layout/reftests/text/reftest.list
--- a/layout/reftests/text/reftest.list	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/reftests/text/reftest.list	Sat Nov 15 19:43:13 2008 -0500
@@ -1,9 +1,10 @@
 == fallback-01.xhtml fallback-01-ref.xhtml
+== font-selection-by-lang-01.html font-selection-by-lang-01-ref.html
 == justification-1.html justification-1-ref.html
 == justification-2a.html justification-2-ref.html
 == justification-2b.html justification-2-ref.html
 == long-1.html long-ref.html
 == pre-line-1.html pre-line-1-ref.html
 == pre-line-2.html pre-line-2-ref.html
 == pre-line-3.html pre-line-3-ref.html
 == soft-hyphens-1a.html soft-hyphens-1-ref.html
diff -r a4343d61f6ee layout/style/nsCSSLoader.cpp
--- a/layout/style/nsCSSLoader.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/style/nsCSSLoader.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -440,17 +440,17 @@ CSSLoaderImpl::RecycleParser(nsICSSParse
   }
 
   // Make sure the parser doesn't keep the last sheet it parsed alive
   aParser->SetStyleSheet(nsnull);
   
   return NS_OK;
 }
 
-static const char kCharsetSym[] = "@charset";
+static const char kCharsetSym[] = "@charset \"";
 
 static nsresult GetCharsetFromData(const unsigned char* aStyleSheetData,
                                    PRUint32 aDataLength,
                                    nsACString& aCharset)
 {
   aCharset.Truncate();
   if (aDataLength <= sizeof(kCharsetSym) - 1)
     return NS_ERROR_NOT_AVAILABLE;
@@ -571,49 +571,29 @@ static nsresult GetCharsetFromData(const
       // we can just return NS_OK even if there is no valid @charset
       // rule.
       return aCharset.IsEmpty() ? NS_ERROR_NOT_AVAILABLE : NS_OK;
     }
     ++index;
     pos += step;
   }
 
-  while (pos < aDataLength && nsCRT::IsAsciiSpace(aStyleSheetData[pos])) {
-    pos += step;
-  }
-
-  if (pos >= aDataLength ||
-      (aStyleSheetData[pos] != '"' && aStyleSheetData[pos] != '\'')) {
-    return aCharset.IsEmpty() ? NS_ERROR_NOT_AVAILABLE : NS_OK;
-  }
-
-  char quote = aStyleSheetData[pos];
-  pos += step;
   nsCAutoString charset;
   while (pos < aDataLength) {
-    if (aStyleSheetData[pos] == '\\') {
-      pos += step;
-      if (pos >= aDataLength) {
-        break;
-      }          
-    } else if (aStyleSheetData[pos] == quote) {
+    if (aStyleSheetData[pos] == '"') {
       break;
     }
     
     // casting to avoid ambiguities
     charset.Append(char(aStyleSheetData[pos]));
     pos += step;
   }
 
   // Check for the ending ';'
   pos += step;
-  while (pos < aDataLength && nsCRT::IsAsciiSpace(aStyleSheetData[pos])) {
-    pos += step;    
-  }
-
   if (pos >= aDataLength || aStyleSheetData[pos] != ';') {
     return aCharset.IsEmpty() ? NS_ERROR_NOT_AVAILABLE : NS_OK;
   }
 
   aCharset = charset;
   return NS_OK;
 }
 
diff -r a4343d61f6ee layout/style/nsCSSParser.cpp
--- a/layout/style/nsCSSParser.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/style/nsCSSParser.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -3177,17 +3177,18 @@ CSSParserImpl::ParseNegatedSimpleSelecto
     return eSelectorParsingStatus_Error;
   }
 
   // Create a new nsCSSSelector and add it to the end of
   // aSelector.mNegations.
   // Given the current parsing rules, every selector in mNegations
   // contains only one simple selector (css3 definition) within it.
   // This could easily change in future versions of CSS, and the only
-  // thing we need to change to support that is this parsing code.
+  // thing we need to change to support that is this parsing code and the
+  // serialization code for nsCSSSelector.
   nsCSSSelector *newSel = new nsCSSSelector();
   if (!newSel) {
     mScanner.SetLowLevelError(NS_ERROR_OUT_OF_MEMORY);
     return eSelectorParsingStatus_Error;
   }
   nsCSSSelector* negations = &aSelector;
   while (negations->mNegations) {
     negations = negations->mNegations;
@@ -3215,16 +3216,21 @@ CSSParserImpl::ParseNegatedSimpleSelecto
     REPORT_UNEXPECTED_TOKEN(PENegationBadInner);
     return parsingStatus;
   }
   // close the parenthesis
   if (!ExpectSymbol(')', PR_TRUE)) {
     REPORT_UNEXPECTED_TOKEN(PENegationNoClose);
     return eSelectorParsingStatus_Error;
   }
+
+  NS_ASSERTION(newSel->mNameSpace == kNameSpaceID_Unknown ||
+               (!newSel->mIDList && !newSel->mClassList &&
+                !newSel->mPseudoClassList && !newSel->mAttrList),
+               "Need to fix the serialization code to deal with this");
 
   return eSelectorParsingStatus_Continue;
 }
 
 //
 // Parse the argument of a pseudo-class that has an ident arg
 //
 CSSParserImpl::nsSelectorParsingStatus
diff -r a4343d61f6ee layout/style/nsCSSStyleRule.cpp
--- a/layout/style/nsCSSStyleRule.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/style/nsCSSStyleRule.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -499,57 +499,56 @@ void nsCSSSelector::ToStringInternal(nsA
     }
   }
 
   // For non-pseudo-element selectors or for lone pseudo-elements, deal with
   // namespace prefixes.
   PRBool wroteNamespace = PR_FALSE;
   if (!isPseudoElement || !mNext) {
     // append the namespace prefix if needed
-    if (mNameSpace == kNameSpaceID_None) {
-      // The only way to do this in CSS is to have an explicit namespace
-      // of "none" specified in the sheet by having a '|' with nothing
-      // before it.
+    nsXMLNameSpaceMap *sheetNS = aSheet ? aSheet->GetNameSpaceMap() : nsnull;
+
+    // sheetNS is non-null if and only if we had an @namespace rule.  If it's
+    // null, that means that the only namespaces we could have are the
+    // wildcard namespace (which can be implicit in this case) and the "none"
+    // namespace, which then needs to be explicitly specified.
+    if (!sheetNS) {
+      NS_ASSERTION(mNameSpace == kNameSpaceID_Unknown ||
+                   mNameSpace == kNameSpaceID_None,
+                   "How did we get this namespace?");
+      if (mNameSpace == kNameSpaceID_None) {
+        aString.Append(PRUnichar('|'));
+        wroteNamespace = PR_TRUE;
+      }
+    } else if (sheetNS->FindNameSpaceID(nsnull) == mNameSpace) {
+      // We have the default namespace (possibly including the wildcard
+      // namespace).  Do nothing.
+      NS_ASSERTION(mNameSpace == kNameSpaceID_Unknown ||
+                   CanBeNamespaced(aIsNegated),
+                   "How did we end up with this namespace?");
+    } else if (mNameSpace != kNameSpaceID_Unknown) {
+      NS_ASSERTION(CanBeNamespaced(aIsNegated),
+                   "How did we end up with this namespace?");
+      nsIAtom *prefixAtom = sheetNS->FindPrefix(mNameSpace);
+      NS_ASSERTION(prefixAtom, "how'd we get a non-default namespace "
+                   "without a prefix?");
+      nsAutoString prefix;
+      prefixAtom->ToString(prefix);
+      aString.Append(prefix);
       aString.Append(PRUnichar('|'));
       wroteNamespace = PR_TRUE;
     } else {
-      if (aSheet) {
-        nsXMLNameSpaceMap *sheetNS = aSheet->GetNameSpaceMap();
-    
-        // sheetNS is non-null if and only if we had an @namespace rule.  If it's
-        // null, that means that the only namespaces we could have are the
-        // wildcard namespace (which can be implicit in this case) and the "none"
-        // namespace, which we handled above.  So no need to output anything when
-        // sheetNS is null.
-        if (sheetNS) {
-          if (mNameSpace != kNameSpaceID_Unknown) {
-            if (sheetNS->FindNameSpaceID(nsnull) != mNameSpace) {
-              nsIAtom *prefixAtom = sheetNS->FindPrefix(mNameSpace);
-              NS_ASSERTION(prefixAtom, "how'd we get a non-default namespace "
-                                       "without a prefix?");
-              nsAutoString prefix;
-              prefixAtom->ToString(prefix);
-              aString.Append(prefix);
-              aString.Append(PRUnichar('|'));
-              wroteNamespace = PR_TRUE;
-            }
-            // otherwise it must be the default namespace
-          } else {
-            // A selector for an element in any namespace.
-            if (// Use explicit "*|" only when it's not implied
-                sheetNS->FindNameSpaceID(nsnull) != kNameSpaceID_None &&
-                // :not() is special in that the default namespace is
-                // not implied for non-type selectors
-                (!aIsNegated || (!mIDList && !mClassList &&
-                                 !mPseudoClassList && !mAttrList))) {
-              aString.AppendLiteral("*|");
-              wroteNamespace = PR_TRUE;
-            }
-          }
-        }
+      // A selector for an element in any namespace, while the default
+      // namespace is something else.  :not() is special in that the default
+      // namespace is not implied for non-type selectors, so if this is a
+      // negated non-type selector we don't need to output an explicit wildcard
+      // namespace here, since those default to a wildcard namespace.
+      if (CanBeNamespaced(aIsNegated)) {
+        aString.AppendLiteral("*|");
+        wroteNamespace = PR_TRUE;
       }
     }
   }
       
   if (!mTag) {
     // Universal selector:  avoid writing the universal selector when we
     // can avoid it, especially since we're required to avoid it for the
     // inside of :not()
@@ -697,16 +696,23 @@ void nsCSSSelector::ToStringInternal(nsA
   }
 
   // Append the operator only if the selector is not negated and is not
   // a pseudo-element
   if (!aIsNegated && mOperator && !aIsPseudoElem) {
     aString.Append(PRUnichar(' '));
     aString.Append(mOperator);
   }
+}
+
+PRBool
+nsCSSSelector::CanBeNamespaced(PRBool aIsNegated) const
+{
+  return !aIsNegated ||
+         (!mIDList && !mClassList && !mPseudoClassList && !mAttrList);
 }
 
 // -- nsCSSSelectorList -------------------------------
 
 nsCSSSelectorList::nsCSSSelectorList(void)
   : mSelectors(nsnull),
     mWeight(0),
     mNext(nsnull)
diff -r a4343d61f6ee layout/style/nsICSSStyleRule.h
--- a/layout/style/nsICSSStyleRule.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/style/nsICSSStyleRule.h	Sat Nov 15 19:43:13 2008 -0500
@@ -171,16 +171,20 @@ private:
 private:
   void AddPseudoClassInternal(nsPseudoClassList *aPseudoClass);
   nsCSSSelector* Clone(PRBool aDeepNext, PRBool aDeepNegations) const;
 
   void AppendNegationToString(nsAString& aString);
   void ToStringInternal(nsAString& aString, nsICSSStyleSheet* aSheet,
                         PRBool aIsPseudoElem,
                         PRBool aIsNegated) const;
+  // Returns true if this selector can have a namespace specified (which
+  // happens if and only if the default namespace would apply to this
+  // selector).
+  PRBool CanBeNamespaced(PRBool aIsNegated) const;
 
 public:
   PRInt32         mNameSpace;
   nsCOMPtr<nsIAtom> mTag;
   nsAtomList*     mIDList;
   nsAtomList*     mClassList;
   nsPseudoClassList* mPseudoClassList; // atom for the pseudo, string for
                                        // the argument to functional pseudos
diff -r a4343d61f6ee layout/style/test/Makefile.in
--- a/layout/style/test/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/style/test/Makefile.in	Sat Nov 15 19:43:13 2008 -0500
@@ -103,16 +103,17 @@ _TEST_FILES =	test_acid3_test46.html \
 		test_dont_use_document_colors.html \
 		test_font_face_parser.html \
 		test_inherit_computation.html \
 		test_inherit_storage.html \
 		test_initial_computation.html \
 		test_initial_storage.html \
 		test_media_queries.html \
 		test_media_queries_dynamic_xbl.html \
+		test_namespace_rule.html \
 		test_of_type_selectors.xhtml \
 		test_parse_rule.html \
 		test_property_database.html \
 		test_property_syntax_errors.html \
 		test_selectors.html \
 		test_selectors_on_anonymous_content.html \
 		test_style_struct_copy_constructors.html \
 		test_value_computation.html \
diff -r a4343d61f6ee layout/style/test/test_namespace_rule.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/style/test/test_namespace_rule.html	Sat Nov 15 19:43:13 2008 -0500
@@ -0,0 +1,407 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+  <title>Test for CSS Namespace rules</title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body onload="run()">
+<p id="display"><iframe id="iframe" src="data:application/xhtml+xml,<html%20xmlns='http://www.w3.org/1999/xhtml'><head/><body/></html>"></iframe></p>
+<pre id="test">
+<script class="testbody" type="text/javascript">
+
+SimpleTest.waitForExplicitFinish();
+
+var HTML_NS = "http://www.w3.org/1999/xhtml";
+var style_text;
+
+function run() {
+    var iframe = $("iframe");
+    var ifwin = iframe.contentWindow;
+    var ifdoc = iframe.contentDocument;
+    var ifbody = ifdoc.getElementsByTagName("body")[0];
+
+    function setup_style_text() {
+        var style_elem = ifdoc.createElement("style");
+        style_elem.setAttribute("type", "text/css");
+        ifdoc.getElementsByTagName("head")[0].appendChild(style_elem);
+        var style_text = ifdoc.createCDATASection("");
+        style_elem.appendChild(style_text);
+        return style_text;
+    }
+
+    style_text = setup_style_text();
+    var gCounter = 0;
+
+    /*
+     * namespaceRules: the @namespace rules to use
+     * selector: the selector to test
+     * body_contents: what to set the body's innerHTML to
+     * match_fn: a function that, given the document object into which
+     *   body_contents has been inserted, produces an array of nodes that
+     *   should match selector
+     * notmatch_fn: likewise, but for nodes that should not match
+     */
+    function test_selector_in_html(namespaceRules, selector, body_contents,
+                                   match_fn, notmatch_fn)
+    {
+        var zi = ++gCounter;
+        if (typeof(body_contents) == "string") {
+            ifbody.innerHTML = body_contents;
+        } else {
+            // It's a function.
+            ifbody.innerHTML = "";
+            body_contents(ifbody);
+        }
+        style_text.data =
+          namespaceRules + " " + selector + "{ z-index: " + zi + " }";
+        var should_match = match_fn(ifdoc);
+        var should_not_match = notmatch_fn(ifdoc);
+        if (should_match.length + should_not_match.length == 0) {
+            ok(false, "nothing to check");
+        }
+
+        for (var i = 0; i < should_match.length; ++i) {
+            var e = should_match[i];
+            is(ifwin.getComputedStyle(e, "").zIndex, zi,
+               "element in " + body_contents + " matched " + selector);
+        }
+        for (var i = 0; i < should_not_match.length; ++i) {
+            var e = should_not_match[i];
+            is(ifwin.getComputedStyle(e, "").zIndex, "auto",
+               "element in " + body_contents + " did not match " + selector);
+        }
+
+        // Now, since we're here, may as well make sure serialization
+        // works correctly.  It need not produce the exact same text,
+        // but it should produce a selector that matches the same
+        // elements.
+        zi = ++gCounter;
+        var ruleList = style_text.parentNode.sheet.cssRules;
+        var ser1 = ruleList[ruleList.length-1].selectorText;
+        style_text.data =
+          namespaceRules + " " + ser1 + "{ z-index: " + zi + " }";
+        for (var i = 0; i < should_match.length; ++i) {
+            var e = should_match[i];
+            is(ifwin.getComputedStyle(e, "").zIndex, zi,
+               "element in " + body_contents + " matched " + ser1 +
+               " which is the reserialization of " + selector);
+        }
+        for (var i = 0; i < should_not_match.length; ++i) {
+            var e = should_not_match[i];
+            is(ifwin.getComputedStyle(e, "").zIndex, "auto",
+               "element in " + body_contents + " did not match " + ser1 +
+               " which is the reserialization of " + selector);
+        }
+
+        // But when we serialize the serialized result, we should get
+        // the same text.
+        var ser2 = ruleList[ruleList.length-1].selectorText;
+        is(ser2, ser1, "parse+serialize of selector \"" + selector +
+                       "\" is idempotent");
+
+        ifbody.innerHTML = "";
+        style_text.data = "";
+    }
+
+    // 2 tests from http://tc.labs.opera.com/css/namespaces/prefix-001.xml
+    test_selector_in_html(
+      '@namespace foo "x"; @namespace Foo "y";',
+      'Foo|test',
+      '<test xmlns="y"/>',
+      function (doc) { return doc.getElementsByTagName("test"); },
+      function (doc) { return []; }
+    );
+
+    test_selector_in_html(
+      '@namespace foo "x"; @namespace Foo "y";',
+      'foo|test',
+      '<test xmlns="y"/>',
+      function (doc) { return []; },
+      function (doc) { return doc.getElementsByTagName("test");}
+    );
+
+    // 2 tests from http://tc.labs.opera.com/css/namespaces/prefix-002.xml
+    test_selector_in_html(
+      '@namespace foo "";',
+      'test',
+      '<test xmlns=""/>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );
+
+    test_selector_in_html(
+      '@namespace foo "";',
+      'foo|test',
+      '<test xmlns=""/>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );
+
+    // 2 tests from http://tc.labs.opera.com/css/namespaces/prefix-003.xml
+    test_selector_in_html(
+      '@namespace foo "";',
+      'test',
+      '<foo xmlns=""><test/></foo>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );
+
+    test_selector_in_html(
+      '@namespace foo "";',
+      'foo|test',
+      '<foo xmlns=""><test/></foo>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );
+
+    // 4 tests from http://tc.labs.opera.com/css/namespaces/prefix-004.xml
+    test_selector_in_html(
+      '@namespace ""; @namespace x "test";',
+      'test[x]',
+      '<foo xmlns=""><test x=""/></foo>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );
+
+    test_selector_in_html(
+      '@namespace ""; @namespace x "test";',
+      '*|test',
+      '<foo xmlns=""><test x=""/></foo>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );
+
+    test_selector_in_html(
+      '@namespace ""; @namespace x "test";',
+      '*|test',
+      '<test xmlns="test"/>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );
+
+    test_selector_in_html(
+      '@namespace ""; @namespace x "test";',
+      'test',
+      '<test xmlns="test"/>',
+      function (doc) { return []; },
+      function (doc) { return doc.getElementsByTagName("test");}
+    );
+
+    // 2 tests from http://tc.labs.opera.com/css/namespaces/prefix-005.xml
+    test_selector_in_html(
+      '@namespace x "test";',
+      'test',
+      '<test/>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );
+
+    test_selector_in_html(
+      '@namespace x "test";',
+      'test',
+      '<test xmlns="test"/>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );
+
+    // Skipping the scope tests because they involve import, and we have no way
+    // to know when the import load completes.
+
+    // 1 test from http://tc.labs.opera.com/css/namespaces/syntax-001.xml
+    test_selector_in_html(
+      '@NAmespace x "http://www.w3.org/1999/xhtml";',
+      'x|test',
+      '<test/>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );
+
+    // 1 test from http://tc.labs.opera.com/css/namespaces/syntax-002.xml
+    test_selector_in_html(
+      '@NAmespac\\65  x "http://www.w3.org/1999/xhtml";',
+      'x|test',
+      '<test/>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );
+    
+    // 3 tests from http://tc.labs.opera.com/css/namespaces/syntax-003.xml
+    test_selector_in_html(
+      '@namespace url("test");',
+      '*|test',
+      '<test xmlns="test"/>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );
+
+    test_selector_in_html(
+      '@namespace url("test");',
+      'test',
+      '<test xmlns="test"/>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );
+
+    test_selector_in_html(
+      '@namespace url("test");',
+      'test',
+      '<test/>',
+      function (doc) { return []; },
+      function (doc) { return doc.getElementsByTagName("test");}
+    );
+
+    // 3 tests from http://tc.labs.opera.com/css/namespaces/syntax-004.xml
+    test_selector_in_html(
+      '@namespace u\\00072l("test");',
+      '*|test',
+      '<test xmlns="test"/>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );
+
+    test_selector_in_html(
+      '@namespace u\\00072l("test");',
+      'test',
+      '<test xmlns="test"/>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );
+
+    test_selector_in_html(
+      '@namespace u\\00072l("test");',
+      'test',
+      '<test/>',
+      function (doc) { return []; },
+      function (doc) { return doc.getElementsByTagName("test");}
+    );
+
+    // Skipping http://tc.labs.opera.com/css/namespaces/syntax-005.xml because it
+    // involves import, and we have no way // to know when the import load completes.
+
+    // Skipping http://tc.labs.opera.com/css/namespaces/syntax-006.xml because it
+    // involves import, and we have no way // to know when the import load completes.
+
+    // 2 tests from http://tc.labs.opera.com/css/namespaces/syntax-007.xml
+    test_selector_in_html(
+      '@charset "x"; @namespace url("test"); @namespace url("test2");',
+      '*|test',
+      '<test xmlns="test"/>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );
+
+    test_selector_in_html(
+      '@charset "x"; @namespace url("test"); @namespace url("test2");',
+      'test',
+      '<test xmlns="test"/>',
+      function (doc) { return []; },
+      function (doc) { return doc.getElementsByTagName("test");}
+    );
+
+    // 2 tests from http://tc.labs.opera.com/css/namespaces/syntax-008.xml
+    test_selector_in_html(
+      '@namespace \\72x url("test");',
+      'rx|test',
+      '<test xmlns="test"/>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );
+
+    test_selector_in_html(
+      '@namespace \\72x url("test");',
+      'test',
+      '<test xmlns="test"/>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );
+
+    // And now some :not() tests
+    test_selector_in_html(
+      '@namespace url("test");',
+      '*|*:not(test)',
+      '<test xmlns="test"/>',
+      function (doc) { return []; },
+      function (doc) { return doc.getElementsByTagName("test");}
+    );      
+
+    test_selector_in_html(
+      '@namespace url("test");',
+      '*|*:not(test)',
+      '<test xmlns="testing"/>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );      
+
+    test_selector_in_html(
+      '@namespace x url("test");',
+      '*|*:not(x|test)',
+      '<test xmlns="test"/>',
+      function (doc) { return []; },
+      function (doc) { return doc.getElementsByTagName("test");}
+    );      
+
+    test_selector_in_html(
+      '@namespace x url("test");',
+      '*|*:not(x|test)',
+      '<test xmlns="testing"/>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );      
+
+    test_selector_in_html(
+      '@namespace url("test");',
+      '*|*:not(*)',
+      '<test xmlns="testing"/>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );      
+
+    test_selector_in_html(
+      '@namespace url("test");',
+      '*|*:not(*)',
+      '<test xmlns="test"/>',
+      function (doc) { return []; },
+      function (doc) { return doc.getElementsByTagName("test");}
+    );      
+
+    test_selector_in_html(
+      '@namespace x url("test");',
+      '*|*:not(x|*)',
+      '<test xmlns="testing"/>',
+      function (doc) { return doc.getElementsByTagName("test");},
+      function (doc) { return []; }
+    );      
+
+    test_selector_in_html(
+      '@namespace x url("test");',
+      '*|*:not(x|*)',
+      '<test xmlns="test"/>',
+      function (doc) { return []; },
+      function (doc) { return doc.getElementsByTagName("test");}
+    );      
+
+    test_selector_in_html(
+      '@namespace url("test");',
+      '*|*:not([foo])',
+      '<test xmlns="testing" foo="bar"/>',
+      function (doc) { return []; },
+      function (doc) { return doc.getElementsByTagName("test");}
+    );      
+
+    test_selector_in_html(
+      '@namespace url("test");',
+      '*|*:not([foo])',
+      '<test xmlns="test" foo="bar"/>',
+      function (doc) { return []; },
+      function (doc) { return doc.getElementsByTagName("test");}
+    );      
+
+    SimpleTest.finish();
+}
+
+</script>
+</pre>
+</body>
+</html>
diff -r a4343d61f6ee layout/svg/base/src/nsSVGGeometryFrame.cpp
--- a/layout/svg/base/src/nsSVGGeometryFrame.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/svg/base/src/nsSVGGeometryFrame.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -93,33 +93,36 @@ nsSVGGeometryFrame::GetStrokeWidth()
     nsSVGUtils::CoordToFloat(PresContext(),
                              ctx,
                              GetStyleSVG()->mStrokeWidth);
 }
 
 nsresult
 nsSVGGeometryFrame::GetStrokeDashArray(gfxFloat **aDashes, PRUint32 *aCount)
 {
+  nsSVGElement *ctx = static_cast<nsSVGElement*>
+                                 (GetType() == nsGkAtoms::svgGlyphFrame ?
+                                     mContent->GetParent() : mContent);
   *aDashes = nsnull;
   *aCount = 0;
 
   PRUint32 count = GetStyleSVG()->mStrokeDasharrayLength;
   gfxFloat *dashes = nsnull;
 
   if (count) {
     const nsStyleCoord *dasharray = GetStyleSVG()->mStrokeDasharray;
     nsPresContext *presContext = PresContext();
     gfxFloat totalLength = 0.0f;
 
     dashes = new gfxFloat[count];
     if (dashes) {
       for (PRUint32 i = 0; i < count; i++) {
         dashes[i] =
           nsSVGUtils::CoordToFloat(presContext,
-                                   static_cast<nsSVGElement*>(mContent),
+                                   ctx,
                                    dasharray[i]);
         if (dashes[i] < 0.0f) {
           delete [] dashes;
           return NS_OK;
         }
         totalLength += dashes[i];
       }
     } else {
@@ -136,19 +139,23 @@ nsSVGGeometryFrame::GetStrokeDashArray(g
   }
 
   return NS_OK;
 }
 
 float
 nsSVGGeometryFrame::GetStrokeDashoffset()
 {
+  nsSVGElement *ctx = static_cast<nsSVGElement*>
+                                 (GetType() == nsGkAtoms::svgGlyphFrame ?
+                                     mContent->GetParent() : mContent);
+
   return
     nsSVGUtils::CoordToFloat(PresContext(),
-                             static_cast<nsSVGElement*>(mContent),
+                             ctx,
                              GetStyleSVG()->mStrokeDashoffset);
 }
 
 PRUint16
 nsSVGGeometryFrame::GetClipRule()
 {
   return GetStyleSVG()->mClipRule;
 }
diff -r a4343d61f6ee layout/tools/reftest/README.txt
--- a/layout/tools/reftest/README.txt	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/tools/reftest/README.txt	Sat Nov 15 19:43:13 2008 -0500
@@ -74,26 +74,29 @@ 2. A test item
                          particular platform (i.e. it allows us to get test
                          coverage on the other platforms).
 
       Examples of using conditions:
           fails-if(MOZ_WIDGET_TOOLKIT=="windows") ...
           fails-if(MOZ_WIDGET_TOOLKIT=="cocoa") ...
           fails-if(MOZ_WIDGET_TOOLKIT=="gtk2") ...
 
-   b. <http>, if present, is the string "HTTP" (sans quotes), indicating that
+   b. <http>, if present, is one of the strings (sans quotes) "HTTP" or
+      "HTTP(..)" or "HTTP(../..)" or "HTTP(../../..)", etc. , indicating that
       the test should be run over an HTTP server because it requires certain
       HTTP headers or a particular HTTP status.  (Don't use this if your test
       doesn't require this functionality, because it unnecessarily slows down
       the test.)
 
-      HTTP tests have the restriction that any resource an HTTP test accesses
-      must be accessed using a relative URL, and the test and the resource must
-      be within the directory containing the reftest manifest that describes
-      the test (or within a descendant directory).
+      With "HTTP", HTTP tests have the restriction that any resource an HTTP
+      test accesses must be accessed using a relative URL, and the test and
+      the resource must be within the directory containing the reftest
+      manifest that describes the test (or within a descendant directory).
+      The variants "HTTP(..)", etc., can be used to relax this restriction by
+      allowing resources in the parent directory, etc.
 
       To modify the HTTP status or headers of a resource named FOO, create a
       sibling file named FOO^headers^ with the following contents:
 
       [<http-status>]
       <http-header>*
 
       <http-status> A line of the form "HTTP ###[ <description>]", where
diff -r a4343d61f6ee layout/tools/reftest/reftest-analyzer.xhtml
--- a/layout/tools/reftest/reftest-analyzer.xhtml	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/tools/reftest/reftest-analyzer.xhtml	Sat Nov 15 19:43:13 2008 -0500
@@ -288,17 +288,17 @@ function show_differences(cb) {
 <div id="viewer" style="display:none">
   <div id="itemlist"></div>
   <div id="images" style="display:none">
     <form id="imgcontrols">
     <label><input type="radio" name="which" value="0" onchange="show_image(1)" checked="checked" />Image 1</label>
     <label><input type="radio" name="which" value="1" onchange="show_image(2)" />Image 2</label>
     <label><input type="checkbox" onchange="show_differences(this)" />Circle differences</label>
     </form>
-    <svg style="position: absolute; left: 300px; top: 50px;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="800px" height="1000px" viewbox="0 0 800 1000" id="svg">
+    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="800px" height="1000px" viewbox="0 0 800 1000" id="svg">
       <defs>
 	<filter id="showDifferences" x="0%" y="0%" width="100%" height="100%">
 	  <feImage id="feimage1" result="img1" xlink:href="#image1" />
 	  <feImage id="feimage2" result="img2" xlink:href="#image2" />
 	  <!-- inv1 and inv2 are the images with RGB inverted -->
 	  <feComponentTransfer result="inv1" in="img1">
 	    <feFuncR type="linear" slope="-1" intercept="1" />
 	    <feFuncG type="linear" slope="-1" intercept="1" />
diff -r a4343d61f6ee layout/tools/reftest/reftest.js
--- a/layout/tools/reftest/reftest.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/layout/tools/reftest/reftest.js	Sat Nov 15 19:43:13 2008 -0500
@@ -205,53 +205,62 @@ function ReadManifest(aURL)
                 } else if (stat == "random") {
                     expected_status = EXPECTED_RANDOM;
                 } else if (stat == "skip") {
                     expected_status = EXPECTED_DEATH;
                 }
             }
         }
 
-        var runHttp = items[0] == "HTTP";
-        if (runHttp)
+        var runHttp = false;
+        var httpDepth;
+        if (items[0] == "HTTP") {
+            runHttp = true;
+            httpDepth = 0;
             items.shift();
+        } else if (items[0].match(/HTTP\(\.\.(\/\.\.)*\)/)) {
+            // Accept HTTP(..), HTTP(../..), HTTP(../../..), etc.
+            runHttp = true;
+            httpDepth = (items[0].length - 5) / 3;
+            items.shift();
+        }
 
         if (items[0] == "include") {
             if (items.length != 2 || runHttp)
                 throw "Error in manifest file " + aURL.spec + " line " + lineNo;
             var incURI = gIOService.newURI(items[1], null, listURL);
             secMan.checkLoadURI(aURL, incURI,
                                 CI.nsIScriptSecurityManager.DISALLOW_SCRIPT);
             ReadManifest(incURI);
         } else if (items[0] == "load") {
             if (expected_status == EXPECTED_PASS)
                 expected_status = EXPECTED_LOAD;
             if (items.length != 2 ||
                 (expected_status != EXPECTED_LOAD &&
                  expected_status != EXPECTED_DEATH))
                 throw "Error in manifest file " + aURL.spec + " line " + lineNo;
             var [testURI] = runHttp
-                            ? ServeFiles(aURL,
+                            ? ServeFiles(aURL, httpDepth,
                                          listURL.file.parent, [items[1]])
                             : [gIOService.newURI(items[1], null, listURL)];
             var prettyPath = runHttp
                            ? gIOService.newURI(items[1], null, listURL).spec
                            : testURI.spec;
             secMan.checkLoadURI(aURL, testURI,
                                 CI.nsIScriptSecurityManager.DISALLOW_SCRIPT);
             gURLs.push( { equal: true /* meaningless */,
                           expected: expected_status,
                           prettyPath: prettyPath,
                           url1: testURI,
                           url2: null } );
         } else if (items[0] == "==" || items[0] == "!=") {
             if (items.length != 3)
                 throw "Error in manifest file " + aURL.spec + " line " + lineNo;
             var [testURI, refURI] = runHttp
-                                  ? ServeFiles(aURL,
+                                  ? ServeFiles(aURL, httpDepth,
                                                listURL.file.parent, [items[1], items[2]])
                                   : [gIOService.newURI(items[1], null, listURL),
                                      gIOService.newURI(items[2], null, listURL)];
             var prettyPath = runHttp
                            ? gIOService.newURI(items[1], null, listURL).spec
                            : testURI.spec;
             secMan.checkLoadURI(aURL, testURI,
                                 CI.nsIScriptSecurityManager.DISALLOW_SCRIPT);
@@ -263,34 +272,47 @@ function ReadManifest(aURL)
                           url1: testURI,
                           url2: refURI } );
         } else {
             throw "Error in manifest file " + aURL.spec + " line " + lineNo;
         }
     } while (more);
 }
 
-function ServeFiles(manifestURL, directory, files)
+function ServeFiles(manifestURL, depth, directory, files)
 {
     if (!gServer)
         gServer = CC["@mozilla.org/server/jshttp;1"].
                       createInstance(CI.nsIHttpServer);
 
+    // Allow serving a tree that's an ancestor of the directory containing
+    // the files so that they can use resources in ../ (etc.).
+    var dirPath = "/";
+    while (depth > 0) {
+        dirPath = "/" + directory.leafName + dirPath;
+        directory = directory.parent;
+        --depth;
+    }
+
     gCount++;
-    var path = "/" + gCount + "/";
-    gServer.registerDirectory(path, directory);
+    var path = "/" + gCount;
+    gServer.registerDirectory(path + "/", directory);
 
     var secMan = CC[NS_SCRIPTSECURITYMANAGER_CONTRACTID]
                      .getService(CI.nsIScriptSecurityManager);
 
+    var testbase = gIOService.newURI("http://localhost:" + HTTP_SERVER_PORT +
+                                         path + dirPath,
+                                     null, null);
+
     function FileToURI(file)
     {
-        var testURI = gIOService.newURI("http://localhost:" + HTTP_SERVER_PORT +
-                                        path + file,
-                                        null, null);
+        // Only serve relative URIs via the HTTP server, not absolute
+        // ones like about:blank.
+        var testURI = gIOService.newURI(file, null, testbase);
 
         // XXX necessary?  manifestURL guaranteed to be file, others always HTTP
         secMan.checkLoadURI(manifestURL, testURI,
                             CI.nsIScriptSecurityManager.DISALLOW_SCRIPT);
 
         return testURI;
     }
 
diff -r a4343d61f6ee media/liboggplay/README_MOZILLA
--- a/media/liboggplay/README_MOZILLA	Thu Nov 06 18:33:22 2008 +0100
+++ b/media/liboggplay/README_MOZILLA	Sat Nov 15 19:43:13 2008 -0500
@@ -1,11 +1,11 @@ The source from this directory was copie
 The source from this directory was copied from the liboggplay svn
 source using the update.sh script. The only changes made were those
 applied by update.sh and the addition/upate of Makefile.in files for
 the Mozilla build system.
 
 http://svn.annodex.net/liboggplay/trunk/
 
-The svn revision number used was r3761.
+The svn revision number used was r3774.
 
 The patch from Annodex trac ticket 421 is applied to fix bug 459938:
   http://trac.annodex.net/ticket/421
diff -r a4343d61f6ee media/liboggplay/src/liboggplay/oggplay.c
--- a/media/liboggplay/src/liboggplay/oggplay.c	Thu Nov 06 18:33:22 2008 +0100
+++ b/media/liboggplay/src/liboggplay/oggplay.c	Sat Nov 15 19:43:13 2008 -0500
@@ -639,19 +639,22 @@ oggplay_get_duration(OggPlay *me) {
 
   if (me == NULL) {
     return E_OGGPLAY_BAD_OGGPLAY;
   }
 
   if (me->reader->duration) 
     return me->reader->duration(me->reader);
   else {
-    ogg_int64_t pos = oggz_tell_units(me->oggz);
-    ogg_int64_t duration = oggz_seek_units(me->oggz, 0, SEEK_END);
+    ogg_int64_t pos;
+    ogg_int64_t duration;
+    pos = oggz_tell_units(me->oggz);
+    duration = oggz_seek_units(me->oggz, 0, SEEK_END);
     oggz_seek_units(me->oggz, pos, SEEK_SET);
+    oggplay_seek_cleanup(me, pos);
     return duration;
   }
 }
 
 int
 oggplay_media_finished_retrieving(OggPlay *me) {
 
   if (me == NULL) {
diff -r a4343d61f6ee media/liboggplay/src/liboggplay/oggplay_private.h
--- a/media/liboggplay/src/liboggplay/oggplay_private.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/media/liboggplay/src/liboggplay/oggplay_private.h	Sat Nov 15 19:43:13 2008 -0500
@@ -224,16 +224,19 @@ struct _OggPlay {
 
 void
 oggplay_set_data_callback_force(OggPlay *me, OggPlayDataCallback callback,
                 void *user);
 
 void
 oggplay_take_out_trash(OggPlay *me, OggPlaySeekTrash *trash);
 
+void
+oggplay_seek_cleanup(OggPlay *me, ogg_int64_t milliseconds);
+
 typedef struct {
   void (*init)(void *user_data);
   int (*callback)(OGGZ * oggz, ogg_packet * op, long serialno,
                                                           void * user_data);
   void (*shutdown)(void *user_data);
   int size;
 } OggPlayCallbackFunctions;
 
diff -r a4343d61f6ee media/liboggplay/src/liboggplay/oggplay_seek.c
--- a/media/liboggplay/src/liboggplay/oggplay_seek.c	Thu Nov 06 18:33:22 2008 +0100
+++ b/media/liboggplay/src/liboggplay/oggplay_seek.c	Sat Nov 15 19:43:13 2008 -0500
@@ -36,21 +36,17 @@
  * Shane Stephens <shane.stephens@annodex.net>
  */
 
 #include "oggplay_private.h"
 
 OggPlayErrorCode
 oggplay_seek(OggPlay *me, ogg_int64_t milliseconds) {
 
-  OggPlaySeekTrash    * trash;
-  OggPlaySeekTrash   ** p;
-  OggPlayDataHeader  ** end_of_list_p;
-  int                   i;
-  int                   eof;
+  ogg_int64_t           eof;
 
   if (me == NULL) {
     return E_OGGPLAY_BAD_OGGPLAY;
   }
 
   if (milliseconds < 0) {
     return E_OGGPLAY_CANT_SEEK;
   }
@@ -70,16 +66,31 @@ oggplay_seek(OggPlay *me, ogg_int64_t mi
     {
       return E_OGGPLAY_CANT_SEEK;
     }
   } else {
     if (oggz_seek_units(me->oggz, milliseconds, SEEK_SET) == -1) {
       return E_OGGPLAY_CANT_SEEK;
     }
   }
+
+  oggplay_seek_cleanup(me, milliseconds);
+
+  return E_OGGPLAY_OK;
+
+}
+
+void
+oggplay_seek_cleanup(OggPlay* me, ogg_int64_t milliseconds)
+{
+
+  OggPlaySeekTrash    * trash;
+  OggPlaySeekTrash   ** p;
+  OggPlayDataHeader  ** end_of_list_p;
+  int                   i;
 
   /*
    * first, create a trash object to store the context that we want to
    * delete but can't until the presentation thread is no longer using it -
    * this will occur as soon as the thread calls oggplay_buffer_release_next
    */
 
   trash = calloc(sizeof(OggPlaySeekTrash), 1);
@@ -124,19 +135,16 @@ oggplay_seek(OggPlay *me, ogg_int64_t mi
   trash->next = NULL;
 
   p = &(me->trash);
   while (*p != NULL) {
     p = &((*p)->next);
   }
 
   *p = trash;
-
-  return E_OGGPLAY_OK;
-
 }
 
 void
 oggplay_take_out_trash(OggPlay *me, OggPlaySeekTrash *trash) {
 
   OggPlaySeekTrash *p = NULL;
 
   for (; trash != NULL; trash = trash->next) {
diff -r a4343d61f6ee modules/libjar/nsJAR.cpp
--- a/modules/libjar/nsJAR.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/modules/libjar/nsJAR.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -198,16 +198,17 @@ nsJAR::Close()
 nsJAR::Close()
 {
   if (mLock) {
     PR_DestroyLock(mLock);
     mLock = nsnull;
   }
 
   mParsedManifest = PR_FALSE;
+  mManifestData.Reset();
   mGlobalStatus = JAR_MANIFEST_NOT_PARSED;
   mTotalItemsInManifest = 0;
 
   return mZip.CloseArchive();
 }
 
 NS_IMETHODIMP
 nsJAR::Test(const char *aEntryName)
diff -r a4343d61f6ee modules/libpr0n/decoders/png/nsPNGDecoder.cpp
--- a/modules/libpr0n/decoders/png/nsPNGDecoder.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/modules/libpr0n/decoders/png/nsPNGDecoder.cpp	Sat Nov 15 19:43:13 2008 -0500
@@ -321,37 +321,39 @@ static NS_METHOD ReadDataOut(nsIInputStr
 {
   nsPNGDecoder *decoder = static_cast<nsPNGDecoder*>(closure);
 
   if (decoder->mError) {
     *writeCount = 0;
     return NS_ERROR_FAILURE;
   }
 
+  // we force to add even erroneous data to restore halfway frame information
+  // later - bug 441563
+  nsresult result = decoder->mImage->AddRestoreData(const_cast<char *>(fromRawSegment), count);
+  if (NS_FAILED (result)) {
+    PR_LOG(gPNGDecoderAccountingLog, PR_LOG_DEBUG,
+           ("PNGDecoderAccounting: ReadDataOut(): failed to add restore data to image container %p",
+            decoder->mImage.get()));
+
+    decoder->mError = PR_TRUE;
+    *writeCount = 0;
+    return result;
+  }
+
   // we need to do the setjmp here otherwise bad things will happen
   if (setjmp(decoder->mPNG->jmpbuf)) {
     png_destroy_read_struct(&decoder->mPNG, &decoder->mInfo, NULL);
 
     decoder->mError = PR_TRUE;
     *writeCount = 0;
     return NS_ERROR_FAILURE;
   }
   png_process_data(decoder->mPNG, decoder->mInfo,
                    reinterpret_cast<unsigned char *>(const_cast<char *>(fromRawSegment)), count);
-
-  nsresult result = decoder->mImage->AddRestoreData((char *) fromRawSegment, count);
-  if (NS_FAILED (result)) {
-    PR_LOG(gPNGDecoderAccountingLog, PR_LOG_DEBUG,
-           ("PNGDecoderAccounting: ReadDataOut(): failed to add restore data to image container %p",
-            decoder->mImage.get()));
-
-    decoder->mError = PR_TRUE;
-    *writeCount = 0;
-    return result;
-  }
 
   PR_LOG(gPNGDecoderAccountingLog, PR_LOG_DEBUG,
          ("PNGDecoderAccounting: ReadDataOut(): Added restore data to image container %p",
           decoder->mImage.get()));
 
   *writeCount = count;
   return NS_OK;
 }
diff -r a4343d61f6ee modules/libpr0n/src/imgContainer.cpp
--- a/modules/libpr0n/src/imgContainer.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/modules/libpr0n/src/imgContainer.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -1487,19 +1487,19 @@ imgContainer::ReloadImages(void)
             "header %p is 0x%s (length %d)",
             this,
             mDiscardableMimeType.get(),
             mRestoreData.Elements(),
             buf,
             mRestoreData.Length()));
   }
 
+  // |WriteFrom()| may fail if the original data is broken.
   PRUint32 written;
-  result = decoder->WriteFrom(stream, mRestoreData.Length(), &written);
-  NS_ENSURE_SUCCESS(result, result);
+  (void)decoder->WriteFrom(stream, mRestoreData.Length(), &written);
 
   result = decoder->Flush();
   NS_ENSURE_SUCCESS(result, result);
 
   result = decoder->Close();
   NS_ENSURE_SUCCESS(result, result);
 
   NS_ASSERTION(mFrames.Count() == mNumFrames,
diff -r a4343d61f6ee modules/libpr0n/test/reftest/generic/green.png
Binary file modules/libpr0n/test/reftest/generic/green.png has changed
diff -r a4343d61f6ee netwerk/base/public/nsNetError.h
--- a/netwerk/base/public/nsNetError.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/netwerk/base/public/nsNetError.h	Sat Nov 15 19:43:14 2008 -0500
@@ -268,16 +268,24 @@
 /**
  * The lookup of a hostname failed.  This generally refers to the hostname
  * from the URL being loaded.
  */
 #define NS_ERROR_UNKNOWN_HOST \
     NS_ERROR_GENERATE_FAILURE(NS_ERROR_MODULE_NETWORK, 30)
 
 /**
+ * A low or medium priority DNS lookup failed because the pending
+ * queue was already full. High priorty (the default) always
+ * makes room
+ */
+#define NS_ERROR_DNS_LOOKUP_QUEUE_FULL \
+    NS_ERROR_GENERATE_FAILURE(NS_ERROR_MODULE_NETWORK, 33)
+
+/**
  * The lookup of a proxy hostname failed.
  *
  * If a channel is configured to speak to a proxy server, then it will
  * generate this error if the proxy hostname cannot be resolved.
  */
 #define NS_ERROR_UNKNOWN_PROXY_HOST \
     NS_ERROR_GENERATE_FAILURE(NS_ERROR_MODULE_NETWORK, 42)
 
diff -r a4343d61f6ee netwerk/base/src/Makefile.in
--- a/netwerk/base/src/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/netwerk/base/src/Makefile.in	Sat Nov 15 19:43:14 2008 -0500
@@ -88,16 +88,17 @@ CPPSRCS		= \
 		nsSyncStreamListener.cpp \
 		nsUnicharStreamLoader.cpp \
 		nsURIChecker.cpp \
 		nsURLHelper.cpp \
 		nsURLParsers.cpp \
 		nsNetStrings.cpp \
 		nsBase64Encoder.cpp \
 		nsSerializationHelper.cpp \
+		nsDNSPrefetch.cpp \
 		$(NULL)
 
 ifeq ($(MOZ_WIDGET_TOOLKIT),os2)
 	CPPSRCS += nsURLHelperOS2.cpp
 else
 ifeq ($(MOZ_WIDGET_TOOLKIT),windows)
 	CPPSRCS += nsURLHelperWin.cpp
 ifneq ($(OS_ARCH), WINCE)
diff -r a4343d61f6ee netwerk/base/src/nsIOService.cpp
--- a/netwerk/base/src/nsIOService.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/netwerk/base/src/nsIOService.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -576,16 +576,34 @@ nsIOService::NewChannel(const nsACString
 nsIOService::NewChannel(const nsACString &aSpec, const char *aCharset, nsIURI *aBaseURI, nsIChannel **result)
 {
     nsresult rv;
     nsCOMPtr<nsIURI> uri;
     rv = NewURI(aSpec, aCharset, aBaseURI, getter_AddRefs(uri));
     if (NS_FAILED(rv)) return rv;
 
     return NewChannelFromURI(uri, result);
+}
+
+PRBool
+nsIOService::IsLinkUp()
+{
+    if (!mNetworkLinkService) {
+        // We cannot decide, assume the link is up
+        return PR_TRUE;
+    }
+
+    PRBool isLinkUp;
+    nsresult rv;
+    rv = mNetworkLinkService->GetIsLinkUp(&isLinkUp);
+    if (NS_FAILED(rv)) {
+        return PR_TRUE;
+    }
+
+    return isLinkUp;
 }
 
 NS_IMETHODIMP
 nsIOService::GetOffline(PRBool *offline)
 {
     *offline = mOffline;
     return NS_OK;
 }
diff -r a4343d61f6ee netwerk/base/src/nsIOService.h
--- a/netwerk/base/src/nsIOService.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/netwerk/base/src/nsIOService.h	Sat Nov 15 19:43:14 2008 -0500
@@ -102,16 +102,17 @@ public:
                                PRUint32 flags);
 
     // Gets the array of registered content sniffers
     const nsCOMArray<nsIContentSniffer>& GetContentSniffers() {
       return mContentSniffers.GetEntries();
     }
 
     PRBool IsOffline() { return mOffline; }
+    PRBool IsLinkUp();
 
 private:
     // These shouldn't be called directly:
     // - construct using GetInstance
     // - destroy using Release
     nsIOService() NS_HIDDEN;
     ~nsIOService() NS_HIDDEN;
 
diff -r a4343d61f6ee netwerk/base/src/nsNativeConnectionHelper.cpp
--- a/netwerk/base/src/nsNativeConnectionHelper.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/netwerk/base/src/nsNativeConnectionHelper.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -33,24 +33,28 @@
  * and other provisions required by the GPL or the LGPL. If you do not delete
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 #include "nsNativeConnectionHelper.h"
 #include "nsAutodialWin.h"
+#include "nsIOService.h"
+
 //-----------------------------------------------------------------------------
 // API typically invoked on the socket transport thread
 //-----------------------------------------------------------------------------
 
-
 PRBool
 nsNativeConnectionHelper::OnConnectionFailed(const PRUnichar* hostName)
 {
+    if (gIOService->IsLinkUp())
+        return PR_FALSE;
+
     nsRASAutodial autodial;
 
     if (autodial.ShouldDialOnNetworkError()) 
         return NS_SUCCEEDED(autodial.DialDefault(hostName));
     else
         return PR_FALSE;
 }
 
diff -r a4343d61f6ee netwerk/build/nsNetModule.cpp
--- a/netwerk/build/nsNetModule.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/netwerk/build/nsNetModule.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -54,16 +54,17 @@
 #include "nsFileStreams.h"
 #include "nsBufferedStreams.h"
 #include "nsMIMEInputStream.h"
 #include "nsSOCKSSocketProvider.h"
 #include "nsCacheService.h"
 #include "nsDiskCacheDeviceSQL.h"
 #include "nsMimeTypes.h"
 #include "nsNetStrings.h"
+#include "nsDNSPrefetch.h"
 
 #include "nsNetCID.h"
 
 #if defined(XP_MACOSX)
 #define BUILD_APPLEFILE_DECODER 1
 #else
 #define BUILD_BINHEX_DECODER 1
 #endif
@@ -614,20 +615,23 @@ static void nsNetShutdown(nsIModule *nec
     // Release buffer cache
     NS_IF_RELEASE(nsIOService::gBufferCache);
 
     // Release global state used by the URL helper module.
     net_ShutdownURLHelper();
 #ifdef XP_MACOSX
     net_ShutdownURLHelperOSX();
 #endif
-
+    
     // Release necko strings
     delete gNetStrings;
     gNetStrings = nsnull;
+    
+    // Release DNS service reference.
+    nsDNSPrefetch::Shutdown();
 }
 
 static const nsModuleComponentInfo gNetModuleInfo[] = {
     { NS_IOSERVICE_CLASSNAME,
       NS_IOSERVICE_CID,
       NS_IOSERVICE_CONTRACTID,
       nsIOServiceConstructor },
     { NS_IOSERVICE_CLASSNAME,
diff -r a4343d61f6ee netwerk/dns/public/nsIDNSService.idl
--- a/netwerk/dns/public/nsIDNSService.idl	Thu Nov 06 18:33:22 2008 +0100
+++ b/netwerk/dns/public/nsIDNSService.idl	Sat Nov 15 19:43:14 2008 -0500
@@ -41,17 +41,17 @@ interface nsICancelable;
 interface nsICancelable;
 interface nsIEventTarget;
 interface nsIDNSRecord;
 interface nsIDNSListener;
 
 /**
  * nsIDNSService
  */
-[scriptable, uuid(3ac9e611-e6b6-44b5-b312-c040e65b2929)]
+[scriptable, uuid(ee4d9f1d-4f99-4384-b547-29da735f8b6e)]
 interface nsIDNSService : nsISupports
 {
     /**
      * kicks off an asynchronous host lookup.
      *
      * @param aHostName
      *        the hostname or IP-address-literal to resolve.
      * @param aFlags
@@ -102,9 +102,16 @@ interface nsIDNSService : nsISupports
      * if set, this flag suppresses the internal DNS lookup cache.
      */
     const unsigned long RESOLVE_BYPASS_CACHE = (1 << 0);
 
     /**
      * if set, the canonical name of the specified host will be queried.
      */
     const unsigned long RESOLVE_CANONICAL_NAME = (1 << 1);
+
+    /**
+     * if set, the query is given lower priority. Medium takes precedence
+     * if both are used.
+     */
+    const unsigned long RESOLVE_PRIORITY_MEDIUM = (1 << 2);
+    const unsigned long RESOLVE_PRIORITY_LOW    = (1 << 3);
 };
diff -r a4343d61f6ee netwerk/dns/src/effective_tld_names.dat
--- a/netwerk/dns/src/effective_tld_names.dat	Thu Nov 06 18:33:22 2008 +0100
+++ b/netwerk/dns/src/effective_tld_names.dat	Sat Nov 15 19:43:14 2008 -0500
@@ -4183,16 +4183,17 @@ or.ug
 // uk : http://en.wikipedia.org/wiki/.uk
 *.uk
 *.sch.uk
 !bl.uk
 !british-library.uk
 !icnet.uk
 !jet.uk
 !nel.uk
+!nhs.uk
 !nls.uk
 !national-library-scotland.uk
 !parliament.uk
 
 // us : http://en.wikipedia.org/wiki/.us
 us
 dni.us
 fed.us
diff -r a4343d61f6ee netwerk/dns/src/nsDNSService2.cpp
--- a/netwerk/dns/src/nsDNSService2.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/netwerk/dns/src/nsDNSService2.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -45,27 +45,29 @@
 #include "nsIPrefBranch2.h"
 #include "nsIServiceManager.h"
 #include "nsReadableUtils.h"
 #include "nsString.h"
 #include "nsAutoLock.h"
 #include "nsAutoPtr.h"
 #include "nsNetCID.h"
 #include "nsNetError.h"
+#include "nsDNSPrefetch.h"
 #include "prsystem.h"
 #include "prnetdb.h"
 #include "prmon.h"
 #include "prio.h"
 #include "plstr.h"
 
 static const char kPrefDnsCacheEntries[]    = "network.dnsCacheEntries";
 static const char kPrefDnsCacheExpiration[] = "network.dnsCacheExpiration";
 static const char kPrefEnableIDN[]          = "network.enableIDN";
 static const char kPrefIPv4OnlyDomains[]    = "network.dns.ipv4OnlyDomains";
 static const char kPrefDisableIPv6[]        = "network.dns.disableIPv6";
+static const char kPrefDisablePrefetch[]    = "network.dns.disablePrefetch";
 
 //-----------------------------------------------------------------------------
 
 class nsDNSRecord : public nsIDNSRecord
 {
 public:
     NS_DECL_ISUPPORTS
     NS_DECL_NSIDNSRECORD
@@ -316,49 +318,53 @@ NS_IMETHODIMP
 NS_IMETHODIMP
 nsDNSService::Init()
 {
     NS_ENSURE_TRUE(!mResolver, NS_ERROR_ALREADY_INITIALIZED);
 
     PRBool firstTime = (mLock == nsnull);
 
     // prefs
-    PRUint32 maxCacheEntries  = 20;
-    PRUint32 maxCacheLifetime = 1; // minutes
+    PRUint32 maxCacheEntries  = 400;
+    PRUint32 maxCacheLifetime = 3; // minutes
     PRBool   enableIDN        = PR_TRUE;
     PRBool   disableIPv6      = PR_FALSE;
+    PRBool   disablePrefetch  = PR_FALSE;
+    
     nsAdoptingCString ipv4OnlyDomains;
 
     // read prefs
     nsCOMPtr<nsIPrefBranch2> prefs = do_GetService(NS_PREFSERVICE_CONTRACTID);
     if (prefs) {
         PRInt32 val;
         if (NS_SUCCEEDED(prefs->GetIntPref(kPrefDnsCacheEntries, &val)))
             maxCacheEntries = (PRUint32) val;
         if (NS_SUCCEEDED(prefs->GetIntPref(kPrefDnsCacheExpiration, &val)))
             maxCacheLifetime = val / 60; // convert from seconds to minutes
 
         // ASSUMPTION: pref branch does not modify out params on failure
         prefs->GetBoolPref(kPrefEnableIDN, &enableIDN);
         prefs->GetBoolPref(kPrefDisableIPv6, &disableIPv6);
         prefs->GetCharPref(kPrefIPv4OnlyDomains, getter_Copies(ipv4OnlyDomains));
+        prefs->GetBoolPref(kPrefDisablePrefetch, &disablePrefetch);
     }
 
     if (firstTime) {
         mLock = PR_NewLock();
         if (!mLock)
             return NS_ERROR_OUT_OF_MEMORY;
 
         // register as prefs observer
         if (prefs) {
             prefs->AddObserver(kPrefDnsCacheEntries, this, PR_FALSE);
             prefs->AddObserver(kPrefDnsCacheExpiration, this, PR_FALSE);
             prefs->AddObserver(kPrefEnableIDN, this, PR_FALSE);
             prefs->AddObserver(kPrefIPv4OnlyDomains, this, PR_FALSE);
             prefs->AddObserver(kPrefDisableIPv6, this, PR_FALSE);
+            prefs->AddObserver(kPrefDisablePrefetch, this, PR_FALSE);
         }
     }
 
     // we have to null out mIDN since we might be getting re-initialized
     // as a result of a pref change.
     nsCOMPtr<nsIIDNService> idn;
     if (enableIDN)
         idn = do_GetService(NS_IDNSERVICE_CONTRACTID);
@@ -369,18 +375,20 @@ nsDNSService::Init()
                                          getter_AddRefs(res));
     if (NS_SUCCEEDED(rv)) {
         // now, set all of our member variables while holding the lock
         nsAutoLock lock(mLock);
         mResolver = res;
         mIDN = idn;
         mIPv4OnlyDomains = ipv4OnlyDomains; // exchanges buffer ownership
         mDisableIPv6 = disableIPv6;
+        mDisablePrefetch = disablePrefetch;
     }
-
+    
+    nsDNSPrefetch::Initialize(this);
     return rv;
 }
 
 NS_IMETHODIMP
 nsDNSService::Shutdown()
 {
     nsRefPtr<nsHostResolver> res;
     {
@@ -401,16 +409,20 @@ nsDNSService::AsyncResolve(const nsACStr
                            nsICancelable    **result)
 {
     // grab reference to global host resolver and IDN service.  beware
     // simultaneous shutdown!!
     nsRefPtr<nsHostResolver> res;
     nsCOMPtr<nsIIDNService> idn;
     {
         nsAutoLock lock(mLock);
+
+        if (mDisablePrefetch && (flags & (RESOLVE_PRIORITY_LOW | RESOLVE_PRIORITY_MEDIUM)))
+            return NS_ERROR_DNS_LOOKUP_QUEUE_FULL;
+
         res = mResolver;
         idn = mIDN;
     }
     NS_ENSURE_TRUE(res, NS_ERROR_OFFLINE);
 
     const nsACString *hostPtr = &hostname;
 
     nsresult rv;
diff -r a4343d61f6ee netwerk/dns/src/nsDNSService2.h
--- a/netwerk/dns/src/nsDNSService2.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/netwerk/dns/src/nsDNSService2.h	Sat Nov 15 19:43:14 2008 -0500
@@ -63,9 +63,10 @@ private:
     // mLock protects access to mResolver and mIPv4OnlyDomains
     PRLock                   *mLock;
 
     // mIPv4OnlyDomains is a comma-separated list of domains for which only
     // IPv4 DNS lookups are performed. This allows the user to disable IPv6 on
     // a per-domain basis and work around broken DNS servers. See bug 68796.
     nsAdoptingCString         mIPv4OnlyDomains;
     PRBool                    mDisableIPv6;
+    PRBool                    mDisablePrefetch;
 };
diff -r a4343d61f6ee netwerk/dns/src/nsHostResolver.cpp
--- a/netwerk/dns/src/nsHostResolver.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/netwerk/dns/src/nsHostResolver.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -63,18 +63,38 @@
 #include "prlong.h"
 #include "prlog.h"
 #include "pldhash.h"
 #include "plstr.h"
 #include "nsURLHelper.h"
 
 //----------------------------------------------------------------------------
 
-#define MAX_THREADS 8
-#define IDLE_TIMEOUT PR_SecondsToInterval(60)
+// Use a persistent thread pool in order to avoid spinning up new threads all the time.
+// In particular, thread creation results in a res_init() call from libc which is 
+// quite expensive.
+//
+// The pool dynamically grows between 0 and MAX_RESOLVER_THREADS in size. New requests
+// go first to an idle thread. If that cannot be found and there are fewer than MAX_RESOLVER_THREADS
+// currently in the pool a new thread is created for high priority requests. If
+// the new request is at a lower priority a new thread will only be created if 
+// there are fewer than HighThreadThreshold currently outstanding. If a thread cannot be
+// created or an idle thread located for the request it is queued.
+//
+// When the pool is greater than HighThreadThreshold in size a thread will be destroyed after
+// ShortIdleTimeoutSeconds of idle time. Smaller pools use LongIdleTimeoutSeconds for a 
+// timeout period.
+
+#define MAX_NON_PRIORITY_REQUESTS 150
+
+#define HighThreadThreshold     MAX_RESOLVER_THREADS_FOR_ANY_PRIORITY
+#define LongIdleTimeoutSeconds  300           // for threads 1 -> HighThreadThreshold
+#define ShortIdleTimeoutSeconds 60            // for threads HighThreadThreshold+1 -> MAX_RESOLVER_THREADS
+
+PR_STATIC_ASSERT (HighThreadThreshold <= MAX_RESOLVER_THREADS);
 
 //----------------------------------------------------------------------------
 
 #if defined(PR_LOGGING)
 static PRLogModuleInfo *gHostResolverLog = nsnull;
 #define LOG(args) PR_LOG(gHostResolverLog, PR_LOG_DEBUG, args)
 #else
 #define LOG(args)
@@ -179,16 +199,17 @@ nsHostRecord::Create(const nsHostKey *ke
     rec->_refc = 1; // addref
     NS_LOG_ADDREF(rec, 1, "nsHostRecord", sizeof(nsHostRecord));
     rec->addr_info_lock = lock;
     rec->addr_info = nsnull;
     rec->addr_info_gencnt = 0;
     rec->addr = nsnull;
     rec->expiration = NowInMinutes();
     rec->resolving = PR_FALSE;
+    rec->onQueue = PR_FALSE;
     PR_INIT_CLIST(rec);
     PR_INIT_CLIST(&rec->callbacks);
     rec->negative = PR_FALSE;
     memcpy((char *) rec->host, key->host, hostLen);
 
     *result = rec;
     return NS_OK;
 }
@@ -303,24 +324,36 @@ HostDB_RemoveEntry(PLDHashTable *table,
 //----------------------------------------------------------------------------
 
 nsHostResolver::nsHostResolver(PRUint32 maxCacheEntries,
                                PRUint32 maxCacheLifetime)
     : mMaxCacheEntries(maxCacheEntries)
     , mMaxCacheLifetime(maxCacheLifetime)
     , mLock(nsnull)
     , mIdleThreadCV(nsnull)
-    , mHaveIdleThread(PR_FALSE)
+    , mNumIdleThreads(0)
     , mThreadCount(0)
+    , mAnyPriorityThreadCount(0)
     , mEvictionQSize(0)
+    , mPendingCount(0)
     , mShutdown(PR_TRUE)
 {
     mCreationTime = PR_Now();
-    PR_INIT_CLIST(&mPendingQ);
+    PR_INIT_CLIST(&mHighQ);
+    PR_INIT_CLIST(&mMediumQ);
+    PR_INIT_CLIST(&mLowQ);
     PR_INIT_CLIST(&mEvictionQ);
+
+    mHighPriorityInfo.self = this;
+    mHighPriorityInfo.onlyHighPriority = PR_TRUE;
+    mAnyPriorityInfo.self = this;
+    mAnyPriorityInfo.onlyHighPriority = PR_FALSE;
+
+    mLongIdleTimeout  = PR_SecondsToInterval(LongIdleTimeoutSeconds);
+    mShortIdleTimeout = PR_SecondsToInterval(ShortIdleTimeoutSeconds);
 }
 
 nsHostResolver::~nsHostResolver()
 {
     if (mIdleThreadCV)
         PR_DestroyCondVar(mIdleThreadCV);
 
     if (mLock)
@@ -355,59 +388,113 @@ nsHostResolver::Init()
         LOG(("calling res_ninit\n"));
         res_ninit(&_res);
     }
 #endif
     return NS_OK;
 }
 
 void
+nsHostResolver::ClearPendingQueue(PRCList *aPendingQ)
+{
+    // loop through pending queue, erroring out pending lookups.
+    if (!PR_CLIST_IS_EMPTY(aPendingQ)) {
+        PRCList *node = aPendingQ->next;
+        while (node != aPendingQ) {
+            nsHostRecord *rec = static_cast<nsHostRecord *>(node);
+            node = node->next;
+            OnLookupComplete(rec, NS_ERROR_ABORT, nsnull);
+        }
+    }
+}
+
+void
 nsHostResolver::Shutdown()
 {
     LOG(("nsHostResolver::Shutdown\n"));
 
-    PRCList pendingQ, evictionQ;
-    PR_INIT_CLIST(&pendingQ);
+    PRCList pendingQHigh, pendingQMed, pendingQLow, evictionQ;
+    PR_INIT_CLIST(&pendingQHigh);
+    PR_INIT_CLIST(&pendingQMed);
+    PR_INIT_CLIST(&pendingQLow);
     PR_INIT_CLIST(&evictionQ);
 
     {
         nsAutoLock lock(mLock);
         
         mShutdown = PR_TRUE;
 
-        MoveCList(mPendingQ, pendingQ);
+        MoveCList(mHighQ, pendingQHigh);
+        MoveCList(mMediumQ, pendingQMed);
+        MoveCList(mLowQ, pendingQLow);
         MoveCList(mEvictionQ, evictionQ);
         mEvictionQSize = 0;
-
-        if (mHaveIdleThread)
-            PR_NotifyCondVar(mIdleThreadCV);
+        mPendingCount = 0;
+        
+        if (mNumIdleThreads)
+            PR_NotifyAllCondVar(mIdleThreadCV);
         
         // empty host database
         PL_DHashTableEnumerate(&mDB, HostDB_RemoveEntry, nsnull);
     }
-
-    // loop through pending queue, erroring out pending lookups.
-    if (!PR_CLIST_IS_EMPTY(&pendingQ)) {
-        PRCList *node = pendingQ.next;
-        while (node != &pendingQ) {
-            nsHostRecord *rec = static_cast<nsHostRecord *>(node);
-            node = node->next;
-            OnLookupComplete(rec, NS_ERROR_ABORT, nsnull);
-        }
-    }
+    
+    ClearPendingQueue(&pendingQHigh);
+    ClearPendingQueue(&pendingQMed);
+    ClearPendingQueue(&pendingQLow);
 
     if (!PR_CLIST_IS_EMPTY(&evictionQ)) {
         PRCList *node = evictionQ.next;
         while (node != &evictionQ) {
             nsHostRecord *rec = static_cast<nsHostRecord *>(node);
             node = node->next;
             NS_RELEASE(rec);
         }
     }
 
+#ifdef NS_BUILD_REFCNT_LOGGING
+    
+    // Logically join the outstanding worker threads with a timeout.
+    // Use this approach instead of PR_JoinThread() because that does 
+    // not allow a timeout which may be necessary for a semi-responsive 
+    // shutdown if the thread is blocked on a very slow DNS resolution.
+    // mThreadCount is read outside of mLock, but the worst case 
+    // scenario for that race is one extra 25ms sleep.
+
+    PRIntervalTime delay = PR_MillisecondsToInterval(25);
+    PRIntervalTime stopTime = PR_IntervalNow() + PR_SecondsToInterval(20);
+    while (mThreadCount && PR_IntervalNow() < stopTime)
+        PR_Sleep(delay);
+#endif
+}
+
+static inline PRBool
+IsHighPriority(PRUint16 flags)
+{
+    return !(flags & (nsHostResolver::RES_PRIORITY_LOW | nsHostResolver::RES_PRIORITY_MEDIUM));
+}
+
+static inline PRBool
+IsMediumPriority(PRUint16 flags)
+{
+    return flags & nsHostResolver::RES_PRIORITY_MEDIUM;
+}
+
+static inline PRBool
+IsLowPriority(PRUint16 flags)
+{
+    return flags & nsHostResolver::RES_PRIORITY_LOW;
+}
+
+void 
+nsHostResolver::MoveQueue(nsHostRecord *aRec, PRCList &aDestQ)
+{
+    NS_ASSERTION(aRec->onQueue, "Moving Host Record Not Currently Queued");
+    
+    PR_REMOVE_LINK(aRec);
+    PR_APPEND_LINK(aRec, &aDestQ);
 }
 
 nsresult
 nsHostResolver::ResolveHost(const char            *host,
                             PRUint16               flags,
                             PRUint16               af,
                             nsResolveHostCallback *callback)
 {
@@ -479,26 +566,48 @@ nsHostResolver::ResolveHost(const char  
                 he->rec->addr = (PRNetAddr *) malloc(sizeof(PRNetAddr));
                 if (!he->rec->addr)
                     status = NS_ERROR_OUT_OF_MEMORY;
                 else
                     memcpy(he->rec->addr, &tempAddr, sizeof(PRNetAddr));
                 // put reference to host record on stack...
                 result = he->rec;
             }
+            else if (mPendingCount >= MAX_NON_PRIORITY_REQUESTS &&
+                     !IsHighPriority(flags) &&
+                     !he->rec->resolving) {
+                // This is a lower priority request and we are swamped, so refuse it.
+                rv = NS_ERROR_DNS_LOOKUP_QUEUE_FULL;
+            }
             // otherwise, hit the resolver...
             else {
-                // add callback to the list of pending callbacks
+                // Add callback to the list of pending callbacks.
                 PR_APPEND_LINK(callback, &he->rec->callbacks);
 
                 if (!he->rec->resolving) {
                     he->rec->flags = flags;
                     rv = IssueLookup(he->rec);
                     if (NS_FAILED(rv))
                         PR_REMOVE_AND_INIT_LINK(callback);
+                }
+                else if (he->rec->onQueue) {
+                    // Consider the case where we are on a pending queue of 
+                    // lower priority than the request is being made at.
+                    // In that case we should upgrade to the higher queue.
+
+                    if (IsHighPriority(flags) && !IsHighPriority(he->rec->flags)) {
+                        // Move from (low|med) to high.
+                        MoveQueue(he->rec, mHighQ);
+                        he->rec->flags = flags;
+                        ConditionallyCreateThread(he->rec);
+                    } else if (IsMediumPriority(flags) && IsLowPriority(he->rec->flags)) {
+                        // Move from low to med.
+                        MoveQueue(he->rec, mMediumQ);
+                        he->rec->flags = flags;
+                    }
                 }
             }
         }
     }
     if (result)
         callback->OnLookupComplete(this, result, status);
     return rv;
 }
@@ -534,97 +643,158 @@ nsHostResolver::DetachCallback(const cha
 
     // complete callback with the given status code; this would only be done if
     // the record was in the process of being resolved.
     if (rec)
         callback->OnLookupComplete(this, rec, status);
 }
 
 nsresult
-nsHostResolver::IssueLookup(nsHostRecord *rec)
+nsHostResolver::ConditionallyCreateThread(nsHostRecord *rec)
 {
-    NS_ASSERTION(!rec->resolving, "record is already being resolved"); 
-
-    // add rec to mPendingQ, possibly removing it from mEvictionQ.
-    // if rec is on mEvictionQ, then we can just move the owning
-    // reference over to mPendingQ.
-    if (rec->next == rec)
-        NS_ADDREF(rec);
-    else {
-        PR_REMOVE_LINK(rec);
-        mEvictionQSize--;
-    }
-    PR_APPEND_LINK(rec, &mPendingQ);
-    rec->resolving = PR_TRUE;
-
-    if (mHaveIdleThread) {
+    if (mNumIdleThreads) {
         // wake up idle thread to process this lookup
         PR_NotifyCondVar(mIdleThreadCV);
     }
-    else if (mThreadCount < MAX_THREADS) {
+    else if ((mThreadCount < HighThreadThreshold) ||
+             (IsHighPriority(rec->flags) && mThreadCount < MAX_RESOLVER_THREADS)) {
         // dispatch new worker thread
         NS_ADDREF_THIS(); // owning reference passed to thread
+
+        struct nsHostResolverThreadInfo *info;
+        
+        if (mAnyPriorityThreadCount < HighThreadThreshold) {
+            info = &mAnyPriorityInfo;
+            mAnyPriorityThreadCount++;
+        }
+        else
+            info = &mHighPriorityInfo;
+
         mThreadCount++;
         PRThread *thr = PR_CreateThread(PR_SYSTEM_THREAD,
                                         ThreadFunc,
-                                        this,
+                                        info,
                                         PR_PRIORITY_NORMAL,
                                         PR_GLOBAL_THREAD,
                                         PR_UNJOINABLE_THREAD,
                                         0);
         if (!thr) {
             mThreadCount--;
+            if (info == &mAnyPriorityInfo)
+                mAnyPriorityThreadCount--;
             NS_RELEASE_THIS();
             return NS_ERROR_OUT_OF_MEMORY;
         }
     }
 #if defined(PR_LOGGING)
     else
       LOG(("lookup waiting for thread - %s ...\n", rec->host));
 #endif
-
     return NS_OK;
 }
 
+nsresult
+nsHostResolver::IssueLookup(nsHostRecord *rec)
+{
+    nsresult rv = NS_OK;
+    NS_ASSERTION(!rec->resolving, "record is already being resolved"); 
+
+    // Add rec to one of the pending queues, possibly removing it from mEvictionQ.
+    // If rec is on mEvictionQ, then we can just move the owning
+    // reference over to the new active queue.
+    if (rec->next == rec)
+        NS_ADDREF(rec);
+    else {
+        PR_REMOVE_LINK(rec);
+        mEvictionQSize--;
+    }
+    
+    if (IsHighPriority(rec->flags))
+        PR_APPEND_LINK(rec, &mHighQ);
+    else if (IsMediumPriority(rec->flags))
+        PR_APPEND_LINK(rec, &mMediumQ);
+    else
+        PR_APPEND_LINK(rec, &mLowQ);
+    mPendingCount++;
+    
+    rec->resolving = PR_TRUE;
+    rec->onQueue = PR_TRUE;
+
+    rv = ConditionallyCreateThread(rec);
+    
+    LOG (("DNS Thread Counters: total=%d any=%d high=%d idle=%d pending=%d\n",
+          mThreadCount,
+          mAnyPriorityThreadCount,
+          mThreadCount - mAnyPriorityThreadCount,
+          mNumIdleThreads,
+          mPendingCount));
+
+    return rv;
+}
+
+void
+nsHostResolver::DeQueue(PRCList &aQ, nsHostRecord **aResult)
+{
+    *aResult = static_cast<nsHostRecord *>(aQ.next);
+    PR_REMOVE_AND_INIT_LINK(*aResult);
+    mPendingCount--;
+    (*aResult)->onQueue = PR_FALSE;
+}
+
 PRBool
-nsHostResolver::GetHostToLookup(nsHostRecord **result)
+nsHostResolver::GetHostToLookup(nsHostRecord **result, struct nsHostResolverThreadInfo *aID)
 {
     nsAutoLock lock(mLock);
 
-    PRIntervalTime start = PR_IntervalNow(), timeout = IDLE_TIMEOUT;
-    //
-    // wait for one or more of the following to occur:
-    //  (1) the pending queue has a host record to process
-    //  (2) the shutdown flag has been set
-    //  (3) the thread has been idle for too long
-    //
-    // PR_WaitCondVar will return when any of these conditions is true.
-    //
-    while (PR_CLIST_IS_EMPTY(&mPendingQ) && !mHaveIdleThread && !mShutdown) {
+    PRIntervalTime start = PR_IntervalNow(), timeout;
+    
+    while (!mShutdown) {
+        // remove next record from Q; hand over owning reference. Check high, then med, then low
+        
+        if (!PR_CLIST_IS_EMPTY(&mHighQ)) {
+            DeQueue (mHighQ, result);
+            return PR_TRUE;
+        }
+
+        if (! aID->onlyHighPriority) {
+            if (!PR_CLIST_IS_EMPTY(&mMediumQ)) {
+                DeQueue (mMediumQ, result);
+                return PR_TRUE;
+            }
+            
+            if (!PR_CLIST_IS_EMPTY(&mLowQ)) {
+                DeQueue (mLowQ, result);
+                return PR_TRUE;
+            }
+        }
+        
+        timeout = (mNumIdleThreads >= HighThreadThreshold) ? mShortIdleTimeout : mLongIdleTimeout;
+        // wait for one or more of the following to occur:
+        //  (1) the pending queue has a host record to process
+        //  (2) the shutdown flag has been set
+        //  (3) the thread has been idle for too long
+        //
+        // PR_WaitCondVar will return when any of these conditions is true.
         // become the idle thread and wait for a lookup
-        mHaveIdleThread = PR_TRUE;
+        
+        mNumIdleThreads++;
         PR_WaitCondVar(mIdleThreadCV, timeout);
-        mHaveIdleThread = PR_FALSE;
+        mNumIdleThreads--;
 
         PRIntervalTime delta = PR_IntervalNow() - start;
         if (delta >= timeout)
             break;
         timeout -= delta;
         start += delta;
     }
 
-    if (!PR_CLIST_IS_EMPTY(&mPendingQ)) {
-        // remove next record from mPendingQ; hand over owning reference.
-        *result = static_cast<nsHostRecord *>(mPendingQ.next);
-        PR_REMOVE_AND_INIT_LINK(*result);
-        return PR_TRUE;
-    }
-
     // tell thread to exit...
     mThreadCount--;
+    if (!aID->onlyHighPriority)
+        mAnyPriorityThreadCount--;
     return PR_FALSE;
 }
 
 void
 nsHostResolver::OnLookupComplete(nsHostRecord *rec, nsresult status, PRAddrInfo *result)
 {
     // get the list of pending callbacks for this lookup, and notify
     // them that the lookup is complete.
@@ -693,21 +863,21 @@ nsHostResolver::OnLookupComplete(nsHostR
 
 void
 nsHostResolver::ThreadFunc(void *arg)
 {
     LOG(("nsHostResolver::ThreadFunc entering\n"));
 #if defined(RES_RETRY_ON_FAILURE)
     nsResState rs;
 #endif
-
-    nsHostResolver *resolver = (nsHostResolver *) arg;
+    struct nsHostResolverThreadInfo *info = (struct nsHostResolverThreadInfo *) arg;
+    nsHostResolver *resolver = info->self;
     nsHostRecord *rec;
     PRAddrInfo *ai;
-    while (resolver->GetHostToLookup(&rec)) {
+    while (resolver->GetHostToLookup(&rec, info)) {
         LOG(("resolving %s ...\n", rec->host));
 
         PRIntn flags = PR_AI_ADDRCONFIG;
         if (!(rec->flags & RES_CANON_NAME))
             flags |= PR_AI_NOCANONNAME;
 
         ai = PR_GetAddrInfoByName(rec->host, rec->af, flags);
 #if defined(RES_RETRY_ON_FAILURE)
diff -r a4343d61f6ee netwerk/dns/src/nsHostResolver.h
--- a/netwerk/dns/src/nsHostResolver.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/netwerk/dns/src/nsHostResolver.h	Sat Nov 15 19:43:14 2008 -0500
@@ -63,16 +63,21 @@ class nsResolveHostCallback;
     PRInt32 Release() {                                                      \
         PRInt32 n = PR_AtomicDecrement((PRInt32*)&_refc);                    \
         NS_LOG_RELEASE(this, n, #classname);                                 \
         if (n == 0)                                                          \
             delete this;                                                     \
         return n;                                                            \
     }
 
+#define MAX_RESOLVER_THREADS_FOR_ANY_PRIORITY  3
+#define MAX_RESOLVER_THREADS_FOR_HIGH_PRIORITY 5
+#define MAX_RESOLVER_THREADS (MAX_RESOLVER_THREADS_FOR_ANY_PRIORITY + \
+                              MAX_RESOLVER_THREADS_FOR_HIGH_PRIORITY)
+
 struct nsHostKey
 {
     const char *host;
     PRUint16    flags;
     PRUint16    af;
 };
 
 /**
@@ -119,16 +124,19 @@ private:
 private:
     friend class nsHostResolver;
 
     PRCList callbacks; /* list of callbacks */
 
     PRBool  resolving; /* true if this record is being resolved, which means
                         * that it is either on the pending queue or owned by
                         * one of the worker threads. */ 
+    
+    PRBool  onQueue;  /* true if pending and on the queue (not yet given to getaddrinfo())*/
+        
 
    ~nsHostRecord();
 };
 
 /**
  * ResolveHost callback object.  It's PRCList members are used by
  * the nsHostResolver and should not be used by anything else.
  */
@@ -150,16 +158,26 @@ public:
      * @param record
      *        the host record containing the results of the lookup
      * @param status
      *        if successful, |record| contains non-null results
      */
     virtual void OnLookupComplete(nsHostResolver *resolver,
                                   nsHostRecord   *record,
                                   nsresult        status) = 0;
+};
+
+/**
+ * nsHostResolverThreadInfo structures are passed to the resolver
+ * thread.
+ */
+struct nsHostResolverThreadInfo
+{
+    nsHostResolver *self;
+    PRBool   onlyHighPriority;
 };
 
 /**
  * nsHostResolver - an asynchronous host name resolver.
  */
 class nsHostResolver
 {
 public:
@@ -209,37 +227,53 @@ public:
      * values for the flags parameter passed to ResolveHost and DetachCallback
      * that may be bitwise OR'd together.
      *
      * NOTE: in this implementation, these flags correspond exactly in value
      *       to the flags defined on nsIDNSService.
      */
     enum {
         RES_BYPASS_CACHE = 1 << 0,
-        RES_CANON_NAME   = 1 << 1
+        RES_CANON_NAME   = 1 << 1,
+        RES_PRIORITY_MEDIUM   = 1 << 2,
+        RES_PRIORITY_LOW  = 1 << 3
     };
 
 private:
     nsHostResolver(PRUint32 maxCacheEntries=50, PRUint32 maxCacheLifetime=1);
    ~nsHostResolver();
 
+   // nsHostResolverThreadInfo * is passed to the ThreadFunc
+   struct nsHostResolverThreadInfo  mHighPriorityInfo, mAnyPriorityInfo;
+   
     nsresult Init();
     nsresult IssueLookup(nsHostRecord *);
-    PRBool   GetHostToLookup(nsHostRecord **);
+    PRBool   GetHostToLookup(nsHostRecord **m, struct nsHostResolverThreadInfo *aID);
     void     OnLookupComplete(nsHostRecord *, nsresult, PRAddrInfo *);
-
+    void     DeQueue(PRCList &aQ, nsHostRecord **aResult);
+    void     ClearPendingQueue(PRCList *aPendingQueue);
+    nsresult ConditionallyCreateThread(nsHostRecord *rec);
+    
+    static void  MoveQueue(nsHostRecord *aRec, PRCList &aDestQ);
+    
     static void ThreadFunc(void *);
 
     PRUint32      mMaxCacheEntries;
     PRUint32      mMaxCacheLifetime;
     PRLock       *mLock;
     PRCondVar    *mIdleThreadCV; // non-null if idle thread
-    PRBool        mHaveIdleThread;
+    PRUint32      mNumIdleThreads;
     PRUint32      mThreadCount;
+    PRUint32      mAnyPriorityThreadCount;
     PLDHashTable  mDB;
-    PRCList       mPendingQ;
+    PRCList       mHighQ;
+    PRCList       mMediumQ;
+    PRCList       mLowQ;
     PRCList       mEvictionQ;
     PRUint32      mEvictionQSize;
+    PRUint32      mPendingCount;
     PRTime        mCreationTime;
     PRBool        mShutdown;
+    PRIntervalTime mLongIdleTimeout;
+    PRIntervalTime mShortIdleTimeout;
 };
 
 #endif // nsHostResolver_h__
diff -r a4343d61f6ee netwerk/protocol/http/src/nsHttpChannel.cpp
--- a/netwerk/protocol/http/src/nsHttpChannel.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/netwerk/protocol/http/src/nsHttpChannel.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -77,16 +77,17 @@
 #include "nsIResumableChannel.h"
 #include "nsInt64.h"
 #include "nsIVariant.h"
 #include "nsChannelProperties.h"
 #include "nsStreamUtils.h"
 #include "nsIOService.h"
 #include "nsAuthInformationHolder.h"
 #include "nsICacheService.h"
+#include "nsDNSPrefetch.h"
 
 // True if the local cache should be bypassed when processing a request.
 #define BYPASS_LOCAL_CACHE(loadFlags) \
         (loadFlags & (nsIRequest::LOAD_BYPASS_CACHE | \
                       nsICachingChannel::LOAD_BYPASS_LOCAL_CACHE))
 
 static NS_DEFINE_CID(kStreamListenerTeeCID, NS_STREAMLISTENERTEE_CID);
 
@@ -4004,16 +4005,23 @@ nsHttpChannel::AsyncOpen(nsIStreamListen
     NS_ENSURE_TRUE(!mWasOpened, NS_ERROR_ALREADY_OPENED);
 
     nsresult rv;
 
     rv = NS_CheckPortSafety(mURI);
     if (NS_FAILED(rv))
         return rv;
 
+    // Start a DNS lookup very early in case the real open is queued the DNS can 
+    // happen in parallel.
+    nsRefPtr<nsDNSPrefetch> prefetch = new nsDNSPrefetch(mURI);
+    if (prefetch) {
+        prefetch->PrefetchHigh();
+    }
+
     // Remember the cookie header that was set, if any
     const char *cookieHeader = mRequestHead.PeekHeader(nsHttp::Cookie);
     if (cookieHeader)
         mUserSetCookieHeader = cookieHeader;
 
     // fetch cookies, and add them to the request header
     AddCookiesToRequest();
 
diff -r a4343d61f6ee netwerk/test/httpserver/httpd.js
--- a/netwerk/test/httpserver/httpd.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/netwerk/test/httpserver/httpd.js	Sat Nov 15 19:43:14 2008 -0500
@@ -1800,21 +1800,21 @@ function maybeAddHeaders(file, metadata,
 
   if (!headerFile.exists())
     return;
 
   const PR_RDONLY = 0x01;
   var fis = new FileInputStream(headerFile, PR_RDONLY, 0444,
                                 Ci.nsIFileInputStream.CLOSE_ON_EOF);
 
-  var lis = new ConverterInputStream(fis, "UTF-8", 1024, 0x0);
-  lis.QueryInterface(Ci.nsIUnicharLineInputStream);
-
   try
   {
+    var lis = new ConverterInputStream(fis, "UTF-8", 1024, 0x0);
+    lis.QueryInterface(Ci.nsIUnicharLineInputStream);
+
     var line = {value: ""};
     var more = lis.readLine(line);
 
     if (!more && line.value == "")
       return;
 
 
     // request line
@@ -1855,16 +1855,20 @@ function maybeAddHeaders(file, metadata,
       line.value = "";
       more = lis.readLine(line);
     }
   }
   catch (e)
   {
     dumpn("WARNING: error in headers for " + metadata.path + ": " + e);
     throw HTTP_500;
+  }
+  finally
+  {
+    fis.close();
   }
 }
 
 
 /**
  * An object which handles requests for a server, executing default and
  * overridden behaviors as instructed by the code which uses and manipulates it.
  * Default behavior includes the paths / and /trace (diagnostics), with some
@@ -2333,61 +2337,93 @@ ServerHandler.prototype =
    */
   _writeFileResponse: function(metadata, file, response, offset, count)
   {
     const PR_RDONLY = 0x01;
 
     var type = this._getTypeFromFile(file);
     if (type == SJS_TYPE)
     {
-      try
-      {
-        var fis = new FileInputStream(file, PR_RDONLY, 0444,
-                                      Ci.nsIFileInputStream.CLOSE_ON_EOF);
+      var fis = new FileInputStream(file, PR_RDONLY, 0444,
+                                    Ci.nsIFileInputStream.CLOSE_ON_EOF);
+
+      try
+      {
         var sis = new ScriptableInputStream(fis);
         var s = Cu.Sandbox(gGlobalObject);
         s.importFunction(dump, "dump");
-        Cu.evalInSandbox(sis.read(file.fileSize), s);
-        s.handleRequest(metadata, response);
-      }
-      catch (e)
-      {
-        dump("*** error running SJS: " + e + " on line " + (e.lineNumber-2192) + "\n");
-        throw HTTP_500;
+
+        try
+        {
+          // Alas, the line number in errors dumped to console when calling the
+          // request handler is simply an offset from where we load the SJS file.
+          // Work around this in a reasonably non-fragile way by dynamically
+          // getting the line number where we evaluate the SJS file.  Don't
+          // separate these two lines!
+          var line = new Error().lineNumber;
+          Cu.evalInSandbox(sis.read(file.fileSize), s);
+        }
+        catch (e)
+        {
+          dumpn("*** syntax error in SJS at " + file.path + ": " + e);
+          throw HTTP_500;
+        }
+
+        try
+        {
+          s.handleRequest(metadata, response);
+        }
+        catch (e)
+        {
+          dumpn("*** error running SJS at " + file.path + ": " +
+                e + " on line " + (e.lineNumber - line));
+          throw HTTP_500;
+        }
+      }
+      finally
+      {
+        fis.close();
       }
     }
     else
     {
       try
       {
         response.setHeader("Last-Modified",
                            toDateString(file.lastModifiedTime),
                            false);
       }
       catch (e) { /* lastModifiedTime threw, ignore */ }
 
       response.setHeader("Content-Type", type, false);
   
       var fis = new FileInputStream(file, PR_RDONLY, 0444,
                                     Ci.nsIFileInputStream.CLOSE_ON_EOF);
-      offset = offset || 0;
-      count  = count || file.fileSize;
-
-      NS_ASSERT(offset == 0 || offset < file.fileSize, "bad offset");
-      NS_ASSERT(count >= 0, "bad count");
-
-      if (offset != 0)
-      {
-        // Read and discard data up to offset so the data sent to
-        // the client matches the requested range request.
-        var sis = new ScriptableInputStream(fis);
-        sis.read(offset);
-      }
-      response.bodyOutputStream.writeFrom(fis, count);
-      fis.close();
+
+      try
+      {
+        offset = offset || 0;
+        count  = count || file.fileSize;
+  
+        NS_ASSERT(offset == 0 || offset < file.fileSize, "bad offset");
+        NS_ASSERT(count >= 0, "bad count");
+  
+        if (offset != 0)
+        {
+          // Read and discard data up to offset so the data sent to
+          // the client matches the requested range request.
+          var sis = new ScriptableInputStream(fis);
+          sis.read(offset);
+        }
+        response.bodyOutputStream.writeFrom(fis, count);
+      }
+      finally
+      {
+        fis.close();
+      }
       
       maybeAddHeaders(file, metadata, response);
     }
   },
 
   /**
    * Gets a content-type for the given file, first by checking for any custom
    * MIME-types registered with this handler for the file's extension, second by
diff -r a4343d61f6ee netwerk/test/httpserver/test/data/sjs/thrower.sjs
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/netwerk/test/httpserver/test/data/sjs/thrower.sjs	Sat Nov 15 19:43:14 2008 -0500
@@ -0,0 +1,6 @@
+function handleRequest(request, response)
+{
+  if (request.queryString == "throw")
+    undefined[5];
+  response.setHeader("X-Test-Status", "PASS", false);
+}
diff -r a4343d61f6ee netwerk/test/httpserver/test/head_utils.js
--- a/netwerk/test/httpserver/test/head_utils.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/netwerk/test/httpserver/test/head_utils.js	Sat Nov 15 19:43:14 2008 -0500
@@ -244,21 +244,36 @@ function runHttpTests(testArray, done)
       {
         Array.prototype.push.apply(this._data,
                                    makeBIS(inputStream).readByteArray(count));
       },
       onStopRequest: function(request, cx, status)
       {
         var ch = request.QueryInterface(Ci.nsIHttpChannel)
                         .QueryInterface(Ci.nsIHttpChannelInternal);
-      
-        testArray[testIndex].onStopRequest(ch, cx, status, this._data);
 
-        performNextTest();
-        do_test_finished();
+        // NB: The onStopRequest callback must run before performNextTest here,
+        //     because the latter runs the next test's initChannel callback, and
+        //     we want one test to be sequentially processed before the next
+        //     one.
+        try
+        {
+          testArray[testIndex].onStopRequest(ch, cx, status, this._data);
+        }
+        finally
+        {
+          try
+          {
+            performNextTest();
+          }
+          finally
+          {
+            do_test_finished();
+          }
+        }
       },
       QueryInterface: function(aIID)
       {
         if (aIID.equals(Ci.nsIStreamListener) ||
             aIID.equals(Ci.nsIRequestObserver) ||
             aIID.equals(Ci.nsISupports))
           return this;
         throw Cr.NS_ERROR_NO_INTERFACE;
diff -r a4343d61f6ee netwerk/test/httpserver/test/test_sjs_throwing_exceptions.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/netwerk/test/httpserver/test/test_sjs_throwing_exceptions.js	Sat Nov 15 19:43:14 2008 -0500
@@ -0,0 +1,103 @@
+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim:set ts=2 sw=2 sts=2 et: */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is httpd.js code.
+ *
+ * The Initial Developer of the Original Code is
+ * the Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Jeff Walden <jwalden+code@mit.edu>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+/*
+ * Tests that running an SJS a whole lot of times doesn't have any ill effects
+ * (like exceeding open-file limits due to not closing the SJS file each time,
+ * then preventing any file from being opened).
+ */
+
+const PORT = 4444;
+
+function run_test()
+{
+  var srv = createServer();
+  var sjsDir = do_get_file("netwerk/test/httpserver/test/data/sjs/");
+  srv.registerDirectory("/", sjsDir);
+  srv.registerContentType("sjs", "sjs");
+  srv.start(PORT);
+
+  function done()
+  {
+    srv.stop();
+    do_check_eq(gStartCount, TEST_RUNS);
+    do_check_true(lastPassed);
+  }
+
+  runHttpTests(tests, done);
+}
+
+/***************
+ * BEGIN TESTS *
+ ***************/
+
+var gStartCount = 0;
+var lastPassed = false;
+
+// This hits the open-file limit for me on OS X; your mileage may vary.
+const TEST_RUNS = 250;
+
+var test = new Test("http://localhost:4444/thrower.sjs?throw",
+                    null, start_thrower);
+
+var tests = new Array(TEST_RUNS + 1);
+for (var i = 0; i < TEST_RUNS; i++)
+  tests[i] = test;
+
+// ...and don't forget to stop!
+tests[TEST_RUNS] = new Test("http://localhost:4444/thrower.sjs",
+                            null, start_last);
+
+function start_thrower(ch, cx)
+{
+  do_check_eq(ch.responseStatus, 500);
+  do_check_false(ch.requestSucceeded);
+
+  gStartCount++;
+}
+
+function start_last(ch, cx)
+{
+  do_check_eq(ch.responseStatus, 200);
+  do_check_true(ch.requestSucceeded);
+
+  do_check_eq(ch.getResponseHeader("X-Test-Status"), "PASS");
+
+  lastPassed = true;
+}
diff -r a4343d61f6ee parser/htmlparser/src/nsHTMLTokenizer.cpp
--- a/parser/htmlparser/src/nsHTMLTokenizer.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/parser/htmlparser/src/nsHTMLTokenizer.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -46,17 +46,16 @@
  * older parsers and the SGML specification. Note that most of the real
  * "tokenization" takes place in nsHTMLTokens.cpp.
  */
 
 #include "nsIAtom.h"
 #include "nsHTMLTokenizer.h"
 #include "nsScanner.h"
 #include "nsElementTable.h"
-#include "CParserContext.h"
 #include "nsReadableUtils.h"
 #include "nsUnicharUtils.h"
 
 /************************************************************************
   And now for the main class -- nsHTMLTokenizer...
  ************************************************************************/
 
 /**
diff -r a4343d61f6ee parser/htmlparser/src/nsHTMLTokens.cpp
--- a/parser/htmlparser/src/nsHTMLTokens.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/parser/htmlparser/src/nsHTMLTokens.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -37,17 +37,16 @@
  *
  * ***** END LICENSE BLOCK ***** */
 
 #include <ctype.h>
 #include <time.h>
 #include <stdio.h>
 #include "nsScanner.h"
 #include "nsToken.h"
-#include "nsIAtom.h"
 #include "nsHTMLTokens.h"
 #include "prtypes.h"
 #include "nsDebug.h"
 #include "nsHTMLTags.h"
 #include "nsHTMLEntities.h"
 #include "nsCRT.h"
 #include "nsReadableUtils.h"
 #include "nsUnicharUtils.h"
diff -r a4343d61f6ee parser/htmlparser/src/nsParser.cpp
--- a/parser/htmlparser/src/nsParser.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/parser/htmlparser/src/nsParser.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -195,17 +195,17 @@ private:
 private:
   Type *mHoldee;
   Reaper mReaper;
 };
 
 class nsSpeculativeScriptThread : public nsIRunnable {
 public:
   nsSpeculativeScriptThread()
-    : mLock(PR_DestroyLock),
+    : mLock(nsAutoLock::DestroyLock),
       mCVar(PR_DestroyCondVar),
       mKeepParsing(0),
       mCurrentlyParsing(0),
       mNumURIs(0),
       mNumConsumed(0),
       mContext(nsnull),
       mTerminated(PR_FALSE) {
   }
@@ -252,33 +252,33 @@ public:
     StopParsing(PR_FALSE);
   }
   PRBool Terminated() {
     return mTerminated;
   }
 
 private:
 
-  nsresult ProcessToken(CToken *aToken);
+  void ProcessToken(CToken *aToken);
 
   void AddToPrefetchList(const nsAString &src,
                          const nsAString &charset,
                          const nsAString &elementType,
                          PrefetchType type);
 
   // These members are only accessed on the speculatively parsing thread.
   nsTokenAllocator mTokenAllocator;
 
   // The following members are shared across the main thread and the
   // speculatively parsing thread.
   Holder<PRLock> mLock;
   Holder<PRCondVar> mCVar;
 
-  PRUint32 mKeepParsing;
-  PRUint32 mCurrentlyParsing;
+  volatile PRUint32 mKeepParsing;
+  volatile PRUint32 mCurrentlyParsing;
   nsRefPtr<nsHTMLTokenizer> mTokenizer;
   nsAutoPtr<nsScanner> mScanner;
 
   enum { kBatchPrefetchURIs = 5 };
   nsAutoTArray<PrefetchEntry, kBatchPrefetchURIs> mURIs;
   PRUint16 mNumURIs;
 
   // Number of characters consumed by the last speculative parse.
@@ -376,34 +376,36 @@ nsSpeculativeScriptThread::Run()
   NS_ASSERTION(!NS_IsMainThread(), "Speculative parsing on the main thread?");
 
   mNumConsumed = 0;
 
   mTokenizer->WillTokenize(PR_FALSE, &mTokenAllocator);
   while (mKeepParsing) {
     PRBool flushTokens = PR_FALSE;
     nsresult rv = mTokenizer->ConsumeToken(*mScanner, flushTokens);
-    if (rv == kEOF) {
+    if (NS_FAILED(rv)) {
       break;
     }
 
     mNumConsumed += mScanner->Mark();
 
     // TODO Don't pop the tokens.
     CToken *token;
-    while (mKeepParsing && NS_SUCCEEDED(rv) && (token = mTokenizer->PopToken())) {
-      rv = ProcessToken(token);
+    while (mKeepParsing && (token = mTokenizer->PopToken())) {
+      ProcessToken(token);
     }
   }
   mTokenizer->DidTokenize(PR_FALSE);
 
-  nsAutoLock al(mLock.get());
+  {
+    nsAutoLock al(mLock.get());
 
-  mCurrentlyParsing = 0;
-  PR_NotifyCondVar(mCVar.get());
+    mCurrentlyParsing = 0;
+    PR_NotifyCondVar(mCVar.get());
+  }
   return NS_OK;
 }
 
 nsresult
 nsSpeculativeScriptThread::StartParsing(nsParser *aParser)
 {
   NS_ASSERTION(NS_IsMainThread(), "Called on the wrong thread");
   NS_ASSERTION(!mCurrentlyParsing, "Bad race happening");
@@ -420,17 +422,17 @@ nsSpeculativeScriptThread::StartParsing(
   nsCOMPtr<nsIDocument> doc = do_QueryInterface(sink->GetTarget());
   if (!doc) {
     return NS_OK;
   }
 
   nsAutoString toScan;
   CParserContext *context = aParser->PeekContext();
   if (!mLock.get()) {
-    mLock = PR_NewLock();
+    mLock = nsAutoLock::NewLock("nsSpeculativeScriptThread::mLock");
     if (!mLock.get()) {
       return NS_ERROR_OUT_OF_MEMORY;
     }
 
     mCVar = PR_NewCondVar(mLock.get());
     if (!mCVar.get()) {
       return NS_ERROR_OUT_OF_MEMORY;
     }
@@ -491,17 +493,17 @@ nsSpeculativeScriptThread::StartParsing(
   mDocument.swap(doc);
   mKeepParsing = 1;
   mCurrentlyParsing = 1;
   mContext = context;
   return aParser->ThreadPool()->Dispatch(this, NS_DISPATCH_NORMAL);
 }
 
 void
-nsSpeculativeScriptThread::StopParsing(PRBool aFromDocWrite)
+nsSpeculativeScriptThread::StopParsing(PRBool /*aFromDocWrite*/)
 {
   NS_ASSERTION(NS_IsMainThread(), "Can't stop parsing from another thread");
 
   if (!mLock.get()) {
     // If we bailed early out of StartParsing, don't do anything.
     return;
   }
 
@@ -528,20 +530,19 @@ nsSpeculativeScriptThread::StopParsing(P
     nsPreloadURIs::PreloadURIs(mURIs, this);
     mNumURIs = 0;
     mURIs.Clear();
   }
 
   // Note: Currently, we pop the tokens off (see the comment in Run) so this
   // isn't a problem. If and when we actually use the tokens created
   // off-thread, we'll need to use aFromDocWrite for real.
-  (void)aFromDocWrite;
 }
 
-nsresult
+void
 nsSpeculativeScriptThread::ProcessToken(CToken *aToken)
 {
   // Only called on the speculative script thread.
 
   CHTMLToken *token = static_cast<CHTMLToken *>(aToken);
   switch (static_cast<eHTMLTokenTypes>(token->GetTokenType())) {
     case eToken_start: {
         CStartToken *start = static_cast<CStartToken *>(aToken);
@@ -630,17 +631,16 @@ nsSpeculativeScriptThread::ProcessToken(
         break;
       }
 
     default:
       break;
   }
 
   IF_FREE(aToken, &mTokenAllocator);
-  return NS_OK;
 }
 
 void
 nsSpeculativeScriptThread::AddToPrefetchList(const nsAString &src,
                                       const nsAString &charset,
                                       const nsAString &elementType,
                                       PrefetchType type)
 {
@@ -1533,34 +1533,32 @@ nsParser::DidBuildModel(nsresult anError
   }
 
   return result;
 }
 
 void
 nsParser::SpeculativelyParse()
 {
-#if 0 // Disable temporarily to see if this is the cause of the bustage.
   if (mParserContext->mParserCommand == eViewNormal &&
       !mParserContext->mMimeType.EqualsLiteral("text/html")) {
     return;
   }
 
   if (!mSpeculativeScriptThread) {
     mSpeculativeScriptThread = new nsSpeculativeScriptThread();
     if (!mSpeculativeScriptThread) {
       return;
     }
   }
 
   nsresult rv = mSpeculativeScriptThread->StartParsing(this);
   if (NS_FAILED(rv)) {
     mSpeculativeScriptThread = nsnull;
   }
-#endif
 }
 
 /**
  * This method adds a new parser context to the list,
  * pushing the current one to the next position.
  *
  * @param   ptr to new context
  */
diff -r a4343d61f6ee parser/htmlparser/src/nsParser.h
--- a/parser/htmlparser/src/nsParser.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/parser/htmlparser/src/nsParser.h	Sat Nov 15 19:43:14 2008 -0500
@@ -89,31 +89,28 @@
 #include "nsCOMArray.h"
 #include "nsIUnicharStreamListener.h"
 #include "nsCycleCollectionParticipant.h"
 
 class nsICharsetConverterManager;
 class nsICharsetAlias;
 class nsIDTD;
 class nsScanner;
-class nsIProgressEventSink;
 class nsSpeculativeScriptThread;
 class nsIThreadPool;
 
 #ifdef _MSC_VER
 #pragma warning( disable : 4275 )
 #endif
 
 
 class nsParser : public nsIParser,
-                 public nsIStreamListener{
-
-  
+                 public nsIStreamListener
+{
   public:
-    friend class CTokenHandler;
     /**
      * Called on module init
      */
     static nsresult Init();
 
     /**
      * Called on module shutdown
      */
diff -r a4343d61f6ee parser/htmlparser/src/nsViewSourceHTML.cpp
--- a/parser/htmlparser/src/nsViewSourceHTML.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/parser/htmlparser/src/nsViewSourceHTML.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -45,24 +45,24 @@
  * output.  Multi-block output helps reduce the amount of bidi
  * processing we have to do on the resulting content model.
  */
 #define NS_VIEWSOURCE_TOKENS_PER_BLOCK 16
 
 #ifdef RAPTOR_PERF_METRICS
 #  define START_TIMER()                    \
     if(mParser) mParser->mParseTime.Start(PR_FALSE); \
-    if(mParser) mParser->mDTDTime.Start(PR_FALSE); 
+    if(mParser) mParser->mDTDTime.Start(PR_FALSE);
 
 #  define STOP_TIMER()                     \
     if(mParser) mParser->mParseTime.Stop(); \
-    if(mParser) mParser->mDTDTime.Stop(); 
+    if(mParser) mParser->mDTDTime.Stop();
 
 #else
-#  define STOP_TIMER() 
+#  define STOP_TIMER()
 #  define START_TIMER()
 #endif
 
 #include "nsIAtom.h"
 #include "nsViewSourceHTML.h"
 #include "nsCRT.h"
 #include "nsParser.h"
 #include "nsScanner.h"
@@ -70,16 +70,17 @@
 #include "nsDTDUtils.h"
 #include "nsIContentSink.h"
 #include "nsIHTMLContentSink.h"
 #include "nsHTMLTokenizer.h"
 #include "nsIPrefService.h"
 #include "nsIPrefBranch.h"
 #include "nsUnicharUtils.h"
 #include "nsPrintfCString.h"
+#include "nsNetUtil.h"
 
 #include "nsIServiceManager.h"
 
 #include "nsElementTable.h"
 
 #include "prenv.h"  //this is here for debug reasons...
 #include "prtypes.h"  //this is here for debug reasons...
 #include "prio.h"
@@ -133,17 +134,17 @@ static const char* const kElementClasses
   "comment",
   "cdata",
   "doctype",
   "pi",
   "entity",
   "text",
   "attribute-name",
   "attribute-value",
-  "markupdeclaration"  
+  "markupdeclaration"
 };
 
 static const char* const kBeforeText[] = {
   "<",
   "</",
   "",
   "",
   "",
@@ -196,20 +197,20 @@ static const char* const kDumpFileAfterT
   "",
   "",
   ""
 };
 #endif // DUMP_TO_FILE
 
 /**
  *  Default constructor
- *  
+ *
  *  @update  gess 4/9/98
- *  @param   
- *  @return  
+ *  @param
+ *  @return
  */
 CViewSourceHTML::CViewSourceHTML()
 {
   mSyntaxHighlight = PR_FALSE;
   mWrapLongLines = PR_FALSE;
   nsCOMPtr<nsIPrefBranch> prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));
   if (prefBranch) {
     PRBool temp;
@@ -236,55 +237,55 @@ CViewSourceHTML::CViewSourceHTML()
 #endif // DUMP_TO_FILE
 
 }
 
 
 
 /**
  *  Default destructor
- *  
+ *
  *  @update  gess 4/9/98
- *  @param   
- *  @return  
+ *  @param
+ *  @return
  */
 CViewSourceHTML::~CViewSourceHTML(){
   mParser=0; //just to prove we destructed...
 }
 
 /**
   * The parser uses a code sandwich to wrap the parsing process. Before
   * the process begins, WillBuildModel() is called. Afterwards the parser
-  * calls DidBuildModel(). 
-  * @update	rickg 03.20.2000
-  * @param	aParserContext
-  * @param	aSink
-  * @return	error code (almost always 0)
+  * calls DidBuildModel().
+  * @update rickg 03.20.2000
+  * @param  aParserContext
+  * @param  aSink
+  * @return error code (almost always 0)
   */
 nsresult CViewSourceHTML::WillBuildModel(const CParserContext& aParserContext,
                                          nsITokenizer* aTokenizer,
                                          nsIContentSink* aSink){
 
   nsresult result=NS_OK;
 
 #ifdef RAPTOR_PERF_METRICS
   vsTimer.Reset();
   NS_START_STOPWATCH(vsTimer);
-#endif 
+#endif
 
   STOP_TIMER();
   mSink=(nsIHTMLContentSink*)aSink;
 
   if((!aParserContext.mPrevContext) && (mSink)) {
 
     nsAString & contextFilename = aParserContext.mScanner->GetFilename();
     mFilename = Substring(contextFilename,
                           12, // The length of "view-source:"
                           contextFilename.Length() - 12);
-    
+
     mDocType=aParserContext.mDocType;
     mMimeType=aParserContext.mMimeType;
     mDTDMode=aParserContext.mDTDMode;
     mParserCommand=aParserContext.mParserCommand;
     mTokenizer = aTokenizer;
 
 #ifdef DUMP_TO_FILE
     if (gDumpFile) {
@@ -326,20 +327,20 @@ nsresult CViewSourceHTML::WillBuildModel
   parserContext.mDTDMode = mDTDMode;
   START_TIMER();
   return result;
 }
 
 /**
   * The parser uses a code sandwich to wrap the parsing process. Before
   * the process begins, WillBuildModel() is called. Afterwards the parser
-  * calls DidBuildModel(). 
-  * @update	gess5/18/98
-  * @param	aFilename is the name of the file being parsed.
-  * @return	error code (almost always 0)
+  * calls DidBuildModel().
+  * @update gess5/18/98
+  * @param  aFilename is the name of the file being parsed.
+  * @return error code (almost always 0)
   */
 NS_IMETHODIMP CViewSourceHTML::BuildModel(nsIParser* aParser,nsITokenizer* aTokenizer,nsITokenObserver* anObserver,nsIContentSink* aSink) {
   nsresult result=NS_OK;
 
   if(aTokenizer && aParser) {
 
     nsITokenizer*  oldTokenizer=mTokenizer;
     mTokenizer=aTokenizer;
@@ -391,17 +392,17 @@ NS_IMETHODIMP CViewSourceHTML::BuildMode
 
           AddAttrToNode(theNode, theAllocator,
                         NS_LITERAL_STRING("type"),
                         NS_LITERAL_STRING("text/css"));
 
           AddAttrToNode(theNode, theAllocator,
                         NS_LITERAL_STRING("href"),
                         NS_LITERAL_STRING("resource://gre/res/viewsource.css"));
-          
+
           mSink->AddLeaf(theNode);
         }
         IF_FREE(theToken, theAllocator);
       }
 
       result = mSink->CloseContainer(eHTMLTag_head);
       if(NS_SUCCEEDED(result)) {
         mHasOpenRoot = PR_TRUE;
@@ -415,27 +416,27 @@ NS_IMETHODIMP CViewSourceHTML::BuildMode
                                                          eHTMLTag_body,
                                                          NS_LITERAL_STRING("BODY")));
         if (bodyToken) {
           nsCParserStartNode bodyNode(bodyToken, theAllocator);
 
           AddAttrToNode(bodyNode, theAllocator,
                         NS_LITERAL_STRING("id"),
                         NS_ConvertASCIItoUTF16(kBodyId));
-          
+
           if (mWrapLongLines) {
             AddAttrToNode(bodyNode, theAllocator,
                           NS_LITERAL_STRING("class"),
                           NS_ConvertASCIItoUTF16(kBodyClassWrap));
           }
           result = mSink->OpenContainer(bodyNode);
           if(NS_SUCCEEDED(result)) mHasOpenBody=PR_TRUE;
         }
         IF_FREE(bodyToken, theAllocator);
-        
+
         if (NS_SUCCEEDED(result)) {
           CStartToken* preToken =
             static_cast<CStartToken*>
                        (theAllocator->CreateTokenOfType(eToken_start,
                                                            eHTMLTag_pre,
                                                            NS_LITERAL_STRING("PRE")));
           if (preToken) {
             nsCParserStartNode preNode(preToken, theAllocator);
@@ -463,17 +464,17 @@ NS_IMETHODIMP CViewSourceHTML::BuildMode
             break;
           }
         } else {
           mTokenizer->PushTokenFront(theToken);
         }
       }
       else break;
     }//while
-   
+
     mTokenizer=oldTokenizer;
   }
   else result=NS_ERROR_HTMLPARSER_BADTOKENIZER;
   return result;
 }
 
 /**
  * Call this to start a new PRE block.  See bug 86355 for why this
@@ -483,50 +484,50 @@ void CViewSourceHTML::StartNewPreBlock(v
   CEndToken endToken(eHTMLTag_pre);
   nsCParserNode endNode(&endToken, 0/*stack token*/);
   mSink->CloseContainer(eHTMLTag_pre);
 
   nsTokenAllocator* theAllocator = mTokenizer->GetTokenAllocator();
   if (!theAllocator) {
     return;
   }
-  
+
   CStartToken* theToken =
     static_cast<CStartToken*>
                (theAllocator->CreateTokenOfType(eToken_start,
                                                    eHTMLTag_pre,
                                                    NS_LITERAL_STRING("PRE")));
   if (!theToken) {
     return;
   }
 
   nsCParserStartNode startNode(theToken, theAllocator);
   AddAttrToNode(startNode, theAllocator,
                 NS_LITERAL_STRING("id"),
                 NS_ConvertASCIItoUTF16(nsPrintfCString("line%d", mLineNumber)));
   mSink->OpenContainer(startNode);
   IF_FREE(theToken, theAllocator);
-  
+
 #ifdef DUMP_TO_FILE
   if (gDumpFile) {
     fprintf(gDumpFile, "</pre>\n");
     fprintf(gDumpFile, "<pre id=\"line%d\">\n", mLineNumber);
   }
 #endif // DUMP_TO_FILE
 
   mTokenCount = 0;
 }
 
 void CViewSourceHTML::AddAttrToNode(nsCParserStartNode& aNode,
                                     nsTokenAllocator* aAllocator,
                                     const nsAString& aAttrName,
                                     const nsAString& aAttrValue)
 {
   NS_PRECONDITION(aAllocator, "Must have a token allocator!");
-  
+
   CAttributeToken* theAttr =
     (CAttributeToken*) aAllocator->CreateTokenOfType(eToken_attribute,
                                                      eHTMLTag_unknown,
                                                      aAttrValue);
   if (!theAttr) {
     NS_ERROR("Failed to allocate attribute token");
     return;
   }
@@ -535,19 +536,19 @@ void CViewSourceHTML::AddAttrToNode(nsCP
   aNode.AddAttribute(theAttr);
 
   // Parser nodes assume that they are being handed a ref when AddAttribute is
   // called, unlike Init() and construction, when they actually addref the
   // incoming token.  Do NOT release here unless this setup changes.
 }
 
 /**
- * 
- * @update	gess5/18/98
- * @param 
+ *
+ * @update  gess5/18/98
+ * @param
  * @return
  */
 NS_IMETHODIMP CViewSourceHTML::DidBuildModel(nsresult anErrorCode,PRBool aNotifySink,nsIParser* aParser,nsIContentSink* aSink){
   nsresult result= NS_OK;
 
   //ADD CODE HERE TO CLOSE OPEN CONTAINERS...
 
   if(aParser){
@@ -580,153 +581,159 @@ NS_IMETHODIMP CViewSourceHTML::DidBuildM
 
   }
 
 #ifdef RAPTOR_PERF_METRICS
   NS_STOP_STOPWATCH(vsTimer);
   printf("viewsource timer: ");
   vsTimer.Print();
   printf("\n");
-#endif 
+#endif
 
   return result;
 }
 
 /**
  * Use this id you want to stop the building content model
  * --------------[ Sets DTD to STOP mode ]----------------
  * It's recommended to use this method in accordance with
  * the parser's terminate() method.
  *
- * @update	harishd 07/22/99
- * @param 
+ * @update  harishd 07/22/99
+ * @param
  * @return
  */
-NS_IMETHODIMP_(void)  
+NS_IMETHODIMP_(void)
 CViewSourceHTML::Terminate() {
 }
 
-NS_IMETHODIMP_(PRInt32)  
+NS_IMETHODIMP_(PRInt32)
 CViewSourceHTML::GetType() {
   return NS_IPARSER_FLAG_HTML;
 }
 
 /**
- * 
- * @update	gess5/18/98
- * @param 
+ *
+ * @update  gess5/18/98
+ * @param
  * @return
  */
 NS_IMETHODIMP CViewSourceHTML::WillResumeParse(nsIContentSink* aSink){
   nsresult result = NS_OK;
   if(mSink) {
     result = mSink->WillResume();
   }
   return result;
 }
 
 /**
- * 
- * @update	gess5/18/98
- * @param 
+ *
+ * @update  gess5/18/98
+ * @param
  * @return
  */
 NS_IMETHODIMP CViewSourceHTML::WillInterruptParse(nsIContentSink* aSink){
   nsresult result = NS_OK;
   if(mSink) {
     result = mSink->WillInterrupt();
   }
   return result;
 }
 
 /**
  * Called by the parser to enable/disable dtd verification of the
  * internal context stack.
- * @update	gess 7/23/98
- * @param 
+ * @update  gess 7/23/98
+ * @param
  * @return
  */
 void CViewSourceHTML::SetVerification(PRBool aEnabled)
 {
 }
 
 /**
  *  This method is called to determine whether or not a tag
  *  of one type can contain a tag of another type.
- *  
+ *
  *  @update  gess 3/25/98
  *  @param   aParent -- int tag of parent container
  *  @param   aChild -- int tag of child container
  *  @return  PR_TRUE if parent can contain child
  */
 PRBool CViewSourceHTML::CanContain(PRInt32 aParent,PRInt32 aChild) const{
   PRBool result=PR_TRUE;
   return result;
 }
 
 /**
- *  This method gets called to determine whether a given 
+ *  This method gets called to determine whether a given
  *  tag is itself a container
  *  
  *  @update  gess 3/25/98
  *  @param   aTag -- tag to test for containership
  *  @return  PR_TRUE if given tag can contain other tags
  */
 PRBool CViewSourceHTML::IsContainer(PRInt32 aTag) const{
   PRBool result=PR_TRUE;
   return result;
 }
 
 /**
  *  This method gets called when a tag needs to write it's attributes
- *  
+ *
  *  @update  gess 3/25/98
- *  @param   
+ *  @param
  *  @return  result status
  */
-nsresult CViewSourceHTML::WriteAttributes(PRInt32 attrCount, PRBool aOwnerInError) {
+nsresult CViewSourceHTML::WriteAttributes(const nsAString& tagName, 
+                                          nsTokenAllocator* allocator, 
+                                          PRInt32 attrCount, PRBool aOwnerInError) {
   nsresult result=NS_OK;
-  
+
   if(attrCount){ //go collect the attributes...
     int attr = 0;
     for(attr = 0; attr < attrCount; ++attr){
       CToken* theToken = mTokenizer->PeekToken();
       if(theToken)  {
         eHTMLTokenTypes theType = eHTMLTokenTypes(theToken->GetTokenType());
         if(eToken_attribute == theType){
           mTokenizer->PopToken(); //pop it for real...
           mTokenNode.AddAttribute(theToken);  //and add it to the node.
 
           CAttributeToken* theAttrToken = (CAttributeToken*)theToken;
           const nsSubstring& theKey = theAttrToken->GetKey();
-          
+
           // The attribute is only in error if its owner is NOT in error.
           const PRBool attributeInError =
             !aOwnerInError && theAttrToken->IsInError();
 
           result = WriteTag(kAttributeName,theKey,0,attributeInError);
           const nsSubstring& theValue = theAttrToken->GetValue();
 
           if(!theValue.IsEmpty() || theAttrToken->mHasEqualWithoutValue){
-            result = WriteTag(kAttributeValue,theValue,0,attributeInError);
+            if (IsUrlAttribute(tagName, theKey, theValue)) {
+              WriteHrefAttribute(allocator, theValue);
+            } else {
+              WriteTag(kAttributeValue,theValue,0,attributeInError);
+            }
           }
-        } 
+        }
       }
       else return kEOF;
     }
   }
 
   return result;
 }
 
 /**
  *  This method gets called when a tag needs to be sent out
- *  
+ *
  *  @update  gess 3/25/98
- *  @param   
+ *  @param
  *  @return  result status
  */
 nsresult CViewSourceHTML::WriteTag(PRInt32 aTagType,const nsSubstring & aText,PRInt32 attrCount,PRBool aTagInError) {
   nsresult result=NS_OK;
 
   // adjust line number to what it will be after we finish writing this tag
   // XXXbz life here sucks.  We can't use the GetNewlineCount on the token,
   // because Text tokens in <style>, <script>, etc lie through their teeth.
@@ -766,17 +773,17 @@ nsresult CViewSourceHTML::WriteTag(PRInt
     mITextToken.SetIndirectString(beforeText);
     nsCParserNode theNode(&mITextToken, 0/*stack token*/);
     mSink->AddLeaf(theNode);
   }
 #ifdef DUMP_TO_FILE
   if (gDumpFile && kDumpFileBeforeText[aTagType][0])
     fprintf(gDumpFile, kDumpFileBeforeText[aTagType]);
 #endif // DUMP_TO_FILE
-  
+
   if (mSyntaxHighlight && aTagType != kText) {
     CStartToken* theTagToken=
       static_cast<CStartToken*>
                  (theAllocator->CreateTokenOfType(eToken_start,
                                                      eHTMLTag_span,
                                                      NS_LITERAL_STRING("SPAN")));
     NS_ENSURE_TRUE(theTagToken, NS_ERROR_OUT_OF_MEMORY);
     mStartNode.Init(theTagToken, theAllocator);
@@ -802,74 +809,74 @@ nsresult CViewSourceHTML::WriteTag(PRInt
   mSink->AddLeaf(theNode);
 #ifdef DUMP_TO_FILE
   if (gDumpFile) {
     fputs(NS_ConvertUTF16toUTF8(aText).get(), gDumpFile);
   }
 #endif // DUMP_TO_FILE
 
   if (mSyntaxHighlight && aTagType != kText) {
-    mStartNode.ReleaseAll(); 
+    mStartNode.ReleaseAll();
     mSink->CloseContainer(eHTMLTag_span);  //emit </endtag>...
 #ifdef DUMP_TO_FILE
     if (gDumpFile)
       fprintf(gDumpFile, "</span>");
 #endif //DUMP_TO_FILE
   }
 
   if(attrCount){
-    result=WriteAttributes(attrCount, aTagInError);
+    result=WriteAttributes(aText, theAllocator, attrCount, aTagInError);
   }
 
-  // Tokens are set in error if their ending > is not there, so don't output 
+  // Tokens are set in error if their ending > is not there, so don't output
   // the after-text
   if (!aTagInError && kAfterText[aTagType][0] != 0) {
     NS_ConvertASCIItoUTF16 afterText(kAfterText[aTagType]);
     mITextToken.SetIndirectString(afterText);
     nsCParserNode theNode(&mITextToken, 0/*stack token*/);
     mSink->AddLeaf(theNode);
   }
 #ifdef DUMP_TO_FILE
   if (!aTagInError && gDumpFile && kDumpFileAfterText[aTagType][0])
     fprintf(gDumpFile, kDumpFileAfterText[aTagType]);
 #endif // DUMP_TO_FILE
 
   if (mSyntaxHighlight && aTagInError) {
-    mErrorNode.ReleaseAll(); 
+    mErrorNode.ReleaseAll();
     mSink->CloseContainer(eHTMLTag_span);  //emit </endtag>...
 #ifdef DUMP_TO_FILE
     if (gDumpFile)
       fprintf(gDumpFile, "</span>");
 #endif //DUMP_TO_FILE
   }
 
   START_TIMER();
 
   return result;
 }
 
 /**
- *  
+ *
  *  @update  gess 3/25/98
  *  @param   aToken -- token object to be put into content model
  *  @return  0 if all is well; non-zero is an error
  */
 NS_IMETHODIMP CViewSourceHTML::HandleToken(CToken* aToken,nsIParser* aParser)
 {
   nsresult        result=NS_OK;
   CHTMLToken*     theToken= (CHTMLToken*)(aToken);
   eHTMLTokenTypes theType= (eHTMLTokenTypes)theToken->GetTokenType();
- 
+
   mParser=(nsParser*)aParser;
   mSink=(nsIHTMLContentSink*)aParser->GetContentSink();
- 
+
   mTokenNode.Init(theToken, mTokenizer->GetTokenAllocator());
 
   switch(theType) {
-    
+
     case eToken_start:
       {
         const nsSubstring& startValue = aToken->GetStringValue();
         result = WriteTag(kStartTag,startValue,aToken->GetAttributeCount(),aToken->IsInError());
 
         if((ePlainText!=mDocType) && mParser && (NS_OK==result)) {
           result = mSink->NotifyTagObservers(&mTokenNode);
         }
@@ -902,17 +909,17 @@ NS_IMETHODIMP CViewSourceHTML::HandleTok
         theStr.Append(aToken->GetStringValue());
         if (!aToken->IsInError()) {
           theStr.AppendLiteral(">");
         }
         result=WriteTag(kMarkupDecl,theStr,0,aToken->IsInError());
       }
       break;
 
-    case eToken_comment: 
+    case eToken_comment:
       {
         nsAutoString theStr;
         aToken->AppendSourceTo(theStr);
         result=WriteTag(kComment,theStr,0,aToken->IsInError());
       }
       break;
 
     case eToken_doctypeDecl:
@@ -946,17 +953,17 @@ NS_IMETHODIMP CViewSourceHTML::HandleTok
           if (ch == kLF || ch == kCR)
             StartNewPreBlock();
         }
       }
       break;
 
     case eToken_text:
       {
-        const nsSubstring& str = aToken->GetStringValue();         
+        const nsSubstring& str = aToken->GetStringValue();
         result=WriteTag(kText,str,aToken->GetAttributeCount(),aToken->IsInError());
         ++mTokenCount;
         if (NS_VIEWSOURCE_TOKENS_PER_BLOCK > 0 &&
             mTokenCount > NS_VIEWSOURCE_TOKENS_PER_BLOCK && !str.IsEmpty()) {
           PRUnichar ch = str.Last();
           if (ch == kLF || ch == kCR)
             StartNewPreBlock();
         }
@@ -971,13 +978,230 @@ NS_IMETHODIMP CViewSourceHTML::HandleTok
     case eToken_instruction:
       result=WriteTag(kPI,aToken->GetStringValue(),0,aToken->IsInError());
       break;
 
     default:
       result=NS_OK;
   }//switch
 
-  mTokenNode.ReleaseAll(); 
+  mTokenNode.ReleaseAll();
 
   return result;
 }
 
+PRBool CViewSourceHTML::IsUrlAttribute(const nsAString& tagName,
+                                       const nsAString& attrName, 
+                                       const nsAString& attrValue) {
+  const nsSubstring &trimmedAttrName = TrimTokenValue(attrName);
+
+  PRBool isHref = trimmedAttrName.LowerCaseEqualsLiteral("href");
+  PRBool isSrc = !isHref && trimmedAttrName.LowerCaseEqualsLiteral("src");
+
+  // If this is the HREF attribute of a BASE element, then update the base URI.
+  // This doesn't feel like the ideal place for this, but the alternatives don't
+  // seem all that nice either.
+  if (isHref && tagName.LowerCaseEqualsLiteral("base")) {
+    const nsSubstring& baseSpec = TrimTokenValue(attrValue);
+    SetBaseURI(baseSpec);
+  }
+
+  return isHref || isSrc;
+}
+
+void CViewSourceHTML::WriteHrefAttribute(nsTokenAllocator* allocator,
+                                         const nsAString& href) {
+  // The "href" will typically contain not only the href proper, but the single
+  // or double quotes and often some surrounding whitespace as well.  Find the
+  // location of the href proper inside the string.
+  nsAString::const_iterator startProper, endProper;
+  href.BeginReading(startProper);
+  href.EndReading(endProper);
+  TrimTokenValue(startProper, endProper);
+
+  // Break the href into three parts, the preceding text, the href proper, and
+  // the succeeding text.
+  nsAString::const_iterator start, end;
+  href.BeginReading(start);
+  href.EndReading(end);  
+  const nsAString &precedingText = Substring(start, startProper);
+  const nsAString &hrefProper = Substring(startProper, endProper);
+  const nsAString &succeedingText = Substring(endProper, end);
+
+  nsAutoString fullPrecedingText;
+  fullPrecedingText.Assign(kEqual);
+  fullPrecedingText.Append(precedingText);
+
+  // Regular URLs and view-source URLs work the same way for .js and .css files.
+  // However, if the user follows a link in the view source window to a .html
+  // file (i.e. the HREF in an A tag), then presumably they will expect to see
+  // the *source* of that new page, not the rendered version.  So for now we
+  // just slap a "view-source:" at the beginning of each URL.  There are two
+  // big downsides to doing it this way -- we must make relative URLs into
+  // absolute URLs before we can turn them into view-source URLs, and links
+  // to images don't work right -- nobody wants to see the bytes constituting a
+  // PNG rendered as text.  A smarter view-source handler might be able to deal
+  // with the latter problem.
+
+  // Construct a "view-source" URL for the HREF.
+  nsAutoString viewSourceUrl;
+  CreateViewSourceURL(hrefProper, viewSourceUrl);
+
+  // Construct the HTML that will represent the HREF.
+  NS_NAMED_LITERAL_STRING(HREF, "href");
+  if (fullPrecedingText.Length() > 0) {
+    WriteTextInSpan(fullPrecedingText, allocator, EmptyString(), EmptyString());
+  }
+  WriteTextInAnchor(hrefProper, allocator, HREF, viewSourceUrl);
+  if (succeedingText.Length() > 0) {
+    WriteTextInSpan(succeedingText, allocator, EmptyString(), EmptyString());
+  }
+}
+
+nsresult CViewSourceHTML::CreateViewSourceURL(const nsAString& linkUrl,
+                                              nsString& viewSourceUrl) {
+  nsCOMPtr<nsIURI> baseURI;
+  nsCOMPtr<nsIURI> hrefURI;
+  nsresult rv;
+
+  // Default the view source URL to the empty string in case we fail.  Links
+  // with empty HREFs are essentially non-functional, at least as of Firefox
+  // 3.03.  This is preferrable behavior to links that look good but then 404.
+  viewSourceUrl.Truncate();
+  
+  // Get the character set.
+  nsCString charset;
+  PRInt32 source;
+  mParser->GetDocumentCharset(charset, source);
+
+  // Get the BaseURI.
+  rv = GetBaseURI(getter_AddRefs(baseURI));
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  // Use the link URL and the base URI to build a URI for the link.
+  rv = NS_NewURI(getter_AddRefs(hrefURI), linkUrl, charset.get(), baseURI);
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  // Get the absolute URL from the link URI.
+  nsCString absoluteLinkUrl;
+  hrefURI->GetSpec(absoluteLinkUrl);
+
+  // Prepend "view-source:" onto the absolute URL and store it in the out param.
+  viewSourceUrl.AssignLiteral("view-source:");
+  viewSourceUrl.AppendWithConversion(absoluteLinkUrl);
+
+  return NS_OK;
+}
+
+void CViewSourceHTML::WriteTextInSpan(const nsAString& text, 
+                                      nsTokenAllocator* allocator, 
+                                      const nsAString& attrName, 
+                                      const nsAString& attrValue) {
+  NS_NAMED_LITERAL_STRING(SPAN, "SPAN");
+  WriteTextInElement(SPAN, eHTMLTag_span, text, allocator, attrName, attrValue);
+}
+
+void CViewSourceHTML::WriteTextInAnchor(const nsAString& text, 
+                                        nsTokenAllocator* allocator, 
+                                        const nsAString& attrName, 
+                                        const nsAString& attrValue) {
+  NS_NAMED_LITERAL_STRING(ANCHOR, "A");
+  WriteTextInElement(ANCHOR, eHTMLTag_a, text, allocator, attrName, attrValue);
+}
+
+void CViewSourceHTML::WriteTextInElement(const nsAString& tagName, 
+                                         eHTMLTags tagType, const nsAString& text,
+                                         nsTokenAllocator* allocator,
+                                         const nsAString& attrName, 
+                                         const nsAString& attrValue) {
+  // Open the element, supplying the attribute, if any.
+  nsTokenAllocator* theAllocator = mTokenizer->GetTokenAllocator();
+  if (!theAllocator) {
+    return;
+  }
+
+  CStartToken* startToken =
+    static_cast<CStartToken*>
+      (theAllocator->CreateTokenOfType(eToken_start, tagType, tagName));
+  if (!startToken) {
+    return;
+  }
+
+  nsCParserStartNode startNode(startToken, theAllocator);
+  if (!attrName.IsEmpty()) {
+    AddAttrToNode(startNode, allocator, attrName, attrValue);
+  }
+  mSink->OpenContainer(startNode);
+
+  // Add the text node.
+  CTextToken textToken(text);
+  nsCParserNode textNode(&textToken, 0/*stack token*/);
+  mSink->AddLeaf(textNode);
+
+  // Close the element.
+  mSink->CloseContainer(tagType);
+}
+
+const nsDependentSubstring CViewSourceHTML::TrimTokenValue(const nsAString& tokenValue) {
+  nsAString::const_iterator start, end;
+  tokenValue.BeginReading(start);
+  tokenValue.EndReading(end);
+  TrimTokenValue(start, end);
+  return Substring(start, end);
+}
+
+void CViewSourceHTML::TrimTokenValue(nsAString::const_iterator& start,
+                                     nsAString::const_iterator& end) {
+  // Token values -- tag names, attribute names, and attribute values --
+  // generally contain adjacent whitespace and, in the case of attribute values,
+  // the surrounding double or single quotes.  Return a new string with this
+  // adjacent text stripped off, so only the value proper remains.
+        
+  // Skip past any whitespace or quotes on the left.
+  while (start != end) {
+    if (!IsTokenValueTrimmableCharacter(*start)) break;
+    ++start;
+  }
+
+  // Skip past any whitespace or quotes on the right.  Note that the interval 
+  // start..end is half-open.  That means the last character of the interval is
+  // at *(end - 1).
+  while (end != start) {      
+    --end;
+    if (!IsTokenValueTrimmableCharacter(*end)) {
+      ++end; // we've actually gone one too far at this point, so adjust.
+      break;
+    }
+  }
+}
+
+PRBool CViewSourceHTML::IsTokenValueTrimmableCharacter(PRUnichar ch) {
+  if (ch == ' ') return PR_TRUE;
+  if (ch == '\t') return PR_TRUE;
+  if (ch == '\r') return PR_TRUE;
+  if (ch == '\n') return PR_TRUE;
+  if (ch == '\'') return PR_TRUE;
+  if (ch == '"') return PR_TRUE;
+  return PR_FALSE;
+}
+
+nsresult CViewSourceHTML::GetBaseURI(nsIURI **result) {
+  nsresult rv = NS_OK;
+  if (!mBaseURI) {
+    rv = SetBaseURI(mFilename);
+  }
+  NS_IF_ADDREF(*result = mBaseURI);
+  return rv;
+}
+
+nsresult CViewSourceHTML::SetBaseURI(const nsAString& baseSpec) {
+  // Get the character set.
+  nsCString charset;
+  PRInt32 source;
+  mParser->GetDocumentCharset(charset, source);
+ 
+  // Create a new base URI and store it in mBaseURI.
+  nsCOMPtr<nsIURI> baseURI;
+  nsresult rv = NS_NewURI(getter_AddRefs(baseURI), baseSpec, charset.get());
+  NS_ENSURE_SUCCESS(rv, rv);
+  mBaseURI = baseURI;
+  return NS_OK;
+}
diff -r a4343d61f6ee parser/htmlparser/src/nsViewSourceHTML.h
--- a/parser/htmlparser/src/nsViewSourceHTML.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/parser/htmlparser/src/nsViewSourceHTML.h	Sat Nov 15 19:43:14 2008 -0500
@@ -33,18 +33,18 @@
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 /**
  * MODULE NOTES:
  * @update  gess 4/8/98
- * 
- *         
+ *
+ *
  */
 
 #ifndef __NS_VIEWSOURCE_HTML_
 #define __NS_VIEWSOURCE_HTML_
 
 #include "nsIDTD.h"
 #include "nsISupports.h"
 #include "nsHTMLTokens.h"
@@ -57,17 +57,17 @@ class nsITokenizer;
 class nsITokenizer;
 class nsCParserNode;
 
 class CIndirectTextToken : public CTextToken {
 public:
   CIndirectTextToken() : CTextToken() {
     mIndirectString=0;
   }
-  
+
   void SetIndirectString(const nsSubstring& aString) {
     mIndirectString=&aString;
   }
 
   virtual const nsSubstring& GetStringValue(void){
     return (const nsSubstring&)*mIndirectString;
   }
 
@@ -76,63 +76,83 @@ public:
 
 
 class CViewSourceHTML: public nsIDTD
 {
 public:
 
     NS_DECL_ISUPPORTS
     NS_DECL_NSIDTD
-    
+
     CViewSourceHTML();
     virtual ~CViewSourceHTML();
 
     /**
      * Set this to TRUE if you want the DTD to verify its
      * context stack.
-     * @update	gess 7/23/98
-     * @param 
+     * @update  gess 7/23/98
+     * @param
      * @return
      */
     virtual void SetVerification(PRBool aEnable);
 
 private:
     nsresult WriteTag(PRInt32 tagType,
                       const nsSubstring &aText,
                       PRInt32 attrCount,
                       PRBool aTagInError);
-    
-    nsresult WriteAttributes(PRInt32 attrCount, PRBool aOwnerInError);
+
+    nsresult WriteAttributes(const nsAString& tagName, 
+        nsTokenAllocator* allocator, PRInt32 attrCount, PRBool aOwnerInError);
     void StartNewPreBlock(void);
     // Utility method for adding attributes to the nodes we generate
     void AddAttrToNode(nsCParserStartNode& aNode,
                        nsTokenAllocator* aAllocator,
                        const nsAString& aAttrName,
                        const nsAString& aAttrValue);
+
+    PRBool IsUrlAttribute(const nsAString& tagName,
+                          const nsAString& attrName, const nsAString& attrValue);
+    void WriteHrefAttribute(nsTokenAllocator* allocator, const nsAString& href);
+    nsresult CreateViewSourceURL(const nsAString& linkUrl, nsString& viewSourceUrl);
+    void WriteTextInSpan(const nsAString& text, nsTokenAllocator* allocator,
+                         const nsAString& attrName, const nsAString& attrValue);
+    void WriteTextInAnchor(const nsAString& text, nsTokenAllocator* allocator,
+                           const nsAString& attrName, const nsAString &attrValue);
+    void WriteTextInElement(const nsAString& tagName, eHTMLTags tagType,
+                            const nsAString& text, nsTokenAllocator* allocator,
+                            const nsAString& attrName, const nsAString& attrValue);
+    const nsDependentSubstring TrimTokenValue(const nsAString& tokenValue);
+    void TrimTokenValue(nsAString::const_iterator& start, 
+                        nsAString::const_iterator& end);
+    PRBool IsTokenValueTrimmableCharacter(PRUnichar ch);
+    nsresult GetBaseURI(nsIURI **result);
+    nsresult SetBaseURI(const nsAString& baseSpec);
 
 protected:
 
     nsParser*           mParser;
     nsIHTMLContentSink* mSink;
     PRInt32             mLineNumber;
     nsITokenizer*       mTokenizer; // weak
 
     PRPackedBool        mSyntaxHighlight;
     PRPackedBool        mWrapLongLines;
     PRPackedBool        mHasOpenRoot;
     PRPackedBool        mHasOpenBody;
 
     nsDTDMode           mDTDMode;
     eParserCommands     mParserCommand;   //tells us to viewcontent/viewsource/viewerrors...
     eParserDocType      mDocType;
-    nsCString           mMimeType;  
+    nsCString           mMimeType;
 
     nsString            mFilename;
+    nsCOMPtr<nsIURI>    mBaseURI; // lazy -- always use GetBaseURI().
 
     PRUint32            mTokenCount;
 
     nsCParserStartNode  mStartNode;
     nsCParserStartNode  mTokenNode;
     CIndirectTextToken  mITextToken;
     nsCParserStartNode  mErrorNode;
 };
 
-#endif 
+#endif
diff -r a4343d61f6ee testing/performance/talos/page_load_test/gfx/images/png-2x2.png
Binary file testing/performance/talos/page_load_test/gfx/images/png-2x2.png has changed
diff -r a4343d61f6ee toolkit/components/autocomplete/src/nsAutoCompleteController.cpp
--- a/toolkit/components/autocomplete/src/nsAutoCompleteController.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/autocomplete/src/nsAutoCompleteController.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -54,36 +54,47 @@
 #include "nsUnicharUtils.h"
 #include "nsITreeColumns.h"
 #include "nsIGenericFactory.h"
 #include "nsIObserverService.h"
 #include "nsIDOMKeyEvent.h"
 
 static const char *kAutoCompleteSearchCID = "@mozilla.org/autocomplete/search;1?name=";
 
-NS_IMPL_ISUPPORTS4(nsAutoCompleteController, nsIAutoCompleteController,
-                                             nsIAutoCompleteObserver,
-                                             nsITimerCallback,
-                                             nsITreeView)
+NS_IMPL_CYCLE_COLLECTION_CLASS(nsAutoCompleteController)
+NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(nsAutoCompleteController)
+  tmp->SetInput(nsnull);
+NS_IMPL_CYCLE_COLLECTION_UNLINK_END
+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN(nsAutoCompleteController)
+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mInput)
+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMARRAY(mSearches)
+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMARRAY(mResults)
+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
+
+NS_IMPL_CYCLE_COLLECTING_ADDREF(nsAutoCompleteController)
+NS_IMPL_CYCLE_COLLECTING_RELEASE(nsAutoCompleteController)
+NS_INTERFACE_TABLE_HEAD(nsAutoCompleteController)
+  NS_INTERFACE_TABLE4(nsAutoCompleteController, nsIAutoCompleteController,
+                      nsIAutoCompleteObserver, nsITimerCallback, nsITreeView)
+  NS_INTERFACE_TABLE_TO_MAP_SEGUE_CYCLE_COLLECTION(nsAutoCompleteController)
+NS_INTERFACE_MAP_END
 
 nsAutoCompleteController::nsAutoCompleteController() :
   mEnterAfterSearch(0),
   mDefaultIndexCompleted(PR_FALSE),
   mBackspaced(PR_FALSE),
   mPopupClosedByCompositionStart(PR_FALSE),
   mIsIMEComposing(PR_FALSE),
   mIgnoreHandleText(PR_FALSE),
   mIsOpen(PR_FALSE),
   mSearchStatus(0),
   mRowCount(0),
   mSearchesOngoing(0),
   mFirstSearchResult(PR_FALSE)
 {
-  mSearches = do_CreateInstance("@mozilla.org/supports-array;1");
-  mResults = do_CreateInstance("@mozilla.org/supports-array;1");
 }
 
 nsAutoCompleteController::~nsAutoCompleteController()
 {
   SetInput(nsnull);
 }
 
 ////////////////////////////////////////////////////////////////////////
@@ -120,17 +131,17 @@ nsAutoCompleteController::SetInput(nsIAu
 
   // Clear out the current search context
   if (mInput) {
     // Stop all searches in case they are async.
     StopSearch();
     ClearResults();
     if (mIsOpen)
       ClosePopup();
-    mSearches->Clear();
+    mSearches.Clear();
   }
 
   mInput = aInput;
 
   // Nothing more to do if the input was just being set to null.
   if (!aInput)
     return NS_OK;
 
@@ -147,33 +158,33 @@ nsAutoCompleteController::SetInput(nsIAu
   mBackspaced = PR_FALSE;
   mSearchStatus = nsIAutoCompleteController::STATUS_NONE;
   mRowCount = 0;
   mSearchesOngoing = 0;
 
   // Initialize our list of search objects
   PRUint32 searchCount;
   aInput->GetSearchCount(&searchCount);
-  mResults->SizeTo(searchCount);
-  mSearches->SizeTo(searchCount);
+  mResults.SetCapacity(searchCount);
+  mSearches.SetCapacity(searchCount);
   mMatchCounts.SetLength(searchCount);
 
   const char *searchCID = kAutoCompleteSearchCID;
 
   for (PRUint32 i = 0; i < searchCount; ++i) {
     // Use the search name to create the contract id string for the search service
     nsCAutoString searchName;
     aInput->GetSearchAt(i, searchName);
     nsCAutoString cid(searchCID);
     cid.Append(searchName);
 
     // Use the created cid to get a pointer to the search service and store it for later
     nsCOMPtr<nsIAutoCompleteSearch> search = do_GetService(cid.get());
     if (search)
-      mSearches->AppendElement(search);
+      mSearches.AppendObject(search);
   }
 
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsAutoCompleteController::StartSearch(const nsAString &aSearchString)
 {
@@ -472,19 +483,17 @@ nsAutoCompleteController::HandleKeyNavig
         input->GetSelectionStart(&start);
         input->GetSelectionEnd(&end);
         if (start != end || end < (PRInt32)text.Length())
           *_retval = PR_FALSE;
       }
 #endif
       if (*_retval) {
         // Open the popup if there has been a previous search, or else kick off a new search
-        PRUint32 resultCount;
-        mResults->Count(&resultCount);
-        if (resultCount) {
+        if (mResults.Count() > 0) {
           if (mRowCount) {
             OpenPopup();
           }
         } else
           StartSearchTimer();
       }
     }
   } else if (   aKey == nsIDOMKeyEvent::DOM_VK_LEFT
@@ -542,18 +551,17 @@ nsAutoCompleteController::HandleDelete(P
   nsCOMPtr<nsIAutoCompletePopup> popup;
   input->GetPopup(getter_AddRefs(popup));
 
   PRInt32 index, searchIndex, rowIndex;
   popup->GetSelectedIndex(&index);
   RowIndexToSearch(index, &searchIndex, &rowIndex);
   NS_ENSURE_TRUE(searchIndex >= 0 && rowIndex >= 0, NS_ERROR_FAILURE);
 
-  nsCOMPtr<nsIAutoCompleteResult> result;
-  mResults->GetElementAt(searchIndex, getter_AddRefs(result));
+  nsIAutoCompleteResult *result = mResults[searchIndex];
   NS_ENSURE_TRUE(result, NS_ERROR_FAILURE);
 
   nsAutoString search;
   input->GetSearchParam(search);
 
   // Clear the row in our result and in the DB.
   result->RemoveValueAt(rowIndex, PR_TRUE);
   --mRowCount;
@@ -609,48 +617,45 @@ NS_IMETHODIMP
 NS_IMETHODIMP
 nsAutoCompleteController::GetCommentAt(PRInt32 aIndex, nsAString & _retval)
 {
   PRInt32 searchIndex;
   PRInt32 rowIndex;
   RowIndexToSearch(aIndex, &searchIndex, &rowIndex);
   NS_ENSURE_TRUE(searchIndex >= 0 && rowIndex >= 0, NS_ERROR_FAILURE);
 
-  nsCOMPtr<nsIAutoCompleteResult> result;
-  mResults->GetElementAt(searchIndex, getter_AddRefs(result));
+  nsIAutoCompleteResult *result = mResults[searchIndex];
   NS_ENSURE_TRUE(result, NS_ERROR_FAILURE);
 
   return result->GetCommentAt(rowIndex, _retval);
 }
 
 NS_IMETHODIMP
 nsAutoCompleteController::GetStyleAt(PRInt32 aIndex, nsAString & _retval)
 {
   PRInt32 searchIndex;
   PRInt32 rowIndex;
   RowIndexToSearch(aIndex, &searchIndex, &rowIndex);
   NS_ENSURE_TRUE(searchIndex >= 0 && rowIndex >= 0, NS_ERROR_FAILURE);
 
-  nsCOMPtr<nsIAutoCompleteResult> result;
-  mResults->GetElementAt(searchIndex, getter_AddRefs(result));
+  nsIAutoCompleteResult *result = mResults[searchIndex];
   NS_ENSURE_TRUE(result, NS_ERROR_FAILURE);
 
   return result->GetStyleAt(rowIndex, _retval);
 }
 
 NS_IMETHODIMP
 nsAutoCompleteController::GetImageAt(PRInt32 aIndex, nsAString & _retval)
 {
   PRInt32 searchIndex;
   PRInt32 rowIndex;
   RowIndexToSearch(aIndex, &searchIndex, &rowIndex);
   NS_ENSURE_TRUE(searchIndex >= 0 && rowIndex >= 0, NS_ERROR_FAILURE);
 
-  nsCOMPtr<nsIAutoCompleteResult> result;
-  mResults->GetElementAt(searchIndex, getter_AddRefs(result));
+  nsIAutoCompleteResult *result = mResults[searchIndex];
   NS_ENSURE_TRUE(result, NS_ERROR_FAILURE);
 
   return result->GetImageAt(rowIndex, _retval);
 }
 
 NS_IMETHODIMP
 nsAutoCompleteController::SetSearchString(const nsAString &aSearchString)
 {
@@ -668,22 +673,19 @@ nsAutoCompleteController::GetSearchStrin
 
 ////////////////////////////////////////////////////////////////////////
 //// nsIAutoCompleteObserver
 
 NS_IMETHODIMP
 nsAutoCompleteController::OnSearchResult(nsIAutoCompleteSearch *aSearch, nsIAutoCompleteResult* aResult)
 {
   // look up the index of the search which is returning
-  PRUint32 count;
-  mSearches->Count(&count);
+  PRUint32 count = mSearches.Count();
   for (PRUint32 i = 0; i < count; ++i) {
-    nsCOMPtr<nsIAutoCompleteSearch> search;
-    mSearches->GetElementAt(i, getter_AddRefs(search));
-    if (search == aSearch) {
+    if (mSearches[i] == aSearch) {
       ProcessResult(i, aResult);
     }
   }
 
   return NS_OK;
 }
 
 ////////////////////////////////////////////////////////////////////////
@@ -973,46 +975,43 @@ nsAutoCompleteController::StartSearch()
 {
   NS_ENSURE_STATE(mInput);
   nsCOMPtr<nsIAutoCompleteInput> input(mInput);
   mSearchStatus = nsIAutoCompleteController::STATUS_SEARCHING;
   mDefaultIndexCompleted = PR_FALSE;
 
   // Cache the current results so that we can pass these through to all the
   // searches without loosing them
-  nsresult rv;
-  nsCOMPtr<nsISupportsArray> resultCache;
-  rv = mResults->Clone(getter_AddRefs(resultCache));
-  NS_ENSURE_SUCCESS(rv, rv);
+  nsCOMArray<nsIAutoCompleteResult> resultCache;
+  if (!resultCache.AppendObjects(mResults)) {
+    return NS_ERROR_OUT_OF_MEMORY;
+  }
 
-  PRUint32 count;
-  mSearches->Count(&count);
+  PRUint32 count = mSearches.Count();
   mSearchesOngoing = count;
   mFirstSearchResult = PR_TRUE;
 
   // notify the input that the search is beginning
   input->OnSearchBegin();
 
   PRUint32 searchesFailed = 0;
   for (PRUint32 i = 0; i < count; ++i) {
-    nsCOMPtr<nsIAutoCompleteSearch> search;
-    mSearches->GetElementAt(i, getter_AddRefs(search));
-    nsCOMPtr<nsIAutoCompleteResult> result;
-    resultCache->GetElementAt(i, getter_AddRefs(result));
+    nsCOMPtr<nsIAutoCompleteSearch> search = mSearches[i];
+    nsIAutoCompleteResult *result = resultCache.SafeObjectAt(i);
 
     if (result) {
       PRUint16 searchResult;
       result->GetSearchResult(&searchResult);
       if (searchResult != nsIAutoCompleteResult::RESULT_SUCCESS &&
           searchResult != nsIAutoCompleteResult::RESULT_SUCCESS_ONGOING)
         result = nsnull;
     }
 
     nsAutoString searchParam;
-    rv = input->GetSearchParam(searchParam);
+    nsresult rv = input->GetSearchParam(searchParam);
     if (NS_FAILED(rv))
         return rv;
 
     rv = search->StartSearch(mSearchString, searchParam, result, static_cast<nsIAutoCompleteObserver *>(this));
     if (NS_FAILED(rv)) {
       ++searchesFailed;
       --mSearchesOngoing;
     }
@@ -1027,22 +1026,20 @@ NS_IMETHODIMP
 NS_IMETHODIMP
 nsAutoCompleteController::StopSearch()
 {
   // Stop the timer if there is one
   ClearSearchTimer();
 
   // Stop any ongoing asynchronous searches
   if (mSearchStatus == nsIAutoCompleteController::STATUS_SEARCHING) {
-    PRUint32 count;
-    mSearches->Count(&count);
+    PRUint32 count = mSearches.Count();
 
     for (PRUint32 i = 0; i < count; ++i) {
-      nsCOMPtr<nsIAutoCompleteSearch> search;
-      mSearches->GetElementAt(i, getter_AddRefs(search));
+      nsCOMPtr<nsIAutoCompleteSearch> search = mSearches[i];
       search->StopSearch();
     }
     mSearchesOngoing = 0;
     // since we were searching, but now we've stopped,
     // we need to call PostSearchCleanup()
     PostSearchCleanup();
   }
   return NS_OK;
@@ -1114,21 +1111,19 @@ nsAutoCompleteController::EnterMatch(PRB
     PRInt32 selectedIndex;
     popup->GetSelectedIndex(&selectedIndex);
     if (selectedIndex >= 0 && (!completeSelection || aIsPopupSelection))
       GetResultValueAt(selectedIndex, PR_TRUE, value);
 
     if (forceComplete && value.IsEmpty()) {
       // Since nothing was selected, and forceComplete is specified, that means
       // we have to find the first default match and enter it instead
-      PRUint32 count;
-      mResults->Count(&count);
+      PRUint32 count = mResults.Count();
       for (PRUint32 i = 0; i < count; ++i) {
-        nsCOMPtr<nsIAutoCompleteResult> result;
-        mResults->GetElementAt(i, getter_AddRefs(result));
+        nsIAutoCompleteResult *result = mResults[i];
 
         if (result) {
           PRInt32 defaultIndex;
           result->GetDefaultIndex(&defaultIndex);
           if (defaultIndex >= 0) {
             result->GetValueAt(defaultIndex, value);
             break;
           }
@@ -1209,25 +1204,25 @@ nsAutoCompleteController::ProcessResult(
     --mSearchesOngoing;
   }
 
   PRUint32 oldMatchCount = 0;
   PRUint32 matchCount = 0;
   if (aResult)
     aResult->GetMatchCount(&matchCount);
 
-  PRInt32 oldIndex = mResults->IndexOf(aResult);
+  PRInt32 oldIndex = mResults.IndexOf(aResult);
   if (oldIndex == -1) {
     // cache the result
-    mResults->AppendElement(aResult);
+    mResults.AppendObject(aResult);
     mMatchCounts.AppendElement(matchCount);
   }
   else {
     // replace the cached result
-    mResults->ReplaceElementAt(aResult, oldIndex);
+    mResults.ReplaceObjectAt(aResult, oldIndex);
     oldMatchCount = mMatchCounts[aSearchIndex];
     mMatchCounts[oldIndex] = matchCount;
   }
 
   PRUint32 oldRowCount = mRowCount;
   // If the search failed, increase the match count
   // to include the error description
   if (result == nsIAutoCompleteResult::RESULT_FAILURE) {
@@ -1308,17 +1303,17 @@ nsAutoCompleteController::PostSearchClea
   return NS_OK;
 }
 
 nsresult
 nsAutoCompleteController::ClearResults()
 {
   PRInt32 oldRowCount = mRowCount;
   mRowCount = 0;
-  mResults->Clear();
+  mResults.Clear();
   mMatchCounts.Clear();
   if (oldRowCount != 0) {
     if (mTree)
       mTree->RowCountChanged(0, -oldRowCount);
     else if (mInput) {
       nsCOMPtr<nsIAutoCompletePopup> popup;
       mInput->GetPopup(getter_AddRefs(popup));
       NS_ENSURE_TRUE(popup != nsnull, NS_ERROR_FAILURE);
@@ -1348,18 +1343,17 @@ nsAutoCompleteController::CompleteDefaul
       selectionEnd != (PRInt32)mSearchString.Length())
     return NS_OK;
 
   PRBool shouldComplete;
   mInput->GetCompleteDefaultIndex(&shouldComplete);
   if (!shouldComplete)
     return NS_OK;
 
-  nsCOMPtr<nsIAutoCompleteResult> result;
-  mResults->GetElementAt(aSearchIndex, getter_AddRefs(result));
+  nsIAutoCompleteResult *result = mResults[aSearchIndex];
   NS_ENSURE_TRUE(result != nsnull, NS_ERROR_FAILURE);
 
   // The search must explicitly provide a default index in order
   // for us to be able to complete
   PRInt32 defaultIndex;
   result->GetDefaultIndex(&defaultIndex);
   NS_ENSURE_TRUE(defaultIndex >= 0, NS_OK);
 
@@ -1432,18 +1426,17 @@ nsAutoCompleteController::GetResultValue
 {
   NS_ENSURE_TRUE(aIndex >= 0 && (PRUint32) aIndex < mRowCount, NS_ERROR_ILLEGAL_VALUE);
 
   PRInt32 searchIndex;
   PRInt32 rowIndex;
   RowIndexToSearch(aIndex, &searchIndex, &rowIndex);
   NS_ENSURE_TRUE(searchIndex >= 0 && rowIndex >= 0, NS_ERROR_FAILURE);
 
-  nsCOMPtr<nsIAutoCompleteResult> result;
-  mResults->GetElementAt(searchIndex, getter_AddRefs(result));
+  nsIAutoCompleteResult *result = mResults[searchIndex];
   NS_ENSURE_TRUE(result != nsnull, NS_ERROR_FAILURE);
 
   PRUint16 searchResult;
   result->GetSearchResult(&searchResult);
 
   if (searchResult == nsIAutoCompleteResult::RESULT_FAILURE) {
     if (aValueOnly)
       return NS_ERROR_FAILURE;
@@ -1462,25 +1455,23 @@ nsAutoCompleteController::GetResultValue
  * the search's results list.
  */
 nsresult
 nsAutoCompleteController::RowIndexToSearch(PRInt32 aRowIndex, PRInt32 *aSearchIndex, PRInt32 *aItemIndex)
 {
   *aSearchIndex = -1;
   *aItemIndex = -1;
 
-  PRUint32 count;
-  mSearches->Count(&count);
+  PRUint32 count = mSearches.Count();
   PRUint32 index = 0;
 
   // Move index through the results of each registered nsIAutoCompleteSearch
   // until we find the given row
   for (PRUint32 i = 0; i < count; ++i) {
-    nsCOMPtr<nsIAutoCompleteResult> result;
-    mResults->GetElementAt(i, getter_AddRefs(result));
+    nsIAutoCompleteResult *result = mResults[i];
     if (!result)
       continue;
 
     PRUint16 searchResult;
     result->GetSearchResult(&searchResult);
 
     // Find out how many results were provided by the
     // current nsIAutoCompleteSearch
diff -r a4343d61f6ee toolkit/components/autocomplete/src/nsAutoCompleteController.h
--- a/toolkit/components/autocomplete/src/nsAutoCompleteController.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/autocomplete/src/nsAutoCompleteController.h	Sat Nov 15 19:43:14 2008 -0500
@@ -43,27 +43,30 @@
 
 #include "nsIAutoCompleteInput.h"
 #include "nsIAutoCompletePopup.h"
 #include "nsIAutoCompleteResult.h"
 #include "nsIAutoCompleteSearch.h"
 #include "nsString.h"
 #include "nsITreeView.h"
 #include "nsITreeSelection.h"
-#include "nsISupportsArray.h"
 #include "nsITimer.h"
 #include "nsTArray.h"
+#include "nsCOMArray.h"
+#include "nsCycleCollectionParticipant.h"
 
 class nsAutoCompleteController : public nsIAutoCompleteController,
                                  public nsIAutoCompleteObserver,
                                  public nsITimerCallback,
                                  public nsITreeView
 {
 public:
-  NS_DECL_ISUPPORTS
+  NS_DECL_CYCLE_COLLECTING_ISUPPORTS
+  NS_DECL_CYCLE_COLLECTION_CLASS_AMBIGUOUS(nsAutoCompleteController,
+                                           nsIAutoCompleteController)
   NS_DECL_NSIAUTOCOMPLETECONTROLLER
   NS_DECL_NSIAUTOCOMPLETEOBSERVER
   NS_DECL_NSITREEVIEW
   NS_DECL_NSITIMERCALLBACK
    
   nsAutoCompleteController();
   virtual ~nsAutoCompleteController();
   
@@ -88,19 +91,19 @@ protected:
 
   nsresult ClearResults();
   
   nsresult RowIndexToSearch(PRInt32 aRowIndex, PRInt32 *aSearchIndex, PRInt32 *aItemIndex);
 
   // members //////////////////////////////////////////
   
   nsCOMPtr<nsIAutoCompleteInput> mInput;
-  
-  nsCOMPtr<nsISupportsArray> mSearches;
-  nsCOMPtr<nsISupportsArray> mResults;
+
+  nsCOMArray<nsIAutoCompleteSearch> mSearches;
+  nsCOMArray<nsIAutoCompleteResult> mResults;
   nsTArray<PRUint32> mMatchCounts;
   
   nsCOMPtr<nsITimer> mTimer;
   nsCOMPtr<nsITreeSelection> mSelection;
   nsCOMPtr<nsITreeBoxObject> mTree;
 
   nsString mSearchString;
   // whether EnterMatch was called while a search was ongoing. Values:
diff -r a4343d61f6ee toolkit/components/downloads/src/Makefile.in
--- a/toolkit/components/downloads/src/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/downloads/src/Makefile.in	Sat Nov 15 19:43:14 2008 -0500
@@ -80,16 +80,20 @@ ifeq ($(OS_ARCH),WINNT)
 ifeq ($(OS_ARCH),WINNT)
 CPPSRCS += nsDownloadScanner.cpp
 REQUIRES += xulapp
 DEFINES += -DDOWNLOAD_SCANNER
 endif
 endif
 endif
 
+ifndef MOZ_SUITE
+# XXX - Until Suite builds off XULRunner we can't guarantee our implementation
+# of nsIDownloadManagerUI overrides toolkit's.
 EXTRA_COMPONENTS = \
   nsDownloadManagerUI.js \
   $(NULL)
+endif
 
 include $(topsrcdir)/config/rules.mk
 
 EXTRA_DSO_LDOPTS += $(MOZ_COMPONENT_LIBS)
 
diff -r a4343d61f6ee toolkit/components/downloads/src/nsDownloadManager.cpp
--- a/toolkit/components/downloads/src/nsDownloadManager.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/downloads/src/nsDownloadManager.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -2597,17 +2597,17 @@ nsDownload::OnStateChange(nsIWebProgress
         mMaxBytes = mCurrBytes;
       } else {
         mCurrBytes = mMaxBytes;
       }
 
       mPercentComplete = 100;
       mLastUpdate = PR_Now();
 
-#if defined(XP_WIN) && !defined(__MINGW32__) && !defined(WINCE)
+#ifdef DOWNLOAD_SCANNER
       PRBool scan = PR_TRUE;
       nsCOMPtr<nsIPrefBranch> prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));
       if (prefs)
         (void)prefs->GetBoolPref(PREF_BDM_SCANWHENDONE, &scan);
 
       if (scan)
         (void)SetState(nsIDownloadManager::DOWNLOAD_SCANNING);
       else
diff -r a4343d61f6ee toolkit/components/downloads/test/downloads.empty.sqlite
Binary file toolkit/components/downloads/test/downloads.empty.sqlite has changed
diff -r a4343d61f6ee toolkit/components/places/public/nsINavHistoryService.idl
--- a/toolkit/components/places/public/nsINavHistoryService.idl	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/public/nsINavHistoryService.idl	Sat Nov 15 19:43:14 2008 -0500
@@ -1052,17 +1052,17 @@ interface nsINavHistoryQueryOptions : ns
   attribute unsigned short queryType;
 
   /**
    * Creates a new options item with the same parameters of this one.
    */
   nsINavHistoryQueryOptions clone();
 };
 
-[scriptable, uuid(8b258ff6-b591-4da5-8b7c-0665b27d09cc)]
+[scriptable, uuid(437f539b-d541-4a0f-a200-6f9a6d45cce2)]
 interface nsINavHistoryService : nsISupports
 {
   /**
    * This transition type means the user followed a link and got a new toplevel
    * window.
    */
   const unsigned long TRANSITION_LINK = 1;
 
@@ -1097,16 +1097,36 @@ interface nsINavHistoryService : nsISupp
    * Set when the transition was a temporary redirect.
    */
   const unsigned long TRANSITION_REDIRECT_TEMPORARY = 6;
 
   /**
    * Set when the transition is a download.
    */
   const unsigned long TRANSITION_DOWNLOAD = 7;
+
+  /**
+   * Set when database is coherent
+   */
+  const unsigned short DATABASE_STATUS_OK = 0;
+
+  /**
+   * Set when database did not exist and we created a new one
+   */
+  const unsigned short DATABASE_STATUS_CREATE = 1;
+
+  /**
+   * Set when database was corrupt and we replaced it
+   */
+  const unsigned short DATABASE_STATUS_CORRUPT = 2;
+
+  /**
+   * Returns the current database status
+   */
+  readonly attribute unsigned short databaseStatus;
 
   /**
    * True if there is any history. This can be used in UI to determine whether
    * the "clear history" button should be enabled or not. This is much better
    * than using BrowserHistory.count since that can be very slow if there is
    * a lot of history (it must enumerate each item). This is pretty fast.
    */
   readonly attribute boolean hasHistoryEntries;
diff -r a4343d61f6ee toolkit/components/places/public/nsPIPlacesDatabase.idl
--- a/toolkit/components/places/public/nsPIPlacesDatabase.idl	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/public/nsPIPlacesDatabase.idl	Sat Nov 15 19:43:14 2008 -0500
@@ -41,16 +41,29 @@
 
 interface mozIStorageConnection;
 
 /**
  * This is a private interface used by Places components to get access to the
  * database.  If outside consumers wish to use this, they should only read from
  * the database so they do not break any internal invariants.
  */
-[scriptable, uuid(daa7d3ba-8e24-4228-93b5-2c188bad7d36)]
+[scriptable, uuid(8e6d4f8a-4b8e-4026-9fca-517c4494ddb7)]
 interface nsPIPlacesDatabase : nsISupports
 {
   /**
    * The database connection used by Places.
    */
   readonly attribute mozIStorageConnection DBConnection;
+
+  /**
+   * Finalizes all Places internal statements, allowing to safely close the
+   * database connection.
+   */
+  void finalizeInternalStatements();
+
+  /**
+   * Commits all pending history changes, call this before finalizing
+   * statements and closing the database connection to ensure safety for all
+   * history data.
+   */
+  void commitPendingChanges();
 };
diff -r a4343d61f6ee toolkit/components/places/src/Makefile.in
--- a/toolkit/components/places/src/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/src/Makefile.in	Sat Nov 15 19:43:14 2008 -0500
@@ -105,14 +105,13 @@ LOCAL_INCLUDES += -I$(srcdir)/../../buil
 
 EXTRA_PP_COMPONENTS = nsLivemarkService.js \
                       nsTaggingService.js \
                       nsPlacesDBFlush.js \
                       $(NULL)
 
 EXTRA_JS_MODULES = \
   utils.js \
-  PlacesBackground.jsm \
   $(NULL)
 
 EXTRA_PP_JS_MODULES = utils.js
 
 include $(topsrcdir)/config/rules.mk
diff -r a4343d61f6ee toolkit/components/places/src/PlacesBackground.jsm
--- a/toolkit/components/places/src/PlacesBackground.jsm	Thu Nov 06 18:33:22 2008 +0100
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,112 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-
- * vim: sw=2 ts=2 sts=2 expandtab filetype=javascript
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Mozilla Corporation.
- * Portions created by the Initial Developer are Copyright (C) 2008
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *   Shawn Wilsher <me@shawnwilsher.com> (Original Author)
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-Components.utils.import("resource://gre/modules/XPCOMUtils.jsm");
-
-var EXPORTED_SYMBOLS = [ "PlacesBackground" ];
-
-////////////////////////////////////////////////////////////////////////////////
-//// Constants
-
-const Cc = Components.classes;
-const Ci = Components.interfaces;
-const Cr = Components.results;
-
-const kQuitApplication = "quit-application";
-const kPlacesBackgroundShutdown = "places-background-shutdown";
-
-////////////////////////////////////////////////////////////////////////////////
-//// nsPlacesBackgound class
-
-function nsPlacesBackground()
-{
-  let tm = Cc["@mozilla.org/thread-manager;1"].
-           getService(Ci.nsIThreadManager);
-  this._thread = tm.newThread(0);
-
-  let os = Cc["@mozilla.org/observer-service;1"].
-           getService(Ci.nsIObserverService);
-  os.addObserver(this, kQuitApplication, false);
-}
-
-nsPlacesBackground.prototype = {
-  //////////////////////////////////////////////////////////////////////////////
-  //// nsIEventTarget
-
-  dispatch: function PlacesBackground_dispatch(aEvent, aFlags)
-  {
-    this._thread.dispatch(aEvent, aFlags);
-  },
-
-  isOnCurrentThread: function PlacesBackground_isOnCurrentThread()
-  {
-    return this._thread.isOnCurrentThread();
-  },
-
-  //////////////////////////////////////////////////////////////////////////////
-  //// nsIObserver
-
-  observe: function PlacesBackground_observe(aSubject, aTopic, aData)
-  {
-    if (aTopic == kQuitApplication) {
-      // Notify consumers that we are shutting down.
-      let os = Cc["@mozilla.org/observer-service;1"].
-               getService(Ci.nsIObserverService);
-      os.notifyObservers(null, kPlacesBackgroundShutdown, null);
-
-      // Now shut the thread down.
-      this._thread.shutdown();
-      this._thread = null;
-    }
-  },
-
-  //////////////////////////////////////////////////////////////////////////////
-  //// nsISupports
-
-  QueryInterface: XPCOMUtils.generateQI([
-    Ci.nsIEventTarget,
-    Ci.nsIObserver,
-  ])
-};
-
-
-__defineGetter__("PlacesBackground", function() {
-  delete this.PlacesBackground;
-  return this.PlacesBackground = new nsPlacesBackground;
-});
diff -r a4343d61f6ee toolkit/components/places/src/nsAnnotationService.cpp
--- a/toolkit/components/places/src/nsAnnotationService.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/src/nsAnnotationService.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -2002,8 +2002,36 @@ nsAnnotationService::CallSetForPageObser
 // nsAnnotationService::CallSetForItemObservers
 
 void
 nsAnnotationService::CallSetForItemObservers(PRInt64 aItemId, const nsACString& aName)
 {
   for (PRInt32 i = 0; i < mObservers.Count(); i ++)
     mObservers[i]->OnItemAnnotationSet(aItemId, aName);
 }
+
+nsresult
+nsAnnotationService::FinalizeStatements() {
+  mozIStorageStatement* stmts[] = {
+    mDBSetAnnotation,
+    mDBSetItemAnnotation,
+    mDBGetAnnotation,
+    mDBGetItemAnnotation,
+    mDBGetAnnotationNames,
+    mDBGetItemAnnotationNames,
+    mDBGetAnnotationFromURI,
+    mDBGetAnnotationFromItemId,
+    mDBGetAnnotationNameID,
+    mDBAddAnnotationName,
+    mDBAddAnnotation,
+    mDBAddItemAnnotation,
+    mDBRemoveAnnotation,
+    mDBRemoveItemAnnotation,
+    mDBGetItemsWithAnnotation
+  };
+
+  for (PRUint32 i = 0; i < NS_ARRAY_LENGTH(stmts); i++) {
+    nsresult rv = nsNavHistory::FinalizeStatement(stmts[i]);
+    NS_ENSURE_SUCCESS(rv, rv);
+  }
+
+  return NS_OK;
+}
diff -r a4343d61f6ee toolkit/components/places/src/nsAnnotationService.h
--- a/toolkit/components/places/src/nsAnnotationService.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/src/nsAnnotationService.h	Sat Nov 15 19:43:14 2008 -0500
@@ -72,16 +72,21 @@ public:
       // our constructor should have set the static variable. If it didn't,
       // something is wrong.
       NS_ASSERTION(gAnnotationService, "Annotation service creation failed");
     }
     // the service manager will keep the pointer to our service around, so
     // this should always be valid even if nobody currently has a reference.
     return gAnnotationService;
   }
+
+  /**
+   * Finalize all internal statements.
+   */
+  nsresult FinalizeStatements();
 
   NS_DECL_ISUPPORTS
   NS_DECL_NSIANNOTATIONSERVICE
 
 private:
   ~nsAnnotationService();
 
 protected:
diff -r a4343d61f6ee toolkit/components/places/src/nsFaviconService.cpp
--- a/toolkit/components/places/src/nsFaviconService.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/src/nsFaviconService.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -1006,16 +1006,34 @@ nsFaviconService::OptimizeFaviconImage(c
 
   // Read the stream into a new buffer.
   rv = NS_ConsumeStream(iconStream, PR_UINT32_MAX, aNewData);
   NS_ENSURE_SUCCESS(rv, rv);
 
   return NS_OK;
 }
 
+nsresult
+nsFaviconService::FinalizeStatements() {
+  mozIStorageStatement* stmts[] = {
+    mDBGetURL,
+    mDBGetData,
+    mDBGetIconInfo,
+    mDBInsertIcon,
+    mDBUpdateIcon,
+    mDBSetPageFavicon
+  };
+
+  for (PRUint32 i = 0; i < NS_ARRAY_LENGTH(stmts); i++) {
+    nsresult rv = nsNavHistory::FinalizeStatement(stmts[i]);
+    NS_ENSURE_SUCCESS(rv, rv);
+  }
+
+  return NS_OK;
+}
 
 NS_IMPL_ISUPPORTS4(FaviconLoadListener,
                    nsIRequestObserver,
                    nsIStreamListener,
                    nsIInterfaceRequestor,
                    nsIChannelEventSink)
 
 // FaviconLoadListener::FaviconLoadListener
diff -r a4343d61f6ee toolkit/components/places/src/nsFaviconService.h
--- a/toolkit/components/places/src/nsFaviconService.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/src/nsFaviconService.h	Sat Nov 15 19:43:14 2008 -0500
@@ -85,19 +85,24 @@ public:
 
   // addition to API for strings to prevent excessive parsing of URIs
   nsresult GetFaviconLinkForIconString(const nsCString& aIcon, nsIURI** aOutput);
   void GetFaviconSpecForIconString(const nsCString& aIcon, nsACString& aOutput);
 
   static nsresult OptimizeFaviconImage(const PRUint8* aData, PRUint32 aDataLen,
                                        const nsACString& aMimeType,
                                        nsACString& aNewData, nsACString& aNewMimeType);
+
+  /**
+   * Finalize all internal statements.
+   */
+  nsresult FinalizeStatements();
+
   NS_DECL_ISUPPORTS
   NS_DECL_NSIFAVICONSERVICE
-
 
 private:
   ~nsFaviconService();
 
   nsCOMPtr<mozIStorageConnection> mDBConn; // from history service
 
   nsCOMPtr<mozIStorageStatement> mDBGetURL; // returns URL, data len given page
   nsCOMPtr<mozIStorageStatement> mDBGetData; // returns actual data given URL
diff -r a4343d61f6ee toolkit/components/places/src/nsNavBookmarks.cpp
--- a/toolkit/components/places/src/nsNavBookmarks.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/src/nsNavBookmarks.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -427,16 +427,45 @@ nsNavBookmarks::InitStatements()
       "WHERE k.keyword = ?1 "
         "AND h.id NOT IN (SELECT id FROM moz_places_temp)"),
     getter_AddRefs(mDBGetURIForKeyword));
   NS_ENSURE_SUCCESS(rv, rv);
 
   return NS_OK;
 }
 
+nsresult
+nsNavBookmarks::FinalizeStatements() {
+  mozIStorageStatement* stmts[] = {
+    mDBGetChildren,
+    mDBFindURIBookmarks,
+    mDBFolderCount,
+    mDBGetItemIndex,
+    mDBGetChildAt,
+    mDBGetItemProperties,
+    mDBGetItemIdForGUID,
+    mDBGetRedirectDestinations,
+    mDBInsertBookmark,
+    mDBIsBookmarkedInDatabase,
+    mDBGetLastBookmarkID,
+    mDBSetItemDateAdded,
+    mDBSetItemLastModified,
+    mDBSetItemIndex,
+    mDBGetKeywordForURI,
+    mDBGetKeywordForBookmark,
+    mDBGetURIForKeyword
+  };
+
+  for (PRUint32 i = 0; i < NS_ARRAY_LENGTH(stmts); i++) {
+    nsresult rv = nsNavHistory::FinalizeStatement(stmts[i]);
+    NS_ENSURE_SUCCESS(rv, rv);
+  }
+
+  return NS_OK;
+}
 
 // nsNavBookmarks::InitRoots
 //
 //    This locates and creates if necessary the root items in the bookmarks
 //    folder hierarchy. These items are stored in a special roots table that
 //    maps short predefined names to folder IDs.
 //
 //    Normally, these folders will exist already and we will save their IDs
@@ -514,22 +543,23 @@ nsNavBookmarks::InitRoots()
   nsCOMPtr<nsIPrefService> prefService =
     do_GetService(NS_PREFSERVICE_CONTRACTID, &rv);
   NS_ENSURE_SUCCESS(rv, rv);
 
   nsCOMPtr<nsIPrefBranch> prefBranch;
   rv = prefService->GetBranch("", getter_AddRefs(prefBranch));
   NS_ENSURE_SUCCESS(rv, rv);
 
-  PRBool importDefaults = PR_TRUE;
-  rv = prefBranch->GetBoolPref("browser.places.importDefaults", &importDefaults);
-  if (NS_FAILED(rv) || importDefaults) {
+  PRUint16 databaseStatus = nsINavHistoryService::DATABASE_STATUS_OK;
+  rv = History()->GetDatabaseStatus(&databaseStatus);
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  if (NS_FAILED(rv) ||
+      databaseStatus != nsINavHistoryService::DATABASE_STATUS_OK) {
     rv = InitDefaults();
-    NS_ENSURE_SUCCESS(rv, rv);
-    rv = prefBranch->SetBoolPref("browser.places.importDefaults", PR_FALSE);
     NS_ENSURE_SUCCESS(rv, rv);
   }
 
   return NS_OK;
 }
 
 // nsNavBookmarks::InitDefaults
 //
diff -r a4343d61f6ee toolkit/components/places/src/nsNavBookmarks.h
--- a/toolkit/components/places/src/nsNavBookmarks.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/src/nsNavBookmarks.h	Sat Nov 15 19:43:14 2008 -0500
@@ -98,16 +98,21 @@ public:
 
   // Called by History service when quitting.
   nsresult OnQuit();
 
   nsresult BeginUpdateBatch();
   nsresult EndUpdateBatch();
 
   PRBool ItemExists(PRInt64 aItemId);
+
+  /**
+   * Finalize all internal statements.
+   */
+  nsresult FinalizeStatements();
 
 private:
   static nsNavBookmarks *sInstance;
 
   ~nsNavBookmarks();
 
   nsresult InitRoots();
   nsresult InitDefaults();
diff -r a4343d61f6ee toolkit/components/places/src/nsNavHistory.cpp
--- a/toolkit/components/places/src/nsNavHistory.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/src/nsNavHistory.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -115,16 +115,17 @@
 
 // preference ID strings
 #define PREF_BRANCH_BASE                        "browser."
 #define PREF_BROWSER_HISTORY_EXPIRE_DAYS_MIN    "history_expire_days_min"
 #define PREF_BROWSER_HISTORY_EXPIRE_DAYS_MAX    "history_expire_days"
 #define PREF_BROWSER_HISTORY_EXPIRE_SITES       "history_expire_sites"
 #define PREF_AUTOCOMPLETE_ONLY_TYPED            "urlbar.matchOnlyTyped"
 #define PREF_AUTOCOMPLETE_MATCH_BEHAVIOR        "urlbar.matchBehavior"
+#define PREF_AUTOCOMPLETE_SEARCH_SOURCES        "urlbar.search.sources"
 #define PREF_AUTOCOMPLETE_FILTER_JAVASCRIPT     "urlbar.filter.javascript"
 #define PREF_AUTOCOMPLETE_ENABLED               "urlbar.autocomplete.enabled"
 #define PREF_AUTOCOMPLETE_MAX_RICH_RESULTS      "urlbar.maxRichResults"
 #define PREF_AUTOCOMPLETE_RESTRICT_HISTORY      "urlbar.restrict.history"
 #define PREF_AUTOCOMPLETE_RESTRICT_BOOKMARK     "urlbar.restrict.bookmark"
 #define PREF_AUTOCOMPLETE_RESTRICT_TAG          "urlbar.restrict.tag"
 #define PREF_AUTOCOMPLETE_MATCH_TITLE           "urlbar.match.title"
 #define PREF_AUTOCOMPLETE_MATCH_URL             "urlbar.match.url"
@@ -149,20 +150,16 @@
 #define PREF_FRECENCY_TYPED_VISIT_BONUS         "places.frecency.typedVisitBonus"
 #define PREF_FRECENCY_BOOKMARK_VISIT_BONUS      "places.frecency.bookmarkVisitBonus"
 #define PREF_FRECENCY_DOWNLOAD_VISIT_BONUS      "places.frecency.downloadVisitBonus"
 #define PREF_FRECENCY_PERM_REDIRECT_VISIT_BONUS "places.frecency.permRedirectVisitBonus"
 #define PREF_FRECENCY_TEMP_REDIRECT_VISIT_BONUS "places.frecency.tempRedirectVisitBonus"
 #define PREF_FRECENCY_DEFAULT_VISIT_BONUS       "places.frecency.defaultVisitBonus"
 #define PREF_FRECENCY_UNVISITED_BOOKMARK_BONUS  "places.frecency.unvisitedBookmarkBonus"
 #define PREF_FRECENCY_UNVISITED_TYPED_BONUS     "places.frecency.unvisitedTypedBonus"
-#define PREF_BROWSER_IMPORT_BOOKMARKS           "browser.places.importBookmarksHTML"
-#define PREF_BROWSER_IMPORT_DEFAULTS            "browser.places.importDefaults"
-#define PREF_BROWSER_SMARTBOOKMARKSVERSION      "browser.places.smartBookmarksVersion"
-#define PREF_BROWSER_LEFTPANEFOLDERID           "browser.places.leftPaneFolderId"
 
 // Default (integer) value of PREF_DB_CACHE_PERCENTAGE from 0-100
 // This is 6% of machine memory, giving 15MB for a user with 256MB of memory.
 // The most that will be used is the size of the DB file. Normal history sizes
 // look like 10MB would be a high average for a typical user, so the maximum
 // should not normally be required.
 #define DEFAULT_DB_CACHE_PERCENTAGE 6
 
@@ -280,16 +277,33 @@ public:
   ~UpdateBatchScoper()
   {
     mNavHistory.EndUpdateBatch();
   }
 protected:
   nsNavHistory& mNavHistory;
 };
 
+class PlacesInitCompleteEvent : public nsRunnable {
+  public:
+  NS_IMETHOD Run() {
+    nsresult rv;
+    nsCOMPtr<nsIObserverService> observerService =
+      do_GetService("@mozilla.org/observer-service;1", &rv);
+    NS_ENSURE_SUCCESS(rv, rv);
+
+    rv = observerService->NotifyObservers(nsnull,
+                                          PLACES_INIT_COMPLETE_EVENT_TOPIC,
+                                          nsnull);
+    NS_ENSURE_SUCCESS(rv, rv);
+
+    return NS_OK;
+  }
+};
+
 // if adding a new one, be sure to update nsNavBookmarks statements and
 // its kGetChildrenIndex_* constants
 const PRInt32 nsNavHistory::kGetInfoIndex_PageID = 0;
 const PRInt32 nsNavHistory::kGetInfoIndex_URL = 1;
 const PRInt32 nsNavHistory::kGetInfoIndex_Title = 2;
 const PRInt32 nsNavHistory::kGetInfoIndex_RevHost = 3;
 const PRInt32 nsNavHistory::kGetInfoIndex_VisitCount = 4;
 const PRInt32 nsNavHistory::kGetInfoIndex_VisitDate = 5;
@@ -345,16 +359,17 @@ nsNavHistory::GetSingleton()
 
 nsNavHistory::nsNavHistory() : mBatchLevel(0),
                                mBatchHasTransaction(PR_FALSE),
                                mNowValid(PR_FALSE),
                                mExpireNowTimer(nsnull),
                                mExpire(this),
                                mAutoCompleteOnlyTyped(PR_FALSE),
                                mAutoCompleteMatchBehavior(MATCH_BOUNDARY_ANYWHERE),
+                               mAutoCompleteSearchSources(SEARCH_BOTH),
                                mAutoCompleteMaxResults(25),
                                mAutoCompleteRestrictHistory(NS_LITERAL_STRING("^")),
                                mAutoCompleteRestrictBookmark(NS_LITERAL_STRING("*")),
                                mAutoCompleteRestrictTag(NS_LITERAL_STRING("+")),
                                mAutoCompleteMatchTitle(NS_LITERAL_STRING("#")),
                                mAutoCompleteMatchUrl(NS_LITERAL_STRING("@")),
                                mAutoCompleteSearchChunkSize(100),
                                mAutoCompleteSearchTimeout(100),
@@ -365,17 +380,18 @@ nsNavHistory::nsNavHistory() : mBatchLev
                                mMatchUrl(PR_FALSE),
                                mPreviousChunkOffset(-1),
                                mAutoCompleteFinishedSearch(PR_FALSE),
                                mExpireDaysMin(0),
                                mExpireDaysMax(0),
                                mExpireSites(0),
                                mNumVisitsForFrecency(10),
                                mTagsFolder(-1),
-                               mInPrivateBrowsing(PRIVATEBROWSING_NOTINITED)
+                               mInPrivateBrowsing(PRIVATEBROWSING_NOTINITED),
+                               mDatabaseStatus(DATABASE_STATUS_OK)
 {
 #ifdef LAZY_ADD
   mLazyTimerSet = PR_TRUE;
   mLazyTimerDeferments = 0;
 #endif
   NS_ASSERTION(! gHistoryService, "YOU ARE CREATING 2 COPIES OF THE HISTORY SERVICE. Everything will break.");
   gHistoryService = this;
 }
@@ -418,16 +434,23 @@ nsNavHistory::Init()
   rv = InitDB(&migrationType);
   if (NS_FAILED(rv)) {
     // if unable to initialize the db, force-re-initialize it:
     // InitDBFile will backup the old db and create a new one.
     rv = InitDBFile(PR_TRUE);
     NS_ENSURE_SUCCESS(rv, rv);
     rv = InitDB(&migrationType);
   }
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  // Notify we have finished database initialization
+  // Enqueue the notification, so if we init another service that requires
+  // nsNavHistoryService we don't recursive try to get it.
+  nsCOMPtr<PlacesInitCompleteEvent> completeEvent = new PlacesInitCompleteEvent();
+  rv = NS_DispatchToMainThread(completeEvent);
   NS_ENSURE_SUCCESS(rv, rv);
 
 #ifdef MOZ_XUL
   rv = InitAutoComplete();
   NS_ENSURE_SUCCESS(rv, rv);
 #endif
 
   // extract the last session ID so we know where to pick up. There is no index
@@ -472,16 +495,17 @@ nsNavHistory::Init()
   nsCOMPtr<nsIObserverService> observerService =
     do_GetService("@mozilla.org/observer-service;1", &rv);
   NS_ENSURE_SUCCESS(rv, rv);
 
   nsCOMPtr<nsIPrefBranch2> pbi = do_QueryInterface(mPrefBranch);
   if (pbi) {
     pbi->AddObserver(PREF_AUTOCOMPLETE_ONLY_TYPED, this, PR_FALSE);
     pbi->AddObserver(PREF_AUTOCOMPLETE_MATCH_BEHAVIOR, this, PR_FALSE);
+    pbi->AddObserver(PREF_AUTOCOMPLETE_SEARCH_SOURCES, this, PR_FALSE);
     pbi->AddObserver(PREF_AUTOCOMPLETE_FILTER_JAVASCRIPT, this, PR_FALSE);
     pbi->AddObserver(PREF_AUTOCOMPLETE_MAX_RICH_RESULTS, this, PR_FALSE);
     pbi->AddObserver(PREF_AUTOCOMPLETE_RESTRICT_HISTORY, this, PR_FALSE);
     pbi->AddObserver(PREF_AUTOCOMPLETE_RESTRICT_BOOKMARK, this, PR_FALSE);
     pbi->AddObserver(PREF_AUTOCOMPLETE_RESTRICT_TAG, this, PR_FALSE);
     pbi->AddObserver(PREF_AUTOCOMPLETE_MATCH_TITLE, this, PR_FALSE);
     pbi->AddObserver(PREF_AUTOCOMPLETE_MATCH_URL, this, PR_FALSE);
     pbi->AddObserver(PREF_AUTOCOMPLETE_SEARCH_CHUNK_SIZE, this, PR_FALSE);
@@ -541,48 +565,55 @@ nsNavHistory::InitDBFile(PRBool aForceIn
   nsCOMPtr<nsIFile> profDir;
   nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,
                                        getter_AddRefs(profDir));
   NS_ENSURE_SUCCESS(rv, rv);
   rv = profDir->Clone(getter_AddRefs(mDBFile));
   NS_ENSURE_SUCCESS(rv, rv);
   rv = mDBFile->Append(DB_FILENAME);
   NS_ENSURE_SUCCESS(rv, rv);
-  
+
   // if forcing, backup and remove the old file
-  PRBool dbExists;
   if (aForceInit) {
     // backup the database
     nsCOMPtr<nsIFile> backup;
     rv = mDBService->BackupDatabaseFile(mDBFile, DB_CORRUPT_FILENAME, profDir,
                                         getter_AddRefs(backup));
     NS_ENSURE_SUCCESS(rv, rv);
 
     // close database connection if open
     rv = mDBConn->Close();
     NS_ENSURE_SUCCESS(rv, rv);
 
     // and remove the file
     rv = mDBFile->Remove(PR_FALSE);
     NS_ENSURE_SUCCESS(rv, rv);
-    dbExists = PR_FALSE;
+
+    // If aForceInit is true we were unable to initialize or upgrade the current
+    // database, so it was corrupt.
+    mDatabaseStatus = DATABASE_STATUS_CORRUPT;
   }
   else {
     // file exists?
+    PRBool dbExists = PR_TRUE;
     rv = mDBFile->Exists(&dbExists);
     NS_ENSURE_SUCCESS(rv, rv);
-  }
-  
+    // If the database didn't previously exist, we create it.
+    if (!dbExists)
+      mDatabaseStatus = DATABASE_STATUS_CREATE;
+  }
+
   // open the database
   mDBService = do_GetService(MOZ_STORAGE_SERVICE_CONTRACTID, &rv);
   NS_ENSURE_SUCCESS(rv, rv);
   rv = mDBService->OpenUnsharedDatabase(mDBFile, getter_AddRefs(mDBConn));
   if (rv == NS_ERROR_FILE_CORRUPTED) {
-    dbExists = PR_FALSE;
-  
+    // The database is corrupt, we create a new one.
+    mDatabaseStatus = DATABASE_STATUS_CORRUPT;
+
     // backup file
     nsCOMPtr<nsIFile> backup;
     rv = mDBService->BackupDatabaseFile(mDBFile, DB_CORRUPT_FILENAME, profDir,
                                         getter_AddRefs(backup));
     NS_ENSURE_SUCCESS(rv, rv);
  
     // remove existing file 
     rv = mDBFile->Remove(PR_FALSE);
@@ -591,43 +622,22 @@ nsNavHistory::InitDBFile(PRBool aForceIn
     // and try again
     rv = profDir->Clone(getter_AddRefs(mDBFile));
     NS_ENSURE_SUCCESS(rv, rv);
     rv = mDBFile->Append(DB_FILENAME);
     NS_ENSURE_SUCCESS(rv, rv);
     rv = mDBService->OpenUnsharedDatabase(mDBFile, getter_AddRefs(mDBConn));
   }
   NS_ENSURE_SUCCESS(rv, rv);
-  
-  // if the db didn't previously exist, or was corrupted, re-import bookmarks.
-  if (!dbExists) {
-    nsCOMPtr<nsIPrefBranch> prefs(do_GetService("@mozilla.org/preferences-service;1"));
-    if (prefs) {
-      rv = prefs->SetBoolPref(PREF_BROWSER_IMPORT_BOOKMARKS, PR_TRUE);
-      NS_ENSURE_SUCCESS(rv, rv);
-
-      rv = prefs->SetBoolPref(PREF_BROWSER_IMPORT_DEFAULTS, PR_TRUE);
-      NS_ENSURE_SUCCESS(rv, rv);  
-
-      // if the places.sqlite gets deleted/corrupted the queries should be created again
-      rv = prefs->SetIntPref(PREF_BROWSER_SMARTBOOKMARKSVERSION, 0);
-      NS_ENSURE_SUCCESS(rv, rv);  
-      
-      // we must create a new Organizer left pane folder root, the old will not be valid anymore
-      rv = prefs->SetIntPref(PREF_BROWSER_LEFTPANEFOLDERID, -1);
-      NS_ENSURE_SUCCESS(rv, rv); 
-    }
-  }
 
   return NS_OK;
 }
 
 // nsNavHistory::InitDB
 //
-
 
 #define PLACES_SCHEMA_VERSION 8
 
 nsresult
 nsNavHistory::InitDB(PRInt16 *aMadeChanges)
 {
   nsresult rv;
   PRBool tableExists;
@@ -889,16 +899,23 @@ nsNavHistory::InitializeIdleTimer()
   PRInt32 idleTimerTimeout = EXPIRE_IDLE_TIME_IN_MSECS;
   if (mFrecencyUpdateIdleTime)
     idleTimerTimeout = PR_MIN(idleTimerTimeout, mFrecencyUpdateIdleTime);
 
   rv = mIdleTimer->InitWithFuncCallback(IdleTimerCallback, this,
                                         idleTimerTimeout,
                                         nsITimer::TYPE_REPEATING_SLACK);
   NS_ENSURE_SUCCESS(rv, rv);
+  return NS_OK;
+}
+
+NS_IMETHODIMP
+nsNavHistory::GetDatabaseStatus(PRUint16 *aDatabaseStatus)
+{
+  *aDatabaseStatus = mDatabaseStatus;
   return NS_OK;
 }
 
 // nsNavHistory::UpdateSchemaVersion
 //
 // Called by the individual services' InitTables()
 nsresult
 nsNavHistory::UpdateSchemaVersion()
@@ -1324,22 +1341,22 @@ nsNavHistory::ForceMigrateBookmarksDB(mo
   rv = aDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "DROP TABLE IF EXISTS moz_keywords"));
   NS_ENSURE_SUCCESS(rv, rv);
 
   // initialize bookmarks tables
   rv = nsNavBookmarks::InitTables(aDBConn);
   NS_ENSURE_SUCCESS(rv, rv);
 
-  // set pref indicating bookmarks.html should be imported.
-  nsCOMPtr<nsIPrefBranch> prefs(do_GetService("@mozilla.org/preferences-service;1"));
-  if (prefs) {
-    prefs->SetBoolPref(PREF_BROWSER_IMPORT_BOOKMARKS, PR_TRUE);
-  }
-  return rv;
+  // We have done a new database init, so we mark this as if the database has
+  // been created now, so the frontend can distinguish this status and import
+  // if needed.
+  mDatabaseStatus = DATABASE_STATUS_CREATE;
+
+  return NS_OK;
 }
 
 // nsNavHistory::MigrateV3Up
 nsresult
 nsNavHistory::MigrateV3Up(mozIStorageConnection* aDBConn) 
 {
   // if type col is already there, then a partial update occurred.
   // return, making no changes, and allowing db version to be updated.
@@ -2001,32 +2018,51 @@ nsNavHistory::LoadPrefs(PRBool aInitiali
                                         &mExpireSites)))
     mExpireSites = EXPIRATION_CAP_SITES;
   
 #ifdef MOZ_XUL
   PRBool oldCompleteOnlyTyped = mAutoCompleteOnlyTyped;
   mPrefBranch->GetBoolPref(PREF_AUTOCOMPLETE_ONLY_TYPED,
                            &mAutoCompleteOnlyTyped);
 
-  PRInt32 matchBehavior;
+  PRInt32 matchBehavior = 1;
   mPrefBranch->GetIntPref(PREF_AUTOCOMPLETE_MATCH_BEHAVIOR,
                           &matchBehavior);
   switch (matchBehavior) {
     case 0:
       mAutoCompleteMatchBehavior = MATCH_ANYWHERE;
       break;
     case 2:
       mAutoCompleteMatchBehavior = MATCH_BOUNDARY;
       break;
     case 3:
       mAutoCompleteMatchBehavior = MATCH_BEGINNING;
       break;
     case 1:
     default:
       mAutoCompleteMatchBehavior = MATCH_BOUNDARY_ANYWHERE;
+      break;
+  }
+
+  PRInt32 searchSources = 3;
+  mPrefBranch->GetIntPref(PREF_AUTOCOMPLETE_SEARCH_SOURCES,
+                          &searchSources);
+  switch (searchSources) {
+    case 0:
+      mAutoCompleteSearchSources = SEARCH_NONE;
+      break;
+    case 1:
+      mAutoCompleteSearchSources = SEARCH_HISTORY;
+      break;
+    case 2:
+      mAutoCompleteSearchSources = SEARCH_BOOKMARK;
+      break;
+    case 3:
+    default:
+      mAutoCompleteSearchSources = SEARCH_BOTH;
       break;
   }
 
   mPrefBranch->GetBoolPref(PREF_AUTOCOMPLETE_FILTER_JAVASCRIPT,
                            &mAutoCompleteFilterJavascript);
   mPrefBranch->GetIntPref(PREF_AUTOCOMPLETE_MAX_RICH_RESULTS,
                           &mAutoCompleteMaxResults);
   mPrefBranch->GetIntPref(PREF_AUTOCOMPLETE_SEARCH_CHUNK_SIZE,
@@ -2050,16 +2086,19 @@ nsNavHistory::LoadPrefs(PRBool aInitiali
                            getter_Copies(prefStr));
   mAutoCompleteMatchUrl = NS_ConvertUTF8toUTF16(prefStr);
 
   if (!aInitializing && oldCompleteOnlyTyped != mAutoCompleteOnlyTyped) {
     // update the autocomplete statements if the option has changed.
     nsresult rv = CreateAutoCompleteQueries();
     NS_ENSURE_SUCCESS(rv, rv);
   }
+
+  // Clear out the search on any pref change to invalidate cached search
+  mCurrentSearchString = EmptyString();
 #endif
 
   // get the frecency prefs
   nsCOMPtr<nsIPrefBranch> prefs(do_GetService("@mozilla.org/preferences-service;1"));
   if (prefs) {
     prefs->GetIntPref(PREF_FRECENCY_NUM_VISITS, 
       &mNumVisitsForFrecency);
     prefs->GetIntPref(PREF_FRECENCY_CALC_ON_IDLE, 
@@ -5235,16 +5274,67 @@ nsNavHistory::AddDownload(nsIURI* aSourc
 
 NS_IMETHODIMP
 nsNavHistory::GetDBConnection(mozIStorageConnection **_DBConnection)
 {
   NS_ADDREF(*_DBConnection = mDBConn);
   return NS_OK;
 }
 
+NS_IMETHODIMP
+nsNavHistory::FinalizeInternalStatements()
+{
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
+#ifdef LAZY_ADD
+  // Kill lazy timer or it could fire later when statements won't be valid
+  // anymore.
+  // At this point we should have called CommitPendingChanges before the last
+  // sync, so all data is saved to disk and we can finalize all statements.
+  if (mLazyTimer)
+    mLazyTimer->Cancel();
+  NS_ABORT_IF_FALSE(mLazyMessages.Length() == 0,
+    "There are pending lazy messages, did you call CommitPendingChanges()?");
+#endif
+
+  // nsNavHistory
+  nsresult rv = FinalizeStatements();
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  // nsNavBookmarks
+  nsNavBookmarks* bookmarks = nsNavBookmarks::GetBookmarksService();
+  NS_ENSURE_TRUE(bookmarks, NS_ERROR_OUT_OF_MEMORY);
+  rv = bookmarks->FinalizeStatements();
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  // nsAnnotationService
+  nsAnnotationService* annosvc = nsAnnotationService::GetAnnotationService();
+  NS_ENSURE_TRUE(annosvc, NS_ERROR_OUT_OF_MEMORY);
+  rv = annosvc->FinalizeStatements();
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  // nsFaviconService
+  nsFaviconService* iconsvc = nsFaviconService::GetFaviconService();
+  NS_ENSURE_TRUE(iconsvc, NS_ERROR_OUT_OF_MEMORY);
+  rv = iconsvc->FinalizeStatements();
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  return NS_OK;
+}
+
+NS_IMETHODIMP
+nsNavHistory::CommitPendingChanges()
+{
+  #ifdef LAZY_ADD
+    CommitLazyMessages();
+  #endif
+
+  return NS_OK;
+}
+
 // nsIObserver *****************************************************************
 
 NS_IMETHODIMP
 nsNavHistory::Observe(nsISupports *aSubject, const char *aTopic,
                     const PRUnichar *aData)
 {
   NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
 
@@ -7411,16 +7501,60 @@ nsNavHistory::GetDBOldFrecencies()
      "WHERE ROWID >= ABS(RANDOM() % (SELECT MAX(ROWID) FROM moz_places)) "
      "LIMIT ?1"),
     getter_AddRefs(mDBOldFrecencies));
   NS_ENSURE_SUCCESS(rv, nsnull);
 
   return mDBOldFrecencies;
 }
 
+nsresult
+nsNavHistory::FinalizeStatements() {
+  mozIStorageStatement* stmts[] = {
+    mDBGetURLPageInfo,
+    mDBGetIdPageInfo,
+    mDBRecentVisitOfURL,
+    mDBRecentVisitOfPlace,
+    mDBInsertVisit,
+    mDBGetPageVisitStats,
+    mDBIsPageVisited,
+    mDBUpdatePageVisitStats,
+    mDBAddNewPage,
+    mDBGetTags,
+    mFoldersWithAnnotationQuery,
+    mDBSetPlaceTitle,
+    mDBVisitToURLResult,
+    mDBVisitToVisitResult,
+    mDBBookmarkToUrlResult,
+    mDBVisitsForFrecency,
+    mDBUpdateFrecencyAndHidden,
+    mDBGetPlaceVisitStats,
+    mDBGetBookmarkParentsForPlace,
+    mDBFullVisitCount,
+    mDBInvalidFrecencies,
+    mDBOldFrecencies,
+    mDBCurrentQuery,
+    mDBAutoCompleteQuery,
+    mDBAutoCompleteHistoryQuery,
+    mDBAutoCompleteStarQuery,
+    mDBAutoCompleteTagsQuery,
+    mDBPreviousQuery,
+    mDBAdaptiveQuery,
+    mDBKeywordQuery,
+    mDBFeedbackIncrease
+  };
+
+  for (PRUint32 i = 0; i < NS_ARRAY_LENGTH(stmts); i++) {
+    nsresult rv = nsNavHistory::FinalizeStatement(stmts[i]);
+    NS_ENSURE_SUCCESS(rv, rv);
+  }
+
+  return NS_OK;
+}
+
 // nsICharsetResolver **********************************************************
 
 NS_IMETHODIMP
 nsNavHistory::RequestCharset(nsIWebNavigation* aWebNavigation,
                              nsIChannel* aChannel,
                              PRBool* aWantCharset,
                              nsISupports** aClosure,
                              nsACString& aResult)
diff -r a4343d61f6ee toolkit/components/places/src/nsNavHistory.h
--- a/toolkit/components/places/src/nsNavHistory.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/src/nsNavHistory.h	Sat Nov 15 19:43:14 2008 -0500
@@ -116,16 +116,18 @@
 #define SQL_STR_FRAGMENT_MAX_VISIT_DATE( __place_relation ) \
   "IFNULL( " SQL_STR_FRAGMENT_MAX_VISIT_DATE_BASE( __place_relation, "moz_historyvisits_temp") \
           ", " SQL_STR_FRAGMENT_MAX_VISIT_DATE_BASE( __place_relation, "moz_historyvisits") ")"
 
 // This magic number specified an uninitialized value for the
 // mInPrivateBrowsing member
 #define PRIVATEBROWSING_NOTINITED (PRBool(0xffffffff))
 
+#define PLACES_INIT_COMPLETE_EVENT_TOPIC "places-init-complete"
+
 struct AutoCompleteIntermediateResult;
 class AutoCompleteResultComparator;
 class mozIAnnotationService;
 class nsNavHistory;
 class nsNavBookmarks;
 class QueryKeyValuePair;
 class nsIEffectiveTLDService;
 class nsIIDNService;
@@ -188,27 +190,16 @@ public:
     if (gHistoryService)
       return gHistoryService;
 
     nsCOMPtr<nsINavHistoryService> serv =
       do_GetService("@mozilla.org/browser/nav-history-service;1");
     NS_ENSURE_TRUE(serv, nsnull);
 
     return gHistoryService;
-  }
-
-  /**
-   * Call this function before doing any database reads. It will ensure that
-   * any data not flushed to the DB yet is flushed.
-   */
-  void SyncDB()
-  {
-    #ifdef LAZY_ADD
-      CommitLazyMessages();
-    #endif
   }
 
 #ifdef LAZY_ADD
   /**
    * Adds a lazy message for adding a favicon. Used by the favicon service so
    * that favicons are handled lazily just like page adds.
    */
   nsresult AddLazyLoadFaviconMessage(nsIURI* aPage, nsIURI* aFavicon,
@@ -393,16 +384,29 @@ public:
       }
     }
 
     return mInPrivateBrowsing;
   }
 
   typedef nsDataHashtable<nsCStringHashKey, nsCString> StringHash;
 
+  /**
+   * Helper method to finalize a statement
+   */
+  static nsresult
+  FinalizeStatement(mozIStorageStatement *aStatement) {
+    nsresult rv;
+    if (aStatement) {
+      rv = aStatement->Finalize();
+      NS_ENSURE_SUCCESS(rv, rv);
+    }
+    return NS_OK;
+  }
+
  private:
   ~nsNavHistory();
 
   // used by GetHistoryService
   static nsNavHistory* gHistoryService;
 
 protected:
 
@@ -436,16 +440,21 @@ protected:
   // these are used by VisitIdToResultNode for making new result nodes from IDs
   // Consumers need to use the getters since these statements are lazily created
   mozIStorageStatement *GetDBVisitToURLResult();
   nsCOMPtr<mozIStorageStatement> mDBVisitToURLResult; // kGetInfoIndex_* results
   mozIStorageStatement *GetDBVisitToVisitResult();
   nsCOMPtr<mozIStorageStatement> mDBVisitToVisitResult; // kGetInfoIndex_* results
   mozIStorageStatement *GetDBBookmarkToUrlResult();
   nsCOMPtr<mozIStorageStatement> mDBBookmarkToUrlResult; // kGetInfoIndex_* results
+
+  /**
+   * Finalize all internal statements.
+   */
+  nsresult FinalizeStatements();
 
   // nsICharsetResolver
   NS_DECL_NSICHARSETRESOLVER
 
   /**
    * Recalculates aCount frecencies.  If aRecalcOld, it will also calculate
    * the frecency of aCount history visits that have not occurred recently.
    *
@@ -697,20 +706,31 @@ protected:
    */
   enum MatchType {
     MATCH_ANYWHERE,
     MATCH_BOUNDARY_ANYWHERE,
     MATCH_BOUNDARY,
     MATCH_BEGINNING
   };
 
+  /**
+   * Determine which sources (if any) of data to search for the autocomplete
+   */
+  enum SearchSource {
+    SEARCH_NONE,
+    SEARCH_HISTORY,
+    SEARCH_BOOKMARK,
+    SEARCH_BOTH
+  };
+
   nsresult InitAutoComplete();
   nsresult CreateAutoCompleteQueries();
   PRBool mAutoCompleteOnlyTyped;
   MatchType mAutoCompleteMatchBehavior;
+  SearchSource mAutoCompleteSearchSources;
   PRBool mAutoCompleteFilterJavascript;
   PRInt32 mAutoCompleteMaxResults;
   nsString mAutoCompleteRestrictHistory;
   nsString mAutoCompleteRestrictBookmark;
   nsString mAutoCompleteRestrictTag;
   nsString mAutoCompleteMatchTitle;
   nsString mAutoCompleteMatchUrl;
   PRInt32 mAutoCompleteSearchChunkSize;
@@ -819,16 +839,18 @@ protected:
   nsCOMPtr<nsITimer> mIdleTimer;
   nsresult InitializeIdleTimer();
   static void IdleTimerCallback(nsITimer* aTimer, void* aClosure);
   nsresult OnIdle();
 
   PRInt64 mTagsFolder;
 
   PRBool mInPrivateBrowsing;
+
+  PRBool mDatabaseStatus;
 };
 
 /**
  * Shared between the places components, this function binds the given URI as
  * UTF8 to the given parameter for the statement.
  */
 nsresult BindStatementURI(mozIStorageStatement* statement, PRInt32 index,
                           nsIURI* aURI);
diff -r a4343d61f6ee toolkit/components/places/src/nsNavHistoryAutoComplete.cpp
--- a/toolkit/components/places/src/nsNavHistoryAutoComplete.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/src/nsNavHistoryAutoComplete.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -615,27 +615,30 @@ nsNavHistory::StartSearch(const nsAStrin
 
   mCurrentListener = aListener;
 
   nsresult rv;
   mCurrentResult = do_CreateInstance(NS_AUTOCOMPLETESIMPLERESULT_CONTRACTID, &rv);
   NS_ENSURE_SUCCESS(rv, rv);
   mCurrentResult->SetSearchString(aSearchString);
 
+  // Short circuit to give no results if we don't need to search for matches.
   // Use the previous in-progress search by looking at which urls it found if
   // the new search begins with the old one and both aren't empty. We don't run
   // into bug 412730 because we only specify urls and not titles to look at.
   // Also, only reuse the search if the previous and new search both start with
   // javascript: or both don't. (bug 417798)
-  if (!prevSearchString.IsEmpty() &&
-      StringBeginsWith(mCurrentSearchString, prevSearchString) &&
-      (StartsWithJS(prevSearchString) == StartsWithJS(mCurrentSearchString))) {
+  if (mAutoCompleteSearchSources == SEARCH_NONE ||
+      (!prevSearchString.IsEmpty() &&
+       StringBeginsWith(mCurrentSearchString, prevSearchString) &&
+       (StartsWithJS(prevSearchString) == StartsWithJS(mCurrentSearchString)))) {
 
     // Got nothing before? We won't get anything new, so stop now
-    if (mAutoCompleteFinishedSearch && prevMatchCount == 0) {
+    if (mAutoCompleteSearchSources == SEARCH_NONE ||
+        (mAutoCompleteFinishedSearch && prevMatchCount == 0)) {
       // Set up the result to let the listener know that there's nothing
       mCurrentResult->SetSearchResult(nsIAutoCompleteResult::RESULT_NOMATCH);
       mCurrentResult->SetDefaultIndex(-1);
 
       rv = mCurrentResult->SetListener(this);
       NS_ENSURE_SUCCESS(rv, rv);
 
       (void)mCurrentListener->OnSearchResult(this, mCurrentResult);
@@ -789,16 +792,23 @@ nsNavHistory::ProcessTokensForSpecialSea
 nsNavHistory::ProcessTokensForSpecialSearch()
 {
   // If any of the special searches are empty, automatically use it
   mRestrictHistory = mAutoCompleteRestrictHistory.IsEmpty();
   mRestrictBookmark = mAutoCompleteRestrictBookmark.IsEmpty();
   mRestrictTag = mAutoCompleteRestrictTag.IsEmpty();
   mMatchTitle = mAutoCompleteMatchTitle.IsEmpty();
   mMatchUrl = mAutoCompleteMatchUrl.IsEmpty();
+
+  // If we're searching only one of history or bookmark, we can use filters
+  if (mAutoCompleteSearchSources == SEARCH_HISTORY)
+    mRestrictHistory = PR_TRUE;
+  else if (mAutoCompleteSearchSources == SEARCH_BOOKMARK)
+    mRestrictBookmark = PR_TRUE;
+  // SEARCH_BOTH doesn't require any filtering
 
   // Determine which special searches to apply
   for (PRInt32 i = mCurrentSearchTokens.Count(); --i >= 0; ) {
     PRBool needToRemove = PR_TRUE;
     const nsString *token = mCurrentSearchTokens.StringAt(i);
 
     if (token->Equals(mAutoCompleteRestrictHistory))
       mRestrictHistory = PR_TRUE;
diff -r a4343d61f6ee toolkit/components/places/src/nsNavHistoryExpire.cpp
--- a/toolkit/components/places/src/nsNavHistoryExpire.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/src/nsNavHistoryExpire.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -252,28 +252,20 @@ nsNavHistoryExpire::ClearHistory()
   // idle query to figure out which places to recalcuate frecency first.
   // We must do this before deleting visits
   nsresult rv = connection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
     "UPDATE moz_places_view SET frecency = -MAX(visit_count, 1) "
     "WHERE id IN("
       "SELECT h.id FROM moz_places_temp h "
       "WHERE "
         "EXISTS (SELECT id FROM moz_bookmarks WHERE fk = h.id) "
-        "OR EXISTS "
-          "(SELECT id FROM moz_annos WHERE place_id = h.id AND expiration = ") +
-          nsPrintfCString("%d", nsIAnnotationService::EXPIRE_NEVER) +
-          NS_LITERAL_CSTRING(") "
       "UNION ALL "
       "SELECT h.id FROM moz_places h "
       "WHERE "
         "EXISTS (SELECT id FROM moz_bookmarks WHERE fk = h.id) "
-        "OR EXISTS "
-          "(SELECT id FROM moz_annos WHERE place_id = h.id AND expiration = ") +
-          nsPrintfCString("%d", nsIAnnotationService::EXPIRE_NEVER) +
-          NS_LITERAL_CSTRING(") "
     ")"));
   NS_ENSURE_SUCCESS(rv, rv);
 
   // expire visits, then let the paranoid functions do the cleanup for us
   rv = connection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "DELETE FROM moz_historyvisits_view"));
   NS_ENSURE_SUCCESS(rv, rv);
 
@@ -832,39 +824,47 @@ nsNavHistoryExpire::ExpireAnnotations(mo
 
   // remove days annos
   rv = expirePagesStatement->BindInt32Parameter(0, nsIAnnotationService::EXPIRE_DAYS);
   NS_ENSURE_SUCCESS(rv, rv);
   rv = expirePagesStatement->BindInt64Parameter(1, (now - EXPIRATION_POLICY_DAYS));
   NS_ENSURE_SUCCESS(rv, rv);
   rv = expirePagesStatement->Execute();
   NS_ENSURE_SUCCESS(rv, rv);
-  
+  rv = expirePagesStatement->Reset();
+  NS_ENSURE_SUCCESS(rv, rv);
+
   // remove days item annos
   rv = expireItemsStatement->BindInt32Parameter(0, nsIAnnotationService::EXPIRE_DAYS);
   NS_ENSURE_SUCCESS(rv, rv);
   rv = expireItemsStatement->BindInt64Parameter(1, (now - EXPIRATION_POLICY_DAYS));
   NS_ENSURE_SUCCESS(rv, rv);
   rv = expireItemsStatement->Execute();
+  NS_ENSURE_SUCCESS(rv, rv);
+  rv = expireItemsStatement->Reset();
   NS_ENSURE_SUCCESS(rv, rv);
 
   // remove weeks annos
   rv = expirePagesStatement->BindInt32Parameter(0, nsIAnnotationService::EXPIRE_WEEKS);
   NS_ENSURE_SUCCESS(rv, rv);
   rv = expirePagesStatement->BindInt64Parameter(1, (now - EXPIRATION_POLICY_WEEKS));
   NS_ENSURE_SUCCESS(rv, rv);
   rv = expirePagesStatement->Execute();
   NS_ENSURE_SUCCESS(rv, rv);
+  rv = expirePagesStatement->Reset();
+  NS_ENSURE_SUCCESS(rv, rv);
 
   // remove weeks item annos
   rv = expireItemsStatement->BindInt32Parameter(0, nsIAnnotationService::EXPIRE_WEEKS);
   NS_ENSURE_SUCCESS(rv, rv);
   rv = expireItemsStatement->BindInt64Parameter(1, (now - EXPIRATION_POLICY_WEEKS));
   NS_ENSURE_SUCCESS(rv, rv);
   rv = expireItemsStatement->Execute();
+  NS_ENSURE_SUCCESS(rv, rv);
+  rv = expireItemsStatement->Reset();
   NS_ENSURE_SUCCESS(rv, rv);
 
   // remove months annos
   rv = expirePagesStatement->BindInt32Parameter(0, nsIAnnotationService::EXPIRE_MONTHS);
   NS_ENSURE_SUCCESS(rv, rv);
   rv = expirePagesStatement->BindInt64Parameter(1, (now - EXPIRATION_POLICY_MONTHS));
   NS_ENSURE_SUCCESS(rv, rv);
   rv = expirePagesStatement->Execute();
diff -r a4343d61f6ee toolkit/components/places/src/nsNavHistoryResult.cpp
--- a/toolkit/components/places/src/nsNavHistoryResult.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/src/nsNavHistoryResult.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -2190,17 +2190,20 @@ nsNavHistoryQueryResultNode::GetHasChild
     nsCOMPtr<mozIStorageStatement> hasTagsStatement;
     rv = dbConn->CreateStatement(NS_LITERAL_CSTRING(
         "SELECT id FROM moz_bookmarks WHERE parent = ?1 LIMIT 1"),
       getter_AddRefs(hasTagsStatement));
     NS_ENSURE_SUCCESS(rv, rv);
     rv = hasTagsStatement->BindInt64Parameter(0, tagsFolderId);
     NS_ENSURE_SUCCESS(rv, rv);
 
-    return hasTagsStatement->ExecuteStep(aHasChildren);
+    rv = hasTagsStatement->ExecuteStep(aHasChildren);
+    NS_ENSURE_SUCCESS(rv, rv);
+
+    return NS_OK;
   }
 
   // For history containers query we must check if we have any history
   if (resultType == nsINavHistoryQueryOptions::RESULTS_AS_DATE_QUERY ||
       resultType == nsINavHistoryQueryOptions::RESULTS_AS_DATE_SITE_QUERY ||
       resultType == nsINavHistoryQueryOptions::RESULTS_AS_SITE_QUERY) {
     nsNavHistory* history = nsNavHistory::GetHistoryService();
     NS_ENSURE_TRUE(history, NS_ERROR_OUT_OF_MEMORY);
diff -r a4343d61f6ee toolkit/components/places/src/nsPlacesDBFlush.js
--- a/toolkit/components/places/src/nsPlacesDBFlush.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/src/nsPlacesDBFlush.js	Sat Nov 15 19:43:14 2008 -0500
@@ -98,17 +98,36 @@ nsPlacesDBFlush.prototype = {
   observe: function DBFlush_observe(aSubject, aTopic, aData)
   {
     if (aTopic == kQuitApplication) {
       this._bs.removeObserver(this);
       this._os.removeObserver(this, kQuitApplication);
       this._prefs.QueryInterface(Ci.nsIPrefBranch2).removeObserver("", this);
       this._timer.cancel();
       this._timer = null;
-      this._syncTables(["places", "historyvisits"]);
+      // Other components could still make changes to history at this point,
+      // for example to clear private data on shutdown, so here we dispatch
+      // an event to the main thread so that we will sync after
+      // quit-application ensuring all data have been saved.
+      let tm = Cc["@mozilla.org/thread-manager;1"].
+          getService(Ci.nsIThreadManager);
+      tm.mainThread.dispatch({
+        _self: this,
+        run: function() {
+          let pip = Cc["@mozilla.org/browser/nav-history-service;1"].
+                    getService(Ci.nsPIPlacesDatabase);
+          pip.commitPendingChanges();
+          this._self._syncTables(["places", "historyvisits"]);
+          // Close the database connection, this was the last sync and we can't
+          // ensure database coherence from now on.
+          pip.finalizeInternalStatements();
+          this._self._db.close();
+        }
+      }, Ci.nsIThread.DISPATCH_NORMAL);
+
     }
     else if (aTopic == "nsPref:changed" && aData == kSyncPrefName) {
       // Get the new pref value, and then update our timer
       this._syncInterval = aSubject.getIntPref(kSyncPrefName);
       if (this._syncInterval <= 0)
         this._syncInterval = kDefaultSyncInterval;
 
       // We may have canceled the timer already for batch updates, so we want to
diff -r a4343d61f6ee toolkit/components/places/src/utils.js
--- a/toolkit/components/places/src/utils.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/src/utils.js	Sat Nov 15 19:43:14 2008 -0500
@@ -1580,27 +1580,36 @@ var PlacesUtils = {
       if (!bookmarksBackupDir.exists())
         return; // unable to create directory!
     }
 
     // construct the new leafname
     // Use YYYY-MM-DD (ISO 8601) as it doesn't contain illegal characters
     // and makes the alphabetical order of multiple backup files more useful.
     var date = new Date().toLocaleFormat("%Y-%m-%d");
-    var backupFilename = this.getFormattedString("bookmarksArchiveFilename", [date]);
+    var backupFilename = "bookmarks-" + date + ".json";
 
     var backupFile = null;
     if (!aForceArchive) {
       var backupFileNames = [];
       var backupFilenamePrefix = backupFilename.substr(0, backupFilename.indexOf("-"));
+
+      // Get the localized backup filename, to clear out
+      // old backups with a localized name (bug 445704).
+      var localizedFilename = this.getFormattedString("bookmarksArchiveFilename", [date]);
+      var localizedFilenamePrefix = localizedFilename.substr(0, localizedFilename.indexOf("-"));
+      var rx = new RegExp("^(bookmarks|" + localizedFilenamePrefix + ")-.+\.json");
+
       var entries = bookmarksBackupDir.directoryEntries;
       while (entries.hasMoreElements()) {
         var entry = entries.getNext().QueryInterface(Ci.nsIFile);
         var backupName = entry.leafName;
-        if (backupName.substr(0, backupFilenamePrefix.length) == backupFilenamePrefix) {
+        // A valid backup is any file that matches either the localized or
+        // not-localized filename (bug 445704).
+        if (backupName.match(rx)) {
           if (backupName == backupFilename)
             backupFile = entry;
           backupFileNames.push(backupName);
         }
       }
 
       var numberOfBackupsToDelete = 0;
       if (aNumberOfBackups > -1)
diff -r a4343d61f6ee toolkit/components/places/tests/Makefile.in
--- a/toolkit/components/places/tests/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/tests/Makefile.in	Sat Nov 15 19:43:14 2008 -0500
@@ -43,17 +43,16 @@ relativesrcdir	= toolkit/components/plac
 relativesrcdir	= toolkit/components/places/tests
 
 include $(DEPTH)/config/autoconf.mk
 
 MODULE		= test_places
 
 XPCSHELL_TESTS = \
                  autocomplete \
-                 background \
                  sync \
                  bookmarks \
                  queries \
                  unit \
                  $(NULL)
 
 # Simple MochiTests
 MOCHI_TESTS = mochitest/test_bug_405924.html \
diff -r a4343d61f6ee toolkit/components/places/tests/autocomplete/test_search_sources.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/toolkit/components/places/tests/autocomplete/test_search_sources.js	Sat Nov 15 19:43:14 2008 -0500
@@ -0,0 +1,75 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Places Test Code.
+ *
+ * The Initial Developer of the Original Code is
+ * Edward Lee <edward.lee@engineering.uiuc.edu>.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+/**
+ * Test for bug 463661 to allow configuring the autocomplete to search history,
+ * bookmarks, both, or neither. Also test bug 463535 for pref changing search.
+ */
+
+// Define some shared uris and titles (each page needs its own uri)
+let kURIs = [
+  "http://url/0",
+  "http://url/1",
+  "http://url/2",
+];
+let kTitles = [
+  "title",
+];
+
+addPageBook(0, 0); // visited page
+addPageBook(1, 0, 0); // visited bookmark
+addPageBook(2, 0, 0); // unvisited bookmark
+
+// Remove the visit for this bookmark
+histsvc.removePage(toURI(kURIs[2]));
+
+// Provide for each test: description; search terms; array of gPages indices of
+// pages that should match; optional function to be run before the test
+let gTests = [
+  // We get more results as we become less restrictive with the same search
+  ["1: search none",
+   "url", [], function() setSearch(0)],
+  ["2: search history",
+   "url", [0,1], function() setSearch(1)],
+  ["3: search bookmark",
+   "url", [1,2], function() setSearch(2)],
+  ["4: search both",
+   "url", [0,1,2], function() setSearch(3)],
+];
+
+function setSearch(aSearch) {
+  prefs.setIntPref("browser.urlbar.search.sources", aSearch);
+}
diff -r a4343d61f6ee toolkit/components/places/tests/background/head_background.js
--- a/toolkit/components/places/tests/background/head_background.js	Thu Nov 06 18:33:22 2008 +0100
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,102 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
-/* ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is Places.
- *
- * The Initial Developer of the Original Code is
- * Google Inc.
- * Portions created by the Initial Developer are Copyright (C) 2005
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *  Brian Ryner <bryner@brianryner.com>
- *  Dietrich Ayala <dietrich@mozilla.com>
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-const NS_APP_USER_PROFILE_50_DIR = "ProfD";
-const NS_APP_HISTORY_50_FILE = "UHist";
-
-const Ci = Components.interfaces;
-const Cc = Components.classes;
-const Cr = Components.results;
-
-function LOG(aMsg) {
-  aMsg = ("*** PLACES TESTS: " + aMsg);
-  Cc["@mozilla.org/consoleservice;1"].getService(Ci.nsIConsoleService).
-                                      logStringMessage(aMsg);
-  print(aMsg);
-}
-
-// If there's no location registered for the profile direcotry, register one now.
-var dirSvc = Cc["@mozilla.org/file/directory_service;1"].getService(Ci.nsIProperties);
-var profileDir = null;
-try {
-  profileDir = dirSvc.get(NS_APP_USER_PROFILE_50_DIR, Ci.nsIFile);
-} catch (e) {}
-if (!profileDir) {
-  // Register our own provider for the profile directory.
-  // It will simply return the current directory.
-  var provider = {
-    getFile: function(prop, persistent) {
-      persistent.value = true;
-      if (prop == NS_APP_USER_PROFILE_50_DIR) {
-        return dirSvc.get("CurProcD", Ci.nsIFile);
-      }
-      if (prop == NS_APP_HISTORY_50_FILE) {
-        var histFile = dirSvc.get("CurProcD", Ci.nsIFile);
-        histFile.append("history.dat");
-        return histFile;
-      }
-      throw Cr.NS_ERROR_FAILURE;
-    },
-    QueryInterface: function(iid) {
-      if (iid.equals(Ci.nsIDirectoryServiceProvider) ||
-          iid.equals(Ci.nsISupports)) {
-        return this;
-      }
-      throw Cr.NS_ERROR_NO_INTERFACE;
-    }
-  };
-  dirSvc.QueryInterface(Ci.nsIDirectoryService).registerProvider(provider);
-}
-
-var iosvc = Cc["@mozilla.org/network/io-service;1"].getService(Ci.nsIIOService);
-
-function uri(spec) {
-  return iosvc.newURI(spec, null, null);
-}
-
-// Delete a previously created sqlite file
-function clearDB() {
-  try {
-    var file = dirSvc.get('ProfD', Ci.nsIFile);
-    file.append("places.sqlite");
-    if (file.exists())
-      file.remove(false);
-  } catch(ex) { dump("Exception: " + ex); }
-}
-clearDB();
diff -r a4343d61f6ee toolkit/components/places/tests/background/test_background.js
--- a/toolkit/components/places/tests/background/test_background.js	Thu Nov 06 18:33:22 2008 +0100
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,123 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-
- * vim: sw=2 ts=2 sts=2 expandtab
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Mozilla Corporation.
- * Portions created by the Initial Developer are Copyright (C) 2008
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *   Shawn Wilsher <me@shawnwilsher.com> (Original Author)
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-Components.utils.import("resource://gre/modules/PlacesBackground.jsm");
-
-function test_service_exists()
-{
-  do_check_neq(PlacesBackground, null);
-}
-
-function test_isOnCurrentThread()
-{
-  do_check_false(PlacesBackground.isOnCurrentThread());
-
-  let event = {
-    run: function()
-    {
-      do_check_true(PlacesBackground.isOnCurrentThread());
-    }
-  };
-  PlacesBackground.dispatch(event, Ci.nsIEventTarget.DISPATCH_SYNC);
-}
-
-function test_two_events_same_thread()
-{
-  // This test imports PlacesBackground.jsm onto two different objects to
-  // ensure that the thread is the same for both.
-  let event = {
-    run: function()
-    {
-      let tm = Cc["@mozilla.org/thread-manager;1"].
-               getService(Ci.nsIThreadManager);
-
-      if (!this.thread1)
-        this.thread1 = tm.currentThread;
-      else
-        this.thread2 = tm.currentThread;
-    }
-  };
-
-  let obj1 = { };
-  Components.utils.import("resource://gre/modules/PlacesBackground.jsm", obj1);
-  obj1.PlacesBackground.dispatch(event, Ci.nsIEventTarget.DISPATCH_SYNC);
-  let obj2 = { };
-  Components.utils.import("resource://gre/modules/PlacesBackground.jsm", obj2);
-  obj2.PlacesBackground.dispatch(event, Ci.nsIEventTarget.DISPATCH_SYNC);
-  do_check_eq(event.thread1, event.thread2);
-}
-
-function test_places_background_shutdown_topic()
-{
-  // Ensures that the places shutdown topic is dispatched before the thread is
-  // shutdown.
-  let os = Cc["@mozilla.org/observer-service;1"].
-           getService(Ci.nsIObserverService);
-  os.addObserver({
-    observe: function(aSubject, aTopic, aData)
-    {
-      // We should still be able to dispatch an event without throwing now!
-      PlacesBackground.dispatch({
-        run: function()
-        {
-          do_test_finished();
-        }
-      }, Ci.nsIEventTarget.DISPATCH_NORMAL);
-    }
-  }, "places-background-shutdown", false);
-  do_test_pending();
-}
-
-let tests = [
-  test_service_exists,
-  test_isOnCurrentThread,
-  test_two_events_same_thread,
-  test_places_background_shutdown_topic,
-];
-
-function run_test()
-{
-  for (let i = 0; i < tests.length; i++)
-    tests[i]();
-
-  // xpcshell doesn't dispatch shutdown-application
-  let os = Cc["@mozilla.org/observer-service;1"].
-           getService(Ci.nsIObserverService);
-  os.notifyObservers(null, "quit-application", null);
-}
diff -r a4343d61f6ee toolkit/components/places/tests/mochitest/bug_461710/Makefile.in
--- a/toolkit/components/places/tests/mochitest/bug_461710/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/tests/mochitest/bug_461710/Makefile.in	Sat Nov 15 19:43:14 2008 -0500
@@ -42,13 +42,17 @@ VPATH		= @srcdir@
 VPATH		= @srcdir@
 relativesrcdir = toolkit/components/places/tests/bug_461710
 
 include $(DEPTH)/config/autoconf.mk
 include $(topsrcdir)/config/rules.mk
 
 _HTTP_FILES	= \
 		visited_page.html \
+		visited_page-2.html \
+		visited_page-3.html \
 		link_page.html \
+		link_page-2.html \
+		link_page-3.html \
 		$(NULL)
 
 libs:: $(_HTTP_FILES)
 	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
diff -r a4343d61f6ee toolkit/components/places/tests/mochitest/bug_461710/link_page-2.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/toolkit/components/places/tests/mochitest/bug_461710/link_page-2.html	Sat Nov 15 19:43:14 2008 -0500
@@ -0,0 +1,13 @@
+<!DOCTYPE HTML>
+<html>
+  <head>
+    <title>Link page 2</title>
+    <style type="text/css">
+      a:link { color: #0000ff; }
+      a:visited { color: #ff0000; }
+    </style>
+  </head>
+  <body>
+    <p><a href="visited_page.html" id="link">Link to the second visited page</a></p>
+  </body>
+</html>
\ No newline at end of file
diff -r a4343d61f6ee toolkit/components/places/tests/mochitest/bug_461710/link_page-3.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/toolkit/components/places/tests/mochitest/bug_461710/link_page-3.html	Sat Nov 15 19:43:14 2008 -0500
@@ -0,0 +1,13 @@
+<!DOCTYPE HTML>
+<html>
+  <head>
+    <title>Link page 3</title>
+    <style type="text/css">
+      a:link { color: #0000ff; }
+      a:visited { color: #ff0000; }
+    </style>
+  </head>
+  <body>
+    <p><a href="visited_page.html" id="link">Link to the third visited page</a></p>
+  </body>
+</html>
\ No newline at end of file
diff -r a4343d61f6ee toolkit/components/places/tests/mochitest/bug_461710/visited_page-2.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/toolkit/components/places/tests/mochitest/bug_461710/visited_page-2.html	Sat Nov 15 19:43:14 2008 -0500
@@ -0,0 +1,9 @@
+<!DOCTYPE HTML>
+<html>
+  <head>
+    <title>Visited page 2</title>
+  </head>
+  <body>
+    <p>This second page is marked as visited</p>
+  </body>
+</html>
\ No newline at end of file
diff -r a4343d61f6ee toolkit/components/places/tests/mochitest/bug_461710/visited_page-3.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/toolkit/components/places/tests/mochitest/bug_461710/visited_page-3.html	Sat Nov 15 19:43:14 2008 -0500
@@ -0,0 +1,9 @@
+<!DOCTYPE HTML>
+<html>
+  <head>
+    <title>Visited page 3</title>
+  </head>
+  <body>
+    <p>This third page is marked as visited</p>
+  </body>
+</html>
\ No newline at end of file
diff -r a4343d61f6ee toolkit/components/places/tests/mochitest/test_bug_461710.html
--- a/toolkit/components/places/tests/mochitest/test_bug_461710.html	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/tests/mochitest/test_bug_461710.html	Sat Nov 15 19:43:14 2008 -0500
@@ -24,43 +24,53 @@ const Cr = Components.results;
 const Cr = Components.results;
 
 const kRed = "rgb(255, 0, 0)";
 const kBlue = "rgb(0, 0, 255)";
 
 var testpath = document.location.pathname + "/../bug_461710/";
 var prefix = "http://localhost:8888" + testpath;
 var subtests = [
-                   "visited_page.html", // 1
-                   "link_page.html", // 2
-                   "link_page.html", // 3
-                   "link_page.html" // 4
+                   "visited_page.html",   // 1
+                   "visited_page-2.html", // 2
+                   "visited_page-3.html", // 3
+                   "link_page.html",      // 4
+                   "link_page-2.html",    // 5
+                   "link_page-3.html"     // 6
                ];
 
 
 var testNum = 0;
 function loadNextTest() {
   netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
 
   // run the initialization code for each test
   switch (++ testNum) {
     case 1:
       // nothing to do here
       break;
 
     case 2:
+      // nothing to do here
+      break;
+
+    case 3:
+      // nothing to do here
+      break;
+
+    case 4:
       ok(!pb.privateBrowsingEnabled, "Test #" + testNum + " should be run outside of private mode");
       break;
 
-    case 3:
+    case 5:
       pb.privateBrowsingEnabled = true;
       ok(pb.privateBrowsingEnabled, "Test #" + testNum + " should be run inside of private mode");
       break;
 
-    case 4:
+    case 6:
       pb.privateBrowsingEnabled = false;
       ok(!pb.privateBrowsingEnabled, "Test #" + testNum + " should be run outside of private mode");
       break;
 
     default:
       ok(false, "Unexpected call to loadNextTest for test #" + testNum);
   }
 
@@ -70,32 +80,40 @@ function loadNextTest() {
 
 function checkTest() {
   switch (testNum) {
     case 1:
       // nothing to do here, we just want to mark the page as visited
       break;
 
     case 2:
+      // nothing to do here, we just want to mark the page as visited
+      break;
+
+    case 3:
+      // nothing to do here, we just want to mark the page as visited
+      break;
+
+    case 4:
       // run outside of private mode, link should appear as visited
       var doc = iframe.contentDocument;
       var win = doc.defaultView;
       var style = win.getComputedStyle(doc.getElementById("link"), "");
       is(style.getPropertyValue("color"), kRed, "Visited link coloring should work outside of private mode");
       break;
 
-    case 3:
+    case 5:
       // run inside of private mode, link should appear as not visited
       var doc = iframe.contentDocument;
       var win = doc.defaultView;
       var style = win.getComputedStyle(doc.getElementById("link"), "");
       is(style.getPropertyValue("color"), kBlue, "Visited link coloring should not work inside of private mode");
       break;
 
-    case 4:
+    case 6:
       // run outside of private mode, link should appear as visited
       var doc = iframe.contentDocument;
       var win = doc.defaultView;
       var style = win.getComputedStyle(doc.getElementById("link"), "");
       is(style.getPropertyValue("color"), kRed, "Visited link coloring should work outside of private mode");
       break;
 
     default:
@@ -121,19 +139,17 @@ function get_PBSvc() {
 
 var ignoreLoad = false;
 function handleLoad(aEvent) {
   netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
 
   checkTest();
 
   if (testNum < subtests.length) {
-    setTimeout(function() {
-      loadNextTest();
-    }, 500);
+    loadNextTest();
   } else {
     prefBranch.clearUserPref("browser.privatebrowsing.keep_current_session");
     SimpleTest.finish();
   }
 }
 
 
 var pb = get_PBSvc();
diff -r a4343d61f6ee toolkit/components/places/tests/sync/head_sync.js
--- a/toolkit/components/places/tests/sync/head_sync.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/tests/sync/head_sync.js	Sat Nov 15 19:43:14 2008 -0500
@@ -106,19 +106,17 @@ clearDB();
 /**
  * Dumps the rows of a table out to the console.
  *
  * @param aName
  *        The name of the table or view to output.
  */
 function dump_table(aName)
 {
-  let db = Cc["@mozilla.org/browser/nav-history-service;1"].
-           getService(Ci.nsPIPlacesDatabase).
-           DBConnection;
+  let db = DBConn()
   let stmt = db.createStatement("SELECT * FROM " + aName);
 
   dump("\n*** Printing data from " + aName + ":\n");
   let count = 0;
   while (stmt.executeStep()) {
     let columns = stmt.numEntries;
 
     if (count == 0) {
@@ -180,19 +178,17 @@ function finish_test()
  *        The URI we expect to be in moz_places.
  * @param aExpected
  *        Indicates if we expect to get a result or not.
  * @param [optional] aFinish
  *        Indicates if the test should be completed or not.
  */
 function new_test_bookmark_uri_event(aBookmarkId, aExpectedURI, aExpected, aFinish)
 {
-  let db = Cc["@mozilla.org/browser/nav-history-service;1"].
-           getService(Ci.nsPIPlacesDatabase).
-           DBConnection;
+  let db = DBConn();
   let stmt = db.createStatement(
     "SELECT moz_places.url " +
     "FROM moz_bookmarks INNER JOIN moz_places " +
     "ON moz_bookmarks.fk = moz_places.id " +
     "WHERE moz_bookmarks.id = ?1"
   );
   stmt.bindInt64Parameter(0, aBookmarkId);
 
@@ -222,19 +218,17 @@ function new_test_bookmark_uri_event(aBo
  *        The URI we expect to be in moz_places.
  * @param aExpected
  *        Indicates if we expect to get a result or not.
  * @param [optional] aFinish
  *        Indicates if the test should be completed or not.
  */
 function new_test_visit_uri_event(aVisitId, aExpectedURI, aExpected, aFinish)
 {
-  let db = Cc["@mozilla.org/browser/nav-history-service;1"].
-           getService(Ci.nsPIPlacesDatabase).
-           DBConnection;
+  let db = DBConn();
   let stmt = db.createStatement(
     "SELECT moz_places.url " +
     "FROM moz_historyvisits INNER JOIN moz_places " +
     "ON moz_historyvisits.place_id = moz_places.id " +
     "WHERE moz_historyvisits.id = ?1"
   );
   stmt.bindInt64Parameter(0, aVisitId);
 
@@ -248,11 +242,36 @@ function new_test_visit_uri_event(aVisit
   stmt.reset();
   stmt.finalize();
   stmt = null;
 
   if (aFinish)
     finish_test();
 }
 
+/**
+ * Function gets current database connection, if the connection has been closed
+ * it will try to reconnect to the places.sqlite database.
+ */
+function DBConn()
+{
+  let db = Cc["@mozilla.org/browser/nav-history-service;1"].
+           getService(Ci.nsPIPlacesDatabase).
+           DBConnection;
+  if (db.connectionReady)
+    return db;
+
+  // open a new connection if needed
+  let file = dirSvc.get('ProfD', Ci.nsIFile);
+  file.append("places.sqlite");
+  let storageService = Cc["@mozilla.org/storage/service;1"].
+                       getService(Ci.mozIStorageService);
+  try {
+    var dbConn = storageService.openDatabase(file);
+  } catch (ex) {
+    return null;
+  }
+  return dbConn;
+}
+
 // profile-after-change doesn't create components in xpcshell, so we have to do
 // it ourselves
 Cc["@mozilla.org/places/sync;1"].getService(Ci.nsISupports);
diff -r a4343d61f6ee toolkit/components/places/tests/sync/test_database_sync_after_quit_application_with_removeAllPages.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/toolkit/components/places/tests/sync/test_database_sync_after_quit_application_with_removeAllPages.js	Sat Nov 15 19:43:14 2008 -0500
@@ -0,0 +1,139 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-
+ * vim: sw=2 ts=2 sts=2 expandtab
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is mozilla.org code.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Marco Bonardo <mak77@bonardo.net> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var os = Cc["@mozilla.org/observer-service;1"].
+         getService(Ci.nsIObserverService);
+var prefs = Cc["@mozilla.org/preferences-service;1"].
+            getService(Ci.nsIPrefService).
+            getBranch("places.");
+var hs = Cc["@mozilla.org/browser/nav-history-service;1"].
+         getService(Ci.nsINavHistoryService);
+var bh = hs.QueryInterface(Ci.nsIBrowserHistory);
+var mDBConn = hs.QueryInterface(Ci.nsPIPlacesDatabase).DBConnection;
+let bs = Cc["@mozilla.org/browser/nav-bookmarks-service;1"].
+         getService(Ci.nsINavBookmarksService);
+
+const TEST_URI = "http://test.com/";
+
+const kSyncPrefName = "syncDBTableIntervalInSecs";
+const SYNC_INTERVAL = 600; // ten minutes
+const kSyncFinished = "places-sync-finished";
+const kQuitApplication = "quit-application";
+
+var historyObserver = {
+  onVisit: function(aURI, aVisitId, aTime, aSessionId, aReferringId,
+                    aTransitionType, aAdded) {
+    observer.visitId = aVisitId;
+  },
+  onClearHistory: function() {
+    // check browserHistory returns no entries
+    do_check_eq(0, bh.count);
+  }
+}
+hs.addObserver(historyObserver, false);
+
+var observer = {
+  visitId: -1,
+  _runCount: 0,
+  observe: function(aSubject, aTopic, aData) {
+    if (aTopic == kSyncFinished) {
+      // the first sync is due to the insert bookmark, timings here are really
+      // constraint, so it's better adding the observer immediately and discard
+      // first notification. Adding the observer later could result in random
+      // test failures due to the first sync being delayed.
+      if (++this._runCount < 2)
+        return;
+      // visit id must be valid
+      do_check_neq(this.visitId, -1);
+      // remove the observer, we don't need to observe sync on quit
+      os.removeObserver(this, kSyncFinished);
+      hs.removeObserver(historyObserver);
+      // Check that tables have been correctly synced
+      // Check that frecency for not cleared items (bookmarks) has been converted
+      // to -MAX(visit_count, 1), so we will be able to recalculate frecency
+      // starting from most frecent bookmarks. 
+      dump_table("moz_places_temp");
+      dump_table("moz_places");
+      stmt = mDBConn.createStatement(
+        "SELECT id FROM moz_places WHERE frecency > 0 LIMIT 1");
+      do_check_false(stmt.executeStep());
+      stmt.finalize();
+
+      stmt = mDBConn.createStatement(
+        "SELECT h.id FROM moz_places h WHERE h.frecency = -2 " +
+          "AND EXISTS (SELECT id FROM moz_bookmarks WHERE fk = h.id) LIMIT 1");
+      do_check_true(stmt.executeStep());
+      stmt.finalize();
+
+      // Check that all visit_counts have been brought to 0
+      stmt = mDBConn.createStatement(
+        "SELECT id FROM moz_places WHERE visit_count <> 0 LIMIT 1");
+      do_check_false(stmt.executeStep());
+      stmt.finalize();
+
+      finish_test();
+    }
+    else if (aTopic == kQuitApplication) {
+      // simulate a clear private data on shutdown
+      bh.removeAllPages();
+    }
+  }
+}
+os.addObserver(observer, kSyncFinished, false);
+os.addObserver(observer, kQuitApplication, false);
+
+function run_test()
+{
+  // Set the preference for the timer to a really large value, so it won't
+  // run before the test finishes.
+  prefs.setIntPref(kSyncPrefName, SYNC_INTERVAL);
+
+  // Now add a visit before creating bookmark, and one later
+  hs.addVisit(uri(TEST_URI), Date.now() * 1000, null,
+              hs.TRANSITION_TYPED, false, 0);
+  bs.insertBookmark(bs.unfiledBookmarksFolder, uri(TEST_URI),
+                    bs.DEFAULT_INDEX, "bookmark");
+  hs.addVisit(uri(TEST_URI), Date.now() * 1000, null,
+              hs.TRANSITION_TYPED, false, 0);
+
+  // Notify that we are quitting the app - we should sync!
+  os.notifyObservers(null, kQuitApplication, null);
+
+  do_test_pending();
+}
diff -r a4343d61f6ee toolkit/components/places/tests/unit/test_history.js
--- a/toolkit/components/places/tests/unit/test_history.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/places/tests/unit/test_history.js	Sat Nov 15 19:43:14 2008 -0500
@@ -85,16 +85,19 @@ function uri_in_db(aURI) {
   var result = histsvc.executeQuery(query, options);
   var root = result.root;
   root.containerOpen = true;
   return (root.childCount == 1);
 }
 
 // main
 function run_test() {
+  // we have a new profile, so we should have imported bookmarks
+  do_check_eq(histsvc.databaseStatus, histsvc.DATABASE_STATUS_CREATE);
+
   // add a visit
   var testURI = uri("http://mozilla.com");
   add_visit(testURI);
 
   // now query for the visit, setting sorting and limit such that
   // we should retrieve only the visit we just added
   var options = histsvc.getNewQueryOptions();
   options.sortingMode = options.SORT_BY_DATE_DESCENDING;
diff -r a4343d61f6ee toolkit/components/places/tests/unit/test_history_removeAllPages.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/toolkit/components/places/tests/unit/test_history_removeAllPages.js	Sat Nov 15 19:43:14 2008 -0500
@@ -0,0 +1,240 @@
+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim:set ts=2 sw=2 sts=2 et: */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Places unit test code.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Marco Bonardo <mak77@bonardo.net> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+// Enable syncing for this test
+start_sync();
+
+// Get services.
+let hs = Cc["@mozilla.org/browser/nav-history-service;1"].
+         getService(Ci.nsINavHistoryService);
+let bh = hs.QueryInterface(Ci.nsIBrowserHistory);
+let mDBConn = hs.QueryInterface(Ci.nsPIPlacesDatabase).DBConnection;
+let bs = Cc["@mozilla.org/browser/nav-bookmarks-service;1"].
+         getService(Ci.nsINavBookmarksService);
+let as = Cc["@mozilla.org/browser/annotation-service;1"].
+         getService(Ci.nsIAnnotationService);
+let os = Cc["@mozilla.org/observer-service;1"].
+         getService(Ci.nsIObserverService);
+
+const kSyncFinished = "places-sync-finished";
+
+let observer = {
+  onBeginUpdateBatch: function() {
+  },
+  onEndUpdateBatch: function() {
+  },
+  onVisit: function(aURI, aVisitID, aTime, aSessionID, aReferringID, aTransitionType) {
+  },
+  onTitleChanged: function(aURI, aPageTitle) {
+  },
+  onDeleteURI: function(aURI) {
+  },
+
+  onClearHistory: function() {
+    // check browserHistory returns no entries
+    do_check_eq(0, bh.count);
+
+    // Check that frecency for not cleared items (bookmarks) has been converted
+    // to -MAX(visit_count, 1), so we will be able to recalculate frecency
+    // starting from most frecent bookmarks. 
+    // Memory table has been updated, disk table has not
+    stmt = mDBConn.createStatement(
+      "SELECT id FROM moz_places_temp WHERE frecency > 0 LIMIT 1");
+    do_check_false(stmt.executeStep());
+    stmt.finalize();
+
+    stmt = mDBConn.createStatement(
+      "SELECT h.id FROM moz_places_temp h WHERE h.frecency = -2 " +
+        "AND EXISTS (SELECT id FROM moz_bookmarks WHERE fk = h.id) LIMIT 1");
+    do_check_true(stmt.executeStep());
+    stmt.finalize();
+
+    // Check that all visit_counts have been brought to 0
+    stmt = mDBConn.createStatement(
+      "SELECT id FROM moz_places_temp WHERE visit_count <> 0 LIMIT 1");
+    do_check_false(stmt.executeStep());
+    stmt.finalize();
+
+    // Check that history tables are empty
+    stmt = mDBConn.createStatement(
+      "SELECT * FROM (SELECT id FROM moz_historyvisits_temp LIMIT 1) " +
+      "UNION ALL " +
+      "SELECT * FROM (SELECT id FROM moz_historyvisits LIMIT 1)");
+    do_check_false(stmt.executeStep());
+    stmt.finalize();
+
+    // force a sync and check again disk tables, insertBookmark will do that
+    bs.insertBookmark(bs.unfiledBookmarksFolder, uri("place:folder=4"),
+                      bs.DEFAULT_INDEX, "shortcut");
+  },
+
+  onPageChanged: function(aURI, aWhat, aValue) {
+  },
+  onPageExpired: function(aURI, aVisitTime, aWholeEntry) {
+  },
+
+  QueryInterface: function(iid) {
+    if (iid.equals(Ci.nsINavHistoryObserver) ||
+        iid.equals(Ci.nsISupports)) {
+      return this;
+    }
+    throw Cr.NS_ERROR_NO_INTERFACE;
+  }
+}
+hs.addObserver(observer, false);
+
+let syncObserver = {
+  _runCount: 0,
+  observe: function (aSubject, aTopic, aData) {
+    if (++this._runCount < 2)
+      return;
+    if (this._runCount == 2) {
+      bh.removeAllPages();
+      return;
+    }
+
+    // Sanity: check that places temp table is empty
+    stmt = mDBConn.createStatement(
+      "SELECT id FROM moz_places_temp LIMIT 1");
+    do_check_false(stmt.executeStep());
+    stmt.finalize();
+
+    // Check that frecency for not cleared items (bookmarks) has been converted
+    // to -MAX(visit_count, 1), so we will be able to recalculate frecency
+    // starting from most frecent bookmarks.
+    stmt = mDBConn.createStatement(
+      "SELECT id FROM moz_places WHERE frecency > 0 LIMIT 1");
+    do_check_false(stmt.executeStep());
+    stmt.finalize();
+
+    stmt = mDBConn.createStatement(
+      "SELECT h.id FROM moz_places h WHERE h.frecency = -2 " +
+        "AND EXISTS (SELECT id FROM moz_bookmarks WHERE fk = h.id) LIMIT 1");
+    do_check_true(stmt.executeStep());
+    stmt.finalize();
+
+    // Check that all visit_counts have been brought to 0
+    stmt = mDBConn.createStatement(
+      "SELECT id FROM moz_places WHERE visit_count <> 0 LIMIT 1");
+    do_check_false(stmt.executeStep());
+    stmt.finalize();
+
+
+    // Check that all moz_places entries except bookmarks and place: have been removed
+    stmt = mDBConn.createStatement(
+      "SELECT h.id FROM moz_places h WHERE SUBSTR(h.url,0,6) <> 'place:' "+
+        "AND NOT EXISTS (SELECT id FROM moz_bookmarks WHERE fk = h.id) LIMIT 1");
+    do_check_false(stmt.executeStep());
+    stmt.finalize();
+
+    // Check that we only have favicons for retained places
+    stmt = mDBConn.createStatement(
+      "SELECT f.id FROM moz_favicons f WHERE NOT EXISTS " +
+        "(SELECT id FROM moz_places WHERE favicon_id = f.id) LIMIT 1");
+    do_check_false(stmt.executeStep());
+    stmt.finalize();
+
+    // Check that we only have annotations for retained places
+    stmt = mDBConn.createStatement(
+      "SELECT a.id FROM moz_annos a WHERE NOT EXISTS " +
+        "(SELECT id FROM moz_places WHERE id = a.place_id) LIMIT 1");
+    do_check_false(stmt.executeStep());
+    stmt.finalize();
+
+    // Check that we only have inputhistory for retained places
+    stmt = mDBConn.createStatement(
+      "SELECT i.place_id FROM moz_inputhistory i WHERE NOT EXISTS " +
+        "(SELECT id FROM moz_places WHERE id = i.place_id) LIMIT 1");
+    do_check_false(stmt.executeStep());
+    stmt.finalize();
+
+    // Check that place:uris have frecency 0
+    stmt = mDBConn.createStatement(
+      "SELECT h.id FROM moz_places h " +
+      "WHERE SUBSTR(h.url,0,6) = 'place:' AND h.frecency <> 0 LIMIT 1");
+    do_check_false(stmt.executeStep());
+    stmt.finalize();
+
+    finish_test();
+  }
+}
+os.addObserver(syncObserver, kSyncFinished, false);
+
+
+// main
+function run_test() {
+  // Add a bunch of visits
+  hs.addVisit(uri("http://typed.mozilla.org"), Date.now(), null,
+              hs.TRANSITION_TYPED, false, 0);
+
+  hs.addVisit(uri("http://link.mozilla.org"), Date.now(), null,
+              hs.TRANSITION_LINK, false, 0);
+  hs.addVisit(uri("http://download.mozilla.org"), Date.now(), null,
+              hs.TRANSITION_DOWNLOAD, false, 0);
+  hs.addVisit(uri("http://invalid.mozilla.org"), Date.now(), null,
+              0, false, 0); // invalid transition
+  hs.addVisit(uri("http://redir_temp.mozilla.org"), Date.now(),
+              uri("http://link.mozilla.org"), hs.TRANSITION_REDIRECT_TEMPORARY,
+              true, 0);
+  hs.addVisit(uri("http://redir_perm.mozilla.org"), Date.now(),
+              uri("http://link.mozilla.org"), hs.TRANSITION_REDIRECT_PERMANENT,
+              true, 0);
+
+  // add a place: bookmark
+  bs.insertBookmark(bs.unfiledBookmarksFolder, uri("place:folder=4"),
+                    bs.DEFAULT_INDEX, "shortcut");
+  
+  // Add an expire never annotation
+  // Actually expire never annotations are removed as soon as a page is removed
+  // from the database, so this should act as a normal visit.
+  as.setPageAnnotation(uri("http://download.mozilla.org"), "never", "never", 0,
+                       as.EXPIRE_NEVER);
+
+  // Add a bookmark
+  // Bookmarked page should have history cleared and frecency = -old_visit_count
+  // This will also finally sync temp tables to disk
+  bs.insertBookmark(bs.unfiledBookmarksFolder, uri("http://typed.mozilla.org"),
+                    bs.DEFAULT_INDEX, "bookmark");
+
+  // this visit is not synced to disk
+  hs.addVisit(uri("http://typed.mozilla.org"), Date.now(), null,
+              hs.TRANSITION_BOOKMARK, false, 0);
+
+  do_test_pending();
+}
diff -r a4343d61f6ee toolkit/components/places/tests/unit/test_nsPIPlacesDatabase_commitPendingChanges.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/toolkit/components/places/tests/unit/test_nsPIPlacesDatabase_commitPendingChanges.js	Sat Nov 15 19:43:14 2008 -0500
@@ -0,0 +1,75 @@
+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim:set ts=2 sw=2 sts=2 et: */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Places Unit Test Code.
+ *
+ * The Initial Developer of the Original Code is Mozilla Corp.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *  Marco Bonardo <mak77bonardo.net> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var hs = Cc["@mozilla.org/browser/nav-history-service;1"].
+         getService(Ci.nsINavHistoryService);
+var pip = hs.QueryInterface(Ci.nsPIPlacesDatabase);
+var mDBConn = pip.DBConnection;
+var gh = hs.QueryInterface(Ci.nsIGlobalHistory2);
+var iconsvc = Cc["@mozilla.org/browser/favicon-service;1"].
+              getService(Ci.nsIFaviconService);
+
+const TEST_URI = "http://www.mozilla.org/";
+const TEST_TITLE = "testTitle";
+
+// main
+function run_test() {
+  var testURI = uri(TEST_URI);
+  var faviconURI = uri(TEST_URI + "favicon.ico");
+
+  // Add a uri lazy message
+  gh.addURI(testURI, false, true, null);
+  // Add a favicon lazy message
+  iconsvc.setFaviconUrlForPage(testURI, faviconURI);
+  // Add a title lazy message
+  hs.setPageTitle(testURI, TEST_TITLE);
+
+  // Commit all pending changes (lazy messages)
+  pip.commitPendingChanges();
+
+  // Check database values, we can't use APIs because them would check
+  // lazy queue.
+  let stmt = mDBConn.createStatement(
+    "SELECT id FROM moz_places_temp WHERE url = :url AND title = :title " +
+      "AND favicon_id = (SELECT id FROM moz_favicons WHERE url = :favicon_url)");
+  stmt.params["url"] = testURI.spec;
+  stmt.params["title"] = TEST_TITLE;
+  stmt.params["favicon_url"] = faviconURI.spec;
+  do_check_true(stmt.executeStep());
+  stmt.finalize();
+}
diff -r a4343d61f6ee toolkit/components/places/tests/unit/test_nsPIPlacesDatabase_finalizeInternalStatements.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/toolkit/components/places/tests/unit/test_nsPIPlacesDatabase_finalizeInternalStatements.js	Sat Nov 15 19:43:14 2008 -0500
@@ -0,0 +1,49 @@
+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim:set ts=2 sw=2 sts=2 et: */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Places Unit Test Code.
+ *
+ * The Initial Developer of the Original Code is Mozilla Corp.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *  Marco Bonardo <mak77bonardo.net> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+// main
+function run_test() {
+  var hs = Cc["@mozilla.org/browser/nav-history-service;1"].
+           getService(Ci.nsINavHistoryService);
+
+  var mDBConn = hs.QueryInterface(Ci.nsPIPlacesDatabase).DBConnection;
+
+  hs.QueryInterface(Ci.nsPIPlacesDatabase).finalizeInternalStatements();
+  mDBConn.close();
+  do_check_false(mDBConn.connectionReady);
+}
diff -r a4343d61f6ee toolkit/components/satchel/public/nsIFormHistory.idl
--- a/toolkit/components/satchel/public/nsIFormHistory.idl	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/satchel/public/nsIFormHistory.idl	Sat Nov 15 19:43:14 2008 -0500
@@ -32,29 +32,30 @@
  * and other provisions required by the GPL or the LGPL. If you do not delete
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 #include "nsISupports.idl"
 interface nsIFile;
+interface mozIStorageConnection;
 
 /**
  * The nsIFormHistory object is a service which holds a set of name/value
  * pairs.  The names correspond to form field names, and the values correspond
  * to values the user has submitted.  So, several values may exist for a single
  * name.
  *
  * Note: this interface provides no means to access stored values.
  * Stored values are used by the FormFillController to generate
  * autocomplete matches.
  */
 
-[scriptable, uuid(a61f0a62-ae0a-4382-b474-d259442ca80c)]
+[scriptable, uuid(d73f5924-3e39-4c67-8f4a-290b85448480)]
 interface nsIFormHistory2 : nsISupports
 {
   /**
    * Returns true if the form history has any entries.
    */
   readonly attribute boolean hasEntries;
   
   /**
@@ -81,16 +82,21 @@ interface nsIFormHistory2 : nsISupports
    * Returns true if there is no entry that is paired with a name.
    */
   boolean nameExists(in AString name);
 
   /**
    * Gets whether a name and value pair exists in the form history.
    */
   boolean entryExists(in AString name, in AString value);
+
+  /**
+   * Returns the underlying DB connection the form history module is using.
+   */
+  readonly attribute mozIStorageConnection DBConnection;
 };
 
 /**
  * nsIFormHistoryImporter is an interface for importing a Mork formhistory.dat
  * file into the new form history storage.
  */
 
 [scriptable, uuid(9e811188-6a5b-4d96-a92d-1bac66a41898)]
diff -r a4343d61f6ee toolkit/components/satchel/src/nsFormHistory.cpp
--- a/toolkit/components/satchel/src/nsFormHistory.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/satchel/src/nsFormHistory.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -208,16 +208,22 @@ nsFormHistory::RemoveAllEntries()
   nsresult rv = RemoveEntriesInternal(nsnull);
 
   if (NS_SUCCEEDED(rv))
     rv = InitByteOrder(PR_TRUE);
   
   rv |= Flush();
   
   return rv;
+}
+
+NS_IMETHODIMP
+nsFormHistory::GetDBConnection()
+{
+  return NS_ERROR_NOT_IMPLEMENTED;
 }
 
 ////////////////////////////////////////////////////////////////////////
 //// nsIObserver
 
 NS_IMETHODIMP
 nsFormHistory::Observe(nsISupports *aSubject, const char *aTopic, const PRUnichar *aData) 
 {
diff -r a4343d61f6ee toolkit/components/satchel/src/nsStorageFormHistory.cpp
--- a/toolkit/components/satchel/src/nsStorageFormHistory.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/satchel/src/nsStorageFormHistory.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -19,16 +19,17 @@
  * Portions created by the Initial Developer are Copyright (C) 1998
  * the Initial Developer. All Rights Reserved.
  *
  * Contributor(s):
  *   Joe Hewitt <hewitt@netscape.com> (Original Author)
  *   Brett Wilson <brettw@gmail.com>
  *   Michael Ventnor <m.ventnor@gmail.com>
  *   Ehsan Akhgari <ehsan.akhgari@gmail.com>
+ *   Justin Dolske <dolske@mozilla.com>
  *
  * Alternatively, the contents of this file may be used under the terms of
  * either the GNU General Public License Version 2 or later (the "GPL"), or
  * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
  * in which case the provisions of the GPL or the LGPL are applicable instead
  * of those above. If you wish to allow use of your version of this file only
  * under the terms of either the GPL or the LGPL, and not to allow others to
  * use your version of this file under the terms of the MPL, indicate your
@@ -70,16 +71,22 @@
 // can be cached in memory. Normally, pages are 1K unless the size has been
 // explicitly changed.
 //
 // 4MB should be much larger than normal form histories. Normal form histories
 // will be several hundered KB at most. If the form history is smaller, the
 // extra memory will never be allocated, so there is no penalty for larger
 // numbers. See StartCache
 #define DATABASE_CACHE_PAGES 4000
+
+#define DB_SCHEMA_VERSION   1
+#define DB_FILENAME         NS_LITERAL_STRING("formhistory.sqlite")
+#define DB_CORRUPT_FILENAME NS_LITERAL_STRING("formhistory.sqlite.corrupt")
+
+#define PR_HOURS (60 * 60 * 1000000)
 
 // nsFormHistoryResult is a specialized autocomplete result class that knows
 // how to remove entries from the form history table.
 class nsFormHistoryResult : public nsIAutoCompleteSimpleResult
 {
 public:
   nsFormHistoryResult(const nsAString &aFieldName)
     : mFieldName(aFieldName) {}
@@ -175,18 +182,36 @@ nsFormHistory::~nsFormHistory()
   NS_ASSERTION(gFormHistory == this,
                "nsFormHistory must be used as a service");
   gFormHistory = nsnull;
 }
 
 nsresult
 nsFormHistory::Init()
 {
-  nsresult rv = OpenDatabase();
+  PRBool doImport = PR_FALSE;
+
+  nsresult rv = OpenDatabase(&doImport);
   NS_ENSURE_SUCCESS(rv, rv);
+
+#ifdef MOZ_MORKREADER
+  if (doImport) {
+    // Locate the old formhistory.dat file and import it.
+    nsCOMPtr<nsIFile> historyFile;
+    rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,
+                                getter_AddRefs(historyFile));
+    if (NS_SUCCEEDED(rv)) {
+      historyFile->Append(NS_LITERAL_STRING("formhistory.dat"));
+
+      nsCOMPtr<nsIFormHistoryImporter> importer = new nsFormHistoryImporter();
+      NS_ENSURE_TRUE(importer, NS_ERROR_OUT_OF_MEMORY);
+      importer->ImportFormHistory(historyFile, this);
+    }
+  }
+#endif
 
   nsCOMPtr<nsIObserverService> service = do_GetService("@mozilla.org/observer-service;1");
   if (service)
     service->AddObserver(this, NS_EARLYFORMSUBMIT_SUBJECT, PR_TRUE);
 
   return NS_OK;
 }
 
@@ -235,46 +260,88 @@ nsFormHistory::AddEntry(const nsAString 
   if (pbs)
     pbs->GetPrivateBrowsingEnabled(&inPrivateBrowsing);
   if (inPrivateBrowsing)
     return NS_OK;
 
   if (!FormHistoryEnabled())
     return NS_OK;
 
-  PRBool exists = PR_TRUE;
-  EntryExists(aName, aValue, &exists);
-  if (!exists) {
-    mozStorageStatementScoper scope(mDBInsertNameValue);
-    nsresult rv = mDBInsertNameValue->BindStringParameter(0, aName);
+  nsresult rv;
+  PRInt64 existingID = GetExistingEntryID(aName, aValue);
+
+  if (existingID != -1) {
+    mozStorageStatementScoper scope(mDBUpdateEntry);
+    // lastUsed
+    rv = mDBUpdateEntry->BindInt64Parameter(0, PR_Now());
+    NS_ENSURE_SUCCESS(rv, rv);
+    // WHERE id
+    rv = mDBUpdateEntry->BindInt64Parameter(1, existingID);
     NS_ENSURE_SUCCESS(rv, rv);
 
+    rv = mDBUpdateEntry->Execute();
+    NS_ENSURE_SUCCESS(rv, rv);
+  } else {
+    PRInt64 now = PR_Now();
+
+    mozStorageStatementScoper scope(mDBInsertNameValue);
+    // fieldname
+    rv = mDBInsertNameValue->BindStringParameter(0, aName);
+    NS_ENSURE_SUCCESS(rv, rv);
+    // value
     rv = mDBInsertNameValue->BindStringParameter(1, aValue);
+    NS_ENSURE_SUCCESS(rv, rv);
+    // timesUsed
+    rv = mDBInsertNameValue->BindInt32Parameter(2, 1);
+    NS_ENSURE_SUCCESS(rv, rv);
+    // firstUsed
+    rv = mDBInsertNameValue->BindInt64Parameter(3, now);
+    NS_ENSURE_SUCCESS(rv, rv);
+    // lastUsed
+    rv = mDBInsertNameValue->BindInt64Parameter(4, now);
     NS_ENSURE_SUCCESS(rv, rv);
 
     rv = mDBInsertNameValue->Execute();
     NS_ENSURE_SUCCESS(rv, rv);
   }
   return NS_OK;
 }
 
+/* Returns -1 if entry not found, or the ID if it was. */
+PRInt64
+nsFormHistory::GetExistingEntryID (const nsAString &aName, 
+                                   const nsAString &aValue)
+{
+  mozStorageStatementScoper scope(mDBFindEntry);
+
+  nsresult rv = mDBFindEntry->BindStringParameter(0, aName);
+  NS_ENSURE_SUCCESS(rv, -1);
+
+  rv = mDBFindEntry->BindStringParameter(1, aValue);
+  NS_ENSURE_SUCCESS(rv, -1);
+
+  PRBool hasMore;
+  rv = mDBFindEntry->ExecuteStep(&hasMore);
+  NS_ENSURE_SUCCESS(rv, -1);
+
+  PRInt64 ID = -1;
+  if (hasMore) {
+    mDBFindEntry->GetInt64(0, &ID);
+    NS_ENSURE_SUCCESS(rv, -1);
+  }
+
+  return ID;
+}
+
 NS_IMETHODIMP
 nsFormHistory::EntryExists(const nsAString &aName, 
                            const nsAString &aValue, PRBool *_retval)
 {
-  mozStorageStatementScoper scope(mDBFindEntry);
-
-  nsresult rv = mDBFindEntry->BindStringParameter(0, aName);
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  rv = mDBFindEntry->BindStringParameter(1, aValue);
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  PRBool hasMore;
-  *_retval = NS_SUCCEEDED(mDBFindEntry->ExecuteStep(&hasMore)) && hasMore;
+  PRInt64 ID = GetExistingEntryID(aName, aValue);
+  *_retval = ID != -1;
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsFormHistory::NameExists(const nsAString &aName, PRBool *_retval)
 {
   mozStorageStatementScoper scope(mDBFindEntryByName);
 
@@ -339,16 +406,24 @@ nsFormHistory::RemoveAllEntries()
   if (NS_SUCCEEDED(oldFormHistoryFile->Exists(&fileExists)) && fileExists) {
     rv = oldFormHistoryFile->Remove(PR_FALSE);
     NS_ENSURE_SUCCESS(rv, rv);
   }
 
   return dbDeleteAll->Execute();
 }
 
+
+NS_IMETHODIMP
+nsFormHistory::GetDBConnection(mozIStorageConnection **aResult)
+{
+  NS_ADDREF(*aResult = mDBConn);
+  return NS_OK;
+}
+
 ////////////////////////////////////////////////////////////////////////
 //// nsIObserver
 
 NS_IMETHODIMP
 nsFormHistory::Observe(nsISupports *aSubject, const char *aTopic, const PRUnichar *aData) 
 {
   if (!strcmp(aTopic, NS_PREFBRANCH_PREFCHANGE_TOPIC_ID)) {
     mPrefBranch->GetBoolPref(PREF_FORMFILL_ENABLE, &gFormHistoryEnabled);
@@ -410,18 +485,78 @@ nsFormHistory::Notify(nsIDOMHTMLFormElem
             AddEntry(name, value);
         }
       }
     }
   }
 
   return transaction.Commit();
 }
+
 nsresult
-nsFormHistory::OpenDatabase()
+nsFormHistory::CreateTable()
+{
+  nsresult rv;
+  rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+         "CREATE TABLE moz_formhistory ("
+           "id INTEGER PRIMARY KEY, fieldname TEXT NOT NULL, "
+           "value TEXT NOT NULL, timesUsed INTEGER NOT NULL, "
+           "firstUsed INTEGER NOT NULL, lastUsed INTEGER NOT NULL)"));
+  NS_ENSURE_SUCCESS(rv, rv);
+  rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING("CREATE INDEX moz_formhistory_index ON moz_formhistory (fieldname)"));
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  rv = mDBConn->SetSchemaVersion(DB_SCHEMA_VERSION);
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  return NS_OK;
+}
+
+nsresult
+nsFormHistory::CreateStatements()
+{
+  nsresult rv;
+  rv  = mDBConn->CreateStatement(NS_LITERAL_CSTRING(
+         "SELECT * FROM moz_formhistory"),
+         getter_AddRefs(mDBSelectEntries));
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING(
+         "SELECT id FROM moz_formhistory WHERE fieldname=?1 AND value=?2"),
+         getter_AddRefs(mDBFindEntry));
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING(
+         "SELECT * FROM moz_formhistory WHERE fieldname=?1"),
+         getter_AddRefs(mDBFindEntryByName));
+  NS_ENSURE_SUCCESS(rv,rv);
+
+  rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING(
+        "SELECT value FROM moz_formhistory WHERE fieldname=?1 ORDER BY value ASC"),
+        getter_AddRefs(mDBGetMatchingField));
+  NS_ENSURE_SUCCESS(rv,rv);
+
+  rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING(
+        "INSERT INTO moz_formhistory (fieldname, value, timesUsed, "
+        "firstUsed, lastUsed) VALUES (?1, ?2, ?3, ?4, ?5)"),
+        getter_AddRefs(mDBInsertNameValue));
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING(
+        "UPDATE moz_formhistory "
+        "SET timesUsed=timesUsed + 1, lastUsed=?1 "
+        "WHERE id = ?2"),
+        getter_AddRefs(mDBUpdateEntry));
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  return NS_OK;
+}
+
+nsresult
+nsFormHistory::OpenDatabase(PRBool *aDoImport)
 {
   // init DB service and obtain a connection
   nsresult rv;
   mStorageService = do_GetService(MOZ_STORAGE_SERVICE_CONTRACTID, &rv);
   NS_ENSURE_SUCCESS(rv, rv);
 
   nsCOMPtr<nsIFile> formHistoryFile;
   rv = GetDatabaseFile(getter_AddRefs(formHistoryFile));
@@ -440,74 +575,130 @@ nsFormHistory::OpenDatabase()
   // the dummy statement--see StartCache). This transaction will keep the cache
   // between these statements, which should improve startup performance because
   // we won't have to keep requesting pages from the OS.
   mozStorageTransaction transaction(mDBConn, PR_FALSE);
 
   PRBool exists;
   mDBConn->TableExists(NS_LITERAL_CSTRING("moz_formhistory"), &exists);
   if (!exists) {
-    rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING("CREATE TABLE moz_formhistory (id INTEGER PRIMARY KEY, fieldname LONGVARCHAR, value LONGVARCHAR)"));
-    NS_ENSURE_SUCCESS(rv, rv);
-    rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING("CREATE INDEX moz_formhistory_index ON moz_formhistory (fieldname)"));
+    *aDoImport = PR_TRUE;
+    rv = CreateTable();
     NS_ENSURE_SUCCESS(rv, rv);
   }
 
-  rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING("SELECT * FROM moz_formhistory"),
-                                getter_AddRefs(mDBSelectEntries));
+  PRInt32 schemaVersion;
+  rv = mDBConn->GetSchemaVersion(&schemaVersion);
   NS_ENSURE_SUCCESS(rv, rv);
 
-  rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING("SELECT * FROM moz_formhistory WHERE fieldname=?1 AND value=?2"),
-                                getter_AddRefs(mDBFindEntry));
-  NS_ENSURE_SUCCESS(rv, rv);
+  // Changing the database?  Be sure to do these two things!
+  // 1) Increment DB_SCHEMA_VERSION
+  // 2) Implement the proper downgrade/upgrade code for the current version
 
-  rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING("SELECT * FROM moz_formhistory WHERE fieldname=?1"),
-                                getter_AddRefs(mDBFindEntryByName));
-  NS_ENSURE_SUCCESS(rv,rv);
+  switch (schemaVersion) {
+  case 0:
+    {
+      mozStorageTransaction stepTransaction(mDBConn, PR_FALSE);
 
-  rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING("SELECT value FROM moz_formhistory WHERE fieldname=?1 ORDER BY value ASC"),
-                                getter_AddRefs(mDBGetMatchingField));
-  NS_ENSURE_SUCCESS(rv,rv);
+      // The formhistory.sqlite in Firefox 3 didn't have a schema version set
+      NS_WARNING("Could not get formhistory database's schema version!");
 
-  rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING("INSERT INTO moz_formhistory (fieldname, value) VALUES (?1, ?2)"),
-                                getter_AddRefs(mDBInsertNameValue));
-  NS_ENSURE_SUCCESS(rv, rv);
+      // Add columns for timestamps and use counts (bug 463154)
+      rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+        "ALTER TABLE moz_formhistory ADD COLUMN timesUsed INTEGER"));
+      NS_ENSURE_SUCCESS(rv, rv);
+      rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+        "ALTER TABLE moz_formhistory ADD COLUMN firstUsed INTEGER"));
+      NS_ENSURE_SUCCESS(rv, rv);
+      rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+        "ALTER TABLE moz_formhistory ADD COLUMN lastUsed INTEGER"));
+      NS_ENSURE_SUCCESS(rv, rv);
 
+      // Set the default values for the new columns.
+      //
+      // Note that we set the timestamps to 24 hours in the past. We want a
+      // timestamp that's recent (so that "keep form history for 90 days"
+      // doesn't expire things surprisingly soon), but not so recent that
+      // "forget the last hour of stuff" deletes all freshly migrated data.
+      nsCOMPtr<mozIStorageStatement> addDefaultValues;
+      rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING(
+        "UPDATE moz_formhistory "
+        "SET timesUsed=1, firstUsed=?1, lastUsed=?1"),
+        getter_AddRefs(addDefaultValues));
+      rv = addDefaultValues->BindInt64Parameter(0, PR_Now() - 24 * PR_HOURS);
+      NS_ENSURE_SUCCESS(rv, rv);
+
+      rv = addDefaultValues->Execute();
+      NS_ENSURE_SUCCESS(rv, rv);
+
+      rv = mDBConn->SetSchemaVersion(DB_SCHEMA_VERSION);
+      NS_ENSURE_SUCCESS(rv, rv);
+
+      rv = stepTransaction.Commit();
+      NS_ENSURE_SUCCESS(rv, rv);
+    }
+    // Fallthrough to the next upgrade
+
+  // Extra sanity checking for developers
+#ifndef DEBUG
+  case DB_SCHEMA_VERSION:
+#endif
+    break;
+
+  // Downgrades (and DEBUG build sanity checking)... Ensure that all the
+  // columns we're expecting are present, backup and reinit if not.
+  default:
+    {
+      // If the statement succeeds, all the columns are there.
+      nsCOMPtr<mozIStorageStatement> stmt;
+      rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING(
+        "SELECT fieldname, value, timesUsed, firstUsed, lastUsed "
+        "FROM moz_formhistory"), getter_AddRefs(stmt));
+      if (NS_SUCCEEDED(rv))
+        break;
+
+      // Columns are screwy. Backup the DB, nuke it, start anew.
+      nsCOMPtr<mozIStorageService> storage =
+        do_GetService(MOZ_STORAGE_SERVICE_CONTRACTID);
+      NS_ENSURE_TRUE(storage, NS_ERROR_NOT_AVAILABLE);
+
+      nsCOMPtr<nsIFile> backupFile;
+      rv = storage->BackupDatabaseFile(formHistoryFile, DB_CORRUPT_FILENAME,
+                                       nsnull, getter_AddRefs(backupFile));
+      NS_ENSURE_SUCCESS(rv, rv);
+
+      rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+        "DROP TABLE moz_formhistory"));
+      NS_ENSURE_SUCCESS(rv, rv);
+
+      rv = CreateTable();
+      NS_ENSURE_SUCCESS(rv, rv);
+    }
+    break;
+  }
+  
   // should commit before starting cache
   transaction.Commit();
 
   // ignore errors since the cache is not critical for operation
   StartCache();
 
-#ifdef MOZ_MORKREADER
-  if (!exists) {
-    // Locate the old formhistory.dat file and import it.
-    nsCOMPtr<nsIFile> historyFile;
-    rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,
-                                getter_AddRefs(historyFile));
-    if (NS_SUCCEEDED(rv)) {
-      historyFile->Append(NS_LITERAL_STRING("formhistory.dat"));
-
-      nsCOMPtr<nsIFormHistoryImporter> importer = new nsFormHistoryImporter();
-      NS_ENSURE_TRUE(importer, NS_ERROR_OUT_OF_MEMORY);
-      importer->ImportFormHistory(historyFile, this);
-    }
-  }
-#endif
+  rv = CreateStatements();
+  NS_ENSURE_SUCCESS(rv, rv);
 
   return NS_OK;
 }
 
 
 nsresult
 nsFormHistory::GetDatabaseFile(nsIFile** aFile)
 {
   nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR, aFile);
   NS_ENSURE_SUCCESS(rv, rv);
-  return (*aFile)->Append(NS_LITERAL_STRING("formhistory.sqlite"));
+  return (*aFile)->Append(DB_FILENAME);
 }
 
 
 // nsFormHistory::StartCache
 //
 //    This function starts the dummy statement that locks the cache in memory.
 //    As long as there is an open connection sharing the same cache, the cache
 //    won't be expired. Therefore, we create a dummy table with some data in
diff -r a4343d61f6ee toolkit/components/satchel/src/nsStorageFormHistory.h
--- a/toolkit/components/satchel/src/nsStorageFormHistory.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/satchel/src/nsStorageFormHistory.h	Sat Nov 15 19:43:14 2008 -0500
@@ -108,32 +108,38 @@ public:
                               nsIAutoCompleteSimpleResult *aPrevResult,
 			      nsIAutoCompleteResult **aNewResult);
 
  private:
   ~nsFormHistory();
 
  protected:
   // Database I/O
-  nsresult OpenDatabase();
+  nsresult OpenDatabase(PRBool *aDoImport);
   nsresult CloseDatabase();
   nsresult GetDatabaseFile(nsIFile** aFile);
+
+  nsresult CreateTable();
+  nsresult CreateStatements();
 
   static PRBool FormHistoryEnabled();
   static nsFormHistory *gFormHistory;
   static PRBool gFormHistoryEnabled;
   static PRBool gPrefsInitialized;
+
+  PRInt64 GetExistingEntryID(const nsAString &aName, const nsAString &aValue);
 
   nsCOMPtr<nsIPrefBranch> mPrefBranch;
   nsCOMPtr<mozIStorageService> mStorageService;
   nsCOMPtr<mozIStorageStatement> mDBGetMatchingField;
   nsCOMPtr<mozIStorageStatement> mDBFindEntry;
   nsCOMPtr<mozIStorageStatement> mDBFindEntryByName;
   nsCOMPtr<mozIStorageStatement> mDBSelectEntries;
   nsCOMPtr<mozIStorageStatement> mDBInsertNameValue;
+  nsCOMPtr<mozIStorageStatement> mDBUpdateEntry;
 
   // dummy statement (see StartCache)
   nsresult StartCache();
   nsresult StopCache();
   nsCOMPtr<mozIStorageConnection> mDummyConnection;
   nsCOMPtr<mozIStorageStatement> mDummyStatement;
 };
 
diff -r a4343d61f6ee toolkit/components/satchel/test/unit/formhistory_CORRUPT.sqlite
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/toolkit/components/satchel/test/unit/formhistory_CORRUPT.sqlite	Sat Nov 15 19:43:14 2008 -0500
@@ -0,0 +1,1 @@
+BACON
diff -r a4343d61f6ee toolkit/components/satchel/test/unit/formhistory_v0.sqlite
Binary file toolkit/components/satchel/test/unit/formhistory_v0.sqlite has changed
diff -r a4343d61f6ee toolkit/components/satchel/test/unit/formhistory_v999a.sqlite
Binary file toolkit/components/satchel/test/unit/formhistory_v999a.sqlite has changed
diff -r a4343d61f6ee toolkit/components/satchel/test/unit/formhistory_v999b.sqlite
Binary file toolkit/components/satchel/test/unit/formhistory_v999b.sqlite has changed
diff -r a4343d61f6ee toolkit/components/satchel/test/unit/head_satchel.js
--- a/toolkit/components/satchel/test/unit/head_satchel.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/satchel/test/unit/head_satchel.js	Sat Nov 15 19:43:14 2008 -0500
@@ -68,11 +68,11 @@ if (!profileDir) {
   };
   dirSvc.QueryInterface(Ci.nsIDirectoryService).registerProvider(provider);
 }
 
 function cleanUpFormHist() {
   var formhistFile = dirSvc.get("ProfD", Ci.nsIFile);
   formhistFile.append("formhistory.dat");
   if (formhistFile.exists())
-    formhistFile.remove();
+    formhistFile.remove(false);
 }
 cleanUpFormHist();
diff -r a4343d61f6ee toolkit/components/satchel/test/unit/test_db_corrupt.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/toolkit/components/satchel/test/unit/test_db_corrupt.js	Sat Nov 15 19:43:14 2008 -0500
@@ -0,0 +1,85 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Satchel Test Code.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Justin Dolske <dolske@mozilla.com> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+function run_test()
+{
+  try {
+  var testnum = 0;
+
+  // ===== test init =====
+  var testfile = do_get_file("toolkit/components/satchel/test/unit/formhistory_CORRUPT.sqlite");
+  var profileDir = dirSvc.get("ProfD", Ci.nsIFile);
+
+  // Cleanup from any previous tests or failures.
+  var destFile = profileDir.clone();
+  destFile.append("formhistory.sqlite");
+  if (destFile.exists())
+    destFile.remove(false);
+
+  testfile.copyTo(profileDir, "formhistory.sqlite");
+
+  var fh = Cc["@mozilla.org/satchel/form-history;1"].
+           getService(Ci.nsIFormHistory2);
+
+
+  // ===== 1 =====
+  testnum++;
+  // File should be empty
+  do_check_false(fh.hasEntries);
+  do_check_false(fh.entryExists("name-A", "value-A"));
+
+
+  // ===== 2 =====
+  testnum++;
+  // Try adding an entry
+  fh.addEntry("name-A", "value-A");
+  do_check_true(fh.hasEntries);
+  do_check_true(fh.entryExists("name-A", "value-A"));
+
+
+  // ===== 3 =====
+  testnum++;
+  // Try removing an entry
+  fh.removeEntry("name-A", "value-A");
+  do_check_false(fh.hasEntries);
+  do_check_false(fh.entryExists("name-A", "value-A"));
+
+
+  } catch (e) {
+    throw "FAILED in test #" + testnum + " -- " + e;
+  }
+}
diff -r a4343d61f6ee toolkit/components/satchel/test/unit/test_db_update_v1.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/toolkit/components/satchel/test/unit/test_db_update_v1.js	Sat Nov 15 19:43:14 2008 -0500
@@ -0,0 +1,151 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Satchel Test Code.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Justin Dolske <dolske@mozilla.com> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+// Returns true if the timestamp is within 30 seconds of now.
+function is_about_now(timestamp) {
+  var delta = Math.abs(timestamp - 1000 * Date.now());
+  var seconds = 30 * 1000000;
+  return delta < seconds;
+}
+
+var testnum = 0;
+var fh;
+var timesUsed, firstUsed, lastUsed;
+
+function run_test()
+{
+  try {
+
+  // ===== test init =====
+  var testfile = do_get_file("toolkit/components/satchel/test/unit/formhistory_v0.sqlite");
+  var profileDir = dirSvc.get("ProfD", Ci.nsIFile);
+
+  // Cleanup from any previous tests or failures.
+  var destFile = profileDir.clone();
+  destFile.append("formhistory.sqlite");
+  if (destFile.exists())
+    destFile.remove(false);
+
+  testfile.copyTo(profileDir, "formhistory.sqlite");
+
+  fh = Cc["@mozilla.org/satchel/form-history;1"].
+       getService(Ci.nsIFormHistory2);
+
+
+  // ===== 1 =====
+  testnum++;
+  // Check for expected contents.
+  do_check_true(fh.entryExists("name-A", "value-A"));
+  do_check_true(fh.entryExists("name-B", "value-B"));
+  do_check_true(fh.entryExists("name-C", "value-C1"));
+  do_check_true(fh.entryExists("name-C", "value-C2"));
+
+
+  // ===== 2 =====
+  testnum++;
+  // Exercise adding and removing a name/value pair
+  do_check_false(fh.entryExists("name-D", "value-D"));
+  fh.addEntry("name-D", "value-D");
+  do_check_true(fh.entryExists("name-D", "value-D"));
+  fh.removeEntry("name-D", "value-D");
+  do_check_false(fh.entryExists("name-D", "value-D"));
+
+
+  // ===== 3 =====
+  testnum++;
+  // Add a new entry, check expected properties
+  do_check_false(fh.entryExists("name-E", "value-E"));
+  fh.addEntry("name-E", "value-E");
+  do_check_true(fh.entryExists("name-E", "value-E"));
+
+  var query = "SELECT timesUsed, firstUsed, lastUsed " +
+              "FROM moz_formhistory WHERE fieldname = 'name-E'";
+  var stmt = fh.DBConnection.createStatement(query);
+  stmt.executeStep();
+
+  timesUsed = stmt.getInt32(0);
+  firstUsed = stmt.getInt64(1);
+  lastUsed  = stmt.getInt64(2);
+
+  do_check_eq(1, timesUsed);
+  do_check_true(firstUsed == lastUsed);
+  do_check_true(is_about_now(firstUsed));
+
+  // The next test adds the entry again, and check to see that the lastUsed
+  // field is updated. Unfortunately, on Windows PR_Now() is granular
+  // (robarnold says usually 16.5ms, sometimes 10ms), so if we execute the
+  // test too soon the timestamp will be the same! So, we'll wait a short
+  // period of time to make sure the timestamp will differ.
+  do_test_pending();
+  do_timeout(50, "delayed_test()");
+
+  } catch (e) {
+    throw "FAILED in test #" + testnum + " -- " + e;
+  }
+}
+
+function delayed_test() {
+  try {
+
+  // ===== 4 =====
+  testnum++;
+  // Add entry again, check for updated properties.
+  do_check_true(fh.entryExists("name-E", "value-E"));
+  fh.addEntry("name-E", "value-E");
+  do_check_true(fh.entryExists("name-E", "value-E"));
+
+  var query = "SELECT timesUsed, firstUsed, lastUsed " +
+              "FROM moz_formhistory WHERE fieldname = 'name-E'";
+  var stmt = fh.DBConnection.createStatement(query);
+  stmt.executeStep();
+
+  timesUsed = stmt.getInt32(0);
+  var firstUsed2 = stmt.getInt64(1);
+  var lastUsed2  = stmt.getInt64(2);
+
+  do_check_eq(2, timesUsed);
+  do_check_true(is_about_now(lastUsed2));
+
+  do_check_true(firstUsed  == firstUsed2); //unchanged
+  do_check_true(lastUsed   != lastUsed2);  //changed
+  do_check_true(firstUsed2 != lastUsed2);
+
+  do_test_finished();
+  } catch (e) {
+    throw "FAILED in test #" + testnum + " -- " + e;
+  }
+}
diff -r a4343d61f6ee toolkit/components/satchel/test/unit/test_db_update_v999a.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/toolkit/components/satchel/test/unit/test_db_update_v999a.js	Sat Nov 15 19:43:14 2008 -0500
@@ -0,0 +1,91 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Satchel Test Code.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Justin Dolske <dolske@mozilla.com> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+/*
+ * This test uses a formhistory.sqlite with schema version set to 999 (a
+ * future version). This exercies the code that allows using a future schema
+ * version as long as the expected columns are present.
+ *
+ * Part A tests this when the columns do match, so the DB is used.
+ * Part B tests this when the columns do *not* match, so the DB is reset.
+ */
+
+function run_test()
+{
+  try {
+  var testnum = 0;
+
+  // ===== test init =====
+  var testfile = do_get_file("toolkit/components/satchel/test/unit/formhistory_v999a.sqlite");
+  var profileDir = dirSvc.get("ProfD", Ci.nsIFile);
+
+  // Cleanup from any previous tests or failures.
+  var destFile = profileDir.clone();
+  destFile.append("formhistory.sqlite");
+  if (destFile.exists())
+    destFile.remove(false);
+
+  testfile.copyTo(profileDir, "formhistory.sqlite");
+
+  var fh = Cc["@mozilla.org/satchel/form-history;1"].
+           getService(Ci.nsIFormHistory2);
+
+
+  // ===== 1 =====
+  testnum++;
+  // Check for expected contents.
+  do_check_true(fh.hasEntries);
+  do_check_true(fh.entryExists("name-A", "value-A"));
+  do_check_true(fh.entryExists("name-B", "value-B"));
+  do_check_true(fh.entryExists("name-C", "value-C1"));
+  do_check_true(fh.entryExists("name-C", "value-C2"));
+  do_check_true(fh.entryExists("name-E", "value-E"));
+
+
+  // ===== 2 =====
+  testnum++;
+  // Exercise adding and removing a name/value pair
+  do_check_false(fh.entryExists("name-D", "value-D"));
+  fh.addEntry("name-D", "value-D");
+  do_check_true(fh.entryExists("name-D", "value-D"));
+  fh.removeEntry("name-D", "value-D");
+  do_check_false(fh.entryExists("name-D", "value-D"));
+
+  } catch (e) {
+    throw "FAILED in test #" + testnum + " -- " + e;
+  }
+}
diff -r a4343d61f6ee toolkit/components/satchel/test/unit/test_db_update_v999b.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/toolkit/components/satchel/test/unit/test_db_update_v999b.js	Sat Nov 15 19:43:14 2008 -0500
@@ -0,0 +1,93 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Satchel Test Code.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Justin Dolske <dolske@mozilla.com> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+/*
+ * This test uses a formhistory.sqlite with schema version set to 999 (a
+ * future version). This exercies the code that allows using a future schema
+ * version as long as the expected columns are present.
+ *
+ * Part A tests this when the columns do match, so the DB is used.
+ * Part B tests this when the columns do *not* match, so the DB is reset.
+ */
+
+function run_test()
+{
+  try {
+  var testnum = 0;
+
+  // ===== test init =====
+  var testfile = do_get_file("toolkit/components/satchel/test/unit/formhistory_v999b.sqlite");
+  var profileDir = dirSvc.get("ProfD", Ci.nsIFile);
+
+  // Cleanup from any previous tests or failures.
+  var destFile = profileDir.clone();
+  destFile.append("formhistory.sqlite");
+  if (destFile.exists())
+    destFile.remove(false);
+
+  testfile.copyTo(profileDir, "formhistory.sqlite");
+
+  var fh = Cc["@mozilla.org/satchel/form-history;1"].
+           getService(Ci.nsIFormHistory2);
+
+
+  // ===== 1 =====
+  testnum++;
+  // File should be empty
+  do_check_false(fh.hasEntries);
+  do_check_false(fh.entryExists("name-A", "value-A"));
+
+
+  // ===== 2 =====
+  testnum++;
+  // Try adding an entry
+  fh.addEntry("name-A", "value-A");
+  do_check_true(fh.hasEntries);
+  do_check_true(fh.entryExists("name-A", "value-A"));
+
+
+  // ===== 3 =====
+  testnum++;
+  // Try removing an entry
+  fh.removeEntry("name-A", "value-A");
+  do_check_false(fh.hasEntries);
+  do_check_false(fh.entryExists("name-A", "value-A"));
+
+  } catch (e) {
+    throw "FAILED in test #" + testnum + " -- " + e;
+  }
+}
diff -r a4343d61f6ee toolkit/components/viewsource/content/viewSource.js
--- a/toolkit/components/viewsource/content/viewSource.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/components/viewsource/content/viewSource.js	Sat Nov 15 19:43:14 2008 -0500
@@ -251,16 +251,17 @@ function viewSource(url)
     try {
       document.getElementById("menu_highlightSyntax").setAttribute("checked", gPrefs.getBoolPref("view_source.syntax_highlight"));
     } catch (ex) {
     }
   } else {
     document.getElementById("menu_highlightSyntax").setAttribute("hidden", "true");
   }
 
+  window.addEventListener("AppCommand", HandleAppCommandEvent, true);
   window._content.focus();
 
   return true;
 }
 
 function onLoadContent()
 {
   //
@@ -280,16 +281,29 @@ function onLoadContent()
 
 function onUnloadContent()
 {
   //
   // Disable "go to line" while reloading due to e.g. change of charset
   // or toggling of syntax highlighting.
   //
   document.getElementById('cmd_goToLine').setAttribute('disabled', 'true');
+}
+
+function HandleAppCommandEvent(evt)
+{
+  evt.stopPropagation();
+  switch (evt.command) {
+    case "Back":
+      BrowserBack();
+      break;
+    case "Forward":
+      BrowserForward();
+      break;
+  }
 }
 
 function ViewSourceClose()
 {
   window.close();
 }
 
 function ViewSourceReload()
diff -r a4343d61f6ee toolkit/content/contentAreaUtils.js
--- a/toolkit/content/contentAreaUtils.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/content/contentAreaUtils.js	Sat Nov 15 19:43:14 2008 -0500
@@ -18,16 +18,17 @@
 # Netscape Communications Corporation.
 # Portions created by the Initial Developer are Copyright (C) 1998
 # the Initial Developer. All Rights Reserved.
 #
 # Contributor(s):
 #   Ben Goodger <ben@netscape.com> (Save File)
 #   Fredrik Holmqvist <thesuckiestemail@yahoo.se>
 #   Asaf Romano <mozilla.mano@sent.com>
+#   Ehsan Akhgari <ehsan.akhgari@gmail.com>
 #
 # Alternatively, the contents of this file may be used under the terms of
 # either the GNU General Public License Version 2 or later (the "GPL"), or
 # the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
 # in which case the provisions of the GPL or the LGPL are applicable instead
 # of those above. If you wish to allow use of your version of this file only
 # under the terms of either the GPL or the LGPL, and not to allow others to
 # use your version of this file under the terms of the MPL, indicate your
@@ -505,19 +506,31 @@ function getTargetFile(aFpP, aSkipPrompt
         fp.filterIndex = prefs.getIntPref("save_converter_index");
       }
       catch (e) {
       }
     }
 
     if (fp.show() == Components.interfaces.nsIFilePicker.returnCancel || !fp.file)
       return false;
-    
-    var directory = fp.file.parent.QueryInterface(nsILocalFile);
-    prefs.setComplexValue("lastDir", nsILocalFile, directory);
+
+    // Do not remember the last save directory inside the private browsing mode
+    var persistLastDir = true;
+    try {
+      var pbs = Components.classes["@mozilla.org/privatebrowsing;1"]
+                          .getService(Components.interfaces.nsIPrivateBrowsingService);
+      if (pbs.privateBrowsingEnabled)
+        persistLastDir = false;
+    }
+    catch (e) {
+    }
+    if (persistLastDir) {
+      var directory = fp.file.parent.QueryInterface(nsILocalFile);
+      prefs.setComplexValue("lastDir", nsILocalFile, directory);
+    }
 
     fp.file.leafName = validateFileName(fp.file.leafName);
     aFpP.saveAsType = fp.filterIndex;
     aFpP.file = fp.file;
     aFpP.fileURL = fp.fileURL;
 
     if (aFpP.isDocument)
       prefs.setIntPref("save_converter_index", aFpP.saveAsType);
diff -r a4343d61f6ee toolkit/content/xul.css
--- a/toolkit/content/xul.css	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/content/xul.css	Sat Nov 15 19:43:14 2008 -0500
@@ -333,17 +333,18 @@ panel {
   -moz-box-orient: vertical;
 }
 
 popup,
 menupopup,
 panel,
 tooltip {
   display: -moz-popup;
-  z-index: 2147483647; 
+  z-index: 2147483647;
+  text-shadow: none;
 }
 
 tooltip {
   -moz-binding: url("chrome://global/content/bindings/popup.xml#tooltip");
   -moz-box-orient: vertical;
   white-space: pre-wrap;
   margin-top: 21px;
 }
@@ -634,29 +635,32 @@ html|span.accesskey {
   text-decoration: underline;
 }
 
 /********** textbox **********/
 
 textbox {
   -moz-binding: url("chrome://global/content/bindings/textbox.xml#textbox");
   -moz-user-select: text;
+  text-shadow: none;
 }
 
 textbox[multiline="true"] {
   -moz-binding: url("chrome://global/content/bindings/textbox.xml#textarea");
 }
 
 html|*.textbox-input {
   -moz-appearance: none !important;
   text-align: inherit;
+  text-shadow: inherit;
 }
 
 html|*.textbox-textarea {
   -moz-appearance: none !important;
+  text-shadow: inherit;
 }
 
 .textbox-input-box {
   -moz-binding: url("chrome://global/content/bindings/textbox.xml#input-box");
 }
 
 .textbox-input-box[spellcheck="true"] {
   -moz-binding: url("chrome://global/content/bindings/textbox.xml#input-box-spell");
diff -r a4343d61f6ee toolkit/library/Makefile.in
--- a/toolkit/library/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/library/Makefile.in	Sat Nov 15 19:43:14 2008 -0500
@@ -201,17 +201,17 @@ EXTRA_DSO_LDOPTS += \
 EXTRA_DSO_LDOPTS += \
 	-framework SystemConfiguration \
 	-framework QuickTime \
 	-framework IOKit \
 	-lcrypto \
 	$(TK_LIBS) \
 	$(NULL)
 
-ifdef MOZ_OGG
+ifdef MOZ_SYDNEYAUDIO
 EXTRA_DSO_LDOPTS += \
 	-framework CoreAudio \
  	-framework AudioToolbox \
 	-framework AudioUnit \
 	$(NULL)
 endif
 endif
 
diff -r a4343d61f6ee toolkit/locales/en-US/chrome/places/places.properties
--- a/toolkit/locales/en-US/chrome/places/places.properties	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/locales/en-US/chrome/places/places.properties	Sat Nov 15 19:43:14 2008 -0500
@@ -6,13 +6,13 @@ finduri-AgeInDays-is-0=Today
 finduri-AgeInDays-is-0=Today
 finduri-AgeInDays-is-1=Yesterday
 finduri-AgeInDays-is=%S days ago
 finduri-AgeInDays-isgreater=Older than %S days
 
 localhost=(local files)
 
 # LOCALIZATION NOTE (bookmarksArchiveFilename):
-# %S will be replaced by the current date in ISO 8601 format, YYYY-MM-DD.
-# The resulting string will be suggested as a filename, so make sure that you're
-# only using characters legal for file names. Consider falling back to the
-# en-US value if you have to use non-ascii characters.
+# Do not change this string! It's used only to
+# detect older localized bookmark archives from
+# before bug 445704 was fixed. It will be removed
+# in a subsequent release.
 bookmarksArchiveFilename=bookmarks-%S.json
diff -r a4343d61f6ee toolkit/mozapps/downloads/content/downloads.js
--- a/toolkit/mozapps/downloads/content/downloads.js	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/mozapps/downloads/content/downloads.js	Sat Nov 15 19:43:14 2008 -0500
@@ -499,18 +499,24 @@ let gDownloadObserver = {
 
         // Otherwise, remove a single download
         let id = aSubject.QueryInterface(Ci.nsISupportsPRUint32);
         let dl = getDownload(id.data);
         removeFromView(dl);
         break;
       case "private-browsing":
         if (aData == "enter" || aData == "exit") {
-          initStatement();
-          buildDownloadList(true);
+          // We might get this notification before the download manager
+          // service, so the new database connection might not be ready
+          // yet.  Defer this until all private-browsing notifications
+          // have been processed.
+          setTimeout(function() {
+            initStatement();
+            buildDownloadList(true);
+          }, 0);
         }
         break;
     }
   }
 };
 
 ////////////////////////////////////////////////////////////////////////////////
 //// View Context Menus
diff -r a4343d61f6ee toolkit/mozapps/downloads/src/nsHelperAppDlg.js.in
--- a/toolkit/mozapps/downloads/src/nsHelperAppDlg.js.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/mozapps/downloads/src/nsHelperAppDlg.js.in	Sat Nov 15 19:43:14 2008 -0500
@@ -22,16 +22,17 @@
 #
 # Contributor(s):
 #   Bill Law <law@netscape.com>
 #   Scott MacGregor <mscott@netscape.com>
 #   Ben Goodger <ben@bengoodger.com> (2.0)
 #   Fredrik Holmqvist <thesuckiestemail@yahoo.se>
 #   Dan Mosedale <dmose@mozilla.org>
 #   Jim Mathies <jmathies@mozilla.com>
+#   Ehsan Akhgari <ehsan.akhgari@gmail.com>
 #
 # Alternatively, the contents of this file may be used under the terms of
 # either the GNU General Public License Version 2 or later (the "GPL"), or
 # the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
 # in which case the provisions of the GPL or the LGPL are applicable instead
 # of those above. If you wish to allow use of your version of this file only
 # under the terms of either the GPL or the LGPL, and not to allow others to
 # use your version of this file under the terms of the MPL, indicate your
@@ -232,17 +233,29 @@ nsUnknownContentTypeDialog.prototype = {
           // Remove the file so that it's not there when we ensure non-existence later;
           // this is safe because for the file to exist, the user would have had to
           // confirm that he wanted the file overwritten.
           if (result.exists())
             result.remove(false);
         }
         catch (e) { }
         var newDir = result.parent;
-        prefs.setComplexValue("browser.download.lastDir", Components.interfaces.nsILocalFile, newDir);
+
+        // Do not remember the last save directory inside the private browsing mode
+        var persistLastDir = true;
+        try {
+          var pbs = Components.classes["@mozilla.org/privatebrowsing;1"]
+                              .getService(Components.interfaces.nsIPrivateBrowsingService);
+          if (pbs.privateBrowsingEnabled)
+            persistLastDir = false;
+        }
+        catch (e) { }
+        if (persistLastDir)
+          prefs.setComplexValue("browser.download.lastDir", Components.interfaces.nsILocalFile, newDir);
+
         result = this.validateLeafName(newDir, result.leafName, null);
       }
       return result;
     },
 
     /**
      * Ensures that a local folder/file combination does not already exist in
      * the file system (or finds such a combination with a reasonably similar
diff -r a4343d61f6ee toolkit/mozapps/installer/package-name.mk
--- a/toolkit/mozapps/installer/package-name.mk	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/mozapps/installer/package-name.mk	Sat Nov 15 19:43:14 2008 -0500
@@ -97,30 +97,32 @@ PKG_BASENAME = $(MOZ_PKG_APPNAME)-$(MOZ_
 PKG_BASENAME = $(MOZ_PKG_APPNAME)-$(MOZ_PKG_VERSION).$(AB_CD).$(MOZ_PKG_PLATFORM)
 PKG_PATH =
 PKG_INST_BASENAME = $(PKG_BASENAME).installer
 PKG_INST_PATH = install/sea/
 PKG_UPDATE_BASENAME = $(PKG_BASENAME)
 PKG_UPDATE_PATH = update/
 PKG_LANGPACK_BASENAME = $(MOZ_PKG_APPNAME)-$(MOZ_PKG_VERSION).$(AB_CD).langpack
 PKG_LANGPACK_PATH = install/
+PKG_SRCPACK_BASENAME = $(MOZ_PKG_APPNAME)-$(MOZ_PKG_VERSION).source
+PKG_SRCPACK_PATH =
 
 else # "pretty" release package names
 
 ifndef MOZ_PKG_APPNAME
 MOZ_PKG_APPNAME = $(MOZ_APP_DISPLAYNAME)
 endif
 MOZ_PKG_APPNAME_LC = $(shell echo $(MOZ_PKG_APPNAME) | tr '[A-Z]' '[a-z]')
 
 
 ifndef MOZ_PKG_LONGVERSION
 MOZ_PKG_LONGVERSION = $(shell echo $(MOZ_PKG_VERSION) |\
-                       sed -e 's/a\([0-9][0-9]*\)$/ Alpha \1/' |\
-                       sed -e 's/b\([0-9][0-9]*\)$/ Beta \1/' |\
-                       sed -e 's/rc\([0-9][0-9]*\)$/ RC \1/')
+                       sed -e 's/a\([0-9][0-9]*\)$$/ Alpha \1/' |\
+                       sed -e 's/b\([0-9][0-9]*\)$$/ Beta \1/' |\
+                       sed -e 's/rc\([0-9][0-9]*\)$$/ RC \1/')
 endif
 
 ifeq (,$(filter-out Darwin OS2, $(OS_ARCH))) # Mac and OS2
 PKG_BASENAME = $(MOZ_PKG_APPNAME) $(MOZ_PKG_LONGVERSION)
 PKG_INST_BASENAME = $(MOZ_PKG_APPNAME) Setup $(MOZ_PKG_LONGVERSION)
 else
 ifeq (,$(filter-out WINNT, $(OS_ARCH))) # Windows
 PKG_BASENAME = $(MOZ_PKG_APPNAME_LC)-$(MOZ_PKG_VERSION)
@@ -131,10 +133,12 @@ endif
 endif
 endif
 PKG_PATH = $(MOZ_PKG_PLATFORM)/$(AB_CD)/
 PKG_INST_PATH = $(PKG_PATH)
 PKG_UPDATE_BASENAME = $(MOZ_PKG_APPNAME_LC)-$(MOZ_PKG_VERSION)
 PKG_UPDATE_PATH = update/$(PKG_PATH)
 PKG_LANGPACK_BASENAME = $(AB_CD)
 PKG_LANGPACK_PATH = langpack/
+PKG_SRCPACK_BASENAME = $(MOZ_PKG_APPNAME_LC)-$(MOZ_PKG_VERSION).source
+PKG_SRCPACK_PATH = source/
 
 endif # MOZ_PKG_PRETTYNAMES
diff -r a4343d61f6ee toolkit/mozapps/installer/packager.mk
--- a/toolkit/mozapps/installer/packager.mk	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/mozapps/installer/packager.mk	Sat Nov 15 19:43:14 2008 -0500
@@ -474,8 +474,28 @@ make-sdk:
 	$(NSINSTALL) -D $(DIST)/$(MOZ_APP_NAME)-sdk/idl
 	(cd $(DIST)/idl && tar $(TAR_CREATE_FLAGS) - .) | \
 	  (cd $(DIST)/$(MOZ_APP_NAME)-sdk/idl && tar -xf -)
 	$(NSINSTALL) -D $(DIST)/$(MOZ_APP_NAME)-sdk/lib
 # sdk/lib is the same as sdk/sdk/lib
 	(cd $(DIST)/sdk/lib && tar $(TAR_CREATE_FLAGS) - .) | \
 	  (cd $(DIST)/$(MOZ_APP_NAME)-sdk/lib && tar -xf -)
 	cd $(DIST) && $(MAKE_SDK)
+
+ifeq ($(OS_TARGET), WINNT)
+INSTALLER_PACKAGE = $(DIST)/$(PKG_INST_PATH)$(PKG_INST_BASENAME).exe
+endif
+
+upload:
+	$(PYTHON) $(topsrcdir)/build/upload.py --base-path $(DIST) $(DIST)/$(PACKAGE) $(INSTALLER_PACKAGE)
+
+ifndef MOZ_PKG_SRCDIR
+MOZ_PKG_SRCDIR = $(topsrcdir)
+endif
+
+CREATE_SOURCE_TAR = $(TAR) -c --owner=0 --group=0 --numeric-owner \
+  --mode="go-w" --exclude=".hg*" --exclude="CVS" --exclude=".cvs*" -f
+
+# source-package creates a source tarball from the files in MOZ_PKG_SRCDIR,
+# which is either set to a clean checkout or defaults to $topsrcdir
+source-package:
+	@echo "Packaging source tarball..."
+	(cd $(MOZ_PKG_SRCDIR) && $(CREATE_SOURCE_TAR) - .) | bzip2 -vf > $(DIST)/$(PKG_SRCPACK_PATH)$(PKG_SRCPACK_BASENAME).tar.bz2
diff -r a4343d61f6ee toolkit/mozapps/update/src/nsUpdateService.js.in
--- a/toolkit/mozapps/update/src/nsUpdateService.js.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/mozapps/update/src/nsUpdateService.js.in	Sat Nov 15 19:43:14 2008 -0500
@@ -79,16 +79,17 @@ const KEY_APPDIR          = "XCurProcD";
 const KEY_APPDIR          = "XCurProcD";
 #ifdef XP_WIN
 const KEY_UPDROOT         = "UpdRootD";
 const KEY_UAPPDATA        = "UAppData";
 #endif
 
 const DIR_UPDATES         = "updates";
 const FILE_UPDATE_STATUS  = "update.status";
+const FILE_UPDATE_VERSION = "update.version";
 const FILE_UPDATE_ARCHIVE = "update.mar";
 const FILE_UPDATE_LOG     = "update.log"
 const FILE_UPDATES_DB     = "updates.xml";
 const FILE_UPDATE_ACTIVE  = "active-update.xml";
 const FILE_PERMS_TEST     = "update.test";
 const FILE_LAST_LOG       = "last-update.log";
 const FILE_UPDATER_INI    = "updater.ini";
 
@@ -391,16 +392,38 @@ function readStatusFile(dir) {
  *          written.
  * @param   state
  *          The state value to write.
  */
 function writeStatusFile(dir, state) {
   var statusFile = dir.clone();
   statusFile.append(FILE_UPDATE_STATUS);
   writeStringToFile(statusFile, state);
+}
+
+/**
+#  Writes the update's application version to a file in the patch directory. If
+#  the update doesn't provide application version information via the
+#  extensionVersion attribute the string "null" will be written to the file.
+#  This value is compared during startup (in nsUpdateDriver.cpp) to determine if
+#  the update should be applied. Note that this won't provide protection from
+#  downgrade of the application for the nightly user case where the application
+#  version doesn't change.
+#  @param   dir
+#           The patch directory where the update.version file should be
+#           written.
+#  @param   version
+#           The version value to write. Will be the string "null" when the
+#           update doesn't provide the extensionVersion attribute in the update
+#           xml.
+ */
+function writeVersionFile(dir, version) {
+  var versionFile = dir.clone();
+  versionFile.append(FILE_UPDATE_VERSION);
+  writeStringToFile(versionFile, version);
 }
 
 /**
  * Removes the Updates Directory
  * @param   key
  *          The Directory Service Key under which update directory resides
  *          (optional).
  */
@@ -1081,16 +1104,19 @@ UpdateService.prototype = {
     switch (topic) {
     case "profile-after-change":
       os.removeObserver(this, "profile-after-change");
       this._start();
       break;
     case "xpcom-shutdown":
       os.removeObserver(this, "xpcom-shutdown");
 
+      // Prevent leaking the downloader (bug 454964)
+      this._downloader = null;
+
       // Release Services
       gApp      = null;
       gPref     = null;
       gConsole  = null;
       break;
     }
   },
 
@@ -1220,16 +1246,17 @@ UpdateService.prototype = {
         // that it can be attempted again the next time we restart.
         var ary = status.split(": ");
         update.state = ary[0];
         if (update.state == STATE_FAILED && ary[1]) {
           update.errorCode = ary[1];
           if (update.errorCode == WRITE_ERROR) {
             prompter.showUpdateError(update);
             writeStatusFile(getUpdatesDir(), update.state = STATE_PENDING);
+            writeVersionFile(getUpdatesDir(), update.extensionVersion);
             return;
           }
         }
 
         // Something went wrong with the patch application process.
         cleanupActiveUpdate();
 
         update.statusText = bundle.GetStringFromName("patchApplyFailure");
@@ -2402,16 +2429,17 @@ Downloader.prototype = {
         // Something went wrong when we tried to apply the previous patch.
         // Try the complete patch next time.
         if (update && selectedPatch.type == "partial") {
           useComplete = true;
         } else {
           // This is a pretty fatal error.  Just bail.
           LOG("Downloader", "_selectPatch - failed to apply complete patch!");
           writeStatusFile(updateDir, STATE_NONE);
+          writeVersionFile(getUpdatesDir(), null);
           return null;
         }
       }
 
       selectedPatch = null;
     }
 
     // If we were not able to discover an update from a previous download, we
@@ -2627,16 +2655,17 @@ Downloader.prototype = {
         // We only need to explicitly show the prompt if this is a backround
         // download, since otherwise some kind of UI is already visible and
         // that UI will notify.
         if (this.background)
           shouldShowPrompt = true;
 
         // Tell the updater.exe we're ready to apply.
         writeStatusFile(getUpdatesDir(), state);
+        writeVersionFile(getUpdatesDir(), this._update.extensionVersion);
         this._update.installDate = (new Date()).getTime();
         this._update.statusText = updateStrings.GetStringFromName("installPending");
       }
       else {
         LOG("Downloader", "onStopRequest - download verification failed");
         state = STATE_DOWNLOAD_FAILED;
 
         var brandStrings = sbs.createBundle(URI_BRAND_PROPERTIES);
diff -r a4343d61f6ee toolkit/themes/gnomestripe/global/autocomplete.css
--- a/toolkit/themes/gnomestripe/global/autocomplete.css	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/themes/gnomestripe/global/autocomplete.css	Sat Nov 15 19:43:14 2008 -0500
@@ -41,49 +41,45 @@
   == Styles used by the autocomplete widget.
   ======================================================================= */
 
 @namespace url("http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul");
 @namespace html url("http://www.w3.org/1999/xhtml");
 
 /* ::::: autocomplete ::::: */
 
-textbox {
+/* .padded is used by autocomplete widgets that don't have an icon. Gross. -dwh */
+textbox:not(.padded) {
   cursor: default;
   padding: 0;
 }
 
 textbox[enablehistory="true"] {
   -moz-appearance: none;
   border: 0;
   background-color: transparent;
 }
 
 textbox[nomatch="true"][highlightnonmatches="true"] {
   color: red;
 }
 
-/* Used by autocomplete widgets that don't have an icon. Gross. -dwh */
-textbox.padded {
-  padding-top: 1px;
-  padding-bottom: 1px;
-  -moz-padding-start: 2px;
-  -moz-padding-end: 0px;
-}
-
 .autocomplete-textbox-container {
   -moz-box-align: center;
 }
 
 textbox[enablehistory="true"] > .autocomplete-textbox-container {
   -moz-appearance: menulist-textfield;
 }
 
+textbox:not(.padded) .textbox-input-box {
+  margin: 0 3px;
+}
+
 .textbox-input-box {
-  margin: 0 3px;
   -moz-box-align: center;
 }
 
 /* ::::: autocomplete popups ::::: */
 
 panel[type="autocomplete"],
 panel[type="autocomplete-richlistbox"],
 .autocomplete-history-popup {
diff -r a4343d61f6ee toolkit/themes/gnomestripe/global/console/console-toolbar.png
Binary file toolkit/themes/gnomestripe/global/console/console-toolbar.png has changed
diff -r a4343d61f6ee toolkit/themes/gnomestripe/global/icons/Search-glass-rtl.png
Binary file toolkit/themes/gnomestripe/global/icons/Search-glass-rtl.png has changed
diff -r a4343d61f6ee toolkit/themes/gnomestripe/global/icons/blacklist_large.png
Binary file toolkit/themes/gnomestripe/global/icons/blacklist_large.png has changed
diff -r a4343d61f6ee toolkit/themes/gnomestripe/global/icons/find.png
Binary file toolkit/themes/gnomestripe/global/icons/find.png has changed
diff -r a4343d61f6ee toolkit/themes/gnomestripe/global/icons/folder-item.png
Binary file toolkit/themes/gnomestripe/global/icons/folder-item.png has changed
diff -r a4343d61f6ee toolkit/themes/gnomestripe/global/textbox.css
--- a/toolkit/themes/gnomestripe/global/textbox.css	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/themes/gnomestripe/global/textbox.css	Sat Nov 15 19:43:14 2008 -0500
@@ -40,27 +40,27 @@
   == Styles used by the XUL textbox element.
   ======================================================================= */
 
 @namespace url("http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul");
 @namespace html url("http://www.w3.org/1999/xhtml");
 
 /* ::::: textbox ::::: */
 
-textbox 
-{
+textbox {
   -moz-appearance: textfield;
   cursor: text;
   margin: 2px 4px;
   border: 2px solid;
   -moz-border-top-colors: ThreeDShadow ThreeDDarkShadow;
   -moz-border-right-colors: ThreeDHighlight ThreeDLightShadow;
   -moz-border-bottom-colors: ThreeDHighlight ThreeDLightShadow;
   -moz-border-left-colors: ThreeDShadow ThreeDDarkShadow;
-  padding: 2px 2px 3px 4px;
+  padding: 2px 2px 3px;
+  -moz-padding-start: 4px;
   background-color: -moz-Field;
   color: -moz-FieldText;
 }
 
 textbox[empty="true"] {
   color: GrayText;
 }
 
diff -r a4343d61f6ee toolkit/themes/gnomestripe/mozapps/extensions/extensionIcons.png
Binary file toolkit/themes/gnomestripe/mozapps/extensions/extensionIcons.png has changed
diff -r a4343d61f6ee toolkit/themes/gnomestripe/mozapps/extensions/themeGeneric.png
Binary file toolkit/themes/gnomestripe/mozapps/extensions/themeGeneric.png has changed
diff -r a4343d61f6ee toolkit/themes/gnomestripe/mozapps/extensions/viewButtons.png
Binary file toolkit/themes/gnomestripe/mozapps/extensions/viewButtons.png has changed
diff -r a4343d61f6ee toolkit/themes/gnomestripe/mozapps/update/update.png
Binary file toolkit/themes/gnomestripe/mozapps/update/update.png has changed
diff -r a4343d61f6ee toolkit/themes/gnomestripe/mozapps/xpinstall/xpinstallItemGeneric.png
Binary file toolkit/themes/gnomestripe/mozapps/xpinstall/xpinstallItemGeneric.png has changed
diff -r a4343d61f6ee toolkit/themes/pinstripe/global/autocomplete.css
--- a/toolkit/themes/pinstripe/global/autocomplete.css	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/themes/pinstripe/global/autocomplete.css	Sat Nov 15 19:43:14 2008 -0500
@@ -41,32 +41,31 @@
   == Styles used by the autocomplete widget.
   ======================================================================= */
 
 @namespace url("http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul");
 @namespace html url("http://www.w3.org/1999/xhtml");
 
 /* ::::: autocomplete ::::: */
 
-textbox {
+/* .padded is used by autocomplete widgets that don't have an icon. Gross. -dwh */
+textbox:not(.padded) {
   cursor: default;
   padding: 0;
 }
 
 textbox[nomatch="true"][highlightnonmatches="true"] {
   color: red;
 }
 
-/* Used by autocomplete widgets that don't have an icon. Gross. -dwh */
-textbox.padded {
-  padding: 1px 0px 1px 2px;
+textbox:not(.padded) .textbox-input-box {
+  margin: 0 3px;
 }
 
 .textbox-input-box {
-  margin: 0 3px;
   -moz-box-align: center;
 }
 
 /* ::::: history button ::::: */
 
 .autocomplete-history-dropmarker {
   -moz-appearance: none !important;
   border: none !important;
diff -r a4343d61f6ee toolkit/themes/pinstripe/global/icons/Search-close.png
Binary file toolkit/themes/pinstripe/global/icons/Search-close.png has changed
diff -r a4343d61f6ee toolkit/themes/pinstripe/global/icons/Search-glass.png
Binary file toolkit/themes/pinstripe/global/icons/Search-glass.png has changed
diff -r a4343d61f6ee toolkit/themes/winstripe/global/autocomplete.css
--- a/toolkit/themes/winstripe/global/autocomplete.css	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/themes/winstripe/global/autocomplete.css	Sat Nov 15 19:43:14 2008 -0500
@@ -41,39 +41,35 @@
   == Styles used by the autocomplete widget.
   ======================================================================= */
 
 @namespace url("http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul");
 @namespace html url("http://www.w3.org/1999/xhtml");
 
 /* ::::: autocomplete ::::: */
 
-textbox {
+/* .padded is used by autocomplete widgets that don't have an icon. Gross. -dwh */
+textbox:not(.padded) {
   cursor: default;
   padding: 0;
 }
 
 textbox[nomatch="true"][highlightnonmatches="true"] {
   color: red;
 }
 
-/* Used by autocomplete widgets that don't have an icon. Gross. -dwh */
-textbox.padded {
-  padding-top: 1px;
-  padding-bottom: 1px;
-  -moz-padding-start: 2px;
-  -moz-padding-end: 0px;
-}
-
 .autocomplete-textbox-container {
   -moz-box-align: center;
 }
 
+textbox:not(.padded) .textbox-input-box {
+  margin: 0 3px;
+}
+
 .textbox-input-box {
-  margin: 0 3px;
   -moz-box-align: center;
 }
 
 /* ::::: autocomplete popups ::::: */
 
 panel[type="autocomplete"],
 panel[type="autocomplete-richlistbox"],
 .autocomplete-history-popup {
diff -r a4343d61f6ee toolkit/themes/winstripe/global/checkbox.css
--- a/toolkit/themes/winstripe/global/checkbox.css	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/themes/winstripe/global/checkbox.css	Sat Nov 15 19:43:14 2008 -0500
@@ -78,16 +78,25 @@ checkbox[disabled="true"] > .checkbox-ch
 checkbox[disabled="true"] > .checkbox-check {
   background-color: -moz-Dialog;
 }
 
 checkbox[disabled="true"] {
   color: GrayText;
 }
 
+/* XXX Hack to work around bug 458231 */
+checkbox:-moz-system-metric(windows-classic) {
+  text-shadow: 1px 1px transparent;
+}
+
+checkbox:-moz-system-metric(windows-classic) > .checkbox-label-box > .checkbox-label {
+  margin-bottom: -2px !important;
+}
+
 checkbox[disabled="true"]:-moz-system-metric(windows-classic) {
   color: ThreeDShadow;
   text-shadow: 1px 1px ThreeDHighlight;
 }
 
 /* ::::: checkmark image ::::: */
 
 .checkbox-check {
diff -r a4343d61f6ee toolkit/themes/winstripe/global/radio.css
--- a/toolkit/themes/winstripe/global/radio.css	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/themes/winstripe/global/radio.css	Sat Nov 15 19:43:14 2008 -0500
@@ -81,16 +81,25 @@ radio[disabled="true"] > .radio-check-bo
 radio[disabled="true"] > .radio-check-box1 {
   background-color: -moz-Dialog;
 }
 
 radio[disabled="true"] {
   color: GrayText;
 }
 
+/* XXX Hack to work around bug 458231 */
+radio:-moz-system-metric(windows-classic) {
+  text-shadow: 1px 1px transparent;
+}
+
+radio:-moz-system-metric(windows-classic) > .radio-label-box > .radio-label {
+  margin-bottom: -2px !important;
+}
+
 radio[disabled="true"]:-moz-system-metric(windows-classic) {
   color: ThreeDShadow;
   text-shadow: 1px 1px ThreeDHighlight;
 }
 
 /* ::::: checkmark image ::::: */
 
 .radio-check-box1 {
diff -r a4343d61f6ee toolkit/themes/winstripe/global/textbox.css
--- a/toolkit/themes/winstripe/global/textbox.css	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/themes/winstripe/global/textbox.css	Sat Nov 15 19:43:14 2008 -0500
@@ -40,27 +40,27 @@
   == Styles used by the XUL textbox element.
   ======================================================================= */
 
 @namespace url("http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul");
 @namespace html url("http://www.w3.org/1999/xhtml");
 
 /* ::::: textbox ::::: */
 
-textbox 
-{
+textbox {
   -moz-appearance: textfield;
   cursor: text;
   margin: 2px 4px;
   border: 2px solid;
   -moz-border-top-colors: ThreeDShadow ThreeDDarkShadow;
   -moz-border-right-colors: ThreeDHighlight ThreeDLightShadow;
   -moz-border-bottom-colors: ThreeDHighlight ThreeDLightShadow;
   -moz-border-left-colors: ThreeDShadow ThreeDDarkShadow;
-  padding: 2px 2px 3px 4px;
+  padding: 2px 2px 3px;
+  -moz-padding-start: 4px;
   background-color: -moz-Field;
   color: -moz-FieldText;
 }
 
 textbox[empty="true"] {
   color: GrayText;
 }
 
diff -r a4343d61f6ee toolkit/toolkit-makefiles.sh
--- a/toolkit/toolkit-makefiles.sh	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/toolkit-makefiles.sh	Sat Nov 15 19:43:14 2008 -0500
@@ -1110,11 +1110,16 @@ if [ "$MOZ_OGG" ]; then
 if [ "$MOZ_OGG" ]; then
  add_makefiles "
    $MAKEFILES_libvorbis
    $MAKEFILES_libtheora
    $MAKEFILES_liboggz
    $MAKEFILES_libogg
    $MAKEFILES_libfishsound
    $MAKEFILES_liboggplay
+ "
+fi
+
+if [ "$MOZ_SYDNEYAUDIO" ]; then
+ add_makefiles "
    $MAKEFILES_libsydneyaudio
  "
 fi
diff -r a4343d61f6ee toolkit/toolkit-tiers.mk
--- a/toolkit/toolkit-tiers.mk	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/toolkit-tiers.mk	Sat Nov 15 19:43:14 2008 -0500
@@ -119,19 +119,24 @@ endif
 endif
 
 ifdef MOZ_OGG
 tier_gecko_dirs += \
 		media/libfishsound \
 		media/libogg \
 		media/liboggplay \
 		media/liboggz \
-		media/libsydneyaudio \
 		media/libtheora \
 		media/libvorbis \
+		$(NULL)
+endif
+
+ifdef MOZ_SYDNEYAUDIO
+tier_gecko_dirs += \
+		media/libsydneyaudio \
 		$(NULL)
 endif
 
 tier_gecko_dirs	+= \
 		uriloader \
 		modules/libimg \
 		caps \
 		parser/expat \
diff -r a4343d61f6ee toolkit/xre/nsAppRunner.cpp
--- a/toolkit/xre/nsAppRunner.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/xre/nsAppRunner.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -2971,17 +2971,18 @@ XRE_main(int argc, char* argv[], const n
   // XRE_UPDATE_ROOT_DIR may fail. Fallback to appDir if failed
   if (NS_FAILED(rv))
     updRoot = dirProvider.GetAppDir();
 
   ProcessUpdates(dirProvider.GetGREDir(),
                  dirProvider.GetAppDir(),
                  updRoot,
                  gRestartArgc,
-                 gRestartArgv);
+                 gRestartArgv,
+                 appData.version);
 #endif
 
     nsCOMPtr<nsIProfileLock> profileLock;
     PRBool startOffline = PR_FALSE;
     nsCAutoString profileName;
 
     rv = SelectProfile(getter_AddRefs(profileLock), nativeApp, &startOffline,
                        &profileName);
diff -r a4343d61f6ee toolkit/xre/nsUpdateDriver.cpp
--- a/toolkit/xre/nsUpdateDriver.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/xre/nsUpdateDriver.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -17,16 +17,17 @@
  *
  * The Initial Developer of the Original Code is Google Inc.
  * Portions created by the Initial Developer are Copyright (C) 2005
  * the Initial Developer. All Rights Reserved.
  *
  * Contributor(s):
  *  Darin Fisher <darin@meer.net>
  *  Ben Turner <mozilla@songbirdnest.com>
+ *  Robert Strong <robert.bugzilla@gmail.com>
  *
  * Alternatively, the contents of this file may be used under the terms of
  * either the GNU General Public License Version 2 or later (the "GPL"), or
  * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
  * in which case the provisions of the GPL or the LGPL are applicable instead
  * of those above. If you wish to allow use of your version of this file only
  * under the terms of either the GPL or the LGPL, and not to allow others to
  * use your version of this file under the terms of the MPL, indicate your
@@ -46,16 +47,17 @@
 #include "nsISimpleEnumerator.h"
 #include "nsIDirectoryEnumerator.h"
 #include "nsCOMPtr.h"
 #include "nsCOMArray.h"
 #include "nsString.h"
 #include "nsPrintfCString.h"
 #include "prproces.h"
 #include "prlog.h"
+#include "nsVersionComparator.h"
 
 #ifdef XP_MACOSX
 #include "nsILocalFileMac.h"
 #include "nsCommandLineServiceMac.h"
 #endif
 
 #if defined(XP_WIN)
 # include <direct.h>
@@ -217,26 +219,26 @@ ScanDir(nsIFile *dir, nsCOMArray<nsIFile
   return NS_OK;
 }
 
 static PRBool
 GetFile(nsIFile *dir, const nsCSubstring &name, nsCOMPtr<nsILocalFile> &result)
 {
   nsresult rv;
   
-  nsCOMPtr<nsIFile> statusFile;
-  rv = dir->Clone(getter_AddRefs(statusFile));
+  nsCOMPtr<nsIFile> file;
+  rv = dir->Clone(getter_AddRefs(file));
   if (NS_FAILED(rv))
     return PR_FALSE;
 
-  rv = statusFile->AppendNative(name);
+  rv = file->AppendNative(name);
   if (NS_FAILED(rv))
     return PR_FALSE;
 
-  result = do_QueryInterface(statusFile, &rv);
+  result = do_QueryInterface(file, &rv);
   return NS_SUCCEEDED(rv);
 }
 
 static PRBool
 GetStatusFile(nsIFile *dir, nsCOMPtr<nsILocalFile> &result)
 {
   return GetFile(dir, NS_LITERAL_CSTRING("update.status"), result);
 }
@@ -267,16 +269,52 @@ SetStatus(nsILocalFile *statusFile, cons
   FILE *fp;
   nsresult rv = statusFile->OpenANSIFileDesc("w", &fp);
   if (NS_FAILED(rv))
     return PR_FALSE;
 
   fprintf(fp, "%s\n", status);
   fclose(fp);
   return PR_TRUE;
+}
+
+static PRBool
+GetVersionFile(nsIFile *dir, nsCOMPtr<nsILocalFile> &result)
+{
+  return GetFile(dir, NS_LITERAL_CSTRING("update.version"), result);
+}
+
+// Compares the current application version with the update's application
+// version.
+static PRBool
+IsOlderVersion(nsILocalFile *versionFile, const char *&appVersion)
+{
+  nsresult rv;
+
+  FILE *fp;
+  rv = versionFile->OpenANSIFileDesc("r", &fp);
+  if (NS_FAILED(rv))
+    return PR_TRUE;
+
+  char buf[32];
+  char *result = fgets(buf, sizeof(buf), fp);
+  fclose(fp);
+  if (!result)
+    return PR_TRUE;
+
+  // If the update xml doesn't provide the application version the file will
+  // contain the string "null" and it is assumed that the update is not older.
+  const char kNull[] = "null";
+  if (strncmp(buf, kNull, sizeof(kNull) - 1) == 0)
+    return PR_FALSE;
+
+  if (NS_CompareVersions(appVersion, result) > 0)
+    return PR_TRUE;
+
+  return PR_FALSE;
 }
 
 static PRBool
 CopyFileIntoUpdateDir(nsIFile *parentDir, const char *leafName, nsIFile *updateDir)
 {
   nsDependentCString leaf(leafName);
   nsCOMPtr<nsIFile> file;
 
@@ -500,17 +538,17 @@ end:
 end:
   PR_DestroyProcessAttr(attr); 
   delete[] argv;
 #endif
 }
 
 nsresult
 ProcessUpdates(nsIFile *greDir, nsIFile *appDir, nsIFile *updRootDir,
-               int argc, char **argv)
+               int argc, char **argv, const char *&appVersion)
 {
   nsresult rv;
 
   nsCOMPtr<nsIFile> updatesDir;
   rv = updRootDir->Clone(getter_AddRefs(updatesDir));
   if (NS_FAILED(rv))
     return rv;
   rv = updatesDir->AppendNative(NS_LITERAL_CSTRING("updates"));
@@ -528,15 +566,25 @@ ProcessUpdates(nsIFile *greDir, nsIFile 
     return rv;
   if (dirEntries.Count() == 0)
     return NS_OK;
 
   // look for the first update subdirectory with a status of pending
   for (int i = 0; i < dirEntries.Count(); ++i) {
     nsCOMPtr<nsILocalFile> statusFile;
     if (GetStatusFile(dirEntries[i], statusFile) && IsPending(statusFile)) {
+      nsCOMPtr<nsILocalFile> versionFile;
+      // Remove the update if the update application version file doesn't exist
+      // or if the update's application version is less than the current
+      // application version.
+      if (!GetVersionFile(dirEntries[i], versionFile) ||
+          IsOlderVersion(versionFile, appVersion)) {
+        dirEntries[i]->Remove(PR_TRUE);
+        continue;
+      }
+
       ApplyUpdate(greDir, dirEntries[i], statusFile, appDir, argc, argv);
       break;
     }
   }
 
   return NS_OK;
 }
diff -r a4343d61f6ee toolkit/xre/nsUpdateDriver.h
--- a/toolkit/xre/nsUpdateDriver.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/toolkit/xre/nsUpdateDriver.h	Sat Nov 15 19:43:14 2008 -0500
@@ -17,16 +17,17 @@
  *
  * The Initial Developer of the Original Code is Google Inc.
  * Portions created by the Initial Developer are Copyright (C) 2005
  * the Initial Developer. All Rights Reserved.
  *
  * Contributor(s):
  *  Darin Fisher <darin@meer.net>
  *  Ben Turner <mozilla@songbirdnest.com>
+ *  Robert Strong <robert.bugzilla@gmail.com>
  *
  * Alternatively, the contents of this file may be used under the terms of
  * either the GNU General Public License Version 2 or later (the "GPL"), or
  * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
  * in which case the provisions of the GPL or the LGPL are applicable instead
  * of those above. If you wish to allow use of your version of this file only
  * under the terms of either the GPL or the LGPL, and not to allow others to
  * use your version of this file under the terms of the MPL, indicate your
@@ -50,15 +51,20 @@ class nsIFile;
  *
  * Two directories are passed to this function: greDir (where the actual
  * binary resides) and appDir (which contains application.ini for XULRunner
  * apps). If this is not a XULRunner app then appDir is identical to greDir.
  * 
  * The argc and argv passed to this function should be what is needed to
  * relaunch the current process.
  *
+ * The appVersion param passed to this function is the current application's
+ * version and is used to determine if an update's version is older than the
+ * current application version.
+ *
  * This function does not modify appDir.
  */
 NS_HIDDEN_(nsresult) ProcessUpdates(nsIFile *greDir, nsIFile *appDir,
                                     nsIFile *updRootDir,
-                                    int argc, char **argv);
+                                    int argc, char **argv,
+                                    const char *&appVersion);
 
 #endif  // nsUpdateDriver_h__
diff -r a4343d61f6ee uriloader/exthandler/nsExternalHelperAppService.cpp
--- a/uriloader/exthandler/nsExternalHelperAppService.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/uriloader/exthandler/nsExternalHelperAppService.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -21,16 +21,17 @@
  * the Initial Developer. All Rights Reserved.
  *
  * Contributor(s):
  *   Scott MacGregor <mscott@netscape.com>
  *   Bill Law <law@netscape.com>
  *   Christian Biesinger <cbiesinger@web.de>
  *   Dan Mosedale <dmose@mozilla.org>
  *   Myk Melez <myk@mozilla.org>
+ *   Ehsan Akhgari <ehsan.akhgari@gmail.com>
  *
  * Alternatively, the contents of this file may be used under the terms of
  * either of the GNU General Public License Version 2 or later (the "GPL"),
  * or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
  * in which case the provisions of the GPL or the LGPL are applicable instead
  * of those above. If you wish to allow use of your version of this file only
  * under the terms of either the GPL or the LGPL, and not to allow others to
  * use your version of this file under the terms of the MPL, indicate your
@@ -118,16 +119,18 @@
 
 #include "nsCRT.h"
 
 #include "nsLocalHandlerApp.h"
 
 #include "nsIRandomGenerator.h"
 #include "plbase64.h"
 #include "prmem.h"
+
+#include "nsIPrivateBrowsingService.h"
 
 // Buffer file writes in 32kb chunks
 #define BUFFERED_OUTPUT_SIZE (1024 * 32)
 
 // Download Folder location constants
 #define NS_PREF_DOWNLOAD_DIR        "browser.download.dir"
 #define NS_PREF_DOWNLOAD_FOLDERLIST "browser.download.folderList"
 enum {
@@ -532,17 +535,18 @@ static nsExtraMimeTypeEntry extraMimeEnt
   { TEXT_HTML, "html,htm,shtml,ehtml", "HyperText Markup Language", MAC_TYPE('TEXT'), MAC_TYPE('MOSS') },
   { "application/xhtml+xml", "xhtml,xht", "Extensible HyperText Markup Language", MAC_TYPE('TEXT'), MAC_TYPE('ttxt') },
   { APPLICATION_RDF, "rdf", "Resource Description Framework", MAC_TYPE('TEXT'), MAC_TYPE('ttxt') },
   { TEXT_XUL, "xul", "XML-Based User Interface Language", MAC_TYPE('TEXT'), MAC_TYPE('ttxt') },
   { TEXT_XML, "xml,xsl,xbl", "Extensible Markup Language", MAC_TYPE('TEXT'), MAC_TYPE('ttxt') },
   { TEXT_CSS, "css", "Style Sheet", MAC_TYPE('TEXT'), MAC_TYPE('ttxt') },
   { "audio/ogg", "oga", "Ogg Audio", 0, 0 },
   { "video/ogg", "ogv", "Ogg Video", 0, 0 },
-  { "audio/ogg", "ogg", "Ogg Audio", 0, 0 }
+  { "audio/ogg", "ogg", "Ogg Audio", 0, 0 },
+  { "audio/x-wav", "wav", "Waveform Audio", 0, 0 }
 };
 
 #undef MAC_TYPE
 
 /**
  * File extensions for which decoding should be disabled.
  * NOTE: These MUST be lower-case and ASCII.
  */
@@ -558,36 +562,45 @@ NS_IMPL_ISUPPORTS6(
   nsExternalHelperAppService,
   nsIExternalHelperAppService,
   nsPIExternalAppLauncher,
   nsIExternalProtocolService,
   nsIMIMEService,
   nsIObserver,
   nsISupportsWeakReference)
 
-nsExternalHelperAppService::nsExternalHelperAppService()
+nsExternalHelperAppService::nsExternalHelperAppService() :
+  mInPrivateBrowsing(PR_FALSE)
 {
   gExtProtSvc = this;
 }
 nsresult nsExternalHelperAppService::Init()
 {
+  nsCOMPtr<nsIPrivateBrowsingService> pbs =
+    do_GetService(NS_PRIVATE_BROWSING_SERVICE_CONTRACTID);
+  if (pbs) {
+    pbs->GetPrivateBrowsingEnabled(&mInPrivateBrowsing);
+  }
+
   // Add an observer for profile change
   nsresult rv = NS_OK;
   nsCOMPtr<nsIObserverService> obs = do_GetService("@mozilla.org/observer-service;1", &rv);
   NS_ENSURE_SUCCESS(rv, rv);
 
 #ifdef PR_LOGGING
   if (!mLog) {
     mLog = PR_NewLogModule("HelperAppService");
     if (!mLog)
       return NS_ERROR_OUT_OF_MEMORY;
   }
 #endif
 
-  return obs->AddObserver(this, "profile-before-change", PR_TRUE);
+  rv = obs->AddObserver(this, "profile-before-change", PR_TRUE);
+  NS_ENSURE_SUCCESS(rv, rv);
+  return obs->AddObserver(this, NS_PRIVATE_BROWSING_SWITCH_TOPIC, PR_TRUE);
 }
 
 nsExternalHelperAppService::~nsExternalHelperAppService()
 {
   gExtProtSvc = nsnull;
 }
 
 NS_IMETHODIMP nsExternalHelperAppService::DoContent(const nsACString& aMimeContentType,
@@ -921,43 +934,54 @@ NS_IMETHODIMP nsExternalHelperAppService
   PRBool isFile = PR_FALSE;
   nsCOMPtr<nsILocalFile> localFile (do_QueryInterface(aTemporaryFile, &rv));
   NS_ENSURE_SUCCESS(rv, rv);
 
   // as a safety measure, make sure the nsIFile is really a file and not a directory object.
   localFile->IsFile(&isFile);
   if (!isFile) return NS_OK;
 
-  mTemporaryFilesList.AppendObject(localFile);
+  if (mInPrivateBrowsing)
+    mTemporaryPrivateFilesList.AppendObject(localFile);
+  else
+    mTemporaryFilesList.AppendObject(localFile);
 
   return NS_OK;
 }
 
 void nsExternalHelperAppService::FixFilePermissions(nsILocalFile* aFile)
 {
   // This space intentionally left blank
 }
 
-nsresult nsExternalHelperAppService::ExpungeTemporaryFiles()
+void nsExternalHelperAppService::ExpungeTemporaryFilesHelper(nsCOMArray<nsILocalFile> &fileList)
 {
-  PRInt32 numEntries = mTemporaryFilesList.Count();
+  PRInt32 numEntries = fileList.Count();
   nsILocalFile* localFile;
   for (PRInt32 index = 0; index < numEntries; index++)
   {
-    localFile = mTemporaryFilesList[index];
+    localFile = fileList[index];
     if (localFile) {
       // First make the file writable, since the temp file is probably readonly.
       localFile->SetPermissions(0600);
       localFile->Remove(PR_FALSE);
     }
   }
 
-  mTemporaryFilesList.Clear();
+  fileList.Clear();
+}
 
-  return NS_OK;
+void nsExternalHelperAppService::ExpungeTemporaryFiles()
+{
+  ExpungeTemporaryFilesHelper(mTemporaryFilesList);
+}
+
+void nsExternalHelperAppService::ExpungeTemporaryPrivateFiles()
+{
+  ExpungeTemporaryFilesHelper(mTemporaryPrivateFilesList);
 }
 
 static const char kExternalWarningPrefPrefix[] = 
   "network.protocol-handler.warn-external.";
 static const char kExternalWarningDefaultPref[] = 
   "network.protocol-handler.warn-external-default";
 
 NS_IMETHODIMP
@@ -1036,16 +1060,23 @@ nsExternalHelperAppService::SetProtocolH
 }
  
 // XPCOM profile change observer
 NS_IMETHODIMP
 nsExternalHelperAppService::Observe(nsISupports *aSubject, const char *aTopic, const PRUnichar *someData )
 {
   if (!strcmp(aTopic, "profile-before-change")) {
     ExpungeTemporaryFiles();
+  } else if (!strcmp(aTopic, NS_PRIVATE_BROWSING_SWITCH_TOPIC)) {
+    if (NS_LITERAL_STRING(NS_PRIVATE_BROWSING_ENTER).Equals(someData))
+      mInPrivateBrowsing = PR_TRUE;
+    else if (NS_LITERAL_STRING(NS_PRIVATE_BROWSING_LEAVE).Equals(someData)) {
+      mInPrivateBrowsing = PR_FALSE;
+      ExpungeTemporaryPrivateFiles();
+    }
   }
   return NS_OK;
 }
 
 //////////////////////////////////////////////////////////////////////////////////////////////////////
 // begin external app handler implementation 
 //////////////////////////////////////////////////////////////////////////////////////////////////////
 
diff -r a4343d61f6ee uriloader/exthandler/nsExternalHelperAppService.h
--- a/uriloader/exthandler/nsExternalHelperAppService.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/uriloader/exthandler/nsExternalHelperAppService.h	Sat Nov 15 19:43:14 2008 -0500
@@ -19,16 +19,17 @@
  * Portions created by the Initial Developer are Copyright (C) 1999
  * the Initial Developer. All Rights Reserved.
  *
  * Contributor(s):
  *   Scott MacGregor <mscott@netscape.com>
  *   Christian Biesinger <cbiesinger@web.de>
  *   Dan Mosedale <dmose@mozilla.org>
  *   Myk Melez <myk@mozilla.org>
+ *   Ehsan Akhgari <ehsan.akhgari@gmail.com>
  *
  * Alternatively, the contents of this file may be used under the terms of
  * either of the GNU General Public License Version 2 or later (the "GPL"),
  * or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
  * in which case the provisions of the GPL or the LGPL are applicable instead
  * of those above. If you wish to allow use of your version of this file only
  * under the terms of either the GPL or the LGPL, and not to allow others to
  * use your version of this file under the terms of the MPL, indicate your
@@ -196,24 +197,43 @@ protected:
   static PRLogModuleInfo* mLog;
 
 #endif
   // friend, so that it can access the nspr log module and FixFilePermissions
   friend class nsExternalAppHandler;
   friend class nsExternalLoadRequest;
 
   /**
+   * Helper function for ExpungeTemporaryFiles and ExpungeTemporaryPrivateFiles
+   */
+  static void ExpungeTemporaryFilesHelper(nsCOMArray<nsILocalFile> &fileList);
+  /**
    * Functions related to the tempory file cleanup service provided by
    * nsExternalHelperAppService
    */
-  NS_HIDDEN_(nsresult) ExpungeTemporaryFiles();
+  void ExpungeTemporaryFiles();
+  /**
+   * Functions related to the tempory file cleanup service provided by
+   * nsExternalHelperAppService (for the temporary files added during
+   * the private browsing mode)
+   */
+  void ExpungeTemporaryPrivateFiles();
   /**
    * Array for the files that should be deleted
    */
   nsCOMArray<nsILocalFile> mTemporaryFilesList;
+  /**
+   * Array for the files that should be deleted (for the temporary files
+   * added during the private browsing mode)
+   */
+  nsCOMArray<nsILocalFile> mTemporaryPrivateFilesList;
+  /**
+   * Whether we are in private browsing mode
+   */
+  PRBool mInPrivateBrowsing;
 };
 
 /**
  * We need to read the data out of the incoming stream into a buffer which we
  * can then use to write the data into the output stream representing the
  * temp file.
  */
 #define DATA_BUFFER_SIZE (4096*2) 
diff -r a4343d61f6ee widget/src/cocoa/crashtests/460387-1.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/widget/src/cocoa/crashtests/460387-1.html	Sat Nov 15 19:43:14 2008 -0500
@@ -0,0 +1,2 @@
+<!DOCTYPE html>
+<html><head></head><body><div style="display: table; padding: 625203mm; -moz-appearance: menulist;"></div></body></html>
diff -r a4343d61f6ee widget/src/cocoa/crashtests/crashtests.list
--- a/widget/src/cocoa/crashtests/crashtests.list	Thu Nov 06 18:33:22 2008 +0100
+++ b/widget/src/cocoa/crashtests/crashtests.list	Sat Nov 15 19:43:14 2008 -0500
@@ -1,6 +1,7 @@ load 397209-1.html
 load 397209-1.html
 load 403296-1.xhtml
 load 419737-1.html
 load 444260-1.xul
 load 444864-1.html
 load 449111-1.html
+load 460387-1.html
diff -r a4343d61f6ee widget/src/cocoa/nsChildView.h
--- a/widget/src/cocoa/nsChildView.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/widget/src/cocoa/nsChildView.h	Sat Nov 15 19:43:14 2008 -0500
@@ -124,19 +124,16 @@ enum {
 {
 @private
   NSWindow* mWindow; // shortcut to the top window, [WEAK]
   
   // the nsChildView that created the view. It retains this NSView, so
   // the link back to it must be weak.
   nsChildView* mGeckoChild;
     
-  // tag for our mouse enter/exit tracking rect
-  NSTrackingRectTag mMouseEnterExitTag;
-
   // Whether we're a plugin view.
   BOOL mIsPluginView;
 
   // The following variables are only valid during key down event processing.
   // Their current usage needs to be fixed to avoid problems with nested event
   // loops that can confuse them. Once a variable is set during key down event
   // processing, if an event spawns a nested event loop the previously set value
   // will be wiped out.
diff -r a4343d61f6ee widget/src/cocoa/nsChildView.mm
--- a/widget/src/cocoa/nsChildView.mm	Thu Nov 06 18:33:22 2008 +0100
+++ b/widget/src/cocoa/nsChildView.mm	Sat Nov 15 19:43:14 2008 -0500
@@ -195,16 +195,17 @@ nsIWidget         * gRollupWidget   = ns
 #ifdef ACCESSIBILITY
 - (id<mozAccessible>)accessible;
 #endif
 
 - (BOOL)isFirstResponder;
 
 - (void)fireKeyEventForFlagsChanged:(NSEvent*)theEvent keyDown:(BOOL)isKeyDown;
 
+- (void)initTSMDocument;
 @end
 
 
 #pragma mark -
 
 // Key code constants
 enum
 {
@@ -2414,16 +2415,17 @@ NSEvent* gLastDragEvent = nil;
     mCumulativeMagnification = 0.0;
     mCumulativeRotation = 0.0;
   }
   
   // register for things we'll take from other applications
   PR_LOG(sCocoaLog, PR_LOG_ALWAYS, ("ChildView initWithFrame: registering drag types\n"));
   [self registerForDraggedTypes:[NSArray arrayWithObjects:NSFilenamesPboardType,
                                                           NSStringPboardType,
+                                                          NSHTMLPboardType,
                                                           NSURLPboardType,
                                                           NSFilesPromisePboardType,
                                                           kWildcardPboardType,
                                                           kCorePboardType_url,
                                                           kCorePboardType_urld,
                                                           kCorePboardType_urln,
                                                           nil]];
   [[NSNotificationCenter defaultCenter] addObserver:self
@@ -2739,36 +2741,16 @@ NSEvent* gLastDragEvent = nil;
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_RETURN;
 
   return [scroller floatValue];
 
   NS_OBJC_END_TRY_ABORT_BLOCK_RETURN(0.0);
 }
 
 
-// Override in order to keep our mouse enter/exit tracking rect in sync with
-// the frame of the view
-- (void)setFrame:(NSRect)frameRect
-{
-  NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
-
-  [super setFrame:frameRect];
-  if (mMouseEnterExitTag)
-    [self removeTrackingRect:mMouseEnterExitTag];
-
-  if ([self window])
-    mMouseEnterExitTag = [self addTrackingRect:[self bounds]
-                                         owner:self
-                                      userData:nil
-                                  assumeInside:[[self window] acceptsMouseMovedEvents]];
-
-  NS_OBJC_END_TRY_ABORT_BLOCK;
-}
-
-
 // Make the origin of this view the topLeft corner (gecko origin) rather
 // than the bottomLeft corner (standard cocoa origin).
 - (BOOL)isFlipped
 {
   return YES;
 }
 
 
@@ -2848,35 +2830,20 @@ NSEvent* gLastDragEvent = nil;
   return YES;
 }
 
 
 - (void)viewWillMoveToWindow:(NSWindow *)newWindow
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
-  if (mMouseEnterExitTag)
-    [self removeTrackingRect:mMouseEnterExitTag];
+  if (!newWindow)
+    HideChildPluginViews(self);
 
   [super viewWillMoveToWindow:newWindow];
-
-  NS_OBJC_END_TRY_ABORT_BLOCK;
-}
-
-
-- (void)viewDidMoveToWindow
-{
-  NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
-
-  if ([self window])
-    mMouseEnterExitTag = [self addTrackingRect:[self bounds] owner:self
-                                      userData:nil assumeInside: [[self window]
-                                      acceptsMouseMovedEvents]];
-
-  [super viewDidMoveToWindow];
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
 
 - (void)viewWillStartLiveResize
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
@@ -3145,16 +3112,23 @@ static const PRInt32 sShadowInvalidation
 // the context menu, mouseMoved events will be sent to the window underneath the
 // context menu.
 - (BOOL)ensureCorrectMouseEventTarget:(NSEvent*)anEvent
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_RETURN;
 
   // If there is no rollup widget we assume the OS routed the event correctly.
   if (!gRollupWidget)
+    return YES;
+
+  // Don't bother if we've been destroyed:  mWindow will now be nil, which
+  // makes all our work here pointless, and can even cause us to resend the
+  // event to ourselves in an infinte loop (since targetWindow == mWindow no
+  // longer tests whether targetWindow is us).
+  if (!mGeckoChild || !mWindow)
     return YES;
 
   // If this is the rollup widget and the event is not a mouse move then trust the OS routing.  
   // The reason for this trust is complicated.
   //
   // There are three types of mouse events that can legitimately need to be targeted at a window
   // that they are not over. Mouse moves, mouse drags, and mouse ups. Anything else our app wouldn't
   // handle (if the mouse was not over any window) or it would go to the appropriate window.
@@ -5079,16 +5053,19 @@ GetUSLayoutCharFromKeyTranslate(UInt32 a
 {
 #ifdef DEBUG_IME
   NSLog(@"****in sendCompositionEvent; type = %d", aEventType);
 #endif
 
   if (!mGeckoChild)
     return nsRect(0, 0, 0, 0);
 
+  if (aEventType == NS_COMPOSITION_START)
+    [self initTSMDocument];
+
   // static void init_composition_event( *aEvent, int aType)
   nsCompositionEvent event(PR_TRUE, aEventType, mGeckoChild);
   event.time = PR_IntervalNow();
   mGeckoChild->DispatchWindowEvent(event);
   return event.theReply.mCursorPosition;
 }
 
 
@@ -5186,18 +5163,23 @@ GetUSLayoutCharFromKeyTranslate(UInt32 a
     } else {
       // Note that insertText is not called only at key pressing.
       if (!IsPrintableChar(geckoEvent.charCode)) {
         geckoEvent.keyCode = GetGeckoKeyCodeFromChar(geckoEvent.charCode);
         geckoEvent.charCode = 0;
       }
     }
 
-    mKeyPressHandled = mGeckoChild->DispatchWindowEvent(geckoEvent);
-    mKeyPressSent = YES;
+    PRBool keyPressHandled = mGeckoChild->DispatchWindowEvent(geckoEvent);
+    // Only record the results of dispatching geckoEvent if we're currently
+    // processing a keyDown event.
+    if (mCurKeyEvent) {
+      mKeyPressHandled = keyPressHandled;
+      mKeyPressSent = YES;
+    }
   }
   else {
     if (!nsTSMManager::IsComposing()) {
       [self sendCompositionEvent:NS_COMPOSITION_START];
       // Note: mGeckoChild might have become null here. Don't count on it from here on.
       nsTSMManager::StartComposing(self);
       // Note: mGeckoChild might have become null here. Don't count on it from here on.
     }
@@ -5637,37 +5619,16 @@ static const char* ToEscapedString(NSStr
 
       mKeyPressHandled = mGeckoChild->DispatchWindowEvent(geckoEvent);
       mKeyPressSent = YES;
       if (!mGeckoChild)
         return (mKeyDownHandled || mKeyPressHandled);
     }
   }
 
-  // We need to initialize the TSMDocument *before* interpretKeyEvents when
-  // IME is enabled.
-  if (!isKeyEquiv && nsTSMManager::IsIMEEnabled()) {
-    // We need to get actual focused view. E.g., the view is in bookmark dialog
-    // that is <panel> element. Then, the key events are processed the parent
-    // window's view that has native focus.
-    nsQueryContentEvent textContent(PR_TRUE, NS_QUERY_TEXT_CONTENT,
-                                    mGeckoChild);
-    textContent.InitForQueryTextContent(0, 0);
-    mGeckoChild->DispatchWindowEvent(textContent);
-    NSView<mozView>* focusedView = self;
-    if (textContent.mSucceeded && textContent.mReply.mFocusedWidget) {
-      NSView<mozView>* view =
-        static_cast<NSView<mozView>*>(textContent.mReply.mFocusedWidget->
-                                      GetNativeData(NS_NATIVE_WIDGET));
-      if (view)
-        focusedView = view;
-    }
-    nsTSMManager::InitTSMDocument(focusedView);
-  }
-
   // Let Cocoa interpret the key events, caching IsComposing first.
   // We don't do it if this came from performKeyEquivalent because
   // interpretKeyEvents isn't set up to handle those key combinations.
   PRBool wasComposing = nsTSMManager::IsComposing();
   PRBool interpretKeyEventsCalled = PR_FALSE;
   if (!isKeyEquiv &&
       (nsTSMManager::IsIMEEnabled() || nsTSMManager::IsRomanKeyboardsOnly())) {
     [super interpretKeyEvents:[NSArray arrayWithObject:theEvent]];
@@ -5705,16 +5666,39 @@ static const char* ToEscapedString(NSStr
   mKeyPressHandled = NO;
   mKeyPressSent = NO;
   mCurKeyEvent = nil;
   mKeyDownHandled = PR_FALSE;
 
   return handled;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_RETURN(NO);
+}
+
+- (void)initTSMDocument
+{
+  if (!mGeckoChild)
+    return;
+
+  // We need to get actual focused view. E.g., the view is in bookmark dialog
+  // that is <panel> element. Then, the key events are processed the parent
+  // window's view that has native focus.
+  nsQueryContentEvent textContent(PR_TRUE, NS_QUERY_TEXT_CONTENT,
+                                  mGeckoChild);
+  textContent.InitForQueryTextContent(0, 0);
+  mGeckoChild->DispatchWindowEvent(textContent);
+  NSView<mozView>* focusedView = self;
+  if (textContent.mSucceeded && textContent.mReply.mFocusedWidget) {
+    NSView<mozView>* view =
+      static_cast<NSView<mozView>*>(textContent.mReply.mFocusedWidget->
+                                    GetNativeData(NS_NATIVE_WIDGET));
+    if (view)
+      focusedView = view;
+  }
+  nsTSMManager::InitTSMDocument(focusedView);
 }
 
 
 // Create a TSM document for use with plugins, so that we can support IME in
 // them.  Once it's created, if need be (re)activate it.  Some plugins (e.g.
 // the Flash plugin running in Camino) don't create their own TSM document --
 // without which IME can't work.  Others (e.g. the Flash plugin running in
 // Firefox) create a TSM document that (somehow) makes the input window behave
diff -r a4343d61f6ee widget/src/cocoa/nsClipboard.h
--- a/widget/src/cocoa/nsClipboard.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/widget/src/cocoa/nsClipboard.h	Sat Nov 15 19:43:14 2008 -0500
@@ -35,16 +35,17 @@
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 #ifndef nsClipboard_h_
 #define nsClipboard_h_
 
 #include "nsBaseClipboard.h"
+#include "nsXPIDLString.h"
 
 #import <Cocoa/Cocoa.h>
 
 class nsITransferable;
 
 
 class nsClipboard : public nsBaseClipboard
 {
@@ -54,16 +55,17 @@ public:
   virtual ~nsClipboard();
 
   // nsIClipboard  
   NS_IMETHOD HasDataMatchingFlavors(const char** aFlavorList, PRUint32 aLength,
                                     PRInt32 aWhichClipboard, PRBool *_retval);
 
   // Helper methods, used also by nsDragService
   static NSDictionary* PasteboardDictFromTransferable(nsITransferable *aTransferable);
+  static PRBool IsStringType(const nsCString& aMIMEType, const NSString** aPasteboardType);
 
 protected:
 
   // impelement the native clipboard behavior
   NS_IMETHOD SetNativeClipboardData(PRInt32 aWhichClipboard);
   NS_IMETHOD GetNativeClipboardData(nsITransferable * aTransferable, PRInt32 aWhichClipboard);
   
 private:
diff -r a4343d61f6ee widget/src/cocoa/nsClipboard.mm
--- a/widget/src/cocoa/nsClipboard.mm	Thu Nov 06 18:33:22 2008 +0100
+++ b/widget/src/cocoa/nsClipboard.mm	Sat Nov 15 19:43:14 2008 -0500
@@ -110,16 +110,17 @@ nsClipboard::SetNativeClipboardData(PRIn
   unsigned int outputCount = [pasteboardOutputDict count];
   NSArray* outputKeys = [pasteboardOutputDict allKeys];
   NSPasteboard* generalPBoard = [NSPasteboard generalPasteboard];
   [generalPBoard declareTypes:outputKeys owner:nil];
   for (unsigned int i = 0; i < outputCount; i++) {
     NSString* currentKey = [outputKeys objectAtIndex:i];
     id currentValue = [pasteboardOutputDict valueForKey:currentKey];
     if (currentKey == NSStringPboardType ||
+        currentKey == NSHTMLPboardType ||
         currentKey == kCorePboardType_url ||
         currentKey == kCorePboardType_urld ||
         currentKey == kCorePboardType_urln)
       [generalPBoard setString:currentValue forType:currentKey];
     else
       [generalPBoard setData:currentValue forType:currentKey];
   }
 
@@ -192,18 +193,19 @@ nsClipboard::GetNativeClipboardData(nsIT
     if (!currentFlavor)
       continue;
 
     nsXPIDLCString flavorStr;
     currentFlavor->ToString(getter_Copies(flavorStr)); // i has a flavr
 
     // printf("looking for clipboard data of type %s\n", flavorStr.get());
 
-    if (flavorStr.EqualsLiteral(kUnicodeMime)) {
-      NSString* pString = [cocoaPasteboard stringForType:NSStringPboardType];
+    const NSString *pboardType;
+    if (nsClipboard::IsStringType(flavorStr, &pboardType)) {
+      NSString* pString = [cocoaPasteboard stringForType:pboardType];
       if (!pString)
         continue;
 
       NSData* stringData = [pString dataUsingEncoding:NSUnicodeStringEncoding];
       unsigned int dataLength = [stringData length];
       void* clipboardDataPtr = malloc(dataLength);
       if (!clipboardDataPtr)
         return NS_ERROR_OUT_OF_MEMORY;
@@ -334,19 +336,22 @@ nsClipboard::HasDataMatchingFlavors(cons
         }
       }      
     }    
   }
 
   NSPasteboard* generalPBoard = [NSPasteboard generalPasteboard];
 
   for (PRUint32 i = 0; i < aLength; i++) {
-    if (!strcmp(aFlavorList[i], kUnicodeMime)) {
-      NSString* availableType = [generalPBoard availableTypeFromArray:[NSArray arrayWithObject:NSStringPboardType]];
-      if (availableType && [availableType isEqualToString:NSStringPboardType]) {
+    nsDependentCString mimeType(aFlavorList[i]);
+    const NSString *pboardType;
+
+    if (nsClipboard::IsStringType(mimeType, &pboardType)) {
+      NSString* availableType = [generalPBoard availableTypeFromArray:[NSArray arrayWithObject:pboardType]];
+      if (availableType && [availableType isEqualToString:pboardType]) {
         *outResult = PR_TRUE;
         break;
       }
     } else if (!strcmp(aFlavorList[i], kJPEGImageMime) ||
                !strcmp(aFlavorList[i], kPNGImageMime) ||
                !strcmp(aFlavorList[i], kGIFImageMime)) {
       NSString* availableType = [generalPBoard availableTypeFromArray:
                                   [NSArray arrayWithObjects:IMAGE_PASTEBOARD_TYPES]];
@@ -390,27 +395,30 @@ nsClipboard::PasteboardDictFromTransfera
     if (!currentFlavor)
       continue;
 
     nsXPIDLCString flavorStr;
     currentFlavor->ToString(getter_Copies(flavorStr));
 
     PR_LOG(sCocoaLog, PR_LOG_ALWAYS, ("writing out clipboard data of type %s (%d)\n", flavorStr.get(), i));
 
-    if (flavorStr.EqualsLiteral(kUnicodeMime)) {
+    const NSString *pboardType;
+
+    if (nsClipboard::IsStringType(flavorStr, &pboardType)) {
       void* data = nsnull;
       PRUint32 dataSize = 0;
       nsCOMPtr<nsISupports> genericDataWrapper;
       rv = aTransferable->GetTransferData(flavorStr, getter_AddRefs(genericDataWrapper), &dataSize);
       nsPrimitiveHelpers::CreateDataFromPrimitive(flavorStr, genericDataWrapper, &data, dataSize);
       
       NSString* nativeString = [NSString stringWithCharacters:(const unichar*)data length:(dataSize / sizeof(PRUnichar))];
       // be nice to Carbon apps, normalize the receiver's contents using Form C.
       nativeString = [nativeString precomposedStringWithCanonicalMapping];
-      [pasteboardOutputDict setObject:nativeString forKey:NSStringPboardType];
+
+      [pasteboardOutputDict setObject:nativeString forKey:pboardType];
       
       nsMemory::Free(data);
     }
     else if (flavorStr.EqualsLiteral(kPNGImageMime) || flavorStr.EqualsLiteral(kJPEGImageMime) ||
              flavorStr.EqualsLiteral(kGIFImageMime) || flavorStr.EqualsLiteral(kNativeImageMime)) {
       PRUint32 dataSize = 0;
       nsCOMPtr<nsISupports> transferSupports;
       aTransferable->GetTransferData(flavorStr, getter_AddRefs(transferSupports), &dataSize);
@@ -525,8 +533,22 @@ nsClipboard::PasteboardDictFromTransfera
     // If it wasn't a type that we recognize as exportable we don't put it on the system
     // clipboard. We'll just access it from our cached transferable when we need it.
   }
 
   return pasteboardOutputDict;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NIL;
 }
+
+PRBool nsClipboard::IsStringType(const nsCString& aMIMEType, const NSString** aPasteboardType)
+{
+  if (aMIMEType.EqualsLiteral(kUnicodeMime) ||
+      aMIMEType.EqualsLiteral(kHTMLMime)) {
+    if (aMIMEType.EqualsLiteral(kUnicodeMime))
+      *aPasteboardType = NSStringPboardType;
+    else
+      *aPasteboardType = NSHTMLPboardType;
+    return PR_TRUE;
+  } else {
+    return PR_FALSE;
+  }
+}
diff -r a4343d61f6ee widget/src/cocoa/nsCocoaWindow.mm
--- a/widget/src/cocoa/nsCocoaWindow.mm	Thu Nov 06 18:33:22 2008 +0100
+++ b/widget/src/cocoa/nsCocoaWindow.mm	Sat Nov 15 19:43:14 2008 -0500
@@ -2124,43 +2124,16 @@ void patternDraw(void* aInfo, CGContextR
   [self setFill];
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
 @end
 
 
-// This is an internal Apple class, which we need to work around a bug in. It is
-// the class responsible for drawing the titlebar for metal windows. It actually
-// is a few levels deep in the inhertiance graph, but we don't need to know about
-// all its superclasses.
-@interface NSGrayFrame : NSObject
-+ (void)drawBevel:(NSRect)bevel inFrame:(NSRect)frame topCornerRounded:(BOOL)top;
-+ (void)drawBevel:(NSRect)bevel inFrame:(NSRect)frame topCornerRounded:(BOOL)top bottomCornerRounded:(BOOL)bottom;
-@end
-
-@implementation NSGrayFrame(DrawingBugWorkaround)
-
-// Work around a bug in this method -- it draws a strange 1px border on the left and
-// right edges of a window. We don't want that, so call the similar method defined
-// in the superclass.
-+ (void)drawBevel:(NSRect)bevel inFrame:(NSRect)frame topCornerRounded:(BOOL)top bottomCornerRounded:(BOOL)bottom
-{
-  NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
-
-  if ([self respondsToSelector:@selector(drawBevel:inFrame:topCornerRounded:)])
-    [self drawBevel:bevel inFrame:frame topCornerRounded:top];
-
-  NS_OBJC_END_TRY_ABORT_BLOCK;
-}
-
-@end
-
-
 @interface NSWindow (MethodSwizzling)
 - (void)nsCocoaWindow_NSWindow_sendEvent:(NSEvent *)anEvent;
 @end
 
 @implementation NSWindow (MethodSwizzling)
 
 // An NSLeftMouseDown event can change the focus, but it doesn't always do
 // this correctly/appropriately.  As a result, Gecko keyboard events may be
diff -r a4343d61f6ee widget/src/cocoa/nsDragService.mm
--- a/widget/src/cocoa/nsDragService.mm	Thu Nov 06 18:33:22 2008 +0100
+++ b/widget/src/cocoa/nsDragService.mm	Sat Nov 15 19:43:14 2008 -0500
@@ -133,16 +133,17 @@ static nsresult SetUpDragClipboard(nsISu
     // Gecko is initiating this drag so we always want its own views to consider
     // it. Add our wildcard type to the pasteboard to accomplish this.
     [types addObject:kWildcardPboardType]; // we don't increase the count for the loop below on purpose
     [dragPBoard declareTypes:types owner:nil];
     for (unsigned int i = 0; i < typeCount; i++) {
       NSString* currentKey = [types objectAtIndex:i];
       id currentValue = [pasteboardOutputDict valueForKey:currentKey];
       if (currentKey == NSStringPboardType ||
+          currentKey == NSHTMLPboardType ||
           currentKey == kCorePboardType_url ||
           currentKey == kCorePboardType_urld ||
           currentKey == kCorePboardType_urln) {
         [dragPBoard setString:currentValue forType:currentKey];
       }
       else if (currentKey == NSTIFFPboardType) {
         [dragPBoard setData:currentValue forType:currentKey];
       }
@@ -406,21 +407,23 @@ nsDragService::GetData(nsITransferable* 
 
       nsCOMPtr<nsISupports> genericDataWrapper;
       genericDataWrapper = do_QueryInterface(file);
       aTransferable->SetTransferData(flavorStr, genericDataWrapper, dataLength);
       
       break;
     }
 
-    if (flavorStr.EqualsLiteral(kUnicodeMime) ||
+    const NSString *pboardType = NSStringPboardType;
+
+    if (nsClipboard::IsStringType(flavorStr, &pboardType) ||
         flavorStr.EqualsLiteral(kURLMime) ||
         flavorStr.EqualsLiteral(kURLDataMime) ||
         flavorStr.EqualsLiteral(kURLDescriptionMime)) {
-      NSString* pString = [globalDragPboard stringForType:NSStringPboardType];
+      NSString* pString = [globalDragPboard stringForType:pboardType];
       if (!pString)
         continue;
 
       NSData* stringData = [pString dataUsingEncoding:NSUnicodeStringEncoding];
       unsigned int dataLength = [stringData length];
       void* clipboardDataPtr = malloc(dataLength);
       if (!clipboardDataPtr)
         return NS_ERROR_OUT_OF_MEMORY;
@@ -507,29 +510,31 @@ nsDragService::IsDataFlavorSupported(con
         if (dataFlavor.Equals(flavorStr)) {
           *_retval = PR_TRUE;
           return NS_OK;
         }
       }
     }
   }
 
+  const NSString *pboardType;
+
   if (dataFlavor.EqualsLiteral(kFileMime)) {
     NSString* availableType = [globalDragPboard availableTypeFromArray:[NSArray arrayWithObject:NSFilenamesPboardType]];
     if (availableType && [availableType isEqualToString:NSFilenamesPboardType])
       *_retval = PR_TRUE;
   }
   else if (dataFlavor.EqualsLiteral(kURLMime)) {
     NSString* availableType = [globalDragPboard availableTypeFromArray:[NSArray arrayWithObject:kCorePboardType_url]];
     if (availableType && [availableType isEqualToString:kCorePboardType_url])
       *_retval = PR_TRUE;
   }
-  else if (dataFlavor.EqualsLiteral(kUnicodeMime)) {
-    NSString* availableType = [globalDragPboard availableTypeFromArray:[NSArray arrayWithObject:NSStringPboardType]];
-    if (availableType && [availableType isEqualToString:NSStringPboardType])
+  else if (nsClipboard::IsStringType(dataFlavor, &pboardType)) {
+    NSString* availableType = [globalDragPboard availableTypeFromArray:[NSArray arrayWithObject:pboardType]];
+    if (availableType && [availableType isEqualToString:pboardType])
       *_retval = PR_TRUE;
   }
 
   return NS_OK;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
 }
 
diff -r a4343d61f6ee widget/src/cocoa/nsNativeThemeCocoa.mm
--- a/widget/src/cocoa/nsNativeThemeCocoa.mm	Thu Nov 06 18:33:22 2008 +0100
+++ b/widget/src/cocoa/nsNativeThemeCocoa.mm	Sat Nov 15 19:43:14 2008 -0500
@@ -251,40 +251,43 @@ static void DrawCellWithScaling(NSCell *
     drawRect.size.height = destRect.size.height * naturalSize.width / destRect.size.width;
 
   // Honor minimum sizes.
   if (drawRect.size.width < minimumSize.width)
     drawRect.size.width = minimumSize.width;
   if (drawRect.size.height < minimumSize.height)
     drawRect.size.height = minimumSize.height;
 
-  CGAffineTransform savedCTM = CGContextGetCTM(cgContext);
-  NSGraphicsContext* savedContext = [NSGraphicsContext currentContext];
+  [NSGraphicsContext saveGraphicsState];
 
   if (flip) {
     // This flips the image in place and is necessary to work around a bug in the way
     // NSButtonCell draws buttons.
     CGContextScaleCTM(cgContext, 1.0f, -1.0f);
     CGContextTranslateCTM(cgContext, 0.0f, -(2.0 * destRect.origin.y + destRect.size.height));
   }
 
   // Fall back to no scaling if the area of our cell (in pixels^2) is too large.
   BOOL noBufferOverride = (drawRect.size.width * drawRect.size.height > CELL_SCALING_MAX_AREA);
 
   if ((!needsBuffer && drawRect.size.width == destRect.size.width &&
        drawRect.size.height == destRect.size.height) || noBufferOverride) {
     // Inflate the rect Gecko gave us by the margin for the control.
     InflateControlRect(&drawRect, controlSize, marginSet);
 
+    NSGraphicsContext* savedContext = [NSGraphicsContext currentContext];
+
     // Set up the graphics context we've been asked to draw to.
     [NSGraphicsContext setCurrentContext:[NSGraphicsContext graphicsContextWithGraphicsPort:cgContext flipped:YES]];
 
     // [NSView focusView] may return nil here, but
     // [NSCell drawWithFrame:inView:] can deal with that.
     [cell drawWithFrame:drawRect inView:[NSView focusView]];
+
+    [NSGraphicsContext setCurrentContext:savedContext];
   }
   else {
     float w = ceil(drawRect.size.width);
     float h = ceil(drawRect.size.height);
 
     NSRect tmpRect = NSMakeRect(0.0f, 0.0f, w, h);
 
     // inflate to figure out the frame we need to tell NSCell to draw in, to get something that's 0,0,w,h
@@ -297,16 +300,18 @@ static void DrawCellWithScaling(NSCell *
     CGColorSpaceRef rgb = CGColorSpaceCreateDeviceRGB();
     CGContextRef ctx = CGBitmapContextCreate(NULL,
                                              (int) w, (int) h,
                                              8, (int) w * 4,
                                              rgb, kCGImageAlphaPremultipliedFirst);
     CGColorSpaceRelease(rgb);
 
     CGContextTranslateCTM(ctx, MAX_FOCUS_RING_WIDTH, MAX_FOCUS_RING_WIDTH);
+
+    NSGraphicsContext* savedContext = [NSGraphicsContext currentContext];
 
     [NSGraphicsContext setCurrentContext:[NSGraphicsContext graphicsContextWithGraphicsPort:ctx flipped:YES]];
 
     // [NSView focusView] may return nil here, but
     // [NSCell drawWithFrame:inView:] can deal with that.
     [cell drawWithFrame:tmpRect inView:[NSView focusView]];
 
     [NSGraphicsContext setCurrentContext:savedContext];
@@ -325,19 +330,17 @@ static void DrawCellWithScaling(NSCell *
                                              destRect.size.width + scaledFocusRingX * 2,
                                              destRect.size.height + scaledFocusRingY * 2),
                        img);
 
     CGImageRelease(img);
     CGContextRelease(ctx);
   }
 
-  CGContextSetCTM(cgContext, savedCTM);
-
-  [NSGraphicsContext setCurrentContext:savedContext];
+  [NSGraphicsContext restoreGraphicsState];
 
 #if DRAW_IN_FRAME_DEBUG
   CGContextSetRGBFillColor(cgContext, 0.0, 0.0, 0.5, 0.25);
   CGContextFillRect(cgContext, destRect);
 #endif
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
@@ -2006,17 +2009,20 @@ nsNativeThemeCocoa::ThemeChanged()
   return NS_OK;
 }
 
 
 PRBool 
 nsNativeThemeCocoa::ThemeSupportsWidget(nsPresContext* aPresContext, nsIFrame* aFrame,
                                       PRUint8 aWidgetType)
 {
-  if (aPresContext && !aPresContext->PresShell()->IsThemeSupportEnabled())
+  // We don't have CSS set up to render non-native scrollbars on Mac OS X so we
+  // render natively even if native theme support is disabled.
+  if (aWidgetType != NS_THEME_SCROLLBAR &&
+      aPresContext && !aPresContext->PresShell()->IsThemeSupportEnabled())
     return PR_FALSE;
 
   // if this is a dropdown button in a combobox the answer is always no
   if (aWidgetType == NS_THEME_DROPDOWN_BUTTON) {
     nsIFrame* parentFrame = aFrame->GetParent();
     if (parentFrame && (parentFrame->GetType() == nsWidgetAtoms::comboboxControlFrame))
       return PR_FALSE;
   }
diff -r a4343d61f6ee widget/src/windows/nsDataObj.cpp
--- a/widget/src/windows/nsDataObj.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/widget/src/windows/nsDataObj.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -57,16 +57,42 @@
 #include "nsPrintfCString.h"
 #include "nsIStringBundle.h"
 #include "nsEscape.h"
 #include "nsIURL.h"
 #include "nsNetUtil.h"
 #include "nsXPCOMStrings.h"
 #include "nscore.h"
 #include "prtypes.h"
+#include "nsDirectoryServiceDefs.h"
+
+// XXX Duped from profile/src/nsProfile.cpp.
+#include <stdlib.h>
+#define TABLE_SIZE 36
+static const char table[] =
+    { 'a','b','c','d','e','f','g','h','i','j',
+      'k','l','m','n','o','p','q','r','s','t',
+      'u','v','w','x','y','z','0','1','2','3',
+      '4','5','6','7','8','9' };
+static void
+MakeRandomString(char *buf, PRInt32 bufLen)
+{
+    // turn PR_Now() into milliseconds since epoch
+    // and salt rand with that.
+    double fpTime;
+    LL_L2D(fpTime, PR_Now());
+    srand((uint)(fpTime * 1e-6 + 0.5));   // use 1e-6, granularity of PR_Now() on the mac is seconds
+
+    PRInt32 i;
+    for (i=0;i<bufLen;i++) {
+        *buf++ = table[rand()%TABLE_SIZE];
+    }
+    *buf = 0;
+}
+// XXX
 
 // XXX for older version of PSDK where IAsyncOperation and related stuff is not available
 // but this should be removed when parocles config is updated
 // IAsyncOperation interface GUID
 #ifndef __IAsyncOperation_INTERFACE_DEFINED__
   const IID IID_IAsyncOperation = {0x3D8B0590, 0xF691, 0x11d2, {0x8E, 0xA9, 0x00, 0x60, 0x97, 0xDF, 0x5B, 0xD4}};
 #endif
 
@@ -442,17 +468,17 @@ BOOL nsDataObj::FormatsMatch(const FORMA
 }
 
 //-----------------------------------------------------
 // IDataObject methods
 //-----------------------------------------------------
 STDMETHODIMP nsDataObj::GetData(LPFORMATETC pFE, LPSTGMEDIUM pSTM)
 {
   PRNTDEBUG("nsDataObj::GetData\n");
-  PRNTDEBUG3("  format: %d  Text: %d\n", pFE->cfFormat, CF_TEXT);
+  PRNTDEBUG3("  format: %d  Text: %d\n", pFE->cfFormat, CF_HDROP);
   if ( !mTransferable )
 	  return ResultFromScode(DATA_E_FORMATETC);
 
   PRUint32 dfInx = 0;
 
   static CLIPFORMAT fileDescriptorFlavorA = ::RegisterClipboardFormat( CFSTR_FILEDESCRIPTORA ); 
   static CLIPFORMAT fileDescriptorFlavorW = ::RegisterClipboardFormat( CFSTR_FILEDESCRIPTORW ); 
   static CLIPFORMAT uniformResourceLocatorA = ::RegisterClipboardFormat( CFSTR_INETURLA );
@@ -480,16 +506,21 @@ STDMETHODIMP nsDataObj::GetData(LPFORMAT
         pSTM->pUnkForRelease = NULL;        // caller is responsible for deleting this data
         CLIPFORMAT format = pFE->cfFormat;
         switch(format) {
 
         // Someone is asking for plain or unicode text
         case CF_TEXT:
         case CF_UNICODETEXT:
         return GetText(*df, *pFE, *pSTM);
+
+        // Some 3rd party apps that receive drag and drop files from the browser
+        // window require support for this.
+        case CF_HDROP:
+          return GetFile(*pFE, *pSTM);
 
         // Someone is asking for an image
         case CF_DIB:
           return GetDib(*df, *pFE, *pSTM);
                                               
         // ... not yet implemented ...
         //case CF_BITMAP:
         //  return GetBitmap(*pFE, *pSTM);
@@ -532,33 +563,33 @@ STDMETHODIMP nsDataObj::GetDataHere(LPFO
 
 //-----------------------------------------------------
 // Other objects querying to see if we support a 
 // particular format
 //-----------------------------------------------------
 STDMETHODIMP nsDataObj::QueryGetData(LPFORMATETC pFE)
 {
   PRNTDEBUG("nsDataObj::QueryGetData  ");
-  PRNTDEBUG3("format: %d  Text: %d\n", pFE->cfFormat, CF_TEXT);
+  PRNTDEBUG2("format: %d\n", pFE->cfFormat);
 
   // Arbitrary system formats
   LPDATAENTRY pde;
   if (SUCCEEDED(FindFORMATETC(pFE, &pde, FALSE)))
     return S_OK;
 
   // Firefox internal formats
   ULONG count;
   FORMATETC fe;
   m_enumFE->Reset();
   while (NOERROR == m_enumFE->Next(1, &fe, &count)) {
     if (fe.cfFormat == pFE->cfFormat) {
       return S_OK;
     }
   }
-  
+
   PRNTDEBUG2("***** nsDataObj::QueryGetData - Unknown format %d\n", pFE->cfFormat);
 	return ResultFromScode(E_FAIL);
 }
 
 //-----------------------------------------------------
 STDMETHODIMP nsDataObj::GetCanonicalFormatEtc
 	 (LPFORMATETC pFEIn, LPFORMATETC pFEOut)
 {
@@ -1345,16 +1376,183 @@ HRESULT nsDataObj::GetText(const nsACStr
 
   // Now, delete the memory that was created by CreateDataFromPrimitive (or our text/plain data)
   nsMemory::Free(data);
 
   return ResultFromScode(S_OK);
 }
 
 //-----------------------------------------------------
+HRESULT nsDataObj::GetFile(FORMATETC& aFE, STGMEDIUM& aSTG)
+{
+  HRESULT res = S_OK;
+
+  // We do  not support 'application/x-moz-file-promise' since CF_HDROP does not
+  // allow for delayed rendering of content. We'll need to write the content out emmediately
+  // and return the path to it. Confirm we have support for 'application/x-moz-nativeimage',
+  // if not fail. 
+  PRUint32 dfInx = 0;
+  ULONG count;
+  FORMATETC fe;
+  m_enumFE->Reset();
+  PRBool found = PR_FALSE;
+  while (NOERROR == m_enumFE->Next(1, &fe, &count)) {
+    nsCString * df = reinterpret_cast<nsCString*>(mDataFlavors.SafeElementAt(dfInx));
+    dfInx++;
+    if (df && df->EqualsLiteral(kNativeImageMime)) {
+      found = PR_TRUE;
+      break;
+    }
+  }
+
+  if (!found)
+    return E_FAIL;
+
+  nsresult rv;
+  PRUint32 len = 0;
+  nsCOMPtr<nsISupports> genericDataWrapper;
+
+  mTransferable->GetTransferData(kNativeImageMime, getter_AddRefs(genericDataWrapper), &len);
+  nsCOMPtr<nsIImage> image ( do_QueryInterface(genericDataWrapper) );
+  
+  if (!image) {
+    // In the 0.9.4 timeframe, I had some embedding clients put the nsIImage directly into the
+    // transferable. Newer code, however, wraps the nsIImage in a nsISupportsInterfacePointer.
+    // We should be backwards compatibile with code already out in the field. If we can't find
+    // the image directly out of the transferable,  unwrap the image from its wrapper.
+    nsCOMPtr<nsISupportsInterfacePointer> ptr(do_QueryInterface(genericDataWrapper));
+    if (ptr)
+      ptr->GetData(getter_AddRefs(image));
+  }
+
+  if (!image) 
+    return E_FAIL;
+
+  // Use the clipboard helper class to build up a memory bitmap.
+  nsImageToClipboard converter(image);
+  HANDLE bits = nsnull;
+  rv = converter.GetPicture(&bits); // Clipboard routines return a global handle we own.
+  
+  if (NS_FAILED(rv) || !bits)
+    return E_FAIL;
+
+  // We now own these bits!
+  PRUint32 bitmapSize = GlobalSize(bits);
+  if (!bitmapSize) {
+    GlobalFree(bits);
+    return E_FAIL;
+  }
+
+  if (mCachedTempFile) {
+    mCachedTempFile->Remove(PR_FALSE);
+    mCachedTempFile = NULL;
+  }
+
+  // Save the bitmap to a temporary location.      
+  nsCOMPtr<nsIFile> dropFile;
+  rv = NS_GetSpecialDirectory(NS_OS_TEMP_DIR, getter_AddRefs(dropFile));
+  if (!dropFile)
+    return E_FAIL;
+
+  // Filename must be random so as not to confuse apps like Photshop which handle
+  // multiple drags into a single window.
+  char buf[13];
+  nsCString filename;
+  MakeRandomString(buf, 8);
+  memcpy(buf+8, ".bmp", 5);
+  filename.Append(nsDependentCString(buf, 12));
+  dropFile->AppendNative(filename);
+  rv = dropFile->CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0660);
+  if (NS_FAILED(rv)) { 
+    GlobalFree(bits);
+    return E_FAIL;
+  }
+
+  // Cache the temp file so we can delete it later.
+  dropFile->Clone(getter_AddRefs(mCachedTempFile));
+
+  // Write the data to disk.
+  nsCOMPtr<nsIOutputStream> outStream;
+  rv = NS_NewLocalFileOutputStream(getter_AddRefs(outStream), dropFile);
+  if (NS_FAILED(rv)) { 
+    GlobalFree(bits);
+    return E_FAIL;
+  }
+  
+  char * bm = (char *)GlobalLock(bits);
+
+  BITMAPFILEHEADER	fileHdr;
+  BITMAPINFOHEADER *bmpHdr = (BITMAPINFOHEADER*)bm;
+
+	fileHdr.bfType		    = ((WORD) ('M' << 8) | 'B');
+	fileHdr.bfSize		    = GlobalSize (bits) + sizeof(fileHdr);
+	fileHdr.bfReserved1 	= 0;
+	fileHdr.bfReserved2 	= 0;
+	fileHdr.bfOffBits		  = (DWORD) (sizeof(fileHdr) + bmpHdr->biSize);
+
+  PRUint32 writeCount = 0;
+  if (NS_FAILED(outStream->Write((const char *)&fileHdr, sizeof(fileHdr), &writeCount)) ||
+      NS_FAILED(outStream->Write((const char *)bm, bitmapSize, &writeCount)))
+     rv = NS_ERROR_FAILURE;
+  
+  outStream->Close();
+
+  GlobalUnlock(bits);
+
+  if (NS_FAILED(rv)) { 
+    GlobalFree(bits);
+    return E_FAIL;
+  }
+
+  GlobalFree(bits);
+  
+  // Pass the file name back to the drop target so that it can access the file.
+  nsAutoString path;
+  rv = mCachedTempFile->GetPath(path);
+  if (NS_FAILED(rv))
+    return E_FAIL;
+
+  // Two null characters are needed to terminate the file name list.
+  HGLOBAL hGlobalMemory = NULL;
+
+  PRUint32 allocLen = path.Length() + 2;
+
+  aSTG.tymed = TYMED_HGLOBAL;
+  aSTG.pUnkForRelease = NULL;
+
+  hGlobalMemory = GlobalAlloc(GMEM_MOVEABLE, sizeof(DROPFILES) + allocLen * sizeof(PRUnichar));
+  if (!hGlobalMemory)
+    return E_FAIL;
+
+  DROPFILES* pDropFile = (DROPFILES*)GlobalLock(hGlobalMemory);
+
+  // First, populate the drop file structure.
+  pDropFile->pFiles = sizeof(DROPFILES); // Offset to start of file name char array.
+  pDropFile->fNC    = 0;
+  pDropFile->pt.x   = 0;
+  pDropFile->pt.y   = 0;
+  pDropFile->fWide  = TRUE;
+
+  // Copy the filename right after the DROPFILES structure.
+  PRUnichar* dest = (PRUnichar*)(((char*)pDropFile) + pDropFile->pFiles);
+  memcpy(dest, path.get(), (allocLen - 1) * sizeof(PRUnichar)); // Copies the null character in path as well.
+
+  // Two null characters are needed at the end of the file name.  
+  // Lookup the CF_HDROP shell clipboard format for more info.
+  // Add the second null character right after the first one.
+  dest[allocLen - 1] = L'\0';
+
+  GlobalUnlock(hGlobalMemory);
+
+  aSTG.hGlobal = hGlobalMemory;
+
+  return S_OK;
+}
+
+//-----------------------------------------------------
 HRESULT nsDataObj::GetMetafilePict(FORMATETC&, STGMEDIUM&)
 {
 	return ResultFromScode(E_NOTIMPL);
 }
 
 //-----------------------------------------------------
 HRESULT nsDataObj::SetBitmap(FORMATETC&, STGMEDIUM&)
 {
@@ -1403,32 +1601,21 @@ CLSID nsDataObj::GetClassID() const
 }
 
 //-----------------------------------------------------
 // Registers the DataFlavor/FE pair.
 //-----------------------------------------------------
 void nsDataObj::AddDataFlavor(const char* aDataFlavor, LPFORMATETC aFE)
 {
   // These two lists are the mapping to and from data flavors and FEs.
-  // Later, OLE will tell us it needs a certain type of FORMATETC (text,
+  // Later, OLE will tell us it needs a certain type of FORMATETC (text, unicode, etc)
   // unicode, etc), so we will look up the data flavor that corresponds to
   // the FE and then ask the transferable for that type of data.
-
-#ifndef WINCE
-  // Just ignore the CF_HDROP here
-  // all file drags are now handled by CFSTR_FileContents format
-  if (aFE->cfFormat == CF_HDROP) {
-    return;
-  }  
-  else 
-#endif
-  {
-    mDataFlavors.AppendElement(new nsCString(aDataFlavor));
-    m_enumFE->AddFE(aFE);
-  }
+  mDataFlavors.AppendElement(new nsCString(aDataFlavor));
+  m_enumFE->AddFE(aFE);
 }
 
 //-----------------------------------------------------
 // Sets the transferable object
 //-----------------------------------------------------
 void nsDataObj::SetTransferable(nsITransferable * aTransferable)
 {
     NS_IF_RELEASE(mTransferable);
diff -r a4343d61f6ee widget/src/windows/nsDataObj.h
--- a/widget/src/windows/nsDataObj.h	Thu Nov 06 18:33:22 2008 +0100
+++ b/widget/src/windows/nsDataObj.h	Sat Nov 15 19:43:14 2008 -0500
@@ -219,16 +219,17 @@ class nsDataObj : public IDataObject,
 
 	protected:
 	  // help determine the kind of drag
     PRBool IsFlavourPresent(const char *inFlavour);
 
 		virtual HRESULT AddSetFormat(FORMATETC&  FE);
 		virtual HRESULT AddGetFormat(FORMATETC&  FE);
 
+		virtual HRESULT GetFile ( FORMATETC& aFE, STGMEDIUM& aSTG );
 		virtual HRESULT GetText ( const nsACString& aDF, FORMATETC& aFE, STGMEDIUM & aSTG );
 		virtual HRESULT GetBitmap ( const nsACString& inFlavor, FORMATETC&  FE, STGMEDIUM&  STM);
 		virtual HRESULT GetDib ( const nsACString& inFlavor, FORMATETC &, STGMEDIUM & aSTG );
 		virtual HRESULT GetMetafilePict(FORMATETC&  FE, STGMEDIUM&  STM);
 
     virtual HRESULT GetUniformResourceLocator ( FORMATETC& aFE, STGMEDIUM& aSTG, PRBool aIsUnicode ) ;
     virtual HRESULT ExtractUniformResourceLocatorA ( FORMATETC& aFE, STGMEDIUM& aSTG ) ;
     virtual HRESULT ExtractUniformResourceLocatorW ( FORMATETC& aFE, STGMEDIUM& aSTG ) ;
@@ -267,17 +268,17 @@ class nsDataObj : public IDataObject,
     nsVoidArray mDataFlavors;
 
     nsITransferable  * mTransferable; // nsDataObj owns and ref counts nsITransferable, 
                                       // the nsITransferable does know anything about the nsDataObj
 
     CEnumFormatEtc   * m_enumFE;      // Ownership Rules: 
                                       // nsDataObj owns and ref counts CEnumFormatEtc,
 
-    nsCOMPtr<nsILocalFile> mCachedTempFile;
+    nsCOMPtr<nsIFile> mCachedTempFile;
 
     BOOL mIsAsyncMode;
     BOOL mIsInOperation;
     ///////////////////////////////////////////////////////////////////////////////
     // CStream class implementation
     // this class is used in Drag and drop with download sample
     // called from IDataObject::GetData
     class CStream : public IStream
diff -r a4343d61f6ee widget/src/windows/nsDragService.cpp
--- a/widget/src/windows/nsDragService.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/widget/src/windows/nsDragService.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -303,17 +303,17 @@ nsDragService::StartInvokingDragSession(
   PRUint64 lShellVersion = GetShellVersion();
   IAsyncOperation *pAsyncOp = NULL;
   PRBool isAsyncAvailable = LL_UCMP(lShellVersion, >=, LL_INIT(5, 0));
   if (isAsyncAvailable)
   {
     // do async drag
     if (SUCCEEDED(aDataObj->QueryInterface(IID_IAsyncOperation,
                                           (void**)&pAsyncOp)))
-      pAsyncOp->SetAsyncMode(TRUE);
+      pAsyncOp->SetAsyncMode(VARIANT_TRUE);
   }
 
   // Call the native D&D method
   HRESULT res = ::DoDragDrop(aDataObj, mNativeDragSrc, effects, &winDropRes);
 
   if (isAsyncAvailable)
   {
     // if dragging async
diff -r a4343d61f6ee widget/src/windows/nsWindow.cpp
--- a/widget/src/windows/nsWindow.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/widget/src/windows/nsWindow.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -4847,17 +4847,16 @@ PRBool nsWindow::ProcessMessage(UINT msg
         // the window origin in screen coordinates...
         RECT r;
         ::GetWindowRect(mWnd, &r);
         PRInt32 newWidth, newHeight;
         newWidth = PRInt32(r.right - r.left);
         newHeight = PRInt32(r.bottom - r.top);
         nsRect rect(wp->x, wp->y, newWidth, newHeight);
 
-
 #ifdef MOZ_XUL
         if (eTransparencyTransparent == mTransparencyMode)
           ResizeTranslucentWindow(newWidth, newHeight);
 #endif
 
         if (newWidth > mLastSize.width)
         {
           RECT drect;
@@ -4888,18 +4887,20 @@ PRBool nsWindow::ProcessMessage(UINT msg
         mBounds.width  = newWidth;
         mBounds.height = newHeight;
         mLastSize.width = newWidth;
         mLastSize.height = newHeight;
         ///nsRect rect(wp->x, wp->y, wp->cx, wp->cy);
 
         // If we're being minimized, don't send the resize event to Gecko because
         // it will cause the scrollbar in the content area to go away and we'll
-        // forget the scroll position of the page.
-        if ( !newWidth && !newHeight && IsIconic(mWnd)) {
+        // forget the scroll position of the page.  Note that we need to check the
+        // toplevel window, because child windows seem to go to 0x0 on minimize.
+        HWND toplevelWnd = GetTopLevelHWND(mWnd);
+        if ( !newWidth && !newHeight && IsIconic(toplevelWnd)) {
           result = PR_FALSE;
           break;
         }
 
         // recalculate the width and height
         // this time based on the client area
         if (::GetClientRect(mWnd, &r)) {
           rect.width  = PRInt32(r.right - r.left);
@@ -7871,22 +7872,23 @@ nsWindow :: DealWithPopups ( HWND inWnd,
 
     if (inMsg == WM_LBUTTONDOWN || inMsg == WM_RBUTTONDOWN || inMsg == WM_MBUTTONDOWN ||
         inMsg == WM_MOUSEWHEEL || inMsg == WM_MOUSEHWHEEL || inMsg == WM_ACTIVATE
 #ifndef WINCE
         || 
         inMsg == WM_NCRBUTTONDOWN || 
         inMsg == WM_MOVING || 
         inMsg == WM_SIZING || 
-        inMsg == WM_GETMINMAXINFO ||
         inMsg == WM_NCLBUTTONDOWN || 
         inMsg == WM_NCMBUTTONDOWN ||
         inMsg == WM_MOUSEACTIVATE ||
         inMsg == WM_ACTIVATEAPP ||
         inMsg == WM_MENUSELECT ||
+        // Non-toplevel windows normally don't get WM_GETMINMAXINFO.
+        // Therefore if a non-toplevel window gets this message, we should ignore it.
         (inMsg == WM_GETMINMAXINFO && !::GetParent(inWnd))
 #endif
         )
     {
       // Rollup if the event is outside the popup.
       PRBool rollup = !nsWindow::EventIsInsideWindow(inMsg, (nsWindow*)gRollupWidget);
 
       if (rollup && (inMsg == WM_MOUSEWHEEL || inMsg == WM_MOUSEHWHEEL))
diff -r a4343d61f6ee widget/src/xpwidgets/nsXPLookAndFeel.cpp
--- a/widget/src/xpwidgets/nsXPLookAndFeel.cpp	Thu Nov 06 18:33:22 2008 +0100
+++ b/widget/src/xpwidgets/nsXPLookAndFeel.cpp	Sat Nov 15 19:43:14 2008 -0500
@@ -596,24 +596,24 @@ nsXPLookAndFeel::GetColor(const nsColorI
     // Used with nsISelectionController::SELECTION_ATTENTION
     aColor = NS_RGB(0x38, 0xd8, 0x78);
     return NS_OK;
   }
 
   if (aID == eColor_TextHighlightBackground) {
     // This makes the matched text stand out when findbar highlighting is on
     // Used with nsISelectionController::SELECTION_FIND
-    aColor = NS_RGB(0xf0, 0xe0, 0x20);
+    aColor = NS_RGB(0xef, 0x0f, 0xff);
     return NS_OK;
   }
 
   if (aID == eColor_TextHighlightForeground) {
     // The foreground color for the matched text in findbar highlighting
     // Used with nsISelectionController::SELECTION_FIND
-    aColor = NS_RGB(0x00, 0x00, 0x00);
+    aColor = NS_RGB(0xff, 0xff, 0xff);
     return NS_OK;
   }
 
   if (NS_SUCCEEDED(NativeGetColor(aID, aColor))) {
     if ((gfxPlatform::GetCMSMode() == eCMSMode_All) && !IsSpecialColor(aID, aColor)) {
       cmsHTRANSFORM transform = gfxPlatform::GetCMSInverseRGBTransform();
       if (transform) {
         PRUint8 color[3];
diff -r a4343d61f6ee xpcom/tests/static-checker/Makefile.in
--- a/xpcom/tests/static-checker/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/xpcom/tests/static-checker/Makefile.in	Sat Nov 15 19:43:14 2008 -0500
@@ -36,19 +36,18 @@
 #
 # ***** END LICENSE BLOCK *****
 
 DEPTH = ../../..
 topsrcdir = @top_srcdir@
 srcdir = @srcdir@
 VPATH = @srcdir@
 
-# MAKE_DIRS: List of directories to build while looping over directories.
-MAKE_DIRS               += $(MDDEPDIR)
-GARBAGE_DIRS            += $(MDDEPDIR)
+# We will do compilations that create dependency files.
+NEED_MDDEPDIR = 1
 
 include $(DEPTH)/config/autoconf.mk
 
 FINAL_FAILURE_TESTCASES = \
   TestFinal.cpp \
   TestFinalTemplate.cpp \
   $(NULL)
 
diff -r a4343d61f6ee xpfe/components/build/Makefile.in
--- a/xpfe/components/build/Makefile.in	Thu Nov 06 18:33:22 2008 +0100
+++ b/xpfe/components/build/Makefile.in	Sat Nov 15 19:43:14 2008 -0500
@@ -74,18 +74,21 @@ LOCAL_INCLUDES += -I$(srcdir)/../directo
 # Non-Mac Browser requirements
 ifneq ($(MOZ_BUILD_APP),macbrowser)
 SHARED_LIBRARY_LIBS += ../../browser/src/$(LIB_PREFIX)mozbrwsr_s.$(LIB_SUFFIX)
 LOCAL_INCLUDES += -I$(srcdir)/../../browser/src
 endif
 
 # Suite specific includes
 ifdef MOZ_SUITE
+ifdef SUITE_USING_XPFE_DM
+REQUIRES += downloadmanager
+endif
+
 REQUIRES	+= \
-		downloadmanager \
 		intl \
 		mork \
 		widget \
 		mimetype \
 		autocomplete \
 		$(NULL)
 
 SHARED_LIBRARY_LIBS += \
