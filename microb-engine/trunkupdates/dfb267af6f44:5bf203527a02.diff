diff --git a/.hgtags b/.hgtags
--- a/.hgtags
+++ b/.hgtags
@@ -1,3 +1,4 @@ df7a3c8ffeeaba229067efee5a20e21dae0dd877
 df7a3c8ffeeaba229067efee5a20e21dae0dd877 MOZILLA_1_9_a4_BASE
 4209e16b58411750ac73f761023e46b76b793e2c MOZILLA_1_9_a6_BASE
 66a5c7bce7ee86a820d3c0d54fa07cb719be751c MOZILLA_1_9_a7_BASE
+caeba7562e495a9f604984df0b48b6f99bec3e2e FENNEC_M4
diff --git a/accessible/src/atk/nsAccessibleWrap.cpp b/accessible/src/atk/nsAccessibleWrap.cpp
--- a/accessible/src/atk/nsAccessibleWrap.cpp
+++ b/accessible/src/atk/nsAccessibleWrap.cpp
@@ -1311,29 +1311,32 @@ nsAccessibleWrap::FirePlatformEvent(nsIA
 
     case nsIAccessibleEvent::EVENT_MENU_END:
         MAI_LOG_DEBUG(("\n\nReceived: EVENT_MENU_END\n"));
         break;
 
     case nsIAccessibleEvent::EVENT_WINDOW_ACTIVATE:
       {
         MAI_LOG_DEBUG(("\n\nReceived: EVENT_WINDOW_ACTIVATED\n"));
-        nsDocAccessibleWrap *accDocWrap =
-          static_cast<nsDocAccessibleWrap *>(accessible.get());
-        accDocWrap->mActivated = PR_TRUE;
+        nsRootAccessible *rootAcc =
+          static_cast<nsRootAccessible *>(accessible.get());
+        rootAcc->mActivated = PR_TRUE;
         guint id = g_signal_lookup ("activate", MAI_TYPE_ATK_OBJECT);
         g_signal_emit(atkObj, id, 0);
+
+        // Always fire a current focus event after activation.
+        rootAcc->FireCurrentFocusEvent();
       } break;
 
     case nsIAccessibleEvent::EVENT_WINDOW_DEACTIVATE:
       {
         MAI_LOG_DEBUG(("\n\nReceived: EVENT_WINDOW_DEACTIVATED\n"));
-        nsDocAccessibleWrap *accDocWrap =
-          static_cast<nsDocAccessibleWrap *>(accessible.get());
-        accDocWrap->mActivated = PR_FALSE;
+        nsRootAccessible *rootAcc =
+          static_cast<nsRootAccessible *>(accessible.get());
+        rootAcc->mActivated = PR_FALSE;
         guint id = g_signal_lookup ("deactivate", MAI_TYPE_ATK_OBJECT);
         g_signal_emit(atkObj, id, 0);
       } break;
 
     case nsIAccessibleEvent::EVENT_DOCUMENT_LOAD_COMPLETE:
       {
         MAI_LOG_DEBUG(("\n\nReceived: EVENT_DOCUMENT_LOAD_COMPLETE\n"));
         g_signal_emit_by_name (atkObj, "load_complete");
diff --git a/accessible/src/base/nsAccessibilityAtomList.h b/accessible/src/base/nsAccessibilityAtomList.h
--- a/accessible/src/base/nsAccessibilityAtomList.h
+++ b/accessible/src/base/nsAccessibilityAtomList.h
@@ -152,16 +152,17 @@ ACCESSIBILITY_ATOM(ul, "ul")
   // Alphabetical list of attributes
 ACCESSIBILITY_ATOM(acceltext, "acceltext")
 ACCESSIBILITY_ATOM(accesskey, "accesskey")
 ACCESSIBILITY_ATOM(alt, "alt")
 ACCESSIBILITY_ATOM(anonid, "anonid") // Used for ID's in XBL
 ACCESSIBILITY_ATOM(contenteditable, "contenteditable")
 ACCESSIBILITY_ATOM(control, "control")
 ACCESSIBILITY_ATOM(disabled, "disabled")
+ACCESSIBILITY_ATOM(display, "display")
 ACCESSIBILITY_ATOM(_class, "class")
 ACCESSIBILITY_ATOM(cycles, "cycles") // used for XUL cycler attribute
 ACCESSIBILITY_ATOM(curpos, "curpos") // XUL
 ACCESSIBILITY_ATOM(data, "data")
 ACCESSIBILITY_ATOM(droppable, "droppable")   // XUL combo box
 ACCESSIBILITY_ATOM(editable, "editable")
 ACCESSIBILITY_ATOM(_for, "for")
 ACCESSIBILITY_ATOM(hidden, "hidden")   // XUL tree columns
diff --git a/accessible/src/base/nsAccessible.cpp b/accessible/src/base/nsAccessible.cpp
--- a/accessible/src/base/nsAccessible.cpp
+++ b/accessible/src/base/nsAccessible.cpp
@@ -2112,46 +2112,72 @@ nsAccessible::GetAttributes(nsIPersisten
   if (!nsAccUtils::HasAccGroupAttrs(attributes)) {
     // The role of an accessible can be pointed by ARIA attribute but ARIA
     // posinset, level, setsize may be skipped. Therefore we calculate here
     // these properties to map them into description.
 
     // If accessible is invisible we don't want to calculate group ARIA
     // attributes for it.
     if ((role == nsIAccessibleRole::ROLE_LISTITEM ||
-        role == nsIAccessibleRole::ROLE_MENUITEM ||
-        role == nsIAccessibleRole::ROLE_RADIOBUTTON ||
-        role == nsIAccessibleRole::ROLE_PAGETAB ||
-        role == nsIAccessibleRole::ROLE_OPTION ||
-        role == nsIAccessibleRole::ROLE_RADIOBUTTON ||
-        role == nsIAccessibleRole::ROLE_OUTLINEITEM) &&
+         role == nsIAccessibleRole::ROLE_MENUITEM ||
+         role == nsIAccessibleRole::ROLE_CHECK_MENU_ITEM ||
+         role == nsIAccessibleRole::ROLE_RADIO_MENU_ITEM ||
+         role == nsIAccessibleRole::ROLE_RADIOBUTTON ||
+         role == nsIAccessibleRole::ROLE_PAGETAB ||
+         role == nsIAccessibleRole::ROLE_OPTION ||
+         role == nsIAccessibleRole::ROLE_RADIOBUTTON ||
+         role == nsIAccessibleRole::ROLE_OUTLINEITEM) &&
         0 == (State(this) & nsIAccessibleStates::STATE_INVISIBLE)) {
+
+      PRUint32 baseRole = role;
+      if (role == nsIAccessibleRole::ROLE_CHECK_MENU_ITEM ||
+          role == nsIAccessibleRole::ROLE_RADIO_MENU_ITEM)
+        baseRole = nsIAccessibleRole::ROLE_MENUITEM;
+
       nsCOMPtr<nsIAccessible> parent = GetParent();
       NS_ENSURE_TRUE(parent, NS_ERROR_FAILURE);
 
       PRInt32 positionInGroup = 0;
       PRInt32 setSize = 0;
 
       nsCOMPtr<nsIAccessible> sibling, nextSibling;
       parent->GetFirstChild(getter_AddRefs(sibling));
       NS_ENSURE_TRUE(sibling, NS_ERROR_FAILURE);
 
       PRBool foundCurrent = PR_FALSE;
-      PRUint32 siblingRole;
+      PRUint32 siblingRole, siblingBaseRole;
       while (sibling) {
         sibling->GetFinalRole(&siblingRole);
-        if (siblingRole == role &&
+
+        siblingBaseRole = siblingRole;
+        if (siblingRole == nsIAccessibleRole::ROLE_CHECK_MENU_ITEM ||
+            siblingRole == nsIAccessibleRole::ROLE_RADIO_MENU_ITEM)
+          siblingBaseRole = nsIAccessibleRole::ROLE_MENUITEM;
+
+        // If sibling is visible and has the same base role.
+        if (siblingBaseRole == baseRole &&
             !(State(sibling) & nsIAccessibleStates::STATE_INVISIBLE)) {
           ++ setSize;
           if (!foundCurrent) {
             ++ positionInGroup;
             if (sibling == this)
               foundCurrent = PR_TRUE;
           }
         }
+
+        // If the sibling is separator
+        if (siblingRole == nsIAccessibleRole::ROLE_SEPARATOR) {
+          if (foundCurrent) // the our group is ended
+            break;
+
+          // not our group, continue the searching
+          positionInGroup = 0;
+          setSize = 0;
+        }
+
         sibling->GetNextSibling(getter_AddRefs(nextSibling));
         sibling = nextSibling;
       }
 
       PRInt32 groupLevel = 0;
       if (role == nsIAccessibleRole::ROLE_OUTLINEITEM) {
         groupLevel = 1;
         nsCOMPtr<nsIAccessible> nextParent;
@@ -2248,16 +2274,24 @@ nsAccessible::GetAttributesInternal(nsIP
     if (!sameTypeParent || sameTypeParent == docShellTreeItem)
       break;
     nsIDocument *parentDoc = doc->GetParentDocument();
     if (!parentDoc)
       break;
     startContent = parentDoc->FindContentForSubDocument(doc);      
   }
 
+  // Expose 'display' attribute.
+  nsAutoString displayValue;
+  nsresult rv = GetComputedStyleValue(EmptyString(),
+                                      NS_LITERAL_STRING("display"),
+                                      displayValue);
+  if (NS_SUCCEEDED(rv))
+    nsAccUtils::SetAccAttr(aAttributes, nsAccessibilityAtoms::display,
+                           displayValue);
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsAccessible::GroupPosition(PRInt32 *aGroupLevel,
                             PRInt32 *aSimilarItemsInGroup,
                             PRInt32 *aPositionInGroup)
 {
diff --git a/accessible/src/base/nsRootAccessible.h b/accessible/src/base/nsRootAccessible.h
--- a/accessible/src/base/nsRootAccessible.h
+++ b/accessible/src/base/nsRootAccessible.h
@@ -102,31 +102,35 @@ class nsRootAccessible : public nsDocAcc
       * @param aForceEvent       Fire a focus event even if the last focused item was the same
       * @return                  Boolean -- was a focus event actually fired
       */
     PRBool FireAccessibleFocusEvent(nsIAccessible *aFocusAccessible,
                                     nsIDOMNode *aFocusNode,
                                     nsIDOMEvent *aFocusEvent,
                                     PRBool aForceEvent = PR_FALSE,
                                     PRBool aIsAsynch = PR_FALSE);
+    /**
+      * Fire an accessible focus event for the current focused node,
+      * if there is a focus.
+      */
+    void FireCurrentFocusEvent();
 
     nsCaretAccessible *GetCaretAccessible();
 
   private:
     nsCOMPtr<nsITimer> mFireFocusTimer;
     static void FireFocusCallback(nsITimer *aTimer, void *aClosure);
     
   protected:
     nsresult AddEventListeners();
     nsresult RemoveEventListeners();
     nsresult HandleEventWithTarget(nsIDOMEvent* aEvent,
                                    nsIDOMNode* aTargetNode);
     static void GetTargetNode(nsIDOMEvent *aEvent, nsIDOMNode **aTargetNode);
     void TryFireEarlyLoadEvent(nsIDOMNode *aDocNode);
-    void FireCurrentFocusEvent();
     void GetChromeEventHandler(nsIDOMEventTarget **aChromeTarget);
 
     /**
      * Handles 'TreeRowCountChanged' event. Used in HandleEventWithTarget().
      */
     nsresult HandleTreeRowCountChangedEvent(nsIDOMEvent *aEvent,
                                             nsIAccessibleTreeCache *aAccessible);
 
diff --git a/accessible/src/html/nsHTMLFormControlAccessible.cpp b/accessible/src/html/nsHTMLFormControlAccessible.cpp
--- a/accessible/src/html/nsHTMLFormControlAccessible.cpp
+++ b/accessible/src/html/nsHTMLFormControlAccessible.cpp
@@ -278,25 +278,28 @@ NS_IMETHODIMP nsHTMLButtonAccessible::Ge
 NS_IMETHODIMP nsHTMLButtonAccessible::GetName(nsAString& aName)
 {
   nsCOMPtr<nsIContent> content(do_QueryInterface(mDOMNode));
   if (!content) {
     return NS_ERROR_FAILURE; // Node shut down
   }
 
   nsAutoString name;
-  if (!content->GetAttr(kNameSpaceID_None, nsAccessibilityAtoms::value,
-                        name) &&
-      !content->GetAttr(kNameSpaceID_None, nsAccessibilityAtoms::alt,
-                        name)) {
-    if (mRoleMapEntry) {
-      // Use HTML label or DHTML accessibility's labelledby attribute for name
-      GetHTMLName(name, PR_FALSE);
-    }
-    if (name.IsEmpty()) {
+  // Prefer aria-labelledby attribute for name
+  if (content->HasAttr(kNameSpaceID_None,
+                       nsAccessibilityAtoms::aria_labelledby)) {
+    GetHTMLName(name, PR_FALSE);
+  }
+
+  if (name.IsEmpty()) {
+    // no label from HTML or ARIA
+    if (!content->GetAttr(kNameSpaceID_None, nsAccessibilityAtoms::value,
+                          name) &&
+        !content->GetAttr(kNameSpaceID_None, nsAccessibilityAtoms::alt,
+                          name)) {
       // Use the button's (default) label if nothing else works
       nsIFrame* frame = GetFrame();
       if (frame) {
         nsIFormControlFrame* fcFrame;
         CallQueryInterface(frame, &fcFrame);
         if (fcFrame)
           fcFrame->GetFormProperty(nsAccessibilityAtoms::defaultLabel, name);
       }
@@ -458,27 +461,30 @@ nsHTMLTextFieldAccessible::GetState(PRUi
       *aState |= nsIAccessibleStates::STATE_HASPOPUP;
     }
   }
 
   if (content->HasAttr(kNameSpaceID_None, nsAccessibilityAtoms::readonly)) {
     *aState |= nsIAccessibleStates::STATE_READONLY;
   }
 
-  if (!aExtraState || !(*aExtraState & nsIAccessibleStates::EXT_STATE_EDITABLE))
+  if (!aExtraState)
     return NS_OK;
 
   nsCOMPtr<nsIDOMHTMLInputElement> htmlInput(do_QueryInterface(mDOMNode));
   // Is it an <input> or a <textarea> ?
   if (htmlInput) {
     *aExtraState |= nsIAccessibleStates::EXT_STATE_SINGLE_LINE;
   }
   else {
     *aExtraState |= nsIAccessibleStates::EXT_STATE_MULTI_LINE;
   }
+
+  if (!(*aExtraState & nsIAccessibleStates::EXT_STATE_EDITABLE))
+    return NS_OK;
 
   nsCOMPtr<nsIContent> bindingContent = content->GetBindingParent();
   if (bindingContent &&
       bindingContent->NodeInfo()->Equals(nsAccessibilityAtoms::textbox,
                                          kNameSpaceID_XUL) &&
       bindingContent->AttrValueIs(kNameSpaceID_None, nsAccessibilityAtoms::type,
                                   nsAccessibilityAtoms::autocomplete,
                                   eIgnoreCase)) {
diff --git a/accessible/src/html/nsHyperTextAccessible.cpp b/accessible/src/html/nsHyperTextAccessible.cpp
--- a/accessible/src/html/nsHyperTextAccessible.cpp
+++ b/accessible/src/html/nsHyperTextAccessible.cpp
@@ -1130,16 +1130,18 @@ nsHyperTextAccessible::GetAttributesInte
     nsAutoString strHeadLevel;
     strHeadLevel.AppendInt(headLevel);
     nsAccUtils::SetAccAttr(aAttributes, nsAccessibilityAtoms::level,
                            strHeadLevel);
   }
   
   // Indicate when the current object uses block-level formatting
   // via formatting: block
+  // XXX: 'formatting' attribute is deprecated and will be removed in Mozilla2,
+  // use 'display' attribute instead.
   nsIFrame *frame = GetFrame();
   if (frame && frame->GetType() == nsAccessibilityAtoms::blockFrame) {
     nsAutoString oldValueUnused;
     aAttributes->SetStringProperty(NS_LITERAL_CSTRING("formatting"), NS_LITERAL_STRING("block"),
                                    oldValueUnused);
   }
 
   if (gLastFocusedNode == mDOMNode) {
diff --git a/accessible/tests/mochitest/Makefile.in b/accessible/tests/mochitest/Makefile.in
--- a/accessible/tests/mochitest/Makefile.in
+++ b/accessible/tests/mochitest/Makefile.in
@@ -46,27 +46,31 @@ include $(topsrcdir)/config/rules.mk
 include $(topsrcdir)/config/rules.mk
 
 _TEST_FILES =\
 		moz.png \
 		test_aria_activedescendant.html \
 		test_aria_role_article.html \
 		test_bug368835.xul \
 		test_bug420863.html \
+		test_cssattrs.html \
 		test_groupattrs.xul \
 		test_table_indexes.html \
 		test_nsIAccessibleTable_1.html \
 		test_nsIAccessibleTable_2.html \
 		test_nsIAccessibleTable_3.html \
 		test_nsIAccessibleTable_4.html \
 		test_nsIAccessibleTable_listboxes.xul \
 		test_nsIAccessibleDocument.html \
 		test_nsIAccessibleHyperLink.html \
 		test_nsIAccessibleHyperLink.xul \
 		test_nsIAccessibleHyperText.html \
 		test_nsIAccessibleImage.html \
 		test_nsOuterDocAccessible.html \
+		test_textboxes.html \
+		test_textboxes.xul \
+		testTextboxes.js \
 		test_bug428479.html \
 		test_bug429285.html \
 		$(NULL)
 
 libs:: $(_TEST_FILES)
 	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/a11y/$(relativesrcdir)
diff --git a/accessible/tests/mochitest/testTextboxes.js b/accessible/tests/mochitest/testTextboxes.js
new file mode 100644
--- /dev/null
+++ b/accessible/tests/mochitest/testTextboxes.js
@@ -0,0 +1,93 @@
+const nsIAccessibleRetrieval = Components.interfaces.nsIAccessibleRetrieval;
+
+// Mapping needed state flags for easier handling.
+const state_focusable = 
+      Components.interfaces.nsIAccessibleStates.STATE_FOCUSABLE;
+const state_focused = 
+      Components.interfaces.nsIAccessibleStates.STATE_FOCUSED;
+const state_readonly = 
+      Components.interfaces.nsIAccessibleStates.STATE_READONLY;
+
+const ext_state_multi_line = 
+      Components.interfaces.nsIAccessibleStates.EXT_STATE_MULTI_LINE;
+const ext_state_editable = 
+      Components.interfaces.nsIAccessibleStates.EXT_STATE_EDITABLE;
+const ext_state_required = 
+      Components.interfaces.nsIAccessibleStates.STATE_REQUIRED;
+const ext_state_invalid = 
+      Components.interfaces.nsIAccessibleStates.STATE_INVALID;
+
+// Mapping needed final roles
+const role_entry = Components.interfaces.nsIAccessibleRole.ROLE_ENTRY;
+const role_password_text =
+      Components.interfaces.nsIAccessibleRole.ROLE_PASSWORD_TEXT;
+
+var gAccRetrieval = null;
+
+function testValue(aID, aAcc, aValue, aRole)
+{
+  if (aRole == role_password_text) {
+    var value;
+    try {
+      value = aAcc.value;
+      do_throw("We do not want a value on " + aID + "!");
+    } catch(e) {
+      is(e.result, Components.results.NS_ERROR_FAILURE,
+         "Wrong return value for getValue on " + aID + "!");
+    }
+  } else
+    is(aAcc.value, aValue, "Wrong value for " + aID + "!");
+}
+
+function testStates(aID, aAcc, aState, aExtraState, aAbsentState)
+{
+  var state = {}, extraState = {};
+  aAcc.getFinalState(state, extraState);
+  is(state.value & aState, aState, "wrong state bits for " + aID + "!");
+  is(extraState.value & aExtraState, aExtraState,
+     "wrong extraState bits for " + aID + "!");
+  if (aAbsentState != 0)
+    is(state.value & aAbsentState, 0, "state bits should not be present in ID "
+       + aID + "!");
+  if (state.value & state_readonly)
+    // if state is readonly, ext state must not be ext_state_editable.
+    is(extraState.value & ext_state_editable, 0,
+       "Read-only " + aID + " cannot be editable!");
+}
+
+function testAction(aID, aAcc, aNumActions, aActionName, aActionDescription)
+{
+  var numActions = aAcc.numActions;
+  is(numActions, aNumActions, "Wrong number of actions for " + aID + "!");
+
+  if (numActions != 0) {
+    // Test first action. Normally only 1 should be present.
+    is(aAcc.getActionName(0), aActionName,
+       "Wrong name of action for " + aID + "!");
+    is(aAcc.getActionDescription(0), aActionDescription,
+       "Wrong description of action for " + aID + "!");
+  }
+}
+
+function testThis(aID, aName, aValue, aDescription, aRole, aState,
+                  aExtraState, aAbsentState, aNumActions, aActionName,
+                  aActionDescription)
+{
+  var elem = document.getElementById(aID);
+  var acc = null;
+  try {
+    acc = gAccRetrieval.getAccessibleFor(elem);
+  } catch(e) {}
+  ok(acc, "No accessible for " + aID + "!");
+
+  if (acc) {
+    is(acc.name, aName, "Wrong name for " + aID + "!");
+    testValue(aID, acc, aValue, aRole);
+    is(acc.description, aDescription, "Wrong description for " + aID + "!");
+    is(acc.role, aRole, "Wrong role for " + aID + "!");
+
+    testStates(aID, acc, aState, aExtraState, aAbsentState);
+
+    testAction(aID, acc, aNumActions, aActionName, aActionDescription);
+  }
+}
diff --git a/accessible/tests/mochitest/test_cssattrs.html b/accessible/tests/mochitest/test_cssattrs.html
new file mode 100644
--- /dev/null
+++ b/accessible/tests/mochitest/test_cssattrs.html
@@ -0,0 +1,85 @@
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=439566
+-->
+<head>
+  <title>CSS-like attributes tests</title>
+  <link rel="stylesheet" type="text/css" href="chrome://mochikit/content/tests/SimpleTest/test.css" />
+
+  <script type="application/javascript" src="chrome://mochikit/content/MochiKit/packed.js"></script>
+  <script type="application/javascript" src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"></script>
+
+  <script type="application/javascript">
+    const nsIAccessibleRetrieval = Components.interfaces.nsIAccessibleRetrieval;
+
+    var gAccRetrieval = null;
+
+    function testAttr(aID, aName, aValue)
+    {
+      var acc = null;
+      try {
+        acc = gAccRetrieval.getAccessibleFor(document.getElementById(aID));
+      } catch(e) { }
+
+      if (!acc) {
+        ok(false, "Can't get accessible object for " + aID);
+        return;
+      }
+
+      var attrs = null;
+      try {
+        attrs = acc.attributes;
+      } catch(e) { }
+
+      if (!attrs) {
+        ok(false, "Can't get accessible attributes for " + aID);
+        return;
+      }
+      
+      is(attrs.getStringProperty(aName), aValue,
+         "Accessible with ID " + aID + " has wrong attribute value");
+    }
+
+    function doTest()
+    {
+      gAccRetrieval = Components.classes["@mozilla.org/accessibleRetrieval;1"].
+                      getService(nsIAccessibleRetrieval);
+
+      testAttr("span", "display", "inline");
+      testAttr("div", "display", "block");
+      testAttr("p", "display", "block");
+      testAttr("input", "display", "inline");
+      testAttr("table", "display", "table");
+      testAttr("tr", "display", "table-row");
+      testAttr("td", "display", "table-cell");
+
+      SimpleTest.finish();
+    }
+
+    SimpleTest.waitForExplicitFinish();
+    addLoadEvent(doTest);
+  </script>
+</head>
+<body>
+
+  <a target="_blank"
+     href="https://bugzilla.mozilla.org/show_bug.cgi?id=439566"
+     title="Include the css display property as an IAccessible2 object attribute">
+    Mozilla Bug 439566
+  </a>
+  <p id="display"></p>
+  <div id="content" style="display: none"></div>
+  <pre id="test">
+  </pre>
+
+  <span id="span" role="group">It's span</span>
+  <div id="div">It's div</div>
+  <p id="p">It's paragraph"</p>
+  <input id="input"/>
+  <table id="table">
+    <tr id="tr" role="group">
+      <td id="td">td</td>
+    </tr>
+  </table>
+</body>
+</html>
diff --git a/accessible/tests/mochitest/test_groupattrs.xul b/accessible/tests/mochitest/test_groupattrs.xul
--- a/accessible/tests/mochitest/test_groupattrs.xul
+++ b/accessible/tests/mochitest/test_groupattrs.xul
@@ -25,29 +25,40 @@
           return "";
         }
       }
 
       this.mAcc = gAccService.getAccessibleFor(document.getElementById(aId));
       this.mAttrs = this.mAcc.attributes;
     }
 
+    function testGroupAtts(aID, aPosInSet, aSetSize)
+    {
+      var attrs = new accAttributes(aID);
+      is(attrs.getAttribute("posinset"), aPosInSet, "Wrong posinset on " + aID);
+      is(attrs.getAttribute("setsize"), aSetSize, "Wrong setsize on " + aID);
+    }
+
     function doTest()
     {
       // Activate accessibility, otherwise events aren't fired.
       gAccService = Components.classes["@mozilla.org/accessibleRetrieval;1"].
                     getService(Components.interfaces.nsIAccessibleRetrieval);
 
-      var attrs = new accAttributes("item1");
-      is(attrs.getAttribute("posinset"), "1", "Wrong posinset on item1.");
-      is(attrs.getAttribute("setsize"), "2", "Wrong setsize on item1.");
+      //////////////////////////////////////////////////////////////////////////
+      // xul:listbox (bug 417317)
+      testGroupAtts("item1", "1", "2");
+      testGroupAtts("item2", "2", "2");
 
-      attrs = new accAttributes("item2");
-      is(attrs.getAttribute("posinset"), "2", "Wrong posinset on item2.");
-      is(attrs.getAttribute("setsize"), "2", "Wrong setsize on item2.");
+      //////////////////////////////////////////////////////////////////////////
+      // ARIA menu (bug 441888)
+      testGroupAtts("aria-menuitem", "1", "3");
+      testGroupAtts("aria-menuitemcheckbox", "2", "3");
+      testGroupAtts("aria-menuitemradio", "3", "3");
+      testGroupAtts("aria-menuitem2", "1", "1");
 
       SimpleTest.finish();
     }
 
     SimpleTest.waitForExplicitFinish();
     addLoadEvent(doTest);
   ]]>
   </script>
@@ -64,10 +75,24 @@
     <pre id="test">
     </pre>
   </body>
 
   <listbox>
     <listitem label="item1" id="item1"/>
     <listitem label="item2" id="item2"/>
   </listbox>
+
+  <vbox>
+    <description role="menuitem" id="aria-menuitem"
+                 value="conventional menuitem"/>
+    <description role="menuitemcheckbox" id="aria-menuitemcheckbox"
+                 value="conventional checkbox menuitem"/>
+    <description role="menuitem" hidden="true"/>
+    <description role="menuitemradio" id="aria-menuitemradio"
+                 value="conventional radio menuitem"/>
+    <description role="separator"
+                 value="conventional separator"/>
+    <description role="menuitem" id="aria-menuitem2"
+                 value="conventional menuitem"/>
+  </vbox>
 </window>
 
diff --git a/accessible/tests/mochitest/test_textboxes.html b/accessible/tests/mochitest/test_textboxes.html
new file mode 100644
--- /dev/null
+++ b/accessible/tests/mochitest/test_textboxes.html
@@ -0,0 +1,186 @@
+<!DOCTYPE html>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=442648
+-->
+<head>
+  <title>nsIAccessible textboxes chrome tests</title>
+  <link rel="stylesheet" type="text/css" href="chrome://mochikit/content/tests/SimpleTest/test.css" />
+
+  <script type="application/javascript" src="chrome://mochikit/content/MochiKit/packed.js"></script>
+  <script type="application/javascript" src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"></script>
+
+  <script type="application/javascript" src="chrome://mochikit/content/a11y/accessible/testTextboxes.js"></script>
+
+  <script type="application/javascript">
+    function doTest()
+    {
+      gAccRetrieval = Components.classes["@mozilla.org/accessibleRetrieval;1"].
+                      getService(nsIAccessibleRetrieval);
+
+      //////////////////////////////////////////////////////////////////////////
+      // normal textbox without content and with no proper label
+      testThis("unlabelled_Textbox", // ID
+               null, // name
+               "", // value
+               "", // description
+               role_entry, // role
+               (state_focusable), // state
+               (ext_state_editable), // extState
+               (state_readonly), // absentState
+               1, // numActions
+               "activate",  // ActionName
+               "Activate"); // ActionDescription
+
+      //////////////////////////////////////////////////////////////////////////
+      // normal textbox without content and with a proper label
+      testThis("labelled_textbox", // ID
+               "Second textbox:", // name
+               "", // value
+               "", // description
+               role_entry, // role
+               (state_focusable), // state
+               (ext_state_editable), // extState
+               (state_readonly), // absentState
+               1, // numActions
+               "activate",  // ActionName
+               "Activate"); // ActionDescription
+
+      //////////////////////////////////////////////////////////////////////////
+      // normal textbox with content and with a proper label
+      testThis("prefilled_textbox", // ID
+               "Textbox with predefined value:", // name
+               "I have some text", // value
+               "", // description
+               role_entry, // role
+               (state_focusable), // state
+               (ext_state_editable), // extState
+               (state_readonly), // absentState
+               1, // numActions
+               "activate",  // ActionName
+               "Activate"); // ActionDescription
+
+      //////////////////////////////////////////////////////////////////////////
+      // password textbox with a proper label
+      testThis("password_textbox", // ID
+               "Enter some password here:", // name
+               "", // value
+               "", // description
+               role_password_text, // role
+               (state_focusable), // state
+               (ext_state_editable), // extState
+               (state_readonly), // absentState
+               1, // numActions
+               "activate",  // ActionName
+               "Activate"); // ActionDescription
+
+      //////////////////////////////////////////////////////////////////////////
+      // textarea without content and label
+      testThis("unlabelled_Textarea", // ID
+               null, // name
+               "", // value
+               "", // description
+               role_entry, // role
+               (state_focusable), // state
+               (ext_state_editable | ext_state_multi_line), // extState
+               (state_readonly), // absentState
+               1, // numActions
+               "activate",  // ActionName
+               "Activate"); // ActionDescription
+
+      //////////////////////////////////////////////////////////////////////////
+      // textarea without content and with proper label
+      testThis("labelled_textarea", // ID
+               "Labelled textarea:", // name
+               "", // value
+               "", // description
+               role_entry, // role
+               (state_focusable), // state
+               (ext_state_editable | ext_state_multi_line), // extState
+               (state_readonly), // absentState
+               1, // numActions
+               "activate",  // ActionName
+               "Activate"); // ActionDescription
+
+      //////////////////////////////////////////////////////////////////////////
+      // textarea with content and with proper label
+      testThis("prefilled_textarea", // ID
+               "Pre-filled textarea:", // name
+               "    I also have some text.\n    ", // value
+               "", // description
+               role_entry, // role
+               (state_focusable), // state
+               (ext_state_editable | ext_state_multi_line), // extState
+               (state_readonly), // absentState
+               1, // numActions
+               "activate",  // ActionName
+               "Activate"); // ActionDescription
+
+      //////////////////////////////////////////////////////////////////////////
+      // readonly textbox with content and with proper label
+      testThis("readonly_textbox", // ID
+               "The following is a read-only textbox:", // name
+               "You cannot change me.", // value
+               "", // description
+               role_entry, // role
+               (state_focusable | state_readonly), // state
+               (0), // extState
+               (0), // absentState
+               1, // numActions
+               "activate",  // ActionName
+               "Activate"); // ActionDescription
+
+      //////////////////////////////////////////////////////////////////////////
+      // readonly textarea with content and with proper label
+      testThis("readonly_textarea", // ID
+               "This textarea is readonly, too:", // name
+               "    You cannot change me, either.\n    ", // value
+               "", // description
+               role_entry, // role
+               (state_focusable | state_readonly), // state
+               (ext_state_multi_line), // extState
+               (0), // absentState
+               1, // numActions
+               "activate",  // ActionName
+               "Activate"); // ActionDescription
+
+      SimpleTest.finish();
+    }
+
+    SimpleTest.waitForExplicitFinish();
+    addLoadEvent(doTest);
+  </script>
+</head>
+<body>
+
+  <a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=442648">Mozilla Bug 442648</a>
+  <p id="display"></p>
+  <div id="content" style="display: none"></div>
+  <pre id="test">
+  </pre>
+  <form action="test.php" method="post">
+    Text before input without labelling it:
+    <input type="text" name="unlabelled_Textbox" id="unlabelled_Textbox" size="50"/>
+    <br><label for="labelled_textbox">Second textbox:</label>
+    <input type="text" name="labelled_Textbox" id="labelled_textbox"/>
+    <br><label for="prefilled_textbox">Textbox with predefined value:</label>
+    <input type="text" name="prefilled_Textbox" id="prefilled_textbox" value="I have some text" size="80"/>
+    <br><label for="password_textbox">Enter some password here:</label>
+    <input type="password" name="password_Textbox" id="password_textbox"/>
+    <br>Textarea without label:<br>
+    <textarea id="unlabelled_Textarea" name="unlabelled_Textarea" cols="80" rows="5"></textarea>
+    <br><label for="labelled_textarea">Labelled textarea:</label><br>
+    <textarea id="labelled_textarea" name="labelled_Textarea" cols="80" rows="5"></textarea>
+    <br><label for="prefilled_textarea">Pre-filled textarea:</label><br>
+    <textarea id="prefilled_textarea" name="prefilled_Textarea" cols="80" rows="5">
+    I also have some text.
+    </textarea>
+    <br><label for="readonly_textbox">The following is a read-only textbox:</label>
+    <input type="text" readonly="true" name="readonly_Textbox" id="readonly_textbox" value="You cannot change me."/>
+    <br><label for="readonly_textarea">This textarea is readonly, too:</label><br>
+    <textarea name="readonly_Textarea" id="readonly_textarea" readonly="true" cols="80" rows="5">
+    You cannot change me, either.
+    </textarea>
+  </form>
+</body>
+</html>
diff --git a/accessible/tests/mochitest/test_textboxes.xul b/accessible/tests/mochitest/test_textboxes.xul
new file mode 100644
--- /dev/null
+++ b/accessible/tests/mochitest/test_textboxes.xul
@@ -0,0 +1,210 @@
+<?xml version="1.0"?>
+<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
+<?xml-stylesheet href="chrome://mochikit/content/tests/SimpleTest/test.css"
+                 type="text/css"?>
+
+<window xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+        title="nsIAccessible XUL textboxes chrome tests">
+
+  <script type="application/javascript" 
+          src="chrome://mochikit/content/MochiKit/packed.js"></script>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js" />
+
+  <script type="application/javascript"
+          src="chrome://mochikit/content/a11y/accessible/testTextboxes.js"></script>
+
+  <script type="application/javascript">
+  <![CDATA[
+    function doTest()
+    {
+      gAccRetrieval = Components.classes["@mozilla.org/accessibleRetrieval;1"].
+                      getService(nsIAccessibleRetrieval);
+
+      //////////////////////////////////////////////////////////////////////////
+      // normal textbox without content and with no proper label
+      testThis("unlabelled_Textbox", // ID
+               "", // name
+               "", // value
+               "", // description
+               role_entry, // role
+               (state_focusable), // state
+               (ext_state_editable), // extState
+               (state_readonly), // absentState
+               1, // numActions
+               "activate",  // ActionName
+               "Activate"); // ActionDescription
+
+      //////////////////////////////////////////////////////////////////////////
+      // normal textbox without content and with a proper label
+      testThis("labelled_textbox", // ID
+               "Second textbox:", // name
+               "", // value
+               "", // description
+               role_entry, // role
+               (state_focusable), // state
+               (ext_state_editable), // extState
+               (state_readonly), // absentState
+               1, // numActions
+               "activate",  // ActionName
+               "Activate"); // ActionDescription
+
+      //////////////////////////////////////////////////////////////////////////
+      // normal textbox with content and with a proper label
+      testThis("prefilled_textbox", // ID
+               "Textbox with predefined value:", // name
+               "I have some text", // value
+               "", // description
+               role_entry, // role
+               (state_focusable), // state
+               (ext_state_editable), // extState
+               (state_readonly), // absentState
+               1, // numActions
+               "activate",  // ActionName
+               "Activate"); // ActionDescription
+
+      //////////////////////////////////////////////////////////////////////////
+      // password textbox with a proper label
+      testThis("password_textbox", // ID
+               "Enter some password here:", // name
+               "", // value
+               "", // description
+               role_password_text, // role
+               (state_focusable), // state
+               (ext_state_editable), // extState
+               (state_readonly), // absentState
+               1, // numActions
+               "activate",  // ActionName
+               "Activate"); // ActionDescription
+
+      //////////////////////////////////////////////////////////////////////////
+      // textarea without content and label
+      testThis("unlabelled_Textarea", // ID
+               "", // name
+               "", // value
+               "", // description
+               role_entry, // role
+               (state_focusable), // state
+               (ext_state_editable | ext_state_multi_line), // extState
+               (state_readonly), // absentState
+               1, // numActions
+               "activate",  // ActionName
+               "Activate"); // ActionDescription
+
+      //////////////////////////////////////////////////////////////////////////
+      // textarea without content and with proper label
+      testThis("labelled_textarea", // ID
+               "Labelled textarea:", // name
+               "", // value
+               "", // description
+               role_entry, // role
+               (state_focusable), // state
+               (ext_state_editable | ext_state_multi_line), // extState
+               (state_readonly), // absentState
+               1, // numActions
+               "activate",  // ActionName
+               "Activate"); // ActionDescription
+
+      //////////////////////////////////////////////////////////////////////////
+      // textarea with content and with proper label
+      testThis("prefilled_textarea", // ID
+               "Pre-filled textarea:", // name
+               "I also have some text.", // value
+               "", // description
+               role_entry, // role
+               (state_focusable), // state
+               (ext_state_editable | ext_state_multi_line), // extState
+               (state_readonly), // absentState
+               1, // numActions
+               "activate",  // ActionName
+               "Activate"); // ActionDescription
+
+      //////////////////////////////////////////////////////////////////////////
+      // readonly textbox with content and with proper label
+      testThis("readonly_textbox", // ID
+               "The following is a read-only textbox:", // name
+               "You cannot change me.", // value
+               "", // description
+               role_entry, // role
+               (state_focusable | state_readonly), // state
+               (0), // extState
+               (0), // absentState
+               1, // numActions
+               "activate",  // ActionName
+               "Activate"); // ActionDescription
+
+      //////////////////////////////////////////////////////////////////////////
+      // readonly textarea with content and with proper label
+      testThis("readonly_textarea", // ID
+               "This textarea is readonly, too:", // name
+               "You cannot change me, either.", // value
+               "", // description
+               role_entry, // role
+               (state_focusable | state_readonly), // state
+               (ext_state_multi_line), // extState
+               (0), // absentState
+               1, // numActions
+               "activate",  // ActionName
+               "Activate"); // ActionDescription
+
+      SimpleTest.finish();
+    }
+
+    SimpleTest.waitForExplicitFinish();
+    addLoadEvent(doTest);
+  ]]>
+  </script>
+
+  <body xmlns="http://www.w3.org/1999/xhtml">
+    <a target="_blank"
+       href="https://bugzilla.mozilla.org/show_bug.cgi?id=442648">
+      Mozilla Bug 442648
+    </a>
+    <p id="display"></p>
+    <div id="content" style="display: none"></div>
+    <pre id="test">
+    </pre>
+  </body>
+
+  <vbox>
+    <hbox>
+      <label value="Text before input without labelling it:"/>
+      <textbox id="unlabelled_Textbox" size="50"/>
+    </hbox>
+    <hbox>
+      <label control="labelled_textbox">Second textbox:</label>
+      <textbox id="labelled_textbox"/>
+    </hbox>
+    <hbox>
+      <label control="prefilled_textbox">Textbox with predefined value:</label>
+      <textbox id="prefilled_textbox" value="I have some text" size="80"/>
+    </hbox>
+    <hbox>
+      <label control="password_textbox">Enter some password here:</label>
+      <textbox type="password" id="password_textbox"/>
+    </hbox>
+    <vbox>
+      <label value="Textarea without label:"/>
+      <textbox multiline="true" id="unlabelled_Textarea" cols="80" rows="5"/>
+    </vbox>
+    <vbox>
+      <label control="labelled_textarea">Labelled textarea:</label>
+      <textbox multiline="true" id="labelled_textarea" cols="80" rows="5"/>
+    </vbox>
+    <vbox>
+      <label control="prefilled_textarea">Pre-filled textarea:</label>
+      <textbox multiline="true" id="prefilled_textarea" cols="80" rows="5"
+               value="I also have some text."/>
+    </vbox>
+    <hbox>
+      <label control="readonly_textbox">The following is a read-only textbox:</label>
+      <textbox readonly="true" id="readonly_textbox"
+               value="You cannot change me."/>
+    </hbox>
+    <vbox>
+      <label control="readonly_textarea">This textarea is readonly, too:</label>
+      <textbox multiline="true" id="readonly_textarea" readonly="true" cols="80"
+               rows="5" value="You cannot change me, either."/>
+    </vbox>
+  </vbox>
+</window>
diff --git a/browser/app/profile/firefox.js b/browser/app/profile/firefox.js
--- a/browser/app/profile/firefox.js
+++ b/browser/app/profile/firefox.js
@@ -628,18 +628,25 @@ pref("urlclassifier.gethashnoise", 4);
 // The list of tables that use the gethash request to confirm partial results.
 pref("urlclassifier.gethashtables", "goog-phish-shavar,goog-malware-shavar");
 
 // If an urlclassifier table has not been updated in this number of seconds,
 // a gethash request will be forced to check that the result is still in
 // the database.
 pref("urlclassifier.confirm-age", 2700);
 
+#ifdef MOZ_WIDGET_GTK2
+#define RESTRICT_CACHEMAX
+#endif
+#ifdef XP_OS2
+#define RESTRICT_CACHEMAX
+#endif
+
 // Maximum size of the sqlite3 cache during an update, in bytes
-#ifdef MOZ_WIDGET_GTK2
+#ifdef RESTRICT_CACHEMAX
 pref("urlclassifier.updatecachemax", 104857600);
 #else
 pref("urlclassifier.updatecachemax", -1);
 #endif
 
 // URL for checking the reason for a malware warning.
 pref("browser.safebrowsing.malware.reportURL", "http://safebrowsing.clients.google.com/safebrowsing/diagnostic?client=%NAME%&hl=%LOCALE%&site=");
 
diff --git a/browser/base/content/browser-menubar.inc b/browser/base/content/browser-menubar.inc
--- a/browser/base/content/browser-menubar.inc
+++ b/browser/base/content/browser-menubar.inc
@@ -397,17 +397,17 @@
 
   <menu id="bookmarksMenu" 
         label="&bookmarksMenu.label;" accesskey="&bookmarksMenu.accesskey;"
         ondragenter="PlacesMenuDNDController.onBookmarksMenuDragEnter(event);"
         ondragdrop="nsDragAndDrop.drop(event, BookmarksMenuDropHandler);"
         ondragover="nsDragAndDrop.dragOver(event, BookmarksMenuDropHandler);">
     <menupopup id="bookmarksMenuPopup"
                type="places"
-               place="place:folder=BOOKMARKS_MENU&amp;expandQueries=1"
+               place="place:folder=BOOKMARKS_MENU"
                context="placesContext"
                openInTabs="children"
                oncommand="BookmarksEventHandler.onCommand(event);"
                onclick="BookmarksEventHandler.onClick(event);"
                onpopupshowing="BookmarksEventHandler.onPopupShowing(event);">
       <menuitem label="&bookmarkThisPageCmd.label;"
                 command="Browser:AddBookmarkAs" key="addBookmarkAsKb"/>
       <menuitem id="subscribeToPageMenuitem"
@@ -427,19 +427,21 @@
                 command="Browser:BookmarkAllTabs" key="bookmarkAllTabsKb"/>
       <menuitem id="bookmarksShowAll"
                 label="&organizeBookmarks.label;"
                 command="Browser:ShowAllBookmarks"
                 key="manBookmarkKb"/>
       <menuseparator id="organizeBookmarksSeparator"/>
       <menu id="bookmarksToolbarFolderMenu"
             class="menu-iconic bookmark-item"
+            label="&personalbarCmd.label;"
             container="true">
         <menupopup id="bookmarksToolbarFolderPopup"
                    type="places"
+                   place="place:folder=TOOLBAR"
                    context="placesContext"
                    onpopupshowing="BookmarksEventHandler.onPopupShowing(event);"/>
       </menu>
       <menuseparator builder="start"/>
     </menupopup>
   </menu>
 
             <menu id="tools-menu" label="&toolsMenu.label;" accesskey="&toolsMenu.accesskey;">
diff --git a/browser/base/content/browser.js b/browser/base/content/browser.js
--- a/browser/base/content/browser.js
+++ b/browser/base/content/browser.js
@@ -256,30 +256,16 @@ function BookmarkThisTab()
   var tab = getBrowser().mContextTab;
   if (tab.localName != "tab")
     tab = getBrowser().mCurrentTab;
 
   PlacesCommandHook.bookmarkPage(tab.linkedBrowser,
                                  PlacesUtils.bookmarksMenuFolderId, true);
 }
 
-/**
- * Initialize the bookmarks toolbar and the menuitem for it.
- */
-function initBookmarksToolbar() {
-  var place = PlacesUtils.getQueryStringForFolder(PlacesUtils.bookmarks.toolbarFolder);
-  var bt = document.getElementById("bookmarksBarContent");
-  if (bt)
-    bt.place = place;
-
-  document.getElementById("bookmarksToolbarFolderPopup").place = place;
-  document.getElementById("bookmarksToolbarFolderMenu").label =
-    PlacesUtils.bookmarks.getItemTitle(PlacesUtils.bookmarks.toolbarFolder);
-}
-
 const gSessionHistoryObserver = {
   observe: function(subject, topic, data)
   {
     if (topic != "browser:purge-session-history")
       return;
 
     var backCommand = document.getElementById("Browser:Back");
     backCommand.setAttribute("disabled", "true");
@@ -668,32 +654,55 @@ const gXPInstallObserver = {
   }
 };
 
 function BrowserStartup()
 {
   gBrowser = document.getElementById("content");
 
   var uriToLoad = null;
-  // Check for window.arguments[0]. If present, use that for uriToLoad.
+
+  // window.arguments[0]: URI to load (string), or an nsISupportsArray of
+  //                      nsISupportsStrings to load
+  //                 [1]: character set (string)
+  //                 [2]: referrer (nsIURI)
+  //                 [3]: postData (nsIInputStream)
+  //                 [4]: allowThirdPartyFixup (bool)
   if ("arguments" in window && window.arguments[0])
     uriToLoad = window.arguments[0];
 
   gIsLoadingBlank = uriToLoad == "about:blank";
 
   prepareForStartup();
 
 #ifdef ENABLE_PAGE_CYCLER
   appCore.startPageCycler();
 #else
 # only load url passed in when we're not page cycling
   if (uriToLoad && !gIsLoadingBlank) {
-    if (window.arguments.length >= 3)
+    if (uriToLoad instanceof Components.interfaces.nsISupportsArray) {
+      var count = uriToLoad.Count();
+      var specs = [];
+      for (var i = 0; i < count; i++) {
+        var urisstring = uriToLoad.GetElementAt(i).QueryInterface(Components.interfaces.nsISupportsString);
+        specs.push(urisstring.data);
+      }
+
+      // This function throws for certain malformed URIs, so use exception handling
+      // so that we don't disrupt startup
+      try {
+        gBrowser.loadTabs(specs, false, true);
+      } catch (e) {}
+    }
+    else if (window.arguments.length >= 3) {
       loadURI(uriToLoad, window.arguments[2], window.arguments[3] || null,
               window.arguments[4] || false);
+    }
+    // Note: loadOneOrMoreURIs *must not* be called if window.arguments.length >= 3.
+    // Such callers expect that window.arguments[0] is handled as a single URI.
     else
       loadOneOrMoreURIs(uriToLoad);
   }
 #endif
 
   var sidebarSplitter;
   if (window.opener && !window.opener.closed) {
     var openerFindBar = window.opener.gFindBar;
@@ -922,17 +931,17 @@ function delayedStartup()
     sidebar.setAttribute("src", sidebarBox.getAttribute("src"));
   }
 
   UpdateUrlbarSearchSplitterState();
   
   try {
     placesMigrationTasks();
   } catch(ex) {}
-  initBookmarksToolbar();
+
   PlacesStarButton.init();
 
   // called when we go into full screen, even if it is
   // initiated by a web page script
   window.addEventListener("fullscreen", onFullScreen, true);
 
   if (gIsLoadingBlank && gURLBar && isElementVisible(gURLBar))
     focusElement(gURLBar);
@@ -1206,19 +1215,16 @@ function nonBrowserWindowDelayedStartup(
   gPrefService = Components.classes["@mozilla.org/preferences-service;1"]
                            .getService(Components.interfaces.nsIPrefBranch2);
 
   // initialise the offline listener
   BrowserOffline.init();
   
   // Set up Sanitize Item
   gSanitizeListener = new SanitizeListener();
-
-  // "Bookmarks Toolbar" menu
-  initBookmarksToolbar();
 }
 
 function nonBrowserWindowShutdown()
 {
   if (gSanitizeListener)
     gSanitizeListener.shutdown();
 
   BrowserOffline.uninit();
@@ -3288,18 +3294,16 @@ function BrowserToolboxCustomizeDone(aTo
       document.getElementById("Browser:Reload").getAttribute("disabled") == "true";
   }
 
 #ifdef XP_MACOSX
   // make sure to re-enable click-and-hold
   if (!getBoolPref("ui.click_hold_context_menus", false))
     SetClickAndHoldHandlers();
 #endif
-
-  initBookmarksToolbar();
 
 #ifndef TOOLBAR_CUSTOMIZATION_SHEET
   // XXX Shouldn't have to do this, but I do
   window.focus();
 #endif
 }
 
 function BrowserToolboxCustomizeChange() {
@@ -4303,17 +4307,19 @@ nsBrowserAccess.prototype =
           aWhere = gPrefService.getIntPref("browser.link.open_newwindow");
       }
     }
     switch(aWhere) {
       case Ci.nsIBrowserDOMWindow.OPEN_NEWWINDOW :
         // FIXME: Bug 408379. So how come this doesn't send the
         // referrer like the other loads do?
         var url = aURI ? aURI.spec : "about:blank";
-        newWindow = openDialog(getBrowserURL(), "_blank", "all,dialog=no", url);
+        // Pass all params to openDialog to ensure that "url" isn't passed through
+        // loadOneOrMoreURIs, which splits based on "|"
+        newWindow = openDialog(getBrowserURL(), "_blank", "all,dialog=no", url, null, null, null);
         break;
       case Ci.nsIBrowserDOMWindow.OPEN_NEWTAB :
         var win = this._getMostRecentBrowserWindow();
         if (!win) {
           // we couldn't find a suitable window, a new one needs to be opened.
           return null;
         }
         var loadInBackground = gPrefService.getBoolPref("browser.tabs.loadDivertedInBackground");
@@ -5055,31 +5061,29 @@ function BrowserSetForcedDetector(doRelo
 {
   getBrowser().documentCharsetInfo.forcedDetector = true;
   if (doReload)
     BrowserReloadWithFlags(nsIWebNavigation.LOAD_FLAGS_CHARSET_CHANGE);
 }
 
 function UpdateCurrentCharset()
 {
-    var menuitem = null;
-
-    // exctract the charset from DOM
+    // extract the charset from DOM
     var wnd = document.commandDispatcher.focusedWindow;
     if ((window == wnd) || (wnd == null)) wnd = window.content;
-    menuitem = document.getElementById('charset.' + wnd.document.characterSet);
-
+
+    // Uncheck previous item
+    if (gPrevCharset) {
+        var pref_item = document.getElementById('charset.' + gPrevCharset);
+        if (pref_item)
+          pref_item.setAttribute('checked', 'false');
+    }
+
+    var menuitem = document.getElementById('charset.' + wnd.document.characterSet);
     if (menuitem) {
-        // uncheck previously checked item to workaround Mac checkmark problem
-        // bug 98625
-        if (gPrevCharset) {
-            var pref_item = document.getElementById('charset.' + gPrevCharset);
-            if (pref_item)
-              pref_item.setAttribute('checked', 'false');
-        }
         menuitem.setAttribute('checked', 'true');
     }
 }
 
 function UpdateCharsetDetector()
 {
     var prefvalue;
 
diff --git a/browser/base/content/browser.xul b/browser/base/content/browser.xul
--- a/browser/base/content/browser.xul
+++ b/browser/base/content/browser.xul
@@ -387,18 +387,20 @@
                      label="&printButton.label;" command="cmd_print"
                      tooltiptext="&printButton.tooltip;"/>
 
       <toolbaritem id="throbber-box" title="&throbberItem.title;" align="center" pack="center">
         <button id="navigator-throbber" disabled="true"/>
       </toolbaritem>
 
       <toolbaritem flex="1" id="personal-bookmarks" title="&bookmarksItem.title;">
-         <hbox id="bookmarksBarContent" flex="1" type="places"
-               context="placesContext" asyncinit="true"
+         <hbox id="bookmarksBarContent" flex="1"
+               type="places"
+               place="place:folder=TOOLBAR"
+               context="placesContext"
                onclick="BookmarksEventHandler.onClick(event);"
                oncommand="BookmarksEventHandler.onCommand(event);"
                onpopupshowing="BookmarksEventHandler.onPopupShowing(event);"
                tooltip="btTooltip"/>
       </toolbaritem>
 
         <toolbarbutton id="downloads-button" class="toolbarbutton-1 chromeclass-toolbar-additional"
                        observes="Tools:Downloads"
diff --git a/browser/components/migration/src/nsSafariProfileMigrator.cpp b/browser/components/migration/src/nsSafariProfileMigrator.cpp
--- a/browser/components/migration/src/nsSafariProfileMigrator.cpp
+++ b/browser/components/migration/src/nsSafariProfileMigrator.cpp
@@ -975,18 +975,18 @@ nsSafariProfileMigrator::ParseBookmarksF
       continue;
 
     if (!type.EqualsLiteral("WebBookmarkTypeList") &&
         !type.EqualsLiteral("WebBookmarkTypeLeaf"))
       continue;
 
     if (::CFDictionaryContainsKey(entry, CFSTR("Children")) &&
         type.EqualsLiteral("WebBookmarkTypeList")) {
-      nsCAutoString title;
-      if (!GetDictionaryCStringValue(entry, CFSTR("Title"), title, kCFStringEncodingUTF8))
+      nsAutoString title;
+      if (!GetDictionaryStringValue(entry, CFSTR("Title"), title))
         continue;
 
       CFArrayRef children = (CFArrayRef)::CFDictionaryGetValue(entry,
                                                                CFSTR("Children"));
 
       // Look for the BookmarksBar Bookmarks and add them into the appropriate
       // Personal Toolbar Root
       if (title.EqualsLiteral("BookmarksBar") && aIsAtRootLevel) {
@@ -1004,17 +1004,17 @@ nsSafariProfileMigrator::ParseBookmarksF
                                    aParentFolder,
                                    aBookmarksService,
                                    PR_TRUE);
       }
       else {
         // Encountered a Folder, so create one in our Bookmarks DataSource and then
         // parse the contents of the Safari one into it...
         PRInt64 folder;
-        rv |= aBookmarksService->CreateFolder(aParentFolder, title,
+        rv |= aBookmarksService->CreateFolder(aParentFolder, NS_ConvertUTF16toUTF8(title),
                                               nsINavBookmarksService::DEFAULT_INDEX,
                                               &folder);
         rv |= ParseBookmarksFolder(children,
                                    folder,
                                    aBookmarksService,
                                    PR_FALSE);
       }
     }
diff --git a/browser/components/nsBrowserContentHandler.js b/browser/components/nsBrowserContentHandler.js
--- a/browser/components/nsBrowserContentHandler.js
+++ b/browser/components/nsBrowserContentHandler.js
@@ -171,27 +171,70 @@ function copyPrefOverride() {
     var prefSvcObs = Components.classes["@mozilla.org/preferences-service;1"]
                                .getService(Components.interfaces.nsIObserver);
     prefSvcObs.observe(null, "reload-default-prefs", null);
   } catch (ex) {
     Components.utils.reportError(ex);
   }
 }
 
-function openWindow(parent, url, target, features, args) {
+// Flag used to indicate that the arguments to openWindow can be passed directly.
+const NO_EXTERNAL_URIS = 1;
+
+function openWindow(parent, url, target, features, args, noExternalArgs) {
   var wwatch = Components.classes["@mozilla.org/embedcomp/window-watcher;1"]
                          .getService(nsIWindowWatcher);
 
-  var argstring;
-  if (args) {
-    argstring = Components.classes["@mozilla.org/supports-string;1"]
+  if (noExternalArgs == NO_EXTERNAL_URIS) {
+    // Just pass in the defaultArgs directly
+    var argstring;
+    if (args) {
+      argstring = Components.classes["@mozilla.org/supports-string;1"]
                             .createInstance(nsISupportsString);
-    argstring.data = args;
+      argstring.data = args;
+    }
+
+    return wwatch.openWindow(parent, url, target, features, argstring);
   }
-  return wwatch.openWindow(parent, url, target, features, argstring);
+  
+  // Pass an array to avoid the browser "|"-splitting behavior.
+  var argArray = Components.classes["@mozilla.org/supports-array;1"]
+                    .createInstance(Components.interfaces.nsISupportsArray);
+
+  // add args to the arguments array
+  var stringArgs = null;
+  if (args instanceof Array) // array
+    stringArgs = args;
+  else if (args) // string
+    stringArgs = [args];
+
+  if (stringArgs) {
+    // put the URIs into argArray
+    var uriArray = Components.classes["@mozilla.org/supports-array;1"]
+                       .createInstance(Components.interfaces.nsISupportsArray);
+    stringArgs.forEach(function (uri) {
+      var sstring = Components.classes["@mozilla.org/supports-string;1"]
+                              .createInstance(nsISupportsString);
+      sstring.data = uri;
+      uriArray.AppendElement(sstring);
+    });
+    argArray.AppendElement(uriArray);
+  } else {
+    argArray.AppendElement(null);
+  }
+
+  // Pass these as null to ensure that we always trigger the "single URL"
+  // behavior in browser.js's BrowserStartup (which handles the window
+  // arguments)
+  argArray.AppendElement(null); // charset
+  argArray.AppendElement(null); // referer
+  argArray.AppendElement(null); // postData
+  argArray.AppendElement(null); // allowThirdPartyFixup
+
+  return wwatch.openWindow(parent, url, target, features, argArray);
 }
 
 function openPreferences() {
   var features = "chrome,titlebar,toolbar,centerscreen,dialog=no";
   var url = "chrome://browser/content/preferences/preferences.xul";
 
   var win = getMostRecentWindow("Browser:Preferences");
   if (win) {
@@ -311,19 +354,20 @@ var nsBrowserContentHandler = {
       throw Components.results.NS_ERROR_NO_INTERFACE;
 
     return this;
   },
 
   /* nsICommandLineHandler */
   handle : function bch_handle(cmdLine) {
     if (cmdLine.handleFlag("browser", false)) {
+      // Passing defaultArgs, so use NO_EXTERNAL_URIS
       openWindow(null, this.chromeURL, "_blank",
                  "chrome,dialog=no,all" + this.getFeatures(cmdLine),
-                 this.defaultArgs);
+                 this.defaultArgs, NO_EXTERNAL_URIS);
       cmdLine.preventDefault = true;
     }
 
     try {
       var remoteCommand = cmdLine.handleFlagWithParam("remote", true);
     }
     catch (e) {
       throw NS_ERROR_ABORT;
@@ -374,19 +418,20 @@ var nsBrowserContentHandler = {
           handURIToExistingBrowser(uri, target, cmdLine);
           break;
 
         case "xfedocommand":
           // xfeDoCommand(openBrowser)
           if (remoteParams[0].toLowerCase() != "openbrowser")
             throw NS_ERROR_ABORT;
 
+          // Passing defaultArgs, so use NO_EXTERNAL_URIS
           openWindow(null, this.chromeURL, "_blank",
                      "chrome,dialog=no,all" + this.getFeatures(cmdLine),
-                     this.defaultArgs);
+                     this.defaultArgs, NO_EXTERNAL_URIS);
           break;
 
         default:
           // Somebody sent us a remote command we don't know how to process:
           // just abort.
           throw "Unknown remote command.";
         }
 
@@ -437,17 +482,17 @@ var nsBrowserContentHandler = {
         cmdLine.preventDefault = true;
       } else try {
         // only load URIs which do not inherit chrome privs
         var features = "chrome,dialog=no,all" + this.getFeatures(cmdLine);
         var uri = resolveURIInternal(cmdLine, chromeParam);
         var netutil = Components.classes["@mozilla.org/network/util;1"]
                                 .getService(nsINetUtil);
         if (!netutil.URIChainHasFlags(uri, URI_INHERITS_SECURITY_CONTEXT)) {
-          openWindow(null, uri.spec, "_blank", features, "");
+          openWindow(null, uri.spec, "_blank", features);
           cmdLine.preventDefault = true;
         }
       }
       catch (e) {
         Components.utils.reportError(e);
       }
     }
     if (cmdLine.handleFlag("preferences", false)) {
@@ -769,33 +814,29 @@ var nsDefaultCommandLineHandler = {
         try {
           handURIToExistingBrowser(urilist[0], nsIBrowserDOMWindow.OPEN_DEFAULTWINDOW, cmdLine);
           return;
         }
         catch (e) {
         }
       }
 
-      var speclist = [];
-      for (uri in urilist) {
-        if (shouldLoadURI(urilist[uri]))
-          speclist.push(urilist[uri].spec);
-      }
-
-      if (speclist.length) {
+      var URLlist = urilist.filter(shouldLoadURI).map(function (u) u.spec);
+      if (URLlist.length) {
         openWindow(null, nsBrowserContentHandler.chromeURL, "_blank",
                    "chrome,dialog=no,all" + nsBrowserContentHandler.getFeatures(cmdLine),
-                   speclist.join("|"));
+                   URLlist);
       }
 
     }
     else if (!cmdLine.preventDefault) {
+      // Passing defaultArgs, so use NO_EXTERNAL_URIS
       openWindow(null, nsBrowserContentHandler.chromeURL, "_blank",
                  "chrome,dialog=no,all" + nsBrowserContentHandler.getFeatures(cmdLine),
-                 nsBrowserContentHandler.defaultArgs);
+                 nsBrowserContentHandler.defaultArgs, NO_EXTERNAL_URIS);
     }
   },
 
   // XXX localize me... how?
   helpInfo : "Usage: firefox [-flags] [<url>]\n",
 
   /* nsIFactory */
   createInstance: function dch_CI(outer, iid) {
diff --git a/browser/components/places/content/places.js b/browser/components/places/content/places.js
--- a/browser/components/places/content/places.js
+++ b/browser/components/places/content/places.js
@@ -743,17 +743,17 @@ var PlacesOrganizer = {
                    getService(Ci.nsIIOService).
                    newURI(placeSpec, null, null);
 
     // Prompt the user for a name for the query.
     // XXX - using prompt service for now; will need to make
     // a real dialog and localize when we're sure this is the UI we want.
     var title = PlacesUIUtils.getString("saveSearch.title");
     var inputLabel = PlacesUIUtils.getString("saveSearch.inputLabel");
-    var defaultText = PlacesUIUtils.getString("saveSearch.defaultText");
+    var defaultText = PlacesUIUtils.getString("saveSearch.inputDefaultText");
 
     var prompts = Cc["@mozilla.org/embedcomp/prompt-service;1"].
                   getService(Ci.nsIPromptService);
     var check = {value: false};
     var input = {value: defaultText};
     var save = prompts.prompt(null, title, inputLabel, input, null, check);
 
     // Don't add the query if the user cancels or clears the seach name.
diff --git a/browser/components/places/content/tree.xml b/browser/components/places/content/tree.xml
--- a/browser/components/places/content/tree.xml
+++ b/browser/components/places/content/tree.xml
@@ -648,21 +648,23 @@
           }
 
           findNodes(this.getResultNode());
 
           // For all the nodes we've found, highlight the corresponding
           // index in the tree.
           var resultview = this.getResultView();
           var selection = this.view.selection;
+          selection.selectEventsSuppressed = true;
           selection.clearSelection();
           for (var i=0; i < nodes.length; i++) {
             var index = resultview.treeIndexForNode(nodes[i]);
             selection.rangedSelect(index, index, true);
           }
+          selection.selectEventsSuppressed = false;
         ]]></body>
       </method>
 
       <!-- nsDragAndDrop -->
       <method name="onDragStart">
         <parameter name="event"/>
         <parameter name="xferData"/>
         <parameter name="dragAction"/>
diff --git a/browser/components/places/public/nsIPlacesTransactionsService.idl b/browser/components/places/public/nsIPlacesTransactionsService.idl
--- a/browser/components/places/public/nsIPlacesTransactionsService.idl
+++ b/browser/components/places/public/nsIPlacesTransactionsService.idl
@@ -45,16 +45,20 @@ interface nsIMicrosummary;
 interface nsIMicrosummary;
 interface nsITransaction;
 
 /**
  * nsIPlacesTransactionService is a service designed to handle
  * nsITransactions that correspond to changes in Places. It is here as a
  * service so that we can keep the transactions around without holding onto
  * the global scope of a js window.
+ *
+ * NOTE: If you are interacting directly with the Places back-end, and you
+ *       need to transactionalize a large amount of changes, look at
+ *       nsINavBookmarksService.runInBatchMode.
  */
 
 [scriptable, uuid(7179d28c-bc41-4110-8225-b3ba7e1cb293)]
 interface nsIPlacesTransactionsService : nsITransactionManager
 {
   /**
    * Transaction for performing several Places Transactions in a single batch. 
    * 
diff --git a/browser/components/places/src/nsPlacesImportExportService.cpp b/browser/components/places/src/nsPlacesImportExportService.cpp
--- a/browser/components/places/src/nsPlacesImportExportService.cpp
+++ b/browser/components/places/src/nsPlacesImportExportService.cpp
@@ -90,17 +90,16 @@
  * both require the content (= title) before actually creating it.
  */
 
 #include "nsPlacesImportExportService.h"
 #include "nsNetUtil.h"
 #include "nsParserCIID.h"
 #include "nsStringAPI.h"
 #include "nsUnicharUtils.h"
-#include "plbase64.h"
 #include "nsAppDirectoryServiceDefs.h"
 #include "nsDirectoryServiceUtils.h"
 #include "nsIPrefService.h"
 #include "nsToolkitCompsCID.h"
 #include "nsIHTMLContentSink.h"
 #include "nsIParser.h"
 #include "prprf.h"
 #include "nsVoidArray.h"
@@ -419,17 +418,17 @@ protected:
   {
     NS_ASSERTION(mFrames.Length() > 1, "Asking for frame when there are not enough!");
     return mFrames[mFrames.Length() - 2];
   }
   nsresult NewFrame();
   nsresult PopFrame();
 
   nsresult SetFaviconForURI(nsIURI* aPageURI, nsIURI* aFaviconURI,
-                            const nsCString& aData);
+                            const nsString& aData);
 
   PRInt64 ConvertImportedIdToInternalId(const nsCString& aId);
   PRTime ConvertImportedDateToInternalDate(const nsACString& aDate);
 
 #ifdef DEBUG_IMPORT
   // prints spaces for indenting to the current frame depth
   void PrintNesting()
   {
@@ -945,18 +944,17 @@ BookmarkContentSink::HandleLinkBegin(con
     }
   }
 
   // save the favicon, ignore errors
   if (!icon.IsEmpty() || !iconUri.IsEmpty()) {
     nsCOMPtr<nsIURI> iconUriObject;
     NS_NewURI(getter_AddRefs(iconUriObject), iconUri);
     if (!icon.IsEmpty() || iconUriObject) {
-      rv = SetFaviconForURI(frame.mPreviousLink, iconUriObject,
-                            NS_ConvertUTF16toUTF8(icon));
+      rv = SetFaviconForURI(frame.mPreviousLink, iconUriObject, icon);
     }
   }
 
   // save the keyword, ignore errors
   if (!keyword.IsEmpty()) {
     mBookmarksService->SetKeywordForBookmark(frame.mPreviousId, keyword);
 
     // post data
@@ -1270,17 +1268,17 @@ BookmarkContentSink::PopFrame()
 //
 //    When aIconURI is null, we have to make up a URI for this favicon so that
 //    it can be stored in the service. The real one will be set the next time
 //    the user visits the page. Our made up one should get expired when the
 //    page no longer references it.
 
 nsresult
 BookmarkContentSink::SetFaviconForURI(nsIURI* aPageURI, nsIURI* aIconURI,
-                                      const nsCString& aData)
+                                      const nsString& aData)
 {
   nsresult rv;
   static PRUint32 serialNumber = 0; // for made-up favicon URIs
 
   nsCOMPtr<nsIFaviconService> faviconService(do_GetService(NS_FAVICONSERVICE_CONTRACTID, &rv));
   NS_ENSURE_SUCCESS(rv, rv);
 
   // if the input favicon URI is a chrome: URI, then we just save it and don't
@@ -1310,63 +1308,23 @@ BookmarkContentSink::SetFaviconForURI(ns
     char buf[32];
     PR_snprintf(buf, sizeof(buf), "%lld", PR_Now());
     faviconSpec.Append(buf);
     rv = NS_NewURI(getter_AddRefs(faviconURI), faviconSpec);
     NS_ENSURE_SUCCESS(rv, rv);
     serialNumber++;
   }
 
-  nsCOMPtr<nsIURI> dataURI;
-  rv = NS_NewURI(getter_AddRefs(dataURI), aData);
+  // save in service
+  rv = faviconService->SetFaviconDataFromDataURL(faviconURI, aData, 0);
   NS_ENSURE_SUCCESS(rv, rv);
 
-  // use the data: protocol handler to convert the data
-  nsCOMPtr<nsIIOService> ioService = do_GetIOService(&rv);
-  NS_ENSURE_SUCCESS(rv, rv);
-  nsCOMPtr<nsIProtocolHandler> protocolHandler;
-  rv = ioService->GetProtocolHandler("data", getter_AddRefs(protocolHandler));
+  rv = faviconService->SetFaviconUrlForPage(aPageURI, faviconURI);
   NS_ENSURE_SUCCESS(rv, rv);
 
-  nsCOMPtr<nsIChannel> channel;
-  rv = protocolHandler->NewChannel(dataURI, getter_AddRefs(channel));
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  // blocking stream is OK for data URIs
-  nsCOMPtr<nsIInputStream> stream;
-  rv = channel->Open(getter_AddRefs(stream));
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  PRUint32 available;
-  rv = stream->Available(&available);
-  NS_ENSURE_SUCCESS(rv, rv);
-  if (available == 0)
-    return NS_ERROR_FAILURE;
-
-  // read all the decoded data
-  PRUint8* buffer = static_cast<PRUint8*>
-                               (nsMemory::Alloc(sizeof(PRUint8) * available));
-  if (!buffer)
-    return NS_ERROR_OUT_OF_MEMORY;
-  PRUint32 numRead;
-  rv = stream->Read(reinterpret_cast<char*>(buffer), available, &numRead);
-  if (NS_FAILED(rv) || numRead != available) {
-    nsMemory::Free(buffer);
-    return rv;
-  }
-
-  nsCAutoString mimeType;
-  rv = channel->GetContentType(mimeType);
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  // save in service
-  rv = faviconService->SetFaviconData(faviconURI, buffer, available, mimeType, 0);
-  nsMemory::Free(buffer);
-  NS_ENSURE_SUCCESS(rv, rv);
-  rv = faviconService->SetFaviconUrlForPage(aPageURI, faviconURI);
   return NS_OK; 
 }
 
 // Converts a string id (ITEM_ID) into an int id
 PRInt64
 BookmarkContentSink::ConvertImportedIdToInternalId(const nsCString& aId) {
   PRInt64 intId = 0;
   if (aId.IsEmpty())
@@ -1491,37 +1449,16 @@ WriteContainerEpilogue(const nsACString&
   nsresult rv = aOutput->Write(PromiseFlatCString(aIndent).get(), aIndent.Length(), &dummy);
   NS_ENSURE_SUCCESS(rv, rv);
   rv = aOutput->Write(kBookmarkClose, sizeof(kBookmarkClose)-1, &dummy);
   NS_ENSURE_SUCCESS(rv, rv);
   return NS_OK;
 }
 
 
-// DataToDataURI
-
-static nsresult
-DataToDataURI(PRUint8* aData, PRUint32 aDataLen, const nsACString& aMimeType,
-              nsACString& aDataURI)
-{
-  char* encoded = PL_Base64Encode(reinterpret_cast<const char*>(aData),
-                                  aDataLen, nsnull);
-  if (!encoded)
-    return NS_ERROR_OUT_OF_MEMORY;
-
-  aDataURI.AssignLiteral("data:");
-  aDataURI.Append(aMimeType);
-  aDataURI.AppendLiteral(";base64,");
-  aDataURI.Append(encoded);
-
-  nsMemory::Free(encoded);
-  return NS_OK;
-}
-
-
 // WriteFaviconAttribute
 //
 //    This writes the 'ICON="data:asdlfkjas;ldkfja;skdljfasdf"' attribute for
 //    an item. We special-case chrome favicon URIs by just writing the chrome:
 //    URI.
 
 static nsresult
 WriteFaviconAttribute(const nsACString& aURI, nsIOutputStream* aOutput)
@@ -1555,32 +1492,24 @@ WriteFaviconAttribute(const nsACString& 
   rv = WriteEscapedUrl(faviconSpec, aOutput);
   NS_ENSURE_SUCCESS(rv, rv);
   rv = aOutput->Write(kQuoteStr, sizeof(kQuoteStr)-1, &dummy);
   NS_ENSURE_SUCCESS(rv, rv);
 
   if (!faviconScheme.EqualsLiteral("chrome")) {
     // only store data for non-chrome URIs
 
-    // get the data - BE SURE TO FREE
-    nsCAutoString mimeType;
-    PRUint32 dataLen;
-    PRUint8* data;
-    rv = faviconService->GetFaviconData(faviconURI, mimeType, &dataLen, &data);
+    nsAutoString faviconContents;
+    rv = faviconService->GetFaviconDataAsDataURL(faviconURI, faviconContents);
     NS_ENSURE_SUCCESS(rv, rv);
-    if (dataLen > 0) {
-      // convert to URI
-      nsCString faviconContents;
-      rv = DataToDataURI(data, dataLen, mimeType, faviconContents);
-      nsMemory::Free(data);
-      NS_ENSURE_SUCCESS(rv, rv);
-
+    if (faviconContents.Length() > 0) {
       rv = aOutput->Write(kIconAttribute, sizeof(kIconAttribute)-1, &dummy);
       NS_ENSURE_SUCCESS(rv, rv);
-      rv = aOutput->Write(faviconContents.get(), faviconContents.Length(), &dummy);
+      NS_ConvertUTF16toUTF8 utf8Favicon(faviconContents);
+      rv = aOutput->Write(utf8Favicon.get(), utf8Favicon.Length(), &dummy);
       NS_ENSURE_SUCCESS(rv, rv);
       rv = aOutput->Write(kQuoteStr, sizeof(kQuoteStr)-1, &dummy);
       NS_ENSURE_SUCCESS(rv, rv);
     }
   }
   return NS_OK;
 }
 
diff --git a/browser/components/places/tests/unit/test_bookmarks_html.js b/browser/components/places/tests/unit/test_bookmarks_html.js
--- a/browser/components/places/tests/unit/test_bookmarks_html.js
+++ b/browser/components/places/tests/unit/test_bookmarks_html.js
@@ -59,16 +59,23 @@ try {
 
 // Get livemark service
 try {
   var livemarksvc = Cc["@mozilla.org/browser/livemark-service;2"].getService(Ci.nsILivemarkService);
 } catch(ex) {
   do_throw("Could not get livemark service\n");
 } 
 
+// Get favicon service
+try {
+  var iconsvc = Cc["@mozilla.org/browser/favicon-service;1"].getService(Ci.nsIFaviconService);
+} catch(ex) {
+  do_throw("Could not get favicon service\n");
+} 
+
 // Get microsummary service
 try {
   var mssvc = Cc["@mozilla.org/microsummary/service;1"].getService(Ci.nsIMicrosummaryService);
 } catch(ex) {
   do_throw("Could not get microsummary service\n");
 }
 
 // Get io service
@@ -76,16 +83,19 @@ try {
   var iosvc = Cc["@mozilla.org/network/io-service;1"].getService(Ci.nsIIOService);
 } catch (ex) {
   do_throw("Could not get io service\n");
 }
 
 const DESCRIPTION_ANNO = "bookmarkProperties/description";
 const LOAD_IN_SIDEBAR_ANNO = "bookmarkProperties/loadInSidebar";
 const POST_DATA_ANNO = "bookmarkProperties/POSTData";
+
+const TEST_FAVICON_PAGE_URL = "http://en-US.www.mozilla.com/en-US/firefox/central/";
+const TEST_FAVICON_DATA_URL = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAHWSURBVHjaYvz//z8DJQAggJiQOe/fv2fv7Oz8rays/N+VkfG/iYnJfyD/1+rVq7ffu3dPFpsBAAHEAHIBCJ85c8bN2Nj4vwsDw/8zQLwKiO8CcRoQu0DxqlWrdsHUwzBAAIGJmTNnPgYa9j8UqhFElwPxf2MIDeIrKSn9FwSJoRkAEEAM0DD4DzMAyPi/G+QKY4hh5WAXGf8PDQ0FGwJ22d27CjADAAIIrLmjo+MXA9R2kAHvGBA2wwx6B8W7od6CeQcggKCmCEL8bgwxYCbUIGTDVkHDBia+CuotgACCueD3TDQN75D4xmAvCoK9ARMHBzAw0AECiBHkAlC0Mdy7x9ABNA3obAZXIAa6iKEcGlMVQHwWyjYuL2d4v2cPg8vZswx7gHyAAAK7AOif7SAbOqCmn4Ha3AHFsIDtgPq/vLz8P4MSkJ2W9h8ggBjevXvHDo4FQUQg/kdypqCg4H8lUIACnQ/SOBMYI8bAsAJFPcj1AAEEjwVQqLpAbXmH5BJjqI0gi9DTAAgDBBCcAVLkgmQ7yKCZxpCQxqUZhAECCJ4XgMl493ug21ZD+aDAXH0WLM4A9MZPXJkJIIAwTAR5pQMalaCABQUULttBGCCAGCnNzgABBgAMJ5THwGvJLAAAAABJRU5ErkJggg==";
 
 // main
 function run_test() {
   // get places import/export service
   var importer = Cc["@mozilla.org/browser/places/import-export-service;1"].getService(Ci.nsIPlacesImportExportService);
 
   // avoid creating the places smart folder during tests
   Cc["@mozilla.org/preferences-service;1"].getService(Ci.nsIPrefBranch).
@@ -301,9 +311,14 @@ function testCanonicalBookmarks(aFolder)
   
   // unfiled bookmarks
   query.setFolders([bmsvc.unfiledBookmarksFolder], 1);
   result = histsvc.executeQuery(query, histsvc.getNewQueryOptions());
   var unfiledBookmarks = result.root;
   unfiledBookmarks.containerOpen = true;
   do_check_eq(unfiledBookmarks.childCount, 1);
   unfiledBookmarks.containerOpen = false;
+
+  // favicons
+  var faviconURI = iconsvc.getFaviconForPage(uri(TEST_FAVICON_PAGE_URL));
+  var dataURL = iconsvc.getFaviconDataAsDataURL(faviconURI);
+  do_check_eq(TEST_FAVICON_DATA_URL, dataURL);
 }
diff --git a/browser/components/shell/src/nsMacShellService.cpp b/browser/components/shell/src/nsMacShellService.cpp
--- a/browser/components/shell/src/nsMacShellService.cpp
+++ b/browser/components/shell/src/nsMacShellService.cpp
@@ -157,17 +157,17 @@ nsMacShellService::SetDefaultBrowser(PRB
   ::_LSSetDefaultSchemeHandlerURL(CFSTR("http"), firefoxURL);
   ::_LSSetDefaultSchemeHandlerURL(CFSTR("https"), firefoxURL);
 
   if (aClaimAllTypes) {
     ::_LSSetDefaultSchemeHandlerURL(CFSTR("ftp"), firefoxURL);
 
     FSRef firefoxFSRef;
     // CFURLGetFSRef returns true if the conversion was successful 
-    if (::CFURLGetFSRef(firefoxURL, &firefoxFSRef)); {
+    if (::CFURLGetFSRef(firefoxURL, &firefoxFSRef)) {
       // Set the default opener for html/htm files
       ::_LSSetWeakBindingForType(0, 0, CFSTR("html"), kLSRolesAll, &firefoxFSRef);
       ::_LSSetWeakBindingForType(0, 0, CFSTR("htm"), kLSRolesAll, &firefoxFSRef);
     }
   }
   ::_LSSaveAndRefresh();
 
   ::CFRelease(firefoxURL);
diff --git a/browser/installer/windows/nsis/installer.nsi b/browser/installer/windows/nsis/installer.nsi
--- a/browser/installer/windows/nsis/installer.nsi
+++ b/browser/installer/windows/nsis/installer.nsi
@@ -484,21 +484,23 @@ SectionEnd
 SectionEnd
 
 ; Cleanup operations to perform at the end of the installation.
 Section "-InstallEndCleanup"
   SetDetailsPrint both
   DetailPrint "$(STATUS_CLEANUP)"
   SetDetailsPrint none
 
-  ${MUI_INSTALLOPTIONS_READ} $0 "options.ini" "Field 6" "State"
-  ${If} "$0" == "1"
-    ${LogHeader} "Setting as the default browser"
-    ${SetAsDefaultAppUser}
-  ${EndIf}
+  ${Unless} ${Silent}
+    ${MUI_INSTALLOPTIONS_READ} $0 "options.ini" "Field 6" "State"
+    ${If} "$0" == "1"
+      ${LogHeader} "Setting as the default browser"
+      ${SetAsDefaultAppUser}
+    ${EndIf}
+  ${EndUnless}
 
   ${LogHeader} "Updating Uninstall Log With Previous Uninstall Log"
 
   ; Refresh desktop icons
   System::Call "shell32::SHChangeNotify(i, i, i, i) v (0x08000000, 0, 0, 0)"
 
   ${InstallEndCleanupCommon}
 
diff --git a/browser/locales/en-US/chrome/browser/places/places.properties b/browser/locales/en-US/chrome/browser/places/places.properties
--- a/browser/locales/en-US/chrome/browser/places/places.properties
+++ b/browser/locales/en-US/chrome/browser/places/places.properties
@@ -85,17 +85,17 @@ tabs.openWarningPromptMeBranded=Warn me 
 
 status_foldercount = %S object(s)
 
 SelectImport=Import Bookmarks File
 EnterExport=Export Bookmarks File
 
 saveSearch.title=Save Search
 saveSearch.inputLabel=Name:
-saveSearch.defaultText=New Query
+saveSearch.inputDefaultText=New Search
 
 detailsPane.noItems=No items
 detailsPane.oneItem=One item
 detailsPane.multipleItems=%S items
 
 smartBookmarksFolderTitle=Smart Bookmarks
 mostVisitedTitle=Most Visited
 recentlyBookmarkedTitle=Recently Bookmarked
diff --git a/config/config.mk b/config/config.mk
--- a/config/config.mk
+++ b/config/config.mk
@@ -500,21 +500,22 @@ endif
 endif
 
 # The entire tree should be subject to static analysis using the XPCOM
 # script. Additional scripts may be added by specific subdirectories.
 
 DEHYDRA_SCRIPT = $(topsrcdir)/xpcom/analysis/static-checking.js
 
 DEHYDRA_MODULES = \
-  $(topsrcdir)/xpcom/analysis/stack.js \
+  $(topsrcdir)/xpcom/analysis/final.js \
   $(NULL)
 
 TREEHYDRA_MODULES = \
   $(topsrcdir)/xpcom/analysis/outparams.js \
+  $(topsrcdir)/xpcom/analysis/stack.js \
   $(NULL)
 
 DEHYDRA_ARGS = \
   --topsrcdir=$(topsrcdir) \
   --objdir=$(DEPTH) \
   --dehydra-modules=$(subst $(NULL) ,$(COMMA),$(strip $(DEHYDRA_MODULES))) \
   --treehydra-modules=$(subst $(NULL) ,$(COMMA),$(strip $(TREEHYDRA_MODULES))) \
   $(NULL)
diff --git a/content/base/public/nsContentUtils.h b/content/base/public/nsContentUtils.h
--- a/content/base/public/nsContentUtils.h
+++ b/content/base/public/nsContentUtils.h
@@ -53,16 +53,17 @@
 #include "nsDOMClassInfoID.h"
 #include "nsIClassInfo.h"
 #include "nsIDOM3Node.h"
 #include "nsDataHashtable.h"
 #include "nsIScriptRuntime.h"
 #include "nsIScriptGlobalObject.h"
 #include "nsIDOMEvent.h"
 #include "nsTArray.h"
+#include "nsTextFragment.h"
 
 struct nsNativeKeyEvent; // Don't include nsINativeKeyBindings.h here: it will force strange compilation error!
 
 class nsIDOMScriptObjectFactory;
 class nsIXPConnect;
 class nsINode;
 class nsIContent;
 class nsIDOMNode;
@@ -93,16 +94,17 @@ class nsIEventListenerManager;
 class nsIEventListenerManager;
 class nsIScriptContext;
 class nsIRunnable;
 template<class E> class nsCOMArray;
 class nsIPref;
 class nsVoidArray;
 struct JSRuntime;
 class nsICaseConversion;
+class nsIUGenCategory;
 class nsIWidget;
 class nsPIDOMWindow;
 #ifdef MOZ_XTF
 class nsIXTFService;
 #endif
 #ifdef IBMBIDI
 class nsIBidiKeyboard;
 #endif
@@ -359,20 +361,26 @@ public:
 
   static const nsDependentSubstring TrimCharsInSet(const char* aSet,
                                                    const nsAString& aValue);
 
   static const nsDependentSubstring TrimWhitespace(const nsAString& aStr,
                                                    PRBool aTrimTrailing = PR_TRUE);
 
   /**
-   * Returns true if aChar is of class Ps, Pi, Po, Pf, or Pe. (Does not
-   * currently handle non-BMP characters.)
+   * Returns true if aChar is of class Ps, Pi, Po, Pf, or Pe.
    */
-  static PRBool IsPunctuationMark(PRUnichar aChar);
+  static PRBool IsPunctuationMark(PRUint32 aChar);
+  static PRBool IsPunctuationMarkAt(const nsTextFragment* aFrag, PRUint32 aOffset);
+ 
+  /**
+   * Returns true if aChar is of class Lu, Ll, Lt, Lm, Lo, Nd, Nl or No
+   */
+  static PRBool IsAlphanumeric(PRUint32 aChar);
+  static PRBool IsAlphanumericAt(const nsTextFragment* aFrag, PRUint32 aOffset);
 
   /*
    * Is the character an HTML whitespace character?
    *
    * We define whitespace using the list in HTML5 and css3-selectors:
    * U+0009, U+000A, U+000C, U+000D, U+0020
    *
    * HTML 4.01 also lists U+200B (zero-width space).
@@ -570,16 +578,21 @@ public:
   static nsIWordBreaker* WordBreaker()
   {
     return sWordBreaker;
   }
   
   static nsICaseConversion* GetCaseConv()
   {
     return sCaseConv;
+  }
+
+  static nsIUGenCategory* GetGenCat()
+  {
+    return sGenCat;
   }
 
   /**
    * @return PR_TRUE if aContent has an attribute aName in namespace aNameSpaceID,
    * and the attribute value is non-empty.
    */
   static PRBool HasNonEmptyAttr(nsIContent* aContent, PRInt32 aNameSpaceID,
                                 nsIAtom* aName);
@@ -1347,16 +1360,17 @@ private:
   static nsIStringBundle* sStringBundles[PropertiesFile_COUNT];
 
   static nsIContentPolicy* sContentPolicyService;
   static PRBool sTriedToGetContentPolicy;
 
   static nsILineBreaker* sLineBreaker;
   static nsIWordBreaker* sWordBreaker;
   static nsICaseConversion* sCaseConv;
+  static nsIUGenCategory* sGenCat;
 
   // Holds pointers to nsISupports* that should be released at shutdown
   static nsVoidArray* sPtrsToPtrsToRelease;
 
   static nsIScriptRuntime* sScriptRuntimes[NS_STID_ARRAY_UBOUND];
   static PRInt32 sScriptRootCount[NS_STID_ARRAY_UBOUND];
   static PRUint32 sJSGCThingRootCount;
 
@@ -1374,17 +1388,17 @@ private:
 #define NS_HOLD_JS_OBJECTS(obj, clazz)                                         \
   nsContentUtils::HoldJSObjects(NS_CYCLE_COLLECTION_UPCAST(obj, clazz),        \
                                 &NS_CYCLE_COLLECTION_NAME(clazz))
 
 #define NS_DROP_JS_OBJECTS(obj, clazz)                                         \
   nsContentUtils::DropJSObjects(NS_CYCLE_COLLECTION_UPCAST(obj, clazz))
 
 
-class nsCxPusher
+class NS_STACK_CLASS nsCxPusher
 {
 public:
   nsCxPusher();
   ~nsCxPusher(); // Calls Pop();
 
   // Returns PR_FALSE if something erroneous happened.
   PRBool Push(nsISupports *aCurrentTarget);
   PRBool Push(JSContext *cx);
diff --git a/content/base/public/nsIDocument.h b/content/base/public/nsIDocument.h
--- a/content/base/public/nsIDocument.h
+++ b/content/base/public/nsIDocument.h
@@ -1097,17 +1097,17 @@ private:
 
 NS_DEFINE_STATIC_IID_ACCESSOR(nsIDocument, NS_IDOCUMENT_IID)
 
 /**
  * mozAutoSubtreeModified batches DOM mutations so that a DOMSubtreeModified
  * event is dispatched, if necessary, when the outermost mozAutoSubtreeModified
  * object is deleted.
  */
-class mozAutoSubtreeModified
+class NS_STACK_CLASS mozAutoSubtreeModified
 {
 public:
   /**
    * @param aSubTreeOwner The document in which a subtree will be modified.
    * @param aTarget       The target of the possible DOMSubtreeModified event.
    *                      Can be nsnull, in which case mozAutoSubtreeModified
    *                      is just used to batch DOM mutations.
    */
diff --git a/content/base/public/nsReferencedElement.h b/content/base/public/nsReferencedElement.h
--- a/content/base/public/nsReferencedElement.h
+++ b/content/base/public/nsReferencedElement.h
@@ -46,41 +46,69 @@
 #include "nsAutoPtr.h"
 
 class nsIURI;
 class nsCycleCollectionCallback;
 
 /**
  * Class to track what content is referenced by a given ID.
  * 
+ * To use it, call Reset() to set it up to watch a given URI. Call get()
+ * anytime to determine the referenced element (which may be null if
+ * the element isn't found). When the element changes, ContentChanged
+ * will be called, so subclass this class if you want to receive that
+ * notification. ContentChanged runs at safe-for-script time, i.e. outside
+ * of the content update. Call Unlink() if you want to stop watching
+ * for changes (get() will then return null).
+ *
  * By default this is a single-shot tracker --- i.e., when ContentChanged
- * fires, we will automatically stop tracking. Override IsPersistent
- * to return PR_TRUE if you want to keep tracking after the content for
- * an ID has changed.
+ * fires, we will automatically stop tracking. get() will continue to return
+ * the changed-to element.
+ * Override IsPersistent to return PR_TRUE if you want to keep tracking after
+ * the first change.
  */
 class nsReferencedElement {
 public:
   nsReferencedElement() {}
   ~nsReferencedElement() {
     Unlink();
     if (mPendingNotification) {
       mPendingNotification->Clear();
     }
   }
+
+  /**
+   * Find which element, if any, is referenced.
+   */
   nsIContent* get() { return mContent; }
 
+  /**
+   * Set up the reference. This can be called multiple times to
+   * change which reference is being tracked, but these changes
+   * do not trigger ContentChanged.
+   * @param aFrom the source element for context
+   * @param aURI the URI containing a hash-reference to the element
+   * @param aWatch if false, then we do not set up the notifications to track
+   * changes, so ContentChanged won't fire and get() will always return the same
+   * value, the current element for the ID.
+   */
   void Reset(nsIContent* aFrom, nsIURI* aURI, PRBool aWatch = PR_TRUE);
+  /**
+   * Clears the reference. ContentChanged is not triggered. get() will return
+   * null.
+   */
   void Unlink();
 
   void Traverse(nsCycleCollectionTraversalCallback* aCB);
   
 protected:
   /**
    * Override this to be notified of content changes. Don't forget
-   * to call this method to change mContent.
+   * to call this superclass method to change mContent. This is called
+   * at script-runnable time.
    */
   virtual void ContentChanged(nsIContent* aFrom, nsIContent* aTo) {
     mContent = aTo;
   }
 
   /**
    * Override this to convert from a single-shot notification to
    * a persistent notification.
diff --git a/content/base/src/mozAutoDocUpdate.h b/content/base/src/mozAutoDocUpdate.h
--- a/content/base/src/mozAutoDocUpdate.h
+++ b/content/base/src/mozAutoDocUpdate.h
@@ -36,17 +36,17 @@
 
 /**
  * Helper class to automatically handle batching of document updates.  This
  * class will call BeginUpdate on construction and EndUpdate on destruction on
  * the given document with the given update type.  The document could be null,
  * in which case no updates will be called.  The constructor also takes a
  * boolean that can be set to false to prevent notifications.
  */
-class mozAutoDocUpdate
+class NS_STACK_CLASS mozAutoDocUpdate
 {
 public:
   mozAutoDocUpdate(nsIDocument* aDocument, nsUpdateType aUpdateType,
                    PRBool aNotify) :
     mDocument(aNotify ? aDocument : nsnull),
     mUpdateType(aUpdateType)
   {
     if (mDocument) {
@@ -89,17 +89,17 @@ private:
 /**
  * Creates an update batch only under certain conditions.
  * Use this rather than mozAutoDocUpdate when you expect inner updates
  * to notify but you don't always want to spec cycles creating a batch.
  * This is needed to avoid having this batch always create a blocker,
  * but then have inner mozAutoDocUpdate call the last EndUpdate before.
  * we remove that blocker. See bug 423269.
  */
-class mozAutoDocConditionalContentUpdateBatch
+class NS_STACK_CLASS mozAutoDocConditionalContentUpdateBatch
 {
 public:
   mozAutoDocConditionalContentUpdateBatch(nsIDocument* aDocument,
                                           PRBool aNotify) :
     mDocument(aNotify ? aDocument : nsnull)
   {
     if (mDocument) {
       mDocument->BeginUpdate(UPDATE_CONTENT_MODEL);
diff --git a/content/base/src/nsContentAreaDragDrop.cpp b/content/base/src/nsContentAreaDragDrop.cpp
--- a/content/base/src/nsContentAreaDragDrop.cpp
+++ b/content/base/src/nsContentAreaDragDrop.cpp
@@ -114,17 +114,17 @@ NS_INTERFACE_MAP_BEGIN(nsContentAreaDrag
     NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIDOMDragListener)
     NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsIDOMEventListener, nsIDOMDragListener)
     NS_INTERFACE_MAP_ENTRY(nsIDOMDragListener)
     NS_INTERFACE_MAP_ENTRY(nsIFlavorDataProvider)
     NS_INTERFACE_MAP_ENTRY(nsIDragDropHandler)
 NS_INTERFACE_MAP_END
 
 
-class nsTransferableFactory
+class NS_STACK_CLASS nsTransferableFactory
 {
 public:
   nsTransferableFactory(nsIDOMEvent* inMouseEvent,
                         nsIFlavorDataProvider *inFlavorDataProvider);
   nsresult Produce(PRBool *aDragSelection, nsITransferable** outTrans);
 
 private:
   nsresult ConvertStringsToTransferable(nsITransferable** outTrans);
diff --git a/content/base/src/nsContentUtils.cpp b/content/base/src/nsContentUtils.cpp
--- a/content/base/src/nsContentUtils.cpp
+++ b/content/base/src/nsContentUtils.cpp
@@ -149,16 +149,17 @@ static NS_DEFINE_CID(kXTFServiceCID, NS_
 #include "nsXULPopupManager.h"
 #include "nsIPermissionManager.h"
 #include "nsIScriptObjectPrincipal.h"
 #include "nsIRunnable.h"
 #include "nsDOMJSUtils.h"
 #include "nsGenericHTMLElement.h"
 #include "nsAttrValue.h"
 #include "nsReferencedElement.h"
+#include "nsIUGenCategory.h"
 
 #ifdef IBMBIDI
 #include "nsIBidiKeyboard.h"
 #endif
 #include "nsCycleCollectionParticipant.h"
 
 // for ReportToConsole
 #include "nsIStringBundle.h"
@@ -190,16 +191,17 @@ nsDataHashtable<nsISupportsHashKey, Even
 nsDataHashtable<nsISupportsHashKey, EventNameMapping>* nsContentUtils::sEventTable = nsnull;
 nsIStringBundleService *nsContentUtils::sStringBundleService;
 nsIStringBundle *nsContentUtils::sStringBundles[PropertiesFile_COUNT];
 nsIContentPolicy *nsContentUtils::sContentPolicyService;
 PRBool nsContentUtils::sTriedToGetContentPolicy = PR_FALSE;
 nsILineBreaker *nsContentUtils::sLineBreaker;
 nsIWordBreaker *nsContentUtils::sWordBreaker;
 nsICaseConversion *nsContentUtils::sCaseConv;
+nsIUGenCategory *nsContentUtils::sGenCat;
 nsVoidArray *nsContentUtils::sPtrsToPtrsToRelease;
 nsIScriptRuntime *nsContentUtils::sScriptRuntimes[NS_STID_ARRAY_UBOUND];
 PRInt32 nsContentUtils::sScriptRootCount[NS_STID_ARRAY_UBOUND];
 PRUint32 nsContentUtils::sJSGCThingRootCount;
 #ifdef IBMBIDI
 nsIBidiKeyboard *nsContentUtils::sBidiKeyboard = nsnull;
 #endif
 PRUint32 nsContentUtils::sScriptBlockerCount = 0;
@@ -291,16 +293,19 @@ nsContentUtils::Init()
 
   rv = CallGetService(NS_LBRK_CONTRACTID, &sLineBreaker);
   NS_ENSURE_SUCCESS(rv, rv);
   
   rv = CallGetService(NS_WBRK_CONTRACTID, &sWordBreaker);
   NS_ENSURE_SUCCESS(rv, rv);
   
   rv = CallGetService(NS_UNICHARUTIL_CONTRACTID, &sCaseConv);
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  rv = CallGetService(NS_UNICHARCATEGORY_CONTRACTID, &sGenCat);
   NS_ENSURE_SUCCESS(rv, rv);
 
   // Ignore failure and just don't load images
   rv = CallGetService("@mozilla.org/image/loader;1", &sImgLoader);
   if (NS_FAILED(rv)) {
     // no image loading for us.  Oh, well.
     sImgLoader = nsnull;
   }
@@ -671,25 +676,65 @@ nsContentUtils::CopyNewlineNormalizedUni
 }
 
 // Replaced by precompiled CCMap (see bug 180266). To update the list
 // of characters, see one of files included below. As for the way
 // the original list of characters was obtained by Frank Tang, see bug 54467.
 // Updated to fix the regression (bug 263411). The list contains
 // characters of the following Unicode character classes : Ps, Pi, Po, Pf, Pe.
 // (ref.: http://www.w3.org/TR/2004/CR-CSS21-20040225/selector.html#first-letter)
-// Note that the file does NOT yet include non-BMP characters.
-#include "punct_marks.ccmap"
-DEFINE_CCMAP(gPuncCharsCCMap, const);
-
-// static
-PRBool
-nsContentUtils::IsPunctuationMark(PRUnichar aChar)
-{
-  return CCMAP_HAS_CHAR(gPuncCharsCCMap, aChar);
+#include "punct_marks.x-ccmap"
+DEFINE_X_CCMAP(gPuncCharsCCMapExt, const);
+
+// static
+PRBool
+nsContentUtils::IsPunctuationMark(PRUint32 aChar)
+{
+  return CCMAP_HAS_CHAR_EXT(gPuncCharsCCMapExt, aChar);
+}
+
+// static
+PRBool
+nsContentUtils::IsPunctuationMarkAt(const nsTextFragment* aFrag, PRUint32 aOffset)
+{
+  PRUnichar h = aFrag->CharAt(aOffset);
+  if (!IS_SURROGATE(h)) {
+    return IsPunctuationMark(h);
+  }
+  if (NS_IS_HIGH_SURROGATE(h) && aOffset + 1 < aFrag->GetLength()) {
+    PRUnichar l = aFrag->CharAt(aOffset + 1);
+    if (NS_IS_LOW_SURROGATE(l)) {
+      return IsPunctuationMark(SURROGATE_TO_UCS4(h, l));
+    }
+  }
+  return PR_FALSE;
+}
+
+// static
+PRBool nsContentUtils::IsAlphanumeric(PRUint32 aChar)
+{
+  nsIUGenCategory::nsUGenCategory cat = sGenCat->Get(aChar);
+
+  return (cat == nsIUGenCategory::kLetter || cat == nsIUGenCategory::kNumber);
+}
+ 
+// static
+PRBool nsContentUtils::IsAlphanumericAt(const nsTextFragment* aFrag, PRUint32 aOffset)
+{
+  PRUnichar h = aFrag->CharAt(aOffset);
+  if (!IS_SURROGATE(h)) {
+    return IsAlphanumeric(h);
+  }
+  if (NS_IS_HIGH_SURROGATE(h) && aOffset + 1 < aFrag->GetLength()) {
+    PRUnichar l = aFrag->CharAt(aOffset + 1);
+    if (NS_IS_LOW_SURROGATE(l)) {
+      return IsAlphanumeric(SURROGATE_TO_UCS4(h, l));
+    }
+  }
+  return PR_FALSE;
 }
 
 /* static */
 PRBool
 nsContentUtils::IsHTMLWhitespace(PRUnichar aChar)
 {
   return aChar == PRUnichar(0x0009) ||
          aChar == PRUnichar(0x000A) ||
@@ -797,16 +842,17 @@ nsContentUtils::Shutdown()
   NS_IF_RELEASE(sSecurityManager);
   NS_IF_RELEASE(sThreadJSContextStack);
   NS_IF_RELEASE(sNameSpaceManager);
   NS_IF_RELEASE(sParserService);
   NS_IF_RELEASE(sIOService);
   NS_IF_RELEASE(sLineBreaker);
   NS_IF_RELEASE(sWordBreaker);
   NS_IF_RELEASE(sCaseConv);
+  NS_IF_RELEASE(sGenCat);
 #ifdef MOZ_XTF
   NS_IF_RELEASE(sXTFService);
 #endif
   NS_IF_RELEASE(sImgLoader);
   NS_IF_RELEASE(sPrefBranch);
   NS_IF_RELEASE(sPref);
 #ifdef IBMBIDI
   NS_IF_RELEASE(sBidiKeyboard);
diff --git a/content/base/src/nsDocument.cpp b/content/base/src/nsDocument.cpp
--- a/content/base/src/nsDocument.cpp
+++ b/content/base/src/nsDocument.cpp
@@ -3052,17 +3052,17 @@ void
 void
 nsDocument::SetScriptHandlingObject(nsIScriptGlobalObject* aScriptObject)
 {
   NS_ASSERTION(!mScriptGlobalObject ||
                mScriptGlobalObject == aScriptObject,
                "Wrong script object!");
   nsCOMPtr<nsPIDOMWindow> win = do_QueryInterface(aScriptObject);
   NS_ASSERTION(!win || win->IsInnerWindow(), "Should have inner window here!");
-  mScriptObject = do_GetWeakReference(aScriptObject);
+  mScopeObject = mScriptObject = do_GetWeakReference(aScriptObject);
   if (aScriptObject) {
     mHasHadScriptHandlingObject = PR_TRUE;
   }
 }
 
 nsPIDOMWindow *
 nsDocument::GetWindow()
 {
diff --git a/content/base/src/nsNodeUtils.cpp b/content/base/src/nsNodeUtils.cpp
--- a/content/base/src/nsNodeUtils.cpp
+++ b/content/base/src/nsNodeUtils.cpp
@@ -318,20 +318,21 @@ nsNodeUtils::GetUserData(nsINode *aNode,
 
   *aResult = static_cast<nsIVariant*>
                         (aNode->GetProperty(DOM_USER_DATA, key));
   NS_IF_ADDREF(*aResult);
 
   return NS_OK;
 }
 
-struct nsHandlerData
+struct NS_STACK_CLASS nsHandlerData
 {
   PRUint16 mOperation;
-  nsCOMPtr<nsIDOMNode> mSource, mDest;
+  nsCOMPtr<nsIDOMNode> mSource;
+  nsCOMPtr<nsIDOMNode> mDest;
 };
 
 static void
 CallHandler(void *aObject, nsIAtom *aKey, void *aHandler, void *aData)
 {
   nsHandlerData *handlerData = static_cast<nsHandlerData*>(aData);
   nsCOMPtr<nsIDOMUserDataHandler> handler =
     static_cast<nsIDOMUserDataHandler*>(aHandler);
diff --git a/content/base/src/nsObjectLoadingContent.cpp b/content/base/src/nsObjectLoadingContent.cpp
--- a/content/base/src/nsObjectLoadingContent.cpp
+++ b/content/base/src/nsObjectLoadingContent.cpp
@@ -757,24 +757,36 @@ nsObjectLoadingContent::EnsureInstantiat
   return rv;
 }
 
 NS_IMETHODIMP
 nsObjectLoadingContent::HasNewFrame(nsIObjectFrame* aFrame)
 {
   LOG(("OBJLC [%p]: Got frame %p (mInstantiating=%i)\n", this, aFrame,
        mInstantiating));
-  if (!mInstantiating && aFrame && mType == eType_Plugin) {
+
+  // "revoke" any existing instantiate event as it likely has out of
+  // date data (frame pointer etc).
+  mPendingInstantiateEvent = nsnull;
+
+  nsCOMPtr<nsIPluginInstance> instance;
+  aFrame->GetPluginInstance(*getter_AddRefs(instance));
+
+  if (instance) {
+    // The frame already has a plugin instance, that means the plugin
+    // has already been instantiated.
+
+    return NS_OK;
+  }
+
+  if (!mInstantiating && mType == eType_Plugin) {
     // Asynchronously call Instantiate
     // This can go away once plugin loading moves to content
     // This must be done asynchronously to ensure that the frame is correctly
     // initialized (has a view etc)
-
-    // "revoke" any existing instantiate event.
-    mPendingInstantiateEvent = nsnull;
 
     // When in a plugin document, the document will take care of calling
     // instantiate
     nsCOMPtr<nsIPluginDocument> pDoc (do_QueryInterface(GetOurDocument()));
     if (pDoc) {
       return NS_OK;
     }
 
diff --git a/content/base/src/nsObjectLoadingContent.h b/content/base/src/nsObjectLoadingContent.h
--- a/content/base/src/nsObjectLoadingContent.h
+++ b/content/base/src/nsObjectLoadingContent.h
@@ -49,20 +49,20 @@
 #include "nsIStreamListener.h"
 #include "nsFrameLoader.h"
 #include "nsIInterfaceRequestor.h"
 #include "nsIChannelEventSink.h"
 #include "nsIObjectLoadingContent.h"
 #include "nsIRunnable.h"
 #include "nsIChannelClassifier.h"
 
-struct nsAsyncInstantiateEvent;
-class  AutoNotifier;
-class  AutoFallback;
-class  AutoSetInstantiatingToFalse;
+class nsAsyncInstantiateEvent;
+class AutoNotifier;
+class AutoFallback;
+class AutoSetInstantiatingToFalse;
 
 /**
  * INVARIANTS OF THIS CLASS
  * - mChannel is non-null between asyncOpen and onStopRequest (NOTE: Only needs
  *   to be valid until onStopRequest is called on mFinalListener, not
  *   necessarily until the channel calls onStopRequest on us)
  * - mChannel corresponds to the channel that gets passed to the
  *   nsIRequestObserver/nsIStreamListener methods
diff --git a/content/base/src/nsRange.cpp b/content/base/src/nsRange.cpp
--- a/content/base/src/nsRange.cpp
+++ b/content/base/src/nsRange.cpp
@@ -784,17 +784,17 @@ nsresult nsRange::SelectNodeContents(nsI
 // so that our methods/algorithms aren't cluttered with special
 // case code that tries to include these points while iterating.
 //
 // The RangeSubtreeIterator class mimics the nsIContentIterator
 // methods we need, so should the Content Iterator support the
 // start/end points in the future, we can switchover relatively
 // easy.
 
-class RangeSubtreeIterator
+class NS_STACK_CLASS RangeSubtreeIterator
 {
 private:
 
   enum RangeSubtreeIterState { eDone=0,
                                eUseStartCData,
                                eUseIterator,
                                eUseEndCData };
 
diff --git a/content/canvas/src/nsCanvasRenderingContext2D.cpp b/content/canvas/src/nsCanvasRenderingContext2D.cpp
--- a/content/canvas/src/nsCanvasRenderingContext2D.cpp
+++ b/content/canvas/src/nsCanvasRenderingContext2D.cpp
@@ -1694,25 +1694,28 @@ nsCanvasRenderingContext2D::SetFont(cons
     }
 
     if (!parentContext)
         return NS_ERROR_FAILURE;
 
     nsRefPtr<nsStyleContext> sc = styleSet->ResolveStyleForRules(parentContext, rules);
     if (!sc)
         return NS_ERROR_FAILURE;
-    const nsStyleFont *fontStyle = sc->GetStyleFont();
+    const nsStyleFont* fontStyle = sc->GetStyleFont();
 
     NS_ASSERTION(fontStyle, "Could not obtain font style");
 
-    PRUint32 aupdp = presShell->GetPresContext()->AppUnitsPerDevPixel();
+    // use CSS pixels instead of dev pixels to avoid being affected by page zoom
+    const PRUint32 aupcp = nsPresContext::AppUnitsPerCSSPixel();
+    // un-zoom the font size to avoid being affected by text-only zoom
+    const nscoord fontSize = nsStyleFont::UnZoomText(parentContext->PresContext(), fontStyle->mFont.size);
 
     gfxFontStyle style(fontStyle->mFont.style,
                        fontStyle->mFont.weight,
-                       NSAppUnitsToFloatPixels(fontStyle->mFont.size,aupdp),
+                       NSAppUnitsToFloatPixels(fontSize, aupcp),
                        langGroup,
                        fontStyle->mFont.sizeAdjust,
                        fontStyle->mFont.systemFont,
                        fontStyle->mFont.familyNameQuirks);
 
     CurrentState().fontGroup = gfxPlatform::GetPlatform()->CreateFontGroup(fontStyle->mFont.name, &style);
     NS_ASSERTION(CurrentState().fontGroup, "Could not get font group");
     CurrentState().font = font;
diff --git a/content/events/public/nsEventDispatcher.h b/content/events/public/nsEventDispatcher.h
--- a/content/events/public/nsEventDispatcher.h
+++ b/content/events/public/nsEventDispatcher.h
@@ -185,17 +185,17 @@ public:
 };
 
 /**
  * If an nsDispatchingCallback object is passed to Dispatch,
  * its HandleEvent method is called after handling the default event group,
  * before handling the system event group.
  * This is used in nsPresShell.
  */
-class nsDispatchingCallback {
+class NS_STACK_CLASS nsDispatchingCallback {
 public:
   virtual void HandleEvent(nsEventChainPostVisitor& aVisitor) = 0;
 };
 
 /**
  * The generic class for event dispatching.
  * Must not be used outside Gecko!
  */
diff --git a/content/events/src/nsEventStateManager.cpp b/content/events/src/nsEventStateManager.cpp
--- a/content/events/src/nsEventStateManager.cpp
+++ b/content/events/src/nsEventStateManager.cpp
@@ -2924,17 +2924,17 @@ nsEventStateManager::SetCursor(PRInt32 a
   }
 
   if (NS_FAILED(rv))
     aWidget->SetCursor(c);
 
   return NS_OK;
 }
 
-class nsESMEventCB : public nsDispatchingCallback
+class NS_STACK_CLASS nsESMEventCB : public nsDispatchingCallback
 {
 public:
   nsESMEventCB(nsIContent* aTarget) : mTarget(aTarget) {}
 
   virtual void HandleEvent(nsEventChainPostVisitor& aVisitor)
   {
     if (aVisitor.mPresContext) {
       nsIPresShell* shell = aVisitor.mPresContext->GetPresShell();
diff --git a/content/events/src/nsQueryContentEventHandler.h b/content/events/src/nsQueryContentEventHandler.h
--- a/content/events/src/nsQueryContentEventHandler.h
+++ b/content/events/src/nsQueryContentEventHandler.h
@@ -56,17 +56,17 @@ struct nsRect;
 /*
  * Query Content Event Handler
  *   nsQueryContentEventHandler is a helper class for nsEventStateManager.
  *   The platforms request some content informations, e.g., the selected text,
  *   the offset of the selected text and the text for specified range.
  *   This class answers to NS_QUERY_* events from actual contents.
  */
 
-class nsQueryContentEventHandler {
+class NS_STACK_CLASS nsQueryContentEventHandler {
 public:
   nsQueryContentEventHandler(nsPresContext *aPresContext);
 
   // NS_QUERY_SELECTED_TEXT event handler
   nsresult OnQuerySelectedText(nsQueryContentEvent* aEvent);
   // NS_QUERY_TEXT_CONTENT event handler
   nsresult OnQueryTextContent(nsQueryContentEvent* aEvent);
   // NS_QUERY_CHARACTER_RECT event handler
diff --git a/content/html/content/src/nsHTMLSelectElement.h b/content/html/content/src/nsHTMLSelectElement.h
--- a/content/html/content/src/nsHTMLSelectElement.h
+++ b/content/html/content/src/nsHTMLSelectElement.h
@@ -185,17 +185,17 @@ public:
     return mValues.Contains(aValue) || mIndices.Contains(aIndex);
   }
 
 private:
   nsCheapStringSet mValues;
   nsCheapInt32Set mIndices;
 };
 
-class nsSafeOptionListMutation
+class NS_STACK_CLASS nsSafeOptionListMutation
 {
 public:
   /**
    * @param aSelect The select element which option list is being mutated.
    *                Can be null.
    * @param aParent The content object which is being mutated.
    * @param aKid    If not null, a new child element is being inserted to
    *                aParent. Otherwise a child element will be removed.
diff --git a/content/svg/content/src/nsSVGFilters.cpp b/content/svg/content/src/nsSVGFilters.cpp
--- a/content/svg/content/src/nsSVGFilters.cpp
+++ b/content/svg/content/src/nsSVGFilters.cpp
@@ -74,17 +74,17 @@
 #endif
 
 //--------------------Filter Resource-----------------------
 /**
   * nsSVGFilterResource provides functionality for managing images used by
   * filters.  PLEASE NOTE that nsSVGFilterResource should ONLY be used on the
   * stack because it has nsAutoString member.
   */
-class nsSVGFilterResource
+class NS_STACK_CLASS nsSVGFilterResource
 {
 public:
   nsSVGFilterResource(nsSVGFE *aFilter, nsSVGFilterInstance* aInstance);
   ~nsSVGFilterResource();
 
   /*
    * Acquires a source image for reading
    * aIn:         the name of the filter primitive to use as the source
diff --git a/content/svg/content/src/nsSVGValue.h b/content/svg/content/src/nsSVGValue.h
--- a/content/svg/content/src/nsSVGValue.h
+++ b/content/svg/content/src/nsSVGValue.h
@@ -82,17 +82,17 @@ private:
   
   nsSmallVoidArray mObservers;
   PRInt32 mModifyNestCount;
 };
 
 // Class that will automatically call WillModify and DidModify in its ctor
 // and dtor respectively (for functions that have multiple exit points).
 
-class nsSVGValueAutoNotifier
+class NS_STACK_CLASS nsSVGValueAutoNotifier
 {
 public:
   nsSVGValueAutoNotifier(nsSVGValue* aVal,
                          nsISVGValue::modificationType aModType =
                          nsISVGValue::mod_other)
     : mVal(aVal)
     , mModType(aModType)
   {
diff --git a/content/xul/document/src/nsXULDocument.cpp b/content/xul/document/src/nsXULDocument.cpp
--- a/content/xul/document/src/nsXULDocument.cpp
+++ b/content/xul/document/src/nsXULDocument.cpp
@@ -1735,18 +1735,21 @@ nsXULDocument::RemoveSubtreeFromDocument
     PRUint32 count = aElement->GetChildCount();
 
     while (count-- > 0) {
         rv = RemoveSubtreeFromDocument(aElement->GetChildAt(count));
         if (NS_FAILED(rv))
             return rv;
     }
 
-    // 2. Remove the element from the resource-to-element map
+    // 2. Remove the element from the resource-to-element map.
+    // Also remove it from the id map, since we added it in
+    // AddElementToDocumentPre().
     RemoveElementFromRefMap(aElement);
+    RemoveFromIdTable(aElement);
 
     // 3. If the element is a 'command updater', then remove the
     // element from the document's command dispatcher.
     if (aElement->AttrValueIs(kNameSpaceID_None, nsGkAtoms::commandupdater,
                               nsGkAtoms::_true, eCaseMatters)) {
         nsCOMPtr<nsIDOMElement> domelement = do_QueryInterface(aElement);
         NS_ASSERTION(domelement != nsnull, "not a DOM element");
         if (! domelement)
diff --git a/content/xul/templates/src/nsXULTemplateBuilder.cpp b/content/xul/templates/src/nsXULTemplateBuilder.cpp
--- a/content/xul/templates/src/nsXULTemplateBuilder.cpp
+++ b/content/xul/templates/src/nsXULTemplateBuilder.cpp
@@ -1575,17 +1575,17 @@ nsXULTemplateBuilder::ParseAttribute(con
 
     if (backup != mark && aTextCallback) {
         // If there's any text left over, then fire the text callback
         (*aTextCallback)(this, Substring(mark, backup), aClosure);
     }
 }
 
 
-struct SubstituteTextClosure {
+struct NS_STACK_CLASS SubstituteTextClosure {
     SubstituteTextClosure(nsIXULTemplateResult* aResult, nsAString& aString)
         : result(aResult), str(aString) {}
 
     // some datasources are lazily initialized or modified while values are
     // being retrieved, causing results to be removed. Due to this, hold a
     // strong reference to the result.
     nsCOMPtr<nsIXULTemplateResult> result;
     nsAString& str;
diff --git a/db/morkreader/nsMorkReader.h b/db/morkreader/nsMorkReader.h
--- a/db/morkreader/nsMorkReader.h
+++ b/db/morkreader/nsMorkReader.h
@@ -48,17 +48,17 @@
 // file and enumerate the rows that it contains.  It does not provide
 // any functionality for modifying mork tables.
 
 // References:
 //  http://www.mozilla.org/mailnews/arch/mork/primer.txt
 //  http://www.mozilla.org/mailnews/arch/mork/grammar.txt
 //  http://www.jwz.org/hacks/mork.pl
 
-class nsMorkReader
+class NS_STACK_CLASS nsMorkReader
 {
  public:
   // This string type has built-in storage for the hex string representation
   // of a 32-bit row id or atom map key, plus the terminating null.
   class IDString : public nsFixedCString
   {
   public:
     IDString() : fixed_string_type(mStorage, sizeof(mStorage), 0) {}
diff --git a/docshell/base/nsDocShell.cpp b/docshell/base/nsDocShell.cpp
--- a/docshell/base/nsDocShell.cpp
+++ b/docshell/base/nsDocShell.cpp
@@ -8435,17 +8435,17 @@ nsDocShell::WalkHistoryEntries(nsISHEntr
         nsresult rv = aCallback(childEntry, childShell, i, aData);
         NS_ENSURE_SUCCESS(rv, rv);
     }
 
     return NS_OK;
 }
 
 // callback data for WalkHistoryEntries
-struct CloneAndReplaceData
+struct NS_STACK_CLASS CloneAndReplaceData
 {
     CloneAndReplaceData(PRUint32 aCloneID, nsISHEntry *aReplaceEntry,
                         nsISHEntry *aDestTreeParent)
         : cloneID(aCloneID),
           replaceEntry(aReplaceEntry),
           destTreeParent(aDestTreeParent) { }
 
     PRUint32              cloneID;
diff --git a/dom/public/base/nsIFocusController.h b/dom/public/base/nsIFocusController.h
--- a/dom/public/base/nsIFocusController.h
+++ b/dom/public/base/nsIFocusController.h
@@ -85,17 +85,17 @@ public:
   NS_IMETHOD MoveFocus(PRBool aForward, nsIDOMElement* aElt)=0;
   NS_IMETHOD RewindFocusState()=0;
 
   NS_IMETHOD ResetElementFocus() = 0;
 };
 
 NS_DEFINE_STATIC_IID_ACCESSOR(nsIFocusController, NS_IFOCUSCONTROLLER_IID)
 
-class nsFocusSuppressor {
+class NS_STACK_CLASS nsFocusSuppressor {
 public:
   ~nsFocusSuppressor()
   {
     Unsuppress();
   }
 
   // Note: We assume that aReason outlives the instance of this class.
   void Suppress(nsIFocusController *aController, const char *aReason)
@@ -123,17 +123,17 @@ public:
     return mController != nsnull;
   }
 
 private:
   nsCOMPtr<nsIFocusController> mController;
   const char *mReason;
 };
 
-class nsFocusScrollSuppressor
+class NS_STACK_CLASS nsFocusScrollSuppressor
 {
 public:
   nsFocusScrollSuppressor(nsIFocusController* aController = nsnull)
   : mWasSuppressed(PR_FALSE)
   {
     Init(aController);
   }
 
diff --git a/dom/public/idl/base/nsIDOMWindowUtils.idl b/dom/public/idl/base/nsIDOMWindowUtils.idl
--- a/dom/public/idl/base/nsIDOMWindowUtils.idl
+++ b/dom/public/idl/base/nsIDOMWindowUtils.idl
@@ -42,17 +42,17 @@
  * to the current nsIDOMWindow.  Some of the methods may require
  * elevated privileges; the method implementations should contain the
  * necessary security checks.  Access this interface by calling
  * getInterface on a DOMWindow.
  */
 
 interface nsIDOMElement;
 
-[scriptable, uuid(993da427-2ac3-4766-8485-21a236d258e4)]
+[scriptable, uuid(ef136142-9925-45f4-a3e4-6f0d275c6aa8)]
 interface nsIDOMWindowUtils : nsISupports {
 
   /**
    * Image animation mode of the window. When this attribute's value
    * is changed, the implementation should set all images in the window
    * to the given value. That is, when set to kDontAnimMode, all images
    * will stop animating. The attribute's value must be one of the
    * animationMode values from imgIContainer.
@@ -156,16 +156,25 @@ interface nsIDOMWindowUtils : nsISupport
    */
   void sendNativeKeyEvent(in long aNativeKeyboardLayout,
                           in long aNativeKeyCode,
                           in long aModifierFlags,
                           in AString aCharacters,
                           in AString aUnmodifiedCharacters);
 
   /**
+   * See nsIWidget::ActivateNativeMenuItemAt
+   *
+   * Cannot be accessed from unprivileged context (not content-accessible)
+   * Will throw a DOM security error if called without UniversalXPConnect
+   * privileges.
+   */
+  void activateNativeMenuItemAt(in AString indexString);
+
+  /**
    * Focus the element aElement. The element should be in the same document
    * that the window is displaying. Pass null to blur the element, if any,
    * that currently has focus, and focus the document.
    *
    * Cannot be accessed from unprivileged context (not content-accessible)
    * Will throw a DOM security error if called without UniversalXPConnect
    * privileges.
    *
diff --git a/dom/public/nsDOMScriptObjectHolder.h b/dom/public/nsDOMScriptObjectHolder.h
--- a/dom/public/nsDOMScriptObjectHolder.h
+++ b/dom/public/nsDOMScriptObjectHolder.h
@@ -41,17 +41,17 @@
 
 #include "nsIScriptContext.h"
 #include "nsIDOMScriptObjectFactory.h"
 
 // A thin class used to help with script object memory management.  No virtual
 // functions and a fully inline implementation should keep the cost down.
 // [Note that a fully inline implementation is necessary for use by other
 // languages, which do not link against the layout component module]
-class nsScriptObjectHolder {
+class NS_STACK_CLASS nsScriptObjectHolder {
 public:
   // A constructor that will cause a reference to |ctx| to be stored in
   // the object.  Only use for short-lived object holders.
   nsScriptObjectHolder(nsIScriptContext *ctx, void *aObject = nsnull) :
       mObject(aObject), mContext(ctx) {
     NS_ASSERTION(ctx, "Must provide a valid context");
   }
 
diff --git a/dom/src/base/nsDOMWindowUtils.cpp b/dom/src/base/nsDOMWindowUtils.cpp
--- a/dom/src/base/nsDOMWindowUtils.cpp
+++ b/dom/src/base/nsDOMWindowUtils.cpp
@@ -303,16 +303,32 @@ nsDOMWindowUtils::SendNativeKeyEvent(PRI
   nsCOMPtr<nsIWidget> widget = GetWidget();
   if (!widget)
     return NS_ERROR_FAILURE;
 
   return widget->SynthesizeNativeKeyEvent(aNativeKeyboardLayout, aNativeKeyCode,
                                           aModifiers, aCharacters, aUnmodifiedCharacters);
 }
 
+NS_IMETHODIMP
+nsDOMWindowUtils::ActivateNativeMenuItemAt(const nsAString& indexString)
+{
+  PRBool hasCap = PR_FALSE;
+  if (NS_FAILED(nsContentUtils::GetSecurityManager()->IsCapabilityEnabled("UniversalXPConnect", &hasCap))
+      || !hasCap)
+    return NS_ERROR_DOM_SECURITY_ERR;
+
+  // get the widget to send the event to
+  nsCOMPtr<nsIWidget> widget = GetWidget();
+  if (!widget)
+    return NS_ERROR_FAILURE;
+
+  return widget->ActivateNativeMenuItemAt(indexString);
+}
+
 nsIWidget*
 nsDOMWindowUtils::GetWidget()
 {
   if (mWindow) {
     nsIDocShell *docShell = mWindow->GetDocShell();
     if (docShell) {
       nsCOMPtr<nsIPresShell> presShell;
       docShell->GetPresShell(getter_AddRefs(presShell));
diff --git a/dom/src/offline/nsDOMOfflineResourceList.cpp b/dom/src/offline/nsDOMOfflineResourceList.cpp
--- a/dom/src/offline/nsDOMOfflineResourceList.cpp
+++ b/dom/src/offline/nsDOMOfflineResourceList.cpp
@@ -270,39 +270,36 @@ nsDOMOfflineResourceList::Disconnect()
 
 //
 // nsDOMOfflineResourceList::nsIDOMOfflineResourceList
 //
 
 NS_IMETHODIMP
 nsDOMOfflineResourceList::GetLength(PRUint32 *aLength)
 {
+  if (!mManifestURI) {
+    *aLength = 0;
+    return NS_OK;
+  }
+
   nsresult rv = Init();
   NS_ENSURE_SUCCESS(rv, rv);
-
-  if (!nsContentUtils::OfflineAppAllowed(mDocumentURI)) {
-    return NS_ERROR_DOM_SECURITY_ERR;
-  }
 
   rv = CacheKeys();
   NS_ENSURE_SUCCESS(rv, rv);
 
   *aLength = gCachedKeysCount;
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsDOMOfflineResourceList::Item(PRUint32 aIndex, nsAString& aURI)
 {
   nsresult rv = Init();
   NS_ENSURE_SUCCESS(rv, rv);
-
-  if (!nsContentUtils::OfflineAppAllowed(mDocumentURI)) {
-    return NS_ERROR_DOM_SECURITY_ERR;
-  }
 
   SetDOMStringToNull(aURI);
 
   rv = CacheKeys();
   NS_ENSURE_SUCCESS(rv, rv);
 
   if (aIndex >= gCachedKeysCount)
     return NS_ERROR_NOT_AVAILABLE;
diff --git a/dom/tests/mochitest/ajax/offline/Makefile.in b/dom/tests/mochitest/ajax/offline/Makefile.in
--- a/dom/tests/mochitest/ajax/offline/Makefile.in
+++ b/dom/tests/mochitest/ajax/offline/Makefile.in
@@ -45,16 +45,17 @@ include $(DEPTH)/config/autoconf.mk
 
 include $(topsrcdir)/config/rules.mk
 
 _TEST_FILES	= \
 	offlineTests.js \
 	test_badManifestMagic.html \
 	test_badManifestMime.html \
 	test_missingFile.html \
+	test_noManifest.html \
 	test_simpleManifest.html \
 	test_identicalManifest.html \
 	test_changingManifest.html \
 	test_offlineIFrame.html \
 	badManifestMagic.cacheManifest \
 	badManifestMagic.cacheManifest^headers^ \
 	missingFile.cacheManifest \
 	missingFile.cacheManifest^headers^ \
diff --git a/dom/tests/mochitest/ajax/offline/test_noManifest.html b/dom/tests/mochitest/ajax/offline/test_noManifest.html
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/offline/test_noManifest.html
@@ -0,0 +1,44 @@
+<html xmlns="http://www.w3.org/1999/xhtml">
+<head>
+<title>bad manifest content type</title>
+
+<script type="text/javascript" src="/MochiKit/packed.js"></script>
+<script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+
+<script type="text/javascript">
+
+function expectInvalidState(fn, desc) {
+  var gotInvalidState = false;
+  try {
+    fn();
+  } catch(e) {
+    if (e.code == DOMException.INVALID_STATE_ERR) {
+      gotInvalidState = true;
+    }
+  }
+
+  ok(gotInvalidState, desc);
+}
+
+is(typeof(applicationCache), "object");
+is(applicationCache.length, 0, "applicationCache.length should be 0");
+is(applicationCache.status, 0, "applicationCache.status should be 0 (UNCACHED)");
+
+expectInvalidState(function() { applicationCache.add("http://localhost:8888/MochiKit/packed.js"); },
+                   "applicationCache.add should throw INVALID_STATE_ERR");
+expectInvalidState(function() { applicationCache.remove("http://localhost:8888/MochiKit/packed.js"); },
+                   "applicationCache.remove should throw INVALID_STATE_ERR");
+expectInvalidState(function() { applicationCache.update(); },
+                   "applicationCache.update should throw INVALID_STATE_ERR");
+expectInvalidState(function() { applicationCache.swapCache(); },
+                   "applicationCache.update should throw INVALID_STATE_ERR");
+
+
+</script>
+
+</head>
+
+<body>
+
+</body>
+</html>
diff --git a/editor/libeditor/base/nsEditorUtils.h b/editor/libeditor/base/nsEditorUtils.h
--- a/editor/libeditor/base/nsEditorUtils.h
+++ b/editor/libeditor/base/nsEditorUtils.h
@@ -51,17 +51,17 @@
 #include "nsCOMArray.h"
 
 class nsPlaintextEditor;
 
 /***************************************************************************
  * stack based helper class for batching a collection of txns inside a 
  * placeholder txn.
  */
-class nsAutoPlaceHolderBatch
+class NS_STACK_CLASS nsAutoPlaceHolderBatch
 {
   private:
     nsCOMPtr<nsIEditor> mEd;
   public:
     nsAutoPlaceHolderBatch( nsIEditor *aEd, nsIAtom *atom) : mEd(do_QueryInterface(aEd)) 
                    { if (mEd) mEd->BeginPlaceHolderTransaction(atom); }
     ~nsAutoPlaceHolderBatch() { if (mEd) mEd->EndPlaceHolderTransaction(); }
 };
@@ -77,17 +77,17 @@ class nsAutoEditBatch : public nsAutoPla
     nsAutoEditBatch( nsIEditor *aEd) : nsAutoPlaceHolderBatch(aEd,nsnull)  {}
     ~nsAutoEditBatch() {}
 };
 
 /***************************************************************************
  * stack based helper class for saving/restoring selection.  Note that this
  * assumes that the nodes involved are still around afterwards!
  */
-class nsAutoSelectionReset
+class NS_STACK_CLASS nsAutoSelectionReset
 {
   private:
     /** ref-counted reference to the selection that we are supposed to restore */
     nsCOMPtr<nsISelection> mSel;
     nsEditor *mEd;  // non-owning ref to nsEditor
 
   public:
     /** constructor responsible for remembering all state needed to restore aSel */
@@ -98,17 +98,17 @@ class nsAutoSelectionReset
 
     /** Abort: cancel selection saver */
     void Abort();
 };
 
 /***************************************************************************
  * stack based helper class for StartOperation()/EndOperation() sandwich
  */
-class nsAutoRules
+class NS_STACK_CLASS nsAutoRules
 {
   public:
   
   nsAutoRules(nsEditor *ed, PRInt32 action, nsIEditor::EDirection aDirection) : 
          mEd(ed), mDoNothing(PR_FALSE)
   { 
     if (mEd && !mEd->mAction) // mAction will already be set if this is nested call
     {
@@ -129,17 +129,17 @@ class nsAutoRules
   PRBool mDoNothing;
 };
 
 
 /***************************************************************************
  * stack based helper class for turning off active selection adjustment
  * by low level transactions
  */
-class nsAutoTxnsConserveSelection
+class NS_STACK_CLASS nsAutoTxnsConserveSelection
 {
   public:
   
   nsAutoTxnsConserveSelection(nsEditor *ed) : mEd(ed), mOldState(PR_TRUE)
   {
     if (mEd) 
     {
       mOldState = mEd->GetShouldTxnSetSelection();
@@ -158,17 +158,17 @@ class nsAutoTxnsConserveSelection
   protected:
   nsEditor *mEd;
   PRBool mOldState;
 };
 
 /***************************************************************************
  * stack based helper class for batching reflow and paint requests.
  */
-class nsAutoUpdateViewBatch
+class NS_STACK_CLASS nsAutoUpdateViewBatch
 {
   public:
   
   nsAutoUpdateViewBatch(nsEditor *ed) : mEd(ed)
   {
     NS_ASSERTION(mEd, "null mEd pointer!");
 
     if (mEd) 
@@ -196,17 +196,17 @@ class nsDomIterFunctor
 };
 
 class nsBoolDomIterFunctor 
 {
   public:
     virtual PRBool operator()(nsIDOMNode* aNode)=0;
 };
 
-class nsDOMIterator
+class NS_STACK_CLASS nsDOMIterator
 {
   public:
     nsDOMIterator();
     virtual ~nsDOMIterator();
     
     nsresult Init(nsIDOMRange* aRange);
     nsresult Init(nsIDOMNode* aNode);
     void ForEach(nsDomIterFunctor& functor) const;
@@ -234,17 +234,17 @@ class nsTrivialFunctor : public nsBoolDo
       return PR_TRUE;
     }
 };
 
 
 /******************************************************************************
  * general dom point utility struct
  *****************************************************************************/
-struct DOMPoint
+struct NS_STACK_CLASS DOMPoint
 {
   nsCOMPtr<nsIDOMNode> node;
   PRInt32 offset;
   
   DOMPoint() : node(0),offset(0) {}
   DOMPoint(nsIDOMNode *aNode, PRInt32 aOffset) : 
                  node(aNode),offset(aOffset) {}
   void SetPoint(nsIDOMNode *aNode, PRInt32 aOffset)
diff --git a/editor/libeditor/base/nsSelectionState.h b/editor/libeditor/base/nsSelectionState.h
--- a/editor/libeditor/base/nsSelectionState.h
+++ b/editor/libeditor/base/nsSelectionState.h
@@ -130,17 +130,17 @@ class nsRangeUpdater
 };
 
 
 /***************************************************************************
  * helper class for using nsSelectionState.  stack based class for doing
  * preservation of dom points across editor actions
  */
 
-class nsAutoTrackDOMPoint
+class NS_STACK_CLASS nsAutoTrackDOMPoint
 {
   private:
     nsRangeUpdater &mRU;
     nsCOMPtr<nsIDOMNode> *mNode;
     PRInt32 *mOffset;
     nsRangeStore mRangeItem;
   public:
     nsAutoTrackDOMPoint(nsRangeUpdater &aRangeUpdater, nsCOMPtr<nsIDOMNode> *aNode, PRInt32 *aOffset) :
@@ -165,17 +165,17 @@ class nsAutoTrackDOMPoint
 
 
 
 /***************************************************************************
  * another helper class for nsSelectionState.  stack based class for doing
  * Will/DidReplaceContainer()
  */
 
-class nsAutoReplaceContainerSelNotify
+class NS_STACK_CLASS nsAutoReplaceContainerSelNotify
 {
   private:
     nsRangeUpdater &mRU;
     nsIDOMNode *mOriginalNode;
     nsIDOMNode *mNewNode;
 
   public:
     nsAutoReplaceContainerSelNotify(nsRangeUpdater &aRangeUpdater, nsIDOMNode *aOriginalNode, nsIDOMNode *aNewNode) :
@@ -193,17 +193,17 @@ class nsAutoReplaceContainerSelNotify
 };
 
 
 /***************************************************************************
  * another helper class for nsSelectionState.  stack based class for doing
  * Will/DidRemoveContainer()
  */
 
-class nsAutoRemoveContainerSelNotify
+class NS_STACK_CLASS nsAutoRemoveContainerSelNotify
 {
   private:
     nsRangeUpdater &mRU;
     nsIDOMNode *mNode;
     nsIDOMNode *mParent;
     PRInt32    mOffset;
     PRUint32   mNodeOrigLen;
 
@@ -228,17 +228,17 @@ class nsAutoRemoveContainerSelNotify
     }
 };
 
 /***************************************************************************
  * another helper class for nsSelectionState.  stack based class for doing
  * Will/DidInsertContainer()
  */
 
-class nsAutoInsertContainerSelNotify
+class NS_STACK_CLASS nsAutoInsertContainerSelNotify
 {
   private:
     nsRangeUpdater &mRU;
 
   public:
     nsAutoInsertContainerSelNotify(nsRangeUpdater &aRangeUpdater) :
     mRU(aRangeUpdater)
     {
@@ -252,17 +252,17 @@ class nsAutoInsertContainerSelNotify
 };
 
 
 /***************************************************************************
  * another helper class for nsSelectionState.  stack based class for doing
  * Will/DidMoveNode()
  */
 
-class nsAutoMoveNodeSelNotify
+class NS_STACK_CLASS nsAutoMoveNodeSelNotify
 {
   private:
     nsRangeUpdater &mRU;
     nsIDOMNode *mOldParent;
     nsIDOMNode *mNewParent;
     PRInt32    mOldOffset;
     PRInt32    mNewOffset;
 
diff --git a/editor/libeditor/html/nsTableEditor.cpp b/editor/libeditor/html/nsTableEditor.cpp
--- a/editor/libeditor/html/nsTableEditor.cpp
+++ b/editor/libeditor/html/nsTableEditor.cpp
@@ -64,17 +64,17 @@
 #include "nsHTMLEditUtils.h"
 #include "nsLayoutErrors.h"
 
 
 
 /***************************************************************************
  * stack based helper class for restoring selection after table edit
  */
-class nsSetSelectionAfterTableEdit
+class NS_STACK_CLASS nsSetSelectionAfterTableEdit
 {
   private:
     nsCOMPtr<nsITableEditor> mEd;
     nsCOMPtr<nsIDOMElement> mTable;
     PRInt32 mCol, mRow, mDirection, mSelected;
   public:
     nsSetSelectionAfterTableEdit(nsITableEditor *aEd, nsIDOMElement* aTable, 
                                  PRInt32 aRow, PRInt32 aCol, PRInt32 aDirection, 
@@ -94,17 +94,17 @@ class nsSetSelectionAfterTableEdit
         mEd->SetSelectionAfterTableEdit(mTable, mRow, mCol, mDirection, mSelected);
     }
     // This is needed to abort the caret reset in the destructor
     //  when one method yields control to another
     void CancelSetCaret() {mEd = nsnull; mTable = nsnull;}
 };
 
 // Stack-class to turn on/off selection batching for table selection
-class nsSelectionBatcher
+class NS_STACK_CLASS nsSelectionBatcher
 {
 private:
   nsCOMPtr<nsISelectionPrivate> mSelection;
 public:
   nsSelectionBatcher(nsISelection *aSelection)
   {
     nsCOMPtr<nsISelection> sel(aSelection);
     mSelection = do_QueryInterface(sel);
diff --git a/editor/libeditor/html/nsWSRunObject.h b/editor/libeditor/html/nsWSRunObject.h
--- a/editor/libeditor/html/nsWSRunObject.h
+++ b/editor/libeditor/html/nsWSRunObject.h
@@ -62,17 +62,17 @@ class nsHTMLEditor;
 // Throughout I refer to LeadingWS, NormalWS, TrailingWS.  LeadingWS & TrailingWS
 // are runs of ascii ws that are insignificant (do not render) because they
 // are adjacent to block boundaries, or after a break.  NormalWS is ws that
 // does cause soem rendering.  Note that not all the ws in a NormalWS run need
 // render.  For example, two ascii spaces surrounded by text on both sides
 // will only render as one space (in non-preformatted stlye html), yet both
 // spaces count as NormalWS.  Together, they render as the one visible space.
 
-class nsWSRunObject
+class NS_STACK_CLASS nsWSRunObject
 {
   public:
 
     enum BlockBoundary
     {
       kBeforeBlock,
       kBlockStart,
       kBlockEnd,
@@ -221,17 +221,17 @@ class nsWSRunObject
                      mRightType(0),mLeft(0),mRight(0) {}
     };
     
     // WSPoint struct ------------------------------------------------------------
     // A WSPoint struct represents a unique location within the ws run.  It is 
     // always within a textnode that is one of the nodes stored in the list
     // in the wsRunObject.  For convenience, the character at that point is also 
     // stored in the struct.
-    struct WSPoint
+    struct NS_STACK_CLASS WSPoint
     {
       nsCOMPtr<nsIContent> mTextNode;
       PRInt16 mOffset;
       PRUnichar mChar;
       
       WSPoint() : mTextNode(0),mOffset(0),mChar(0) {}
       WSPoint(nsIDOMNode *aNode, PRInt32 aOffset, PRUnichar aChar) : 
                      mTextNode(do_QueryInterface(aNode)),mOffset(aOffset),mChar(aChar)
diff --git a/embedding/components/webbrowserpersist/src/nsWebBrowserPersist.cpp b/embedding/components/webbrowserpersist/src/nsWebBrowserPersist.cpp
--- a/embedding/components/webbrowserpersist/src/nsWebBrowserPersist.cpp
+++ b/embedding/components/webbrowserpersist/src/nsWebBrowserPersist.cpp
@@ -2351,17 +2351,17 @@ public:
     nsresult GetISupports(nsISupports **ret)
     {
         *ret = mKey;
         NS_IF_ADDREF(mKey);
         return NS_OK;
     }
 };
 
-struct FixRedirectData
+struct NS_STACK_CLASS FixRedirectData
 {
     nsCOMPtr<nsIChannel> mNewChannel;
     nsCOMPtr<nsIURI> mOriginalURI;
     nsISupportsKey *mMatchingKey;
 };
 
 nsresult
 nsWebBrowserPersist::FixRedirectedChannelEntry(nsIChannel *aNewChannel)
diff --git a/embedding/components/windowwatcher/src/nsWindowWatcher.cpp b/embedding/components/windowwatcher/src/nsWindowWatcher.cpp
--- a/embedding/components/windowwatcher/src/nsWindowWatcher.cpp
+++ b/embedding/components/windowwatcher/src/nsWindowWatcher.cpp
@@ -263,17 +263,17 @@ void nsWatcherWindowEnumerator::WindowRe
     mCurrentPosition = mCurrentPosition != inInfo->mYounger ?
                        inInfo->mYounger : 0;
 }
 
 /****************************************************************
  ********************** JSContextAutoPopper *********************
  ****************************************************************/
 
-class JSContextAutoPopper {
+class NS_STACK_CLASS JSContextAutoPopper {
 public:
   JSContextAutoPopper();
   ~JSContextAutoPopper();
 
   nsresult   Push(JSContext *cx = nsnull);
   JSContext *get() { return mContext; }
 
 protected:
diff --git a/gfx/cairo/cairo/src/cairo-quartz-font.c b/gfx/cairo/cairo/src/cairo-quartz-font.c
--- a/gfx/cairo/cairo/src/cairo-quartz-font.c
+++ b/gfx/cairo/cairo/src/cairo-quartz-font.c
@@ -182,16 +182,21 @@ _cairo_quartz_font_face_scaled_font_crea
 	fs_metrics.max_x_advance = CGRectGetMaxX(bbox) / ems;
 	fs_metrics.max_y_advance = 0.0;
     } else {
 	CGGlyph wGlyph;
 	UniChar u;
 
 	quartz_CGFontMetrics *m;
 	m = CGFontGetHMetricsPtr (font_face->cgFont);
+
+	if (!m) {
+	    status = _cairo_error(CAIRO_STATUS_NULL_POINTER);
+	    goto FINISH;
+	}
 
 	fs_metrics.ascent = (m->ascent / ems);
 	fs_metrics.descent = - (m->descent / ems);
 	fs_metrics.height = fs_metrics.ascent + fs_metrics.descent + (m->leading / ems);
 
 	/* We kind of have to guess here; W's big, right? */
 	u = (UniChar) 'W';
 	CGFontGetGlyphsForUnicharsPtr (font_face->cgFont, &u, &wGlyph, 1);
diff --git a/gfx/thebes/public/gfxAtsuiFonts.h b/gfx/thebes/public/gfxAtsuiFonts.h
--- a/gfx/thebes/public/gfxAtsuiFonts.h
+++ b/gfx/thebes/public/gfxAtsuiFonts.h
@@ -80,24 +80,26 @@ public:
     PRBool HasMirroringInfo();
 
     virtual void SetupGlyphExtents(gfxContext *aContext, PRUint32 aGlyphID,
             PRBool aNeedTight, gfxGlyphExtents *aExtents);
 
     PRBool TestCharacterMap(PRUint32 aCh);
 
     MacOSFontEntry* GetFontEntry();
+    PRBool Valid() { return mValid; }
 
 protected:
     const gfxFontStyle *mFontStyle;
 
     ATSUStyle mATSUStyle;
 
     nsRefPtr<MacOSFontEntry> mFontEntry;
 
+    PRBool mValid;
     PRBool mHasMirroring;
     PRBool mHasMirroringLookedUp;
 
     nsString mUniqueName;
 
     cairo_font_face_t *mFontFace;
     cairo_scaled_font_t *mScaledFont;
 
diff --git a/gfx/thebes/public/gfxPlatformMac.h b/gfx/thebes/public/gfxPlatformMac.h
--- a/gfx/thebes/public/gfxPlatformMac.h
+++ b/gfx/thebes/public/gfxPlatformMac.h
@@ -51,18 +51,18 @@ public:
 
     static gfxPlatformMac *GetPlatform() {
         return (gfxPlatformMac*) gfxPlatform::GetPlatform();
     }
 
     already_AddRefed<gfxASurface> CreateOffscreenSurface(const gfxIntSize& size,
                                                          gfxASurface::gfxImageFormat imageFormat);
 
-    already_AddRefed<gfxASurface> gfxPlatformMac::OptimizeImage(gfxImageSurface *aSurface,
-                                                                gfxASurface::gfxImageFormat format);
+    already_AddRefed<gfxASurface> OptimizeImage(gfxImageSurface *aSurface,
+                                                gfxASurface::gfxImageFormat format);
 
     nsresult ResolveFontName(const nsAString& aFontName,
                              FontResolverCallback aCallback,
                              void *aClosure, PRBool& aAborted);
 
     nsresult GetStandardFamilyName(const nsAString& aFontName, nsAString& aFamilyName);
 
     gfxFontGroup *CreateFontGroup(const nsAString &aFamilies,
@@ -79,18 +79,18 @@ public:
     // Returns the OS X version as returned from Gestalt(gestaltSystemVersion, ...)
     // Ex: Mac OS X 10.4.x ==> 0x104x 
     PRInt32 OSXVersion();
 
     // lower threshold on font anti-aliasing
     PRUint32 GetAntiAliasingThreshold() { return mFontAntiAliasingThreshold; }
     
 private:
-    void gfxPlatformMac::AppendCJKPrefLangs(eFontPrefLang aPrefLangs[], PRUint32 &aLen, 
-                                            eFontPrefLang aCharLang, eFontPrefLang aPageLang);
+    void AppendCJKPrefLangs(eFontPrefLang aPrefLangs[], PRUint32 &aLen, 
+                            eFontPrefLang aCharLang, eFontPrefLang aPageLang);
                                                
     virtual cmsHPROFILE GetPlatformCMSOutputProfile();
     
     // read in the pref value for the lower threshold on font anti-aliasing
     static PRUint32 ReadAntiAliasingThreshold();    
     
     nsTArray<PRUint32> mCJKPrefLangs;
     PRInt32 mOSXVersion;
diff --git a/gfx/thebes/src/gfxAtsuiFonts.cpp b/gfx/thebes/src/gfxAtsuiFonts.cpp
--- a/gfx/thebes/src/gfxAtsuiFonts.cpp
+++ b/gfx/thebes/src/gfxAtsuiFonts.cpp
@@ -89,17 +89,17 @@ OSStatus ATSClearGlyphVector(void *glyph
 #endif
 
 eFontPrefLang GetFontPrefLangFor(PRUint8 aUnicodeRange);
 
 gfxAtsuiFont::gfxAtsuiFont(MacOSFontEntry *aFontEntry,
                            const gfxFontStyle *fontStyle, PRBool aNeedsBold)
     : gfxFont(aFontEntry->Name(), fontStyle),
       mFontStyle(fontStyle), mATSUStyle(nsnull), mFontEntry(aFontEntry),
-      mHasMirroring(PR_FALSE), mHasMirroringLookedUp(PR_FALSE), mAdjustedSize(0.0f)
+      mValid(PR_TRUE), mHasMirroring(PR_FALSE), mHasMirroringLookedUp(PR_FALSE), mAdjustedSize(0.0f)
 {
     ATSUFontID fontID = mFontEntry->GetFontID();
     ATSFontRef fontRef = FMGetATSFontRefFromFont(fontID);
 
     // determine whether synthetic bolding is needed
     PRInt8 baseWeight, weightDistance;
     mFontStyle->ComputeWeightAndOffset(&baseWeight, &weightDistance);
     PRUint16 targetWeight = (baseWeight * 100) + (weightDistance * 100);
@@ -144,18 +144,27 @@ gfxAtsuiFont::gfxAtsuiFont(MacOSFontEntr
     // turn off font anti-aliasing based on user pref setting
     if (mAdjustedSize <= (float) gfxPlatformMac::GetPlatform()->GetAntiAliasingThreshold()) {
         cairo_font_options_set_antialias(fontOptions, CAIRO_ANTIALIAS_NONE); 
         //printf("font: %s, size: %f, disabling anti-aliasing\n", NS_ConvertUTF16toUTF8(mName).get(), mAdjustedSize);
     }
     
     mScaledFont = cairo_scaled_font_create(mFontFace, &sizeMatrix, &ctm, fontOptions);
     cairo_font_options_destroy(fontOptions);
-    NS_ASSERTION(cairo_scaled_font_status(mScaledFont) == CAIRO_STATUS_SUCCESS,
-                 "Failed to create scaled font");
+
+    cairo_status_t cairoerr = cairo_scaled_font_status(mScaledFont);
+    if (cairoerr != CAIRO_STATUS_SUCCESS) {
+        mValid = PR_FALSE;
+
+#ifdef DEBUG        
+        char warnBuf[1024];
+        sprintf(warnBuf, "Failed to create scaled font: %s status: %d", NS_ConvertUTF16toUTF8(mName).get(), cairoerr);
+        NS_WARNING(warnBuf);
+#endif
+    }
 }
 
 
 ATSUFontID gfxAtsuiFont::GetATSUFontID()
 {
     return mFontEntry->GetFontID();
 }
 
@@ -410,16 +419,17 @@ gfxAtsuiFont::HasMirroringInfo()
         mHasMirroring = (status == noErr);
         mHasMirroringLookedUp = PR_TRUE;
     }
     
     return mHasMirroring;
 }
 
 PRBool gfxAtsuiFont::TestCharacterMap(PRUint32 aCh) {
+    if (!mValid) return PR_FALSE;
     return mFontEntry->TestCharacterMap(aCh);
 }
 
 MacOSFontEntry*
 gfxAtsuiFont::GetFontEntry()
 {
     return mFontEntry.get();
 }
@@ -431,19 +441,24 @@ gfxAtsuiFont::GetFontEntry()
  */
  
 static already_AddRefed<gfxAtsuiFont>
 GetOrMakeFont(MacOSFontEntry *aFontEntry, const gfxFontStyle *aStyle, PRBool aNeedsBold)
 {
     // the font entry name is the psname, not the family name
     nsRefPtr<gfxFont> font = gfxFontCache::GetCache()->Lookup(aFontEntry->Name(), aStyle);
     if (!font) {
-        font = new gfxAtsuiFont(aFontEntry, aStyle, aNeedsBold);
-        if (!font)
+        gfxAtsuiFont *newFont = new gfxAtsuiFont(aFontEntry, aStyle, aNeedsBold);
+        if (!newFont)
             return nsnull;
+        if (!newFont->Valid()) {
+            delete newFont;
+            return nsnull;
+        }
+        font = newFont;
         gfxFontCache::GetCache()->AddNew(font);
     }
     gfxFont *f = nsnull;
     font.swap(f);
     return static_cast<gfxAtsuiFont *>(f);
 }
 
 gfxAtsuiFontGroup::gfxAtsuiFontGroup(const nsAString& families,
@@ -830,16 +845,17 @@ gfxAtsuiFontGroup::WhichPrefFontSupports
                 return prefFont.forget();
             }
             
             PRBool needsBold;
             MacOSFontEntry *fe = family->FindFont(&mStyle, needsBold);
             // if ch in cmap, create and return a gfxFont
             if (fe && fe->TestCharacterMap(aCh)) {
                 nsRefPtr<gfxAtsuiFont> prefFont = GetOrMakeFont(fe, &mStyle, needsBold);
+                if (!prefFont) continue;
                 mLastPrefFamily = family;
                 mLastPrefFont = prefFont;
                 mLastPrefLang = charLang;
                 mLastPrefFirstFont = (i == 0);
                 return prefFont.forget();
             }
 
         }
diff --git a/intl/uconv/src/charsetData.properties b/intl/uconv/src/charsetData.properties
--- a/intl/uconv/src/charsetData.properties
+++ b/intl/uconv/src/charsetData.properties
@@ -61,16 +61,17 @@ iso-8859-6-e.notForBrowser              
 iso-8859-6-e.notForBrowser              = true
 iso-8859-6-i.notForBrowser              = true
 ibm864i.notForBrowser                   = true
 ibm869.notForBrowser                    = true
 ibm1125.notForBrowser                   = true
 ibm1131.notForBrowser                   = true
 x-ibm1046.notForBrowser                 = true
 iso-8859-8-e.notForBrowser              = true
+utf-7.notForBrowser                     = true
 
 t.61-8bit.notForOutgoing             = true
 utf-7.notForOutgoing                 = true
 x-imap4-modified-utf7.notForOutgoing = true
 windows-936.notForOutgoing           = true
 us-ascii.notForOutgoing                  = true
 x-obsoleted-euc-jp.notForOutgoing        = true
 x-obsoleted-iso-2022-jp.notForOutgoing   = true
diff --git a/intl/uconv/src/nsScriptableUConv.h b/intl/uconv/src/nsScriptableUConv.h
--- a/intl/uconv/src/nsScriptableUConv.h
+++ b/intl/uconv/src/nsScriptableUConv.h
@@ -49,19 +49,17 @@ public:
 public:
   NS_DECL_ISUPPORTS
   NS_DECL_NSISCRIPTABLEUNICODECONVERTER
 
   nsScriptableUnicodeConverter();
   virtual ~nsScriptableUnicodeConverter();
 
 protected:
-  // charsets are ALWAYS very short, so its actually better to use
-  // nsCAutoString here
-  nsCAutoString mCharset;
+  nsCString mCharset;
   nsCOMPtr<nsIUnicodeEncoder> mEncoder;
   nsCOMPtr<nsIUnicodeDecoder> mDecoder;
 
   nsresult FinishWithLength(char **_retval, PRInt32* aLength);
   nsresult ConvertFromUnicodeWithLength(const nsAString& aSrc,
                                         PRInt32* aOutLen,
                                         char **_retval);
 
diff --git a/js/src/Makefile.ref b/js/src/Makefile.ref
--- a/js/src/Makefile.ref
+++ b/js/src/Makefile.ref
@@ -324,17 +324,17 @@ endif
 endif
 
 $(PROGRAM).pure: $(PROG_OBJS) $(LIBRARY)
 	purify $(PUREFLAGS) \
 	    $(CXX) -o $@ $(PURE_OS_CFLAGS) $(PROG_OBJS) $(LIBRARY) $(LDFLAGS) \
 		$(OTHER_LIBS) $(PROG_LIBS)
 
 ifndef PREBUILT_CPUCFG
-$(HFILES) $(CPPFILES): $(OBJDIR)/jsautocfg.h
+$(filter-out jscpucfg.h $(OBJDIR)/jsautocfg.h, $(HFILES)) $(CPPFILES): $(OBJDIR)/jsautocfg.h
 
 $(OBJDIR)/jsautocfg.h: $(OBJDIR)/jscpucfg
 	rm -f $@
 	$(OBJDIR)/jscpucfg > $@
 
 $(OBJDIR)/jscpucfg: $(OBJDIR)/jscpucfg.o
 	$(CXX) $(OS_LDFLAGS) -o $@ $(OBJDIR)/jscpucfg.o
 
diff --git a/js/src/config.mk b/js/src/config.mk
--- a/js/src/config.mk
+++ b/js/src/config.mk
@@ -121,28 +121,28 @@ endif
 endif
 
 ifdef BUILD_OPT
 ifdef USE_MSVC
 OPTIMIZER  = -O2 -GL
 INTERP_OPTIMIZER = -O2 -GL
 LDFLAGS    += -LTCG
 else
-OPTIMIZER  = -Os
-INTERP_OPTIMIZER = -Os
+OPTIMIZER  = -Os -fno-exceptions -fno-rtti
+INTERP_OPTIMIZER = -Os -fno-exceptions -fno-rtti
 endif
 DEFINES    += -UDEBUG -DNDEBUG -UDEBUG_$(USER)
 OBJDIR_TAG = _OPT
 else
 ifdef USE_MSVC
 OPTIMIZER  = -Zi
 INTERP_OPTIMIZER = -Zi
 else
-OPTIMIZER  = -g3
-INTERP_OPTIMIZER = -g3
+OPTIMIZER  = -g3 -fno-exceptions -fno-rtti
+INTERP_OPTIMIZER = -g3 -fno-exceptions -fno-rtti
 endif
 DEFINES    += -DDEBUG -DDEBUG_$(USER)
 OBJDIR_TAG = _DBG
 endif
 
 SO_SUFFIX = so
 
 NS_USE_NATIVE = 1
diff --git a/js/src/js.msg b/js/src/js.msg
--- a/js/src/js.msg
+++ b/js/src/js.msg
@@ -300,8 +300,9 @@ MSG_DEF(JSMSG_EMPTY_ARRAY_REDUCE,     21
 MSG_DEF(JSMSG_EMPTY_ARRAY_REDUCE,     218, 0, JSEXN_TYPEERR, "reduce of empty array with no initial value")
 MSG_DEF(JSMSG_NON_LIST_XML_METHOD,    219, 2, JSEXN_TYPEERR, "cannot call {0} method on an XML list with {1} elements")
 MSG_DEF(JSMSG_BAD_DELETE_OPERAND,     220, 0, JSEXN_SYNTAXERR, "invalid delete operand")
 MSG_DEF(JSMSG_BAD_INCOP_OPERAND,      221, 0, JSEXN_SYNTAXERR, "invalid increment/decrement operand")
 MSG_DEF(JSMSG_NULL_OR_UNDEFINED,      222, 2, JSEXN_TYPEERR, "{0} is {1}")
 MSG_DEF(JSMSG_LET_DECL_NOT_IN_BLOCK,  223, 0, JSEXN_SYNTAXERR, "let declaration not directly within block")
 MSG_DEF(JSMSG_BAD_OBJECT_INIT,        224, 0, JSEXN_SYNTAXERR, "invalid object initializer")
 MSG_DEF(JSMSG_CANT_SET_ARRAY_ATTRS,   225, 0, JSEXN_INTERNALERR, "can't set attributes on indexed array properties")
+MSG_DEF(JSMSG_EVAL_ARITY,             226, 0, JSEXN_TYPEERR, "eval accepts only one parameter")
diff --git a/js/src/jsapi.h b/js/src/jsapi.h
--- a/js/src/jsapi.h
+++ b/js/src/jsapi.h
@@ -98,18 +98,18 @@ JS_BEGIN_EXTERN_C
                                  ? JS_UnlockGCThing(cx, JSVAL_TO_GCTHING(v))  \
                                  : JS_TRUE)
 
 /* Domain limits for the jsval int type. */
 #define JSVAL_INT_BITS          31
 #define JSVAL_INT_POW2(n)       ((jsval)1 << (n))
 #define JSVAL_INT_MIN           (-JSVAL_INT_POW2(30))
 #define JSVAL_INT_MAX           (JSVAL_INT_POW2(30) - 1)
-#define INT_FITS_IN_JSVAL(i)    ((jsuint)(i) + JSVAL_INT_MAX + 1 <=           \
-                                 2 * JSVAL_INT_MAX + 1)
+#define INT_FITS_IN_JSVAL(i)    ((jsuint)(i) - (jsuint)JSVAL_INT_MIN <=      \
+                                 (jsuint)(JSVAL_INT_MAX - JSVAL_INT_MIN))
 #define JSVAL_TO_INT(v)         ((jsint)(v) >> 1)
 #define INT_TO_JSVAL(i)         (((jsval)(i) << 1) | JSVAL_INT)
 
 /* Convert between boolean and jsval. */
 #define JSVAL_TO_BOOLEAN(v)     ((JSBool)((v) >> JSVAL_TAGBITS))
 #define BOOLEAN_TO_JSVAL(b)     JSVAL_SETTAG((jsval)(b) << JSVAL_TAGBITS,     \
                                              JSVAL_BOOLEAN)
 
diff --git a/js/src/jsarray.cpp b/js/src/jsarray.cpp
--- a/js/src/jsarray.cpp
+++ b/js/src/jsarray.cpp
@@ -111,21 +111,18 @@
 #define INDEX_TOO_BIG(index) ((index) > JS_BIT(29) - 1)
 #define INDEX_TOO_SPARSE(array, index)                                         \
     (INDEX_TOO_BIG(index) ||                                                   \
      ((index) > ARRAY_DENSE_LENGTH(array) && (index) >= MIN_SPARSE_INDEX &&    \
       (index) > (uint32)((array)->fslots[JSSLOT_ARRAY_COUNT] + 1) * 4))
 
 JS_STATIC_ASSERT(sizeof(JSScopeProperty) > 4 * sizeof(jsval));
 
-static JSBool
-MakeArraySlow(JSContext *cx, JSObject *obj);
-
 #define ENSURE_SLOW_ARRAY(cx, obj)                                             \
-    (OBJ_GET_CLASS(cx, obj) == &js_SlowArrayClass || MakeArraySlow(cx, obj))
+    (OBJ_GET_CLASS(cx, obj) == &js_SlowArrayClass || js_MakeArraySlow(cx, obj))
 
 /*
  * Determine if the id represents an array index or an XML property index.
  *
  * An id is an array index according to ECMA by (15.4):
  *
  * "Array objects give special treatment to a certain class of property names.
  * A property name P (in the form of a string value) is an array index if and
@@ -412,17 +409,17 @@ GetArrayElement(JSContext *cx, JSObject 
  */
 static JSBool
 SetArrayElement(JSContext *cx, JSObject *obj, jsuint index, jsval v)
 {
     jsid id;
 
     if (OBJ_IS_DENSE_ARRAY(cx, obj)) {
         if (INDEX_TOO_SPARSE(obj, index)) {
-            if (!MakeArraySlow(cx, obj))
+            if (!js_MakeArraySlow(cx, obj))
                 return JS_FALSE;
         } else {
 
             if (!EnsureLength(cx, obj, index + 1))
                 return JS_FALSE;
             if (index >= (uint32)obj->fslots[JSSLOT_ARRAY_LENGTH])
                 obj->fslots[JSSLOT_ARRAY_LENGTH] = index + 1;
             if (obj->dslots[index] == JSVAL_HOLE)
@@ -696,23 +693,39 @@ array_getProperty(JSContext *cx, JSObjec
         return JS_TRUE;
     }
 
     if (!OBJ_IS_DENSE_ARRAY(cx, obj))
         return js_GetProperty(cx, obj, id, vp);
 
     if (!js_IdIsIndex(ID_TO_VALUE(id), &i) || i >= ARRAY_DENSE_LENGTH(obj) ||
         obj->dslots[i] == JSVAL_HOLE) {
+        JSObject *obj2;
+        JSProperty *prop;
+        JSScopeProperty *sprop;
+
         JSObject *proto = STOBJ_GET_PROTO(obj);
         if (!proto) {
             *vp = JSVAL_VOID;
             return JS_TRUE;
         }
 
-        return OBJ_GET_PROPERTY(cx, proto, id, vp);
+        *vp = JSVAL_VOID;
+        if (js_LookupPropertyWithFlags(cx, proto, id, 0, &obj2, &prop) < 0)
+            return JS_FALSE;
+
+        if (prop) {
+            if (OBJ_IS_NATIVE(obj2)) {
+                sprop = (JSScopeProperty *) prop;
+                if (!js_NativeGet(cx, obj, obj2, sprop, vp))
+                    return JS_FALSE;
+            }
+            OBJ_DROP_PROPERTY(cx, obj2, prop);
+        }
+        return JS_TRUE;
     }
 
     *vp = obj->dslots[i];
     return JS_TRUE;
 }
 
 static JSBool
 slowarray_addProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp)
@@ -758,17 +771,17 @@ array_setProperty(JSContext *cx, JSObjec
 
     if (id == ATOM_TO_JSID(cx->runtime->atomState.lengthAtom))
         return array_length_setter(cx, obj, id, vp);
 
     if (!OBJ_IS_DENSE_ARRAY(cx, obj))
         return js_SetProperty(cx, obj, id, vp);
 
     if (!js_IdIsIndex(id, &i) || INDEX_TOO_SPARSE(obj, i)) {
-        if (!MakeArraySlow(cx, obj))
+        if (!js_MakeArraySlow(cx, obj))
             return JS_FALSE;
         return js_SetProperty(cx, obj, id, vp);
     }
 
     if (!EnsureLength(cx, obj, i + 1))
         return JS_FALSE;
 
     if (i >= (uint32)obj->fslots[JSSLOT_ARRAY_LENGTH])
@@ -1104,18 +1117,18 @@ JSClass js_SlowArrayClass = {
     JS_EnumerateStub,      JS_ResolveStub,  js_TryValueOf,    JS_FinalizeStub,
     slowarray_getObjectOps, NULL,           NULL,             NULL,
     NULL,                  NULL,            NULL,             NULL
 };
 
 /*
  * Convert an array object from fast-and-dense to slow-and-flexible.
  */
-static JSBool
-MakeArraySlow(JSContext *cx, JSObject *obj)
+JSBool
+js_MakeArraySlow(JSContext *cx, JSObject *obj)
 {
     JSObjectMap *map, *oldmap;
     uint32 i, length;
 
     JS_ASSERT(OBJ_GET_CLASS(cx, obj) == &js_ArrayClass);
 
     /* Create a native scope. */
     map = js_NewObjectMap(cx, obj->map->nrefs, &js_SlowArrayObjectOps,
@@ -2054,17 +2067,17 @@ array_push(JSContext *cx, uintN argc, js
     obj = JS_THIS_OBJECT(cx, vp);
     if (!obj)
         return JS_FALSE;
     if (argc != 1 || !OBJ_IS_DENSE_ARRAY(cx, obj))
         return array_push_slowly(cx, obj, argc, vp);
 
     length = obj->fslots[JSSLOT_ARRAY_LENGTH];
     if (INDEX_TOO_SPARSE(obj, length)) {
-        if (!MakeArraySlow(cx, obj))
+        if (!js_MakeArraySlow(cx, obj))
             return JS_FALSE;
         return array_push_slowly(cx, obj, argc, vp);
     }
 
     if (!EnsureLength(cx, obj, length + 1))
         return JS_FALSE;
     obj->fslots[JSSLOT_ARRAY_LENGTH] = length + 1;
 
@@ -2080,33 +2093,26 @@ array_pop(JSContext *cx, uintN argc, jsv
     JSObject *obj;
     jsuint index;
     JSBool hole;
 
     obj = JS_THIS_OBJECT(cx, vp);
     if (!obj)
         return JS_FALSE;
     if (OBJ_IS_DENSE_ARRAY(cx, obj)) {
-        *vp = JSVAL_VOID;
         index = obj->fslots[JSSLOT_ARRAY_LENGTH];
-        if (index == 0)
+        if (index == 0) {
+            *vp = JSVAL_VOID;
             return JS_TRUE;
+        }
         index--;
-        if (index < ARRAY_DENSE_LENGTH(obj)) {
-            *vp = obj->dslots[index];
-            JS_ASSERT(*vp != JSVAL_HOLE);
-            if (index == 0) {
-                JS_free(cx, obj->dslots - 1);
-                obj->dslots = NULL;
-            } else {
-                ARRAY_SET_DENSE_LENGTH(obj, index);
-            }
-            obj->fslots[JSSLOT_ARRAY_COUNT]--;
-        }
-
+        if (!GetArrayElement(cx, obj, index, &hole, vp))
+            return JS_FALSE;
+        if (!hole && !DeleteArrayElement(cx, obj, index))
+            return JS_FALSE;
         obj->fslots[JSSLOT_ARRAY_LENGTH] = index;
         return JS_TRUE;
     }
 
     if (!js_GetLengthProperty(cx, obj, &index))
         return JS_FALSE;
     if (index == 0) {
         *vp = JSVAL_VOID;
diff --git a/js/src/jsarray.h b/js/src/jsarray.h
--- a/js/src/jsarray.h
+++ b/js/src/jsarray.h
@@ -66,16 +66,19 @@ extern JSObject *
 extern JSObject *
 js_NewArrayObject(JSContext *cx, jsuint length, jsval *vector,
                   JSBool holey = JS_FALSE);
 
 /* Create an array object that starts out already made slow/sparse. */
 extern JSObject *
 js_NewSlowArrayObject(JSContext *cx);
 
+extern JSBool
+js_MakeArraySlow(JSContext *cx, JSObject *obj);
+
 #define JSSLOT_ARRAY_LENGTH            JSSLOT_PRIVATE
 #define JSSLOT_ARRAY_COUNT             (JSSLOT_ARRAY_LENGTH + 1)
 #define JSSLOT_ARRAY_LOOKUP_HOLDER     (JSSLOT_ARRAY_COUNT + 1)
 
 #define ARRAY_DENSE_LENGTH(obj)                                                \
     (JS_ASSERT(OBJ_IS_DENSE_ARRAY(cx, obj)),                                   \
      (obj)->dslots ? (uint32)(obj)->dslots[-1] : 0)
 
diff --git a/js/src/jscntxt.h b/js/src/jscntxt.h
--- a/js/src/jscntxt.h
+++ b/js/src/jscntxt.h
@@ -160,19 +160,24 @@ typedef enum JSRuntimeState {
 } JSRuntimeState;
 
 typedef struct JSPropertyTreeEntry {
     JSDHashEntryHdr     hdr;
     JSScopeProperty     *child;
 } JSPropertyTreeEntry;
 
 /*
- * Forward declaration for opaque JSRuntime.nativeIteratorStates.
+ * Private type used to enumerate properties of a native JS object.
  */
-typedef struct JSNativeIteratorState JSNativeIteratorState;
+struct JSNativeEnumerator {
+    jsint               next_index;     /* index into jsid array */
+    JSIdArray           *ida;           /* all property ids in enumeration */
+    JSNativeEnumerator  *next;          /* double-linked list support */
+    JSNativeEnumerator  **prevp;
+};
 
 typedef struct JSSetSlotRequest JSSetSlotRequest;
 
 struct JSSetSlotRequest {
     JSObject            *obj;           /* object containing slot to set */
     JSObject            *pobj;          /* new proto or parent reference */
     uint16              slot;           /* which to set, proto or parent */
     uint16              errnum;         /* JSMSG_NO_ERROR or error result */
@@ -375,19 +380,19 @@ struct JSRuntime {
      * the object graph usually associated with a JSContext's global object,
      * including the set of standard class objects.  See jsxml.c for details.
      */
     JSObject            *anynameObject;
     JSObject            *functionNamespaceObject;
 
     /*
      * A helper list for the GC, so it can mark native iterator states. See
-     * js_TraceNativeIteratorStates for details.
+     * js_TraceNativeEnumerators for details.
      */
-    JSNativeIteratorState *nativeIteratorStates;
+    JSNativeEnumerator  *nativeEnumerators;
 
 #ifndef JS_THREADSAFE
     /*
      * For thread-unsafe embeddings, the GSN cache lives in the runtime and
      * not each context, since we expect it to be filled once when decompiling
      * a longer script, then hit repeatedly as js_GetSrcNote is called during
      * the decompiler activation that filled it.
      */
diff --git a/js/src/jsemit.cpp b/js/src/jsemit.cpp
--- a/js/src/jsemit.cpp
+++ b/js/src/jsemit.cpp
@@ -4246,16 +4246,17 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
             return JS_FALSE;
         if (!js_SetSrcNoteOffset(cx, cg, noteIndex, 0, 1 + (beq - top)))
             return JS_FALSE;
         ok = js_PopStatementCG(cx, cg);
         break;
 
       case TOK_FOR:
         beq = 0;                /* suppress gcc warnings */
+        jmp = -1;
         pn2 = pn->pn_left;
         js_PushStatement(&cg->treeContext, &stmtInfo, STMT_FOR_LOOP, top);
 
         if (pn2->pn_type == TOK_IN) {
             JSBool emitIFEQ;
 
             /* Set stmtInfo type for later testing. */
             stmtInfo.type = STMT_FOR_IN_LOOP;
@@ -4297,24 +4298,18 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
             if (!js_EmitTree(cx, cg, pn2->pn_right))
                 return JS_FALSE;
 
             /*
              * Emit a bytecode to convert top of stack value to the iterator
              * object depending on the loop variant (for-in, for-each-in, or
              * destructuring for-in).
              */
-#if JS_HAS_DESTRUCTURING
-            JS_ASSERT(pn->pn_op == JSOP_FORIN ||
-                      pn->pn_op == JSOP_FOREACHKEYVAL ||
-                      pn->pn_op == JSOP_FOREACH);
-#else
-            JS_ASSERT(pn->pn_op == JSOP_FORIN || pn->pn_op == JSOP_FOREACH);
-#endif
-            if (js_Emit1(cx, cg, PN_OP(pn)) < 0)
+            JS_ASSERT(pn->pn_op == JSOP_ITER);
+            if (js_Emit2(cx, cg, PN_OP(pn), (uint8) pn->pn_iflags) < 0)
                 return JS_FALSE;
 
             top = CG_OFFSET(cg);
             SET_STATEMENT_TOP(&stmtInfo, top);
 
             /*
              * Compile a JSOP_FOR* bytecode based on the left hand side.
              *
@@ -4493,17 +4488,34 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
                 if (noteIndex < 0)
                     return JS_FALSE;
 
                 /* Pop and test the loop condition generated by JSOP_FOR*. */
                 beq = EmitJump(cx, cg, JSOP_IFEQ, 0);
                 if (beq < 0)
                     return JS_FALSE;
             }
-        } else {
+
+            /* Emit code for the loop body. */
+            if (!js_EmitTree(cx, cg, pn->pn_right))
+                return JS_FALSE;
+
+            /* Emit the loop-closing jump and fixup all jump offsets. */
+            jmp = EmitJump(cx, cg, JSOP_GOTO, top - CG_OFFSET(cg));
+            if (jmp < 0)
+                return JS_FALSE;
+            if (beq > 0)
+                CHECK_AND_SET_JUMP_OFFSET_AT(cx, cg, beq);
+
+            /* Set the SRC_WHILE note offset so we can find the closing jump. */
+            JS_ASSERT(noteIndex != -1);
+            if (!js_SetSrcNoteOffset(cx, cg, (uintN)noteIndex, 0, jmp - beq))
+                return JS_FALSE;
+        } else {
+            /* C-style for (init; cond; update) ... loop. */
             op = JSOP_POP;
             pn3 = pn2->pn_kid1;
             if (!pn3) {
                 /* No initializer: emit an annotated nop for the decompiler. */
                 op = JSOP_NOP;
             } else {
                 cg->treeContext.flags |= TCF_IN_FOR_INIT;
 #if JS_HAS_DESTRUCTURING
@@ -4530,58 +4542,45 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
                 cg->treeContext.flags &= ~TCF_IN_FOR_INIT;
             }
             noteIndex = js_NewSrcNote(cx, cg, SRC_FOR);
             if (noteIndex < 0 ||
                 js_Emit1(cx, cg, op) < 0) {
                 return JS_FALSE;
             }
 
+            if (pn2->pn_kid2) {
+                /* Goto the loop condition, which branches back to iterate. */
+                jmp = EmitJump(cx, cg, JSOP_GOTO, 0);
+                if (jmp < 0)
+                    return JS_FALSE;
+            }
             top = CG_OFFSET(cg);
             SET_STATEMENT_TOP(&stmtInfo, top);
-            if (!pn2->pn_kid2) {
-                /* No loop condition: flag this fact in the source notes. */
-                if (!js_SetSrcNoteOffset(cx, cg, (uintN)noteIndex, 0, 0))
-                    return JS_FALSE;
-            } else {
-                if (!js_EmitTree(cx, cg, pn2->pn_kid2))
-                    return JS_FALSE;
-                if (!js_SetSrcNoteOffset(cx, cg, (uintN)noteIndex, 0,
-                                         CG_OFFSET(cg) - top)) {
-                    return JS_FALSE;
-                }
-                beq = EmitJump(cx, cg, JSOP_IFEQ, 0);
-                if (beq < 0)
-                    return JS_FALSE;
-            }
-
-            /* Set pn3 (used below) here to avoid spurious gcc warnings. */
-            pn3 = pn2->pn_kid3;
-        }
-
-        /* Emit code for the loop body. */
-        if (!js_EmitTree(cx, cg, pn->pn_right))
-            return JS_FALSE;
-
-        if (pn2->pn_type != TOK_IN) {
+
+            /* Emit code for the loop body. */
+            if (!js_EmitTree(cx, cg, pn->pn_right))
+                return JS_FALSE;
+
             /* Set the second note offset so we can find the update part. */
             JS_ASSERT(noteIndex != -1);
             if (!js_SetSrcNoteOffset(cx, cg, (uintN)noteIndex, 1,
                                      CG_OFFSET(cg) - top)) {
                 return JS_FALSE;
             }
 
+            /* Set loop and enclosing "update" offsets, for continue. */
+            stmt = &stmtInfo;
+            do {
+                stmt->update = CG_OFFSET(cg);
+            } while ((stmt = stmt->down) != NULL && stmt->type == STMT_LABEL);
+
+            /* Check for update code to do before the condition (if any). */
+            pn3 = pn2->pn_kid3;
             if (pn3) {
-                /* Set loop and enclosing "update" offsets, for continue. */
-                stmt = &stmtInfo;
-                do {
-                    stmt->update = CG_OFFSET(cg);
-                } while ((stmt = stmt->down) != NULL &&
-                         stmt->type == STMT_LABEL);
-
                 op = JSOP_POP;
 #if JS_HAS_DESTRUCTURING
                 if (pn3->pn_type == TOK_ASSIGN &&
                     !MaybeEmitGroupAssignment(cx, cg, op, pn3, &op)) {
                     return JS_FALSE;
                 }
 #endif
                 if (op == JSOP_POP) {
@@ -4595,34 +4594,47 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
                 off = (ptrdiff_t) pn->pn_pos.end.lineno;
                 if (CG_CURRENT_LINE(cg) != (uintN) off) {
                     if (js_NewSrcNote2(cx, cg, SRC_SETLINE, off) < 0)
                         return JS_FALSE;
                     CG_CURRENT_LINE(cg) = (uintN) off;
                 }
             }
 
+            /* Set the first note offset so we can find the loop condition. */
+            if (!js_SetSrcNoteOffset(cx, cg, (uintN)noteIndex, 0,
+                                     CG_OFFSET(cg) - top)) {
+                return JS_FALSE;
+            }
+
+            if (pn2->pn_kid2) {
+                /* Fix up the goto from top to target the loop condition. */
+                JS_ASSERT(jmp >= 0);
+                CHECK_AND_SET_JUMP_OFFSET_AT(cx, cg, jmp);
+
+                if (!js_EmitTree(cx, cg, pn2->pn_kid2))
+                    return JS_FALSE;
+            }
+
             /* The third note offset helps us find the loop-closing jump. */
             if (!js_SetSrcNoteOffset(cx, cg, (uintN)noteIndex, 2,
                                      CG_OFFSET(cg) - top)) {
                 return JS_FALSE;
             }
-        }
-
-        /* Emit the loop-closing jump and fixup all jump offsets. */
-        jmp = EmitJump(cx, cg, JSOP_GOTO, top - CG_OFFSET(cg));
-        if (jmp < 0)
-            return JS_FALSE;
-        if (beq > 0)
-            CHECK_AND_SET_JUMP_OFFSET_AT(cx, cg, beq);
-        if (pn2->pn_type == TOK_IN) {
-            /* Set the SRC_WHILE note offset so we can find the closing jump. */
-            JS_ASSERT(noteIndex != -1);
-            if (!js_SetSrcNoteOffset(cx, cg, (uintN)noteIndex, 0, jmp - beq))
-                return JS_FALSE;
+
+            if (pn2->pn_kid2) {
+                beq = EmitJump(cx, cg, JSOP_IFNE, top - CG_OFFSET(cg));
+                if (beq < 0)
+                    return JS_FALSE;
+            } else {
+                /* No loop condition -- emit the loop-closing jump. */
+                jmp = EmitJump(cx, cg, JSOP_GOTO, top - CG_OFFSET(cg));
+                if (jmp < 0)
+                    return JS_FALSE;
+            }
         }
 
         /* Now fixup all breaks and continues (before for/in's JSOP_ENDITER). */
         if (!js_PopStatementCG(cx, cg))
             return JS_FALSE;
 
         if (pn2->pn_type == TOK_IN) {
             /*
diff --git a/js/src/jsfun.cpp b/js/src/jsfun.cpp
--- a/js/src/jsfun.cpp
+++ b/js/src/jsfun.cpp
@@ -578,16 +578,20 @@ JSClass js_ArgumentsClass = {
     args_enumerate,     (JSResolveOp) args_resolve,
     JS_ConvertStub,     JS_FinalizeStub,
     NULL,               NULL,
     NULL,               NULL,
     NULL,               NULL,
     JS_CLASS_TRACE(args_or_call_trace), NULL
 };
 
+#define JSSLOT_SCRIPTED_FUNCTION         (JSSLOT_PRIVATE + 1)
+#define JSSLOT_CALL_ARGUMENTS            (JSSLOT_PRIVATE + 2)
+#define CALL_CLASS_FIXED_RESERVED_SLOTS  2
+
 JSObject *
 js_GetCallObject(JSContext *cx, JSStackFrame *fp, JSObject *parent)
 {
     JSObject *callobj, *funobj;
 
     /* Create a call object for fp only if it lacks one. */
     JS_ASSERT(fp->fun);
     callobj = fp->callobj;
@@ -598,96 +602,120 @@ js_GetCallObject(JSContext *cx, JSStackF
     if (!parent) {
         funobj = fp->callee;
         if (funobj)
             parent = OBJ_GET_PARENT(cx, funobj);
     }
 
     /* Create the call object and link it to its stack frame. */
     callobj = js_NewObject(cx, &js_CallClass, NULL, parent, 0);
-    if (!callobj || !JS_SetPrivate(cx, callobj, fp)) {
-        cx->weakRoots.newborn[GCX_OBJECT] = NULL;
+    if (!callobj)
         return NULL;
-    }
+
+    JS_SetPrivate(cx, callobj, fp);
+    STOBJ_SET_SLOT(callobj, JSSLOT_SCRIPTED_FUNCTION,
+                   OBJECT_TO_JSVAL(FUN_OBJECT(fp->fun)));
     fp->callobj = callobj;
 
     /* Make callobj be the scope chain and the variables object. */
     JS_ASSERT(fp->scopeChain == parent);
     fp->scopeChain = callobj;
     fp->varobj = callobj;
     return callobj;
 }
 
-static JSBool
-call_enumerate(JSContext *cx, JSObject *obj);
+JSFunction *
+js_GetCallObjectFunction(JSObject *obj)
+{
+    jsval v;
+
+    JS_ASSERT(STOBJ_GET_CLASS(obj) == &js_CallClass);
+    v = STOBJ_GET_SLOT(obj, JSSLOT_SCRIPTED_FUNCTION);
+    if (JSVAL_IS_VOID(v)) {
+        /* Newborn or prototype object. */
+        return NULL;
+    }
+    JS_ASSERT(!JSVAL_IS_PRIMITIVE(v));
+    return (JSFunction *) JSVAL_TO_OBJECT(v);
+}
 
 JS_FRIEND_API(JSBool)
 js_PutCallObject(JSContext *cx, JSStackFrame *fp)
 {
     JSObject *callobj;
     JSBool ok;
-    jsid argsid;
-    jsval aval;
+    JSFunction *fun;
+    uintN n;
+    JSScope *scope;
 
     /*
-     * Reuse call_enumerate here to reflect all actual args and vars into the
-     * call object from fp.
+     * Since for a call object all fixed slots happen to be taken, we can copy
+     * arguments and variables straight into JSObject.dslots.
      */
+    JS_STATIC_ASSERT(JS_INITIAL_NSLOTS - JSSLOT_PRIVATE ==
+                     1 + CALL_CLASS_FIXED_RESERVED_SLOTS);
+
     callobj = fp->callobj;
     if (!callobj)
         return JS_TRUE;
-    ok = call_enumerate(cx, callobj);
 
     /*
      * Get the arguments object to snapshot fp's actual argument values.
      */
+    ok = JS_TRUE;
     if (fp->argsobj) {
         if (!TEST_OVERRIDE_BIT(fp, CALL_ARGUMENTS)) {
-            argsid = ATOM_TO_JSID(cx->runtime->atomState.argumentsAtom);
-            aval = OBJECT_TO_JSVAL(fp->argsobj);
-            ok &= js_SetProperty(cx, callobj, argsid, &aval);
+            STOBJ_SET_SLOT(callobj, JSSLOT_CALL_ARGUMENTS,
+                           OBJECT_TO_JSVAL(fp->argsobj));
         }
         ok &= js_PutArgsObject(cx, fp);
     }
 
+    fun = fp->fun;
+    JS_ASSERT(fun == js_GetCallObjectFunction(callobj));
+    n = JS_GET_LOCAL_NAME_COUNT(fun);
+    if (n != 0) {
+        JS_LOCK_OBJ(cx, callobj);
+        n += JS_INITIAL_NSLOTS;
+        if (n > STOBJ_NSLOTS(callobj))
+            ok &= js_ReallocSlots(cx, callobj, n, JS_TRUE);
+        scope = OBJ_SCOPE(callobj);
+        if (ok) {
+            memcpy(callobj->dslots, fp->argv, fun->nargs * sizeof(jsval));
+            memcpy(callobj->dslots + fun->nargs, fp->vars,
+                   fun->u.i.nvars * sizeof(jsval));
+            if (scope->object == callobj && n > scope->map.freeslot)
+                scope->map.freeslot = n;
+        }
+        JS_UNLOCK_SCOPE(cx, scope);
+    }
+
     /*
      * Clear the private pointer to fp, which is about to go away (js_Invoke).
-     * Do this last because the call_enumerate and js_GetProperty calls above
-     * need to follow the private slot to find fp.
+     * Do this last because js_GetProperty calls above need to follow the
+     * private slot to find fp.
      */
-    ok &= JS_SetPrivate(cx, callobj, NULL);
+    JS_SetPrivate(cx, callobj, NULL);
     fp->callobj = NULL;
     return ok;
 }
 
 static JSBool
 call_enumerate(JSContext *cx, JSObject *obj)
 {
-    JSStackFrame *fp;
     JSFunction *fun;
-    uintN n, i, slot;
+    uintN n, i;
     void *mark;
     jsuword *names;
     JSBool ok;
     JSAtom *name;
     JSObject *pobj;
     JSProperty *prop;
-    jsval v;
 
-    fp = (JSStackFrame *) JS_GetPrivate(cx, obj);
-    if (!fp)
-        return JS_TRUE;
-    JS_ASSERT(GET_FUNCTION_PRIVATE(cx, fp->callee) == fp->fun);
-
-    /*
-     * Reflect actual args from fp->argv for formal parameters, and local vars
-     * and functions in fp->vars for declared variables and nested-at-top-level
-     * local functions.
-     */
-    fun = fp->fun;
+    fun = js_GetCallObjectFunction(obj);
     n = JS_GET_LOCAL_NAME_COUNT(fun);
     if (n == 0)
         return JS_TRUE;
 
     mark = JS_ARENA_MARK(&cx->tempPool);
 
     /* From this point the control must flow through the label out. */
     names = js_GetLocalNameArray(cx, fun, &cx->tempPool);
@@ -710,21 +738,17 @@ call_enumerate(JSContext *cx, JSObject *
             goto out;
 
         /*
          * At this point the call object always has a property corresponding
          * to the local name because call_resolve creates the property using
          * JSPROP_PERMANENT.
          */
         JS_ASSERT(prop && pobj == obj);
-        slot = ((JSScopeProperty *) prop)->slot;
         OBJ_DROP_PROPERTY(cx, pobj, prop);
-
-        v = (i < fun->nargs) ? fp->argv[i] : fp->vars[i - fun->nargs];
-        LOCKED_OBJ_SET_SLOT(obj, slot, v);
     }
     ok = JS_TRUE;
 
   out:
     JS_ARENA_RELEASE(&cx->tempPool, mark);
     return ok;
 }
 
@@ -733,45 +757,62 @@ typedef enum JSCallPropertyKind {
     JSCPK_ARG,
     JSCPK_VAR
 } JSCallPropertyKind;
 
 static JSBool
 CallPropertyOp(JSContext *cx, JSObject *obj, jsid id, jsval *vp,
                JSCallPropertyKind kind, JSBool setter)
 {
+    JSFunction *fun;
     JSStackFrame *fp;
-    JSFunction *fun;
     uintN i;
     jsval *array;
 
+    if (STOBJ_GET_CLASS(obj) != &js_CallClass)
+        return JS_TRUE;
+
+    fun = js_GetCallObjectFunction(obj);
     fp = (JSStackFrame *) JS_GetPrivate(cx, obj);
-    if (!fp)
-        return JS_TRUE;
-    fun = fp->fun;
-    JS_ASSERT(fun && FUN_INTERPRETED(fun));
 
     if (kind == JSCPK_ARGUMENTS) {
         if (setter) {
-            SET_OVERRIDE_BIT(fp, CALL_ARGUMENTS);
-        } else if (!TEST_OVERRIDE_BIT(fp, CALL_ARGUMENTS)) {
-            JSObject *argsobj;
+            if (fp)
+                SET_OVERRIDE_BIT(fp, CALL_ARGUMENTS);
+            STOBJ_SET_SLOT(obj, JSSLOT_CALL_ARGUMENTS, *vp);
+        } else {
+            if (fp && !TEST_OVERRIDE_BIT(fp, CALL_ARGUMENTS)) {
+                JSObject *argsobj;
 
-            argsobj = js_GetArgsObject(cx, fp);
-            if (!argsobj)
-                return JS_FALSE;
-            *vp = OBJECT_TO_JSVAL(argsobj);
+                argsobj = js_GetArgsObject(cx, fp);
+                if (!argsobj)
+                    return JS_FALSE;
+                *vp = OBJECT_TO_JSVAL(argsobj);
+            } else {
+                *vp = STOBJ_GET_SLOT(obj, JSSLOT_CALL_ARGUMENTS);
+            }
         }
         return JS_TRUE;
-    }
+  }
 
     JS_ASSERT((int16) JSVAL_TO_INT(id) == JSVAL_TO_INT(id));
     i = (uint16) JSVAL_TO_INT(id);
     JS_ASSERT_IF(kind == JSCPK_ARG, i < fun->nargs);
     JS_ASSERT_IF(kind == JSCPK_VAR, i < fun->u.i.nvars);
+
+    if (!fp) {
+        i += CALL_CLASS_FIXED_RESERVED_SLOTS;
+        if (kind == JSCPK_VAR)
+            i += fun->nargs;
+        else
+            JS_ASSERT(kind == JSCPK_ARG);
+        return setter
+               ? JS_SetReservedSlot(cx, obj, i, *vp)
+               : JS_GetReservedSlot(cx, obj, i, vp);
+    }
 
     JS_ASSERT(fun->u.i.nvars == fp->nvars);
     if (kind == JSCPK_ARG) {
         array = fp->argv;
     } else {
         JS_ASSERT(kind == JSCPK_VAR);
         array = fp->vars;
     }
@@ -817,74 +858,66 @@ SetCallVar(JSContext *cx, JSObject *obj,
 {
     return CallPropertyOp(cx, obj, id, vp, JSCPK_VAR, JS_TRUE);
 }
 
 static JSBool
 call_resolve(JSContext *cx, JSObject *obj, jsval idval, uintN flags,
              JSObject **objp)
 {
-    JSStackFrame *fp;
     JSFunction *fun;
     jsid id;
     JSLocalKind localKind;
     JSPropertyOp getter, setter;
     uintN slot, attrs;
-    jsval *vp;
-
-    fp = (JSStackFrame *) JS_GetPrivate(cx, obj);
-    if (!fp)
-        return JS_TRUE;
-    fun = fp->fun;
-    JS_ASSERT(fun);
-    JS_ASSERT(GET_FUNCTION_PRIVATE(cx, fp->callee) == fun);
 
     if (!JSVAL_IS_STRING(idval))
+        return JS_TRUE;
+
+    fun = js_GetCallObjectFunction(obj);
+    if (!fun)
         return JS_TRUE;
 
     if (!js_ValueToStringId(cx, idval, &id))
         return JS_FALSE;
 
     localKind = js_LookupLocal(cx, fun, JSID_TO_ATOM(id), &slot);
     if (localKind != JSLOCAL_NONE) {
         JS_ASSERT((uint16) slot == slot);
+        attrs = JSPROP_PERMANENT | JSPROP_SHARED;
         if (localKind == JSLOCAL_ARG) {
             JS_ASSERT(slot < fun->nargs);
-            vp = fp->argv;
             getter = js_GetCallArg;
             setter = SetCallArg;
-            attrs = JSPROP_PERMANENT;
         } else {
             JS_ASSERT(localKind == JSLOCAL_VAR || localKind == JSLOCAL_CONST);
-            JS_ASSERT(fun->u.i.nvars == fp->nvars);
             JS_ASSERT(slot < fun->u.i.nvars);
-            vp = fp->vars;
             getter = js_GetCallVar;
             setter = SetCallVar;
-            attrs = (localKind == JSLOCAL_CONST)
-                    ? JSPROP_PERMANENT | JSPROP_READONLY
-                    : JSPROP_PERMANENT;
+            if (localKind == JSLOCAL_CONST)
+                attrs |= JSPROP_READONLY;
         }
-        if (!js_DefineNativeProperty(cx, obj, id, vp[slot], getter, setter,
+        if (!js_DefineNativeProperty(cx, obj, id, JSVAL_VOID, getter, setter,
                                      attrs, SPROP_HAS_SHORTID, (int16) slot,
                                      NULL)) {
             return JS_FALSE;
         }
         *objp = obj;
         return JS_TRUE;
     }
 
     /*
      * Resolve arguments so that we never store a particular Call object's
      * arguments object reference in a Call prototype's |arguments| slot.
      */
     if (id == ATOM_TO_JSID(cx->runtime->atomState.argumentsAtom)) {
         if (!js_DefineNativeProperty(cx, obj, id, JSVAL_VOID,
                                      GetCallArguments, SetCallArguments,
-                                     JSPROP_PERMANENT, 0, 0, NULL)) {
+                                     JSPROP_PERMANENT | JSPROP_SHARED,
+                                     0, 0, NULL)) {
             return JS_FALSE;
         }
         *objp = obj;
         return JS_TRUE;
     }
     return JS_TRUE;
 }
 
@@ -898,28 +931,39 @@ call_convert(JSContext *cx, JSObject *ob
         if (fp) {
             JS_ASSERT(fp->fun);
             *vp = OBJECT_TO_JSVAL(fp->callee);
         }
     }
     return JS_TRUE;
 }
 
+static uint32
+call_reserveSlots(JSContext *cx, JSObject *obj)
+{
+    JSFunction *fun;
+
+    fun = js_GetCallObjectFunction(obj);
+    return JS_GET_LOCAL_NAME_COUNT(fun);
+}
+
 JS_FRIEND_DATA(JSClass) js_CallClass = {
     js_Call_str,
-    JSCLASS_HAS_PRIVATE | JSCLASS_NEW_RESOLVE | JSCLASS_IS_ANONYMOUS |
+    JSCLASS_HAS_PRIVATE |
+    JSCLASS_HAS_RESERVED_SLOTS(CALL_CLASS_FIXED_RESERVED_SLOTS) |
+    JSCLASS_NEW_RESOLVE | JSCLASS_IS_ANONYMOUS |
     JSCLASS_MARK_IS_TRACE | JSCLASS_HAS_CACHED_PROTO(JSProto_Call),
     JS_PropertyStub,    JS_PropertyStub,
     JS_PropertyStub,    JS_PropertyStub,
     call_enumerate,     (JSResolveOp)call_resolve,
     call_convert,       JS_FinalizeStub,
     NULL,               NULL,
     NULL,               NULL,
     NULL,               NULL,
-    JS_CLASS_TRACE(args_or_call_trace), NULL,
+    JS_CLASS_TRACE(args_or_call_trace), call_reserveSlots
 };
 
 /*
  * ECMA-262 specifies that length is a property of function object instances,
  * but we can avoid that space cost by delegating to a prototype property that
  * is JSPROP_PERMANENT and JSPROP_SHARED.  Each fun_getProperty call computes
  * a fresh length value based on the arity of the individual function object's
  * private data.
diff --git a/js/src/jsgc.cpp b/js/src/jsgc.cpp
--- a/js/src/jsgc.cpp
+++ b/js/src/jsgc.cpp
@@ -2860,17 +2860,17 @@ js_TraceRuntime(JSTracer *trc, JSBool al
 {
     JSRuntime *rt = trc->context->runtime;
     JSContext *iter, *acx;
 
     JS_DHashTableEnumerate(&rt->gcRootsHash, gc_root_traversal, trc);
     if (rt->gcLocksHash)
         JS_DHashTableEnumerate(rt->gcLocksHash, gc_lock_traversal, trc);
     js_TraceAtomState(trc, allAtoms);
-    js_TraceNativeIteratorStates(trc);
+    js_TraceNativeEnumerators(trc);
     js_TraceRuntimeNumberState(trc);
 
     iter = NULL;
     while ((acx = js_ContextIterator(rt, JS_TRUE, &iter)) != NULL)
         js_TraceContext(trc, acx);
 
     if (rt->gcExtraRootsTraceOp)
         rt->gcExtraRootsTraceOp(trc, rt->gcExtraRootsData);
diff --git a/js/src/jsinterp.cpp b/js/src/jsinterp.cpp
--- a/js/src/jsinterp.cpp
+++ b/js/src/jsinterp.cpp
@@ -1478,22 +1478,16 @@ js_Execute(JSContext *cx, JSObject *chai
         if (cx->options & JSOPTION_VAROBJFIX) {
             while ((tmp = OBJ_GET_PARENT(cx, obj)) != NULL)
                 obj = tmp;
         }
         frame.varobj = obj;
         frame.callee = NULL;
         frame.fun = NULL;
         frame.thisp = chain;
-        OBJ_TO_OUTER_OBJECT(cx, frame.thisp);
-        if (!frame.thisp) {
-            ok = JS_FALSE;
-            goto out;
-        }
-        flags |= JSFRAME_COMPUTED_THIS;
         frame.argc = 0;
         frame.argv = NULL;
         frame.nvars = script->ngvars;
         if (script->regexpsOffset != 0)
             frame.nvars += JS_SCRIPT_REGEXPS(script)->length;
         if (frame.nvars != 0) {
             frame.vars = js_AllocRawStack(cx, frame.nvars, &mark);
             if (!frame.vars) {
@@ -1533,29 +1527,40 @@ js_Execute(JSContext *cx, JSObject *chai
      */
     if (oldfp && oldfp != down) {
         JS_ASSERT(!oldfp->dormantNext);
         oldfp->dormantNext = cx->dormantFrameChain;
         cx->dormantFrameChain = oldfp;
     }
 
     cx->fp = &frame;
+    if (!down) {
+        OBJ_TO_OUTER_OBJECT(cx, frame.thisp);
+        if (!frame.thisp) {
+            ok = JS_FALSE;
+            goto out2;
+        }
+        frame.flags |= JSFRAME_COMPUTED_THIS;
+    }
+
     if (hook) {
         hookData = hook(cx, &frame, JS_TRUE, 0,
                         cx->debugHooks->executeHookData);
     }
 
     ok = js_Interpret(cx);
     *result = frame.rval;
 
     if (hookData) {
         hook = cx->debugHooks->executeHook;
         if (hook)
             hook(cx, &frame, JS_FALSE, &ok, hookData);
     }
+
+out2:
     if (mark)
         js_FreeRawStack(cx, mark);
     cx->fp = oldfp;
 
     if (oldfp && oldfp != down) {
         JS_ASSERT(cx->dormantFrameChain == oldfp);
         cx->dormantFrameChain = oldfp->dormantNext;
         oldfp->dormantNext = NULL;
@@ -2545,17 +2550,16 @@ js_Interpret(JSContext *cx)
     jsbytecode *endpc, *pc2;
     JSOp op, op2;
     jsatomid index;
     JSAtom *atom;
     uintN argc, attrs, flags;
     uint32 slot;
     jsval *vp, lval, rval, ltmp, rtmp;
     jsid id;
-    JSObject *iterobj;
     JSProperty *prop;
     JSScopeProperty *sprop;
     JSString *str, *str2;
     jsint i, j;
     jsdouble d, d2;
     JSClass *clasp;
     JSFunction *fun;
     JSType type;
@@ -3137,42 +3141,23 @@ js_Interpret(JSContext *cx)
             if (!OBJ_LOOKUP_PROPERTY(cx, obj, id, &obj2, &prop))
                 goto error;
             regs.sp--;
             STORE_OPND(-1, BOOLEAN_TO_JSVAL(prop != NULL));
             if (prop)
                 OBJ_DROP_PROPERTY(cx, obj2, prop);
           END_CASE(JSOP_IN)
 
-          BEGIN_CASE(JSOP_FOREACH)
-            flags = JSITER_ENUMERATE | JSITER_FOREACH;
-            goto value_to_iter;
-
-#if JS_HAS_DESTRUCTURING
-          BEGIN_CASE(JSOP_FOREACHKEYVAL)
-            flags = JSITER_ENUMERATE | JSITER_FOREACH | JSITER_KEYVALUE;
-            goto value_to_iter;
-#endif
-
-          BEGIN_CASE(JSOP_FORIN)
-            /*
-             * Set JSITER_ENUMERATE to indicate that for-in loop should use
-             * the enumeration protocol's iterator for compatibility if an
-             * explicit iterator is not given via the optional __iterator__
-             * method.
-             */
-            flags = JSITER_ENUMERATE;
-
-          value_to_iter:
+          BEGIN_CASE(JSOP_ITER)
+            flags = regs.pc[1];
             JS_ASSERT(regs.sp > fp->spbase);
             if (!js_ValueToIterator(cx, flags, &regs.sp[-1]))
                 goto error;
             JS_ASSERT(!JSVAL_IS_PRIMITIVE(regs.sp[-1]));
-            JS_ASSERT(JSOP_FORIN_LENGTH == js_CodeSpec[op].length);
-          END_CASE(JSOP_FORIN)
+          END_CASE(JSOP_ITER)
 
           BEGIN_CASE(JSOP_FORPROP)
             /*
              * Handle JSOP_FORPROP first, so the cost of the goto do_forinloop
              * is not paid for the more common cases.
              */
             LOAD_ATOM(0);
             id = ATOM_TO_JSID(atom);
@@ -3206,19 +3191,17 @@ js_Interpret(JSContext *cx)
             i = -1;
 
           do_forinloop:
             /*
              * Reach under the top of stack to find our property iterator, a
              * JSObject that contains the iteration state.
              */
             JS_ASSERT(!JSVAL_IS_PRIMITIVE(regs.sp[i]));
-            iterobj = JSVAL_TO_OBJECT(regs.sp[i]);
-
-            if (!js_CallIteratorNext(cx, iterobj, &rval))
+            if (!js_CallIteratorNext(cx, JSVAL_TO_OBJECT(regs.sp[i]), &rval))
                 goto error;
             if (rval == JSVAL_HOLE) {
                 rval = JSVAL_FALSE;
                 goto end_forinloop;
             }
 
             switch (op) {
               case JSOP_FORARG:
@@ -6796,17 +6779,16 @@ js_Interpret(JSContext *cx)
 
 # if !JS_HAS_GENERATORS
           L_JSOP_GENERATOR:
           L_JSOP_YIELD:
           L_JSOP_ARRAYPUSH:
 # endif
 
 # if !JS_HAS_DESTRUCTURING
-          L_JSOP_FOREACHKEYVAL:
           L_JSOP_ENUMCONSTELEM:
 # endif
 
 # if !JS_HAS_XML_SUPPORT
           L_JSOP_CALLXMLNAME:
           L_JSOP_STARTXMLEXPR:
           L_JSOP_STARTXML:
           L_JSOP_DELDESC:
@@ -6831,16 +6813,19 @@ js_Interpret(JSContext *cx)
           L_JSOP_TOATTRNAME:
           L_JSOP_QNAME:
           L_JSOP_QNAMECONST:
           L_JSOP_QNAMEPART:
           L_JSOP_ANYNAME:
           L_JSOP_DEFXMLNS:
 # endif
 
+          L_JSOP_UNUSED186:
+          L_JSOP_UNUSED213:
+
 #else /* !JS_THREADED_INTERP */
           default:
 #endif
           {
             char numBuf[12];
             JS_snprintf(numBuf, sizeof numBuf, "%d", op);
             JS_ReportErrorNumber(cx, js_GetErrorMessage, NULL,
                                  JSMSG_BAD_BYTECODE, numBuf);
diff --git a/js/src/jsiter.h b/js/src/jsiter.h
--- a/js/src/jsiter.h
+++ b/js/src/jsiter.h
@@ -43,16 +43,21 @@
 /*
  * JavaScript iterators.
  */
 #include "jsprvtd.h"
 #include "jspubtd.h"
 
 JS_BEGIN_EXTERN_C
 
+/*
+ * NB: these flag bits are encoded into the bytecode stream in the immediate
+ * operand of JSOP_ITER, so don't change them without advancing jsxdrapi.h's
+ * JSXDR_BYTECODE_VERSION.
+ */
 #define JSITER_ENUMERATE  0x1   /* for-in compatible hidden default iterator */
 #define JSITER_FOREACH    0x2   /* return [key, value] pair rather than key */
 #define JSITER_KEYVALUE   0x4   /* destructuring for-in wants [key, value] */
 
 /*
  * Convert the value stored in *vp to its iteration object. The flags should
  * contain JSITER_ENUMERATE if js_ValueToIterator is called when enumerating
  * for-in semantics are required, and when the caller can guarantee that the
diff --git a/js/src/jsobj.cpp b/js/src/jsobj.cpp
--- a/js/src/jsobj.cpp
+++ b/js/src/jsobj.cpp
@@ -1210,24 +1210,22 @@ obj_eval(JSContext *cx, JSObject *obj, u
     /*
      * If the caller is a lightweight function and doesn't have a variables
      * object, then we need to provide one for the compiler to stick any
      * declared (var) variables into.
      */
     if (caller && !caller->varobj && !js_GetCallObject(cx, caller, NULL))
         return JS_FALSE;
 
-    /*
-     * Script.prototype.compile/exec and Object.prototype.eval all take an
-     * optional trailing argument that overrides the scope object.
-     */
-    if (argc >= 2) {
-        if (!js_ValueToObject(cx, argv[1], &scopeobj))
-            return JS_FALSE;
-        argv[1] = OBJECT_TO_JSVAL(scopeobj);
+    /* eval no longer takes an optional trailing argument. */
+    if (argc >= 2 &&
+        !JS_ReportErrorFlagsAndNumber(cx, JSREPORT_WARNING | JSREPORT_STRICT,
+                                      js_GetErrorMessage, NULL,
+                                      JSMSG_EVAL_ARITY)) {
+        return JS_FALSE;
     }
 
     /* From here on, control must exit through label out with ok set. */
     js_DisablePropertyCache(cx);
 
     if (!scopeobj) {
 #if JS_HAS_EVAL_THIS_SCOPE
         /* If obj.eval(str), emulate 'with (obj) eval(str)' in the caller. */
@@ -1429,16 +1427,19 @@ obj_watch(JSContext *cx, uintN argc, jsv
         return JS_FALSE;
 
     obj = JS_THIS_OBJECT(cx, vp);
     if (!obj || !OBJ_CHECK_ACCESS(cx, obj, propid, JSACC_WATCH, &value, &attrs))
         return JS_FALSE;
     if (attrs & JSPROP_READONLY)
         return JS_TRUE;
     *vp = JSVAL_VOID;
+
+    if (OBJ_IS_DENSE_ARRAY(cx, obj) && !js_MakeArraySlow(cx, obj))
+        return JS_FALSE;
     return JS_SetWatchPoint(cx, obj, userid, obj_watch_handler, callable);
 }
 
 static JSBool
 obj_unwatch(JSContext *cx, uintN argc, jsval *vp)
 {
     JSObject *obj;
 
@@ -1946,20 +1947,16 @@ js_CloneBlockObject(JSContext *cx, JSObj
         return NULL;
     STOBJ_SET_SLOT(clone, JSSLOT_PRIVATE, PRIVATE_TO_JSVAL(fp));
     STOBJ_SET_SLOT(clone, JSSLOT_BLOCK_DEPTH,
                    OBJ_GET_SLOT(cx, proto, JSSLOT_BLOCK_DEPTH));
     JS_ASSERT(OBJ_IS_CLONED_BLOCK(clone));
     return clone;
 }
 
-static JSBool
-js_ReallocSlots(JSContext *cx, JSObject *obj, uint32 nslots,
-                JSBool exactAllocation);
-
 JSBool
 js_PutBlockObject(JSContext *cx, JSBool normalUnwind)
 {
     JSStackFrame *fp;
     JSObject *obj;
     uintN depth, count;
 
     /* Blocks have one fixed slot available for the first local.*/
@@ -2299,17 +2296,17 @@ FreeSlots(JSContext *cx, JSObject *obj)
 }
 
 #define SLOTS_TO_DYNAMIC_WORDS(nslots)                                        \
   (JS_ASSERT((nslots) > JS_INITIAL_NSLOTS), (nslots) + 1 - JS_INITIAL_NSLOTS)
 
 #define DYNAMIC_WORDS_TO_SLOTS(words)                                         \
   (JS_ASSERT((words) > 1), (words) - 1 + JS_INITIAL_NSLOTS)
 
-static JSBool
+JSBool
 js_ReallocSlots(JSContext *cx, JSObject *obj, uint32 nslots,
                 JSBool exactAllocation)
 {
     jsval *old, *slots;
     uint32 oslots, nwords, owords, log, i;
 
     /*
      * Minimal number of dynamic slots to allocate.
@@ -4150,24 +4147,16 @@ js_SetIdArrayLength(JSContext *cx, JSIdA
            JS_realloc(cx, ida, sizeof(JSIdArray) + (length-1) * sizeof(jsval));
     if (!rida)
         JS_DestroyIdArray(cx, ida);
     else
         rida->length = length;
     return rida;
 }
 
-/* Private type used to iterate over all properties of a native JS object */
-struct JSNativeIteratorState {
-    jsint                   next_index; /* index into jsid array */
-    JSIdArray               *ida;       /* all property ids in enumeration */
-    JSNativeIteratorState   *next;      /* double-linked list support */
-    JSNativeIteratorState   **prevp;
-};
-
 /*
  * This function is used to enumerate the properties of native JSObjects
  * and those host objects that do not define a JSNewEnumerateOp-style iterator
  * function.
  */
 JSBool
 js_Enumerate(JSContext *cx, JSObject *obj, JSIterateOp enum_op,
              jsval *statep, jsid *idp)
@@ -4175,17 +4164,17 @@ js_Enumerate(JSContext *cx, JSObject *ob
     JSRuntime *rt;
     JSObject *proto;
     JSClass *clasp;
     JSEnumerateOp enumerate;
     JSScopeProperty *sprop, *lastProp;
     jsint i, length;
     JSScope *scope;
     JSIdArray *ida;
-    JSNativeIteratorState *state;
+    JSNativeEnumerator *state;
 
     rt = cx->runtime;
     clasp = OBJ_GET_CLASS(cx, obj);
     enumerate = clasp->enumerate;
     if (clasp->flags & JSCLASS_NEW_ENUMERATE) {
         JS_ASSERT(enumerate != JS_EnumerateStub);
         return ((JSNewEnumerateOp) enumerate)(cx, obj, enum_op, statep, idp);
     }
@@ -4240,53 +4229,52 @@ js_Enumerate(JSContext *cx, JSObject *ob
                      SCOPE_HAS_PROPERTY(scope, sprop))) {
                     JS_ASSERT(i > 0);
                     ida->vector[--i] = sprop->id;
                 }
             }
         }
         JS_UNLOCK_OBJ(cx, obj);
 
-        state = (JSNativeIteratorState *)
-            JS_malloc(cx, sizeof(JSNativeIteratorState));
+        state = (JSNativeEnumerator *)JS_malloc(cx, sizeof(JSNativeEnumerator));
         if (!state) {
             JS_DestroyIdArray(cx, ida);
             return JS_FALSE;
         }
         state->ida = ida;
         state->next_index = 0;
 
         JS_LOCK_RUNTIME(rt);
-        state->next = rt->nativeIteratorStates;
+        state->next = rt->nativeEnumerators;
         if (state->next)
             state->next->prevp = &state->next;
-        state->prevp = &rt->nativeIteratorStates;
+        state->prevp = &rt->nativeEnumerators;
         *state->prevp = state;
         JS_UNLOCK_RUNTIME(rt);
 
         *statep = PRIVATE_TO_JSVAL(state);
         if (idp)
             *idp = INT_TO_JSVAL(length);
         break;
 
       case JSENUMERATE_NEXT:
-        state = (JSNativeIteratorState *) JSVAL_TO_PRIVATE(*statep);
+        state = (JSNativeEnumerator *) JSVAL_TO_PRIVATE(*statep);
         ida = state->ida;
         length = ida->length;
         if (state->next_index != length) {
             *idp = ida->vector[state->next_index++];
             break;
         }
         /* FALL THROUGH */
 
       case JSENUMERATE_DESTROY:
-        state = (JSNativeIteratorState *) JSVAL_TO_PRIVATE(*statep);
+        state = (JSNativeEnumerator *) JSVAL_TO_PRIVATE(*statep);
 
         JS_LOCK_RUNTIME(rt);
-        JS_ASSERT(rt->nativeIteratorStates);
+        JS_ASSERT(rt->nativeEnumerators);
         JS_ASSERT(*state->prevp == state);
         if (state->next) {
             JS_ASSERT(state->next->prevp == &state->next);
             state->next->prevp = state->prevp;
         }
         *state->prevp = state->next;
         JS_UNLOCK_RUNTIME(rt);
 
@@ -4294,22 +4282,22 @@ js_Enumerate(JSContext *cx, JSObject *ob
         JS_free(cx, state);
         *statep = JSVAL_NULL;
         break;
     }
     return JS_TRUE;
 }
 
 void
-js_TraceNativeIteratorStates(JSTracer *trc)
-{
-    JSNativeIteratorState *state;
+js_TraceNativeEnumerators(JSTracer *trc)
+{
+    JSNativeEnumerator *state;
     jsid *cursor, *end, id;
 
-    state = trc->context->runtime->nativeIteratorStates;
+    state = trc->context->runtime->nativeEnumerators;
     if (!state)
         return;
 
     do {
         JS_ASSERT(*state->prevp == state);
         cursor = state->ida->vector;
         end = cursor + state->ida->length;
         for (; cursor != end; ++cursor) {
diff --git a/js/src/jsobj.h b/js/src/jsobj.h
--- a/js/src/jsobj.h
+++ b/js/src/jsobj.h
@@ -616,17 +616,17 @@ extern JSIdArray *
 extern JSIdArray *
 js_SetIdArrayLength(JSContext *cx, JSIdArray *ida, jsint length);
 
 extern JSBool
 js_Enumerate(JSContext *cx, JSObject *obj, JSIterateOp enum_op,
              jsval *statep, jsid *idp);
 
 extern void
-js_TraceNativeIteratorStates(JSTracer *trc);
+js_TraceNativeEnumerators(JSTracer *trc);
 
 extern JSBool
 js_CheckAccess(JSContext *cx, JSObject *obj, jsid id, JSAccessMode mode,
                jsval *vp, uintN *attrsp);
 
 extern JSBool
 js_Call(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval);
 
@@ -684,16 +684,23 @@ js_Clear(JSContext *cx, JSObject *obj);
 js_Clear(JSContext *cx, JSObject *obj);
 
 extern jsval
 js_GetRequiredSlot(JSContext *cx, JSObject *obj, uint32 slot);
 
 extern JSBool
 js_SetRequiredSlot(JSContext *cx, JSObject *obj, uint32 slot, jsval v);
 
+/*
+ * obj must be locked.
+ */
+extern JSBool
+js_ReallocSlots(JSContext *cx, JSObject *obj, uint32 nslots,
+                JSBool exactAllocation);
+
 extern JSObject *
 js_CheckScopeChainValidity(JSContext *cx, JSObject *scopeobj, const char *caller);
 
 extern JSBool
 js_CheckPrincipalsAccess(JSContext *cx, JSObject *scopeobj,
                          JSPrincipals *principals, JSAtom *caller);
 
 /* Infallible -- returns its argument if there is no wrapped object. */
diff --git a/js/src/jsopcode.cpp b/js/src/jsopcode.cpp
--- a/js/src/jsopcode.cpp
+++ b/js/src/jsopcode.cpp
@@ -57,17 +57,17 @@
 #include "jsapi.h"
 #include "jsarray.h"
 #include "jsatom.h"
 #include "jscntxt.h"
 #include "jsconfig.h"
 #include "jsdbgapi.h"
 #include "jsemit.h"
 #include "jsfun.h"
-#include "jslock.h"
+#include "jsiter.h"
 #include "jsobj.h"
 #include "jsopcode.h"
 #include "jsregexp.h"
 #include "jsscan.h"
 #include "jsscope.h"
 #include "jsscript.h"
 #include "jsstr.h"
 
@@ -1980,41 +1980,52 @@ Decompile(SprintStack *ss, jsbytecode *p
                   do_forloop:
                     /* Skip the JSOP_NOP or JSOP_POP bytecode. */
                     pc++;
 
                     /* Get the cond, next, and loop-closing tail offsets. */
                     cond = js_GetSrcNoteOffset(sn, 0);
                     next = js_GetSrcNoteOffset(sn, 1);
                     tail = js_GetSrcNoteOffset(sn, 2);
-                    LOCAL_ASSERT(tail + GetJumpOffset(pc+tail, pc+tail) == 0);
+
+                    /*
+                     * If this loop has a condition, then pc points at a goto
+                     * targeting the condition.
+                     */
+                    if (cond != tail) {
+                        LOCAL_ASSERT(*pc == JSOP_GOTO || *pc == JSOP_GOTOX);
+                        pc += (*pc == JSOP_GOTO)
+                              ? JSOP_GOTO_LENGTH
+                              : JSOP_GOTOX_LENGTH;
+                    }
+                    LOCAL_ASSERT(tail == -GetJumpOffset(pc+tail, pc+tail));
 
                     /* Print the keyword and the possibly empty init-part. */
                     js_printf(jp, "\tfor (%s;", rval);
 
-                    if (pc[cond] == JSOP_IFEQ || pc[cond] == JSOP_IFEQX) {
+                    if (cond != tail) {
                         /* Decompile the loop condition. */
-                        DECOMPILE_CODE(pc, cond);
+                        DECOMPILE_CODE(pc + cond, tail - cond);
                         js_printf(jp, " %s", POP_STR());
                     }
 
                     /* Need a semicolon whether or not there was a cond. */
                     js_puts(jp, ";");
 
-                    if (pc[next] != JSOP_GOTO && pc[next] != JSOP_GOTOX) {
+                    if (next != cond) {
                         /* Decompile the loop updater. */
-                        DECOMPILE_CODE(pc + next, tail - next - 1);
+                        DECOMPILE_CODE(pc + next,
+                                       cond - next - JSOP_POP_LENGTH);
                         js_printf(jp, " %s", POP_STR());
                     }
 
                     /* Do the loop body. */
                     js_printf(jp, ") {\n");
                     jp->indent += 4;
-                    oplen = (cond) ? js_CodeSpec[pc[cond]].length : 0;
-                    DECOMPILE_CODE(pc + cond + oplen, next - cond - oplen);
+                    DECOMPILE_CODE(pc, next);
                     jp->indent -= 4;
                     js_printf(jp, "\t}\n");
 
                     /* Set len so pc skips over the entire loop. */
                     len = tail + js_CodeSpec[pc[tail]].length;
                     break;
 
                   case SRC_LABEL:
@@ -3829,42 +3840,44 @@ Decompile(SprintStack *ss, jsbytecode *p
                     len = JSOP_CALL_LENGTH;
 
                     /*
                      * Arrange to parenthesize this genexp unless:
                      *
                      *  1. It is the complete expression consumed by a control
                      *     flow bytecode such as JSOP_TABLESWITCH whose syntax
                      *     always parenthesizes the controlling expression.
-                     *  2. It is the sole argument to a function call.
-                     *  3. It is the condition of an if statement and not of a
+                     *  2. It is the condition of a loop other than a for (;;).
+                     *  3. It is the sole argument to a function call.
+                     *  4. It is the condition of an if statement and not of a
                      *     ?: expression.
                      *
                      * But (first, before anything else) always parenthesize
                      * if this genexp runs up against endpc and the next op is
-                     * not a while or do-while loop JSOP_IFNE* opcode. In such
-                     * cases, this Decompile activation has been recursively
-                     * called by a comma operator, &&, or || bytecode.
-                     */
-                    LOCAL_ASSERT(pc + len < endpc ||
+                     * not a loop condition (JSOP_IFNE*) opcode. In such cases,
+                     * this Decompile activation has been recursively called by
+                     * a comma operator, &&, or || bytecode.
+                     */
+                    pc2 = pc + len;
+                    LOCAL_ASSERT(pc2 < endpc ||
                                  endpc < outer->code + outer->length);
                     LOCAL_ASSERT(ss2.top == 1);
                     ss2.opcodes[0] = JSOP_POP;
-                    if (pc + len == endpc &&
-                        ((JSOp) *endpc != JSOP_IFNE &&
-                         (JSOp) *endpc != JSOP_IFNEX)) {
+                    if (pc2 == endpc &&
+                        (JSOp) *endpc != JSOP_IFNE &&
+                        (JSOp) *endpc != JSOP_IFNEX) {
                         op = JSOP_SETNAME;
                     } else {
-                        op = (JSOp) pc[len];
+                        op = (JSOp) *pc2;
                         op = ((js_CodeSpec[op].format & JOF_PARENHEAD) ||
                               ((js_CodeSpec[op].format & JOF_INVOKE) &&
-                               GET_ARGC(pc + len) == 1) ||
-                              (((op == JSOP_IFEQ || op == JSOP_IFEQX) &&
-                               (sn2 = js_GetSrcNote(outer, pc + len)) &&
-                               SN_TYPE(sn2) != SRC_COND)))
+                               GET_ARGC(pc2) == 1) ||
+                              ((op == JSOP_IFEQ || op == JSOP_IFEQX) &&
+                               (sn2 = js_GetSrcNote(outer, pc2)) &&
+                               SN_TYPE(sn2) != SRC_COND))
                              ? JSOP_POP
                              : JSOP_SETNAME;
 
                         /*
                          * Stack this result as if it's a name and not an
                          * anonymous function, so it doesn't get decompiled as
                          * a generator function in a getter or setter context.
                          * The precedence level is the same for JSOP_NAME and
@@ -4510,18 +4523,19 @@ Decompile(SprintStack *ss, jsbytecode *p
                 break;
 
               case JSOP_TOXMLLIST:
                 op = JSOP_NOP;           /* turn off parens */
                 todo = Sprint(&ss->sprinter, "<>%s</>", POP_STR());
                 inXML = JS_FALSE;
                 break;
 
-              case JSOP_FOREACH:
-                foreach = JS_TRUE;
+              case JSOP_ITER:
+                foreach = (pc[1] & (JSITER_FOREACH | JSITER_KEYVALUE)) ==
+                          JSITER_FOREACH;
                 todo = -2;
                 break;
 
               case JSOP_TOXML:
               case JSOP_CALLXMLNAME:
               case JSOP_XMLNAME:
               case JSOP_FILTER:
                 /* These ops indicate the end of XML expressions. */
diff --git a/js/src/jsopcode.tbl b/js/src/jsopcode.tbl
--- a/js/src/jsopcode.tbl
+++ b/js/src/jsopcode.tbl
@@ -229,19 +229,20 @@ OPDEF(JSOP_DECARG,    97, "decarg",     
 OPDEF(JSOP_DECARG,    97, "decarg",     NULL,         3,  0,  1, 15,  JOF_QARG |JOF_NAME|JOF_DEC)
 OPDEF(JSOP_DECVAR,    98, "decvar",     NULL,         3,  0,  1, 15,  JOF_QVAR |JOF_NAME|JOF_DEC)
 OPDEF(JSOP_ARGINC,    99, "arginc",     NULL,         3,  0,  1, 15,  JOF_QARG |JOF_NAME|JOF_INC|JOF_POST)
 OPDEF(JSOP_VARINC,    100,"varinc",     NULL,         3,  0,  1, 15,  JOF_QVAR |JOF_NAME|JOF_INC|JOF_POST)
 OPDEF(JSOP_ARGDEC,    101,"argdec",     NULL,         3,  0,  1, 15,  JOF_QARG |JOF_NAME|JOF_DEC|JOF_POST)
 OPDEF(JSOP_VARDEC,    102,"vardec",     NULL,         3,  0,  1, 15,  JOF_QVAR |JOF_NAME|JOF_DEC|JOF_POST)
 
 /*
- * Initialize for-in iterator. See also JSOP_FOREACH and JSOP_FOREACHKEYVAL.
+ * Initialize for-in iterator using the JSITER_* flag bits in this op's uint8
+ * immediate operand. See also JSOP_ENDITER.
  */
-OPDEF(JSOP_FORIN,     103,"forin",      NULL,         1,  1,  1,  0,  JOF_BYTE)
+OPDEF(JSOP_ITER,      103,"iter",       NULL,         2,  1,  1,  0,  JOF_2BYTE)
 
 /* ECMA-compliant for/in ops. */
 OPDEF(JSOP_FORNAME,   104,"forname",    NULL,         3,  0,  1, 19,  JOF_ATOM|JOF_NAME|JOF_FOR)
 OPDEF(JSOP_FORPROP,   105,"forprop",    NULL,         3,  1,  1, 18,  JOF_ATOM|JOF_PROP|JOF_FOR)
 OPDEF(JSOP_FORELEM,   106,"forelem",    NULL,         1,  1,  3, 18,  JOF_BYTE |JOF_ELEM|JOF_FOR)
 OPDEF(JSOP_POPN,      107,"popn",       NULL,         3, -1,  0,  0,  JOF_UINT16)
 
 /* ECMA-compliant assignment ops. */
@@ -405,17 +406,17 @@ OPDEF(JSOP_XMLTAGEXPR,    178,"xmltagexp
 OPDEF(JSOP_XMLTAGEXPR,    178,"xmltagexpr", NULL,     1,  1,  1,  0,  JOF_BYTE)
 OPDEF(JSOP_XMLELTEXPR,    179,"xmleltexpr", NULL,     1,  1,  1,  0,  JOF_BYTE)
 OPDEF(JSOP_XMLOBJECT,     180,"xmlobject",  NULL,     3,  0,  1, 19,  JOF_OBJECT)
 OPDEF(JSOP_XMLCDATA,      181,"xmlcdata",   NULL,     3,  0,  1, 19,  JOF_ATOM)
 OPDEF(JSOP_XMLCOMMENT,    182,"xmlcomment", NULL,     3,  0,  1, 19,  JOF_ATOM)
 OPDEF(JSOP_XMLPI,         183,"xmlpi",      NULL,     3,  1,  1, 19,  JOF_ATOM)
 OPDEF(JSOP_CALLPROP,      184,"callprop",   NULL,     3,  1,  2, 18,  JOF_ATOM|JOF_PROP|JOF_CALLOP)
 OPDEF(JSOP_GETFUNNS,      185,"getfunns",   NULL,     1,  0,  1, 19,  JOF_BYTE)
-OPDEF(JSOP_FOREACH,       186,"foreach",    NULL,     1,  1,  1,  0,  JOF_BYTE)
+OPDEF(JSOP_UNUSED186,     186,"unused186",  NULL,     1,  0,  0,  0,  JOF_BYTE)
 OPDEF(JSOP_DELDESC,       187,"deldesc",    NULL,     1,  2,  1, 17,  JOF_BYTE |JOF_ELEM|JOF_DEL)
 
 /*
  * Opcode to hold 24-bit immediate integer operands.
  */
 OPDEF(JSOP_UINT24,        188,"uint24",     NULL,     4,  0,  1, 16,  JOF_UINT24)
 
 /*
@@ -472,17 +473,17 @@ OPDEF(JSOP_FORLOCAL,      207,"forlocal"
  * Iterator, generator, and array comprehension support.
  */
 OPDEF(JSOP_FORCONST,      208,"forconst",    NULL,    3,  0,  1, 19,  JOF_QVAR|JOF_NAME|JOF_FOR)
 OPDEF(JSOP_ENDITER,       209,"enditer",     NULL,    1,  1,  0,  0,  JOF_BYTE|JOF_TMPSLOT)
 OPDEF(JSOP_GENERATOR,     210,"generator",   NULL,    1,  0,  0,  0,  JOF_BYTE)
 OPDEF(JSOP_YIELD,         211,"yield",       NULL,    1,  1,  1,  1,  JOF_BYTE)
 OPDEF(JSOP_ARRAYPUSH,     212,"arraypush",   NULL,    3,  1,  0,  3,  JOF_LOCAL)
 
-OPDEF(JSOP_FOREACHKEYVAL, 213,"foreachkeyval",NULL,   1,  1,  1,  0,  JOF_BYTE)
+OPDEF(JSOP_UNUSED213,     213,"unused213",   NULL,    1,  0,  0,  0,  JOF_BYTE)
 
 /*
  * Variant of JSOP_ENUMELEM for destructuring const (const [a, b] = ...).
  */
 OPDEF(JSOP_ENUMCONSTELEM, 214,"enumconstelem",NULL,   1,  3,  0,  3,  JOF_BYTE|JOF_SET)
 
 /*
  * Variant of JSOP_LEAVEBLOCK has a result on the stack above the locals,
diff --git a/js/src/jsparse.cpp b/js/src/jsparse.cpp
--- a/js/src/jsparse.cpp
+++ b/js/src/jsparse.cpp
@@ -61,16 +61,17 @@
 #include "jsapi.h"
 #include "jsarray.h"
 #include "jsatom.h"
 #include "jscntxt.h"
 #include "jsconfig.h"
 #include "jsemit.h"
 #include "jsfun.h"
 #include "jsinterp.h"
+#include "jsiter.h"
 #include "jslock.h"
 #include "jsnum.h"
 #include "jsobj.h"
 #include "jsopcode.h"
 #include "jsparse.h"
 #include "jsscan.h"
 #include "jsscope.h"
 #include "jsscript.h"
@@ -2669,30 +2670,31 @@ Statement(JSContext *cx, JSTokenStream *
 #endif
 
         /* A FOR node is binary, left is loop control and right is the body. */
         pn = NewParseNode(cx, ts, PN_BINARY, tc);
         if (!pn)
             return NULL;
         js_PushStatement(tc, &stmtInfo, STMT_FOR_LOOP, -1);
 
-        pn->pn_op = JSOP_FORIN;
+        pn->pn_op = JSOP_ITER;
+        pn->pn_iflags = 0;
         if (js_MatchToken(cx, ts, TOK_NAME)) {
             if (CURRENT_TOKEN(ts).t_atom == cx->runtime->atomState.eachAtom)
-                pn->pn_op = JSOP_FOREACH;
+                pn->pn_iflags = JSITER_FOREACH;
             else
                 js_UngetToken(ts);
         }
 
         MUST_MATCH_TOKEN(TOK_LP, JSMSG_PAREN_AFTER_FOR);
         ts->flags |= TSF_OPERAND;
         tt = js_PeekToken(cx, ts);
         ts->flags &= ~TSF_OPERAND;
         if (tt == TOK_SEMI) {
-            if (pn->pn_op == JSOP_FOREACH)
+            if (pn->pn_iflags & JSITER_FOREACH)
                 goto bad_for_each;
 
             /* No initializer -- set first kid of left sub-node to null. */
             pn1 = NULL;
         } else {
             /*
              * Set pn1 to a var list or an initializing expression.
              *
@@ -2738,38 +2740,41 @@ Statement(JSContext *cx, JSTokenStream *
 
         /*
          * We can be sure that it's a for/in loop if there's still an 'in'
          * keyword here, even if JavaScript recognizes 'in' as an operator,
          * as we've excluded 'in' from being parsed in RelExpr by setting
          * the TCF_IN_FOR_INIT flag in our JSTreeContext.
          */
         if (pn1 && js_MatchToken(cx, ts, TOK_IN)) {
+            pn->pn_iflags |= JSITER_ENUMERATE;
             stmtInfo.type = STMT_FOR_IN_LOOP;
 
             /* Check that the left side of the 'in' is valid. */
             JS_ASSERT(!TOKEN_TYPE_IS_DECL(tt) || pn1->pn_type == tt);
             if (TOKEN_TYPE_IS_DECL(tt)
                 ? (pn1->pn_count > 1 || pn1->pn_op == JSOP_DEFCONST
 #if JS_HAS_DESTRUCTURING
                    || (JSVERSION_NUMBER(cx) == JSVERSION_1_7 &&
-                       pn->pn_op == JSOP_FORIN &&
+                       pn->pn_op == JSOP_ITER &&
+                       !(pn->pn_iflags & JSITER_FOREACH) &&
                        (pn1->pn_head->pn_type == TOK_RC ||
                         (pn1->pn_head->pn_type == TOK_RB &&
                          pn1->pn_head->pn_count != 2) ||
                         (pn1->pn_head->pn_type == TOK_ASSIGN &&
                          (pn1->pn_head->pn_left->pn_type != TOK_RB ||
                           pn1->pn_head->pn_left->pn_count != 2))))
 #endif
                   )
                 : (pn1->pn_type != TOK_NAME &&
                    pn1->pn_type != TOK_DOT &&
 #if JS_HAS_DESTRUCTURING
                    ((JSVERSION_NUMBER(cx) == JSVERSION_1_7 &&
-                     pn->pn_op == JSOP_FORIN)
+                     pn->pn_op == JSOP_ITER &&
+                     !(pn->pn_iflags & JSITER_FOREACH))
                     ? (pn1->pn_type != TOK_RB || pn1->pn_count != 2)
                     : (pn1->pn_type != TOK_RB && pn1->pn_type != TOK_RC)) &&
 #endif
 #if JS_HAS_LVALUE_RETURN
                    pn1->pn_type != TOK_LP &&
 #endif
 #if JS_HAS_XML_SUPPORT
                    (pn1->pn_type != TOK_UNARYOP ||
@@ -2825,46 +2830,63 @@ Statement(JSContext *cx, JSTokenStream *
                 if (pn1 == pn2 && !CheckDestructuring(cx, NULL, pn2, NULL, tc))
                     return NULL;
 
                 if (JSVERSION_NUMBER(cx) == JSVERSION_1_7) {
                     /*
                      * Destructuring for-in requires [key, value] enumeration
                      * in JS1.7.
                      */
-                    if (pn->pn_op != JSOP_FOREACH)
-                        pn->pn_op = JSOP_FOREACHKEYVAL;
+                    JS_ASSERT(pn->pn_op == JSOP_ITER);
+                    if (!(pn->pn_iflags & JSITER_FOREACH))
+                        pn->pn_iflags |= JSITER_FOREACH | JSITER_KEYVALUE;
                 }
                 break;
 #endif
 
               default:;
             }
 
             /* Parse the object expression as the right operand of 'in'. */
             pn2 = NewBinary(cx, TOK_IN, JSOP_NOP, pn1, Expr(cx, ts, tc), tc);
             if (!pn2)
                 return NULL;
             pn->pn_left = pn2;
         } else {
-            if (pn->pn_op == JSOP_FOREACH)
+            if (pn->pn_iflags & JSITER_FOREACH)
                 goto bad_for_each;
             pn->pn_op = JSOP_NOP;
 
             /* Parse the loop condition or null into pn2. */
             MUST_MATCH_TOKEN(TOK_SEMI, JSMSG_SEMI_AFTER_FOR_INIT);
             ts->flags |= TSF_OPERAND;
             tt = js_PeekToken(cx, ts);
             ts->flags &= ~TSF_OPERAND;
             if (tt == TOK_SEMI) {
                 pn2 = NULL;
             } else {
                 pn2 = Expr(cx, ts, tc);
                 if (!pn2)
                     return NULL;
+
+                if (pn2->pn_type == TOK_LP &&
+                    pn2->pn_head->pn_type == TOK_FUNCTION &&
+                    (pn2->pn_head->pn_flags & TCF_GENEXP_LAMBDA)) {
+                    /*
+                     * A generator expression as loop condition is useless.
+                     * It won't be called, and as an object it evaluates to
+                     * true in boolean contexts without any conversion hook
+                     * being called.
+                     *
+                     * This useless condition elimination is mandatory, to
+                     * help the decompiler. See bug 442342.
+                     */
+                    RecycleTree(pn2, tc);
+                    pn2 = NULL;
+                }
             }
 
             /* Parse the update expression or null into pn3. */
             MUST_MATCH_TOKEN(TOK_SEMI, JSMSG_SEMI_AFTER_FOR_COND);
             ts->flags |= TSF_OPERAND;
             tt = js_PeekToken(cx, ts);
             ts->flags &= ~TSF_OPERAND;
             if (tt == TOK_RP) {
@@ -4164,20 +4186,21 @@ ComprehensionTail(JSContext *cx, JSToken
          * FOR node is binary, left is loop control and right is body.  Use
          * index to count each block-local let-variable on the left-hand side
          * of the IN.
          */
         pn2 = NewParseNode(cx, ts, PN_BINARY, tc);
         if (!pn2)
             return NULL;
 
-        pn2->pn_op = JSOP_FORIN;
+        pn2->pn_op = JSOP_ITER;
+        pn2->pn_iflags = JSITER_ENUMERATE;
         if (js_MatchToken(cx, ts, TOK_NAME)) {
             if (CURRENT_TOKEN(ts).t_atom == rt->atomState.eachAtom)
-                pn2->pn_op = JSOP_FOREACH;
+                pn2->pn_iflags |= JSITER_FOREACH;
             else
                 js_UngetToken(ts);
         }
         MUST_MATCH_TOKEN(TOK_LP, JSMSG_PAREN_AFTER_FOR);
 
         tt = js_GetToken(cx, ts);
         switch (tt) {
 #if JS_HAS_DESTRUCTURING
@@ -4190,18 +4213,20 @@ ComprehensionTail(JSContext *cx, JSToken
             if (pn3->pn_type != TOK_RB || pn3->pn_count != 2) {
                 js_ReportCompileErrorNumber(cx, ts, NULL, JSREPORT_ERROR,
                                             JSMSG_BAD_FOR_LEFTSIDE);
                 return NULL;
             }
 
             if (JSVERSION_NUMBER(cx) == JSVERSION_1_7) {
                 /* Destructuring requires [key, value] enumeration in JS1.7. */
-                if (pn2->pn_op != JSOP_FOREACH)
-                    pn2->pn_op = JSOP_FOREACHKEYVAL;
+                JS_ASSERT(pn2->pn_op == JSOP_ITER);
+                JS_ASSERT(pn2->pn_iflags & JSITER_ENUMERATE);
+                if (!(pn2->pn_iflags & JSITER_FOREACH))
+                    pn2->pn_iflags |= JSITER_FOREACH | JSITER_KEYVALUE;
             }
             break;
 #endif
 
           case TOK_NAME:
             atom = CURRENT_TOKEN(ts).t_atom;
             if (!data.binder(cx, &data, atom, tc))
                 return NULL;
diff --git a/js/src/jsparse.h b/js/src/jsparse.h
--- a/js/src/jsparse.h
+++ b/js/src/jsparse.h
@@ -297,16 +297,17 @@ struct JSParseNode {
             JSParseNode *kid1;          /* condition, discriminant, etc. */
             JSParseNode *kid2;          /* then-part, case list, etc. */
             JSParseNode *kid3;          /* else-part, default case, etc. */
         } ternary;
         struct {                        /* two kids if binary */
             JSParseNode *left;
             JSParseNode *right;
             jsval       val;            /* switch case value */
+            uintN       iflags;         /* JSITER_* flags for TOK_FOR node */
         } binary;
         struct {                        /* one kid if unary */
             JSParseNode *kid;
             jsint       num;            /* -1 or sharp variable number */
             JSBool      hidden;         /* hidden genexp-induced JSOP_YIELD */
         } unary;
         struct {                        /* name, labeled statement, etc. */
             JSAtom      *atom;          /* name or label atom, null if slot */
@@ -341,16 +342,17 @@ struct JSParseNode {
 #define pn_count        pn_u.list.count
 #define pn_extra        pn_u.list.extra
 #define pn_kid1         pn_u.ternary.kid1
 #define pn_kid2         pn_u.ternary.kid2
 #define pn_kid3         pn_u.ternary.kid3
 #define pn_left         pn_u.binary.left
 #define pn_right        pn_u.binary.right
 #define pn_val          pn_u.binary.val
+#define pn_iflags       pn_u.binary.iflags
 #define pn_kid          pn_u.unary.kid
 #define pn_num          pn_u.unary.num
 #define pn_hidden       pn_u.unary.hidden
 #define pn_atom         pn_u.name.atom
 #define pn_expr         pn_u.name.expr
 #define pn_slot         pn_u.name.slot
 #define pn_const        pn_u.name.isconst
 #define pn_dval         pn_u.dval
diff --git a/js/src/jsprvtd.h b/js/src/jsprvtd.h
--- a/js/src/jsprvtd.h
+++ b/js/src/jsprvtd.h
@@ -87,16 +87,17 @@ typedef uint8  jssrcnote;
 typedef uint8  jssrcnote;
 typedef uint32 jsatomid;
 
 /* Struct typedefs. */
 typedef struct JSArgumentFormatMap  JSArgumentFormatMap;
 typedef struct JSCodeGenerator      JSCodeGenerator;
 typedef struct JSGCThing            JSGCThing;
 typedef struct JSGenerator          JSGenerator;
+typedef struct JSNativeEnumerator   JSNativeEnumerator;
 typedef struct JSParseContext       JSParseContext;
 typedef struct JSParsedObjectBox    JSParsedObjectBox;
 typedef struct JSParseNode          JSParseNode;
 typedef struct JSPropCacheEntry     JSPropCacheEntry;
 typedef struct JSSharpObjectMap     JSSharpObjectMap;
 typedef struct JSTempValueRooter    JSTempValueRooter;
 typedef struct JSThread             JSThread;
 typedef struct JSToken              JSToken;
diff --git a/js/src/jsxdrapi.h b/js/src/jsxdrapi.h
--- a/js/src/jsxdrapi.h
+++ b/js/src/jsxdrapi.h
@@ -197,17 +197,17 @@ JS_XDRFindClassById(JSXDRState *xdr, uin
  * Bytecode version number. Increment the subtrahend whenever JS bytecode
  * changes incompatibly.
  *
  * This version number should be XDR'ed once near the front of any file or
  * larger storage unit containing XDR'ed bytecode and other data, and checked
  * before deserialization of bytecode.  If the saved version does not match
  * the current version, abort deserialization and invalidate the file.
  */
-#define JSXDR_BYTECODE_VERSION      (0xb973c0de - 26)
+#define JSXDR_BYTECODE_VERSION      (0xb973c0de - 27)
 
 /*
  * Library-private functions.
  */
 extern JSBool
 js_XDRAtom(JSXDRState *xdr, JSAtom **atomp);
 
 extern JSBool
diff --git a/js/tests/Makefile b/js/tests/Makefile
--- a/js/tests/Makefile
+++ b/js/tests/Makefile
@@ -18,18 +18,18 @@ spidermonkey-extensions-n.tests: $(TEST_
 
 menu-list.txt:
 	echo "http://$(TEST_HTTP)/tests/mozilla.org/$(JSDIR)/menu.html" > menu-list.txt
 
 confidential-failures.txt:
 	touch confidential-failures.txt
 
 public-failures.txt.expanded: public-failures.txt universe.data
-	pattern-expander.pl public-failures.txt > public-failures.txt.expanded
+	./pattern-expander.pl public-failures.txt > public-failures.txt.expanded
 
 confidential-failures.txt.expanded: confidential-failures.txt universe.data
-	pattern-expander.pl confidential-failures.txt > confidential-failures.txt.expanded
+	./pattern-expander.pl confidential-failures.txt > confidential-failures.txt.expanded
 
 failures.txt: public-failures.txt.expanded confidential-failures.txt.expanded
 	sort -u public-failures.txt.expanded confidential-failures.txt.expanded > failures.txt
 
 clean:
 	rm -f menubody.html menu.html menu-list.txt failures.txt *failures.txt.expanded excluded-*.tests included-*.tests urllist*.html urllist*.tests
diff --git a/js/tests/js1_5/GC/regress-418128.js b/js/tests/js1_5/GC/regress-418128.js
new file mode 100755
--- /dev/null
+++ b/js/tests/js1_5/GC/regress-418128.js
@@ -0,0 +1,73 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2007
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Igor Bukanov
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-418128.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 418128;
+var summary = 'GC hazard with ++/--';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  var obj = {};
+  var id = { toString: function() { return ""+Math.pow(2, 0.1); } }
+  obj[id] = { valueOf: unrooter };
+  print(obj[id]++);
+  gc();
+  print(uneval(obj));
+
+  function unrooter()
+  {
+    delete obj[id];
+    gc();
+    return 10;
+  }
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff --git a/js/tests/js1_5/extensions/regress-356378.js b/js/tests/js1_5/extensions/regress-356378.js
new file mode 100755
--- /dev/null
+++ b/js/tests/js1_5/extensions/regress-356378.js
@@ -0,0 +1,69 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2007
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-356378.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 356378;
+var summary = 'var x; x getter= function () { };';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  expect = 'SyntaxError: invalid getter usage';
+  try
+  {
+    eval('(function() { var x; x getter= function () { }; })();');
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+  }
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff --git a/js/tests/js1_5/extensions/regress-422592.js b/js/tests/js1_5/extensions/regress-422592.js
new file mode 100755
--- /dev/null
+++ b/js/tests/js1_5/extensions/regress-422592.js
@@ -0,0 +1,103 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2007
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): timeless
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-422592.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 422592;
+var summary = 'js.c dis/dissrc should not kill script execution';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  if (typeof dis == 'undefined')
+  {
+    expect = actual = 'Test requires function dis. Not tested';
+    print(expect);
+  }
+  else
+  {
+    expect = 'Completed';
+    actual = 'Not Completed';
+    print('Before dis');
+    try
+    {
+      dis(print);
+    }
+    catch(ex)
+    {
+      print(ex + '');
+    }
+    print('After dis');
+    actual = 'Completed';
+  }
+  reportCompare(expect, actual, summary);
+
+  if (typeof dissrc == 'undefined')
+  {
+    expect = actual = 'Test requires function dissrc. Not tested';
+    print(expect);
+  }
+  else
+  {
+    print('Before dissrc');
+    expect = 'Completed';
+    actual = 'Not Completed';
+    try
+    {
+      dissrc(print);
+    }
+    catch(ex)
+    {
+      print(ex + '');
+    }
+    print('After dissrc');
+    actual = 'Completed';
+  }
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff --git a/js/tests/js1_7/extensions/regress-429266.js b/js/tests/js1_7/extensions/regress-429266.js
new file mode 100755
--- /dev/null
+++ b/js/tests/js1_7/extensions/regress-429266.js
@@ -0,0 +1,73 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2007
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-429266.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 429266;
+var summary = 'Do not assert: nuses == 0 || *pcstack[pcdepth - 1] == JSOP_ENTERBLOCK';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  try
+  {
+    function f() { let (a) 1; null.x; }
+    if (typeof trap == 'function')
+    {
+      trap(f, 0, "");
+    }
+    f();
+  }
+  catch(ex)
+  {
+    print(ex + '');
+  }
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff --git a/js/tests/js1_8/genexps/regress-380237-04.js b/js/tests/js1_8/genexps/regress-380237-04.js
--- a/js/tests/js1_8/genexps/regress-380237-04.js
+++ b/js/tests/js1_8/genexps/regress-380237-04.js
@@ -73,17 +73,17 @@ doesNotNeedParens("do { } while (xx);");
 doesNotNeedParens("do { } while (xx);");
 doesNotNeedParens("while (xx) { }");
 doesNotNeedParens("switch (xx) { }");
 doesNotNeedParens("with (xx) { }");
 needParens("switch (x) { case xx: }");
 needParens("return xx;");
 needParens("yield xx;");
 needParens("for (xx;;) { }");
-needParens("for (;xx;) { }");
+needParens("for (;xx;) { }", "function anonymous() {\n    for (;;) {\n    }\n}");
 needParens("for (;;xx) { }");
 needParens("for (i in xx) { }");
 needParens("throw xx");
 needParens("try { } catch (e if xx) { }");
 needParens("let (x=3) xx");
 needParens("let (x=xx) 3");
 
 // Function calls
@@ -206,17 +206,17 @@ function doesNotNeedParens(pat)
   // Make sure the decompilation is not over-parenthesized.
   var uf = "" + f;
   if (pat.indexOf("(xx)") != -1)
     overParenTest(f);
   //  else
   //    print("Skipping the over-parenthesization test, because I don't know how to test for over-parenthesization when the pattern doesn't have parens snugly around it.")
 }
 
-function needParens(pat)
+function needParens(pat, exp)
 {
   print("Testing " + pat);
 
   var f, ft;
   sanityCheck(pat);
 
   expect = 'SyntaxError';
   actual = '';
@@ -237,18 +237,18 @@ function needParens(pat)
     f = new Function(ft);
     actual = 'No Error';
   } catch(e) { 
     print("Yikes!"); 
     actual = e + '';
   }
   reportCompare(expect, actual, summary + ': needParens ' + ft);
 
-  roundTripTest(f);
-  overParenTest(f);
+  roundTripTest(f, exp);
+  overParenTest(f, exp);
 }
 
 function rejectLHS(pat)
 {
   print("Testing " + pat);
 
   // sanityCheck(pat); // because 'z' should be accepted as an LHS or binding
     
@@ -263,19 +263,21 @@ function rejectLHS(pat)
       actual = 'No Error';
     } catch(e) { 
       actual = e.name;
     }
   reportCompare(expect, actual, summary + ': rejectLHS');
 }
 
 
-function overParenTest(f)
+function overParenTest(f, exp)
 {
   var uf = "" + f;
+  if (uf == exp)
+    return;
 
   reportCompare(false, uf.indexOf(genexpParened) == -1, summary + 
                 ': overParenTest genexp snugly in parentheses: ' + uf);
 
   if (uf.indexOf(genexpParened) != -1) {
     reportCompare(true, uf.indexOf(genexpParenedTwice) == -1, summary + 
       ': overParensTest decompilation should not be over-parenthesized: ' + uf);
   }
@@ -296,17 +298,17 @@ function sanityCheck(pat)
   try {
     f = new Function(ft);
   } catch(e) { 
     actual += "Yowzers! Probably a bogus test!";
   }
   reportCompare(expect, actual, summary + ': sanityCheck ' + pat);
 }
 
-function roundTripTest(f)
+function roundTripTest(f, exp)
 {
   // Decompile
   var uf = "" + f;
 
   // Recompile
   expect = 'No Error';
   actual = '';
   var euf;
@@ -316,12 +318,12 @@ function roundTripTest(f)
     reportCompare(expect, actual, summary + ': roundTripTest: ' + uf);
   } catch(e) {
     actual = e + '';
     reportCompare(expect, actual, summary + ': roundTripTest: ' + uf);
     return;
   }
 
   // Decompile again and make sure the decompilations match exactly.
-  expect = uf;
+  expect = exp || uf;
   actual = "" + euf;
   reportCompare(expect, actual, summary + ': roundTripTest no round-trip change');
 }
diff --git a/js/tests/post-process-logs.pl b/js/tests/post-process-logs.pl
--- a/js/tests/post-process-logs.pl
+++ b/js/tests/post-process-logs.pl
@@ -471,17 +471,17 @@ while ($file = shift @ARGV)
                !/real.*user.*sys.*$/ && 
                !/user.*system.*elapsed/)
         {
             if ('runningtest, reportingtest' =~ /$state/)
             {
 
                 if (/error: can.t allocate region/ || /set a breakpoint in malloc_error_break/ || 
                     /set a breakpoint in szone_error to debug/ || /malloc:.*mmap/ || /vm_allocate/ ||
-                    /terminate called after throwing an instance of 'std::bad_alloc'/)
+                    /terminate called after throwing an instance of .*bad_alloc/)
                 {
                     dbg "Adding message: $_ converted to /$test_id{$state}:0: out of memory";
                     push @messages, ('/' . $test_id{$state} . ':0: out of memory');
                 }
                 elsif (/\.js, line [0-9]+: out of memory/ )
                 {
                     s/\.js, line ([0-9]+): out of memory/\.js:$1:/;
                     dbg "Adding message: $_ converted to /$test_id{$state}:0: out of memory";
diff --git a/js/tests/public-failures.txt b/js/tests/public-failures.txt
--- a/js/tests/public-failures.txt
+++ b/js/tests/public-failures.txt
@@ -1,54 +1,35 @@ TEST_ID=e4x/decompilation/decompile-xml-
-TEST_ID=e4x/decompilation/decompile-xml-escapes.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Decompiler escapes line breaks/backslashes in E4X literals reason: Type mismatch, expected type boolean, actual type string Expected value 'false', Actual value ''function anonymous() {NL    return <![CDATA[\\\\]]>;NL}' does not contain '<![CDATA[\\]]>'!'
-TEST_ID=e4x/decompilation/decompile-xml-escapes.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Decompiler escapes line breaks/backslashes in E4X literals reason: Type mismatch, expected type boolean, actual type string Expected value 'false', Actual value ''function anonymous() {NL    return <?f bNLNLcNLc?>;NL}' does not contain '<?f bNLNLcNLc?>'!'
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 11 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . n : : z ) ; } ', Actual value ' function ( ) { new x ( y ) . n : : z ; } '
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 12 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . n : : z ) ; } ', Actual value ' function ( ) { new x ( y ) . n : : z ; } '
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 14 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . n : : [ z ] ) ; } ', Actual value ' function ( ) { new x ( y ) . n : : [ z ] ; } '
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 15 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . n : : [ z ] ) ; } ', Actual value ' function ( ) { new x ( y ) . n : : [ z ] ; } '
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 2 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) [ z ] ) ; } ', Actual value ' function ( ) { new x ( y ) [ z ] ; } '
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 3 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) [ z ] ) ; } ', Actual value ' function ( ) { new x ( y ) [ z ] ; } '
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 5 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . @ a ) ; } ', Actual value ' function ( ) { new x ( y ) . @ a ; } '
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . @ a ) ; } ', Actual value ' function ( ) { new x ( y ) . @ a ; } '
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 8 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . @ [ n : : a ] ) ; } ', Actual value ' function ( ) { new x ( y ) . @ [ n : : a ] ; } '
-TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 9 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . @ [ n : : a ] ) ; } ', Actual value ' function ( ) { new x ( y ) . @ [ n : : a ] ; } '
-TEST_ID=e4x/decompilation/regress-352789.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Decompilation of new and .@ reason: Expected value ' function ( ) { return new ( a ( ) . @ z ) ; } ', Actual value ' function ( ) { return new a . @ z ; } '
-TEST_ID=e4x/decompilation/regress-429249.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=trap should not change decompilation <x/> : after trap reason: Expected value ' function g ( ) { return <x/>; } ', Actual value ' function g ( ) { return "<x/>"; } '
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 50 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 51 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 53 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 54 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 56 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
-TEST_ID=e4x/extensions/regress-337226.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=function::globalfunction Section  reason: `.``*`/e4x/extensions/regress-337226.js:`.``*`: reference to undefined XML name @mozilla.org/js/function::parseInt
-TEST_ID=e4x/extensions/regress-337226.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/extensions/regress-337226.js:`.``*`: ReferenceError: reference to undefined XML name @mozilla.org/js/function::parseInt
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`received signal 11
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`received signal 11
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/extensions/regress-374025.js:`.``*`: out of memory
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
-TEST_ID=e4x/extensions/regress-410192.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Proper quoting of attribute by uneval/toSource reason: Expected value '"v"', Actual value 'v'
-TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/e4x/GC/regress-324278.js:`.``*`: out of memory
-TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/e4x/GC/regress-324278.js:`.``*`: out of memory
-TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/GC/regress-324278.js:`.``*`: out of memory
+TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/e4x/GC/regress-324278.js:`.``*`: out of memory
+TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/e4x/GC/regress-324278.js:`.``*`: out of memory
 TEST_ID=e4x/Global/13.1.2.1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 4 of test - 13.1.2.1 - isXMLName() reason: Expected value 'exception', Actual value 'no exception'
 TEST_ID=e4x/Global/13.1.2.1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6 of test - 13.1.2.1 - isXMLName() reason: Expected value '', Actual value '0xAA-0xAA : Invalid char accepted as start : Invalid Char accepted as other NL0xB5-0xB5 : Invalid char accepted as start : Invalid Char accepted as other NL0xB7-0xB7 : Other char not acceptedNL0xBA-0xBA : Invalid char accepted as start : Invalid Char accepted as other NL0x132-0x133 : Invalid char accepted as start : Invalid Char accepted as other NL0x13F-0x140 : Invalid char accepted as start : Invalid Char accepted as other NL0x149-0x149 : Invalid char accepted as start : Invalid Char accepted as other NL0x17F-0x17F : Invalid char accepted as start : Invalid Char accepted as other NL0x1C4-0x1CC : Invalid char accepted as start : Invalid Char accepted as other NL0x1F1-0x1F3 : Invalid char accepted as start : Invalid Char accepted as other NL0x2B0-0x2B8 : Invalid Char accepted as other NL0x2BB-0x2C1 : Start char not acceptedNL0x2E0-0x2E4 : Invalid Char accepted as other NL0x37A-0x37A : Invalid Char accepted as other NL0x387-0x387 : Other char not acceptedNL0x559-0x559 : Start char not acceptedNL0x587-0x587 : Invalid char accepted as start : Invalid Char accepted as other NL0x6E5-0x6E6 : Start char not acceptedNL0xEDC-0xEDD : Invalid char accepted as start : Invalid Char accepted as other NL0x1101-0x1101 : Invalid char accepted as start : Invalid Char accepted as other NL0x1104-0x1104 : Invalid char accepted as start : Invalid Char accepted as other NL0x1108-0x1108 : Invalid char accepted as start : Invalid Char accepted as other NL0x110A-0x110A : Invalid char accepted as start : Invalid Char accepted as other NL0x110D-0x110D : Invalid char accepted as start : Invalid Char accepted as other NL0x1113-0x113B : Invalid char accepted as start : Invalid Char accepted as other NL0x113D-0x113D : Invalid char accepted as start : Invalid Char accepted as other NL0x113F-0x113F : Invalid char accepted as start : Invalid Char accepted as other NL0x1141-0x114B : Invalid char accepted as start : Invalid Char accepted as other NL0x114D-0x114D : Invalid char accepted as start : Invalid Char accepted as other NL0x114F-0x114F : Invalid char accepted as start : Invalid Char accepted as other NL0x1151-0x1153 : Invalid char accepted as start : Invalid Char accepted as other NL0x1156-0x1158 : Invalid char accepted as start : Invalid Char accepted as other NL0x1162-0x1162 : Invalid char accepted as start : Invalid Char accepted as other NL0x1164-0x1164 : Invalid char accepted as start : Invalid Char accepted as other NL0x1166-0x1166 : Invalid char accepted as start : Invalid Char accepted as other NL0x1168-0x1168 : Invalid char accepted as start : Invalid Char accepted as other NL0x116A-0x116C : Invalid char accepted as start : Invalid Char accepted as other NL0x116F-0x1171 : Invalid char accepted as start : Invalid Char accepted as other NL0x1174-0x1174 : Invalid char accepted as start : Invalid Char accepted as other NL0x1176-0x119D : Invalid char accepted as start : Invalid Char accepted as other NL0x119F-0x11A2 : Invalid char accepted as start : Invalid Char accepted as other NL0x11A9-0x11AA : Invalid char accepted as start : Invalid Char accepted as other NL0x11AC-0x11AD : Invalid char accepted as start : Invalid Char accepted as other NL0x11B0-0x11B6 : Invalid char accepted as start : Invalid Char accepted as other NL0x11B9-0x11B9 : Invalid char accepted as start : Invalid Char accepted as other NL0x11BB-0x11BB : Invalid char accepted as start : Invalid Char accepted as other NL0x11C3-0x11EA : Invalid char accepted as start : Invalid Char accepted as other NL0x11EC-0x11EF : Invalid char accepted as start : Invalid Char accepted as other NL0x11F1-0x11F8 : Invalid char accepted as start : Invalid Char accepted as other NL0x207F-0x207F : Invalid char accepted as start : Invalid Char accepted as other NL0x20DD-0x20E0 : Invalid Char accepted as other NL0x2102-0x2102 : Invalid char accepted as start : Invalid Char accepted as other NL0x2107-0x2107 : Invalid char accepted as start : Invalid Char accepted as other NL0x210A-0x2113 : Invalid char accepted as start : Invalid Char accepted as other NL0x2115-0x2115 : Invalid char accepted as start : Invalid Char accepted as other NL0x2118-0x211D : Invalid char accepted as start : Invalid Char accepted as other NL0x2124-0x2124 : Invalid char accepted as start : Invalid Char accepted as other NL0x2128-0x2128 : Invalid char accepted as start : Invalid Char accepted as other NL0x212C-0x212D : Invalid char accepted as start : Invalid Char accepted as other NL0x212F-0x2131 : Invalid char accepted as start : Invalid Char accepted as other NL0x2133-0x2138 : Invalid char accepted as start : Invalid Char accepted as other NL0x2160-0x217F : Invalid char accepted as start : Invalid Char accepted as other NL0x309B-0x309C : Invalid Char accepted as other NL0x3131-0x318E : Invalid char accepted as start : Invalid Char accepted as other NL0xF900-0xFA2D : Invalid char accepted as start : Invalid Char accepted as other NL0xFB00-0xFB06 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB13-0xFB17 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB1E-0xFB1E : Invalid Char accepted as other NL0xFB1F-0xFB28 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB2A-0xFB36 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB38-0xFB3C : Invalid char accepted as start : Invalid Char accepted as other NL0xFB3E-0xFB3E : Invalid char accepted as start : Invalid Char accepted as other NL0xFB40-0xFB41 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB43-0xFB44 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB46-0xFBB1 : Invalid char accepted as start : Invalid Char accepted as other NL0xFBD3-0xFD3D : Invalid char accepted as start : Invalid Char accepted as other NL0xFD50-0xFD8F : Invalid char accepted as start : Invalid Char accepted as other NL0xFD92-0xFDC7 : Invalid char accepted as start : Invalid Char accepted as other NL0xFDF0-0xFDFB : Invalid char accepted as start : Invalid Char accepted as other NL0xFE20-0xFE23 : Invalid Char accepted as other NL0xFE70-0xFE72 : Invalid char accepted as start : Invalid Char accepted as other NL0xFE74-0xFE74 : Invalid char accepted as start : Invalid Char accepted as other NL0xFE76-0xFEFC : Invalid char accepted as start : Invalid Char accepted as other NL0xFF10-0xFF19 : Invalid Char accepted as other NL0xFF21-0xFF3A : Invalid char accepted as start : Invalid Char accepted as other NL0xFF41-0xFF5A : Invalid char accepted as start : Invalid Char accepted as other NL0xFF66-0xFF6F : Invalid char accepted as start : Invalid Char accepted as other NL0xFF70-0xFF70 : Invalid Char accepted as other NL0xFF71-0xFF9D : Invalid char accepted as start : Invalid Char accepted as other NL0xFF9E-0xFF9F : Invalid Char accepted as other NL0xFFA0-0xFFBE : Invalid char accepted as start : Invalid Char accepted as other NL0xFFC2-0xFFC7 : Invalid char accepted as start : Invalid Char accepted as other NL0xFFCA-0xFFCF : Invalid char accepted as start : Invalid Char accepted as other NL0xFFD2-0xFFD7 : Invalid char accepted as start : Invalid Char accepted as other NL0xFFDA-0xFFDC : Invalid char accepted as start : Invalid Char accepted as other NL'
 TEST_ID=e4x/Namespace/regress-292863.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Undeclaring namespace prefix should cause parse error reason: Expected value 'error', Actual value 'no error'
+TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=6.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=6.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/e4x/Regress/regress-319872.js:`.``*`: out of memory
-TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/e4x/Regress/regress-319872.js:`.``*`: out of memory
+TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=e4x/Regress/regress-352223.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Reject invalid spaces in tags reason: Expected value 'SyntaxError: invalid XML name', Actual value ''
 TEST_ID=e4x/Regress/regress-352223.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 2 of test - Reject invalid spaces in tags reason: Expected value 'SyntaxError: invalid XML tag syntax', Actual value ''
 TEST_ID=e4x/Regress/regress-369032.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: kid2->parent == xml || !kid2->parent, at `.``*`jsxml.c:
 TEST_ID=e4x/Regress/regress-369032.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: kid2->parent == xml || !kid2->parent, at `.``*`jsxml.c:
 TEST_ID=e4x/Regress/regress-369032.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=e4x/Regress/regress-369032.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 2 of test - Do not assert: kid2->parent == xml || !kid2->parent reason: Expected value '<x>NL  <b>NL    <a>3</a>NL  </b>NL</x>', Actual value '<x>NL  <b>5</b>NL</x>'
 TEST_ID=e4x/Regress/regress-369740.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 3 of test - generic code for function:: reason: Expected value 'test', Actual value 'TypeError: can't set property @mozilla.org/js/function::toString in XMLList'
 TEST_ID=e4x/Regress/regress-370016.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=with (nonxmlobj) function:: Section  reason: `.``*`/e4x/Regress/regress-370016.js:`.``*`: reference to undefined XML name @mozilla.org/js/function::sin
@@ -64,579 +45,719 @@ TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANC
 TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 23 of test - 13.4.4.26 - XML normalize() reason: Expected value '2', Actual value '1'
 TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 3 of test - 13.4.4.26 - XML normalize() reason: Expected value '<alpha> <bravo> one </bravo> </alpha>', Actual value '<alpha><bravo> one </bravo></alpha>'
 TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 4 of test - 13.4.4.26 - XML normalize() reason: Expected value '<alpha>  </alpha>', Actual value '<alpha/>'
 TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 5 of test - 13.4.4.26 - XML normalize() reason: Expected value '2', Actual value '0'
 TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6 of test - 13.4.4.26 - XML normalize() reason: Expected value '<alpha>  </alpha>', Actual value '<alpha/>'
 TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 7 of test - 13.4.4.26 - XML normalize() reason: Expected value '1', Actual value '0'
 TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 8 of test - 13.4.4.26 - XML normalize() reason: Expected value '<alpha>  <bravo> fun </bravo></alpha>', Actual value '<alpha><bravo> fun </bravo></alpha>'
 TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 9 of test - 13.4.4.26 - XML normalize() reason: Expected value '2', Actual value '1'
-TEST_ID=e4x/XML/regress-324422-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-1.js:`.``*`: out of memory
-TEST_ID=e4x/XML/regress-324422-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=e4x/XML/regress-324422-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-1.js:`.``*`: out of memory
+TEST_ID=e4x/XML/regress-324422-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
+TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
+TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
+TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
+TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
 TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
+TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
+TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
 TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
-TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
-TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
-TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
+TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=e4x/XML/regress-376773.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=xmlsimple.stringmethod === xmlsimple.function::stringmethod Section 61 reason: `.``*`/e4x/XML/regress-376773.js:`.``*`: reference to undefined XML name @mozilla.org/js/function::charAt
 TEST_ID=e4x/XML/regress-376773.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=Section 61 of test - xmlsimple.stringmethod === xmlsimple.function::stringmethod reason:
+TEST_ID=e4x/decompilation/decompile-xml-escapes.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Decompiler escapes line breaks/backslashes in E4X literals reason: Type mismatch, expected type boolean, actual type string Expected value 'false', Actual value ''function anonymous() {NL    return <![CDATA[\\\\]]>;NL}' does not contain '<![CDATA[\\]]>'!'
+TEST_ID=e4x/decompilation/decompile-xml-escapes.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Decompiler escapes line breaks/backslashes in E4X literals reason: Type mismatch, expected type boolean, actual type string Expected value 'false', Actual value ''function anonymous() {NL    return <?f bNLNLcNLc?>;NL}' does not contain '<?f bNLNLcNLc?>'!'
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 11 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . n : : z ) ; } ', Actual value ' function ( ) { new x ( y ) . n : : z ; } '
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 12 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . n : : z ) ; } ', Actual value ' function ( ) { new x ( y ) . n : : z ; } '
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 14 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . n : : [ z ] ) ; } ', Actual value ' function ( ) { new x ( y ) . n : : [ z ] ; } '
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 15 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . n : : [ z ] ) ; } ', Actual value ' function ( ) { new x ( y ) . n : : [ z ] ; } '
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 2 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) [ z ] ) ; } ', Actual value ' function ( ) { new x ( y ) [ z ] ; } '
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 3 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) [ z ] ) ; } ', Actual value ' function ( ) { new x ( y ) [ z ] ; } '
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 5 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . @ a ) ; } ', Actual value ' function ( ) { new x ( y ) . @ a ; } '
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . @ a ) ; } ', Actual value ' function ( ) { new x ( y ) . @ a ; } '
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 8 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . @ [ n : : a ] ) ; } ', Actual value ' function ( ) { new x ( y ) . @ [ n : : a ] ; } '
+TEST_ID=e4x/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 9 of test - Decompilation with new operator redeaux reason: Expected value ' function ( ) { new ( x ( y ) . @ [ n : : a ] ) ; } ', Actual value ' function ( ) { new x ( y ) . @ [ n : : a ] ; } '
+TEST_ID=e4x/decompilation/regress-352789.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Decompilation of new and .@ reason: Expected value ' function ( ) { return new ( a ( ) . @ z ) ; } ', Actual value ' function ( ) { return new a . @ z ; } '
+TEST_ID=e4x/decompilation/regress-429249.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=trap should not change decompilation <x/> : after trap reason: Expected value ' function g ( ) { return <x/>; } ', Actual value ' function g ( ) { return "<x/>"; } '
+TEST_ID=e4x/extensions/regress-337226.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=function::globalfunction Section  reason: `.``*`/e4x/extensions/regress-337226.js:`.``*`: reference to undefined XML name @mozilla.org/js/function::parseInt
+TEST_ID=e4x/extensions/regress-337226.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/extensions/regress-337226.js:`.``*`: ReferenceError: reference to undefined XML name @mozilla.org/js/function::parseInt
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/extensions/regress-374025.js:`.``*`: out of memory
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`received signal 11
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`received signal 11
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`received signal 11
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`received signal 11
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=e4x/extensions/regress-410192.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Proper quoting of attribute by uneval/toSource reason: Expected value '"v"', Actual value 'v'
+TEST_ID=ecma/Math/15.8.2.5.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.atan2(-0, 1) reason: wrong value
+TEST_ID=ecma/Math/15.8.2.5.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.atan2(-1, Infinity) reason: wrong value
+TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-0.9) reason: wrong value
+TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-Number.MIN_VALUE) reason: wrong value
+TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-0.9) reason: wrong value
+TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-Number.MIN_VALUE) reason: wrong value
+TEST_ID=ecma/String/15.5.4.6-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var f = new Object( String.prototype.indexOf ); f('[object Window @ `.``*` (native @ `.``*`)]') reason: wrong value
+TEST_ID=ecma/TypeConversion/9.2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=!(0/0) reason: wrong value
+TEST_ID=ecma/TypeConversion/9.2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=1000 % 0 ? true : false reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
 TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-03.js:`.``*`: out of memory
 TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-04.js:`.``*`: out of memory
 TEST_ID=ecma_3/Array/regress-387501.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Array.prototype.toString|toSource|toLocaleString is not generic reason: Expected value 'TypeError: Array.prototype.toLocaleString called on incompatible String', Actual value 'f,o,o'
 TEST_ID=ecma_3/Array/regress-387501.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Array.prototype.toString|toSource|toLocaleString is not generic reason: Expected value 'TypeError: Array.prototype.toSource called on incompatible String', Actual value '["f", "o", "o"]'
 TEST_ID=ecma_3/Array/regress-387501.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Array.prototype.toString|toSource|toLocaleString is not generic reason: Expected value 'TypeError: Array.prototype.toString called on incompatible String', Actual value 'f,o,o'
+TEST_ID=ecma_3/Date/15.9.4.3.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=15.9.4.3 - Date.UTC edge-case arguments.: date -1 reason: Expected value '30', Actual value '1'
 TEST_ID=ecma_3/Date/15.9.4.3.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=15.9.4.3 - Date.UTC edge-case arguments.: date 0 reason: Expected value '31', Actual value '1'
-TEST_ID=ecma_3/Date/15.9.4.3.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=15.9.4.3 - Date.UTC edge-case arguments.: date -1 reason: Expected value '30', Actual value '1'
 TEST_ID=ecma_3/Date/15.9.4.3.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=15.9.4.3 - Date.UTC edge-case arguments.: date null reason: Expected value '31', Actual value '1'
 TEST_ID=ecma_3/Date/15.9.5.5-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.prototype.toLocaleString should not clamp year: check toLocaleString reason: Expected value '-271821', Actual value 'null'
 TEST_ID=ecma_3/Date/15.9.5.5-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.prototype.toLocaleString should not clamp year: check toLocaleString reason: Expected value '275760', Actual value 'null'
 TEST_ID=ecma_3/ExecutionContexts/10.1.3-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/ecma_3/ExecutionContexts/10.1.3-2.js:`.``*`: x is not a function
 TEST_ID=ecma_3/ExecutionContexts/10.1.3-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/ExecutionContexts/10.1.3-2.js:`.``*`: TypeError: x is not a function
 TEST_ID=ecma_3/Expressions/11.10-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=11.10 - & should evaluate operands in order: order reason: Expected value 'o.valueOf, p.valueOf', Actual value ', p.valueOfo.valueOf'
 TEST_ID=ecma_3/Expressions/11.10-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=11.10 - ^ should evaluate operands in order: order reason: Expected value 'o.valueOf, p.valueOf', Actual value ', p.valueOfo.valueOf'
 TEST_ID=ecma_3/Expressions/11.10-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=11.10 - | should evaluate operands in order: order reason: Expected value 'o.valueOf, p.valueOf', Actual value ', p.valueOfo.valueOf'
 TEST_ID=ecma_3/Expressions/11.7.1-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=11.7.1 - << should evaluate operands in order: order reason: Expected value 'o.valueOf, p.valueOf', Actual value ', p.valueOfo.valueOf'
 TEST_ID=ecma_3/Expressions/11.7.2-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=11.7.2 - >> should evaluate operands in order: order reason: Expected value 'o.valueOf, p.valueOf', Actual value ', p.valueOfo.valueOf'
 TEST_ID=ecma_3/Expressions/11.7.3-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=11.7.3 - >>> should evaluate operands in order: order reason: Expected value 'o.valueOf, p.valueOf', Actual value ', p.valueOfo.valueOf'
-TEST_ID=ecma_3/extensions/regress-274152.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not ignore unicode format-control characters: 0 reason: Expected value 'SyntaxError: illegal character', Actual value ''
-TEST_ID=ecma_3/extensions/regress-274152.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not ignore unicode format-control characters: 1 reason: Expected value 'SyntaxError: illegal character', Actual value ''
-TEST_ID=ecma_3/extensions/regress-274152.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not ignore unicode format-control characters: 2 reason: Expected value 'SyntaxError: illegal character', Actual value ''
-TEST_ID=ecma_3/extensions/regress-368516.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Ignore unicode BOM characters: 0 reason: Expected value 'No Error', Actual value 'SyntaxError: illegal character'
 TEST_ID=ecma_3/LexicalConventions/7.9.1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Automatic Semicolon insertion in postfix expressions: (xNL)-- y reason: Type mismatch, expected type string, actual type number Expected value 'SyntaxError: missing ; before statement', Actual value '0'
 TEST_ID=ecma_3/Number/15.7.4.2-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=3.3.toString.length should be 1 reason: Expected value '1', Actual value '0'
 TEST_ID=ecma_3/Number/15.7.4.2-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=num.toString(), num.toString(10), and num.toString(undefined) should all be equivalent reason: Type mismatch, expected type boolean, actual type object Expected value 'false', Actual value 'Error: illegal radix 0'
 TEST_ID=ecma_3/Operators/11.13.1-002.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=11.13.1 Simple Assignment should return type of RHS reason: Expected value 'string', Actual value 'number'
 TEST_ID=ecma_3/Operators/11.4.1-002.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=11.4.1 - The delete Operator - delete f() reason: Type mismatch, expected type boolean, actual type string Expected value 'true', Actual value 'SyntaxError: invalid assignment left-hand side'
 TEST_ID=ecma_3/RegExp/15.10.2.12.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=15.10.2.12 - CharacterClassEscape d reason: Expected value 'false', Actual value 'true'
 TEST_ID=ecma_3/RegExp/regress-307456.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/RegExp/regress-330684.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-367888.js:`.``*`: out of memory
 TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-367888.js:`.``*`: out of memory
+TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
+TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-367888.js:`.``*`: out of memory
+TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-367888.js:`.``*`: out of memory
+TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-367888.js:`.``*`: out of memory
+TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-367888.js:`.``*`: out of memory
 TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-367888.js:`.``*`: out of memory
 TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-367888.js:`.``*`: out of memory
-TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-367888.js:`.``*`: out of memory
-TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-367888.js:`.``*`: out of memory
-TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-367888.js:`.``*`: out of memory
-TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-367888.js:`.``*`: out of memory
 TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=ecma_3/RegExp/regress-367888.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-367888.js:`.``*`: out of memory
+TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-375642.js:`.``*`: out of memory
 TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-375642.js:`.``*`: out of memory
+TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
+TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-375642.js:`.``*`: out of memory
+TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-375642.js:`.``*`: out of memory
+TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-375642.js:`.``*`: out of memory
+TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-375642.js:`.``*`: out of memory
+TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-375642.js:`.``*`: out of memory
 TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-375642.js:`.``*`: out of memory
-TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-375642.js:`.``*`: out of memory
-TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-375642.js:`.``*`: out of memory
-TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-375642.js:`.``*`: out of memory
-TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-375642.js:`.``*`: out of memory
-TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-375642.js:`.``*`: out of memory
 TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=ecma_3/RegExp/regress-375642.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/RegExp/regress-375642.js:`.``*`: out of memory
 TEST_ID=ecma_3/RegExp/regress-375711.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not assert with /[Q-b]/i.exec(""): /[Q-b]/i.exec("") reason: Expected value 'No Error', Actual value 'SyntaxError: invalid range in character class'
+TEST_ID=ecma_3/RegExp/regress-375715-01-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
 TEST_ID=ecma_3/RegExp/regress-375715-01-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
+TEST_ID=ecma_3/RegExp/regress-375715-01-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
 TEST_ID=ecma_3/RegExp/regress-375715-01-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
+TEST_ID=ecma_3/RegExp/regress-375715-01-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
 TEST_ID=ecma_3/RegExp/regress-375715-01-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
-TEST_ID=ecma_3/RegExp/regress-375715-01-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
-TEST_ID=ecma_3/RegExp/regress-375715-01-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
-TEST_ID=ecma_3/RegExp/regress-375715-01-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
-TEST_ID=ecma_3/RegExp/regress-375715-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
-TEST_ID=ecma_3/RegExp/regress-375715-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
-TEST_ID=ecma_3/RegExp/regress-375715-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
-TEST_ID=ecma_3/RegExp/regress-375715-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
-TEST_ID=ecma_3/RegExp/regress-375715-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
+TEST_ID=ecma_3/RegExp/regress-375715-01-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at jsregexp.c:
 TEST_ID=ecma_3/RegExp/regress-375715-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
 TEST_ID=ecma_3/RegExp/regress-375715-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
-TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
-TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
-TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
-TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
-TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
+TEST_ID=ecma_3/RegExp/regress-375715-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
+TEST_ID=ecma_3/RegExp/regress-375715-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
+TEST_ID=ecma_3/RegExp/regress-375715-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
+TEST_ID=ecma_3/RegExp/regress-375715-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
+TEST_ID=ecma_3/RegExp/regress-375715-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
+TEST_ID=ecma_3/RegExp/regress-375715-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at jsregexp.c:
 TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
 TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
-TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not assert: (c2 <= cs->length) && (c1 <= c2)(new RegExp("[-]]", "i")).exec("") reason: Expected value 'SyntaxError: invalid range in character class', Actual value ''
-TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not assert: (c2 <= cs->length) && (c1 <= c2)(new RegExp("[-]]", "i")).exec("") reason: Expected value 'SyntaxError: invalid range in character class', Actual value ''
-TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 7 reason: Expected value '/x/g/x/g/x/g', Actual value 'xnullx'
+TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
+TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
+TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
+TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
+TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
+TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at jsregexp.c:
+TEST_ID=ecma_3/RegExp/regress-375715-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not assert: (c2 <= cs->length) && (c1 <= c2)(new RegExp("`.``*`", "i")).exec("") reason: Expected value 'SyntaxError: invalid range in character class', Actual value ''
+TEST_ID=ecma_3/RegExp/regress-375876-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
+TEST_ID=ecma_3/RegExp/regress-375876-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
+TEST_ID=ecma_3/RegExp/regress-375876-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
+TEST_ID=ecma_3/RegExp/regress-375876-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (c2 <= cs->length) && (c1 <= c2), at `.``*`jsregexp.c:
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 42 reason: Expected value 'ok', Actual value 'failure'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 56 reason: Expected value '|x|string|x|string|0|number|xyz|string||y|string||undefined|1|number|xyz|string|z', Actual value '|x|string|x|string|0|number|xyz|string||y|string||string|1|number|xyz|string|z'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 58 reason: Expected value 'xy|z|string||undefined|2|number|xyz|string|', Actual value 'xy|z|string||string|2|number|xyz|string|'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 59 reason: Expected value 'xy|z|string||undefined|2|number|xyz|string|', Actual value 'xy|z|string||string|2|number|xyz|string|'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 60 reason: Expected value 'xy|z|string||undefined|2|number|xyz|string|', Actual value 'xy|z|string||string|2|number|xyz|string|'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 61 reason: Expected value 'xy|z|string||string|2|number|xyz|string|', Actual value 'xyz'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 62 reason: Expected value 'x|y|string|y|string||undefined|1|number|xyz|string|z', Actual value 'x|y|string|y|string||string|1|number|xyz|string|z'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 64 reason: Expected value 'x|y|string|y|string||undefined|1|number|xyyz|string||y|string|y|string||undefined|2|number|xyyz|string|z', Actual value 'x|y|string|y|string||string|1|number|xyyz|string||y|string|y|string||string|2|number|xyyz|string|z'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 66 reason: Expected value 'xyy|z|string||undefined||string|3|number|xyyz|string|', Actual value 'xyy|z|string||string||string|3|number|xyyz|string|'
 TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 67 reason: Expected value 'x|y|string|1|number|xyz|string||string||undefined|y|string|z', Actual value 'x|y|string|1|number|xyz|string||string||string|y|string|z'
+TEST_ID=ecma_3/String/15.5.4.11.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 7 reason: Expected value '/x/g/x/g/x/g', Actual value 'xnullx'
 TEST_ID=ecma_3/String/regress-392378.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Regular Expression Non-participating Capture Groups are inaccurate in edge cases: "y".replace(/(x)?\1y/, function($0, $1){ return String($1); }) reason: Expected value 'undefined', Actual value ''
 TEST_ID=ecma_3/String/regress-392378.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Regular Expression Non-participating Capture Groups are inaccurate in edge cases: "y".replace(/(x)?y/, function($0, $1){ return $1; }) reason: Expected value 'undefined', Actual value ''
 TEST_ID=ecma_3/String/regress-392378.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Regular Expression Non-participating Capture Groups are inaccurate in edge cases: "y".replace(/(x)?y/, function($0, $1){ return String($1); }) reason: Expected value 'undefined', Actual value ''
 TEST_ID=ecma_3/Unicode/regress-352044-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=issues with Unicode escape sequences in JavaScript source code reason: Expected value 'SyntaxError: illegal character', Actual value ''
 TEST_ID=ecma_3/Unicode/regress-352044-02-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=issues with Unicode escape sequences in JavaScript source code reason: Expected value 'SyntaxError', Actual value 'No Error'
-TEST_ID=ecma/Math/15.8.2.5.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.atan2(-0, 1) reason: wrong value
-TEST_ID=ecma/Math/15.8.2.5.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.atan2(-1, Infinity) reason: wrong value
-TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-0.9) reason: wrong value
-TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-Number.MIN_VALUE) reason: wrong value
-TEST_ID=ecma/String/15.5.4.6-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var f = new Object( String.prototype.indexOf ); f('[object Window @ `.``*` (native @ `.``*`)]') reason: wrong value
-TEST_ID=ecma/TypeConversion/9.2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=!(0/0) reason: wrong value
-TEST_ID=ecma/TypeConversion/9.2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=1000 % 0 ? true : false reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma_3/extensions/regress-274152.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not ignore unicode format-control characters: 0 reason: Expected value 'SyntaxError: illegal character', Actual value ''
+TEST_ID=ecma_3/extensions/regress-274152.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not ignore unicode format-control characters: 1 reason: Expected value 'SyntaxError: illegal character', Actual value ''
+TEST_ID=ecma_3/extensions/regress-274152.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not ignore unicode format-control characters: 2 reason: Expected value 'SyntaxError: illegal character', Actual value ''
+TEST_ID=ecma_3/extensions/regress-368516.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Ignore unicode BOM characters: 0 reason: Expected value 'No Error', Actual value 'SyntaxError: illegal character'
+TEST_ID=ecma_3/extensions/regress-430740.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not strip format-control characters from string literals reason: Expected value 'a%EF%BF%BE,+doevil()%5D)//', Actual value 'a',%20evildone'
 TEST_ID=js1_2/function/regexparg-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=typeof f(/abc/) reason: wrong value
 TEST_ID=js1_2/function/regexparg-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=typeof new f(/abc/) reason: wrong value
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 1 of test -  [,1]  reason: Expected value '1', Actual value '01'
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 2 of test -  [,,1]  reason: Expected value '2', Actual value '012'
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 4 of test -  [1,,]  reason: Expected value '0', Actual value '01'
 TEST_ID=js1_5/Array/regress-101964.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test -  reason: Expected value 'Truncation took less than 50 ms', Actual value 'Truncation took `.``*` ms'
 TEST_ID=js1_5/Array/regress-157652.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Array/regress-157652.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
 TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
 TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
-TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
-TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-350256-03.js:`.``*`: out of memory
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-350256-03.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-350256-03.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-350256-03.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-350256-03.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-350256-03.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-350256-03.js:`.``*`: out of memory
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-350256-03.js:`.``*`: out of memory
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-350256-03.js:`.``*`: out of memory
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-350256-03.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-350256-03.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Error/regress-354246.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Error/regress-354246.js:`.``*`: x is not defined
+TEST_ID=js1_5/Error/regress-354246.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Error/regress-354246.js:`.``*`: x is not defined
+TEST_ID=js1_5/Expressions/regress-394673.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Expressions/regress-394673.js:`.``*`: too much recursion
+TEST_ID=js1_5/Expressions/regress-394673.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Expressions/regress-394673.js:`.``*`: InternalError: too much recursion
+TEST_ID=js1_5/Function/regress-338001.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=3, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=3, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Issues with JS_ARENA_ALLOCATE_CAST reason: Expected value 'InternalError: script stack space quota is exhausted', Actual value 'SyntaxError: malformed formal parameter'
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=Issues with JS_ARENA_ALLOCATE_CAST reason: Expected value 'InternalError: script stack space quota is exhausted', Actual value 'SyntaxError: malformed formal parameter'
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Function/regress-338121-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-03.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-203278-2.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-203278-2.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-319980-01.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-338653.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-338653.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-338653.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=3, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-348532.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-348532.js:`.``*`: too much recursion
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=fast, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=fast, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/Regress/regress-203278-1.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-203278-1.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=3, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=6.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-303213.js:`.``*`: out of memory`.``*`received signal 11
+TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-312588.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-312588.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-312588.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-312588.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-312588.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-312588.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=3, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-319384.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-319384.js:`.``*`: can't convert "foo" to an integer
+TEST_ID=js1_5/Regress/regress-320119.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=delegating objects and arguments, arity, caller, name: arguments no longer shared reason: Expected value 'false', Actual value 'true'
+TEST_ID=js1_5/Regress/regress-320119.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=delegating objects and arguments, arity, caller, name: arity no longer shared reason: Expected value 'false', Actual value 'true'
+TEST_ID=js1_5/Regress/regress-320119.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=delegating objects and arguments, arity, caller, name: caller no longer shared reason: Expected value 'false', Actual value 'true'
+TEST_ID=js1_5/Regress/regress-320119.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=delegating objects and arguments, arity, caller, name: name no longer shared reason: Expected value 'false', Actual value 'true'
+TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: :0: uncaught exception: Permission denied to get property UnnamedClass.classes
+TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=JS_ReportPendingException should reason: Expected value 'Error', Actual value 'No Error'
+TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: javascript:Components.classes:0: Script error.
+TEST_ID=js1_5/Regress/regress-329530.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-330352.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-330352.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-330352.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-330352.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-330352.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-330352.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-330352.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-346237.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-346237.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-350268.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=new Function with unbalanced braces: alert(6); } alert(5); reason: Expected value 'SyntaxError', Actual value 'No Error'
+TEST_ID=js1_5/Regress/regress-350268.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=new Function with unbalanced braces: } reason: Expected value 'SyntaxError', Actual value 'No Error'
+TEST_ID=js1_5/Regress/regress-350268.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=new Function with unbalanced braces: } { reason: Expected value 'SyntaxError', Actual value 'No Error'
+TEST_ID=js1_5/Regress/regress-350268.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=new Function with unbalanced braces: }}}}} reason: Expected value 'SyntaxError', Actual value 'No Error'
+TEST_ID=js1_5/Regress/regress-352604.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !OBJ_GET_PROTO(cx, ctor), at `.``*`jsapi.c:
+TEST_ID=js1_5/Regress/regress-352604.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !OBJ_GET_PROTO(cx, ctor), at `.``*`jsapi.c:
+TEST_ID=js1_5/Regress/regress-352604.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-362583.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: caller->fun && !JSFUN_HEAVYWEIGHT_TEST(caller->fun->flags), at `.``*`jsscript.c:
+TEST_ID=js1_5/Regress/regress-362583.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: caller->fun && !JSFUN_HEAVYWEIGHT_TEST(caller->fun->flags), at `.``*`jsscript.c:
+TEST_ID=js1_5/Regress/regress-362583.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-383674.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Statement that implicitly calls toString should not be optimized away as a "useless expression": 1 reason: Expected value 'toString called', Actual value 'toString not called'
+TEST_ID=js1_5/Regress/regress-383674.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Statement that implicitly calls toString should not be optimized away as a "useless expression": 2 reason: Expected value 'toString called', Actual value 'toString not called'
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
 TEST_ID=js1_5/decompilation/regress-351219.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of immutable infinity, NaN decompile Infinity as 1/0 reason: Expected value ' function ( ) { return 1 / 0 ; } ', Actual value ' function ( ) { return Infinity ; } '
 TEST_ID=js1_5/decompilation/regress-351219.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of immutable infinity, NaN: decompile NaN as 0/0 reason: Expected value ' function ( ) { var NaN = 0 / 0 ; return NaN ; } ', Actual value ' function ( ) { var NaN = NaN ; return NaN ; } '
+TEST_ID=js1_5/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of new parenthetic expressions reason: Expected value ' function ( ) { new ( x ( y ) ( z ) ) ; } ', Actual value ' function ( ) { new x ( y ) ( z ) ; } '
 TEST_ID=js1_5/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of new parenthetic expressions reason: Expected value ' function ( ) { new ( x ( y ) . z ) ; } ', Actual value ' function ( ) { new x ( y ) . z ; } '
-TEST_ID=js1_5/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of new parenthetic expressions reason: Expected value ' function ( ) { new ( x ( y ) ( z ) ) ; } ', Actual value ' function ( ) { new x ( y ) ( z ) ; } '
 TEST_ID=js1_5/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of new parenthetic expressions reason: Expected value ' function ( ) { new ( x ( z ) ) ( w ) ; } ', Actual value ' function ( ) { new x ( z ) ( w ) ; } '
+TEST_ID=js1_5/decompilation/regress-352360.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of negative 0 reason: Expected value ' function ( ) { return - 0 ; } ', Actual value ' function ( ) { return 0 ; } '
 TEST_ID=js1_5/decompilation/regress-352360.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of negative 0: 8 / eval("" + f)() reason: Expected value '-Infinity', Actual value 'Infinity'
-TEST_ID=js1_5/decompilation/regress-352360.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of negative 0 reason: Expected value ' function ( ) { return - 0 ; } ', Actual value ' function ( ) { return 0 ; } '
 TEST_ID=js1_5/decompilation/regress-352453.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/decompilation/regress-352453.js:`.``*`: invalid decrement operand
-TEST_ID=js1_5/decompilation/regress-352453.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/decompilation/regress-352453.js:`.``*`: SyntaxError: invalid decrement operand:; `.``*`/js1_5/decompilation/regress-352453.js:`.``*`:   var f = function() { (eval)(x)-- };; `.``*`/js1_5/decompilation/regress-352453.js:`.``*`:
+TEST_ID=js1_5/decompilation/regress-352453.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/decompilation/regress-352453.js:`.``*`: SyntaxError: invalid decrement operand:
 TEST_ID=js1_5/decompilation/regress-353146.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of new expressions revisited reason: Expected value ' function ( ) { return new ( p ( 2 ) [ 1 ] ) ; } ', Actual value ' function ( ) { return new p ( 2 ) [ 1 ] ; } '
 TEST_ID=js1_5/decompilation/regress-356083.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation for ({this setter: function () { } })  reason: Expected value ' function ( ) { return { this setter : function ( ) { } } ; } ', Actual value ' function ( ) { return { ' this ' setter : function ( ) { } } ; } '
 TEST_ID=js1_5/decompilation/regress-356248.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of object literal with named getter reason: Expected value ' function ( ) { return { set p y ( ) { } } ; } ', Actual value ' function ( ) { return { set py ( ) { } } ; } '
 TEST_ID=js1_5/decompilation/regress-371692.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Keep extra parentheses in conditional tests reason: Expected value ' function ( ) { if ( ( i = 1 ) ) { a = 2 ; } } ', Actual value ' function ( ) { if ( i = 1 ) { a = 2 ; } } '
 TEST_ID=js1_5/decompilation/regress-375882.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of switch with case 0/0 reason: Expected value ' function ( ) { switch ( a ) { case 0 / 0 : a ; case 1 / 0 : b ; case 1 / - 0 : c ; case - 0 : d ; default : ; } } ', Actual value ' function ( ) { switch ( a ) { case NaN : a ; case Infinity : b ; case - Infinity : c ; case 0 : d ; default : ; } } '
 TEST_ID=js1_5/decompilation/regress-376564.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of new (eval()) reason: Expected value ' function ( ) { new ( eval ( ) ) ; } ', Actual value ' function ( ) { new eval ; } '
 TEST_ID=js1_5/decompilation/regress-376564.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of new (eval()) reason: Expected value ' function ( ) { new ( g ( ) ) ; } ', Actual value ' function ( ) { new g ; } '
 TEST_ID=js1_5/decompilation/regress-383721.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompiling Tabs: toString reason: Expected value ' function ( ) { return "\ t "; } ', Actual value ' function ( ) { return " "; } '
 TEST_ID=js1_5/decompilation/regress-383721.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompiling Tabs: uneval reason: Expected value ' ( function ( ) { return "\ t "; } ) ', Actual value ' ( function ( ) { return " "; } ) '
-TEST_ID=js1_5/Error/regress-354246.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Error/regress-354246.js:`.``*`: x is not defined
-TEST_ID=js1_5/Error/regress-354246.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Error/regress-354246.js:`.``*`: x is not defined
-TEST_ID=js1_5/Expressions/regress-394673.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Expressions/regress-394673.js:`.``*`: too much recursion
-TEST_ID=js1_5/Expressions/regress-394673.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Expressions/regress-394673.js:`.``*`: InternalError: too much recursion
 TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
+TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
+TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
 TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
-TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
-TEST_ID=js1_5/extensions/regress-304897.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=uneval("\t"), uneval("\x09") reason: Expected value '"\t"', Actual value '"	"'
+TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
+TEST_ID=js1_5/extensions/regress-304897.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=uneval("\t"), uneval("\x09") reason: Expected value '"\t"', Actual value '"\x09"'
 TEST_ID=js1_5/extensions/regress-322957.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=TryMethod should not eat getter exceptions reason: Type mismatch, expected type boolean, actual type number Expected value 'true', Actual value '-1'
 TEST_ID=js1_5/extensions/regress-330569.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-336409-1.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-336409-1.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-336409-1.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-336409-1.js:`.``*`: out of memory
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=3, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-336409-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-336410-1.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-336410-1.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-336410-1.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-336410-1.js:`.``*`: out of memory
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=3, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-336410-2.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-342960.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-342960.js:`.``*`: out of memory
-TEST_ID=js1_5/extensions/regress-342960.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-342960.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-342960.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-342960.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-342960.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-342960.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/regress-342960.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-342960.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/regress-342960.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-342960.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=fast, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-350531.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-350531.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-351448.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-351463-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Treat hyphens as not special adjacent to CharacterClassEscapes in character classes: /([\d-\S]+)/.exec("a0- z") reason: Expected value 'a0-,a0-', Actual value 'SyntaxError: invalid range in character class'
 TEST_ID=js1_5/extensions/regress-351463-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Treat hyphens as not special adjacent to CharacterClassEscapes in character classes: /([\d-\s]+)/.exec("a0- z") reason: Expected value '0- ,0- ', Actual value 'SyntaxError: invalid range in character class'
-TEST_ID=js1_5/extensions/regress-351463-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Treat hyphens as not special adjacent to CharacterClassEscapes in character classes: /([\d-\S]+)/.exec("a0- z") reason: Expected value 'a0-,a0-', Actual value 'SyntaxError: invalid range in character class'
 TEST_ID=js1_5/extensions/regress-352455.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Eval object with non-function getters/setters reason: Expected value 'SyntaxError: invalid getter usage', Actual value ''
 TEST_ID=js1_5/extensions/regress-352604.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !OBJ_GET_PROTO(cx, ctor), at `.``*`jsapi.c:
 TEST_ID=js1_5/extensions/regress-352604.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !OBJ_GET_PROTO(cx, ctor), at `.``*`jsapi.c:
 TEST_ID=js1_5/extensions/regress-352604.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-352604.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not assert: !OBJ_GET_PROTO(cx, ctor) reason: Expected value 'function f() {NL}', Actual value 'function () {NL}'
 TEST_ID=js1_5/extensions/regress-353214.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of |function() { (function ([x]) { })(); eval("return 3;") }| reason: Expected value ' function ( ) { ( function ( [ x ] ) { } ( ) ) ; eval ( " return 3 ;" ) ; } ', Actual value ' function ( ) { ( function ( [ x ] ) { } ) ( ) ; eval ( " return 3 ;" ) ; } '
 TEST_ID=js1_5/extensions/regress-355622.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: overwriting, at `.``*`jsscope.c:
 TEST_ID=js1_5/extensions/regress-355622.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: overwriting, at `.``*`jsscope.c:
 TEST_ID=js1_5/extensions/regress-355622.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-355736.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of "[reserved]" has extra quotes: 1 reason: Expected value ' function ( ) { [ super ] = q ; } ', Actual value ' function ( ) { [ " super " ] = q ; } '
 TEST_ID=js1_5/extensions/regress-355736.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of "[reserved]" has extra quotes: 1: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: invalid assignment left-hand side'
-TEST_ID=js1_5/extensions/regress-355736.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of "[reserved]" has extra quotes: 1 reason: Expected value ' function ( ) { [ super ] = q ; } ', Actual value ' function ( ) { [ " super " ] = q ; } '
 TEST_ID=js1_5/extensions/regress-355736.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of "[reserved]" has extra quotes: 2 reason: Expected value ' function ( ) { return { super getter : function ( ) { } } ; } ', Actual value ' function ( ) { return { ' super ' getter : function ( ) { } } ; } '
+TEST_ID=js1_5/extensions/regress-355736.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of "[reserved]" has extra quotes: 3 reason: Expected value ' function ( ) { [ goto ] = a ; } ', Actual value ' function ( ) { [ " goto " ] = a ; } '
 TEST_ID=js1_5/extensions/regress-355736.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of "[reserved]" has extra quotes: 3: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: invalid assignment left-hand side'
-TEST_ID=js1_5/extensions/regress-355736.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of "[reserved]" has extra quotes: 3 reason: Expected value ' function ( ) { [ goto ] = a ; } ', Actual value ' function ( ) { [ " goto " ] = a ; } '
 TEST_ID=js1_5/extensions/regress-355820.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Remove non-standard Script object reason: Expected value 'undefined', Actual value 'function'
 TEST_ID=js1_5/extensions/regress-356085.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=js_obj_toString for getter/setter reason: Expected value ' ( { set p y ( ) { } } ) ', Actual value ' ( { set p ( ) { } } ) '
 TEST_ID=js1_5/extensions/regress-365869.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=strict warning for object literal with duplicate propery names reason: Expected value 'TypeError: redeclaration of property 1', Actual value 'No warning'
 TEST_ID=js1_5/extensions/regress-365869.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=strict warning for object literal with duplicate propery names reason: Expected value 'TypeError: redeclaration of property a', Actual value 'No warning'
 TEST_ID=js1_5/extensions/regress-367923.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=strict warning for variable redeclares argument reason: Expected value 'TypeError: variable v redeclares argument', Actual value 'TypeError: variable v hides argument'
-TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
-TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
-TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
-TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
-TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
 TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
 TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
+TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
+TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
+TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
+TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
+TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
+TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
+TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
+TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
-TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
-TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
-TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
+TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-375801.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=uneval should use "(void 0)" instead of "undefined": uneval reason: Expected value ' ( { a : ( void 0 ) } ) ', Actual value ' ( { a : undefined } ) '
 TEST_ID=js1_5/extensions/regress-376052.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=javascript.options.anonfunfix to allow function (){} expressions: 3 reason: Expected value 'SyntaxError: syntax error', Actual value 'No Error'
-TEST_ID=js1_5/extensions/regress-379523.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of sharp declaration: 1: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: invalid property id'
 TEST_ID=js1_5/extensions/regress-379523.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of sharp declaration: 1 reason: Expected value ' ( function ( ) { return # 1 = [ a ] ; } ) ', Actual value ' ( function ( ) { return # 1 = [ , a ] ; } ) '
 TEST_ID=js1_5/extensions/regress-379523.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of sharp declaration: 1 reason: Expected value ' ( function ( ) { return # 1 = { a : b } ; } ) ', Actual value ' ( function ( ) { return # 1 = { , a : b } ; } ) '
+TEST_ID=js1_5/extensions/regress-379523.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of sharp declaration: 1: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: invalid property id'
 TEST_ID=js1_5/extensions/regress-380831.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=uneval trying to output a getter function that is a sharp definition reason: Expected value ' ( { b getter : # 1 = ( function ( ) { } ) , c getter : # 1 # } ) ', Actual value ' ( { b getter : # 1 = ( ) { } , c getter : # 1 # } ) '
 TEST_ID=js1_5/extensions/regress-380889.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: op == JSOP_LOOKUPSWITCH, at `.``*`js.c:
 TEST_ID=js1_5/extensions/regress-380889.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: op == JSOP_LOOKUPSWITCH, at `.``*`js.c:
 TEST_ID=js1_5/extensions/regress-380889.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-381205.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=uneval with special getter functions: global reason: Expected value '({get x p() {print(4);}})', Actual value '({get x () {print(4);})'
 TEST_ID=js1_5/extensions/regress-381304.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-381304.js:`.``*`: missing : after property id
-TEST_ID=js1_5/extensions/regress-381304.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-381304.js:`.``*`: SyntaxError: missing : after property id:; `.``*`/js1_5/extensions/regress-381304.js:`.``*`:     set in(value) {this.for = value;},; `.``*`/js1_5/extensions/regress-381304.js:`.``*`:
+TEST_ID=js1_5/extensions/regress-381304.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-381304.js:`.``*`: SyntaxError: missing : after property id
 TEST_ID=js1_5/extensions/regress-385134.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-385134.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-385134.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-394967.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-407019.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not assert: !JS_IsExceptionPending(cx) - Browser only reason: Expected match to '/Illegal operation on WrappedNative prototype object/', Actual value 'TypeError: window.Option is not a function'
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'xxx-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51', Actual value 'xxx-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051'
+TEST_ID=js1_5/extensions/regress-422592.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-1 99', Actual value '-001 -1'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-51 49', Actual value '-051 -51'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value '-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51', Actual value '-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051'
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'xxx-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51', Actual value 'xxx-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'Sat Jan 01 -0051 00:00:00 `.``*`', Actual value 'xxxx-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51'
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'Sun Jan 01 32767 00:00:00 `.``*`', Actual value 'xxxxx2767276727672767276727672767276727672767276727672767276727672767276727672767'
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-1 99', Actual value '000/ 0/'
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-100 00', Actual value '0/00 00'
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-51 49', Actual value '00+/ +/'
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '1851 51', Actual value '1851 ,''
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '1899 99', Actual value '1899 0/'
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value '-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999', Actual value ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value '32767327673276732767327673276732767327673276732767327673276732767327673276732767327673276732767', Actual value '2767276727672767276727672767276727672767276727672767276727672767276727672767'
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value '-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51', Actual value '00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/'
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'xxx-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51', Actual value 'xxx00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/'
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'xxxx-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999', Actual value 'xxxx'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'xxxx32767327673276732767327673276732767327673276732767327673276732767327673276732767327673276732767', Actual value 'xxxx2767276727672767276727672767276727672767276727672767276727672767276727672767'
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'xxxx-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999', Actual value 'xxxx'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'Mon Jan 01 -9999 00:00:00 `.``*`', Actual value 'xxxx'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'Sun Jan 01 32767 00:00:00 `.``*`', Actual value 'xxxx2767276727672767276727672767276727672767276727672767276727672767276727672767276727672767'
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'xxx-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51', Actual value 'xxx00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/'
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-100 00', Actual value '0/00 00'
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '1851 51', Actual value '1851 ,''
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '1899 99', Actual value '1899 0/'
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-1 99', Actual value '000/ 0/'
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-51 49', Actual value '00+/ +/'
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value '32767327673276732767327673276732767327673276732767327673276732767327673276732767327673276732767', Actual value '2767276727672767276727672767276727672767276727672767276727672767276727672767'
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value '-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999-9999', Actual value ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
-TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value '-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51', Actual value '00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/00+/'
+TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'Sun Jan 01 32767 00:00:00 `.``*`', Actual value 'xxxxx2767276727672767276727672767276727672767276727672767276727672767276727672767'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%C") reason: Expected value '20', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%G") reason: Expected value '2005', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%V") reason: Expected value '22', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y-%m-%d") == Date.toLocaleFormat("%F") reason: Expected value '2005-06-04', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%b") == Date.toLocaleFormat("%h") reason: Expected value 'Jun', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%e") reason: Expected value ' 4', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%g") reason: Expected value '05', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%m/%d/%y") == Date.toLocaleFormat("%D") reason: Expected value '06/04/05', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%n") == "NL" reason: Expected value 'NL', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%t") == "\t" reason: Expected value '\x09', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%u") reason: Expected value '6', Actual value 'Sat Jun 04 2005 `.``*`'
 TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%C%y") == Date.toLocaleFormat("%Y") reason: Expected value '05', Actual value '2005'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%C%y") == Date.toLocaleFormat("%Y") reason: Expected value 'Sat Jun 04 2005 20:00:00 `.``*`', Actual value '2005'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%b") == Date.toLocaleFormat("%h") reason: Expected value 'Jun', Actual value 'Sat Jun 04 2005 20:00:00 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%C") reason: Expected value '20', Actual value 'Sat Jun 04 2005 20:00:00 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%e") reason: Expected value ' 4', Actual value 'Sat Jun 04 2005 20:00:00 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%g") reason: Expected value '05', Actual value 'Sat Jun 04 2005 20:00:00 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%G") reason: Expected value '2005', Actual value 'Sat Jun 04 2005 20:00:00 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%H:%M") == Date.toLocaleFormat("%R") reason: Expected value '20:00', Actual value 'Sat Jun 04 2005 20:00:00 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%H:%M:%S") == Date.toLocaleFormat("%T") reason: Expected value '20:00:00', Actual value 'Sat Jun 04 2005 20:00:00 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%I:%M:%S %p") == Date.toLocaleFormat("%r") reason: Expected value '08:00:00 PM', Actual value 'Sat Jun 04 2005 20:00:00 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%m/%d/%y") == Date.toLocaleFormat("%D") reason: Expected value '06/04/05', Actual value 'Sat Jun 04 2005 20:00:00 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%n") == "NL" reason: Expected value 'NL', Actual value 'Sat Jun 04 2005 20:00:00 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%t") == "\t" reason: Expected value '	', Actual value 'Sat Jun 04 2005 20:00:00 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%u") reason: Expected value '6', Actual value 'Sat Jun 04 2005 20:00:00 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%V") reason: Expected value '22', Actual value 'Sat Jun 04 2005 20:00:00 `.``*`'
-TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y-%m-%d") == Date.toLocaleFormat("%F") reason: Expected value '2005-06-04', Actual value 'Sat Jun 04 2005 20:00:00 `.``*`'
-TEST_ID=js1_5/Function/regress-338001.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=Issues with JS_ARENA_ALLOCATE_CAST reason: Expected value 'InternalError: script stack space quota is exhausted', Actual value 'SyntaxError: malformed formal parameter'; messages: BUGNUMBER: 338121; `.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory; SyntaxError: malformed formal parameter
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Issues with JS_ARENA_ALLOCATE_CAST reason: Expected value 'InternalError: script stack space quota is exhausted', Actual value 'SyntaxError: malformed formal parameter'
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Issues with JS_ARENA_ALLOCATE_CAST reason: Expected value 'InternalError: script stack space quota is exhausted', Actual value 'SyntaxError: malformed formal parameter'; messages: BUGNUMBER: 338121; `.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory; SyntaxError: malformed formal parameter
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Issues with JS_ARENA_ALLOCATE_CAST reason: Expected value 'InternalError: script stack space quota is exhausted', Actual value 'SyntaxError: malformed formal parameter'; messages: BUGNUMBER: 338121; SyntaxError: malformed formal parameter
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=Issues with JS_ARENA_ALLOCATE_CAST reason: Expected value 'InternalError: script stack space quota is exhausted', Actual value 'SyntaxError: malformed formal parameter'; messages: BUGNUMBER: 338121; `.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory; SyntaxError: malformed formal parameter
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Issues with JS_ARENA_ALLOCATE_CAST reason: Expected value 'InternalError: script stack space quota is exhausted', Actual value 'SyntaxError: malformed formal parameter'; messages: BUGNUMBER: 338121; `.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory; SyntaxError: malformed formal parameter
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Issues with JS_ARENA_ALLOCATE_CAST reason: Expected value 'InternalError: script stack space quota is exhausted', Actual value 'SyntaxError: malformed formal parameter'
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-03.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-203278-2.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-203278-2.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-311497.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-319980-01.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-338653.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-338653.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-338653.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-338653.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-348532.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-348532.js:`.``*`: too much recursion
-TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*` uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*` uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: :`.``*`: uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*` uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*` uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/Regress/regress-203278-1.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-203278-1.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-312588.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-312588.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-312588.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-312588.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-312588.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-319384.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-319384.js:`.``*`: can't convert "foo" to an integer
-TEST_ID=js1_5/Regress/regress-320119.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=delegating objects and arguments, arity, caller, name: arguments no longer shared reason: Expected value 'false', Actual value 'true'
-TEST_ID=js1_5/Regress/regress-320119.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=delegating objects and arguments, arity, caller, name: arity no longer shared reason: Expected value 'false', Actual value 'true'
-TEST_ID=js1_5/Regress/regress-320119.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=delegating objects and arguments, arity, caller, name: caller no longer shared reason: Expected value 'false', Actual value 'true'
-TEST_ID=js1_5/Regress/regress-320119.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=delegating objects and arguments, arity, caller, name: name no longer shared reason: Expected value 'false', Actual value 'true'
-TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: :0: uncaught exception: Permission denied to get property UnnamedClass.classes
-TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=JS_ReportPendingException should reason: Expected value 'Error', Actual value 'No Error'
-TEST_ID=js1_5/Regress/regress-328897.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: javascript:Components.classes:0: Script error.
-TEST_ID=js1_5/Regress/regress-329530.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-330352.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-330352.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-330352.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-330352.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-330352.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-330352.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-330352.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-346237.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-346237.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-346237.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-346237.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-346237.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-346237.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-350268.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=new Function with unbalanced braces: alert(6); } alert(5); reason: Expected value 'SyntaxError', Actual value 'No Error'
-TEST_ID=js1_5/Regress/regress-350268.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=new Function with unbalanced braces: } { reason: Expected value 'SyntaxError', Actual value 'No Error'
-TEST_ID=js1_5/Regress/regress-350268.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=new Function with unbalanced braces: } reason: Expected value 'SyntaxError', Actual value 'No Error'
-TEST_ID=js1_5/Regress/regress-350268.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=new Function with unbalanced braces: }}}}} reason: Expected value 'SyntaxError', Actual value 'No Error'
-TEST_ID=js1_5/Regress/regress-352604.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !OBJ_GET_PROTO(cx, ctor), at `.``*`jsapi.c:
-TEST_ID=js1_5/Regress/regress-352604.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !OBJ_GET_PROTO(cx, ctor), at `.``*`jsapi.c:
-TEST_ID=js1_5/Regress/regress-352604.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-362583.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: caller->fun && !JSFUN_HEAVYWEIGHT_TEST(caller->fun->flags), at `.``*`jsscript.c:
-TEST_ID=js1_5/Regress/regress-362583.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: caller->fun && !JSFUN_HEAVYWEIGHT_TEST(caller->fun->flags), at `.``*`jsscript.c:
-TEST_ID=js1_5/Regress/regress-362583.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-383674.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Statement that implicitly calls toString should not be optimized away as a "useless expression": 1 reason: Expected value 'toString called', Actual value 'toString not called'
-TEST_ID=js1_5/Regress/regress-383674.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Statement that implicitly calls toString should not be optimized away as a "useless expression": 2 reason: Expected value 'toString called', Actual value 'toString not called'
-TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%H:%M") == Date.toLocaleFormat("%R") reason: Expected value '17:00', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%H:%M:%S") == Date.toLocaleFormat("%T") reason: Expected value '17:00:00', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%I:%M:%S %p") == Date.toLocaleFormat("%r") reason: Expected value '05:00:00 PM', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%H:%M") == Date.toLocaleFormat("%R") reason: Expected value '20:00', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%H:%M:%S") == Date.toLocaleFormat("%T") reason: Expected value '20:00:00', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%I:%M:%S %p") == Date.toLocaleFormat("%r") reason: Expected value '08:00:00 PM', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%C%y") == Date.toLocaleFormat("%Y") reason: Expected value 'Sat Jun 04 2005 `.``*`', Actual value '2005'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%H:%M") == Date.toLocaleFormat("%R") reason: Expected value '20:00', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%H:%M:%S") == Date.toLocaleFormat("%T") reason: Expected value '20:00:00', Actual value 'Sat Jun 04 2005 `.``*`'
+TEST_ID=js1_5/extensions/toLocaleFormat-02.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%I:%M:%S %p") == Date.toLocaleFormat("%r") reason: Expected value '08:00:00 PM', Actual value 'Sat Jun 04 2005 `.``*`'
 TEST_ID=js1_6/Array/regress-320887.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var x should not throw a ReferenceError reason: Expected value 'No error', Actual value 'ReferenceError: x is not defined'
 TEST_ID=js1_6/Array/regress-386030.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Array.reduce should ignore holes: 1 reason: Expected value 'PASS', Actual value 'FAIL, reduce'
 TEST_ID=js1_6/Array/regress-386030.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Array.reduce should ignore holes: 2 reason: Expected value 'PASS', Actual value 'FAIL, reduceRight'
 TEST_ID=js1_6/Regress/regress-353078.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not assert with bogus toString, map, split reason: Expected value 'TypeError: can't convert global to string', Actual value 'No Crash'
 TEST_ID=js1_7/block/regress-352422.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=let declaration must be direct child of block, top-level implicit block, or switch body block reason: Expected value 'SyntaxError', Actual value ''
 TEST_ID=js1_7/block/regress-352609.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=p = {}; (p.z = [let (x = 3, y = 4) x])() reason: Expected match to '/TypeError: (p.z = \[let \(x = 3, y = 4\) x\]|.*Array.*) is not a function/', Actual value 'TypeError: p.z = [(let (x = 3, y = 4) x)] is not a function'
 TEST_ID=js1_7/block/regress-352786.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=let declaration must be direct child of block, top-level implicit block, or switch body block reason: Expected value 'SyntaxError', Actual value ''
 TEST_ID=js1_7/block/regress-352907.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=let declaration must be direct child of block, top-level implicit block, or switch body block reason: Expected value 'SyntaxError', Actual value ''
 TEST_ID=js1_7/block/regress-376410.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=let declaration must be direct child of block, top-level implicit block, or switch body block reason: Expected value 'SyntaxError', Actual value ''
 TEST_ID=js1_7/decompilation/regress-346642-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 14 reason: Expected value ' function ( ) { while ( [ ] = e ) { } } ', Actual value ' function ( ) { while ( ( [ ] = e ) ) { } } '
 TEST_ID=js1_7/decompilation/regress-346642-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 15 reason: Expected value ' function ( ) { while ( [ ] = a ( b ) ) { } } ', Actual value ' function ( ) { while ( ( [ ] = a ( b ) ) ) { } } '
 TEST_ID=js1_7/decompilation/regress-350704.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of let nested in for reason: Expected value ' function ( ) { try { } catch ( y ) { for ( z ( let ( y = 3 ) 4 ) ;; ) { } } } ', Actual value ' function ( ) { try { } catch ( y ) { for ( z ( ( let ( y = 3 ) 4 ) ) ;; ) { } } } '
 TEST_ID=js1_7/decompilation/regress-352026.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of yield in argument lists reason: Expected value ' function f ( ) { g ( ( ( let ( a = b ) c ) , d ) , e ) ; } ', Actual value ' function f ( ) { g ( ( let ( a = b ) c , d ) , e ) ; } '
 TEST_ID=js1_7/decompilation/regress-352079.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of various operators reason: Expected value ' function ( ) { f ( let ( y = 3 ) 4 ) ++; } ', Actual value ' function ( ) { f ( ( let ( y = 3 ) 4 ) ) ++; } '
 TEST_ID=js1_7/decompilation/regress-352272.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of |let| in arg to lvalue returning function reason: Expected value ' function ( ) { f ( let ( y = 3 ) 4 ) ++; } ', Actual value ' function ( ) { f ( ( let ( y = 3 ) 4 ) ) ++; } '
+TEST_ID=js1_7/decompilation/regress-355786.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of for (a[b, this] in []) { } reason: Expected value ' function ( ) { for ( a [ b , this ] in [ ] ) { } } ', Actual value ' function ( ) { for ( let a [ ( b , this ) ] in [ ] ) { } } '
 TEST_ID=js1_7/decompilation/regress-355786.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of for (a[b, this] in []) { }: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: missing ; after for-loop initializer'
-TEST_ID=js1_7/decompilation/regress-355786.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of for (a[b, this] in []) { } reason: Expected value ' function ( ) { for ( a [ b , this ] in [ ] ) { } } ', Actual value ' function ( ) { for ( let a [ ( b , this ) ] in [ ] ) { } } '
 TEST_ID=js1_7/decompilation/regress-356247.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of let {} = [1] in a loop: g : (function() { for(let x in []) let {} = [1]; }) reason: Expected value ' function ( ) { for ( let x in [ ] ) let [ ] = [ 1 ] ; } ', Actual value ' function ( ) { for ( let x in [ ] ) { let [ ] = [ 1 ] ; } } '
 TEST_ID=js1_7/decompilation/regress-356247.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of let {} = [1] in a loop: g : (function() { while(0) let {} = [1]; }) reason: Expected value ' function ( ) { while ( 0 ) let [ ] = [ 1 ] ; } ', Actual value ' function ( ) { while ( 0 ) { let [ ] = [ 1 ] ; } } '
+TEST_ID=js1_7/decompilation/regress-375794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of array comprehension with catch guard reason: Expected value ' function ( ) { try { } catch ( a if [ b for each ( c in [ ] ) ] ) { } } ', Actual value ' function ( ) { try { } catch ( a if [ b for each ( [ ] in [ ] ) ] ) { } } '
 TEST_ID=js1_7/decompilation/regress-375794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of array comprehension with catch guard: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: invalid for/in left-hand side'
-TEST_ID=js1_7/decompilation/regress-375794.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of array comprehension with catch guard reason: Expected value ' function ( ) { try { } catch ( a if [ b for each ( c in [ ] ) ] ) { } } ', Actual value ' function ( ) { try { } catch ( a if [ b for each ( [ ] in [ ] ) ] ) { } } '
 TEST_ID=js1_7/decompilation/regress-380506.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of nested-for and for-if comprehensions reason: Expected value ' function ( ) { return [ i * i for ( i in [ 0 ] ) if ( i % 2 ) ] ; } ', Actual value ' function ( ) { return [ i * i for ( i in [ 0 ] ) ] ; } '
 TEST_ID=js1_7/decompilation/regress-380506.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of nested-for and for-if comprehensions reason: Expected value ' function ( ) { return [ i * j for ( i in [ 0 ] ) for ( j in [ 1 ] ) ] ; } ', Actual value ' function ( ) { return [ i * j for ( i in [ 0 ] ) ] ; } '
 TEST_ID=js1_7/decompilation/regress-381108.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of object literal should have space following : reason: Expected value 'true', Actual value 'false'
 TEST_ID=js1_7/decompilation/regress-429252.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=trap should not change decompilation of { let x }: after trap reason: Expected value ' function f ( ) { { let x ; } } ', Actual value ' function f ( ) { { let x ; } let x ; } '
 TEST_ID=js1_7/expressions/regress-421806.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/expressions/regress-421806.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/expressions/regress-421806.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/extensions/regress-351102-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/extensions/regress-351102-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/extensions/regress-351102-04.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/extensions/regress-351102-05.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/extensions/regress-351102-05.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/extensions/regress-351102-05.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/extensions/regress-367629.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of result with native function as getter reason: Expected value '({get h encodeURI() {[native code]}})', Actual value '({get h () {[native code]})'
+TEST_ID=js1_7/extensions/regress-368224.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/extensions/regress-368224.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: pnprop->pn_type == TOK_COLON, at `.``*`jsparse.c:
 TEST_ID=js1_7/extensions/regress-368224.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: pnprop->pn_type == TOK_COLON, at `.``*`jsparse.c:
-TEST_ID=js1_7/extensions/regress-368224.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/extensions/regress-368224.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/extensions/regress-368224.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
-TEST_ID=js1_7/extensions/regress-368224.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=; messages:
+TEST_ID=js1_7/extensions/regress-379566.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Keywords after get|set reason: Expected value ' ( { in getter : ( function ( ) { return this . for ; } ) , in setter : ( function ( value ) { this . for = value ; } ) } ) ', Actual value ' SyntaxError : missing : after property id '
 TEST_ID=js1_7/extensions/regress-379566.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Keywords after get|set: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: missing ; before statement'
-TEST_ID=js1_7/extensions/regress-379566.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Keywords after get|set reason: Expected value ' ( { in getter : ( function ( ) { return this . for ; } ) , in setter : ( function ( value ) { this . for = value ; } ) } ) ', Actual value ' SyntaxError : missing : after property id '
 TEST_ID=js1_7/extensions/regress-380933.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not assert with uneval object with setter with modified proto reason: Expected match to '/TypeError: Array.prototype.toSource called on incompatible Function/', Actual value 'No Error'
 TEST_ID=js1_7/extensions/regress-381301.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=uneval of object with native-function getter reason: Expected value ' ( { get x decodeURI ( ) { [ native code ] } } ) ', Actual value ' ( { get x ( ) { [ native code ] } ) '
 TEST_ID=js1_7/extensions/regress-381303.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=object toSource when a property has both a getter and a setter reason: Expected value ' ( { get inn ( ) { return this . for ; } , set inn ( value ) { this . for = value ; } } ) ', Actual value ' ( { get inn ( ) { return this [ ' for ' ] ; } , set inn ( value ) { this [ ' for ' ] = value ; } } ) '
 TEST_ID=js1_7/geniter/regress-347739.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=generator_instance.close readonly and immune: 2 reason: Expected value 'Inside finally: 1 Inside finally: 2 ', Actual value 'Inside finally: 2 '
 TEST_ID=js1_7/geniter/regress-349012-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/geniter/regress-349012-01.js:`.``*`: yield from closing generator function gen() {try {try {yield 1;} finally {actual += "Inner finally";yield 2;}} finally {actual += ",Outer finally";}}
 TEST_ID=js1_7/geniter/regress-349012-01.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=closing a generator fails to report error if yield during close is ignored reason: Expected value 'Inner finally,Outer finally', Actual value ''
 TEST_ID=js1_7/geniter/regress-349331.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=test GC-invoke close reason: Expected value 'true', Actual value 'false'
 TEST_ID=js1_7/iterable/regress-340526-02.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Iterators: cross-referenced objects with close handler can delay close handler execution reason: Expected value '2', Actual value '0'
-TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0400, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=-0700, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`Assertion failure: queue->handlerThread == PR_GetCurrentThread(), at `.``*`plevent.c:
+TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=2, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_7/iterable/regress-415922.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Support exception from withing JSNewEnumerateOp on JSENUMERATE_NEXT reason: Expected value 'Error: its enumeration failed', Actual value 'No exception r: color'
+TEST_ID=js1_7/lexical/regress-346642-03.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 8 reason: Expected value 'TypeError: ++x is not a function', Actual value 'TypeError: ++e1 is not a function'
 TEST_ID=js1_7/lexical/regress-346642-03.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 2 reason: Expected match to '/TypeError: x.t (has no properties|is undefined)/', Actual value 'TypeError: e1.t has no properties'
 TEST_ID=js1_7/lexical/regress-346642-03.js, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 2 reason: Expected match to '/TypeError: x.t (has no properties|is undefined)/', Actual value 'TypeError: e1.t is undefined'
-TEST_ID=js1_7/lexical/regress-346642-03.js, TEST_BRANCH=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 8 reason: Expected value 'TypeError: ++x is not a function', Actual value 'TypeError: ++e1 is not a function'
 TEST_ID=js1_7/lexical/regress-351515.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Invalid uses of yield, let keywords in js17: global: yield = 1 reason: Expected value 'SyntaxError: syntax error', Actual value 'SyntaxError: yield not in function'
 TEST_ID=js1_7/regexp/yflag.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/regexp/yflag.js:`.``*`: invalid flag after regular expression
 TEST_ID=js1_7/regexp/yflag.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_7/regexp/yflag.js:`.``*`: SyntaxError: invalid flag after regular expression
 TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-350387.js:`.``*`: x is not defined
 TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-350387.js:`.``*`: ReferenceError: x is not defined
 TEST_ID=js1_7/regress/regress-361566.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-361566.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-361566.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
+TEST_ID=js1_7/regress/regress-363040-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Test reduce of empty array without initializer. : TypeError: reduce of empty array with no initial value reason: Expected value 'TypeError: reduce of empty array with no initial value', Actual value 'TypeError: arr0elms.reduce is not a function'
+TEST_ID=js1_7/regress/regress-363040-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Test reduceRight of empty array without initializer. : TypeError: reduce of empty array with no initial value reason: Expected value 'TypeError: reduce of empty array with no initial value', Actual value 'TypeError: arr0elms.reduceRight is not a function'
 TEST_ID=js1_7/regress/regress-363040-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-363040-01.js:`.``*`: arr0elms.reduce is not a function
 TEST_ID=js1_7/regress/regress-363040-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=Test reduceRight of empty array without initializer. : TypeError: reduce of empty array with no initial value reason: Expected value 'TypeError: reduce of empty array with no initial value', Actual value 'TypeError: arr0elms.reduceRight is not a function';
-TEST_ID=js1_7/regress/regress-363040-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Test reduce of empty array without initializer. : TypeError: reduce of empty array with no initial value reason: Expected value 'TypeError: reduce of empty array with no initial value', Actual value 'TypeError: arr0elms.reduce is not a function'
-TEST_ID=js1_7/regress/regress-363040-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Test reduceRight of empty array without initializer. : TypeError: reduce of empty array with no initial value reason: Expected value 'TypeError: reduce of empty array with no initial value', Actual value 'TypeError: arr0elms.reduceRight is not a function'
 TEST_ID=js1_7/regress/regress-363040-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-363040-02.js:`.``*`: arr.reduce is not a function
 TEST_ID=js1_7/regress/regress-363040-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-363040-02.js:`.``*`: TypeError: arr.reduce is not a function
-TEST_ID=js1_7/regress/regress-372331.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*` uncaught exception: for-in binds name to early
-TEST_ID=js1_7/regress/regress-372331.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*` uncaught exception: for-in binds name to early
+TEST_ID=js1_7/regress/regress-372331.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: for-in binds name to early
+TEST_ID=js1_7/regress/regress-372331.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`uncaught exception: for-in binds name to early
 TEST_ID=js1_7/regress/regress-373827-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: OBJ_GET_CLASS(cx, obj) == &js_BlockClass, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-373827-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: OBJ_GET_CLASS(cx, obj) == &js_BlockClass, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-373827-01.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/regress/regress-373827-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: OBJ_GET_CLASS(cx, obj) == &js_BlockClass, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-373827-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: OBJ_GET_CLASS(cx, obj) == &js_BlockClass, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-373827-02.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/regress/regress-373828.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: op == JSOP_LEAVEBLOCKEXPR ? fp->spbase + OBJ_BLOCK_DEPTH(cx, obj) == sp - 1 : fp->spbase + OBJ_BLOCK_DEPTH(cx, obj) == sp, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-373828.js, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: op == JSOP_LEAVEBLOCKEXPR ? fp->spbase + OBJ_BLOCK_DEPTH(cx, obj) == sp - 1 : fp->spbase + OBJ_BLOCK_DEPTH(cx, obj) == sp, at `.``*`jsinterp.c:
diff --git a/js/tests/shell.js b/js/tests/shell.js
--- a/js/tests/shell.js
+++ b/js/tests/shell.js
@@ -227,32 +227,75 @@ function toPrinted(value)
   if (typeof value == "xml") 
   {
     value = value.toXMLString();
   } 
   else 
   {
     value = String(value);
   }
-  value = value.replace(/\\n/g, 'NL').replace(/\n/g, 'NL').replace(/\\r/g, 'CR');
+  value = value.replace(/\\n/g, 'NL')
+               .replace(/\n/g, 'NL')
+               .replace(/\\r/g, 'CR')
+               .replace(/[^\x20-\x7E]+/g, escapeString);
   return value;
+}
+
+function escapeString (str)
+{
+  var a, b, c, d;
+  var len = str.length;
+  var result = "";
+  var digits = ["0", "1", "2", "3", "4", "5", "6", "7",
+                "8", "9", "A", "B", "C", "D", "E", "F"];
+
+  for (var i=0; i<len; i++)
+  {
+    var ch = str.charCodeAt(i);
+
+    a = digits[ch & 0xf];
+    ch >>= 4;
+    b = digits[ch & 0xf];
+    ch >>= 4;
+
+    if (ch)
+    {
+      c = digits[ch & 0xf];
+      ch >>= 4;
+      d = digits[ch & 0xf];
+
+      result += "\\u" + d + c + b + a;
+    }
+    else
+    {
+      result += "\\x" + b + a;
+    }
+  }
+
+  return result;
 }
 
 /*
  * Compare expected result to actual result, if they differ (in value and/or
  * type) report a failure.  If description is provided, include it in the
  * failure report.
  */
 function reportCompare (expected, actual, description) {
   var expected_t = typeof expected;
   var actual_t = typeof actual;
   var output = "";
-   
-  if ((VERBOSE) && (typeof description != "undefined"))
+
+  if (typeof description == "undefined")
+  {
+    description = '';
+  }
+  else if (VERBOSE)
+  {
     printStatus ("Comparing '" + description + "'");
+  }
 
   if (expected_t != actual_t)
   {
     output += "Type mismatch, expected type " + expected_t +
       ", actual type " + actual_t + " ";
   }
   else if (VERBOSE)
   {
@@ -266,47 +309,50 @@ function reportCompare (expected, actual
       "', Actual value '" + toPrinted(actual) + "' ";
   }
   else if (VERBOSE)
   {
     printStatus ("Expected value '" + toPrinted(expected) +
                  "' matched actual value '" + toPrinted(actual) + "'");
   }
 
-  if (typeof description == "undefined")
-    description = '';
-   
   var testcase = new TestCase(gTestfile, description, expected, actual);
   testcase.reason = output;
- 
+
   if (testcase.passed)
   {
-    print('PASSED! ' + description);
+    print(PASSED + description);
   }
   else
   {
-    reportFailure (output);  
+    reportFailure (description + " : " + output);
   }
 
   return testcase.passed;
 }
 
 /*
  * Attempt to match a regular expression describing the result to
  * the actual result, if they differ (in value and/or
  * type) report a failure.  If description is provided, include it in the
  * failure report.
  */
 function reportMatch (expectedRegExp, actual, description) {
   var expected_t = "string";
   var actual_t = typeof actual;
   var output = "";
 
-  if ((VERBOSE) && (typeof description != "undefined"))
+  if (typeof description == "undefined")
+  {
+    description = '';
+  }
+  else if (VERBOSE)
+  {
     printStatus ("Comparing '" + description + "'");
+  }
 
   if (expected_t != actual_t)
   {
     output += "Type mismatch, expected type " + expected_t +
       ", actual type " + actual_t + " ";
   }
   else if (VERBOSE)
   {
@@ -321,29 +367,26 @@ function reportMatch (expectedRegExp, ac
       "', Actual value '" + toPrinted(actual) + "' ";
   }
   else if (VERBOSE)
   {
     printStatus ("Expected match to '" + toPrinted(expectedRegExp) +
                  "' matched actual value '" + toPrinted(actual) + "'");
   }
 
-  if (typeof description == "undefined")
-    description = '';
-
   var testcase = new TestCase(gTestfile, description, true, matches);
   testcase.reason = output;
 
   if (testcase.passed)
   {
-    print('PASSED! ' + description);
+    print(PASSED + description);
   }
   else
   {
-    reportFailure (output);
+    reportFailure (description + " : " + output);
   }
 
   return testcase.passed;
 }
 
 /*
  * Puts funcName at the top of the call stack.  This stack is used to show
  * a function-reported-from field when reporting failures.
diff --git a/js/tests/universe.data b/js/tests/universe.data
--- a/js/tests/universe.data
+++ b/js/tests/universe.data
@@ -1,16 +1,20 @@ TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=8.11.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
@@ -29,32 +33,72 @@ TEST_OS=darwin, TEST_KERNEL=9.3.0, TEST_
 TEST_OS=darwin, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.3.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=1, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
@@ -77,24 +121,60 @@ TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.22, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=3, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=3, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=3, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=3, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=3, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=3, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=3, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.25, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=3, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.8.1, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=nt, TEST_KERNEL=6.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=nt, TEST_KERNEL=6.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=nt, TEST_KERNEL=6.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=nt, TEST_KERNEL=6.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0400, TEST_BRANCH=1.9.0, TEST_BUILDTYPE=opt, TEST_TYPE=shell
diff --git a/layout/base/nsCSSFrameConstructor.cpp b/layout/base/nsCSSFrameConstructor.cpp
--- a/layout/base/nsCSSFrameConstructor.cpp
+++ b/layout/base/nsCSSFrameConstructor.cpp
@@ -1122,17 +1122,17 @@ private:
   nsIAtom* mChildListName;
   nsFrameConstructorState* mState;
 
   friend class nsFrameConstructorState;
 };
 
 // Structure used for maintaining state information during the
 // frame construction process
-class nsFrameConstructorState {
+class NS_STACK_CLASS nsFrameConstructorState {
 public:
   nsPresContext            *mPresContext;
   nsIPresShell             *mPresShell;
   nsFrameManager           *mFrameManager;
 
 #ifdef MOZ_XUL
   // The root box, if any.
   nsIRootBox*               mRootBox;
@@ -1726,17 +1726,17 @@ MoveChildrenTo(nsFrameManager*          
   }
 }
 
 // -----------------------------------------------------------
 
 
 // Structure used to ensure that bindings are properly enqueued in the
 // binding manager's attached queue.
-struct nsAutoEnqueueBinding
+struct NS_STACK_CLASS nsAutoEnqueueBinding
 {
   nsAutoEnqueueBinding(nsIDocument* aDocument) :
     mDocument(aDocument)
   {}
 
   ~nsAutoEnqueueBinding();
 
   nsRefPtr<nsXBLBinding> mBinding;
diff --git a/layout/base/nsChildIterator.h b/layout/base/nsChildIterator.h
--- a/layout/base/nsChildIterator.h
+++ b/layout/base/nsChildIterator.h
@@ -47,17 +47,17 @@
 #include "nsIDOMNode.h"
 
 /**
  * Helper class for iterating children during frame construction.
  * This class should always be used in lieu of the straight content
  * node APIs, since it handles XBL-generated anonymous content as
  * well.
  */
-class ChildIterator
+class NS_STACK_CLASS ChildIterator
 {
 protected:
   nsCOMPtr<nsIContent> mContent;
   PRUint32 mIndex;
   nsCOMPtr<nsIDOMNodeList> mNodes;
 
 public:
   ChildIterator()
diff --git a/layout/base/nsDisplayList.h b/layout/base/nsDisplayList.h
--- a/layout/base/nsDisplayList.h
+++ b/layout/base/nsDisplayList.h
@@ -112,17 +112,17 @@ class nsDisplayTableItem;
  * This manages a display list and is passed as a parameter to
  * nsIFrame::BuildDisplayList.
  * It contains the parameters that don't change from frame to frame and manages
  * the display list memory using a PLArena. It also establishes the reference
  * coordinate system for all display list items. Some of the parameters are
  * available from the prescontext/presshell, but we copy them into the builder
  * for faster/more convenient access.
  */
-class nsDisplayListBuilder {
+class NS_STACK_CLASS nsDisplayListBuilder {
 public:
   /**
    * @param aReferenceFrame the frame at the root of the subtree; its origin
    * is the origin of the reference coordinate system for this display list
    * @param aIsForEvents PR_TRUE if we're creating this list in order to
    * determine which frame is under the mouse position
    * @param aBuildCaret whether or not we should include the caret in any
    * display lists that we make.
diff --git a/layout/base/nsICaret.h b/layout/base/nsICaret.h
--- a/layout/base/nsICaret.h
+++ b/layout/base/nsICaret.h
@@ -199,17 +199,17 @@ NS_DEFINE_STATIC_IID_ACCESSOR(nsICaret, 
 NS_DEFINE_STATIC_IID_ACCESSOR(nsICaret, NS_ICARET_IID)
 
 nsresult
 NS_NewCaret(nsICaret** aInstancePtrResult);
 
 
 // handy stack-based class for temporarily disabling the caret
 
-class StCaretHider
+class NS_STACK_CLASS StCaretHider
 {
 public:
                StCaretHider(nsICaret* aSelCon)
                : mWasVisible(PR_FALSE), mCaret(aSelCon)
                {
                  if (mCaret)
                  {
                    mCaret->GetCaretVisible(&mWasVisible);
diff --git a/layout/base/nsPresShell.cpp b/layout/base/nsPresShell.cpp
--- a/layout/base/nsPresShell.cpp
+++ b/layout/base/nsPresShell.cpp
@@ -1232,17 +1232,17 @@ public:
     else {
       nsContentUtils::RemoveScriptBlocker();
     }
   }
 
   PresShell* mShell;
 };
 
-class nsPresShellEventCB : public nsDispatchingCallback
+class NS_STACK_CLASS nsPresShellEventCB : public nsDispatchingCallback
 {
 public:
   nsPresShellEventCB(PresShell* aPresShell) : mPresShell(aPresShell) {}
 
   virtual void HandleEvent(nsEventChainPostVisitor& aVisitor)
   {
     if (aVisitor.mPresContext && aVisitor.mEvent->eventStructType != NS_EVENT) {
       nsIFrame* frame = mPresShell->GetCurrentEventFrame();
diff --git a/layout/generic/nsFrame.cpp b/layout/generic/nsFrame.cpp
--- a/layout/generic/nsFrame.cpp
+++ b/layout/generic/nsFrame.cpp
@@ -2330,17 +2330,17 @@ NS_IMETHODIMP nsFrame::HandleRelease(nsP
 
   return selectionOff
     ? NS_OK
     : HandleFrameSelection(frameselection, offsets, handleTableSelection,
                            contentOffsetForTableSel, targetForTableSel,
                            parentContent, aEvent, aEventStatus);
 }
 
-struct FrameContentRange {
+struct NS_STACK_CLASS FrameContentRange {
   FrameContentRange(nsIContent* aContent, PRInt32 aStart, PRInt32 aEnd) :
     content(aContent), start(aStart), end(aEnd) { }
   nsCOMPtr<nsIContent> content;
   PRInt32 start;
   PRInt32 end;
 };
 
 // Retrieve the content offsets of a frame
diff --git a/layout/generic/nsFrameSelection.h b/layout/generic/nsFrameSelection.h
--- a/layout/generic/nsFrameSelection.h
+++ b/layout/generic/nsFrameSelection.h
@@ -72,17 +72,17 @@ class nsIPresShell;
 class nsIPresShell;
 
 enum EWordMovementType { eStartWord, eEndWord, eDefaultBehavior };
 
 /** PeekOffsetStruct is used to group various arguments (both input and output)
  *  that are passed to nsFrame::PeekOffset(). See below for the description of
  *  individual arguments.
  */
-struct nsPeekOffsetStruct
+struct NS_STACK_CLASS nsPeekOffsetStruct
 {
   void SetData(nsSelectionAmount aAmount,
                nsDirection aDirection,
                PRInt32 aStartOffset,
                nscoord aDesiredX,
                PRBool aJumpLines,
                PRBool aScrollViewStop,
                PRBool aIsKeyboardSelect,
diff --git a/layout/generic/nsIFrame.h b/layout/generic/nsIFrame.h
--- a/layout/generic/nsIFrame.h
+++ b/layout/generic/nsIFrame.h
@@ -940,17 +940,17 @@ public:
   // a point; there is a primary and a secondary offset associated with any
   // point.  The primary and secondary offsets differ when the point is over a
   // non-text object.  The primary offset is the expected position of the
   // cursor calculated from a point; the secondary offset, when it is different,
   // indicates that the point is in the boundaries of some selectable object.
   // Note that the primary offset can be after the secondary offset; for places
   // that need the beginning and end of the object, the StartOffset and 
   // EndOffset helpers can be used.
-  struct ContentOffsets {
+  struct NS_STACK_CLASS ContentOffsets {
     nsCOMPtr<nsIContent> content;
     PRBool IsNull() { return !content; }
     PRInt32 offset;
     PRInt32 secondaryOffset;
     // Helpers for places that need the ends of the offsets and expect them in
     // numerical order, as opposed to wanting the primary and secondary offsets
     PRInt32 StartOffset() { return PR_MIN(offset, secondaryOffset); }
     PRInt32 EndOffset() { return PR_MAX(offset, secondaryOffset); }
@@ -973,17 +973,17 @@ public:
                                                             PRBool aIgnoreSelectionStyle = PR_FALSE)
   { return GetContentOffsetsFromPoint(aPoint, aIgnoreSelectionStyle); }
 
   /**
    * This structure holds information about a cursor. mContainer represents a
    * loaded image that should be preferred. If it is not possible to use it, or
    * if it is null, mCursor should be used.
    */
-  struct Cursor {
+  struct NS_STACK_CLASS Cursor {
     nsCOMPtr<imgIContainer> mContainer;
     PRInt32                 mCursor;
     PRBool                  mHaveHotspot;
     float                   mHotspotX, mHotspotY;
   };
   /**
    * Get the cursor for a given frame.
    */
diff --git a/layout/generic/nsLineBox.h b/layout/generic/nsLineBox.h
--- a/layout/generic/nsLineBox.h
+++ b/layout/generic/nsLineBox.h
@@ -597,54 +597,54 @@ class nsLineList_iterator {
     {
       iterator_self_type rv(*this);
       mCurrent = mCurrent->_mPrev;
       return rv;
     }
 
     reference operator*()
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return *static_cast<pointer>(mCurrent);
     }
 
     pointer operator->()
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return static_cast<pointer>(mCurrent);
     }
 
     pointer get()
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return static_cast<pointer>(mCurrent);
     }
 
     operator pointer()
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return static_cast<pointer>(mCurrent);
     }
 
     const_reference operator*() const
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return *static_cast<const_pointer>(mCurrent);
     }
 
     const_pointer operator->() const
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return static_cast<const_pointer>(mCurrent);
     }
 
 #ifndef __MWERKS__
     operator const_pointer() const
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return static_cast<const_pointer>(mCurrent);
     }
 #endif /* !__MWERKS__ */
 
     iterator_self_type next()
     {
       iterator_self_type copy(*this);
       return ++copy;
@@ -756,54 +756,54 @@ class nsLineList_reverse_iterator {
     {
       iterator_self_type rv(*this);
       mCurrent = mCurrent->_mNext;
       return rv;
     }
 
     reference operator*()
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return *static_cast<pointer>(mCurrent);
     }
 
     pointer operator->()
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return static_cast<pointer>(mCurrent);
     }
 
     pointer get()
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return static_cast<pointer>(mCurrent);
     }
 
     operator pointer()
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return static_cast<pointer>(mCurrent);
     }
 
     const_reference operator*() const
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return *static_cast<const_pointer>(mCurrent);
     }
 
     const_pointer operator->() const
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return static_cast<const_pointer>(mCurrent);
     }
 
 #ifndef __MWERKS__
     operator const_pointer() const
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return static_cast<const_pointer>(mCurrent);
     }
 #endif /* !__MWERKS__ */
 
     // Passing by value rather than by reference and reference to const
     // to keep AIX happy.
     PRBool operator==(const iterator_self_type aOther) const
     {
@@ -896,36 +896,36 @@ class nsLineList_const_iterator {
     {
       iterator_self_type rv(*this);
       mCurrent = mCurrent->_mPrev;
       return rv;
     }
 
     const_reference operator*() const
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return *static_cast<const_pointer>(mCurrent);
     }
 
     const_pointer operator->() const
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return static_cast<const_pointer>(mCurrent);
     }
 
     const_pointer get() const
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return static_cast<const_pointer>(mCurrent);
     }
 
 #ifndef __MWERKS__
     operator const_pointer() const
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return static_cast<const_pointer>(mCurrent);
     }
 #endif /* !__MWERKS__ */
 
     const iterator_self_type next() const
     {
       iterator_self_type copy(*this);
       return ++copy;
@@ -1030,36 +1030,36 @@ class nsLineList_const_reverse_iterator 
     {
       iterator_self_type rv(*this);
       mCurrent = mCurrent->_mNext;
       return rv;
     }
 
     const_reference operator*() const
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return *static_cast<const_pointer>(mCurrent);
     }
 
     const_pointer operator->() const
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return static_cast<const_pointer>(mCurrent);
     }
 
     const_pointer get() const
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return static_cast<const_pointer>(mCurrent);
     }
 
 #ifndef __MWERKS__
     operator const_pointer() const
     {
-      NS_ASSERTION(mCurrent != mListLink, "running past end");
+      NS_ABORT_IF_FALSE(mCurrent != mListLink, "running past end");
       return static_cast<const_pointer>(mCurrent);
     }
 #endif /* !__MWERKS__ */
 
     // Passing by value rather than by reference and reference to const
     // to keep AIX happy.
     PRBool operator==(const iterator_self_type aOther) const
     {
diff --git a/layout/generic/nsObjectFrame.cpp b/layout/generic/nsObjectFrame.cpp
--- a/layout/generic/nsObjectFrame.cpp
+++ b/layout/generic/nsObjectFrame.cpp
@@ -855,16 +855,18 @@ nsObjectFrame::InstantiatePlugin(nsIPlug
                                                 mInstanceOwner);
     if (NS_SUCCEEDED(rv))
       pDoc->SetStreamListener(stream);
   } else {   /* embedded mode */
     rv = aPluginHost->InstantiateEmbeddedPlugin(aMimeType, aURI,
                                                 mInstanceOwner);
   }
 
+  // Note that |this| may very well be destroyed already!
+
   if (appShell) {
     appShell->ResumeNative();
   }
 
   return rv;
 }
 
 void
@@ -1593,17 +1595,18 @@ nsObjectFrame::HandleEvent(nsPresContext
   default:
     // instead of using an event listener, we can dispatch events to plugins directly.
     rv = nsObjectFrameSuper::HandleEvent(aPresContext, anEvent, anEventStatus);
   }
 
   return rv;
 }
 
-nsresult nsObjectFrame::GetPluginInstance(nsIPluginInstance*& aPluginInstance)
+nsresult
+nsObjectFrame::GetPluginInstance(nsIPluginInstance*& aPluginInstance)
 {
   aPluginInstance = nsnull;
 
   if (!mInstanceOwner)
     return NS_OK;
   
   return mInstanceOwner->GetInstance(aPluginInstance);
 }
@@ -1650,19 +1653,26 @@ nsObjectFrame::Instantiate(nsIChannel* a
   nsCOMPtr<nsIPluginHost> pluginHost(do_GetService(kCPluginManagerCID, &rv));
   if (NS_FAILED(rv))
     return rv;
   mInstanceOwner->SetPluginHost(pluginHost);
 
   // This must be done before instantiating the plugin
   FixupWindow(mRect.Size());
 
+  nsWeakFrame weakFrame(this);
+
   NS_ASSERTION(!mPreventInstantiation, "Say what?");
   mPreventInstantiation = PR_TRUE;
   rv = pluginHost->InstantiatePluginForChannel(aChannel, mInstanceOwner, aStreamListener);
+
+  if (!weakFrame.IsAlive()) {
+    return NS_ERROR_NOT_AVAILABLE;
+  }
+
   NS_ASSERTION(mPreventInstantiation,
                "Instantiation should still be prevented!");
   mPreventInstantiation = PR_FALSE;
 
   return rv;
 }
 
 nsresult
@@ -1678,32 +1688,43 @@ nsObjectFrame::Instantiate(const char* a
 
   NS_ASSERTION(aMimeType || aURI, "Need a type or a URI!");
 
   // Note: If PrepareInstanceOwner() returns an error, |this| may very
   // well be deleted already.
   nsresult rv = PrepareInstanceOwner();
   NS_ENSURE_SUCCESS(rv, rv);
 
+  nsWeakFrame weakFrame(this);
+
   // This must be done before instantiating the plugin
   FixupWindow(mRect.Size());
 
   // get the nsIPluginHost service
   nsCOMPtr<nsIPluginHost> pluginHost(do_GetService(kCPluginManagerCID, &rv));
   if (NS_FAILED(rv))
     return rv;
   mInstanceOwner->SetPluginHost(pluginHost);
 
   mPreventInstantiation = PR_TRUE;
 
   rv = InstantiatePlugin(pluginHost, aMimeType, aURI);
+
+  if (!weakFrame.IsAlive()) {
+    return NS_ERROR_NOT_AVAILABLE;
+  }
 
   // finish up
   if (NS_SUCCEEDED(rv)) {
     TryNotifyContentObjectWrapper();
+
+    if (!weakFrame.IsAlive()) {
+      return NS_ERROR_NOT_AVAILABLE;
+    }
+
     CallSetWindow();
   }
 
   NS_ASSERTION(mPreventInstantiation,
                "Instantiation should still be prevented!");
 
   mPreventInstantiation = PR_FALSE;
 
diff --git a/layout/generic/nsPageFrame.cpp b/layout/generic/nsPageFrame.cpp
--- a/layout/generic/nsPageFrame.cpp
+++ b/layout/generic/nsPageFrame.cpp
@@ -554,17 +554,22 @@ nsPageFrame::PaintPageContent(nsIRenderi
   // Note: this computation matches how we compute maxSize.height
   // in nsPageFrame::Reflow
   nscoord expectedPageContentHeight = 
     NSToCoordCeil((GetSize().height - mPD->mReflowMargin.TopBottom()) / scale);
   if (clipRect.height > expectedPageContentHeight) {
     // We're doing print-selection, with one long page-content frame.
     // Clip to the appropriate page-content slice for the current page.
     NS_ASSERTION(mPageNum > 0, "page num should be positive");
-    clipRect.y =  expectedPageContentHeight * (mPageNum - 1);
+    // Note: The pageContentFrame's y-position has been set such that a zero
+    // y-value matches the top edge of the current page.  So, to clip to the
+    // current page's content (in coordinates *relative* to the page content
+    // frame), we just negate its y-position and add the top margin.
+    clipRect.y = NSToCoordCeil((-pageContentFrame->GetRect().y + 
+                                mPD->mReflowMargin.top) / scale);
     clipRect.height = expectedPageContentHeight;
     NS_ASSERTION(clipRect.y < pageContentFrame->GetSize().height,
                  "Should be clipping to region inside the page content bounds");
   }
   aRenderingContext.SetClipRect(clipRect, nsClipCombine_kIntersect);
 
   const nsStyleBorder* border = GetStyleBorder();
   const nsStylePadding* padding = GetStylePadding();
diff --git a/layout/generic/nsSelection.cpp b/layout/generic/nsSelection.cpp
--- a/layout/generic/nsSelection.cpp
+++ b/layout/generic/nsSelection.cpp
@@ -376,26 +376,26 @@ private:
   CachedOffsetForFrame *mCachedOffsetForFrame;
   nsDirection mDirection;
   SelectionType mType;
   PRPackedBool mTrueDirection;
   PRPackedBool mFixupState;
 };
 
 // Stack-class to turn on/off selection batching for table selection
-class nsSelectionBatcher
+class NS_STACK_CLASS NS_FINAL_CLASS nsSelectionBatcher
 {
 private:
   nsCOMPtr<nsISelectionPrivate> mSelection;
 public:
   nsSelectionBatcher(nsISelectionPrivate *aSelection) : mSelection(aSelection)
   {
     if (mSelection) mSelection->StartBatchChanges();
   }
-  virtual ~nsSelectionBatcher() 
+  ~nsSelectionBatcher() 
   { 
     if (mSelection) mSelection->EndBatchChanges();
   }
 };
 
 class nsSelectionIterator : public nsIBidirectionalEnumerator
 {
 public:
diff --git a/layout/generic/nsTextFrameThebes.cpp b/layout/generic/nsTextFrameThebes.cpp
--- a/layout/generic/nsTextFrameThebes.cpp
+++ b/layout/generic/nsTextFrameThebes.cpp
@@ -1972,17 +1972,17 @@ static PRBool IsInBounds(const gfxSkipCh
   if (aContentLength == PR_INT32_MAX)
     return PR_TRUE;
   gfxSkipCharsIterator iter(aStart);
   iter.AdvanceOriginal(aContentLength);
   return iter.GetSkippedOffset() >= aOffset + aLength;
 }
 #endif
 
-class PropertyProvider : public gfxTextRun::PropertyProvider {
+class NS_STACK_CLASS PropertyProvider : public gfxTextRun::PropertyProvider {
 public:
   /**
    * Use this constructor for reflow, when we don't know what text is
    * really mapped by the frame and we have a lot of other data around.
    * 
    * @param aLength can be PR_INT32_MAX to indicate we cover all the text
    * associated with aFrame up to where its flow chain ends in the given
    * textrun. If PR_INT32_MAX is passed, justification and hyphen-related methods
@@ -4705,17 +4705,17 @@ nsTextFrame::PeekOffsetNoAmount(PRBool a
 /**
  * This class iterates through the clusters before or after the given
  * aPosition (which is a content offset). You can test each cluster
  * to see if it's whitespace (as far as selection/caret movement is concerned),
  * or punctuation, or if there is a word break before the cluster. ("Before"
  * is interpreted according to aDirection, so if aDirection is -1, "before"
  * means actually *after* the cluster content.)
  */
-class ClusterIterator {
+class NS_STACK_CLASS ClusterIterator {
 public:
   ClusterIterator(nsTextFrame* aTextFrame, PRInt32 aPosition, PRInt32 aDirection,
                   nsString& aContext);
 
   PRBool NextCluster();
   PRBool IsWhitespace();
   PRBool IsPunctuation();
   PRBool HaveWordBreakBefore() { return mHaveWordBreak; }
@@ -4988,57 +4988,87 @@ NS_IMETHODIMP
 NS_IMETHODIMP
 nsTextFrame::GetOffsets(PRInt32 &start, PRInt32 &end) const
 {
   start = GetContentOffset();
   end = GetContentEnd();
   return NS_OK;
 }
 
+static PRInt32
+FindEndOfPunctuationRun(const nsTextFragment* aFrag,
+                        gfxTextRun* aTextRun,
+                        gfxSkipCharsIterator* aIter,
+                        PRInt32 aOffset,
+                        PRInt32 aStart,
+                        PRInt32 aEnd)
+{
+  PRInt32 i;
+
+  for (i = aStart; i < aEnd - aOffset; ++i) {
+    if (nsContentUtils::IsPunctuationMarkAt(aFrag, aOffset + i)) {
+      aIter->SetOriginalOffset(aOffset + i);
+      FindClusterEnd(aTextRun, aEnd, aIter);
+      i = aIter->GetOriginalOffset() - aOffset;
+    } else {
+      break;
+    }
+  }
+  return i;
+}
+
 /**
  * Returns PR_TRUE if this text frame completes the first-letter, PR_FALSE
  * if it does not contain a true "letter".
  * If returns PR_TRUE, then it also updates aLength to cover just the first-letter
  * text.
  *
  * XXX :first-letter should be handled during frame construction
  * (and it has a good bit in common with nextBidi)
  * 
  * @param aLength an in/out parameter: on entry contains the maximum length to
  * return, on exit returns length of the first-letter fragment (which may
- * include leading punctuation, for example)
+ * include leading and trailing punctuation, for example)
  */
 static PRBool
 FindFirstLetterRange(const nsTextFragment* aFrag,
                      gfxTextRun* aTextRun,
                      PRInt32 aOffset, const gfxSkipCharsIterator& aIter,
                      PRInt32* aLength)
 {
-  // Find first non-whitespace, non-punctuation cluster, and stop after it
   PRInt32 i;
   PRInt32 length = *aLength;
-  for (i = 0; i < length; ++i) {
-    if (!IsTrimmableSpace(aFrag, aOffset + i) &&
-        !nsContentUtils::IsPunctuationMark(aFrag->CharAt(aOffset + i)))
-      break;
-  }
-
+  PRInt32 endOffset = aOffset + length;
+  gfxSkipCharsIterator iter(aIter);
+
+  // skip leading whitespace, then consume clusters that start with punctuation
+  i = FindEndOfPunctuationRun(aFrag, aTextRun, &iter, aOffset, 
+                              GetTrimmableWhitespaceCount(aFrag, aOffset, length, 1),
+                              endOffset);
   if (i == length)
     return PR_FALSE;
 
-  // Advance to the end of the cluster
-  gfxSkipCharsIterator iter(aIter);
-  PRInt32 nextClusterStart;
-  for (nextClusterStart = i + 1; nextClusterStart < length; ++nextClusterStart) {
-    iter.SetOriginalOffset(aOffset + nextClusterStart);
-    if (iter.IsOriginalCharSkipped() ||
-        aTextRun->IsClusterStart(iter.GetSkippedOffset()))
-      break;
-  }
-  *aLength = nextClusterStart;
+  // If the next character is not a letter or number, there is no first-letter.
+  // Return PR_TRUE so that we don't go on looking, but set aLength to 0.
+  if (!nsContentUtils::IsAlphanumericAt(aFrag, aOffset + i)) {
+    *aLength = 0;
+    return PR_TRUE;
+  }
+
+  // consume another cluster (the actual first letter)
+  iter.SetOriginalOffset(aOffset + i);
+  FindClusterEnd(aTextRun, endOffset, &iter);
+  i = iter.GetOriginalOffset() - aOffset;
+  if (i + 1 == length)
+    return PR_TRUE;
+
+  // consume clusters that start with punctuation
+  i = FindEndOfPunctuationRun(aFrag, aTextRun, &iter, aOffset, i + 1, endOffset);
+  if (i < length)
+    *aLength = i;
   return PR_TRUE;
 }
 
 static PRUint32
 FindStartAfterSkippingWhitespace(PropertyProvider* aProvider,
                                  nsIFrame::InlineIntrinsicWidthData* aData,
                                  PRBool aCollapseWhitespace,
                                  gfxSkipCharsIterator* aIterator,
@@ -5516,18 +5546,20 @@ nsTextFrame::Reflow(nsPresContext*      
 
   NS_ASSERTION(gfxSkipCharsIterator(iter).ConvertOriginalToSkipped(offset + length)
                     <= mTextRun->GetLength(),
                "Text run does not map enough text for our reflow");
 
   // Restrict to just the first-letter if necessary
   PRBool completedFirstLetter = PR_FALSE;
   if (lineLayout.GetFirstLetterStyleOK()) {
-    AddStateBits(TEXT_FIRST_LETTER);
     completedFirstLetter = FindFirstLetterRange(frag, mTextRun, offset, iter, &length);
+    if (length) {
+      AddStateBits(TEXT_FIRST_LETTER);
+    }
   }
 
   /////////////////////////////////////////////////////////////////////
   // See how much text should belong to this text frame, and measure it
   /////////////////////////////////////////////////////////////////////
   
   iter.SetOriginalOffset(offset);
   nscoord xOffsetForTabs = (mTextRun->GetFlags() & nsTextFrameUtils::TEXT_HAS_TAB) ?
@@ -5677,17 +5709,20 @@ nsTextFrame::Reflow(nsPresContext*      
     textMetrics.mAscent = PR_MAX(0, -textMetrics.mBoundingBox.Y());
     textMetrics.mDescent = PR_MAX(0, textMetrics.mBoundingBox.YMost());
   }
 
   // Setup metrics for caller
   // Disallow negative widths
   aMetrics.width = NSToCoordCeil(PR_MAX(0, textMetrics.mAdvanceWidth));
 
-  if (needTightBoundingBox) {
+  if (transformedCharsFit == 0) {
+    aMetrics.ascent = 0;
+    aMetrics.height = 0;
+  } else if (needTightBoundingBox) {
     // Use actual text metrics for floating first letter frame.
     aMetrics.ascent = NSToCoordCeil(textMetrics.mAscent);
     aMetrics.height = aMetrics.ascent + NSToCoordCeil(textMetrics.mDescent);
   } else {
     // Otherwise, ascent should contain the overline drawable area.
     // And also descent should contain the underline drawable area.
     // nsIFontMetrics::GetMaxAscent/GetMaxDescent contains them.
     nscoord fontAscent, fontDescent;
diff --git a/layout/generic/punct_marks.ccmap b/layout/generic/punct_marks.x-ccmap
rename from layout/generic/punct_marks.ccmap
rename to layout/generic/punct_marks.x-ccmap
--- a/layout/generic/punct_marks.ccmap
+++ b/layout/generic/punct_marks.x-ccmap
@@ -47,46 +47,44 @@
   listing characters (one character per line) you want to put 
   into "punct_marks" in the format
 
          0xuuuu // comment
 
   In addition, the input file can have the following optional lines that
   read
 
-      VARIABLE::gPuncCharsCCMap
+      VARIABLE::gPuncCharsCCMapExt
       CLASS::punct_marks
       DESCRIPTION:: description of a character class 
       FILE:: mozilla source file to include the output file
       
 
   Then, run the following in the current directory.
 
-    perl ccmapbin.pl input_file [gPuncCharsCCMap [punct_marks]] 
+    perl ccmapbin.pl input_file [gPuncCharsCCMapExt [punct_marks]] 
 
   which will generate punct_marks.ccmap (or punct_marks.x-ccmap if the ccmap
-  includes non-BMP characters.). gPuncCharsCCMap is used as the prefix
+  includes non-BMP characters.). gPuncCharsCCMapExt is used as the prefix
   in macros for the array initializer and the array size. 
 
   (see bug 180266, bug 167136, and bug 224337)
 
   Additional notes: 
   The input file for this ccmap file was generated with the following shell commands:
   (see bug 263411 for details)
 
   cut -d ';' -f 1-3 UnicodeData-4.0.1.txt | egrep 'Ps|Pe|Po|Pf|Pi' | cut -d ';' -f 1-2 \
-   | egrep -v '[1-9A-F]{5,}' \ 
    | sed -e 's/;/ : /'  -e 's/^/  0X/'
  */
 
 /*
-   VARIABLE:: gPuncCharsCCMap
+   VARIABLE:: gPuncCharsCCMapExt
    CLASS:: punct_marks
    DESCRIPTION:: Punctuation Marks (Unicode char. classes: Ps, Pe, Po, Pi, Pf)
-   FILE:: layout/html/base/src/nsTextFrame.cpp
 
    0X000021 : EXCLAMATION MARK
    0X000022 : QUOTATION MARK
    0X000023 : NUMBER SIGN
    0X000025 : PERCENT SIGN
    0X000026 : AMPERSAND
    0X000027 : APOSTROPHE
    0X000028 : LEFT PARENTHESIS
@@ -489,23 +487,41 @@
    0X00FF5D : FULLWIDTH RIGHT CURLY BRACKET
    0X00FF5F : FULLWIDTH LEFT WHITE PARENTHESIS
    0X00FF60 : FULLWIDTH RIGHT WHITE PARENTHESIS
    0X00FF61 : HALFWIDTH IDEOGRAPHIC FULL STOP
    0X00FF62 : HALFWIDTH LEFT CORNER BRACKET
    0X00FF63 : HALFWIDTH RIGHT CORNER BRACKET
    0X00FF64 : HALFWIDTH IDEOGRAPHIC COMMA
    0X00FF65 : HALFWIDTH KATAKANA MIDDLE DOT
+   0X010100 : AEGEAN WORD SEPARATOR LINE
+   0X010101 : AEGEAN WORD SEPARATOR DOT
+   0X01039F : UGARITIC WORD DIVIDER
+   0X0103D0 : OLD PERSIAN WORD DIVIDER
+   0X01091F : PHOENICIAN WORD SEPARATOR
+   0X010A50 : KHAROSHTHI PUNCTUATION DOT
+   0X010A51 : KHAROSHTHI PUNCTUATION SMALL CIRCLE
+   0X010A52 : KHAROSHTHI PUNCTUATION CIRCLE
+   0X010A53 : KHAROSHTHI PUNCTUATION CRESCENT BAR
+   0X010A54 : KHAROSHTHI PUNCTUATION MANGALAM
+   0X010A55 : KHAROSHTHI PUNCTUATION LOTUS
+   0X010A56 : KHAROSHTHI PUNCTUATION DANDA
+   0X010A57 : KHAROSHTHI PUNCTUATION DOUBLE DANDA
+   0X010A58 : KHAROSHTHI PUNCTUATION LINES
+   0X012470 : CUNEIFORM PUNCTUATION SIGN OLD ASSYRIAN WORD DIVIDER
+   0X012471 : CUNEIFORM PUNCTUATION SIGN VERTICAL COLON
+   0X012472 : CUNEIFORM PUNCTUATION SIGN DIAGONAL COLON
+   0X012473 : CUNEIFORM PUNCTUATION SIGN DIAGONAL TRICOLON
 */
 
-#if (defined(IS_LITTLE_ENDIAN) || ALU_SIZE == 16)
-// Precompiled CCMap for Little Endian(16/32/64bit)
-// and Big Endian(16bit)
-#define gPuncCharsCCMap_SIZE 592
-#define gPuncCharsCCMap_INITIALIZER    \
+#if (defined(IS_LITTLE_ENDIAN) && ALU_SIZE == 64)
+// Precompiled CCMap for Little Endian(64bit)
+#define gPuncCharsCCMapExt_SIZE 804
+#define gPuncCharsCCMapExt_INITIALIZER    \
+/* EXTFLG */ 0x0001,0x0000,0x0250,0x0000,    \
 /* 000000 */ 0x0030,0x00D0,0x0160,0x01D0,0x0010,0x0010,0x0010,0x0010,    \
              0x0010,0x0010,0x01F0,0x0010,0x0010,0x0010,0x0010,0x0210,    \
 /* 000010 */ 0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
              0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
 /* 000020 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
              0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
 /* 000030 */ 0x0040,0x0020,0x0020,0x0050,0x0020,0x0060,0x0070,0x0080,    \
              0x0020,0x0090,0x0020,0x0020,0x0020,0x00A0,0x00B0,0x00C0,    \
@@ -569,21 +585,258 @@
              0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
 /* 000210 */ 0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
              0x0020,0x0020,0x0020,0x0020,0x0020,0x0220,0x0230,0x0240,    \
 /* 000220 */ 0x0000,0x0000,0x0000,0xC000,0x0000,0x0000,0x0000,0x0000,    \
              0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
 /* 000230 */ 0x0000,0x03FF,0x0000,0xFFE1,0x1FFF,0xFEF7,0x0D03,0x0000,    \
              0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
 /* 000240 */ 0xD7EE,0x8C00,0x0001,0x3800,0x0000,0xA800,0x003F,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000250 */ 0x0280,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,    \
+             0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,    \
+/* 000260 */ 0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,    \
+             0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,    \
+/* 000270 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000280 */ 0x0030,0x0010,0x0080,0x0010,0x0010,0x0010,0x0010,0x0010,    \
+             0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,    \
+/* 000290 */ 0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+             0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 0002a0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0002b0 */ 0x0020,0x0040,0x0020,0x0050,0x0020,0x0020,0x0020,0x0020,    \
+             0x0020,0x0060,0x0070,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 0002c0 */ 0x0003,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0002d0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x8000,0x0000,0x0000,0x0000,0x0001,0x0000,0x0000,    \
+/* 0002e0 */ 0x0000,0x8000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0002f0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x01FF,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000300 */ 0x0020,0x0020,0x0020,0x0020,0x0090,0x0020,0x0020,0x0020,    \
+             0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 000310 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x000F,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
+#elif defined(IS_LITTLE_ENDIAN)
+// Precompiled CCMap for Little Endian(16/32bit) 
+#define gPuncCharsCCMapExt_SIZE 802
+#define gPuncCharsCCMapExt_INITIALIZER    \
+/* EXTFLG */ 0x0001,0x0250,    \
+/* 000000 */ 0x0030,0x00D0,0x0160,0x01D0,0x0010,0x0010,0x0010,0x0010,    \
+             0x0010,0x0010,0x01F0,0x0010,0x0010,0x0010,0x0010,0x0210,    \
+/* 000010 */ 0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+             0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 000020 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000030 */ 0x0040,0x0020,0x0020,0x0050,0x0020,0x0060,0x0070,0x0080,    \
+             0x0020,0x0090,0x0020,0x0020,0x0020,0x00A0,0x00B0,0x00C0,    \
+/* 000040 */ 0x0000,0x0000,0xD7EE,0x8C00,0x0001,0x3800,0x0000,0x2800,    \
+             0x0000,0x0000,0x0802,0x8880,0x0000,0x0000,0x0000,0x0000,    \
+/* 000050 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x4000,    \
+             0x0080,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000060 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0xFC00,0x0000,0x0000,    \
+             0x0200,0x0000,0x0000,0x4000,0x0049,0x0000,0x0000,0x0018,    \
+/* 000070 */ 0x3000,0xC800,0x0000,0x0000,0x0000,0x0000,0x3C00,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0010,0x0000,0x0000,    \
+/* 000080 */ 0x3FFF,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0380,    \
+/* 000090 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0030,0x0001,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0000a0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0010,    \
+/* 0000b0 */ 0x0000,0x0000,0x0000,0x0000,0x8000,0x0C00,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0000c0 */ 0xFFF0,0x0007,0x0000,0x3C00,0x0000,0x0000,0x0000,0x0000,    \
+             0x0020,0x0000,0x0000,0x0000,0x0000,0x0003,0x0000,0x0000,    \
+/* 0000d0 */ 0x00E0,0x0020,0x0020,0x00F0,0x0020,0x0020,0x0100,0x0110,    \
+             0x0120,0x0130,0x0140,0x0150,0x0020,0x0020,0x0020,0x0020,    \
+/* 0000e0 */ 0x0000,0x0000,0x0000,0x0000,0xFC00,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0800,    \
+/* 0000f0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x01FE,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000100 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x6000,0x0000,    \
+             0x0000,0x1800,0x0000,0x0000,0x0000,0x0000,0x3800,0x0000,    \
+/* 000110 */ 0x0000,0x0000,0x0000,0x0060,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0770,0x0000,0x0000,    \
+/* 000120 */ 0x07BF,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000130 */ 0x0000,0x0000,0x0000,0x0000,0x0030,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0xC000,0x0000,0x0000,    \
+/* 000140 */ 0x0000,0xC000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000150 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0xFC00,0x0001,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000160 */ 0x0170,0x0020,0x0020,0x0180,0x0020,0x0020,0x0020,0x0190,    \
+             0x0020,0x01A0,0x0020,0x0020,0x01B0,0x0020,0x01C0,0x0020,    \
+/* 000170 */ 0x0000,0xFFC0,0x00FF,0x7FFF,0xFFEE,0x7FEB,0x0000,0x6000,    \
+             0x6000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000180 */ 0x0000,0x0000,0x0600,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000190 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xFF00,0x003F,    \
+             0x0000,0x0000,0x0000,0x0000,0x0060,0x0000,0x0FC0,0x0000,    \
+/* 0001a0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0xFFF8,0x01FF,0x0000,0x0000,0x0000,0x0F00,0x0000,0x3000,    \
+/* 0001b0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xDE00,    \
+/* 0001c0 */ 0xFFFF,0x307F,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0001d0 */ 0x01E0,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+             0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 0001e0 */ 0xFF0E,0xEFF3,0x0000,0x2000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0800,    \
+/* 0001f0 */ 0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+             0x0200,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 000200 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x00F0,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000210 */ 0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+             0x0020,0x0020,0x0020,0x0020,0x0020,0x0220,0x0230,0x0240,    \
+/* 000220 */ 0x0000,0x0000,0x0000,0xC000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000230 */ 0x0000,0x03FF,0x0000,0xFFE1,0x1FFF,0xFEF7,0x0D03,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000240 */ 0xD7EE,0x8C00,0x0001,0x3800,0x0000,0xA800,0x003F,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000250 */ 0x0280,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,    \
+             0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,    \
+/* 000260 */ 0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,    \
+             0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,    \
+/* 000270 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000280 */ 0x0030,0x0010,0x0080,0x0010,0x0010,0x0010,0x0010,0x0010,    \
+             0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,    \
+/* 000290 */ 0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+             0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 0002a0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0002b0 */ 0x0020,0x0040,0x0020,0x0050,0x0020,0x0020,0x0020,0x0020,    \
+             0x0020,0x0060,0x0070,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 0002c0 */ 0x0003,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0002d0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x8000,0x0000,0x0000,0x0000,0x0001,0x0000,0x0000,    \
+/* 0002e0 */ 0x0000,0x8000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0002f0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x01FF,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000300 */ 0x0020,0x0020,0x0020,0x0020,0x0090,0x0020,0x0020,0x0020,    \
+             0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 000310 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x000F,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
+#elif (ALU_SIZE == 16)
+// Precompiled CCMap for Big Endian(16bit)
+#define gPuncCharsCCMapExt_SIZE 802
+#define gPuncCharsCCMapExt_INITIALIZER    \
+/* EXTFLG */ 0x0001,0x0250,    \
+/* 000000 */ 0x0030,0x00D0,0x0160,0x01D0,0x0010,0x0010,0x0010,0x0010,    \
+             0x0010,0x0010,0x01F0,0x0010,0x0010,0x0010,0x0010,0x0210,    \
+/* 000010 */ 0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+             0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 000020 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000030 */ 0x0040,0x0020,0x0020,0x0050,0x0020,0x0060,0x0070,0x0080,    \
+             0x0020,0x0090,0x0020,0x0020,0x0020,0x00A0,0x00B0,0x00C0,    \
+/* 000040 */ 0x0000,0x0000,0xD7EE,0x8C00,0x0001,0x3800,0x0000,0x2800,    \
+             0x0000,0x0000,0x0802,0x8880,0x0000,0x0000,0x0000,0x0000,    \
+/* 000050 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x4000,    \
+             0x0080,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000060 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0xFC00,0x0000,0x0000,    \
+             0x0200,0x0000,0x0000,0x4000,0x0049,0x0000,0x0000,0x0018,    \
+/* 000070 */ 0x3000,0xC800,0x0000,0x0000,0x0000,0x0000,0x3C00,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0010,0x0000,0x0000,    \
+/* 000080 */ 0x3FFF,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0380,    \
+/* 000090 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0030,0x0001,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0000a0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0010,    \
+/* 0000b0 */ 0x0000,0x0000,0x0000,0x0000,0x8000,0x0C00,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0000c0 */ 0xFFF0,0x0007,0x0000,0x3C00,0x0000,0x0000,0x0000,0x0000,    \
+             0x0020,0x0000,0x0000,0x0000,0x0000,0x0003,0x0000,0x0000,    \
+/* 0000d0 */ 0x00E0,0x0020,0x0020,0x00F0,0x0020,0x0020,0x0100,0x0110,    \
+             0x0120,0x0130,0x0140,0x0150,0x0020,0x0020,0x0020,0x0020,    \
+/* 0000e0 */ 0x0000,0x0000,0x0000,0x0000,0xFC00,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0800,    \
+/* 0000f0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x01FE,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000100 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x6000,0x0000,    \
+             0x0000,0x1800,0x0000,0x0000,0x0000,0x0000,0x3800,0x0000,    \
+/* 000110 */ 0x0000,0x0000,0x0000,0x0060,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0770,0x0000,0x0000,    \
+/* 000120 */ 0x07BF,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000130 */ 0x0000,0x0000,0x0000,0x0000,0x0030,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0xC000,0x0000,0x0000,    \
+/* 000140 */ 0x0000,0xC000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000150 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0xFC00,0x0001,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000160 */ 0x0170,0x0020,0x0020,0x0180,0x0020,0x0020,0x0020,0x0190,    \
+             0x0020,0x01A0,0x0020,0x0020,0x01B0,0x0020,0x01C0,0x0020,    \
+/* 000170 */ 0x0000,0xFFC0,0x00FF,0x7FFF,0xFFEE,0x7FEB,0x0000,0x6000,    \
+             0x6000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000180 */ 0x0000,0x0000,0x0600,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000190 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xFF00,0x003F,    \
+             0x0000,0x0000,0x0000,0x0000,0x0060,0x0000,0x0FC0,0x0000,    \
+/* 0001a0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0xFFF8,0x01FF,0x0000,0x0000,0x0000,0x0F00,0x0000,0x3000,    \
+/* 0001b0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xDE00,    \
+/* 0001c0 */ 0xFFFF,0x307F,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0001d0 */ 0x01E0,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+             0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 0001e0 */ 0xFF0E,0xEFF3,0x0000,0x2000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0800,    \
+/* 0001f0 */ 0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+             0x0200,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 000200 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x00F0,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000210 */ 0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+             0x0020,0x0020,0x0020,0x0020,0x0020,0x0220,0x0230,0x0240,    \
+/* 000220 */ 0x0000,0x0000,0x0000,0xC000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000230 */ 0x0000,0x03FF,0x0000,0xFFE1,0x1FFF,0xFEF7,0x0D03,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000240 */ 0xD7EE,0x8C00,0x0001,0x3800,0x0000,0xA800,0x003F,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000250 */ 0x0000,0x0280,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,    \
+             0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,    \
+/* 000260 */ 0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,    \
+             0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,    \
+/* 000270 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000280 */ 0x0030,0x0010,0x0080,0x0010,0x0010,0x0010,0x0010,0x0010,    \
+             0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,    \
+/* 000290 */ 0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+             0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 0002a0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0002b0 */ 0x0020,0x0040,0x0020,0x0050,0x0020,0x0020,0x0020,0x0020,    \
+             0x0020,0x0060,0x0070,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 0002c0 */ 0x0003,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0002d0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x8000,0x0000,0x0000,0x0000,0x0001,0x0000,0x0000,    \
+/* 0002e0 */ 0x0000,0x8000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0002f0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x01FF,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000300 */ 0x0020,0x0020,0x0020,0x0020,0x0090,0x0020,0x0020,0x0020,    \
+             0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 000310 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x000F,    \
              0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
 #elif (ALU_SIZE == 32)
 // Precompiled CCMap for  Big Endian(32bit)
-#define gPuncCharsCCMap_SIZE 592
-#define gPuncCharsCCMap_INITIALIZER    \
+#define gPuncCharsCCMapExt_SIZE 802
+#define gPuncCharsCCMapExt_INITIALIZER    \
+/* EXTFLG */ 0x0001,0x0250,    \
 /* 000000 */ 0x0030,0x00D0,0x0160,0x01D0,0x0010,0x0010,0x0010,0x0010,    \
              0x0010,0x0010,0x01F0,0x0010,0x0010,0x0010,0x0010,0x0210,    \
 /* 000010 */ 0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
              0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
 /* 000020 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
              0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
 /* 000030 */ 0x0040,0x0020,0x0020,0x0050,0x0020,0x0060,0x0070,0x0080,    \
              0x0020,0x0090,0x0020,0x0020,0x0020,0x00A0,0x00B0,0x00C0,    \
@@ -647,21 +900,48 @@
              0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
 /* 000210 */ 0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
              0x0020,0x0020,0x0020,0x0020,0x0020,0x0220,0x0230,0x0240,    \
 /* 000220 */ 0x0000,0x0000,0xC000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
              0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
 /* 000230 */ 0x03FF,0x0000,0xFFE1,0x0000,0xFEF7,0x1FFF,0x0000,0x0D03,    \
              0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
 /* 000240 */ 0x8C00,0xD7EE,0x3800,0x0001,0xA800,0x0000,0x0000,0x003F,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000250 */ 0x0000,0x0280,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,    \
+             0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,    \
+/* 000260 */ 0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,    \
+             0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,    \
+/* 000270 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000280 */ 0x0030,0x0010,0x0080,0x0010,0x0010,0x0010,0x0010,0x0010,    \
+             0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,    \
+/* 000290 */ 0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+             0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 0002a0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0002b0 */ 0x0020,0x0040,0x0020,0x0050,0x0020,0x0020,0x0020,0x0020,    \
+             0x0020,0x0060,0x0070,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 0002c0 */ 0x0000,0x0003,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0002d0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x8000,0x0000,0x0000,0x0000,0x0001,0x0000,0x0000,0x0000,    \
+/* 0002e0 */ 0x8000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0002f0 */ 0x0000,0x0000,0x0000,0x0000,0x01FF,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000300 */ 0x0020,0x0020,0x0020,0x0020,0x0090,0x0020,0x0020,0x0020,    \
+             0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 000310 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x000F,0x0000,    \
              0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
 #elif (ALU_SIZE == 64)
 // Precompiled CCMap for Big Endian(64bit)
-#define gPuncCharsCCMap_SIZE 592
-#define gPuncCharsCCMap_INITIALIZER    \
+#define gPuncCharsCCMapExt_SIZE 804
+#define gPuncCharsCCMapExt_INITIALIZER    \
+/* EXTFLG */ 0x0000,0x0001,0x0000,0x0250,    \
 /* 000000 */ 0x0030,0x00D0,0x0160,0x01D0,0x0010,0x0010,0x0010,0x0010,    \
              0x0010,0x0010,0x01F0,0x0010,0x0010,0x0010,0x0010,0x0210,    \
 /* 000010 */ 0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
              0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
 /* 000020 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
              0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
 /* 000030 */ 0x0040,0x0020,0x0020,0x0050,0x0020,0x0060,0x0070,0x0080,    \
              0x0020,0x0090,0x0020,0x0020,0x0020,0x00A0,0x00B0,0x00C0,    \
@@ -725,13 +1005,39 @@
              0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
 /* 000210 */ 0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
              0x0020,0x0020,0x0020,0x0020,0x0020,0x0220,0x0230,0x0240,    \
 /* 000220 */ 0xC000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
              0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
 /* 000230 */ 0xFFE1,0x0000,0x03FF,0x0000,0x0000,0x0D03,0xFEF7,0x1FFF,    \
              0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
 /* 000240 */ 0x3800,0x0001,0x8C00,0xD7EE,0x0000,0x003F,0xA800,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000250 */ 0x0000,0x0280,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,    \
+             0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,    \
+/* 000260 */ 0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,    \
+             0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,0x0000,0x0270,    \
+/* 000270 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000280 */ 0x0030,0x0010,0x0080,0x0010,0x0010,0x0010,0x0010,0x0010,    \
+             0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,0x0010,    \
+/* 000290 */ 0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+             0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 0002a0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0002b0 */ 0x0020,0x0040,0x0020,0x0050,0x0020,0x0020,0x0020,0x0020,    \
+             0x0020,0x0060,0x0070,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 0002c0 */ 0x0000,0x0000,0x0000,0x0003,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0002d0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x8000,0x0000,0x0000,0x0000,0x0001,0x0000,    \
+/* 0002e0 */ 0x0000,0x0000,0x8000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 0002f0 */ 0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x01FF,0x0000,    \
+             0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,    \
+/* 000300 */ 0x0020,0x0020,0x0020,0x0020,0x0090,0x0020,0x0020,0x0020,    \
+             0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,0x0020,    \
+/* 000310 */ 0x0000,0x0000,0x0000,0x0000,0x000F,0x0000,0x0000,0x0000,    \
              0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
 #else
 #error "We don't support this architecture."
 #endif
 
diff --git a/layout/reftests/bugs/436356-1-ref.html b/layout/reftests/bugs/436356-1-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/436356-1-ref.html
@@ -0,0 +1,1 @@
+<html><body><center><ul><li><p>Test</p></li></ul></center></body></html>
diff --git a/layout/reftests/bugs/436356-1.html b/layout/reftests/bugs/436356-1.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/436356-1.html
@@ -0,0 +1,13 @@
+<html>
+<body>
+<center>
+<ul>
+<li>
+<p>
+Test
+</p>
+</li>
+</ul>
+</center>
+</body>
+</html>
diff --git a/layout/reftests/bugs/436356-2-ref.html b/layout/reftests/bugs/436356-2-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/436356-2-ref.html
@@ -0,0 +1,2 @@
+<!DOCTYPE html>
+<html><body><center><ul><li><p>Test</p></li></ul></center></body></html>
diff --git a/layout/reftests/bugs/436356-2.html b/layout/reftests/bugs/436356-2.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/436356-2.html
@@ -0,0 +1,14 @@
+<!DOCTYPE html>
+<html>
+<body>
+<center>
+<ul>
+<li>
+<p>
+Test
+</p>
+</li>
+</ul>
+</center>
+</body>
+</html>
diff --git a/layout/reftests/bugs/reftest.list b/layout/reftests/bugs/reftest.list
--- a/layout/reftests/bugs/reftest.list
+++ b/layout/reftests/bugs/reftest.list
@@ -846,11 +846,13 @@ fails-if(MOZ_WIDGET_TOOLKIT=="gtk2") == 
 == 428521-1c.html 428521-1-ref.html
 random == 429849-1.html 429849-1-ref.html # bug 432288
 == 430412-1.html 430412-1-ref.html
 == 430813-1.html 430813-1-ref.html
 == 430813-2.html 430813-2-ref.html
 == 430813-3.html 430813-3-ref.html
 == 440112.html 440112-ref.html
 == 433640-1.html 433640-1-ref.html
+== 436356-1.html 436356-1-ref.html
+== 436356-2.html 436356-2-ref.html
 == 438981-1.xhtml about:blank
 == 439004-1.html 439004-1-ref.html
 == 439910.html 439910-ref.html
diff --git a/layout/reftests/first-letter/399941-1-ref.html b/layout/reftests/first-letter/399941-1-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/399941-1-ref.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html>
+<html>
+ <head>
+  <meta http-equiv="content-type" content="text/html; charset=utf-8">
+  <title>Test case for bug 399941.html</title>
+  <style type="text/css">
+   span.fake-first-letter {
+     color: lime;
+     background-color: olive;
+   }
+  </style>
+ </head>
+ <body>
+ <!-- Leading and trailing punctuation should all be included -->
+  <p><span class="fake-first-letter">"I!,"</span> said the Fly,</p>
+ </body>
+</html>
diff --git a/layout/reftests/first-letter/399941-1.html b/layout/reftests/first-letter/399941-1.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/399941-1.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html>
+<html>
+ <head>
+  <meta http-equiv="content-type" content="text/html; charset=utf-8">
+  <title>Test case for bug 399941.html</title>
+  <style type="text/css">
+   p:first-letter {
+     color: lime;
+     background-color: olive;
+   }
+  </style>
+ </head>
+ <body>
+ <!-- Leading and trailing punctuation should all be included -->
+  <p>"I!," said the Fly,</p>
+ </body>
+</html>
diff --git a/layout/reftests/first-letter/399941-2-ref.html b/layout/reftests/first-letter/399941-2-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/399941-2-ref.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html>
+<html>
+ <head>
+  <meta http-equiv="content-type" content="text/html; charset=utf-8">
+  <title>Test case for bug 399941.html</title>
+  <style type="text/css">
+   span.fake-first-letter {
+     color: lime;
+     background-color: olive;
+   }
+  </style>
+ </head>
+ <body>
+ <!-- Punctuation in class Pc should not be included: there is no first-letter here -->
+  <p>_I_, said the Fly,</p>
+ </body>
+</html>
diff --git a/layout/reftests/first-letter/399941-2.html b/layout/reftests/first-letter/399941-2.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/399941-2.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html>
+<html>
+ <head>
+  <meta http-equiv="content-type" content="text/html; charset=utf-8">
+  <title>Test case for bug 399941.html</title>
+  <style type="text/css">
+   p:first-letter {
+     color: lime;
+     background-color: olive;
+   }
+  </style>
+ </head>
+ <body>
+ <!-- Punctuation in class Pc should not be included: there is no first-letter here -->
+  <p>_I_, said the Fly,</p>
+ </body>
+</html>
diff --git a/layout/reftests/first-letter/399941-3-ref.html b/layout/reftests/first-letter/399941-3-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/399941-3-ref.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html>
+<html>
+ <head>
+  <meta http-equiv="content-type" content="text/html; charset=utf-8">
+  <title>Test case for bug 399941.html</title>
+  <style type="text/css">
+   span.fake-first-letter {
+     color: lime;
+     background-color: olive;
+   }
+  </style>
+ </head>
+ <body>
+ <!-- Test non-ASCII punctuation -->
+  <p><span class="fake-first-letter">C</span>mo est usted?</p>
+ </body>
+</html>
diff --git a/layout/reftests/first-letter/399941-3.html b/layout/reftests/first-letter/399941-3.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/399941-3.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html>
+<html>
+ <head>
+  <meta http-equiv="content-type" content="text/html; charset=utf-8">
+  <title>Test case for bug 399941.html</title>
+  <style type="text/css">
+   p:first-letter {
+     color: lime;
+     background-color: olive;
+   }
+  </style>
+ </head>
+ <body>
+ <!-- Test non-ASCII punctuation -->
+  <p>Cmo est usted?</p>
+ </body>
+</html>
diff --git a/layout/reftests/first-letter/399941-4-ref.html b/layout/reftests/first-letter/399941-4-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/399941-4-ref.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html>
+<html>
+ <head>
+  <meta http-equiv="content-type" content="text/html; charset=utf-8">
+  <title>Test case for bug 399941.html</title>
+  <style type="text/css">
+   span.fake-first-letter {
+     color: lime;
+     background-color: olive;
+   }
+  </style>
+ </head>
+ <body>
+ <!-- Test 16-bit punctuation -->
+  <p><span class="fake-first-letter">&#x201c;I!,&#x201d;</span> said the Fly,</p>
+ </body>
+</html>
diff --git a/layout/reftests/first-letter/399941-4.html b/layout/reftests/first-letter/399941-4.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/399941-4.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html>
+<html>
+ <head>
+  <meta http-equiv="content-type" content="text/html; charset=utf-8">
+  <title>Test case for bug 399941.html</title>
+  <style type="text/css">
+   p:first-letter {
+     color: lime;
+     background-color: olive;
+   }
+  </style>
+ </head>
+ <body>
+ <!-- Test 16-bit punctuation -->
+  <p>&#x201c;I!,&#x201d; said the Fly,</p>
+ </body>
+</html>
diff --git a/layout/reftests/first-letter/399941-5-ref.html b/layout/reftests/first-letter/399941-5-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/399941-5-ref.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html>
+<html>
+ <head>
+  <meta http-equiv="content-type" content="text/html; charset=utf-8">
+  <title>Test case for bug 399941.html</title>
+  <style type="text/css">
+   span.fake-first-letter {
+     color: lime;
+     background-color: olive;
+   }
+  </style>
+ </head>
+ <body>
+ <!-- If there is whitespace between the punctuation and the first letter, there is no first-letter -->
+  <p>"*" is an asterix</p>
+ </body>
+</html>
diff --git a/layout/reftests/first-letter/399941-5.html b/layout/reftests/first-letter/399941-5.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/399941-5.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html>
+<html>
+ <head>
+  <meta http-equiv="content-type" content="text/html; charset=utf-8">
+  <title>Test case for bug 399941.html</title>
+  <style type="text/css">
+   p:first-letter {
+     color: lime;
+     background-color: olive;
+   }
+  </style>
+ </head>
+ <body>
+ <!-- If there is whitespace between the punctuation and the first letter, there is no first-letter -->
+  <p>"*" is an asterix</p>
+ </body>
+</html>
diff --git a/layout/reftests/first-letter/399941-6-ref.html b/layout/reftests/first-letter/399941-6-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/399941-6-ref.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html>
+<html>
+ <head>
+  <meta http-equiv="content-type" content="text/html; charset=utf-8">
+  <title>Test case for bug 399941.html</title>
+  <style type="text/css">
+   span.fake-first-letter {
+     color: lime;
+     background-color: olive;
+   }
+  </style>
+ </head>
+ <body>
+ <!-- :first-letter applies to digits (and following punctuation) -->
+  <p><span class="fake-first-letter">2,</span>000 miles</p>
+ </body>
+</html>
diff --git a/layout/reftests/first-letter/399941-6.html b/layout/reftests/first-letter/399941-6.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/399941-6.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html>
+<html>
+ <head>
+  <meta http-equiv="content-type" content="text/html; charset=utf-8">
+  <title>Test case for bug 399941.html</title>
+  <style type="text/css">
+   p:first-letter {
+     color: lime;
+     background-color: olive;
+   }
+  </style>
+ </head>
+ <body>
+ <!-- :first-letter applies to digits (and following punctuation) -->
+  <p>2,000 miles</p>
+ </body>
+</html>
diff --git a/layout/reftests/first-letter/399941-7-ref.html b/layout/reftests/first-letter/399941-7-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/399941-7-ref.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html>
+<html>
+ <head>
+  <meta http-equiv="content-type" content="text/html; charset=utf-8">
+  <title>Test case for bug 399941.html</title>
+  <style type="text/css">
+   span.fake-first-letter {
+     color: lime;
+     background-color: olive;
+   }
+  </style>
+ </head>
+ <body>
+ <!-- :first-letter doesn't apply to symbols -->
+  <p>$64,000</p>
+ </body>
+</html>
diff --git a/layout/reftests/first-letter/399941-7.html b/layout/reftests/first-letter/399941-7.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/399941-7.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html>
+<html>
+ <head>
+  <meta http-equiv="content-type" content="text/html; charset=utf-8">
+  <title>Test case for bug 399941.html</title>
+  <style type="text/css">
+   p:first-letter {
+     color: lime;
+     background-color: olive;
+   }
+  </style>
+ </head>
+ <body>
+ <!-- :first-letter doesn't apply to symbols -->
+  <p>$64,000</p>
+ </body>
+</html>
diff --git a/layout/reftests/first-letter/399941-8-ref.html b/layout/reftests/first-letter/399941-8-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/399941-8-ref.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html>
+<html>
+ <head>
+  <meta http-equiv="content-type" content="text/html; charset=utf-8">
+  <title>Test case for bug 399941.html</title>
+  <style type="text/css">
+   span.fake-first-letter {
+     color: lime;
+     background-color: olive;
+   }
+  </style>
+ </head>
+ <body>
+ <!-- Test SMP characters -->
+  <p><span class="fake-first-letter">&#x10900;</span>&#x10901;&#x10909; is Phoenician</p>
+ </body>
+</html>
diff --git a/layout/reftests/first-letter/399941-8.html b/layout/reftests/first-letter/399941-8.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/399941-8.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html>
+<html>
+ <head>
+  <meta http-equiv="content-type" content="text/html; charset=utf-8">
+  <title>Test case for bug 399941.html</title>
+  <style type="text/css">
+   p:first-letter {
+     color: lime;
+     background-color: olive;
+   }
+  </style>
+ </head>
+ <body>
+ <!-- Test SMP characters -->
+  <p>&#x10900;&#x10901;&#x10909; is Phoenician</p>
+ </body>
+</html>
diff --git a/layout/reftests/first-letter/399941-9-ref.html b/layout/reftests/first-letter/399941-9-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/399941-9-ref.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html>
+<html>
+ <head>
+  <meta http-equiv="content-type" content="text/html; charset=utf-8">
+  <title>Test case for bug 399941.html</title>
+  <style type="text/css">
+   span.fake-first-letter {
+     color: lime;
+     background-color: olive;
+   }
+  </style>
+ </head>
+ <body>
+ <!-- Test SMP characters and punctuation -->
+  <p><span class="fake-first-letter">&#x12470;&#x12000;&#x12470;</span>&#x12041; is cuneiform with punctuation</p>
+ </body>
+</html>
diff --git a/layout/reftests/first-letter/399941-9.html b/layout/reftests/first-letter/399941-9.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/399941-9.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html>
+<html>
+ <head>
+  <meta http-equiv="content-type" content="text/html; charset=utf-8">
+  <title>Test case for bug 399941.html</title>
+  <style type="text/css">
+   p:first-letter {
+     color: lime;
+     background-color: olive;
+   }
+  </style>
+ </head>
+ <body>
+ <!-- Test SMP characters and punctuation -->
+  <p>&#x12470;&#x12000;&#x12470;&#x12041; is cuneiform with punctuation</p>
+ </body>
+</html>
diff --git a/layout/reftests/first-letter/nested-1g.html b/layout/reftests/first-letter/nested-1g.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/nested-1g.html
@@ -0,0 +1,14 @@
+<!DOCTYPE html>
+<html>
+<head>
+  <style>
+  div { color: black; }
+  div::first-letter { color: green; }
+  </style>
+</head>
+<body>
+  <div>
+    <span>T</span>his is text
+  </div>
+</body>
+</html>
diff --git a/layout/reftests/first-letter/reftest.list b/layout/reftests/first-letter/reftest.list
--- a/layout/reftests/first-letter/reftest.list
+++ b/layout/reftests/first-letter/reftest.list
@@ -7,16 +7,17 @@
 
 # others
 == nested-1a.html nested-1-ref.html
 == nested-1b.html nested-1-ref.html
 == nested-1c.html nested-1-ref.html
 == nested-1d.html nested-1-ref.html
 == nested-1e.html nested-1-ref.html
 == nested-1f.html nested-1-ref.html
+== nested-1g.html nested-1-ref.html
 == quote-1a.html quote-1-ref.html
 fails == quote-1b.html quote-1-ref.html
 fails == quote-1c.html quote-1-ref.html
 == quote-1c.html quote-1b.html
 fails == quote-1d.html quote-1-ref.html
 random == quote-1d.html quote-1b.html
 fails == dynamic-1.html dynamic-1-ref.html # bug 8253
 == dynamic-2.html dynamic-2-ref.html
@@ -28,8 +29,17 @@ random == dynamic-3b.html dynamic-3-ref.
 == 23605-4.html 23605-4-ref.html
 == 23605-5.html 23605-5-ref.html
 == 23605-6.html 23605-6-ref.html
 random-if(MOZ_WIDGET_TOOLKIT=="gtk2") == 329069-1.html 329069-1-ref.html # failure is font-dependent, may be related to bug 404848
 != 229764-1.html 229764-ref.html
 == 229764-2.html 229764-ref.html
 == 342120-1.xhtml 342120-1-ref.xhtml
 == 379799-1.html 379799-1-ref.html
+== 399941-1.html 399941-1-ref.html
+== 399941-2.html 399941-2-ref.html
+== 399941-3.html 399941-3-ref.html
+== 399941-4.html 399941-4-ref.html
+== 399941-5.html 399941-5-ref.html
+== 399941-6.html 399941-6-ref.html
+== 399941-7.html 399941-7-ref.html
+== 399941-8.html 399941-8-ref.html
+== 399941-9.html 399941-9-ref.html
diff --git a/layout/style/nsCSSParser.cpp b/layout/style/nsCSSParser.cpp
--- a/layout/style/nsCSSParser.cpp
+++ b/layout/style/nsCSSParser.cpp
@@ -814,17 +814,17 @@ CSSParserImpl::ParseStyleAttribute(const
     UngetToken();
   }
   else {
     haveBraces = PR_FALSE;
   }
 
   nsCSSDeclaration* declaration = ParseDeclarationBlock(errorCode, haveBraces);
   if (declaration) {
-    // Create a style rule for the delcaration
+    // Create a style rule for the declaration
     nsICSSStyleRule* rule = nsnull;
     rv = NS_NewCSSStyleRule(&rule, nsnull, declaration);
     if (NS_FAILED(rv)) {
       declaration->RuleAbort();
       ReleaseScanner();
       return rv;
     }
     *aResult = rule;
diff --git a/layout/style/nsCSSValue.h b/layout/style/nsCSSValue.h
--- a/layout/style/nsCSSValue.h
+++ b/layout/style/nsCSSValue.h
@@ -314,20 +314,28 @@ public:
         return PR_FALSE;
       for (PRUint16 i = 0; i < mCount; ++i)
         if ((*this)[i] != aOther[i])
           return PR_FALSE;
       return PR_TRUE;
     }
 
     void AddRef() {
+      if (mRefCnt == PR_UINT16_MAX) {
+        NS_WARNING("refcount overflow, leaking nsCSSValue::Array");
+        return;
+      }
       ++mRefCnt;
       NS_LOG_ADDREF(this, mRefCnt, "nsCSSValue::Array", sizeof(*this));
     }
     void Release() {
+      if (mRefCnt == PR_UINT16_MAX) {
+        NS_WARNING("refcount overflow, leaking nsCSSValue::Array");
+        return;
+      }
       --mRefCnt;
       NS_LOG_RELEASE(this, mRefCnt, "nsCSSValue::Array");
       if (mRefCnt == 0)
         delete this;
     }
 
   private:
 
diff --git a/layout/svg/base/src/nsSVGFilterInstance.h b/layout/svg/base/src/nsSVGFilterInstance.h
--- a/layout/svg/base/src/nsSVGFilterInstance.h
+++ b/layout/svg/base/src/nsSVGFilterInstance.h
@@ -46,17 +46,17 @@
 #include "nsIContent.h"
 #include "nsAutoPtr.h"
 
 #include "gfxImageSurface.h"
 
 class nsSVGLength2;
 class nsSVGElement;
 
-class nsSVGFilterInstance
+class NS_STACK_CLASS nsSVGFilterInstance
 {
 public:
   class ColorModel {
   public:
     enum ColorSpace { SRGB, LINEAR_RGB };
     enum AlphaChannel { UNPREMULTIPLIED, PREMULTIPLIED };
 
     ColorModel(ColorSpace aColorSpace, AlphaChannel aAlphaChannel) :
diff --git a/layout/xul/base/src/nsBoxLayoutState.h b/layout/xul/base/src/nsBoxLayoutState.h
--- a/layout/xul/base/src/nsBoxLayoutState.h
+++ b/layout/xul/base/src/nsBoxLayoutState.h
@@ -51,17 +51,17 @@
 #include "nsIPresShell.h"
 
 class nsIRenderingContext;
 class nsCalculatedBoxInfo;
 struct nsHTMLReflowMetrics;
 class nsString;
 class nsHTMLReflowCommand;
 
-class nsBoxLayoutState
+class NS_STACK_CLASS nsBoxLayoutState
 {
 public:
   nsBoxLayoutState(nsPresContext* aPresContext, nsIRenderingContext* aRenderingContext = nsnull,
                    PRUint16 aReflowDepth = 0) NS_HIDDEN;
   nsBoxLayoutState(const nsBoxLayoutState& aState) NS_HIDDEN;
 
   nsPresContext* PresContext() const { return mPresContext; }
   nsIPresShell* PresShell() const { return mPresContext->PresShell(); }
diff --git a/memory/jemalloc/Makefile.in b/memory/jemalloc/Makefile.in
--- a/memory/jemalloc/Makefile.in
+++ b/memory/jemalloc/Makefile.in
@@ -68,18 +68,19 @@ libs:: $(CRT_OBJ_DIR)/build/intel/mozcrt
 	done
 	# truly awful
 	#XXX: get ed into mozillabuild, bug 415123
 	$(PERL) $(srcdir)/apply-ed-patches.pl $(srcdir)/crtsp1.diff \
 	$(CRT_OBJ_DIR) $(srcdir)/ed.exe
 
 $(CRT_OBJ_DIR)/build/intel/mozcrt19.dll: \
   $(CRT_OBJ_DIR)/jemalloc.c $(srcdir)/jemalloc.c $(srcdir)/jemalloc.h \
-  $(srcdir)/rb.h
-	cp $(srcdir)/jemalloc.c $(srcdir)/jemalloc.h $(srcdir)/rb.h $(CRT_OBJ_DIR)
+  $(srcdir)/ql.h $(srcdir)/qr.h $(srcdir)/rb.h
+	cp $(srcdir)/jemalloc.c $(srcdir)/jemalloc.h $(srcdir)/ql.h \
+	$(srcdir)/qr.h $(srcdir)/rb.h $(CRT_OBJ_DIR)
 # this pretty much sucks, but nmake and make don't play well together
 	$(PYTHON) $(srcdir)/build-crt.py $(CRT_OBJ_DIR)
 	#XXX: these don't link right for some reason
 	rm $(CRT_OBJ_DIR)/build/intel/{libcmt,libcpmt}.lib
 else
 # Using a pre-built DLL, so just install it.
 libs:: $(WIN32_CUSTOM_CRT_DIR)/mozcrt19.dll
 	$(INSTALL) $< $(FINAL_TARGET)
diff --git a/memory/jemalloc/apply-ed-patches.pl b/memory/jemalloc/apply-ed-patches.pl
--- a/memory/jemalloc/apply-ed-patches.pl
+++ b/memory/jemalloc/apply-ed-patches.pl
@@ -41,18 +41,18 @@ use FileHandle;
 use FileHandle;
 
 sub do_patch {
   my ($ed, $target_file, $patch_file, $fh) = @_;
   # these keep winding up read only for me
   chmod 0666, $target_file;
   print $fh "w\n";
   $fh->close();
-  print "$ed - $target_file < $patch_file\n";
-  system "$ed - $target_file < $patch_file\n";
+  print "$ed -s $target_file < $patch_file\n";
+  system "$ed -s $target_file < $patch_file\n";
 }
 
 my $header_done = 0;
 my ($target_file,$patch_file) = ('','');
 my $source_patch = $ARGV[0];
 my $srcdir = $ARGV[1];
 my $ed = $ARGV[2];
 $srcdir = "$srcdir/" unless $srcdir =~ m|/$|;
diff --git a/memory/jemalloc/jemalloc.c b/memory/jemalloc/jemalloc.c
--- a/memory/jemalloc/jemalloc.c
+++ b/memory/jemalloc/jemalloc.c
@@ -1,9 +1,10 @@
-/* -*- Mode: C; tab-width: 4; c-basic-offset: 4 -*- */
+/* -*- Mode: C; tab-width: 8; c-basic-offset: 8 -*- */
+/* vim:set softtabstop=8 shiftwidth=8: */
 /*-
  * Copyright (C) 2006-2008 Jason Evans <jasone@FreeBSD.org>.
  * All rights reserved.
  *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
  * 1. Redistributions of source code must retain the above copyright
@@ -157,41 +158,32 @@
 
 /*
  * MALLOC_BALANCE enables monitoring of arena lock contention and dynamically
  * re-balances arena load if exponentially averaged contention exceeds a
  * certain threshold.
  */
 /* #define	MALLOC_BALANCE */
 
-/*
- * MALLOC_DSS enables use of sbrk(2) to allocate chunks from the data storage
- * segment (DSS).  In an ideal world, this functionality would be completely
- * unnecessary, but we are burdened by history and the lack of resource limits
- * for anonymous mapped memory.
- */
-/*
- * Uniformly disable sbrk(2) use in Mozilla, since it has various problems
- * across platforms:
- *
- *   Linux: sbrk() fails to detect error conditions when using large amounts of
- *          memory, resulting in memory corruption.
- *
- *   Darwin: sbrk() is severely limited in how much memory it can allocate, and
- *           its use is strongly discouraged.
- *
- *   Solaris: sbrk() does not necessarily discard pages when the DSS is shrunk,
- *            which makes it possible to get non-zeroed pages when re-expanding
- *            the DSS.  This is incompatible with jemalloc's assumptions, and a
- *            fix would require chunk_alloc_dss() to optionally zero memory as
- *            chunk_recycle_dss() does (though the cost could be reduced by
- *            keeping track of the DSS high water mark and zeroing only when
- *            below that mark).
- */
-/* #define	MALLOC_DSS */
+#if (!defined(MOZ_MEMORY_WINDOWS) && !defined(MOZ_MEMORY_DARWIN))
+   /*
+    * MALLOC_PAGEFILE causes all mmap()ed memory to be backed by temporary
+    * files, so that if a chunk is mapped, it is guaranteed to be swappable.
+    * This avoids asynchronous OOM failures that are due to VM over-commit.
+    *
+    * XXX OS X over-commits, so we should probably use mmap() instead of
+    * vm_allocate(), so that MALLOC_PAGEFILE works.
+    */
+#  define MALLOC_PAGEFILE
+#endif
+
+#ifdef MALLOC_PAGEFILE
+/* Write size when initializing a page file. */
+#  define MALLOC_PAGEFILE_WRITE_SIZE 512
+#endif
 
 #ifdef MOZ_MEMORY_LINUX
 #define	_GNU_SOURCE /* For mremap(2). */
 #define	issetugid() 0
 #if 0 /* Enable in order to test decommit code on Linux. */
 #  define MALLOC_DECOMMIT
 #endif
 #endif
@@ -279,16 +271,19 @@ __FBSDID("$FreeBSD: head/lib/libc/stdlib
 #  define _LOCK_DEBUG
 #endif
 #include "spinlock.h"
 #include "namespace.h"
 #endif
 #include <sys/mman.h>
 #ifndef MADV_FREE
 #  define MADV_FREE	MADV_DONTNEED
+#endif
+#ifndef MAP_NOSYNC
+#  define MAP_NOSYNC	0
 #endif
 #include <sys/param.h>
 #ifndef MOZ_MEMORY
 #include <sys/stddef.h>
 #endif
 #include <sys/time.h>
 #include <sys/types.h>
 #ifndef MOZ_MEMORY_SOLARIS
@@ -358,16 +353,18 @@ static const bool __isthreaded = true;
 #  ifndef NDEBUG
 #    define NDEBUG
 #  endif
 #endif
 #ifndef MOZ_MEMORY_WINDOWS
 #include <assert.h>
 #endif
 
+#include "qr.h"
+#include "ql.h"
 #ifdef MOZ_MEMORY_WINDOWS
    /* MSVC++ does not support C99 variable-length arrays. */
 #  define RB_NO_C99_VARARRAYS
 #endif
 #include "rb.h"
 
 #ifdef MALLOC_DEBUG
    /* Disable inlining to make debugging easier. */
@@ -452,16 +449,28 @@ static const bool __isthreaded = true;
 /*
  * Size and alignment of memory chunks that are allocated by the OS's virtual
  * memory system.
  */
 #define	CHUNK_2POW_DEFAULT	20
 
 /* Maximum number of dirty pages per arena. */
 #define	DIRTY_MAX_DEFAULT	(1U << 10)
+
+/* Default reserve chunks. */
+#define	RESERVE_MIN_2POW_DEFAULT	1
+/*
+ * Default range (in chunks) between reserve_min and reserve_max, in addition
+ * to the mandatory one chunk per arena.
+ */
+#ifdef MALLOC_PAGEFILE
+#  define RESERVE_RANGE_2POW_DEFAULT	5
+#else
+#  define RESERVE_RANGE_2POW_DEFAULT	0
+#endif
 
 /*
  * Maximum size of L1 cache line.  This is used to avoid cache line aliasing,
  * so over-estimates are okay (up to a point), but under-estimates will
  * negatively affect performance.
  */
 #define	CACHELINE_2POW		6
 #define	CACHELINE		((size_t)(1U << CACHELINE_2POW))
@@ -696,16 +705,40 @@ struct extent_node_s {
 
 	/* Total region size. */
 	size_t	size;
 };
 typedef rb_tree(extent_node_t) extent_tree_t;
 
 /******************************************************************************/
 /*
+ * Reserve data structures.
+ */
+
+/* Callback registration. */
+typedef struct reserve_reg_s reserve_reg_t;
+struct reserve_reg_s {
+	/* Linkage for list of all registered callbacks. */
+	ql_elm(reserve_reg_t)	link;
+
+	/* Callback function pointer. */
+	reserve_cb_t		*cb;
+
+	/* Opaque application data pointer. */
+	void			*ctx;
+
+	/*
+	 * Sequence number of condition notification most recently sent to this
+	 * callback.
+	 */
+	uint64_t		seq;
+};
+
+/******************************************************************************/
+/*
  * Arena data structures.
  */
 
 typedef struct arena_s arena_t;
 typedef struct arena_bin_s arena_bin_t;
 
 /*
  * Each map element contains several flags, plus page position for runs that
@@ -832,42 +865,36 @@ struct arena_s {
 #else
 	pthread_mutex_t		lock;
 #endif
 
 #ifdef MALLOC_STATS
 	arena_stats_t		stats;
 #endif
 
+	/*
+	 * Chunk allocation sequence number, used to detect races with other
+	 * threads during chunk allocation, and then discard unnecessary chunks.
+	 */
+	uint64_t		chunk_seq;
+
 	/* Tree of all chunks this arena manages. */
 	arena_chunk_tree_t	chunks_all;
 
 	/*
 	 * Tree of dirty-page-containing chunks this arena manages.  This tree
 	 * is maintained in addition to chunks_all in order to make
 	 * deallocation O(lg d), where 'd' is the size of chunks_dirty.
 	 *
 	 * Without this tree, deallocation would be O(a), where 'a' is the size
 	 * of chunks_all.  Since dirty pages are purged in descending memory
 	 * order, it would not be difficult to trigger something approaching
 	 * worst case behavior with a series of large deallocations.
 	 */
 	arena_chunk_tree_t	chunks_dirty;
-
-	/*
-	 * In order to avoid rapid chunk allocation/deallocation when an arena
-	 * oscillates right on the cusp of needing a new chunk, cache the most
-	 * recently freed chunk.  The spare is left in the arena's chunk trees
-	 * until it is deleted.
-	 *
-	 * There is one spare chunk per arena, rather than one spare total, in
-	 * order to avoid interactions between multiple threads that could make
-	 * a single spare inadequate.
-	 */
-	arena_chunk_t		*spare;
 
 	/*
 	 * Current count of pages within unused runs that are potentially
 	 * dirty, and for which madvise(... MADV_FREE) has not been called.  By
 	 * tracking this, we can institute a limit on how much dirty unused
 	 * memory is mapped for each arena.
 	 */
 	size_t			ndirty;
@@ -955,46 +982,60 @@ static size_t		arena_maxclass; /* Max si
  */
 
 /* Protects chunk-related data structures. */
 static malloc_mutex_t	huge_mtx;
 
 /* Tree of chunks that are stand-alone huge allocations. */
 static extent_tree_t	huge;
 
-#ifdef MALLOC_DSS
-/*
- * Protects sbrk() calls.  This avoids malloc races among threads, though it
- * does not protect against races with threads that call sbrk() directly.
- */
-static malloc_mutex_t	dss_mtx;
-/* Base address of the DSS. */
-static void		*dss_base;
-/* Current end of the DSS, or ((void *)-1) if the DSS is exhausted. */
-static void		*dss_prev;
-/* Current upper limit on DSS addresses. */
-static void		*dss_max;
-
-/*
- * Trees of chunks that were previously allocated (trees differ only in node
- * ordering).  These are used when allocating chunks, in an attempt to re-use
- * address space.  Depending on function, different tree orderings are needed,
- * which is why there are two trees with the same contents.
- */
-static extent_tree_t	dss_chunks_szad;
-static extent_tree_t	dss_chunks_ad;
-#endif
-
 #ifdef MALLOC_STATS
 /* Huge allocation statistics. */
 static uint64_t		huge_nmalloc;
 static uint64_t		huge_ndalloc;
 static size_t		huge_allocated;
 #endif
 
+/****************/
+/*
+ * Memory reserve.
+ */
+
+#ifdef MALLOC_PAGEFILE
+static char		pagefile_templ[PATH_MAX];
+#endif
+
+/* Protects reserve-related data structures. */
+static malloc_mutex_t	reserve_mtx;
+
+/*
+ * Bounds on acceptable reserve size, and current reserve size.  Reserve
+ * depletion may cause (reserve_cur < reserve_min).
+ */
+static size_t		reserve_min;
+static size_t		reserve_cur;
+static size_t		reserve_max;
+
+/* List of registered callbacks. */
+static ql_head(reserve_reg_t) reserve_regs;
+
+/*
+ * Condition notification sequence number, used to determine whether all
+ * registered callbacks have been notified of the most current condition.
+ */
+static uint64_t		reserve_seq;
+
+/*
+ * Trees of chunks currently in the memory reserve.  Depending on function,
+ * different tree orderings are needed, which is why there are two trees with
+ * the same contents.
+ */
+static extent_tree_t	reserve_chunks_szad;
+static extent_tree_t	reserve_chunks_ad;
+
 /****************************/
 /*
  * base (internal allocation).
  */
 
 /*
  * Current pages that are being used for internal memory allocations.  These
  * pages are carved up in cacheline-size quanta, so that there is no chance of
@@ -1002,32 +1043,34 @@ static size_t		huge_allocated;
  */
 static void		*base_pages;
 static void		*base_next_addr;
 #ifdef MALLOC_DECOMMIT
 static void		*base_next_decommitted;
 #endif
 static void		*base_past_addr; /* Addr immediately past base_pages. */
 static extent_node_t	*base_nodes;
+static reserve_reg_t	*base_reserve_regs;
 static malloc_mutex_t	base_mtx;
 #ifdef MALLOC_STATS
 static size_t		base_mapped;
 #endif
 
 /********/
 /*
  * Arenas.
  */
 
 /*
  * Arenas that are used to service external requests.  Not all elements of the
  * arenas array are necessarily used; arenas are created lazily as needed.
  */
 static arena_t		**arenas;
 static unsigned		narenas;
+static unsigned		narenas_2pow;
 #ifndef NO_TLS
 #  ifdef MALLOC_BALANCE
 static unsigned		narenas_2pow;
 #  else
 static unsigned		next_arena;
 #  endif
 #endif
 #ifdef MOZ_MEMORY
@@ -1062,29 +1105,30 @@ static bool	opt_abort = true;
 #ifdef MALLOC_FILL
 static bool	opt_junk = true;
 #endif
 #else
 static bool	opt_abort = false;
 #ifdef MALLOC_FILL
 static bool	opt_junk = false;
 #endif
-#endif
-#ifdef MALLOC_DSS
-static bool	opt_dss = true;
-static bool	opt_mmap = true;
 #endif
 static size_t	opt_dirty_max = DIRTY_MAX_DEFAULT;
 #ifdef MALLOC_BALANCE
 static uint64_t	opt_balance_threshold = BALANCE_THRESHOLD_DEFAULT;
 #endif
 static bool	opt_print_stats = false;
 static size_t	opt_quantum_2pow = QUANTUM_2POW_MIN;
 static size_t	opt_small_max_2pow = SMALL_MAX_2POW_DEFAULT;
 static size_t	opt_chunk_2pow = CHUNK_2POW_DEFAULT;
+static int	opt_reserve_min_lshift = 0;
+static int	opt_reserve_range_lshift = 0;
+#ifdef MALLOC_PAGEFILE
+static bool	opt_pagefile = true;
+#endif
 #ifdef MALLOC_UTRACE
 static bool	opt_utrace = false;
 #endif
 #ifdef MALLOC_SYSV
 static bool	opt_sysv = false;
 #endif
 #ifdef MALLOC_XMALLOC
 static bool	opt_xmalloc = false;
@@ -1125,54 +1169,51 @@ static void	wrtmessage(const char *p1, c
 #ifdef MALLOC_STATS
 #ifdef MOZ_MEMORY_DARWIN
 /* Avoid namespace collision with OS X's malloc APIs. */
 #define malloc_printf moz_malloc_printf
 #endif
 static void	malloc_printf(const char *format, ...);
 #endif
 static char	*umax2s(uintmax_t x, char *s);
-#ifdef MALLOC_DSS
-static bool	base_pages_alloc_dss(size_t minsize);
-#endif
 static bool	base_pages_alloc_mmap(size_t minsize);
 static bool	base_pages_alloc(size_t minsize);
 static void	*base_alloc(size_t size);
 static void	*base_calloc(size_t number, size_t size);
 static extent_node_t *base_node_alloc(void);
 static void	base_node_dealloc(extent_node_t *node);
+static reserve_reg_t *base_reserve_reg_alloc(void);
+static void	base_reserve_reg_dealloc(reserve_reg_t *reg);
 #ifdef MALLOC_STATS
 static void	stats_print(arena_t *arena);
 #endif
-static void	*pages_map(void *addr, size_t size);
+static void	*pages_map(void *addr, size_t size, int pfd);
 static void	pages_unmap(void *addr, size_t size);
-#ifdef MALLOC_DSS
-static void	*chunk_alloc_dss(size_t size);
-static void	*chunk_recycle_dss(size_t size, bool zero);
-#endif
-static void	*chunk_alloc_mmap(size_t size);
-static void	*chunk_alloc(size_t size, bool zero);
-#ifdef MALLOC_DSS
-static extent_node_t *chunk_dealloc_dss_record(void *chunk, size_t size);
-static bool	chunk_dealloc_dss(void *chunk, size_t size);
-#endif
+static void	*chunk_alloc_mmap(size_t size, bool pagefile);
+#ifdef MALLOC_PAGEFILE
+static int	pagefile_init(size_t size);
+static void	pagefile_close(int pfd);
+#endif
+static void	*chunk_recycle_reserve(size_t size, bool zero);
+static void	*chunk_alloc(size_t size, bool zero, bool pagefile);
+static extent_node_t *chunk_dealloc_reserve(void *chunk, size_t size);
 static void	chunk_dealloc_mmap(void *chunk, size_t size);
 static void	chunk_dealloc(void *chunk, size_t size);
 #ifndef NO_TLS
 static arena_t	*choose_arena_hard(void);
 #endif
 static extent_node_t *arena_chunk_node_alloc(arena_chunk_t *chunk);
 static void	arena_chunk_node_dealloc(arena_chunk_t *chunk,
     extent_node_t *node);
 static void	arena_run_split(arena_t *arena, arena_run_t *run, size_t size,
     bool small, bool zero);
-static arena_chunk_t *arena_chunk_alloc(arena_t *arena);
+static void arena_chunk_init(arena_t *arena, arena_chunk_t *chunk);
 static void	arena_chunk_dealloc(arena_t *arena, arena_chunk_t *chunk);
-static arena_run_t *arena_run_alloc(arena_t *arena, size_t size, bool small,
-    bool zero);
+static arena_run_t *arena_run_alloc(arena_t *arena, arena_bin_t *bin,
+    size_t size, bool small, bool zero);
 static void	arena_purge(arena_t *arena);
 static void	arena_run_dalloc(arena_t *arena, arena_run_t *run, bool dirty);
 static void	arena_run_trim_head(arena_t *arena, arena_chunk_t *chunk,
     extent_node_t *nodeB, arena_run_t *run, size_t oldsize, size_t newsize);
 static void	arena_run_trim_tail(arena_t *arena, arena_chunk_t *chunk,
     extent_node_t *nodeA, arena_run_t *run, size_t oldsize, size_t newsize,
     bool dirty);
 static arena_run_t *arena_bin_nonfull_run_get(arena_t *arena, arena_bin_t *bin);
@@ -1199,16 +1240,20 @@ static void	*huge_palloc(size_t alignmen
 static void	*huge_palloc(size_t alignment, size_t size);
 static void	*huge_ralloc(void *ptr, size_t size, size_t oldsize);
 static void	huge_dalloc(void *ptr);
 static void	malloc_print_stats(void);
 #ifndef MOZ_MEMORY_WINDOWS
 static
 #endif
 bool		malloc_init_hard(void);
+static void	reserve_shrink(void);
+static uint64_t	reserve_notify(reserve_cnd_t cnd, size_t size, uint64_t seq);
+static uint64_t	reserve_crit(size_t size, const char *fname, uint64_t seq);
+static void	reserve_fail(size_t size, const char *fname);
 
 /*
  * End function prototypes.
  */
 /******************************************************************************/
 /*
  * Begin mutex.  We can't use normal pthread mutexes in all places, because
  * they require malloc()ed memory, which causes bootstrapping issues in some
@@ -1645,114 +1690,72 @@ pages_commit(void *addr, size_t size)
 #  else
 	if (mmap(addr, size, PROT_READ | PROT_WRITE, MAP_FIXED | MAP_PRIVATE |
 	    MAP_ANON, -1, 0) == MAP_FAILED)
 		abort();
 #  endif
 }
 #endif
 
-#ifdef MALLOC_DSS
-static bool
-base_pages_alloc_dss(size_t minsize)
-{
-
-	/*
-	 * Do special DSS allocation here, since base allocations don't need to
-	 * be chunk-aligned.
-	 */
-	malloc_mutex_lock(&dss_mtx);
-	if (dss_prev != (void *)-1) {
-		intptr_t incr;
-		size_t csize = CHUNK_CEILING(minsize);
-
-		do {
-			/* Get the current end of the DSS. */
-			dss_max = sbrk(0);
-
-			/*
-			 * Calculate how much padding is necessary to
-			 * chunk-align the end of the DSS.  Don't worry about
-			 * dss_max not being chunk-aligned though.
-			 */
-			incr = (intptr_t)chunksize
-			    - (intptr_t)CHUNK_ADDR2OFFSET(dss_max);
-			assert(incr >= 0);
-			if ((size_t)incr < minsize)
-				incr += csize;
-
-			dss_prev = sbrk(incr);
-			if (dss_prev == dss_max) {
-				/* Success. */
-				dss_max = (void *)((intptr_t)dss_prev + incr);
-				base_pages = dss_prev;
-				base_next_addr = base_pages;
-				base_past_addr = dss_max;
-#ifdef MALLOC_STATS
-				base_mapped += incr;
-#endif
-				malloc_mutex_unlock(&dss_mtx);
-				return (false);
-			}
-		} while (dss_prev != (void *)-1);
-	}
-	malloc_mutex_unlock(&dss_mtx);
-
-	return (true);
-}
-#endif
-
 static bool
 base_pages_alloc_mmap(size_t minsize)
 {
+	bool ret;
 	size_t csize;
 #ifdef MALLOC_DECOMMIT
 	size_t pminsize;
 #endif
+	int pfd;
 
 	assert(minsize != 0);
-	csize = PAGE_CEILING(minsize);
-	base_pages = pages_map(NULL, csize);
-	if (base_pages == NULL)
-		return (true);
+	csize = CHUNK_CEILING(minsize);
+#ifdef MALLOC_PAGEFILE
+	if (opt_pagefile) {
+		pfd = pagefile_init(csize);
+		if (pfd == -1)
+			return (true);
+	} else
+#endif
+		pfd = -1;
+	base_pages = pages_map(NULL, csize, pfd);
+	if (base_pages == NULL) {
+		ret = true;
+		goto RETURN;
+	}
 	base_next_addr = base_pages;
 	base_past_addr = (void *)((uintptr_t)base_pages + csize);
 #ifdef MALLOC_DECOMMIT
 	/*
 	 * Leave enough pages for minsize committed, since otherwise they would
 	 * have to be immediately recommitted.
 	 */
 	pminsize = PAGE_CEILING(minsize);
 	base_next_decommitted = (void *)((uintptr_t)base_pages + pminsize);
 	if (pminsize < csize)
 		pages_decommit(base_next_decommitted, csize - pminsize);
 #endif
 #ifdef MALLOC_STATS
 	base_mapped += csize;
 #endif
 
+	ret = false;
+RETURN:
+#ifdef MALLOC_PAGEFILE
+	if (pfd != -1)
+		pagefile_close(pfd);
+#endif
 	return (false);
 }
 
 static bool
 base_pages_alloc(size_t minsize)
 {
 
-#ifdef MALLOC_DSS
-	if (opt_dss) {
-		if (base_pages_alloc_dss(minsize) == false)
-			return (false);
-	}
-
-	if (opt_mmap && minsize != 0)
-#endif
-	{
-		if (base_pages_alloc_mmap(minsize) == false)
-			return (false);
-	}
+	if (base_pages_alloc_mmap(minsize) == false)
+		return (false);
 
 	return (true);
 }
 
 static void *
 base_alloc(size_t size)
 {
 	void *ret;
@@ -1830,16 +1833,48 @@ base_node_dealloc(extent_node_t *node)
 base_node_dealloc(extent_node_t *node)
 {
 
 	malloc_mutex_lock(&base_mtx);
 	VALGRIND_FREELIKE_BLOCK(node, 0);
 	VALGRIND_MALLOCLIKE_BLOCK(node, sizeof(extent_node_t *), 0, false);
 	*(extent_node_t **)node = base_nodes;
 	base_nodes = node;
+	malloc_mutex_unlock(&base_mtx);
+}
+
+static reserve_reg_t *
+base_reserve_reg_alloc(void)
+{
+	reserve_reg_t *ret;
+
+	malloc_mutex_lock(&base_mtx);
+	if (base_reserve_regs != NULL) {
+		ret = base_reserve_regs;
+		base_reserve_regs = *(reserve_reg_t **)ret;
+		VALGRIND_FREELIKE_BLOCK(ret, 0);
+		VALGRIND_MALLOCLIKE_BLOCK(ret, sizeof(reserve_reg_t), 0, false);
+		malloc_mutex_unlock(&base_mtx);
+	} else {
+		malloc_mutex_unlock(&base_mtx);
+		ret = (reserve_reg_t *)base_alloc(sizeof(reserve_reg_t));
+	}
+
+	return (ret);
+}
+
+static void
+base_reserve_reg_dealloc(reserve_reg_t *reg)
+{
+
+	malloc_mutex_lock(&base_mtx);
+	VALGRIND_FREELIKE_BLOCK(reg, 0);
+	VALGRIND_MALLOCLIKE_BLOCK(reg, sizeof(reserve_reg_t *), 0, false);
+	*(reserve_reg_t **)reg = base_reserve_regs;
+	base_reserve_regs = reg;
 	malloc_mutex_unlock(&base_mtx);
 }
 
 /******************************************************************************/
 
 #ifdef MALLOC_STATS
 static void
 stats_print(arena_t *arena)
@@ -2001,17 +2036,17 @@ rb_wrap(static, extent_tree_ad_, extent_
  */
 /******************************************************************************/
 /*
  * Begin chunk management functions.
  */
 
 #ifdef MOZ_MEMORY_WINDOWS
 static void *
-pages_map(void *addr, size_t size)
+pages_map(void *addr, size_t size, int pfd)
 {
 	void *ret;
 
 	ret = VirtualAlloc(addr, size, MEM_COMMIT | MEM_RESERVE,
 	    PAGE_READWRITE);
 
 	return (ret);
 }
@@ -2024,17 +2059,17 @@ pages_unmap(void *addr, size_t size)
 		_malloc_message(_getprogname(),
 		    ": (malloc) Error in VirtualFree()\n", "", "");
 		if (opt_abort)
 			abort();
 	}
 }
 #elif (defined(MOZ_MEMORY_DARWIN))
 static void *
-pages_map(void *addr, size_t size)
+pages_map(void *addr, size_t size, int pfd)
 {
 	void *ret;
 	kern_return_t err;
 	int flags;
 
 	if (addr != NULL) {
 		ret = addr;
 		flags = 0;
@@ -2076,26 +2111,34 @@ pages_copy(void *dest, const void *src, 
 	assert(n >= VM_COPY_MIN);
 	assert((void *)((uintptr_t)src & ~pagesize_mask) == src);
 
 	vm_copy(mach_task_self(), (vm_address_t)src, (vm_size_t)n,
 	    (vm_address_t)dest);
 }
 #else /* MOZ_MEMORY_DARWIN */
 static void *
-pages_map(void *addr, size_t size)
+pages_map(void *addr, size_t size, int pfd)
 {
 	void *ret;
 
 	/*
 	 * We don't use MAP_FIXED here, because it can cause the *replacement*
 	 * of existing mappings, and we only want to create new mappings.
 	 */
-	ret = mmap(addr, size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANON,
-	    -1, 0);
+#ifdef MALLOC_PAGEFILE
+	if (pfd != -1) {
+		ret = mmap(addr, size, PROT_READ | PROT_WRITE, MAP_PRIVATE |
+		    MAP_NOSYNC, pfd, 0);
+	} else
+#endif
+	       {
+		ret = mmap(addr, size, PROT_READ | PROT_WRITE, MAP_PRIVATE |
+		    MAP_ANON, -1, 0);
+	}
 	assert(ret != NULL);
 
 	if (ret == MAP_FAILED)
 		ret = NULL;
 	else if (addr != NULL && ret != addr) {
 		/*
 		 * We succeeded in mapping memory, but not in the right place.
 		 */
@@ -2127,427 +2170,382 @@ pages_unmap(void *addr, size_t size)
 		_malloc_message(_getprogname(),
 		    ": (malloc) Error in munmap(): ", buf, "\n");
 		if (opt_abort)
 			abort();
 	}
 }
 #endif
 
-#ifdef MALLOC_DSS
-static void *
-chunk_alloc_dss(size_t size)
-{
-
-	/*
-	 * sbrk() uses a signed increment argument, so take care not to
-	 * interpret a huge allocation request as a negative increment.
-	 */
-	if ((intptr_t)size < 0)
-		return (NULL);
-
-	malloc_mutex_lock(&dss_mtx);
-	if (dss_prev != (void *)-1) {
-		intptr_t incr;
-
-		/*
-		 * The loop is necessary to recover from races with other
-		 * threads that are using the DSS for something other than
-		 * malloc.
-		 */
-		do {
-			void *ret;
-
-			/* Get the current end of the DSS. */
-			dss_max = sbrk(0);
-
-			/*
-			 * Calculate how much padding is necessary to
-			 * chunk-align the end of the DSS.
-			 */
-			incr = (intptr_t)size
-			    - (intptr_t)CHUNK_ADDR2OFFSET(dss_max);
-			if (incr == (intptr_t)size)
-				ret = dss_max;
-			else {
-				ret = (void *)((intptr_t)dss_max + incr);
-				incr += size;
-			}
-
-			dss_prev = sbrk(incr);
-			if (dss_prev == dss_max) {
-				/* Success. */
-				dss_max = (void *)((intptr_t)dss_prev + incr);
-				malloc_mutex_unlock(&dss_mtx);
-				return (ret);
-			}
-		} while (dss_prev != (void *)-1);
-	}
-	malloc_mutex_unlock(&dss_mtx);
-
-	return (NULL);
-}
-
-static void *
-chunk_recycle_dss(size_t size, bool zero)
-{
-	extent_node_t *node, key;
-
-	key.addr = NULL;
-	key.size = size;
-	malloc_mutex_lock(&dss_mtx);
-	node = extent_tree_szad_nsearch(&dss_chunks_szad, &key);
-	if (node != NULL) {
-		void *ret = node->addr;
-
-		/* Remove node from the tree. */
-		extent_tree_szad_remove(&dss_chunks_szad, node);
-		if (node->size == size) {
-			extent_tree_ad_remove(&dss_chunks_ad, node);
-			base_node_dealloc(node);
-		} else {
-			/*
-			 * Insert the remainder of node's address range as a
-			 * smaller chunk.  Its position within dss_chunks_ad
-			 * does not change.
-			 */
-			assert(node->size > size);
-			node->addr = (void *)((uintptr_t)node->addr + size);
-			node->size -= size;
-			extent_tree_szad_insert(&dss_chunks_szad, node);
-		}
-		malloc_mutex_unlock(&dss_mtx);
-
-		if (zero)
-			memset(ret, 0, size);
-		return (ret);
-	}
-	malloc_mutex_unlock(&dss_mtx);
-
-	return (NULL);
-}
-#endif
-
-#ifdef MOZ_MEMORY_WINDOWS
-static inline void *
-chunk_alloc_mmap(size_t size)
+static inline void *
+chunk_alloc_mmap(size_t size, bool pagefile)
 {
 	void *ret;
 	size_t offset;
+	int pfd;
+
+#ifdef MALLOC_PAGEFILE
+	if (opt_pagefile && pagefile) {
+		pfd = pagefile_init(size);
+		if (pfd == -1)
+			return (NULL);
+	} else
+#endif
+		pfd = -1;
 
 	/*
 	 * Windows requires that there be a 1:1 mapping between VM
 	 * allocation/deallocation operations.  Therefore, take care here to
 	 * acquire the final result via one mapping operation.  This means
 	 * unmapping any preliminary result that is not correctly aligned.
-	 */
-
-	ret = pages_map(NULL, size);
+	 *
+	 * The MALLOC_PAGEFILE code also benefits from this mapping algorithm,
+	 * since it reduces the number of page files.
+	 */
+
+	ret = pages_map(NULL, size, pfd);
 	if (ret == NULL)
-		return (NULL);
+		goto RETURN;
 
 	offset = CHUNK_ADDR2OFFSET(ret);
 	if (offset != 0) {
 		/* Deallocate, then try to allocate at (ret + size - offset). */
 		pages_unmap(ret, size);
-		ret = pages_map((void *)((uintptr_t)ret + size - offset), size);
+		ret = pages_map((void *)((uintptr_t)ret + size - offset), size,
+		    pfd);
 		while (ret == NULL) {
 			/*
 			 * Over-allocate in order to map a memory region that
 			 * is definitely large enough.
 			 */
-			ret = pages_map(NULL, size + chunksize);
+			ret = pages_map(NULL, size + chunksize, -1);
 			if (ret == NULL)
-				return (NULL);
+				goto RETURN;
 			/*
 			 * Deallocate, then allocate the correct size, within
 			 * the over-sized mapping.
 			 */
 			offset = CHUNK_ADDR2OFFSET(ret);
 			pages_unmap(ret, size + chunksize);
 			if (offset == 0)
-				ret = pages_map(ret, size);
+				ret = pages_map(ret, size, pfd);
 			else {
 				ret = pages_map((void *)((uintptr_t)ret +
-				    chunksize - offset), size);
+				    chunksize - offset), size, pfd);
 			}
 			/*
 			 * Failure here indicates a race with another thread, so
 			 * try again.
 			 */
 		}
 	}
 
-	return (ret);
-}
-#else
-static inline void *
-chunk_alloc_mmap(size_t size)
-{
-	void *ret;
-	size_t offset;
-
-	/*
-	 * Ideally, there would be a way to specify alignment to mmap() (like
-	 * NetBSD has), but in the absence of such a feature, we have to work
-	 * hard to efficiently create aligned mappings.  The reliable, but
-	 * expensive method is to create a mapping that is over-sized, then
-	 * trim the excess.  However, that always results in at least one call
-	 * to pages_unmap().
-	 *
-	 * A more optimistic approach is to try mapping precisely the right
-	 * amount, then try to append another mapping if alignment is off.  In
-	 * practice, this works out well as long as the application is not
-	 * interleaving mappings via direct mmap() calls.  If we do run into a
-	 * situation where there is an interleaved mapping and we are unable to
-	 * extend an unaligned mapping, our best option is to momentarily
-	 * revert to the reliable-but-expensive method.  This will tend to
-	 * leave a gap in the memory map that is too small to cause later
-	 * problems for the optimistic method.
-	 */
-
-	ret = pages_map(NULL, size);
-	if (ret == NULL)
-		return (NULL);
-
-	offset = CHUNK_ADDR2OFFSET(ret);
-	if (offset != 0) {
-		/* Try to extend chunk boundary. */
-		if (pages_map((void *)((uintptr_t)ret + size),
-		    chunksize - offset) == NULL) {
-			/*
-			 * Extension failed.  Clean up, then revert to the
-			 * reliable-but-expensive method.
-			 */
-			pages_unmap(ret, size);
-
-			/* Beware size_t wrap-around. */
-			if (size + chunksize <= size)
-				return NULL;
-
-			ret = pages_map(NULL, size + chunksize);
-			if (ret == NULL)
-				return (NULL);
-
-			/* Clean up unneeded leading/trailing space. */
-			offset = CHUNK_ADDR2OFFSET(ret);
-			if (offset != 0) {
-				/* Leading space. */
-				pages_unmap(ret, chunksize - offset);
-
-				ret = (void *)((uintptr_t)ret +
-				    (chunksize - offset));
-
-				/* Trailing space. */
-				pages_unmap((void *)((uintptr_t)ret + size),
-				    offset);
+RETURN:
+#ifdef MALLOC_PAGEFILE
+	if (pfd != -1)
+		pagefile_close(pfd);
+#endif
+	return (ret);
+}
+
+#ifdef MALLOC_PAGEFILE
+static int
+pagefile_init(size_t size)
+{
+	int ret;
+	size_t i;
+	char pagefile_path[PATH_MAX];
+	char zbuf[MALLOC_PAGEFILE_WRITE_SIZE];
+
+	/*
+	 * Create a temporary file, then immediately unlink it so that it will
+	 * not persist.
+	 */
+	strcpy(pagefile_path, pagefile_templ);
+	ret = mkstemp(pagefile_path);
+	if (ret == -1)
+		return (ret);
+	if (unlink(pagefile_path)) {
+		char buf[STRERROR_BUF];
+
+		strerror_r(errno, buf, sizeof(buf));
+		_malloc_message(_getprogname(), ": (malloc) Error in unlink(\"",
+		    pagefile_path, "\"):");
+		_malloc_message(buf, "\n", "", "");
+		if (opt_abort)
+			abort();
+	}
+
+	/*
+	 * Write sequential zeroes to the file in order to assure that disk
+	 * space is committed, with minimal fragmentation.  It would be
+	 * sufficient to write one zero per disk block, but that potentially
+	 * results in more system calls, for no real gain.
+	 */
+	memset(zbuf, 0, sizeof(zbuf));
+	for (i = 0; i < size; i += sizeof(zbuf)) {
+		if (write(ret, zbuf, sizeof(zbuf)) != sizeof(zbuf)) {
+			if (errno != ENOSPC) {
+				char buf[STRERROR_BUF];
+
+				strerror_r(errno, buf, sizeof(buf));
+				_malloc_message(_getprogname(),
+				    ": (malloc) Error in write(): ", buf, "\n");
+				if (opt_abort)
+					abort();
+			}
+			pagefile_close(ret);
+			return (-1);
+		}
+	}
+
+	return (ret);
+}
+
+static void
+pagefile_close(int pfd)
+{
+
+	if (close(pfd)) {
+		char buf[STRERROR_BUF];
+
+		strerror_r(errno, buf, sizeof(buf));
+		_malloc_message(_getprogname(),
+		    ": (malloc) Error in close(): ", buf, "\n");
+		if (opt_abort)
+			abort();
+	}
+}
+#endif
+
+static void *
+chunk_recycle_reserve(size_t size, bool zero)
+{
+	extent_node_t *node, key;
+
+#ifdef MALLOC_DECOMMIT
+	if (size != chunksize)
+		return (NULL);
+#endif
+
+	key.addr = NULL;
+	key.size = size;
+	malloc_mutex_lock(&reserve_mtx);
+	node = extent_tree_szad_nsearch(&reserve_chunks_szad, &key);
+	if (node != NULL) {
+		void *ret = node->addr;
+
+		/* Remove node from the tree. */
+		extent_tree_szad_remove(&reserve_chunks_szad, node);
+#ifndef MALLOC_DECOMMIT
+		if (node->size == size) {
+#else
+			assert(node->size == size);
+#endif
+			extent_tree_ad_remove(&reserve_chunks_ad, node);
+			base_node_dealloc(node);
+#ifndef MALLOC_DECOMMIT
+		} else {
+			/*
+			 * Insert the remainder of node's address range as a
+			 * smaller chunk.  Its position within reserve_chunks_ad
+			 * does not change.
+			 */
+			assert(node->size > size);
+			node->addr = (void *)((uintptr_t)node->addr + size);
+			node->size -= size;
+			extent_tree_szad_insert(&reserve_chunks_szad, node);
+		}
+#endif
+		reserve_cur -= size;
+		/*
+		 * Try to replenish the reserve if this allocation depleted it.
+		 */
+#ifndef MALLOC_DECOMMIT
+		if (reserve_cur < reserve_min) {
+			size_t diff = reserve_min - reserve_cur;
+#else
+		while (reserve_cur < reserve_min) {
+#  define diff chunksize
+#endif
+			void *chunk;
+
+			malloc_mutex_unlock(&reserve_mtx);
+			chunk = chunk_alloc_mmap(diff, true);
+			malloc_mutex_lock(&reserve_mtx);
+			if (chunk == NULL) {
+				uint64_t seq = 0;
+
+				do {
+					seq = reserve_notify(RESERVE_CND_LOW,
+					    size, seq);
+				} while (reserve_cur < reserve_min && seq != 0);
 			} else {
-				/* Trailing space only. */
-				pages_unmap((void *)((uintptr_t)ret + size),
-				    chunksize);
-			}
-		} else {
-			/* Clean up unneeded leading space. */
-			pages_unmap(ret, chunksize - offset);
-			ret = (void *)((uintptr_t)ret + (chunksize - offset));
-		}
-	}
-
-	return (ret);
-}
-#endif
-
-static void *
-chunk_alloc(size_t size, bool zero)
+				extent_node_t *node;
+
+				node = chunk_dealloc_reserve(chunk, diff);
+				if (node == NULL) {
+					uint64_t seq = 0;
+
+					pages_unmap(chunk, diff);
+					do {
+						seq = reserve_notify(
+						    RESERVE_CND_LOW, size, seq);
+					} while (reserve_cur < reserve_min &&
+					    seq != 0);
+				}
+			}
+		}
+		malloc_mutex_unlock(&reserve_mtx);
+
+#ifdef MALLOC_DECOMMIT
+		pages_commit(ret, size);
+#  undef diff
+#else
+		if (zero)
+			memset(ret, 0, size);
+#endif
+		return (ret);
+	}
+	malloc_mutex_unlock(&reserve_mtx);
+
+	return (NULL);
+}
+
+static void *
+chunk_alloc(size_t size, bool zero, bool pagefile)
 {
 	void *ret;
 
 	assert(size != 0);
 	assert((size & chunksize_mask) == 0);
 
-#ifdef MALLOC_DSS
-	if (opt_dss) {
-		ret = chunk_recycle_dss(size, zero);
-		if (ret != NULL) {
-			goto RETURN;
-		}
-
-		ret = chunk_alloc_dss(size);
-		if (ret != NULL)
-			goto RETURN;
-	}
-
-	if (opt_mmap)
-#endif
-	{
-		ret = chunk_alloc_mmap(size);
-		if (ret != NULL)
-			goto RETURN;
+	ret = chunk_recycle_reserve(size, zero);
+	if (ret != NULL)
+		goto RETURN;
+
+	ret = chunk_alloc_mmap(size, pagefile);
+	if (ret != NULL) {
+#ifdef MALLOC_STATS
+		stats_chunks.nchunks += (size / chunksize);
+#endif
+		goto RETURN;
 	}
 
 	/* All strategies for allocation failed. */
 	ret = NULL;
 RETURN:
 #ifdef MALLOC_STATS
-	if (ret != NULL) {
-		stats_chunks.nchunks += (size / chunksize);
+	if (ret != NULL)
 		stats_chunks.curchunks += (size / chunksize);
-	}
 	if (stats_chunks.curchunks > stats_chunks.highchunks)
 		stats_chunks.highchunks = stats_chunks.curchunks;
 #endif
 
 	assert(CHUNK_ADDR2BASE(ret) == ret);
 	return (ret);
 }
 
-#ifdef MALLOC_DSS
 static extent_node_t *
-chunk_dealloc_dss_record(void *chunk, size_t size)
-{
-	extent_node_t *node, *prev, key;
+chunk_dealloc_reserve(void *chunk, size_t size)
+{
+	extent_node_t *node;
+
+#ifdef MALLOC_DECOMMIT
+	if (size != chunksize)
+		return (NULL);
+#else
+	extent_node_t *prev, key;
 
 	key.addr = (void *)((uintptr_t)chunk + size);
-	node = extent_tree_ad_nsearch(&dss_chunks_ad, &key);
+	node = extent_tree_ad_nsearch(&reserve_chunks_ad, &key);
 	/* Try to coalesce forward. */
 	if (node != NULL && node->addr == key.addr) {
 		/*
 		 * Coalesce chunk with the following address range.  This does
-		 * not change the position within dss_chunks_ad, so only
-		 * remove/insert from/into dss_chunks_szad.
-		 */
-		extent_tree_szad_remove(&dss_chunks_szad, node);
+		 * not change the position within reserve_chunks_ad, so only
+		 * remove/insert from/into reserve_chunks_szad.
+		 */
+		extent_tree_szad_remove(&reserve_chunks_szad, node);
 		node->addr = chunk;
 		node->size += size;
-		extent_tree_szad_insert(&dss_chunks_szad, node);
-	} else {
-		/*
-		 * Coalescing forward failed, so insert a new node.  Drop
-		 * dss_mtx during node allocation, since it is possible that a
-		 * new base chunk will be allocated.
-		 */
-		malloc_mutex_unlock(&dss_mtx);
+		extent_tree_szad_insert(&reserve_chunks_szad, node);
+	} else {
+#endif
+		/* Coalescing forward failed, so insert a new node. */
 		node = base_node_alloc();
-		malloc_mutex_lock(&dss_mtx);
 		if (node == NULL)
 			return (NULL);
 		node->addr = chunk;
 		node->size = size;
-		extent_tree_ad_insert(&dss_chunks_ad, node);
-		extent_tree_szad_insert(&dss_chunks_szad, node);
+		extent_tree_ad_insert(&reserve_chunks_ad, node);
+		extent_tree_szad_insert(&reserve_chunks_szad, node);
+#ifndef MALLOC_DECOMMIT
 	}
 
 	/* Try to coalesce backward. */
-	prev = extent_tree_ad_prev(&dss_chunks_ad, node);
+	prev = extent_tree_ad_prev(&reserve_chunks_ad, node);
 	if (prev != NULL && (void *)((uintptr_t)prev->addr + prev->size) ==
 	    chunk) {
 		/*
 		 * Coalesce chunk with the previous address range.  This does
-		 * not change the position within dss_chunks_ad, so only
-		 * remove/insert node from/into dss_chunks_szad.
-		 */
-		extent_tree_szad_remove(&dss_chunks_szad, prev);
-		extent_tree_ad_remove(&dss_chunks_ad, prev);
-
-		extent_tree_szad_remove(&dss_chunks_szad, node);
+		 * not change the position within reserve_chunks_ad, so only
+		 * remove/insert node from/into reserve_chunks_szad.
+		 */
+		extent_tree_szad_remove(&reserve_chunks_szad, prev);
+		extent_tree_ad_remove(&reserve_chunks_ad, prev);
+
+		extent_tree_szad_remove(&reserve_chunks_szad, node);
 		node->addr = prev->addr;
 		node->size += prev->size;
-		extent_tree_szad_insert(&dss_chunks_szad, node);
+		extent_tree_szad_insert(&reserve_chunks_szad, node);
 
 		base_node_dealloc(prev);
 	}
+#endif
+
+#ifdef MALLOC_DECOMMIT
+	pages_decommit(chunk, size);
+#else
+	madvise(chunk, size, MADV_FREE);
+#endif
+
+	reserve_cur += size;
+	if (reserve_cur > reserve_max)
+		reserve_shrink();
 
 	return (node);
 }
 
-static bool
-chunk_dealloc_dss(void *chunk, size_t size)
-{
-
-	malloc_mutex_lock(&dss_mtx);
-	if ((uintptr_t)chunk >= (uintptr_t)dss_base
-	    && (uintptr_t)chunk < (uintptr_t)dss_max) {
-		extent_node_t *node;
-
-		/* Try to coalesce with other unused chunks. */
-		node = chunk_dealloc_dss_record(chunk, size);
-		if (node != NULL) {
-			chunk = node->addr;
-			size = node->size;
-		}
-
-		/* Get the current end of the DSS. */
-		dss_max = sbrk(0);
-
-		/*
-		 * Try to shrink the DSS if this chunk is at the end of the
-		 * DSS.  The sbrk() call here is subject to a race condition
-		 * with threads that use brk(2) or sbrk(2) directly, but the
-		 * alternative would be to leak memory for the sake of poorly
-		 * designed multi-threaded programs.
-		 */
-		if ((void *)((uintptr_t)chunk + size) == dss_max
-		    && (dss_prev = sbrk(-(intptr_t)size)) == dss_max) {
-			/* Success. */
-			dss_max = (void *)((intptr_t)dss_prev - (intptr_t)size);
-
-			if (node != NULL) {
-				extent_tree_szad_remove(&dss_chunks_szad, node);
-				extent_tree_ad_remove(&dss_chunks_ad, node);
-				base_node_dealloc(node);
-			}
-			malloc_mutex_unlock(&dss_mtx);
-		} else {
-			malloc_mutex_unlock(&dss_mtx);
-#ifdef MOZ_MEMORY_WINDOWS
-			VirtualAlloc(chunk, size, MEM_RESET, PAGE_READWRITE);
-#elif (defined(MOZ_MEMORY_DARWIN))
-			mmap(chunk, size, PROT_READ | PROT_WRITE, MAP_PRIVATE
-			    | MAP_ANON | MAP_FIXED, -1, 0);
-#else
-			madvise(chunk, size, MADV_FREE);
-#endif
-		}
-
-		return (false);
-	}
-	malloc_mutex_unlock(&dss_mtx);
-
-	return (true);
-}
-#endif
-
 static void
 chunk_dealloc_mmap(void *chunk, size_t size)
 {
 
 	pages_unmap(chunk, size);
 }
 
 static void
 chunk_dealloc(void *chunk, size_t size)
 {
+	extent_node_t *node;
 
 	assert(chunk != NULL);
 	assert(CHUNK_ADDR2BASE(chunk) == chunk);
 	assert(size != 0);
 	assert((size & chunksize_mask) == 0);
 
 #ifdef MALLOC_STATS
 	stats_chunks.curchunks -= (size / chunksize);
 #endif
 
-#ifdef MALLOC_DSS
-	if (opt_dss) {
-		if (chunk_dealloc_dss(chunk, size) == false)
-			return;
-	}
-
-	if (opt_mmap)
-#endif
+	/* Try to merge chunk into the reserve. */
+	malloc_mutex_lock(&reserve_mtx);
+	node = chunk_dealloc_reserve(chunk, size);
+	malloc_mutex_unlock(&reserve_mtx);
+	if (node == NULL)
 		chunk_dealloc_mmap(chunk, size);
 }
 
 /*
  * End chunk management functions.
  */
 /******************************************************************************/
 /*
@@ -2956,17 +2954,17 @@ arena_run_split(arena_t *arena, arena_ru
 				    CHUNK_MAP_DECOMMITTED;
 			}
 
 			pages_commit((void *)((uintptr_t)chunk + ((run_ind + i)
 			    << pagesize_2pow)), (j << pagesize_2pow));
 #  ifdef MALLOC_STATS
 			arena->stats.ncommit++;
 #  endif
-		}
+		} else /* No need to zero since commit zeros. */
 #endif
 
 		/* Zero if necessary. */
 		if (zero) {
 			if ((chunk->map[run_ind + i] & CHUNK_MAP_UNTOUCHED)
 			    == 0) {
 				VALGRIND_MALLOCLIKE_BLOCK((void *)((uintptr_t)
 				    chunk + ((run_ind + i) << pagesize_2pow)),
@@ -3009,163 +3007,194 @@ arena_run_split(arena_t *arena, arena_ru
 		arena_chunk_node_dealloc(chunk, nodeB);
 	}
 
 	chunk->pages_used += need_pages;
 	if (chunk->ndirty == 0 && old_ndirty > 0)
 		arena_chunk_tree_dirty_remove(&arena->chunks_dirty, chunk);
 }
 
-static arena_chunk_t *
-arena_chunk_alloc(arena_t *arena)
-{
-	arena_chunk_t *chunk;
+static void
+arena_chunk_init(arena_t *arena, arena_chunk_t *chunk)
+{
 	extent_node_t *node;
 
-	if (arena->spare != NULL) {
-		chunk = arena->spare;
-		arena->spare = NULL;
-	} else {
-		chunk = (arena_chunk_t *)chunk_alloc(chunksize, true);
-		if (chunk == NULL)
-			return (NULL);
-		VALGRIND_MALLOCLIKE_BLOCK(chunk, (arena_chunk_header_npages <<
-		    pagesize_2pow), 0, false);
-#ifdef MALLOC_STATS
-		arena->stats.mapped += chunksize;
-#endif
-
-		chunk->arena = arena;
-
-		arena_chunk_tree_all_insert(&arena->chunks_all, chunk);
-
-		/*
-		 * Claim that no pages are in use, since the header is merely
-		 * overhead.
-		 */
-		chunk->pages_used = 0;
-		chunk->ndirty = 0;
-
-		/*
-		 * Initialize the map to contain one maximal free untouched
-		 * run.
-		 */
-		memset(chunk->map, (CHUNK_MAP_LARGE | CHUNK_MAP_POS_MASK),
-		    arena_chunk_header_npages);
-		memset(&chunk->map[arena_chunk_header_npages],
-		    (CHUNK_MAP_UNTOUCHED
-#ifdef MALLOC_DECOMMIT
-		    | CHUNK_MAP_DECOMMITTED
-#endif
-		    ), (chunk_npages -
-		    arena_chunk_header_npages));
-
-		/* Initialize the tree of unused extent nodes. */
-		extent_tree_ad_new(&chunk->nodes);
-		chunk->nodes_past = (extent_node_t *)QUANTUM_CEILING(
-		    (uintptr_t)&chunk->map[chunk_npages]);
-
-#ifdef MALLOC_DECOMMIT
-		/*
-		 * Start out decommitted, in order to force a closer
-		 * correspondence between dirty pages and committed untouched
-		 * pages.
-		 */
-		pages_decommit((void *)((uintptr_t)chunk +
-		    (arena_chunk_header_npages << pagesize_2pow)),
-		    ((chunk_npages - arena_chunk_header_npages) <<
-		    pagesize_2pow));
+	VALGRIND_MALLOCLIKE_BLOCK(chunk, (arena_chunk_header_npages <<
+	    pagesize_2pow), 0, false);
+#ifdef MALLOC_STATS
+	arena->stats.mapped += chunksize;
+#endif
+
+	chunk->arena = arena;
+
+	arena_chunk_tree_all_insert(&arena->chunks_all, chunk);
+
+	/*
+	 * Claim that no pages are in use, since the header is merely overhead.
+	 */
+	chunk->pages_used = 0;
+	chunk->ndirty = 0;
+
+	/* Initialize the map to contain one maximal free untouched run. */
+	memset(chunk->map, (CHUNK_MAP_LARGE | CHUNK_MAP_POS_MASK),
+	    arena_chunk_header_npages);
+	memset(&chunk->map[arena_chunk_header_npages], (CHUNK_MAP_UNTOUCHED
+#ifdef MALLOC_DECOMMIT
+	    | CHUNK_MAP_DECOMMITTED
+#endif
+	    ), (chunk_npages -
+	    arena_chunk_header_npages));
+
+	/* Initialize the tree of unused extent nodes. */
+	extent_tree_ad_new(&chunk->nodes);
+	chunk->nodes_past = (extent_node_t *)QUANTUM_CEILING(
+	    (uintptr_t)&chunk->map[chunk_npages]);
+
+#ifdef MALLOC_DECOMMIT
+	/*
+	 * Start out decommitted, in order to force a closer correspondence
+	 * between dirty pages and committed untouched pages.
+	 */
+	pages_decommit((void *)((uintptr_t)chunk +
+	    (arena_chunk_header_npages << pagesize_2pow)),
+	    ((chunk_npages - arena_chunk_header_npages) <<
+	    pagesize_2pow));
 #  ifdef MALLOC_STATS
-		arena->stats.ndecommit++;
-		arena->stats.decommitted += (chunk_npages -
-		    arena_chunk_header_npages);
-#  endif
-#endif
-	}
+	arena->stats.ndecommit++;
+	arena->stats.decommitted += (chunk_npages - arena_chunk_header_npages);
+#  endif
+#endif
 
 	/* Insert the run into the runs_avail_* red-black trees. */
 	node = arena_chunk_node_alloc(chunk);
 	node->addr = (void *)((uintptr_t)chunk + (arena_chunk_header_npages <<
 	    pagesize_2pow));
 	node->size = chunksize - (arena_chunk_header_npages << pagesize_2pow);
 	extent_tree_szad_insert(&arena->runs_avail_szad, node);
 	extent_tree_ad_insert(&arena->runs_avail_ad, node);
-
-	return (chunk);
 }
 
 static void
 arena_chunk_dealloc(arena_t *arena, arena_chunk_t *chunk)
 {
 	extent_node_t *node, key;
-
-	if (arena->spare != NULL) {
-		arena_chunk_tree_all_remove(&chunk->arena->chunks_all,
-		    arena->spare);
-		if (arena->spare->ndirty > 0) {
-			arena_chunk_tree_dirty_remove(
-			    &chunk->arena->chunks_dirty, arena->spare);
-			arena->ndirty -= arena->spare->ndirty;
-		}
-		VALGRIND_FREELIKE_BLOCK(arena->spare, 0);
-		chunk_dealloc((void *)arena->spare, chunksize);
-#ifdef MALLOC_STATS
-		arena->stats.mapped -= chunksize;
-#endif
-	}
 
 	/*
 	 * Remove run from the runs trees, regardless of whether this chunk
 	 * will be cached, so that the arena does not use it.  Dirty page
 	 * flushing only uses the chunks_dirty tree, so leaving this chunk in
 	 * the chunks_* trees is sufficient for that purpose.
 	 */
 	key.addr = (void *)((uintptr_t)chunk + (arena_chunk_header_npages <<
 	    pagesize_2pow));
 	node = extent_tree_ad_search(&arena->runs_avail_ad, &key);
 	assert(node != NULL);
 	extent_tree_szad_remove(&arena->runs_avail_szad, node);
 	extent_tree_ad_remove(&arena->runs_avail_ad, node);
 	arena_chunk_node_dealloc(chunk, node);
 
-	arena->spare = chunk;
+	arena_chunk_tree_all_remove(&chunk->arena->chunks_all,
+	    chunk);
+	if (chunk->ndirty > 0) {
+		arena_chunk_tree_dirty_remove(
+		    &chunk->arena->chunks_dirty, chunk);
+		arena->ndirty -= chunk->ndirty;
+	}
+	VALGRIND_FREELIKE_BLOCK(chunk, 0);
+	chunk_dealloc((void *)chunk, chunksize);
+#ifdef MALLOC_STATS
+	arena->stats.mapped -= chunksize;
+#endif
 }
 
 static arena_run_t *
-arena_run_alloc(arena_t *arena, size_t size, bool small, bool zero)
+arena_run_alloc(arena_t *arena, arena_bin_t *bin, size_t size, bool small,
+    bool zero)
 {
 	arena_chunk_t *chunk;
 	arena_run_t *run;
 	extent_node_t *node, key;
 
 	assert(size <= (chunksize - (arena_chunk_header_npages <<
 	    pagesize_2pow)));
 	assert((size & pagesize_mask) == 0);
 
-	/* Search the arena's chunks for the lowest best fit. */
-	key.addr = NULL;
-	key.size = size;
-	node = extent_tree_szad_nsearch(&arena->runs_avail_szad, &key);
-	if (node != NULL) {
-		run = (arena_run_t *)node->addr;
+	chunk = NULL;
+	while (true) {
+		/* Search the arena's chunks for the lowest best fit. */
+		key.addr = NULL;
+		key.size = size;
+		node = extent_tree_szad_nsearch(&arena->runs_avail_szad, &key);
+		if (node != NULL) {
+			if (chunk != NULL)
+				chunk_dealloc(chunk, chunksize);
+			run = (arena_run_t *)node->addr;
+			arena_run_split(arena, run, size, small, zero);
+			return (run);
+		}
+
+		/*
+		 * No usable runs.  Create a new chunk from which to allocate
+		 * the run.
+		 */
+		if (chunk == NULL) {
+			uint64_t chunk_seq;
+
+			/*
+			 * Record the chunk allocation sequence number in order
+			 * to detect races.
+			 */
+			arena->chunk_seq++;
+			chunk_seq = arena->chunk_seq;
+
+			/*
+			 * Drop the arena lock while allocating a chunk, since
+			 * reserve notifications may cause recursive
+			 * allocation.  Dropping the lock here opens an
+			 * allocataion race, but we recover.
+			 */
+			malloc_mutex_unlock(&arena->lock);
+			chunk = (arena_chunk_t *)chunk_alloc(chunksize, true,
+			    true);
+			malloc_mutex_lock(&arena->lock);
+
+			/*
+			 * Check whether a race allowed a usable run to appear.
+			 */
+			if (bin != NULL && (run = bin->runcur) != NULL &&
+			    run->nfree > 0) {
+				if (chunk != NULL)
+					chunk_dealloc(chunk, chunksize);
+				return (run);
+			}
+
+			/*
+			 * If this thread raced with another such that multiple
+			 * chunks were allocated, make sure that there is still
+			 * inadequate space before using this chunk.
+			 */
+			if (chunk_seq != arena->chunk_seq)
+				continue;
+
+			/*
+			 * Check for an error *after* checking for a race,
+			 * since a race could also cause a transient OOM
+			 * condition.
+			 */
+			if (chunk == NULL)
+				return (NULL);
+		}
+
+		arena_chunk_init(arena, chunk);
+		run = (arena_run_t *)((uintptr_t)chunk +
+		    (arena_chunk_header_npages << pagesize_2pow));
+		/* Update page map. */
 		arena_run_split(arena, run, size, small, zero);
 		return (run);
 	}
-
-	/*
-	 * No usable runs.  Create a new chunk from which to allocate the run.
-	 */
-	chunk = arena_chunk_alloc(arena);
-	if (chunk == NULL)
-		return (NULL);
-	run = (arena_run_t *)((uintptr_t)chunk + (arena_chunk_header_npages <<
-	    pagesize_2pow));
-	/* Update page map. */
-	arena_run_split(arena, run, size, small, zero);
-	return (run);
 }
 
 static void
 arena_purge(arena_t *arena)
 {
 	arena_chunk_t *chunk;
 	size_t i, npages;
 #ifdef MALLOC_DEBUG
@@ -3428,19 +3457,25 @@ arena_bin_nonfull_run_get(arena_t *arena
 #ifdef MALLOC_STATS
 		bin->stats.reruns++;
 #endif
 		return (run);
 	}
 	/* No existing runs have any space available. */
 
 	/* Allocate a new run. */
-	run = arena_run_alloc(arena, bin->run_size, true, false);
+	run = arena_run_alloc(arena, bin, bin->run_size, true, false);
 	if (run == NULL)
 		return (NULL);
+	/*
+	 * Don't initialize if a race in arena_run_alloc() allowed an existing
+	 * run to become usable.
+	 */
+	if (run == bin->runcur)
+		return (run);
 
 	VALGRIND_MALLOCLIKE_BLOCK(run, sizeof(arena_run_t) + (sizeof(unsigned) *
 	    (bin->regs_mask_nelms - 1)), 0, false);
 
 	/* Initialize run internals. */
 	run->bin = bin;
 
 	for (i = 0; i < bin->regs_mask_nelms - 1; i++)
@@ -3717,17 +3752,17 @@ arena_malloc_large(arena_t *arena, size_
 
 	/* Large allocation. */
 	size = PAGE_CEILING(size);
 #ifdef MALLOC_BALANCE
 	arena_lock_balance(arena);
 #else
 	malloc_spin_lock(&arena->lock);
 #endif
-	ret = (void *)arena_run_alloc(arena, size, false, zero);
+	ret = (void *)arena_run_alloc(arena, NULL, size, false, zero);
 	if (ret == NULL) {
 		malloc_spin_unlock(&arena->lock);
 		return (NULL);
 	}
 #ifdef MALLOC_STATS
 	arena->stats.nmalloc_large++;
 	arena->stats.allocated_large += size;
 #endif
@@ -3795,17 +3830,17 @@ arena_palloc(arena_t *arena, size_t alig
 	assert((size & pagesize_mask) == 0);
 	assert((alignment & pagesize_mask) == 0);
 
 #ifdef MALLOC_BALANCE
 	arena_lock_balance(arena);
 #else
 	malloc_spin_lock(&arena->lock);
 #endif
-	ret = (void *)arena_run_alloc(arena, alloc_size, false, false);
+	ret = (void *)arena_run_alloc(arena, NULL, alloc_size, false, false);
 	if (ret == NULL) {
 		malloc_spin_unlock(&arena->lock);
 		return (NULL);
 	}
 
 	chunk = (arena_chunk_t *)CHUNK_ADDR2BASE(ret);
 
 	offset = (uintptr_t)ret & (alignment - 1);
@@ -4145,16 +4180,17 @@ arena_dalloc_small(arena_t *arena, arena
 		if (run == bin->runcur)
 			bin->runcur = NULL;
 		else if (bin->nregs != 1) {
 			/*
 			 * This block's conditional is necessary because if the
 			 * run only contains one region, then it never gets
 			 * inserted into the non-full runs tree.
 			 */
+			assert(arena_run_tree_search(&bin->runs, run) == run);
 			arena_run_tree_remove(&bin->runs, run);
 		}
 #ifdef MALLOC_DEBUG
 		run->magic = 0;
 #endif
 		VALGRIND_FREELIKE_BLOCK(run, 0);
 		arena_run_dalloc(arena, run, true);
 #ifdef MALLOC_STATS
@@ -4166,21 +4202,25 @@ arena_dalloc_small(arena_t *arena, arena
 		 * non-full run, if one exists.
 		 */
 		if (bin->runcur == NULL)
 			bin->runcur = run;
 		else if ((uintptr_t)run < (uintptr_t)bin->runcur) {
 			/* Switch runcur. */
 			if (bin->runcur->nfree > 0) {
 				/* Insert runcur. */
+				assert(arena_run_tree_search(&bin->runs,
+				    bin->runcur) == NULL);
 				arena_run_tree_insert(&bin->runs, bin->runcur);
 			}
 			bin->runcur = run;
-		} else
+		} else {
+			assert(arena_run_tree_search(&bin->runs, run) == NULL);
 			arena_run_tree_insert(&bin->runs, run);
+		}
 	}
 #ifdef MALLOC_STATS
 	arena->stats.allocated_small -= size;
 	arena->stats.ndalloc_small++;
 #endif
 }
 
 static void
@@ -4491,20 +4531,21 @@ arena_new(arena_t *arena)
 
 	if (malloc_spin_init(&arena->lock))
 		return (true);
 
 #ifdef MALLOC_STATS
 	memset(&arena->stats, 0, sizeof(arena_stats_t));
 #endif
 
+	arena->chunk_seq = 0;
+
 	/* Initialize chunks. */
 	arena_chunk_tree_all_new(&arena->chunks_all);
 	arena_chunk_tree_dirty_new(&arena->chunks_dirty);
-	arena->spare = NULL;
 
 	arena->ndirty = 0;
 
 	extent_tree_szad_new(&arena->runs_avail_szad);
 	extent_tree_ad_new(&arena->runs_avail_ad);
 	extent_tree_ad_new(&arena->runs_alloced_ad);
 
 #ifdef MALLOC_BALANCE
@@ -4622,17 +4663,17 @@ huge_malloc(size_t size, bool zero)
 		return (NULL);
 	}
 
 	/* Allocate an extent node with which to track the chunk. */
 	node = base_node_alloc();
 	if (node == NULL)
 		return (NULL);
 
-	ret = chunk_alloc(csize, zero);
+	ret = chunk_alloc(csize, zero, true);
 	if (ret == NULL) {
 		base_node_dealloc(node);
 		return (NULL);
 	}
 
 	/* Insert node into huge. */
 	node->addr = ret;
 #ifdef MALLOC_DECOMMIT
@@ -4690,16 +4731,17 @@ huge_palloc(size_t alignment, size_t siz
 huge_palloc(size_t alignment, size_t size)
 {
 	void *ret;
 	size_t alloc_size, chunk_size, offset;
 #ifdef MALLOC_DECOMMIT
 	size_t psize;
 #endif
 	extent_node_t *node;
+	int pfd;
 
 	/*
 	 * This allocation requires alignment that is even larger than chunk
 	 * alignment.  This means that huge_malloc() isn't good enough.
 	 *
 	 * Allocate almost twice as many chunks as are demanded by the size or
 	 * alignment, in order to assure the alignment can be achieved, then
 	 * unmap leading and trailing chunks.
@@ -4713,73 +4755,53 @@ huge_palloc(size_t alignment, size_t siz
 	else
 		alloc_size = (alignment << 1) - chunksize;
 
 	/* Allocate an extent node with which to track the chunk. */
 	node = base_node_alloc();
 	if (node == NULL)
 		return (NULL);
 
-#ifdef MOZ_MEMORY_WINDOWS
 	/*
 	 * Windows requires that there be a 1:1 mapping between VM
 	 * allocation/deallocation operations.  Therefore, take care here to
 	 * acquire the final result via one mapping operation.
-	 */
+	 *
+	 * The MALLOC_PAGEFILE code also benefits from this mapping algorithm,
+	 * since it reduces the number of page files.
+	 */
+#ifdef MALLOC_PAGEFILE
+	if (opt_pagefile) {
+		pfd = pagefile_init(size);
+		if (pfd == -1)
+			return (NULL);
+	} else
+#endif
+		pfd = -1;
 	do {
 		void *over;
 
-		over = chunk_alloc(alloc_size, false);
+		over = chunk_alloc(alloc_size, false, false);
 		if (over == NULL) {
 			base_node_dealloc(node);
-			return (NULL);
+			ret = NULL;
+			goto RETURN;
 		}
 
 		offset = (uintptr_t)over & (alignment - 1);
 		assert((offset & chunksize_mask) == 0);
 		assert(offset < alloc_size);
 		ret = (void *)((uintptr_t)over + offset);
 		chunk_dealloc(over, alloc_size);
-		ret = pages_map(ret, chunk_size);
+		ret = pages_map(ret, chunk_size, pfd);
 		/*
 		 * Failure here indicates a race with another thread, so try
 		 * again.
 		 */
 	} while (ret == NULL);
-#else
-	ret = chunk_alloc(alloc_size, false);
-	if (ret == NULL) {
-		base_node_dealloc(node);
-		return (NULL);
-	}
-
-	offset = (uintptr_t)ret & (alignment - 1);
-	assert((offset & chunksize_mask) == 0);
-	assert(offset < alloc_size);
-	if (offset == 0) {
-		/* Trim trailing space. */
-		chunk_dealloc((void *)((uintptr_t)ret + chunk_size), alloc_size
-		    - chunk_size);
-	} else {
-		size_t trailsize;
-
-		/* Trim leading space. */
-		chunk_dealloc(ret, alignment - offset);
-
-		ret = (void *)((uintptr_t)ret + (alignment - offset));
-
-		trailsize = alloc_size - (alignment - offset) - chunk_size;
-		if (trailsize != 0) {
-		    /* Trim trailing space. */
-		    assert(trailsize < alloc_size);
-		    chunk_dealloc((void *)((uintptr_t)ret + chunk_size),
-			trailsize);
-		}
-	}
-#endif
 
 	/* Insert node into huge. */
 	node->addr = ret;
 #ifdef MALLOC_DECOMMIT
 	psize = PAGE_CEILING(size);
 	node->size = psize;
 #else
 	node->size = chunk_size;
@@ -4820,16 +4842,21 @@ huge_palloc(size_t alignment, size_t siz
 	else if (opt_zero)
 #  ifdef MALLOC_DECOMMIT
 		memset(ret, 0, psize);
 #  else
 		memset(ret, 0, chunk_size);
 #  endif
 #endif
 
+RETURN:
+#ifdef MALLOC_PAGEFILE
+	if (pfd != -1)
+		pagefile_close(pfd);
+#endif
 	return (ret);
 }
 
 static void *
 huge_ralloc(void *ptr, size_t size, size_t oldsize)
 {
 	void *ret;
 	size_t copysize;
@@ -4930,21 +4957,19 @@ huge_dalloc(void *ptr)
 #ifdef MALLOC_STATS
 	huge_ndalloc++;
 	huge_allocated -= node->size;
 #endif
 
 	malloc_mutex_unlock(&huge_mtx);
 
 	/* Unmap chunk. */
-#ifdef MALLOC_DSS
-#ifdef MALLOC_FILL
-	if (opt_dss && opt_junk)
+#ifdef MALLOC_FILL
+	if (opt_junk)
 		memset(node->addr, 0x5a, node->size);
-#endif
 #endif
 #ifdef MALLOC_DECOMMIT
 	chunk_dealloc(node->addr, CHUNK_CEILING(node->size));
 #else
 	chunk_dealloc(node->addr, node->size);
 #endif
 	VALGRIND_FREELIKE_BLOCK(node->addr, 0);
 
@@ -5069,24 +5094,21 @@ malloc_print_stats(void)
 #ifdef NDEBUG
 		    "disabled",
 #else
 		    "enabled",
 #endif
 		    "\n", "");
 		_malloc_message("Boolean MALLOC_OPTIONS: ",
 		    opt_abort ? "A" : "a", "", "");
-#ifdef MALLOC_DSS
-		_malloc_message(opt_dss ? "D" : "d", "", "", "");
-#endif
 #ifdef MALLOC_FILL
 		_malloc_message(opt_junk ? "J" : "j", "", "", "");
 #endif
-#ifdef MALLOC_DSS
-		_malloc_message(opt_mmap ? "M" : "m", "", "", "");
+#ifdef MALLOC_PAGEFILE
+		_malloc_message(opt_pagefile ? "o" : "O", "", "", "");
 #endif
 		_malloc_message("P", "", "", "");
 #ifdef MALLOC_UTRACE
 		_malloc_message(opt_utrace ? "U" : "u", "", "", "");
 #endif
 #ifdef MALLOC_SYSV
 		_malloc_message(opt_sysv ? "V" : "v", "", "", "");
 #endif
@@ -5153,16 +5175,32 @@ malloc_print_stats(void)
 
 #ifdef MOZ_MEMORY_WINDOWS
 			malloc_printf("Allocated: %lu, mapped: %lu\n",
 			    allocated, mapped);
 #else
 			malloc_printf("Allocated: %zu, mapped: %zu\n",
 			    allocated, mapped);
 #endif
+
+			malloc_mutex_lock(&reserve_mtx);
+			malloc_printf("Reserve:    min          "
+			    "cur          max\n");
+#ifdef MOZ_MEMORY_WINDOWS
+			malloc_printf("   %12lu %12lu %12lu\n",
+			    CHUNK_CEILING(reserve_min) >> opt_chunk_2pow,
+			    reserve_cur >> opt_chunk_2pow,
+			    reserve_max >> opt_chunk_2pow);
+#else
+			malloc_printf("   %12zu %12zu %12zu\n",
+			    CHUNK_CEILING(reserve_min) >> opt_chunk_2pow,
+			    reserve_cur >> opt_chunk_2pow,
+			    reserve_max >> opt_chunk_2pow);
+#endif
+			malloc_mutex_unlock(&reserve_mtx);
 
 #ifdef MALLOC_BALANCE
 			malloc_printf("Arena balance reassignments: %llu\n",
 			    nbalance);
 #endif
 
 			/* Print chunk stats. */
 			{
@@ -5283,16 +5321,47 @@ malloc_init_hard(void)
 
 	/*
 	 * We assume that pagesize is a power of 2 when calculating
 	 * pagesize_mask and pagesize_2pow.
 	 */
 	assert(((result - 1) & result) == 0);
 	pagesize_mask = result - 1;
 	pagesize_2pow = ffs((int)result) - 1;
+
+#ifdef MALLOC_PAGEFILE
+	/*
+	 * Determine where to create page files.  It is insufficient to
+	 * unconditionally use P_tmpdir (typically "/tmp"), since for some
+	 * operating systems /tmp is a separate filesystem that is rather small.
+	 * Therefore prefer, in order, the following locations:
+	 *
+	 * 1) MALLOC_TMPDIR
+	 * 2) TMPDIR
+	 * 3) P_tmpdir
+	 */
+	{
+		char *s;
+		size_t slen;
+		static const char suffix[] = "/jemalloc.XXXXXX";
+
+		if ((s = getenv("MALLOC_TMPDIR")) == NULL && (s =
+		    getenv("TMPDIR")) == NULL)
+			s = P_tmpdir;
+		slen = strlen(s);
+		if (slen + sizeof(suffix) > sizeof(pagefile_templ)) {
+			_malloc_message(_getprogname(),
+			    ": (malloc) Page file path too long\n",
+			    "", "");
+			abort();
+		}
+		memcpy(pagefile_templ, s, slen);
+		memcpy(&pagefile_templ[slen], suffix, sizeof(suffix));
+	}
+#endif
 
 	for (i = 0; i < 3; i++) {
 		unsigned j;
 
 		/* Get runtime configuration. */
 		switch (i) {
 		case 0:
 #ifndef MOZ_MEMORY_WINDOWS
@@ -5384,34 +5453,30 @@ MALLOC_OUT:
 #ifdef MALLOC_BALANCE
 					if (opt_balance_threshold == 0)
 						opt_balance_threshold = 1;
 					else if ((opt_balance_threshold << 1)
 					    > opt_balance_threshold)
 						opt_balance_threshold <<= 1;
 #endif
 					break;
-				case 'd':
-#ifdef MALLOC_DSS
-					opt_dss = false;
-#endif
-					break;
-				case 'D':
-#ifdef MALLOC_DSS
-					opt_dss = true;
-#endif
-					break;
 				case 'f':
 					opt_dirty_max >>= 1;
 					break;
 				case 'F':
 					if (opt_dirty_max == 0)
 						opt_dirty_max = 1;
 					else if ((opt_dirty_max << 1) != 0)
 						opt_dirty_max <<= 1;
+					break;
+				case 'g':
+					opt_reserve_range_lshift--;
+					break;
+				case 'G':
+					opt_reserve_range_lshift++;
 					break;
 #ifdef MALLOC_FILL
 				case 'j':
 					opt_junk = false;
 					break;
 				case 'J':
 					opt_junk = true;
 					break;
@@ -5425,46 +5490,52 @@ MALLOC_OUT:
 					if (opt_chunk_2pow > pagesize_2pow + 1)
 						opt_chunk_2pow--;
 					break;
 				case 'K':
 					if (opt_chunk_2pow + 1 <
 					    (sizeof(size_t) << 3))
 						opt_chunk_2pow++;
 					break;
-				case 'm':
-#ifdef MALLOC_DSS
-					opt_mmap = false;
-#endif
-					break;
-				case 'M':
-#ifdef MALLOC_DSS
-					opt_mmap = true;
-#endif
-					break;
 				case 'n':
 					opt_narenas_lshift--;
 					break;
 				case 'N':
 					opt_narenas_lshift++;
 					break;
+#ifdef MALLOC_PAGEFILE
+				case 'o':
+					/* Do not over-commit. */
+					opt_pagefile = true;
+					break;
+				case 'O':
+					/* Allow over-commit. */
+					opt_pagefile = false;
+					break;
+#endif
 				case 'p':
 					opt_print_stats = false;
 					break;
 				case 'P':
 					opt_print_stats = true;
 					break;
 				case 'q':
 					if (opt_quantum_2pow > QUANTUM_2POW_MIN)
 						opt_quantum_2pow--;
 					break;
 				case 'Q':
 					if (opt_quantum_2pow < pagesize_2pow -
 					    1)
 						opt_quantum_2pow++;
+					break;
+				case 'r':
+					opt_reserve_min_lshift--;
+					break;
+				case 'R':
+					opt_reserve_min_lshift++;
 					break;
 				case 's':
 					if (opt_small_max_2pow >
 					    QUANTUM_2POW_MIN)
 						opt_small_max_2pow--;
 					break;
 				case 'S':
 					if (opt_small_max_2pow < pagesize_2pow
@@ -5512,22 +5583,16 @@ MALLOC_OUT:
 					    ": (malloc) Unsupported character "
 					    "in malloc options: '", cbuf,
 					    "'\n");
 				}
 				}
 			}
 		}
 	}
-
-#ifdef MALLOC_DSS
-	/* Make sure that there is some method for acquiring memory. */
-	if (opt_dss == false && opt_mmap == false)
-		opt_mmap = true;
-#endif
 
 	/* Take care to call atexit() only once. */
 	if (opt_print_stats) {
 #ifndef MOZ_MEMORY_WINDOWS
 		/* Print statistics at exit. */
 		atexit(malloc_print_stats);
 #endif
 	}
@@ -5587,44 +5652,28 @@ MALLOC_OUT:
 	assert(quantum >= sizeof(void *));
 	assert(quantum <= pagesize);
 	assert(chunksize >= pagesize);
 	assert(quantum * 4 <= chunksize);
 
 	/* Initialize chunks data. */
 	malloc_mutex_init(&huge_mtx);
 	extent_tree_ad_new(&huge);
-#ifdef MALLOC_DSS
-	malloc_mutex_init(&dss_mtx);
-	dss_base = sbrk(0);
-	dss_prev = dss_base;
-	dss_max = dss_base;
-	extent_tree_szad_new(&dss_chunks_szad);
-	extent_tree_ad_new(&dss_chunks_ad);
-#endif
 #ifdef MALLOC_STATS
 	huge_nmalloc = 0;
 	huge_ndalloc = 0;
 	huge_allocated = 0;
 #endif
 
 	/* Initialize base allocation data structures. */
 #ifdef MALLOC_STATS
 	base_mapped = 0;
 #endif
-#ifdef MALLOC_DSS
-	/*
-	 * Allocate a base chunk here, since it doesn't actually have to be
-	 * chunk-aligned.  Doing this before allocating any other chunks allows
-	 * the use of space that would otherwise be wasted.
-	 */
-	if (opt_dss)
-		base_pages_alloc(0);
-#endif
 	base_nodes = NULL;
+	base_reserve_regs = NULL;
 	malloc_mutex_init(&base_mtx);
 
 #ifdef MOZ_MEMORY_NARENAS_DEFAULT_ONE
 	narenas = 1;
 #else
 	if (ncpus > 1) {
 		/*
 		 * For SMP systems, create four times as many arenas as there
@@ -5735,16 +5784,37 @@ MALLOC_OUT:
 	 * called for other threads.  The seed value doesn't really matter.
 	 */
 #ifdef MALLOC_BALANCE
 	SPRN(balance, 42);
 #endif
 
 	malloc_spin_init(&arenas_lock);
 
+	/*
+	 * Configure and initialize the memory reserve.  This needs to happen
+	 * late during initialization, since chunks are allocated.
+	 */
+	malloc_mutex_init(&reserve_mtx);
+	reserve_min = 0;
+	reserve_cur = 0;
+	reserve_max = chunksize * narenas;
+	if (RESERVE_RANGE_2POW_DEFAULT + opt_reserve_range_lshift >= 0) {
+		reserve_max += chunksize << (RESERVE_RANGE_2POW_DEFAULT +
+		    opt_reserve_range_lshift);
+	}
+	ql_new(&reserve_regs);
+	reserve_seq = 0;
+	extent_tree_szad_new(&reserve_chunks_szad);
+	extent_tree_ad_new(&reserve_chunks_ad);
+	if (RESERVE_MIN_2POW_DEFAULT + opt_reserve_min_lshift >= 0) {
+		reserve_min_set(chunksize << (RESERVE_MIN_2POW_DEFAULT +
+		    opt_reserve_min_lshift));
+	}
+
 	malloc_initialized = true;
 #ifndef MOZ_MEMORY_WINDOWS
 	malloc_mutex_unlock(&init_lock);
 #endif
 	return (false);
 }
 
 /* XXX Why not just expose malloc_print_stats()? */
@@ -6066,31 +6136,21 @@ jemalloc_stats(jemalloc_stats_t *stats)
 	size_t i;
 
 	assert(stats != NULL);
 
 	/*
 	 * Gather runtime settings.
 	 */
 	stats->opt_abort = opt_abort;
-	stats->opt_dss =
-#ifdef MALLOC_DSS
-	    opt_dss ? true :
+	stats->opt_junk =
+#ifdef MALLOC_FILL
+	    opt_junk ? true :
 #endif
 	    false;
-	stats->opt_junk =
-#ifdef MALLOC_FILL
-	    opt_junk ? true :
-#endif
-	    false;
-	stats->opt_mmap =
-#ifdef MALLOC_DSS
-	    opt_mmap == false ? false :
-#endif
-	    true;
 	stats->opt_utrace =
 #ifdef MALLOC_UTRACE
 	    opt_utrace ? true :
 #endif
 	    false;
 	stats->opt_sysv =
 #ifdef MALLOC_SYSV
 	    opt_sysv ? true :
@@ -6115,16 +6175,22 @@ jemalloc_stats(jemalloc_stats_t *stats)
 #endif
 	    ;
 	stats->quantum = quantum;
 	stats->small_max = small_max;
 	stats->large_max = arena_maxclass;
 	stats->chunksize = chunksize;
 	stats->dirty_max = opt_dirty_max;
 
+	malloc_mutex_lock(&reserve_mtx);
+	stats->reserve_min = reserve_min;
+	stats->reserve_max = reserve_max;
+	stats->reserve_cur = reserve_cur;
+	malloc_mutex_unlock(&reserve_mtx);
+
 	/*
 	 * Gather current memory usage statistics.
 	 */
 	stats->mapped = 0;
 	stats->committed = 0;
 	stats->allocated = 0;
 	stats->dirty = 0;
 
@@ -6172,16 +6238,457 @@ jemalloc_stats(jemalloc_stats_t *stats)
 		}
 	}
 
 #ifndef MALLOC_DECOMMIT
 	stats->committed = stats->mapped;
 #endif
 }
 
+void *
+xmalloc(size_t size)
+{
+	void *ret;
+
+	if (malloc_init())
+		reserve_fail(size, "xmalloc");
+
+	if (size == 0) {
+#ifdef MALLOC_SYSV
+		if (opt_sysv == false)
+#endif
+			size = 1;
+#ifdef MALLOC_SYSV
+		else {
+			_malloc_message(_getprogname(),
+			    ": (malloc) Error in xmalloc(): ",
+			    "invalid size 0", "\n");
+			abort();
+		}
+#endif
+	}
+
+	ret = imalloc(size);
+	if (ret == NULL) {
+		uint64_t seq = 0;
+
+		do {
+			seq = reserve_crit(size, "xmalloc", seq);
+			ret = imalloc(size);
+		} while (ret == NULL);
+	}
+
+	UTRACE(0, size, ret);
+	return (ret);
+}
+
+void *
+xcalloc(size_t num, size_t size)
+{
+	void *ret;
+	size_t num_size;
+
+	num_size = num * size;
+	if (malloc_init())
+		reserve_fail(num_size, "xcalloc");
+
+	if (num_size == 0) {
+#ifdef MALLOC_SYSV
+		if ((opt_sysv == false) && ((num == 0) || (size == 0)))
+#endif
+			num_size = 1;
+#ifdef MALLOC_SYSV
+		else {
+			_malloc_message(_getprogname(),
+			    ": (malloc) Error in xcalloc(): ",
+			    "invalid size 0", "\n");
+			abort();
+		}
+#endif
+	/*
+	 * Try to avoid division here.  We know that it isn't possible to
+	 * overflow during multiplication if neither operand uses any of the
+	 * most significant half of the bits in a size_t.
+	 */
+	} else if (((num | size) & (SIZE_T_MAX << (sizeof(size_t) << 2)))
+	    && (num_size / size != num)) {
+		/* size_t overflow. */
+		_malloc_message(_getprogname(),
+		    ": (malloc) Error in xcalloc(): ",
+		    "size overflow", "\n");
+		abort();
+	}
+
+	ret = icalloc(num_size);
+	if (ret == NULL) {
+		uint64_t seq = 0;
+
+		do {
+			seq = reserve_crit(num_size, "xcalloc", seq);
+			ret = icalloc(num_size);
+		} while (ret == NULL);
+	}
+
+	UTRACE(0, num_size, ret);
+	return (ret);
+}
+
+void *
+xrealloc(void *ptr, size_t size)
+{
+	void *ret;
+
+	if (size == 0) {
+#ifdef MALLOC_SYSV
+		if (opt_sysv == false)
+#endif
+			size = 1;
+#ifdef MALLOC_SYSV
+		else {
+			if (ptr != NULL)
+				idalloc(ptr);
+			_malloc_message(_getprogname(),
+			    ": (malloc) Error in xrealloc(): ",
+			    "invalid size 0", "\n");
+			abort();
+		}
+#endif
+	}
+
+	if (ptr != NULL) {
+		assert(malloc_initialized);
+
+		ret = iralloc(ptr, size);
+		if (ret == NULL) {
+			uint64_t seq = 0;
+
+			do {
+				seq = reserve_crit(size, "xrealloc", seq);
+				ret = iralloc(ptr, size);
+			} while (ret == NULL);
+		}
+	} else {
+		if (malloc_init())
+			reserve_fail(size, "xrealloc");
+
+		ret = imalloc(size);
+		if (ret == NULL) {
+			uint64_t seq = 0;
+
+			do {
+				seq = reserve_crit(size, "xrealloc", seq);
+				ret = imalloc(size);
+			} while (ret == NULL);
+		}
+	}
+
+	UTRACE(ptr, size, ret);
+	return (ret);
+}
+
+void *
+xmemalign(size_t alignment, size_t size)
+{
+	void *ret;
+
+	assert(((alignment - 1) & alignment) == 0 && alignment >=
+	    sizeof(void *));
+
+	if (malloc_init())
+		reserve_fail(size, "xmemalign");
+
+	ret = ipalloc(alignment, size);
+	if (ret == NULL) {
+		uint64_t seq = 0;
+
+		do {
+			seq = reserve_crit(size, "xmemalign", seq);
+			ret = ipalloc(alignment, size);
+		} while (ret == NULL);
+	}
+
+	UTRACE(0, size, ret);
+	return (ret);
+}
+
+static void
+reserve_shrink(void)
+{
+	extent_node_t *node;
+
+	assert(reserve_cur > reserve_max);
+#ifdef MALLOC_DEBUG
+	{
+		extent_node_t *node;
+		size_t reserve_size;
+
+		reserve_size = 0;
+		rb_foreach_begin(extent_node_t, link_szad, &reserve_chunks_szad,
+		    node) {
+			reserve_size += node->size;
+		} rb_foreach_end(extent_node_t, link_szad, &reserve_chunks_szad,
+		    node)
+		assert(reserve_size == reserve_cur);
+
+		reserve_size = 0;
+		rb_foreach_begin(extent_node_t, link_ad, &reserve_chunks_ad,
+		    node) {
+			reserve_size += node->size;
+		} rb_foreach_end(extent_node_t, link_ad, &reserve_chunks_ad,
+		    node)
+		assert(reserve_size == reserve_cur);
+	}
+#endif
+
+	/* Discard chunks until the the reserve is below the size limit. */
+	rb_foreach_reverse_begin(extent_node_t, link_ad, &reserve_chunks_ad,
+	    node) {
+#ifndef MALLOC_DECOMMIT
+		if (node->size <= reserve_cur - reserve_max) {
+#endif
+			extent_node_t *tnode = extent_tree_ad_prev(
+			    &reserve_chunks_ad, node);
+
+#ifdef MALLOC_DECOMMIT
+			assert(node->size <= reserve_cur - reserve_max);
+#endif
+
+			/* Discard the entire [multi-]chunk. */
+			extent_tree_szad_remove(&reserve_chunks_szad, node);
+			extent_tree_ad_remove(&reserve_chunks_ad, node);
+			reserve_cur -= node->size;
+			pages_unmap(node->addr, node->size);
+			base_node_dealloc(node);
+			if (reserve_cur == reserve_max)
+				break;
+
+			rb_foreach_reverse_prev(extent_node_t, link_ad,
+			    extent_ad_comp, &reserve_chunks_ad, tnode);
+#ifndef MALLOC_DECOMMIT
+		} else {
+			/* Discard the end of the multi-chunk. */
+			extent_tree_szad_remove(&reserve_chunks_szad, node);
+			node->size -= reserve_cur - reserve_max;
+			extent_tree_szad_insert(&reserve_chunks_szad, node);
+			pages_unmap((void *)((uintptr_t)node->addr +
+			    node->size), reserve_cur - reserve_max);
+			reserve_cur = reserve_max;
+			break;
+		}
+#endif
+		assert(reserve_cur > reserve_max);
+	} rb_foreach_reverse_end(extent_node_t, link_ad, &reserve_chunks_ad,
+	    node)
+}
+
+/* Send a condition notification. */
+static uint64_t
+reserve_notify(reserve_cnd_t cnd, size_t size, uint64_t seq)
+{
+	reserve_reg_t *reg;
+
+	/* seq is used to keep track of distinct condition-causing events. */
+	if (seq == 0) {
+		/* Allocate new sequence number. */
+		reserve_seq++;
+		seq = reserve_seq;
+	}
+
+	/*
+	 * Advance to the next callback registration and send a notification,
+	 * unless one has already been sent for this condition-causing event.
+	 */
+	reg = ql_first(&reserve_regs);
+	if (reg == NULL)
+		return (0);
+	ql_first(&reserve_regs) = ql_next(&reserve_regs, reg, link);
+	if (reg->seq == seq)
+		return (0);
+	reg->seq = seq;
+	malloc_mutex_unlock(&reserve_mtx);
+	reg->cb(reg->ctx, cnd, size);
+	malloc_mutex_lock(&reserve_mtx);
+
+	return (seq);
+}
+
+/* Allocation failure due to OOM.  Try to free some memory via callbacks. */
+static uint64_t
+reserve_crit(size_t size, const char *fname, uint64_t seq)
+{
+
+	/*
+	 * Send one condition notification.  Iteration is handled by the
+	 * caller of this function.
+	 */
+	malloc_mutex_lock(&reserve_mtx);
+	seq = reserve_notify(RESERVE_CND_CRIT, size, seq);
+	malloc_mutex_unlock(&reserve_mtx);
+
+	/* If no notification could be sent, then no further recourse exists. */
+	if (seq == 0)
+		reserve_fail(size, fname);
+
+	return (seq);
+}
+
+/* Permanent allocation failure due to OOM. */
+static void
+reserve_fail(size_t size, const char *fname)
+{
+	uint64_t seq = 0;
+
+	/* Send fail notifications. */
+	malloc_mutex_lock(&reserve_mtx);
+	do {
+		seq = reserve_notify(RESERVE_CND_FAIL, size, seq);
+	} while (seq != 0);
+	malloc_mutex_unlock(&reserve_mtx);
+
+	/* Terminate the application. */
+	_malloc_message(_getprogname(),
+	    ": (malloc) Error in ", fname, "(): out of memory\n");
+	abort();
+}
+
+bool
+reserve_cb_register(reserve_cb_t *cb, void *ctx)
+{
+	reserve_reg_t *reg = base_reserve_reg_alloc();
+	if (reg == NULL)
+		return (true);
+
+	ql_elm_new(reg, link);
+	reg->cb = cb;
+	reg->ctx = ctx;
+	reg->seq = 0;
+
+	malloc_mutex_lock(&reserve_mtx);
+	ql_head_insert(&reserve_regs, reg, link);
+	malloc_mutex_unlock(&reserve_mtx);
+
+	return (false);
+}
+
+bool
+reserve_cb_unregister(reserve_cb_t *cb, void *ctx)
+{
+	reserve_reg_t *reg = NULL;
+
+	malloc_mutex_lock(&reserve_mtx);
+	ql_foreach(reg, &reserve_regs, link) {
+		if (reg->cb == cb && reg->ctx == ctx) {
+			ql_remove(&reserve_regs, reg, link);
+			break;
+		}
+	}
+	malloc_mutex_unlock(&reserve_mtx);
+
+	if (reg != NULL)
+		base_reserve_reg_dealloc(reg);
+		return (false);
+	return (true);
+}
+
+size_t
+reserve_cur_get(void)
+{
+	size_t ret;
+
+	malloc_mutex_lock(&reserve_mtx);
+	ret = reserve_cur;
+	malloc_mutex_unlock(&reserve_mtx);
+
+	return (ret);
+}
+
+size_t
+reserve_min_get(void)
+{
+	size_t ret;
+
+	malloc_mutex_lock(&reserve_mtx);
+	ret = reserve_min;
+	malloc_mutex_unlock(&reserve_mtx);
+
+	return (ret);
+}
+
+bool
+reserve_min_set(size_t min)
+{
+
+	min = CHUNK_CEILING(min);
+
+	malloc_mutex_lock(&reserve_mtx);
+	/* Keep |reserve_max - reserve_min| the same. */
+	if (min < reserve_min) {
+		reserve_max -= reserve_min - min;
+		reserve_min = min;
+	} else {
+		/* Protect against wrap-around. */
+		if (reserve_max + min - reserve_min < reserve_max) {
+			reserve_min = SIZE_T_MAX - (reserve_max - reserve_min)
+			    - chunksize + 1;
+			reserve_max = SIZE_T_MAX - chunksize + 1;
+		} else {
+			reserve_max += min - reserve_min;
+			reserve_min = min;
+		}
+	}
+
+	/* Resize the reserve if necessary. */
+	if (reserve_cur < reserve_min) {
+		size_t size = reserve_min - reserve_cur;
+
+		/* Force the reserve to grow by allocating/deallocating. */
+		malloc_mutex_unlock(&reserve_mtx);
+#ifdef MALLOC_DECOMMIT
+		{
+			void **chunks;
+			size_t i, n;
+
+			n = size >> opt_chunk_2pow;
+			chunks = imalloc(n * sizeof(void *));
+			if (chunks == NULL)
+				return (true);
+			for (i = 0; i < n; i++) {
+				chunks[i] = huge_malloc(chunksize, false);
+				if (chunks[i] == NULL) {
+					size_t j;
+
+					for (j = 0; j < i; j++) {
+						huge_dalloc(chunks[j]);
+					}
+					idalloc(chunks);
+					return (true);
+				}
+			}
+			for (i = 0; i < n; i++)
+				huge_dalloc(chunks[i]);
+			idalloc(chunks);
+		}
+#else
+		{
+			void *x = huge_malloc(size, false);
+			if (x == NULL) {
+				return (true);
+			}
+			huge_dalloc(x);
+		}
+#endif
+	} else if (reserve_cur > reserve_max) {
+		reserve_shrink();
+		malloc_mutex_unlock(&reserve_mtx);
+	} else
+		malloc_mutex_unlock(&reserve_mtx);
+
+	return (false);
+}
+
 #ifdef MOZ_MEMORY_WINDOWS
 void*
 _recalloc(void *ptr, size_t count, size_t size)
 {
 	size_t oldsize = (ptr != NULL) ? isalloc(ptr) : 0;
 	size_t newsize = count * size;
 
 	/*
@@ -6217,17 +6724,16 @@ size_t
 size_t
 _msize(const void *ptr)
 {
 
 	return malloc_usable_size(ptr);
 }
 #endif
 
-
 /*
  * End non-standard functions.
  */
 /******************************************************************************/
 /*
  * Begin library-private functions, used by threading libraries for protection
  * of malloc during fork().  These functions are only called if the program is
  * running in threaded mode, so there is no need to check whether the program
@@ -6246,32 +6752,24 @@ _malloc_prefork(void)
 		if (arenas[i] != NULL)
 			malloc_spin_lock(&arenas[i]->lock);
 	}
 	malloc_spin_unlock(&arenas_lock);
 
 	malloc_mutex_lock(&base_mtx);
 
 	malloc_mutex_lock(&huge_mtx);
-
-#ifdef MALLOC_DSS
-	malloc_mutex_lock(&dss_mtx);
-#endif
 }
 
 void
 _malloc_postfork(void)
 {
 	unsigned i;
 
 	/* Release all mutexes, now that fork() has completed. */
-
-#ifdef MALLOC_DSS
-	malloc_mutex_unlock(&dss_mtx);
-#endif
 
 	malloc_mutex_unlock(&huge_mtx);
 
 	malloc_mutex_unlock(&base_mtx);
 
 	malloc_spin_lock(&arenas_lock);
 	for (i = 0; i < narenas; i++) {
 		if (arenas[i] != NULL)
diff --git a/memory/jemalloc/jemalloc.h b/memory/jemalloc/jemalloc.h
--- a/memory/jemalloc/jemalloc.h
+++ b/memory/jemalloc/jemalloc.h
@@ -14,44 +14,164 @@ extern const char	*_malloc_options;
  * sure that the compiled results of jemalloc.c are in sync with this header
  * file.
  */
 typedef struct {
 	/*
 	 * Run-time configuration settings.
 	 */
 	bool	opt_abort;	/* abort(3) on error? */
-	bool	opt_dss;	/* Use sbrk(2) to map memory? */
 	bool	opt_junk;	/* Fill allocated/free memory with 0xa5/0x5a? */
-	bool	opt_mmap;	/* Use mmap(2) to map memory? */
 	bool	opt_utrace;	/* Trace all allocation events? */
 	bool	opt_sysv;	/* SysV semantics? */
 	bool	opt_xmalloc;	/* abort(3) on OOM? */
 	bool	opt_zero;	/* Fill allocated memory with 0x0? */
 	size_t	narenas;	/* Number of arenas. */
 	size_t	balance_threshold; /* Arena contention rebalance threshold. */
 	size_t	quantum;	/* Allocation quantum. */
 	size_t	small_max;	/* Max quantum-spaced allocation size. */
 	size_t	large_max;	/* Max sub-chunksize allocation size. */
 	size_t	chunksize;	/* Size of each virtual memory mapping. */
 	size_t	dirty_max;	/* Max dirty pages per arena. */
+	size_t	reserve_min;	/* reserve_low callback threshold. */
+	size_t	reserve_max;	/* Maximum reserve size before unmapping. */
 
 	/*
 	 * Current memory usage statistics.
 	 */
 	size_t	mapped;		/* Bytes mapped (not necessarily committed). */
 	size_t	committed;	/* Bytes committed (readable/writable). */
 	size_t	allocated;	/* Bytes allocted (in use by application). */
 	size_t	dirty;		/* Bytes dirty (committed unused pages). */
+	size_t	reserve_cur;	/* Current memory reserve. */
 } jemalloc_stats_t;
 
 #ifndef MOZ_MEMORY_DARWIN
 void	*malloc(size_t size);
 void	*valloc(size_t size);
 void	*calloc(size_t num, size_t size);
 void	*realloc(void *ptr, size_t size);
 void	free(void *ptr);
 #endif
 
 int	posix_memalign(void **memptr, size_t alignment, size_t size);
 void	*memalign(size_t alignment, size_t size);
 size_t	malloc_usable_size(const void *ptr);
 void	jemalloc_stats(jemalloc_stats_t *stats);
+
+/* The x*() functions never return NULL. */
+void	*xmalloc(size_t size);
+void	*xcalloc(size_t num, size_t size);
+void	*xrealloc(void *ptr, size_t size);
+void	*xmemalign(size_t alignment, size_t size);
+
+/*
+ * The allocator maintains a memory reserve that is used to satisfy allocation
+ * requests when no additional memory can be acquired from the operating
+ * system.  Under normal operating conditions, the reserve size is at least
+ * reserve_min bytes.  If the reserve is depleted or insufficient to satisfy an
+ * allocation request, then condition notifications are sent to one or more of
+ * the registered callback functions:
+ *
+ *   RESERVE_CND_LOW: The reserve had to be used to satisfy an allocation
+ *                    request, which dropped the reserve size below the
+ *                    minimum.  The callee should try to free memory in order
+ *                    to restore the reserve.
+ *
+ *   RESERVE_CND_CRIT: The reserve was not large enough to satisfy a pending
+ *                     allocation request.  Some callee must free adequate
+ *                     memory in order to prevent application failure (unless
+ *                     the condition spontaneously desists due to concurrent
+ *                     deallocation).
+ *
+ *   RESERVE_CND_FAIL: An allocation request could not be satisfied, despite all
+ *                     attempts.  The allocator is about to terminate the
+ *                     application.
+ *
+ * The order in which the callback functions are called is only loosely
+ * specified: in the absence of interposing callback
+ * registrations/unregistrations, enabled callbacks will be called in an
+ * arbitrary round-robin order.
+ *
+ * Condition notifications are sent to callbacks only while conditions exist.
+ * For example, just before the allocator sends a RESERVE_CND_LOW condition
+ * notification to a callback, the reserve is in fact depleted.  However, due
+ * to allocator concurrency, the reserve may have been restored by the time the
+ * callback function executes.  Furthermore, if the reserve is restored at some
+ * point during the delivery of condition notifications to callbacks, no
+ * further deliveries will occur, since the condition no longer exists.
+ *
+ * Callback functions can freely call back into the allocator (i.e. the
+ * allocator releases all internal resources before calling each callback
+ * function), though allocation is discouraged, since recursive callbacks are
+ * likely to result, which places extra burden on the application to avoid
+ * deadlock.
+ *
+ * Callback functions must be thread-safe, since it is possible that multiple
+ * threads will call into the same callback function concurrently.
+ */
+
+/* Memory reserve condition types. */
+typedef enum {
+	RESERVE_CND_LOW,
+	RESERVE_CND_CRIT,
+	RESERVE_CND_FAIL
+} reserve_cnd_t;
+
+/*
+ * Reserve condition notification callback function type definition.
+ *
+ * Inputs:
+ *   ctx: Opaque application data, as passed to reserve_cb_register().
+ *   cnd: Condition type being delivered.
+ *   size: Allocation request size for the allocation that caused the condition.
+ */
+typedef void reserve_cb_t(void *ctx, reserve_cnd_t cnd, size_t size);
+
+/*
+ * Register a callback function.
+ *
+ * Inputs:
+ *   cb: Callback function pointer.
+ *   ctx: Opaque application data, passed to cb().
+ *
+ * Output:
+ *   ret: If true, failure due to OOM; success otherwise.
+ */
+bool	reserve_cb_register(reserve_cb_t *cb, void *ctx);
+
+/*
+ * Unregister a callback function.
+ *
+ * Inputs:
+ *   cb: Callback function pointer.
+ *   ctx: Opaque application data, same as that passed to reserve_cb_register().
+ *
+ * Output:
+ *   ret: False upon success, true if the {cb,ctx} registration could not be
+ *        found.
+ */
+bool	reserve_cb_unregister(reserve_cb_t *cb, void *ctx);
+
+/*
+ * Get the current reserve size.
+ *
+ * ret: Current reserve size.
+ */
+size_t	reserve_cur_get(void);
+
+/*
+ * Get the minimum acceptable reserve size.  If the reserve drops below this
+ * value, the RESERVE_CND_LOW condition notification is sent to the callbacks.
+ *
+ * ret: Minimum acceptable reserve size.
+ */
+size_t	reserve_min_get(void);
+
+/*
+ * Set the minimum acceptable reserve size.
+ *
+ * min: Reserve threshold.  This value may be internally rounded up.
+ * ret: False if the reserve was successfully resized; true otherwise.  Note
+ *      that failure to resize the reserve also results in a RESERVE_CND_LOW
+ *      condition.
+ */
+bool	reserve_min_set(size_t min);
diff --git a/modules/libjar/zipwriter/test/unit/test_bug433248.js b/modules/libjar/zipwriter/test/unit/test_bug433248.js
--- a/modules/libjar/zipwriter/test/unit/test_bug433248.js
+++ b/modules/libjar/zipwriter/test/unit/test_bug433248.js
@@ -37,70 +37,70 @@
  */
 
 function run_test()
 {
   var test;
   // zipW is an uninitialised zipwriter at this point.
   try {
     test = zipW.file;
-    do_throw("Should have thrown unitialised error.");
+    do_throw("Should have thrown uninitialized error.");
   }
   catch (e) {
     do_check_eq(e.result, Components.results.NS_ERROR_NOT_INITIALIZED);
   }
 
   try {
     test = zipW.comment;
-    do_throw("Should have thrown unitialised error.");
+    do_throw("Should have thrown uninitialized error.");
   }
   catch (e) {
     do_check_eq(e.result, Components.results.NS_ERROR_NOT_INITIALIZED);
   }
 
   try {
     zipW.comment = "test";
-    do_throw("Should have thrown unitialised error.");
+    do_throw("Should have thrown uninitialized error.");
   }
   catch (e) {
     do_check_eq(e.result, Components.results.NS_ERROR_NOT_INITIALIZED);
   }
 
   try {
     zipW.addEntryDirectory("test", 0, false);
-    do_throw("Should have thrown unitialised error.");
+    do_throw("Should have thrown uninitialized error.");
   }
   catch (e) {
     do_check_eq(e.result, Components.results.NS_ERROR_NOT_INITIALIZED);
   }
 
   try {
     zipW.addEntryFile("test", Ci.nsIZipWriter.COMPRESSION_DEFAULT, tmpDir, false);
-    do_throw("Should have thrown unitialised error.");
+    do_throw("Should have thrown uninitialized error.");
   }
   catch (e) {
     do_check_eq(e.result, Components.results.NS_ERROR_NOT_INITIALIZED);
   }
 
   try {
     zipW.removeEntry("test", false);
-    do_throw("Should have thrown unitialised error.");
+    do_throw("Should have thrown uninitialized error.");
   }
   catch (e) {
     do_check_eq(e.result, Components.results.NS_ERROR_NOT_INITIALIZED);
   }
 
   try {
     zipW.processQueue(null, null);
-    do_throw("Should have thrown unitialised error.");
+    do_throw("Should have thrown uninitialized error.");
   }
   catch (e) {
     do_check_eq(e.result, Components.results.NS_ERROR_NOT_INITIALIZED);
   }
 
   try {
     zipW.close();
-    do_throw("Should have thrown unitialised error.");
+    do_throw("Should have thrown uninitialized error.");
   }
   catch (e) {
     do_check_eq(e.result, Components.results.NS_ERROR_NOT_INITIALIZED);
   }
 }
diff --git a/modules/libpref/src/init/all.js b/modules/libpref/src/init/all.js
--- a/modules/libpref/src/init/all.js
+++ b/modules/libpref/src/init/all.js
@@ -2245,16 +2245,19 @@ pref("browser.urlbar.clickSelectsAll", f
 // autocomplete keyboard grab workaround
 pref("autocomplete.grab_during_popup", true);
 pref("autocomplete.ungrab_during_mode_switch", true);
 
 // Default to using the system filepicker if possible, but allow
 // toggling to use the XUL filepicker
 pref("ui.allow_platform_file_picker", true);
 
+// should NetworkManager be authoritative for online/offline status?
+pref("toolkit.networkmanager.disable", false);
+
 pref("helpers.global_mime_types_file", "/etc/mime.types");
 pref("helpers.global_mailcap_file", "/etc/mailcap");
 pref("helpers.private_mime_types_file", "~/.mime.types");
 pref("helpers.private_mailcap_file", "~/.mailcap");
 pref("java.global_java_version_file", "/etc/.java/versions");
 pref("java.private_java_version_file", "~/.java/versions");
 pref("java.default_java_location_solaris", "/usr/j2se");
 pref("java.default_java_location_others", "/usr/java");
diff --git a/modules/libpref/src/nsPrefBranch.h b/modules/libpref/src/nsPrefBranch.h
--- a/modules/libpref/src/nsPrefBranch.h
+++ b/modules/libpref/src/nsPrefBranch.h
@@ -116,11 +116,10 @@ public:
   NS_DECL_ISUPPORTS
   NS_DECL_NSIRELATIVEFILEPREF
   
                 nsRelativeFilePref();
   virtual       ~nsRelativeFilePref();
   
 private:
   nsCOMPtr<nsILocalFile> mFile;
-  nsCAutoString mRelativeToKey; // An nsCAutoString because length is always very short.
-                                // While this makes the object larger, avoids allocation.
+  nsCString mRelativeToKey;
 };
diff --git a/modules/oji/public/Makefile.in b/modules/oji/public/Makefile.in
--- a/modules/oji/public/Makefile.in
+++ b/modules/oji/public/Makefile.in
@@ -43,17 +43,16 @@ include $(DEPTH)/config/autoconf.mk
 include $(DEPTH)/config/autoconf.mk
 
 MODULE		= oji
 GRE_MODULE	= 1
 
 XPIDLSRCS	= \
 		nsIJVMManager.idl \
 		nsIJVMPluginInstance.idl \
-		nsIJVMAuthTools.idl \
 		nsIJVMConfigManager.idl \
 		$(NULL)
 
 EXPORTS		= \
 		nsjvm.h \
 		nsIJRIPlugin.h \
 		nsIJVMConsole.h \
 		nsIJVMPlugin.h \
diff --git a/modules/oji/src/Makefile.in b/modules/oji/src/Makefile.in
--- a/modules/oji/src/Makefile.in
+++ b/modules/oji/src/Makefile.in
@@ -88,17 +88,16 @@ CPPSRCS		= \
 		nsJVMPluginTagInfo.cpp \
 		ProxyJNI.cpp \
 		nsCNullSecurityContext.cpp \
 		ProxyClassLoader.cpp \
 		nsCSecurityContext.cpp \
 		nsCJVMManagerFactory.cpp \
 		nsJVMConfigManager.cpp \
 		lcglue.cpp \
-		nsJVMAuthTools.cpp \
 		$(NULL)
 
 ifeq ($(TARGET_MD_ARCH), unix)
 CPPSRCS		+= \
 		nsJVMConfigManagerUnix.cpp \
 		$(NULL)
 endif
 
diff --git a/modules/oji/src/nsCJVMManagerFactory.cpp b/modules/oji/src/nsCJVMManagerFactory.cpp
--- a/modules/oji/src/nsCJVMManagerFactory.cpp
+++ b/modules/oji/src/nsCJVMManagerFactory.cpp
@@ -33,48 +33,40 @@
  * and other provisions required by the GPL or the LGPL. If you do not delete
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 #include "nsIModule.h"
 #include "nsIGenericFactory.h"
-#include "nsJVMAuthTools.h"
 #include "nsJVMManager.h"
 #include "nsJVMConfigManager.h"
 
 #ifdef XP_UNIX
 #include "nsJVMConfigManagerUnix.h"
 #endif
 
 /*
  * Note:  In revision 1.17 of this file (and earlier) there was a
  * commented out implementation of nsCJVMManagerFactory, a hand-crafted
  * implementation of nsIFactory.
  */
 #ifdef XP_UNIX
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsJVMConfigManagerUnix)
 #endif
 NS_GENERIC_AGGREGATED_CONSTRUCTOR(nsJVMManager)
-NS_GENERIC_AGGREGATED_CONSTRUCTOR(nsJVMAuthTools)
 
 // The list of components we register
 static const nsModuleComponentInfo components[] = 
 {
     { "JVM Manager Service", 
       NS_JVMMANAGER_CID,  
       "@mozilla.org/oji/jvm-mgr;1", 
       nsJVMManagerConstructor
-    },
-
-    { "JVM Authentication Service", 
-      NS_JVMAUTHTOOLS_CID,  
-      "@mozilla.org/oji/jvm-auth-tools;1", 
-      nsJVMAuthToolsConstructor
     },
 #ifdef XP_UNIX
     { "JVM Config Manager",
       NS_JVMCONFIGMANAGER_CID,
       "@mozilla.org/oji/jvm-config-mgr;1",
       nsJVMConfigManagerUnixConstructor
     },
 #endif
diff --git a/modules/plugin/base/public/Makefile.in b/modules/plugin/base/public/Makefile.in
--- a/modules/plugin/base/public/Makefile.in
+++ b/modules/plugin/base/public/Makefile.in
@@ -86,16 +86,17 @@ XPIDLSRCS 	= \
 		nsIJRILiveConnectPlugin.idl \
 		nsIPluginInputStream.idl \
 		nsIPluginStreamListener.idl \
 		nsIPluginInstance.idl \
 		nsPIPluginHost.idl \
 		nsPIPluginInstancePeer.idl \
 		nsIPluginHost.idl \
 		nsIPluginDocument.idl \
+		nsIJVMAuthTools.idl \
 		$(NULL)
 
 ifeq ($(OS_ARCH),OS2)
 XPIDLSRCS += nsILegacyPluginWrapperOS2.idl
 endif
 
 # Just build headers if we don't want plugins support
 ifndef MOZ_PLUGINS
diff --git a/modules/oji/public/nsIJVMAuthTools.idl b/modules/plugin/base/public/nsIJVMAuthTools.idl
rename from modules/oji/public/nsIJVMAuthTools.idl
rename to modules/plugin/base/public/nsIJVMAuthTools.idl
diff --git a/modules/plugin/base/src/Makefile.in b/modules/plugin/base/src/Makefile.in
--- a/modules/plugin/base/src/Makefile.in
+++ b/modules/plugin/base/src/Makefile.in
@@ -86,16 +86,17 @@ endif
 
 CPPSRCS		= \
 		ns4xPlugin.cpp \
 		ns4xPluginInstance.cpp \
 		nsPluginHostImpl.cpp \
 		nsPluginModule.cpp \
 		nsPluginInstancePeer.cpp \
 		nsJSNPRuntime.cpp \
+		nsJVMAuthTools.cpp \
 		$(NULL)
 
 ifeq ($(OS_ARCH), BeOS)
 	CPPSRCS += nsPluginsDirBeOS.cpp
 	CPPSRCS += nsPluginNativeWindow.cpp
 else
 ifneq (,$(filter WINNT WINCE,$(OS_ARCH)))
 	CPPSRCS += nsPluginsDirWin.cpp
diff --git a/modules/oji/src/nsJVMAuthTools.cpp b/modules/plugin/base/src/nsJVMAuthTools.cpp
rename from modules/oji/src/nsJVMAuthTools.cpp
rename to modules/plugin/base/src/nsJVMAuthTools.cpp
diff --git a/modules/oji/src/nsJVMAuthTools.h b/modules/plugin/base/src/nsJVMAuthTools.h
rename from modules/oji/src/nsJVMAuthTools.h
rename to modules/plugin/base/src/nsJVMAuthTools.h
diff --git a/modules/plugin/base/src/nsPluginHostImpl.cpp b/modules/plugin/base/src/nsPluginHostImpl.cpp
--- a/modules/plugin/base/src/nsPluginHostImpl.cpp
+++ b/modules/plugin/base/src/nsPluginHostImpl.cpp
@@ -2379,17 +2379,17 @@ NS_IMETHODIMP nsPluginStreamListenerPeer
       return NS_ERROR_FAILURE;
 
   nsCOMPtr<nsIChannel> channel = do_QueryInterface(request);
   if (!channel)
     return NS_ERROR_FAILURE;
   // Set the content type to ensure we don't pass null to the plugin
   nsCAutoString aContentType;
   rv = channel->GetContentType(aContentType);
-  if (NS_FAILED(rv))
+  if (NS_FAILED(rv) && !mRequestFailed)
     return rv;
 
   if (!aContentType.IsEmpty())
     mPluginStreamInfo->SetContentType(aContentType.get());
 
   // set error status if stream failed so we notify the plugin
   if (mRequestFailed)
     aStatus = NS_ERROR_FAILURE;
diff --git a/modules/plugin/base/src/nsPluginHostImpl.h b/modules/plugin/base/src/nsPluginHostImpl.h
--- a/modules/plugin/base/src/nsPluginHostImpl.h
+++ b/modules/plugin/base/src/nsPluginHostImpl.h
@@ -469,17 +469,17 @@ private:
 
   static nsIFile *sPluginTempDir;
 
   // We need to hold a global ptr to ourselves because we register for
   // two different CIDs for some reason...
   static nsPluginHostImpl* sInst;
 };
 
-class PluginDestructionGuard : protected PRCList
+class NS_STACK_CLASS PluginDestructionGuard : protected PRCList
 {
 public:
   PluginDestructionGuard(nsIPluginInstance *aInstance)
     : mInstance(aInstance)
   {
     Init();
   }
 
diff --git a/modules/plugin/base/src/nsPluginModule.cpp b/modules/plugin/base/src/nsPluginModule.cpp
--- a/modules/plugin/base/src/nsPluginModule.cpp
+++ b/modules/plugin/base/src/nsPluginModule.cpp
@@ -36,25 +36,33 @@
  *
  * ***** END LICENSE BLOCK ***** */
 
 #include "nsIGenericFactory.h"
 #include "nsIPluginManager.h"
 #include "nsPluginsCID.h"
 #include "nsPluginHostImpl.h"
 #include "ns4xPlugin.h"
+#include "nsJVMAuthTools.h"
 
 NS_GENERIC_FACTORY_SINGLETON_CONSTRUCTOR(nsPluginHostImpl,
                                          nsPluginHostImpl::GetInst)
+NS_GENERIC_AGGREGATED_CONSTRUCTOR(nsJVMAuthTools)
 
 static const nsModuleComponentInfo gComponentInfo[] = {
   { "Plugin Host",
     NS_PLUGIN_HOST_CID,
     "@mozilla.org/plugin/host;1",
-    nsPluginHostImplConstructor },
-
+    nsPluginHostImplConstructor
+  },
   { "Plugin Manager",
     NS_PLUGINMANAGER_CID,
     "@mozilla.org/plugin/manager;1",
-    nsPluginHostImplConstructor },
+    nsPluginHostImplConstructor
+  },
+  { "JVM Authentication Service", 
+    NS_JVMAUTHTOOLS_CID,  
+    "@mozilla.org/oji/jvm-auth-tools;1", 
+    nsJVMAuthToolsConstructor
+  }
 };
 
 NS_IMPL_NSGETMODULE(nsPluginModule, gComponentInfo)
diff --git a/modules/plugin/base/src/nsPluginsDirDarwin.cpp b/modules/plugin/base/src/nsPluginsDirDarwin.cpp
--- a/modules/plugin/base/src/nsPluginsDirDarwin.cpp
+++ b/modules/plugin/base/src/nsPluginsDirDarwin.cpp
@@ -236,16 +236,26 @@ nsresult nsPluginFile::LoadPlugin(PRLibr
 nsresult nsPluginFile::LoadPlugin(PRLibrary* &outLibrary)
 {
     const char* path;
 
     if (!mPlugin)
         return NS_ERROR_NULL_POINTER;
 
     nsCAutoString temp;
+    mPlugin->GetNativeLeafName(temp);
+    /*
+     * Don't load the VDP fake plugin, to avoid tripping a bad bug in OS X
+     * 10.5.3 (see bug 436575).
+     */
+    if (!strcmp(temp.get(), "VerifiedDownloadPlugin.plugin")) {
+        NS_WARNING("Preventing load of VerifiedDownloadPlugin.plugin (see bug 436575)");
+        return NS_ERROR_FAILURE;
+    }
+
     mPlugin->GetNativePath(temp);
     path = temp.get();
 
     outLibrary = PR_LoadLibrary(path);
     pLibrary = outLibrary;
     if (!outLibrary) {
         return NS_ERROR_FAILURE;
     }
diff --git a/netwerk/base/src/nsDirectoryIndexStream.h b/netwerk/base/src/nsDirectoryIndexStream.h
--- a/netwerk/base/src/nsDirectoryIndexStream.h
+++ b/netwerk/base/src/nsDirectoryIndexStream.h
@@ -43,17 +43,17 @@
 #include "nsIInputStream.h"
 #include "nsCOMPtr.h"
 #include "nsCOMArray.h"
 #include "nsITextToSubURI.h"
 
 class nsDirectoryIndexStream : public nsIInputStream
 {
 private:
-    nsCAutoString mBuf;
+    nsCString mBuf;
     PRInt32 mOffset;
     nsresult mStatus;
 
     PRInt32             mPos;   // position within mArray
     nsCOMArray<nsIFile> mArray; // file objects within the directory
 
     nsDirectoryIndexStream();
     /**
diff --git a/netwerk/streamconv/converters/nsFTPDirListingConv.h b/netwerk/streamconv/converters/nsFTPDirListingConv.h
--- a/netwerk/streamconv/converters/nsFTPDirListingConv.h
+++ b/netwerk/streamconv/converters/nsFTPDirListingConv.h
@@ -72,15 +72,15 @@ public:
     nsresult Init();
 
 private:
     // Get the application/http-index-format headers
     nsresult GetHeaders(nsACString& str, nsIURI* uri);
     char*    DigestBufferLines(char *aBuffer, nsCString &aString);
 
     // member data
-    nsCAutoString       mBuffer;            // buffered data.
+    nsCString           mBuffer;            // buffered data.
     PRBool              mSentHeading;       // have we sent 100, 101, 200, and 300 lines yet?
 
     nsIStreamListener   *mFinalListener; // this guy gets the converted data via his OnDataAvailable()
 };
 
 #endif /* __nsftpdirlistingdconv__h__ */
diff --git a/rdf/base/src/nsInMemoryDataSource.cpp b/rdf/base/src/nsInMemoryDataSource.cpp
--- a/rdf/base/src/nsInMemoryDataSource.cpp
+++ b/rdf/base/src/nsInMemoryDataSource.cpp
@@ -152,21 +152,32 @@ public:
     Assertion(nsIRDFResource* aSource,      // normal assertion
               nsIRDFResource* aProperty,
               nsIRDFNode* aTarget,
               PRBool aTruthValue);
     Assertion(nsIRDFResource* aSource);     // PLDHashTable assertion variant
 
     ~Assertion();
 
-    void AddRef() { ++mRefCnt; }
+    void AddRef() {
+        if (mRefCnt == PR_UINT16_MAX) {
+            NS_WARNING("refcount overflow, leaking Assertion");
+            return;
+        }
+        ++mRefCnt;
+    }
 
     void Release(nsFixedSizeAllocator& aAllocator) {
+        if (mRefCnt == PR_UINT16_MAX) {
+            NS_WARNING("refcount overflow, leaking Assertion");
+            return;
+        }
         if (--mRefCnt == 0)
-            Destroy(aAllocator, this); }
+            Destroy(aAllocator, this);
+    }
 
     // For nsIRDFPurgeableDataSource
     inline  void    Mark()      { u.as.mMarked = PR_TRUE; }
     inline  PRBool  IsMarked()  { return u.as.mMarked; }
     inline  void    Unmark()    { u.as.mMarked = PR_FALSE; }
 
     // public for now, because I'm too lazy to go thru and clean this up.
 
@@ -189,17 +200,17 @@ public:
             PRPackedBool    mTruthValue;
             PRPackedBool    mMarked;
         } as;
     } u;
 
     // also shared between hash/as (see the union above)
     // but placed after union definition to ensure that
     // all 32-bit entries are long aligned
-    PRInt16                     mRefCnt;
+    PRUint16                    mRefCnt;
     PRPackedBool                mHashEntry;
 
 private:
     // Hide so that only Create() and Destroy() can be used to
     // allocate and deallocate from the heap
     static void* operator new(size_t) CPP_THROW_NEW { return 0; }
     static void operator delete(void*, size_t) {}
 };
diff --git a/security/manager/ssl/src/nsClientAuthRemember.cpp b/security/manager/ssl/src/nsClientAuthRemember.cpp
--- a/security/manager/ssl/src/nsClientAuthRemember.cpp
+++ b/security/manager/ssl/src/nsClientAuthRemember.cpp
@@ -53,18 +53,19 @@
 #include "pk11pub.h"
 #include "certdb.h"
 #include "sechash.h"
 #include "ssl.h" // For SSL_ClearSessionCache
 
 #include "nsNSSCleaner.h"
 NSSCleanupAutoPtrClass(CERTCertificate, CERT_DestroyCertificate)
 
-NS_IMPL_THREADSAFE_ISUPPORTS1(nsClientAuthRememberService, 
-                              nsIObserver)
+NS_IMPL_THREADSAFE_ISUPPORTS2(nsClientAuthRememberService, 
+                              nsIObserver,
+                              nsISupportsWeakReference)
 
 nsClientAuthRememberService::nsClientAuthRememberService()
 {
   monitor = PR_NewMonitor();
 }
 
 nsClientAuthRememberService::~nsClientAuthRememberService()
 {
diff --git a/security/manager/ssl/src/nsClientAuthRemember.h b/security/manager/ssl/src/nsClientAuthRemember.h
--- a/security/manager/ssl/src/nsClientAuthRemember.h
+++ b/security/manager/ssl/src/nsClientAuthRemember.h
@@ -41,16 +41,17 @@
 #define __NSCLIENTAUTHREMEMBER_H__
 
 #include "nsTHashtable.h"
 #include "nsIObserver.h"
 #include "nsIX509Cert.h"
 #include "nsAutoPtr.h"
 #include "nsNSSCertificate.h"
 #include "nsString.h"
+#include "nsWeakReference.h"
 #include "prmon.h"
 
 class nsClientAuthRemember
 {
 public:
 
   nsClientAuthRemember()
   {
@@ -133,17 +134,18 @@ class nsClientAuthRememberEntry : public
     {
       return mHostWithCert.get();
     }
 
     nsClientAuthRemember mSettings;
     nsCString mHostWithCert;
 };
 
-class nsClientAuthRememberService : public nsIObserver
+class nsClientAuthRememberService : public nsIObserver,
+                                    public nsSupportsWeakReference
 {
 public:
   NS_DECL_ISUPPORTS
   NS_DECL_NSIOBSERVER
 
   nsClientAuthRememberService();
   ~nsClientAuthRememberService();
 
diff --git a/security/manager/ssl/src/nsNSSComponent.cpp b/security/manager/ssl/src/nsNSSComponent.cpp
--- a/security/manager/ssl/src/nsNSSComponent.cpp
+++ b/security/manager/ssl/src/nsNSSComponent.cpp
@@ -291,18 +291,20 @@ nsNSSComponent::nsNSSComponent()
   mCrlTimerLock = nsnull;
   mObserversRegistered = PR_FALSE;
 
   // In order to keep startup time lower, we delay loading and 
   // registering all identity data until first needed.
   memset(&mIdentityInfoCallOnce, 0, sizeof(PRCallOnceType));
 
   nsSSLIOLayerHelpers::Init();
-  mClientAuthRememberService.Init();
-  
+  mClientAuthRememberService = new nsClientAuthRememberService;
+  if (mClientAuthRememberService)
+    mClientAuthRememberService->Init();
+
   NS_ASSERTION( (0 == mInstanceCount), "nsNSSComponent is a singleton, but instantiated multiple times!");
   ++mInstanceCount;
   hashTableCerts = nsnull;
   mShutdownObjectList = nsNSSShutDownList::construct();
   mIsNetworkDown = PR_FALSE;
   mSSLThread = new nsSSLThread();
   if (mSSLThread)
     mSSLThread->startThread();
@@ -1679,17 +1681,19 @@ nsNSSComponent::ShutdownNSS()
 
     if (mPrefBranch) {
       nsCOMPtr<nsIPrefBranch2> pbi = do_QueryInterface(mPrefBranch);
       pbi->RemoveObserver("security.", this);
     }
 
     ShutdownSmartCardThreads();
     SSL_ClearSessionCache();
-    mClientAuthRememberService.ClearRememberedDecisions();
+    if (mClientAuthRememberService) {
+      mClientAuthRememberService->ClearRememberedDecisions();
+    }
     UnloadLoadableRoots();
     CleanupIdentityInfo();
     PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, ("evaporating psm resources\n"));
     mShutdownObjectList->evaporateAllNSSResources();
     if (SECSuccess != ::NSS_Shutdown()) {
       PR_LOG(gPIPNSSLog, PR_LOG_ALWAYS, ("NSS SHUTDOWN FAILURE\n"));
       rv = NS_ERROR_FAILURE;
     }
@@ -2145,17 +2149,19 @@ void nsNSSComponent::ShowAlert(AlertIden
         proxyPrompt->Alert(nsnull, message.get());
       }
     }
   }
 }
 
 nsresult nsNSSComponent::LogoutAuthenticatedPK11()
 {
-  mClientAuthRememberService.ClearRememberedDecisions();
+  if (mClientAuthRememberService) {
+    mClientAuthRememberService->ClearRememberedDecisions();
+  }
   return mShutdownObjectList->doPK11Logout();
 }
 
 nsresult
 nsNSSComponent::RegisterObservers()
 {
   // Happens once during init only, no mutex protection.
 
@@ -2411,17 +2417,18 @@ nsNSSComponent::DoProfileChangeNetRestor
     mCertVerificationThread->startThread();
   mIsNetworkDown = PR_FALSE;
 }
 
 NS_IMETHODIMP
 nsNSSComponent::GetClientAuthRememberService(nsClientAuthRememberService **cars)
 {
   NS_ENSURE_ARG_POINTER(cars);
-  *cars = &mClientAuthRememberService;
+  NS_IF_ADDREF(*cars = mClientAuthRememberService);
+  return NS_OK;
 }
 
 //---------------------------------------------
 // Implementing nsICryptoHash
 //---------------------------------------------
 
 nsCryptoHash::nsCryptoHash()
   : mHashContext(nsnull)
diff --git a/security/manager/ssl/src/nsNSSComponent.h b/security/manager/ssl/src/nsNSSComponent.h
--- a/security/manager/ssl/src/nsNSSComponent.h
+++ b/security/manager/ssl/src/nsNSSComponent.h
@@ -323,17 +323,17 @@ private:
   PRBool mUpdateTimerInitialized;
   static int mInstanceCount;
   nsNSSShutDownList *mShutdownObjectList;
   SmartCardThreadList *mThreadList;
   PRBool mIsNetworkDown;
   nsSSLThread *mSSLThread;
   nsCertVerificationThread *mCertVerificationThread;
   nsNSSHttpInterface mHttpForNSS;
-  nsClientAuthRememberService mClientAuthRememberService;
+  nsRefPtr<nsClientAuthRememberService> mClientAuthRememberService;
 
   static PRStatus PR_CALLBACK IdentityInfoInit(void);
   PRCallOnceType mIdentityInfoCallOnce;
 };
 
 class PSMContentListener : public nsIURIContentListener,
                             public nsSupportsWeakReference {
 public:
diff --git a/security/manager/ssl/src/nsNSSIOLayer.cpp b/security/manager/ssl/src/nsNSSIOLayer.cpp
--- a/security/manager/ssl/src/nsNSSIOLayer.cpp
+++ b/security/manager/ssl/src/nsNSSIOLayer.cpp
@@ -2617,25 +2617,19 @@ SECStatus nsNSS_SSLGetClientAuthData(voi
     }
 
     nsXPIDLCString hostname;
     info->GetHostName(getter_Copies(hostname));
 
     nsresult rv;
     NS_DEFINE_CID(nssComponentCID, NS_NSSCOMPONENT_CID);
     nsCOMPtr<nsINSSComponent> nssComponent(do_GetService(nssComponentCID, &rv));
-    // it's ok to keep our raw pointer to the nsClientAuthRememberService
-    // as long as we hold the reference to the nssComponent.
-    // Yes, this sucks, but this is branch only code,
-    // and I don't want to deal with new interfaces, and want to use full
-    // typed pointers.
-    // Note nsINSSComponent is NOT exposed to anywhere outside of PSM.
-    nsClientAuthRememberService *cars = nsnull;
+    nsRefPtr<nsClientAuthRememberService> cars;
     if (nssComponent) {
-      nssComponent->GetClientAuthRememberService(&cars);
+      nssComponent->GetClientAuthRememberService(getter_AddRefs(cars));
     }
 
     PRBool hasRemembered = PR_FALSE;
     nsCString rememberedNickname;
     if (cars) {
       PRBool found;
       nsresult rv = cars->HasRememberedDecision(hostname, 
                                                 serverCert,
diff --git a/storage/public/mozStorageHelper.h b/storage/public/mozStorageHelper.h
--- a/storage/public/mozStorageHelper.h
+++ b/storage/public/mozStorageHelper.h
@@ -145,17 +145,17 @@ protected:
 
 /**
  * This class wraps a statement so that it is guaraneed to be reset when
  * this object goes out of scope.
  *
  * Note that this always just resets the statement. If the statement doesn't
  * need resetting, the reset operation is inexpensive.
  */
-class mozStorageStatementScoper
+class NS_STACK_CLASS mozStorageStatementScoper
 {
 public:
   mozStorageStatementScoper(mozIStorageStatement* aStatement)
       : mStatement(aStatement)
   {
   }
   ~mozStorageStatementScoper()
   {
diff --git a/testing/mochitest/Makefile.in b/testing/mochitest/Makefile.in
--- a/testing/mochitest/Makefile.in
+++ b/testing/mochitest/Makefile.in
@@ -49,17 +49,16 @@ DIRS =	MochiKit \
 	chrome \
 	ssltunnel \
 	$(NULL)
 
 include $(topsrcdir)/config/rules.mk
 
 # files that get copied into $objdir/_tests/
 _SERV_FILES = 	\
-		runtests.pl \
 		runtests.py \
 		automation.py \
 		gen_template.pl \
 		server.js \
 		harness-a11y.xul \
 		harness-overlay.xul \
 		harness.xul \
 		browser-test-overlay.xul \
@@ -112,24 +111,20 @@ else
 else
 TEST_DRIVER_PPARGS += -DIS_CAMINO=0
 endif
 
 ifeq ($(host_os), cygwin)
 TEST_DRIVER_PPARGS += -DIS_CYGWIN=1
 endif
 
-runtests.pl: runtests.pl.in
-	$(PYTHON) $(topsrcdir)/config/Preprocessor.py \
-	$(TEST_DRIVER_PPARGS) $(DEFINES) $(ACDEFINES) $^ > $@
-
 runtests.py: runtests.py.in
 	$(PYTHON) $(topsrcdir)/config/Preprocessor.py \
 	$(TEST_DRIVER_PPARGS) $(DEFINES) $(ACDEFINES) $^ > $@
 
 automation.py: $(topsrcdir)/build/pgo/automation.py.in
 	$(PYTHON) $(topsrcdir)/config/Preprocessor.py \
 	$(TEST_DRIVER_PPARGS) $(DEFINES) $(ACDEFINES) $^ > $@
 
-GARBAGE += runtests.pl runtests.py automation.py
+GARBAGE += runtests.py automation.py
 
 libs:: $(_SERV_FILES)
 	$(INSTALL) $^ $(_DEST_DIR)
diff --git a/testing/mochitest/runtests.pl.in b/testing/mochitest/runtests.pl.in
deleted file mode 100644
--- a/testing/mochitest/runtests.pl.in
+++ /dev/null
@@ -1,703 +0,0 @@
-#
-# ***** BEGIN LICENSE BLOCK *****
-# Version: MPL 1.1/GPL 2.0/LGPL 2.1
-#
-# The contents of this file are subject to the Mozilla Public License Version
-# 1.1 (the "License"); you may not use this file except in compliance with
-# the License. You may obtain a copy of the License at
-# http://www.mozilla.org/MPL/
-#
-# Software distributed under the License is distributed on an "AS IS" basis,
-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
-# for the specific language governing rights and limitations under the
-# License.
-#
-# The Original Code is mozilla.org code.
-#
-# The Initial Developer of the Original Code is
-# Mozilla Foundation.
-# Portions created by the Initial Developer are Copyright (C) 1998
-# the Initial Developer. All Rights Reserved.
-#
-# Contributor(s):
-#   Robert Sayre <sayrer@gmail.com>
-#   Jeff Walden <jwalden+bmo@mit.edu>
-#
-# Alternatively, the contents of this file may be used under the terms of
-# either the GNU General Public License Version 2 or later (the "GPL"), or
-# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
-# in which case the provisions of the GPL or the LGPL are applicable instead
-# of those above. If you wish to allow use of your version of this file only
-# under the terms of either the GPL or the LGPL, and not to allow others to
-# use your version of this file under the terms of the MPL, indicate your
-# decision by deleting the provisions above and replace them with the notice
-# and other provisions required by the GPL or the LGPL. If you do not delete
-# the provisions above, a recipient may use your version of this file under
-# the terms of any one of the MPL, the GPL or the LGPL.
-#
-# ***** END LICENSE BLOCK *****
-
-# Win32 path munging for msys courtesy the Curl project under an
-# MIT/X license http://curl.haxx.se/
-#
-# Copyright (c) 1996 - 2007, Daniel Stenberg, <daniel@haxx.se>.
-# All rights reserved.
-#
-# Permission to use, copy, modify, and distribute this software for
-# any purpose with or without fee is hereby granted, provided that the
-# above copyright notice and this permission notice appear in all
-# copies.
-#
-# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
-# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
-# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
-# NONINFRINGEMENT OF THIRD PARTY RIGHTS. IN NO EVENT SHALL THE AUTHORS
-# OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
-# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
-# ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE
-# OR OTHER DEALINGS IN THE SOFTWARE.
-#
-# Except as contained in this notice, the name of a copyright holder
-# shall not be used in advertising or otherwise to promote the sale,
-# use or other dealings in this Software without prior written
-# authorization of the copyright holder.
-
- # Perl script to start server and browser
- # For usage instructions, run:
- # perl runtests.pl --help 
-
-use FindBin;
-use File::Path;
-use File::Spec;
-use File::Basename;
-use Getopt::Long;
-use Cwd 'abs_path';
-use POSIX qw(sys_wait_h strftime);
-
-use strict;
-
- # URL parameters to test URL:
- #
- # autorun -- kick off tests automatically
- # closeWhenDone -- runs quit.js after tests
- # logFile -- logs test run to an absolute path
- #
-
- # consoleLevel, fileLevel: set the logging level of the console and
- # file logs, if activated.
- # <http://mochikit.com/doc/html/MochiKit/Logging.html>
-
- # Path to the test script on the server
-use constant TEST_SERVER_HOST => "localhost:8888";
-use constant TEST_PATH => "/tests/";
-use constant CHROME_PATH => "/redirect.html";
-use constant A11Y_PATH => "/redirect-a11y.html";
-use constant TESTS_URL => "http://" . TEST_SERVER_HOST . TEST_PATH;
-use constant CHROMETESTS_URL => "http://" . TEST_SERVER_HOST . CHROME_PATH;
-use constant A11YTESTS_URL => "http://" . TEST_SERVER_HOST . A11Y_PATH;
- # main browser chrome URL, same as browser.chromeURL pref
-#ifdef MOZ_SUITE
-use constant BROWSER_CHROME_URL => "chrome://navigator/content/navigator.xul";
-#else
-use constant BROWSER_CHROME_URL => "chrome://browser/content/browser.xul";
-#endif
-
- # Max time in seconds to wait for server startup before tests will fail -- if
- # this seems big, it's mostly for debug machines where cold startup
- # (particularly after a build) takes forever.
-use constant SERVER_STARTUP_TIMEOUT => 45;
-
-
- # Since some tests require cross-domain support in Mochitest, across ports,
- # domains, subdomains, etc. we use a proxy autoconfig hack to map a bunch of
- # servers onto localhost:8888.  We have to grant them the same privileges as
- # localhost:8888 here, since the browser only knows them as the URLs they're
- # pretending to be.
-my @servers = (
-               "localhost:8888", # MUST be first -- see PAC pref-setting code
-               "example.org:80",
-               "test1.example.org:80",
-               "test2.example.org:80",
-               "sub1.test1.example.org:80",
-               "sub1.test2.example.org:80",
-               "sub2.test1.example.org:80",
-               "sub2.test2.example.org:80",
-               "example.org:8000",
-               "test1.example.org:8000",
-               "test2.example.org:8000",
-               "sub1.test1.example.org:8000",
-               "sub1.test2.example.org:8000",
-               "sub2.test1.example.org:8000",
-               "sub2.test2.example.org:8000",
-               "example.com:80",
-               "test1.example.com:80",
-               "test2.example.com:80",
-               "sub1.test1.example.com:80",
-               "sub1.test2.example.com:80",
-               "sub2.test1.example.com:80",
-               "sub2.test2.example.com:80",
-               "sectest1.example.org:80",
-               "sub.sectest2.example.org:80",
-               "sub1.xn--lt-uia.example.org:8000", # U+00E4 U+006C U+0074
-               "sub2.xn--lt-uia.example.org:80",   # U+00E4 U+006C U+0074
-               "xn--exmple-cua.test:80",
-               "sub1.xn--exmple-cua.test:80",
-               "xn--hxajbheg2az3al.xn--jxalpdlp:80", # Greek IDN for example.test
-               "sub1.xn--hxajbheg2az3al.xn--jxalpdlp:80",
-              );
-
-
-my $profile = "mochitesttestingprofile";
-my $profile_dir = "$FindBin::Bin/$profile";
-
- # These are generated in mozilla/testing/mochitest/Makefile.in
-#expand my $app = "$FindBin::Bin/" . __BROWSER_PATH__;
-#expand my $dist_bin = "$FindBin::Bin/" . __XPC_BIN_PATH__;
-#ifdef WIN32
-#expand my $is_win32 = __WIN32__;
-#else
-my $is_win32 = 0;
-#endif
-my $is_mac = ($^O =~ m/darwin/);
-my $unixish = (!($is_win32) && !($is_mac));
-
- # Do everything.
- main();
-
-
- #################
- # MAIN FUNCTION #
- #################
-
-sub main {
-  my ($close_when_done, $appoverride, $log_path, $autorun,
-      $console_level, $file_level, $help, $do_chrome, $test_path,
-      $do_browser_chrome, $do_a11y, %browser_env, %browser_args);
-  GetOptions("close-when-done!"=> \$close_when_done,
-             "appname:s"=> \$appoverride,
-             "log-file:s" => \$log_path,
-             "autorun!" => \$autorun,
-             "console-level:s" => \$console_level,
-             "file-level:s" => \$file_level,
-             "chrome!" => \$do_chrome,
-             "test-path:s" => \$test_path,
-             "browser-chrome!" => \$do_browser_chrome,
-             "a11y!" => \$do_a11y,
-             "setenv=s%" => \%browser_env,
-             "browser-arg=s%" => \%browser_args,
-             "help!" => \$help);
-
-  # if the switches include --help, exit and print directions
-  if ($help) {
-    usage_and_exit();
-  }
-
-  # we were passed an explicit path to the app
-  if ($appoverride) {
-    $app = $appoverride;
-  }
-
-  # make sure the application we're going to use exists
-  unless (-e $app) {
-    my $error_message = "\nError: Path \"$app\" doesn't exist.\n";
-    $error_message .= "Are you executing ";
-    $error_message .= "\$objdir/_tests/testing/mochitest/runtests.pl?\n\n";
-    die $error_message;
-  }
-
-  my $manifest = initializeProfile($app, $do_browser_chrome);
-  my $serverPid = startServer($close_when_done);
-
-  # If we're lucky, the server has fully started by now, and all paths are
-  # ready, etc.  However, xpcshell cold start times suck, at least for debug
-  # builds.  We'll try to connect to the server for 30 seconds or until we
-  # succeed, whichever is first.  If we succeed, then we continue with
-  # execution.  If we fail, we try to kill the server and exit with an error.
-  wait_for_server_startup($serverPid, SERVER_STARTUP_TIMEOUT);
-
-  my $url;
-  if ($do_chrome) {
-   $url = CHROMETESTS_URL . "?" . ($test_path ? "testPath=" . $test_path : "");
-  } elsif ($do_browser_chrome) {
-   # Tests will run from an overlay, no need to load any URL.  We'll include
-   # the test path in the config file so the browser chrome harness can use it.
-   $url = "about:blank";
-  } elsif ($do_a11y) {
-   $url = A11YTESTS_URL . "?" . ($test_path ? "testPath=" . $test_path : "");
-  } else {
-   $url = TESTS_URL . ($test_path ? $test_path : "") . "?";
-  }
-
-  if ($do_browser_chrome) {
-    generate_test_config($autorun, $close_when_done, $log_path, $test_path);
-  } else {
-    if ($autorun) {
-      $url .= "&autorun=1";
-    }
-    if ($close_when_done) {
-      $url .= "&closeWhenDone=1";
-    }
-    if ($log_path) {
-      $url .= "&logFile=$log_path";
-    }
-    if ($file_level) {
-      $url .= "&fileLevel=$file_level";
-    }
-    if ($console_level) {
-      $url .= "&consoleLevel=$console_level";
-    }
-  }
-  
-  my $test_start = runTests($url, \%browser_env, \%browser_args);
-
-  shutdownServer($serverPid);
-
-  # print test run times
-  my $test_finish = localtime();
-  print " started: $test_start\n";
-  print "finished: $test_finish\n";
-
-  # delete the profile and manifest
-  # rmtree($profile_dir, 0, 0);
-  unlink($manifest);
-}
-
- #######################
- # COMMANDLINE USAGE   #
- #######################
-
-sub usage_and_exit {
-  print "\n";
-  print "Usage instructons for runtests.pl.\n";
-  print "If --log-file is specified, --file-level must be specified as well.\n";
-  print "If --chrome is specified, chrome tests will be run instead of web content tests.\n";
-  print "If --browser-chrome is specified, browser-chrome tests will be run instead of web content tests.\n";
-  print "If --a11y is specified, a11y tests will be run instead of web content tests.";
-  print "\n\n";
-  print "Syntax:\n";
-  print "  runtests.pl \\\n";
-  print "   [--autorun] \\\n";
-  print "   [--chrome] \\\n";
-  print "   [--browser-chrome] \\\n";
-  print "   [--a11y] \\\n";
-  print "   [--close-when-done] \\\n";
-  print "   [--appname=/path/to/app] \\\n";
-  print "   [--log-file=/path/to/logfile] \\\n";
-  print "   [--test-path=relative/path/to/tests] \\\n";
-  print "   [--setenv=VAR=value] \\\n";  
-  print "   [--browser-arg=VAR=value] \\\n";
-  print "   [--file-level=DEBUG|INFO|ERROR|FATAL|WARNING] \\\n";  
-  print "   [--console-level=DEBUG|INFO|ERROR|FATAL|WARNING] \n\n";  
-  exit(1);
-}
-
- #######################
- # MAKE A WINDOWS PATH #
- #######################
-
-#ifdef IS_CYGWIN
-
-sub winPathFromDir {
-  my ($path) = abs_path(@_);
-
-  # Use external cygpath command to get the windows-like path
-  $path = `cygpath -w $path`;
-  
-  # Just remove the traling CR char
-  chop($path);
-  return $path;
-}
-
-#else
-# Non-cygwin version
-
-sub winPathFromDir {
-  my ($path) = abs_path(@_);
-
-  # This is a windows mingw32 build, we need to translate the
-  # given path to the "actual" windows path.
-
-  my @m = `mount`;
-  my $matchlen;
-  my $bestmatch;
-  my $mount;
-
-  #example mount output:
-  # C:\DOCUME~1\Temp on /tmp type user (binmode,noumount)
-  # c:\ActiveState\perl on /perl type user (binmode)
-  # C:\msys\1.0\bin on /usr/bin type user (binmode,cygexec,noumount)
-  # C:\msys\1.0\bin on /bin type user (binmode,cygexec,noumount)
-  foreach $mount (@m) {
-    if ( $mount =~ /(.*) on ([^ ]*) type /) {
-      my ($mingw, $real)=($2, $1);
-      if ($path =~ /^$mingw/i) {
-        # the path starts with the path we
-        # found on this line in the mount output
-        my $len = length($mingw);
-        if ($len > $matchlen) {
-          # we remember the match that is the longest
-          $matchlen = $len;
-          $bestmatch = $real;
-        }
-      }
-    }
-  }
-  if (!$matchlen) {
-    die "Serious error, can't find our \"real\" path!\n";
-  }
-
-  my ($volume,$directories,$file) =
-    File::Spec->splitpath(substr($path, $matchlen), 1);
-  my @dirs = File::Spec->splitdir( $directories );
-  return $bestmatch . "\\" . join "\\", @dirs;
-}
-
-# End of non-cygwin version
-#endif
-
- ##################
- # SERVER STARTUP #
- ##################
-
- # Start up the server, and let the server script handle shutdown if
- # we're closing when done.  (We'll kill it later if it goes zombie
- # somehow, but that shouldn't be the way it happens except if
- # something really breaks.)
-
-sub startServer {
-  my ($close_when_done) = @_;
-  my $pid = fork();
-  if ($pid == 0) {
-    # Run the server
-    my $status = 0;
-
-    if ($close_when_done) {
-      $ENV{'CLOSE_WHEN_DONE'} = '1';
-    }
-
-    if ($unixish) {
-      $ENV{'LD_LIBRARY_PATH'} = $dist_bin;
-      $ENV{'MOZILLA_FIVE_HOME'} = $dist_bin;
-    }
-
-    my @runargs = ("$dist_bin/xpcshell", "-v", "170");
-
-    # this path is passed as a string, so we need to convert it on win32
-    if ($is_win32) {
-      push(@runargs, "-f", winPathFromDir($FindBin::Bin) . "\\httpd.js");
-      push(@runargs, "-f", winPathFromDir($FindBin::Bin) . "\\server.js");
-    } else {
-      push(@runargs, "-f", $FindBin::Bin . "/httpd.js");
-      push(@runargs, "-f", $FindBin::Bin . "/server.js");
-    }
-    print "@runargs\n";
-    exec @runargs or die("Error running server: $!\n");
-  }
-
-  return ($pid);
-}
-
-
- ##############
- # TEST SETUP #
- ##############
-
-sub generate_test_config {
-  my ($autorun, $close_when_done, $log_path, $test_path) = @_;
-  $autorun = $autorun || 0;
-  $close_when_done = $close_when_done || 0;
-  $log_path = $log_path || "";
-  $log_path =~ s/\\/\\\\/g;
-  $test_path = $test_path || "";
-  $test_path =~ s/\\/\\\\/g;
-
-  my $config_content = <<CONFIGEND;
-({
-  autoRun: $autorun,
-  closeWhenDone: $close_when_done,
-  logPath: "$log_path",
-  testPath: "$test_path"
-})
-CONFIGEND
-
-  open(CONFIGOUTFILE, ">$profile_dir/testConfig.js") ||
-    die("Could not open testConfig.js file $!");
-  print CONFIGOUTFILE ($config_content);
-  close(CONFIGOUTFILE);
-}
-
-sub initializeProfile {
-  my ($app_path, $do_browser_tests) = @_;
-  my $pref_content = <<PREFEND;
-user_pref("browser.dom.window.dump.enabled", true);
-user_pref("dom.disable_open_during_load", false);
-user_pref("dom.max_script_run_time", 0); // no slow script dialogs
-user_pref("signed.applets.codebase_principal_support", true);
-user_pref("security.warn_submit_insecure", false);
-user_pref("browser.shell.checkDefaultBrowser", false);
-user_pref("browser.warnOnQuit", false);
-user_pref("accessibility.typeaheadfind.autostart", false);
-user_pref("javascript.options.showInConsole", true);
-user_pref("layout.debug.enable_data_xbl", true);
-user_pref("browser.EULA.override", true);
-PREFEND
-
-  # Grant God-power to all the servers on which tests can run.
-  my $i = 1;
-  my $server;
-  foreach $server (@servers) {
-    $pref_content .= <<SERVERPREFEND;
-user_pref("capability.principal.codebase.p$i.granted", "UniversalXPConnect UniversalBrowserRead UniversalBrowserWrite UniversalPreferencesRead UniversalPreferencesWrite UniversalFileRead");
-user_pref("capability.principal.codebase.p$i.id", "http://$server");
-user_pref("capability.principal.codebase.p$i.subjectName", "");
-SERVERPREFEND
-    $i++;
-  }
-
-  # Now add the two servers that do NOT have God-power so we can properly test
-  # the granting and receiving of God-power
-  push(@servers,
-       "sectest2.example.org:80",
-       "sub.sectest1.example.org:80");
-
-
-  # Now actually create the preference to make the proxying happen, stripping
-  # off the first server because it's the one to which we proxy all the others.
-  my $quotedServers = join(", ", map("'" . $_ . "'", @servers[1 .. $#servers]));
-
-  my $pacURL = "data:text/plain,";
-  $pacURL   .= "function FindProxyForURL(url, host)             ";
-  $pacURL   .= "{                                               ";
-  $pacURL   .= "  var servers = [$quotedServers];               ";
-  $pacURL   .= "  var regex =                                   ";
-  $pacURL   .= "    new RegExp('http://(?:[^/@]*@)?(.*?(:\\\\\\\\d+)?)/');  ";
-  $pacURL   .= "  var matches = regex.exec(url);                ";
-  $pacURL   .= "  if (!matches)                                 ";
-  $pacURL   .= "    return 'DIRECT';                            ";
-  $pacURL   .= "  var hostport = matches[1], port = matches[2]; ";
-  $pacURL   .= "  if (!port)                                    ";
-  $pacURL   .= "    hostport += ':80';                          ";
-  $pacURL   .= "  if (servers.indexOf(hostport) >= 0)           ";
-  $pacURL   .= "    return 'PROXY localhost:8888';              ";
-  $pacURL   .= "  return 'DIRECT';                              ";
-  $pacURL   .= "}";
-
-  $pref_content .= <<PROXYPREFEND;
-user_pref("network.proxy.type", 2);
-user_pref("network.proxy.autoconfig_url", "$pacURL");
-PROXYPREFEND
-
-
-  my $chrome_content = <<CHROMEEND;
-\@namespace url("http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"); /* set default namespace to XUL */
-toolbar,
-toolbarpalette {
-  background-color: rgb(235, 235, 235) !important;
-}
-toolbar#nav-bar {
-  background-image: none !important;
-}
-CHROMEEND
-
-  # in case we died for some reason on the last run
-  rmtree($profile_dir, 0, 0);
-
-  my $chrome_dir = "$profile_dir/chrome";
-  mkdir($profile_dir);
-  mkdir($chrome_dir);
-
-  # append magic prefs to user.js
-  open(PREFOUTFILE, ">>$profile_dir/user.js") ||
-    die("Could not open user.js file $!\n");
-  print PREFOUTFILE ($pref_content);
-  close(PREFOUTFILE) or die("Couldn't close user.js file: $!\n");
-
-  # add userChrome.css
-  open(CHROMEOUTFILE, ">>$chrome_dir/userChrome.css") ||
-    die("Could not open userChrome.css file $!");
-  print CHROMEOUTFILE ($chrome_content);
-  close(CHROMEOUTFILE);
-
-  # register our chrome dir
-  my $chrometest_dir = "$FindBin::Bin/";
-  if ($is_win32) {
-    # we don't have LWP, so we can't use its file url stuff
-    $chrometest_dir = winPathFromDir($chrometest_dir) . "\\";
-    $chrometest_dir =~ s/\\/\//g;
-    $chrometest_dir = "file:///$chrometest_dir";
-  }
-  
-  my($filename, $directories, $suffix) = fileparse($app_path);
-  my $manifest = $directories . "chrome/mochikit.manifest";
-  open(MANIFEST, ">$manifest") ||
-    die("Could not open manifest file $!");
-  print MANIFEST ("content mochikit $chrometest_dir contentaccessible=yes\n");
-  if ($do_browser_tests) {
-    print MANIFEST ("overlay " . BROWSER_CHROME_URL . " chrome://mochikit/content/browser-test-overlay.xul\n");
-  }
-  close(MANIFEST);
-
-  return $manifest;
-}
-
- ###################
- # WAIT FOR SERVER #
- ###################
-
-sub wait_for_server_startup {
-  my ($pid, $timeout) = @_;
-
-  die ("Invalid timeout value passed to wait_for_server_startup()\n")
-      if ($timeout <= 0);
-
-  eval {
-      my $loop_count = 0;
-      while ($loop_count++ < $timeout) {
-          last if (-e "$profile_dir/server_alive.txt");
-          sleep 1;
-      }
-
-      die "timeout" if ($loop_count >= $timeout);
-      return "done";
-  };
-
-  my $time_out_message;
-  if ($@) {
-    if ($@ =~ /timeout/) {
-      $time_out_message = "\nError: ";
-      $time_out_message = "Timed out while waiting for server startup.\n";
-    } else {
-      # Died for some other reason.
-      $time_out_message = "An unknown error occurred ";
-      $time_out_message .= "while waiting for server startup.\n";
-    }
-  }
-
-  if ($time_out_message) {
-    kill_process($pid);
-    print $time_out_message;
-    exit(1);
-  }
-}
-
-sub kill_process {
-  my ($target_pid) = @_;
-  my $start_time = time();
-
-  # Try to kill and wait 10 seconds, then try a kill -9
-  my $sig;
-  for $sig ('TERM', 'KILL') {
-    print "kill $sig $target_pid\n";
-    kill $sig => $target_pid;
-    my $interval_start = time;
-    while (time - $interval_start < 10) {
-      # the following will work with 'cygwin' perl on win32, but not
-      # with 'MSWin32' (ActiveState) perl
-      my $pid = waitpid($target_pid, POSIX::WNOHANG());
-      if (($pid == $target_pid and POSIX::WIFEXITED($?)) or $pid == -1) {
-        my $secs = time - $start_time;
-        $secs = $secs == 1 ? '1 second' : "$secs seconds";
-        print "Process killed. Took $secs to die.\n";
-        return;
-      }
-      sleep 1;
-    }
-  }
-  die "Unable to kill process: $target_pid";
-}
-
- ##################
- # TEST EXECUTION #
- ##################
-
-sub runTests {
-  my ($test_url, $browser_env, $browser_args) = @_;
-
-  # mark the start
-  my $test_start = localtime();
-
-  # set env vars so Firefox doesn't quit weirdly and break the script
-  $ENV{'NO_EM_RESTART'} = '1';
-  $ENV{'XPCOM_DEBUG_BREAK'} = 'warn';
-
-  if ($unixish) {
-    $ENV{'LD_LIBRARY_PATH'} = $dist_bin;
-    $ENV{'MOZILLA_FIVE_HOME'} = $dist_bin;
-  }
-
-  for my $key (keys(%{$browser_env})) {
-    $ENV{$key} = $browser_env->{$key};
-  }
-
-  my $profile_arg = "$profile_dir";
-  if ($is_win32) {
-    $profile_arg = winPathFromDir($profile_dir);
-  }
-
-  # now run with the profile we created
-
-  # On Windows and Linux, the application is focused for us. On OS X, we
-  # need to use applescript to focus the app and then set the url.
-  my $rc = -1;
-  if (!$is_mac) {
-    my @runargs = ($app, '-no-remote', '-profile', $profile_arg);
-    if ($browser_args) {
-      foreach my $key (keys %$browser_args) {
-        push(@runargs, ($key,
-			$browser_args->{$key})
-	    );
-      }
-    }
-    push(@runargs, $test_url);
-    $rc = 0xffff & system @runargs;
-  } else {
-    $rc = executeMac($profile_arg, $test_url, $browser_args);
-  }
-
-  if ($rc != 0) {
-    print "FAIL Exited with code $rc during test run\n";
-  }
-
-  return $test_start;
-}
-
-sub executeMac {
-  my ($profile_arg, $test_url, $browser_args) = @_;
-  my $pid = fork();
-  if (not defined $pid) {
-    die "cannot fork: $!";
-  } elsif ($pid == 0) {
-    # run only the executable so we get a pid we can focus
-    if ($app !~ /-bin$/) {
-        $app .= "-bin";
-    }
-    my @runargs = ($app, '-foreground', '-no-remote', '-profile', $profile_arg);
-    if ($browser_args) {
-      foreach my $key (keys %$browser_args) {     
-        push(@runargs, ($key,
-                        $browser_args->{$key})
-            );
-      }
-    }
-    push(@runargs, $test_url);
-    
-    # redirect stderr to stdout for easier buildbot / tinderbox logging
-    #$ENV{'XPCOM_DEBUG_BREAK'} = 'stack';
-    open (STDERR, '>&', \*STDOUT) || die $!;
-    exec @runargs or die("Error starting application: $!\n");
-  } else {
-    waitpid($pid,0);
-  }
-
-  # return the exit code we received from waitpid
-  return $?;
-}
-
- ##################
- # SHUT DOWN      #
- ##################
-
-sub shutdownServer {
-  my ($pid) = @_;
-  kill_process($pid);
-}
diff --git a/testing/mochitest/runtests.py.in b/testing/mochitest/runtests.py.in
--- a/testing/mochitest/runtests.py.in
+++ b/testing/mochitest/runtests.py.in
@@ -72,16 +72,17 @@ BROWSER_CHROME_URL = "chrome://browser/c
 
 # Max time in seconds to wait for server startup before tests will fail -- if
 # this seems big, it's mostly for debug machines where cold startup
 # (particularly after a build) takes forever.
 SERVER_STARTUP_TIMEOUT = 45
 
 INFINITY = 1.0e3000
 
+oldcwd = os.getcwd()
 SCRIPT_DIRECTORY = os.path.abspath(os.path.realpath(os.path.dirname(sys.argv[0])))
 os.chdir(SCRIPT_DIRECTORY)
 
 PROFILE_DIRECTORY = os.path.abspath("./mochitesttestingprofile")
 
 LEAK_REPORT_FILE = PROFILE_DIRECTORY + "/" + "leaks-report.log"
 
 log = logging.getLogger()
@@ -333,17 +334,17 @@ Are you executing $objdir/_tests/testing
   if options.browserChrome:
     makeTestConfig(options)
   else:
     if options.autorun:
       urlOpts.append("autorun=1")
     if options.closeWhenDone:
       urlOpts.append("closeWhenDone=1")
     if options.logFile:
-      urlOpts.append("logFile=" + encodeURIComponent(options.logFile))
+      urlOpts.append("logFile=" + encodeURIComponent(os.path.normpath(os.path.join(oldcwd, options.logFile))))
       urlOpts.append("fileLevel=" + encodeURIComponent(options.fileLevel))
     if options.consoleLevel:
       urlOpts.append("consoleLevel=" + encodeURIComponent(options.consoleLevel))
     if len(urlOpts) > 0:
       testURL += "?" + "&".join(urlOpts)
 
   browserEnv["XPCOM_MEM_BLOAT_LOG"] = LEAK_REPORT_FILE
 
diff --git a/toolkit/mozapps/downloads/tests/browser/browser_bug_406857.js b/toolkit/components/downloads/test/unit/test_bug_406857.js
rename from toolkit/mozapps/downloads/tests/browser/browser_bug_406857.js
rename to toolkit/components/downloads/test/unit/test_bug_406857.js
--- a/toolkit/mozapps/downloads/tests/browser/browser_bug_406857.js
+++ b/toolkit/components/downloads/test/unit/test_bug_406857.js
@@ -34,24 +34,21 @@
  *
  * ***** END LICENSE BLOCK ***** */
 
 /**
  * Test bug 406857 to make sure a download's referrer doesn't disappear when
  * retrying the download.
  */
 
-function test()
+function run_test()
 {
   let dm = Cc["@mozilla.org/download-manager;1"].
            getService(Ci.nsIDownloadManager);
   let db = dm.DBConnection;
-
-  // Empty any old downloads
-  db.executeSimpleSQL("DELETE FROM moz_downloads");
 
   let stmt = db.createStatement(
     "INSERT INTO moz_downloads (source, target, state, referrer) " +
     "VALUES (?1, ?2, ?3, ?4)");
 
   // Download from the test http server
   stmt.bindStringParameter(0, "http://example.com/httpd.js");
 
@@ -74,51 +71,27 @@ function test()
   stmt.execute();
   stmt.finalize();
 
   let listener = {
     onDownloadStateChange: function(aState, aDownload)
     {
       switch (aDownload.state) {
         case dm.DOWNLOAD_DOWNLOADING:
-          ok(aDownload.referrer.spec == referrer, "Got referrer on download");
+          do_check_eq(aDownload.referrer.spec, referrer);
           break;
         case dm.DOWNLOAD_FINISHED:
-          ok(aDownload.referrer.spec == referrer, "Got referrer on finish");
+          do_check_eq(aDownload.referrer.spec, referrer);
 
           dm.removeListener(listener);
-          obs.removeObserver(testObs, DLMGR_UI_DONE);
           try { file.remove(false); } catch(e) { /* stupid windows box */ }
-          finish();
+          do_test_finished();
           break;
       }
     }
   };
   dm.addListener(listener);
 
-  // Close the UI if necessary
-  let wm = Cc["@mozilla.org/appshell/window-mediator;1"].
-           getService(Ci.nsIWindowMediator);
-  let win = wm.getMostRecentWindow("Download:Manager");
-  if (win) win.close();
+  // Retry the download, and wait.
+  dm.retryDownload(1);
 
-  let obs = Cc["@mozilla.org/observer-service;1"].
-            getService(Ci.nsIObserverService);
-  const DLMGR_UI_DONE = "download-manager-ui-done";
-
-  let testObs = {
-    observe: function(aSubject, aTopic, aData) {
-      if (aTopic != DLMGR_UI_DONE)
-        return;
-
-      // Send the enter key to Download Manager to retry the download
-      let win = aSubject.QueryInterface(Ci.nsIDOMWindow);
-      EventUtils.synthesizeKey("VK_ENTER", {}, win);
-    }
-  };
-  obs.addObserver(testObs, DLMGR_UI_DONE, false);
-
-  // Show the Download Manager UI
-  Cc["@mozilla.org/download-manager-ui;1"].
-  getService(Ci.nsIDownloadManagerUI).show();
-
-  waitForExplicitFinish();
+  do_test_pending();
 }
diff --git a/toolkit/components/passwordmgr/public/nsILoginManager.idl b/toolkit/components/passwordmgr/public/nsILoginManager.idl
--- a/toolkit/components/passwordmgr/public/nsILoginManager.idl
+++ b/toolkit/components/passwordmgr/public/nsILoginManager.idl
@@ -38,17 +38,17 @@
 #include "nsISupports.idl"
 
 interface nsIURI;
 interface nsILoginInfo;
 interface nsIAutoCompleteResult;
 interface nsIDOMHTMLInputElement;
 interface nsIDOMHTMLFormElement;
 
-[scriptable, uuid(5247f630-38a5-11dd-ae16-0800200c9a66)]
+[scriptable, uuid(04dbfa30-4238-11dd-ae16-0800200c9a66)]
 
 interface nsILoginManager : nsISupports {
 
     /**
      * Store a new login in the login manager.
      *
      * @param aLogin
      *        The login to be added.
@@ -214,17 +214,18 @@ interface nsILoginManager : nsISupports 
                                     in nsIDOMHTMLInputElement aElement);
 
     /**
      * Fill a form with login information if we have it. This method will fill
      * aForm regardless of the signon.autofillForms preference.
      *
      * @param aForm
      *        The form to fill
+     * @return Success of attempt fill form
      */
-    void fillForm(in nsIDOMHTMLFormElement aForm);
+    boolean fillForm(in nsIDOMHTMLFormElement aForm);
 };
 
 %{C++
 
 #define NS_LOGINMANAGER_CONTRACTID "@mozilla.org/login-manager;1"
 
 %}
diff --git a/toolkit/components/passwordmgr/src/nsLoginManager.js b/toolkit/components/passwordmgr/src/nsLoginManager.js
--- a/toolkit/components/passwordmgr/src/nsLoginManager.js
+++ b/toolkit/components/passwordmgr/src/nsLoginManager.js
@@ -79,16 +79,25 @@ LoginManager.prototype = {
         if (!this.__formFillService)
             this.__formFillService =
                             Cc["@mozilla.org/satchel/form-fill-controller;1"].
                             getService(Ci.nsIFormFillController);
         return this.__formFillService;
     },
 
 
+    __observerService : null, // Observer Service, for notifications
+    get _observerService() {
+        if (!this.__observerService)
+            this.__observerService = Cc["@mozilla.org/observer-service;1"].
+                                     getService(Ci.nsIObserverService);
+        return this.__observerService;
+    },
+
+
     __storage : null, // Storage component which contains the saved logins
     get _storage() {
         if (!this.__storage) {
 
             var contractID = "@mozilla.org/login-manager/storage/legacy;1";
             try {
                 var catMan = Cc["@mozilla.org/categorymanager;1"].
                              getService(Ci.nsICategoryManager);
@@ -150,20 +159,18 @@ LoginManager.prototype = {
 
 
         // Get constructor for nsILoginInfo
         this._nsLoginInfo = new Components.Constructor(
             "@mozilla.org/login-manager/loginInfo;1", Ci.nsILoginInfo);
 
 
         // Form submit observer checks forms for new logins and pw changes.
-        var observerService = Cc["@mozilla.org/observer-service;1"].
-                              getService(Ci.nsIObserverService);
-        observerService.addObserver(this._observer, "earlyformsubmit", false);
-        observerService.addObserver(this._observer, "xpcom-shutdown", false);
+        this._observerService.addObserver(this._observer, "earlyformsubmit", false);
+        this._observerService.addObserver(this._observer, "xpcom-shutdown", false);
 
         // WebProgressListener for getting notification of new doc loads.
         var progress = Cc["@mozilla.org/docloaderservice;1"].
                        getService(Ci.nsIWebProgress);
         progress.addProgressListener(this._webProgressListener,
                                      Ci.nsIWebProgress.NOTIFY_STATE_DOCUMENT);
 
 
@@ -961,40 +968,44 @@ LoginManager.prototype = {
             // Only the actionOrigin might be changing, so if it's the same
             // as the last form on the page we can reuse the same logins.
             var actionOrigin = this._getActionOrigin(form);
             if (actionOrigin != previousActionOrigin) {
                 foundLogins = null;
                 previousActionOrigin = actionOrigin;
             }
             this.log("_fillDocument processing form[" + i + "]");
-            foundLogins = this._fillForm(form, autofillForm, foundLogins);
+            foundLogins = this._fillForm(form, autofillForm, false, foundLogins)[1];
         } // foreach form
     },
 
 
     /*
      * _fillform
      *
      * Fill the form with login information if we can find it. This will find
      * an array of logins if not given any, otherwise it will use the logins
-     * passed in.  The logins are returned so they can be reused for
-     * optimization.
+     * passed in. The logins are returned so they can be reused for
+     * optimization. Success of action is also returned in format
+     * [success, foundLogins]. autofillForm denotes if we should fill the form
+     * in automatically, ignoreAutocomplete denotes if we should ignore
+     * autocomplete=off attributes, and foundLogins is an array of nsILoginInfo
+     * for optimization
      */
-    _fillForm : function (form, autofillForm, foundLogins) {
+    _fillForm : function (form, autofillForm, ignoreAutocomplete, foundLogins) {
         // Heuristically determine what the user/pass fields are
         // We do this before checking to see if logins are stored,
         // so that the user isn't prompted for a master password
         // without need.
         var [usernameField, passwordField, ignored] =
             this._getFormFields(form, false);
 
         // Need a valid password field to do anything.
         if (passwordField == null)
-            return foundLogins;
+            return [false, foundLogins];
 
         // Need to get a list of logins if we weren't given them
         if (foundLogins == null) {
             var formOrigin = 
                 this._getPasswordOrigin(form.ownerDocument.documentURI);
             var actionOrigin = this._getActionOrigin(form);
             foundLogins = this.findLogins({}, formOrigin, actionOrigin, null);
             this.log("found " + foundLogins.length + " matching logins.");
@@ -1022,90 +1033,107 @@ LoginManager.prototype = {
                     this.log("Ignored " + l.username + " login: won't fit");
 
                 return fit;
             }, this);
 
 
         // Nothing to do if we have no matching logins available.
         if (logins.length == 0)
-            return foundLogins;
+            return [false, foundLogins];
 
 
         // Attach autocomplete stuff to the username field, if we have
         // one. This is normally used to select from multiple accounts,
         // but even with one account we should refill if the user edits.
         if (usernameField)
             this._attachToInput(usernameField);
 
         // If the form has an autocomplete=off attribute in play, don't
         // fill in the login automatically. We check this after attaching
         // the autocomplete stuff to the username field, so the user can
         // still manually select a login to be filled in.
         var isFormDisabled = false;
-        if (this._isAutocompleteDisabled(form) ||
-            this._isAutocompleteDisabled(usernameField) ||
-            this._isAutocompleteDisabled(passwordField)) {
+        if (!ignoreAutocomplete &&
+            (this._isAutocompleteDisabled(form) ||
+             this._isAutocompleteDisabled(usernameField) ||
+             this._isAutocompleteDisabled(passwordField))) {
 
             isFormDisabled = true;
             this.log("form not filled, has autocomplete=off");
         }
 
-        if (autofillForm && !isFormDisabled) {
+        // Variable such that we reduce code duplication and can be sure we
+        // should be firing notifications if and only if we can fill the form.
+        var selectedLogin = null;
 
-            if (usernameField && usernameField.value) {
-                // If username was specified in the form, only fill in the
-                // password if we find a matching login.
+        if (usernameField && usernameField.value) {
+            // If username was specified in the form, only fill in the
+            // password if we find a matching login.
 
-                var username = usernameField.value;
+            var username = usernameField.value;
 
-                var matchingLogin;
-                var found = logins.some(function(l) {
-                                            matchingLogin = l;
-                                            return (l.username == username);
-                                        });
-                if (found)
-                    passwordField.value = matchingLogin.password;
-                else
-                    this.log("Password not filled. None of the stored " +
-                             "logins match the username already present.");
+            var matchingLogin;
+            var found = logins.some(function(l) {
+                                        matchingLogin = l;
+                                        return (l.username == username);
+                                    });
+            if (found)
+                selectedLogin = matchingLogin;
+            else
+                this.log("Password not filled. None of the stored " +
+                         "logins match the username already present.");
 
-            } else if (usernameField && logins.length == 2) {
-                // Special case, for sites which have a normal user+pass
-                // login *and* a password-only login (eg, a PIN)...
-                // When we have a username field and 1 of 2 available
-                // logins is password-only, go ahead and prefill the
-                // one with a username.
-                if (!logins[0].username && logins[1].username) {
-                    usernameField.value = logins[1].username;
-                    passwordField.value = logins[1].password;
-                } else if (!logins[1].username && logins[0].username) {
-                    usernameField.value = logins[0].username;
-                    passwordField.value = logins[0].password;
-                }
-            } else if (logins.length == 1) {
-                if (usernameField)
-                    usernameField.value = logins[0].username;
-                passwordField.value = logins[0].password;
-            } else {
-                this.log("Multiple logins for form, so not filling any.");
-            }
+        } else if (usernameField && logins.length == 2) {
+            // Special case, for sites which have a normal user+pass
+            // login *and* a password-only login (eg, a PIN)...
+            // When we have a username field and 1 of 2 available
+            // logins is password-only, go ahead and prefill the
+            // one with a username.
+            if (!logins[0].username && logins[1].username)
+                selectedLogin = logins[1];
+            else if (!logins[1].username && logins[0].username)
+                selectedLogin = logins[0];
+        } else if (logins.length == 1) {
+            selectedLogin = logins[0];
+        } else {
+            this.log("Multiple logins for form, so not filling any.");
         }
-        return foundLogins;
+
+        var didFillForm = false;
+        if (selectedLogin && autofillForm && !isFormDisabled) {
+            // Fill the form
+            if (usernameField)
+                usernameField.value = selectedLogin.username;
+            passwordField.value = selectedLogin.password;
+            didFillForm = true;
+        } else if (selectedLogin && !autofillForm) {
+            // For when autofillForm is false, but we still have the information
+            // to fill a form, we notify observers.
+            this._observerService.notifyObservers(form, "passwordmgr-found-form", "noAutofillForms");
+            this.log("autofillForms=false but form can be filled; notified observers");
+        } else if (selectedLogin && isFormDisabled) {
+            // For when autocomplete is off, but we still have the information
+            // to fill a form, we notify observers.
+            this._observerService.notifyObservers(form, "passwordmgr-found-form", "autocompleteOff");
+            this.log("autocomplete=off but form can be filled; notified observers");
+        }
+
+        return [didFillForm, foundLogins];
     },
 
 
     /*
      * fillForm
      *
      * Fill the form with login information if we can find it.
      */
     fillForm : function (form) {
         this.log("fillForm processing form[id=" + form.id + "]");
-        this._fillForm(form, true, null)
+        return this._fillForm(form, true, true, null)[0];
     },
 
 
     /*
      * _attachToInput
      *
      * Hooks up autocomplete support to a username field, to allow
      * a user editing the field to select an existing login and have
diff --git a/toolkit/components/passwordmgr/test/Makefile.in b/toolkit/components/passwordmgr/test/Makefile.in
--- a/toolkit/components/passwordmgr/test/Makefile.in
+++ b/toolkit/components/passwordmgr/test/Makefile.in
@@ -52,16 +52,18 @@ MOCHI_TESTS = \
 		test_basic_form.html \
 		test_basic_form_2.html \
 		test_basic_form_0pw.html \
 		test_basic_form_1pw.html \
 		test_basic_form_2pw_1.html \
 		test_basic_form_2pw_2.html \
 		test_basic_form_3pw_1.html \
 		test_basic_form_autocomplete.html \
+		test_basic_form_observer_autofillForms.html \
+		test_basic_form_observer_autocomplete.html \
 		test_basic_form_pwonly.html \
 		test_bug_227640.html \
 		test_bug_242956.html \
 		test_bug_360493_1.html \
 		test_bug_360493_2.html \
 		test_bug_391514.html \
 		test_bug_427033.html \
 		test_prompt.html \
diff --git a/toolkit/components/passwordmgr/test/test_basic_form_2.html b/toolkit/components/passwordmgr/test/test_basic_form_2.html
--- a/toolkit/components/passwordmgr/test/test_basic_form_2.html
+++ b/toolkit/components/passwordmgr/test/test_basic_form_2.html
@@ -40,18 +40,19 @@ prefs.setBoolPref("autofillForms", false
 prefs.setBoolPref("autofillForms", false);
 
 function startTest(){
   netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
   // Ensure the form is empty at start
   is($_(1, "uname").value, "", "Checking for blank username");
   is($_(1, "pword").value, "", "Checking for blank password");
 
-  // Call the public method
-  pwmgr.fillForm(document.getElementById("form1"));
+  // Call the public method, check return value
+  is(pwmgr.fillForm(document.getElementById("form1")), true,
+     "Checking return value of fillForm");
 
   // Check that the form was filled
   is($_(1, "uname").value, "testuser", "Checking for filled username");
   is($_(1, "pword").value, "testpass", "Checking for filled password");
 
   // Reset pref (since we assumed it was true to start)
   prefs.setBoolPref("autofillForms", true);
 
diff --git a/toolkit/components/passwordmgr/test/test_basic_form_observer_autocomplete.html b/toolkit/components/passwordmgr/test/test_basic_form_observer_autocomplete.html
new file mode 100644
--- /dev/null
+++ b/toolkit/components/passwordmgr/test/test_basic_form_observer_autocomplete.html
@@ -0,0 +1,107 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+  <title>Test for Login Manager</title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>  
+  <script type="text/javascript" src="pwmgr_common.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+Login Manager test: simple form with autocomplete off and notifying observers & normal form
+<p id="display"></p>
+
+<div id="content" style="display: block">
+
+  <form id="form1" action="formtest.js" autocomplete="off">
+    <p>This is form 1.</p>
+    <input  type="text"       name="uname">
+    <input  type="password"   name="pword">
+
+    <button type="submit">Submit</button>
+    <button type="reset"> Reset </button>
+  </form>
+  
+  <form id="form2" action="formtest.js">
+    <p>This is form 2.</p>
+    <input  type="text"       name="uname">
+    <input  type="password"   name="pword">
+
+    <button type="submit">Submit</button>
+    <button type="reset"> Reset </button>
+  </form>
+
+</div>
+
+<pre id="test">
+<script class="testbody" type="text/javascript">
+
+/** Test for Login Manager: simple form with autocomplete off and notifying observers & normal form **/
+
+netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
+const Cc = Components.classes;
+const Ci = Components.interfaces;
+const Cu = Components.utils;
+
+Cu.import("resource://gre/modules/XPCOMUtils.jsm");
+
+var TestObserver = {
+  receivedNotification1 : false,
+  receivedNotification2 : false,
+  data1 : "",
+  data2 : "",
+  QueryInterface : XPCOMUtils.generateQI([Ci.nsIObserver, Ci.nsISupportsWeakReference]),
+  observe : function (subject, topic, data) {
+    netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
+    var pwmgr = Cc["@mozilla.org/login-manager;1"].
+                getService(Ci.nsILoginManager);
+    if (topic == "passwordmgr-found-form") {
+      if (subject.id == "form1") {
+        this.receivedNotification1 = true;
+        this.data1 = data;
+      } else if (subject.id == "form2") {
+        this.receivedNotification2 = true;
+        this.data2 = data;
+      }
+      // Now fill the form
+      pwmgr.fillForm(subject);
+    }
+  }
+};
+
+// Add the observer
+var os = Cc["@mozilla.org/observer-service;1"].
+         getService(Ci.nsIObserverService);
+os.addObserver(TestObserver, "passwordmgr-found-form", false);
+
+function startTest(){
+  netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
+  // Test that observer is notified & got correct data
+  is(TestObserver.receivedNotification1, true, "Checking observer was notified");
+  is(TestObserver.data1, "autocompleteOff", "Checking observer got correct data");
+
+  // Check that form1 was filled
+  is($_(1, "uname").value, "testuser", "Checking for filled username 1");
+  is($_(1, "pword").value, "testpass", "Checking for filled password 1");
+  
+  // Test that observer wasn't notified & didn't get data
+  is(TestObserver.receivedNotification2, false, "Checking observer was not notified");
+  is(TestObserver.data2, "", "Checking observer didn't get data");
+
+  // Check that form2 was filled
+  is($_(2, "uname").value, "testuser", "Checking for filled username 2");
+  is($_(2, "pword").value, "testpass", "Checking for filled password 2");
+
+  // Remove the observer
+  os.removeObserver(TestObserver, "passwordmgr-found-form");
+
+  SimpleTest.finish();
+}
+
+window.onload = startTest;
+
+SimpleTest.waitForExplicitFinish();
+</script>
+</pre>
+</body>
+</html>
diff --git a/toolkit/components/passwordmgr/test/test_basic_form_observer_autofillForms.html b/toolkit/components/passwordmgr/test/test_basic_form_observer_autofillForms.html
new file mode 100644
--- /dev/null
+++ b/toolkit/components/passwordmgr/test/test_basic_form_observer_autofillForms.html
@@ -0,0 +1,92 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+  <title>Test for Login Manager</title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>  
+  <script type="text/javascript" src="pwmgr_common.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+Login Manager test: simple form with autofillForms disabled and notifying observers
+<p id="display"></p>
+
+<div id="content" style="display: block">
+
+  <form id="form1" action="formtest.js">
+    <p>This is form 1.</p>
+    <input  type="text"       name="uname">
+    <input  type="password"   name="pword">
+
+    <button type="submit">Submit</button>
+    <button type="reset"> Reset </button>
+  </form>
+
+</div>
+
+<pre id="test">
+<script class="testbody" type="text/javascript">
+
+/** Test for Login Manager: simple form with autofillForms disabled and notifying observers **/
+
+netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
+const Cc = Components.classes;
+const Ci = Components.interfaces;
+const Cu = Components.utils;
+
+Cu.import("resource://gre/modules/XPCOMUtils.jsm");
+
+var prefs = Cc["@mozilla.org/preferences-service;1"].
+            getService(Ci.nsIPrefService);
+prefs = prefs.getBranch("signon.");
+// Assume that the pref starts out true, so set to false
+prefs.setBoolPref("autofillForms", false);
+
+var TestObserver = {
+  receivedNotification : false,
+  data : "",
+  QueryInterface : XPCOMUtils.generateQI([Ci.nsIObserver, Ci.nsISupportsWeakReference]),
+  observe : function (subject, topic, data) {
+    netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
+    var pwmgr = Cc["@mozilla.org/login-manager;1"].
+                getService(Ci.nsILoginManager);
+    if (topic == "passwordmgr-found-form") {
+      this.receivedNotification = true;
+      this.data = data;
+      // Now fill the form
+      pwmgr.fillForm(subject);
+    }
+  }
+};
+
+// Add the observer
+var os = Cc["@mozilla.org/observer-service;1"].
+         getService(Ci.nsIObserverService);
+os.addObserver(TestObserver, "passwordmgr-found-form", false);
+
+function startTest(){
+  netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
+  // Test that observer is notified & got correct data
+  is(TestObserver.receivedNotification, true, "Checking observer was notified");
+  is(TestObserver.data, "noAutofillForms", "Checking observer got correct data");
+
+  // Check that form1 was filled
+  is($_(1, "uname").value, "testuser", "Checking for filled username");
+  is($_(1, "pword").value, "testpass", "Checking for filled password");
+
+  // Reset pref (since we assumed it was true to start)
+  prefs.setBoolPref("autofillForms", true);
+
+  // Remove the observer
+  os.removeObserver(TestObserver, "passwordmgr-found-form");
+
+  SimpleTest.finish();
+}
+
+window.onload = startTest;
+
+SimpleTest.waitForExplicitFinish();
+</script>
+</pre>
+</body>
+</html>
diff --git a/toolkit/components/places/public/nsIFaviconService.idl b/toolkit/components/places/public/nsIFaviconService.idl
--- a/toolkit/components/places/public/nsIFaviconService.idl
+++ b/toolkit/components/places/public/nsIFaviconService.idl
@@ -35,17 +35,17 @@
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 #include "nsISupports.idl"
 
 interface nsIURI;
 
-[scriptable, uuid(91f635a4-2531-4f3d-89ef-81403a685f44)]
+[scriptable, uuid(fafe10e0-194f-4e89-aab9-a5849e97287c)]
 interface nsIFaviconService : nsISupports
 {
   /**
    * Declares that a given page uses a favicon with the given URI.
    *
    * You needn't have specified any data at this point. An entry linking the
    * favicon with the page will be create with no data. You can populate it
    * later with SetFaviconData.  However, any favicons not associated with a
@@ -144,16 +144,34 @@ interface nsIFaviconService : nsISupport
    *        Until this time, we won't try to load it again.
    */
   void setFaviconData(in nsIURI aFaviconURI,
                       [const,array,size_is(aDataLen)] in octet aData,
                       in unsigned long aDataLen, in AUTF8String aMimeType,
                       in PRTime aExpiration);
 
   /**
+   * Stores the data of a given favicon. The data is provided by a string
+   * containing a data URL.
+   *
+   * @see setFaviconData
+   *
+   * @param aFaviconURI
+   *        URI of the favicon whose data is being set.
+   * @param aDataURL
+   *        string containing a data URL that represents the contents of
+   *        the favicon to save
+   * @param aExpiration
+   *        Time in microseconds since the epoch when this favicon expires.
+   *        Until this time, we won't try to load it again.
+   */
+  void setFaviconDataFromDataURL(in nsIURI aFaviconURI, in AString aDataURL,
+                                 in PRTime aExpiration);
+
+  /**
    * Retrieves the given favicon data. Throws if we don't have data.
    *
    * If there is no data but we have an entry for this favicon, aDataLen will
    * be 0 and aData will be NULL.
    *
    * @param aFaviconURI
    *        URI of the favicon whose data is being read
    * @param aData
@@ -166,16 +184,34 @@ interface nsIFaviconService : nsISupport
    *        Output parameter where the MIME type will be placed.
    * @throws NS_ERROR_NOT_AVAILABLE
    *         Thrown when we have never heard of this favicon URI.
    */
   void getFaviconData(in nsIURI aFaviconURI,
                       out AUTF8String aMimeType,
                       out unsigned long aDataLen,
                       [array,retval,size_is(aDataLen)] out octet aData);
+
+  /**
+   * Retrieves the given favicon data as a data URL. Throws if we don't
+   * have data.
+   *
+   * If there is no data but we have an entry for this favicon, the return
+   * value will be NULL.
+   * 
+   * @see getFaviconData
+   *
+   * @param aFaviconURI
+   *        URI of the favicon whose data is being read
+   * @returns A data URL containing the data of the favicon. This will be
+   *          null if we have this URL but have no data associated with it.
+   * @throws NS_ERROR_NOT_AVAILABLE
+   *         Thrown when we have never heard of this favicon URL.
+   */
+  AString getFaviconDataAsDataURL(in nsIURI aFaviconURI);
 
   /**
    * Retrieves the URI of the favicon for the given page.
    *
    * @param aPageURI
    *        URI of the page whose favicon is desired
    * @returns The URI of the favicon associated with that page. Returning a
    *          URI here does NOT mean that we have data for this favicon, only
diff --git a/toolkit/components/places/public/nsINavBookmarksService.idl b/toolkit/components/places/public/nsINavBookmarksService.idl
--- a/toolkit/components/places/public/nsINavBookmarksService.idl
+++ b/toolkit/components/places/public/nsINavBookmarksService.idl
@@ -557,19 +557,21 @@ interface nsINavBookmarksService : nsISu
   void addObserver(in nsINavBookmarkObserver observer, in boolean ownsWeak);
 
   /**
    * Removes a bookmark observer.
    */
   void removeObserver(in nsINavBookmarkObserver observer);
 
   /**
-   * Runs the passed callback in batch mode. Use this when a lot of things
-   * are about to change. Calls can be nested, observers will only be
-   * notified when all batches begin/end.
+   * Runs the passed callback inside of a database transaction.
+   * Use this when a lot of things are about to change, for example
+   * adding or deleting a large number of bookmark items. Calls can
+   * be nested. Observers are notified when batches begin and end, via 
+   * nsINavBookmarkObserver.onBeginUpdateBatch/onEndUpdateBatch.
    *
    * @param aCallback
    *        nsINavHistoryBatchCallback interface to call.
    * @param aUserData
    *        Opaque parameter passed to nsINavBookmarksBatchCallback
    */
   void runInBatchMode(in nsINavHistoryBatchCallback aCallback,
                       in nsISupports aUserData);
diff --git a/toolkit/components/places/src/nsFaviconService.cpp b/toolkit/components/places/src/nsFaviconService.cpp
--- a/toolkit/components/places/src/nsFaviconService.cpp
+++ b/toolkit/components/places/src/nsFaviconService.cpp
@@ -57,16 +57,17 @@
 #include "nsISupportsPrimitives.h"
 #include "nsNavBookmarks.h"
 #include "nsNavHistory.h"
 #include "nsNetUtil.h"
 #include "nsReadableUtils.h"
 #include "nsStreamUtils.h"
 #include "nsStringStream.h"
 #include "mozStorageHelper.h"
+#include "plbase64.h"
 
 // For favicon optimization
 #include "imgITools.h"
 #include "imgIContainer.h"
 
 #define FAVICON_BUFFER_INCREMENT 8192
 
 #define MAX_FAVICON_CACHE_SIZE 512
@@ -631,16 +632,76 @@ nsFaviconService::SetFaviconData(nsIURI*
   rv = statement->BindUTF8StringParameter(2, *mimeType);
   NS_ENSURE_SUCCESS(rv, rv);
   rv = statement->BindInt64Parameter(3, aExpiration);
   NS_ENSURE_SUCCESS(rv, rv);
   return statement->Execute();
 }
 
 
+// nsFaviconService::SetFaviconDataFromDataURL
+
+NS_IMETHODIMP
+nsFaviconService::SetFaviconDataFromDataURL(nsIURI* aFaviconURI,
+                                            const nsAString& aDataURL,
+                                            PRTime aExpiration)
+{
+  nsresult rv;
+
+  nsCOMPtr<nsIURI> dataURI;
+  rv = NS_NewURI(getter_AddRefs(dataURI), aDataURL);
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  // use the data: protocol handler to convert the data
+  nsCOMPtr<nsIIOService> ioService = do_GetIOService(&rv);
+  NS_ENSURE_SUCCESS(rv, rv);
+  nsCOMPtr<nsIProtocolHandler> protocolHandler;
+  rv = ioService->GetProtocolHandler("data", getter_AddRefs(protocolHandler));
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  nsCOMPtr<nsIChannel> channel;
+  rv = protocolHandler->NewChannel(dataURI, getter_AddRefs(channel));
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  // blocking stream is OK for data URIs
+  nsCOMPtr<nsIInputStream> stream;
+  rv = channel->Open(getter_AddRefs(stream));
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  PRUint32 available;
+  rv = stream->Available(&available);
+  NS_ENSURE_SUCCESS(rv, rv);
+  if (available == 0)
+    return NS_ERROR_FAILURE;
+
+  // read all the decoded data
+  PRUint8* buffer = static_cast<PRUint8*>
+                               (nsMemory::Alloc(sizeof(PRUint8) * available));
+  if (!buffer)
+    return NS_ERROR_OUT_OF_MEMORY;
+  PRUint32 numRead;
+  rv = stream->Read(reinterpret_cast<char*>(buffer), available, &numRead);
+  if (NS_FAILED(rv) || numRead != available) {
+    nsMemory::Free(buffer);
+    return rv;
+  }
+
+  nsCAutoString mimeType;
+  rv = channel->GetContentType(mimeType);
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  // SetFaviconData can now do the dirty work 
+  rv = SetFaviconData(aFaviconURI, buffer, available, mimeType, aExpiration);
+  nsMemory::Free(buffer);
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  return NS_OK;
+}
+
+
 // nsFaviconService::GetFaviconData
 
 NS_IMETHODIMP
 nsFaviconService::GetFaviconData(nsIURI* aFaviconURI, nsACString& aMimeType,
                                  PRUint32* aDataLen, PRUint8** aData)
 {
   mozStorageStatementScoper scoper(mDBGetData);
   nsresult rv = BindStatementURI(mDBGetData, 0, aFaviconURI);
@@ -649,16 +710,53 @@ nsFaviconService::GetFaviconData(nsIURI*
   PRBool hasResult = PR_FALSE;
   if (NS_SUCCEEDED(mDBGetData->ExecuteStep(&hasResult)) && hasResult) {
     rv = mDBGetData->GetUTF8String(1, aMimeType);
     NS_ENSURE_SUCCESS(rv, rv);
 
     return mDBGetData->GetBlob(0, aDataLen, aData);
   }
   return NS_ERROR_NOT_AVAILABLE;
+}
+
+
+// nsFaviconService::GetFaviconDataAsDataURL
+
+NS_IMETHODIMP
+nsFaviconService::GetFaviconDataAsDataURL(nsIURI* aFaviconURI,
+                                          nsAString& aDataURL)
+{
+  nsresult rv;
+
+  PRUint8* data;
+  PRUint32 dataLen;
+  nsCAutoString mimeType;
+
+  rv = GetFaviconData(aFaviconURI, mimeType, &dataLen, &data);
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  if (!data) {
+    aDataURL.SetIsVoid(PR_TRUE);
+    return NS_OK;
+  }
+
+  char* encoded = PL_Base64Encode(reinterpret_cast<const char*>(data),
+                                  dataLen, nsnull);
+  nsMemory::Free(data);
+
+  if (!encoded)
+    return NS_ERROR_OUT_OF_MEMORY;
+
+  aDataURL.AssignLiteral("data:");
+  AppendUTF8toUTF16(mimeType, aDataURL);
+  aDataURL.AppendLiteral(";base64,");
+  AppendUTF8toUTF16(encoded, aDataURL);
+
+  nsMemory::Free(encoded);
+  return NS_OK;
 }
 
 
 // nsFaviconService::GetFaviconForPage
 
 NS_IMETHODIMP
 nsFaviconService::GetFaviconForPage(nsIURI* aPageURI, nsIURI** _retval)
 {
diff --git a/toolkit/components/places/src/nsNavHistoryResult.cpp b/toolkit/components/places/src/nsNavHistoryResult.cpp
--- a/toolkit/components/places/src/nsNavHistoryResult.cpp
+++ b/toolkit/components/places/src/nsNavHistoryResult.cpp
@@ -2877,25 +2877,28 @@ nsNavHistoryQueryResultNode::OnItemRemov
   return NS_OK;
 }
 NS_IMETHODIMP
 nsNavHistoryQueryResultNode::OnItemChanged(PRInt64 aItemId,
                                            const nsACString& aProperty,
                                            PRBool aIsAnnotationProperty,
                                            const nsACString& aValue)
 {
-  // history observers should not get OnItemChanged
-  // but should get the corresponding history notifications instead
-  // for bookmark queries, "all bookmark" observers should get OnItemChanged
-  // for example, when a title of a bookmark change, we want that to refresh
-  if (mLiveUpdate == QUERYUPDATE_COMPLEX_WITH_BOOKMARKS)
-    return Refresh();
+  // History observers should not get OnItemChanged
+  // but should get the corresponding history notifications instead.
+  // For bookmark queries, "all bookmark" observers should get OnItemChanged.
+  // For example, when a title of a bookmark changes, we want that to refresh.
+  if (mLiveUpdate == QUERYUPDATE_COMPLEX_WITH_BOOKMARKS)
+    (void)Refresh();
   else
     NS_WARNING("history observers should not get OnItemChanged, but should get the corresponding history notifications instead");
-  return NS_OK;
+
+  return nsNavHistoryResultNode::OnItemChanged(aItemId, aProperty,
+                                               aIsAnnotationProperty,
+                                               aValue);
 }
 
 NS_IMETHODIMP
 nsNavHistoryQueryResultNode::OnItemVisited(PRInt64 aItemId,
                                            PRInt64 aVisitId, PRTime aTime)
 {
   // for bookmark queries, "all bookmark" observer should get OnItemVisited
   // but it is ignored.
diff --git a/toolkit/components/places/src/utils.js b/toolkit/components/places/src/utils.js
--- a/toolkit/components/places/src/utils.js
+++ b/toolkit/components/places/src/utils.js
@@ -761,28 +761,16 @@ var PlacesUtils = {
       }
       else {
         annosvc.setItemAnnotation(aItemId, anno.name, anno.value, flags,
                                   expires);
       }
     });
   },
 
-  /**
-   * Helper for getting a serialized Places query for a particular folder.
-   * @param aFolderId The folder id to get a query for.
-   * @return string serialized place URI
-   */
-  getQueryStringForFolder: function PU_getQueryStringForFolder(aFolderId) {
-    var options = this.history.getNewQueryOptions();
-    var query = this.history.getNewQuery();
-    query.setFolders([aFolderId], 1);
-    return this.history.queriesToQueryString([query], 1, options);
-  },
-
   // identifier getters for special folders
   get placesRootId() {
     delete this.placesRootId;
     return this.placesRootId = this.bookmarks.placesRoot;
   },
 
   get bookmarksMenuFolderId() {
     delete this.bookmarksMenuFolderId;
@@ -1327,17 +1315,17 @@ var PlacesUtils = {
             // XXX causes JSON encoding errors, so utf-8 encode
             //anno.value = unescape(encodeURIComponent(anno.value));
             if (anno.name == LMANNO_FEEDURI)
               aJSNode.livemark = 1;
             if (anno.name == READ_ONLY_ANNO && aResolveShortcuts) {
               // When copying a read-only node, remove the read-only annotation.
               return false;
             }
-            return anno.name != "placesInternal/GUID";
+            return true;
           });
         } catch(ex) {
           LOG(ex);
         }
         if (annos.length != 0)
           aJSNode.annos = annos;
       }
       // XXXdietrich - store annos for non-bookmark items
diff --git a/toolkit/components/places/tests/bookmarks/test_restore_guids.js b/toolkit/components/places/tests/bookmarks/test_restore_guids.js
new file mode 100644
--- /dev/null
+++ b/toolkit/components/places/tests/bookmarks/test_restore_guids.js
@@ -0,0 +1,119 @@
+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim:set ts=2 sw=2 sts=2 et: */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Bug 384370 code.
+ *
+ * The Initial Developer of the Original Code is Mozilla Corp.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *  Dietrich Ayala <dietrich@mozilla.com> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+Components.utils.import("resource://gre/modules/utils.js");
+var tests = [];
+
+/*
+
+Backup/restore tests example:
+
+var myTest = {
+  populate: function () { ... add bookmarks ... },
+  validate: function () { ... query for your bookmarks ... }
+}
+
+this.push(myTest);
+
+*/
+
+const DEFAULT_INDEX = PlacesUtils.bookmarks.DEFAULT_INDEX;
+
+var test = {
+  _testBookmarkId: null,
+  _testBookmarkGUID: null, 
+
+  populate: function populate() {
+    var bookmarkURI = uri("http://bookmark");
+    this._testBookmarkId =
+      PlacesUtils.bookmarks.insertBookmark(PlacesUtils.toolbarFolderId, bookmarkURI,
+                                           DEFAULT_INDEX, "bookmark");
+    this._testBookmarkGUID = PlacesUtils.bookmarks.getItemGUID(this._testBookmarkId);
+  },
+
+  clean: function () {},
+
+  validate: function validate() {
+    var guid = PlacesUtils.bookmarks.getItemGUID(this._testBookmarkId);
+    do_check_eq(this._testBookmarkGUID, guid);
+  }
+}
+tests.push(test);
+
+function run_test() {
+  do_check_eq(typeof PlacesUtils, "object");
+
+  // make json file
+  var jsonFile = dirSvc.get("ProfD", Ci.nsILocalFile);
+  jsonFile.append("bookmarks.json");
+  if (jsonFile.exists())
+    jsonFile.remove(false);
+  jsonFile.create(Ci.nsILocalFile.NORMAL_FILE_TYPE, 0600);
+  if (!jsonFile.exists())
+    do_throw("couldn't create file: bookmarks.exported.json");
+
+  // populate db
+  tests.forEach(function(aTest) {
+    aTest.populate();
+    // sanity
+    aTest.validate();
+  });
+
+  // export json to file
+  try {
+    PlacesUtils.backupBookmarksToFile(jsonFile);
+  } catch(ex) { do_throw("couldn't export to file: " + ex); }
+
+  // clean
+  tests.forEach(function(aTest) {
+    aTest.clean();
+  });
+
+  // restore json file
+  try {
+    PlacesUtils.restoreBookmarksFromJSONFile(jsonFile);
+  } catch(ex) { do_throw("couldn't import the exported file: " + ex); }
+
+  // validate
+  tests.forEach(function(aTest) {
+    aTest.validate();
+  });
+
+  // clean up
+  jsonFile.remove(false);
+}
diff --git a/toolkit/components/places/tests/unit/test_favicons.js b/toolkit/components/places/tests/unit/test_favicons.js
--- a/toolkit/components/places/tests/unit/test_favicons.js
+++ b/toolkit/components/places/tests/unit/test_favicons.js
@@ -66,16 +66,19 @@ function readFileData(aFile) {
  * and array of bytes and mimetype.
  */
 function setAndGetFaviconData(aFilename, aData, aMimeType) {
   var iconURI = uri("http://places.test/" + aFilename);
 
   iconsvc.setFaviconData(iconURI,
                          aData, aData.length, aMimeType,
                          Number.MAX_VALUE);
+
+  var dataURL = iconsvc.getFaviconDataAsDataURL(iconURI);
+  iconsvc.setFaviconDataFromDataURL(iconURI, dataURL, Number.MAX_VALUE);
 
   var mimeTypeOutparam = {};
 
   var outData = iconsvc.getFaviconData(iconURI,
                          mimeTypeOutparam, {});
 
   return [outData, mimeTypeOutparam.value];
 }
diff --git a/toolkit/content/charsetOverlay.js b/toolkit/content/charsetOverlay.js
--- a/toolkit/content/charsetOverlay.js
+++ b/toolkit/content/charsetOverlay.js
@@ -113,31 +113,29 @@ function SetForcedCharset(charset)
 function SetForcedCharset(charset)
 {
     BrowserSetForcedCharacterSet(charset);
 }
 
 var gPrevCharset = null;
 function UpdateCurrentCharset()
 {
-    var menuitem = null;
-
-    // exctract the charset from DOM
+    // extract the charset from DOM
     var wnd = document.commandDispatcher.focusedWindow;
     if ((window == wnd) || (wnd == null)) wnd = window.content;
-    menuitem = document.getElementById('charset.' + wnd.document.characterSet);
 
+    // Uncheck previous item
+    if (gPrevCharset) {
+        var pref_item = document.getElementById('charset.' + gPrevCharset);
+        if (pref_item)
+          pref_item.setAttribute('checked', 'false');
+    }
+
+    var menuitem = document.getElementById('charset.' + wnd.document.characterSet);
     if (menuitem) {
-        // uncheck previously checked item to workaround Mac checkmark problem
-        // bug 98625
-        if (gPrevCharset) {
-            var pref_item = document.getElementById('charset.' + gPrevCharset);
-            if (pref_item)
-              pref_item.setAttribute('checked', 'false');
-        }
         menuitem.setAttribute('checked', 'true');
     }
 }
 
 function UpdateCurrentMailCharset()
 {
     var charset = msgWindow.mailCharacterSet;
     var menuitem = document.getElementById('charset.' + charset);
diff --git a/toolkit/content/tests/chrome/bug331215_window.xul b/toolkit/content/tests/chrome/bug331215_window.xul
--- a/toolkit/content/tests/chrome/bug331215_window.xul
+++ b/toolkit/content/tests/chrome/bug331215_window.xul
@@ -64,17 +64,21 @@
 
     function onLoad() {
       var _delayedOnLoad = function() {
         gFindBar = document.getElementById("FindToolbar");
         gBrowser = document.getElementById("content");
         gBrowser.addEventListener("pageshow", onPageShow, false);
         gBrowser.loadURI("data:text/plain,latest");
       }
-      setTimeout(_delayedOnLoad, 1000);
+      let tm = Cc["@mozilla.org/thread-manager;1"].
+               getService(Ci.nsIThreadManager);
+      tm.mainThread.dispatch({
+        run: function() _delayedOnLoad()
+      }, Ci.nsIThread.DISPATCH_NORMAL);
     }
 
     function onPageShow() {
       document.getElementById("cmd_find").doCommand();
       enterStringIntoFindField("test");
       document.commandDispatcher
               .getControllerForCommand("cmd_moveTop")
               .doCommand("cmd_moveTop");
diff --git a/toolkit/content/widgets/general.xml b/toolkit/content/widgets/general.xml
--- a/toolkit/content/widgets/general.xml
+++ b/toolkit/content/widgets/general.xml
@@ -14,17 +14,17 @@
                                 onget="return this.getAttribute('disabled') == 'true';"/>
       <property name="tabIndex" onget="return parseInt(this.getAttribute('tabindex')) || 0"
                                 onset="if (val) this.setAttribute('tabindex', val);
                                        else this.removeAttribute('tabindex'); return val;"/>
     </implementation>
   </binding>
 
   <binding id="basetext" extends="chrome://global/content/bindings/general.xml#basecontrol">
-    <implementation>
+    <implementation implements="nsIDOMXULLabeledControlElement">
       <!-- public implementation -->
       <property name="label"      onset="this.setAttribute('label',val); return val;"
                                   onget="return this.getAttribute('label');"/>
       <property name="crop"       onset="this.setAttribute('crop',val); return val;"
                                   onget="return this.getAttribute('crop');"/>
       <property name="image"      onset="this.setAttribute('image',val); return val;"
                                   onget="return this.getAttribute('image');"/>
       <property name="command"    onset="this.setAttribute('command',val); return val;"
diff --git a/toolkit/content/widgets/progressmeter.xml b/toolkit/content/widgets/progressmeter.xml
--- a/toolkit/content/widgets/progressmeter.xml
+++ b/toolkit/content/widgets/progressmeter.xml
@@ -58,38 +58,35 @@
            extends="chrome://global/content/bindings/progressmeter.xml#progressmeter">
     <content>
       <xul:stack class="progress-remainder" flex="1" anonid="stack" style="overflow: -moz-hidden-unscrollable;">
         <xul:spacer class="progress-bar" anonid="spacer" top="0" style="margin-right: -1000px;"/>
       </xul:stack>
     </content>
 
     <implementation>
+      <field name="_alive">true</field>
       <method name="_init">
         <body><![CDATA[
           var stack = document.getAnonymousElementByAttribute(this, "anonid", "stack");
           var spacer = document.getAnonymousElementByAttribute(this, "anonid", "spacer");
+          var self = this;
 
           var isLTR = 
            document.defaultView.getComputedStyle(this, null).direction == "ltr";
 
           var position = isLTR ? 4 : -1;
           var interval = setInterval(function nextStep() {
             try {
               var width = stack.boxObject.width;
               if (!width) {
                 // Maybe we've been removed from the document.
-                var currentNode = stack;
-                while (currentNode && currentNode != stack.ownerDocument) {
-                  currentNode = currentNode.parentNode;
-                }
-                if (!currentNode) {
+                if (!self._alive)
                   clearInterval(interval);
-                  return;
-                }
+                return;
               }
               width = width >> 2;
               spacer.height = stack.boxObject.height;
               spacer.width = width;
               spacer.left = width * position;
               if (isLTR) {
                 position += 15 / (width + 150);
                 if (position >= 4)
@@ -108,25 +105,38 @@
       </method>
 
       <constructor>this._init();</constructor>
     </implementation>
   </binding>
 
   <binding id="progressmeter-periodic-redraw"
            extends="chrome://global/content/bindings/progressmeter.xml#progressmeter">
+    <content>
+      <xul:spacer anonid="visibility-detector" flex="1"/>
+    </content>
     <implementation>
+      <field name="_alive">true</field>
       <method name="_init">
         <body><![CDATA[
           var step = 0;
           var self = this;
+          var spacer = document.getAnonymousElementByAttribute(this, "anonid", "visibility-detector");
           var interval = setInterval(function nextStep() {
             try {
+              // Only bother redrawing when we're visible
+              var width = spacer.boxObject.width;
+              if (!width) {
+                // Maybe we've been removed from the document.
+                if (!self._alive)
+                  clearInterval(interval);
+                return;
+              }
               // Trigger redraw by changing the step attribute
-              step = (step + 1) % 2;
+              step = 1 - step;
               self.setAttribute('step', step);
             } catch (e) {
               clearInterval(interval);
             }
           }, 1000/30);
         ]]></body>
       </method>
       <constructor>this._init();</constructor>
diff --git a/toolkit/content/widgets/radio.xml b/toolkit/content/widgets/radio.xml
--- a/toolkit/content/widgets/radio.xml
+++ b/toolkit/content/widgets/radio.xml
@@ -436,17 +436,17 @@
     <content>
       <xul:image class="radio-check" xbl:inherits="disabled,selected"/>
       <xul:hbox class="radio-label-box" align="center" flex="1">
         <xul:image class="radio-icon" xbl:inherits="src"/>
         <xul:label class="radio-label" xbl:inherits="xbl:text=label,accesskey,crop" flex="1"/>
       </xul:hbox>
     </content>
 
-    <implementation implements="nsIDOMXULSelectControlItemElement, nsIDOMXULLabeledControlElement, nsIAccessibleProvider">
+    <implementation implements="nsIDOMXULSelectControlItemElement, nsIAccessibleProvider">
       <constructor>
         <![CDATA[
           // Just clear out the parent's cached list of radio children
           var control = this.control;
           if (control)
             control._radioChildren = null;
         ]]>
       </constructor>
diff --git a/toolkit/crashreporter/client/crashreporter_osx.h b/toolkit/crashreporter/client/crashreporter_osx.h
--- a/toolkit/crashreporter/client/crashreporter_osx.h
+++ b/toolkit/crashreporter/client/crashreporter_osx.h
@@ -119,17 +119,17 @@
 
 @end
 
 /*
  * Subclass NSTextView to provide a text view with placeholder text.
  * Also provide a setEnabled implementation.
  */
 @interface TextViewWithPlaceHolder : NSTextView {
-  NSAttributedString *mPlaceHolderString;
+  NSMutableAttributedString *mPlaceHolderString;
 }
 
 - (BOOL)becomeFirstResponder;
 - (void)drawRect:(NSRect)rect;
 - (BOOL)resignFirstResponder;  
 - (void)setPlaceholder:(NSString*)placeholder;
 - (void)insertTab:(id)sender;
 - (void)insertBacktab:(id)sender;
diff --git a/toolkit/crashreporter/client/crashreporter_osx.mm b/toolkit/crashreporter/client/crashreporter_osx.mm
--- a/toolkit/crashreporter/client/crashreporter_osx.mm
+++ b/toolkit/crashreporter/client/crashreporter_osx.mm
@@ -55,16 +55,17 @@ static NSAutoreleasePool* gMainPool;
 static NSAutoreleasePool* gMainPool;
 static CrashReporterUI* gUI = 0;
 static string gDumpFile;
 static StringTable gQueryParameters;
 static string gURLParameter;
 static string gSendURL;
 static vector<string> gRestartArgs;
 static bool gDidTrySend = false;
+static bool gRTLlayout = false;
 
 #define NSSTR(s) [NSString stringWithUTF8String:(s).c_str()]
 
 static NSString* Str(const char* aName)
 {
   string str = gStrings[aName];
   if (str.empty()) str = "?";
   return NSSTR(str);
@@ -113,24 +114,35 @@ static bool RestartApplication()
 {
   gDumpFile = dumpfile;
   gQueryParameters = queryParameters;
   gSendURL = sendURL;
 
   [mWindow setTitle:Str(ST_CRASHREPORTERTITLE)];
   [mHeaderLabel setStringValue:Str(ST_CRASHREPORTERHEADER)];
 
+  NSRect viewReportFrame = [mViewReportButton frame];
   [mViewReportButton setTitle:Str(ST_VIEWREPORT)];
   [mViewReportButton sizeToFit];
+  if (gRTLlayout) {
+    // sizeToFit will keep the left side fixed, so realign
+    float oldWidth = viewReportFrame.size.width;
+    viewReportFrame = [mViewReportButton frame];
+    viewReportFrame.origin.x += oldWidth - viewReportFrame.size.width;
+    [mViewReportButton setFrame: viewReportFrame];
+  }
+
   [mSubmitReportButton setTitle:Str(ST_CHECKSUBMIT)];
   [mIncludeURLButton setTitle:Str(ST_CHECKURL)];
   [mEmailMeButton setTitle:Str(ST_CHECKEMAIL)];
   [mViewReportOkButton setTitle:Str(ST_OK)];
 
   [mCommentText setPlaceholder:Str(ST_COMMENTGRAYTEXT)];
+  if (gRTLlayout)
+    [mCommentText toggleBaseWritingDirection:self];
   [[mEmailText cell] setPlaceholderString:Str(ST_EMAILGRAYTEXT)];
 
   if (gQueryParameters.find("URL") != gQueryParameters.end()) {
     // save the URL value in case the checkbox gets unchecked
     gURLParameter = gQueryParameters["URL"];
   }
   else {
     // no URL specified, hide checkbox
@@ -334,33 +346,46 @@ static bool RestartApplication()
   NSRect restartFrame = [mRestartButton frame];
   NSRect closeFrame = [mCloseButton frame];
   // resize close button to fit text
   float oldCloseWidth = closeFrame.size.width;
   [mCloseButton setTitle:Str(ST_QUIT)];
   [mCloseButton sizeToFit];
   closeFrame = [mCloseButton frame];
   // move close button left if it grew
-  closeFrame.origin.x -= closeFrame.size.width - oldCloseWidth;
+  if (!gRTLlayout) {
+    closeFrame.origin.x -= closeFrame.size.width - oldCloseWidth;
+  }
 
   if (gRestartArgs.size() == 0) {
     [mRestartButton removeFromSuperview];
-    closeFrame.origin.x = restartFrame.origin.x +
-      (restartFrame.size.width - closeFrame.size.width);
+    if (!gRTLlayout) {
+      closeFrame.origin.x = restartFrame.origin.x +
+        (restartFrame.size.width - closeFrame.size.width);
+    }
+    else {
+      closeFrame.origin.x = restartFrame.origin.x;
+    }
     [mCloseButton setFrame: closeFrame];
     [mCloseButton setKeyEquivalent:@"\r"];
   } else {
     [mRestartButton setTitle:Str(ST_RESTART)];
     // resize "restart" button
     float oldRestartWidth = restartFrame.size.width;
     [mRestartButton sizeToFit];
     restartFrame = [mRestartButton frame];
-    // move left by the amount that the button grew
-    restartFrame.origin.x -= restartFrame.size.width - oldRestartWidth;
-    closeFrame.origin.x -= restartFrame.size.width - oldRestartWidth;
+    if (!gRTLlayout) {
+      // move left by the amount that the button grew
+      restartFrame.origin.x -= restartFrame.size.width - oldRestartWidth;
+      closeFrame.origin.x -= restartFrame.size.width - oldRestartWidth;
+    }
+    else {
+      // shift the close button right in RTL
+      closeFrame.origin.x += restartFrame.size.width - oldRestartWidth;
+    }
     [mRestartButton setFrame: restartFrame];
     [mCloseButton setFrame: closeFrame];
     // possibly resize window if both buttons no longer fit
     // leave 20 px from either side of the window, and 12 px
     // between the buttons
     float neededWidth = closeFrame.size.width + restartFrame.size.width +
                         2*20 + 12;
     
@@ -373,19 +398,26 @@ static bool RestartApplication()
 
   NSButton *checkboxes[] = {
     mSubmitReportButton,
     mIncludeURLButton,
     mEmailMeButton
   };
 
   for (int i=0; i<3; i++) {
+    NSRect frame = [checkboxes[i] frame];
     [checkboxes[i] sizeToFit];
+    if (gRTLlayout) {
+      // sizeToFit will keep the left side fixed, so realign
+      float oldWidth = frame.size.width;
+      frame = [checkboxes[i] frame];
+      frame.origin.x += oldWidth - frame.size.width;
+      [checkboxes[i] setFrame: frame];
+    }
     // keep existing spacing on left side, + 20 px spare on right
-    NSRect frame = [checkboxes[i] frame];
     float neededWidth = frame.origin.x + frame.size.width + 20;
     if (neededWidth > windowFrame.size.width) {
       windowFrame.size.width = neededWidth;
       [mWindow setFrame:windowFrame display: true animate: NO];
     }
   }
 
   // do this down here because we may have made the window wider
@@ -647,33 +679,37 @@ static bool RestartApplication()
   return [super becomeFirstResponder];
 }
 
 - (void)drawRect:(NSRect)rect
 {
   [super drawRect:rect];
   if (mPlaceHolderString && [[self string] isEqualToString:@""] &&
       self != [[self window] firstResponder])
-    [mPlaceHolderString drawAtPoint:NSMakePoint(0,0)];
+    [mPlaceHolderString drawInRect:[self frame]];
 }
 
 - (BOOL)resignFirstResponder
 {
   [self setNeedsDisplay:YES];
   return [super resignFirstResponder];
 }
 
 - (void)setPlaceholder:(NSString*)placeholder
 {
 	NSColor* txtColor = [NSColor disabledControlTextColor];
   NSDictionary* txtDict = [NSDictionary
                            dictionaryWithObjectsAndKeys:txtColor,
                            NSForegroundColorAttributeName, nil];
-  mPlaceHolderString = [[NSAttributedString alloc]
+  mPlaceHolderString = [[NSMutableAttributedString alloc]
                        initWithString:placeholder attributes:txtDict];
+  if (gRTLlayout)
+    [mPlaceHolderString setAlignment:NSRightTextAlignment
+     range:NSMakeRange(0, [placeholder length])];
+  
 }
 
 - (void)insertTab:(id)sender
 {
   // don't actually want to insert tabs, just tab to next control
   [[self window] selectNextKeyView:sender];
 }
 
@@ -714,17 +750,23 @@ static bool RestartApplication()
 @end
 
 /* === Crashreporter UI Functions === */
 
 bool UIInit()
 {
   gMainPool = [[NSAutoreleasePool alloc] init];
   [NSApplication sharedApplication];
-  [NSBundle loadNibNamed:@"MainMenu" owner:NSApp];
+
+  if (gStrings.find("isRTL") != gStrings.end() &&
+      gStrings["isRTL"] == "yes")
+    gRTLlayout = true;
+
+  [NSBundle loadNibNamed:(gRTLlayout ? @"MainMenuRTL" : @"MainMenu")
+                   owner:NSApp];
 
   return true;
 }
 
 void UIShutdown()
 {
   [gMainPool release];
 }
diff --git a/toolkit/crashreporter/client/macbuild/Contents/Resources/English.lproj/MainMenuRTL.nib/classes.nib b/toolkit/crashreporter/client/macbuild/Contents/Resources/English.lproj/MainMenuRTL.nib/classes.nib
new file mode 100644
--- /dev/null
+++ b/toolkit/crashreporter/client/macbuild/Contents/Resources/English.lproj/MainMenuRTL.nib/classes.nib
@@ -0,0 +1,102 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
+<plist version="1.0">
+<dict>
+	<key>IBClasses</key>
+	<array>
+		<dict>
+			<key>ACTIONS</key>
+			<dict>
+				<key>closeClicked</key>
+				<string>id</string>
+				<key>emailMeClicked</key>
+				<string>id</string>
+				<key>includeURLClicked</key>
+				<string>id</string>
+				<key>restartClicked</key>
+				<string>id</string>
+				<key>submitReportClicked</key>
+				<string>id</string>
+				<key>viewReportClicked</key>
+				<string>id</string>
+				<key>viewReportOkClicked</key>
+				<string>id</string>
+			</dict>
+			<key>CLASS</key>
+			<string>CrashReporterUI</string>
+			<key>LANGUAGE</key>
+			<string>ObjC</string>
+			<key>OUTLETS</key>
+			<dict>
+				<key>mCloseButton</key>
+				<string>NSButton</string>
+				<key>mCommentScrollView</key>
+				<string>NSScrollView</string>
+				<key>mCommentText</key>
+				<string>TextViewWithPlaceHolder</string>
+				<key>mDescriptionLabel</key>
+				<string>NSTextField</string>
+				<key>mEmailMeButton</key>
+				<string>NSButton</string>
+				<key>mEmailText</key>
+				<string>NSTextField</string>
+				<key>mErrorCloseButton</key>
+				<string>NSButton</string>
+				<key>mErrorHeaderLabel</key>
+				<string>NSTextField</string>
+				<key>mErrorLabel</key>
+				<string>NSTextField</string>
+				<key>mErrorView</key>
+				<string>NSView</string>
+				<key>mHeaderLabel</key>
+				<string>NSTextField</string>
+				<key>mIncludeURLButton</key>
+				<string>NSButton</string>
+				<key>mProgressIndicator</key>
+				<string>NSProgressIndicator</string>
+				<key>mProgressText</key>
+				<string>NSTextField</string>
+				<key>mRestartButton</key>
+				<string>NSButton</string>
+				<key>mSubmitReportButton</key>
+				<string>NSButton</string>
+				<key>mViewReportButton</key>
+				<string>NSButton</string>
+				<key>mViewReportOkButton</key>
+				<string>NSButton</string>
+				<key>mViewReportTextView</key>
+				<string>NSTextView</string>
+				<key>mViewReportWindow</key>
+				<string>NSWindow</string>
+				<key>mWindow</key>
+				<string>NSWindow</string>
+			</dict>
+			<key>SUPERCLASS</key>
+			<string>NSObject</string>
+		</dict>
+		<dict>
+			<key>ACTIONS</key>
+			<dict>
+				<key>insertTab</key>
+				<string>id</string>
+			</dict>
+			<key>CLASS</key>
+			<string>TextViewWithPlaceHolder</string>
+			<key>LANGUAGE</key>
+			<string>ObjC</string>
+			<key>SUPERCLASS</key>
+			<string>NSTextView</string>
+		</dict>
+		<dict>
+			<key>CLASS</key>
+			<string>FirstResponder</string>
+			<key>LANGUAGE</key>
+			<string>ObjC</string>
+			<key>SUPERCLASS</key>
+			<string>NSObject</string>
+		</dict>
+	</array>
+	<key>IBVersion</key>
+	<string>1</string>
+</dict>
+</plist>
diff --git a/toolkit/crashreporter/client/macbuild/Contents/Resources/English.lproj/MainMenuRTL.nib/info.nib b/toolkit/crashreporter/client/macbuild/Contents/Resources/English.lproj/MainMenuRTL.nib/info.nib
new file mode 100644
--- /dev/null
+++ b/toolkit/crashreporter/client/macbuild/Contents/Resources/English.lproj/MainMenuRTL.nib/info.nib
@@ -0,0 +1,18 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
+<plist version="1.0">
+<dict>
+	<key>IBFramework Version</key>
+	<string>629</string>
+	<key>IBOldestOS</key>
+	<integer>5</integer>
+	<key>IBOpenObjects</key>
+	<array>
+		<integer>2</integer>
+	</array>
+	<key>IBSystem Version</key>
+	<string>9D34</string>
+	<key>targetFramework</key>
+	<string>IBCocoaFramework</string>
+</dict>
+</plist>
diff --git a/toolkit/crashreporter/client/macbuild/Contents/Resources/English.lproj/MainMenuRTL.nib/keyedobjects.nib b/toolkit/crashreporter/client/macbuild/Contents/Resources/English.lproj/MainMenuRTL.nib/keyedobjects.nib
new file mode 100644
index 0000000000000000000000000000000000000000..6c93849b94ff6db75660a631b6882f14a219b00e
GIT binary patch
literal 27032
zc%03=cYG7a(?7nucPe)_MzR4nY|9PYd#`elY>F*QvMI*k2wT_!+cK6+FSmr=LTDi*
z5HK~QP(nyZfiwaskkCR31VRd=Kte(YBmsWACpUrfyq@R#*N=QY*4^Ij?9A-!?0aVS
zZftXd#b%F-I|Cp<fB`I!04d-AKO$t3xy5F&HkF6it<57tOf5C_7E&}K#5#7oxyEjD
z2XOwTlRyUKqX*^3I0|b`c9Q_B6}?N1L(EgnwR!E0b}P|N-~wDhJV*xVKn)5&At(kz
z!DHYFumijZc7r|OWpDtz0$u}$z+vzXco!T6AAwWgGjI-k4!!^vz<1y(_!0aBeg?lm
z0D0g7U0^620Ha|HjEBiE1*XGnSOAB>p>Q}HK}xFNX!r;;!zpkoxCN)d*>Emg1D}G=
z!QJp}_zwISo`L7#Mfe@O2IJs$_y_8Te2^bfp<pxsg`+4GixN;WN<*0_2j!tcRD=ej
z5>$qaXc!uas!%l=i_EAVO+Za(BC?~&Xd0S{W}~@i0eTFrL@%R*=r!~vdK(=<AE4vt
z6Lb=NgML6iqF>NibQRr1|Db=-T?Q}`M#{LsqfBqcgXzb3GG2@?)1L`sf|w9yAd|o(
zGD%D-lgH#U1&o#{Wpqp>Gm5EVMl;pSBTNlb%UGBOrjeP!%wjMzhndIBXBIP$Gi#W&
z%oEI0OdGR>*~;u>b~AgJz05x50P`kuh&jx>#T;QiWWI#&F<&uPnSYtP%su8l3s}e^
zmSI^|!b({gD`z>DXI)rVwioNhdazz>f7YK3Vk6l^rXQQhX0f?!Av=T}%9gODtdXr^
zN3-MDI(7ov%uZw{v6I<p>`ZnR`zSk?UBo`lKFO|Ux3F8;?d%Trd3GOrkbRAPn|+7<
zko|}~#h!-w>{<46_6zoF_9FWo`#t*;`#bxG1W2GnDv?QCCA}p5B%YE0iAoYE86b&~
z#7fd6>5@E2zGR4GsH9Y4lsqCaNybXd61!xkWR_%}WWHp%<T1$;l68{xk~YZ}$u7xr
zl2;{%B=1PxmAof8A^C*Klbn-$4qTXO$rq9@C0|L-OTLj@mRylsm0Xitm;52QDY+y0
zTXJ8@N;#>U)I-`w>Miw=21tXY5z<I$lr&lzFHMuCOEaW7QjJtAEs_>XOQfYzqjZFH
zq;!n5T3Rc$NSmZqsa-llI#W7JI$JtdI#0S-`j~Wubd7Ya^eO4n(oNDG(w)+0rMslN
zrF*0=OW%;bDLo{8SNfjx1L=p-Po$qp&q%+Lo|j&bej~jq{Zaap^k?aB(i_r0rT<Fr
zO7BVU%UGF2)?4Nw^OSkXyk$NzKiL4;Kv|e9Miwhek)_JgWRqlq49n)o7RVOKmdcjN
z9s_Bzm9kZ`HrWfZ1G2;9*;}&rWuK7WPi1FiU(2q_ZpeO@{UgJ2K>p9kd3kTSLS8Cg
zCjVG|Tz*3SiTqRfN%<-HY55uXS@~!3bMnvSU&z0de<eRJzaalweo=l&{*C;y{9E~V
z^6%w8$gjw+%72vqB>!3di~O4Wy8Ku9Z}J=R-{pVEZ_59a-;)0&zb(Hb|6Bf#{9pN9
z`91l44seh|9K*4kgp+bS=f*ALUHM+T8{eB(@JimD_u%{ReffU8C-233^FF*U-=Fv6
z{rLc1#Ru|1d@vuvhw=mXfqWPr&PVW(d=wwe$MCUy93Rgo@QHj9pUkK5seBrr&S&tM
zd={V0=kU3_n$P3&`2xO>*YH}th%e>`@q_sx{7}AxFXeT78L#IJypb>GEBImjaDD_o
zlCR`P@m2h2ehgpDKf;^%v3w0*%bWRed>voUTln$(1ipc9<ePXa-^@?sTX-99=Ue$n
z{A7L#Kb4=xPv>XwGx=HkY+m3o?9b2PALZxr^Z5Dv0)8>Sj9*a^($w0}a8cn7dI2}k
z8z_JhxC0N+2lNH~fG6+*-oOX=g8sk{_=5nT0)Ze11cML|3I>3IAPj_q2oMRPKs1N}
zu^?_(snKAy+J}YIG?;9*(WOS6!_gB@ZWCR40WCM%hM5{#&7{P;)R<ROW475WV=WC9
z`&6B!w*47tTVQQ!B8|!VVH;IyEHyQnMLOhK+d^(8TU#cK?xaYcRFeJ(0eU&Qy}^HV
z)K1&lLThTRP4*H~lc~<!Qms&w8i!d(wFdKWOH-|NvV-q-IXcLB_P{sob|mT6JjG6K
zs~o&I8VCrZ9T>icQ7A^+1rEcjf)t|=j0Rx%BSu>VKxPxXg3&f5+K17=Q)D<2Kq5#Q
z)h-|vMvw>$eUJiDK^o~P#%6D^G}Q?#5h1UcEW$M=s;pBW17w0MkUhdN3T9iS<D!Ys
z*aEUa4#*W{DrvQwh?qu^%7{{9=Y>O92c0~S-v;tQ?ij*ItIck0bUY+_8kApPt+ARq
z$AYq^0a{Q*hM|2ew+Zr14l;wl;4NS<7y@#ux;i%7D@d<qyQ5_ZC>3VxR;YmvlmR_3
z03#>|6<`<`4n}~Hpc0G%RbVt21FFFzzy!vE8c++&U>v9e^}qtgg9)GkG=e5z1<hb0
zXaP202d!Wdm<*<XsbCtI4rYLvU>2AS1c1RD@F<uI=7ITO0ayqYfyH16SPGVb<pM8w
z3I0NekSXjIUKQRH-WJ{$J`z3_eid$F2r*<ZbivRYLthO2FpR`78N(46R$^F%;TQ}b
z!Eh{wH5k@nXvT0HhV>YZ$8Z9M%^2D-oQmOe3};|C3qt`zjNu#%=VG`B!zCCl#c(->
zD==J%;S(4>iQxtepTTf5hFdTscJw@kFJkx-hA(6I28M5+A^KYZ9tSJIDl$pefVIRR
z3e7gVrAaghI<(f-mKyW$QsYq5SaXBmDImc`==V8kw+=iB)`O?O(_jPG2%Z6(z-G_}
zwt%f*8`w@7lw0f#=4ypfL}QwXt(Hk8*4h%2Z9-*N3F)q+$=qmdveXQ<))33oH4SPc
zvxyG1Ws130ydkck#N5;>^c8x!6GsCCH}~21@81`C3m$^&8IhBn;90N>JO`c!FAQ_c
z-%*Z6gY4!;8-^can1<ok7@i+tthY{9<ux>vofc=xUa$|m1ojgnHJELptm1@m7Zie$
z2q7}yuz5nQpx#_Fq0vMwmYU|P;9wg#Nauv2!^S&^bSM6%NUe`pi&7CKGulmdvxCfA
z;O#c>Hps2)V!2w;ueGV(QfnrRcAKEK3`dLiz>zKB2zZ}%-IvH~8B4s9y~Wzl>72%N
zlsaxHJC0HQ0DMRW(OdBAX$X&#Aw1DOgeQr<eTDv_mVHi(m8p);fU}}H&tUl37*QW8
zW3#!Tfy{q>=9n5<&~cy9)$3Q_Jn1z+2=1xZi=@{}?Y(|WdJPnU#9mchz5W2Mh`oM-
z;ina4CY#-?pERtQ{$_NU@GsyRxDI|5GK54SR7n3E+#rvB2Y-N@;7@Q1`~_}<JK%5d
z5BL|{1^2*haagI-C4<&%ZK^f53~yf`hz%7G8Ho8$(l(gtsB_jdQO8qDiX6_J*q5=j
z+1xV8VxBAv5E6ueLbwtJaYC3d;2iB4LU0ozvEO@;g%T)*GIGUL(uQMcv(EL%Xqjdv
z?ViIhLkR(f1|bYXBe8+$)8o^kRPl-NGow_~6BE<Pb=u6C7oaO4-wV3I-cSLR&>ecf
zKCmzB2R)$|^agFv7xssK<Tn7Sz;ze|gJH-hhe)D0)d~;d_Z#fy7BbDv)O5^Ec2eqI
zYAiFiSgf^{nn9$jWs<3Z*in9~-EM6X8zzW0+}W~ga&*jRQv;z?DK5Yw&5@#(nyoE%
z$Er+ibQlp`Y}C<Lp}D~{wW=F`38S5Q^&pe|{#<wu2=RiO!droa7{N`55F&+8#W8o5
z1a$7jQTqGUiZDx4O+#y~S!J&`t4y`EEo7NhS;vXD&4g8zMK#$(N}7nxz=2>V41?h?
z0!G3pGT?L&$mos}yA+~>)e%7aCqyaPK2<|oYb>><q81Y|6LAj0SQys^<3R2(2MQo7
z5ln!IkgmI;UPLz%C&W@8I@w~csdqF>g=uXtjZR#T4k5+r4nOOtlL0fg!c3S&OqVWt
zj#^YZRTMl>M?h~Jb#q|uHkb?5Fb|Toc0@<*kzMMhsKiX|wbRUdoEcCHi#le8XwXSQ
zvS`g+b{Ow$hhMkbVM&jcSSnhgzS9=Vi7j4p*dm2k)|N(7gDAN>+di~HsyMJIWMC7k
z6)|=qqpHz5&C<|dQrWF4bEC;Z3d|~^&3f{ng^Xv@I7)|Vq?^NqqeO?BHmZrtZDN^J
ze222e!0Iiq+Tl0*h#pecN){=5r=RTROyF2p18a#h*(PKOFMbKf5n1bCJ+#2_Z~|<A
zjj#z?VKbZvTc8cvVJney5{Rtoa1gXta$~G%F`JtVg!<@?C*s0L255M>XltG2B3$ci
zZxFFk?~dDiQ_Te8Q^obvQDU@DZ7|dIbd+O+#pZ%qctLnx$Z-#$rkg8dD;NP(E4;`E
zrl&-y5>gyP7*B>UAt`<4%wY~%XS;c<NaC$#5^pt&K+ETZJYiQm$bwjy(FW(hu|mGE
z?JIBt&Z9;I=hJ53FSr0Mgo}tqmcXTO8C(t@gDc40O1KKHA`BK2Jy;tW%q_%1ZKBwe
z>yE<F4nN#JR--%p2fZT_Z5Fl)TNLg>0kJT0yFn-v3Oks3LYT3I^sy2yA*CCH&0jfe
z8$Jy;i1KWN&k*Jo623RXHn;_Dh1=kExC8DaB|ApYWxK^@Z6Tvk)9LC9tu?e`a+P0H
zU~RCr5P_c-)(KB4SV5!YfS?uTk|J#f3oi&WHp3l)R_q$?fqUUTsz~?}+)uiGnQ-?C
zd=(yquff;h8}Lnd2(AK=;?R~8p{b}QOOu)MP(DoLftpRdsl{AdXtJ9~afxY4yLT$F
zG?9x+3ep<Pb;Jb|p`Q?n6;k0*CFd>_32TJ4qzF__PmD{TD@Vf2v+!NQ)qC&=d><Z#
z$B5`3!jEWQ1!7;74lby`!>MJ}+UrHuhMJ~YTRUPK1r+88+F*6dC5KBKbe51j4o|>O
zh<KmElkgNgNJUaSAQH80T3{qoi_jsx4lQx`S1bs^U;$7%XF(49jL<m;KZjqyFU2X8
zXD1QG*jBsQ5kqy}4k8m?m@Nzyh6pnS&>qsjuLZVRiN*{iE}>CnX|}aCs%q)DscaUz
z%G{zdlR!(=K>V>iN>xKp6q#9OyQ#HBRYQD>h153HTAE4ZRzoJ3s@YuA8l|$CYY7dN
z+0trjwAQK!BqNI$@i$}@u++9T*;TES;#lg0%yvg_W)<;fO(vD8!7{Pc6r-vjeK%Ps
zaaE&*UQ8mlrp720StxC)CM$`-T5DD2Ddv_Mi(T|#DiTtg8f&Z$%Cr(;iuNRuv^0~-
zDzk}*&`5Z)Iz%B|*<)0Nl%$C$NM&hhC7d|Kw=}6*%*`$4dNcL<L<gi`lC`0=nPN}E
z4pj?TBF&;6I+R8PYE_MEt+SZyDjMUP$kN$DZdzMnRGKL@=4QLOm1>sgz*<vdG81H~
zs%dSu(CjN|L8NGIu@dCkM3il#nj)Rnv^F%GsN7^V9!Jz{Qq`Jm<`(+2kvIUthKVZ3
zLeybv*DGO1V^@(`(Arq5YHg}jHCU|^NMVCzf>~8WeCh<cCN!F(2&on`QRFxik%DM}
zQlMi#rP*9d2-jL@G*d%#L>6SydMtTHgr~Zzu@ELH71ER#sLD>rH(Sk3Dl)amC4nZ^
ziLF#QlPs;ZrjFVE4fTST;kQDGFqtem@Oz+vKfo*SCo+9vCXh&8nA8TZ!XJfFLDvR<
zhQA19LaR76%1mSuw3wRfMbCX2{z_W^25-RM;Uqc>O=HP4X{LTLufbB+)JT{U^nxSA
zg*V}!f^D}#1#iK>;B9yZ{tf?u|H8ZQ9=wkLf(Ri7u}FfXNQUHyLp*XpuBaDsL%op#
zDUmz!Kz&eO!61|i6~ZuKxG+K(DO3uhgeqaQFh-~r9uZ8!SfNI!70kjop-!k5EW&tU
zg3ur|3QdAlXci_4Erc87iM)_E;h02hqS*?@V9@?gTxO9k>feU?gWQph*-s?vXcj=~
zs)u&eb(96svMT4YP+DeoE(@b&4bEkev}~f_R2D<aTAk~~)3Pbf^^$1W4Ci{Ov~0F>
zy$o80oy)Rm*`sQwGBqum=S;7Fmd$_5sZ2}D7CO@#M9UUC(;G_5mO9hZ(XwUE^bEA@
zF=u)ev~0yDr?L^W>~ZIMqiEU6N1V#W(6Uv|yqIX&YL!!2EiGH)%wL^YcFC!1JS|)6
z%yT0xd%~H&W?Ht+nLisXd(xS|NwjReGk;TQ*;5_-Q5&3&X0)LhAeYR_yp|TzR7dG7
zc&!ay1G(J-0EA&AdXxhG5Qi)T@Vodrs?S67+t7Rwgcn*w;B9J|+BxabBDA#oWJk-;
za$$-vt$k*r6?A3`Q#+?HTK)fvDeNRWdIh~IL<`du3W6-V2RYIC)`nV#7G6hhY(Z~O
zWsd30z_sht4IM&<(OcB@iMwyJbc){IfQ5443WI<Q&Sl$&;~n(w7W6K959E&Sq(RXQ
ziB9N`qtg5E#8!9$9Yx0|K=<zItYi7FbtD?aNcF+OcK?h%qG;?@q1Zw41bn{@61?xY
z`xNeJgL^>k=Y;W7=rlTm&Z5uIIrKUD0ukVW&cmJPYw~-ECITFhvM0q_<4mm$c4zl3
zdh|hL0d5iFF}iY!*qq|@x)v*0vD(Y}&_rbeg&eirQH?u=buAN|3kk`gmZk|^MZ#)j
zq?zFG`2=w;Aipb!@uAD;Tl5{AgubUSGwsCKY!Xv+!|N>s5zfnxZ&&&ibhQm#73Y9h
zuY2R4NxeAGWy{ym4PwjaSM-~(P*~K4en)=@i-qL`prNaz(VyrR`VQTO2hkn$_o#My
zG{mJ~oeW@uwN4Cp=LyS%rNWY7#;G<jjpb`=mz^#I59p>lJNJcoL*imm9RJdRbGPT=
zL54wp6XNrQ$Al$B&)unZ&~gaE$Qc(R2*VLU9w&k@u1qgsr9fkl3W|an2rd;nW)!63
zql|k635<*Kg?ZXIRh+6_b4(wmZyVFMJxuJt$6c7bYI;&~5`ov|$hg#*mD3Xv63I<M
z>P$ytZ}{Fe_#Wfq2+4;z2oOpn1|!wP_)7%mX{j@35>^;L#-9mbRPZQSFN>{qW3$y>
z)e)GKPi-~}PYLUXPbd9FC%5+y44-a;Pq$k&6Uq$O$_#MyMsqI>mS)N>iSn5+G0wlq
zgoD4B2omwkVWOEBC}m>FRs0AFI$G+?_7NRvg^^-XriLPqeDdEWVWaSjkRP0T{oEDm
zgR2#NrxV^2+ogz4ZWp4ey4Kne$~iKWOfr+QjY;W9OH_(+u=xDT4zA$*cD~X&Im;pe
zii5XYMqMeYK->jsXQs`;%x?}iO}NTG=HQA%x6$!&aYRAnFXb#P)sdkP87Ac^ah*|b
zd>V;*9Xu8?nyrk+!C_Sghg5Utobn@oK`Xe!3}OZ|L%>~VB>`xHuwB@pgsz;Rb_^@E
zg#_9Kjj>70^*^TQ9ElNM#sF1JIa2{ua4ZaBMld7A^cEH(g=dAG<nK0jIgw6Ge$Ahw
zzHhKj(D$nB3f&ztjDdMu91?WMDvBDPlteDmQqwwQH8Eq`n6d4t>h?4QiD?>0AV3<D
z@WgI0HE1m@wytDow_FG_j;Ukng$!Yzut#{MeT#{iAV`G0Bt9!>G1=-3W}4+Qw^R)J
z(xE-3iLny>-C~-_7*7PZ85?6~TA4}AWN?p}O75puijl22!j)oZD_#;CY_@cS!G$fR
z$t5P@4W|eLgag9M!RnFiqpyy0Tqq?fAxt@uC(mCxNhZ@wVZTG-*^JP}2%_zk867kn
z_M4IxrAkf_wM0fMKBYrNk1}(&GIKkW=|P&cSnFsCaZpn&&A(G;?%w!NVP}$?S;#CB
zJcWb88$BesnWbI3Bg_h+ukgCyCMLOG>r8SptC-bdlKXQEzZ_$<n_BENwQizmpD{Li
z+i};GSZAJO){{OD32*h(=Z0=OGBmM%xV=x+Fq%HFn}^qmKi$Y}XLb;B?+8bFBDV`{
zW}fRt?p@(M2f6YBYx7inO+^j)=|*fn^D-fJRQRwbVy_Zn2fGnFCVb!^R_RzR=@yON
zROxW^<T}GSH8)4h^KT=5A-($sz;))B_#jj`E~H;n^roiBeB{W<FdsXzGT;_SaAanf
z<ID->6XsL0yqsiC!PlA7%o$>wpE2i{<20Q?Y(Upysk1bh8alU9M~OyRNBy!*_*A$q
zd?I`&{3x6hz7>8E!h{pTHBw4^l4oaD#bU27Yak1BF#%NOmJ98(<9t_!3fyw!sF(|I
zGjox-1h)`|F2n6amV0m~bAdTV)4Fuov|(5*JdNQH42KF&VmO$H879o7rN`ShQJJ3v
z`EG@h`I-5JxyD>)er0}RZZN+ye=s+hKbc$1U(9Xh4)Ztjk8nyjEu0a~3ZDt*gwKU9
zgfE4!g!94$;cMZda7p+^xJ)6Kc|^I&P_8XhiJL8Bt)`Y*m7T~g0vHGIDice~#X=vk
zK}#!f^bfc27ax`n(rQ(cl49Z>uHa3#y3DEy!_bGH1s7Ob%w?UW#6e7Qtd6R<DJg|1
z+7xYS3V|EL&0|S(8&$fPX0>(a?th|@nw*-DQjieW$wgVA_CGl+D=m8XnUCXHad}A(
z?Dr*r($Zk28|h9g#fv)8G}V}zZLQQB*Q&~_Hal61EX{V+r1+SGhiQ4X!>|8jp=?k=
zc@MmcU5&Fg*&luu;TUL3O}&cRtx7AV)oK3^4bw=n1Q8FKp7LO3kvYaHS$AQMa6DLT
zbA*7x_fCmIwlCX{CJF^CTory0DEb6BH1o&$kiyx*mClqN*e$T_fSy$mK+k+CeAfeL
zXG0vIoecw#Yy<_%SK7hyPvrOKPEg23vvED4+pY@9Y#Ocb8^Z~UgvZ;MUW}`-N?1A4
zf$fN};u^tbvpH>Sj^j)N^$5nvrsn4EOXVsMz~-|B;y(Fr!XG_&K2{4hvqc^I<izvc
z5Po-TWfO;^Z?)J};(Ds;SWxv7E6LwRx+Cwj*~ykMb*zE-x<7?I7=j-5bl3`Z7(1LD
z(YdE{U$`awrG$LfwoXDE#VZbUltNJqL35u|?1Ij=W0rpG7+A_yvyZSQb}U=Q*0R(E
zcH(Z~p76JDTeu_q>8?<#f$%Q@L^YKEK$U8&si}_sSgnnLPCIVs6?QxgI+b#-hvEyi
zNd)@Kgnxu3RW%*E+N7t4LIT#_9unN8A%UX3ZYO7s0h_{3-O5gNY^8Ok+_e^SLv804
z8athxv5lS4fmKI!t5eljY&H?6EuMYoz5wkYx}QUIucf+2WZ)X9t9J}phvV;N6r}b7
zb|EneQk%t)e*j>zi@_asDZ7ka4(_sxF_Z`i7)mjeDPbT-ZoBU%C$KAtt*>U+Kq<SH
zeS%#__|;6Yo15rqSpi_^iJ>coeK72cVLuV^bivbjirxR0_>@d(6}yprhWuRsgV;6)
zJ{2M{BrM74FG~Qb8dTIYSZ(HR^LDgYK%$Tu65Tpk>|&ya=Y$L@AW?)@#{_>-n6ZWE
zXAiqq)J`u9l@BS1*z(Kl0cy(*1>MKc4a444JEDx#kkgVyJEj=?f3o8@i5>5uc1&#-
zLxpgM^hpg@;Rsq)bURmcgFSI^gngeq+Kmf$3_X-k-pNROYDc({BnEl^6C*^md%H72
zbgC5ot(=~eNJU6UnAx$xkw?8DHPz49b6eSSogs_k%n3EN%0^8~i?zks?tWqFh&#GK
z>~xQSF!UKw+rDe$44LZKZ$-#N#-u-qts4h9cG1Z?>ex%}K7?1;s}x{iH~>Tc9?w`1
z9bIFuciTxON(#VG)$VjU#wyVfk&%^z$T{=N2UK*E{gWNT-XdzcO>9xcUS$bA_8xm*
z%(2j@z}A&aaDa6RvFb&L<$xt(;Iw+;y*%L_hCvR?^>=60A%KikAci5;3O_SF<)E5s
zZEb1aUG6wEP;YKAJ2@P<6CRYXqQfC@E0}s55BtL@jfb3+gm*Y83`2z_Bkdi|smC37
zi9({3xOeTqV>l4QFeMD>whf<>+&Pz1QvXkLS>h|{Pc(VOc`ip_7*2l)`92fr;zKvr
zt*v&I%}fHEraHZEx6zjbOF|r@ABSPof1I$9gi9j2pCiC98pD__5fbC*Hgu{u{K+Z*
zo09}y&L;^Z$wZhC$4P>&V*?n*QaPfk6>&}n2TWtBH1>LnO(m{NDw~y_2brp>F*T{i
zS*EBg_MXMal4MhV+$Balh6(Lrc+z=JO*c_A<M_1yn_HD=B}L?KFdYiX;Eth4!Z4Bk
z#yLX%?P_A|{fuU_YI42FKG3FWKipCq6BE<T+jbuwf(RrAIy@<KE)PHdz?p@Y=&1!s
zIcx&AVY6g7cuq1B+9jhTRj|Kgv}BB=dZZYIi>HwW2rpn*j$xX6^AviJ0K-%ahbd$j
zR$!Perd(1I$-0u5n&R+v^g5Y1yD`q_rJYkrt-zK$&S8i?Us5N`cwSP^mPtY+!QdKu
zRno*>Va7=&5_fa~!%X2%GL%FWLL!;87?SP>2>UQB6hcX?)1%XoOqNWMOzrM;vM|h6
zLZ5DvhfJ7+bVmX%m0Dr^fBI$#aae@CPT!nE2PRYaceKNX2#B|t>dZYG&LYWT=UJ@A
zFt5w|bz6;-<Nt4Fvr4j>{B3fc!37xR(_ad2i0=~92IDL(=5f|3-OQwCoo$e8bavDl
z47J@@P3_2(Bqq_Bn*QJV+D;go*rl%`%26R*RFg#S>QGyYXcWZ7koh^*tg^L^ZM4{F
z$TPX#+(g~5s$GEd51cN!)p5QA+?Kommr8a^_DJ?h_EEkiG>ShikmX1xY{gKoFkm=H
z2@w?n!x9pVf7)SluMwQV9GAQ-c|rJ;JR&VRp1egvjAO!a;?%n(Y3bsWl0dVFeZ<UK
zVv<wwS6%s4s?v^JCW+TCFwv4@P)Zfc#FD#Q$#G(~G)muuVJX$`Gvp>X_q$!YHi-#L
zLf?^`>`1FR(WjZxhv=WCxzY~$jJk_{Sv&bod>^0eaJGq*Zqm$|m0h#7a(Y6%n7U3U
zLi$Wkj3JmMEx{a_NJQ**Gjn*OBW2hf3G5-x<`Q)_y{NMpNr8h1L3&2al6q482U<Oo
zRv$&H7n*Him`i}`L)Du|^<QZ9Tv~nf7<#alTE>Hjgg|RJR`NTA*1|RntBEcrbs}-y
zgdR{RxJF3d77vLM%BC@m8oKhAm><GA%rWAcXfo+Ibwue-+_6_2>!9eE(w&k1l@6p&
z?2mT>V<bX$fH6YR$7x+<>ZI=Cx=P#8LtfqDiHAYhRZ`uHR`;jXEtL)tC}MSrQQ%mS
zeXX!fNbk(bNdu)p0*MhCFtqj%ok~N&X6b;gyc~v&7&f)1`3&Y-tG=?Lh5U4-`J}PZ
zI7)CLhPIvvCORiRF>L9`e2%8)9XeB-qY0F4emKJ^&5~wQ@~s$7>506W@SE3lWEsOr
z7*2K^TDAZqXa;7`K>o9UCQzpupwA#)(pGPsT+~Wjc$ulm?37q!7ZA-3rJ7}_W~X%;
zbpZ`&9vTR;cr`ifAc`8QlZk{7O2frRl+sKZA{s@1_aB4G93u@zQ){F3XIC{ASR3gP
zkOxMU!0&60F8zrCr#qP!LCK<diA$!FeN7~^8)>6L`t;G!omp&W>Z?G2v_)#8$qNkU
zVYsj-g-?=BmQLwPUtl=j9e4o}crI{cF-8?zYRxJg!B{OeeLe9)^ccH%>vWLaY0gNR
zq>no044F`iyB4w@rZ3TX89kOM>O4hw(TNVYCS5MN0s<SB5i(}S)P9%@t$SU%TC7VT
z#beb9cS~o~(^Kerg=lcS823;vA1A}pWf5Jrx>5QJwbfM^uI)*6ZA5ijy3eiE7_M>5
zEwbK<iAj~Isa92Dve(qB#BFB%FcO!F8Mr(fP0!H*>&_VQ{&mt9DPzTyv2}EdqTO=3
z_OqNv_$BFn#|W>-@adk|e1%LYrxAXtb8v|ni^J;-@+#;MJ16J~SMP`kdcxF3=lqCn
z!owbIFR6cwN};3;HjQ%3x`)y(HKf`JLN<%mYIAmzjuonFEKW&J)3G3!V0%wOe%5Vo
zMD!cm+TD^5SqYurYfzbNs*wboI5M{Wc57W-gLrD*($s2gwTacl7S4|AqVy7FU?+yp
z^~AupM9bfGH-=|1+~qI^64%@HQ_5>v?GH?oVCk=pX+q+!7sya|Ep;6>+tvLa(wnsV
z-5Bocsr$c3_qV%uPpIx~_wyA*llo~DB&fAMz(9zMaWFt8-+r>z+Pb;44i?VQ7BZ<!
zMqA0`GET<JTx727Rhb*?KT>>Gpv+{ir^jn8VvJd>=r5kdZoln3j6KZp3OI(ZV|W0=
z*DyRNy0%vdY?CQuN^n=)&2((b4{9PFqp8M>;VYb&E0Oh)_1z-tE9*xSe_o}=3Y)p5
z{UnF2{b+oHxuvS}oO}a)h0kXa-Ga<ei9fa&(SPJQasm}%88PJ^o;f=7mG$2u>)-vY
zoChWP+(|Y5?aB$1xq|Dm5Lu|G9-Rn?Y#mY`B2rTq^(Kagi5$-Sb@?nZ7al6>%x=pf
zWKqJT%`$??-`dQ$3M<7dN@;6DL$|C+Ps5f#IJ+iGhW$IZd6#lSoa;M8!X8vrVjkms
z+kWy%mO)QGWy&&TS%hj1a}0dTjFaUvPm)DzvGk&(3~ZNXv1PD^ECersHSAtlnRFu@
zD{Wz~$SRoqvf*%tG!V`qCRD|&U>C6YWD)#;#2b5<3(`NpNlCD*UQ#a`FO6jug6q&q
z7T@jQwyZ^Z3VbCaz~Kmn$3*szlhsv41Ie$1L)3~T;`B@rTnWAq{uHvr^=G}{Li`Yh
zBo19gG37iF$z2qVVt7)}667T0i)MIQc#YzO-^e=bO;%PhaY;b<Zox;KpO*>L#qbmX
zMgkc?K~0gsJ2WP_M4XZkfZ@3>i5X9Jo|pvWKSOjht^2EVvf1KWG-DgZci==(-f#C+
zgzuvxjPxa>8nbPT%~8j3lp~|ti*d5KvU#%k;@<KH7=DD|hwYJ}Oz7NZku4EsY$8i$
zH9fB6AV^<Eb6ECru(6GJjokK~f7#;#(cFo0O|7Nl4NTb@63`Q$6DS)ly-2kGm2@K+
z-TkuhvMM?PyG6ixlBk>LAb=|N5Y;Eq&S{4ts2XHjz<Sx%ZZC$l5jET;fA4nqsnMmz
zK{lhg+0;UJ-mB<cp~WV?m?iWT+&KC_(S`l5DL&M!rx5`s!I|z`>9Rwl85!j>9sB7R
zo*mJ#T68Gn9TIIyv%m+^Q`ESKg>3x~>dXpel@s+7ggP;;&%3C9F^o_*(^rTbv`+~$
z+L(pXSb;diiT_(!w>!z|+Cl4*Fk=Uqm}LYPw173Td^TU4Fc(C8FptiKuY}+JAN#1P
zcD!F~rl#~?%H0m0>k?nqBKw=rAcmdh5MP`x-*h+TyRv(-`=T*_hv5$xe*a&DzXd;Z
zCoGo}!bF*$bR+!jh!T^f$zkZCI^?cIwXzCXJ(=-j4v(s)XH>e?fH&ptqAw%!G7|)V
z0Oo?M9^58Ed`s`>Us(mQm)qo;mTqSk(`V2MM2|$Ce+%b`_qWMNw~9}1)B5C!mQ;zg
z$Q7}Q72r0kq1VJe29P?WEmh1B0a5fuT+L-+fZ$3T8o8%`sgv>{MMx}mr5hCVsha$y
zZiif|gnY4J0M)}eM}+~j4ZRc#PdloTYvDEW-v9!&#PSqE)rV5(&_Ws2LKZO`p7^UC
zJvyvm%cNN(R^AH&h%YC8oqF~E*{8F6NUS3IbmGy2d-CbBR^nSui6(kL^o9TF(+TT;
zig9Bug_Vf9a?!P45CQuC&a3wl9eamYzbrcT|McqTsAt>Sp`gb^1<6;)AD6F`uad8p
zuaU2nKOtYoOpvdaKP7)!zCpfG{)~K+e6zewzD2%OzD>SezC*rK{;YhL{5kpa@)zVU
z%6H56$oI<k$zPK1m%l7OAb&;vs{Ek*HTmoEH{@^156KV9-;%#Ae@FhV{5|;*`TO#t
zvb*vR<R8k3kN*k7pE3Le!)q8`$M9DSf5Y$whQAAYG5iC=n-~)H+`{lL3~yt22gAQH
z{0GB-F}#c6Jq+(-1TcaaA&eM|Sd1hXNimXPB*%!uh{wnUBUg-iVdREUZ;TWeDKT=#
z$OEH381==dA4Z-Sd12&@kq<_`81=`<4<mn!0x(k1IgA1^3c@Iuz)3pIRP_C4RanO&
z6i(J82f|Zzpf^$?R_v-Xs#|DTt?(6(Fwn?AMbCk#M3AF$9KRXmXh~PD@Txr9)TSC$
z9tkxj+eUUSD+E_}<HK=MDtu(;_F6~pj>iP46AnF`j=(u05rU8$eL2TUq_*P0pru+7
zL|+HD)Hn`bg!Qz69&T0i1tq`?nm{X1fkD7dt{cf!*uz;4Ksxa&YbCupA}v+e1Bqes
z+~29k2X{WhtLSN!fi{(Ha+COJ3nyyU34}mEH!buK6NW!9ob7MjhmY#ib98*QBCuPP
z9^+p^#`D3B9JvMZB*=-Yp0=+@C7<r2^&pG=oGh;6+*x-f6GnDg6H!CA>NFV^KH3pv
zi;tt@D;;NN=*fWxq;JOt;iKCPS6t1h;W$YkZk#`$+8$1XkQy0|2sPh2MHTjcdr$U3
zjW|WR<e}<+whKCF`A${-U-J7z!CiWDRx6D?!@Fj97h~NkiPN`Q5#pr1p0~<KHQ$FP
zSH})c_mNJlR(N+Gv+l{s2ejsVIFmd~>NXz#+n3P8$F#rY+HO77imd+{)&IpN<^vj{
zCo;pUx_990);cXv`QQvBWdr`xK)R<w!rNCmPA=HQ-II=cS9<@MaH8X0L07^VV3;fi
z2w*XR3JbwxFq|0&D!>#lAIzqZ0aSwVU=D!|vp_wlW6LB>U>O)i0Rxyp0RzCY;b0M1
zLcr644#)r|f)U^v4Ff4$kd3FGZ($Zvs35|Gu>_#$Xut`oz;aLvmJ$FpLHrENTnbb`
zIhY4*(u<%POrqf@fm+iENC}|fCmajP2pXQr>?dy402(P&0aJ;SeS|pMCIVGH0D54e
zKt&P^8YJ~#nlu)S1CN61#5uQ6paMqH;1kpUi$Egx<KjnIUZi>d9T?6M-WK)=uZkaV
z*^J?G5w!>(i=TdZf<PDXJ1%1|tfKgZfR{IfUpr9CA_r;_Kk#x={G7{66t`^Y23;_m
zAiPgwbQ+Piqn1;S@5m6yq83v(mqhgEN3kUDh>ht7YTgz<NAog;do>-OtJ&bdRlCK{
z$k;__MIh7+N5q^ZetKp-{Ui*9Sla|I5mzmtplYfRf}vSNR^n%BMqubI5a=|HKr3&-
zU;G44u^1S}iC??P6u)FMQT!IplQiKm9m8e{t%Q%-<K;*UAL%eD5nRpSR&bAVE4fwN
zYHkg;mV1I*$34ld=bqx8<~DE}xo5ad+-9zg+rn+-wsG6J9o$atS#B5i9QQo;0{0@f
zo7=<f<@Rwear?QKxdYrQ+^gI{?ltap?hWou?htpFdy9LUdxv|MdyhN9z0V!xj&UDw
zA95dYA9KgK6Wk}<r`$>I6nC0C!=2?m<IZuPb6;>@a$j-hxeMIa+(qsZ_YHTM`<DBT
z`=0xOyTV=Ne&l}Qe&&ARu5s77U%B778{F^QAKXpuPwp1?7k8Vx!~M<u!~M(M<?eC!
zdB8&+@eI%M5?;#7csbAUJWoJZ7)Ie3MPL+(Q4~he7{y=|i%}d#@famwl!#FhM#&hZ
zV3dkc8b;|DWnh$vQ5Hto80BD;i;)_mJdE-&D!`}^BMnAcjEXQS#%K^mgE1O{(NK&^
zFe=4Jhfx_udW;Mh88Iryr~;#57!Aj01V$q<s>Em%MpYP%#%K&i)fhd3kqM)*7}a1@
zi;)?laTwKMRF9DbqwyF`z^DPEMvR&;vSQSX(L{_|FtTA}$EX#fNf=GWXbMJCF`9<a
zbc|+TG!vs)7|q5=zzAbB2ct(Znv2mqjOJss0HcK%Ey8FqMoTbSiqSHRmSgl7Mk_FS
z9HW&Ot-@$EMr$xyi_sGpt;6U^jMiiH6h=>Dv;m`y7(Ij0CX6;?)P~U(B^o21%OL;m
zD$&zQRI5aS5{*`(jY?Fdgx8hGtVAwKv|9-;C_YodIZ8zS_oxzWQ1n&8!%CE{M7xx5
zi4v|>!p{{;6f2adPzm=b;TlDn5}A}pt%R>CQIHZvDN&sgu2P~wN;E_X=PJ=yC8|-v
zl}h-l63$nmQYFe#q9P^QtVAhFG*pQqm2jEDPl*OAk*nfS#gmFTN;pf2wkzSYO0-7_
zcPUY}5*|^a7nN|H61|{UqeL1d+Nnfam8f2c@|5%gV$UfElR71eP^?stZuTnHD&avT
zic_L$#p6n3Q6jApwJ8y=L|BPpl_*yUUs4j~z>kzDQ;D8eEL5U0C3-}Ob|}$ICCX7k
z(yq4>+LeefQldo9DAp<A$4b;oiN+~Wz7i!XkzR=klt`vTo7$srevvR^Q~O-!mkPGd
z>&L|F43Nn`&aZ6aSBfWb2jx4yEJokV0&?IDg1|r!Pip0YLgKy4!8plllDDKTQg^Ah
zbf7d{S|P2GTBXyai=?ZiZPG*1kEIu-H)JldzOo=$h-{!NLKZEHlO@QKWvQ|ZS+-0q
zE0AeqMY6%N5?PtdD668YjjTb|Dw{3Cvd3iWWSeEr%U+Tlk)4p8lU<U1FS{w1$rW;6
zxu4u$K2RPb&y?rM2g`@bKaro5pO&AMpOb$f|4M#Aeo_97{9F0=@+<Nm<v+`>%WueU
z%Kwu8Ex*eFj^U&n$GLL7Id`rv=f(MQ{#+mz!VTmixM(hpOXO0xbS{g_<?=ZVSIiCJ
zN;y4O&JE`(xzXGsTn#slvv3WZm22TzxhdRqZWf1$yWB*a;9lbNUM3FjAaPfhxm(1|
z^ya<!0emzc%g6I6d>Wt4=kj@c0bkCK;_LYFd?Vk?+r+N|F6N))pW-+0&+t3=gZw-E
zQT|K*3jZVjGk?tmxNt6RF5WH)E}1U*E|o48mq{*DT&B6qaM|GUjLT-1EiT(!cDOw2
za=_)F%Ns6-T~4@s>T=QL7nkcUzq$PG>fzeg)zj76)z{U}HNZ8>HP$u3HQ6=OHQTk&
zwZe6{>qys8uA^ONxvp?s=lYE6PS<^|ue%;~{lN7j*W<3AxSn!7?RwVroa;^3`@LLx
z_3G8TmwT_iy}Ww)^z!SK(rZGm$-S2KYU{PP*L%G_>-9~qpL^YLb8+)>8{ih}7Vnnm
zmh6`5mhP76mhG17mgiRBR_s>dHpOj`+X}ZQ-JWvW>bBkOS+@gjhuz+D`^fE#+a<Tl
zZr{0GbGzmCPj6*!pWeZ}<9cWJ*7nx-uIydgdqVHYz1Q_#-}~v_8+&i+y}9?6-rIT~
z>iw5OqTm&-3O9v9;jZYT=%?^f_$Y=bMkp#3Rf;i+@d}$_n&NRqn_{bCyJDwem*TYI
zlH!`;AEiX;p;Rdolv<@hS*{$W9HFdKRx3@)8l_oTr<|i)q}-_7q-;}eRc=@AR_;|E
zP`;{sO?gH6hw@){xqCnN5cdJ@VeS#`QSLGBaqfxk$?mD{>F$~Ch3;DS5_g@u-reXf
zxG!>F<-Wmvhx@bc&$++gzT17T`%CTz++THn&HWAcL+(f2KXCup{e=5J9=$v~JwiNU
zJW@UKJqkUv9>pGmJ%)PdJoFw$j|z|B9wR+!J*Ij*>apBot;bG}T^`SSyy)?Y$3c%1
z9^ZKU>T$>8ACJ2p_xr#;{rUv=N$!){C%sQ*pX@%leTw@G?)QAZm;1fa?~Q(k`n}cf
zc)zp#&h<Or@9Tb-`hDN;O1~fb{p-nj_VHAC26={fMtjD3ws_h-CwWfsoaQ;hbC##z
zImdIZ=X}qFo{K$~dM@`|;knXtwdY#Tb)M@zpZ477xyiH5bF1fe&z+vTJfHV`(Q}XI
zKF`-Z-}gM`dD8Ps&x@Wvdj9Tt)AO#E)JyKA^z!lQ?-lA5;}z$X?v?LV=vCr1%xi>~
z$!ok<gIBB9EHA-pk=IJE)m|ICwtMaL+Uxb2*Bf3(yiRz1>h*=!Wv}nNu6f<^y6p|U
zd2d(mzTW=cD(`Ub1n(s8Y;Uc1vA5p4(!0vr?A_$u>^;?cj`v*eW!`JO*LiRD-sSzg
z_siagyx;Qv!26W<8Se|;KX_mDzTy41_rE?8A2%O`kGD^dPl!*nPl`{PPoB?UpP@b#
zK4W}pd?xtVeWv;>_F3w)#^(v2^*&pCcKW>R^N!DZJ|Fme<a6BTl+PKT&wRf1`QGP>
z&u>1z`zHIQ`lkD4`eys)`sVo-_-cHMd<Xds@h$Py`RaX*z7@X1eMkC^@*VA4?Q8O_
z@iqI_`C5D@_%`}leJA?bd|Q3z`!4id?7P%=lkc;>dwdW39`pUw_muB<zSn$j_DB7>
z{_g#K`=|CF+P|Xz@cxzktNNS!kMD2mKc)YZ{Wtf2z5j{+m;2xGbMp)I3-%k}7v>k?
z7v&e@7w4DYm+LpwuiS5#-$=i)esz9UzZrhB{IK70zZHIK{GRZ8(r=^RCcienSNz`f
zJLz}Y@2uZBzc2hQ`Q7t(@$cpD?H}VG=bzx8<e%a{*nhbHNdGbZkNA)Euk*L~Pw=1Y
zKi7Y;|5E=|{!jaF_J7s?i2tYlU-*CL|8oEe=pEo4Fd!f-AR-_kATvN6FetzfFgjpX
zz=D7k0qX;v4%is5DWEN2Yryt^-2q1f&IDWtxEk<>s=sQWDqIz*idMy{;#G;NER{y}
zh-!)os}`%CQ0-S8P`#>pP4$NAu<9+<JE|`N-2xSX?ty&*`vrOh`ULh5^bZUUj0%hm
zj1SBT)C3L<tPN}oYzdqfxFPVxz&(Nc0`~_V2s|A4cHp~#X9MpAaY228{DUHcqJv_C
z;)61R3WBsj#X&=YN`iDj<w3)Os)K5StU(KcRs=m6v^(g%pp!wTgU$w>3%VWjchJ8<
z_kuw%3TA_q!F_@~gMEU-gVTaF!9~G?f`<e*1UCgY2e$;<gC_+~37#FiAb54~+TeA;
z>w{kpelz%R@Y})f1|JDN8vJqaiQqHA-voaf{C)715P1k6;u_)>q6l#h=@SwV5*QK{
zk{yy8k{41Cq6rxmG9sihq$*@g$cB)YLJo(#9rA9-k&vSyAB21qay;adkdq;&L(Ybr
z3;81CkI=Bt_|T-#l+g6htk9g$ywHMBO=wZ*;LxF=6`{jJXN1lQ6+-8P&JCR(x-fKc
z=+e;Tp({dHhOQ1>8@euZedyDn8$(|U{Ur340lfx<56}&09I$G@?g1YSxH=FFOd41^
zaKgX^1NRR+H1PDmvjfi!yfpCgz`q9G8Tik@y94isxrVugDZ<>te8c?0284x$MTSL(
zm4=mt8N({VhKG#|8x=M>tU9bAtSQVE)*3cBY)06uFd=MN*kfU<!`6na3)>L(OxWhI
z=fd`f9Sl1b_C?rNVHd(KhJ6!`!r5?XxICN>cMW$74+$R-9v_|`UKp+oFAg6P-Vojt
z-W=W%ZV#UvJ|%ow_>Ay1;RnLs34bsA{qSSqABKM%elq-Y_)p>ggx?LnAAuq~BfKMg
zBm5!)BBCPlA_^ij5k(P$BB~<H5ls<7#G;7R5t|}jh&UASR>V6I??oJqxDatY;<t$3
zBmRuI9oaY1E7B*@FH#j592pWhFtRYREYc8J5ji4qROFaQQ{>dh7bEvX?u*<X`AXz#
zk#9sEj(jij!^qQ-XCuFjycu~b@=oMGk@uoxQCyTF$|I^@ly_80RC-iqR8CZ0RDP5u
zYIM}BC?RT2)V!z#QH!INMm-btM%3Y`x1-*RIvVw1)JIV#qJD^$MRU<E(QeU-XpiW=
z(W>b1=*Z}#=<Mjh(G}6-qU)o_M>j-Uqo+hKie3`EEc&tNmC@UyUx_{#{YLcR=(nRU
zM}HUnL-dc)zeHb){x$kW3>T9Sqm8MGF~`)!jE`xEX^NQ`Gbv_r%(R%9F&kp`#q5tc
z5OXl*^_Y_}Kg3*(`6=dF%&#$bVtr!!$NI+x#)iZWj17y8h>eQX#7>Ky5j!hZh<!A6
ze(b{7C9!R>TVr32eI@p_*f(Pj$6kuP9Q$4DmDrzRe~!Ht`)iy$E-$ViP7_xYHz;mM
zTxnccoH1^G+>W?s<DQFqF>Y_%zPSBy2jV`Bm&D8Bxp<d&w|Hf|M|{8dfcUidy!e9n
z^7vu#BjZQKkBNUQ{>k{K;y1)^ir*5yGk#b63-Np6_r<>)|7!f{_{;G>$6t&8J^r8g
zy9xagyc2vA{1XBbf)fTLgeOEL#3aNgBqpRJ3{M!DFe+h8f+?Xk!JJT+U`d#huq9zz
z!j6Pp3C}0&PS~4pIN?&l<%I7Nt|a`F@N>eogkKY7iCKv`iR#4sL``CG;^4%R#OlQQ
z#PNws5|<@Dmbfx;P2$?bb&2Z}_a&ZAJeznf@yo>Xi5C;UN%Be>lr$u%G^s4fm{gH8
zB5738=%nhTu}QT_<C3gN6O*PSO-q`YBqS|LT9ULpX+_fZq&Jg(O1hTxThi}Ie<s~Z
zx}EfQ(%ocfvS0Gx<dWpFWJ7XA^6=!5$yLd%$wKmy<ekZTlHX2#H~IbKW62*SUrhcj
z`S;{MlmANoJH;&}ASEy*BxOKKcuHEzpp+pgB`LZTLy9G3TFQ)+St&xwqbVy>wxn!J
z*^#m<<@uC1Qx2!RlX4{GXv*g)U#6T-xtMY}<&Ts<Q~pZ1lk#tBuhibD?x}rJJyRo7
zvr=<X^HK{^wW<2lv8lDG<5KHW$EQwCotio$b$05e)V9=ZsXJ45r9PkfV(Lq&FQ>kq
zdMx$B)Z?k2rrt>XBlTA5?bN?h|4qG@=9=b{HZUzbEh;TGtt`!uR*^O$tun1DZA{w4
zG+Wxdw6$sL(w<7&khUppf7+3>qiG+e9Z&lt?NZw1wC~fdr2Ui*(v|5R>3!2Z(|yth
zrl+N6q-Uq+rst&_(#z9_rH@RnN^eZJrnjWq(<i6TOJAG5E`5FahV)J8Z>PVT{(kyL
z=_k@ZO+S@>CjC<S<@A3tTr=D<6d4{F{W8Kb(latMax(HV3Np$whGmS%sLU9hVa*US
z=48yxn4hsIV`IkdjJ+BAGY(`N%y>WJbjI0?&ojQt_&4KTCd_0rrJ3?fJ~JpYBr`R$
zICF4jNv1B-kXe^GC39NljLg}Yb27JNZp+-6`CR4;nY%OhW**Hvp80j=rOeBj-(_CO
zyqo2grO5Kg>YL@26_S;lm70~Fm6?^3Wyq?|GG*0f)nzTrTAZ~k>#?lIvsPuT$=a87
zI_px_<*e_su4Z%DF4=C`%50D9zS*AHzS(}+LD`Af$=Rvd8QIy{hV1HWQ+923UG~E4
z#o5cUS7fiuUY)%*`>E^=*;}&rXCKIZHT(7KL)mAuf6x9mN179w6P6R16O$94la!O1
zqs}qr49gjw^GHrz&YYaba-PrGmvb!VWX|U~zvU`(eRKVD19L-i2j+(7M&-ul4$d8u
zJ0Z6*w>j6AJ1KWc?$X?6bDz)Mox3mh<=j_tU&}p}`%Ugoxxc8*>U#AAb(4Cc+NN$*
zPgYM;&rr`&WA$A10`(&GQuT863iT@WTJ<{hQ|gWC&FU@c?doUM&#PZl?^VB~KA?V8
z{kr;)`YrXl>Lco->JQW(t3OenQlC|yQ-7(xpuVL3R{ewes`@AOFX~^_H`ITqZ>jI7
z|54w|8<-cLmzbB5m!6lImz|fJmzP(VSCUti*O=FwXUm(EH#Kig-rT%pd5`6-$ZN}c
zE^klX!MxY=4&}X@_i^5dyeoM><z37BE$@%KKlA>|`#bO7ynFdDpUs!$$K~hb56Lgd
z*X5Vx8}g0$75T&SN9NDTpPN5Fe?k7D{Kff8^OxtZ$Um6>dj6aFZ{@#}|6cz4`N#4<
z%0H8TA^&3j5BWdl|D1olz_Y-+z_-A^KvfV_5K=IpAiN;1AiW^7KwXeupebl7Xf9|e
zuobixOe&aCFs)!l!MuV61#1hQEO@%$nS!>0tpz&@o-H_4aHin1f^!956nt55zToSE
zO9j^o`xSZ>`V{&V1{4Ms1{V$}3@^+m%q~<H78Gg=t%VZ{ZH1ExrxZ>roKZNta8BWp
z!qtUq3!f_7Sh%_Hg~9`cuWI5oiJBBmnkGY&tx;?8HH8|jrdTsrGgMQm(QAyF3e9lM
zNX;nCXw4&<v6@=VI8D7~yrxlO)lAgbG_9J+nyH%UnpqmGc~mn`vp};*vsANOvqG~<
zvqrN{vtIMGW}{}4rcJX|vt6@O^PJ`d&2G(J%}bg$G>5e5+AM9ZHeajJ7HJ1*hiFT+
zWm<!_LOVh`N;_Ixtu<+DwRPI@+6HZtcB0m%our+rouQqroui$rU7%g0U8-HKeO$X*
zyH@+8_9^WK?K9do?KbUB?Q_}}w0pEKX%A=*YTwWv(!QmAM|(tjRQrMUW9=u}liD-d
z3)+iCl|`eA9x19R8dqc~YACW6wG_1$O)i>NG_y!3dbDVM(W0WIMUNG&ELu~vuIQ<v
zjYXS_wifLu+Ew&I(Vn80iVhSVEPA8paM3$OM~aRWeN=R!=w#8EqH{%G7F{U1RP=4p
z4@Ex~{ZjO6(eFin7TqrTr|4cWEM|*k#e8wE;*jE$;^N}+;+EoB#Y>9U6z?kDU;KXY
z`Qn>{WP_pxjT|&}(E33;2E8`u{GdMu-5(r0ID7Ee!LtXi8@zS!i-X@D{K?=i2j3Wc
ze@NdUsYC2T9v`xQ$ep2*p<Y8HhGq|~9Xe;|@}awi9vynGq*uw%lIoI%5?r#T<WR}c
zk`GEgE;&(huH=i7^Ce%GTq*gn^t;j@N`EZ<rS#X*8>Kf(|0=yx`cLUy9ndj4sZOqQ
z(e=_PbRN2XI&WQnU4Sl77or=e3)e;IVs#0+WL=srQ<tO5(-rEpx<R_3I-O3hE7uLz
zjns|OjnSEOHM(&+i>^Uu)lJmdbdz*bbu)Ccb#rucbqjQhbxU=R=~n92=$_E6*KN>k
z(rwXg*X`8p(!HSDqkBnrKzC60y6%wfE#14i_jSi~AL@?lKGB`jozb1seW5$A`&##n
z?pxgtx*v7F=zi7R(B0JC(%shmt-D(W%9t`~8CT|7*1OETtZ$iDnNOKtnW`+PETn8e
zS$J7wSxi}cSw>lwK2@Kg&(^E;1$wQ1kbbCMr#I*;^dt16^keiUeXYJuKVILcZ`RxN
zlk`*dGxW3dbM*7{3-wF%%k_`zSL>h9uh(zTZ_;nkZ`VJoe_p>^zfb?N{#E_!`a}A+
z_3!DA>Oa&U*MF)%t^Z8_h5o$$qW-e}d;L}Y&-&~78~U62zx03W?;3!CF-Q%Z!PU^)
z;BM$^@G|%s{0)JI5W_%2gdy4xXGk=p7}5<{hFn9wL1QR33^9}%^oDZ7a6_eGwBZp$
zjbWU@VrVc}4K0RN!xY1G!z=?f%rz`9EH*4NtT3!HtTjAoc-rucq0O+(u+#9I;YGtM
zhSv;l8s0LzYk1%Af#GArCx%movxd(NUm7kLE*ZWx{9w3h_}OsXaKmuZ@R#9l!@q`m
zMrdS>G9zbnHTE{T8~Yl)jJ`&HW1um_IM5hjj5fv@6OAdxbYqq=*O+hA7>kWVjP#2$
zM&mH!2xFzO%2;h2Ycw0{jT4Mb#)(F|ak6omafWfWagK4GaiMXEak=qv<0|7?<CDgx
zj2n!bjBUnk#+}CJj4v4X7+*3TFdj6%VLWVn$9Tke%=nS<gz=>DwDB|J7sm6(i^j{w
z?~PZDKO3(bZy0YHZyE0x|25t(N9B@odAUouTe-5_r@Vi;U-^LYu=4Qogz}{F<no;I
T0>`Iw5OVzTtANwLa>M@z3AMEu

diff --git a/toolkit/locales/en-US/chrome/global/intl.properties b/toolkit/locales/en-US/chrome/global/intl.properties
--- a/toolkit/locales/en-US/chrome/global/intl.properties
+++ b/toolkit/locales/en-US/chrome/global/intl.properties
@@ -24,16 +24,16 @@ intl.accept_languages=en-us, en
 intl.accept_languages=en-us, en
 intl.charsetmenu.browser.static=ISO-8859-1, UTF-8
 intl.charsetmenu.browser.more1=ISO-8859-1, ISO-8859-15, IBM850, x-mac-roman, windows-1252, ISO-8859-14, ISO-8859-7, x-mac-greek, windows-1253, x-mac-icelandic, ISO-8859-10, ISO-8859-3
 intl.charsetmenu.browser.more2=ISO-8859-4, ISO-8859-13, windows-1257, IBM852, ISO-8859-2, x-mac-ce, windows-1250, x-mac-croatian, IBM855, ISO-8859-5, ISO-IR-111, KOI8-R, x-mac-cyrillic, windows-1251, IBM866, KOI8-U, x-mac-ukrainian, ISO-8859-16, x-mac-romanian
 intl.charsetmenu.browser.more3=GB2312, x-gbk, gb18030, HZ-GB-2312, ISO-2022-CN, Big5, Big5-HKSCS, x-euc-tw, EUC-JP, ISO-2022-JP, Shift_JIS, EUC-KR, x-windows-949, x-johab, ISO-2022-KR
 intl.charsetmenu.browser.more4=armscii-8, GEOSTD8, TIS-620, ISO-8859-11, windows-874, IBM857, ISO-8859-9, x-mac-turkish, windows-1254, x-viet-tcvn5712, VISCII, x-viet-vps, windows-1258, x-mac-devanagari, x-mac-gujarati, x-mac-gurmukhi
 intl.charsetmenu.browser.more5=ISO-8859-6, windows-1256, IBM864, x-mac-arabic, x-mac-farsi, ISO-8859-8-I, windows-1255, ISO-8859-8, IBM862, x-mac-hebrew
 # Localization Note: Never change the following entry.
-intl.charsetmenu.browser.unicode=UTF-8, UTF-16LE, UTF-16BE, UTF-32LE, UTF-32BE, UTF-7
+intl.charsetmenu.browser.unicode=UTF-8, UTF-16LE, UTF-16BE, UTF-32LE, UTF-32BE
 intl.charset.default=ISO-8859-1
 intl.charset.detector=
 intl.charsetmenu.mailedit=ISO-8859-1, ISO-8859-15, ISO-8859-6, armscii-8, geostd8, ISO-8859-13, ISO-8859-14, ISO-8859-2, GB2312, GB18030, Big5, KOI8-R, windows-1251, KOI8-U, ISO-8859-7, ISO-8859-8-I, windows-1255, ISO-2022-JP, EUC-KR, ISO-8859-10, ISO-8859-3, TIS-620, ISO-8859-9, UTF-8, VISCII
 # valid intl.menuitems.appendedacceskeys are: true or false, <empty string> (missing or empty preference equals false)
 intl.menuitems.alwaysappendaccesskeys=
 # valid intl.menuitems.insertseparatorbeforeaccesskeys are: true or false, <empty string> (missing or empty preference equals false)
 intl.menuitems.insertseparatorbeforeaccesskeys=true
diff --git a/toolkit/locales/en-US/chrome/mozapps/downloads/downloads.dtd b/toolkit/locales/en-US/chrome/mozapps/downloads/downloads.dtd
--- a/toolkit/locales/en-US/chrome/mozapps/downloads/downloads.dtd
+++ b/toolkit/locales/en-US/chrome/mozapps/downloads/downloads.dtd
@@ -34,14 +34,15 @@ file names and tall enough to hint that 
 
 <!ENTITY cmd.close.commandKey             "w">
 <!ENTITY cmd.close2.commandKey            "j">
 <!ENTITY cmd.close2Unix.commandKey        "y">
 <!ENTITY cmd.clearList.label              "Clear List">
 <!ENTITY cmd.clearList.tooltip            "Removes completed, canceled, and failed downloads from the list">
 <!ENTITY cmd.clearList.accesskey          "C">
 <!ENTITY cmd.find.commandKey              "f">
+<!ENTITY cmd.search.commandKey            "k">
 
 <!ENTITY closeWhenDone.label              "Close when downloads complete">
 <!ENTITY closeWhenDone.tooltip            "Closes the Downloads window when all files are done downloading">
 
 <!ENTITY showFolder.label                 "Show this Folder">
 <!ENTITY searchBox.label                  "Search">
diff --git a/toolkit/mozapps/downloads/content/downloads.xul b/toolkit/mozapps/downloads/content/downloads.xul
--- a/toolkit/mozapps/downloads/content/downloads.xul
+++ b/toolkit/mozapps/downloads/content/downloads.xul
@@ -98,16 +98,20 @@
     <key id="key_close2"  key="&cmd.close2Unix.commandKey;" oncommand="closeWindow(true);" modifiers="accel"/>
 #else
     <key id="key_close2"  key="&cmd.close2.commandKey;" oncommand="closeWindow(true);" modifiers="accel"/>
 #endif
     <key                  keycode="VK_ESCAPE"           oncommand="closeWindow(true);"/>
 
     <key id="key_findDownload"
          key="&cmd.find.commandKey;"
+         modifiers="accel"
+         command="cmd_findDownload"/>
+    <key id="key_findDownload2"
+         key="&cmd.search.commandKey;"
          modifiers="accel"
          command="cmd_findDownload"/>
     <key id="key_selectAllDownloads"
          key="&selectAllCmd.key;"
          modifiers="accel"
          command="cmd_selectAllDownloads"/>
   </keyset>
   
diff --git a/toolkit/mozapps/downloads/tests/Makefile.in b/toolkit/mozapps/downloads/tests/Makefile.in
--- a/toolkit/mozapps/downloads/tests/Makefile.in
+++ b/toolkit/mozapps/downloads/tests/Makefile.in
@@ -44,12 +44,11 @@ include $(DEPTH)/config/autoconf.mk
 include $(DEPTH)/config/autoconf.mk
 
 MODULE = test_downloads
 
 XPCSHELL_TESTS = \
   unit \
   $(NULL)
 
-DIRS += browser
 DIRS += chrome
 
 include $(topsrcdir)/config/rules.mk
diff --git a/toolkit/mozapps/downloads/tests/browser/Makefile.in b/toolkit/mozapps/downloads/tests/browser/Makefile.in
deleted file mode 100644
--- a/toolkit/mozapps/downloads/tests/browser/Makefile.in
+++ /dev/null
@@ -1,54 +0,0 @@
-#
-# ***** BEGIN LICENSE BLOCK *****
-# Version: MPL 1.1/GPL 2.0/LGPL 2.1
-#
-# The contents of this file are subject to the Mozilla Public License Version
-# 1.1 (the "License"); you may not use this file except in compliance with
-# the License. You may obtain a copy of the License at
-# http://www.mozilla.org/MPL/
-#
-# Software distributed under the License is distributed on an "AS IS" basis,
-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
-# for the specific language governing rights and limitations under the
-# License.
-#
-# The Original Code is Mozilla code.
-#
-# The Initial Developer of the Original Code is
-# Mozilla Corporation.
-# Portions created by the Initial Developer are Copyright (C) 2008
-# the Initial Developer. All Rights Reserved.
-#
-# Contributor(s):
-#	  Shawn Wilsher <me@shawnwilsher.com> (Original Author)
-#
-# Alternatively, the contents of this file may be used under the terms of
-# either the GNU General Public License Version 2 or later (the "GPL"), or
-# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
-# in which case the provisions of the GPL or the LGPL are applicable instead
-# of those above. If you wish to allow use of your version of this file only
-# under the terms of either the GPL or the LGPL, and not to allow others to
-# use your version of this file under the terms of the MPL, indicate your
-# decision by deleting the provisions above and replace them with the notice
-# and other provisions required by the GPL or the LGPL. If you do not delete
-# the provisions above, a recipient may use your version of this file under
-# the terms of any one of the MPL, the GPL or the LGPL.
-#
-# ***** END LICENSE BLOCK *****
-
-DEPTH          = ../../../../..
-topsrcdir      = @top_srcdir@
-srcdir         = @srcdir@
-VPATH          = @srcdir@
-relativesrcdir = toolkit/mozapps/downloads/tests/browser
-
-include $(DEPTH)/config/autoconf.mk
-include $(topsrcdir)/config/rules.mk
-
-_BROWSER_FILES = \
-  browser_bug_406857.js \
-  browser_bug_412360.js \
-  $(NULL)
-
-libs:: $(_BROWSER_FILES)
-	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/browser/$(relativesrcdir)
diff --git a/toolkit/mozapps/downloads/tests/chrome/Makefile.in b/toolkit/mozapps/downloads/tests/chrome/Makefile.in
--- a/toolkit/mozapps/downloads/tests/chrome/Makefile.in
+++ b/toolkit/mozapps/downloads/tests/chrome/Makefile.in
@@ -52,20 +52,23 @@ _CHROME_FILES = \
   test_delete_key_removes.xul \
   test_esc_key_closes_clears.xul \
   test_multi_select.xul \
   test_multiword_search.xul \
   test_pause_button_state.xul \
   test_removeDownload_updates_ui.xul \
   test_retention_is_0_closes.xul \
   test_search_clearlist.xul \
+  test_search_keys.xul \
   test_select_all.xul \
   test_space_key_pauses_resumes.xul \
   test_ui_stays_open_on_alert_clickback.xul \
+  test_bug_412360.xul \
   test_bug_429247.xul \
+  utils.js \
   $(NULL)
 
 ifneq (,$(filter cocoa, $(MOZ_WIDGET_TOOLKIT)))
 _CHROME_FILES += \
   test_backspace_key_removes.xul \
   $(NULL)
 endif
 
diff --git a/toolkit/mozapps/downloads/tests/browser/browser_bug_412360.js b/toolkit/mozapps/downloads/tests/chrome/test_bug_412360.xul
rename from toolkit/mozapps/downloads/tests/browser/browser_bug_412360.js
rename to toolkit/mozapps/downloads/tests/chrome/test_bug_412360.xul
--- a/toolkit/mozapps/downloads/tests/browser/browser_bug_412360.js
+++ b/toolkit/mozapps/downloads/tests/chrome/test_bug_412360.xul
@@ -1,8 +1,10 @@
+<?xml version="1.0"?>
+<!--
 /* ***** BEGIN LICENSE BLOCK *****
  * Version: MPL 1.1/GPL 2.0/LGPL 2.1
  *
  * The contents of this file are subject to the Mozilla Public License Version
  * 1.1 (the "License"); you may not use this file except in compliance with
  * the License. You may obtain a copy of the License at
  * http://www.mozilla.org/MPL/
  *
@@ -29,71 +31,113 @@
  * use your version of this file under the terms of the MPL, indicate your
  * decision by deleting the provisions above and replace them with the notice
  * and other provisions required by the GPL or the LGPL. If you do not delete
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
+/**
+ * This tests bug 412360, which caused problems when trying to save javascript
+ * URIs.  This is not an xpcshell unit test because it triggers an assertion,
+ * which causes xpcshell test cases to fail.
+ */
+-->
+
+<window title="Download Manager Test"
+        xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+        onload="test();">
+
+  <script type="application/javascript"
+          src="chrome://mochikit/content/MochiKit/packed.js"/>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"/>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/tests/SimpleTest/EventUtils.js"/>
+
+  <script type="application/javascript">
+  <![CDATA[
+
+const Cc = Components.classes;
+const Ci = Components.interfaces;
+const Cr = Components.results;
+
 Components.utils.import("resource://gre/modules/XPCOMUtils.jsm");
 
 let didFail = false;
 var file;
+
+let factory = {
+  createInstance: function(aOuter, aIid) {
+    if (aOuter != null)
+      throw Components.results.NS_ERROR_NO_AGGREGATION;
+    return promptService.QueryInterface(aIid);
+  }
+};
 
 let promptService = {
   QueryInterface: XPCOMUtils.generateQI([Ci.nsIPromptService]),
   alert: function() {
     ok(didFail, "javascript: uri failed and showed a message");
     file.remove(false);
-    finish();
+
+    // Unregister the factory so we do not leak
+    Components.manager.QueryInterface(Ci.nsIComponentRegistrar).
+    unregisterFactory(
+      Components.ID("{6cc9c9fe-bc0b-432b-a410-253ef8bcc699}"),
+      factory
+    );
+
+    SimpleTest.finish();
   }
 };
 
 Components.manager.QueryInterface(Ci.nsIComponentRegistrar).
 registerFactory(Components.ID("{6cc9c9fe-bc0b-432b-a410-253ef8bcc699}"),
   "PromptService", "@mozilla.org/embedcomp/prompt-service;1",
-  {
-    createInstance: function(aOuter, aIid) {
-      if (aOuter != null)
-        throw Components.results.NS_ERROR_NO_AGGREGATION;
-      return promptService.QueryInterface(aIid);
-    }
-  });
+  factory
+);
 
 function test()
 {
   let dm = Cc["@mozilla.org/download-manager;1"].
            getService(Ci.nsIDownloadManager);
   let db = dm.DBConnection;
 
   // Empty any old downloads
   db.executeSimpleSQL("DELETE FROM moz_downloads");
 
   let stmt = db.createStatement(
-    "INSERT INTO moz_downloads (source, target, state) " +
-    "VALUES (?1, ?2, ?3)");
+    "INSERT INTO moz_downloads (source, target, state, endTime) " +
+    "VALUES (?1, ?2, ?3, ?4)");
 
-  // Saving javascript URIs doesn't work
-  stmt.bindStringParameter(0, "javascript:5");
+  try {
+    // Saving javascript URIs doesn't work
+    stmt.bindStringParameter(0, "javascript:5");
 
-  // Download to a temp local file
-  file = Cc["@mozilla.org/file/directory_service;1"].
-         getService(Ci.nsIProperties).get("TmpD", Ci.nsIFile);
-  file.append("javascriptURI");
-  file.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE, 0666);
-  stmt.bindStringParameter(1, Cc["@mozilla.org/network/io-service;1"].
-    getService(Ci.nsIIOService).newFileURI(file).spec);
+    // Download to a temp local file
+    file = Cc["@mozilla.org/file/directory_service;1"].
+           getService(Ci.nsIProperties).get("TmpD", Ci.nsIFile);
+    file.append("javascriptURI");
+    file.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE, 0666);
+    stmt.bindStringParameter(1, Cc["@mozilla.org/network/io-service;1"].
+      getService(Ci.nsIIOService).newFileURI(file).spec);
 
-  // Start it as canceled
-  stmt.bindInt32Parameter(2, dm.DOWNLOAD_CANCELED);
+    // Start it as canceled
+    stmt.bindInt32Parameter(2, dm.DOWNLOAD_CANCELED);
 
-  // Add it!
-  stmt.execute();
-  stmt.finalize();
+    stmt.bindInt32Parameter(3, Date.now() * 1000);
+
+    // Add it!
+    stmt.execute();
+  }
+  finally {
+    stmt.finalize();
+  }
 
   let listener = {
     onDownloadStateChange: function(aState, aDownload)
     {
       switch (aDownload.state) {
         case dm.DOWNLOAD_FAILED:
           // Remember that we failed for the prompt service
           didFail = true;
@@ -107,37 +151,45 @@ function test()
   dm.addListener(listener);
 
   // Close the UI if necessary
   let wm = Cc["@mozilla.org/appshell/window-mediator;1"].
            getService(Ci.nsIWindowMediator);
   let win = wm.getMostRecentWindow("Download:Manager");
   if (win) win.close();
 
-  // Start the test when the download manager window loads
-  let ww = Cc["@mozilla.org/embedcomp/window-watcher;1"].
-           getService(Ci.nsIWindowWatcher);
-  ww.registerNotification({
-    observe: function(aSubject, aTopic, aData) {
-      ww.unregisterNotification(this);
-      aSubject.QueryInterface(Ci.nsIDOMEventTarget).
-      addEventListener("DOMContentLoaded", doTest, false);
+
+  let os = Cc["@mozilla.org/observer-service;1"].
+           getService(Ci.nsIObserverService);
+  const DLMGR_UI_DONE = "download-manager-ui-done";
+
+  let testObs = {
+    observe: function(aSubject, aTopic, aData)
+    {
+      if (aTopic != DLMGR_UI_DONE)
+        return;
+
+      let win = aSubject.QueryInterface(Ci.nsIDOMWindow);
+      // Send the enter key to Download Manager to retry the download
+      synthesizeKey("VK_ENTER", {}, win);
+      os.removeObserver(testObs, DLMGR_UI_DONE);
     }
-  });
+  };
 
-  // Let the Startup method of the download manager UI finish before we test
-  let doTest = function() setTimeout(function() {
-    win = wm.getMostRecentWindow("Download:Manager");
+  // Register with the observer service
+  os.addObserver(testObs, DLMGR_UI_DONE, false);
 
-    // Try again if selectedIndex is -1
-    if (win.document.getElementById("downloadView").selectedIndex)
-      return doTest();
-
-    // Send the enter key to Download Manager to retry the download
-    EventUtils.synthesizeKey("VK_ENTER", {}, win);
-  }, 0);
- 
   // Show the Download Manager UI
   Cc["@mozilla.org/download-manager-ui;1"].
   getService(Ci.nsIDownloadManagerUI).show();
 
-  waitForExplicitFinish();
+  SimpleTest.waitForExplicitFinish();
 }
+
+  ]]>
+  </script>
+
+  <body xmlns="http://www.w3.org/1999/xhtml">
+    <p id="display"></p>
+    <div id="content" style="display:none;"></div>
+    <pre id="test"></pre>
+  </body>
+</window>
diff --git a/toolkit/mozapps/downloads/tests/chrome/test_retention_is_0_closes.xul b/toolkit/mozapps/downloads/tests/chrome/test_retention_is_0_closes.xul
--- a/toolkit/mozapps/downloads/tests/chrome/test_retention_is_0_closes.xul
+++ b/toolkit/mozapps/downloads/tests/chrome/test_retention_is_0_closes.xul
@@ -48,59 +48,71 @@
 <window title="Download Manager Test"
         xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
         onload="test();">
 
   <script type="application/javascript"
           src="chrome://mochikit/content/MochiKit/packed.js"/>
   <script type="application/javascript"
           src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"/>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/chrome/toolkit/mozapps/downloads/tests/chrome/utils.js"/>
 
   <script type="application/javascript">
   <![CDATA[
 
-const Cc = Components.classes;
-const Ci = Components.interfaces;
-const Cr = Components.results;
+function setPref(aDoTest)
+{
+  let prefs = Cc["@mozilla.org/preferences-service;1"].
+              getService(Ci.nsIPrefBranch);
+
+  // If we're testing, set retention to auto-remove and auto-close
+  prefs.setIntPref("browser.download.manager.retention", aDoTest ? 0 : 2);
+  prefs.setBoolPref("browser.download.manager.closeWhenDone", aDoTest);
+}
 
 function bug413093obs()
 {
   this.mDownload = null;
   this.wasPaused = false;
 }
 bug413093obs.prototype = {
   observe: function(aSubject, aTopic, aData)
   {
     if ("domwindowopened" == aTopic) {
-      let ww = Cc["@mozilla.org/embedcomp/window-watcher;1"].
-               getService(Ci.nsIWindowWatcher);
-      ww.unregisterNotification(this);
-
       // If we opened before we were paused, we need to set up our proper state
       // We also should not try to resume (we weren't paused!)
       if (!this.wasPaused) {
         dump("domwindowopened callback - not pausing or resuming\n");
         this.wasPaused = true;
         return;
       }
 
       dump("domwindowopened callback - resuming download\n");
 
       // Resume the download now that UI is up and running
       let dm = Cc["@mozilla.org/download-manager;1"].
                 getService(Ci.nsIDownloadManager);
       dm.resumeDownload(this.mDownload.id);
-    } else if ("timer-callback" == aTopic) {
-      this.setPref(false);
+    }
+    else if("domwindowclosed" == aTopic) {
+      let ww = Cc["@mozilla.org/embedcomp/window-watcher;1"].
+               getService(Ci.nsIWindowWatcher);
+      ww.unregisterNotification(this);
 
-      let dmui = Cc["@mozilla.org/download-manager-ui;1"].
-                 getService(Ci.nsIDownloadManagerUI);
-      ok(!dmui.visible, "Download Manager UI is not showing");
+      // Let the UI finish doing whatever it needs to do
+      executeSoon(function() {
+        setPref(false);
 
-      SimpleTest.finish();
+        let dmui = Cc["@mozilla.org/download-manager-ui;1"].
+                   getService(Ci.nsIDownloadManagerUI);
+        ok(!dmui.visible, "Download Manager UI is not showing");
+
+        SimpleTest.finish();
+      });
     }
   },
 
   onDownloadStateChange: function(aOldState, aDownload)
   {
     if (aDownload.state == Ci.nsIDownloadManager.DOWNLOAD_DOWNLOADING &&
         !this.wasPaused) {
       dump("onDownloadStateChange - pausing download\n");
@@ -114,35 +126,22 @@ bug413093obs.prototype = {
 
     if (aDownload.state == Ci.nsIDownloadManager.DOWNLOAD_FINISHED) {
       aDownload.targetFile.remove(false);
 
       let dm = Cc["@mozilla.org/download-manager;1"].
                 getService(Ci.nsIDownloadManager);
       dm.removeListener(this);
 
-      // We have to do this on a timer so other JS stuff that handles the UI
-      // can actually catch up to us...
-      let timer = Cc["@mozilla.org/timer;1"].createInstance(Ci.nsITimer);
-      timer.init(this, 1000, Ci.nsITimer.TYPE_ONE_SHOT);
+      // If this test is going to pass, we'll get a domwindowclosed notification
     }
   },
   onStateChange: function(a, b, c, d, e) { },
   onProgressChange: function(a, b, c, d, e, f, g) { },
   onSecurityChange: function(a, b, c, d) { },
-
-  setPref: function(aDoTest)
-  {
-    let prefs = Cc["@mozilla.org/preferences-service;1"].
-                getService(Ci.nsIPrefBranch);
-
-    // If we're testing, set retention to auto-remove and auto-close
-    prefs.setIntPref("browser.download.manager.retention", aDoTest ? 0 : 2);
-    prefs.setBoolPref("browser.download.manager.closeWhenDone", aDoTest);
-  }
 };
 function test()
 {
   function addDownload() {
     function createURI(aObj) {
       let ios = Cc["@mozilla.org/network/io-service;1"].
                 getService(Ci.nsIIOService);
       return (aObj instanceof Ci.nsIFile) ? ios.newFileURI(aObj) :
@@ -181,17 +180,17 @@ function test()
   let wm = Cc["@mozilla.org/appshell/window-mediator;1"].
            getService(Ci.nsIWindowMediator);
   let win = wm.getMostRecentWindow("Download:Manager");
   if (win)
     win.close();
 
   let obs = new bug413093obs();
   dm.addListener(obs);
-  obs.setPref(true);
+  setPref(true);
 
   // Start the test when the download manager window loads
   let ww = Cc["@mozilla.org/embedcomp/window-watcher;1"].
            getService(Ci.nsIWindowWatcher);
   ww.registerNotification(obs);
 
   addDownload();
 
diff --git a/toolkit/mozapps/downloads/tests/chrome/test_search_keys.xul b/toolkit/mozapps/downloads/tests/chrome/test_search_keys.xul
new file mode 100644
--- /dev/null
+++ b/toolkit/mozapps/downloads/tests/chrome/test_search_keys.xul
@@ -0,0 +1,136 @@
+<?xml version="1.0"?>
+<!--
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is mozilla.org code.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Shawn Wilsher <me@shawnwilsher.com> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+/**
+ * Make sure the download manager can display downloads in the right order and
+ * contains the expected data. The list has one of each download state ordered
+ * by the start/end times.
+ */
+-->
+
+<window title="Download Manager Test"
+        xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+        onload="test();">
+
+  <script type="application/javascript"
+          src="chrome://mochikit/content/MochiKit/packed.js"/>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"/>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/tests/SimpleTest/EventUtils.js"/>
+
+  <script type="application/javascript">
+  <![CDATA[
+
+const Cc = Components.classes;
+const Ci = Components.interfaces;
+const Cr = Components.results;
+
+function test_meta_k(aWin)
+{
+  let doc = aWin.document;
+  let searchbox = doc.getElementById("searchbox");
+  let richlistbox = doc.getElementById("downloadView");
+
+  // Enusre the serachbox is not focused
+  richlistbox.focus();
+
+  // Dispatch the right key combination
+  synthesizeKey("k", {accelKey: true}, aWin);
+
+  ok(searchbox.hasAttribute("focused"), "Searchbox is focused");
+}
+
+let testFuncs = [
+  test_meta_k,
+]
+
+function test()
+{
+  let dm = Cc["@mozilla.org/download-manager;1"].
+           getService(Ci.nsIDownloadManager);
+
+  // See if the DM is already open, and if it is, close it!
+  let wm = Cc["@mozilla.org/appshell/window-mediator;1"].
+           getService(Ci.nsIWindowMediator);
+  let win = wm.getMostRecentWindow("Download:Manager");
+  if (win)
+    win.close();
+
+  let os = Cc["@mozilla.org/observer-service;1"].
+           getService(Ci.nsIObserverService);
+  const DLMGR_UI_DONE = "download-manager-ui-done";
+
+  let testObs = {
+    observe: function(aSubject, aTopic, aData)
+    {
+      if (aTopic != DLMGR_UI_DONE)
+        return;
+
+      let win = aSubject.QueryInterface(Ci.nsIDOMWindow);
+
+      // Now we can run our tests
+      for each (let t in testFuncs)
+        t(win);
+
+      win.close();
+      os.removeObserver(testObs, DLMGR_UI_DONE);
+      SimpleTest.finish();
+    }
+  };
+
+  // Register with the observer service
+  os.addObserver(testObs, DLMGR_UI_DONE, false);
+
+  // Show the Download Manager UI
+  Cc["@mozilla.org/download-manager-ui;1"].
+  getService(Ci.nsIDownloadManagerUI).show();
+
+  SimpleTest.waitForExplicitFinish();
+}
+
+  ]]>
+  </script>
+
+  <body xmlns="http://www.w3.org/1999/xhtml">
+    <p id="display"></p>
+    <div id="content" style="display:none;"></div>
+    <pre id="test"></pre>
+  </body>
+</window>
diff --git a/toolkit/mozapps/downloads/tests/chrome/utils.js b/toolkit/mozapps/downloads/tests/chrome/utils.js
new file mode 100644
--- /dev/null
+++ b/toolkit/mozapps/downloads/tests/chrome/utils.js
@@ -0,0 +1,60 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is mozilla.org code.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Shawn Wilsher <me@shawnwilsher.com> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+/**
+ * Provides utility functions for the download manager chrome tests.
+ */
+
+const Cc = Components.classes;
+const Ci = Components.interfaces;
+const Cr = Components.results;
+
+/**
+ * Executes a function shortly after the call, but lets the caller continue
+ * working (or finish).
+ */
+function executeSoon(aFunc)
+{
+  let tm = Cc["@mozilla.org/thread-manager;1"].getService(Ci.nsIThreadManager);
+  
+  tm.mainThread.dispatch({
+    run: function()
+    {
+      aFunc();
+    }
+  }, Ci.nsIThread.DISPATCH_NORMAL);
+}
diff --git a/toolkit/mozapps/extensions/test/unit/addons/test_bug436207/install.js b/toolkit/mozapps/extensions/test/unit/addons/test_bug436207/install.js
new file mode 100644
--- /dev/null
+++ b/toolkit/mozapps/extensions/test/unit/addons/test_bug436207/install.js
@@ -0,0 +1,1 @@
+// Test add-on that attempts to use install.js to install.
diff --git a/toolkit/mozapps/extensions/test/unit/test_bug394717.js b/toolkit/mozapps/extensions/test/unit/test_bug394717.js
--- a/toolkit/mozapps/extensions/test/unit/test_bug394717.js
+++ b/toolkit/mozapps/extensions/test/unit/test_bug394717.js
@@ -31,55 +31,67 @@
  * decision by deleting the provisions above and replace them with the notice
  * and other provisions required by the GPL or the LGPL. If you do not delete
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL
  *
  * ***** END LICENSE BLOCK *****
  */
 
+// Use the internal webserver for regular update pings
+gPrefs.setCharPref("extensions.update.url", "http://localhost:4444/");
+
 const checkListener = {
   _onUpdateStartedCalled: false,
   _onUpdateEndedCalled: false,
   _onAddonUpdateStartedCount: 0,
   _onAddonUpdateEndedCount: 0,
 
   // nsIAddonUpdateCheckListener
   onUpdateStarted: function onUpdateStarted() {
     this._onUpdateStartedCalled = true;
   },
 
   // nsIAddonUpdateCheckListener
   onUpdateEnded: function onUpdateEnded() {
     this._onUpdateEndedCalled = true;
+    run_test_pt2();
   },
 
   // nsIAddonUpdateCheckListener
   onAddonUpdateStarted: function onAddonUpdateStarted(aAddon) {
     this._onAddonUpdateStartedCount++;
   },
 
   // nsIAddonUpdateCheckListener
   onAddonUpdateEnded: function onAddonUpdateEnded(aAddon, aStatus) {
     this._onAddonUpdateEndedCount++;
   }
 }
 
+// Get the HTTP server.
+do_import_script("netwerk/test/httpserver/httpd.js");
+var testserver;
+
 /**
  * Run the test.
  */
 function run_test() {
+  // Start the http server. Will return empty update info but that's ok
+  testserver = new nsHttpServer();
+  testserver.start(4444);
+
   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "5", "1.9");
   startupEM();
   const Ci = Components.interfaces;
   gEM.update([], 0, Ci.nsIExtensionManager.UPDATE_SYNC_COMPATIBILITY, checkListener);
   do_test_pending();
-  do_timeout(5000, "run_test_pt2()");
 }
 
 function run_test_pt2() {
   dump("Checking onUpdateStarted\n");
   do_check_true(checkListener._onUpdateStartedCalled);
   dump("Checking onUpdateEnded\n");
   do_check_true(checkListener._onUpdateEndedCalled);
   do_check_eq(checkListener._onAddonUpdateStartedCount, checkListener._onAddonUpdateEndedCount);
+  testserver.stop();
   do_test_finished();
 }
diff --git a/toolkit/mozapps/extensions/test/unit/test_bug436207.js b/toolkit/mozapps/extensions/test/unit/test_bug436207.js
new file mode 100644
--- /dev/null
+++ b/toolkit/mozapps/extensions/test/unit/test_bug436207.js
@@ -0,0 +1,64 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is mozilla.org code.
+ *
+ * The Initial Developer of the Original Code is
+ * Dave Townsend <dtownsend@oxymoronical.com>.
+ *
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL
+ *
+ * ***** END LICENSE BLOCK *****
+ */
+
+const NO_INSTALL_SCRIPT = -204;
+
+var listener = {
+  onStateChange: function(index, state, value) {
+    if (state == Components.interfaces.nsIXPIProgressDialog.INSTALL_DONE)
+      do_check_eq(value, NO_INSTALL_SCRIPT);
+  },
+
+  onProgress: function(index, value, maxValue) {
+  }
+}
+
+function run_test() {
+  // Setup for test
+  createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1");
+  startupEM();
+
+  var xpi = do_get_addon("test_bug436207");
+  var ioservice = Components.classes["@mozilla.org/network/io-service;1"]
+                            .getService(Components.interfaces.nsIIOService);
+  var uri = ioservice.newFileURI(xpi);
+
+  var xpim = Components.classes["@mozilla.org/xpinstall/install-manager;1"]
+                       .createInstance(Components.interfaces.nsIXPInstallManager);
+  xpim.initManagerFromChrome([uri.spec], 1, listener);
+}
diff --git a/toolkit/toolkit-makefiles.sh b/toolkit/toolkit-makefiles.sh
--- a/toolkit/toolkit-makefiles.sh
+++ b/toolkit/toolkit-makefiles.sh
@@ -905,20 +905,16 @@ if test -n "$MOZ_CALENDAR"; then
     calendar/base/build/Makefile
     calendar/providers/Makefile
     calendar/providers/memory/Makefile
     calendar/providers/storage/Makefile
     calendar/providers/composite/Makefile
   "
 fi
 
-if [ "$MOZ_MAIL_NEWS" ]; then
-  . "${srcdir}/mailnews/makefiles.sh"
-fi
-
 if test -n "$MOZ_IPCD"; then
   add_makefiles "
     ipc/ipcd/Makefile
     ipc/ipcd/daemon/public/Makefile
     ipc/ipcd/daemon/src/Makefile
     ipc/ipcd/client/public/Makefile
     ipc/ipcd/client/src/Makefile
     ipc/ipcd/shared/src/Makefile
diff --git a/view/public/nsIViewManager.h b/view/public/nsIViewManager.h
--- a/view/public/nsIViewManager.h
+++ b/view/public/nsIViewManager.h
@@ -317,17 +317,17 @@ public:
   /**
    * allow the view manager to refresh. this may cause a synchronous
    * paint to occur inside the call.
    * @param aUpdateFlags see bottom of nsIViewManager.h for description
    * @return error status
    */
   NS_IMETHOD EnableRefresh(PRUint32 aUpdateFlags) = 0;
 
-  class UpdateViewBatch {
+  class NS_STACK_CLASS UpdateViewBatch {
   public:
     UpdateViewBatch() {}
   /**
    * prevents the view manager from refreshing. allows UpdateView()
    * to notify widgets of damaged regions that should be repainted
    * when the batch is ended. Call EndUpdateViewBatch on this object
    * before it is destroyed
    * @return error status
diff --git a/widget/public/Makefile.in b/widget/public/Makefile.in
--- a/widget/public/Makefile.in
+++ b/widget/public/Makefile.in
@@ -59,17 +59,17 @@ EXPORTS		= \
 		nsILookAndFeel.h \
 		nsIPluginWidget.h \
 		nsINativeKeyBindings.h \
 		nsIDeviceContextSpec.h \
 		nsIMenuRollup.h \
 		$(NULL)
 
 ifeq ($(MOZ_WIDGET_TOOLKIT),cocoa)
-EXPORTS		+= nsIMenuBar.h
+EXPORTS		+= nsINativeMenuService.h
 endif
 
 ifeq ($(MOZ_WIDGET_TOOLKIT),os2)
 EXPORTS		+= nsIDragSessionOS2.h
 endif
 
 ifeq ($(MOZ_WIDGET_TOOLKIT),beos)
 EXPORTS		+= nsIDragSessionBeOS.h
diff --git a/widget/public/nsIMenuBar.h b/widget/public/nsIMenuBar.h
deleted file mode 100644
--- a/widget/public/nsIMenuBar.h
+++ /dev/null
@@ -1,141 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
-/* ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 1998
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#ifndef nsIMenuBar_h__
-#define nsIMenuBar_h__
-
-#include "nsISupports.h"
-#include "nsString.h"
-#include "nsIMenu.h"
-
-class nsIWidget;
-
-// F81C6D64-B260-44ED-9289-2E410A130E35
-#define NS_IMENUBAR_IID      \
-{ 0xF81C6D64, 0xB260, 0x44ED, \
-  { 0x92, 0x89, 0x2E, 0x41, 0x0A, 0x13, 0x0E, 0x35 } }
-
-/**
- * MenuBar widget
- */
-class nsIMenuBar : public nsISupports {
-
-  public:
-    NS_DECLARE_STATIC_IID_ACCESSOR(NS_IMENUBAR_IID)
-
-   /**
-    * Creates the MenuBar
-    *
-    */
-    NS_IMETHOD Create(nsIWidget * aParent) = 0;
-
-   /**
-    * Get the MenuBar's Parent.  This addrefs.
-    *
-    */
-    NS_IMETHOD GetParent(nsIWidget *&aParent) = 0;
-
-   /**
-    * Set the MenuBar's Parent
-    *
-    */
-    NS_IMETHOD SetParent(nsIWidget *aParent) = 0;
-
-   /**
-    * Adds the Menu 
-    *
-    */
-    NS_IMETHOD AddMenu(nsIMenu * aMenu) = 0;
-    
-   /**
-    * Returns the number of menus
-    *
-    */
-    NS_IMETHOD GetMenuCount(PRUint32 &aCount) = 0;
-
-   /**
-    * Returns a Menu Item at a specified Index
-    *
-    */
-    NS_IMETHOD GetMenuAt(const PRUint32 aCount, nsIMenu *& aMenu) = 0;
-
-   /**
-    * Inserts a Menu at a specified Index
-    *
-    */
-    NS_IMETHOD InsertMenuAt(const PRUint32 aCount, nsIMenu *& aMenu) = 0;
-
-   /**
-    * Removes an Menu from a specified Index
-    *
-    */
-    NS_IMETHOD RemoveMenu(const PRUint32 aCount) = 0;
-
-   /**
-    * Removes all the Menus
-    *
-    */
-    NS_IMETHOD RemoveAll() = 0;
-
-   /**
-    * Gets Native MenuHandle
-    *
-    */
-    NS_IMETHOD  GetNativeData(void*& aData) = 0;
-
-   /**
-    * Sets Native MenuHandle. Temporary hack for mac until 
-    * nsMenuBar does it's own construction
-    */
-    NS_IMETHOD  SetNativeData(void* aData) = 0;
-    
-   /**
-    * Draw the menubar
-    *
-    */
-    NS_IMETHOD  Paint() = 0;
-
-   /**
-    * Construct the menubar
-    *
-    */
-    NS_IMETHOD MenuConstruct(const nsMenuEvent & aMenuEvent, nsIWidget * aParentWindow, void * aMenuNode) = 0;
-};
-
-NS_DEFINE_STATIC_IID_ACCESSOR(nsIMenuBar, NS_IMENUBAR_IID)
-
-#endif
diff --git a/widget/public/nsINativeMenuService.h b/widget/public/nsINativeMenuService.h
new file mode 100644
--- /dev/null
+++ b/widget/public/nsINativeMenuService.h
@@ -0,0 +1,60 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is mozilla.org code.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *  Josh Aas <josh@mozilla.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#ifndef nsINativeMenuService_h_
+#define nsINativeMenuService_h_
+
+#include "nsISupports.h"
+
+class nsIWidget;
+class nsIContent;
+
+// {90DF88F9-F084-4EF3-829A-49496E636DED}
+#define NS_INATIVEMENUSERVICE_IID \
+{ 0x90DF88F9, 0xF084, 0x4EF3, \
+{ 0x82, 0x9A, 0x49, 0x49, 0x6E, 0x63, 0x6D, 0xED} }
+
+class nsINativeMenuService : public nsISupports {
+public:
+  // Given a top-level window widget and a menu bar DOM node, sets up native
+  // menus. Once created, native menus are controlled via the DOM, including
+  // destruction.
+  NS_IMETHOD CreateNativeMenuBar(nsIWidget* aParent, nsIContent* aMenuBarNode)=0;
+};
+
+#endif // nsINativeMenuService_h_
diff --git a/widget/public/nsIWidget.h b/widget/public/nsIWidget.h
--- a/widget/public/nsIWidget.h
+++ b/widget/public/nsIWidget.h
@@ -50,17 +50,16 @@ class   nsIAppShell;
 class   nsIAppShell;
 class   nsIToolkit;
 class   nsIFontMetrics;
 class   nsIRenderingContext;
 class   nsIDeviceContext;
 class   nsIRegion;
 struct  nsRect;
 struct  nsFont;
-class   nsIMenuBar;
 class   nsIEventListener;
 class   nsIRollupListener;
 class   nsGUIEvent;
 struct  nsColorMap;
 class   imgIContainer;
 class   gfxASurface;
 class   nsIMouseListener;
 class   nsIContent;
@@ -90,20 +89,20 @@ typedef nsEventStatus (*PR_CALLBACK EVEN
 #define NS_NATIVE_PLUGIN_PORT 8
 #define NS_NATIVE_SCREEN      9
 #define NS_NATIVE_SHELLWIDGET 10      // Get the shell GtkWidget
 #ifdef XP_MACOSX
 #define NS_NATIVE_PLUGIN_PORT_QD    100
 #define NS_NATIVE_PLUGIN_PORT_CG    101
 #endif
 
-// 517a0eef-cd1c-48b3-96f0-e341a50f120d
+// 00e25b3d-c872-4985-a15e-8e650b7b8ff6
 #define NS_IWIDGET_IID \
-{ 0x517a0eef, 0xcd1c, 0x48b3, \
-  { 0x96, 0xf0, 0xe3, 0x41, 0xa5, 0x0f, 0x12, 0x0d } }
+{ 0x00e25b3d, 0xc872, 0x4985, \
+  { 0xa1, 0x5e, 0x8e, 0x65, 0x0b, 0x7b, 0x8f, 0xf6 } }
 
 // Hide the native window systems real window type so as to avoid
 // including native window system types and APIs. This is necessary
 // to ensure cross-platform code.
 typedef void* nsNativeWidget;
 
 /**
  * Border styles
@@ -874,17 +873,17 @@ class nsIWidget : public nsISupports {
 
     /**
      * Set the widget's MenuBar.
      * Must be called after Create.
      *
      * @param aMenuBar the menubar
      */
 
-    NS_IMETHOD SetMenuBar(nsIMenuBar * aMenuBar) = 0;
+    NS_IMETHOD SetMenuBar(void* aMenuBar) = 0;
 
     /**
      * Set the widget's MenuBar's visibility
      *
      * @param aShow PR_TRUE to show, PR_FALSE to hide
      */
 
     NS_IMETHOD ShowMenuBar(PRBool aShow) = 0;
@@ -1100,16 +1099,30 @@ class nsIWidget : public nsISupports {
      * layout is not supported and the event was not fired
      */
     virtual nsresult SynthesizeNativeKeyEvent(PRInt32 aNativeKeyboardLayout,
                                               PRInt32 aNativeKeyCode,
                                               PRUint32 aModifierFlags,
                                               const nsAString& aCharacters,
                                               const nsAString& aUnmodifiedCharacters) = 0;
 
+    /**
+     * Activates a native menu item at the position specified by the index
+     * string. The index string is a string of positive integers separated
+     * by the "|" (pipe) character. The last integer in the string represents
+     * the item index in a submenu located using the integers prior to it.
+     *
+     * Example: 1|0|4
+     * In this string, the first integer represents the top-level submenu
+     * in the native menu bar. Since the integer is 1, it is the second submeu
+     * in the native menu bar. Within that, the first item (index 0) is a
+     * submenu, and we want to activate the 5th item within that submenu.
+     */
+    virtual nsresult ActivateNativeMenuItemAt(const nsAString& indexString) = 0;
+
 protected:
     // keep the list of children.  We also keep track of our siblings.
     // The ownership model is as follows: parent holds a strong ref to
     // the first element of the list, and each element holds a strong
     // ref to the next element in the list.  The prevsibling and
     // lastchild pointers are weak, which is fine as long as they are
     // maintained properly.
     nsCOMPtr<nsIWidget> mFirstChild;
diff --git a/widget/public/nsWidgetsCID.h b/widget/public/nsWidgetsCID.h
--- a/widget/public/nsWidgetsCID.h
+++ b/widget/public/nsWidgetsCID.h
@@ -74,30 +74,20 @@
 #define NS_LOOKANDFEEL_CID \
 { 0xa61e6398, 0x2057, 0x40fd,  \
     { 0x9c, 0x81, 0x87, 0x3b, 0x90, 0x8d, 0x24, 0xe7 } }
 
 //-----------------------------------------------------------
 // Menus 
 //-----------------------------------------------------------
 
-// {BC658C81-4BEB-11d2-8DBB-00609703C14E}
-#define NS_MENUBAR_CID      \
-{ 0xbc658c81, 0x4beb, 0x11d2, \
-  { 0x8d, 0xbb, 0x0, 0x60, 0x97, 0x3, 0xc1, 0x4e } }
-
-// {35A3DEC1-4992-11d2-8DBA-00609703C14E}
-#define NS_MENU_CID      \
-{ 0x35a3dec1, 0x4992, 0x11d2, \
-  { 0x8d, 0xba, 0x0, 0x60, 0x97, 0x3, 0xc1, 0x4e } }
-
-// {7F045771-4BEB-11d2-8DBB-00609703C14E}
-#define NS_MENUITEM_CID      \
-{ 0x7f045771, 0x4beb, 0x11d2, \
-  { 0x8d, 0xbb, 0x0, 0x60, 0x97, 0x3, 0xc1, 0x4e } }
+// {0B3FE5AA-BC72-4303-85AE-76365DF1251D}
+#define NS_NATIVEMENUSERVICE_CID \
+{ 0x0B3FE5AA, 0xBC72, 0x4303, \
+  { 0x85, 0xAE, 0x76, 0x36, 0x5D, 0xF1, 0x25, 0x1D} }
 
 // {F6CD4F21-53AF-11d2-8DC4-00609703C14E}
 #define NS_POPUPMENU_CID      \
 { 0xf6cd4f21, 0x53af, 0x11d2, \
   { 0x8d, 0xc4, 0x0, 0x60, 0x97, 0x3, 0xc1, 0x4e } }
 
 //-----------------------------------------------------------
 //Drag & Drop & Clipboard
diff --git a/widget/src/beos/nsWindow.h b/widget/src/beos/nsWindow.h
--- a/widget/src/beos/nsWindow.h
+++ b/widget/src/beos/nsWindow.h
@@ -42,18 +42,16 @@
 #define BeIME
 
 #include "nsBaseWidget.h"
 #include "nsdefs.h"
 #include "nsSwitchToUIThread.h"
 #include "nsToolkit.h"
 
 #include "nsIWidget.h"
-
-#include "nsIMenuBar.h"
 
 #include "nsIMouseListener.h"
 #include "nsIEventListener.h"
 #include "nsString.h"
 #include "nsRegion.h"
 
 #include <Window.h>
 #include <View.h>
@@ -159,17 +157,17 @@ public:
 	NS_IMETHOD              Invalidate(const nsRect & aRect, PRBool aIsSynchronous);
 	NS_IMETHOD              InvalidateRegion(const nsIRegion *aRegion,
 	                                         PRBool aIsSynchronous);
 	NS_IMETHOD              Update();
 	virtual void*           GetNativeData(PRUint32 aDataType);
 	NS_IMETHOD              SetColorMap(nsColorMap *aColorMap);
 	NS_IMETHOD              Scroll(PRInt32 aDx, PRInt32 aDy, nsRect *aClipRect);
 	NS_IMETHOD              SetTitle(const nsAString& aTitle);
-	NS_IMETHOD              SetMenuBar(nsIMenuBar * aMenuBar) { return NS_ERROR_FAILURE; }
+	NS_IMETHOD              SetMenuBar(void * aMenuBar) { return NS_ERROR_FAILURE; }
 	NS_IMETHOD              ShowMenuBar(PRBool aShow) { return NS_ERROR_FAILURE; }
 	NS_IMETHOD              WidgetToScreen(const nsRect& aOldRect, nsRect& aNewRect);
 	NS_IMETHOD              ScreenToWidget(const nsRect& aOldRect, nsRect& aNewRect);
 	NS_IMETHOD              BeginResizingChildren(void);
 	NS_IMETHOD              EndResizingChildren(void);
 	NS_IMETHOD              GetPreferredSize(PRInt32& aWidth, PRInt32& aHeight);
 	NS_IMETHOD              SetPreferredSize(PRInt32 aWidth, PRInt32 aHeight);
 	NS_IMETHOD              DispatchEvent(nsGUIEvent* event, nsEventStatus & aStatus);
diff --git a/widget/src/cocoa/Makefile.in b/widget/src/cocoa/Makefile.in
--- a/widget/src/cocoa/Makefile.in
+++ b/widget/src/cocoa/Makefile.in
@@ -61,17 +61,17 @@ REQUIRES = xpcom \
 		  layout \
 		  view \
 		  necko \
 		  locale \
 		  pref \
 		  intl \
 		  exthandler \
 		  appshell \
-                  lcms \
+		  lcms \
 		  thebes \
 		  js \
 		  xpconnect \
 		  imglib2 \
 		  $(NULL)
 
 ifdef MOZ_ENABLE_GLITZ
 REQUIRES += glitz glitzagl
@@ -79,27 +79,26 @@ endif
 
 ifdef ACCESSIBILITY
 REQUIRES += accessibility
 endif
 
 EXPORTS = \
 		mozView.h \
 		nsChangeObserver.h \
-		nsIMenu.h \
-		nsIMenuItem.h \
 		$(NULL)
 
 CMMSRCS = \
 		nsBidiKeyboard.mm \
 		nsClipboard.mm \
 		nsMenuX.mm \
 		nsMenuBarX.mm \
 		nsMenuItemX.mm \
 		nsMenuItemIconX.mm \
+		nsMenuUtilsX.mm \
 		nsFilePicker.mm \
 		nsDragService.mm \
 		nsToolkit.mm \
 		nsAppShell.mm \
 		nsCocoaUtils.mm \
 		nsCocoaWindow.mm \
 		nsChildView.mm \
 		nsWindowMap.mm \
diff --git a/widget/src/cocoa/nsAppShell.mm b/widget/src/cocoa/nsAppShell.mm
--- a/widget/src/cocoa/nsAppShell.mm
+++ b/widget/src/cocoa/nsAppShell.mm
@@ -51,16 +51,17 @@
 #include "nsIWidget.h"
 #include "nsThreadUtils.h"
 #include "nsIWindowMediator.h"
 #include "nsServiceManagerUtils.h"
 #include "nsIInterfaceRequestor.h"
 #include "nsIWebBrowserChrome.h"
 #include "nsObjCExceptions.h"
 #include "nsCocoaUtils.h"
+#include "nsChildView.h"
 
 // defined in nsChildView.mm
 extern nsIRollupListener * gRollupListener;
 extern nsIWidget         * gRollupWidget;
 
 // defined in nsCocoaWindow.mm
 extern PRInt32             gXULModalLevel;
 
@@ -230,16 +231,18 @@ nsAppShell::Init()
   context.perform = ProcessGeckoEvents;
   
   mCFRunLoopSource = ::CFRunLoopSourceCreate(kCFAllocatorDefault, 0, &context);
   NS_ENSURE_STATE(mCFRunLoopSource);
 
   ::CFRunLoopAddSource(mCFRunLoop, mCFRunLoopSource, kCFRunLoopCommonModes);
 
   rv = nsBaseAppShell::Init();
+
+  NS_InstallPluginKeyEventsHandler();
 
   [localPool release];
 
   return rv;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
 }
 
@@ -602,16 +605,18 @@ nsAppShell::Exit(void)
   // But we should also complain about it (since it isn't quite kosher).
   if (mTerminated) {
     NS_WARNING("nsAppShell::Exit() called redundantly");
     return NS_OK;
   }
 
   mTerminated = PR_TRUE;
 
+  NS_RemovePluginKeyEventsHandler();
+
   // Quoting from Apple's doc on the [NSApplication stop:] method (from their
   // doc on the NSApplication class):  "If this method is invoked during a
   // modal event loop, it will break that loop but not the main event loop."
   // nsAppShell::Exit() shouldn't be called from a modal event loop.  So if
   // it is we complain about it (to users of debug builds) and call [NSApp
   // stop:] one extra time.  (I'm not sure if modal event loops can be nested
   // -- Apple's docs don't say one way or the other.  But the return value
   // of [NSApp _isRunningModal] doesn't change immediately after a call to
diff --git a/widget/src/cocoa/nsChildView.h b/widget/src/cocoa/nsChildView.h
--- a/widget/src/cocoa/nsChildView.h
+++ b/widget/src/cocoa/nsChildView.h
@@ -56,26 +56,55 @@
 #include "nsIWidget.h"
 #include "nsIKBStateControl.h"
 #include "nsIAppShell.h"
 
 #include "nsIMouseListener.h"
 #include "nsIEventListener.h"
 #include "nsString.h"
 #include "nsIDragService.h"
-#include "nsIMenuBar.h"
 
 #include "nsplugindefs.h"
 
 #import <Carbon/Carbon.h>
 #import <Cocoa/Cocoa.h>
 
 class gfxASurface;
 class nsChildView;
 union nsPluginPort;
+
+enum {
+  // Currently focused ChildView (while this TSM document is active).
+  // Transient (only set while TSMProcessRawKeyEvent() is processing a key
+  // event), and the ChildView will be retained and released around the call
+  // to TSMProcessRawKeyEvent() -- so it can be weak.
+  kFocusedChildViewTSMDocPropertyTag  = 'GKFV', // type ChildView* [WEAK]
+};
+
+// Undocumented HIToolbox function used by WebKit to allow Carbon-based IME
+// to work in a Cocoa-based browser (like Safari or Cocoa-widgets Firefox).
+// (Recent WebKit versions actually use a thin wrapper around this function
+// called WKSendKeyEventToTSM().)
+//
+// Calling TSMProcessRawKeyEvent() from ChildView's keyDown: and keyUp:
+// methods (when the ChildView is a plugin view) bypasses Cocoa's IME
+// infrastructure and (instead) causes Carbon TSM events to be sent on each
+// NSKeyDown event.  We install a Carbon event handler
+// (PluginKeyEventsHandler()) to catch these events and pass them to Gecko
+// (which in turn passes them to the plugin).
+extern "C" long TSMProcessRawKeyEvent(EventRef carbonEvent);
+
+@interface NSEvent (Undocumented)
+
+// Return Cocoa event's corresponding Carbon event.  Not initialized (on
+// synthetic events) until the OS actually "sends" the event.  This method
+// has been present in the same form since at least OS X 10.2.8.
+- (EventRef)_eventRef;
+
+@end
 
 @interface ChildView : NSView<
 #ifdef ACCESSIBILITY
                               mozAccessible,
 #endif
                               mozView, NSTextInput>
 {
 @private
@@ -127,28 +156,35 @@ union nsPluginPort;
   // Holds our drag service across multiple drag calls. The reference to the
   // service is obtained when the mouse enters the view and is released when
   // the mouse exits or there is a drop. This prevents us from having to
   // re-establish the connection to the service manager many times per second
   // when handling |draggingUpdated:| messages.
   nsIDragService* mDragService;
   
   PRUint32 mLastModifierState;
+
+  // For use with plugins, so that we can support IME in them.  We can't use
+  // Cocoa TSM documents (those created and managed by the NSTSMInputContext
+  // class) -- for some reason TSMProcessRawKeyEvent() doesn't work with them.
+  TSMDocumentID mPluginTSMDoc;
 }
 
 // these are sent to the first responder when the window key status changes
 - (void)viewsWindowDidBecomeKey;
 - (void)viewsWindowDidResignKey;
 
 // Stop NSView hierarchy being changed during [ChildView drawRect:]
 - (void)delayedTearDown;
 
 - (void)setTransparent:(BOOL)transparent;
 
 - (void)sendFocusEvent:(PRUint32)eventType;
+
+- (void) processPluginKeyEvent:(EventRef)aKeyEvent;
 @end
 
 
 
 //-------------------------------------------------------------------------
 //
 // nsTSMManager
 //
@@ -286,29 +322,31 @@ public:
 
   NS_IMETHOD              Update();
 
   virtual void      ConvertToDeviceCoordinates(nscoord &aX, nscoord &aY);
   void              LocalToWindowCoordinate(nsPoint& aPoint)            { ConvertToDeviceCoordinates(aPoint.x, aPoint.y); }
   void              LocalToWindowCoordinate(nscoord& aX, nscoord& aY)   { ConvertToDeviceCoordinates(aX, aY); }
   void              LocalToWindowCoordinate(nsRect& aRect)              { ConvertToDeviceCoordinates(aRect.x, aRect.y); }
 
-  NS_IMETHOD        SetMenuBar(nsIMenuBar * aMenuBar);
+  NS_IMETHOD        SetMenuBar(void* aMenuBar);
   NS_IMETHOD        ShowMenuBar(PRBool aShow);
 
   NS_IMETHOD        GetPreferredSize(PRInt32& aWidth, PRInt32& aHeight);
   NS_IMETHOD        SetPreferredSize(PRInt32 aWidth, PRInt32 aHeight);
   
   NS_IMETHOD        SetCursor(nsCursor aCursor);
   NS_IMETHOD        SetCursor(imgIContainer* aCursor, PRUint32 aHotspotX, PRUint32 aHotspotY);
   
   NS_IMETHOD        CaptureRollupEvents(nsIRollupListener * aListener, PRBool aDoCapture, PRBool aConsumeRollupEvent);
   NS_IMETHOD        SetTitle(const nsAString& title);
 
   NS_IMETHOD        GetAttention(PRInt32 aCycleCount);
+
+  NS_IMETHOD ActivateNativeMenuItemAt(const nsAString& indexString);
 
   // nsIPluginWidget
   NS_IMETHOD        GetPluginClipRect(nsRect& outClipRect, nsPoint& outOrigin, PRBool& outWidgetVisible);
   NS_IMETHOD        StartDrawPlugin();
   NS_IMETHOD        EndDrawPlugin();
   NS_IMETHOD        SetPluginInstanceOwner(nsIPluginInstanceOwner* aInstanceOwner);
   
   NS_IMETHOD        GetHasTransparentBackground(PRBool& aTransparent);
@@ -377,10 +415,12 @@ protected:
   PRPackedBool          mPluginIsCG; // true if this is a CoreGraphics plugin
 
   PRPackedBool          mInSetFocus;
 
   nsPluginPort          mPluginPort;
   nsIPluginInstanceOwner* mPluginInstanceOwner; // [WEAK]
 };
 
+void NS_InstallPluginKeyEventsHandler();
+void NS_RemovePluginKeyEventsHandler();
 
 #endif // nsChildView_h_
diff --git a/widget/src/cocoa/nsChildView.mm b/widget/src/cocoa/nsChildView.mm
--- a/widget/src/cocoa/nsChildView.mm
+++ b/widget/src/cocoa/nsChildView.mm
@@ -419,17 +419,28 @@ nsChildView::~nsChildView()
 nsChildView::~nsChildView()
 {
   // notify the children that we're gone
   for (nsIWidget* kid = mFirstChild; kid; kid = kid->GetNextSibling()) {
     nsChildView* childView = static_cast<nsChildView*>(kid);
     childView->mParentWidget = nsnull;
   }
 
-  TearDownView(); // should have already been done from Destroy
+  NS_WARN_IF_FALSE(mOnDestroyCalled, "nsChildView object destroyed without calling Destroy()");
+
+  // An nsChildView object that was in use can be destroyed without Destroy()
+  // ever being called on it.  So we also need to do a quick, safe cleanup
+  // here (it's too late to just call Destroy(), which can cause crashes).
+  // It's particularly important to make sure widgetDestroyed is called on our
+  // mView -- this method NULLs mView's mGeckoChild, and NULL checks on
+  // mGeckoChild are used throughout the ChildView class to tell if it's safe
+  // to use a ChildView object.
+  [mView widgetDestroyed]; // Safe if mView is nil.
+  mParentWidget = nil;
+  TearDownView(); // Safe if called twice.
 }
 
 
 NS_IMPL_ISUPPORTS_INHERITED2(nsChildView, nsBaseWidget, nsIPluginWidget, nsIKBStateControl)
 
 
 // Utility method for implementing both Create(nsIWidget ...)
 // and Create(nsNativeWidget...)
@@ -955,17 +966,17 @@ NS_IMETHODIMP nsChildView::SetFocus(PRBo
 
 // Set the colormap of the window
 NS_IMETHODIMP nsChildView::SetColorMap(nsColorMap *aColorMap)
 {
   return NS_OK;
 }
 
 
-NS_IMETHODIMP nsChildView::SetMenuBar(nsIMenuBar * aMenuBar)
+NS_IMETHODIMP nsChildView::SetMenuBar(void* aMenuBar)
 {
   return NS_ERROR_FAILURE; // subviews don't have menu bars
 }
 
 
 NS_IMETHODIMP nsChildView::ShowMenuBar(PRBool aShow)
 {
   return NS_ERROR_FAILURE; // subviews don't have menu bars
@@ -1357,16 +1368,61 @@ nsresult nsChildView::SynthesizeNativeKe
     gOverrideKeyboardLayout = currentLayout;
   }
 
   return NS_OK;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
 }
 
+// Used for testing native menu system structure and event handling.
+NS_IMETHODIMP nsChildView::ActivateNativeMenuItemAt(const nsAString& indexString)
+{  
+  NSString* title = [NSString stringWithCharacters:indexString.BeginReading() length:indexString.Length()];
+  NSArray* indexes = [title componentsSeparatedByString:@"|"];
+  unsigned int indexCount = [indexes count];
+  if (indexCount == 0)
+    return NS_OK;
+  
+  NSMenu* currentSubmenu = [NSApp mainMenu];
+  for (unsigned int i = 0; i < (indexCount - 1); i++) {
+    NSMenu* newSubmenu = nil;
+    int targetIndex;
+    // We remove the application menu from consideration for the top-level menu
+    if (i == 0)
+      targetIndex = [[indexes objectAtIndex:i] intValue] + 1;
+    else
+      targetIndex = [[indexes objectAtIndex:i] intValue];
+    int itemCount = [currentSubmenu numberOfItems];
+    if (targetIndex < itemCount) {
+      NSMenuItem* menuItem = [currentSubmenu itemAtIndex:targetIndex];
+      if ([menuItem hasSubmenu])
+        newSubmenu = [menuItem submenu];
+    }
+    
+    if (newSubmenu)
+      currentSubmenu = newSubmenu;
+    else
+      return NS_ERROR_FAILURE;
+  }
+
+  int itemCount = [currentSubmenu numberOfItems];
+  int targetIndex = [[indexes objectAtIndex:(indexCount - 1)] intValue];
+  if (targetIndex < itemCount) {
+    // NSLog(@"Performing action for native menu item titled: %@\n",
+    //       [[currentSubmenu itemAtIndex:targetIndex] title]);
+    [currentSubmenu performActionForItemAtIndex:targetIndex];
+  }
+  else {
+    return NS_ERROR_FAILURE;
+  }
+
+  return NS_OK;
+}
+
 #pragma mark -
 
 
 #ifdef INVALIDATE_DEBUGGING
 
 static Boolean KeyDown(const UInt8 theKey)
 {
   KeyMap map;
@@ -2159,16 +2215,18 @@ NSEvent* gLastDragEvent = nil;
     mKeyPressSent = NO;
 
     // initialization for NSTextInput
     mMarkedRange.location = NSNotFound;
     mMarkedRange.length = 0;
 
     mLastMouseDownEvent = nil;
     mDragService = nsnull;
+
+    mPluginTSMDoc = nil;
   }
   
   // register for things we'll take from other applications
   PR_LOG(sCocoaLog, PR_LOG_ALWAYS, ("ChildView initWithFrame: registering drag types\n"));
   [self registerForDraggedTypes:[NSArray arrayWithObjects:NSFilenamesPboardType,
                                                           NSStringPboardType,
                                                           NSURLPboardType,
                                                           NSFilesPromisePboardType,
@@ -2185,16 +2243,18 @@ NSEvent* gLastDragEvent = nil;
 
 
 - (void)dealloc
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
   [mPendingDirtyRects release];
   [mLastMouseDownEvent release];
+  if (mPluginTSMDoc)
+    ::DeleteTSMDocument(mPluginTSMDoc);
   
   if (sLastViewEntered == self)
     sLastViewEntered = nil;
 
   [super dealloc];    
 
   // This sets the current port to _savePort.
   // todo: Only do if a Quickdraw plugin is present in the hierarchy!
@@ -4429,16 +4489,94 @@ GetUSLayoutCharFromKeyTranslate(UInt32 a
 
   if (outGeckoEvent->message == NS_KEY_PRESS && !outGeckoEvent->isMeta)
     [NSCursor setHiddenUntilMouseMoves:YES];
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
 
+// Called from PluginKeyEventsHandler() (a handler for Carbon TSM events) to
+// process a Carbon key event for the currently focused plugin.  Both Unicode
+// characters and "Mac encoding characters" (in the MBCS or "multibyte
+// character system") are (or should be) available from aKeyEvent, but here we
+// use the MCBS characters.  This is how the WebKit does things, and seems to
+// be what plugins expect.
+- (void) processPluginKeyEvent:(EventRef)aKeyEvent
+{
+  NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
+
+  if (!mGeckoChild)
+    return;
+
+  nsAutoRetainCocoaObject kungFuDeathGrip(self);
+
+  UInt32 numCharCodes;
+  OSStatus status = ::GetEventParameter(aKeyEvent, kEventParamKeyMacCharCodes,
+                                        typeChar, NULL, 0, &numCharCodes, NULL);
+  if (status != noErr)
+    return;
+
+  nsAutoTArray<unsigned char, 3> charCodes;
+  charCodes.SetLength(numCharCodes);
+  status = ::GetEventParameter(aKeyEvent, kEventParamKeyMacCharCodes,
+                              typeChar, NULL, numCharCodes, NULL, charCodes.Elements());
+  if (status != noErr)
+    return;
+
+  UInt32 modifiers;
+  status = ::GetEventParameter(aKeyEvent, kEventParamKeyModifiers,
+                               typeUInt32, NULL, sizeof(modifiers), NULL, &modifiers);
+  if (status != noErr)
+    return;
+
+  UInt32 macKeyCode;
+  status = ::GetEventParameter(aKeyEvent, kEventParamKeyCode,
+                               typeUInt32, NULL, sizeof(macKeyCode), NULL, &macKeyCode);
+  if (status != noErr)
+    return;
+
+  EventRef cloneEvent = ::CopyEvent(aKeyEvent);
+  for (unsigned int i = 0; i < numCharCodes; ++i) {
+    status = ::SetEventParameter(cloneEvent, kEventParamKeyMacCharCodes,
+                                 typeChar, 1, charCodes.Elements() + i);
+    if (status != noErr)
+      break;
+
+    EventRecord eventRec;
+    if (::ConvertEventRefToEventRecord(cloneEvent, &eventRec)) {
+      nsKeyEvent keyDownEvent(PR_TRUE, NS_KEY_DOWN, mGeckoChild);
+
+      PRUint32 keyCode(ConvertMacToGeckoKeyCode(macKeyCode, &keyDownEvent, @""));
+      PRUint32 charCode(charCodes.ElementAt(i));
+
+      keyDownEvent.time       = PR_IntervalNow();
+      keyDownEvent.nativeMsg  = &eventRec;
+      if (IsSpecialGeckoKey(macKeyCode)) {
+        keyDownEvent.keyCode  = keyCode;
+      } else {
+        keyDownEvent.charCode = charCode;
+        keyDownEvent.isChar   = PR_TRUE;
+      }
+      keyDownEvent.isShift   = ((modifiers & shiftKey) != 0);
+      keyDownEvent.isControl = ((modifiers & controlKey) != 0);
+      keyDownEvent.isAlt     = ((modifiers & optionKey) != 0);
+      keyDownEvent.isMeta    = ((modifiers & cmdKey) != 0); // Should never happen
+      mGeckoChild->DispatchWindowEvent(keyDownEvent);
+      if (!mGeckoChild)
+        break;
+    }
+  }
+
+  ::ReleaseEvent(cloneEvent);
+
+  NS_OBJC_END_TRY_ABORT_BLOCK;
+}
+
+
 - (nsRect)sendCompositionEvent:(PRInt32) aEventType
 {
 #ifdef DEBUG_IME
   NSLog(@"****in sendCompositionEvent; type = %d", aEventType);
 #endif
 
   if (!mGeckoChild)
     return nsRect(0, 0, 0, 0);
@@ -5044,19 +5182,73 @@ static const char* ToEscapedString(NSStr
   mKeyDownHandled = PR_FALSE;
 
   return handled;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_RETURN(NO);
 }
 
 
+// Create a TSM document for use with plugins, so that we can support IME in
+// them.  Once it's created, if need be (re)activate it.  Some plugins (e.g.
+// the Flash plugin running in Camino) don't create their own TSM document --
+// without which IME can't work.  Others (e.g. the Flash plugin running in
+// Firefox) create a TSM document that (somehow) makes the input window behave
+// badly when it contains more than one kind of input (say Hiragana and
+// Romaji).  (We can't just use the per-NSView TSM documents that Cocoa
+// provices (those created and managed by the NSTSMInputContext class) -- for
+// some reason TSMProcessRawKeyEvent() doesn't work with them.)
+- (void)activatePluginTSMDoc
+{
+  if (!mPluginTSMDoc) {
+    // Create a TSM document that supports both non-Unicode and Unicode input.
+    // Though [ChildView processPluginKeyEvent:] only sends Mac char codes to
+    // the plugin, this makes the input window behave better when it contains
+    // more than one kind of input (say Hiragana and Romaji).  This is what
+    // the OS does when it creates a TSM document for use by an
+    // NSTSMInputContext class.
+    InterfaceTypeList supportedServices;
+    supportedServices[0] = kTextServiceDocumentInterfaceType;
+    supportedServices[1] = kUnicodeDocumentInterfaceType;
+    ::NewTSMDocument(2, supportedServices, &mPluginTSMDoc, 0);
+    // We'll need to use the "input window".
+    ::UseInputWindow(mPluginTSMDoc, YES);
+    ::ActivateTSMDocument(mPluginTSMDoc);
+  } else if (::TSMGetActiveDocument() != mPluginTSMDoc) {
+    ::ActivateTSMDocument(mPluginTSMDoc);
+  }
+}
+
+
 - (void)keyDown:(NSEvent*)theEvent
 {
+  NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
+
+  // If a plugin has the focus, we need to use an alternate method for
+  // handling NSKeyDown and NSKeyUp events (otherwise Carbon-based IME won't
+  // work in plugins like the Flash plugin).  The same strategy is used by the
+  // WebKit.  See PluginKeyEventsHandler() and [ChildView processPluginKeyEvent:]
+  // for more info.
+  if (mGeckoChild && mIsPluginView) {
+    [self activatePluginTSMDoc];
+    // We use the active TSM document to pass a pointer to ourselves (the
+    // currently focused ChildView) to PluginKeyEventsHandler().  Because this
+    // pointer is weak, we should retain and release ourselves around the call
+    // to TSMProcessRawKeyEvent().
+    nsAutoRetainCocoaObject kungFuDeathGrip(self);
+    ::TSMSetDocumentProperty(mPluginTSMDoc, kFocusedChildViewTSMDocPropertyTag,
+                             sizeof(ChildView *), &self);
+    ::TSMProcessRawKeyEvent([theEvent _eventRef]);
+    ::TSMRemoveDocumentProperty(mPluginTSMDoc, kFocusedChildViewTSMDocPropertyTag);
+    return;
+  }
+
   [self processKeyDownEvent:theEvent keyEquiv:NO];
+
+  NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
 
 static BOOL keyUpAlreadySentKeyDown = NO;
 
 - (void)keyUp:(NSEvent*)theEvent
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
@@ -5066,21 +5258,56 @@ static BOOL keyUpAlreadySentKeyDown = NO
   nsCAutoString str2;
 #endif
   PR_LOG(sCocoaLog, PR_LOG_ALWAYS,
          ("ChildView keyUp: keycode=%d,modifiers=%x,chars=%s,charsIgnoringModifiers=%s\n",
           [theEvent keyCode], [theEvent modifierFlags],
           ToEscapedString([theEvent characters], str1),
           ToEscapedString([theEvent charactersIgnoringModifiers], str2)));
 
+  if (!mGeckoChild)
+    return;
+
+  nsAutoRetainCocoaObject kungFuDeathGrip(self);
+
+  if (mIsPluginView) {
+    // I'm not sure the call to TSMProcessRawKeyEvent() is needed here (though
+    // WebKit makes one).
+    ::TSMProcessRawKeyEvent([theEvent _eventRef]);
+
+    // Don't send a keyUp event if the corresponding keyDown event(s) is/are
+    // still being processed (idea borrowed from WebKit).
+    ChildView *keyDownTarget = nil;
+    OSStatus status = ::TSMGetDocumentProperty(mPluginTSMDoc, kFocusedChildViewTSMDocPropertyTag,
+                                               sizeof(ChildView *), nil, &keyDownTarget);
+    if (status != noErr)
+      keyDownTarget = nil;
+    if (keyDownTarget == self)
+      return;
+
+    // PluginKeyEventsHandler() never sends keyUp events to [ChildView
+    // processPluginKeyEvent:], so we need to send them to Gecko here.  (This
+    // means that when commiting text from IME, several keyDown events may be
+    // sent to Gecko (in processPluginKeyEvent) for one keyUp event here.
+    // But this is how the WebKit does it, and games expect a keyUp event to
+    // be sent when it actually happens (they need to be able to detect how
+    // long a key has been held down) -- which wouldn't be possible if we sent
+    // them from processPluginKeyEvent.)
+    nsKeyEvent keyUpEvent(PR_TRUE, NS_KEY_UP, nsnull);
+    [self convertCocoaKeyEvent:theEvent toGeckoEvent:&keyUpEvent];
+    EventRecord macKeyUpEvent;
+    ConvertCocoaKeyEventToMacEvent(theEvent, macKeyUpEvent);
+    keyUpEvent.nativeMsg = &macKeyUpEvent;
+    mGeckoChild->DispatchWindowEvent(keyUpEvent);
+    return;
+  }
+
   // if we don't have any characters we can't generate a keyUp event
-  if (!mGeckoChild || [[theEvent characters] length] == 0)
-    return;
-
-  nsAutoRetainCocoaObject kungFuDeathGrip(self);
+  if ([[theEvent characters] length] == 0)
+    return;
 
   // Cocoa doesn't send an NSKeyDown event for control-tab on 10.4, so if this
   // is an NSKeyUp event for control-tab, send a down event to gecko first.
   if (!nsToolkit::OnLeopardOrLater() && !keyUpAlreadySentKeyDown &&
       [theEvent modifierFlags] & NSControlKeyMask && [theEvent keyCode] == kTabKeyCode) {
     // We'll need an NSKeyDown copy of our native event so we convert to a gecko event correctly.
     NSEvent* nativeKeyDownEvent = [ChildView makeNewCocoaEventWithType:NSKeyDown fromEvent:theEvent];
 
@@ -5149,22 +5376,26 @@ static BOOL keyUpAlreadySentKeyDown = NO
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_RETURN;
 
   // don't do anything if we don't have a gecko widget
   if (!mGeckoChild)
     return NO;
 
   nsAutoRetainCocoaObject kungFuDeathGrip(self);
 
-  // if we aren't the first responder, pass the event on
+  // If we're not the first responder and the first responder is an NSView
+  // object, pass the event on.  Otherwise (if, for example, the first
+  // responder is an NSWindow object) we should trust the OS to have called
+  // us correctly.
   id firstResponder = [[self window] firstResponder];
   if (firstResponder != self) {
+    // Special handling if the other first responder is a ChildView.
     if ([firstResponder isKindOfClass:[ChildView class]])
       return [(ChildView *)firstResponder performKeyEquivalent:theEvent];
-    else
+    if ([firstResponder isKindOfClass:[NSView class]])
       return [super performKeyEquivalent:theEvent];
   }
 
   // don't process if we're composing, but don't consume the event
   if (nsTSMManager::IsComposing())
     return NO;
 
   // Perform native menu UI feedback even if we stop the event from propagating to it normally.
@@ -5855,8 +6086,77 @@ nsTSMManager::CancelIME()
   // If the composing transaction is still there, KillComposing only kills the
   // composing in TSM. We also need to kill the our composing transaction too.
   NSAttributedString* str = [[NSAttributedString alloc] initWithString:@""];
   [sComposingView insertText:str];
   [str release];
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
+
+
+// Target for text services events sent as the result of calls made to
+// TSMProcessRawKeyEvent() in [ChildView keyDown:] (above) when a plugin has
+// the focus.  The calls to TSMProcessRawKeyEvent() short-circuit Cocoa-based
+// IME (which would otherwise interfere with our efforts) and allow Carbon-
+// based IME to work in plugins (via the NPAPI).  This strategy doesn't cause
+// trouble for plugins that (like the Java Embedding Plugin) bypass the NPAPI
+// to get their keyboard events and do their own Cocoa-based IME.
+OSStatus PluginKeyEventsHandler(EventHandlerCallRef inHandlerRef,
+                                EventRef inEvent, void *userData)
+{
+  id arp = [[NSAutoreleasePool alloc] init];
+
+  TSMDocumentID activeDoc = ::TSMGetActiveDocument();
+  if (!activeDoc) {
+    [arp release];
+    return eventNotHandledErr;
+  }
+
+  ChildView *target = nil;
+  OSStatus status = ::TSMGetDocumentProperty(activeDoc, kFocusedChildViewTSMDocPropertyTag,
+                                             sizeof(ChildView *), nil, &target);
+  if (status != noErr)
+    target = nil;
+  if (!target) {
+    [arp release];
+    return eventNotHandledErr;
+  }
+
+  EventRef keyEvent = NULL;
+  status = ::GetEventParameter(inEvent, kEventParamTextInputSendKeyboardEvent,
+                               typeEventRef, NULL, sizeof(EventRef), NULL, &keyEvent);
+  if ((status != noErr) || !keyEvent) {
+    [arp release];
+    return eventNotHandledErr;
+  }
+
+  [target processPluginKeyEvent:keyEvent];
+
+  [arp release];
+  return noErr;
+}
+
+static EventHandlerRef gPluginKeyEventsHandler = NULL;
+
+// Called from nsAppShell::Init()
+void NS_InstallPluginKeyEventsHandler()
+{
+  if (gPluginKeyEventsHandler)
+    return;
+  static const EventTypeSpec sTSMEvents[] =
+    { { kEventClassTextInput, kEventTextInputUnicodeForKeyEvent } };
+  ::InstallEventHandler(::GetEventDispatcherTarget(),
+                        ::NewEventHandlerUPP(PluginKeyEventsHandler),
+                        GetEventTypeCount(sTSMEvents),
+                        sTSMEvents,
+                        NULL,
+                        &gPluginKeyEventsHandler);
+}
+
+// Called from nsAppShell::Exit()
+void NS_RemovePluginKeyEventsHandler()
+{
+  if (!gPluginKeyEventsHandler)
+    return;
+  ::RemoveEventHandler(gPluginKeyEventsHandler);
+  gPluginKeyEventsHandler = NULL;
+}
diff --git a/widget/src/cocoa/nsCocoaUtils.mm b/widget/src/cocoa/nsCocoaUtils.mm
--- a/widget/src/cocoa/nsCocoaUtils.mm
+++ b/widget/src/cocoa/nsCocoaUtils.mm
@@ -42,16 +42,17 @@
 #include "nsMenuBarX.h"
 #include "nsCocoaWindow.h"
 #include "nsCOMPtr.h"
 #include "nsIInterfaceRequestorUtils.h"
 #include "nsIAppShellService.h"
 #include "nsIXULWindow.h"
 #include "nsIBaseWindow.h"
 #include "nsIServiceManager.h"
+#include "nsMenuUtilsX.h"
 
 float nsCocoaUtils::MenuBarScreenHeight()
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_RETURN;
 
   NSArray* allScreens = [NSScreen screens];
   if ([allScreens count])
     return [[allScreens objectAtIndex:0] frame].size.height;
@@ -186,17 +187,17 @@ nsIWidget* nsCocoaUtils::GetHiddenWindow
 
 
 void nsCocoaUtils::PrepareForNativeAppModalDialog()
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
   // Don't do anything if this is embedding. We'll assume that if there is no hidden
   // window we shouldn't do anything, and that should cover the embedding case.
-  nsIMenuBar* hiddenWindowMenuBar = MenuHelpersX::GetHiddenWindowMenuBar();
+  nsMenuBarX* hiddenWindowMenuBar = nsMenuUtilsX::GetHiddenWindowMenuBar();
   if (!hiddenWindowMenuBar)
     return;
 
   // First put up the hidden window menu bar so that app menu event handling is correct.
   hiddenWindowMenuBar->Paint();
 
   NSMenu* mainMenu = [NSApp mainMenu];
   NS_ASSERTION([mainMenu numberOfItems] > 0, "Main menu does not have any items, something is terribly wrong!");
@@ -207,33 +208,33 @@ void nsCocoaUtils::PrepareForNativeAppMo
   // Swap in our app menu. Note that the event target is whatever window is up when
   // the app modal dialog goes up.
   NSMenuItem* firstMenuItem = [[mainMenu itemAtIndex:0] retain];
   [mainMenu removeItemAtIndex:0];
   [newMenuBar insertItem:firstMenuItem atIndex:0];
   [firstMenuItem release];
   
   // Add standard edit menu
-  [newMenuBar addItem:MenuHelpersX::GetStandardEditMenuItem()];
+  [newMenuBar addItem:nsMenuUtilsX::GetStandardEditMenuItem()];
   
   // Show the new menu bar
   [NSApp setMainMenu:newMenuBar];
   [newMenuBar release];
   
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
 
 void nsCocoaUtils::CleanUpAfterNativeAppModalDialog()
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
   // Don't do anything if this is embedding. We'll assume that if there is no hidden
   // window we shouldn't do anything, and that should cover the embedding case.
-  nsIMenuBar* hiddenWindowMenuBar = MenuHelpersX::GetHiddenWindowMenuBar();
+  nsMenuBarX* hiddenWindowMenuBar = nsMenuUtilsX::GetHiddenWindowMenuBar();
   if (!hiddenWindowMenuBar)
     return;
 
   NSWindow* mainWindow = [NSApp mainWindow];
   if (!mainWindow)
     hiddenWindowMenuBar->Paint();
   else
     [WindowDelegate paintMenubarForWindow:mainWindow];
diff --git a/widget/src/cocoa/nsCocoaWindow.h b/widget/src/cocoa/nsCocoaWindow.h
--- a/widget/src/cocoa/nsCocoaWindow.h
+++ b/widget/src/cocoa/nsCocoaWindow.h
@@ -41,19 +41,21 @@
 #define nsCocoaWindow_h_
 
 #undef DARWIN
 
 #import <Cocoa/Cocoa.h>
 
 #include "nsBaseWidget.h"
 #include "nsPIWidgetCocoa.h"
+#include "nsAutoPtr.h"
 
 class nsCocoaWindow;
 class nsChildView;
+class nsMenuBarX;
 
 typedef struct _nsCocoaWindowList {
   _nsCocoaWindowList() : prev(NULL), window(NULL) {}
   struct _nsCocoaWindowList *prev;
   nsCocoaWindow *window; // Weak
 } nsCocoaWindowList;
 
 
@@ -205,18 +207,18 @@ public:
     virtual nsIWidget*      GetSheetWindowParent(void);
     NS_IMETHOD              AddMouseListener(nsIMouseListener * aListener);
     NS_IMETHOD              AddEventListener(nsIEventListener * aListener);
     NS_IMETHOD              Enable(PRBool aState);
     NS_IMETHOD              IsEnabled(PRBool *aState);
     NS_IMETHOD              SetModal(PRBool aState);
     NS_IMETHOD              IsVisible(PRBool & aState);
     NS_IMETHOD              SetFocus(PRBool aState=PR_FALSE);
-    NS_IMETHOD              SetMenuBar(nsIMenuBar * aMenuBar);
-    virtual nsIMenuBar*     GetMenuBar();
+    NS_IMETHOD              SetMenuBar(void* aMenuBar);
+    virtual nsMenuBarX*     GetMenuBar();
     NS_IMETHOD              ShowMenuBar(PRBool aShow);
     NS_IMETHOD WidgetToScreen(const nsRect& aOldRect, nsRect& aNewRect);
     NS_IMETHOD ScreenToWidget(const nsRect& aOldRect, nsRect& aNewRect);
     
     virtual void* GetNativeData(PRUint32 aDataType) ;
 
     NS_IMETHOD              ConstrainPosition(PRBool aAllowSlop,
                                               PRInt32 *aX, PRInt32 *aY);
@@ -270,17 +272,17 @@ public:
     NS_IMETHOD BeginSecureKeyboardInput();
     NS_IMETHOD EndSecureKeyboardInput();
 
 protected:
   
   nsIWidget*           mParent;         // if we're a popup, this is our parent [WEAK]
   NSWindow*            mWindow;         // our cocoa window [STRONG]
   WindowDelegate*      mDelegate;       // our delegate for processing window msgs [STRONG]
-  nsCOMPtr<nsIMenuBar> mMenuBar;
+  nsRefPtr<nsMenuBarX> mMenuBar;
   NSWindow*            mSheetWindowParent; // if this is a sheet, this is the NSWindow it's attached to
   nsChildView*         mPopupContentView; // if this is a popup, this is its content widget
 
   PRPackedBool         mIsResizing;     // we originated the resize, prevent infinite recursion
   PRPackedBool         mWindowMadeHere; // true if we created the window, false for embedding
   PRPackedBool         mSheetNeedsShow; // if this is a sheet, are we waiting to be shown?
                                         // this is used for sibling sheet contention only
   PRPackedBool         mModal;
diff --git a/widget/src/cocoa/nsCocoaWindow.mm b/widget/src/cocoa/nsCocoaWindow.mm
--- a/widget/src/cocoa/nsCocoaWindow.mm
+++ b/widget/src/cocoa/nsCocoaWindow.mm
@@ -59,16 +59,17 @@
 #include "nsThreadUtils.h"
 #include "nsIFocusController.h"
 #include "nsIWindowWatcher.h"
 #include "nsIServiceManager.h"
 #include "nsIDOMWindow.h"
 #include "nsPIDOMWindow.h"
 #include "nsIDOMElement.h"
 #include "nsMenuBarX.h"
+#include "nsMenuUtilsX.h"
 
 #include "gfxPlatform.h"
 #include "lcms.h"
 
 PRInt32 gXULModalLevel = 0;
 // In principle there should be only one app-modal window at any given time.
 // But sometimes, despite our best efforts, another window appears above the
 // current app-modal window.  So we need to keep a linked list of app-modal
@@ -1112,23 +1113,16 @@ NS_IMETHODIMP nsCocoaWindow::GetChildShe
   }
 
   *_retval = nsnull;
 
   return NS_OK;
 }
 
 
-NS_IMETHODIMP nsCocoaWindow::GetMenuBar(nsIMenuBar** menuBar)
-{
-  *menuBar = mMenuBar;
-  return NS_OK;
-}
-
-
 NS_IMETHODIMP nsCocoaWindow::GetRealParent(nsIWidget** parent)
 {
   *parent = mParent;
   return NS_OK;
 }
 
 
 NS_IMETHODIMP nsCocoaWindow::GetIsSheet(PRBool* isSheet)
@@ -1195,25 +1189,25 @@ nsCocoaWindow::ReportSizeEvent(NSRect *r
 
   nsEventStatus status = nsEventStatus_eIgnore;
   DispatchEvent(&sizeEvent, status);
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
 
-NS_IMETHODIMP nsCocoaWindow::SetMenuBar(nsIMenuBar *aMenuBar)
+NS_IMETHODIMP nsCocoaWindow::SetMenuBar(void *aMenuBar)
 {
   if (mMenuBar)
     mMenuBar->SetParent(nsnull);
-  mMenuBar = aMenuBar;
+  mMenuBar = static_cast<nsMenuBarX*>(aMenuBar);
   
   // We paint the hidden window menu bar if no other menu bar has been painted
   // yet so that some reasonable menu bar is displayed when the app starts up.
-  if (!gSomeMenuBarPainted && mMenuBar && (MenuHelpersX::GetHiddenWindowMenuBar() == mMenuBar))
+  if (!gSomeMenuBarPainted && mMenuBar && (nsMenuUtilsX::GetHiddenWindowMenuBar() == mMenuBar))
     mMenuBar->Paint();
   
   return NS_OK;
 }
 
 
 NS_IMETHODIMP nsCocoaWindow::SetFocus(PRBool aState)
 {
@@ -1259,17 +1253,17 @@ NS_IMETHODIMP nsCocoaWindow::ScreenToWid
   aNewRect.height = aOldRect.height;
 
   return NS_OK;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
 }
 
 
-nsIMenuBar* nsCocoaWindow::GetMenuBar()
+nsMenuBarX* nsCocoaWindow::GetMenuBar()
 {
   return mMenuBar;
 }
 
 
 NS_IMETHODIMP nsCocoaWindow::CaptureRollupEvents(nsIRollupListener * aListener, 
                                                  PRBool aDoCapture, 
                                                  PRBool aConsumeRollupEvent)
@@ -1405,17 +1399,17 @@ NS_IMETHODIMP nsCocoaWindow::EndSecureKe
   // object as a delegate
   id windowDelegate = [aWindow delegate];
   if ([windowDelegate class] != [self class])
     return;
 
   nsCocoaWindow* geckoWidget = [windowDelegate geckoWidget];
   NS_ASSERTION(geckoWidget, "Window delegate not returning a gecko widget!");
   
-  nsIMenuBar* geckoMenuBar = geckoWidget->GetMenuBar();
+  nsMenuBarX* geckoMenuBar = geckoWidget->GetMenuBar();
   if (geckoMenuBar) {
     geckoMenuBar->Paint();
   }
   else {
     // sometimes we don't have a native application menu early in launching
     if (!sApplicationMenu)
       return;
 
@@ -1493,17 +1487,17 @@ NS_IMETHODIMP nsCocoaWindow::EndSecureKe
 - (void)windowDidResignMain:(NSNotification *)aNotification
 {
   RollUpPopups();
 
   // [NSApp _isRunningAppModal] will return true if we're running an OS dialog
   // app modally. If one of those is up then we want it to retain its menu bar.
   if ([NSApp _isRunningAppModal])
     return;
-  nsCOMPtr<nsIMenuBar> hiddenWindowMenuBar = MenuHelpersX::GetHiddenWindowMenuBar();
+  nsRefPtr<nsMenuBarX> hiddenWindowMenuBar = nsMenuUtilsX::GetHiddenWindowMenuBar();
   if (hiddenWindowMenuBar) {
     // printf("painting hidden window menu bar due to window losing main status\n");
     hiddenWindowMenuBar->Paint();
   }
 }
 
 
 - (void)windowDidBecomeKey:(NSNotification *)aNotification
@@ -2244,49 +2238,60 @@ already_AddRefed<nsIDOMElement> GetFocus
       break;
   }
   if (target) {
     switch (type) {
       case NSScrollWheel:
         [target scrollWheel:anEvent];
         break;
       case NSLeftMouseDown:
-        [target mouseDown:anEvent];
-        // If we're in a context menu we don't want the OS to send the coming
-        // NSLeftMouseUp event to NSApp via the window server, but we do want
-        // our ChildView to receive an NSLeftMouseUp event (and to send a Gecko
-        // NS_MOUSE_BUTTON_UP event to the corresponding nsChildView object).
-        // If our NSApp isn't active (i.e. if we're in a context menu raised
-        // by a right mouse down event) when it receives the coming NSLeftMouseUp
-        // via the window server, our app will (in effect) become partially
-        // activated, which has strange side effects:  For example, if another
-        // app's window had the focus, that window will lose the focus and the
-        // other app's main menu will be completely disabled (though it will
-        // continue to be displayed).
-        // A side effect of not allowing the coming NSLeftMouseUp event to be
-        // sent to NSApp via the window server is that our custom context
-        // menus will roll up whenever the user left-clicks on them, whether
-        // or not the left-click hit an active menu item.  This is how native
-        // context menus behave, but wasn't how our custom context menus
-        // behaved previously (on the trunk or e.g. in Firefox 2.0.0.4).
-        // If our ChildView's corresponding nsChildView object doesn't
-        // dispatch an NS_MOUSE_BUTTON_UP event, none of our active menu items
-        // will "work" on an NSLeftMouseUp.
-        if (mIsContextMenu && ![NSApp isActive]) {
+        if ([NSApp isActive]) {
+          [target mouseDown:anEvent];
+        } else if (mIsContextMenu) {
+          [target mouseDown:anEvent];
+          // If we're in a context menu and our NSApp isn't active (i.e. if
+          // we're in a context menu raised by a right mouse-down event), we
+          // don't want the OS to send the coming NSLeftMouseUp event to NSApp
+          // via the window server, but we do want our ChildView to receive an
+          // NSLeftMouseUp event (and to send a Gecko NS_MOUSE_BUTTON_UP event
+          // to the corresponding nsChildView object).  If our NSApp isn't
+          // active when it receives the coming NSLeftMouseUp via the window
+          // server, our app will (in effect) become partially activated,
+          // which has strange side effects:  For example, if another app's
+          // window had the focus, that window will lose the focus and the
+          // other app's main menu will be completely disabled (though it will
+          // continue to be displayed).
+          // A side effect of not allowing the coming NSLeftMouseUp event to be
+          // sent to NSApp via the window server is that our custom context
+          // menus will roll up whenever the user left-clicks on them, whether
+          // or not the left-click hit an active menu item.  This is how native
+          // context menus behave, but wasn't how our custom context menus
+          // behaved previously (on the trunk or e.g. in Firefox 2.0.0.4).
+          // If our ChildView's corresponding nsChildView object doesn't
+          // dispatch an NS_MOUSE_BUTTON_UP event, none of our active menu items
+          // will "work" on an NSLeftMouseUp.
           NSEvent *newEvent = [NSEvent mouseEventWithType:NSLeftMouseUp
                                                  location:windowLocation
                                             modifierFlags:[anEvent modifierFlags]
                                                 timestamp:GetCurrentEventTime()
                                              windowNumber:[self windowNumber]
                                                   context:nil
                                               eventNumber:0
                                                clickCount:1
                                                  pressure:0.0];
           [target mouseUp:newEvent];
           RollUpPopups();
+        } else {
+          // If our NSApp isn't active and we're not a context menu (i.e. if
+          // we're an ordinary popup window), activate us before sending the
+          // event to its target.  This prevents us from being used in the
+          // background, and resolves bmo bug 434097 (another app focus
+          // wierdness bug).
+          [NSApp activateIgnoringOtherApps:YES];
+          [target mouseDown:anEvent];
         }
         break;
       case NSLeftMouseUp:
         [target mouseUp:anEvent];
         break;
       case NSRightMouseDown:
         [target rightMouseDown:anEvent];
         break;
diff --git a/widget/src/cocoa/nsIMenu.h b/widget/src/cocoa/nsIMenu.h
deleted file mode 100644
--- a/widget/src/cocoa/nsIMenu.h
+++ /dev/null
@@ -1,240 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
-/* ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 1998
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#ifndef nsIMenu_h__
-#define nsIMenu_h__
-
-#include "nsISupports.h"
-#include "nsStringFwd.h"
-#include "nsEvent.h"
-
-class nsIMenuBar;
-class nsIMenu;
-class nsIMenuItem;
-class nsIContent;
-class nsIWidget;
-class nsMenuBarX;
-
-
-// 9225136B-3F56-4CA3-92E0-623D5FB8356B
-#define NS_IMENU_IID \
-{ 0x9225136B, 0x3F56, 0x4CA3, \
-  { 0x92, 0xE0, 0x62, 0x3D, 0x5F, 0xB8, 0x35, 0x6B } }
-
-/**
- * Menu widget
- */
-class nsIMenu : public nsISupports {
-
-  public:
-    NS_DECLARE_STATIC_IID_ACCESSOR(NS_IMENU_IID)
-
-  /**
-    * Creates the Menu
-    *
-    */
-    NS_IMETHOD Create(nsISupports * aParent, const nsAString &aLabel, const nsAString &aAccessKey, 
-                      nsMenuBarX* aMenuBar, nsIContent* aNode) = 0;
-
-  /**
-   * Get the Menu's Parent.  This addrefs.
-   *
-   */
-    NS_IMETHOD GetParent(nsISupports *&aParent) = 0;
-
-  /**
-   * Get the Menu label
-   *
-   */
-    NS_IMETHOD GetLabel(nsString &aText) = 0;
-
-  /**
-   * Set the Menu label
-   *
-   */
-    NS_IMETHOD SetLabel(const nsAString &aText) = 0;
-
-  /**
-    * Get the Menu Access Key
-    *
-    */
-  NS_IMETHOD GetAccessKey(nsString &aText) = 0;
-   
-  /**
-    * Set the Menu Access Key
-    *
-    */
-  NS_IMETHOD SetAccessKey(const nsAString &aText) = 0;
-
-  /**
-    * Set the Menu enabled state
-    *
-    */
-  NS_IMETHOD SetEnabled(PRBool aIsEnabled) = 0;
-
-  /**
-    * Get the Menu enabled state
-    *
-    */
-  NS_IMETHOD GetEnabled(PRBool* aIsEnabled) = 0;
-  
-  /**
-    * Adds a Menu Item. Do not use outside of widget menu implementations.
-    * Add and modify menu items via DOM content.
-    *
-    */
-    NS_IMETHOD AddItem(nsISupports* aItem) = 0;
-
-   /**
-    * Returns the number of visible menu items
-    * This includes separators. It does not include hidden items.
-    *
-    */
-    NS_IMETHOD GetVisibleItemCount(PRUint32 &aCount) = 0;
-
-   /**
-    * Returns a Menu or Menu Item at a specified Index.
-    * This includes separators. It does not include hidden items.
-    *
-    */
-    NS_IMETHOD GetVisibleItemAt(const PRUint32 aPos, nsISupports *& aMenuItem) = 0;
-
-   /**
-    * Returns the number of menu items
-    * This includes separators. It -does- include hidden items.
-    *
-    */
-    NS_IMETHOD GetItemCount(PRUint32 &aCount) = 0;
-
-   /**
-    * Returns a Menu or Menu Item at a specified Index.
-    * This includes separators. It -does- include hidden items.
-    *
-    */
-    NS_IMETHOD GetItemAt(const PRUint32 aPos, nsISupports *& aMenuItem) = 0;
-
-   /**
-    * Inserts a Menu Item at a specified Index
-    *
-    */
-    NS_IMETHOD InsertItemAt(const PRUint32 aPos, nsISupports * aMenuItem) = 0;
-
-   /**
-    * Removes an Menu Item from a specified Index
-    *
-    */
-    NS_IMETHOD RemoveItem(const PRUint32 aPos) = 0;
-
-   /**
-    * Removes all the Menu Items
-    *
-    */
-    NS_IMETHOD RemoveAll() = 0;
-
-   /**
-    * Gets Native MenuHandle
-    *
-    */
-    NS_IMETHOD  GetNativeData(void** aData) = 0;
-
-   /**
-    * Sets Native MenuHandle
-    *
-    */
-    NS_IMETHOD  SetNativeData(void* aData) = 0;
-
-   /**
-    * Get menu content
-    *
-    */
-    NS_IMETHOD GetMenuContent(nsIContent ** aMenuContent) = 0;
-    
-   /**
-    * Enable/disable native widget for a particular nsIMenuItem
-    *
-    */
-    NS_IMETHOD ChangeNativeEnabledStatusForMenuItem(nsIMenuItem* aMenuItem,
-                                                    PRBool aEnabled) = 0;
-
-   /**
-    * Retrieve the native menu and the index of the item within that menu.
-    *
-    */
-    NS_IMETHOD GetMenuRefAndItemIndexForMenuItem(nsISupports* aMenuItem,
-                                                 void**       aMenuRef,
-                                                 PRUint16*    aMenuItemIndex) = 0;
-
-   /**
-    * Sets an appropriate icon for the menu.
-    *
-    */
-    NS_IMETHOD SetupIcon() = 0;
-    
-   /**
-    * Menu has been selected
-    *
-    */
-    virtual nsEventStatus MenuSelected(const nsMenuEvent & aMenuEvent) = 0;
-    
-   /**
-    * Menu has been deselected
-    *
-    */
-    virtual void MenuDeselected(const nsMenuEvent & aMenuEvent) = 0;
-
-   /**
-    * Construct menu
-    *
-    */
-    virtual void MenuConstruct(const nsMenuEvent & aMenuEvent, nsIWidget * aParentWindow, void * aMenuNode) = 0;
-
-   /**
-    * Destruct menu
-    *
-    */
-    virtual void MenuDestruct(const nsMenuEvent & aMenuEvent) = 0;
-    
-   /**
-    * Set rebuild
-    *
-    */
-    virtual void SetRebuild(PRBool aMenuEvent) = 0;
-};
-
-NS_DEFINE_STATIC_IID_ACCESSOR(nsIMenu, NS_IMENU_IID)
-
-#endif
diff --git a/widget/src/cocoa/nsIMenuItem.h b/widget/src/cocoa/nsIMenuItem.h
deleted file mode 100644
--- a/widget/src/cocoa/nsIMenuItem.h
+++ /dev/null
@@ -1,156 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
-/* ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 1998
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#ifndef nsIMenuItem_h__
-#define nsIMenuItem_h__
-
-#include "prtypes.h"
-#include "nsISupports.h"
-#include "nsString.h"
-
-#include "nsIDOMElement.h"
-
-// 33FA04E3-EAFE-4DD1-AFB3-B3BC8C712716
-#define NS_IMENUITEM_IID \
-{ 0x33FA04E3, 0xEAFE, 0x4DD1, \
-  { 0xAF, 0xB3, 0xB3, 0xBC, 0x8C, 0x71, 0x27, 0x16 } }
-
-class nsIMenu;
-class nsIWidget;
-class nsIContent;
-class nsMenuBarX;
-
-enum {
-  knsMenuItemNoModifier      = 0,
-  knsMenuItemShiftModifier   = (1 << 0),
-  knsMenuItemAltModifier     = (1 << 1),
-  knsMenuItemControlModifier = (1 << 2),
-  knsMenuItemCommandModifier = (1 << 3)
-};
-
-/**
- * MenuItem widget
- */
-class nsIMenuItem : public nsISupports {
-
-  public:
-    NS_DECLARE_STATIC_IID_ACCESSOR(NS_IMENUITEM_IID)
-
-    enum EMenuItemType { eRegular = 0, eCheckbox, eRadio, eSeparator} ;
-
-   /**
-    * Creates the MenuItem
-    *
-    */
-    NS_IMETHOD Create(nsIMenu* aParent, const nsString & aLabel, EMenuItemType aItemType,
-                      nsMenuBarX* aMenuBar, nsIContent* aNode) = 0;
-
-   /**
-    * Get the MenuItem label
-    *
-    */
-    NS_IMETHOD GetLabel(nsString &aText) = 0;
-
-    /**
-    * Get the Menu shortcut char
-    *
-    */
-    NS_IMETHOD GetShortcutChar(nsString &aText) = 0;
-
-   /**
-    * Gets whether the item is enabled or disabled
-    *
-    */
-    NS_IMETHOD GetEnabled(PRBool *aIsEnabled) = 0;
-
-   /**
-    * Sets whether the item is checked or not
-    *
-    */
-    NS_IMETHOD SetChecked(PRBool aIsEnabled) = 0;
-
-   /**
-    * Gets whether the item is checked or not
-    *
-    */
-    NS_IMETHOD GetChecked(PRBool *aIsEnabled) = 0;
-
-   /**
-    * Gets whether the item is a checkbox or radio
-    *
-    */
-    NS_IMETHOD GetMenuItemType(EMenuItemType *aType) = 0;
-    
-   /**
-    * Gets Native Menu Handle
-    *
-    */
-    NS_IMETHOD GetNativeData(void*& aData) = 0;
-
-   /**
-    * Indicates whether it is a separator
-    *
-    */
-    NS_IMETHOD IsSeparator(PRBool & aIsSep) = 0;
-
-   /**
-    * Executes the "cached" JavaScript Command 
-    * @return NS_OK if the command was executed properly, otherwise an error code
-    */
-    NS_IMETHOD DoCommand() = 0;
-    
-    /**
-     * Sends a DOM event to the menu item's content node 
-     * @return NS_OK if the event was sent properly, otherwise an error code
-     */
-    NS_IMETHOD DispatchDOMEvent(const nsString &eventName, PRBool *preventDefaultCalled) = 0;
-
-   /**
-    * Sets an appropriate icon for the menu item.
-    */
-    NS_IMETHOD SetupIcon() = 0;
-
-    /**
-     * Get GetMenuItemContent
-     *
-     */
-    NS_IMETHOD GetMenuItemContent(nsIContent ** aMenuItemContent) = 0;
-};
-
-NS_DEFINE_STATIC_IID_ACCESSOR(nsIMenuItem, NS_IMENUITEM_IID)
-
-#endif
diff --git a/widget/src/cocoa/nsMenuBarX.h b/widget/src/cocoa/nsMenuBarX.h
--- a/widget/src/cocoa/nsMenuBarX.h
+++ b/widget/src/cocoa/nsMenuBarX.h
@@ -34,129 +34,109 @@
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 #ifndef nsMenuBarX_h_
 #define nsMenuBarX_h_
 
-#include "nsIMenuBar.h"
-#include "nsObjCExceptions.h"
+#import <Cocoa/Cocoa.h>
+
+#include "nsMenuBaseX.h"
 #include "nsIMutationObserver.h"
-#include "nsCOMArray.h"
 #include "nsHashtable.h"
-#include "nsWeakReference.h"
-#include "nsIContent.h"
+#include "nsINativeMenuService.h"
+#include "nsAutoPtr.h"
 
-#import  <Carbon/Carbon.h>
-#import  <Cocoa/Cocoa.h>
+class nsMenuX;
+class nsMenuItemX;
+class nsChangeObserver;
+class nsIWidget;
+class nsIContent;
+class nsIDocument;
 
-class nsIWidget;
-class nsIDocument;
-class nsIDOMNode;
-class nsChangeObserver;
 
-extern "C" MenuRef _NSGetCarbonMenu(NSMenu* aMenu);
-
-PRBool NodeIsHiddenOrCollapsed(nsIContent* inContent);
-
-namespace MenuHelpersX
+// The native menu service for creating native menu bars.
+class nsNativeMenuServiceX : public nsINativeMenuService
 {
-  nsEventStatus DispatchCommandTo(nsIContent* aTargetContent);
-  NSString* CreateTruncatedCocoaLabel(const nsString& itemLabel);
-  PRUint8 GeckoModifiersForNodeAttribute(const nsString& modifiersAttribute);
-  unsigned int MacModifiersForGeckoModifiers(PRUint8 geckoModifiers);
-  nsIMenuBar* GetHiddenWindowMenuBar();
-  NSMenuItem* GetStandardEditMenuItem();
-}
+public:
+  NS_DECL_ISUPPORTS
+  NS_IMETHOD CreateNativeMenuBar(nsIWidget* aParent, nsIContent* aMenuBarNode);
+};
 
 
 // Objective-C class used to allow us to have keyboard commands
 // look like they are doing something but actually do nothing.
 // We allow mouse actions to work normally.
 @interface GeckoNSMenu : NSMenu
 {
 }
-- (BOOL)performKeyEquivalent:(NSEvent *)theEvent;
-- (void)actOnKeyEquivalent:(NSEvent *)theEvent;
+- (BOOL)performKeyEquivalent:(NSEvent*)theEvent;
+- (void)actOnKeyEquivalent:(NSEvent*)theEvent;
 - (void)performMenuUserInterfaceEffectsForEvent:(NSEvent*)theEvent;
 @end
 
 
 // Objective-C class used as action target for menu items
 @interface NativeMenuItemTarget : NSObject
 {
 }
 -(IBAction)menuItemHit:(id)sender;
 @end
 
 
-//
-// Native menu bar wrapper
-//
-
-class nsMenuBarX : public nsIMenuBar,
-                   public nsIMutationObserver,
-                   public nsSupportsWeakReference
+// Once instantiated, this object lives until its DOM node or its parent window is destroyed.
+// Do not hold references to this, they can become invalid any time the DOM node can be destroyed.
+class nsMenuBarX : public nsMenuObjectX,
+                   public nsIMutationObserver
 {
 public:
-    nsMenuBarX();
-    virtual ~nsMenuBarX();
+  nsMenuBarX();
+  virtual ~nsMenuBarX();
 
-    // |NSMenuItem|s target Objective-C objects
-    static NativeMenuItemTarget* sNativeEventTarget;
-    
-    static nsMenuBarX* sLastGeckoMenuBarPainted;
-    
-    NS_DECL_ISUPPORTS
+  static NativeMenuItemTarget* sNativeEventTarget;
+  static nsMenuBarX*           sLastGeckoMenuBarPainted;
 
-    // nsIMutationObserver
-    NS_DECL_NSIMUTATIONOBSERVER
+  // The following content nodes have been removed from the menu system.
+  // We save them here for use in command handling.
+  nsCOMPtr<nsIContent> mAboutItemContent;
+  nsCOMPtr<nsIContent> mPrefItemContent;
+  nsCOMPtr<nsIContent> mQuitItemContent;
 
-    // nsIMenuBar Methods
-    NS_IMETHOD Create(nsIWidget * aParent);
-    NS_IMETHOD GetParent(nsIWidget *&aParent);
-    NS_IMETHOD SetParent(nsIWidget * aParent);
-    NS_IMETHOD AddMenu(nsIMenu * aMenu);
-    NS_IMETHOD GetMenuCount(PRUint32 &aCount);
-    NS_IMETHOD GetMenuAt(const PRUint32 aCount, nsIMenu *& aMenu);
-    NS_IMETHOD InsertMenuAt(const PRUint32 aCount, nsIMenu *& aMenu);
-    NS_IMETHOD RemoveMenu(const PRUint32 aCount);
-    NS_IMETHOD RemoveAll();
-    NS_IMETHOD GetNativeData(void*& aData);
-    NS_IMETHOD Paint();
-    NS_IMETHOD SetNativeData(void* aData);
-    NS_IMETHOD MenuConstruct(const nsMenuEvent & aMenuEvent, nsIWidget * aParentWindow, void * aMenuNode);
+  NS_DECL_ISUPPORTS
+  NS_DECL_NSIMUTATIONOBSERVER
 
-    PRUint32 RegisterForCommand(nsIMenuItem* aItem);
-    void UnregisterCommand(PRUint32 aCommandID);
-    nsIMenuItem* GetMenuItemForCommandID(PRUint32 inCommandID);
+  // nsMenuObjectX
+  void*             NativeData()     {return (void*)mRootMenu;}
+  nsMenuObjectTypeX MenuObjectType() {return eMenuBarObjectType;}
 
-    void RegisterForContentChanges(nsIContent* aContent, nsChangeObserver* aMenuObject);
-    void UnregisterForContentChanges(nsIContent* aContent);
-    nsChangeObserver* LookupContentChangeObserver(nsIContent* aContent);
+  // nsMenuBarX
+  nsresult          Create(nsIWidget* aParent, nsIContent* aContent);
+  void              SetParent(nsIWidget* aParent);
+  void              RegisterForContentChanges(nsIContent* aContent, nsChangeObserver* aMenuObject);
+  void              UnregisterForContentChanges(nsIContent* aContent);
+  PRUint32          RegisterForCommand(nsMenuItemX* aItem);
+  void              UnregisterCommand(PRUint32 aCommandID);
+  PRUint32          GetMenuCount();
+  nsMenuX*          GetMenuAt(PRUint32 aIndex);
+  nsMenuItemX*      GetMenuItemForCommandID(PRUint32 inCommandID);
+  nsresult          Paint();
 
-    nsCOMPtr<nsIContent>    mAboutItemContent;    // holds the content node for the about item that has
-                                                  //   been removed from the menubar
-    nsCOMPtr<nsIContent>    mPrefItemContent;     // as above, but for prefs
-    nsCOMPtr<nsIContent>    mQuitItemContent;     // as above, but for quit
 protected:
-    // Make our menubar conform to Aqua UI guidelines
-    void AquifyMenuBar();
-    void HideItem(nsIDOMDocument* inDoc, const nsAString & inID, nsIContent** outHiddenNode);
+  nsresult          AddMenu(nsMenuX* aMenu);
+  void              RemoveMenu(PRUint32 aIndex);
+  nsChangeObserver* LookupContentChangeObserver(nsIContent* aContent);
+  void              HideItem(nsIDOMDocument* inDoc, const nsAString & inID, nsIContent** outHiddenNode);
+  void              AquifyMenuBar();
+  NSMenuItem*       CreateNativeAppMenuItem(nsMenuX* inMenu, const nsAString& nodeID, SEL action,
+                                            int tag, NativeMenuItemTarget* target);
+  nsresult          CreateApplicationMenu(nsMenuX* inMenu);
 
-    // build the Application menu shared by all menu bars.
-    NSMenuItem* CreateNativeAppMenuItem(nsIMenu* inMenu, const nsAString& nodeID, SEL action,
-                                                    int tag, NativeMenuItemTarget* target);
-    nsresult CreateApplicationMenu(nsIMenu* inMenu);
-
-    nsCOMArray<nsIMenu>     mMenusArray;          // holds refs
-    nsCOMPtr<nsIContent>    mMenuBarContent;      // menubar content node, strong ref
-    nsIWidget*              mParent;              // weak ref
-    PRBool                  mIsMenuBarAdded;
-    PRUint32                mCurrentCommandID;    // unique command id (per menu-bar) to give to next item that asks
-    nsIDocument*            mDocument;            // pointer to document
-    GeckoNSMenu*            mRootMenu;            // root menu, representing entire menu bar
-    nsHashtable             mObserverTable;       // stores observers for content change notification
+  nsTArray< nsAutoPtr<nsMenuX> > mMenuArray;
+  nsIWidget*         mParent;              // [weak]
+  PRUint32           mCurrentCommandID;    // unique command id (per menu-bar) to give to next item that asks
+  nsIDocument*       mDocument;            // pointer to document
+  GeckoNSMenu*       mRootMenu;            // root menu, representing entire menu bar
+  nsHashtable        mObserverTable;       // stores observers for content change notification
 };
 
 #endif // nsMenuBarX_h_
diff --git a/widget/src/cocoa/nsMenuBarX.mm b/widget/src/cocoa/nsMenuBarX.mm
--- a/widget/src/cocoa/nsMenuBarX.mm
+++ b/widget/src/cocoa/nsMenuBarX.mm
@@ -31,47 +31,38 @@
  * use your version of this file under the terms of the MPL, indicate your
  * decision by deleting the provisions above and replace them with the notice
  * and other provisions required by the GPL or the LGPL. If you do not delete
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
-#include "nsCOMPtr.h"
-#include "nsIServiceManager.h"
-#include "nsIComponentManager.h"
-#include "nsINameSpaceManager.h"
-#include "nsIMenu.h"
-#include "nsIMenuItem.h"
-#include "nsIContent.h"
-
 #include "nsMenuBarX.h"
 #include "nsMenuX.h"
-#include "nsChildView.h"
+#include "nsMenuItemX.h"
+#include "nsMenuUtilsX.h"
 #include "nsCocoaUtils.h"
 #include "nsCocoaWindow.h"
 
-#include "nsISupports.h"
+#include "nsCOMPtr.h"
+#include "nsString.h"
+#include "nsWidgetAtoms.h"
+#include "nsGUIEvent.h"
+#include "nsObjCExceptions.h"
+#include "nsHashtable.h"
+#include "nsThreadUtils.h"
+
+#include "nsIContent.h"
 #include "nsIWidget.h"
-#include "nsString.h"
-#include "nsIStringBundle.h"
 #include "nsIDocument.h"
-#include "nsIMutationObserver.h"
+#include "nsIDOMDocument.h"
+#include "nsIDOMElement.h"
 
-#include "nsIDOMDocument.h"
-#include "nsWidgetAtoms.h"
-
-#include "nsGUIEvent.h"
-
-// CIDs
-#include "nsWidgetsCID.h"
-static NS_DEFINE_CID(kMenuCID, NS_MENU_CID);
-
-NS_IMPL_ISUPPORTS3(nsMenuBarX, nsIMenuBar, nsIMutationObserver, nsISupportsWeakReference)
+NS_IMPL_ISUPPORTS1(nsMenuBarX, nsIMutationObserver)
 
 NativeMenuItemTarget* nsMenuBarX::sNativeEventTarget = nil;
 nsMenuBarX* nsMenuBarX::sLastGeckoMenuBarPainted = nsnull;
 NSMenu* sApplicationMenu = nil;
 BOOL gSomeMenuBarPainted = NO;
 
 // We keep references to the first quit and pref item content nodes we find, which
 // will be from the hidden window. We use these when the document for the current
@@ -87,28 +78,32 @@ enum {
 enum {
   eCommand_ID_About = 1,
   eCommand_ID_Prefs = 2,
   eCommand_ID_Quit  = 3,
   eCommand_ID_Last  = 4
 };
 
 
-PRBool NodeIsHiddenOrCollapsed(nsIContent* inContent)
+NS_IMPL_ISUPPORTS1(nsNativeMenuServiceX, nsINativeMenuService)
+
+NS_IMETHODIMP nsNativeMenuServiceX::CreateNativeMenuBar(nsIWidget* aParent, nsIContent* aMenuBarNode)
 {
-  return (inContent->AttrValueIs(kNameSpaceID_None, nsWidgetAtoms::hidden,
-                                 nsWidgetAtoms::_true, eCaseMatters) ||
-          inContent->AttrValueIs(kNameSpaceID_None, nsWidgetAtoms::collapsed,
-                                 nsWidgetAtoms::_true, eCaseMatters));
+  NS_ASSERTION(NS_IsMainThread(), "Attempting to create native menu bar on wrong thread!");
+
+  nsRefPtr<nsMenuBarX> mb = new nsMenuBarX();
+  if (!mb)
+    return NS_ERROR_OUT_OF_MEMORY;
+
+  return mb->Create(aParent, aMenuBarNode);
 }
 
 
 nsMenuBarX::nsMenuBarX()
 : mParent(nsnull),
-  mIsMenuBarAdded(PR_FALSE),
   mCurrentCommandID(eCommand_ID_Last),
   mDocument(nsnull)
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
   mRootMenu = [[GeckoNSMenu alloc] initWithTitle:@"MainMenuBar"];
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
@@ -116,43 +111,197 @@ nsMenuBarX::nsMenuBarX()
 
 
 nsMenuBarX::~nsMenuBarX()
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
   if (nsMenuBarX::sLastGeckoMenuBarPainted == this)
     nsMenuBarX::sLastGeckoMenuBarPainted = nsnull;
-
-  mMenusArray.Clear(); // release all menus
 
   // the quit/pref items of a random window might have been used if there was no
   // hidden window, thus we need to invalidate the weak references.
   if (sAboutItemContent == mAboutItemContent)
     sAboutItemContent = nsnull;
   if (sQuitItemContent == mQuitItemContent)
     sQuitItemContent = nsnull;
   if (sPrefItemContent == mPrefItemContent)
     sPrefItemContent = nsnull;
 
   // make sure we unregister ourselves as a document observer
   if (mDocument)
     mDocument->RemoveMutationObserver(this);
-  
+
+  // We have to manually clear the array here because clearing causes menu items
+  // to call back into the menu bar to unregister themselves. We don't want to
+  // depend on member variable ordering to ensure that the array gets cleared
+  // before the registration hash table is destroyed.
+  mMenuArray.Clear();
+
   [mRootMenu release];
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
 
-// Do what's necessary to conform to the Aqua guidelines for menus.
-void
-nsMenuBarX::AquifyMenuBar()
+nsresult nsMenuBarX::Create(nsIWidget* aParent, nsIContent* aContent)
 {
-  nsCOMPtr<nsIDOMDocument> domDoc(do_QueryInterface(mMenuBarContent->GetDocument()));
+  if (!aParent || !aContent)
+    return NS_ERROR_INVALID_ARG;
+
+  mParent = aParent;
+  mContent = aContent;
+
+  AquifyMenuBar();
+
+  nsIDocument* doc = aContent->GetOwnerDoc();
+  if (!doc)
+    return NS_ERROR_FAILURE;
+  doc->AddMutationObserver(this);
+  mDocument = doc;
+
+  PRUint32 count = mContent->GetChildCount();
+  for (PRUint32 i = 0; i < count; i++) { 
+    nsIContent *menuContent = mContent->GetChildAt(i);
+    if (menuContent) {
+      if (menuContent->Tag() == nsWidgetAtoms::menu &&
+          menuContent->IsNodeOfType(nsINode::eXUL)) {
+        nsAutoString menuName;
+        menuContent->GetAttr(kNameSpaceID_None, nsWidgetAtoms::label, menuName);
+        nsMenuX* newMenu = new nsMenuX();
+        if (newMenu) {
+          nsresult rv = newMenu->Create(this, menuName, this, menuContent);
+          if (NS_SUCCEEDED(rv))
+            AddMenu(newMenu);
+          else
+            delete newMenu;
+        }
+      }
+    }
+  }
+
+  // Give this to the parent window. The parent takes ownership.
+  return mParent->SetMenuBar(this);
+}
+
+
+PRUint32 nsMenuBarX::GetMenuCount()
+{
+  return mMenuArray.Length();
+}
+
+
+nsresult nsMenuBarX::AddMenu(nsMenuX* aMenu)
+{
+  NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;
+
+  // If we haven't created a global Application menu yet, do it.
+  if (!sApplicationMenu) {
+    nsresult rv = NS_OK; // avoid warning about rv being unused
+    rv = CreateApplicationMenu(aMenu);
+    NS_ASSERTION(NS_SUCCEEDED(rv), "Can't create Application menu");
+
+    // Hook the new Application menu up to the menu bar.
+    NSMenu* mainMenu = [NSApp mainMenu];
+    NS_ASSERTION([mainMenu numberOfItems] > 0, "Main menu does not have any items, something is terribly wrong!");
+    [[mainMenu itemAtIndex:0] setSubmenu:sApplicationMenu];
+  }
+
+  // keep track of all added menus
+  mMenuArray.AppendElement(aMenu); // owner
+
+  NSMenu* nativeMenu = (NSMenu*)aMenu->NativeData();
+  nsIContent* menuContent = aMenu->Content();
+  if (menuContent->GetChildCount() > 0 &&
+      !nsMenuUtilsX::NodeIsHiddenOrCollapsed(menuContent)) {
+    NSMenuItem* newMenuItem = [[[NSMenuItem alloc] initWithTitle:[nativeMenu title] action:NULL keyEquivalent:@""] autorelease];
+    [mRootMenu addItem:newMenuItem];
+    [newMenuItem setSubmenu:nativeMenu];
+  }
+
+  return NS_OK;
+
+  NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
+}
+
+
+void nsMenuBarX::RemoveMenu(PRUint32 aIndex)
+{
+  NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
+
+  NS_ASSERTION(aIndex < mMenuArray.Length(), "Attempting submenu removal with bad index!");
+
+  // Our native menu and our internal menu object array might be out of sync.
+  // This happens, for example, when a submenu is hidden. Because of this we
+  // should not assume that a native submenu is hooked up.
+  [mRootMenu removeItem:(mMenuArray[aIndex]->NativeMenuItem())];
+  mMenuArray.RemoveElementAt(aIndex);
+
+  NS_OBJC_END_TRY_ABORT_BLOCK;
+}
+
+
+nsMenuX* nsMenuBarX::GetMenuAt(PRUint32 aIndex)
+{
+  if (mMenuArray.Length() <= aIndex) {
+    NS_ERROR("Requesting menu at invalid index!");
+    return NULL;
+  }
+  return mMenuArray[aIndex];
+}
+
+
+nsresult nsMenuBarX::Paint()
+{
+  NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;
+  
+  NSMenu* mainMenu = [NSApp mainMenu];
+  NS_ASSERTION([mainMenu numberOfItems] > 0, "Main menu does not have any items, something is terribly wrong!");
+
+  // Swap out first item into incoming menu bar. We have to keep the same menu item for the
+  // Application menu and its submenu is global so we keep passing it along.
+  NSMenuItem* firstMenuItem = [[mainMenu itemAtIndex:0] retain];
+  [mainMenu removeItemAtIndex:0];
+  [mRootMenu insertItem:firstMenuItem atIndex:0];
+  [firstMenuItem release];
+
+  // Set menu bar and event target.
+  [NSApp setMainMenu:mRootMenu];
+  nsMenuBarX::sLastGeckoMenuBarPainted = this;
+
+  gSomeMenuBarPainted = YES;
+
+  return NS_OK;
+
+  NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
+}
+
+
+// Hide the item in the menu by setting the 'hidden' attribute. Returns it in |outHiddenNode| so
+// the caller can hang onto it if they so choose. It is acceptable to pass nsull
+// for |outHiddenNode| if the caller doesn't care about the hidden node.
+void nsMenuBarX::HideItem(nsIDOMDocument* inDoc, const nsAString & inID, nsIContent** outHiddenNode)
+{
+  nsCOMPtr<nsIDOMElement> menuItem;
+  inDoc->GetElementById(inID, getter_AddRefs(menuItem));  
+  nsCOMPtr<nsIContent> menuContent(do_QueryInterface(menuItem));
+  if (menuContent) {
+    menuContent->SetAttr(kNameSpaceID_None, nsWidgetAtoms::hidden, NS_LITERAL_STRING("true"), PR_FALSE);
+    if (outHiddenNode) {
+      *outHiddenNode = menuContent.get();
+      NS_IF_ADDREF(*outHiddenNode);
+    }
+  }
+}
+
+
+// Do what is necessary to conform to the Aqua guidelines for menus.
+void nsMenuBarX::AquifyMenuBar()
+{
+  nsCOMPtr<nsIDOMDocument> domDoc(do_QueryInterface(mContent->GetDocument()));
   if (domDoc) {
     // remove the "About..." item and its separator
     HideItem(domDoc, NS_LITERAL_STRING("aboutSeparator"), nsnull);
     HideItem(domDoc, NS_LITERAL_STRING("aboutName"), getter_AddRefs(mAboutItemContent));
     if (!sAboutItemContent)
       sAboutItemContent = mAboutItemContent;
 
     // remove quit item and its separator
@@ -172,155 +321,23 @@ nsMenuBarX::AquifyMenuBar()
     HideItem(domDoc, NS_LITERAL_STRING("menu_mac_services"), nsnull);
     HideItem(domDoc, NS_LITERAL_STRING("menu_mac_hide_app"), nsnull);
     HideItem(domDoc, NS_LITERAL_STRING("menu_mac_hide_others"), nsnull);
     HideItem(domDoc, NS_LITERAL_STRING("menu_mac_show_all"), nsnull);
   }
 }
 
 
-// Hide the item in the menu by setting the 'hidden' attribute. Returns it in |outHiddenNode| so
-// the caller can hang onto it if they so choose. It is acceptable to pass nsull
-// for |outHiddenNode| if the caller doesn't care about the hidden node.
-void
-nsMenuBarX::HideItem(nsIDOMDocument* inDoc, const nsAString & inID, nsIContent** outHiddenNode)
-{
-  nsCOMPtr<nsIDOMElement> menuItem;
-  inDoc->GetElementById(inID, getter_AddRefs(menuItem));  
-  nsCOMPtr<nsIContent> menuContent(do_QueryInterface(menuItem));
-  if (menuContent) {
-    menuContent->SetAttr(kNameSpaceID_None, nsWidgetAtoms::hidden, NS_LITERAL_STRING("true"), PR_FALSE);
-    if (outHiddenNode) {
-      *outHiddenNode = menuContent.get();
-      NS_IF_ADDREF(*outHiddenNode);
-    }
-  }
-}
-
-
-NS_IMETHODIMP
-nsMenuBarX::MenuConstruct(const nsMenuEvent & aMenuEvent, nsIWidget* aParentWindow, void * aMenubarNode)
-{
-  nsIDOMNode* domNode  = static_cast<nsIDOMNode*>(aMenubarNode);
-  mMenuBarContent = do_QueryInterface(domNode); // strong ref
-  NS_ASSERTION(mMenuBarContent, "No content specified for this menubar");
-  if (!mMenuBarContent)
-    return NS_ERROR_FAILURE;
-
-  SetParent(aParentWindow);
-
-  AquifyMenuBar();
-
-  nsCOMPtr<nsIDOMDocument> domDoc;
-  domNode->GetOwnerDocument(getter_AddRefs(domDoc));
-  nsCOMPtr<nsIDocument> doc(do_QueryInterface(domDoc));
-  if (!doc)
-    return NS_ERROR_FAILURE;
-  doc->AddMutationObserver(this);
-  mDocument = doc;
-
-  PRUint32 count = mMenuBarContent->GetChildCount();
-  for (PRUint32 i = 0; i < count; i++) { 
-    nsIContent *menu = mMenuBarContent->GetChildAt(i);
-    if (menu) {
-      if (menu->Tag() == nsWidgetAtoms::menu &&
-          menu->IsNodeOfType(nsINode::eXUL)) {
-        nsAutoString menuName;
-        nsAutoString menuAccessKey(NS_LITERAL_STRING(" "));
-        menu->GetAttr(kNameSpaceID_None, nsWidgetAtoms::label, menuName);
-        menu->GetAttr(kNameSpaceID_None, nsWidgetAtoms::accesskey, menuAccessKey);
-
-        // Create nsMenu, the menubar will own it
-        nsCOMPtr<nsIMenu> pnsMenu(do_CreateInstance(kMenuCID));
-        if (pnsMenu) {
-          pnsMenu->Create(static_cast<nsIMenuBar*>(this), menuName, menuAccessKey, this, menu);
-          AddMenu(pnsMenu);
-        }
-      } 
-    }
-  }
-  
-  // Give the aParentWindow this nsMenuBarX to hold onto.
-  // The parent takes ownership.
-  aParentWindow->SetMenuBar(this);
-  
-  return NS_OK;
-}
-
-
-NS_IMETHODIMP nsMenuBarX::Create(nsIWidget *aParent)
-{
-  SetParent(aParent);
-  return NS_OK;
-}
-
-
-NS_IMETHODIMP nsMenuBarX::GetParent(nsIWidget *&aParent)
-{
-  NS_IF_ADDREF(aParent = mParent);
-  return NS_OK;
-}
-
-
-NS_IMETHODIMP nsMenuBarX::SetParent(nsIWidget *aParent)
-{
-  mParent = aParent; // weak ref  
-  return NS_OK;
-}
-
-
-NS_IMETHODIMP nsMenuBarX::AddMenu(nsIMenu * aMenu)
-{
-  NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;
-
-  // If we haven't created a global Application menu yet, do it.
-  if (!sApplicationMenu) {
-    nsresult rv = NS_OK; // avoid warning about rv being unused
-    rv = CreateApplicationMenu(aMenu);
-    NS_ASSERTION(NS_SUCCEEDED(rv), "Can't create Application menu");
-
-    // Hook the new Application menu up to the menu bar.
-    NSMenu* mainMenu = [NSApp mainMenu];
-    NS_ASSERTION([mainMenu numberOfItems] > 0, "Main menu does not have any items, something is terribly wrong!");
-    [[mainMenu itemAtIndex:0] setSubmenu:sApplicationMenu];
-  }
-
-  // keep track of all added menus
-  mMenusArray.AppendObject(aMenu); // owner
-  
-  NSMenu* nativeMenu = NULL;
-  aMenu->GetNativeData((void**)&nativeMenu);
-  
-  nsCOMPtr<nsIContent> menu;
-  aMenu->GetMenuContent(getter_AddRefs(menu));
-  if (menu->GetChildCount() > 0 &&
-      !NodeIsHiddenOrCollapsed(menu)) {
-    NSMenuItem* newMenuItem = [[[NSMenuItem alloc] initWithTitle:[nativeMenu title] action:NULL keyEquivalent:@""] autorelease];
-    [mRootMenu addItem:newMenuItem];
-    [newMenuItem setSubmenu:nativeMenu];
-  }
-  
-  return NS_OK;
-
-  NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
-}
-
-
 // for creating menu items destined for the Application menu
-NSMenuItem* nsMenuBarX::CreateNativeAppMenuItem(nsIMenu* inMenu, const nsAString& nodeID, SEL action,
+NSMenuItem* nsMenuBarX::CreateNativeAppMenuItem(nsMenuX* inMenu, const nsAString& nodeID, SEL action,
                                                 int tag, NativeMenuItemTarget* target)
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NIL;
 
-  nsCOMPtr<nsIContent> menu;
-  inMenu->GetMenuContent(getter_AddRefs(menu));
-  if (!menu)
-    return nil;
-
-  nsCOMPtr<nsIDocument> doc = menu->GetDocument();
+  nsCOMPtr<nsIDocument> doc = inMenu->Content()->GetDocument();
   if (!doc)
     return nil;
 
   nsCOMPtr<nsIDOMDocument> domdoc(do_QueryInterface(doc));
   if (!domdoc)
     return nil;
 
   // Get information from the gecko menu item
@@ -351,18 +368,18 @@ NSMenuItem* nsMenuBarX::CreateNativeAppM
       nsAutoString keyChar(NS_LITERAL_STRING(" "));
       keyContent->GetAttr(kNameSpaceID_None, nsWidgetAtoms::key, keyChar);
       if (!keyChar.EqualsLiteral(" ")) {
         keyEquiv = [[NSString stringWithCharacters:keyChar.get() length:keyChar.Length()] lowercaseString];
       }
       // now grab the key equivalent modifiers
       nsAutoString modifiersStr;
       keyContent->GetAttr(kNameSpaceID_None, nsWidgetAtoms::modifiers, modifiersStr);
-      PRUint8 geckoModifiers = MenuHelpersX::GeckoModifiersForNodeAttribute(modifiersStr);
-      macKeyModifiers = MenuHelpersX::MacModifiersForGeckoModifiers(geckoModifiers);
+      PRUint8 geckoModifiers = nsMenuUtilsX::GeckoModifiersForNodeAttribute(modifiersStr);
+      macKeyModifiers = nsMenuUtilsX::MacModifiersForGeckoModifiers(geckoModifiers);
     }
   }
   // get the label into NSString-form
   NSString* labelString = [NSString stringWithCharacters:label.get() length:label.Length()];
   
   if (!labelString)
     labelString = @"";
   if (!keyEquiv)
@@ -377,18 +394,17 @@ NSMenuItem* nsMenuBarX::CreateNativeAppM
   
   return newMenuItem;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NIL;
 }
 
 
 // build the Application menu shared by all menu bars
-nsresult
-nsMenuBarX::CreateApplicationMenu(nsIMenu* inMenu)
+nsresult nsMenuBarX::CreateApplicationMenu(nsMenuX* inMenu)
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;
 
   // At this point, the application menu is the application menu from
   // the nib in cocoa widgets. We do not have a way to create an application
   // menu manually, so we grab the one from the nib and use that.
   sApplicationMenu = [[[[NSApp mainMenu] itemAtIndex:0] submenu] retain];
   
@@ -531,160 +547,79 @@ nsMenuBarX::CreateApplicationMenu(nsIMen
   }
   
   return (sApplicationMenu) ? NS_OK : NS_ERROR_FAILURE;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
 }
 
 
-NS_IMETHODIMP nsMenuBarX::GetMenuCount(PRUint32 &aCount)
+void nsMenuBarX::SetParent(nsIWidget* aParent)
 {
-  aCount = mMenusArray.Count();
-  return NS_OK;
+  mParent = aParent;
 }
-
-
-NS_IMETHODIMP nsMenuBarX::GetMenuAt(const PRUint32 aCount, nsIMenu *& aMenu)
-{ 
-  aMenu = NULL;
-  nsCOMPtr<nsIMenu> menu = mMenusArray.ObjectAt(aCount);
-  if (!menu)
-    return NS_OK;
-  
-  return CallQueryInterface(menu, &aMenu); // addref
-}
-
-
-NS_IMETHODIMP nsMenuBarX::InsertMenuAt(const PRUint32 aCount, nsIMenu *& aMenu)
-{
-  return NS_ERROR_NOT_IMPLEMENTED;
-}
-
-
-NS_IMETHODIMP nsMenuBarX::RemoveMenu(const PRUint32 aCount)
-{
-  NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;
-
-  mMenusArray.RemoveObjectAt(aCount);
-  [mRootMenu removeItemAtIndex:aCount];
-  return NS_OK;
-
-  NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
-}
-
-
-NS_IMETHODIMP nsMenuBarX::RemoveAll()
-{
-  return NS_ERROR_NOT_IMPLEMENTED;
-}
-
-
-NS_IMETHODIMP nsMenuBarX::GetNativeData(void *& aData)
-{
-  aData = (void*)mRootMenu;
-  return NS_OK;
-}
-
-
-NS_IMETHODIMP nsMenuBarX::SetNativeData(void* aData)
-{
-  return NS_ERROR_NOT_IMPLEMENTED;
-}
-
-
-NS_IMETHODIMP nsMenuBarX::Paint()
-{
-  NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;
-
-  NSMenu* mainMenu = [NSApp mainMenu];
-  NS_ASSERTION([mainMenu numberOfItems] > 0, "Main menu does not have any items, something is terribly wrong!");
-
-  // Swap out first item into incoming menu bar. We have to keep the same menu item for the
-  // Application menu and its submenu is global so we keep passing it along.
-  NSMenuItem* firstMenuItem = [[mainMenu itemAtIndex:0] retain];
-  [mainMenu removeItemAtIndex:0];
-  [mRootMenu insertItem:firstMenuItem atIndex:0];
-  [firstMenuItem release];
-
-  // Set menu bar and event target.
-  [NSApp setMainMenu:mRootMenu];
-  nsMenuBarX::sLastGeckoMenuBarPainted = this;
-
-  gSomeMenuBarPainted = YES;
-
-  return NS_OK;
-
-  NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
-}
-
 
 //
 // nsIMutationObserver
 //
 
-void
-nsMenuBarX::CharacterDataWillChange(nsIDocument * aDocument,
-                                    nsIContent * aContent,
-                                    CharacterDataChangeInfo * aInfo)
+void nsMenuBarX::CharacterDataWillChange(nsIDocument* aDocument,
+                                         nsIContent* aContent,
+                                         CharacterDataChangeInfo* aInfo)
 {
 }
 
-void
-nsMenuBarX::CharacterDataChanged(nsIDocument * aDocument,
-                                 nsIContent * aContent,
-                                 CharacterDataChangeInfo * aInfo)
+
+void nsMenuBarX::CharacterDataChanged(nsIDocument* aDocument,
+                                      nsIContent* aContent,
+                                      CharacterDataChangeInfo* aInfo)
 {
 }
 
 
-void
-nsMenuBarX::ContentAppended(nsIDocument* aDocument, nsIContent* aContainer,
-                            PRInt32 aNewIndexInContainer)
+void nsMenuBarX::ContentAppended(nsIDocument* aDocument, nsIContent* aContainer,
+                                 PRInt32 aNewIndexInContainer)
 {
-  if (aContainer != mMenuBarContent) {
+  if (aContainer != mContent) {
     nsChangeObserver* obs = LookupContentChangeObserver(aContainer);
     if (obs)
       obs->ObserveContentInserted(aDocument, aContainer, aNewIndexInContainer);
     else {
       nsCOMPtr<nsIContent> parent = aContainer->GetParent();
       if (parent) {
         obs = LookupContentChangeObserver(parent);
         if (obs)
           obs->ObserveContentInserted(aDocument, aContainer, aNewIndexInContainer);
       }
     }
   }
 }
 
 
-void
-nsMenuBarX::NodeWillBeDestroyed(const nsINode * aNode)
+void nsMenuBarX::NodeWillBeDestroyed(const nsINode * aNode)
 {
   mDocument = nsnull;
 }
 
 
-void
-nsMenuBarX::AttributeChanged(nsIDocument * aDocument, nsIContent * aContent,
-                             PRInt32 aNameSpaceID, nsIAtom * aAttribute,
-                             PRInt32 aModType, PRUint32 aStateMask)
+void nsMenuBarX::AttributeChanged(nsIDocument * aDocument, nsIContent * aContent,
+                                  PRInt32 aNameSpaceID, nsIAtom * aAttribute,
+                                  PRInt32 aModType, PRUint32 aStateMask)
 {
   // lookup and dispatch to registered thang
   nsChangeObserver* obs = LookupContentChangeObserver(aContent);
   if (obs)
     obs->ObserveAttributeChanged(aDocument, aContent, aAttribute);
 }
 
 
-void
-nsMenuBarX::ContentRemoved(nsIDocument * aDocument, nsIContent * aContainer,
-                           nsIContent * aChild, PRInt32 aIndexInContainer)
+void nsMenuBarX::ContentRemoved(nsIDocument * aDocument, nsIContent * aContainer,
+                                nsIContent * aChild, PRInt32 aIndexInContainer)
 {
-  if (aContainer == mMenuBarContent) {
+  if (aContainer == mContent) {
     UnregisterForContentChanges(aChild);
     RemoveMenu(aIndexInContainer);
   }
   else {
     nsChangeObserver* obs = LookupContentChangeObserver(aContainer);
     if (obs) {
       obs->ObserveContentRemoved(aDocument, aChild, aIndexInContainer);
     }
@@ -695,74 +630,68 @@ nsMenuBarX::ContentRemoved(nsIDocument *
         if (obs)
           obs->ObserveContentRemoved(aDocument, aChild, aIndexInContainer);
       }
     }
   }
 }
 
 
-void
-nsMenuBarX::ContentInserted(nsIDocument * aDocument, nsIContent * aContainer,
-                             nsIContent * aChild, PRInt32 aIndexInContainer)
+void nsMenuBarX::ContentInserted(nsIDocument * aDocument, nsIContent * aContainer,
+                                 nsIContent * aChild, PRInt32 aIndexInContainer)
 {
-  if (aContainer != mMenuBarContent) {
+  if (aContainer != mContent) {
     nsChangeObserver* obs = LookupContentChangeObserver(aContainer);
     if (obs)
       obs->ObserveContentInserted(aDocument, aChild, aIndexInContainer);
     else {
       nsCOMPtr<nsIContent> parent = aContainer->GetParent();
       if (parent) {
         obs = LookupContentChangeObserver(parent);
         if (obs)
           obs->ObserveContentInserted(aDocument, aChild, aIndexInContainer);
       }
     }
   }
 }
 
 
-void
-nsMenuBarX::ParentChainChanged(nsIContent *aContent)
+void nsMenuBarX::ParentChainChanged(nsIContent *aContent)
 {
 }
 
 
 // For change management, we don't use a |nsSupportsHashtable| because we know that the
 // lifetime of all these items is bounded by the lifetime of the menubar. No need to add
 // any more strong refs to the picture because the containment hierarchy already uses
 // strong refs.
-void
-nsMenuBarX::RegisterForContentChanges(nsIContent *aContent, nsChangeObserver *aMenuObject)
+void nsMenuBarX::RegisterForContentChanges(nsIContent *aContent, nsChangeObserver *aMenuObject)
 {
   nsVoidKey key(aContent);
   mObserverTable.Put(&key, aMenuObject);
 }
 
 
-void
-nsMenuBarX::UnregisterForContentChanges(nsIContent *aContent)
+void nsMenuBarX::UnregisterForContentChanges(nsIContent *aContent)
 {
   nsVoidKey key(aContent);
   mObserverTable.Remove(&key);
 }
 
 
-nsChangeObserver*
-nsMenuBarX::LookupContentChangeObserver(nsIContent* aContent)
+nsChangeObserver* nsMenuBarX::LookupContentChangeObserver(nsIContent* aContent)
 {
   nsVoidKey key(aContent);
   return reinterpret_cast<nsChangeObserver*>(mObserverTable.Get(&key));
 }
 
 
 // Given a menu item, creates a unique 4-character command ID and
 // maps it to the item. Returns the id for use by the client.
-PRUint32
-nsMenuBarX::RegisterForCommand(nsIMenuItem* inMenuItem)
+PRUint32 nsMenuBarX::RegisterForCommand(nsMenuItemX* inMenuItem)
 {
   // no real need to check for uniqueness. We always start afresh with each
   // window at 1. Even if we did get close to the reserved Apple command id's,
   // those don't start until at least '    ', which is integer 538976288. If
   // we have that many menu items in one window, I think we have other problems.
 
   // make id unique
   ++mCurrentCommandID;
@@ -772,174 +701,27 @@ nsMenuBarX::RegisterForCommand(nsIMenuIt
   mObserverTable.Put(&key, inMenuItem);
 
   return mCurrentCommandID;
 }
 
 
 // Removes the mapping between the given 4-character command ID
 // and its associated menu item.
-void
-nsMenuBarX::UnregisterCommand(PRUint32 inCommandID)
+void nsMenuBarX::UnregisterCommand(PRUint32 inCommandID)
 {
   nsPRUint32Key key(inCommandID);
   mObserverTable.Remove(&key);
 }
 
 
-nsIMenuItem*
-nsMenuBarX::GetMenuItemForCommandID(PRUint32 inCommandID)
+nsMenuItemX* nsMenuBarX::GetMenuItemForCommandID(PRUint32 inCommandID)
 {
   nsPRUint32Key key(inCommandID);
-  return reinterpret_cast<nsIMenuItem*>(mObserverTable.Get(&key));
-}
-
-
-nsEventStatus
-MenuHelpersX::DispatchCommandTo(nsIContent* aTargetContent)
-{
-  NS_PRECONDITION(aTargetContent, "null ptr");
-
-  nsEventStatus status = nsEventStatus_eConsumeNoDefault;
-  nsXULCommandEvent event(PR_TRUE, NS_XUL_COMMAND, nsnull);
-  
-  // FIXME: Should probably figure out how to init this with the actual
-  // pressed keys, but this is a big old edge case anyway. -dwh
-  
-  aTargetContent->DispatchDOMEvent(&event, nsnull, nsnull, &status);
-  return status;
-}
-
-
-NSString* MenuHelpersX::CreateTruncatedCocoaLabel(const nsString& itemLabel)
-{
-  NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NIL;
-
-  // ::TruncateThemeText() doesn't take the number of characters to truncate to, it takes a pixel with
-  // to fit the string in. Ugh. I talked it over with sfraser and we couldn't come up with an 
-  // easy way to compute what this should be given the system font, etc, so we're just going
-  // to hard code it to something reasonable and bigger fonts will just have to deal.
-  const short kMaxItemPixelWidth = 300;
-  NSMutableString *label = [[NSMutableString stringWithCharacters:itemLabel.get() length:itemLabel.Length()] retain];
-  ::TruncateThemeText((CFMutableStringRef)label, kThemeMenuItemFont, kThemeStateActive, kMaxItemPixelWidth, truncMiddle, NULL);
-  return label; // caller releases
-
-  NS_OBJC_END_TRY_ABORT_BLOCK_NIL;
-}
-
-
-PRUint8 MenuHelpersX::GeckoModifiersForNodeAttribute(const nsString& modifiersAttribute)
-{
-  PRUint8 modifiers = knsMenuItemNoModifier;
-  char* str = ToNewCString(modifiersAttribute);
-  char* newStr;
-  char* token = nsCRT::strtok(str, ", \t", &newStr);
-  while (token != NULL) {
-    if (PL_strcmp(token, "shift") == 0)
-      modifiers |= knsMenuItemShiftModifier;
-    else if (PL_strcmp(token, "alt") == 0) 
-      modifiers |= knsMenuItemAltModifier;
-    else if (PL_strcmp(token, "control") == 0) 
-      modifiers |= knsMenuItemControlModifier;
-    else if ((PL_strcmp(token, "accel") == 0) ||
-             (PL_strcmp(token, "meta") == 0)) {
-      modifiers |= knsMenuItemCommandModifier;
-    }
-    token = nsCRT::strtok(newStr, ", \t", &newStr);
-  }
-  nsMemory::Free(str);
-
-  return modifiers;
-}
-
-
-unsigned int MenuHelpersX::MacModifiersForGeckoModifiers(PRUint8 geckoModifiers)
-{
-  unsigned int macModifiers = 0;
-  
-  if (geckoModifiers & knsMenuItemShiftModifier)
-    macModifiers |= NSShiftKeyMask;
-  if (geckoModifiers & knsMenuItemAltModifier)
-    macModifiers |= NSAlternateKeyMask;
-  if (geckoModifiers & knsMenuItemControlModifier)
-    macModifiers |= NSControlKeyMask;
-  if (geckoModifiers & knsMenuItemCommandModifier)
-    macModifiers |= NSCommandKeyMask;
-  
-  return macModifiers;
-}
-
-
-nsIMenuBar* MenuHelpersX::GetHiddenWindowMenuBar()
-{
-  nsIWidget* hiddenWindowWidgetNoCOMPtr = nsCocoaUtils::GetHiddenWindowWidget();
-  if (hiddenWindowWidgetNoCOMPtr)
-    return static_cast<nsCocoaWindow*>(hiddenWindowWidgetNoCOMPtr)->GetMenuBar();
-  else
-    return nsnull;
-}
-
-
-// It would be nice if we could localize these edit menu names.
-static NSMenuItem* standardEditMenuItem = nil;
-NSMenuItem* MenuHelpersX::GetStandardEditMenuItem()
-{
-  NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NIL;
-
-  if (standardEditMenuItem)
-    return standardEditMenuItem;
-
-  NSMenuItem* standardEditMenuItem = [[NSMenuItem alloc] initWithTitle:@"Edit" action:nil keyEquivalent:@""];
-  NSMenu* standardEditMenu = [[NSMenu alloc] initWithTitle:@"Edit"];
-  [standardEditMenuItem setSubmenu:standardEditMenu];
-  [standardEditMenu release];
-
-  // Add Undo
-  NSMenuItem* undoItem = [[NSMenuItem alloc] initWithTitle:@"Undo" action:@selector(undo:) keyEquivalent:@"z"];
-  [standardEditMenu addItem:undoItem];
-  [undoItem release];
-
-  // Add Redo
-  NSMenuItem* redoItem = [[NSMenuItem alloc] initWithTitle:@"Redo" action:@selector(redo:) keyEquivalent:@"Z"];
-  [standardEditMenu addItem:redoItem];
-  [redoItem release];
-
-  // Add separator
-  [standardEditMenu addItem:[NSMenuItem separatorItem]];
-  
-  // Add Cut
-  NSMenuItem* cutItem = [[NSMenuItem alloc] initWithTitle:@"Cut" action:@selector(cut:) keyEquivalent:@"x"];
-  [standardEditMenu addItem:cutItem];
-  [cutItem release];
-
-  // Add Copy
-  NSMenuItem* copyItem = [[NSMenuItem alloc] initWithTitle:@"Copy" action:@selector(copy:) keyEquivalent:@"c"];
-  [standardEditMenu addItem:copyItem];
-  [copyItem release];
-
-  // Add Paste
-  NSMenuItem* pasteItem = [[NSMenuItem alloc] initWithTitle:@"Paste" action:@selector(paste:) keyEquivalent:@"v"];
-  [standardEditMenu addItem:pasteItem];
-  [pasteItem release];
-
-  // Add Delete
-  NSMenuItem* deleteItem = [[NSMenuItem alloc] initWithTitle:@"Delete" action:@selector(delete:) keyEquivalent:@""];
-  [standardEditMenu addItem:deleteItem];
-  [deleteItem release];
-
-  // Add Select All
-  NSMenuItem* selectAllItem = [[NSMenuItem alloc] initWithTitle:@"Select All" action:@selector(selectAll:) keyEquivalent:@"a"];
-  [standardEditMenu addItem:selectAllItem];
-  [selectAllItem release];
-
-  standardEditMenuItem = standardEditMenuItem;
-
-  return standardEditMenuItem;
-
-  NS_OBJC_END_TRY_ABORT_BLOCK_NIL;
+  return reinterpret_cast<nsMenuItemX*>(mObserverTable.Get(&key));
 }
 
 
 //
 // Objective-C class used to allow us to have keyboard commands
 // look like they are doing something but actually do nothing.
 // We allow mouse actions to work normally.
 //
@@ -1017,33 +799,33 @@ static BOOL gActOnSpecialCommands = YES;
   // perform native menu effects only. This avoids sending events twice,
   // which can lead to major problems.
   if (gActOnSpecialCommands) {
     // Do special processing if this is for an app-global command.
     if (tag == eCommand_ID_About) {
       nsIContent* mostSpecificContent = sAboutItemContent;
       if (menuBar && menuBar->mAboutItemContent)
         mostSpecificContent = menuBar->mAboutItemContent;
-      MenuHelpersX::DispatchCommandTo(mostSpecificContent);
+      nsMenuUtilsX::DispatchCommandTo(mostSpecificContent);
     }
     else if (tag == eCommand_ID_Prefs) {
       nsIContent* mostSpecificContent = sPrefItemContent;
       if (menuBar && menuBar->mPrefItemContent)
         mostSpecificContent = menuBar->mPrefItemContent;
-      MenuHelpersX::DispatchCommandTo(mostSpecificContent);
+      nsMenuUtilsX::DispatchCommandTo(mostSpecificContent);
     }
     else if (tag == eCommand_ID_Quit) {
       nsIContent* mostSpecificContent = sQuitItemContent;
       if (menuBar && menuBar->mQuitItemContent)
         mostSpecificContent = menuBar->mQuitItemContent;
       // If we have some content for quit we execute it. Otherwise we send a native app terminate
       // message. If you want to stop a quit from happening, provide quit content and return
       // the event as unhandled.
       if (mostSpecificContent) {
-        MenuHelpersX::DispatchCommandTo(mostSpecificContent);
+        nsMenuUtilsX::DispatchCommandTo(mostSpecificContent);
       }
       else {
         [NSApp terminate:nil];
         return;
       }
     }
     // Quit now if the "active" menu bar has changed (as the result of
     // processing an app-global command above).  This resolves bmo bug
@@ -1056,20 +838,19 @@ static BOOL gActOnSpecialCommands = YES;
   // this isn't for the hidden window menu. We assume that if there
   // is no main window then the hidden window menu bar is up, even
   // if that isn't true for some reason we better play it safe if
   // there is no main window.
   if (gPerformKeyEquivOnStack && !gActOnKeyEquiv && [NSApp mainWindow])
     return;
 
   // given the commandID, look it up in our hashtable and dispatch to
-  // that content node. Recall that we store weak pointers to the content
-  // nodes in the hash table.
+  // that menu item.
   if (menuBar) {
-    nsIMenuItem* content = menuBar->GetMenuItemForCommandID(static_cast<PRUint32>(tag));
-    if (content)
-      content->DoCommand();    
+    nsMenuItemX* menuItem = menuBar->GetMenuItemForCommandID(static_cast<PRUint32>(tag));
+    if (menuItem)
+      menuItem->DoCommand();
   }
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
 @end
diff --git a/widget/src/cocoa/nsMenuBaseX.h b/widget/src/cocoa/nsMenuBaseX.h
new file mode 100644
--- /dev/null
+++ b/widget/src/cocoa/nsMenuBaseX.h
@@ -0,0 +1,68 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is mozilla.org code.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Josh Aas <josh@mozilla.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#ifndef nsMenuBaseX_h_
+#define nsMenuBaseX_h_
+
+#include "nsCOMPtr.h"
+#include "nsIContent.h"
+
+enum nsMenuObjectTypeX {
+  eMenuBarObjectType,
+  eSubmenuObjectType,
+  eMenuItemObjectType
+};
+
+// All menu objects subclass this.
+// Menu bars are owned by their top-level nsIWidgets.
+// All other objects are memory-managed based on the DOM.
+// Content removal deletes them immediately and nothing else should.
+// Do not attempt to hold strong references to them or delete them.
+class nsMenuObjectX
+{
+public:
+  virtual ~nsMenuObjectX() { }
+  virtual nsMenuObjectTypeX MenuObjectType()=0;
+  virtual void*             NativeData()=0;
+  nsIContent*               Content() { return mContent; }
+
+protected:
+  nsCOMPtr<nsIContent> mContent;
+};
+
+#endif // nsMenuBaseX_h_
diff --git a/widget/src/cocoa/nsMenuItemIconX.h b/widget/src/cocoa/nsMenuItemIconX.h
--- a/widget/src/cocoa/nsMenuItemIconX.h
+++ b/widget/src/cocoa/nsMenuItemIconX.h
@@ -46,29 +46,28 @@
 
 
 #include "nsCOMPtr.h"
 #include "imgIDecoderObserver.h"
 
 class nsIURI;
 class nsIContent;
 class imgIRequest;
-class nsIMenu;
+class nsMenuObjectX;
 
 #import <Carbon/Carbon.h>
 #import <Cocoa/Cocoa.h>
 
 
 class nsMenuItemIconX : public imgIDecoderObserver
 {
 public:
-  nsMenuItemIconX(nsISupports* aMenuItem,
-                 nsIMenu*     aMenu,
-                 nsIContent*  aContent,
-                 NSMenuItem* aNativeMenuItem);
+  nsMenuItemIconX(nsMenuObjectX* aMenuItem,
+                  nsIContent*    aContent,
+                  NSMenuItem*    aNativeMenuItem);
 private:
   ~nsMenuItemIconX();
 
 public:
   NS_DECL_ISUPPORTS
   NS_DECL_IMGICONTAINEROBSERVER
   NS_DECL_IMGIDECODEROBSERVER
 
@@ -81,18 +80,15 @@ public:
 
   // LoadIcon will set a placeholder image and start a load request for the
   // icon.  The request may not complete until after LoadIcon returns.
   nsresult LoadIcon(nsIURI* aIconURI);
 
 protected:
   nsCOMPtr<nsIContent>  mContent;
   nsCOMPtr<imgIRequest> mIconRequest;
-  nsISupports*          mMenuItem;
-  nsIMenu*              mMenu;
-  MenuRef               mMenuRef;
-  PRUint16              mMenuItemIndex;
+  nsMenuObjectX*        mMenuObject;
   PRPackedBool          mLoadedIcon;
   PRPackedBool          mSetIcon;
   NSMenuItem*           mNativeMenuItem;
 };
 
 #endif // nsMenuItemIconX_h_
diff --git a/widget/src/cocoa/nsMenuItemIconX.mm b/widget/src/cocoa/nsMenuItemIconX.mm
--- a/widget/src/cocoa/nsMenuItemIconX.mm
+++ b/widget/src/cocoa/nsMenuItemIconX.mm
@@ -40,18 +40,16 @@
  * Retrieves and displays icons in native menu items on Mac OS X.
  */
 
 
 #include "nsMenuItemIconX.h"
 
 #include "nsObjCExceptions.h"
 #include "prmem.h"
-#include "nsIMenu.h"
-#include "nsIMenuItem.h"
 #include "nsIContent.h"
 #include "nsIDocument.h"
 #include "nsINameSpaceManager.h"
 #include "nsWidgetAtoms.h"
 #include "nsIDOMDocumentView.h"
 #include "nsIDOMViewCSS.h"
 #include "nsIDOMElement.h"
 #include "nsIDOMCSSStyleDeclaration.h"
@@ -59,16 +57,17 @@
 #include "nsIDOMCSSPrimitiveValue.h"
 #include "nsThreadUtils.h"
 #include "nsToolkit.h"
 #include "nsNetUtil.h"
 #include "imgILoader.h"
 #include "imgIRequest.h"
 #include "gfxIImageFrame.h"
 #include "nsIImage.h"
+#include "nsMenuItemX.h"
 
 static const PRUint32 kIconWidth = 16;
 static const PRUint32 kIconHeight = 16;
 static const PRUint32 kIconBitsPerComponent = 8;
 static const PRUint32 kIconComponents = 4;
 static const PRUint32 kIconBitsPerPixel = kIconBitsPerComponent *
                                           kIconComponents;
 static const PRUint32 kIconBytesPerRow = kIconWidth * kIconBitsPerPixel / 8;
@@ -78,25 +77,21 @@ static void
 static void
 PRAllocCGFree(void* aInfo, const void* aData, size_t aSize) {
   free((void*)aData);
 }
 
 
 NS_IMPL_ISUPPORTS2(nsMenuItemIconX, imgIContainerObserver, imgIDecoderObserver)
 
-nsMenuItemIconX::nsMenuItemIconX(nsISupports* aMenuItem,
-                               nsIMenu*     aMenu,
-                               nsIContent*  aContent,
-                               NSMenuItem* aNativeMenuItem)
+nsMenuItemIconX::nsMenuItemIconX(nsMenuObjectX* aMenuItem,
+                                 nsIContent*    aContent,
+                                 NSMenuItem*    aNativeMenuItem)
 : mContent(aContent)
-, mMenuItem(aMenuItem)
-, mMenu(aMenu)
-, mMenuRef(NULL)
-, mMenuItemIndex(0)
+, mMenuObject(aMenuItem)
 , mLoadedIcon(PR_FALSE)
 , mSetIcon(PR_FALSE)
 , mNativeMenuItem(aNativeMenuItem)
 {
   //  printf("Creating icon for menu item %d, menu %d, native item is %d\n", aMenuItem, aMenu, aNativeMenuItem);
 }
 
 
@@ -106,37 +101,25 @@ nsMenuItemIconX::~nsMenuItemIconX()
     mIconRequest->Cancel(NS_BINDING_ABORTED);
 }
 
 
 nsresult
 nsMenuItemIconX::SetupIcon()
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;
-
-  nsresult rv;
-  if (!mMenuRef || !mMenuItemIndex) {
-    // These values are initialized here instead of in the constructor
-    // because they depend on the parent menu, mMenu, having inserted
-    // this object into its array of children.  That can only happen after
-    // the object is constructed.
-    rv = mMenu->GetMenuRefAndItemIndexForMenuItem(mMenuItem,
-                                                  (void**)&mMenuRef,
-                                                  &mMenuItemIndex);
-    if (NS_FAILED(rv)) return rv;
-  }
 
   // Still don't have one, then something is wrong, get out of here.
   if (!mNativeMenuItem) {
     NS_ERROR("No native menu item\n");
     return NS_ERROR_FAILURE;
   }
 
   nsCOMPtr<nsIURI> iconURI;
-  rv = GetIconURI(getter_AddRefs(iconURI));
+  nsresult rv = GetIconURI(getter_AddRefs(iconURI));
   if (NS_FAILED(rv)) {
     // There is no icon for this menu item. An icon might have been set
     // earlier.  Clear it.
     [mNativeMenuItem setImage:nil];
 
     return NS_OK;
   }
 
@@ -150,25 +133,24 @@ nsMenuItemIconX::GetIconURI(nsIURI** aIc
 nsMenuItemIconX::GetIconURI(nsIURI** aIconURI)
 {
   // Mac native menu items support having both a checkmark and an icon
   // simultaneously, but this is unheard of in the cross-platform toolkit,
   // seemingly because the win32 theme is unable to cope with both at once.
   // The downside is that it's possible to get a menu item marked with a
   // native checkmark and a checkmark for an icon.  Head off that possibility
   // by pretending that no icon exists if this is a checkable menu item.
-  nsCOMPtr<nsIMenuItem> menuItem = do_QueryInterface(mMenuItem);
-  if (menuItem) {
-    nsIMenuItem::EMenuItemType menuItemType;
-    menuItem->GetMenuItemType(&menuItemType);
-    if (menuItemType != nsIMenuItem::eRegular)
+  if (mMenuObject->MenuObjectType() == eMenuItemObjectType) {
+    nsMenuItemX* menuItem = static_cast<nsMenuItemX*>(mMenuObject);
+    if (menuItem->GetMenuItemType() != eRegularMenuItemType)
       return NS_ERROR_FAILURE;
   }
 
-  if (!mContent) return NS_ERROR_FAILURE;
+  if (!mContent)
+    return NS_ERROR_FAILURE;
 
   // First, look at the content node's "image" attribute.
   nsAutoString imageURIString;
   PRBool hasImageAttr = mContent->GetAttr(kNameSpaceID_None,
                                           nsWidgetAtoms::image,
                                           imageURIString);
 
   nsresult rv;
diff --git a/widget/src/cocoa/nsMenuItemX.h b/widget/src/cocoa/nsMenuItemX.h
--- a/widget/src/cocoa/nsMenuItemX.h
+++ b/widget/src/cocoa/nsMenuItemX.h
@@ -34,74 +34,73 @@
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 #ifndef nsMenuItemX_h_
 #define nsMenuItemX_h_
 
-#include "nsIMenuItem.h"
-#include "nsString.h"
+#include "nsMenuBaseX.h"
 #include "nsChangeObserver.h"
 #include "nsAutoPtr.h"
 
 #import <Cocoa/Cocoa.h>
 
-class nsIMenu;
+class nsString;
 class nsMenuItemIconX;
+class nsMenuX;
+class nsMenuBarX;
 
-/**
- * Native menu item wrapper
- */
+enum {
+  knsMenuItemNoModifier      = 0,
+  knsMenuItemShiftModifier   = (1 << 0),
+  knsMenuItemAltModifier     = (1 << 1),
+  knsMenuItemControlModifier = (1 << 2),
+  knsMenuItemCommandModifier = (1 << 3)
+};
 
-class nsMenuItemX : public nsIMenuItem,
+enum EMenuItemType {
+  eRegularMenuItemType = 0,
+  eCheckboxMenuItemType,
+  eRadioMenuItemType,
+  eSeparatorMenuItemType
+};
+
+
+// Once instantiated, this object lives until its DOM node or its parent window is destroyed.
+// Do not hold references to this, they can become invalid any time the DOM node can be destroyed.
+class nsMenuItemX : public nsMenuObjectX,
                     public nsChangeObserver
 {
 public:
   nsMenuItemX();
   virtual ~nsMenuItemX();
 
-  // nsISupports
-  NS_DECL_ISUPPORTS
   NS_DECL_CHANGEOBSERVER
 
-  // nsIMenuItem Methods
-  NS_IMETHOD Create(nsIMenu* aParent, const nsString & aLabel, EMenuItemType aItemType,
-                    nsMenuBarX* aMenuBar, nsIContent* aNode);
-  NS_IMETHOD GetLabel(nsString &aText);
-  NS_IMETHOD GetShortcutChar(nsString &aText);
-  NS_IMETHOD GetEnabled(PRBool *aIsEnabled);
-  NS_IMETHOD SetChecked(PRBool aIsEnabled);
-  NS_IMETHOD GetChecked(PRBool *aIsEnabled);
-  NS_IMETHOD GetMenuItemType(EMenuItemType *aIsCheckbox);
-  NS_IMETHOD GetNativeData(void*& aData);
-  NS_IMETHOD IsSeparator(PRBool & aIsSep);
+  // nsMenuObjectX
+  void*             NativeData()     {return (void*)mNativeMenuItem;}
+  nsMenuObjectTypeX MenuObjectType() {return eMenuItemObjectType;}
 
-  NS_IMETHOD DoCommand();
-  NS_IMETHOD DispatchDOMEvent(const nsString &eventName, PRBool *preventDefaultCalled);
-  NS_IMETHOD SetupIcon();
-  NS_IMETHOD GetMenuItemContent(nsIContent ** aMenuItemContent);
+  // nsMenuItemX
+  nsresult      Create(nsMenuX* aParent, const nsString& aLabel, EMenuItemType aItemType,
+                       nsMenuBarX* aMenuBar, nsIContent* aNode);
+  nsresult      SetChecked(PRBool aIsChecked);
+  EMenuItemType GetMenuItemType();
+  void          DoCommand();
+  nsresult      DispatchDOMEvent(const nsString &eventName, PRBool* preventDefaultCalled);
+  void          SetupIcon();
 
 protected:
-
   void UncheckRadioSiblings(nsIContent* inCheckedElement);
   void SetKeyEquiv(PRUint8 aModifiers, const nsString &aText);
 
-  NSMenuItem*               mNativeMenuItem;       // strong ref, we own
-  
-  nsString                  mLabel;
-  nsString                  mKeyEquivalent;
-
-  nsIMenu*                  mMenuParent;          // weak, parent owns us
-  nsMenuBarX*               mMenuBar;             // weak
-  
-  nsCOMPtr<nsIContent>      mContent;
+  EMenuItemType             mType;
+  NSMenuItem*               mNativeMenuItem;      // [strong]
+  nsMenuX*                  mMenuParent;          // [weak]
+  nsMenuBarX*               mMenuBar;             // [weak]
   nsCOMPtr<nsIContent>      mCommandContent;
   nsRefPtr<nsMenuItemIconX> mIcon;
-  
-  PRUint8           mModifiers;
-  PRPackedBool      mEnabled;
-  PRPackedBool      mIsChecked;
-  EMenuItemType     mType; // regular, checkbox, radio, or separator
+  PRBool                    mIsChecked;
 };
 
 #endif // nsMenuItemX_h_
diff --git a/widget/src/cocoa/nsMenuItemX.mm b/widget/src/cocoa/nsMenuItemX.mm
--- a/widget/src/cocoa/nsMenuItemX.mm
+++ b/widget/src/cocoa/nsMenuItemX.mm
@@ -31,79 +31,78 @@
  * use your version of this file under the terms of the MPL, indicate your
  * decision by deleting the provisions above and replace them with the notice
  * and other provisions required by the GPL or the LGPL. If you do not delete
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
+#include "nsMenuItemX.h"
+#include "nsMenuBarX.h"
+#include "nsMenuX.h"
+#include "nsMenuItemIconX.h"
+#include "nsMenuUtilsX.h"
+
+#include "nsObjCExceptions.h"
+
 #include "nsCOMPtr.h"
+#include "nsWidgetAtoms.h"
+#include "nsGUIEvent.h"
+
 #include "nsIContent.h"
-#include "nsObjCExceptions.h"
-#include "nsMenuBarX.h"  // for MenuHelpers namespace
-#include "nsMenuItemX.h"
-#include "nsIMenu.h"
-#include "nsIMenuBar.h"
 #include "nsIWidget.h"
-#include "nsINameSpaceManager.h"
-#include "nsWidgetAtoms.h"
-#include "nsIServiceManager.h"
 #include "nsIDocument.h"
 #include "nsIDOMDocument.h"
 #include "nsIPrivateDOMEvent.h"
 #include "nsIDOMEventTarget.h"
 #include "nsIDOMDocumentEvent.h"
-
-#include "nsMenuItemIconX.h"
-#include "nsGUIEvent.h"
-
-
-NS_IMPL_ISUPPORTS1(nsMenuItemX, nsIMenuItem)
+#include "nsIDOMElement.h"
 
 
 nsMenuItemX::nsMenuItemX()
 {
-  mNativeMenuItem     = nil;
-  mMenuParent         = nsnull;
-  mMenuBar            = nsnull;
-  mKeyEquivalent.AssignLiteral(" ");
-  mEnabled            = PR_TRUE;
-  mIsChecked          = PR_FALSE;
-  mType               = eRegular;
+  mType           = eRegularMenuItemType;
+  mNativeMenuItem = nil;
+  mMenuParent     = nsnull;
+  mMenuBar        = nsnull;
+  mIsChecked      = PR_FALSE;
+
+  MOZ_COUNT_CTOR(nsMenuItemX);
 }
 
 
 nsMenuItemX::~nsMenuItemX()
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
   [mNativeMenuItem autorelease];
   if (mContent)
     mMenuBar->UnregisterForContentChanges(mContent);
   if (mCommandContent)
     mMenuBar->UnregisterForContentChanges(mCommandContent);
 
+  MOZ_COUNT_DTOR(nsMenuItemX);
+
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
 
-NS_METHOD nsMenuItemX::Create(nsIMenu* aParent, const nsString & aLabel, EMenuItemType aItemType,
-                              nsMenuBarX* aMenuBar, nsIContent* aNode)
+nsresult nsMenuItemX::Create(nsMenuX* aParent, const nsString& aLabel, EMenuItemType aItemType,
+                             nsMenuBarX* aMenuBar, nsIContent* aNode)
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;
 
-  mContent = aNode;      // addref
-  mMenuParent = aParent; // weak
+  mType = aItemType;
+  mMenuParent = aParent;
+  mContent = aNode;
 
-  mType = aItemType;
+  mMenuBar = aMenuBar;
+  NS_ASSERTION(mMenuBar, "No menu bar given, must have one!");
 
-  // register for AttributeChanged messages
-  mMenuBar = aMenuBar;
-  NS_ASSERTION(mMenuBar, "No menu bar given, must have one");
   mMenuBar->RegisterForContentChanges(mContent, this);
 
   nsCOMPtr<nsIDOMDocument> domDoc(do_QueryInterface(mContent->GetCurrentDoc()));
 
   // if we have a command associated with this menu item, register for changes
   // to the command DOM node
   if (domDoc) {
     nsAutoString ourCommand;
@@ -115,89 +114,72 @@ NS_METHOD nsMenuItemX::Create(nsIMenu* a
 
       if (commandElement) {
         mCommandContent = do_QueryInterface(commandElement);
         // register to observe the command DOM element
         mMenuBar->RegisterForContentChanges(mCommandContent, this);
       }
     }
   }
-  
-  // set up mEnabled based on command content if it exists, otherwise do it based
+
+  // decide enabled state based on command content if it exists, otherwise do it based
   // on our own content
+  PRBool isEnabled;
   if (mCommandContent)
-    mEnabled = !mCommandContent->AttrValueIs(kNameSpaceID_None, nsWidgetAtoms::disabled, nsWidgetAtoms::_true, eCaseMatters);
+    isEnabled = !mCommandContent->AttrValueIs(kNameSpaceID_None, nsWidgetAtoms::disabled, nsWidgetAtoms::_true, eCaseMatters);
   else
-    mEnabled = !mContent->AttrValueIs(kNameSpaceID_None, nsWidgetAtoms::disabled, nsWidgetAtoms::_true, eCaseMatters);
-  
-  mLabel = aLabel;
-  
+    isEnabled = !mContent->AttrValueIs(kNameSpaceID_None, nsWidgetAtoms::disabled, nsWidgetAtoms::_true, eCaseMatters);
+
   // set up the native menu item
-  if (mType == nsIMenuItem::eSeparator) {
+  if (mType == eSeparatorMenuItemType) {
     mNativeMenuItem = [[NSMenuItem separatorItem] retain];
   }
   else {
-    NSString *newCocoaLabelString = MenuHelpersX::CreateTruncatedCocoaLabel(mLabel);
+    NSString *newCocoaLabelString = nsMenuUtilsX::CreateTruncatedCocoaLabel(aLabel);
     mNativeMenuItem = [[NSMenuItem alloc] initWithTitle:newCocoaLabelString action:nil keyEquivalent:@""];
     [newCocoaLabelString release];
-    
-    [mNativeMenuItem setEnabled:(BOOL)mEnabled];
+
+    [mNativeMenuItem setEnabled:(BOOL)isEnabled];
 
     SetChecked(mContent->AttrValueIs(kNameSpaceID_None, nsWidgetAtoms::checked,
                                      nsWidgetAtoms::_true, eCaseMatters));
 
     // Set key shortcut and modifiers
     if (domDoc) {
       nsAutoString keyValue;
       mContent->GetAttr(kNameSpaceID_None, nsWidgetAtoms::key, keyValue);
-
       if (!keyValue.IsEmpty()) {
         nsCOMPtr<nsIDOMElement> keyElement;
         domDoc->GetElementById(keyValue, getter_AddRefs(keyElement));
-
         if (keyElement) {
           nsCOMPtr<nsIContent> keyContent(do_QueryInterface(keyElement));
           nsAutoString keyChar(NS_LITERAL_STRING(" "));
           keyContent->GetAttr(kNameSpaceID_None, nsWidgetAtoms::key, keyChar);
 
           nsAutoString modifiersStr;
           keyContent->GetAttr(kNameSpaceID_None, nsWidgetAtoms::modifiers, modifiersStr);
-          PRUint8 modifiers = MenuHelpersX::GeckoModifiersForNodeAttribute(modifiersStr);
+          PRUint8 modifiers = nsMenuUtilsX::GeckoModifiersForNodeAttribute(modifiersStr);
 
           SetKeyEquiv(modifiers, keyChar);
         }
       }
     }
   }
 
-  mIcon = new nsMenuItemIconX(static_cast<nsIMenuItem*>(this), mMenuParent, mContent, mNativeMenuItem);
-  
+  mIcon = new nsMenuItemIconX(this, mContent, mNativeMenuItem);
+  if (!mIcon)
+    return NS_ERROR_OUT_OF_MEMORY;
+
   return NS_OK;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
 }
 
 
-NS_METHOD
-nsMenuItemX::GetLabel(nsString &aText)
-{
-  aText = mLabel;
-  return NS_OK;
-}
-
-
-NS_METHOD 
-nsMenuItemX::GetEnabled(PRBool *aIsEnabled)
-{
-  *aIsEnabled = mEnabled;
-  return NS_OK;
-}
-
-
-NS_METHOD nsMenuItemX::SetChecked(PRBool aIsChecked)
+nsresult nsMenuItemX::SetChecked(PRBool aIsChecked)
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;
 
   mIsChecked = aIsChecked;
   
   // update the content model. This will also handle unchecking our siblings
   // if we are a radiomenu
   mContent->SetAttr(kNameSpaceID_None, nsWidgetAtoms::checked, 
@@ -210,120 +192,89 @@ NS_METHOD nsMenuItemX::SetChecked(PRBool
     [mNativeMenuItem setState:NSOffState];
 
   return NS_OK;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
 }
 
 
-NS_METHOD nsMenuItemX::GetChecked(PRBool *aIsEnabled)
+EMenuItemType nsMenuItemX::GetMenuItemType()
 {
-  *aIsEnabled = mIsChecked;
-  return NS_OK;
-}
-
-
-NS_METHOD nsMenuItemX::GetMenuItemType(EMenuItemType *aType)
-{
-  *aType = mType;
-  return NS_OK;
-}
-
-
-NS_METHOD nsMenuItemX::GetNativeData(void *& aData)
-{
-  aData = mNativeMenuItem;
-  return NS_OK;
-}
-
-
-NS_METHOD nsMenuItemX::IsSeparator(PRBool & aIsSep)
-{
-  aIsSep = (mType == nsIMenuItem::eSeparator);
-  return NS_OK;
+  return mType;
 }
 
 
 // Executes the "cached" javaScript command.
 // Returns NS_OK if the command was executed properly, otherwise an error code.
-NS_IMETHODIMP nsMenuItemX::DoCommand()
+void nsMenuItemX::DoCommand()
 {
   // flip "checked" state if we're a checkbox menu, or an un-checked radio menu
-  if (mType == nsIMenuItem::eCheckbox ||
-      (mType == nsIMenuItem::eRadio && !mIsChecked)) {
+  if (mType == eCheckboxMenuItemType ||
+      (mType == eRadioMenuItemType && !mIsChecked)) {
     if (!mContent->AttrValueIs(kNameSpaceID_None, nsWidgetAtoms::autocheck,
                                nsWidgetAtoms::_false, eCaseMatters))
     SetChecked(!mIsChecked);
     /* the AttributeChanged code will update all the internal state */
   }
 
   nsEventStatus status = nsEventStatus_eIgnore;
   nsXULCommandEvent event(PR_TRUE, NS_XUL_COMMAND, nsnull);
 
   mContent->DispatchDOMEvent(&event, nsnull, nsnull, &status);
-  return NS_OK;
 }
     
 
-NS_IMETHODIMP nsMenuItemX::DispatchDOMEvent(const nsString &eventName, PRBool *preventDefaultCalled)
+nsresult nsMenuItemX::DispatchDOMEvent(const nsString &eventName, PRBool *preventDefaultCalled)
 {
   if (!mContent)
     return NS_ERROR_FAILURE;
-  
+
   // get owner document for content
   nsCOMPtr<nsIDocument> parentDoc = mContent->GetOwnerDoc();
   if (!parentDoc) {
     NS_WARNING("Failed to get owner nsIDocument for menu item content");
     return NS_ERROR_FAILURE;
   }
-  
+
   // get interface for creating DOM events from content owner document
   nsCOMPtr<nsIDOMDocumentEvent> DOMEventFactory = do_QueryInterface(parentDoc);
   if (!DOMEventFactory) {
     NS_WARNING("Failed to QI parent nsIDocument to nsIDOMDocumentEvent");
     return NS_ERROR_FAILURE;
   }
-  
+
   // create DOM event
   nsCOMPtr<nsIDOMEvent> event;
   nsresult rv = DOMEventFactory->CreateEvent(NS_LITERAL_STRING("Events"), getter_AddRefs(event));
   if (NS_FAILED(rv)) {
     NS_WARNING("Failed to create nsIDOMEvent");
     return rv;
   }
   event->InitEvent(eventName, PR_TRUE, PR_TRUE);
-  
+
   // mark DOM event as trusted
   nsCOMPtr<nsIPrivateDOMEvent> privateEvent(do_QueryInterface(event));
   privateEvent->SetTrusted(PR_TRUE);
-  
+
   // send DOM event
   nsCOMPtr<nsIDOMEventTarget> eventTarget = do_QueryInterface(mContent);
   rv = eventTarget->DispatchEvent(event, preventDefaultCalled);
   if (NS_FAILED(rv)) {
     NS_WARNING("Failed to send DOM event via nsIDOMEventTarget");
     return rv;
   }
-  
+
   return NS_OK;  
 }
 
 
-NS_METHOD nsMenuItemX::GetShortcutChar(nsString &aText)
-{
-  aText = mKeyEquivalent;
-  return NS_OK;
-}
-
-
 // Walk the sibling list looking for nodes with the same name and
 // uncheck them all.
-void
-nsMenuItemX::UncheckRadioSiblings(nsIContent* inCheckedContent)
+void nsMenuItemX::UncheckRadioSiblings(nsIContent* inCheckedContent)
 {
   nsAutoString myGroupName;
   inCheckedContent->GetAttr(kNameSpaceID_None, nsWidgetAtoms::name, myGroupName);
   if (!myGroupName.Length()) // no groupname, nothing to do
     return;
   
   nsCOMPtr<nsIContent> parent = inCheckedContent->GetParent();
   if (!parent)
@@ -344,23 +295,21 @@ nsMenuItemX::UncheckRadioSiblings(nsICon
   }
 }
 
 
 void nsMenuItemX::SetKeyEquiv(PRUint8 aModifiers, const nsString &aText)
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
-  mModifiers = aModifiers;
-  unsigned int macModifiers = MenuHelpersX::MacModifiersForGeckoModifiers(mModifiers);
+  unsigned int macModifiers = nsMenuUtilsX::MacModifiersForGeckoModifiers(aModifiers);
   [mNativeMenuItem setKeyEquivalentModifierMask:macModifiers];
 
-  mKeyEquivalent = aText;
-  NSString *keyEquivalent = [[NSString stringWithCharacters:(unichar*)mKeyEquivalent.get()
-                                                     length:mKeyEquivalent.Length()] lowercaseString];
+  NSString *keyEquivalent = [[NSString stringWithCharacters:(unichar*)aText.get()
+                                                     length:aText.Length()] lowercaseString];
   if ([keyEquivalent isEqualToString:@" "])
     [mNativeMenuItem setKeyEquivalent:@""];
   else
     [mNativeMenuItem setKeyEquivalent:keyEquivalent];
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
@@ -377,17 +326,17 @@ nsMenuItemX::ObserveAttributeChanged(nsI
 
   if (!aContent)
     return;
   
   if (aContent == mContent) { // our own content node changed
     if (aAttribute == nsWidgetAtoms::checked) {
       // if we're a radio menu, uncheck our sibling radio items. No need to
       // do any of this if we're just a normal check menu.
-      if (mType == nsIMenuItem::eRadio) {
+      if (mType == eRadioMenuItemType) {
         if (mContent->AttrValueIs(kNameSpaceID_None, nsWidgetAtoms::checked,
                                   nsWidgetAtoms::_true, eCaseMatters))
           UncheckRadioSiblings(mContent);
       }
       mMenuParent->SetRebuild(PR_TRUE);
     }
     else if (aAttribute == nsWidgetAtoms::hidden ||
              aAttribute == nsWidgetAtoms::collapsed ||
@@ -427,44 +376,30 @@ nsMenuItemX::ObserveAttributeChanged(nsI
         [mNativeMenuItem setEnabled:YES];
     }
   }
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
 
-void
-nsMenuItemX::ObserveContentRemoved(nsIDocument *aDocument, nsIContent *aChild, PRInt32 aIndexInContainer)
+void nsMenuItemX::ObserveContentRemoved(nsIDocument *aDocument, nsIContent *aChild, PRInt32 aIndexInContainer)
 {
   if (aChild == mCommandContent) {
     mMenuBar->UnregisterForContentChanges(mCommandContent);
     mCommandContent = nsnull;
   }
 
   mMenuParent->SetRebuild(PR_TRUE);
 }
 
 
-void
-nsMenuItemX::ObserveContentInserted(nsIDocument *aDocument, nsIContent *aChild, PRInt32 aIndexInContainer)
+void nsMenuItemX::ObserveContentInserted(nsIDocument *aDocument, nsIContent *aChild, PRInt32 aIndexInContainer)
 {
   mMenuParent->SetRebuild(PR_TRUE);
 }
 
 
-NS_IMETHODIMP
-nsMenuItemX::SetupIcon()
+void nsMenuItemX::SetupIcon()
 {
-  if (!mIcon)
-    return NS_ERROR_OUT_OF_MEMORY;
-
-  return mIcon->SetupIcon();
+  if (mIcon)
+    mIcon->SetupIcon();
 }
-
-
-NS_IMETHODIMP
-nsMenuItemX::GetMenuItemContent(nsIContent ** aMenuItemContent)
-{
-  NS_ENSURE_ARG_POINTER(aMenuItemContent);
-  NS_IF_ADDREF(*aMenuItemContent = mContent);
-  return NS_OK;
-}
diff --git a/widget/src/cocoa/nsMenuUtilsX.h b/widget/src/cocoa/nsMenuUtilsX.h
new file mode 100644
--- /dev/null
+++ b/widget/src/cocoa/nsMenuUtilsX.h
@@ -0,0 +1,63 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is mozilla.org code.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Josh Aas <josh@mozilla.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#ifndef nsMenuUtilsX_h_
+#define nsMenuUtilsX_h_
+
+#include "nscore.h"
+#include "nsGUIEvent.h"
+
+#import <Cocoa/Cocoa.h>
+
+class nsIContent;
+class nsString;
+class nsMenuBarX;
+
+// Namespace containing utility functions used in our native menu implementation.
+namespace nsMenuUtilsX
+{
+  nsEventStatus DispatchCommandTo(nsIContent* aTargetContent);
+  NSString*     CreateTruncatedCocoaLabel(const nsString& itemLabel); // returned object is not retained
+  PRUint8       GeckoModifiersForNodeAttribute(const nsString& modifiersAttribute);
+  unsigned int  MacModifiersForGeckoModifiers(PRUint8 geckoModifiers);
+  nsMenuBarX*   GetHiddenWindowMenuBar(); // returned object is not retained
+  NSMenuItem*   GetStandardEditMenuItem(); // returned object is not retained
+  PRBool        NodeIsHiddenOrCollapsed(nsIContent* inContent);
+}
+
+#endif // nsMenuUtilsX_h_
diff --git a/widget/src/cocoa/nsMenuUtilsX.mm b/widget/src/cocoa/nsMenuUtilsX.mm
new file mode 100644
--- /dev/null
+++ b/widget/src/cocoa/nsMenuUtilsX.mm
@@ -0,0 +1,197 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is mozilla.org code.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Josh Aas <josh@mozilla.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#include "nsMenuUtilsX.h"
+#include "nsMenuBarX.h"
+#include "nsMenuItemX.h"
+#include "nsObjCExceptions.h"
+#include "nsCocoaUtils.h"
+#include "nsCocoaWindow.h"
+#include "nsWidgetAtoms.h"
+
+#import <Carbon/Carbon.h>
+
+nsEventStatus nsMenuUtilsX::DispatchCommandTo(nsIContent* aTargetContent)
+{
+  NS_PRECONDITION(aTargetContent, "null ptr");
+
+  nsEventStatus status = nsEventStatus_eConsumeNoDefault;
+  nsXULCommandEvent event(PR_TRUE, NS_XUL_COMMAND, nsnull);
+
+  // FIXME: Should probably figure out how to init this with the actual
+  // pressed keys, but this is a big old edge case anyway. -dwh
+
+  aTargetContent->DispatchDOMEvent(&event, nsnull, nsnull, &status);
+  return status;
+}
+
+
+NSString* nsMenuUtilsX::CreateTruncatedCocoaLabel(const nsString& itemLabel)
+{
+  NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NIL;
+
+  // ::TruncateThemeText() doesn't take the number of characters to truncate to, it takes a pixel with
+  // to fit the string in. Ugh. I talked it over with sfraser and we couldn't come up with an 
+  // easy way to compute what this should be given the system font, etc, so we're just going
+  // to hard code it to something reasonable and bigger fonts will just have to deal.
+  const short kMaxItemPixelWidth = 300;
+  NSMutableString *label = [[NSMutableString stringWithCharacters:itemLabel.get() length:itemLabel.Length()] retain];
+  ::TruncateThemeText((CFMutableStringRef)label, kThemeMenuItemFont, kThemeStateActive, kMaxItemPixelWidth, truncMiddle, NULL);
+  return label; // caller releases
+
+  NS_OBJC_END_TRY_ABORT_BLOCK_NIL;
+}
+
+
+PRUint8 nsMenuUtilsX::GeckoModifiersForNodeAttribute(const nsString& modifiersAttribute)
+{
+  PRUint8 modifiers = knsMenuItemNoModifier;
+  char* str = ToNewCString(modifiersAttribute);
+  char* newStr;
+  char* token = strtok_r(str, ", \t", &newStr);
+  while (token != NULL) {
+    if (strcmp(token, "shift") == 0)
+      modifiers |= knsMenuItemShiftModifier;
+    else if (strcmp(token, "alt") == 0) 
+      modifiers |= knsMenuItemAltModifier;
+    else if (strcmp(token, "control") == 0) 
+      modifiers |= knsMenuItemControlModifier;
+    else if ((strcmp(token, "accel") == 0) ||
+             (strcmp(token, "meta") == 0)) {
+      modifiers |= knsMenuItemCommandModifier;
+    }
+    token = strtok_r(newStr, ", \t", &newStr);
+  }
+  free(str);
+
+  return modifiers;
+}
+
+
+unsigned int nsMenuUtilsX::MacModifiersForGeckoModifiers(PRUint8 geckoModifiers)
+{
+  unsigned int macModifiers = 0;
+  
+  if (geckoModifiers & knsMenuItemShiftModifier)
+    macModifiers |= NSShiftKeyMask;
+  if (geckoModifiers & knsMenuItemAltModifier)
+    macModifiers |= NSAlternateKeyMask;
+  if (geckoModifiers & knsMenuItemControlModifier)
+    macModifiers |= NSControlKeyMask;
+  if (geckoModifiers & knsMenuItemCommandModifier)
+    macModifiers |= NSCommandKeyMask;
+
+  return macModifiers;
+}
+
+
+nsMenuBarX* nsMenuUtilsX::GetHiddenWindowMenuBar()
+{
+  nsIWidget* hiddenWindowWidgetNoCOMPtr = nsCocoaUtils::GetHiddenWindowWidget();
+  if (hiddenWindowWidgetNoCOMPtr)
+    return static_cast<nsCocoaWindow*>(hiddenWindowWidgetNoCOMPtr)->GetMenuBar();
+  else
+    return nsnull;
+}
+
+
+// It would be nice if we could localize these edit menu names.
+static NSMenuItem* standardEditMenuItem = nil;
+NSMenuItem* nsMenuUtilsX::GetStandardEditMenuItem()
+{
+  NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NIL;
+
+  if (standardEditMenuItem)
+    return standardEditMenuItem;
+
+  standardEditMenuItem = [[NSMenuItem alloc] initWithTitle:@"Edit" action:nil keyEquivalent:@""];
+  NSMenu* standardEditMenu = [[NSMenu alloc] initWithTitle:@"Edit"];
+  [standardEditMenuItem setSubmenu:standardEditMenu];
+  [standardEditMenu release];
+
+  // Add Undo
+  NSMenuItem* undoItem = [[NSMenuItem alloc] initWithTitle:@"Undo" action:@selector(undo:) keyEquivalent:@"z"];
+  [standardEditMenu addItem:undoItem];
+  [undoItem release];
+
+  // Add Redo
+  NSMenuItem* redoItem = [[NSMenuItem alloc] initWithTitle:@"Redo" action:@selector(redo:) keyEquivalent:@"Z"];
+  [standardEditMenu addItem:redoItem];
+  [redoItem release];
+
+  // Add separator
+  [standardEditMenu addItem:[NSMenuItem separatorItem]];
+
+  // Add Cut
+  NSMenuItem* cutItem = [[NSMenuItem alloc] initWithTitle:@"Cut" action:@selector(cut:) keyEquivalent:@"x"];
+  [standardEditMenu addItem:cutItem];
+  [cutItem release];
+
+  // Add Copy
+  NSMenuItem* copyItem = [[NSMenuItem alloc] initWithTitle:@"Copy" action:@selector(copy:) keyEquivalent:@"c"];
+  [standardEditMenu addItem:copyItem];
+  [copyItem release];
+
+  // Add Paste
+  NSMenuItem* pasteItem = [[NSMenuItem alloc] initWithTitle:@"Paste" action:@selector(paste:) keyEquivalent:@"v"];
+  [standardEditMenu addItem:pasteItem];
+  [pasteItem release];
+
+  // Add Delete
+  NSMenuItem* deleteItem = [[NSMenuItem alloc] initWithTitle:@"Delete" action:@selector(delete:) keyEquivalent:@""];
+  [standardEditMenu addItem:deleteItem];
+  [deleteItem release];
+
+  // Add Select All
+  NSMenuItem* selectAllItem = [[NSMenuItem alloc] initWithTitle:@"Select All" action:@selector(selectAll:) keyEquivalent:@"a"];
+  [standardEditMenu addItem:selectAllItem];
+  [selectAllItem release];
+
+  return standardEditMenuItem;
+
+  NS_OBJC_END_TRY_ABORT_BLOCK_NIL;
+}
+
+
+PRBool nsMenuUtilsX::NodeIsHiddenOrCollapsed(nsIContent* inContent)
+{
+  return (inContent->AttrValueIs(kNameSpaceID_None, nsWidgetAtoms::hidden,
+                                 nsWidgetAtoms::_true, eCaseMatters) ||
+          inContent->AttrValueIs(kNameSpaceID_None, nsWidgetAtoms::collapsed,
+                                 nsWidgetAtoms::_true, eCaseMatters));
+}
diff --git a/widget/src/cocoa/nsMenuX.h b/widget/src/cocoa/nsMenuX.h
--- a/widget/src/cocoa/nsMenuX.h
+++ b/widget/src/cocoa/nsMenuX.h
@@ -34,131 +34,103 @@
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 #ifndef nsMenuX_h_
 #define nsMenuX_h_
 
+#import <Cocoa/Cocoa.h>
+#import <Carbon/Carbon.h>
+
+#include "nsMenuBaseX.h"
+#include "nsMenuBarX.h"
 #include "nsCOMPtr.h"
+#include "nsChangeObserver.h"
 #include "nsAutoPtr.h"
-#include "nsIMenu.h"
-#include "nsChangeObserver.h"
-#include "nsMenuBarX.h"
 
-#import <Carbon/Carbon.h>
-#import <Cocoa/Cocoa.h>
-
-
-class nsIMenuBar;
 class nsMenuX;
 class nsMenuItemIconX;
+class nsMenuItemX;
+class nsIWidget;
 
 
 // MenuDelegate is used to receive Cocoa notifications for
 // setting up carbon events
 @interface MenuDelegate : NSObject
 {
   nsMenuX* mGeckoMenu; // weak ref
   EventHandlerRef mEventHandler;
   BOOL mHaveInstalledCarbonEvents;
 }
 - (id)initWithGeckoMenu:(nsMenuX*)geckoMenu;
 @end
 
 
-class nsMenuX : public nsIMenu,
+// Once instantiated, this object lives until its DOM node or its parent window is destroyed.
+// Do not hold references to this, they can become invalid any time the DOM node can be destroyed.
+class nsMenuX : public nsMenuObjectX,
                 public nsChangeObserver
 {
 public:
-    nsMenuX();
-    virtual ~nsMenuX();
+  nsMenuX();
+  virtual ~nsMenuX();
 
-    // If > 0, the OS is indexing all the app's menus (triggered by opening
-    // Help menu on Leopard and higher).  There are some things that are
-    // unsafe to do while this is happening.
-    static PRInt32 sIndexingMenuLevel;
+  // If > 0, the OS is indexing all the app's menus (triggered by opening
+  // Help menu on Leopard and higher).  There are some things that are
+  // unsafe to do while this is happening.
+  static PRInt32 sIndexingMenuLevel;
 
-    NS_DECL_ISUPPORTS
-    NS_DECL_CHANGEOBSERVER
+  NS_DECL_CHANGEOBSERVER
 
-    id GetNativeMenuItem();
+  // nsMenuObjectX
+  void*             NativeData()     {return (void*)mMacMenu;}
+  nsMenuObjectTypeX MenuObjectType() {return eSubmenuObjectType;}
 
-    // nsIMenu Methods
-    NS_IMETHOD Create(nsISupports * aParent, const nsAString &aLabel, const nsAString &aAccessKey, 
-                      nsMenuBarX* aMenuBar, nsIContent* aNode);
-    NS_IMETHOD GetParent(nsISupports *&aParent);
-    NS_IMETHOD GetLabel(nsString &aText);
-    NS_IMETHOD SetLabel(const nsAString &aText);
-    NS_IMETHOD GetAccessKey(nsString &aText);
-    NS_IMETHOD SetAccessKey(const nsAString &aText);
-    NS_IMETHOD AddItem(nsISupports* aText);
-    NS_IMETHOD GetItemCount(PRUint32 &aCount);
-    NS_IMETHOD GetItemAt(const PRUint32 aPos, nsISupports *& aMenuItem);
-    NS_IMETHOD GetVisibleItemCount(PRUint32 &aCount);
-    NS_IMETHOD GetVisibleItemAt(const PRUint32 aPos, nsISupports *& aMenuItem);
-    NS_IMETHOD InsertItemAt(const PRUint32 aPos, nsISupports * aMenuItem);
-    NS_IMETHOD RemoveItem(const PRUint32 aPos);
-    NS_IMETHOD RemoveAll();
-    NS_IMETHOD GetNativeData(void** aData);
-    NS_IMETHOD SetNativeData(void* aData);
-    NS_IMETHOD GetMenuContent(nsIContent ** aMenuNode);
-    NS_IMETHOD SetEnabled(PRBool aIsEnabled);
-    NS_IMETHOD GetEnabled(PRBool* aIsEnabled);
-
-    NS_IMETHOD ChangeNativeEnabledStatusForMenuItem(nsIMenuItem* aMenuItem, PRBool aEnabled);
-    NS_IMETHOD GetMenuRefAndItemIndexForMenuItem(nsISupports* aMenuItem,
-                                                 void**       aMenuRef,
-                                                 PRUint16*    aMenuItemIndex);
-    NS_IMETHOD SetupIcon();
-    nsEventStatus MenuSelected(const nsMenuEvent & aMenuEvent); 
-    void MenuDeselected(const nsMenuEvent & aMenuEvent); 
-    void MenuConstruct(const nsMenuEvent & aMenuEvent, nsIWidget * aParentWindow, void * aMenuNode);
-    void MenuDestruct(const nsMenuEvent & aMenuEvent);
-    void SetRebuild(PRBool aMenuEvent);
+  // nsMenuX
+  nsresult       Create(nsMenuObjectX* aParent, const nsAString &aLabel,
+                        nsMenuBarX* aMenuBar, nsIContent* aNode);
+  PRUint32       GetItemCount();
+  nsMenuObjectX* GetItemAt(PRUint32 aPos);
+  nsresult       GetVisibleItemCount(PRUint32 &aCount);
+  nsMenuObjectX* GetVisibleItemAt(PRUint32 aPos);
+  nsEventStatus  MenuOpened(const nsMenuEvent& aMenuEvent);
+  void           MenuClosed(const nsMenuEvent& aMenuEvent);
+  void           SetRebuild(PRBool aMenuEvent);
+  NSMenuItem*    NativeMenuItem();
 
 protected:
-    // Determines how many menus are visible among the siblings that are before me.
-    // It doesn't matter if I am visible.
-    nsresult CountVisibleBefore(PRUint32* outVisibleBefore);
+  void           MenuConstruct(nsIWidget* aParentWindow, void* aMenuNode);
+  nsresult       RemoveAll();
+  nsresult       SetEnabled(PRBool aIsEnabled);
+  nsresult       GetEnabled(PRBool* aIsEnabled);
+  nsresult       SetupIcon();
+  nsresult       CountVisibleBefore(PRUint32* outVisibleBefore);
+  void           GetMenuPopupContent(nsIContent** aResult);
+  PRBool         OnOpen();
+  PRBool         OnOpened();
+  PRBool         OnClose();
+  PRBool         OnClosed();
+  nsresult       AddMenuItem(nsMenuItemX* aMenuItem);
+  nsresult       AddMenu(nsMenuX* aMenu);
+  void           LoadMenuItem(nsIContent* inMenuItemContent);  
+  void           LoadSubMenu(nsIContent* inMenuContent);
+  GeckoNSMenu*   CreateMenuWithGeckoString(nsString& menuTitle);
 
-    // fetch the content node associated with the menupopup item
-    void GetMenuPopupContent(nsIContent** aResult);
-    
-    // fire handlers for oncreate/ondestroy
-    PRBool OnDestroy();
-    PRBool OnCreate();
-    PRBool OnDestroyed();
-    PRBool OnCreated();
-
-    nsresult AddMenuItem(nsIMenuItem * aMenuItem);
-    nsresult AddMenu(nsIMenu * aMenu);
-
-    void LoadMenuItem(nsIContent* inMenuItemContent);  
-    void LoadSubMenu(nsIContent* inMenuContent);
-
-    GeckoNSMenu* CreateMenuWithGeckoString(nsString& menuTitle);
-
-protected:
-    nsString                    mLabel;
-    nsCOMArray<nsISupports>     mMenuItemsArray;
-    PRUint32                    mVisibleItemsCount;     // caching number of visible items in mMenuItemsArray
-
-    nsISupports*                mParent;                // weak, my parent owns me
-    nsMenuBarX*                 mMenuBar;               // weak ref, it will outlive us
-    nsCOMPtr<nsIContent>        mMenuContent;           // the |menu| tag, strong ref
-    nsRefPtr<nsMenuItemIconX>   mIcon;
-
-    // Mac specific
-    PRInt16                     mMacMenuID;
-    GeckoNSMenu*                mMacMenu;               // strong ref, we own it
-    MenuDelegate*               mMenuDelegate;          // strong ref, we keep this around to get events for us
-    NSMenuItem*                 mNativeMenuItem;        // strong ref, we own
-    PRPackedBool                mIsEnabled;
-    PRPackedBool                mDestroyHandlerCalled;
-    PRPackedBool                mNeedsRebuild;
-    PRPackedBool                mConstructed;
-    PRPackedBool                mVisible;               // are we visible to the user?
-    PRPackedBool                mXBLAttached;
+  nsTArray< nsAutoPtr<nsMenuObjectX> > mMenuObjectsArray;
+  nsString                  mLabel;
+  PRUint32                  mVisibleItemsCount; // cache
+  nsMenuObjectX*            mParent; // [weak]
+  nsMenuBarX*               mMenuBar; // [weak]
+  nsRefPtr<nsMenuItemIconX> mIcon;
+  GeckoNSMenu*              mMacMenu; // [strong]
+  MenuDelegate*             mMenuDelegate; // [strong]
+  NSMenuItem*               mNativeMenuItem; // [strong]
+  PRPackedBool              mIsEnabled;
+  PRPackedBool              mDestroyHandlerCalled;
+  PRPackedBool              mNeedsRebuild;
+  PRPackedBool              mConstructed;
+  PRPackedBool              mVisible;
+  PRPackedBool              mXBLAttached;
 };
 
 #endif // nsMenuX_h_
diff --git a/widget/src/cocoa/nsMenuX.mm b/widget/src/cocoa/nsMenuX.mm
--- a/widget/src/cocoa/nsMenuX.mm
+++ b/widget/src/cocoa/nsMenuX.mm
@@ -32,73 +32,63 @@
  * decision by deleting the provisions above and replace them with the notice
  * and other provisions required by the GPL or the LGPL. If you do not delete
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 #include "nsMenuX.h"
+#include "nsMenuItemX.h"
+#include "nsMenuUtilsX.h"
+#include "nsMenuItemIconX.h"
 
+#include "nsObjCExceptions.h"
+
+#include "nsToolkit.h"
+#include "nsCocoaUtils.h"
 #include "nsCOMPtr.h"
-#include "nsObjCExceptions.h"
+#include "prinrval.h"
+#include "nsString.h"
+#include "nsReadableUtils.h"
+#include "nsUnicharUtils.h"
+#include "plstr.h"
+#include "nsWidgetAtoms.h"
+#include "nsGUIEvent.h"
+#include "nsCRT.h"
+
 #include "nsIDocument.h"
 #include "nsIContent.h"
 #include "nsIDOMDocument.h"
 #include "nsIDocumentObserver.h"
 #include "nsIComponentManager.h"
-#include "prinrval.h"
 #include "nsIRollupListener.h"
-
-#include "nsMenuItemIconX.h"
-#include "nsIMenu.h"
-#include "nsIMenuBar.h"
-#include "nsIMenuItem.h"
-#include "nsToolkit.h"
-#include "nsCocoaUtils.h"
-
-#include "nsString.h"
-#include "nsReadableUtils.h"
-#include "nsUnicharUtils.h"
-#include "plstr.h"
-
-#include "nsINameSpaceManager.h"
-#include "nsWidgetAtoms.h"
+#include "nsIDOMElement.h"
 #include "nsIXBLService.h"
 #include "nsIServiceManager.h"
-
-#include "nsGUIEvent.h"
-
-#include "nsCRT.h"
 
 #include "jsapi.h"
 #include "nsIScriptGlobalObject.h"
 #include "nsIScriptContext.h"
 #include "nsIXPConnect.h"
 
 // externs defined in nsChildView.mm
 extern nsIRollupListener * gRollupListener;
 extern nsIWidget         * gRollupWidget;
 
+extern "C" MenuRef _NSGetCarbonMenu(NSMenu* aMenu);
+
 static PRBool gConstructingMenu = PR_FALSE;
-
 static PRBool gMenuMethodsSwizzled = PR_FALSE;
-
-// CIDs
-#include "nsWidgetsCID.h"
-static NS_DEFINE_CID(kMenuCID,     NS_MENU_CID);
-static NS_DEFINE_CID(kMenuItemCID, NS_MENUITEM_CID);
-
-NS_IMPL_ISUPPORTS1(nsMenuX, nsIMenu)
 
 PRInt32 nsMenuX::sIndexingMenuLevel = 0;
 
 
 nsMenuX::nsMenuX()
-: mVisibleItemsCount(0), mParent(nsnull), mMenuBar(nsnull), mMacMenuID(0), 
+: mVisibleItemsCount(0), mParent(nsnull), mMenuBar(nsnull),
   mMacMenu(nil), mNativeMenuItem(nil), mIsEnabled(PR_TRUE),
   mDestroyHandlerCalled(PR_FALSE), mNeedsRebuild(PR_TRUE),
   mConstructed(PR_FALSE), mVisible(PR_TRUE), mXBLAttached(PR_FALSE)
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
   if (nsToolkit::OnLeopardOrLater() && !gMenuMethodsSwizzled) {
     nsToolkit::SwizzleMethods([NSMenu class], @selector(_addItem:toTable:),
@@ -111,424 +101,305 @@ nsMenuX::nsMenuX()
     gMenuMethodsSwizzled = PR_TRUE;
   }
 
   mMenuDelegate = [[MenuDelegate alloc] initWithGeckoMenu:this];
     
   if (!nsMenuBarX::sNativeEventTarget)
     nsMenuBarX::sNativeEventTarget = [[NativeMenuItemTarget alloc] init];
 
+  MOZ_COUNT_CTOR(nsMenuX);
+
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
 
 nsMenuX::~nsMenuX()
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
   RemoveAll();
 
   [mMacMenu setDelegate:nil];
   [mMacMenu release];
   [mMenuDelegate release];
   [mNativeMenuItem release];
 
   // alert the change notifier we don't care no more
-  if (mMenuContent)
-    mMenuBar->UnregisterForContentChanges(mMenuContent);
+  if (mContent)
+    mMenuBar->UnregisterForContentChanges(mContent);
+
+  MOZ_COUNT_DTOR(nsMenuX);
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
 
-NS_IMETHODIMP
-nsMenuX::Create(nsISupports * aParent, const nsAString &aLabel, const nsAString &aAccessKey, 
-                nsMenuBarX* aMenuBar, nsIContent* aNode)
+nsresult nsMenuX::Create(nsMenuObjectX* aParent, const nsAString& aLabel,
+                         nsMenuBarX* aMenuBar, nsIContent* aNode)
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;
 
-  mMenuContent = aNode;
-  NS_ASSERTION(mMenuContent, "Menu not given a dom node at creation time");
+  mContent = aNode;
+  mLabel = aLabel;
+  mMacMenu = CreateMenuWithGeckoString(mLabel);
 
   // register this menu to be notified when changes are made to our content object
   mMenuBar = aMenuBar; // weak ref
   NS_ASSERTION(mMenuBar, "No menu bar given, must have one");
-  mMenuBar->RegisterForContentChanges(mMenuContent, this);
+  mMenuBar->RegisterForContentChanges(mContent, this);
 
   mParent = aParent;
   // our parent could be either a menu bar (if we're toplevel) or a menu (if we're a submenu)
-  nsCOMPtr<nsIMenuBar> menubar = do_QueryInterface(aParent);
-  nsCOMPtr<nsIMenu> menu = do_QueryInterface(aParent);
-  NS_ASSERTION(menubar || menu, "Menu parent not a menu bar or menu!");
+  nsMenuObjectTypeX parentType = mParent->MenuObjectType();
+  NS_ASSERTION((parentType == eMenuBarObjectType || parentType == eSubmenuObjectType),
+               "Menu parent not a menu bar or menu!");
 
-  // SetLabel will create the native menu if it has not been created yet
-  SetLabel(aLabel);
-
-  if (NodeIsHiddenOrCollapsed(mMenuContent))
+  if (nsMenuUtilsX::NodeIsHiddenOrCollapsed(mContent))
+    mVisible = PR_FALSE;
+  if (mContent->GetChildCount() == 0)
     mVisible = PR_FALSE;
 
-  if (menubar && mMenuContent->GetChildCount() == 0)
-    mVisible = PR_FALSE;
+  SetEnabled(!mContent->AttrValueIs(kNameSpaceID_None, nsWidgetAtoms::disabled,
+                                    nsWidgetAtoms::_true, eCaseMatters));
 
-  SetEnabled(!mMenuContent->AttrValueIs(kNameSpaceID_None, nsWidgetAtoms::disabled,
-                                        nsWidgetAtoms::_true, eCaseMatters));
-
-  NSString *newCocoaLabelString = MenuHelpersX::CreateTruncatedCocoaLabel(mLabel);
+  NSString *newCocoaLabelString = nsMenuUtilsX::CreateTruncatedCocoaLabel(mLabel);
   mNativeMenuItem = [[NSMenuItem alloc] initWithTitle:newCocoaLabelString action:nil keyEquivalent:@""];
   [newCocoaLabelString release];
 
   [mNativeMenuItem setEnabled:(BOOL)mIsEnabled];
 
   // We call MenuConstruct here because keyboard commands are dependent upon
   // native menu items being created. If we only call MenuConstruct when a menu
   // is actually selected, then we can't access keyboard commands until the
   // menu gets selected, which is bad.
-  nsMenuEvent fake(PR_TRUE, 0, nsnull);
-  MenuConstruct(fake, nsnull, nsnull);
-  
-  if (menu)
-    mIcon = new nsMenuItemIconX(static_cast<nsIMenu*>(this), menu, mMenuContent, mNativeMenuItem);
+  MenuConstruct(nsnull, nsnull);
+
+  mIcon = new nsMenuItemIconX(this, mContent, mNativeMenuItem);
 
   return NS_OK;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
 }
 
 
-NS_IMETHODIMP nsMenuX::GetParent(nsISupports*& aParent)
-{
-  aParent = mParent;
-  NS_IF_ADDREF(aParent);
-  return NS_OK;
-}
-
-
-NS_IMETHODIMP nsMenuX::GetLabel(nsString &aText)
-{
-  aText = mLabel;
-  return NS_OK;
-}
-
-
-NS_IMETHODIMP nsMenuX::SetLabel(const nsAString &aText)
-{
-  mLabel = aText;
-  // create an actual NSMenu if this is the first time
-  if (mMacMenu == nil)
-    mMacMenu = CreateMenuWithGeckoString(mLabel);
-  return NS_OK;
-}
-
-
-NS_IMETHODIMP nsMenuX::GetAccessKey(nsString &aText)
-{
-  return NS_ERROR_NOT_IMPLEMENTED;
-}
-
-
-NS_IMETHODIMP nsMenuX::SetAccessKey(const nsAString &aText)
-{
-  return NS_ERROR_NOT_IMPLEMENTED;
-}
-
-
-// This should only be used internally by our menu implementation. In all other
-// cases menus and their items should be added and modified via the DOM.
-NS_IMETHODIMP nsMenuX::AddItem(nsISupports* aItem)
-{
-  nsresult rv = NS_ERROR_FAILURE;
-
-  if (!aItem)
-    return NS_ERROR_INVALID_ARG;
-
-  // Figure out what we're adding
-  nsCOMPtr<nsIMenuItem> menuItem(do_QueryInterface(aItem, &rv));
-  if (NS_SUCCEEDED(rv)) {
-    rv = AddMenuItem(menuItem);
-  }
-  else {
-    nsCOMPtr<nsIMenu> menu(do_QueryInterface(aItem, &rv));
-    if (NS_SUCCEEDED(rv))
-      rv = AddMenu(menu);
-  }
-
-  return rv;
-}
-
-
-nsresult nsMenuX::AddMenuItem(nsIMenuItem * aMenuItem)
+nsresult nsMenuX::AddMenuItem(nsMenuItemX* aMenuItem)
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;
 
   if (!aMenuItem)
     return NS_ERROR_INVALID_ARG;
 
-  nsCOMPtr<nsIContent> menuItemContent;
-  aMenuItem->GetMenuItemContent(getter_AddRefs(menuItemContent));
-  mMenuItemsArray.AppendObject(aMenuItem); // owning ref
-  if (menuItemContent && NodeIsHiddenOrCollapsed(menuItemContent))
+  mMenuObjectsArray.AppendElement(aMenuItem);
+  if (nsMenuUtilsX::NodeIsHiddenOrCollapsed(aMenuItem->Content()))
     return NS_OK;
   ++mVisibleItemsCount;
- 
+
+  NSMenuItem* newNativeMenuItem = (NSMenuItem*)aMenuItem->NativeData();
+
   // add the menu item to this menu
-  NSMenuItem* newNativeMenuItem;
-  aMenuItem->GetNativeData((void*&)newNativeMenuItem);
-  if (!newNativeMenuItem)
-    return NS_ERROR_FAILURE;
   [mMacMenu addItem:newNativeMenuItem];
 
   // set up target/action
   [newNativeMenuItem setTarget:nsMenuBarX::sNativeEventTarget];
   [newNativeMenuItem setAction:@selector(menuItemHit:)];
-  
+
   // set its command. we get the unique command id from the menubar
   [newNativeMenuItem setTag:mMenuBar->RegisterForCommand(aMenuItem)];
-  
+
   return NS_OK;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
 }
 
 
-nsresult nsMenuX::AddMenu(nsIMenu * aMenu)
+nsresult nsMenuX::AddMenu(nsMenuX* aMenu)
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;
 
   // Add a submenu
   if (!aMenu)
     return NS_ERROR_NULL_POINTER;
 
-  nsCOMPtr<nsIContent> menuContent;
-  aMenu->GetMenuContent(getter_AddRefs(menuContent));
-  mMenuItemsArray.AppendObject(aMenu); // owning ref
-  if (menuContent && NodeIsHiddenOrCollapsed(menuContent))
+  mMenuObjectsArray.AppendElement(aMenu);
+  if (nsMenuUtilsX::NodeIsHiddenOrCollapsed(aMenu->Content()))
     return NS_OK;
   ++mVisibleItemsCount;
 
   // We have to add a menu item and then associate the menu with it
-  NSMenuItem* newNativeMenuItem = (static_cast<nsMenuX*>(aMenu))->GetNativeMenuItem();
+  NSMenuItem* newNativeMenuItem = (static_cast<nsMenuX*>(aMenu))->NativeMenuItem();
   if (!newNativeMenuItem)
     return NS_ERROR_FAILURE;
   [mMacMenu addItem:newNativeMenuItem];
-  
-  NSMenu* childMenu;
-  if (aMenu->GetNativeData((void**)&childMenu) == NS_OK)
-    [newNativeMenuItem setSubmenu:childMenu];
+
+  [newNativeMenuItem setSubmenu:(NSMenu*)aMenu->NativeData()];
 
   return NS_OK;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
 }
 
 
 // Includes all items, including hidden/collapsed ones
-NS_IMETHODIMP nsMenuX::GetItemCount(PRUint32 &aCount)
+PRUint32 nsMenuX::GetItemCount()
 {
-  aCount = mMenuItemsArray.Count();
-  return NS_OK;
+  return mMenuObjectsArray.Length();
 }
 
 
 // Includes all items, including hidden/collapsed ones
-NS_IMETHODIMP nsMenuX::GetItemAt(const PRUint32 aPos, nsISupports *& aMenuItem)
+nsMenuObjectX* nsMenuX::GetItemAt(PRUint32 aPos)
 {
-  if (aPos >= (PRUint32)mMenuItemsArray.Count())
-    return NS_ERROR_INVALID_ARG;
+  if (aPos >= (PRUint32)mMenuObjectsArray.Length())
+    return NULL;
 
-  aMenuItem = mMenuItemsArray.ObjectAt(aPos);
-  NS_IF_ADDREF(aMenuItem);
-  return NS_OK;
+  return mMenuObjectsArray[aPos];
 }
 
 
-// Checks both nsIMenus and nsIMenuItems. Not suitable for menus that are children
-// of nsIMenuBar, which has slightly different rules for visiblity.
-static PRBool MenuNodeIsVisible(nsISupports *item)
+// Checks submenus and menu items. Not suitable for submenus that are children
+// of a menu bar, which has slightly different rules for visiblity.
+static PRBool MenuNodeIsVisible(nsMenuObjectX* item)
 {
-  // Find the content for this item in the menu, be it a MenuItem or a Menu
-  nsCOMPtr<nsIContent> itemContent;
-  nsCOMPtr<nsIMenuItem> menuItem = do_QueryInterface(item);
-  if (menuItem) {
-    menuItem->GetMenuItemContent(getter_AddRefs(itemContent));
-  }
-  else {
-    nsCOMPtr<nsIMenu> menu = do_QueryInterface(item);
-    if (menu)
-      menu->GetMenuContent(getter_AddRefs(itemContent));
-  }
-  
-  // Check the visibility of the item's content
-  return (itemContent && !NodeIsHiddenOrCollapsed(itemContent));
+  return (!nsMenuUtilsX::NodeIsHiddenOrCollapsed(item->Content()));
 }
 
 
 // Only includes visible items
-NS_IMETHODIMP nsMenuX::GetVisibleItemCount(PRUint32 &aCount)
+nsresult nsMenuX::GetVisibleItemCount(PRUint32 &aCount)
 {
   aCount = mVisibleItemsCount;
   return NS_OK;
 }
 
 
 // Only includes visible items. Note that this is provides O(N) access
 // If you need to iterate or search, consider using GetItemAt and doing your own filtering
-NS_IMETHODIMP nsMenuX::GetVisibleItemAt(const PRUint32 aPos, nsISupports *& aMenuItem)
+nsMenuObjectX* nsMenuX::GetVisibleItemAt(PRUint32 aPos)
 {
-  PRUint32 count = mMenuItemsArray.Count();
+  
+  PRUint32 count = mMenuObjectsArray.Length();
   if (aPos >= mVisibleItemsCount || aPos >= count)
-    return NS_ERROR_INVALID_ARG;
+    return NULL;
 
   // If there are no invisible items, can provide direct access
-  if (mVisibleItemsCount == count) {
-    nsCOMPtr<nsISupports> item = mMenuItemsArray.ObjectAt(aPos);
-    aMenuItem = item;
-    NS_IF_ADDREF(aMenuItem);
-    return NS_OK;
-  }
+  if (mVisibleItemsCount == count)
+    return mMenuObjectsArray[aPos];
 
   // Otherwise, traverse the array until we find the the item we're looking for.
-  nsCOMPtr<nsISupports> item;
+  nsMenuObjectX* item;
   PRUint32 visibleNodeIndex = 0;
   for (PRUint32 i = 0; i < count; i++) {
-    item = mMenuItemsArray.ObjectAt(i);
+    item = mMenuObjectsArray[i];
     if (MenuNodeIsVisible(item)) {
       if (aPos == visibleNodeIndex) {
         // we found the visible node we're looking for, return it
-        aMenuItem = item;
-        NS_IF_ADDREF(aMenuItem);
-        return NS_OK;
+        return item;
       }
       visibleNodeIndex++;
     }
   }
 
-  return NS_ERROR_FAILURE;
+  return NULL;
 }
 
 
-NS_IMETHODIMP nsMenuX::InsertItemAt(const PRUint32 aPos, nsISupports * aMenuItem)
-{
-  return NS_ERROR_NOT_IMPLEMENTED;
-}
-
-
-NS_IMETHODIMP nsMenuX::RemoveItem(const PRUint32 aPos)
-{
-  return NS_ERROR_NOT_IMPLEMENTED;
-}
-
-
-NS_IMETHODIMP nsMenuX::RemoveAll()
+nsresult nsMenuX::RemoveAll()
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;
 
   if (mMacMenu) {
     // clear command id's
     int itemCount = [mMacMenu numberOfItems];
     for (int i = 0; i < itemCount; i++)
       mMenuBar->UnregisterCommand((PRUint32)[[mMacMenu itemAtIndex:i] tag]);
     // get rid of Cocoa menu items
     for (int i = [mMacMenu numberOfItems] - 1; i >= 0; i--)
       [mMacMenu removeItemAtIndex:i];
   }
-  // get rid of Gecko menu items
-  mMenuItemsArray.Clear();
+
+  mMenuObjectsArray.Clear();
   mVisibleItemsCount = 0;
-  
+
   return NS_OK;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
 }
 
 
-NS_IMETHODIMP nsMenuX::GetNativeData(void ** aData)
-{
-  *aData = mMacMenu;
-  return NS_OK;
-}
-
-
-NS_IMETHODIMP nsMenuX::SetNativeData(void * aData)
-{
-  NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;
-
-  [mMacMenu release];
-  mMacMenu = [(NSMenu*)aData retain];
-  return NS_OK;
-
-  NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
-}
-
-
-nsEventStatus nsMenuX::MenuSelected(const nsMenuEvent & aMenuEvent)
+nsEventStatus nsMenuX::MenuOpened(const nsMenuEvent & aMenuEvent)
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_RETURN;
-
-  // printf("JOSH: MenuSelected called for %s \n", NS_LossyConvertUTF16toASCII(mLabel).get());
 
   // Determine if this is the correct menu to handle the event
   MenuRef selectedMenuHandle = (MenuRef)aMenuEvent.mCommand;
 
   // at this point, the carbon event handler was installed so there
   // must be a carbon MenuRef to be had
   if (_NSGetCarbonMenu(mMacMenu) == selectedMenuHandle) {
     // Open the node.
-    mMenuContent->SetAttr(kNameSpaceID_None, nsWidgetAtoms::open, NS_LITERAL_STRING("true"), PR_TRUE);
+    mContent->SetAttr(kNameSpaceID_None, nsWidgetAtoms::open, NS_LITERAL_STRING("true"), PR_TRUE);
 
-    // Fire our oncreate handler. If we're told to stop, don't build the menu at all
-    PRBool keepProcessing = OnCreate();
+    // Fire a handler. If we're told to stop, don't build the menu at all
+    PRBool keepProcessing = OnOpen();
 
     if (!mNeedsRebuild || !keepProcessing)
       return nsEventStatus_eConsumeNoDefault;
 
     if (!mConstructed || mNeedsRebuild) {
       if (mNeedsRebuild)
         RemoveAll();
 
-      MenuConstruct(aMenuEvent, nsnull, nsnull);
+      MenuConstruct(nsnull, nsnull);
       mConstructed = true;
     }
 
-    OnCreated();  // Now that it's built, fire the popupShown event.
+    OnOpened();
 
     return nsEventStatus_eConsumeNoDefault;  
   }
   else {
     // Make sure none of our submenus are the ones that should be handling this
-    for (PRUint32 i = mMenuItemsArray.Count() - 1; i >= 0; i--) {
-      nsISupports* menuSupports = mMenuItemsArray.ObjectAt(i);
-      nsCOMPtr<nsIMenu> menu = do_QueryInterface(menuSupports);
-      if (menu) {
-        nsEventStatus status = menu->MenuSelected(aMenuEvent);
+    PRUint32 count = mMenuObjectsArray.Length();
+    for (PRUint32 i = 0; i < count; i++) {
+      nsMenuObjectX* menuObject = mMenuObjectsArray[i];
+      if (menuObject->MenuObjectType() == eSubmenuObjectType) {
+        nsEventStatus status = static_cast<nsMenuX*>(menuObject)->MenuOpened(aMenuEvent);
         if (status != nsEventStatus_eIgnore)
           return status;
       }  
     }
   }
 
   return nsEventStatus_eIgnore;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_RETURN(nsEventStatus_eIgnore);
 }
 
 
-void nsMenuX::MenuDeselected(const nsMenuEvent & aMenuEvent)
+void nsMenuX::MenuClosed(const nsMenuEvent & aMenuEvent)
 {
-  // Destroy the menu
   if (mConstructed) {
-    MenuDestruct(aMenuEvent);
+    // Don't close if a handler tells us to stop.
+    if (!OnClose())
+      return;
+
+    if (mNeedsRebuild)
+      mConstructed = false;
+
+    mContent->UnsetAttr(kNameSpaceID_None, nsWidgetAtoms::open, PR_TRUE);
+
+    OnClosed();
+
     mConstructed = false;
   }
 }
 
 
-void nsMenuX::MenuConstruct(
-    const nsMenuEvent & aMenuEvent,
-    nsIWidget         * aParentWindow, 
-    void              * aMenuNode)
+void nsMenuX::MenuConstruct(nsIWidget* aParentWindow, void* aMenuNode)
 {
   mConstructed = false;
   gConstructingMenu = PR_TRUE;
   
   // reset destroy handler flag so that we'll know to fire it next time this menu goes away.
   mDestroyHandlerCalled = PR_FALSE;
   
   //printf("nsMenuX::MenuConstruct called for %s = %d \n", NS_LossyConvertUTF16toASCII(mLabel).get(), mMacMenu);
@@ -577,175 +448,156 @@ void nsMenuX::MenuConstruct(
         LoadMenuItem(child);
       else if (tag == nsWidgetAtoms::menu)
         LoadSubMenu(child);
     }
   } // for each menu item
 
   gConstructingMenu = PR_FALSE;
   mNeedsRebuild = PR_FALSE;
-  // printf("Done building, mMenuItemsArray.Count() = %d \n", mMenuItemsArray.Count());
-}
-
-
-void nsMenuX::MenuDestruct(const nsMenuEvent & aMenuEvent)
-{
-  // printf("nsMenuX::MenuDestruct() called for %s \n", NS_LossyConvertUTF16toASCII(mLabel).get());
-
-  // Fire our ondestroy handler. If we're told to stop, don't destroy the menu.
-  if (!OnDestroy())
-    return;
-
-  if (mNeedsRebuild)
-    mConstructed = false;
-  // Close the node.
-  mMenuContent->UnsetAttr(kNameSpaceID_None, nsWidgetAtoms::open, PR_TRUE);
-  OnDestroyed();
+  // printf("Done building, mMenuObjectsArray.Count() = %d \n", mMenuObjectsArray.Count());
 }
 
 
 void nsMenuX::SetRebuild(PRBool aNeedsRebuild)
 {
   if (!gConstructingMenu)
     mNeedsRebuild = aNeedsRebuild;
 }
 
 
-NS_IMETHODIMP nsMenuX::SetEnabled(PRBool aIsEnabled)
+nsresult nsMenuX::SetEnabled(PRBool aIsEnabled)
 {
   if (aIsEnabled != mIsEnabled) {
     // we always want to rebuild when this changes
     SetRebuild(PR_TRUE); 
     mIsEnabled = aIsEnabled;
   }
   return NS_OK;
 }
 
 
-NS_IMETHODIMP nsMenuX::GetEnabled(PRBool* aIsEnabled)
+nsresult nsMenuX::GetEnabled(PRBool* aIsEnabled)
 {
   NS_ENSURE_ARG_POINTER(aIsEnabled);
   *aIsEnabled = mIsEnabled;
-  return NS_OK;
-}
-
-
-NS_IMETHODIMP nsMenuX::GetMenuContent(nsIContent ** aMenuContent)
-{
-  NS_ENSURE_ARG_POINTER(aMenuContent);
-  NS_IF_ADDREF(*aMenuContent = mMenuContent);
   return NS_OK;
 }
 
 
 GeckoNSMenu* nsMenuX::CreateMenuWithGeckoString(nsString& menuTitle)
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NIL;
 
   NSString* title = [NSString stringWithCharacters:(UniChar*)menuTitle.get() length:menuTitle.Length()];
   GeckoNSMenu* myMenu = [[GeckoNSMenu alloc] initWithTitle:title];
   [myMenu setDelegate:mMenuDelegate];
-  
+
   // We don't want this menu to auto-enable menu items because then Cocoa
   // overrides our decisions and things get incorrectly enabled/disabled.
   [myMenu setAutoenablesItems:NO];
-  
+
   // we used to install Carbon event handlers here, but since NSMenu* doesn't
   // create its underlying MenuRef until just before display, we delay until
   // that happens. Now we install the event handlers when Cocoa notifies
   // us that a menu is about to display - see the Cocoa MenuDelegate class.
-  
+
   return myMenu;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NIL;
 }
 
 
 void nsMenuX::LoadMenuItem(nsIContent* inMenuItemContent)
 {
   if (!inMenuItemContent)
-    return;
-
-  // create nsMenuItem
-  nsCOMPtr<nsIMenuItem> pnsMenuItem = do_CreateInstance(kMenuItemCID);
-  if (!pnsMenuItem)
     return;
 
   nsAutoString menuitemName;
   inMenuItemContent->GetAttr(kNameSpaceID_None, nsWidgetAtoms::label, menuitemName);
 
   // printf("menuitem %s \n", NS_LossyConvertUTF16toASCII(menuitemName).get());
 
-  nsIMenuItem::EMenuItemType itemType = nsIMenuItem::eRegular;
+  EMenuItemType itemType = eRegularMenuItemType;
   if (inMenuItemContent->Tag() == nsWidgetAtoms::menuseparator) {
-    itemType = nsIMenuItem::eSeparator;
+    itemType = eSeparatorMenuItemType;
   }
   else {
     static nsIContent::AttrValuesArray strings[] =
   {&nsWidgetAtoms::checkbox, &nsWidgetAtoms::radio, nsnull};
     switch (inMenuItemContent->FindAttrValueIn(kNameSpaceID_None, nsWidgetAtoms::type,
                                                strings, eCaseMatters)) {
-      case 0: itemType = nsIMenuItem::eCheckbox; break;
-      case 1: itemType = nsIMenuItem::eRadio; break;
+      case 0: itemType = eCheckboxMenuItemType; break;
+      case 1: itemType = eRadioMenuItemType; break;
     }
   }
 
   // Create the item.
-  pnsMenuItem->Create(this, menuitemName, itemType, mMenuBar, inMenuItemContent);
+  nsMenuItemX* menuItem = new nsMenuItemX();
+  if (!menuItem)
+    return;
 
-  AddMenuItem(pnsMenuItem);
+  nsresult rv = menuItem->Create(this, menuitemName, itemType, mMenuBar, inMenuItemContent);
+  if (NS_FAILED(rv)) {
+    delete menuItem;
+    return;
+  }
+
+  AddMenuItem(menuItem);
 
   // This needs to happen after the nsIMenuItem object is inserted into
   // our item array in AddMenuItem()
-  pnsMenuItem->SetupIcon();
+  menuItem->SetupIcon();
 }
 
 
 void nsMenuX::LoadSubMenu(nsIContent* inMenuContent)
 {
   nsAutoString menuName; 
   inMenuContent->GetAttr(kNameSpaceID_None, nsWidgetAtoms::label, menuName);
   //printf("Creating Menu [%s] \n", NS_LossyConvertUTF16toASCII(menuName).get());
 
-  // Create nsMenu
-  nsCOMPtr<nsIMenu> pnsMenu(do_CreateInstance(kMenuCID));
-  if (!pnsMenu)
+  nsAutoPtr<nsMenuX> menu(new nsMenuX());
+  if (!menu)
     return;
 
-  pnsMenu->Create(reinterpret_cast<nsISupports*>(this), menuName, EmptyString(), mMenuBar, inMenuContent);
+  nsresult rv = menu->Create(this, menuName, mMenuBar, inMenuContent);
+  if (NS_FAILED(rv))
+    return;
 
-  AddMenu(pnsMenu);
+  AddMenu(menu);
 
   // This needs to happen after the nsIMenu object is inserted into
   // our item array in AddMenu()
-  pnsMenu->SetupIcon();
+  menu->SetupIcon();
+
+  menu.forget();
 }
 
 
-// Fire our oncreate handler. Returns TRUE if we should keep processing the event,
-// FALSE if the handler wants to stop the creation of the menu
-PRBool nsMenuX::OnCreate()
+// This menu is about to open. Returns TRUE if we should keep processing the event,
+// FALSE if the handler wants to stop the opening of the menu.
+PRBool nsMenuX::OnOpen()
 {
   nsEventStatus status = nsEventStatus_eIgnore;
   nsMouseEvent event(PR_TRUE, NS_XUL_POPUP_SHOWING, nsnull,
                      nsMouseEvent::eReal);
   
   nsCOMPtr<nsIContent> popupContent;
   GetMenuPopupContent(getter_AddRefs(popupContent));
   
   nsresult rv = NS_OK;
-  nsIContent* dispatchTo = popupContent ? popupContent : mMenuContent;
+  nsIContent* dispatchTo = popupContent ? popupContent : mContent;
   rv = dispatchTo->DispatchDOMEvent(&event, nsnull, nsnull, &status);
   if (NS_FAILED(rv) || status == nsEventStatus_eConsumeNoDefault)
     return PR_FALSE;
 
-  // the menu is going to show and the oncreate handler has executed. We
-  // now need to walk our menu items, checking to see if any of them have
-  // a command attribute. If so, several apptributes must potentially
-  // be updated.
+  // If the open is going to succeed we need to walk our menu items, checking to
+  // see if any of them have a command attribute. If so, several apptributes
+  // must potentially be updated.
   if (popupContent) {
     nsCOMPtr<nsIDOMDocument> domDoc(do_QueryInterface(popupContent->GetDocument()));
 
     PRUint32 count = popupContent->GetChildCount();
     for (PRUint32 i = 0; i < count; i++) {
       nsIContent *grandChild = popupContent->GetChildAt(i);
       if (grandChild->Tag() == nsWidgetAtoms::menuitem) {
         // See if we have a command attribute.
@@ -792,72 +644,72 @@ PRBool nsMenuX::OnCreate()
       }
     }
   }
   
   return PR_TRUE;
 }
 
 
-PRBool nsMenuX::OnCreated()
+PRBool nsMenuX::OnOpened()
 {
   nsEventStatus status = nsEventStatus_eIgnore;
   nsMouseEvent event(PR_TRUE, NS_XUL_POPUP_SHOWN, nsnull, nsMouseEvent::eReal);
   
   nsCOMPtr<nsIContent> popupContent;
   GetMenuPopupContent(getter_AddRefs(popupContent));
 
   nsresult rv = NS_OK;
-  nsIContent* dispatchTo = popupContent ? popupContent : mMenuContent;
+  nsIContent* dispatchTo = popupContent ? popupContent : mContent;
   rv = dispatchTo->DispatchDOMEvent(&event, nsnull, nsnull, &status);
   if (NS_FAILED(rv) || status == nsEventStatus_eConsumeNoDefault)
     return PR_FALSE;  
   
   return PR_TRUE;
 }
 
 
-// Fire our ondestroy handler. Returns TRUE if we should keep processing the event,
-// FALSE if the handler wants to stop the destruction of the menu
-PRBool nsMenuX::OnDestroy()
+// Returns TRUE if we should keep processing the event, FALSE if the handler
+// wants to stop the closing of the menu.
+PRBool nsMenuX::OnClose()
 {
   if (mDestroyHandlerCalled)
     return PR_TRUE;
 
   nsEventStatus status = nsEventStatus_eIgnore;
   nsMouseEvent event(PR_TRUE, NS_XUL_POPUP_HIDING, nsnull,
                      nsMouseEvent::eReal);
 
   nsCOMPtr<nsIContent> popupContent;
   GetMenuPopupContent(getter_AddRefs(popupContent));
 
   nsresult rv = NS_OK;
-  nsIContent* dispatchTo = popupContent ? popupContent : mMenuContent;
+  nsIContent* dispatchTo = popupContent ? popupContent : mContent;
   rv = dispatchTo->DispatchDOMEvent(&event, nsnull, nsnull, &status);
   
   mDestroyHandlerCalled = PR_TRUE;
   
   if (NS_FAILED(rv) || status == nsEventStatus_eConsumeNoDefault)
     return PR_FALSE;
   
   return PR_TRUE;
 }
 
 
-PRBool nsMenuX::OnDestroyed()
+PRBool nsMenuX::OnClosed()
 {
   nsEventStatus status = nsEventStatus_eIgnore;
   nsMouseEvent event(PR_TRUE, NS_XUL_POPUP_HIDDEN, nsnull,
                      nsMouseEvent::eReal);
 
   nsCOMPtr<nsIContent> popupContent;
   GetMenuPopupContent(getter_AddRefs(popupContent));
 
   nsresult rv = NS_OK;
-  nsIContent* dispatchTo = popupContent ? popupContent : mMenuContent;
+  nsIContent* dispatchTo = popupContent ? popupContent : mContent;
   rv = dispatchTo->DispatchDOMEvent(&event, nsnull, nsnull, &status);
   
   mDestroyHandlerCalled = PR_TRUE;
   
   if (NS_FAILED(rv) || status == nsEventStatus_eConsumeNoDefault)
     return PR_FALSE;
   
   return PR_TRUE;
@@ -873,21 +725,21 @@ void nsMenuX::GetMenuPopupContent(nsICon
     return;
   *aResult = nsnull;
   
   nsresult rv;
   nsCOMPtr<nsIXBLService> xblService = do_GetService("@mozilla.org/xbl;1", &rv);
   if (!xblService)
     return;
   
-  PRUint32 count = mMenuContent->GetChildCount();
+  PRUint32 count = mContent->GetChildCount();
 
   for (PRUint32 i = 0; i < count; i++) {
     PRInt32 dummy;
-    nsIContent *child = mMenuContent->GetChildAt(i);
+    nsIContent *child = mContent->GetChildAt(i);
     nsCOMPtr<nsIAtom> tag;
     xblService->ResolveTag(child, &dummy, getter_AddRefs(tag));
     if (tag == nsWidgetAtoms::menupopup) {
       *aResult = child;
       NS_ADDREF(*aResult);
       return;
     }
   }
@@ -897,239 +749,170 @@ void nsMenuX::GetMenuPopupContent(nsICon
 
 // Determines how many menus are visible among the siblings that are before me.
 // It doesn't matter if I am visible. Note that this will always count the
 // Application menu, since we always put it in there.
 nsresult nsMenuX::CountVisibleBefore(PRUint32* outVisibleBefore)
 {
   NS_ASSERTION(outVisibleBefore, "bad index param in nsMenuX::CountVisibleBefore");
   
-  nsCOMPtr<nsIMenuBar> menubarParent = do_QueryInterface(mParent);
-  if (menubarParent) {
-    PRUint32 numMenus = 0;
-    menubarParent->GetMenuCount(numMenus);
-    
+  nsMenuObjectTypeX parentType = mParent->MenuObjectType();
+  if (parentType == eMenuBarObjectType) {
+    nsMenuBarX* menubarParent = static_cast<nsMenuBarX*>(mParent);
+    PRUint32 numMenus = menubarParent->GetMenuCount();
+
     // Find this menu among the children of my parent menubar
     *outVisibleBefore = 1; // start at 1, the Application menu will always be there
     for (PRUint32 i = 0; i < numMenus; i++) {
-      nsCOMPtr<nsIMenu> currMenu;
-      menubarParent->GetMenuAt(i, *getter_AddRefs(currMenu));
-      if (currMenu == static_cast<nsIMenu*>(this)) {
+      nsMenuX* currMenu = menubarParent->GetMenuAt(i);
+      if (currMenu == this) {
         // we found ourselves, break out
         return NS_OK;
       }
-  
+
       if (currMenu) {
-        nsCOMPtr<nsIContent> menuContent;
-        currMenu->GetMenuContent(getter_AddRefs(menuContent));
-        if (menuContent &&
-            menuContent->GetChildCount() > 0 &&
-            !NodeIsHiddenOrCollapsed(menuContent)) {
+        nsIContent* menuContent = currMenu->Content();
+        if (menuContent->GetChildCount() > 0 &&
+            !nsMenuUtilsX::NodeIsHiddenOrCollapsed(menuContent)) {
           ++(*outVisibleBefore);
         }
       }
     }
-  } // if menubarParent
-  else {
-    nsCOMPtr<nsIMenu> menuParent = do_QueryInterface(mParent);
-    if (!menuParent)
-      return NS_ERROR_FAILURE;
-
-    PRUint32 numItems;
-    menuParent->GetItemCount(numItems);
-
+  }
+  else if (parentType == eSubmenuObjectType) {
     // Find this menu among the children of my parent menu
+    nsMenuX* menuParent = static_cast<nsMenuX*>(mParent);
+    PRUint32 numItems = menuParent->GetItemCount();
     for (PRUint32 i = 0; i < numItems; i++) {
       // Using GetItemAt instead of GetVisibleItemAt to avoid O(N^2)
-      nsCOMPtr<nsISupports> currItem;
-      menuParent->GetItemAt(i, *getter_AddRefs(currItem));
-      nsCOMPtr<nsIMenu> currMenu = do_QueryInterface(currItem);
-      if (currMenu == static_cast<nsIMenu*>(this)) {
-        // we found ourselves, break out
-        return NS_OK;
-      }
-
+      nsMenuObjectX* currItem = menuParent->GetItemAt(i);
+      if (currItem == this)
+        return NS_OK; // we found ourselves, break out
       // If the node is visible increment the outparam.
       if (MenuNodeIsVisible(currItem))
         ++(*outVisibleBefore);
-      
     }
   }
   return NS_ERROR_FAILURE;
 }
 
 
-NS_IMETHODIMP
-nsMenuX::ChangeNativeEnabledStatusForMenuItem(nsIMenuItem* aMenuItem,
-                                              PRBool aEnabled)
-{
-  return NS_ERROR_NOT_IMPLEMENTED;
-}
-
-
-NS_IMETHODIMP
-nsMenuX::GetMenuRefAndItemIndexForMenuItem(nsISupports* aMenuItem,
-                                           void**       aMenuRef,
-                                           PRUint16*    aMenuItemIndex)
-{
-  if (!mMacMenu)
-    return NS_ERROR_FAILURE;
-  
-  // look for the menu item given, and skip invisible elements
-  PRUint32 menuItemCount;
-  GetItemCount(menuItemCount);
-  PRUint32 visibleNodeIndex = 0;
-  for (PRUint32 i = 0; i < menuItemCount; i++) {
-    nsCOMPtr<nsISupports> currItem;
-    GetItemAt(i, *getter_AddRefs(currItem));
-    // Only check visible nodes
-    if (MenuNodeIsVisible(currItem)) {
-      if (currItem == aMenuItem) {
-        *aMenuRef = _NSGetCarbonMenu(mMacMenu);
-        // add 1 because carbon menu items are 1-indexed.
-        *aMenuItemIndex = visibleNodeIndex + 1;
-        return NS_OK;
-      }
-      visibleNodeIndex++;
-    }
-  }
-  
-  return NS_ERROR_FAILURE;
-}
-
-
-id
-nsMenuX::GetNativeMenuItem()
+NSMenuItem* nsMenuX::NativeMenuItem()
 {
   return mNativeMenuItem;
 }
 
 
 //
 // nsChangeObserver
 //
 
 
-void
-nsMenuX::ObserveAttributeChanged(nsIDocument *aDocument, nsIContent *aContent, nsIAtom *aAttribute)
+void nsMenuX::ObserveAttributeChanged(nsIDocument *aDocument, nsIContent *aContent,
+                                      nsIAtom *aAttribute)
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
   // ignore the |open| attribute, which is by far the most common
   if (gConstructingMenu || (aAttribute == nsWidgetAtoms::open))
     return;
 
-  nsCOMPtr<nsIMenuBar> menubarParent = do_QueryInterface(mParent);
+  nsMenuObjectTypeX parentType = mParent->MenuObjectType();
 
   if (aAttribute == nsWidgetAtoms::disabled) {
     SetRebuild(PR_TRUE);
-    SetEnabled(!mMenuContent->AttrValueIs(kNameSpaceID_None, nsWidgetAtoms::disabled,
-                                          nsWidgetAtoms::_true, eCaseMatters));
+    SetEnabled(!mContent->AttrValueIs(kNameSpaceID_None, nsWidgetAtoms::disabled,
+                                      nsWidgetAtoms::_true, eCaseMatters));
   }
   else if (aAttribute == nsWidgetAtoms::label) {
     SetRebuild(PR_TRUE);
     
-    mMenuContent->GetAttr(kNameSpaceID_None, nsWidgetAtoms::label, mLabel);
+    mContent->GetAttr(kNameSpaceID_None, nsWidgetAtoms::label, mLabel);
 
     // invalidate my parent. If we're a submenu parent, we have to rebuild
     // the parent menu in order for the changes to be picked up. If we're
     // a regular menu, just change the title and redraw the menubar.
-    if (menubarParent) {
+    if (parentType == eMenuBarObjectType) {
       // reuse the existing menu, to avoid rebuilding the root menu bar.
       NS_ASSERTION(mMacMenu, "nsMenuX::AttributeChanged: invalid menu handle.");
-      NSString *newCocoaLabelString = MenuHelpersX::CreateTruncatedCocoaLabel(mLabel);
+      NSString *newCocoaLabelString = nsMenuUtilsX::CreateTruncatedCocoaLabel(mLabel);
       [mMacMenu setTitle:newCocoaLabelString];
       [newCocoaLabelString release];
     }
     else {
-      nsCOMPtr<nsIMenu> parentMenu(do_QueryInterface(mParent));
-      parentMenu->SetRebuild(PR_TRUE);
+      static_cast<nsMenuX*>(mParent)->SetRebuild(PR_TRUE);
     }    
   }
   else if (aAttribute == nsWidgetAtoms::hidden || aAttribute == nsWidgetAtoms::collapsed) {
     SetRebuild(PR_TRUE);
 
-    PRBool contentIsHiddenOrCollapsed = NodeIsHiddenOrCollapsed(mMenuContent);
+    PRBool contentIsHiddenOrCollapsed = nsMenuUtilsX::NodeIsHiddenOrCollapsed(mContent);
 
     // don't do anything if the state is correct already
     if (contentIsHiddenOrCollapsed != mVisible)
       return;
 
-    nsCOMPtr<nsIMenu> menuParent = do_QueryInterface(mParent);
     if (contentIsHiddenOrCollapsed) {
-      void *clientData = nsnull;
-      if (menubarParent)
-        menubarParent->GetNativeData(clientData);
-      else if (menuParent)
-        menuParent->GetNativeData(&clientData);
-      if (clientData) {
-        NSMenu* parentMenu = reinterpret_cast<NSMenu*>(clientData);
+      if (parentType == eMenuBarObjectType || parentType == eSubmenuObjectType) {
+        NSMenu* parentMenu = (NSMenu*)mParent->NativeData();
         // An exception will get thrown if we try to remove an item that isn't
         // in the menu.
         if ([parentMenu indexOfItem:mNativeMenuItem] != -1)
           [parentMenu removeItem:mNativeMenuItem];
         mVisible = PR_FALSE;
       }
     }
     else {
       PRUint32 insertAfter = 0;
       if (NS_SUCCEEDED(CountVisibleBefore(&insertAfter))) {
-        void *clientData = nsnull;
-        if (menubarParent)
-          menubarParent->GetNativeData(clientData);
-        else if (menuParent)
-          menuParent->GetNativeData(&clientData);
-        if (clientData) {
-          NSMenu* parentMenu = reinterpret_cast<NSMenu*>(clientData);
+        if (parentType == eMenuBarObjectType || parentType == eSubmenuObjectType) {
+          NSMenu* parentMenu = (NSMenu*)mParent->NativeData();
           [parentMenu insertItem:mNativeMenuItem atIndex:insertAfter];
           [mNativeMenuItem setSubmenu:mMacMenu];
           mVisible = PR_TRUE;
         }
       }
     }
   }
   else if (aAttribute == nsWidgetAtoms::image) {
     SetupIcon();
   }
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
 
-void
-nsMenuX::ObserveContentRemoved(nsIDocument *aDocument, nsIContent *aChild,
-                          PRInt32 aIndexInContainer)
-{  
+void nsMenuX::ObserveContentRemoved(nsIDocument *aDocument, nsIContent *aChild,
+                                    PRInt32 aIndexInContainer)
+{
   if (gConstructingMenu)
     return;
 
   SetRebuild(PR_TRUE);
-
-  RemoveItem(aIndexInContainer);
   mMenuBar->UnregisterForContentChanges(aChild);
 }
 
 
-void
-nsMenuX::ObserveContentInserted(nsIDocument *aDocument, nsIContent *aChild,
-                           PRInt32 aIndexInContainer)
-{  
+void nsMenuX::ObserveContentInserted(nsIDocument *aDocument, nsIContent *aChild,
+                                     PRInt32 aIndexInContainer)
+{
   if (gConstructingMenu)
     return;
 
   SetRebuild(PR_TRUE);
 }
 
 
-NS_IMETHODIMP
-nsMenuX::SetupIcon()
+nsresult nsMenuX::SetupIcon()
 {
   // In addition to out-of-memory, menus that are children of the menu bar
   // will not have mIcon set.
-  if (!mIcon) return NS_ERROR_OUT_OF_MEMORY;
+  if (!mIcon)
+    return NS_ERROR_OUT_OF_MEMORY;
+
   return mIcon->SetupIcon();
 }
 
 
 //
 // Carbon event support
 //
 
@@ -1143,65 +926,55 @@ static pascal OSStatus MyMenuEventHandle
   // menus, but it also resolves many other problems -- including crashes and
   // long delays while opening the Help menu.  Once we know better which
   // operations are safe during (re)indexing, we can start allowing some
   // operations here while it's happening.  This change resolves bmo bugs
   // 426499 and 414699.
   if (nsMenuX::sIndexingMenuLevel > 0)
     return noErr;
 
+  nsMenuX* targetMenu = static_cast<nsMenuX*>(userData);
   UInt32 kind = ::GetEventKind(event);
   if (kind == kEventMenuTargetItem) {
     // get the position of the menu item we want
     PRUint16 aPos;
     ::GetEventParameter(event, kEventParamMenuItemIndex, typeMenuItemIndex, NULL, sizeof(MenuItemIndex), NULL, &aPos);
     aPos--; // subtract 1 from aPos because Carbon menu positions start at 1 not 0
     
     // don't request a menu item that doesn't exist or we crash
     // this might happen just due to some random quirks in the event system
     PRUint32 itemCount;
-    nsIMenu* targetMenu = reinterpret_cast<nsIMenu*>(userData);
     targetMenu->GetVisibleItemCount(itemCount);
     if (aPos >= itemCount)
       return eventNotHandledErr;
-    
-    nsCOMPtr<nsISupports> aTargetMenuItem;
-    targetMenu->GetVisibleItemAt((PRUint32)aPos, *getter_AddRefs(aTargetMenuItem));
-    
-    // Send DOM event
-    // If the QI fails, we're over a submenu and we shouldn't send the event
-    nsCOMPtr<nsIMenuItem> bTargetMenuItem(do_QueryInterface(aTargetMenuItem));
-    if (bTargetMenuItem) {
+
+    // Send DOM event if we're over a menu item
+    nsMenuObjectX* target = targetMenu->GetVisibleItemAt((PRUint32)aPos);
+    if (target->MenuObjectType() == eMenuItemObjectType) {
+      nsMenuItemX* targetMenuItem = static_cast<nsMenuItemX*>(target);
       PRBool handlerCalledPreventDefault; // but we don't actually care
-      bTargetMenuItem->DispatchDOMEvent(NS_LITERAL_STRING("DOMMenuItemActive"), &handlerCalledPreventDefault);
+      targetMenuItem->DispatchDOMEvent(NS_LITERAL_STRING("DOMMenuItemActive"), &handlerCalledPreventDefault);
       return noErr;
     }
   }
   else if (kind == kEventMenuOpening || kind == kEventMenuClosed) {
     if (kind == kEventMenuOpening && gRollupListener && gRollupWidget) {
       gRollupListener->Rollup(nsnull);
       return userCanceledErr;
     }
-    
-    nsISupports* supports = reinterpret_cast<nsISupports*>(userData);
-    nsCOMPtr<nsIMenu> menu(do_QueryInterface(supports));
-    if (menu) {
-      MenuRef menuRef;
-      ::GetEventParameter(event, kEventParamDirectObject, typeMenuRef, NULL, sizeof(menuRef), NULL, &menuRef);
-      nsMenuEvent menuEvent(PR_TRUE, NS_MENU_SELECTED, nsnull);
-      menuEvent.time = PR_IntervalNow();
-      menuEvent.mCommand = (PRUint32)menuRef;
-      if (kind == kEventMenuOpening) {
-        menu->MenuSelected(menuEvent);
-      }
-      else {
-        menu->MenuDeselected(menuEvent);
-      }
-      return noErr;
-    }
+    MenuRef menuRef;
+    ::GetEventParameter(event, kEventParamDirectObject, typeMenuRef, NULL, sizeof(menuRef), NULL, &menuRef);
+    nsMenuEvent menuEvent(PR_TRUE, NS_MENU_SELECTED, nsnull);
+    menuEvent.time = PR_IntervalNow();
+    menuEvent.mCommand = (PRUint32)menuRef;
+    if (kind == kEventMenuOpening)
+      targetMenu->MenuOpened(menuEvent);
+    else
+      targetMenu->MenuClosed(menuEvent);
+    return noErr;
   }
   return eventNotHandledErr;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_RETURN(noErr);
 }
 
 
 static OSStatus InstallMyMenuEventHandler(MenuRef menuRef, void* userData, EventHandlerRef* outHandler)
diff --git a/widget/src/cocoa/nsPIWidgetCocoa.idl b/widget/src/cocoa/nsPIWidgetCocoa.idl
--- a/widget/src/cocoa/nsPIWidgetCocoa.idl
+++ b/widget/src/cocoa/nsPIWidgetCocoa.idl
@@ -34,35 +34,32 @@
  * and other provisions required by the GPL or the LGPL. If you do not delete
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 #include "nsISupports.idl"
 
-interface nsIMenuBar;
+interface nsMenuBarX;
 interface nsCocoaWindow;
 interface nsIWidget;
 
 [ptr] native NSWindowPtr(NSWindow);
 
 //
 // nsPIWidgetCocoa
 //
 // A private interface (unfrozen, private to the widget implementation) that
 // gives us access to some extra features on a widget/window.
 //
 [uuid(F08E9D06-6705-4749-BE81-CEF931246E06)]
 interface nsPIWidgetCocoa : nsISupports
 {
   void SendSetZLevelEvent();
-
-  // Obtain the menubar for a window
-  nsIMenuBar GetMenuBar();
 
   // Find the displayed child sheet (if aShown) or a child sheet that
   // wants to be displayed (if !aShown)
   nsCocoaWindow GetChildSheet(in boolean aShown);
   
   // Get the parent widget (if any) StandardCreate() was called with.
   nsIWidget GetRealParent();
   
diff --git a/widget/src/cocoa/nsWidgetFactory.mm b/widget/src/cocoa/nsWidgetFactory.mm
--- a/widget/src/cocoa/nsWidgetFactory.mm
+++ b/widget/src/cocoa/nsWidgetFactory.mm
@@ -44,20 +44,16 @@
 
 #include "nsToolkit.h"
 #include "nsChildView.h"
 #include "nsCocoaWindow.h"
 #include "nsAppShell.h"
 #include "nsAppShellSingleton.h"
 #include "nsFilePicker.h"
 
-#include "nsMenuBarX.h"
-#include "nsMenuX.h"
-#include "nsMenuItemX.h"
-
 #include "nsClipboard.h"
 #include "nsClipboardHelper.h"
 #include "nsTransferable.h"
 #include "nsHTMLFormatConverter.h"
 #include "nsDragService.h"
 
 #include "nsLookAndFeel.h"
 
@@ -69,30 +65,30 @@
 #include "nsPrintOptionsX.h"
 #include "nsPrintSessionX.h"
 
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsCocoaWindow)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsChildView)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsFilePicker)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsToolkit)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsLookAndFeel)
-NS_GENERIC_FACTORY_CONSTRUCTOR(nsMenuBarX)
-NS_GENERIC_FACTORY_CONSTRUCTOR(nsMenuX)
-NS_GENERIC_FACTORY_CONSTRUCTOR(nsMenuItemX)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsSound)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsTransferable)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsHTMLFormatConverter)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsClipboard)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsClipboardHelper)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsDragService)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsScreenManagerCocoa)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsDeviceContextSpecX)
 NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsPrintOptionsX, Init)
 NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsPrintSessionX, Init)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsIdleServiceX)
+
+#include "nsMenuBarX.h"
+NS_GENERIC_FACTORY_CONSTRUCTOR(nsNativeMenuServiceX)
 
 #include "nsBidiKeyboard.h"
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsBidiKeyboard)
 
 #include "nsNativeThemeCocoa.h"
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsNativeThemeCocoa)
 
 static const nsModuleComponentInfo gComponents[] =
@@ -120,28 +116,16 @@ static const nsModuleComponentInfo gComp
   { "Toolkit",
     NS_TOOLKIT_CID,
     "@mozilla.org/widget/toolkit/mac;1",
     nsToolkitConstructor },
   { "Look And Feel",
     NS_LOOKANDFEEL_CID,
     "@mozilla.org/widget/lookandfeel;1",
     nsLookAndFeelConstructor },
-  { "Menubar",
-    NS_MENUBAR_CID,
-    "@mozilla.org/widget/menubar/mac;1",
-    nsMenuBarXConstructor },
-  { "Menu",
-    NS_MENU_CID,
-    "@mozilla.org/widget/menu/mac;1",
-    nsMenuXConstructor },
-  { "MenuItem",
-    NS_MENUITEM_CID,
-    "@mozilla.org/widget/menuitem/mac;1",
-    nsMenuItemXConstructor },
   { "Sound",
     NS_SOUND_CID,
     "@mozilla.org/sound;1",
     nsSoundConstructor },
   { "Transferable",
     NS_TRANSFERABLE_CID,
     "@mozilla.org/widget/transferable;1",
     nsTransferableConstructor },
@@ -184,12 +168,16 @@ static const nsModuleComponentInfo gComp
   { "Print Session",
     NS_PRINTSESSION_CID,
     "@mozilla.org/gfx/printsession;1",
     nsPrintSessionXConstructor },
   { "User Idle Service",
     NS_IDLE_SERVICE_CID,
     "@mozilla.org/widget/idleservice;1",
     nsIdleServiceXConstructor },
+  { "Native Menu Service",
+    NS_NATIVEMENUSERVICE_CID,
+    "@mozilla.org/widget/nativemenuservice;1",
+    nsNativeMenuServiceXConstructor },
 };
 
 NS_IMPL_NSGETMODULE_WITH_CTOR_DTOR(nsWidgetMacModule, gComponents,
                                    nsAppShellInit, nsAppShellShutdown)
diff --git a/widget/src/gtk2/Makefile.in b/widget/src/gtk2/Makefile.in
--- a/widget/src/gtk2/Makefile.in
+++ b/widget/src/gtk2/Makefile.in
@@ -100,24 +100,30 @@ CPPSRCS		= \
 		nsGtkKeyUtils.cpp \
 		nsClipboard.cpp \
 		nsDragService.cpp \
 		nsFilePicker.cpp \
 		nsSound.cpp \
 		nsNativeKeyBindings.cpp \
 		nsScreenGtk.cpp \
 		nsScreenManagerGtk.cpp \
-		nsDeviceContextSpecG.cpp \
-		nsPrintOptionsGTK.cpp \
 		nsImageToPixbuf.cpp \
 		nsAccessibilityHelper.cpp \
 		nsIdleServiceGTK.cpp \
+		$(NULL)
+
+
+ifdef NS_PRINTING
+CPPSRCS		+= \
+		nsDeviceContextSpecG.cpp \
+		nsPrintOptionsGTK.cpp \
 		nsPrintDialogGTK.cpp \
 		nsPrintSettingsGTK.cpp \
 		$(NULL)
+endif
 
 # build our subdirs, too
 ifdef ACCESSIBILITY
 REQUIRES	+= accessibility
 endif
 
 SHARED_LIBRARY_LIBS = ../xpwidgets/libxpwidgets_s.a
 
diff --git a/widget/src/gtk2/nsCommonWidget.cpp b/widget/src/gtk2/nsCommonWidget.cpp
--- a/widget/src/gtk2/nsCommonWidget.cpp
+++ b/widget/src/gtk2/nsCommonWidget.cpp
@@ -199,18 +199,17 @@ nsCommonWidget::Show(PRBool aState)
     NativeShow(aState);
 
     return NS_OK;
 }
 
 NS_IMETHODIMP
 nsCommonWidget::Resize(PRInt32 aWidth, PRInt32 aHeight, PRBool aRepaint)
 {
-    mBounds.width = aWidth;
-    mBounds.height = aHeight;
+    mBounds.SizeTo(GetSafeWindowSize(nsSize(aWidth, aHeight)));
 
     if (!mCreated)
         return NS_OK;
 
     // There are several cases here that we need to handle, based on a
     // matrix of the visibility of the widget, the sanity of this resize
     // and whether or not the widget was previously sane.
 
@@ -273,18 +272,17 @@ nsCommonWidget::Resize(PRInt32 aWidth, P
 }
 
 NS_IMETHODIMP
 nsCommonWidget::Resize(PRInt32 aX, PRInt32 aY, PRInt32 aWidth, PRInt32 aHeight,
                        PRBool aRepaint)
 {
     mBounds.x = aX;
     mBounds.y = aY;
-    mBounds.width = aWidth;
-    mBounds.height = aHeight;
+    mBounds.SizeTo(GetSafeWindowSize(nsSize(aWidth, aHeight)));
 
     mPlaced = PR_TRUE;
 
     if (!mCreated)
         return NS_OK;
 
     // There are several cases here that we need to handle, based on a
     // matrix of the visibility of the widget, the sanity of this resize
diff --git a/widget/src/gtk2/nsCommonWidget.h b/widget/src/gtk2/nsCommonWidget.h
--- a/widget/src/gtk2/nsCommonWidget.h
+++ b/widget/src/gtk2/nsCommonWidget.h
@@ -97,16 +97,18 @@ public:
     virtual void NativeResize(PRInt32 aX,
                               PRInt32 aY,
                               PRInt32 aWidth,
                               PRInt32 aHeight,
                               PRBool  aRepaint) = 0;
 
     virtual void NativeShow  (PRBool  aAction) = 0;
 
+    virtual nsSize GetSafeWindowSize(nsSize aSize) = 0;
+
     // Some of the nsIWidget methods
     NS_IMETHOD         Show             (PRBool aState);
     NS_IMETHOD         Resize           (PRInt32 aWidth,
                                          PRInt32 aHeight,
                                          PRBool  aRepaint);
     NS_IMETHOD         Resize           (PRInt32 aX,
                                          PRInt32 aY,
                                          PRInt32 aWidth,
diff --git a/widget/src/gtk2/nsWidgetFactory.cpp b/widget/src/gtk2/nsWidgetFactory.cpp
--- a/widget/src/gtk2/nsWidgetFactory.cpp
+++ b/widget/src/gtk2/nsWidgetFactory.cpp
@@ -48,19 +48,23 @@
 #include "nsHTMLFormatConverter.h"
 #include "nsClipboard.h"
 #include "nsDragService.h"
 #include "nsFilePicker.h"
 #include "nsSound.h"
 #include "nsBidiKeyboard.h"
 #include "nsNativeKeyBindings.h"
 #include "nsScreenManagerGtk.h"
+
+#ifdef NS_PRINTING
 #include "nsPrintOptionsGTK.h"
 #include "nsPrintSession.h"
 #include "nsDeviceContextSpecG.h"
+#endif
+
 #include "nsIPrefService.h"
 #include "nsIPrefBranch.h"
 #include "nsImageToPixbuf.h"
 #include "nsIdleServiceGTK.h"
 #include "nsPrintDialogGTK.h"
 
 #ifdef NATIVE_THEME_SUPPORT
 #include "nsNativeThemeGTK.h"
@@ -84,26 +88,29 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsTransfe
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsTransferable)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsBidiKeyboard)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsClipboardHelper)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsHTMLFormatConverter)
 NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsClipboard, Init)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsDragService)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsSound)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsScreenManagerGtk)
-NS_GENERIC_FACTORY_CONSTRUCTOR(nsDeviceContextSpecGTK)
 #ifdef NATIVE_THEME_SUPPORT
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsNativeThemeGTK)
 #endif
+NS_GENERIC_FACTORY_CONSTRUCTOR(nsImageToPixbuf)
+NS_GENERIC_FACTORY_CONSTRUCTOR(nsIdleServiceGTK)
+
+#ifdef NS_PRINTING
+NS_GENERIC_FACTORY_CONSTRUCTOR(nsDeviceContextSpecGTK)
 NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsPrintOptionsGTK, Init)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsPrinterEnumeratorGTK)
 NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsPrintSession, Init)
-NS_GENERIC_FACTORY_CONSTRUCTOR(nsImageToPixbuf)
-NS_GENERIC_FACTORY_CONSTRUCTOR(nsIdleServiceGTK)
 NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsPrintDialogServiceGTK, Init)
+#endif
 
 static NS_IMETHODIMP
 nsFilePickerConstructor(nsISupports *aOuter, REFNSIID aIID,
                         void **aResult)
 {
   *aResult = nsnull;
   if (aOuter != nsnull) {
     return NS_ERROR_NO_AGGREGATION;
@@ -245,16 +252,17 @@ static const nsModuleComponentInfo compo
     "@mozilla.org/gfx/screenmanager;1",
     nsScreenManagerGtkConstructor },
 #ifdef NATIVE_THEME_SUPPORT
    { "Native Theme Renderer",
     NS_THEMERENDERER_CID,
     "@mozilla.org/chrome/chrome-native-theme;1",
      nsNativeThemeGTKConstructor },
 #endif
+#ifdef NS_PRINTING
   { "PrintSettings Service",
     NS_PRINTSETTINGSSERVICE_CID,
     "@mozilla.org/gfx/printsettings-service;1",
     nsPrintOptionsGTKConstructor },
   { "Gtk Printer Enumerator",
     NS_PRINTER_ENUMERATOR_CID,
     //    "@mozilla.org/gfx/printer_enumerator/gtk;1",
     "@mozilla.org/gfx/printerenumerator;1",
@@ -263,28 +271,29 @@ static const nsModuleComponentInfo compo
     NS_PRINTSESSION_CID,
     "@mozilla.org/gfx/printsession;1",
     nsPrintSessionConstructor },
   { "Gtk Device Context Spec",
     NS_DEVICE_CONTEXT_SPEC_CID,
     //    "@mozilla.org/gfx/device_context_spec/gtk;1",
     "@mozilla.org/gfx/devicecontextspec;1",
     nsDeviceContextSpecGTKConstructor },
+  { "Native Print Dialog",
+    NS_PRINTDIALOGSERVICE_CID,
+    NS_PRINTDIALOGSERVICE_CONTRACTID,
+    nsPrintDialogServiceGTKConstructor },
+#endif 
   { "Image to gdk-pixbuf converter",
     NS_IMAGE_TO_PIXBUF_CID,
     "@mozilla.org/widget/image-to-gdk-pixbuf;1",
     nsImageToPixbufConstructor },
   { "User Idle Service",
     NS_IDLE_SERVICE_CID,
     "@mozilla.org/widget/idleservice;1",
     nsIdleServiceGTKConstructor },
-  { "Native Print Dialog",
-    NS_PRINTDIALOGSERVICE_CID,
-    NS_PRINTDIALOGSERVICE_CONTRACTID,
-    nsPrintDialogServiceGTKConstructor },
 };
 
 PR_STATIC_CALLBACK(void)
 nsWidgetGtk2ModuleDtor(nsIModule *aSelf)
 {
   nsFilePicker::Shutdown();
   nsSound::Shutdown();
   nsWindow::ReleaseGlobals();
diff --git a/widget/src/gtk2/nsWindow.cpp b/widget/src/gtk2/nsWindow.cpp
--- a/widget/src/gtk2/nsWindow.cpp
+++ b/widget/src/gtk2/nsWindow.cpp
@@ -1368,17 +1368,17 @@ nsWindow::SetIcon(const nsAString& aIcon
     // leave the default icon intact if no matching icons were found
     if (iconList.Count() == 0)
         return NS_OK;
 
     return SetWindowIconList(iconList);
 }
 
 NS_IMETHODIMP
-nsWindow::SetMenuBar(nsIMenuBar * aMenuBar)
+nsWindow::SetMenuBar(void * aMenuBar)
 {
     return NS_ERROR_NOT_IMPLEMENTED;
 }
 
 NS_IMETHODIMP
 nsWindow::ShowMenuBar(PRBool aShow)
 {
     return NS_ERROR_NOT_IMPLEMENTED;
@@ -1712,16 +1712,19 @@ nsWindow::OnExposeEvent(GtkWidget *aWidg
         // XGetGeometry on us in gdk_pixmap_foreign_new_for_display when we
         // paint native themes
         GdkDrawable* d = GDK_DRAWABLE(mDrawingarea->inner_window);
         gint depth = gdk_drawable_get_depth(d);
         bufferPixmap = gdk_pixmap_new(d, boundsRect.width, boundsRect.height, depth);
         if (bufferPixmap) {
             bufferPixmapSurface = GetSurfaceForGdkDrawable(GDK_DRAWABLE(bufferPixmap),
                                                            boundsRect.Size());
+            if (bufferPixmapSurface && bufferPixmapSurface->CairoStatus()) {
+                bufferPixmapSurface = nsnull;
+            }
             if (bufferPixmapSurface) {
                 bufferPixmapSurface->SetDeviceOffset(gfxPoint(-boundsRect.x, -boundsRect.y));
                 nsCOMPtr<nsIRenderingContext> newRC;
                 nsresult rv = GetDeviceContext()->
                     CreateRenderingContextInstance(*getter_AddRefs(newRC));
                 if (NS_FAILED(rv)) {
                     bufferPixmapSurface = nsnull;
                 } else {
@@ -3564,16 +3567,42 @@ nsWindow::NativeShow (PRBool  aAction)
             moz_drawingarea_set_visibility(mDrawingarea, FALSE);
         }
         if (mDrawingarea) {
             moz_drawingarea_set_visibility(mDrawingarea, FALSE);
         }
     }
 }
 
+nsSize
+nsWindow::GetSafeWindowSize(nsSize aSize)
+{
+    GdkScreen* screen = NULL;
+    if (mContainer) {
+        screen = gdk_drawable_get_screen(GTK_WIDGET(mContainer)->window);
+    }
+    else if (mDrawingarea) {
+        screen = gdk_drawable_get_screen(mDrawingarea->inner_window);
+    }
+
+    if (!screen)
+        return aSize;
+
+    nsSize result = aSize;
+    if (aSize.width > 2 * gdk_screen_get_width(screen)) {
+        NS_WARNING("Clamping huge window width");
+        result.width = 2 * gdk_screen_get_width(screen);
+    }
+    if (aSize.height > 2 * gdk_screen_get_height(screen)) {
+        NS_WARNING("Clamping huge window height");
+        result.height = 2 * gdk_screen_get_height(screen);
+    }
+    return result;
+}
+
 void
 nsWindow::EnsureGrabs(void)
 {
     if (mRetryPointerGrab)
         GrabPointer();
     if (mRetryKeyboardGrab)
         GrabKeyboard();
 }
diff --git a/widget/src/gtk2/nsWindow.h b/widget/src/gtk2/nsWindow.h
--- a/widget/src/gtk2/nsWindow.h
+++ b/widget/src/gtk2/nsWindow.h
@@ -136,17 +136,17 @@ public:
     NS_IMETHOD         ScrollRect(nsRect  &aSrcRect,
                                   PRInt32  aDx,
                                   PRInt32  aDy);
     virtual void*      GetNativeData(PRUint32 aDataType);
     NS_IMETHOD         SetBorderStyle(nsBorderStyle aBorderStyle);
     NS_IMETHOD         SetTitle(const nsAString& aTitle);
     NS_IMETHOD         SetIcon(const nsAString& aIconSpec);
     NS_IMETHOD         SetWindowClass(const nsAString& xulWinType);
-    NS_IMETHOD         SetMenuBar(nsIMenuBar * aMenuBar);
+    NS_IMETHOD         SetMenuBar(void * aMenuBar);
     NS_IMETHOD         ShowMenuBar(PRBool aShow);
     NS_IMETHOD         WidgetToScreen(const nsRect& aOldRect,
                                       nsRect& aNewRect);
     NS_IMETHOD         ScreenToWidget(const nsRect& aOldRect,
                                       nsRect& aNewRect);
     NS_IMETHOD         BeginResizingChildren(void);
     NS_IMETHOD         EndResizingChildren(void);
     NS_IMETHOD         EnableDragDrop(PRBool aEnable);
@@ -241,16 +241,17 @@ public:
 
     void               NativeResize(PRInt32 aX,
                                     PRInt32 aY,
                                     PRInt32 aWidth,
                                     PRInt32 aHeight,
                                     PRBool  aRepaint);
 
     void               NativeShow  (PRBool  aAction);
+    virtual nsSize     GetSafeWindowSize(nsSize aSize);
 
     void               EnsureGrabs  (void);
     void               GrabPointer  (void);
     void               GrabKeyboard (void);
     void               ReleaseGrabs (void);
 
     enum PluginType {
         PluginType_NONE = 0,   /* do not have any plugin */
diff --git a/widget/src/os2/nsWindow.h b/widget/src/os2/nsWindow.h
--- a/widget/src/os2/nsWindow.h
+++ b/widget/src/os2/nsWindow.h
@@ -56,17 +56,16 @@
 
 #include "nsWidgetDefs.h"
 #include "nsBaseWidget.h"
 #include "nsToolkit.h"
 #include "nsSwitchToUIThread.h"
 #include "gfxOS2Surface.h"
 #include "gfxContext.h"
 
-class nsIMenuBar;
 class imgIContainer;
 
 //#define DEBUG_FOCUS
 
 #ifdef DEBUG_FOCUS
   #define DEBUGFOCUS(what) printf("[%x] "#what" (%d)\n", (int)this, mWindowIdentifier)
 #else
   #define DEBUGFOCUS(what)
@@ -173,17 +172,17 @@ class nsWindow : public nsBaseWidget,
    // Widget appearance
    NS_IMETHOD              SetColorMap( nsColorMap *aColorMap);
    NS_IMETHOD              SetCursor( nsCursor aCursor);
    NS_IMETHOD              SetCursor(imgIContainer* aCursor,
                                      PRUint32 aHotspotX, PRUint32 aHotspotY);
    NS_IMETHOD              HideWindowChrome(PRBool aShouldHide);
    NS_IMETHOD              SetTitle( const nsAString& aTitle); 
    NS_IMETHOD              SetIcon(const nsAString& aIconSpec); 
-   NS_IMETHOD              SetMenuBar(nsIMenuBar * aMenuBar) { return NS_ERROR_FAILURE; } 
+   NS_IMETHOD              SetMenuBar(void * aMenuBar) { return NS_ERROR_FAILURE; } 
    NS_IMETHOD              ShowMenuBar(PRBool aShow)         { return NS_ERROR_FAILURE; } 
    NS_IMETHOD              Invalidate( PRBool aIsSynchronous);
    NS_IMETHOD              Invalidate( const nsRect & aRect, PRBool aIsSynchronous);
    NS_IMETHOD              InvalidateRegion(const nsIRegion *aRegion, PRBool aIsSynchronous);
    NS_IMETHOD              Update();
    NS_IMETHOD              Scroll( PRInt32 aDx, PRInt32 aDy, nsRect *aClipRect);
    NS_IMETHOD              ScrollWidgets(PRInt32 aDx, PRInt32 aDy);
    NS_IMETHOD              ScrollRect(nsRect &aRect, PRInt32 aDx, PRInt32 aDy);
@@ -276,17 +275,16 @@ protected:
    HWND      GetParentHWND() const;
    HWND      GetHWND() const   { return mWnd; }
    PFNWP     GetPrevWP() const { return mPrevWndProc; }
 
    // nglayout data members
    PRInt32        mPreferredHeight;
    PRInt32        mPreferredWidth;
    nsToolkit     *mOS2Toolkit;
-   nsIMenuBar    *mMenuBar;
    PRInt32        mWindowState;
    nsRefPtr<gfxOS2Surface> mThebesSurface;
 
    // Implementation ------------------------------
    void DoCreate( HWND hwndP, nsWindow *wndP, const nsRect &rect,
                   EVENT_CALLBACK aHandleEventFunction,
                   nsIDeviceContext *aContext, nsIAppShell *aAppShell,
                   nsIToolkit *aToolkit, nsWidgetInitData *aInitData);
diff --git a/widget/src/photon/nsWindow.cpp b/widget/src/photon/nsWindow.cpp
--- a/widget/src/photon/nsWindow.cpp
+++ b/widget/src/photon/nsWindow.cpp
@@ -48,17 +48,16 @@
 #include "nsIFontMetrics.h"
 #include "nsFont.h"
 #include "nsGUIEvent.h"
 #include "nsIRenderingContext.h"
 #include "nsIRegion.h"
 #include "nsRect.h"
 #include "nsTransform2D.h"
 #include "nsGfxCIID.h"
-#include "nsIMenuBar.h"
 #include "nsToolkit.h"
 #include "nsIPrefBranch.h"
 #include "nsIPrefService.h"
 
 #include "nsClipboard.h"
 #include "nsIRollupListener.h"
 
 #include "nsIServiceManager.h"
diff --git a/widget/src/windows/nsWindow.h b/widget/src/windows/nsWindow.h
--- a/widget/src/windows/nsWindow.h
+++ b/widget/src/windows/nsWindow.h
@@ -56,17 +56,16 @@
 #include "nsString.h"
 
 #include "nsVoidArray.h"
 #include "nsTArray.h"
 
 class nsNativeDragTarget;
 class nsIRollupListener;
 
-class nsIMenuBar;
 class nsIFile;
 
 class imgIContainer;
 
 struct nsAlternativeCharCode;
 struct nsFakeCharMessage;
 
 #ifdef ACCESSIBILITY
@@ -185,17 +184,17 @@ public:
   virtual void            FreeNativeData(void * data, PRUint32 aDataType);//~~~
   NS_IMETHOD              SetColorMap(nsColorMap *aColorMap);
   //XXX-Scroll is obsolete it is going away soon
   NS_IMETHOD              Scroll(PRInt32 aDx, PRInt32 aDy, nsRect *aClipRect);
   NS_IMETHOD              ScrollWidgets(PRInt32 aDx, PRInt32 aDy);
   NS_IMETHOD              ScrollRect(nsRect &aRect, PRInt32 aDx, PRInt32 aDy);
   NS_IMETHOD              SetTitle(const nsAString& aTitle);
   NS_IMETHOD              SetIcon(const nsAString& aIconSpec);
-  NS_IMETHOD              SetMenuBar(nsIMenuBar * aMenuBar) { return NS_ERROR_FAILURE; }
+  NS_IMETHOD              SetMenuBar(void * aMenuBar) { return NS_ERROR_FAILURE; }
   NS_IMETHOD              ShowMenuBar(PRBool aShow)         { return NS_ERROR_FAILURE; }
   NS_IMETHOD              WidgetToScreen(const nsRect& aOldRect, nsRect& aNewRect);
   NS_IMETHOD              ScreenToWidget(const nsRect& aOldRect, nsRect& aNewRect);
   NS_IMETHOD              BeginResizingChildren(void);
   NS_IMETHOD              EndResizingChildren(void);
   NS_IMETHOD              GetPreferredSize(PRInt32& aWidth, PRInt32& aHeight);
   NS_IMETHOD              SetPreferredSize(PRInt32 aWidth, PRInt32 aHeight);
   NS_IMETHOD              DispatchEvent(nsGUIEvent* event, nsEventStatus & aStatus);
diff --git a/widget/src/xpwidgets/nsBaseWidget.h b/widget/src/xpwidgets/nsBaseWidget.h
--- a/widget/src/xpwidgets/nsBaseWidget.h
+++ b/widget/src/xpwidgets/nsBaseWidget.h
@@ -131,16 +131,17 @@ public:
   NS_IMETHOD              GetLastInputEventTime(PRUint32& aTime);
   NS_IMETHOD              SetIcon(const nsAString &anIconSpec);
   NS_IMETHOD              BeginSecureKeyboardInput();
   NS_IMETHOD              EndSecureKeyboardInput();
   NS_IMETHOD              SetWindowTitlebarColor(nscolor aColor, PRBool aActive);
   virtual void            ConvertToDeviceCoordinates(nscoord  &aX,nscoord &aY) {}
   virtual void            FreeNativeData(void * data, PRUint32 aDataType) {}
   NS_IMETHOD              BeginResizeDrag(nsGUIEvent* aEvent, PRInt32 aHorizontal, PRInt32 aVertical);
+  virtual nsresult        ActivateNativeMenuItemAt(const nsAString& indexString) { return NS_ERROR_NOT_IMPLEMENTED; }
 
 protected:
 
   virtual void            ResolveIconName(const nsAString &aIconName,
                                           const nsAString &aIconSuffix,
                                           nsILocalFile **aResult);
   virtual void            OnDestroy();
   virtual void            BaseCreate(nsIWidget *aParent,
diff --git a/widget/tests/Makefile.in b/widget/tests/Makefile.in
--- a/widget/tests/Makefile.in
+++ b/widget/tests/Makefile.in
@@ -43,10 +43,15 @@ relativesrcdir  = widget/test
 
 include $(DEPTH)/config/autoconf.mk
 include $(topsrcdir)/config/rules.mk
 
 _TEST_FILES =	test_bug343416.xul \
 		test_keycodes.xul \
 		$(NULL)
 
+ifeq ($(MOZ_WIDGET_TOOLKIT),cocoa)
+_TEST_FILES += native_menus_window.xul \
+               test_native_menus.xul
+endif
+
 libs:: $(_TEST_FILES)
 	$(INSTALL) $^ $(DEPTH)/_tests/testing/mochitest/chrome/$(relativesrcdir)
diff --git a/widget/tests/native_menus_window.xul b/widget/tests/native_menus_window.xul
new file mode 100644
--- /dev/null
+++ b/widget/tests/native_menus_window.xul
@@ -0,0 +1,115 @@
+<?xml version="1.0"?>
+
+<!-- ***** BEGIN LICENSE BLOCK *****
+   - Version: MPL 1.1/GPL 2.0/LGPL 2.1
+   -
+   - The contents of this file are subject to the Mozilla Public License Version
+   - 1.1 (the "License"); you may not use this file except in compliance with
+   - the License. You may obtain a copy of the License at
+   - http://www.mozilla.org/MPL/
+   -
+   - Software distributed under the License is distributed on an "AS IS" basis,
+   - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+   - for the specific language governing rights and limitations under the
+   - License.
+   -
+   - The Original Code is Findbar Test code
+   -
+   - The Initial Developer of the Original Code is
+   - Mozilla Corporation.
+   - Portions created by the Initial Developer are Copyright (C) 2006
+   - the Initial Developer. All Rights Reserved.
+   -
+   - Contributor(s):
+   -   Josh Aas <josh@mozilla.com>
+   -
+   - Alternatively, the contents of this file may be used under the terms of
+   - either the GNU General Public License Version 2 or later (the "GPL"), or
+   - the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+   - in which case the provisions of the GPL or the LGPL are applicable instead
+   - of those above. If you wish to allow use of your version of this file only
+   - under the terms of either the GPL or the LGPL, and not to allow others to
+   - use your version of this file under the terms of the MPL, indicate your
+   - decision by deleting the provisions above and replace them with the notice
+   - and other provisions required by the GPL or the LGPL. If you do not delete
+   - the provisions above, a recipient may use your version of this file under
+   - the terms of any one of the MPL, the GPL or the LGPL.
+   -
+   - ***** END LICENSE BLOCK ***** -->
+
+<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
+
+<window id="NativeMenuWindow"
+        xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+        width="300"
+        height="300"
+        onload="onLoad();"
+        title="Native Menu Test">
+
+  <command id="cmd_FooItem1" oncommand="executedCommandID = 'cmd_FooItem1';"/>
+  <command id="cmd_FooItem2" oncommand="executedCommandID = 'cmd_FooItem2';"/>
+  <command id="cmd_BarItem1" oncommand="executedCommandID = 'cmd_BarItem1';"/>
+  <command id="cmd_BarItem2" oncommand="executedCommandID = 'cmd_BarItem2';"/>
+
+  <menubar id="nativemenubar">
+    <menu id="foo" label="Foo">
+      <menupopup>
+        <menuitem label="FooItem1" command="cmd_FooItem1"/>
+        <menuitem label="FooItem2" command="cmd_FooItem2"/>
+        <menuseparator/>
+        <menu label="Bar">
+          <menupopup>
+            <menuitem label="BarItem1" command="cmd_BarItem1"/>
+            <menuitem label="BarItem2" command="cmd_BarItem2"/>
+          </menupopup>
+        </menu>
+      </menupopup>
+    </menu>
+  </menubar>
+
+  <script type="application/javascript"><![CDATA[
+
+    function ok(condition, message) {
+      window.opener.wrappedJSObject.SimpleTest.ok(condition, message);
+    }
+
+    function onTestsFinished() {
+      window.close();
+      window.opener.wrappedJSObject.SimpleTest.finish();
+    }
+
+    var executedCommandID = "";
+
+    function testItem(location, targetID) {
+      netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
+      var utils = window.QueryInterface(Components.interfaces.nsIInterfaceRequestor).
+                                          getInterface(Components.interfaces.nsIDOMWindowUtils);
+
+      var correctCommandHandler = false;
+      try {
+        utils.activateNativeMenuItemAt(location);
+        correctCommandHandler = executedCommandID == targetID;
+      }
+      catch (e) {
+        dump(e + "\n");
+      }
+      finally {
+        ok(correctCommandHandler, 'Command handler not run correctly');
+        executedCommandID = "";
+      }
+    }
+
+    function onLoad() {
+      var _delayedOnLoad = function() {
+        testItem("0|0", "cmd_FooItem1");
+        testItem("0|1", "cmd_FooItem2");
+        testItem("0|3|0", "cmd_BarItem1");
+        testItem("0|3|1", "cmd_BarItem2");
+        onTestsFinished()
+      }
+
+      setTimeout(_delayedOnLoad, 1000);
+    }    
+
+  ]]></script>
+</window>
diff --git a/widget/tests/test_native_menus.xul b/widget/tests/test_native_menus.xul
new file mode 100644
--- /dev/null
+++ b/widget/tests/test_native_menus.xul
@@ -0,0 +1,34 @@
+<?xml version="1.0"?>
+<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
+<?xml-stylesheet href="chrome://mochikit/content/tests/SimpleTest/test.css"
+                 type="text/css"?>
+<window title="Native menu system tests"
+  xmlns:html="http://www.w3.org/1999/xhtml"
+  xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
+
+  <title>Native menu system tests</title>
+  <script type="application/javascript" 
+          src="chrome://mochikit/content/MochiKit/packed.js"></script>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js" />
+
+<body  xmlns="http://www.w3.org/1999/xhtml">
+<p id="display"></p>
+<div id="content" style="display: none">
+  
+</div>
+<pre id="test">
+</pre>
+</body>
+
+<script class="testbody" type="application/javascript">
+<![CDATA[
+
+SimpleTest.waitForExplicitFinish();
+window.open("native_menus_window.xul", "NativeMenuWindow", 
+            "chrome,width=600,height=600");
+
+]]>
+</script>
+
+</window>
diff --git a/xpcom/analysis/final.js b/xpcom/analysis/final.js
new file mode 100644
--- /dev/null
+++ b/xpcom/analysis/final.js
@@ -0,0 +1,16 @@
+function process_type(c)
+{
+  if ((c.kind == 'class' || c.kind == 'struct') && !c.isIncomplete) {
+    for each (let base in c.bases)
+      if (isFinal(base))
+        error("Class '" + c.name + "' derives from final class '" + base.name + "'.", c.loc);
+  }
+}
+
+function isFinal(c)
+{
+  if (c.isIncomplete)
+    throw Error("Can't get final property for incomplete type.");
+
+  return hasAttribute(c, 'NS_final');
+}
diff --git a/xpcom/analysis/outparams.js b/xpcom/analysis/outparams.js
--- a/xpcom/analysis/outparams.js
+++ b/xpcom/analysis/outparams.js
@@ -9,16 +9,23 @@ include('unstable/adts.js');
 include('unstable/adts.js');
 include('unstable/analysis.js');
 include('unstable/esp.js');
 include('unstable/liveness.js');
 let Zero_NonZero = {};
 include('unstable/zero_nonzero.js', Zero_NonZero);
 
 include('mayreturn.js');
+
+function safe_location_of(t) {
+  if (t === undefined)
+    return UNKNOWN_LOCATION;
+  
+  return location_of(t);
+}
 
 MapFactory.use_injective = true;
 
 // Print a trace for each function analyzed
 let TRACE_FUNCTIONS = 0;
 // Trace operation of the ESP analysis, use 2 or 3 for more detail
 let TRACE_ESP = 0;
 // Trace determination of function call parameter semantics, 2 for detail
@@ -133,16 +140,19 @@ function is_constructor(function_decl)
 // Outparam check analysis
 function OutparamCheck(cfg, psem_list, outparam_list, retvar, retvar_set, finally_tmps, trace) {
   this.retvar = retvar;
   this.psem_list = psem_list;
   // We need both an ordered set and a lookup structure
   this.outparam_list = outparam_list
   this.outparams = create_decl_set(outparam_list);
   this.psvar_list = outparam_list.slice(0);
+  // We need to save the retvars so we can detect assignments through
+  // their addresses passed as arguments.
+  this.retvar_set = retvar_set;
   for (let v in retvar_set.items()) {
     this.psvar_list.push(v);
   }
   for each (let v in finally_tmps) {
     this.psvar_list.push(v);
   }
   if (trace) {
     print("PS vars");
@@ -401,41 +411,50 @@ OutparamCheck.prototype.processCall = fu
   if (TRACE_CALL_SEM) {
     print("param semantics:" + psem);
   }
 
   if (args.length != psem.length) {
     let ct = TREE_TYPE(callable);
     if (TREE_CODE(ct) == POINTER_TYPE) ct = TREE_TYPE(ct);
     if (args.length < psem.length || !stdarg_p(ct)) {
-      //print("TTT " + type_string(ct));
       let name = function_decl_name(callable);
       // TODO Can __builtin_memcpy write to an outparam? Probably not.
       if (name != 'operator new' && name != 'operator delete' &&
           name != 'operator new []' && name != 'operator delete []' &&
           name.substr(0, 5) != '__cxa' &&
           name.substr(0, 9) != '__builtin') {
         throw Error("bad len for '" + name + "': " + args.length + ' args, ' + 
                     psem.length + ' params');
       }
     }
   }
 
   // Collect variables that are possibly written to on callee success
   let updates = [];
   for (let i = 0; i < psem.length; ++i) {
     let arg = args[i];
+    // The arg could be the address of a return-value variable.
+    // This means it's really the nsresult code for the call,
+    // so we treat it the same as the target of an rv assignment.
+    if (TREE_CODE(arg) == ADDR_EXPR) {
+      let v = arg.operands()[0];
+      if (DECL_P(v) && this.retvar_set.has(v)) {
+        dest = v;
+      }
+    }
     // The arg could be a copy of an outparam. We'll unwrap to the
     // outparam if it is. The following is cheating a bit because
     // we munge states together, but it should be OK in practice.
     arg = unwrap_outparam(arg, state);
     let sem = psem[i];
     if (sem == ps.CONST) continue;
     // At this point, we know the call can write thru this param.
-    // Invalidate any vars whose addresses are passed here.
+    // Invalidate any vars whose addresses are passed here. This
+    // is distinct from the rv handling above.
     if (TREE_CODE(arg) == ADDR_EXPR) {
       let v = arg.operands()[0];
       if (DECL_P(v)) {
         state.remove(v);
       }
     }
     if (!DECL_P(arg) || !this.outparams.has(arg)) continue;
     // At this point, we may be writing to an outparam 
@@ -539,77 +558,106 @@ OutparamCheck.prototype.checkSubstate = 
       warning("Outparams checker cannot determine rv success/failure",
               location_of(fndecl));
       this.checkSubstateSuccess(ss);
       this.checkSubstateFailure(ss);
     }
   }
 }
 
+/* @return     The return statement in the function
+ *             that writes the return value in the given substate.
+ *             If the function returns void, then the substate doesn't
+ *             matter and we just look for the return. */
+OutparamCheck.prototype.findReturnStmt = function(ss) {
+  if (this.retvar != undefined)
+    return ss.getBlame(this.retvar);
+
+  if (this.cfg._cached_return)
+    return this.cfg._cached_return;
+  
+  for (let bb in cfg_bb_iterator(this.cfg)) {
+    for (let isn in bb_isn_iterator(bb)) {
+      if (TREE_CODE(isn) == RETURN_EXPR) {
+        return this.cfg._cached_return = isn;
+      }
+    }
+  }
+
+  return undefined;
+}
+
 OutparamCheck.prototype.checkSubstateSuccess = function(ss) {
   for (let i = 0; i < this.psem_list.length; ++i) {
     let [v, psem] = [ this.outparam_list[i], this.psem_list[i] ];
     if (psem == ps.INOUT) continue;
     let val = ss.get(v);
     if (val == av.NOT_WRITTEN) {
       this.logResult('succ', 'not_written', 'error');
-      this.warn("outparam not written on NS_SUCCEEDED(return value)",
-                v, this.formatBlame('Return at', ss, this.retvar));
+      this.warn([this.findReturnStmt(ss), "outparam '" + expr_display(v) + "' not written on NS_SUCCEEDED(return value)"],
+                [v, "outparam declared here"]);
     } else if (val == av.MAYBE_WRITTEN) {
       this.logResult('succ', 'maybe_written', 'error');
-      this.warn("outparam not written on NS_SUCCEEDED(return value)", v,
-                this.formatBlame('Return at', ss, this.retvar),
-                this.formatBlame('Possibly written by unannotated outparam in call at', ss, v));
-    } else { 
+
+      let blameStmt = ss.getBlame(v);
+      let callMsg;
+      let callName = "";
+      try {
+        let callExpr = blameStmt.tree_check(GIMPLE_MODIFY_STMT).
+          operands()[1].tree_check(CALL_EXPR);
+        let callDecl = callable_arg_function_decl(CALL_EXPR_FN(callExpr));
+        
+        callMsg = [callDecl, "declared here"];
+        callName = " '" + decl_name(callDecl) + "'";
+      }
+      catch (e if e.TreeCheckError) { }
+      
+      this.warn([ss.getBlame(this.retvar), "outparam '" + expr_display(v) + "' not written on NS_SUCCEEDED(return value)"],
+                [v, "outparam declared here"],
+                [blameStmt, "possibly written by unannotated function call" + callName],
+                callMsg);
+    } else {
       this.logResult('succ', '', 'ok');
     }
   }    
 }
 
 OutparamCheck.prototype.checkSubstateFailure = function(ss) {
   for (let i = 0; i < this.psem_list.length; ++i) {
     let [v, ps] = [ this.outparam_list[i], this.psem_list[i] ];
     let val = ss.get(v);
     if (val == av.WRITTEN) {
       this.logResult('fail', 'written', 'error');
-      this.warn("outparam written on NS_FAILED(return value)", v,
-                this.formatBlame('Return at', ss, this.retvar),
-                this.formatBlame('Written at', ss, v));
+      this.warn([this.findReturnStmt(ss), "outparam '" + expr_display(v) + "' written on NS_FAILED(return value)"],
+                [v, "outparam declared here"],
+                [ss.getBlame(v), "written here"]);
     } else if (val == av.WROTE_NULL) {
       this.logResult('fail', 'wrote_null', 'warning');
-      this.warn("NULL written to outparam on NS_FAILED(return value)", v,
-                this.formatBlame('Return at', ss, this.retvar),
-                this.formatBlame('Written at', ss, v));
+      this.warn([ss.getBlame(this.retvar), "NULL written to outparam '" + expr_display(v) + "' on NS_FAILED(return value)"],
+                [v, "outparam declared here"],
+                [ss.getBlame(v), "written here"]);
     } else {
       this.logResult('fail', '', 'ok');
     }
   }    
 }
 
-OutparamCheck.prototype.warn = function() {
-  let tag = arguments[0];
-  let v = arguments[1];
-  // Filter out any undefined values.
-  let rest = [ x for each (x in Array.slice(arguments, 2)) ];
+/**
+ * Generate a warning from one or more tuples [treeforloc, message]
+ */
+OutparamCheck.prototype.warn = function(arg0) {
+  let loc = safe_location_of(arg0[0]);
+  let msg = arg0[1];
 
-  let label = expr_display(v)
-  let lines = [ tag + ': ' + label,
-              'Outparam declared at: ' + loc_string(location_of(v)) ];
-  lines = lines.concat(rest);
-  let msg = lines.join('\n    ');
-  warning(msg);
-}
-
-OutparamCheck.prototype.formatBlame = function(msg, ss, v) {
-  // If v is undefined, that means we don't have that variable, e.g., 
-  // a return variable in a void function, so just return undefined;
-  if (v == undefined) return undefined;
-  let blame = ss.getBlame(v);
-  let loc = blame ? loc_string(location_of(blame)) : '?';
-  return(msg + ": " + loc);
+  for (let i = 1; i < arguments.length; ++i) {
+    if (arguments[i] === undefined) continue;
+    let [atree, amsg] = arguments[i];
+    msg += "\n" + loc_string(safe_location_of(atree)) + ":   " + amsg;
+  }
+  warning(msg, loc);
 }
 
 OutparamCheck.prototype.logResult = function(rv, msg, kind) {
   if (LOG_RESULTS) {
     let s = [ '"' + x + '"' for each (x in [ loc_string(location_of(this.fndecl)), function_decl_name(this.fndecl), rv, msg, kind ]) ].join(', ');
     print(":LR: (" + s + ")");
   }
 }
@@ -651,106 +699,114 @@ OutparamCheck.prototype.func_param_seman
   // Analyze params
   let ans = [];
   for (let i = 0; i < types.length; ++i) {
     let sem;
     if (i == 0 && string_mutator) {
       // Special case: string mutator receiver is an no-fail outparams
       sem = ps.OUTNOFAIL;
     } else {
-      if (params) sem = param_semantics(params[i]);
+      if (params) sem = decode_attr(DECL_ATTRIBUTES(params[i]));
       if (TRACE_CALL_SEM >= 2) print("param " + i + ": annotated " + sem);
       if (sem == undefined) {
-        if (guess) {
-          sem = param_semantics_by_type(types[i]);
-          // Params other than last are guessed as MAYBE
-          if (i < types.length - 1 && sem == ps.OUT) sem = ps.MAYBE;
-        } else {
-          sem = ps.CONST;
+        sem = decode_attr(TYPE_ATTRIBUTES(types[i]));
+        if (TRACE_CALL_SEM >= 2) print("type " + i + ": annotated " + sem);
+        if (sem == undefined) {
+          if (guess && type_is_outparam(types[i])) {
+            // Params other than last are guessed as MAYBE
+            sem = i < types.length - 1 ? ps.MAYBE : ps.OUT;
+          } else {
+            sem = ps.CONST;
+          }
         }
       }
       if (sem == ps.OUT && nofail) sem = ps.OUTNOFAIL;
     }
     if (sem == undefined) throw new Error("assert");
     ans.push(sem);
   }
   return ans;
 }
 
-// Return the param semantics as indicated by the attributes, or
-// undefined if no param attribute is present.
-function param_semantics(decl) {
-  for each (let attr in rectify_attributes(DECL_ATTRIBUTES(decl))) {
+/* Decode parameter semantics GCC attributes.
+ * @param attrs    GCC attributes of a parameter. E.g., TYPE_ATTRIBUTES
+ *                 or DECL_ATTRIBUTES of an item
+ * @return         The parameter semantics value defined by the attributes,
+ *                 or undefined if no such attributes were present. */
+function decode_attr(attrs) {
+  // Note: we're not checking for conflicts, we just take the first
+  // one we find.
+  for each (let attr in rectify_attributes(attrs)) {
     if (attr.name == 'user') {
       for each (let arg in attr.args) {
         if (arg == 'NS_outparam') {
           return ps.OUT;
         } else if (arg == 'NS_inoutparam') {
           return ps.INOUT;
         } else if (arg == 'NS_inparam') {
           return ps.CONST;
         }
       }
     }
   }
   return undefined;
 }
 
-// Return param semantics as guessed from types. Never returns undefined.
-function param_semantics_by_type(type) {
+/* @return       true if the given type appears to be an outparam
+ *               type based on the type alone (i.e., not considering
+ *               attributes. */
+function type_is_outparam(type) {
   switch (TREE_CODE(type)) {
   case POINTER_TYPE:
-    let pt = TREE_TYPE(type);
-    if (TYPE_READONLY(pt)) return ps.CONST;
-    switch (TREE_CODE(pt)) {
-    case RECORD_TYPE:
-      // TODO: should we consider field writes?
-      return ps.CONST;
-    case POINTER_TYPE:
-    case ARRAY_TYPE:
-      // Outparam if nsIFoo** or void **
-      let ppt = TREE_TYPE(pt);
-      let tname = TYPE_NAME(ppt);
-      if (tname == undefined) return ps.CONST;
-      let name = decl_name_string(tname);
-      return name == 'void' || name == 'char' || name == 'PRUnichar' ||
-        name.substr(0, 3) == 'nsI' ?
-        ps.OUT : ps.CONST;
-    case INTEGER_TYPE: {
-      let name = decl_name_string(TYPE_NAME(pt));
-      return name != 'char' && name != 'PRUnichar' ? ps.OUT : ps.CONST;
-    }
-    case ENUMERAL_TYPE:
-    case REAL_TYPE:
-    case UNION_TYPE:
-      return TYPE_READONLY(pt) ? ps.CONST : ps.OUT;
-    case FUNCTION_TYPE:
-    case VOID_TYPE:
-      return ps.CONST;
-    default:
-      print("Y " + TREE_CODE(pt));
-      print('Y ' + type_string(pt));
-      throw new Error("ni");
-    }
-    break;
+    return pointer_type_is_outparam(TREE_TYPE(type));
   case REFERENCE_TYPE:
     let rt = TREE_TYPE(type);
-    return !TYPE_READONLY(rt) && is_string_type(rt) ? ps.OUT : ps.CONST;
-  case BOOLEAN_TYPE:
-  case INTEGER_TYPE:
+    return !TYPE_READONLY(rt) && is_string_type(rt);
+  default:
+    // Note: This is unsound for UNION_TYPE, because the union could
+    //       contain a pointer.
+    return false;
+  }
+}
+
+/* Helper for type_is_outparam.
+ * @return      true if 'pt *' looks like an outparam type. */
+function pointer_type_is_outparam(pt) {
+  if (TYPE_READONLY(pt)) return false;
+
+  switch (TREE_CODE(pt)) {
+  case POINTER_TYPE:
+  case ARRAY_TYPE: {
+    // Look for void **, nsIFoo **, char **, PRUnichar **
+    let ppt = TREE_TYPE(pt);
+    let tname = TYPE_NAME(ppt);
+    if (tname == undefined) return false;
+    let name = decl_name_string(tname);
+    return name == 'void' || name == 'char' || name == 'PRUnichar' ||
+      name.substr(0, 3) == 'nsI';
+  }
+  case INTEGER_TYPE: {
+    // char * and PRUnichar * are probably strings, otherwise guess
+    // it is an integer outparam.
+    let name = decl_name_string(TYPE_NAME(pt));
+    return name != 'char' && name != 'PRUnichar';
+  }
+  case ENUMERAL_TYPE:
   case REAL_TYPE:
-  case ENUMERAL_TYPE:
+  case UNION_TYPE:
+    return true;
   case RECORD_TYPE:
-  case UNION_TYPE:    // unsafe, c/b pointer
-  case ARRAY_TYPE:
-    return ps.CONST;
+    // TODO: should we consider field writes?
+    return false;
+  case FUNCTION_TYPE:
+  case VOID_TYPE:
+    return false;
   default:
-    print("Z " + TREE_CODE(type));
-    print('Z ' + type_string(type));
-    throw new Error("ni");
+    throw new Error("can't guess if a pointer to this type is an outparam: " +
+                    TREE_CODE(pt) + ': ' + type_string(pt));
   }
 }
 
 // Map type name to boolean as to whether it is a string.
 let cached_string_types = MapFactory.create_map(
   function (x, y) x == y,
   function (x) x,
   function (t) t,
diff --git a/xpcom/analysis/stack.js b/xpcom/analysis/stack.js
--- a/xpcom/analysis/stack.js
+++ b/xpcom/analysis/stack.js
@@ -1,26 +1,178 @@ function process_function(f, stmts)
-function process_function(f, stmts)
+include("gcc_util.js");
+include("unstable/lazy_types.js");
+
+function process_type(c)
 {
-  var stmt;
-  function getLocation()
+  if ((c.kind == 'class' || c.kind == 'struct') &&
+      !c.isIncomplete)
+    isStack(c);
+}
+
+function isStack(c)
+{
+  function calculate()
   {
-    if (stmt.loc)
-      return stmt.loc;
+    if (hasAttribute(c, 'NS_stack'))
+      return true;
 
-    return f.loc;
+    for each (let base in c.bases)
+      if (isStack(base))
+        return true;
+
+    for each (let member in c.members) {
+      if (member.isFunction)
+        continue;
+
+      let type = member.type;
+      while (true) {
+        if (type === undefined)
+          break;
+
+        if (type.isArray) {
+          type = type.type;
+          continue;
+        }
+
+        if (type.typedef) {
+          if (hasAttribute(type, 'NS_stack'))
+            return true;
+
+          type = type.typedef;
+          continue;
+        }
+        break;
+      }
+
+      if (type === undefined) {
+        warning("incomplete type for member " + member + ".", member.loc);
+        continue;
+      }
+
+      if (type.isPointer || type.isReference)
+        continue;
+
+      if (!type.kind || (type.kind != 'class' && type.kind != 'struct'))
+        continue;
+
+      if (isStack(type))
+        return true;
+    }
+    return false;
   }
 
-  function processVar(v)
-  {
-    if (v.isConstructor &&
-        v.fieldOf &&
-        get_class(v.memberOf, false).stack &&
-        v.fieldOf.type.isPointer) {
-      error(getLocation() + ": constructed object of type '" +
-            v.memberOf.name + "' not on the stack.");
+  if (c.isIncomplete)
+    throw Error("Can't get stack property for incomplete type.");
+
+  if (!c.hasOwnProperty('isStack'))
+    c.isStack = calculate();
+
+  return c.isStack;
+}
+
+function isVoidPtr(t)
+{
+  return t.isPointer && t.type.name == 'void';
+}
+
+/**
+ * Detect a call to operator new. If this is operator new, and not
+ * placement-new, return the VAR_DECL of the temporary variable that operator
+ * new is always assigned to.
+ */
+function operator_new_assign(stmt)
+{
+  try {
+    stmt.tree_check(GIMPLE_MODIFY_STMT);
+    let [varDecl, callExpr] = stmt.operands();
+    varDecl.tree_check(VAR_DECL);
+    callExpr.tree_check(CALL_EXPR);
+    
+    let fncall = callable_arg_function_decl(CALL_EXPR_FN(callExpr)).
+                   tree_check(FUNCTION_DECL);
+
+    let nameid = DECL_NAME(fncall);
+    if (IDENTIFIER_OPNAME_P(nameid)) {
+      let name = IDENTIFIER_POINTER(nameid);
+      if (name == "operator new" || name == "operator new []") {
+        // if this is placement-new, ignore it (should we issue a warning?)
+        let fncallobj = dehydra_convert(TREE_TYPE(fncall));
+        if (fncallobj.parameters.length == 2 &&
+            isVoidPtr(fncallobj.parameters[1]))
+          return null;
+
+        return varDecl;
+      }
     }
   }
+  catch (e if e.TreeCheckError) { }
 
-  for each (stmt in stmts) {
-    iter(processVar, stmt.statements);
+  return null;
+}
+
+function process_tree(fndecl)
+{
+  function findconstructors(t, stack)
+  {
+    function getLocation(t) {
+      let loc;
+      if (t) {
+        loc = location_of(t);
+        if (loc !== undefined)
+          return loc;
+      }
+
+      for (let i = stack.length - 1; i >= 0; --i) {
+        let loc = location_of(stack[i]);
+        if (loc !== undefined)
+          return loc;
+      }
+      return location_of(DECL_SAVED_TREE(fndecl));
+    }
+    
+    function check_opnew_assignment(varDecl, stmt)
+    {
+      if (TREE_CODE(stmt) != GIMPLE_MODIFY_STMT) {
+        warning("operator new not followed by a GIMPLE_MODIFY_STMT: " + TREE_CODE(stmt), getLocation(stmt));
+        return;
+      }
+
+      let [destVar, assign] = stmt.operands();
+      if (TREE_CODE(assign) == NOP_EXPR)
+        assign = assign.operands()[0];
+
+      if (assign != varDecl) {
+        warning("operator new not followed by an known assignment pattern", getLocation(stmt));
+        return;
+      }
+
+      let destType = dehydra_convert(TREE_TYPE(destVar));
+      if (!destType.isPointer && !destType.isReference) {
+        error("operator new not assigned to pointer/ref?", getLocation(stmt));
+        return;
+      }
+      destType = destType.type;
+
+      if (isStack(destType))
+        error("constructed object of type '" + destType.name + "' not on the stack.", getLocation(stmt));
+    }
+
+    if (TREE_CODE(t) != STATEMENT_LIST)
+      return;
+
+    // if we find a tuple of "operator new" / GIMPLE_MODIFY_STMT casting
+    // the result of operator new to a pointer type
+    let opnew = null;
+    for (let stmt in iter_statement_list(t)) {
+      if (opnew != null)
+        check_opnew_assignment(opnew, stmt);
+
+      opnew = operator_new_assign(stmt);
+    }
+
+    if (opnew != null)
+      warning("operator new not followed by an assignment", getLocation());
   }
+  
+  let tmap = new Map();
+  walk_tree(DECL_SAVED_TREE(fndecl), findconstructors, tmap);
 }
diff --git a/xpcom/analysis/static-checking.js b/xpcom/analysis/static-checking.js
--- a/xpcom/analysis/static-checking.js
+++ b/xpcom/analysis/static-checking.js
@@ -31,204 +31,36 @@ function LoadModules(modulelist)
     modules.push(module);
   }
 }
 
 LoadModules(options['dehydra-modules']);
 if (treehydra_enabled())
   LoadModules(options['treehydra-modules']);
 
-/**
- * gClassMap maps class names to an object with the following properties:
- *
- * .final = true   if the class has been annotated as final, and may not be
- *                 subclassed
- * .stack = true   if the class has been annotated as a class which may only
- *                 be instantiated on the stack
- */
-var gClassMap = {};
-
-function ClassType(name)
-{
-  this.name = name;
-}
-
-ClassType.prototype = {
-  final: false,
-  stack: false,
-};
-
 function process_type(c)
 {
-  if (c.kind == 'class' || c.kind == 'struct')
-    get_class(c, true);
-
   for each (let module in modules)
     if (module.hasOwnProperty('process_type'))
       module.process_type(c);
 }
 
-/**
- * Get the ClassType for a type 'c'
- *
- * If allowIncomplete is true and the type is incomplete, this function
- * will return null.
- *
- * If allowIncomplete is false and the type is incomplete, this function will
- * throw.
- */
-function get_class(c, allowIncomplete)
+function hasAttribute(c, attrname)
 {
-  var classattr, base, member, type, realtype, foundConstructor;
-  var bases = [];
+  var attr;
 
-  if (c.isIncomplete) {
-    if (allowIncomplete)
-      return null;
+  if (c.attributes === undefined)
+    return false;
 
-    throw Error("Can't process incomplete type '" + c + "'.");
-  }
+  for each (attr in c.attributes)
+    if (attr.name == 'user' && attr.value[0] == attrname)
+      return true;
 
-  if (gClassMap.hasOwnProperty(c.name)) {
-    return gClassMap[c.name];
-  }
-
-  for each (base in c.bases) {
-      realtype = get_class(base, allowIncomplete);
-      if (realtype == null) {
-        error("Complete type " + c + " has incomplete base " + base);
-        return null;
-      }
-
-      bases.push(realtype);
-  }
-
-  function hasAttribute(attrname)
-  {
-    var attr;
-
-    if (c.attributes === undefined)
-      return false;
-
-    for each (attr in c.attributes) {
-      if (attr.name == 'user' && attr.value[0] == attrname) {
-        return true;
-      }
-    }
-
-    return false;
-  }
-
-  classattr = new ClassType(c.name);
-  gClassMap[c.name] = classattr;
-
-  // check for .final
-
-  if (hasAttribute('NS_final')) {
-    classattr.final = true;
-  }
-
-  // check for .stack
-
-  if (hasAttribute('NS_stack')) {
-    classattr.stack = true;
-  }
-  else {
-    for each (base in bases) {
-      if (base.stack) {
-        classattr.stack = true;
-        break;
-      }
-    }
-  }
-
-  if (!classattr.stack) {
-    // Check members
-    for each (member in c.members) {
-      if (member.isFunction)
-        continue;
-
-      type = member.type;
-
-      /* recurse through arrays and typedefs */
-      while (true) {
-          if (type === undefined) {
-              break;
-          }
-              
-          if (type.isArray) {
-              type = type.type;
-              continue;
-          }
-          if (type.typedef) {
-              type = type.typedef;
-              continue;
-          }
-          break;
-      }
-
-      if (type === undefined) {
-          warning("incomplete type  for member " + member + ".");
-          continue;
-      }
-
-      if (type.isPointer || type.isReference) {
-          continue;
-      }
-
-      if (!type.kind || (type.kind != 'class' && type.kind != 'struct')) {
-          continue;
-      }
-
-      var membertype = get_class(type, false);
-      if (membertype.stack) {
-        classattr.stack = true;
-        break;
-      }
-    }
-  }
-
-  // Check for errors at declaration-time
-
-  for each (base in bases) {
-    if (base.final) {
-      error("class '" + c.name + "' inherits from final class '" + base.name + "'.");
-    }
-  }
-
-  // At the moment, any class that is .final has to have a constructor, or
-  // we can't detect callsites... this may change with treehydra.
-  if (classattr.stack) {
-    foundConstructor = false;
-    for each (member in c.members) {
-      if (member.isConstructor) {
-        foundConstructor = true;
-        break;
-      }
-    }
-
-    if (!foundConstructor) {
-      warning(c.loc + ": class " + c.name + " is marked stack-only but doesn't have a constructor. Static checking can't detect instantiations of this class properly.");
-    }
-  }
-
-  return classattr;
+  return false;
 }
-
-/**
- * Unwrap any array of types back to their base type.
- */
-function unwrapArray(t)
-{
-  while (t.isArray) {
-    t = t.type;
-  }
-  return t;
-}
-
 function process_function(f, stmts)
 {
   for each (let module in modules)
     if (module.hasOwnProperty('process_function'))
       module.process_function(f, stmts);
 }
 
 function process_tree(fndecl)
diff --git a/xpcom/components/nsComponentManager.cpp b/xpcom/components/nsComponentManager.cpp
--- a/xpcom/components/nsComponentManager.cpp
+++ b/xpcom/components/nsComponentManager.cpp
@@ -713,19 +713,19 @@ nsresult nsComponentManagerImpl::Shutdow
 
     // Shutdown the component manager
     PR_LOG(nsComponentManagerLog, PR_LOG_DEBUG, ("nsComponentManager: Beginning Shutdown."));
 
     // Write out our component data file.
     if (mRegistryDirty) {
         nsresult rv = WritePersistentRegistry();
         if (NS_FAILED(rv)) {
-            PR_LOG(nsComponentManagerLog, PR_LOG_ERROR, ("nsComponentManager: Could not write out perisistant registry."));
+            PR_LOG(nsComponentManagerLog, PR_LOG_ERROR, ("nsComponentManager: Could not write out persistent registry."));
 #ifdef DEBUG
-            printf("Could not write out perisistant registry!\n");
+            printf("Could not write out persistent registry!\n");
 #endif
         }
     }
 
     mAutoRegEntries.Clear();
 
     // Release all cached factories
     if (mContractIDs.ops) {
diff --git a/xpcom/proxy/public/nsProxiedService.h b/xpcom/proxy/public/nsProxiedService.h
--- a/xpcom/proxy/public/nsProxiedService.h
+++ b/xpcom/proxy/public/nsProxiedService.h
@@ -88,17 +88,17 @@
 #define NS_WITH_ALWAYS_PROXIED_SERVICE(T, var, cid, Q, rvAddr)     \
     nsProxiedService _serv##var(cid, NS_GET_IID(T), Q, PR_TRUE, rvAddr);       \
     T* var = (T*)(nsISupports*)_serv##var;
 
 ////////////////////////////////////////////////////////////////////////////////
 // nsProxiedService
 ////////////////////////////////////////////////////////////////////////////////
 
-class nsProxiedService
+class NS_STACK_CLASS nsProxiedService
 {
 public:
     nsProxiedService(const nsCID &aClass, const nsIID &aIID, 
                      nsIEventTarget* aTarget, PRBool always, nsresult* rv)
     {
         nsCOMPtr<nsISupports> svc = do_GetService(aClass, rv);
         if (NS_SUCCEEDED(*rv))
             InitProxy(svc, aIID, aTarget, always, rv);
diff --git a/xpcom/string/public/nsTString.h b/xpcom/string/public/nsTString.h
--- a/xpcom/string/public/nsTString.h
+++ b/xpcom/string/public/nsTString.h
@@ -482,17 +482,17 @@ class nsTFixedString_CharT : public nsTS
 
 
   /**
    * nsTAutoString_CharT
    *
    * Subclass of nsTString_CharT that adds support for stack-based string
    * allocation.  Do not allocate this class on the heap! ;-)
    */
-class nsTAutoString_CharT : public nsTFixedString_CharT
+class NS_STACK_CLASS nsTAutoString_CharT : public nsTFixedString_CharT
   {
     public:
 
       typedef nsTAutoString_CharT    self_type;
 
     public:
 
         /**
@@ -626,17 +626,17 @@ class nsTXPIDLString_CharT : public nsTS
    *    
    *    void some_function()
    *    {
    *      nsXPIDLCString blah;
    *      GetBlah(getter_Copies(blah));
    *      // ...
    *    }
    */
-class nsTGetterCopies_CharT
+class NS_STACK_CLASS nsTGetterCopies_CharT
   {
     public:
       typedef CharT char_type;
 
       nsTGetterCopies_CharT(nsTSubstring_CharT& str)
         : mString(str), mData(nsnull) {}
 
       ~nsTGetterCopies_CharT()
diff --git a/xpcom/tests/static-checker/Makefile.in b/xpcom/tests/static-checker/Makefile.in
--- a/xpcom/tests/static-checker/Makefile.in
+++ b/xpcom/tests/static-checker/Makefile.in
@@ -50,16 +50,22 @@ FINAL_FAILURE_TESTCASES = \
 FINAL_FAILURE_TESTCASES = \
   TestFinal.cpp \
   TestFinalTemplate.cpp \
   $(NULL)
 
 STACK_FAILURE_TESTCASES = \
   TestStack.cpp \
   TestStackTemplate.cpp \
+  StackNoConstructor.cpp \
+  StackVector.cpp \
+  $(NULL)
+
+STACK_PASS_TESTCASES = \
+  StackPlacementNewOK.cpp \
   $(NULL)
 
 OUTPARAMS_WARNING_TESTCASES = \
   e1.cpp \
   e2.cpp \
   e3.cpp \
   e4.cpp \
   e5.cpp \
@@ -82,29 +88,32 @@ OUTPARAMS_PASS_TESTCASES = \
   o6.cpp \
   o7.cpp \
   o8.cpp \
   o9.cpp \
   o10.cpp \
   o11.cpp \
   o12.cpp \
   o13.cpp \
+  o14.cpp \
+  o15.cpp \
   $(NULL)
 
 STATIC_FAILURE_TESTCASES = \
   $(FINAL_FAILURE_TESTCASES) \
   $(STACK_FAILURE_TESTCASES) \
   $(NULL)
 
 STATIC_WARNING_TESTCASES = \
   $(OUTPARAMS_WARNING_TESTCASES) \
   $(NULL)
 
 STATIC_PASS_TESTCASES = \
   $(OUTPARAMS_PASS_TESTCASES) \
+  $(STACK_PASS_TESTCASES) \
   $(NULL)
 
 include $(topsrcdir)/config/rules.mk
 
 # We want to compile each file and invert the result to ensure that
 # compilation failed.
 check:: \
   $(STATIC_FAILURE_TESTCASES:.cpp=.s-fail) \
diff --git a/xpcom/tests/static-checker/StackNoConstructor.cpp b/xpcom/tests/static-checker/StackNoConstructor.cpp
new file mode 100644
--- /dev/null
+++ b/xpcom/tests/static-checker/StackNoConstructor.cpp
@@ -0,0 +1,11 @@
+#include "nscore.h"
+
+struct NS_STACK_CLASS A
+{
+  int i;
+};
+
+void* Foo()
+{
+  return new A();
+}
diff --git a/xpcom/tests/static-checker/StackPlacementNewOK.cpp b/xpcom/tests/static-checker/StackPlacementNewOK.cpp
new file mode 100644
--- /dev/null
+++ b/xpcom/tests/static-checker/StackPlacementNewOK.cpp
@@ -0,0 +1,15 @@
+#include "nscore.h"
+#include NEW_H
+
+struct NS_STACK_CLASS A
+{
+  int i;
+};
+
+int Foo()
+{
+  char buf[sizeof(A)];
+
+  A *a = new(&buf) A;
+  return a->i;
+}
diff --git a/xpcom/tests/static-checker/StackVector.cpp b/xpcom/tests/static-checker/StackVector.cpp
new file mode 100644
--- /dev/null
+++ b/xpcom/tests/static-checker/StackVector.cpp
@@ -0,0 +1,12 @@
+#include "nscore.h"
+
+struct NS_STACK_CLASS A
+{
+  int i;
+};
+
+void* Foo()
+{
+  A *a = new A[8];
+  return a;
+}
diff --git a/xpcom/tests/static-checker/o14.cpp b/xpcom/tests/static-checker/o14.cpp
new file mode 100644
--- /dev/null
+++ b/xpcom/tests/static-checker/o14.cpp
@@ -0,0 +1,24 @@
+typedef int PRUint32;
+typedef int PRInt32;
+
+typedef PRUint32 nsresult;
+
+inline int NS_FAILED(nsresult _nsresult) {
+  return _nsresult & 0x80000000;
+}
+
+inline int NS_SUCCEEDED(nsresult _nsresult) {
+    return !(_nsresult & 0x80000000);
+}
+
+int SomeFunc(nsresult *rv);
+
+nsresult foo(__attribute__((user("NS_outparam"))) int *a) {
+  nsresult rv;
+  int i = SomeFunc(&rv);
+  if (NS_FAILED(rv))
+    return rv;
+  
+  *a = i;
+  return 0;
+}
diff --git a/xpcom/tests/static-checker/o15.cpp b/xpcom/tests/static-checker/o15.cpp
new file mode 100644
--- /dev/null
+++ b/xpcom/tests/static-checker/o15.cpp
@@ -0,0 +1,20 @@
+typedef int PRUint32;
+typedef int PRInt32;
+typedef PRUint32 nsresult;
+
+typedef nsresult (*xpcomFunc)(PRInt32 * __attribute__((user("NS_outparam"))) a,
+                              PRInt32 ** __attribute__((user("NS_outparam"))) b);
+
+struct A {
+  virtual nsresult TestMethod(PRInt32 *a __attribute__((user("NS_outparam"))),
+                              PRInt32 **b __attribute__((user("NS_outparam"))));
+
+  struct FuncTable {
+    xpcomFunc mFunc;
+  } *mTable;
+};
+
+nsresult A::TestMethod(PRInt32 *a, PRInt32 **b)
+{
+  return mTable->mFunc(a, b);
+}
diff --git a/xpfe/appshell/src/nsWebShellWindow.cpp b/xpfe/appshell/src/nsWebShellWindow.cpp
--- a/xpfe/appshell/src/nsWebShellWindow.cpp
+++ b/xpfe/appshell/src/nsWebShellWindow.cpp
@@ -104,31 +104,28 @@
 
 #include "nsIBaseWindow.h"
 #include "nsIDocShellTreeItem.h"
 #include "nsIDocShellTreeNode.h"
 
 #include "nsIMarkupDocumentViewer.h"
 #include "nsIFocusEventSuppressor.h"
 
-#if defined(XP_MACOSX)
-#include "nsIMenuBar.h"
+#ifdef XP_MACOSX
+#include "nsINativeMenuService.h"
 #define USE_NATIVE_MENUS
 #endif
 
 static nsWebShellWindow* gCurrentlyFocusedWindow = nsnull;
 static nsWebShellWindow* gFocusedWindowBeforeSuppression = nsnull;
 static PRBool gFocusSuppressed = PR_FALSE;
 static PRUint32 gWebShellWindowCount = 0;
 
 /* Define Class IDs */
 static NS_DEFINE_CID(kWindowCID,           NS_WINDOW_CID);
-
-#include "nsWidgetsCID.h"
-static NS_DEFINE_CID(kMenuBarCID,          NS_MENUBAR_CID);
 
 #define SIZE_PERSISTENCE_TIMEOUT 500 // msec
 
 nsWebShellWindow::nsWebShellWindow() : nsXULWindow()
 {
   mSPTimerLock = PR_NewLock();
   if (++gWebShellWindowCount == 1) {
     nsCOMPtr<nsIFocusEventSuppressorService> suppressor =
@@ -547,33 +544,27 @@ static void LoadNativeMenus(nsIDOMDocume
 static void LoadNativeMenus(nsIDOMDocument *aDOMDoc, nsIWidget *aParentWindow)
 {
   // Find the menubar tag (if there is more than one, we ignore all but
   // the first).
   nsCOMPtr<nsIDOMNodeList> menubarElements;
   aDOMDoc->GetElementsByTagNameNS(NS_LITERAL_STRING("http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"),
                                   NS_LITERAL_STRING("menubar"),
                                   getter_AddRefs(menubarElements));
-  
+
   nsCOMPtr<nsIDOMNode> menubarNode;
   if (menubarElements)
     menubarElements->Item(0, getter_AddRefs(menubarNode));
-
   if (!menubarNode)
     return;
 
-  nsCOMPtr<nsIMenuBar> pnsMenuBar = do_CreateInstance(kMenuBarCID);
-  if (!pnsMenuBar)
-    return;
-
-  pnsMenuBar->Create(aParentWindow);
-
-  // fake event
-  nsMenuEvent fake(PR_TRUE, 0, nsnull);
-  pnsMenuBar->MenuConstruct(fake, aParentWindow, menubarNode);
+  nsCOMPtr<nsINativeMenuService> nms = do_GetService("@mozilla.org/widget/nativemenuservice;1");
+  nsCOMPtr<nsIContent> menubarContent(do_QueryInterface(menubarNode));
+  if (nms && menubarContent)
+    nms->CreateNativeMenuBar(aParentWindow, menubarContent);
 }
 #endif
 
 void
 nsWebShellWindow::SetPersistenceTimer(PRUint32 aDirtyFlags)
 {
   if (!mSPTimerLock)
     return;
diff --git a/xpfe/components/intl/nsCharsetMenu.cpp b/xpfe/components/intl/nsCharsetMenu.cpp
--- a/xpfe/components/intl/nsCharsetMenu.cpp
+++ b/xpfe/components/intl/nsCharsetMenu.cpp
@@ -277,17 +277,17 @@ private:
     const char * aKey);
   nsresult UpdateCachePrefs(const char * aCacheKey, const char * aCacheSizeKey, 
     const char * aStaticKey, const PRUnichar * aCharset);
 
   nsresult ClearMenu(nsIRDFContainer * aContainer, nsVoidArray * aArray);
   nsresult RemoveLastMenuItem(nsIRDFContainer * aContainer, 
                               nsVoidArray * aArray);
 
-  nsresult RemoveFlaggedCharsets(nsCStringArray& aList, nsString * aProp);
+  nsresult RemoveFlaggedCharsets(nsCStringArray& aList, const nsString& aProp);
   nsresult NewRDFContainer(nsIRDFDataSource * aDataSource, 
     nsIRDFResource * aResource, nsIRDFContainer ** aResult);
   void FreeMenuItemArray(nsVoidArray * aArray);
   PRInt32 FindMenuItemInArray(const nsVoidArray* aArray,
                               const nsAFlatCString& aCharset, 
                               nsMenuEntry ** aResult);
   nsresult ReorderMenuItemArray(nsVoidArray * aArray);
   nsresult GetCollation(nsICollation ** aCollation);
@@ -588,16 +588,20 @@ nsresult nsCharsetMenu::RefreshBrowserMe
   
   res = AddFromPrefsToMenu(&mBrowserMenu, container, kBrowserStaticPrefKey, 
                            decs, "charset.");
   NS_ASSERTION(NS_SUCCEEDED(res), "error initializing static charset menu from prefs");
 
   // mark the end of the static area, the rest is cache
   mBrowserCacheStart = mBrowserMenu.Count();
 
+  // Remove "notForBrowser" entries before populating cache menu
+  res = RemoveFlaggedCharsets(decs, NS_LITERAL_STRING(".notForBrowser"));
+  NS_ASSERTION(NS_SUCCEEDED(res), "error removing flagged charsets");
+
   res = InitCacheMenu(decs, kNC_BrowserCharsetMenuRoot, kBrowserCachePrefKey, 
                       &mBrowserMenu);
   NS_ASSERTION(NS_SUCCEEDED(res), "error initializing browser cache charset menu");
 
   return res;
 }
 
 nsresult nsCharsetMenu::RefreshMailviewMenu()
@@ -897,16 +901,20 @@ nsresult nsCharsetMenu::InitBrowserMenu(
     mPrefs->GetIntPref(kBrowserCacheSizePrefKey, &mBrowserCacheSize);
 
     // compute the position of the menu in the RDF container
     res = container->GetCount(&mBrowserMenuRDFPosition);
     if (NS_FAILED(res)) return res;
     // this "1" here is a correction necessary because the RDF container 
     // elements are numbered from 1 (why god, WHY?!?!?!)
     mBrowserMenuRDFPosition -= mBrowserCacheStart - 1;
+
+    // Remove "notForBrowser" entries before populating cache menu
+    res = RemoveFlaggedCharsets(browserDecoderList, NS_LITERAL_STRING(".notForBrowser"));
+    NS_ASSERTION(NS_SUCCEEDED(res), "error initializing static charset menu from prefs");
 
     res = InitCacheMenu(browserDecoderList, kNC_BrowserCharsetMenuRoot, kBrowserCachePrefKey, 
       &mBrowserMenu);
     NS_ASSERTION(NS_SUCCEEDED(res), "error initializing browser cache charset menu");
 
     // register prefs callback
     nsCOMPtr<nsIPrefBranch2> pbi = do_QueryInterface(mPrefs);
     if (pbi)
@@ -1205,23 +1213,22 @@ nsresult nsCharsetMenu::InitMoreMenu(nsC
                                      nsIRDFResource * aResource, 
                                      const char * aFlag)
 {
   NS_TIMELINE_START_TIMER("nsCharsetMenu::InitMoreMenu");
 
   nsresult res = NS_OK;
   nsCOMPtr<nsIRDFContainer> container;
   nsVoidArray moreMenu;
-  nsAutoString prop; prop.AssignWithConversion(aFlag);
 
   res = NewRDFContainer(mInner, aResource, getter_AddRefs(container));
   if (NS_FAILED(res)) goto done;
 
   // remove charsets "not for browser"
-  res = RemoveFlaggedCharsets(aDecs, &prop);
+  res = RemoveFlaggedCharsets(aDecs, NS_ConvertASCIItoUTF16(aFlag));
   if (NS_FAILED(res)) goto done;
 
   res = AddCharsetArrayToItemArray(moreMenu, aDecs);
   if (NS_FAILED(res)) goto done;
 
   // reorder the array
   res = ReorderMenuItemArray(&moreMenu);
   if (NS_FAILED(res)) goto done;
@@ -1693,32 +1700,32 @@ nsresult nsCharsetMenu::RemoveLastMenuIt
       if (NS_FAILED(res)) return res;
     }
   }
 
   return res;
 }
 
 nsresult nsCharsetMenu::RemoveFlaggedCharsets(nsCStringArray& aList, 
-                                              nsString * aProp)
+                                              const nsString& aProp)
 {
   nsresult res = NS_OK;
   PRUint32 count;
 
   count = aList.Count();
   if (NS_FAILED(res)) return res;
 
   nsCString* charset;
   nsAutoString str;
   for (PRUint32 i = 0; i < count; i++) {
 
     charset = aList.CStringAt(i);
     if (!charset) continue;
 
-    res = mCCManager->GetCharsetData(charset->get(), aProp->get(), str);
+    res = mCCManager->GetCharsetData(charset->get(), aProp.get(), str);
     if (NS_FAILED(res)) continue;
 
     aList.RemoveCStringAt(i);
 
     i--; 
     count--;
   }
 
@@ -1836,16 +1843,23 @@ nsresult nsCharsetMenu::GetCollation(nsI
 // Interface nsICurrentCharsetListener [implementation]
 
 NS_IMETHODIMP nsCharsetMenu::SetCurrentCharset(const PRUnichar * aCharset)
 {
   NS_TIMELINE_START_TIMER("nsCharsetMenu:SetCurrentCharset");
   nsresult res = NS_OK;
 
   if (mBrowserMenuInitialized) {
+    // Don't add item to the cache if it's marked "notForBrowser"
+    nsAutoString str;
+    res = mCCManager->GetCharsetData(NS_LossyConvertUTF16toASCII(aCharset).get(),
+                                     NS_LITERAL_STRING(".notForBrowser").get(), str);
+    if (NS_SUCCEEDED(res)) // succeeded means attribute exists
+      return res; // don't throw
+
     res = AddCharsetToCache(NS_LossyConvertUTF16toASCII(aCharset),
                             &mBrowserMenu, kNC_BrowserCharsetMenuRoot, 
                             mBrowserCacheStart, mBrowserCacheSize,
                             mBrowserMenuRDFPosition);
     if (NS_FAILED(res)) {
         NS_TIMELINE_LEAVE("nsCharsetMenu:SetCurrentCharset");
         return res;
     }
diff --git a/xpinstall/src/nsXPInstallManager.cpp b/xpinstall/src/nsXPInstallManager.cpp
--- a/xpinstall/src/nsXPInstallManager.cpp
+++ b/xpinstall/src/nsXPInstallManager.cpp
@@ -708,16 +708,22 @@ OpenAndValidateArchive(nsIZipReader* hZi
         return nsInstall::CANT_READ_ARCHIVE;
     }
 
     rv = VerifySigning(hZip, aPrincipal);
     if (NS_FAILED(rv))
     {
         NS_WARNING("Signing check of archive failed!");
         return nsInstall::INVALID_SIGNATURE;
+    }
+
+    if (NS_FAILED(hZip->Test("install.rdf")))
+    {
+        NS_WARNING("Archive did not contain an install manifest!");
+        return nsInstall::NO_INSTALL_SCRIPT;
     }
 
     return nsInstall::SUCCESS;
 }
 
 
 nsresult nsXPInstallManager::InstallItems()
 {
diff --git a/xulrunner/installer/Makefile.in b/xulrunner/installer/Makefile.in
--- a/xulrunner/installer/Makefile.in
+++ b/xulrunner/installer/Makefile.in
@@ -134,19 +134,21 @@ DEBDESTDIR=debian/$(MOZ_BUILD_APP)
 DEBDESTDIR=debian/$(MOZ_BUILD_APP)
 
 
 ifeq ($(OS_TARGET),Linux)
 deb: 
 	$(NSINSTALL)  $(topsrcdir)/$(MOZ_BUILD_APP)/installer/debian .
 	rm -rf $(DEBDESTDIR)/usr/local/*
 	$(NSINSTALL) -D $(DEBDESTDIR)/usr/local
-	cd $(DEBDESTDIR)/usr/local; cat ../../../../dist/$(PKG_BASENAME)$(PKG_SUFFIX) | $(UNMAKE_PACKAGE)
+	cd $(DEBDESTDIR)/usr/local; cat ../../../../$(DEPTH)/dist/$(PKG_BASENAME)$(PKG_SUFFIX) | $(UNMAKE_PACKAGE)
 	$(NSINSTALL) -D $(DEBDESTDIR)/usr/share/dbus-1/services/
 	cp debian/$(MOZ_BUILD_APP).service $(DEBDESTDIR)/usr/share/dbus-1/services/org.mozilla.$(MOZ_BUILD_APP).service
 ifdef NS_HILDON
 	$(NSINSTALL) $(DEPTH)/dist/bin/components/softkey.xpt $(DEBDESTDIR)/usr/local/$(MOZ_BUILD_APP)/components/
 	$(NSINSTALL) $(DEPTH)/dist/bin/components/libsoftkey.so $(DEBDESTDIR)/usr/local/$(MOZ_BUILD_APP)/components/
 	$(NSINSTALL) $(DEPTH)/dist/bin/libsoftokn3.* $(DEBDESTDIR)/usr/local/$(MOZ_BUILD_APP)/	
 endif
+	$(NSINSTALL) debian/postinst $(DEBDESTDIR)/DEBIAN
+	$(NSINSTALL) debian/prerm $(DEBDESTDIR)/DEBIAN
 	dh_shlibdeps; fakeroot dh_gencontrol; fakeroot dh_md5sums; dh_builddeb
 endif
 
diff --git a/xulrunner/installer/debian/prerm b/xulrunner/installer/debian/prerm
new file mode 100644
--- /dev/null
+++ b/xulrunner/installer/debian/prerm
@@ -0,0 +1,27 @@
+#!/bin/sh
+# prerm script for moz
+#
+# see: dh_installdeb(1)
+
+set -e
+
+case "$1" in
+    remove|upgrade|deconfigure)
+	/usr/local/xulrunner/xulrunner --unregister-global
+    ;;
+
+    failed-upgrade)
+    ;;
+
+    *)
+        echo "postinst called with unknown argument \`$1'" >&2
+        exit 1
+    ;;
+esac
+
+gtk-update-icon-cache /usr/share/icons/hicolor
+
+
+exit 0
+
+
