diff -r f3ac957eb4af accessible/src/base/nsAccessible.cpp
--- a/accessible/src/base/nsAccessible.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/accessible/src/base/nsAccessible.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -1704,11 +1704,15 @@ nsAccessible::AppendFlatStringFromSubtre
 {
   // Depth first search for all text nodes that are decendants of content node.
   // Append all the text into one flat string
   PRUint32 numChildren = 0;
   nsCOMPtr<nsIDOMXULSelectControlElement> selectControlEl(do_QueryInterface(aContent));
-  if (!selectControlEl) {  // Don't walk children of elements with options, just get label directly
+  
+  if (!selectControlEl && aContent->Tag() != nsAccessibilityAtoms::textarea) {
+    // Don't walk children of elements with options, just get label directly.
+    // Don't traverse the children of a textarea, we want the value, not the
+    // static text node.
     numChildren = aContent->GetChildCount();
   }
 
   if (numChildren == 0) {
     // There are no children or they are irrelvant: get the text from the current node
diff -r f3ac957eb4af accessible/src/base/nsAccessibleEventData.cpp
--- a/accessible/src/base/nsAccessibleEventData.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/accessible/src/base/nsAccessibleEventData.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -36,10 +36,11 @@
  *
  * ***** END LICENSE BLOCK ***** */
 
 #include "nsAccessibleEventData.h"
 #include "nsAccessibilityAtoms.h"
+#include "nsAccessibilityUtils.h"
 #include "nsIAccessibilityService.h"
 #include "nsIAccessNode.h"
 #include "nsIDocument.h"
 #include "nsIDOMDocument.h"
 #include "nsIEventStateManager.h"
diff -r f3ac957eb4af accessible/src/base/nsApplicationAccessible.cpp
--- a/accessible/src/base/nsApplicationAccessible.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/accessible/src/base/nsApplicationAccessible.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -69,11 +69,11 @@ NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN_
         && hasMoreElements) {
 
     enumerator->GetNext(getter_AddRefs(childWeakRef));
     accessible = do_QueryReferent(childWeakRef);
     if (accessible) {
-      NS_CYCLE_COLLECTION_NOTE_EDGE_NAME(cb, accessible);
+      NS_CYCLE_COLLECTION_NOTE_EDGE_NAME(cb, "nsApplicationAccessible child");
       cb.NoteXPCOMChild(accessible);
     }
   }
   
 NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
diff -r f3ac957eb4af accessible/src/base/nsDocAccessible.cpp
--- a/accessible/src/base/nsDocAccessible.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/accessible/src/base/nsDocAccessible.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -143,11 +143,11 @@ ElementTraverser(const void *aKey, nsIAc
                  void *aUserArg)
 {
   nsCycleCollectionTraversalCallback *cb = 
     static_cast<nsCycleCollectionTraversalCallback*>(aUserArg);
 
-  NS_CYCLE_COLLECTION_NOTE_EDGE_NAME(*cb, aAccessNode);
+  NS_CYCLE_COLLECTION_NOTE_EDGE_NAME(*cb, "mAccessNodeCache entry");
   cb->NoteXPCOMChild(aAccessNode);
   return PL_DHASH_NEXT;
 }
 
 NS_IMPL_CYCLE_COLLECTION_CLASS(nsDocAccessible)
diff -r f3ac957eb4af accessible/src/base/nsDocAccessible.h
--- a/accessible/src/base/nsDocAccessible.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/accessible/src/base/nsDocAccessible.h	Sat Sep 06 10:14:36 2008 +0300
@@ -86,11 +86,10 @@ class nsDocAccessible : public nsHyperTe
     NS_IMETHOD GetParent(nsIAccessible **aParent);
     NS_IMETHOD TakeFocus(void);
 
     // ----- nsIScrollPositionListener ---------------------------
     NS_IMETHOD ScrollPositionWillChange(nsIScrollableView *aView, nscoord aX, nscoord aY);
-    virtual void ViewPositionDidChange(nsIScrollableView* aScrollable) {}
     NS_IMETHOD ScrollPositionDidChange(nsIScrollableView *aView, nscoord aX, nscoord aY);
 
     // nsIDocumentObserver
     NS_DECL_NSIDOCUMENTOBSERVER
 
diff -r f3ac957eb4af accessible/src/base/nsRootAccessible.cpp
--- a/accessible/src/base/nsRootAccessible.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/accessible/src/base/nsRootAccessible.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -1092,10 +1092,11 @@ NS_IMETHODIMP nsRootAccessible::FireDocL
                       aEventType == nsIAccessibleEvent::EVENT_DOCUMENT_LOAD_STOPPED);
 
   return NS_OK;
 }
 
+#ifdef MOZ_XUL
 nsresult
 nsRootAccessible::HandleTreeRowCountChangedEvent(nsIDOMEvent *aEvent,
                                                  nsIAccessibleTreeCache *aAccessible)
 {
   nsCOMPtr<nsIDOMDataContainerEvent> dataEvent(do_QueryInterface(aEvent));
@@ -1155,6 +1156,7 @@ nsRootAccessible::HandleTreeInvalidatedE
   if (endColVariant)
     endColVariant->GetAsInt32(&endCol);
 
   return aAccessible->TreeViewInvalidated(startRow, endRow, startCol, endCol);
 }
+#endif
 
diff -r f3ac957eb4af accessible/src/base/nsRootAccessible.h
--- a/accessible/src/base/nsRootAccessible.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/accessible/src/base/nsRootAccessible.h	Sat Sep 06 10:14:36 2008 +0300
@@ -40,11 +40,13 @@
 
 #include "nsCaretAccessible.h"
 #include "nsDocAccessibleWrap.h"
 
 #include "nsIAccessibleDocument.h"
+#ifdef MOZ_XUL
 #include "nsIAccessibleTreeCache.h"
+#endif
 
 #include "nsHashtable.h"
 #include "nsCaretAccessible.h"
 #include "nsIDocument.h"
 #include "nsIDOMFocusListener.h"
@@ -129,20 +131,20 @@ class nsRootAccessible : public nsDocAcc
     void GetChromeEventHandler(nsIDOMEventTarget **aChromeTarget);
 
     /**
      * Handles 'TreeRowCountChanged' event. Used in HandleEventWithTarget().
      */
+#ifdef MOZ_XUL
     nsresult HandleTreeRowCountChangedEvent(nsIDOMEvent *aEvent,
                                             nsIAccessibleTreeCache *aAccessible);
 
     /**
      * Handles 'TreeInvalidated' event. Used in HandleEventWithTarget().
      */
     nsresult HandleTreeInvalidatedEvent(nsIDOMEvent *aEvent,
                                         nsIAccessibleTreeCache *aAccessible);
 
-#ifdef MOZ_XUL
     PRUint32 GetChromeFlags();
 #endif
     already_AddRefed<nsIDocShellTreeItem>
            GetContentDocShell(nsIDocShellTreeItem *aStart);
     nsRefPtr<nsCaretAccessible> mCaretAccessible;
diff -r f3ac957eb4af accessible/tests/mochitest/test_nsIAccessible_name.html
--- a/accessible/tests/mochitest/test_nsIAccessible_name.html	Thu Sep 04 12:36:46 2008 -0400
+++ b/accessible/tests/mochitest/test_nsIAccessible_name.html	Sat Sep 06 10:14:36 2008 +0300
@@ -112,10 +112,23 @@
       //////////////////////////////////////////////////////////////////////////
       // title attribute
 
       // If nothing is left. Let's try title attribute.
       testName("btn_title", "title");
+
+      //////////////////////////////////////////////////////////////////////////
+      // textarea name
+
+      // textarea's name should have the value, which initially is specified by
+      // a text child.
+      testName("textareawithchild", "Story: Foo");
+
+      // new textarea name should reflect the value change. 
+      var elem = document.getElementById("textareawithchild");
+      elem.value = "Bar";
+
+      testName("textareawithchild", "Story: Bar");
 
       SimpleTest.finish();
     }
 
     SimpleTest.waitForExplicitFinish();
@@ -258,7 +271,15 @@
     </div>
   </div>
 
   <!-- name from title attribute -->
   <span id="btn_title" role="group" title="title">15</span>
+
+  <!-- A textarea nested in a label with a text child (bug #453371). -->
+  <form>
+    <label>Story: 
+      <textarea id="textareawithchild" name="name">Foo</textarea>
+    </label>
+  </form>
+
 </body>
 </html>
diff -r f3ac957eb4af browser/base/content/test/test_bug395533.html
--- a/browser/base/content/test/test_bug395533.html	Thu Sep 04 12:36:46 2008 -0400
+++ b/browser/base/content/test/test_bug395533.html	Sat Sep 06 10:14:36 2008 +0300
@@ -23,12 +23,12 @@ SimpleTest.waitForExplicitFinish();
 
 addLoadEvent(function() {
   // Need privs because the feed seems to have an about:feeds principal or some
   // such.  It's not same-origin with us in any case.
   netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
-  is($("testFrame").contentDocument.documentElement.id, "feedHandler",
-     "Text didn't get sniffed as a feed?");
+  is($("testFrame").contentDocument.documentElement.id, "",
+     "Text got sniffed as a feed?");
 });
 addLoadEvent(SimpleTest.finish);
 
 
 
diff -r f3ac957eb4af browser/components/feeds/src/nsFeedSniffer.cpp
--- a/browser/components/feeds/src/nsFeedSniffer.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/browser/components/feeds/src/nsFeedSniffer.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -57,10 +57,12 @@
 
 #include "nsIStreamListener.h"
 
 #include "nsIHttpChannel.h"
 #include "nsIMIMEHeaderParam.h"
+
+#include "nsMimeTypes.h"
 
 #define TYPE_ATOM "application/atom+xml"
 #define TYPE_RSS "application/rss+xml"
 #define TYPE_MAYBE_FEED "application/vnd.mozilla.maybe.feed"
 
@@ -329,10 +331,21 @@ nsFeedSniffer::GetMIMETypeFromContent(ns
                                NS_LITERAL_CSTRING("1"), PR_FALSE);
     sniffedType.AssignLiteral(TYPE_MAYBE_FEED);
     return NS_OK;
   }
 
+  // Don't sniff arbitrary types.  Limit sniffing to situations that
+  // we think can reasonably arise.
+  if (!contentType.EqualsLiteral(TEXT_HTML) &&
+      !contentType.EqualsLiteral(APPLICATION_OCTET_STREAM) &&
+      // Same criterion as XMLHttpRequest.  Should we be checking for "+xml"
+      // and check for text/xml and application/xml by hand instead?
+      contentType.Find("xml") == -1) {
+    sniffedType.Truncate();
+    return NS_OK;
+  }
+
   // Now we need to potentially decompress data served with 
   // Content-Encoding: gzip
   nsresult rv = ConvertEncodedData(request, data, length);
   if (NS_FAILED(rv))
     return rv;
diff -r f3ac957eb4af browser/components/sessionstore/src/nsSessionStartup.js
--- a/browser/components/sessionstore/src/nsSessionStartup.js	Thu Sep 04 12:36:46 2008 -0400
+++ b/browser/components/sessionstore/src/nsSessionStartup.js	Sat Sep 06 10:14:36 2008 +0300
@@ -133,14 +133,10 @@ SessionStartup.prototype = {
         this._sessionType = Ci.nsISessionStartup.RESUME_SESSION;
       else
         this._iniString = null; // reset the state string
     }
 
-    if (this._prefBranch.getBoolPref("sessionstore.resume_session_once")) {
-      this._prefBranch.setBoolPref("sessionstore.resume_session_once", false);
-    }
-    
     if (this._sessionType != Ci.nsISessionStartup.NO_SESSION) {
       // wait for the first browser window to open
       var observerService = Cc["@mozilla.org/observer-service;1"].
                             getService(Ci.nsIObserverService);
       observerService.addObserver(this, "domwindowopened", true);
@@ -163,12 +159,11 @@ SessionStartup.prototype = {
       observerService.removeObserver(this, "final-ui-startup");
       observerService.removeObserver(this, "quit-application");
       this.init();
       break;
     case "quit-application":
-      // make sure that we don't init at this point, as that might
-      // unwantedly discard the session (cf. bug 409115)
+      // no reason for initializing at this point (cf. bug 409115)
       observerService.removeObserver(this, "final-ui-startup");
       observerService.removeObserver(this, "quit-application");
       break;
     case "domwindowopened":
       var window = aSubject;
diff -r f3ac957eb4af browser/components/sessionstore/src/nsSessionStore.js
--- a/browser/components/sessionstore/src/nsSessionStore.js	Thu Sep 04 12:36:46 2008 -0400
+++ b/browser/components/sessionstore/src/nsSessionStore.js	Sat Sep 06 10:14:36 2008 +0300
@@ -142,11 +142,12 @@ SessionStoreService.prototype = {
 
   // states for all currently opened windows
   _windows: {},
 
   // in case the last closed window ain't a navigator:browser one
-  _lastWindowClosed: null,
+  // (also contains browser popup windows closed after the last non-popup one)
+  _lastClosedWindows: null,
 
   // not-"dirty" windows usually don't need to have their data updated
   _dirtyWindows: {},
 
   // flag all windows as dirty
@@ -231,10 +232,16 @@ SessionStoreService.prototype = {
 
     // remove the session data files if crash recovery is disabled
     if (!this._resume_from_crash)
       this._clearDisk();
     
+    // at this point, we've as good as resumed the session, so we can
+    // clear the resume_session_once flag, if it's set
+    if (this._loadState != STATE_QUITTING &&
+        this._prefBranch.getBoolPref("sessionstore.resume_session_once"))
+      this._prefBranch.setBoolPref("sessionstore.resume_session_once", false);
+    
     // As this is called at delayedStartup, restoration must be initiated here
     this.onLoad(aWindow);
   },
 
   /**
@@ -294,11 +301,11 @@ SessionStoreService.prototype = {
       this._forEachBrowserWindow(function(aWindow) {
         Array.forEach(aWindow.getBrowser().browsers, function(aBrowser) {
           delete aBrowser.parentNode.__SS_data;
         });
       });
-      this._lastWindowClosed = null;
+      this._lastClosedWindows = null;
       this._clearDisk();
       // also clear all data about closed tabs
       for (ix in this._windows) {
         this._windows[ix]._closedTabs = [];
       }
@@ -355,13 +362,14 @@ SessionStoreService.prototype = {
     switch (aEvent.type) {
       case "load":
       case "pageshow":
         this.onTabLoad(aEvent.currentTarget.ownerDocument.defaultView, aEvent.currentTarget, aEvent);
         break;
+      case "change":
       case "input":
       case "DOMAutoComplete":
-        this.onTabInput(aEvent.currentTarget.ownerDocument.defaultView, aEvent.currentTarget, aEvent);
+        this.onTabInput(aEvent.currentTarget.ownerDocument.defaultView, aEvent.currentTarget);
         break;
       case "TabOpen":
       case "TabClose":
         var panelID = aEvent.originalTarget.linkedPanel;
         var tabpanel = aEvent.originalTarget.ownerDocument.getElementById(panelID);
@@ -402,10 +410,12 @@ SessionStoreService.prototype = {
     // assign it a unique identifier (timestamp)
     aWindow.__SSi = "window" + Date.now();
 
     // and create its data object
     this._windows[aWindow.__SSi] = { tabs: [], selected: 0, _closedTabs: [] };
+    if (!aWindow.toolbar.visible)
+      this._windows[aWindow.__SSi].isPopup = true;
     
     // perform additional initialization when the first window is loading
     if (this._loadState == STATE_STOPPED) {
       this._loadState = STATE_RUNNING;
       this._lastSaveTime = Date.now();
@@ -470,13 +480,20 @@ SessionStoreService.prototype = {
     if (this._loadState == STATE_RUNNING) { // window not closed during a regular shut-down 
       // update all window data for a last time
       this._collectWindowData(aWindow);
       
       // preserve this window's data (in case it was the last navigator:browser)
-      this._lastWindowClosed = this._windows[aWindow.__SSi];
-      this._lastWindowClosed.title = aWindow.content.document.title;
-      this._updateCookies([this._lastWindowClosed]);
+      var winData = this._windows[aWindow.__SSi];
+      winData.title = aWindow.content.document.title;
+      
+      // if this is a popup window, append it to what we've already got (cf. bug 368677)
+      if (!this._lastClosedWindows || !winData.isPopup)
+        this._lastClosedWindows = [winData];
+      else
+        this._lastClosedWindows.push(winData);
+      
+      this._updateCookies(this._lastClosedWindows);
       
       // clear this window from the list
       delete this._windows[aWindow.__SSi];
       
       // save the state without this window to disk
@@ -486,11 +503,11 @@ SessionStoreService.prototype = {
     for (var i = 0; i < tabpanels.childNodes.length; i++) {
       this.onTabRemove(aWindow, tabpanels.childNodes[i], true);
     }
     
     // cache the window state until the window is completely gone
-    aWindow.__SS_dyingCache = this._windows[aWindow.__SSi] || this._lastWindowClosed;
+    aWindow.__SS_dyingCache = this._windows[aWindow.__SSi] || winData;
     
     // reset the _tab property to avoid keeping the tab's XUL element alive
     // longer than we need it
     var tabCount = aWindow.__SS_dyingCache.tabs.length;
     for (var t = 0; t < tabCount; t++) {
@@ -510,10 +527,11 @@ SessionStoreService.prototype = {
    *        bool Do not save state if we're updating an existing tab
    */
   onTabAdd: function sss_onTabAdd(aWindow, aPanel, aNoNotification) {
     aPanel.addEventListener("load", this, true);
     aPanel.addEventListener("pageshow", this, true);
+    aPanel.addEventListener("change", this, true);
     aPanel.addEventListener("input", this, true);
     aPanel.addEventListener("DOMAutoComplete", this, true);
     
     if (!aNoNotification) {
       this.saveStateDelayed(aWindow);
@@ -530,15 +548,15 @@ SessionStoreService.prototype = {
    *        bool Do not save state if we're updating an existing tab
    */
   onTabRemove: function sss_onTabRemove(aWindow, aPanel, aNoNotification) {
     aPanel.removeEventListener("load", this, true);
     aPanel.removeEventListener("pageshow", this, true);
+    aPanel.removeEventListener("change", this, true);
     aPanel.removeEventListener("input", this, true);
     aPanel.removeEventListener("DOMAutoComplete", this, true);
     
     delete aPanel.__SS_data;
-    delete aPanel.__SS_text;
     
     if (!aNoNotification) {
       this.saveStateDelayed(aWindow);
     }
   },
@@ -570,11 +588,11 @@ SessionStoreService.prototype = {
     // reset the _tab property to avoid keeping the tab's XUL element alive
     // longer than we need it
     delete tabState._tab;
     
     // store closed-tab data for undo
-    if (tabState.entries.length > 1 || tabState.entries[0].url != "about:blank") {
+    if (tabState.entries.length > 0) {
       this._windows[aWindow.__SSi]._closedTabs.unshift({
         state: tabState,
         title: aTab.getAttribute("label"),
         image: aTab.getAttribute("image"),
         pos: aTab._tPos
@@ -600,31 +618,28 @@ SessionStoreService.prototype = {
     if (aEvent.type != "load" && !aEvent.persisted) {
       return;
     }
     
     delete aPanel.__SS_data;
-    delete aPanel.__SS_text;
     this.saveStateDelayed(aWindow);
     
     // attempt to update the current URL we send in a crash report
     this._updateCrashReportURL(aWindow);
   },
 
   /**
    * Called when a tabpanel sends the "input" notification 
-   * stores textarea data
    * @param aWindow
    *        Window reference
    * @param aPanel
    *        TabPanel reference
-   * @param aEvent
-   *        Event obj
    */
-  onTabInput: function sss_onTabInput(aWindow, aPanel, aEvent) {
-    if (this._saveTextData(aPanel, aEvent.originalTarget)) {
-      this.saveStateDelayed(aWindow, 3000);
-    }
+  onTabInput: function sss_onTabInput(aWindow, aPanel) {
+    if (aPanel.__SS_data)
+      delete aPanel.__SS_data._formDataSaved;
+    
+    this.saveStateDelayed(aWindow, 3000);
   },
 
   /**
    * When a tab is selected, save session data
    * @param aWindow
@@ -686,11 +701,11 @@ SessionStoreService.prototype = {
     return this._toJSONString(tabState);
   },
 
   setTabState: function sss_setTabState(aTab, aState) {
     var tabState = this._safeEval("(" + aState + ")");
-    if (!tabState.entries || !tabState.entries.length) {
+    if (!tabState.entries) {
       Components.returnCode = Cr.NS_ERROR_INVALID_ARG;
       return;
     }
     tabState._tab = aTab;
     
@@ -855,11 +870,11 @@ SessionStoreService.prototype = {
    * @param aFullData
    *        always return privacy sensitive data (use with care)
    * @returns object
    */
   _collectTabData: function sss_collectTabData(aTab, aFullData) {
-    var tabData = { entries: [], index: 0 };
+    var tabData = { entries: [] };
     var browser = aTab.linkedBrowser;
     
     if (!browser || !browser.currentURI)
       // can happen when calling this function right after .addTab()
       return tabData;
@@ -886,11 +901,12 @@ SessionStoreService.prototype = {
 
       // make sure not to cache privacy sensitive data which shouldn't get out
       if (!aFullData)
         browser.parentNode.__SS_data = tabData;
     }
-    else {
+    else if (browser.currentURI.spec != "about:blank" ||
+             browser.contentDocument.body.hasChildNodes()) {
       tabData.entries[0] = { url: browser.currentURI.spec };
       tabData.index = 1;
     }
     
     var disallow = [];
@@ -1030,72 +1046,21 @@ SessionStoreService.prototype = {
     
     return entry;
   },
 
   /**
-   * Updates the current document's cache of user entered text data
-   * @param aPanel
-   *        TabPanel reference
-   * @param aTextarea
-   *        HTML content element
-   * @returns bool
-   */
-  _saveTextData: function sss_saveTextData(aPanel, aTextarea) {
-    var id = aTextarea.id ? "#" + aTextarea.id :
-                            aTextarea.name;
-    if (!id
-      || !(aTextarea instanceof Ci.nsIDOMHTMLTextAreaElement 
-      || aTextarea instanceof Ci.nsIDOMHTMLInputElement)) {
-      return false; // nothing to save
-    }
-    
-    if (!aPanel.__SS_text) {
-      aPanel.__SS_text = [];
-      aPanel.__SS_text._refs = [];
-    }
-    
-    // get the index of the reference to the text element
-    var ix = aPanel.__SS_text._refs.indexOf(aTextarea);
-    if (ix == -1) {
-      // we haven't registered this text element yet - do so now
-      aPanel.__SS_text._refs.push(aTextarea);
-      ix = aPanel.__SS_text.length;
-    }
-    else if (!aPanel.__SS_text[ix].cache) {
-      // we've already marked this text element for saving (the cache is
-      // added during save operations and would have to be updated here)
-      return false;
-    }
-    
-    // determine the frame we're in and encode it into the textarea's ID
-    var content = aTextarea.ownerDocument.defaultView;
-    while (content != content.top) {
-      var frames = content.parent.frames;
-      for (var i = 0; i < frames.length && frames[i] != content; i++);
-      id = i + "|" + id;
-      content = content.parent;
-    }
-    
-    // mark this element for saving
-    aPanel.__SS_text[ix] = { id: id, element: aTextarea };
-    
-    return true;
-  },
-
-  /**
    * go through all tabs and store the current scroll positions
    * and innerHTML content of WYSIWYG editors
    * @param aWindow
    *        Window reference
    */
   _updateTextAndScrollData: function sss_updateTextAndScrollData(aWindow) {
     var browsers = aWindow.getBrowser().browsers;
     for (var i = 0; i < browsers.length; i++) {
       try {
         var tabData = this._windows[aWindow.__SSi].tabs[i];
-        if (tabData.entries.length == 0 ||
-            browsers[i].parentNode.__SS_data && browsers[i].parentNode.__SS_data._tab)
+        if (browsers[i].parentNode.__SS_data && browsers[i].parentNode.__SS_data._tab)
           continue; // ignore incompletely initialized tabs
         this._updateTextAndScrollDataForTab(aWindow, browsers[i], tabData);
       }
       catch (ex) { debug(ex); } // get as much data as possible, ignore failures (might succeed the next time)
     }
@@ -1113,69 +1078,105 @@ SessionStoreService.prototype = {
    * @param aFullData
    *        always return privacy sensitive data (use with care)
    */
   _updateTextAndScrollDataForTab:
     function sss_updateTextAndScrollDataForTab(aWindow, aBrowser, aTabData, aFullData) {
-    var text = [];
-    if (aBrowser.parentNode.__SS_text &&
-        (aFullData || this._checkPrivacyLevel(aBrowser.currentURI.schemeIs("https")))) {
-      for (var ix = aBrowser.parentNode.__SS_text.length - 1; ix >= 0; ix--) {
-        var data = aBrowser.parentNode.__SS_text[ix];
-        if (!data.cache)
-          // update the text element's value before adding it to the data structure
-          data.cache = encodeURI(data.element.value);
-        text.push(data.id + "=" + data.cache);
-      }
-    }
-    if (aBrowser.currentURI.spec == "about:config")
-      text = ["#textbox=" + encodeURI(aBrowser.contentDocument.getElementById("textbox").
-                                               wrappedJSObject.value)];
-    if (text.length > 0)
-      aTabData.text = text.join(" ");
-    else if (aTabData.text)
-      delete aTabData.text;
-    
     var tabIndex = (aTabData.index || aTabData.entries.length) - 1;
     // entry data needn't exist for tabs just initialized with an incomplete session state
-    if (aTabData.entries[tabIndex])
-      this._updateTextAndScrollDataForFrame(aWindow, aBrowser.contentWindow,
-                                            aTabData.entries[tabIndex], aFullData);
+    if (!aTabData.entries[tabIndex])
+      return;
+    
+    this._updateTextAndScrollDataForFrame(aWindow, aBrowser.contentWindow,
+                                          aTabData.entries[tabIndex],
+                                          !aTabData._formDataSaved, aFullData);
+    aTabData._formDataSaved = true;
+    if (aBrowser.currentURI.spec == "about:config")
+      aTabData.entries[tabIndex].formdata = {
+        "#textbox": aBrowser.contentDocument.getElementById("textbox").wrappedJSObject.value
+      };
   },
 
   /**
-   * go through all subframes and store the current scroll positions
-   * and innerHTML content of WYSIWYG editors
+   * go through all subframes and store all form data, the current
+   * scroll positions and innerHTML content of WYSIWYG editors
    * @param aWindow
    *        Window reference
    * @param aContent
    *        frame reference
    * @param aData
    *        part of a tabData object to add the information to
+   * @param aUpdateFormData
+   *        update all form data for this tab
    * @param aFullData
    *        always return privacy sensitive data (use with care)
    */
   _updateTextAndScrollDataForFrame:
-    function sss_updateTextAndScrollDataForFrame(aWindow, aContent, aData, aFullData) {
+    function sss_updateTextAndScrollDataForFrame(aWindow, aContent, aData,
+                                                 aUpdateFormData, aFullData) {
     for (var i = 0; i < aContent.frames.length; i++) {
       if (aData.children && aData.children[i])
-        this._updateTextAndScrollDataForFrame(aWindow, aContent.frames[i], aData.children[i], aFullData);
+        this._updateTextAndScrollDataForFrame(aWindow, aContent.frames[i],
+                                              aData.children[i], aUpdateFormData, aFullData);
     }
-    // designMode is undefined e.g. for XUL documents (as about:config)
     var isHTTPS = this._getURIFromString((aContent.parent || aContent).
                                          document.location.href).schemeIs("https");
-    if ((aContent.document.designMode || "") == "on" &&
-        (aFullData || this._checkPrivacyLevel(isHTTPS))) {
-      if (aData.innerHTML === undefined && !aFullData) {
-        // we get no "input" events from iframes - listen for keypress here
-        var _this = this;
-        aContent.addEventListener("keypress", function(aEvent) {
-          _this.saveStateDelayed(aWindow, 3000); }, true);
+    if (aFullData || this._checkPrivacyLevel(isHTTPS)) {
+      if (aFullData || aUpdateFormData) {
+        let formData = this._collectFormDataForFrame(aContent.document);
+        if (formData)
+          aData.formdata = formData;
+        else if (aData.formdata)
+          delete aData.formdata;
       }
-      aData.innerHTML = aContent.document.body.innerHTML;
+      
+      // designMode is undefined e.g. for XUL documents (as about:config)
+      if ((aContent.document.designMode || "") == "on") {
+        if (aData.innerHTML === undefined && !aFullData) {
+          // we get no "input" events from iframes - listen for keypress here
+          let _this = this;
+          aContent.addEventListener("keypress", function(aEvent) {
+            _this.saveStateDelayed(aWindow, 3000);
+          }, true);
+        }
+        aData.innerHTML = aContent.document.body.innerHTML;
+      }
     }
     aData.scroll = aContent.scrollX + "," + aContent.scrollY;
    },
+
+  /**
+   * collect the state of all form elements
+   * @param aDocument
+   *        document reference
+   */
+  _collectFormDataForFrame: function sss_collectFormDataForFrame(aDocument) {
+    let formNodesXPath = "//textarea|//select|//xhtml:textarea|//xhtml:select|" +
+      "//input[not(@type) or @type='text' or @type='checkbox' or @type='radio' or @type='file']|" +
+      "//xhtml:input[not(@type) or @type='text' or @type='checkbox' or @type='radio' or @type='file']";
+    let formNodes = aDocument.evaluate(formNodesXPath, aDocument, XPathHelper.resolveNS,
+                                       Ci.nsIDOMXPathResult.UNORDERED_NODE_ITERATOR_TYPE, null);
+    let node = formNodes.iterateNext();
+    if (!node)
+      return null;
+    
+    let data = {};
+    do {
+      let id = node.id ? "#" + node.id : XPathHelper.generate(node);
+      if (node instanceof Ci.nsIDOMHTMLInputElement)
+        data[id] = node.type == "checkbox" || node.type == "radio" ? node.checked : node.value;
+      else if (node instanceof Ci.nsIDOMHTMLTextAreaElement)
+        data[id] = node.value;
+      else if (!node.multiple)
+        data[id] = node.selectedIndex;
+      else {
+        let options = Array.map(node.options, function(aOpt, aIx) aOpt.selected ? aIx : -1);
+        data[id] = options.filter(function(aIx) aIx >= 0);
+      }
+    } while ((node = formNodes.iterateNext()));
+    
+    return data;
+  },
 
   /**
    * store all hosts for a URL
    * @param aWindow
    *        Window reference
@@ -1296,20 +1297,25 @@ SessionStoreService.prototype = {
       this._dirty = false;
     }
     
     // collect the data for all windows
     var total = [], windows = [];
+    var nonPopupCount = 0;
     var ix;
     for (ix in this._windows) {
       total.push(this._windows[ix]);
       windows.push(ix);
+      if (!this._windows[ix].isPopup)
+        nonPopupCount++;
     }
     this._updateCookies(total);
     
-    // if no browser window remains open, return the state of the last closed window
-    if (total.length == 0 && this._lastWindowClosed) {
-      total.push(this._lastWindowClosed);
+    // if no non-popup browser window remains open, return the state of the last closed window(s)
+    if (nonPopupCount == 0 && this._lastClosedWindows) {
+      // prepend the last non-popup browser window, so that if the user loads more tabs
+      // at startup we don't accidentally add them to a popup window
+      total = this._lastClosedWindows.concat(total);
     }
     if (activeWindow) {
       this.activeWindowSSiCache = activeWindow.__SSi || "";
     }
     ix = this.activeWindowSSiCache ? windows.indexOf(this.activeWindowSSiCache) : -1;
@@ -1405,15 +1411,13 @@ SessionStoreService.prototype = {
     if (!winData.tabs) {
       winData.tabs = [];
     }
     // don't restore a single blank tab when we've had an external
     // URL passed in for loading at startup (cf. bug 357419)
-    else if (root._firstTabs && !aOverwriteTabs && winData.tabs.length == 1) {
-      let tabEntries = winData.tabs[0].entries || [];
-      if (tabEntries.length == 0 ||
-          tabEntries.length == 1 && tabEntries[0].url == "about:blank")
-        winData.tabs = [];
+    else if (root._firstTabs && !aOverwriteTabs && winData.tabs.length == 1 &&
+             (!winData.tabs[0].entries || winData.tabs[0].entries.length == 0)) {
+      winData.tabs = [];
     }
     
     var tabbrowser = aWindow.getBrowser();
     var openTabCount = aOverwriteTabs ? tabbrowser.browsers.length : -1;
     var newTabCount = winData.tabs.length;
@@ -1488,20 +1492,31 @@ SessionStoreService.prototype = {
       }
     }
     
     // mark the tabs as loading
     for (t = 0; t < aTabs.length; t++) {
-      if (!aTabs[t].entries || !aTabs[t].entries[0])
-        continue; // there won't be anything to load
-      
       var tab = aTabs[t]._tab;
       var browser = tabbrowser.getBrowserForTab(tab);
+      
+      if (!aTabs[t].entries || aTabs[t].entries.length == 0) {
+        // make sure to blank out this tab's content
+        // (just purging the tab's history won't be enough)
+        browser.contentDocument.location = "about:blank";
+        continue;
+      }
+      
       browser.stop(); // in case about:blank isn't done yet
       
       tab.setAttribute("busy", "true");
       tabbrowser.updateIcon(tab);
       tabbrowser.setTabTitleLoading(tab);
+      
+      // wall-paper fix for bug 439675: make sure that the URL to be loaded
+      // is always visible in the address bar
+      let activeIndex = (aTabs[t].index || aTabs[t].entries.length) - 1;
+      let activePageData = aTabs[t].entries[activeIndex] || null;
+      browser.userTypedValue = activePageData ? activePageData.url || null : null;
       
       // keep the data around to prevent dataloss in case
       // a tab gets closed before it's been properly restored
       browser.parentNode.__SS_data = aTabs[t];
     }
@@ -1579,24 +1594,32 @@ SessionStoreService.prototype = {
     // notify the tabbrowser that the tab chrome has been restored
     var event = aWindow.document.createEvent("Events");
     event.initEvent("SSTabRestoring", true, false);
     tab.dispatchEvent(event);
     
-    var activeIndex = (tabData.index || tabData.entries.length) - 1;
+    let activeIndex = (tabData.index || tabData.entries.length) - 1;
+    if (activeIndex >= tabData.entries.length)
+      activeIndex = tabData.entries.length - 1;
     try {
-      browser.webNavigation.gotoIndex(activeIndex);
+      if (activeIndex >= 0)
+        browser.webNavigation.gotoIndex(activeIndex);
     }
-    catch (ex) { } // ignore an invalid tabData.index
+    catch (ex) {
+      // ignore page load errors
+      tab.removeAttribute("busy");
+    }
     
-    // restore those aspects of the currently active documents
-    // which are not preserved in the plain history entries
-    // (mainly scroll state and text data)
-    browser.__SS_restore_data = tabData.entries[activeIndex] || {};
-    browser.__SS_restore_text = tabData.text || "";
-    browser.__SS_restore_tab = tab;
-    browser.__SS_restore = this.restoreDocument_proxy;
-    browser.addEventListener("load", browser.__SS_restore, true);
+    if (tabData.entries.length > 0) {
+      // restore those aspects of the currently active documents
+      // which are not preserved in the plain history entries
+      // (mainly scroll state and text data)
+      browser.__SS_restore_data = tabData.entries[activeIndex] || {};
+      browser.__SS_restore_text = tabData.text || "";
+      browser.__SS_restore_tab = tab;
+      browser.__SS_restore = this.restoreDocument_proxy;
+      browser.addEventListener("load", browser.__SS_restore, true);
+    }
     
     aWindow.setTimeout(function(){ _this.restoreHistory(aWindow, aTabs, aIdMap); }, 0);
   },
 
   /**
@@ -1694,10 +1717,11 @@ SessionStoreService.prototype = {
     // wait for the top frame to be loaded completely
     if (!aEvent || !aEvent.originalTarget || !aEvent.originalTarget.defaultView || aEvent.originalTarget.defaultView != aEvent.originalTarget.defaultView.top) {
       return;
     }
     
+    // restore text data saved by Firefox 2.0/3.0
     var textArray = this.__SS_restore_text ? this.__SS_restore_text.split(" ") : [];
     function restoreTextData(aContent, aPrefix) {
       textArray.forEach(function(aEntry) {
         if (/^((?:\d+\|)*)(#?)([^\s=]+)=(.*)$/.test(aEntry) && (!RegExp.$1 || RegExp.$1 == aPrefix)) {
           var document = aContent.document;
@@ -1711,12 +1735,45 @@ SessionStoreService.prototype = {
           }
         }
       });
     }
     
+    function restoreFormData(aDocument, aData) {
+      for (let key in aData) {
+        let node = key.charAt(0) == "#" ? aDocument.getElementById(key.slice(1)) :
+                                          XPathHelper.resolve(aDocument, key);
+        if (!node)
+          continue;
+        
+        let value = aData[key];
+        if (typeof value == "string") {
+          node.value = value;
+          
+          let event = aDocument.createEvent("UIEvents");
+          event.initUIEvent("input", true, true, aDocument.defaultView, 0);
+          node.dispatchEvent(event);
+        }
+        else if (typeof value == "boolean")
+          node.checked = value;
+        else if (typeof value == "number")
+          try {
+            node.selectedIndex = value;
+          } catch (ex) { /* throws for invalid indices */ }
+        else if (value && typeof value.indexOf == "function" && node.options) {
+          Array.forEach(node.options, function(aOpt, aIx) {
+            aOpt.selected = value.indexOf(aIx) > -1;
+          });
+        }
+        // NB: dispatching "change" events might have unintended side-effects
+      }
+    }
+    
     function restoreTextDataAndScrolling(aContent, aData, aPrefix) {
-      restoreTextData(aContent, aPrefix);
+      if (aData.formdata)
+        restoreFormData(aContent.document, aData.formdata);
+      else
+        restoreTextData(aContent, aPrefix);
       if (aData.innerHTML) {
         aContent.setTimeout(function(aHTML) { if (this.document.designMode == "on") { this.document.body.innerHTML = aHTML; } }, 0, aData.innerHTML);
       }
       if (aData.scroll && /(\d+),(\d+)/.test(aData.scroll)) {
         aContent.scrollTo(RegExp.$1, RegExp.$2);
@@ -1726,22 +1783,27 @@ SessionStoreService.prototype = {
           restoreTextDataAndScrolling(aContent.frames[i], aData.children[i], i + "|" + aPrefix);
         }
       }
     }
     
-    var content = aEvent.originalTarget.defaultView;
-    if (this.currentURI.spec == "about:config") {
-      // unwrap the document for about:config because otherwise the properties
-      // of the XBL bindings - as the textbox - aren't accessible (see bug 350718)
-      content = content.wrappedJSObject;
+    // don't restore text data and scrolling state if the user has navigated
+    // away before the loading completed (except for in-page navigation)
+    if (!this.__SS_restore_data.url || this.currentURI.spec.replace(/#.*/, "") ==
+                                       this.__SS_restore_data.url.replace(/#.*/, "")) {
+      var content = aEvent.originalTarget.defaultView;
+      if (this.currentURI.spec == "about:config") {
+        // unwrap the document for about:config because otherwise the properties
+        // of the XBL bindings - as the textbox - aren't accessible (see bug 350718)
+        content = content.wrappedJSObject;
+      }
+      restoreTextDataAndScrolling(content, this.__SS_restore_data, "");
+      
+      // notify the tabbrowser that this document has been completely restored
+      var event = this.ownerDocument.createEvent("Events");
+      event.initEvent("SSTabRestored", true, false);
+      this.__SS_restore_tab.dispatchEvent(event);
     }
-    restoreTextDataAndScrolling(content, this.__SS_restore_data, "");
-    
-    // notify the tabbrowser that this document has been completely restored
-    var event = this.ownerDocument.createEvent("Events");
-    event.initEvent("SSTabRestored", true, false);
-    this.__SS_restore_tab.dispatchEvent(event);
     
     this.removeEventListener("load", this.__SS_restore, true);
     delete this.__SS_restore_data;
     delete this.__SS_restore_text;
     delete this.__SS_restore_tab;
@@ -1758,10 +1820,15 @@ SessionStoreService.prototype = {
   restoreWindowFeatures: function sss_restoreWindowFeatures(aWindow, aWinData) {
     var hidden = (aWinData.hidden)?aWinData.hidden.split(","):[];
     WINDOW_HIDEABLE_FEATURES.forEach(function(aItem) {
       aWindow[aItem].visible = hidden.indexOf(aItem) == -1;
     });
+    
+    if (aWinData.isPopup)
+      this._windows[aWindow.__SSi].isPopup = true;
+    else
+      delete this._windows[aWindow.__SSi].isPopup;
     
     var _this = this;
     aWindow.setTimeout(function() {
       _this.restoreDimensions.apply(_this, [aWindow, aWinData.width || 0, 
         aWinData.height || 0, "screenX" in aWinData ? aWinData.screenX : NaN,
@@ -1808,11 +1875,11 @@ SessionStoreService.prototype = {
       aWindow.toggleSidebar(aSidebar);
     }
     // since resizing/moving a window brings it to the foreground,
     // we might want to re-focus the last focused window
     if (this.windowToFocus) {
-      this.windowToFocus.focus();
+      this.windowToFocus.content.focus();
     }
   },
 
   /**
    * Restores cookies (accepting both Firefox 2.0 and current format)
@@ -2117,11 +2184,11 @@ SessionStoreService.prototype = {
    *
    * @param aJSObject is the object to be converted
    * @return the object's JSON representation
    */
   _toJSONString: function sss_toJSONString(aJSObject) {
-    var str = JSON.toString(aJSObject, ["_tab", "_hosts"] /* keys to drop */);
+    let str = JSON.toString(aJSObject, ["_tab", "_hosts", "_formDataSaved"] /* keys to drop */);
     
     // sanity check - so that API consumers can just eval this string
     if (!JSON.isMostlyHarmless(str))
       throw new Error("JSON conversion failed unexpectedly!");
     
@@ -2158,7 +2225,67 @@ SessionStoreService.prototype = {
       stream.close();
     }
   }
 };
 
+let XPathHelper = {
+  // these two hashes should be kept in sync
+  namespaceURIs:     { "xhtml": "http://www.w3.org/1999/xhtml" },
+  namespacePrefixes: { "http://www.w3.org/1999/xhtml": "xhtml" },
+
+  /**
+   * Generates an approximate XPath query to an (X)HTML node
+   */
+  generate: function sss_xph_generate(aNode) {
+    // have we reached the document node already?
+    if (!aNode.parentNode)
+      return "";
+    
+    let prefix = this.namespacePrefixes[aNode.namespaceURI] || null;
+    let tag = (prefix ? prefix + ":" : "") + aNode.localName;
+    
+    // stop once we've found a tag with an ID
+    if (aNode.id)
+      return "//" + tag + "[@id=" + this.quoteArgument(aNode.id) + "]";
+    
+    // count the number of previous sibling nodes of the same tag
+    // (and possible also the same name)
+    let count = 0;
+    let nName = aNode.name || null;
+    for (let n = aNode; (n = n.previousSibling); )
+      if (n.localName == aNode.localName && n.namespaceURI == aNode.namespaceURI &&
+          (!nName || n.name == nName))
+        count++;
+    
+    // recurse until hitting either the document node or an ID'd node
+    return this.generate(aNode.parentNode) + "/" + tag +
+           (nName ? "[@name=" + this.quoteArgument(nName) + "]" : "") +
+           (count ? "[" + (count + 1) + "]" : "");
+  },
+
+  /**
+   * Resolves an XPath query generated by XPathHelper.generate
+   */
+  resolve: function sss_xph_resolve(aDocument, aQuery) {
+    let xptype = Ci.nsIDOMXPathResult.FIRST_ORDERED_NODE_TYPE;
+    return aDocument.evaluate(aQuery, aDocument, this.resolveNS, xptype, null).singleNodeValue;
+  },
+
+  /**
+   * Namespace resolver for the above XPath resolver
+   */
+  resolveNS: function sss_xph_resolveNS(aPrefix) {
+    return XPathHelper.namespaceURIs[aPrefix] || null;
+  },
+
+  /**
+   * @returns a properly quoted string to insert into an XPath query
+   */
+  quoteArgument: function sss_xph_quoteArgument(aArg) {
+    return !/'/.test(aArg) ? "'" + aArg + "'" :
+           !/"/.test(aArg) ? '"' + aArg + '"' :
+           "concat('" + aArg.replace(/'+/g, "',\"$&\",'") + "')";
+  }
+};
+
 function NSGetModule(aComMgr, aFileSpec)
   XPCOMUtils.generateModule([SessionStoreService]);
diff -r f3ac957eb4af browser/components/sessionstore/test/browser/Makefile.in
--- a/browser/components/sessionstore/test/browser/Makefile.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/browser/components/sessionstore/test/browser/Makefile.in	Sat Sep 06 10:14:36 2008 +0300
@@ -43,11 +43,13 @@ relativesrcdir  = browser/components/ses
 
 include $(DEPTH)/config/autoconf.mk
 include $(topsrcdir)/config/rules.mk
 
 _BROWSER_TEST_FILES = \
+	browser_346337.js \
 	browser_350525.js \
+	browser_367052.js \
 	browser_393716.js \
 	browser_448741.js \
 	$(NULL)
 
 libs:: $(_BROWSER_TEST_FILES)
diff -r f3ac957eb4af browser/components/sessionstore/test/browser/browser_346337.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/browser/components/sessionstore/test/browser/browser_346337.js	Sat Sep 06 10:14:36 2008 +0300
@@ -0,0 +1,125 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is sessionstore test code.
+ *
+ * The Initial Developer of the Original Code is
+ * Simon BÃ¼nzli <zeniko@gmail.com>.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+function test() {
+  /** Test for Bug 346337 **/
+  
+  let fieldList = {
+    "//input[@name='testinput']": Date.now().toString(),
+    "//input[@name='bad name']":  Math.random().toString(),
+    "//input[@type='checkbox']":  true,
+    "//input[@type='radio'][1]":  false,
+    "//input[@type='radio'][2]":  true,
+    "//select":                   2,
+    "//select[@multiple]":        [1, 3],
+    "//textarea[1]":              "",
+    "//textarea[3]":              "Some more test\n" + new Date()
+  };
+  
+  function getElementByXPath(aTab, aQuery) {
+    let doc = aTab.linkedBrowser.contentDocument;
+    let xptype = Ci.nsIDOMXPathResult.FIRST_ORDERED_NODE_TYPE;
+    return doc.evaluate(aQuery, doc, null, xptype, null).singleNodeValue;
+  }
+  
+  function setFormValue(aTab, aQuery, aValue) {
+    let node = getElementByXPath(aTab, aQuery);
+    if (typeof aValue == "string")
+      node.value = aValue;
+    else if (typeof aValue == "boolean")
+      node.checked = aValue;
+    else if (typeof aValue == "number")
+      node.selectedIndex = aValue;
+    else
+      Array.forEach(node.options, function(aOpt, aIx)
+                                    (aOpt.selected = aValue.indexOf(aIx) > -1));
+  }
+  
+  function compareFormValue(aTab, aQuery, aValue) {
+    let node = getElementByXPath(aTab, aQuery);
+    if (!node)
+      return false;
+    if (node instanceof Ci.nsIDOMHTMLInputElement)
+      return aValue == (node.type == "checkbox" || node.type == "radio" ?
+                        node.checked : node.value);
+    if (node instanceof Ci.nsIDOMHTMLTextAreaElement)
+      return aValue == node.value;
+    if (!node.multiple)
+      return aValue == node.selectedIndex;
+    return Array.every(node.options, function(aOpt, aIx)
+                                       (aValue.indexOf(aIx) > -1) == aOpt.selected);
+  }
+  
+  // test setup
+  let tabbrowser = getBrowser();
+  waitForExplicitFinish();
+  
+  // make sure we don't save form data at all (except for tab duplication)
+  let privacy_level = gPrefService.getIntPref("browser.sessionstore.privacy_level");
+  gPrefService.setIntPref("browser.sessionstore.privacy_level", 2);
+  
+  todo(false, "test doesn't run from the harness's http server");
+  let tab = tabbrowser.addTab("https://bugzilla.mozilla.org/attachment.cgi?id=328502");
+  tab.linkedBrowser.addEventListener("load", function(aEvent) {
+    for (let xpath in fieldList)
+      setFormValue(tab, xpath, fieldList[xpath]);
+    
+    let tab2 = tabbrowser.duplicateTab(tab);
+    tab2.linkedBrowser.addEventListener("load", function(aEvent) {
+      for (let xpath in fieldList)
+        ok(compareFormValue(tab2, xpath, fieldList[xpath]),
+           "The value for \"" + xpath + "\" was correctly restored");
+      
+      // clean up
+      tabbrowser.removeTab(tab2);
+      tabbrowser.removeTab(tab);
+      
+      undoCloseTab();
+      
+      tab = tabbrowser.selectedTab;
+      tab.linkedBrowser.addEventListener("load", function(aEvent) {
+        for (let xpath in fieldList)
+          if (fieldList[xpath])
+            ok(!compareFormValue(tab, xpath, fieldList[xpath]),
+               "The value for \"" + xpath + "\" was correctly discarded");
+        
+        gPrefService.setIntPref("browser.sessionstore.privacy_level", privacy_level);
+        tabbrowser.removeTab(tab);
+        finish();
+      }, true);
+    }, true);
+  }, true);
+}
diff -r f3ac957eb4af browser/components/sessionstore/test/browser/browser_367052.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/browser/components/sessionstore/test/browser/browser_367052.js	Sat Sep 06 10:14:36 2008 +0300
@@ -0,0 +1,72 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is sessionstore test code.
+ *
+ * The Initial Developer of the Original Code is
+ * Simon BÃ¼nzli <zeniko@gmail.com>.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+function test() {
+  /** Test for Bug 367052 **/
+  
+  // test setup
+  let ss = Cc["@mozilla.org/browser/sessionstore;1"].getService(Ci.nsISessionStore);
+  let tabbrowser = gBrowser;
+  waitForExplicitFinish();
+  
+  // make sure that the next closed tab will increase getClosedTabCount
+  let max_tabs_undo = gPrefService.getIntPref("browser.sessionstore.max_tabs_undo");
+  gPrefService.setIntPref("browser.sessionstore.max_tabs_undo", max_tabs_undo + 1);
+  let closedTabCount = ss.getClosedTabCount(window);
+  
+  // restore a blank tab
+  let tab = tabbrowser.addTab("about:");
+  tab.linkedBrowser.addEventListener("load", function(aEvent) {
+    this.removeEventListener("load", arguments.callee, true);
+    
+    let browser = tabbrowser.getBrowserForTab(tab);
+    let history = browser.webNavigation.sessionHistory;
+    ok(history.count >= 1, "the new tab does have at least one history entry");
+    
+    ss.setTabState(tab, "{ entries: [] }");
+    tab.linkedBrowser.addEventListener("load", function(aEvent) {
+      ok(history.count == 0, "the tab was restored without any history whatsoever");
+      
+      tabbrowser.removeTab(tab);
+      ok(ss.getClosedTabCount(window) == closedTabCount,
+         "The closed blank tab wasn't added to Recently Closed Tabs");
+      
+      // clean up
+      gPrefService.setIntPref("browser.sessionstore.max_tabs_undo", max_tabs_undo);
+      finish();
+    }, true);
+  }, true);
+}
diff -r f3ac957eb4af build/Makefile.in
--- a/build/Makefile.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/build/Makefile.in	Sat Sep 06 10:14:36 2008 +0300
@@ -77,13 +77,17 @@ else
 else
 browser_path = \"$(DIST)/bin/$(PROGRAM)\"
 endif
 endif
 
+_CERTS_DIR = _profile/pgo/certs
+
 AUTOMATION_PPARGS = 	\
 			-DBROWSER_PATH=$(browser_path) \
 			-DXPC_BIN_PATH=\"$(DIST)/bin\" \
+			-DBIN_SUFFIX=\"$(BIN_SUFFIX)\" \
+			-DCERTS_DIR=\"../$(_CERTS_DIR)\" \
 			$(NULL)
 
 ifeq ($(OS_ARCH),Darwin)
 AUTOMATION_PPARGS += -DIS_MAC=1
 else
diff -r f3ac957eb4af build/pgo/Makefile.in
--- a/build/pgo/Makefile.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/build/pgo/Makefile.in	Sat Sep 06 10:14:36 2008 +0300
@@ -41,23 +41,30 @@ srcdir		= @srcdir@
 srcdir		= @srcdir@
 VPATH		= @srcdir@
 relativesrcdir = build/pgo
 
 include $(DEPTH)/config/autoconf.mk
+
+DIRS = \
+		certs \
+		$(NULL)
+
 include $(topsrcdir)/config/rules.mk
 
 # Stuff to make a build with a profile
 _PROFILE_DIR = $(DEPTH)/_profile/pgo
+_CERTS_DIR = $(_PROFILE_DIR)/certs
+_CERTS_SRC_DIR = $(srcdir)/certs
 
 _PGO_FILES = 	\
 		automation.py \
 		profileserver.py \
+		genpgocert.py \
 		index.html \
 		quit.js \
 		server-locations.txt \
 		$(NULL)
-
 
 ifeq ($(USE_SHORT_LIBNAME), 1)
 PROGRAM = $(MOZ_APP_NAME)$(BIN_SUFFIX)
 else
 PROGRAM = $(MOZ_APP_NAME)-bin$(BIN_SUFFIX)
@@ -78,10 +85,13 @@ endif
 endif
 
 AUTOMATION_PPARGS = 	\
 			-DBROWSER_PATH=$(browser_path) \
 			-DXPC_BIN_PATH=\"$(DIST)/bin\" \
+			-DBIN_SUFFIX=\"$(BIN_SUFFIX)\" \
+			-DCERTS_DIR=\"$(_CERTS_DIR)\" \
+			-DCERTS_SRC_DIR=\"$(_CERTS_SRC_DIR)\" \
 			$(NULL)
 
 ifeq ($(OS_ARCH),Darwin)
 AUTOMATION_PPARGS += -DIS_MAC=1
 else
@@ -100,13 +110,17 @@ endif
 
 automation.py: automation.py.in
 	$(PYTHON) $(topsrcdir)/config/Preprocessor.py \
 	$(AUTOMATION_PPARGS) $(DEFINES) $(ACDEFINES) $^ > $@
 
+genpgocert.py: genpgocert.py.in
+	$(PYTHON) $(topsrcdir)/config/Preprocessor.py \
+	$(AUTOMATION_PPARGS) $(DEFINES) $(ACDEFINES) $^ > $@
+
 profileserver.py: profileserver.py.in
 	$(PYTHON) $(topsrcdir)/config/Preprocessor.py $^ > $@
 	chmod +x $@
 
-GARBAGE += automation.py profileserver.py
+GARBAGE += automation.py profileserver.py genpgocert.py
 
 libs:: $(_PGO_FILES)
 	$(INSTALL) $^ $(_PROFILE_DIR)
diff -r f3ac957eb4af build/pgo/automation.py.in
--- a/build/pgo/automation.py.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/build/pgo/automation.py.in	Sat Sep 06 10:14:36 2008 +0300
@@ -51,19 +51,22 @@ import threading
 """
 Runs the browser from a script, and provides useful utilities
 for setting up the browser environment.
 """
 
+SCRIPT_DIR = os.path.abspath(os.path.realpath(os.path.dirname(sys.argv[0])))
+
 __all__ = [
            "UNIXISH",
            "IS_WIN32",
            "IS_MAC",
            "runApp",
            "Process",
            "initializeProfile",
            "DIST_BIN",
            "DEFAULT_APP",
+           "environment",
           ]
 
 # These are generated in mozilla/build/Makefile.in
 #expand DIST_BIN = "./" + __XPC_BIN_PATH__
 #expand IS_WIN32 = len("__WIN32__") != 0
@@ -72,14 +75,16 @@ __all__ = [
 #expand IS_CYGWIN = __IS_CYGWIN__ == 1
 #else
 IS_CYGWIN = False
 #endif
 #expand IS_CAMINO = __IS_CAMINO__ != 0
+#expand BIN_SUFFIX = __BIN_SUFFIX__
 
 UNIXISH = not IS_WIN32 and not IS_MAC
 
 #expand DEFAULT_APP = "./" + __BROWSER_PATH__
+#expand CERTS_DIR = __CERTS_DIR__
 
 ###########
 # LOGGING #
 ###########
 
@@ -101,35 +106,51 @@ class Process:
   Represents a subprocess of this process.  We don't just directly use the
   subprocess module here because we want compatibility with Python 2.3 on
   non-Windows platforms.  :-(
   """
 
-  def __init__(self, command, args, env):
+  def __init__(self, command, args, env, inputdata = None):
     """
     Creates a process representing the execution of the given command, which
     must be an absolute path, with the given arguments in the given environment.
     The process is then started.
     """
     command = os.path.abspath(command)
     if IS_WIN32:
+      import tempfile
       import subprocess
+      
+      if inputdata:
+        inputfile = tempfile.TemporaryFile()
+        inputfile.write(inputdata)
+        inputfile.seek(0)
+      else:
+        inputfile = None
+        
       cmd = [command]
       cmd.extend(args)
       p = subprocess.Popen(cmd, env = env,
                            stdout = subprocess.PIPE,
-                           stderr = subprocess.STDOUT)
+                           stderr = subprocess.STDOUT,
+                           stdin = inputfile)
       self._out = p.stdout
     else:
       import popen2
       cmd = []
-      for (k, v) in env.iteritems():
-        cmd.append(k + "='" + v + "' ")
+      if env:
+        for (k, v) in env.iteritems():
+          cmd.append(k + "='" + v + "' ")
+          
       cmd.append("'" + command + "'")
       cmd.extend(map(lambda x: "'" + x + "'", args))
       cmd = " ".join(cmd)
       p = popen2.Popen4(cmd)
       self._out = p.fromchild
+
+      if inputdata:
+        p.tochild.write(inputdata)
+        p.tochild.close()
 
     self._process = p
     self.pid = p.pid
     
     self._thread = threading.Thread(target = lambda: self._run())
@@ -163,12 +184,17 @@ class Process:
     return self._status
 
   def kill(self):
     "Kills this process."
     try:
-      if not IS_WIN32: # XXX
+      if not IS_WIN32:
         os.kill(self._process.pid, signal.SIGKILL)
+      else:
+        import subprocess
+        pid = "%i" % self.pid
+        process = subprocess.Popen(["taskkill", "/F", "/PID", pid])
+        process.wait()
     except:
       pass
 
 
 #################
@@ -199,17 +225,17 @@ class Location:
     self.host = host
     self.port = port
     self.options = options
 
 
-def readLocations():
+def readLocations(locationsPath = "server-locations.txt"):
   """
   Reads the locations at which the Mochitest HTTP server is available from
   server-locations.txt.
   """
 
-  locationFile = codecs.open("server-locations.txt", "r", "UTF-8")
+  locationFile = codecs.open(locationsPath, "r", "UTF-8")
 
   # Perhaps more detail than necessary, but it's the easiest way to make sure
   # we get exactly the format we want.  See server-locations.txt for the exact
   # format guaranteed here.
   lineRe = re.compile(r"^(?P<scheme>[a-z][-a-z0-9+.]*)"
@@ -222,11 +248,11 @@ def readLocations():
                       r")"
                       r":"
                       r"(?P<port>\d+)"
                       r"(?:"
                       r"\s+"
-                      r"(?P<options>\w+(?:,\w+)*)"
+                      r"(?P<options>\S+(?:,\S+)*)"
                       r")?$")
   locations = []
   lineno = 0
   seenPrimary = False
   for line in locationFile:
@@ -272,10 +298,11 @@ user_pref("dom.disable_open_during_load"
 user_pref("dom.disable_open_during_load", false);
 user_pref("dom.max_script_run_time", 0); // no slow script dialogs
 user_pref("signed.applets.codebase_principal_support", true);
 user_pref("security.warn_submit_insecure", false);
 user_pref("browser.shell.checkDefaultBrowser", false);
+user_pref("shell.checkDefaultClient", false);
 user_pref("browser.warnOnQuit", false);
 user_pref("accessibility.typeaheadfind.autostart", false);
 user_pref("javascript.options.showInConsole", true);
 user_pref("layout.debug.enable_data_xbl", true);
 user_pref("browser.EULA.override", true);
@@ -317,17 +344,24 @@ function FindProxyForURL(url, host)
                          '(?::(\\\\\\\\d+))?/');
   var matches = regex.exec(url);
   if (!matches)
     return 'DIRECT';
   var isHttp = matches[1] == 'http';
+  var isHttps = matches[1] == 'https';
   if (!matches[3])
-    matches[3] = isHttp ? '80' : '443';
+  {
+    if (isHttp) matches[3] = '80';
+    if (isHttps) matches[3] = '443';
+  }
+    
   var origin = matches[1] + '://' + matches[2] + ':' + matches[3];
   if (origins.indexOf(origin) < 0)
     return 'DIRECT';
   if (isHttp)
-    return 'PROXY localhost:8888';
+    return 'PROXY 127.0.0.1:8888';
+  if (isHttps)
+    return 'PROXY 127.0.0.1:4443';
   return 'DIRECT';
 }""" % { "origins": origins }
   pacURL = "".join(pacURL.splitlines())
 
   part = """
@@ -341,16 +375,85 @@ user_pref("camino.use_system_proxy_setti
   # write the preferences
   prefsFile = open(profileDir + "/" + "user.js", "a")
   prefsFile.write("".join(prefs))
   prefsFile.close()
 
+def fillCertificateDB(profileDir):
+
+  pwfilePath = os.path.join(profileDir, ".crtdbpw")
+  
+  pwfile = open(pwfilePath, "w")
+  pwfile.write("\n")
+  pwfile.close()
+
+  # Create head of the ssltunnel configuration file
+  sslTunnelConfigPath = os.path.join(CERTS_DIR, "ssltunnel.cfg")
+  sslTunnelConfig = open(sslTunnelConfigPath, "w")
+  
+  sslTunnelConfig.write("httpproxy:1\n")
+  sslTunnelConfig.write("certdbdir:%s\n" % CERTS_DIR)
+  sslTunnelConfig.write("forward:127.0.0.1:8888\n")
+  sslTunnelConfig.write("listen:*:4443:pgo server certificate\n")
+
+  # Generate automatic certificate and bond custom certificates
+  locations = readLocations()
+  locations.pop(0)
+  for loc in locations:
+    if loc.scheme == "https" and "nocert" not in loc.options:
+      customCertRE = re.compile("^cert=(?P<nickname>[0-9a-zA-Z_ ]+)")
+      for option in loc.options:
+        match = customCertRE.match(option)
+        if match:
+          customcert = match.group("nickname");
+          sslTunnelConfig.write("listen:%s:%s:4443:%s\n" % (loc.host, loc.port, customcert))
+          break
+
+  sslTunnelConfig.close()
+
+  # Pre-create the certification database for the profile
+  certutil = DIST_BIN + "/certutil" + BIN_SUFFIX
+  status = Process(certutil, ["-N", "-d", profileDir, "-f", pwfilePath], environment()).wait()
+  if status != 0:
+    return status
+
+  # Walk the cert directory and add custom CAs as trusted
+  files = os.listdir(CERTS_DIR)
+  for item in files:
+    root, ext = os.path.splitext(item)
+    if ext == ".ca":
+      Process(certutil, ["-A", "-i", os.path.join(CERTS_DIR, item), "-d", profileDir, "-f", pwfilePath, "-n", root, "-t", "CT,,"], environment())
+
+  os.unlink(pwfilePath)
+  return 0
+
+def environment(env = None):
+  if env == None:
+    env = dict(os.environ)
+
+  if UNIXISH:
+    ldLibraryPath = os.path.join(SCRIPT_DIR, DIST_BIN)
+    if "LD_LIBRARY_PATH" in env:
+      ldLibraryPath = ldLibraryPath + ":" + env["LD_LIBRARY_PATH"]
+    env["LD_LIBRARY_PATH"] = ldLibraryPath
+
+  return env
 
 ###############
 # RUN THE APP #
 ###############
 
 def runApp(testURL, env, app, profileDir, extraArgs):
+  # create certificate database for the profile
+  certificateStatus = fillCertificateDB(profileDir)
+  if certificateStatus != 0:
+    log.info("ERROR FAIL Certificate integration")
+    return certificateStatus
+
+  ssltunnel = DIST_BIN + "/ssltunnel" + BIN_SUFFIX
+  ssltunnelProcess = Process(ssltunnel, [os.path.join(CERTS_DIR, "ssltunnel.cfg")], environment())
+  log.info("SSL tunnel pid: %d", ssltunnelProcess.pid)
+  
   "Run the app, returning the time at which it was started."
   # mark the start
   start = datetime.now()
 
   # now run with the profile we created
@@ -372,12 +475,14 @@ def runApp(testURL, env, app, profileDir
   if IS_CAMINO:
     args.extend(("-url", testURL))
   else:
     args.append((testURL))
   args.extend(extraArgs)
-  proc = Process(cmd, args, env = env)
+  proc = Process(cmd, args, env = environment(env))
   log.info("Application pid: %d", proc.pid)
   status = proc.wait()
   if status != 0:
     log.info("ERROR FAIL Exited with code %d during test run", status)
 
+  ssltunnelProcess.kill()
+  
   return start
diff -r f3ac957eb4af build/pgo/certs/Makefile.in
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/build/pgo/certs/Makefile.in	Sat Sep 06 10:14:36 2008 +0300
@@ -0,0 +1,65 @@
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is Mozilla test code
+#
+# The Initial Developer of the Original Code is
+# Mozilla Foundation
+# Portions created by the Initial Developer are Copyright (C) 2008
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+# Honza Bambas <honzab@firemni.cz>
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+DEPTH		= ../../..
+topsrcdir	= @top_srcdir@
+srcdir		= @srcdir@
+VPATH		= @srcdir@
+
+include $(DEPTH)/config/autoconf.mk
+
+_PROFILE_DIR = $(DEPTH)/_profile/pgo
+_CERTS_DIR = $(_PROFILE_DIR)/certs
+
+# Extension of files must be '.server'
+_SERVER_CERTS = \
+    $(NULL)
+  
+# Extension of files must be '.ca'
+_CERT_AUTHORITIES = \
+    pgoca.ca \
+    $(NULL)
+
+_SERV_FILES = \
+    pgoca.p12 \
+    $(NULL)
+
+include $(topsrcdir)/config/rules.mk
+
+libs:: $(_SERV_FILES) $(_SERVER_CERTS) $(_CERT_AUTHORITIES)
+	$(INSTALL) $^ $(_CERTS_DIR)
diff -r f3ac957eb4af build/pgo/certs/pgoca.ca
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/build/pgo/certs/pgoca.ca	Sat Sep 06 10:14:36 2008 +0300
@@ -0,0 +1,15 @@
+-----BEGIN CERTIFICATE-----
+MIICXTCCAcagAwIBAgIBATANBgkqhkiG9w0BAQUFADBqMSQwIgYDVQQLExtQcm9m
+aWxlIEd1aWRlZCBPcHRpbWl6YXRpb24xGDAWBgNVBAoTD01vemlsbGEgVGVzdGlu
+ZzEoMCYGA1UEAxMfVGVtcG9yYXJ5IENlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0w
+ODA1MjIwMDM4MDVaFw0xODA1MjIwMDM4MDVaMGoxJDAiBgNVBAsTG1Byb2ZpbGUg
+R3VpZGVkIE9wdGltaXphdGlvbjEYMBYGA1UEChMPTW96aWxsYSBUZXN0aW5nMSgw
+JgYDVQQDEx9UZW1wb3JhcnkgQ2VydGlmaWNhdGUgQXV0aG9yaXR5MIGfMA0GCSqG
+SIb3DQEBAQUAA4GNADCBiQKBgQDg6iipAXGZYmgTcHfx8M2hcLqmqDalcj7sZ1A7
+a3LiCBb+1uHKKy9hUxRUe61aJF4NgMAF5oc+HpXN0hpvkiNHxqqD7R6hrkP3gAJ3
+eczEFKsFUI6AqaCL0+xpyhaaZmmarcHxU+PL2h5zq6VssxfBAsO0DkzWzk6E8vM+
+jrku7QIDAQABoxMwETAPBgNVHRMECDAGAQH/AgEAMA0GCSqGSIb3DQEBBQUAA4GB
+ALPbn3Ztg0m8qDt8Vkf5You6HEqIxZe+ffDTrfq/L7ofHk/OXEpL7OWKRHU33pNG
+QS8khBG+sO461C51s6u9giW+eq2PaQv2HGASBpDbvPqc/Hf+zupZsdsXzHv6rt0V
+lu5B6nOpMse1nhA494i1ARSuBNzLv5mas38YWG8Rr6jR
+-----END CERTIFICATE-----
diff -r f3ac957eb4af build/pgo/certs/pgoca.p12
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/build/pgo/certs/pgoca.p12	Sat Sep 06 10:14:36 2008 +0300
@@ -0,0 +1,1 @@
+-----EMPTY CERTIFICATE-----
diff -r f3ac957eb4af build/pgo/genpgocert.py.in
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/build/pgo/genpgocert.py.in	Sat Sep 06 10:14:36 2008 +0300
@@ -0,0 +1,214 @@
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is mozilla.org code.
+#
+# The Initial Developer of the Original Code is
+# Mozilla Foundation.
+# Portions created by the Initial Developer are Copyright (C) 2008
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#   Honza Bambas <honzab@firemni.cz>
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+import automation
+import os
+import re
+import sys
+
+#expand DIST_BIN = "./" + __XPC_BIN_PATH__
+#expand BIN_SUFFIX = __BIN_SUFFIX__
+#expand CERTS_DIR = __CERTS_DIR__
+#expand CERTS_SRC_DIR = __CERTS_SRC_DIR__
+
+dbFiles = [
+  re.compile("^cert[0-9]+\.db$"),
+  re.compile("^key[0-9]+\.db$"),
+  re.compile("^secmod\.db$")
+]
+
+def unlinkDbFiles(path):
+  for root, dirs, files in os.walk(path):
+    for name in files:
+      for dbFile in dbFiles:
+        if dbFile.match(name) and os.path.exists(os.path.join(root, name)):
+          os.unlink(os.path.join(root, name))
+  
+
+def runUtil(util, args, inputdata = None):
+  proc = automation.Process(util, args, automation.environment(), inputdata)
+  return proc.wait()
+
+
+def createRandomFile(randomFile):
+  import random
+  file = open(randomFile, "wb");
+  for count in xrange(0, 2048):
+    file.write(chr(random.randint(0, 255)))
+  file.close()
+
+
+def createCertificateAuthority(dbDir, srcDir):
+  certutil = DIST_BIN + "/certutil" + BIN_SUFFIX
+  pk12util = DIST_BIN + "/pk12util" + BIN_SUFFIX
+
+  tempDbDir = os.path.join(dbDir, ".temp")
+  if not os.path.exists(tempDbDir):
+    os.mkdir(tempDbDir)
+  
+  pwfilePath = os.path.join(tempDbDir, ".crtdbpw")
+  rndfilePath = os.path.join(tempDbDir, ".rndfile")
+  pgoCAModulePathSrc = os.path.join(srcDir, "pgoca.p12")
+  pgoCAPathSrc = os.path.join(srcDir, "pgoca.ca")
+  pgoCAModulePath = os.path.join(srcDir, "pgoca.p12")
+  pgoCAPath = os.path.join(srcDir, "pgoca.ca")
+  
+  pwfile = open(pwfilePath, "w")
+  pwfile.write("\n")
+  pwfile.close()
+
+  unlinkDbFiles(tempDbDir)
+
+  # Create temporary certification database for CA generation
+  status = runUtil(certutil, ["-N", "-d", tempDbDir, "-f", pwfilePath])
+  if status != 0:
+    return status
+
+  createRandomFile(rndfilePath);
+  status = runUtil(certutil, ["-S", "-d", tempDbDir, "-s", "CN=Temporary Certificate Authority, O=Mozilla Testing, OU=Profile Guided Optimization", "-t", "C,,", "-x", "-m", "1", "-v", "120", "-n", "pgo temporary ca", "-2", "-f", pwfilePath, "-z", rndfilePath], "Y\n0\nN\n")
+  if status != 0:
+    return status
+ 
+  status = runUtil(certutil, ["-L", "-d", tempDbDir, "-n", "pgo temporary ca", "-a", "-o", pgoCAPathSrc, "-f", pwfilePath])
+  if status != 0:
+    return status
+ 
+  status = runUtil(pk12util, ["-o", pgoCAModulePathSrc, "-n", "pgo temporary ca", "-d", tempDbDir, "-w", pwfilePath, "-k", pwfilePath])
+  if status != 0:
+    return status
+    
+  unlinkDbFiles(tempDbDir)
+  os.unlink(pwfilePath)
+  os.unlink(rndfilePath)
+  os.rmdir(tempDbDir)
+  return 0
+
+
+def createSSLServerCertificate(dbDir):
+  certutil = DIST_BIN + "/certutil" + BIN_SUFFIX
+  pk12util = DIST_BIN + "/pk12util" + BIN_SUFFIX
+
+  pwfilePath = os.path.join(dbDir, ".crtdbpw")
+  rndfilePath = os.path.join(dbDir, ".rndfile")
+  pgoCAPath = os.path.join(dbDir, "pgoca.p12")
+  
+  pwfile = open(pwfilePath, "w")
+  pwfile.write("\n")
+  pwfile.close()
+
+  unlinkDbFiles(dbDir)
+
+  # Create certification database for ssltunnel
+  status = runUtil(certutil, ["-N", "-d", dbDir, "-f", pwfilePath])
+  if status != 0:
+    return status
+
+  status = runUtil(pk12util, ["-i", pgoCAPath, "-w", pwfilePath, "-d", dbDir, "-k", pwfilePath])
+  if status != 0:
+    return status
+
+  # Generate automatic certificate
+  locations = automation.readLocations(os.path.join(dbDir, "../server-locations.txt"))
+  locations.pop(0)
+  locationsParam = ""
+  firstLocation = ""
+  for loc in locations:
+    if loc.scheme == "https" and "nocert" not in loc.options:
+      customCertOption = False
+      customCertRE = re.compile("^cert=(?:\w+)")
+      for option in loc.options:
+        match = customCertRE.match(option)
+        if match:
+          customCertOption = True
+          break
+
+      if not customCertOption:
+        if len(locationsParam) > 0:
+          locationsParam += ","
+        locationsParam += loc.host
+        
+        if firstLocation == "":
+          firstLocation = loc.host
+      
+  if firstLocation == "":
+    print "Nothing to generate, no automatic secure hosts specified"
+  else:
+    createRandomFile(rndfilePath);
+    status = runUtil(certutil, ["-S", "-s", "CN=%s" % firstLocation, "-t", "Pu,,", "-c", "pgo temporary ca", "-m", "2", "-8", locationsParam, "-v", "12", "-n", "pgo server certificate", "-d", dbDir, "-z", rndfilePath, "-f", pwfilePath])
+    if status != 0:
+      return status
+    
+  # Walk the cert directory and add what necessary
+  files = os.listdir(CERTS_DIR)
+  for item in files:
+    root, ext = os.path.splitext(item)
+    if ext == ".server":
+      runUtil(pk12util, ["-i", os.path.join(CERTS_DIR, item), "-d", dbDir, "-k", pwfilePath, "-w", pwfilePath])
+            
+  os.unlink(pwfilePath)
+  os.unlink(rndfilePath)
+  return 0
+
+
+if len(sys.argv) == 1:
+  print "Specify --gen-server or --gen-ca"
+  sys.exit(1)
+
+if sys.argv[1] == "--gen-server":
+  certificateStatus = createSSLServerCertificate(CERTS_DIR)
+  if certificateStatus != 0:
+    print "ERROR FAIL: SSL Server Certificate generation"
+  
+  sys.exit(certificateStatus)
+  
+if sys.argv[1] == "--gen-ca":
+  certificateStatus = createCertificateAuthority(CERTS_DIR, CERTS_SRC_DIR)
+  if certificateStatus != 0:
+    print "ERROR FAIL: Certificate Authority generation"
+  else:
+    print "\n\n"
+    print "==================================================="
+    print " IMPORTANT:"
+    print " To use this new certificate authority in tests"
+    print " run 'make' at testing/mochitest"
+    print "==================================================="
+
+  sys.exit(certificateStatus)
+
+print "Invalid option specified"
+sys.exit(1)
diff -r f3ac957eb4af build/pgo/server-locations.txt
--- a/build/pgo/server-locations.txt	Thu Sep 04 12:36:46 2008 -0400
+++ b/build/pgo/server-locations.txt	Sat Sep 06 10:14:36 2008 +0300
@@ -50,15 +50,28 @@
 # "https"), followed by "://", followed by a host, followed by ":", followed by
 # a port number.  The colon and port number must be present even if the port
 # number is the default for the protocol.
 #
 # Unrecognized options are ignored.  Recognized options are "primary" and
-# "privileged".  "primary" denotes a location which is the canonical location of
+# "privileged", "nocert", "cert=some_cert_nickname". 
+#
+# "primary" denotes a location which is the canonical location of
 # the server; this location is the one assumed for requests which don't
-# otherwise identify a particular origin (e.g. HTTP/1.0 requests).  "privileged"
-# denotes a location which should have the ability to request elevated
-# privileges; the default is no privileges.
+# otherwise identify a particular origin (e.g. HTTP/1.0 requests).  
+#
+# "privileged" denotes a location which should have the ability to request 
+# elevated privileges; the default is no privileges.
+#
+# "nocert" makes sense only for https:// hosts and means there is not
+# any certificate automatically generated for this host.
+#
+# "cert=nickname" tells the pgo server to use a particular certificate
+# for this host. The certificate is referenced by its nickname that must
+# not contain any spaces. The certificate  key files (PKCS12 modules)
+# for custom certification are loaded from build/pgo/ssltunnel/certs
+# directory. When new certificate is added to this dir pgo/ssltunnel
+# must be builded then.
 #
 
 #
 # This is the primary location from which tests run.
 #
@@ -88,17 +101,29 @@ http://sub1.test1.example.com:80     pri
 http://sub1.test1.example.com:80     privileged
 http://sub1.test2.example.com:80     privileged
 http://sub2.test1.example.com:80     privileged
 http://sub2.test2.example.com:80     privileged
 
+https://example.com:443                privileged
+https://test1.example.com:443          privileged
+https://test2.example.com:443          privileged
+https://sub1.test1.example.com:443     privileged
+https://sub1.test2.example.com:443     privileged
+https://sub2.test1.example.com:443     privileged
+https://sub2.test2.example.com:443     privileged
+https://nocert.example.com:443         privileged,nocert
+
 #
 # These are subdomains of <Ã¤lt.example.org>.
 #
 http://sub1.xn--lt-uia.example.org:8000   privileged
 http://sub2.xn--lt-uia.example.org:80     privileged
 http://xn--exmple-cua.test:80             privileged
 http://sub1.xn--exmple-cua.test:80        privileged
+
+https://xn--hxajbheg2az3al.xn--jxalpdlp:443        privileged
+https://sub1.xn--hxajbheg2az3al.xn--jxalpdlp:443   privileged
 
 #
 # These are subdomains of <ÏÎ±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±.Î´Î¿ÎºÎ¹Î¼Î®>, the Greek IDN for example.test.
 #
 http://xn--hxajbheg2az3al.xn--jxalpdlp:80        privileged
@@ -112,5 +137,10 @@ http://sub1.xn--hxajbheg2az3al.xn--jxalp
 #
 http://sectest1.example.org:80       privileged
 http://sub.sectest2.example.org:80   privileged
 http://sectest2.example.org:80
 http://sub.sectest1.example.org:80
+
+https://sectest1.example.org:443       privileged
+https://sub.sectest2.example.org:443   privileged
+https://sectest2.example.org:443
+https://sub.sectest1.example.org:443
diff -r f3ac957eb4af caps/src/nsJSPrincipals.cpp
--- a/caps/src/nsJSPrincipals.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/caps/src/nsJSPrincipals.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -177,14 +177,17 @@ nsJSPrincipals::Startup()
 
     JSRuntime *rt;
     rtsvc->GetRuntime(&rt);
     NS_ASSERTION(rt != nsnull, "no JSRuntime?!");
 
-    JSPrincipalsTranscoder oldpx;
-    oldpx = ::JS_SetPrincipalsTranscoder(rt, nsTranscodeJSPrincipals);
-    NS_ASSERTION(oldpx == nsnull, "oops, JS_SetPrincipalsTranscoder wars!");
+    JSSecurityCallbacks *callbacks = JS_GetRuntimeSecurityCallbacks(rt);
+    NS_ASSERTION(callbacks, "Need a callbacks struct by now!");
 
+    NS_ASSERTION(!callbacks->principalsTranscoder,
+                 "oops, JS_SetPrincipalsTranscoder wars!");
+
+    callbacks->principalsTranscoder = nsTranscodeJSPrincipals;
     return NS_OK;
 }
 
 nsJSPrincipals::nsJSPrincipals()
 {
diff -r f3ac957eb4af caps/src/nsScriptSecurityManager.cpp
--- a/caps/src/nsScriptSecurityManager.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/caps/src/nsScriptSecurityManager.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -2048,11 +2048,11 @@ nsScriptSecurityManager::GetScriptPrinci
         return nsnull;
     }
     JSPrincipals *jsp = JS_GetScriptPrincipals(cx, script);
     if (!jsp) {
         *rv = NS_ERROR_FAILURE;
-        // Script didn't have principals -- shouldn't happen.
+        NS_ERROR("Script compiled without principals!");
         return nsnull;
     }
     nsJSPrincipals *nsJSPrin = static_cast<nsJSPrincipals *>(jsp);
     nsIPrincipal* result = nsJSPrin->nsIPrincipalPtr;
     if (!result)
@@ -3223,21 +3223,25 @@ nsresult nsScriptSecurityManager::Init()
     NS_ENSURE_SUCCESS(rv, rv);
 
     rv = runtimeService->GetRuntime(&sRuntime);
     NS_ENSURE_SUCCESS(rv, rv);
 
+    static JSSecurityCallbacks securityCallbacks = {
+      CheckObjectAccess,
+      NULL,
+      NULL
+    };
+
 #ifdef DEBUG
-    JSCheckAccessOp oldCallback =
+    JSSecurityCallbacks *oldcallbacks =
 #endif
-        JS_SetCheckObjectAccessCallback(sRuntime, CheckObjectAccess);
+    JS_SetRuntimeSecurityCallbacks(sRuntime, &securityCallbacks);
+    NS_ASSERTION(!oldcallbacks, "Someone else set security callbacks!");
 
     sXPConnect->GetXPCWrappedNativeJSClassInfo(&sXPCWrappedNativeJSClass,
                                                &sXPCWrappedNativeGetObjOps1,
                                                &sXPCWrappedNativeGetObjOps2);
-
-    // For now, assert that no callback was set previously
-    NS_ASSERTION(!oldCallback, "Someone already set a JS CheckObjectAccess callback");
     return NS_OK;
 }
 
 static nsScriptSecurityManager *gScriptSecMan = nsnull;
 
@@ -3254,15 +3258,11 @@ nsScriptSecurityManager::~nsScriptSecuri
 
 void
 nsScriptSecurityManager::Shutdown()
 {
     if (sRuntime) {
-#ifdef DEBUG
-        JSCheckAccessOp oldCallback =
-#endif
-            JS_SetCheckObjectAccessCallback(sRuntime, nsnull);
-        NS_ASSERTION(oldCallback == CheckObjectAccess, "Oops, we just clobbered someone else, oh well.");
+        JS_SetRuntimeSecurityCallbacks(sRuntime, NULL);
         sRuntime = nsnull;
     }
     sEnabledID = JSVAL_VOID;
 
     NS_IF_RELEASE(sIOService);
diff -r f3ac957eb4af config/autoconf.mk.in
--- a/config/autoconf.mk.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/config/autoconf.mk.in	Sat Sep 06 10:14:36 2008 +0300
@@ -67,15 +67,11 @@ DIST		= $(DEPTH)/dist
 DIST		= $(DEPTH)/dist
 LIBXUL_SDK      = @LIBXUL_SDK@
 
 L10NBASEDIR     = @L10NBASEDIR@
 
-ifdef LIBXUL_SDK
-LIBXUL_DIST = $(LIBXUL_SDK)
-else
-LIBXUL_DIST = $(DIST)
-endif
+LIBXUL_DIST	= @LIBXUL_DIST@
 
 XULRUNNER_STUB_NAME = @XULRUNNER_STUB_NAME@
 
 MOZ_CHROME_FILE_FORMAT	= @MOZ_CHROME_FILE_FORMAT@
 
diff -r f3ac957eb4af configure.in
--- a/configure.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/configure.in	Sat Sep 06 10:14:36 2008 +0300
@@ -4029,10 +4029,17 @@ elif test -n "$LIBXUL_SDK_DIR" -a "$LIBX
 
     MOZ_ENABLE_LIBXUL=1
 fi
 AC_SUBST(LIBXUL_SDK)
 
+if test -n "$LIBXUL_SDK"; then
+    LIBXUL_DIST="$LIBXUL_SDK"
+else
+    LIBXUL_DIST="$MOZ_BUILD_ROOT/dist"
+fi
+AC_SUBST(LIBXUL_DIST)
+
 dnl ========================================================
 dnl = If NSPR was not detected in the system, 
 dnl = use the one in the source tree (mozilla/nsprpub)
 dnl ========================================================
 MOZ_ARG_WITH_BOOL(system-nspr,
@@ -4052,26 +4059,26 @@ if test -n "$MOZ_NATIVE_NSPR"; then
                  #endif],
                 [MOZ_NATIVE_NSPR=1],
                 AC_MSG_ERROR([system NSPR does not support PR_STATIC_ASSERT]))
     CFLAGS=$_SAVE_CFLAGS
 else
-    NSPR_CFLAGS='`$(DEPTH)/nsprpub/config/nspr-config --prefix=$(LIBXUL_DIST) --includedir=$(LIBXUL_DIST)/include/nspr --cflags`'
+    NSPR_CFLAGS='`$(DEPTH)/nsprpub/config/nspr-config --prefix='${LIBXUL_DIST}' --includedir='${LIBXUL_DIST}'/include/nspr --cflags`'
     # explicitly set libs for Visual Age C++ for OS/2
     if test "$OS_ARCH" = "OS2" -a "$VACPP" = "yes"; then
-        NSPR_LIBS='$(LIBXUL_DIST)/lib/nspr'$NSPR_VERSION'.lib $(LIBXUL_DIST)/lib/plc'$NSPR_VERSION'.lib $(LIBXUL_DIST)/lib/plds'$NSPR_VERSION'.lib '$_PTHREAD_LDFLAGS''
+        NSPR_LIBS="${LIBXUL_DIST}/lib/nspr${NSPR_VERSION}.lib ${LIBXUL_DIST}/lib/plc${NSPR_VERSION}.lib ${LIBXUL_DIST}/lib/plds${NSPR_VERSION}.lib ${_PTHREAD_LDFLAGS}"
     elif test "$OS_ARCH" = "WINCE"; then
-        NSPR_CFLAGS='-I$(LIBXUL_DIST)/include/nspr'
-        NSPR_LIBS='$(LIBXUL_DIST)/lib/nspr'$NSPR_VERSION'.lib $(LIBXUL_DIST)/lib/plc'$NSPR_VERSION'.lib $(LIBXUL_DIST)/lib/plds'$NSPR_VERSION'.lib '
+        NSPR_CFLAGS="-I${LIBXUL_DIST}/include/nspr"
+        NSPR_LIBS="${LIBXUL_DIST}/lib/nspr${NSPR_VERSION}.lib ${LIBXUL_DIST}/lib/plc${NSPR_VERSION}.lib ${LIBXUL_DIST}/lib/plds${NSPR_VERSION}.lib "
     elif test "$OS_ARCH" = "WINNT"; then
-        NSPR_CFLAGS='-I$(LIBXUL_DIST)/include/nspr'
+        NSPR_CFLAGS="-I${LIBXUL_DIST}/include/nspr"
         if test -n "$GNU_CC"; then
-            NSPR_LIBS="-L\$(LIBXUL_DIST)/lib -lnspr$NSPR_VERSION -lplc$NSPR_VERSION -lplds$NSPR_VERSION"
-        else
-            NSPR_LIBS='$(LIBXUL_DIST)/lib/nspr'$NSPR_VERSION'.lib $(LIBXUL_DIST)/lib/plc'$NSPR_VERSION'.lib $(LIBXUL_DIST)/lib/plds'$NSPR_VERSION'.lib '
-        fi
-    else
-        NSPR_LIBS='`$(DEPTH)/nsprpub/config/nspr-config --prefix=$(LIBXUL_DIST) --libdir=$(LIBXUL_DIST)/lib --libs`'
+            NSPR_LIBS="-L${LIBXUL_DIST}/lib -lnspr${NSPR_VERSION} -lplc${NSPR_VERSION} -lplds${NSPR_VERSION}"
+        else
+            NSPR_LIBS="${LIBXUL_DIST}/lib/nspr${NSPR_VERSION}.lib ${LIBXUL_DIST}/lib/plc${NSPR_VERSION}.lib ${LIBXUL_DIST}/lib/plds${NSPR_VERSION}.lib "
+        fi
+    else
+        NSPR_LIBS='`$(DEPTH)/nsprpub/config/nspr-config --prefix='${LIBXUL_DIST}' --libdir='${LIBXUL_DIST}'/lib --libs`'
     fi
 fi
 
 dnl ========================================================
 dnl = If NSS was not detected in the system, 
@@ -8354,16 +8361,16 @@ fi
 
 if test -z "$MOZ_NATIVE_NSPR"; then
     # Hack to deal with the fact that we use NSPR_CFLAGS everywhere
     AC_MSG_WARN([Recreating autoconf.mk with updated nspr-config output])
     if test ! "$VACPP" && test "$OS_ARCH" != "WINNT" && test "$OS_ARCH" != "WINCE"; then
-       _libs=`./nsprpub/config/nspr-config --prefix=$\(LIBXUL_DIST\) --exec-prefix=$\(DIST\) --libdir=$\(LIBXUL_DIST\)/lib --libs`
-       $PERL -pi.bak -e "s '^NSPR_LIBS\\s*=.*'NSPR_LIBS = $_libs'" config/autoconf.mk
+       NSPR_LIBS=`./nsprpub/config/nspr-config --prefix=$LIBXUL_DIST --exec-prefix=$MOZ_BUILD_ROOT/dist --libdir=$LIBXUL_DIST/lib --libs`
+       $PERL -pi.bak -e "s '^NSPR_LIBS\\s*=.*'NSPR_LIBS = $NSPR_LIBS'" config/autoconf.mk
     fi
     if test "$OS_ARCH" != "WINNT" && test "$OS_ARCH" != "WINCE" ; then
-       _cflags=`./nsprpub/config/nspr-config --prefix=$\(LIBXUL_DIST\) --exec-prefix=$\(DIST\) --includedir=$\(LIBXUL_DIST\)/include/nspr --cflags`
-       $PERL -pi.bak -e "s '^NSPR_CFLAGS\\s*=.*'NSPR_CFLAGS = $_cflags'" config/autoconf.mk
+       NSPR_CFLAGS=`./nsprpub/config/nspr-config --prefix=$LIBXUL_DIST --exec-prefix=$MOZ_BUILD_ROOT/dist --includedir=$LIBXUL_DIST/include/nspr --cflags`
+       $PERL -pi.bak -e "s '^NSPR_CFLAGS\\s*=.*'NSPR_CFLAGS = $NSPR_CFLAGS'" config/autoconf.mk
     fi
     rm -f config/autoconf.mk.bak
 fi
 
 fi # COMPILE_ENVIRONMENT
diff -r f3ac957eb4af content/base/public/nsContentUtils.h
--- a/content/base/public/nsContentUtils.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/content/base/public/nsContentUtils.h	Sat Sep 06 10:14:36 2008 +0300
@@ -1321,10 +1321,13 @@ public:
   static nsresult ProcessViewportInfo(nsIDocument *aDocument,
                                       const nsAString &viewportInfo);
 
   static nsresult GetContextForEventHandlers(nsINode* aNode,
                                              nsIScriptContext** aContext);
+
+  static JSContext *GetCurrentJSContext();
+
 private:
 
   static PRBool InitializeEventTable();
 
   static nsresult doReparentContentWrapper(nsIContent *aChild,
@@ -1503,10 +1506,82 @@ public:
 
 private:
   PRUint32 mNestingLevel;
 };
 
+/**
+ * Class used to detect unexpected mutations. To use the class create an
+ * nsMutationGuard on the stack before unexpected mutations could occur.
+ * You can then at any time call Mutated to check if any unexpected mutations
+ * have occured.
+ *
+ * When a guard is instantiated sMutationCount is set to 300. It is then
+ * decremented by every mutation (capped at 0). This means that we can only
+ * detect 300 mutations during the lifetime of a single guard, however that
+ * should be more then we ever care about as we usually only care if more then
+ * one mutation has occured.
+ *
+ * When the guard goes out of scope it will adjust sMutationCount so that over
+ * the lifetime of the guard the guard itself has not affected sMutationCount,
+ * while mutations that happened while the guard was alive still will. This
+ * allows a guard to be instantiated even if there is another guard higher up
+ * on the callstack watching for mutations.
+ *
+ * The only thing that has to be avoided is for an outer guard to be used
+ * while an inner guard is alive. This can be avoided by only ever
+ * instantiating a single guard per scope and only using the guard in the
+ * current scope.
+ */
+class nsMutationGuard {
+public:
+  nsMutationGuard()
+  {
+    mDelta = eMaxMutations - sMutationCount;
+    sMutationCount = eMaxMutations;
+  }
+  ~nsMutationGuard()
+  {
+    sMutationCount =
+      mDelta > sMutationCount ? 0 : sMutationCount - mDelta;
+  }
+
+  /**
+   * Returns true if any unexpected mutations have occured. You can pass in
+   * an 8-bit ignore count to ignore a number of expected mutations.
+   */
+  PRBool Mutated(PRUint8 aIgnoreCount)
+  {
+    return sMutationCount < static_cast<PRUint32>(eMaxMutations - aIgnoreCount);
+  }
+
+  // This function should be called whenever a mutation that we want to keep
+  // track of happen. For now this is only done when children are added or
+  // removed, but we might do it for attribute changes too in the future.
+  static void DidMutate()
+  {
+    if (sMutationCount) {
+      --sMutationCount;
+    }
+  }
+
+private:
+  // mDelta is the amount sMutationCount was adjusted when the guard was
+  // initialized. It is needed so that we can undo that adjustment once
+  // the guard dies.
+  PRUint32 mDelta;
+
+  // The value 300 is not important, as long as it is bigger then anything
+  // ever passed to Mutated().
+  enum { eMaxMutations = 300 };
+
+  
+  // sMutationCount is a global mutation counter which is decreased by one at
+  // every mutation. It is capped at 0 to avoid wrapping.
+  // It's value is always between 0 and 300, inclusive.
+  static PRUint32 sMutationCount;
+};
+
 #define NS_AUTO_GCROOT_PASTE2(tok,line) tok##line
 #define NS_AUTO_GCROOT_PASTE(tok,line) \
   NS_AUTO_GCROOT_PASTE2(tok,line)
 #define NS_AUTO_GCROOT(ptr, result) \ \
   nsAutoGCRoot NS_AUTO_GCROOT_PASTE(_autoGCRoot_, __LINE__) \
diff -r f3ac957eb4af content/base/public/nsIDOMParser.idl
--- a/content/base/public/nsIDOMParser.idl	Thu Sep 04 12:36:46 2008 -0400
+++ b/content/base/public/nsIDOMParser.idl	Sat Sep 06 10:14:36 2008 +0300
@@ -126,18 +126,19 @@ interface nsIDOMParser : nsISupports
 
 /**
  * The nsIDOMParserJS interface provides a scriptable way of calling init().
  * Do NOT use this interface from languages other than JavaScript.
  */
-[scriptable, uuid(dca92fe9-ae7a-44b7-80aa-d151216698ac)]
+[scriptable, uuid(ba6bcd6c-63d8-49b3-bc8a-1e5e895645bc)]
 interface nsIDOMParserJS : nsISupports
 {
   /**
-   * Just like nsIDOMParser.init, but callable from JS.  It'll pick up the args
-   * from XPConnect.
+   * Just like nsIDOMParser.init, but callable from JS.
    */
-  void init();
+  void init(in nsIPrincipal principal,
+            in nsIURI documentURI,
+            in nsIURI baseURI);
 };
 
 %{ C++
 #define NS_DOMPARSER_CID                            \
  { /* 3a8a3a50-512c-11d4-9a54-000064657374 */       \
diff -r f3ac957eb4af content/base/src/nsContentUtils.cpp
--- a/content/base/src/nsContentUtils.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/content/base/src/nsContentUtils.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -210,10 +210,12 @@ PRUint32 nsContentUtils::sRunnersCountAt
 PRUint32 nsContentUtils::sRunnersCountAtFirstBlocker = 0;
 
 nsIJSRuntimeService *nsAutoGCRoot::sJSRuntimeService;
 JSRuntime *nsAutoGCRoot::sJSScriptRuntime;
 
+PRUint32 nsMutationGuard::sMutationCount = 0;
+
 PRBool nsContentUtils::sInitialized = PR_FALSE;
 
 static PLDHashTable sEventListenerManagersHash;
 
 class EventListenerManagerMapEntry : public PLDHashEntryHdr
@@ -4313,10 +4315,21 @@ nsContentUtils::GetContextForEventHandle
 
   return NS_OK;
 }
 
 /* static */
+JSContext *
+nsContentUtils::GetCurrentJSContext()
+{
+  JSContext *cx = nsnull;
+
+  sThreadJSContextStack->Peek(&cx);
+
+  return cx;
+}
+
+/* static */
 void
 nsAutoGCRoot::Shutdown()
 {
   NS_IF_RELEASE(sJSRuntimeService);
 }
diff -r f3ac957eb4af content/base/src/nsDOMParser.cpp
--- a/content/base/src/nsDOMParser.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/content/base/src/nsDOMParser.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -504,41 +504,16 @@ nsDOMParser::Initialize(nsISupports* aOw
   nsCOMPtr<nsIScriptGlobalObject> scriptglobal = do_QueryInterface(aOwner);
   return Init(prin, documentURI, baseURI, scriptglobal);
 }
 
 NS_IMETHODIMP
-nsDOMParser::Init()
+nsDOMParser::Init(nsIPrincipal *principal, nsIURI *documentURI, nsIURI *baseURI)
 {
   AttemptedInitMarker marker(&mAttemptedInit);
 
-  nsAXPCNativeCallContext *ncc = nsnull;
-
-  nsresult rv = nsContentUtils::XPConnect()->
-    GetCurrentNativeCallContext(&ncc);
-  NS_ENSURE_SUCCESS(rv, rv);
-  NS_ENSURE_TRUE(ncc, NS_ERROR_UNEXPECTED);
-
-  JSContext *cx = nsnull;
-  rv = ncc->GetJSContext(&cx);
-  NS_ENSURE_SUCCESS(rv, rv);
+  JSContext *cx = nsContentUtils::GetCurrentJSContext();
   NS_ENSURE_TRUE(cx, NS_ERROR_UNEXPECTED);
 
-  PRUint32 argc;
-  jsval *argv = nsnull;
-  ncc->GetArgc(&argc);
-  ncc->GetArgvPtr(&argv);
-
-  if (argc != 3) {
-    return NS_ERROR_INVALID_ARG;
-  }
-
-  nsCOMPtr<nsIPrincipal> prin;
-  nsCOMPtr<nsIURI> documentURI;
-  nsCOMPtr<nsIURI> baseURI;
-  rv = GetInitArgs(cx, argc, argv, getter_AddRefs(prin),
-                   getter_AddRefs(documentURI), getter_AddRefs(baseURI));
-  NS_ENSURE_SUCCESS(rv, rv);
-
   nsIScriptContext* scriptContext = GetScriptContextFromJSContext(cx);
-  return Init(prin, documentURI, baseURI,
+  return Init(principal, documentURI, baseURI,
               scriptContext ? scriptContext->GetGlobalObject() : nsnull);
 }
diff -r f3ac957eb4af content/base/src/nsGenericDOMDataNode.cpp
--- a/content/base/src/nsGenericDOMDataNode.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/content/base/src/nsGenericDOMDataNode.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -609,11 +609,11 @@ nsGenericDOMDataNode::BindToTree(nsIDocu
     NS_ENSURE_TRUE(slots, NS_ERROR_OUT_OF_MEMORY);
 
     NS_ASSERTION(IsRootOfNativeAnonymousSubtree() ||
                  !HasFlag(NODE_IS_IN_ANONYMOUS_SUBTREE) ||
                  aBindingParent->IsInNativeAnonymousSubtree(),
-                 "Trying to re-bind content from native anonymous subtree to"
+                 "Trying to re-bind content from native anonymous subtree to "
                  "non-native anonymous parent!");
     slots->mBindingParent = aBindingParent; // Weak, so no addref happens.
     if (IsRootOfNativeAnonymousSubtree() ||
         aParent->IsInNativeAnonymousSubtree()) {
       SetFlags(NODE_IS_IN_ANONYMOUS_SUBTREE);
diff -r f3ac957eb4af content/base/src/nsGenericElement.cpp
--- a/content/base/src/nsGenericElement.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/content/base/src/nsGenericElement.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -147,10 +147,12 @@
 #include "nsCycleCollectionParticipant.h"
 #include "nsCCUncollectableMarker.h"
 
 #include "mozAutoDocUpdate.h"
 
+#include "nsICSSParser.h"
+
 #ifdef MOZ_SVG
 PRBool NS_SVG_HaveFeature(const nsAString &aFeature);
 #endif /* MOZ_SVG */
 
 #ifdef DEBUG_waterson
@@ -787,14 +789,16 @@ NS_IMETHODIMP
 NS_IMETHODIMP
 nsNSElementTearoff::GetFirstElementChild(nsIDOMElement** aResult)
 {
   *aResult = nsnull;
 
+#ifdef MOZ_XUL
   nsXULElement* xul = nsXULElement::FromContent(mContent);
   if (xul) {
     xul->EnsureContentsGenerated();
   }
+#endif
 
   nsAttrAndChildArray& children = mContent->mAttrsAndChildren;
   PRUint32 i, count = children.ChildCount();
   for (i = 0; i < count; ++i) {
     nsIContent* child = children.ChildAt(i);
@@ -809,14 +813,16 @@ NS_IMETHODIMP
 NS_IMETHODIMP
 nsNSElementTearoff::GetLastElementChild(nsIDOMElement** aResult)
 {
   *aResult = nsnull;
 
+#ifdef MOZ_XUL
   nsXULElement* xul = nsXULElement::FromContent(mContent);
   if (xul) {
     xul->EnsureContentsGenerated();
   }
+#endif
 
   nsAttrAndChildArray& children = mContent->mAttrsAndChildren;
   PRUint32 i = children.ChildCount();
   while (i > 0) {
     nsIContent* child = children.ChildAt(--i);
@@ -836,14 +842,16 @@ nsNSElementTearoff::GetPreviousElementSi
   nsIContent* parent = mContent->GetParent();
   if (!parent) {
     return NS_OK;
   }
 
+#ifdef MOZ_XUL
   nsXULElement* xul = nsXULElement::FromContent(parent);
   if (xul) {
     xul->EnsureContentsGenerated();
   }
+#endif
 
   NS_ASSERTION(parent->IsNodeOfType(nsINode::eELEMENT) ||
                parent->IsNodeOfType(nsINode::eDOCUMENT_FRAGMENT),
                "Parent content must be an element or a doc fragment");
 
@@ -873,14 +881,16 @@ nsNSElementTearoff::GetNextElementSiblin
   nsIContent* parent = mContent->GetParent();
   if (!parent) {
     return NS_OK;
   }
 
+#ifdef MOZ_XUL
   nsXULElement* xul = nsXULElement::FromContent(parent);
   if (xul) {
     xul->EnsureContentsGenerated();
   }
+#endif
 
   NS_ASSERTION(parent->IsNodeOfType(nsINode::eELEMENT) ||
                parent->IsNodeOfType(nsINode::eDOCUMENT_FRAGMENT),
                "Parent content must be an element or a doc fragment");
 
@@ -988,12 +998,11 @@ nsGenericElement::GetOffsetRect(nsRect& 
 
   // Get the union of all rectangles in this and continuation frames.
   // It doesn't really matter what we use as aRelativeTo here, since
   // we only care about the size. Using 'parent' might make things
   // a bit faster by speeding up the internal GetOffsetTo operations.
-  nsIFrame* parent = frame->GetParent() ? frame->GetParent() : frame;
-  nsRect rcFrame = nsLayoutUtils::GetAllInFlowRectsUnion(frame, parent);
+  nsRect rcFrame = nsLayoutUtils::GetAllInFlowRectsUnion(frame, nsnull);
   aRect.width = nsPresContext::AppUnitsToIntCSSPixels(rcFrame.width);
   aRect.height = nsPresContext::AppUnitsToIntCSSPixels(rcFrame.height);
 }
 
 void
@@ -1690,13 +1699,10 @@ nsStaticContentList::Item(PRUint32 aInde
 
   return CallQueryInterface(c, aReturn);
 }
 
 //----------------------------------------------------------------------
-
-PRUint32 nsMutationGuard::sMutationCount = 0;
-
 nsGenericElement::nsDOMSlots::nsDOMSlots(PtrBits aFlags)
   : nsINode::nsSlots(aFlags),
     mBindingParent(nsnull)
 {
 }
@@ -5151,10 +5157,14 @@ TryMatchingElementsInSubtree(nsINode* aR
   RuleProcessorData* prevSibling = nsnull;
   RuleProcessorData* data = reinterpret_cast<RuleProcessorData*>(databuf);
   nsIContent * const * kidSlot = aRoot->GetChildArray();
   nsIContent * const * end = kidSlot + count;
 
+#ifdef DEBUG
+  nsMutationGuard debugMutationGuard;
+#endif
+  
   PRBool continueIteration = PR_TRUE;
   for (; kidSlot != end; ++kidSlot) {
     nsIContent* kid = *kidSlot;
     if (!kid->IsNodeOfType(nsINode::eELEMENT)) {
       continue;
@@ -5212,10 +5222,15 @@ TryMatchingElementsInSubtree(nsINode* aR
       prevSibling->mParentData = nsnull;
     }
     /* Make sure to clean this up */
     prevSibling->~RuleProcessorData();
   }
+
+#ifdef DEBUG
+  NS_ASSERTION(!debugMutationGuard.Mutated(0), "Unexpected mutations happened");
+#endif
+
   return continueIteration;
 }
 
 PR_STATIC_CALLBACK(PRBool)
 FindFirstMatchingElement(nsIContent* aMatchingElement,
diff -r f3ac957eb4af content/base/src/nsGenericElement.h
--- a/content/base/src/nsGenericElement.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/content/base/src/nsGenericElement.h	Sat Sep 06 10:14:36 2008 +0300
@@ -313,82 +313,10 @@ public:
 
 private:
   ~nsStaticContentList() {}
   
   nsCOMArray<nsIContent> mList;
-};
-
-/**
- * Class used to detect unexpected mutations. To use the class create an
- * nsMutationGuard on the stack before unexpected mutations could occur.
- * You can then at any time call Mutated to check if any unexpected mutations
- * have occured.
- *
- * When a guard is instantiated sMutationCount is set to 300. It is then
- * decremented by every mutation (capped at 0). This means that we can only
- * detect 300 mutations during the lifetime of a single guard, however that
- * should be more then we ever care about as we usually only care if more then
- * one mutation has occured.
- *
- * When the guard goes out of scope it will adjust sMutationCount so that over
- * the lifetime of the guard the guard itself has not affected sMutationCount,
- * while mutations that happened while the guard was alive still will. This
- * allows a guard to be instantiated even if there is another guard higher up
- * on the callstack watching for mutations.
- *
- * The only thing that has to be avoided is for an outer guard to be used
- * while an inner guard is alive. This can be avoided by only ever
- * instantiating a single guard per scope and only using the guard in the
- * current scope.
- */
-class nsMutationGuard {
-public:
-  nsMutationGuard()
-  {
-    mDelta = eMaxMutations - sMutationCount;
-    sMutationCount = eMaxMutations;
-  }
-  ~nsMutationGuard()
-  {
-    sMutationCount =
-      mDelta > sMutationCount ? 0 : sMutationCount - mDelta;
-  }
-
-  /**
-   * Returns true if any unexpected mutations have occured. You can pass in
-   * an 8-bit ignore count to ignore a number of expected mutations.
-   */
-  PRBool Mutated(PRUint8 aIgnoreCount)
-  {
-    return sMutationCount < static_cast<PRUint32>(eMaxMutations - aIgnoreCount);
-  }
-
-  // This function should be called whenever a mutation that we want to keep
-  // track of happen. For now this is only done when children are added or
-  // removed, but we might do it for attribute changes too in the future.
-  static void DidMutate()
-  {
-    if (sMutationCount) {
-      --sMutationCount;
-    }
-  }
-
-private:
-  // mDelta is the amount sMutationCount was adjusted when the guard was
-  // initialized. It is needed so that we can undo that adjustment once
-  // the guard dies.
-  PRUint32 mDelta;
-
-  // The value 300 is not important, as long as it is bigger then anything
-  // ever passed to Mutated().
-  enum { eMaxMutations = 300 };
-
-  
-  // sMutationCount is a global mutation counter which is decreased by one at
-  // every mutation. It is capped at 0 to avoid wrapping.
-  // It's value is always between 0 and 300, inclusive.
-  static PRUint32 sMutationCount;
 };
 
 // Forward declare to allow being a friend
 class nsNSElementTearoff;
 
diff -r f3ac957eb4af content/base/src/nsNodeUtils.cpp
--- a/content/base/src/nsNodeUtils.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/content/base/src/nsNodeUtils.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -51,10 +51,11 @@
 #include "nsCOMArray.h"
 #include "nsPIDOMWindow.h"
 #ifdef MOZ_XUL
 #include "nsXULElement.h"
 #endif
+#include "nsBindingManager.h"
 
 // This macro expects the ownerDocument of content_ to be in scope as
 // |nsIDocument* doc|
 #define IMPL_MUTATION_NOTIFICATION(func_, content_, params_)      \
   PR_BEGIN_MACRO                                                  \
diff -r f3ac957eb4af content/html/content/src/nsHTMLSelectElement.h
--- a/content/html/content/src/nsHTMLSelectElement.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/content/html/content/src/nsHTMLSelectElement.h	Sat Sep 06 10:14:36 2008 +0300
@@ -51,10 +51,11 @@
 #include "nsIDOMHTMLOptionElement.h"
 #include "nsIDOMHTMLCollection.h"
 #include "nsIDOMHTMLOptionsCollection.h"
 #include "nsIDOMNSHTMLOptionCollectn.h"
 #include "nsISelectControlFrame.h"
+#include "nsContentUtils.h"
 
 // PresState
 #include "nsXPCOM.h"
 #include "nsPresState.h"
 #include "nsIComponentManager.h"
diff -r f3ac957eb4af content/html/content/src/nsHTMLSharedElement.cpp
--- a/content/html/content/src/nsHTMLSharedElement.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/content/html/content/src/nsHTMLSharedElement.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -45,11 +45,10 @@
 #include "nsGkAtoms.h"
 #include "nsStyleConsts.h"
 #include "nsPresContext.h"
 #include "nsRuleData.h"
 #include "nsMappedAttributes.h"
-#include "nsStyleContext.h"
 
 // XXX nav4 has type= start= (same as OL/UL)
 extern nsAttrValue::EnumTable kListTypeTable[];
 
 class nsHTMLSharedElement : public nsGenericHTMLElement,
@@ -237,81 +236,88 @@ SpacerMapAttributesIntoRule(const nsMapp
                             nsRuleData* aData)
 {
   nsGenericHTMLElement::MapImageMarginAttributeInto(aAttributes, aData);
   nsGenericHTMLElement::MapImageSizeAttributesInto(aAttributes, aData);
 
-  if (aData->mSIDs & NS_STYLE_INHERIT_BIT(Position)) {
-    const nsStyleDisplay* display = aData->mStyleContext->GetStyleDisplay();
+  if (aData->mSIDs & (NS_STYLE_INHERIT_BIT(Position) |
+                      NS_STYLE_INHERIT_BIT(Display))) {
+    PRBool typeIsBlock = PR_FALSE;
+    const nsAttrValue* value = aAttributes->GetAttr(nsGkAtoms::type);
+    if (value && value->Type() == nsAttrValue::eString) {
+      const nsString& tmp(value->GetStringValue());
+      if (tmp.LowerCaseEqualsLiteral("line") ||
+          tmp.LowerCaseEqualsLiteral("vert") ||
+          tmp.LowerCaseEqualsLiteral("vertical") ||
+          tmp.LowerCaseEqualsLiteral("block")) {
+        // This is not strictly 100% compatible: if the spacer is given
+        // a width of zero then it is basically ignored.
+        typeIsBlock = PR_TRUE;
+      }
+    }
 
-    PRBool typeIsBlock = (display->mDisplay == NS_STYLE_DISPLAY_BLOCK);
+    if (aData->mSIDs & NS_STYLE_INHERIT_BIT(Position)) {
+      if (typeIsBlock) {
+        // width: value
+        if (aData->mPositionData->mWidth.GetUnit() == eCSSUnit_Null) {
+          const nsAttrValue* value = aAttributes->GetAttr(nsGkAtoms::width);
+          if (value && value->Type() == nsAttrValue::eInteger) {
+            aData->mPositionData->
+              mWidth.SetFloatValue((float)value->GetIntegerValue(),
+                                   eCSSUnit_Pixel);
+          } else if (value && value->Type() == nsAttrValue::ePercent) {
+            aData->mPositionData->
+              mWidth.SetPercentValue(value->GetPercentValue());
+          }
+        }
 
-    if (typeIsBlock) {
-      // width: value
-      if (aData->mPositionData->mWidth.GetUnit() == eCSSUnit_Null) {
-        const nsAttrValue* value = aAttributes->GetAttr(nsGkAtoms::width);
-        if (value && value->Type() == nsAttrValue::eInteger) {
-          aData->mPositionData->
-            mWidth.SetFloatValue((float)value->GetIntegerValue(),
-                                 eCSSUnit_Pixel);
-        } else if (value && value->Type() == nsAttrValue::ePercent) {
-          aData->mPositionData->
-            mWidth.SetPercentValue(value->GetPercentValue());
+        // height: value
+        if (aData->mPositionData->mHeight.GetUnit() == eCSSUnit_Null) {
+          const nsAttrValue* value = aAttributes->GetAttr(nsGkAtoms::height);
+          if (value && value->Type() == nsAttrValue::eInteger) {
+            aData->mPositionData->
+              mHeight.SetFloatValue((float)value->GetIntegerValue(),
+                                    eCSSUnit_Pixel);
+          } else if (value && value->Type() == nsAttrValue::ePercent) {
+            aData->mPositionData->
+              mHeight.SetPercentValue(value->GetPercentValue());
+          }
+        }
+      } else {
+        // size: value
+        if (aData->mPositionData->mWidth.GetUnit() == eCSSUnit_Null) {
+          const nsAttrValue* value = aAttributes->GetAttr(nsGkAtoms::size);
+          if (value && value->Type() == nsAttrValue::eInteger)
+            aData->mPositionData->
+              mWidth.SetFloatValue((float)value->GetIntegerValue(),
+                                   eCSSUnit_Pixel);
+        }
+      }
+    }
+
+    if (aData->mSIDs & NS_STYLE_INHERIT_BIT(Display)) {
+      const nsAttrValue* value = aAttributes->GetAttr(nsGkAtoms::align);
+      if (value && value->Type() == nsAttrValue::eEnum) {
+        PRInt32 align = value->GetEnumValue();
+        if (aData->mDisplayData->mFloat.GetUnit() == eCSSUnit_Null) {
+          if (align == NS_STYLE_TEXT_ALIGN_LEFT)
+            aData->mDisplayData->mFloat.SetIntValue(NS_STYLE_FLOAT_LEFT,
+                                                    eCSSUnit_Enumerated);
+          else if (align == NS_STYLE_TEXT_ALIGN_RIGHT)
+            aData->mDisplayData->mFloat.SetIntValue(NS_STYLE_FLOAT_RIGHT,
+                                                    eCSSUnit_Enumerated);
         }
       }
 
-      // height: value
-      if (aData->mPositionData->mHeight.GetUnit() == eCSSUnit_Null) {
-        const nsAttrValue* value = aAttributes->GetAttr(nsGkAtoms::height);
-        if (value && value->Type() == nsAttrValue::eInteger) {
-          aData->mPositionData->
-            mHeight.SetFloatValue((float)value->GetIntegerValue(),
-                                  eCSSUnit_Pixel);
-        } else if (value && value->Type() == nsAttrValue::ePercent) {
-          aData->mPositionData->
-            mHeight.SetPercentValue(value->GetPercentValue());
-        }
-      }
-    } else {
-      // size: value
-      if (aData->mPositionData->mWidth.GetUnit() == eCSSUnit_Null) {
-        const nsAttrValue* value = aAttributes->GetAttr(nsGkAtoms::size);
-        if (value && value->Type() == nsAttrValue::eInteger)
-          aData->mPositionData->
-            mWidth.SetFloatValue((float)value->GetIntegerValue(),
-                                 eCSSUnit_Pixel);
-      }
-    }
-  }
-  if (aData->mSIDs & NS_STYLE_INHERIT_BIT(Display)) {
-    const nsAttrValue* value = aAttributes->GetAttr(nsGkAtoms::align);
-    if (value && value->Type() == nsAttrValue::eEnum) {
-      PRInt32 align = value->GetEnumValue();
-      if (aData->mDisplayData->mFloat.GetUnit() == eCSSUnit_Null) {
-        if (align == NS_STYLE_TEXT_ALIGN_LEFT)
-          aData->mDisplayData->mFloat.SetIntValue(NS_STYLE_FLOAT_LEFT,
-                                                  eCSSUnit_Enumerated);
-        else if (align == NS_STYLE_TEXT_ALIGN_RIGHT)
-          aData->mDisplayData->mFloat.SetIntValue(NS_STYLE_FLOAT_RIGHT,
-                                                  eCSSUnit_Enumerated);
-      }
-    }
-
-    if (aData->mDisplayData->mDisplay.GetUnit() == eCSSUnit_Null) {
-      const nsAttrValue* value = aAttributes->GetAttr(nsGkAtoms::type);
-      if (value && value->Type() == nsAttrValue::eString) {
-        nsAutoString tmp(value->GetStringValue());
-        if (tmp.LowerCaseEqualsLiteral("line") ||
-            tmp.LowerCaseEqualsLiteral("vert") ||
-            tmp.LowerCaseEqualsLiteral("vertical") ||
-            tmp.LowerCaseEqualsLiteral("block")) {
-          // This is not strictly 100% compatible: if the spacer is given
-          // a width of zero then it is basically ignored.
+      if (typeIsBlock) {
+        if (aData->mDisplayData->mDisplay.GetUnit() == eCSSUnit_Null) {
           aData->mDisplayData->mDisplay.SetIntValue(NS_STYLE_DISPLAY_BLOCK,
                                                     eCSSUnit_Enumerated);
         }
       }
     }
+    // Any new structs that don't need typeIsBlock should go outside
+    // the code that calculates it.
   }
 
   nsGenericHTMLElement::MapCommonAttributesInto(aAttributes, aData);
 }
 
diff -r f3ac957eb4af content/xml/content/crashtest/453278-frame.xml
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/content/xml/content/crashtest/453278-frame.xml	Sat Sep 06 10:14:36 2008 +0300
@@ -0,0 +1,3 @@
+<xml xmlns:xlink="http://www.w3.org/1999/xlink">
+<xml xlink:href="#"  xlink:actuate="onLoad" xlink:type="simple"/>
+</xml>
diff -r f3ac957eb4af content/xml/content/crashtest/453278.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/content/xml/content/crashtest/453278.html	Sat Sep 06 10:14:36 2008 +0300
@@ -0,0 +1,9 @@
+<html>
+<head>
+<title> Bug 453278 - Crash [@ nsContentUtils::TriggerLink] with xlink stuff in display: none iframe</title><style>
+</style>
+</head>
+<body>
+<iframe id="content" src="453278-frame.xml" style="display: none;"></iframe>
+</body>
+</html>
diff -r f3ac957eb4af content/xml/content/crashtest/crashtests.list
--- a/content/xml/content/crashtest/crashtests.list	Thu Sep 04 12:36:46 2008 -0400
+++ b/content/xml/content/crashtest/crashtests.list	Sat Sep 06 10:14:36 2008 +0300
@@ -1,1 +1,2 @@ load 420429.xul
 load 420429.xul
+load 453278.html
diff -r f3ac957eb4af content/xml/content/src/nsXMLElement.cpp
--- a/content/xml/content/src/nsXMLElement.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/content/xml/content/src/nsXMLElement.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -186,11 +186,13 @@ nsXMLElement::MaybeTriggerAutoLink(nsIDo
   // Attempt to load the URI
   nsCOMPtr<nsPresContext> pc;
   nsresult rv = DocShellToPresContext(aShell, getter_AddRefs(pc));
   NS_ENSURE_SUCCESS(rv, rv);
 
-  nsContentUtils::TriggerLink(this, pc, absURI, target, PR_TRUE, PR_FALSE);
+  if (pc) {
+    nsContentUtils::TriggerLink(this, pc, absURI, target, PR_TRUE, PR_FALSE);
+  }
 
   return special_rv; // return GetLinkTargetAndAutoType's special rv!
 }
 
 PRBool
diff -r f3ac957eb4af content/xslt/src/xslt/txMozillaXSLTProcessor.cpp
--- a/content/xslt/src/xslt/txMozillaXSLTProcessor.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/content/xslt/src/xslt/txMozillaXSLTProcessor.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -1444,21 +1444,12 @@ txVariable::Convert(nsIVariant *aValue, 
 
             // Convert random JS Objects to a string.
             nsCOMPtr<nsIXPConnectJSObjectHolder> holder =
                 do_QueryInterface(supports);
             if (holder) {
-                nsCOMPtr<nsIXPConnect> xpc =
-                    do_GetService(nsIXPConnect::GetCID(), &rv);
-                NS_ENSURE_SUCCESS(rv, rv);
-                
-                nsAXPCNativeCallContext *cc = nsnull;
-                rv = xpc->GetCurrentNativeCallContext(&cc);
-                NS_ENSURE_SUCCESS(rv, rv);
-
-                JSContext* cx;
-                rv = cc->GetJSContext(&cx);
-                NS_ENSURE_SUCCESS(rv, rv);
+                JSContext* cx = nsContentUtils::GetCurrentJSContext();
+                NS_ENSURE_TRUE(cx, NS_ERROR_NOT_AVAILABLE);
 
                 JSObject *jsobj;
                 rv = holder->GetJSObject(&jsobj);
                 NS_ENSURE_SUCCESS(rv, rv);
 
diff -r f3ac957eb4af dom/public/idl/base/Makefile.in
--- a/dom/public/idl/base/Makefile.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/public/idl/base/Makefile.in	Sat Sep 06 10:14:36 2008 +0300
@@ -63,12 +63,10 @@ XPIDLSRCS =					\
 	nsIDOMCrypto.idl			\
 	nsIDOMHistory.idl			\
 	nsIDOMLocation.idl			\
 	nsIDOMMimeType.idl			\
 	nsIDOMMimeTypeArray.idl			\
-	nsIDOMNSHistory.idl			\
-	nsIDOMNSLocation.idl			\
 	nsIDOMNavigator.idl			\
 	nsIDOMPkcs11.idl			\
 	nsIDOMPlugin.idl			\
 	nsIDOMPluginArray.idl			\
 	nsIDOMScreen.idl			\
diff -r f3ac957eb4af dom/public/idl/base/nsIDOMHistory.idl
--- a/dom/public/idl/base/nsIDOMHistory.idl	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/public/idl/base/nsIDOMHistory.idl	Sat Sep 06 10:14:36 2008 +0300
@@ -48,9 +48,8 @@ interface nsIDOMHistory : nsISupports
   readonly attribute DOMString        next;
 
   void                       back();
   void                       forward();
 
-  // go() gets special treatment in nsIDOMNSHistory
-  [noscript] void            go(in long aDelta);
+  void                       go([optional] in long aDelta);
   DOMString                  item(in unsigned long index);
 };
diff -r f3ac957eb4af dom/public/idl/base/nsIDOMJSWindow.idl
--- a/dom/public/idl/base/nsIDOMJSWindow.idl	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/public/idl/base/nsIDOMJSWindow.idl	Sat Sep 06 10:14:36 2008 +0300
@@ -36,11 +36,11 @@
  *
  * ***** END LICENSE BLOCK ***** */
 
 #include "domstubs.idl"
 
-[scriptable, uuid(c8188620-1dd1-11b2-bc88-df8440498add)]
+[scriptable, uuid(8fcfcc79-054f-437b-965d-807d9b602d0f)]
 interface nsIDOMJSWindow : nsISupports
 {
   void                      dump(in DOMString str);
 
   /**
@@ -75,16 +75,10 @@ interface nsIDOMJSWindow : nsISupports
   void                      routeEvent(in nsIDOMEvent evt);
   void                      enableExternalCapture();
   void                      disableExternalCapture();
 
   /**
-   * The prompt method takes up to four arguments, the arguments are
-   * message, initial prompt value, title and a save password flag
-   */
-  DOMString                 prompt();
-
-  /**
    * These are the scriptable versions of nsIDOMWindowInternal::open() and
    * nsIDOMWindowInternal::openDialog() that take 3 optional arguments.  Unlike
    * the nsIDOMWindowInternal methods, these methods assume that they are
    * called from JavaScript and hence will look on the JS context stack to
    * determine the caller and hence correct security context for doing their
@@ -102,18 +96,6 @@ interface nsIDOMJSWindow : nsISupports
    * JS specific.
    *
    * This property is "replaceable" in JavaScript.
    */
   readonly attribute nsIDOMWindow             frames;
-
-  /* Scriptable version of find(). See nsIDOMWindowInternal for the
-   * non-scriptable version. It takes 7 optional arguments:
-   * @param searchString: the search string
-   * @param caseSensitive: is the search case sensitive?
-   * @param backwards: should we search backwards?
-   * @param wrapAround: should wrap the search?
-   * @param wholeWord: should we search only for whole words?
-   * @param searchInFrames: should we search in all frames?
-   * @param showDialog: should we show the Find Dialog?
-   */  
-  boolean                   find();                
 };
diff -r f3ac957eb4af dom/public/idl/base/nsIDOMLocation.idl
--- a/dom/public/idl/base/nsIDOMLocation.idl	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/public/idl/base/nsIDOMLocation.idl	Sat Sep 06 10:14:36 2008 +0300
@@ -54,12 +54,11 @@ interface nsIDOMLocation : nsISupports
            attribute DOMString        pathname;
            attribute DOMString        port;
            attribute DOMString        protocol;
            attribute DOMString        search;
 
-  // XXX is this needed?
-  [noscript] void           reload(in boolean forceget);
+  void                      reload([optional] in boolean forceget);
   void                      replace(in DOMString url);
   void                      assign(in DOMString url);
 
   DOMString                 toString();
 };
diff -r f3ac957eb4af dom/public/idl/base/nsIDOMNSHistory.idl
--- a/dom/public/idl/base/nsIDOMNSHistory.idl	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,49 +0,0 @@
-/* -*- Mode: IDL; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
-/* ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 2000
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *   Johnny Stenback <jst@netscape.com> (original author)
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either of the GNU General Public License Version 2 or later (the "GPL"),
- * or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#include "domstubs.idl"
-
-[scriptable, uuid(5fb96f46-1dd2-11b2-a5dc-998ca8636ea9)]
-interface nsIDOMNSHistory : nsISupports
-{
-  /**
-   * go() can be called with an integer argument or no arguments (a
-   * nop) from JS
-   */
-  void                       go(/* ... */);
-};
diff -r f3ac957eb4af dom/public/idl/base/nsIDOMNSLocation.idl
--- a/dom/public/idl/base/nsIDOMNSLocation.idl	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,45 +0,0 @@
-/* -*- Mode: IDL; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
-/* ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 2000
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *   Johnny Stenback <jst@netscape.com> (original author)
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either of the GNU General Public License Version 2 or later (the "GPL"),
- * or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#include "domstubs.idl"
-
-[scriptable, uuid(a6cf9108-15b3-11d2-932e-00805f8add32)]
-interface nsIDOMNSLocation : nsISupports
-{
-  void                      reload(/* ... */);
-};
diff -r f3ac957eb4af dom/public/idl/base/nsIDOMPluginArray.idl
--- a/dom/public/idl/base/nsIDOMPluginArray.idl	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/public/idl/base/nsIDOMPluginArray.idl	Sat Sep 06 10:14:36 2008 +0300
@@ -45,14 +45,7 @@ interface nsIDOMPluginArray : nsISupport
   readonly attribute unsigned long    length;
 
   nsIDOMPlugin              item(in unsigned long index);
   nsIDOMPlugin              namedItem(in DOMString name);
 
-  [noscript] void           refresh(in boolean reloadDocuments);
+  void                      refresh([optional] in boolean reloadDocuments);
 };
-
-
-[scriptable, uuid(ee753352-1dd1-11b2-b18d-b0b7320a28c3)]
-interface nsIDOMJSPluginArray : nsISupports
-{
-  void                      refresh();
-};
diff -r f3ac957eb4af dom/public/idl/base/nsIDOMWindowInternal.idl
--- a/dom/public/idl/base/nsIDOMWindowInternal.idl	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/public/idl/base/nsIDOMWindowInternal.idl	Sat Sep 06 10:14:36 2008 +0300
@@ -121,14 +121,14 @@ interface nsIDOMWindowInternal : nsIDOMW
 
   void                      alert(in DOMString text);
   boolean                   confirm(in DOMString text);
 
   // prompt() should return a null string if cancel is pressed
-  DOMString                 prompt(in DOMString aMessage,
-                                   in DOMString aInitial,
-                                   in DOMString aTitle,
-                                   in unsigned long aSavePassword);
+  DOMString                 prompt([optional] in DOMString aMessage,
+                                   [optional] in DOMString aInitial,
+                                   [optional] in DOMString aTitle,
+                                   [optional] in unsigned long aSavePassword);
 
   void                      focus();
   void                      blur();
 
   void                      back();
@@ -172,26 +172,26 @@ interface nsIDOMWindowInternal : nsIDOMW
   void                      close();
 
   // XXX Should this be in nsIDOMChromeWindow?
   void                      updateCommands(in DOMString action);
 
-  /* See nsIDOMJSWindow for the scriptable version of find()
+  /* Find in page.
    * @param str: the search pattern
    * @param caseSensitive: is the search caseSensitive
    * @param backwards: should we search backwards
    * @param wrapAround: should we wrap the search
    * @param wholeWord: should we search only for whole words
    * @param searchInFrames: should we search through all frames
    * @param showDialog: should we show the Find dialog
    */
-  [noscript] boolean        find(in DOMString str, 
-                                 in boolean caseSensitive,
-                                 in boolean backwards, 
-                                 in boolean wrapAround,
-                                 in boolean wholeWord, 
-                                 in boolean searchInFrames, 
-                                 in boolean showDialog);
+  boolean                   find([optional] in DOMString str,
+                                 [optional] in boolean caseSensitive,
+                                 [optional] in boolean backwards,
+                                 [optional] in boolean wrapAround,
+                                 [optional] in boolean wholeWord,
+                                 [optional] in boolean searchInFrames,
+                                 [optional] in boolean showDialog);
 
   // Ascii base64 data to binary data and vice versa...
   DOMString                 atob(in DOMString aAsciiString);
   DOMString                 btoa(in DOMString aBase64Data);
 
diff -r f3ac957eb4af dom/src/base/nsDOMClassInfo.cpp
--- a/dom/src/base/nsDOMClassInfo.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/src/base/nsDOMClassInfo.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -102,18 +102,16 @@
 // DOM base includes
 #include "nsIDOMPluginArray.h"
 #include "nsIDOMPlugin.h"
 #include "nsIDOMMimeTypeArray.h"
 #include "nsIDOMMimeType.h"
-#include "nsIDOMNSLocation.h"
 #include "nsIDOMLocation.h"
 #include "nsIDOMWindowInternal.h"
 #include "nsPIDOMWindow.h"
 #include "nsIDOMJSWindow.h"
 #include "nsIDOMWindowCollection.h"
 #include "nsIDOMHistory.h"
-#include "nsIDOMNSHistory.h"
 #include "nsIDOMMediaList.h"
 #include "nsIDOMChromeWindow.h"
 #include "nsIDOMConstructor.h"
 #include "nsIDOMClientRect.h"
 #include "nsIDOMClientRectList.h"
@@ -1956,11 +1954,10 @@ nsDOMClassInfo::Init()
     DOM_CLASSINFO_MAP_ENTRY(nsIDOMWindowUtils)
   DOM_CLASSINFO_MAP_END
 
   DOM_CLASSINFO_MAP_BEGIN(Location, nsIDOMLocation)
     DOM_CLASSINFO_MAP_ENTRY(nsIDOMLocation)
-    DOM_CLASSINFO_MAP_ENTRY(nsIDOMNSLocation)
   DOM_CLASSINFO_MAP_END
 
   DOM_CLASSINFO_MAP_BEGIN(Navigator, nsIDOMNavigator)
     DOM_CLASSINFO_MAP_ENTRY(nsIDOMNavigator)
     DOM_CLASSINFO_MAP_ENTRY(nsIDOMJSNavigator)
@@ -1972,11 +1969,10 @@ nsDOMClassInfo::Init()
     DOM_CLASSINFO_MAP_ENTRY(nsIDOMPlugin)
   DOM_CLASSINFO_MAP_END
 
   DOM_CLASSINFO_MAP_BEGIN(PluginArray, nsIDOMPluginArray)
     DOM_CLASSINFO_MAP_ENTRY(nsIDOMPluginArray)
-    DOM_CLASSINFO_MAP_ENTRY(nsIDOMJSPluginArray)
   DOM_CLASSINFO_MAP_END
 
   DOM_CLASSINFO_MAP_BEGIN(MimeType, nsIDOMMimeType)
     DOM_CLASSINFO_MAP_ENTRY(nsIDOMMimeType)
   DOM_CLASSINFO_MAP_END
@@ -1989,11 +1985,10 @@ nsDOMClassInfo::Init()
     DOM_CLASSINFO_MAP_ENTRY(nsIDOMBarProp)
   DOM_CLASSINFO_MAP_END
 
   DOM_CLASSINFO_MAP_BEGIN(History, nsIDOMHistory)
     DOM_CLASSINFO_MAP_ENTRY(nsIDOMHistory)
-    DOM_CLASSINFO_MAP_ENTRY(nsIDOMNSHistory)
   DOM_CLASSINFO_MAP_END
 
   DOM_CLASSINFO_MAP_BEGIN(Screen, nsIDOMScreen)
     DOM_CLASSINFO_MAP_ENTRY(nsIDOMScreen)
   DOM_CLASSINFO_MAP_END
@@ -7474,10 +7469,15 @@ NS_IMETHODIMP
 NS_IMETHODIMP
 nsGenericArraySH::NewResolve(nsIXPConnectWrappedNative *wrapper, JSContext *cx,
                              JSObject *obj, jsval id, PRUint32 flags,
                              JSObject **objp, PRBool *_retval)
 {
+  if (id == sLength_id) {
+    // Bail early; this isn't something we're interested in
+    return NS_OK;
+  }
+  
   PRBool is_number = PR_FALSE;
   PRInt32 n = GetArrayIndexFromId(cx, id, &is_number);
 
   if (is_number && n >= 0) {
     // XXX The following is a cheap optimization to avoid hitting xpconnect to
diff -r f3ac957eb4af dom/src/base/nsGlobalWindow.cpp
--- a/dom/src/base/nsGlobalWindow.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/src/base/nsGlobalWindow.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -1784,18 +1784,11 @@ nsGlobalWindow::SetNewDocument(nsIDocume
 
       if (currentInner && currentInner->mJSObject) {
         PRBool termFuncSet = PR_FALSE;
 
         if (oldDoc == aDocument) {
-          nsCOMPtr<nsIJSContextStack> stack =
-            do_GetService(sJSStackContractID);
-
-          JSContext *cx = nsnull;
-
-          if (stack) {
-            stack->Peek(&cx);
-          }
+          JSContext *cx = nsContentUtils::GetCurrentJSContext();
 
           nsIScriptContext *callerScx;
           if (cx && (callerScx = GetScriptContextFromJSContext(cx))) {
             // We're called from document.open() (and document.open() is
             // called from JS), clear the scope etc in a termination
@@ -3698,19 +3691,11 @@ nsGlobalWindow::DispatchCustomEvent(cons
 }
 
 static already_AddRefed<nsIDocShellTreeItem>
 GetCallerDocShellTreeItem()
 {
-  nsCOMPtr<nsIJSContextStack> stack =
-    do_GetService(sJSStackContractID);
-
-  JSContext *cx = nsnull;
-
-  if (stack) {
-    stack->Peek(&cx);
-  }
-
+  JSContext *cx = nsContentUtils::GetCurrentJSContext();
   nsIDocShellTreeItem *callerItem = nsnull;
 
   if (cx) {
     nsCOMPtr<nsIWebNavigation> callerWebNav =
       do_GetInterface(nsJSUtils::GetDynamicScriptGlobal(cx));
@@ -4096,10 +4081,16 @@ nsGlobalWindow::Prompt(const nsAString& 
 {
   // We don't use "aTitle" because we ignore the 3rd (title) argument to
   // prompt(). IE and Opera ignore it too. See Mozilla bug 334893.
   SetDOMStringToNull(aReturn);
 
+  // This code depends on aSavePassword being defaulted to
+  // nsIAuthPrompt::SAVE_PASSWORD_NEVER, which happens to have the
+  // value 0. If that ever changes, this code needs to deal!
+
+  PR_STATIC_ASSERT(nsIAuthPrompt::SAVE_PASSWORD_NEVER == 0);
+
   nsresult rv;
   nsCOMPtr<nsIWindowWatcher> wwatch =
     do_GetService(NS_WINDOWWATCHER_CONTRACTID, &rv);
   NS_ENSURE_SUCCESS(rv, rv);
 
@@ -4136,61 +4127,10 @@ nsGlobalWindow::Prompt(const nsAString& 
   if (uniResult && b) {
     aReturn.Assign(uniResult);
   }
 
   return rv;
-}
-
-NS_IMETHODIMP
-nsGlobalWindow::Prompt(nsAString& aReturn)
-{
-  FORWARD_TO_OUTER(Prompt, (aReturn), NS_ERROR_NOT_INITIALIZED);
-
-  NS_ENSURE_STATE(mDocShell);
-
-  nsresult rv = NS_OK;
-  nsAXPCNativeCallContext *ncc = nsnull;
-
-  rv = nsContentUtils::XPConnect()->
-    GetCurrentNativeCallContext(&ncc);
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  if (!ncc)
-    return NS_ERROR_NOT_AVAILABLE;
-
-  JSContext *cx = nsnull;
-
-  rv = ncc->GetJSContext(&cx);
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  nsAutoString message, initial, title;
-
-  PRUint32 argc;
-  jsval *argv = nsnull;
-
-  ncc->GetArgc(&argc);
-  ncc->GetArgvPtr(&argv);
-
-  PRUint32 savePassword = nsIAuthPrompt::SAVE_PASSWORD_NEVER;
-
-  if (argc > 0) {
-    JSAutoRequest ar(cx);
-    switch (argc) {
-      default:
-      case 4:
-        nsJSUtils::ConvertJSValToUint32(&savePassword, cx, argv[3]);
-      case 3:
-        nsJSUtils::ConvertJSValToString(title, cx, argv[2]);
-      case 2:
-        nsJSUtils::ConvertJSValToString(initial, cx, argv[1]);
-      case 1:
-        nsJSUtils::ConvertJSValToString(message, cx, argv[0]);
-        break;
-    }
-  }
-
-  return Prompt(message, initial, title, savePassword, aReturn);
 }
 
 NS_IMETHODIMP
 nsGlobalWindow::Focus()
 {
@@ -4959,20 +4899,17 @@ nsGlobalWindow::FireAbuseEvents(PRBool a
 
   // first, fetch the opener's base URI
 
   nsIURI *baseURL = 0;
 
-  nsCOMPtr<nsIJSContextStack> stack = do_GetService(sJSStackContractID);
+  JSContext *cx = nsContentUtils::GetCurrentJSContext();
   nsCOMPtr<nsIDOMWindow> contextWindow;
-  if (stack) {
-    JSContext *cx = nsnull;
-    stack->Peek(&cx);
-    if (cx) {
-      nsIScriptContext *currentCX = nsJSUtils::GetDynamicScriptContext(cx);
-      if (currentCX) {
-        contextWindow = do_QueryInterface(currentCX->GetGlobalObject());
-      }
+
+  if (cx) {
+    nsIScriptContext *currentCX = nsJSUtils::GetDynamicScriptContext(cx);
+    if (currentCX) {
+      contextWindow = do_QueryInterface(currentCX->GetGlobalObject());
     }
   }
   if (!contextWindow)
     contextWindow = static_cast<nsIDOMWindow*>(this);
 
@@ -5155,20 +5092,14 @@ nsGlobalWindow::GetFrames(nsIDOMWindow**
 }
 
 nsGlobalWindow*
 nsGlobalWindow::CallerInnerWindow()
 {
-  nsAXPCNativeCallContext *ncc;
-  nsresult rv = nsContentUtils::XPConnect()->GetCurrentNativeCallContext(&ncc);
-  if (NS_FAILED(rv) || !ncc) {
-    NS_ASSERTION(ncc, "Please don't call this method from C++!");
-    return nsnull;
-  }
-
-  JSContext *cx = nsnull;
-  if (NS_FAILED(ncc->GetJSContext(&cx))) {
-    NS_WARNING("couldn't get JS context from native context");
+  JSContext *cx = nsContentUtils::GetCurrentJSContext();
+  if (!cx) {
+    NS_ERROR("Please don't call this method from C++!");
+
     return nsnull;
   }
 
   JSObject *scope = ::JS_GetScopeChain(cx);
   if (!scope)
@@ -6195,131 +6126,33 @@ nsGlobalWindow::GetSelection(nsISelectio
   NS_IF_ADDREF(*aSelection);
 
   return NS_OK;
 }
 
-// Non-scriptable version of window.find(), part of nsIDOMWindowInternal
 NS_IMETHODIMP
 nsGlobalWindow::Find(const nsAString& aStr, PRBool aCaseSensitive,
                      PRBool aBackwards, PRBool aWrapAround, PRBool aWholeWord,
                      PRBool aSearchInFrames, PRBool aShowDialog,
                      PRBool *aDidFind)
 {
-  return FindInternal(aStr, aCaseSensitive, aBackwards, aWrapAround,
-                      aWholeWord, aSearchInFrames, aShowDialog, aDidFind);
-}
-
-// Scriptable version of window.find() which takes a variable number of
-// arguments, part of nsIDOMJSWindow.
-NS_IMETHODIMP
-nsGlobalWindow::Find(PRBool *aDidFind)
-{
-  nsresult rv = NS_OK;
-
-  // We get the arguments passed to the function using the XPConnect native
-  // call context.
-  nsAXPCNativeCallContext *ncc = nsnull;
-
-  rv = nsContentUtils::XPConnect()->
-    GetCurrentNativeCallContext(&ncc);
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  NS_ASSERTION(ncc, "No Native Call Context."
-                    "Please don't call this method from C++.");
-  if (!ncc) {
-    return NS_ERROR_NOT_AVAILABLE;
-  }
-
-  JSContext *cx = nsnull;
-
-  rv = ncc->GetJSContext(&cx);
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  PRUint32 argc;
-  jsval *argv = nsnull;
-
-  ncc->GetArgc(&argc);
-  ncc->GetArgvPtr(&argv);
-
-  // Parse the arguments passed to the function
-  nsAutoString searchStr;
-  PRBool caseSensitive  = PR_FALSE;
-  PRBool backwards      = PR_FALSE;
-  PRBool wrapAround     = PR_FALSE;
-  PRBool showDialog     = PR_FALSE;
-  PRBool wholeWord      = PR_FALSE;
-  PRBool searchInFrames = PR_FALSE;
-
-  if (argc > 0) {
-    JSAutoRequest ar(cx);
-    switch (argc) {
-      default:
-      case 7:
-        if (!JS_ValueToBoolean(cx, argv[6], &showDialog)) {
-          // Seventh arg specifies whether we should search in all frames
-          showDialog = PR_FALSE;
-        }
-      case 6:
-        if (!JS_ValueToBoolean(cx, argv[5], &searchInFrames)) {
-          // Sixth arg specifies whether we should search only for whole words
-          searchInFrames = PR_FALSE;
-        }
-      case 5:
-        if (!JS_ValueToBoolean(cx, argv[4], &wholeWord)) {
-          // Fifth arg specifies whether we should show the Find dialog
-          wholeWord = PR_FALSE;
-        }
-      case 4:
-        if (!JS_ValueToBoolean(cx, argv[3], &wrapAround)) {
-          // Fourth arg specifies whether we should wrap the search
-          wrapAround = PR_FALSE;
-        }
-      case 3:
-        if (!JS_ValueToBoolean(cx, argv[2], &backwards)) {
-          // Third arg specifies whether to search backwards
-          backwards = PR_FALSE;
-        }
-      case 2:
-        if (!JS_ValueToBoolean(cx, argv[1], &caseSensitive)) {
-          // Second arg is the case sensitivity
-          caseSensitive = PR_FALSE;
-        }
-      case 1:
-        // First arg is the search pattern
-        nsJSUtils::ConvertJSValToString(searchStr, cx, argv[0]);
-        break;
-    }
-  }
-
-  return FindInternal(searchStr, caseSensitive, backwards, wrapAround,
-                      wholeWord, searchInFrames, showDialog, aDidFind);
-}
-
-nsresult
-nsGlobalWindow::FindInternal(const nsAString& aStr, PRBool caseSensitive,
-                             PRBool backwards, PRBool wrapAround,
-                             PRBool wholeWord, PRBool searchInFrames,
-                             PRBool showDialog, PRBool *aDidFind)
-{
-  FORWARD_TO_OUTER(FindInternal, (aStr, caseSensitive, backwards, wrapAround,
-                                  wholeWord, searchInFrames, showDialog,
-                                  aDidFind), NS_ERROR_NOT_INITIALIZED);
-
-  NS_ENSURE_ARG_POINTER(aDidFind);
+  FORWARD_TO_OUTER(Find, (aStr, aCaseSensitive, aBackwards, aWrapAround,
+                          aWholeWord, aSearchInFrames, aShowDialog, aDidFind),
+                   NS_ERROR_NOT_INITIALIZED);
+
   nsresult rv = NS_OK;
   *aDidFind = PR_FALSE;
 
   nsCOMPtr<nsIWebBrowserFind> finder(do_GetInterface(mDocShell));
 
   // Set the options of the search
   rv = finder->SetSearchString(PromiseFlatString(aStr).get());
   NS_ENSURE_SUCCESS(rv, rv);
-  finder->SetMatchCase(caseSensitive);
-  finder->SetFindBackwards(backwards);
-  finder->SetWrapFind(wrapAround);
-  finder->SetEntireWord(wholeWord);
-  finder->SetSearchFrames(searchInFrames);
+  finder->SetMatchCase(aCaseSensitive);
+  finder->SetFindBackwards(aBackwards);
+  finder->SetWrapFind(aWrapAround);
+  finder->SetEntireWord(aWholeWord);
+  finder->SetSearchFrames(aSearchInFrames);
 
   // the nsIWebBrowserFind is initialized to use this window
   // as the search root, but uses focus to set the current search
   // frame. If we're being called from JS (as here), this window
   // should be the current search frame.
@@ -6328,11 +6161,11 @@ nsGlobalWindow::FindInternal(const nsASt
     framesFinder->SetRootSearchFrame(this);   // paranoia
     framesFinder->SetCurrentSearchFrame(this);
   }
   
   // The Find API does not accept empty strings. Launch the Find Dialog.
-  if (aStr.IsEmpty() || showDialog) {
+  if (aStr.IsEmpty() || aShowDialog) {
     // See if the find dialog is already up using nsIWindowMediator
     nsCOMPtr<nsIWindowMediator> windowMediator =
       do_GetService(NS_WINDOWMEDIATOR_CONTRACTID);
 
     nsCOMPtr<nsIDOMWindowInternal> findDialog;
@@ -8171,10 +8004,11 @@ nsGlobalWindow::ClearTimeoutOrInterval()
 
   int32 timer_id;
 
   JSAutoRequest ar(cx);
 
+  // XXXjst: Can we deal with this w/o using GetCurrentNativeCallContext()
   if (argv[0] == JSVAL_VOID || !::JS_ValueToInt32(cx, argv[0], &timer_id) ||
       timer_id <= 0) {
     // Undefined or non-positive number passed as argument, return
     // early. Make sure that JS_ValueToInt32 didn't set an exception.
 
@@ -9427,10 +9261,12 @@ nsNavigator::sPrefInternal_id = JSVAL_VO
 nsNavigator::sPrefInternal_id = JSVAL_VOID;
 
 NS_IMETHODIMP
 nsNavigator::Preference()
 {
+  // XXXjst: We could get rid of this GetCurrentNativeCallContext()
+  // call if this method returned a variant...
   nsAXPCNativeCallContext *ncc = nsnull;
   nsresult rv = nsContentUtils::XPConnect()->
     GetCurrentNativeCallContext(&ncc);
   NS_ENSURE_SUCCESS(rv, rv);
 
diff -r f3ac957eb4af dom/src/base/nsGlobalWindow.h
--- a/dom/src/base/nsGlobalWindow.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/src/base/nsGlobalWindow.h	Sat Sep 06 10:14:36 2008 +0300
@@ -64,11 +64,11 @@
 #include "nsIDOMEventTarget.h"
 #include "nsIDOM3EventTarget.h"
 #include "nsIDOMNSEventTarget.h"
 #include "nsIDOMNavigator.h"
 #include "nsIDOMNavigatorGeolocation.h"
-#include "nsIDOMNSLocation.h"
+#include "nsIDOMLocation.h"
 #include "nsIDOMWindowInternal.h"
 #include "nsIInterfaceRequestor.h"
 #include "nsIInterfaceRequestorUtils.h"
 #include "nsIDOMJSWindow.h"
 #include "nsIDOMChromeWindow.h"
@@ -570,16 +570,10 @@ protected:
 
   static void MakeScriptDialogTitle(nsAString &aOutTitle);
 
   static PRBool CanMoveResizeWindows();
 
-  // Helper for window.find()
-  nsresult FindInternal(const nsAString& aStr, PRBool caseSensitive,
-                       PRBool backwards, PRBool wrapAround, PRBool wholeWord, 
-                       PRBool searchInFrames, PRBool showDialog, 
-                       PRBool *aReturn);
-
   nsresult ConvertCharset(const nsAString& aStr, char** aDest);
 
   PRBool   GetBlurSuppression();
 
   // If aDoFlush is true, we'll flush our own layout; otherwise we'll try to
@@ -843,12 +837,11 @@ class nsIURI;
 
 //*****************************************************************************
 // nsLocation: Script "location" object
 //*****************************************************************************
 
-class nsLocation : public nsIDOMLocation,
-                   public nsIDOMNSLocation
+class nsLocation : public nsIDOMLocation
 {
 public:
   nsLocation(nsIDocShell *aDocShell);
   virtual ~nsLocation();
 
@@ -857,13 +850,10 @@ public:
   void SetDocShell(nsIDocShell *aDocShell);
   nsIDocShell *GetDocShell();
 
   // nsIDOMLocation
   NS_DECL_NSIDOMLOCATION
-
-  // nsIDOMNSLocation
-  NS_DECL_NSIDOMNSLOCATION
 
 protected:
   // In the case of jar: uris, we sometimes want the place the jar was
   // fetched from as the URI instead of the jar: uri itself.  Pass in
   // PR_TRUE for aGetInnermostURI when that's the case.
diff -r f3ac957eb4af dom/src/base/nsHistory.cpp
--- a/dom/src/base/nsHistory.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/src/base/nsHistory.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -72,11 +72,10 @@ nsHistory::~nsHistory()
 
 // QueryInterface implementation for nsHistory
 NS_INTERFACE_MAP_BEGIN(nsHistory)
   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIDOMHistory)
   NS_INTERFACE_MAP_ENTRY(nsIDOMHistory)
-  NS_INTERFACE_MAP_ENTRY(nsIDOMNSHistory)
   NS_DOM_INTERFACE_MAP_ENTRY_CLASSINFO(History)
 NS_INTERFACE_MAP_END
 
 
 NS_IMPL_ADDREF(nsHistory)
@@ -220,65 +219,11 @@ nsHistory::Forward()
 }
 
 NS_IMETHODIMP
 nsHistory::Go(PRInt32 aDelta)
 {
-  nsCOMPtr<nsISHistory> session_history;
-
-  GetSessionHistoryFromDocShell(mDocShell, getter_AddRefs(session_history));
-  NS_ENSURE_TRUE(session_history, NS_ERROR_FAILURE);
-
-  // QI SHistory to nsIWebNavigation
-  nsCOMPtr<nsIWebNavigation> webnav(do_QueryInterface(session_history));
-  NS_ENSURE_TRUE(webnav, NS_ERROR_FAILURE);
-
-  PRInt32 curIndex=-1;
-  PRInt32 len = 0;
-  nsresult rv = session_history->GetIndex(&curIndex);  
-  rv = session_history->GetCount(&len);
-  
-  PRInt32 index = curIndex + aDelta;
-  if (index > -1  &&  index < len)
-    webnav->GotoIndex(index);
-  // We always want to return a NS_OK, since returning errors 
-  // from GotoIndex() can lead to exceptions and a possible leak
-  // of history length
-  return NS_OK;
-}
-
-NS_IMETHODIMP
-nsHistory::Go()
-{
-  nsAXPCNativeCallContext *ncc = nsnull;
-  nsresult rv = nsContentUtils::XPConnect()->
-    GetCurrentNativeCallContext(&ncc);
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  if (!ncc)
-    return NS_ERROR_NOT_AVAILABLE;
-
-  PRUint32 argc;
-  ncc->GetArgc(&argc);
-
-  PRInt32 delta = 0;
-
-  if (argc > 0) {
-    jsval *argv = nsnull;
-
-    ncc->GetArgvPtr(&argv);
-    NS_ENSURE_TRUE(argv, NS_ERROR_UNEXPECTED);
-
-    if (!JSVAL_IS_INT(argv[0])) {
-      // Not an index, don't do anything.
-
-      return NS_OK;
-    }
-
-    delta = JSVAL_TO_INT(argv[0]);
-  }
-
-  if (delta == 0) {
+  if (aDelta == 0) {
     nsCOMPtr<nsPIDOMWindow> window(do_GetInterface(mDocShell));
 
     if (window && window->IsHandlingResizeEvent()) {
       // history.go(0) (aka location.reload()) was called on a window
       // that is handling a resize event. Sites do this since Netscape
@@ -300,11 +245,33 @@ nsHistory::Go()
 
       return NS_OK;
     }
   }
 
-  return Go(delta);
+  nsCOMPtr<nsISHistory> session_history;
+
+  GetSessionHistoryFromDocShell(mDocShell, getter_AddRefs(session_history));
+  NS_ENSURE_TRUE(session_history, NS_ERROR_FAILURE);
+
+  // QI SHistory to nsIWebNavigation
+  nsCOMPtr<nsIWebNavigation> webnav(do_QueryInterface(session_history));
+  NS_ENSURE_TRUE(webnav, NS_ERROR_FAILURE);
+
+  PRInt32 curIndex=-1;
+  PRInt32 len = 0;
+  nsresult rv = session_history->GetIndex(&curIndex);  
+  rv = session_history->GetCount(&len);
+
+  PRInt32 index = curIndex + aDelta;
+  if (index > -1  &&  index < len)
+    webnav->GotoIndex(index);
+
+  // We always want to return a NS_OK, since returning errors 
+  // from GotoIndex() can lead to exceptions and a possible leak
+  // of history length
+
+  return NS_OK;
 }
 
 NS_IMETHODIMP
 nsHistory::Item(PRUint32 aIndex, nsAString& aReturn)
 {
diff -r f3ac957eb4af dom/src/base/nsHistory.h
--- a/dom/src/base/nsHistory.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/src/base/nsHistory.h	Sat Sep 06 10:14:36 2008 +0300
@@ -36,21 +36,19 @@
  * ***** END LICENSE BLOCK ***** */
 #ifndef nsHistory_h___
 #define nsHistory_h___
 
 #include "nsIDOMHistory.h"
-#include "nsIDOMNSHistory.h"
 #include "nsISupports.h"
 #include "nscore.h"
 #include "nsIScriptContext.h"
 #include "nsISHistory.h"
 
 class nsIDocShell;
 
 // Script "History" object
-class nsHistory : public nsIDOMHistory,
-                  public nsIDOMNSHistory
+class nsHistory : public nsIDOMHistory
 {
 public:
   nsHistory(nsIDocShell* aDocShell);
   virtual ~nsHistory();
 
@@ -58,13 +56,10 @@ public:
   NS_DECL_ISUPPORTS
 
   // nsIDOMHistory
   NS_DECL_NSIDOMHISTORY
 
-  // nsIDOMNSHistory
-  NS_DECL_NSIDOMNSHISTORY
-
   void SetDocShell(nsIDocShell *aDocShell);
 
 protected:
   nsresult GetSessionHistoryFromDocShell(nsIDocShell * aDocShell,
                                          nsISHistory ** aReturn);
diff -r f3ac957eb4af dom/src/base/nsJSEnvironment.cpp
--- a/dom/src/base/nsJSEnvironment.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/src/base/nsJSEnvironment.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -907,10 +907,15 @@ nsJSContext::DOMOperationCallback(JSCont
     nsJSContext::CC();
 
     // if that didn't work, warn the user
     mem->IsLowMemory(&lowMemory);
     if (lowMemory) {
+
+      PRBool preventDialog = nsContentUtils::GetBoolPref("dom.prevent_oom_dialog", PR_FALSE);
+      if (preventDialog)
+        return JS_FALSE;
+
       nsCOMPtr<nsIPrompt> prompt = GetPromptFromContext(ctx);
       
       nsXPIDLString title, msg;
       rv = nsContentUtils::GetLocalizedString(nsContentUtils::eDOM_PROPERTIES,
                                               "LowMemoryTitle",
@@ -3056,11 +3061,11 @@ static JSFunctionSpec TraceMallocFunctio
 
 inline PRBool
 IsJProfAction(struct sigaction *action)
 {
     return (action->sa_sigaction &&
-            action->sa_flags == SA_RESTART | SA_SIGINFO);
+            action->sa_flags == (SA_RESTART | SA_SIGINFO));
 }
 
 void NS_JProfStartProfiling();
 void NS_JProfStopProfiling();
 
@@ -3761,11 +3766,15 @@ nsJSRuntime::Init()
       return NS_ERROR_NOT_AVAILABLE;
 
     return NS_OK;
   }
 
-  nsresult rv = CallGetService(kJSRuntimeServiceContractID, &sRuntimeService);
+  nsresult rv = CallGetService(NS_SCRIPTSECURITYMANAGER_CONTRACTID,
+                               &sSecurityManager);
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  rv = CallGetService(kJSRuntimeServiceContractID, &sRuntimeService);
   // get the JSRuntime from the runtime svc, if possible
   NS_ENSURE_SUCCESS(rv, rv);
 
   rv = sRuntimeService->GetRuntime(&sRuntime);
   NS_ENSURE_SUCCESS(rv, rv);
@@ -3777,16 +3786,14 @@ nsJSRuntime::Init()
                "nsJSRuntime initialized more than once");
 
   // Save the old GC callback to chain to it, for GC-observing generality.
   gOldJSGCCallback = ::JS_SetGCCallbackRT(sRuntime, DOMGCCallback);
 
-  // No chaining to a pre-existing callback here, we own this problem space.
-#ifdef NS_DEBUG
-  JSObjectPrincipalsFinder oldfop =
-#endif
-    ::JS_SetObjectPrincipalsFinder(sRuntime, ObjectPrincipalFinder);
-  NS_ASSERTION(!oldfop, " fighting over the findObjectPrincipals callback!");
+  JSSecurityCallbacks *callbacks = JS_GetRuntimeSecurityCallbacks(sRuntime);
+  NS_ASSERTION(callbacks, "SecMan should have set security callbacks!");
+
+  callbacks->findObjectPrincipals = ObjectPrincipalFinder;
 
   // Set these global xpconnect options...
   nsContentUtils::RegisterPrefCallback("dom.max_script_run_time",
                                        MaxScriptRunTimePrefChangedCallback,
                                        nsnull);
@@ -3815,13 +3822,11 @@ nsJSRuntime::Init()
 
   nsIObserver* ccMemPressureObserver = new nsCCMemoryPressureObserver();
   NS_ENSURE_TRUE(ccMemPressureObserver, NS_ERROR_OUT_OF_MEMORY);
   obs->AddObserver(ccMemPressureObserver, "memory-pressure", PR_FALSE);
 
-  rv = CallGetService(NS_SCRIPTSECURITYMANAGER_CONTRACTID, &sSecurityManager);
-
-  sIsInitialized = NS_SUCCEEDED(rv);
+  sIsInitialized = PR_TRUE;
 
   return rv;
 }
 
 //static
@@ -3861,16 +3866,16 @@ void nsJSRuntime::ShutDown()
   if (!sContextCount) {
     // We're being shutdown, and there are no more contexts
     // alive, release the JS runtime service and the security manager.
 
     if (sRuntimeService && sSecurityManager) {
-      // No chaining to a pre-existing callback here, we own this problem space.
-#ifdef NS_DEBUG
-      JSObjectPrincipalsFinder oldfop =
-#endif
-        ::JS_SetObjectPrincipalsFinder(sRuntime, nsnull);
-      NS_ASSERTION(oldfop == ObjectPrincipalFinder, " fighting over the findObjectPrincipals callback!");
+      JSSecurityCallbacks *callbacks = JS_GetRuntimeSecurityCallbacks(sRuntime);
+      if (callbacks) {
+        NS_ASSERTION(callbacks->findObjectPrincipals == ObjectPrincipalFinder,
+                     "Fighting over the findObjectPrincipals callback!");
+        callbacks->findObjectPrincipals = NULL;
+      }
     }
     NS_IF_RELEASE(sRuntimeService);
     NS_IF_RELEASE(sSecurityManager);
     NS_IF_RELEASE(gCollation);
     NS_IF_RELEASE(gDecoder);
diff -r f3ac957eb4af dom/src/base/nsLocation.cpp
--- a/dom/src/base/nsLocation.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/src/base/nsLocation.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -146,11 +146,10 @@ nsLocation::~nsLocation()
 }
 
 
 // QueryInterface implementation for nsLocation
 NS_INTERFACE_MAP_BEGIN(nsLocation)
-  NS_INTERFACE_MAP_ENTRY(nsIDOMNSLocation)
   NS_INTERFACE_MAP_ENTRY(nsIDOMLocation)
   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIDOMLocation)
   NS_DOM_INTERFACE_MAP_ENTRY_CLASSINFO(Location)
 NS_INTERFACE_MAP_END
 
@@ -840,44 +839,10 @@ nsLocation::Reload(PRBool aForceget)
 nsLocation::Reload(PRBool aForceget)
 {
   nsresult rv;
   nsCOMPtr<nsIDocShell> docShell(do_QueryReferent(mDocShell));
   nsCOMPtr<nsIWebNavigation> webNav(do_QueryInterface(docShell));
-
-  if (webNav) {
-    PRUint32 reloadFlags = nsIWebNavigation::LOAD_FLAGS_NONE;
-
-    if (aForceget) {
-      reloadFlags = nsIWebNavigation::LOAD_FLAGS_BYPASS_CACHE | 
-                    nsIWebNavigation::LOAD_FLAGS_BYPASS_PROXY;
-    }
-    rv = webNav->Reload(reloadFlags);
-    if (rv == NS_BINDING_ABORTED) {
-      // This happens when we attempt to reload a POST result and the user says
-      // no at the "do you want to reload?" prompt.  Don't propagate this one
-      // back to callers.
-      rv = NS_OK;
-    }
-  } else {
-    rv = NS_ERROR_FAILURE;
-  }
-
-  return rv;
-}
-
-NS_IMETHODIMP
-nsLocation::Reload()
-{
-  nsAXPCNativeCallContext *ncc = nsnull;
-  nsresult rv = nsContentUtils::XPConnect()->
-    GetCurrentNativeCallContext(&ncc);
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  if (!ncc)
-    return NS_ERROR_NOT_AVAILABLE;
-
-  nsCOMPtr<nsIDocShell> docShell(do_QueryReferent(mDocShell));
   nsCOMPtr<nsPIDOMWindow> window(do_GetInterface(docShell));
 
   if (window && window->IsHandlingResizeEvent()) {
     // location.reload() was called on a window that is handling a
     // resize event. Sites do this since Netscape 4.x needed it, but
@@ -896,32 +861,29 @@ nsLocation::Reload()
     }
 
     return NS_OK;
   }
 
-  PRBool force_get = PR_FALSE;
+  if (webNav) {
+    PRUint32 reloadFlags = nsIWebNavigation::LOAD_FLAGS_NONE;
 
-  PRUint32 argc;
-
-  ncc->GetArgc(&argc);
-
-  if (argc > 0) {
-    jsval *argv = nsnull;
-
-    ncc->GetArgvPtr(&argv);
-    NS_ENSURE_TRUE(argv, NS_ERROR_UNEXPECTED);
-
-    JSContext *cx = nsnull;
-
-    rv = ncc->GetJSContext(&cx);
-    NS_ENSURE_SUCCESS(rv, rv);
-
-    JSAutoRequest ar(cx);
-    JS_ValueToBoolean(cx, argv[0], &force_get);
+    if (aForceget) {
+      reloadFlags = nsIWebNavigation::LOAD_FLAGS_BYPASS_CACHE | 
+                    nsIWebNavigation::LOAD_FLAGS_BYPASS_PROXY;
+    }
+    rv = webNav->Reload(reloadFlags);
+    if (rv == NS_BINDING_ABORTED) {
+      // This happens when we attempt to reload a POST result and the user says
+      // no at the "do you want to reload?" prompt.  Don't propagate this one
+      // back to callers.
+      rv = NS_OK;
+    }
+  } else {
+    rv = NS_ERROR_FAILURE;
   }
 
-  return Reload(force_get);
+  return rv;
 }
 
 NS_IMETHODIMP
 nsLocation::Replace(const nsAString& aUrl)
 {
diff -r f3ac957eb4af dom/src/base/nsPluginArray.cpp
--- a/dom/src/base/nsPluginArray.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/src/base/nsPluginArray.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -76,11 +76,10 @@ nsPluginArray::~nsPluginArray()
 
 // QueryInterface implementation for nsPluginArray
 NS_INTERFACE_MAP_BEGIN(nsPluginArray)
   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIDOMPluginArray)
   NS_INTERFACE_MAP_ENTRY(nsIDOMPluginArray)
-  NS_INTERFACE_MAP_ENTRY(nsIDOMJSPluginArray)
   NS_DOM_INTERFACE_MAP_ENTRY_CLASSINFO(PluginArray)
 NS_INTERFACE_MAP_END
 
 NS_IMPL_ADDREF(nsPluginArray)
 NS_IMPL_RELEASE(nsPluginArray)
@@ -240,45 +239,10 @@ nsPluginArray::Refresh(PRBool aReloadDoc
     webNav->Reload(nsIWebNavigation::LOAD_FLAGS_NONE);
 
   return res;
 }
 
-NS_IMETHODIMP
-nsPluginArray::Refresh()
-{
-  nsAXPCNativeCallContext *ncc = nsnull;
-  nsresult rv = nsContentUtils::XPConnect()->
-    GetCurrentNativeCallContext(&ncc);
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  if (!ncc)
-    return NS_ERROR_NOT_AVAILABLE;
-
-  PRBool reload_doc = PR_FALSE;
-
-  PRUint32 argc;
-
-  ncc->GetArgc(&argc);
-
-  if (argc > 0) {
-    jsval *argv = nsnull;
-
-    ncc->GetArgvPtr(&argv);
-    NS_ENSURE_TRUE(argv, NS_ERROR_UNEXPECTED);
-
-    JSContext *cx = nsnull;
-
-    rv = ncc->GetJSContext(&cx);
-    NS_ENSURE_SUCCESS(rv, rv);
-
-    JSAutoRequest ar(cx);
-    JS_ValueToBoolean(cx, argv[0], &reload_doc);
-  }
-
-  return Refresh(reload_doc);
-}
-
 nsresult
 nsPluginArray::GetPlugins()
 {
   nsresult rv = GetLength(&mPluginCount);
   if (NS_SUCCEEDED(rv)) {
diff -r f3ac957eb4af dom/src/base/nsPluginArray.h
--- a/dom/src/base/nsPluginArray.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/src/base/nsPluginArray.h	Sat Sep 06 10:14:36 2008 +0300
@@ -45,24 +45,20 @@
 
 class nsNavigator;
 class nsIDocShell;
 class nsIPluginHost;
 
-class nsPluginArray : public nsIDOMPluginArray,
-                      public nsIDOMJSPluginArray
+class nsPluginArray : public nsIDOMPluginArray
 {
 public:
   nsPluginArray(nsNavigator* navigator, nsIDocShell *aDocShell);
   virtual ~nsPluginArray();
 
   NS_DECL_ISUPPORTS
 
   // nsIDOMPluginArray
   NS_DECL_NSIDOMPLUGINARRAY
-
-  // nsIDOMJSPluginArray
-  NS_DECL_NSIDOMJSPLUGINARRAY
 
   nsresult GetPluginHost(nsIPluginHost** aPluginHost);
 
 private:
   nsresult GetPlugins();
diff -r f3ac957eb4af dom/src/threads/nsDOMWorkerBase.cpp
--- a/dom/src/threads/nsDOMWorkerBase.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/src/threads/nsDOMWorkerBase.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -127,27 +127,20 @@ nsDOMWorkerBase::PostMessageInternal(con
 }
 
 nsresult
 nsDOMWorkerBase::PostMessageInternal(const nsAString& aMessage)
 {
-  nsAXPCNativeCallContext* ncc;
-  nsresult rv = nsContentUtils::XPConnect()->
-    GetCurrentNativeCallContext(&ncc);
-  NS_ENSURE_SUCCESS(rv, rv);
+  nsRefPtr<nsDOMWorkerBase> source;
+  JSContext *cx = nsContentUtils::GetCurrentJSContext();
 
-  nsRefPtr<nsDOMWorkerBase> source;
-  if (ncc) {
+  if (cx) {
     if (NS_IsMainThread()) {
       // Must be a normal DOM context, use the pool as the source.
       source = Pool();
     }
     else {
       // Must be a worker context, get the worker from the context private.
-      JSContext* cx;
-      rv = ncc->GetJSContext(&cx);
-      NS_ENSURE_SUCCESS(rv, rv);
-
       nsRefPtr<nsDOMWorkerThread> worker =
         (nsDOMWorkerThread*)JS_GetContextPrivate(cx);
 
       // Only allowed to communicate to other threads in the same pool.
       nsRefPtr<nsDOMWorkerPool> sourcePool = worker->Pool();
@@ -158,11 +151,11 @@ nsDOMWorkerBase::PostMessageInternal(con
   }
   else {
     source = this;
   }
 
-  rv = PostMessageInternal(aMessage, source);
+  nsresult rv = PostMessageInternal(aMessage, source);
   NS_ENSURE_SUCCESS(rv, rv);
 
   return NS_OK;
 }
 
diff -r f3ac957eb4af dom/src/threads/nsDOMWorkerPool.cpp
--- a/dom/src/threads/nsDOMWorkerPool.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/src/threads/nsDOMWorkerPool.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -98,21 +98,14 @@ nsresult
 nsresult
 nsDOMWorkerPool::Init()
 {
   NS_ASSERTION(NS_IsMainThread(), "Wrong thread!");
 
-  nsAXPCNativeCallContext* ncc;
-  nsresult rv = nsContentUtils::XPConnect()->GetCurrentNativeCallContext(&ncc);
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  // GetCurrentNativeCallContext can return NS_OK and still hand out a null
-  // context... We shouldn't ever see that here.
-  NS_ENSURE_TRUE(ncc, NS_ERROR_UNEXPECTED);
-
-  JSContext* cx;
-  rv = ncc->GetJSContext(&cx);
-  NS_ENSURE_SUCCESS(rv, rv);
+  // GetCurrentJSContext () can return a null context... We shouldn't
+  // ever see that here.
+  JSContext* cx = nsContentUtils::GetCurrentJSContext();
+  NS_ENSURE_TRUE(cx, NS_ERROR_UNEXPECTED);
 
   nsIScriptContext* scriptContext = GetScriptContextFromJSContext(cx);
   NS_ENSURE_STATE(scriptContext);
 
   nsIScriptGlobalObject* globalObject = scriptContext->GetGlobalObject();
diff -r f3ac957eb4af dom/src/threads/nsDOMWorkerThread.cpp
--- a/dom/src/threads/nsDOMWorkerThread.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/src/threads/nsDOMWorkerThread.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -561,11 +561,13 @@ nsDOMWorkerThread::CompileGlobalObject(J
   success = JS_DefineProperty(aCx, global, "threadContext",
                               OBJECT_TO_JSVAL(contextObj), nsnull, nsnull,
                               JSPROP_ENUMERATE);
   NS_ENSURE_TRUE(success, PR_FALSE);
 
-  JSScript* script = JS_CompileUCScript(aCx, global, mSource.BeginReading(),
+  JSScript* script = JS_CompileUCScript(aCx, global,
+                                        reinterpret_cast<const jschar*>
+                                            (mSource.BeginReading()),
                                         mSource.Length(), nsnull, 1);
   NS_ENSURE_TRUE(script, PR_FALSE);
 
   JSRuntime* rt;
   rv = nsDOMThreadService::JSRuntimeService()->GetRuntime(&rt);
diff -r f3ac957eb4af dom/tests/mochitest/geolocation/Makefile.in
--- a/dom/tests/mochitest/geolocation/Makefile.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/tests/mochitest/geolocation/Makefile.in	Sat Sep 06 10:14:36 2008 +0300
@@ -45,10 +45,16 @@ include $(topsrcdir)/config/rules.mk
 include $(topsrcdir)/config/rules.mk
 
 _TEST_FILES	= \
 		test_lastPosition.html \
 		test_manyWindows.html \
+		test_allowCurrent.html \
+		test_allowWatch.html \
+		test_cancelCurrent.html \
+		test_cancelWatch.html \
+		test_clearWatch.html \
+		test_geoPrompt.html \
 		prompt_common.js       \
 		geolocation_common.js  \
 		geolocation.html \
 		test_optional_api_params.html \
 		$(NULL)
diff -r f3ac957eb4af dom/tests/mochitest/geolocation/geolocation_common.js
--- a/dom/tests/mochitest/geolocation/geolocation_common.js	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/tests/mochitest/geolocation/geolocation_common.js	Sat Sep 06 10:14:36 2008 +0300
@@ -1,16 +1,127 @@ function check_geolocation(location) {
+// defines for prompt - button position
+const ACCEPT = 0;
+const ACCEPT_FUZZ = 1;
+const DECLINE = 2;
+
+/* Set if testLocationProvider is registered as geolocation provider.
+ * To register, copy testLocationProvider.js to components directory 
+ * and remove from directory when done. 
+ */
+var TEST_PROVIDER = 0; 
+
+// set if there should be a delay before prompt is accepted
+var DELAYED_PROMPT = 0;
+
+var prompt_delay = timeout * 2;
+
+// the prompt that was registered at runtime
+var old_prompt;
+
+// whether the prompt was accepted
+var prompted = 0;
+
+// which prompt option to select when prompt is fired
+var promptOption;
+
+// number of position changes for testLocationProvider to make
+var num_pos_changes = 3;
+
+ // based on testLocationProvider's interval
+var timer_interval = 500;
+var slack = 500;
+
+// time needed for provider to make position changes
+var timeout = num_pos_changes * timer_interval + slack;
+
 function check_geolocation(location) {
 
   ok(location, "Check to see if this location is non-null");
 
-  ok(location.latitude, "Check to see if there is a latitude");
-  ok(location.longitude, "Check to see if there is a longitude");
-  ok(location.altitude, "Check to see if there is a altitude");
-  ok(location.accuracy, "Check to see if there is a accuracy");
-  ok(location.altitudeAccuracy, "Check to see if there is a alt accuracy");
-
-  ok(location.heading, "Check to see if there is a heading");
-  ok(location.velocity, "Check to see if there is a velocity");
-
-  ok(location.timestamp, "Check to see if there is a timestamp");
+  ok("latitude" in location, "Check to see if there is a latitude");
+  ok("longitude" in location, "Check to see if there is a longitude");
+  ok("altitude" in location, "Check to see if there is a altitude");
+  ok("accuracy" in location, "Check to see if there is a accuracy");
+  ok("altitudeAccuracy" in location, "Check to see if there is a alt accuracy");
+  ok("heading" in location, "Check to see if there is a heading");
+  ok("velocity" in location, "Check to see if there is a velocity");
+  ok("timestamp" in location, "Check to see if there is a timestamp");
 
 }
+
+//TODO: test for fuzzed location when this is implemented
+function check_fuzzed_geolocation(location) {
+  check_geolocation(location);
+}
+
+function check_no_geolocation(location) {
+   ok(!location, "Check to see if this location is null");
+}
+
+function checkFlags(flags, value, isExact) {
+  for(var i = 0; i < flags.length; i++)
+    ok(isExact ? flags[i] == value : flags[i] >= value, "ensure callbacks called " + value + " times");
+}
+
+function success_callback(position) {
+  if(prompted == 0)
+    ok(0, "Should not call success callback before prompt accepted");
+  if(position == null)
+    ok(1, "No geolocation available");
+  else {
+    switch(promptOption) {
+      case ACCEPT:
+        check_geolocation(position);
+        break;
+      case ACCEPT_FUZZ:
+        check_fuzzed_geolocation(position);
+        break;
+      case DECLINE:
+        check_no_geolocation(position);
+        break;
+      default:
+        break;
+    }
+  }
+}
+
+function geolocation_prompt(request) {
+  netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
+	prompted = 1;
+  switch(promptOption) {
+    case ACCEPT:
+      request.allow();
+      break;
+    case ACCEPT_FUZZ:
+      request.allowButFuzz();
+      break;
+    case DECLINE:
+      request.cancel();
+      break;
+    default:
+      break;
+  }
+  return 1;
+}
+
+function delayed_prompt(request) {
+  setTimeout(geolocation_prompt, prompt_delay, request);
+}
+
+function attachPrompt() {
+  netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
+  var geolocationService = Components.classes["@mozilla.org/geolocation/service;1"]
+                           .getService(Components.interfaces.nsIGeolocationService);
+  old_prompt = geolocationService.prompt;
+
+	if(DELAYED_PROMPT)
+    geolocationService.prompt = delayed_prompt;
+  else
+    geolocationService.prompt = geolocation_prompt;
+}
+
+function removePrompt() {
+  netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
+  var geolocationService = Components.classes["@mozilla.org/geolocation/service;1"]
+                           .getService(Components.interfaces.nsIGeolocationService);
+  geolocationService.prompt = old_prompt;
+}
diff -r f3ac957eb4af dom/tests/mochitest/geolocation/testLocationProvider.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/dom/tests/mochitest/geolocation/testLocationProvider.js	Sat Sep 06 10:14:36 2008 +0300
@@ -0,0 +1,79 @@
+Components.utils.import("resource://gre/modules/XPCOMUtils.jsm");
+
+const Ci = Components.interfaces;
+const Cc = Components.classes;
+
+function GeolocationObject() {};
+GeolocationObject.prototype = {
+
+    QueryInterface:   XPCOMUtils.generateQI([Ci.nsIDOMGeolocation, Ci.nsIClassInfo, Ci.nsIGeolocationPrompt]),
+
+    // Class Info is required to be able to pass objects back into the DOM.
+    
+    getInterfaces: function(countRef) {
+        var interfaces = [Ci.nsIDOMGeolocation, Ci.nsIClassInfo, Ci.nsISupports, Ci.nsIGeolocationPrompt];
+        countRef.value = interfaces.length;
+        return interfaces;
+    },
+    getHelperForLanguage: function(language) null,
+    contractID: "",
+    classDescription: "geolocation object",
+    classID: null,
+    implementationLanguage: Ci.nsIProgrammingLanguage.JAVASCRIPT,
+    flags: Ci.nsIClassInfo.DOM_OBJECT,
+
+    latitude: 1,
+    longitude: 1,
+    altitude: 1,
+    horizontalAccuracy: 1,
+    verticalAccuracy: 1,
+    timestamp: 1,
+
+    prompt: function(uri) {return 1;},
+};
+
+function dump(msg) {
+    var consoleService = Components.classes["@mozilla.org/consoleservice;1"].getService(Ci.nsIConsoleService);
+    consoleService.logStringMessage("mylocation: " + msg);
+}
+
+function MyLocation() {};
+MyLocation.prototype = {
+    classDescription: "A component that returns a geolocation",
+    classID:          Components.ID("{10F622A4-6D7F-43A1-A938-5FFCBE2B1D1D}"),
+    contractID:       "@mozilla.org/geolocation/provider;1",
+    QueryInterface:   XPCOMUtils.generateQI([Ci.nsIGeolocationProvider]),
+  
+    geolocation:     null,
+    timer:           null,
+    timerInterval:   500,
+
+    startup:         function() { dump("startup");},
+    isReady:         function() { dump("isReady"); return true},
+    watch:           function(c) { 
+                        var watchCallback = {
+                            notify: function(timer) {
+	                            c.update(this.parent.currentLocation);
+	                          }
+                        };
+                        watchCallback.parent = this;
+
+                        if(!this.timer)
+                           this.timer = Cc["@mozilla.org/timer;1"].createInstance(Ci.nsITimer);
+                        this.timer.initWithCallback(watchCallback, this.timerInterval, 
+                           Ci.nsITimer.TYPE_REPEATING_SLACK);
+                     },
+
+    currentLocation: new GeolocationObject(),
+    shutdown:        function() { 
+                       dump("shutdown"); 
+                       if(this.timer)
+                         this.timer.cancel();
+                     },
+};
+
+var components = [MyLocation];
+function NSGetModule(compMgr, fileSpec) {
+  return XPCOMUtils.generateModule(components);
+}
+
diff -r f3ac957eb4af dom/tests/mochitest/geolocation/test_allowCurrent.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/dom/tests/mochitest/geolocation/test_allowCurrent.html	Sat Sep 06 10:14:36 2008 +0300
@@ -0,0 +1,65 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=
+-->
+<head>
+  <title>Test for getCurrentPosition </title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="text/javascript" src="prompt_common.js"></script>
+  <script type="text/javascript" src="geolocation_common.js"></script>
+
+<link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=">Mozilla Bug </a>
+<p id="display"></p>
+<div id="content" style="display: none">
+  
+</div>
+<pre id="test">
+<script class="testbody" type="text/javascript">
+
+var numCallbacks = 5;
+var callbackCounter = new Array(numCallbacks);
+
+// define success callbacks
+for(var i = 0; i < numCallbacks; i++) {
+  eval("function successCallback" + i + "(position) {" +
+          "callbackCounter[" + i + "]++;" +
+          "success_callback(position);" +
+       "}"
+  );
+}
+
+function testAccepted() {
+  if(TEST_PROVIDER)
+    checkFlags(callbackCounter, 1, true);
+  removePrompt();
+  SimpleTest.finish();
+}
+
+/** Test for Bug  **/
+
+SimpleTest.waitForExplicitFinish();
+
+attachPrompt();
+
+ok(navigator.geolocation, "Ensure that the geolocation object is present");
+
+promptOption = ACCEPT;
+
+// one-shot position requests
+for(var i = 0; i < numCallbacks; i++) {
+  eval("navigator.geolocation.getCurrentPosition(successCallback" + i + ", null, null);");
+}
+
+// wait for position change
+setTimeout(testAccepted, timeout);
+
+</script>
+</pre>
+</body>
+</html>
+
diff -r f3ac957eb4af dom/tests/mochitest/geolocation/test_allowWatch.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/dom/tests/mochitest/geolocation/test_allowWatch.html	Sat Sep 06 10:14:36 2008 +0300
@@ -0,0 +1,77 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=
+-->
+<head>
+  <title>Test for watchPosition </title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="text/javascript" src="prompt_common.js"></script>
+  <script type="text/javascript" src="geolocation_common.js"></script>
+
+<link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=">Mozilla Bug </a>
+<p id="display"></p>
+<div id="content" style="display: none">
+  
+</div>
+<pre id="test">
+<script class="testbody" type="text/javascript">
+
+var numCallbacks = 5;
+var callbackCounter = new Array(numCallbacks);
+var watchID = new Array(numCallbacks);
+
+// define success callbacks
+for(var i = 0; i < numCallbacks; i++) {
+  eval("function successCallback" + i + "(position) {" +
+          "callbackCounter[" + i + "]++;" +
+          "success_callback(position);" +
+       "}"
+  );
+}
+
+function registerWatches() {
+  for(var i = 0; i < numCallbacks; i++) {
+    watchID[i] = eval("navigator.geolocation.watchPosition(successCallback"
+                       + i + ", null, null);"
+    );
+  }
+}
+
+function clearWatches() {
+  for(var i = 0; i < numCallbacks; i++)
+    navigator.geolocation.clearWatch(watchID[i]);
+}
+
+function testAccepted() {
+  if(TEST_PROVIDER)
+    checkFlags(callbackCounter, num_pos_changes, false);
+  clearWatches();
+  removePrompt();
+  SimpleTest.finish();
+}
+
+/** Test for Bug  **/
+
+SimpleTest.waitForExplicitFinish();
+
+attachPrompt();
+
+ok(navigator.geolocation, "Ensure that the geolocation object is present");
+
+promptOption = ACCEPT;
+
+registerWatches();
+
+// wait for position changes
+setTimeout(testAccepted, timeout);
+
+</script>
+</pre>
+</body>
+</html>
+
diff -r f3ac957eb4af dom/tests/mochitest/geolocation/test_cancelCurrent.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/dom/tests/mochitest/geolocation/test_cancelCurrent.html	Sat Sep 06 10:14:36 2008 +0300
@@ -0,0 +1,63 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=
+-->
+<head>
+  <title>Test for getCurrentPosition </title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="text/javascript" src="prompt_common.js"></script>
+  <script type="text/javascript" src="geolocation_common.js"></script>
+
+<link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=">Mozilla Bug </a>
+<p id="display"></p>
+<div id="content" style="display: none">
+  
+</div>
+<pre id="test">
+<script class="testbody" type="text/javascript">
+
+var numCallbacks = 5;
+var callbackCounter = new Array(numCallbacks);
+
+// define success callbacks
+for(var i = 0; i < numCallbacks; i++) {
+  eval("function successCallback" + i + "(position) {" +
+          "callbackCounter[" + i + "]++;" +
+          "success_callback(position);" +
+       "}"
+  );
+}
+
+function testDeclined() {
+  removePrompt();
+  SimpleTest.finish();
+}
+
+/** Test for Bug  **/
+
+SimpleTest.waitForExplicitFinish();
+
+attachPrompt();
+
+ok(navigator.geolocation, "Ensure that the geolocation object is present");
+
+promptOption = DECLINE;
+
+// one-shot position requests
+for(var i = 0; i < numCallbacks; i++) {
+  eval("navigator.geolocation.getCurrentPosition(successCallback" + i + ", null, null);");
+}
+
+// wait for position change
+setTimeout(testDeclined, timeout);
+
+</script>
+</pre>
+</body>
+</html>
+
diff -r f3ac957eb4af dom/tests/mochitest/geolocation/test_cancelWatch.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/dom/tests/mochitest/geolocation/test_cancelWatch.html	Sat Sep 06 10:14:36 2008 +0300
@@ -0,0 +1,77 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=
+-->
+<head>
+  <title>Test for watchPosition </title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="text/javascript" src="prompt_common.js"></script>
+  <script type="text/javascript" src="geolocation_common.js"></script>
+
+<link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=">Mozilla Bug </a>
+<p id="display"></p>
+<div id="content" style="display: none">
+  
+</div>
+<pre id="test">
+<script class="testbody" type="text/javascript">
+
+var numCallbacks = 5;
+var callbackCounter = new Array(numCallbacks);
+var watchID = new Array(numCallbacks);
+
+// define success callbacks
+for(var i = 0; i < numCallbacks; i++) {
+  eval("function successCallback" + i + "(position) {" +
+          "callbackCounter[" + i + "]++;" +
+          "success_callback(position);" +
+       "}"
+  );
+}
+
+function registerWatches() {
+  for(var i = 0; i < numCallbacks; i++) {
+    watchID[i] = eval("navigator.geolocation.watchPosition(successCallback"
+                       + i + ", null, null);"
+    );
+  }
+}
+
+function clearWatches() {
+  for(var i = 0; i < numCallbacks; i++)
+    navigator.geolocation.clearWatch(watchID[i]);
+}
+
+function testDeclined() {
+  clearWatches();
+  removePrompt();
+  SimpleTest.finish();
+}
+
+/** Test for Bug  **/
+
+SimpleTest.waitForExplicitFinish();
+
+attachPrompt();
+
+ok(navigator.geolocation, "Ensure that the geolocation object is present");
+
+promptOption = DECLINE;
+
+registerWatches();
+
+// wait for position changes
+setTimeout(testDeclined, timeout);
+
+</script>
+</pre>
+</body>
+</html>
+
+
+
diff -r f3ac957eb4af dom/tests/mochitest/geolocation/test_clearWatch.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/dom/tests/mochitest/geolocation/test_clearWatch.html	Sat Sep 06 10:14:36 2008 +0300
@@ -0,0 +1,89 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=
+-->
+<head>
+  <title>Test for watchPosition and clearWatch</title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="text/javascript" src="prompt_common.js"></script>
+  <script type="text/javascript" src="geolocation_common.js"></script>
+
+<link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=">Mozilla Bug </a>
+<p id="display"></p>
+<div id="content" style="display: none">
+  
+</div>
+<pre id="test">
+<script class="testbody" type="text/javascript">
+
+var numCallbacks = 5;
+var callbackCounter = new Array(numCallbacks);
+var watchID = new Array(numCallbacks);
+
+// define success callbacks
+for(var i = 0; i < numCallbacks; i++) {
+  eval("function successCallback" + i + "(position) {" +
+          "callbackCounter[" + i + "]++;" +
+          "success_callback(position);" +
+       "}"
+  );
+}
+
+function registerWatches() {
+  for(var i = 0; i < numCallbacks; i++) {
+    watchID[i] = eval("navigator.geolocation.watchPosition(successCallback"
+                       + i + ", null, null);"
+    );
+  }
+}
+
+function clearWatches() {
+  for(var i = 0; i < numCallbacks; i++)
+    navigator.geolocation.clearWatch(watchID[i]);
+}
+
+function testAccepted() {
+  if(TEST_PROVIDER)
+    checkFlags(callbackCounter, num_pos_changes, false);
+  clearWatches();
+  setTimeout(clearAll, timeout); // now clear flags
+}
+
+function clearAll() {
+  for(var i = 0; i < numCallbacks; i++)
+    callbackCounter[i] = 0;
+  setTimeout(testCleared, timeout); // check to see if watches were cleared
+}
+
+function testCleared() {
+  checkFlags(callbackCounter, 0, true);
+  removePrompt();
+  SimpleTest.finish();
+}
+
+
+
+/** Test for Bug  **/
+
+SimpleTest.waitForExplicitFinish();
+
+attachPrompt();
+
+ok(navigator.geolocation, "Ensure that the geolocation object is present");
+
+promptOption = ACCEPT;
+
+registerWatches();
+
+// wait for position changes
+setTimeout(testAccepted, timeout);
+
+</script>
+</pre>
+</body>
+</html>
diff -r f3ac957eb4af dom/tests/mochitest/geolocation/test_geoPrompt.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/dom/tests/mochitest/geolocation/test_geoPrompt.html	Sat Sep 06 10:14:36 2008 +0300
@@ -0,0 +1,54 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=
+-->
+<head>
+  <title>Test for geolocation prompt </title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="text/javascript" src="prompt_common.js"></script>
+  <script type="text/javascript" src="geolocation_common.js"></script>
+
+<link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=">Mozilla Bug </a>
+<p id="display"></p>
+<div id="content" style="display: none">
+  
+</div>
+<pre id="test">
+<script class="testbody" type="text/javascript">
+
+function testPrompt() {
+  removePrompt();
+  SimpleTest.finish();
+}
+
+/** Test for Bug  **/
+
+SimpleTest.waitForExplicitFinish();
+
+DELAYED_PROMPT = 1;
+
+attachPrompt();
+
+ok(navigator.geolocation, "Ensure that the geolocation object is present");
+
+promptOption = ACCEPT;
+
+// try get current
+navigator.geolocation.getCurrentPosition(success_callback, null, null);
+
+// try watch position
+navigator.geolocation.watchPosition(success_callback, null, null);
+
+// wait for position change
+setTimeout(testPrompt, timeout);
+
+</script>
+</pre>
+</body>
+</html>
+
diff -r f3ac957eb4af dom/tests/mochitest/geolocation/test_optional_api_params.html
--- a/dom/tests/mochitest/geolocation/test_optional_api_params.html	Thu Sep 04 12:36:46 2008 -0400
+++ b/dom/tests/mochitest/geolocation/test_optional_api_params.html	Sat Sep 06 10:14:36 2008 +0300
@@ -5,10 +5,12 @@ https://bugzilla.mozilla.org/show_bug.cg
 -->
 <head>
   <title>Test for Bug 452566</title>
   <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
   <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="text/javascript" src="prompt_common.js"></script>
+  <script type="text/javascript" src="geolocation_common.js"></script>
   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
 </head>
 <body>
 <a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=452566">Mozilla Bug 452566</a>
 <p id="display"></p>
@@ -21,10 +23,13 @@ https://bugzilla.mozilla.org/show_bug.cg
 /** Test for Bug 452566 **/
 
 const NOT_ENOUGH_ARGS = 2153185281;
 
 ok(navigator.geolocation, "Should have geolocation");
+
+attachPrompt();
+promptOption = ACCEPT;
 
 var exception = null;
 try {
   navigator.geolocation.getCurrentPosition();
 } catch(ex) {
@@ -102,10 +107,12 @@ try {
     exception = ex;
   }
 }
 ok(!exception, exception);
 
+removePrompt();
+
 </script>
 </pre>
 </body>
 </html>
 
diff -r f3ac957eb4af editor/libeditor/html/nsHTMLEditor.cpp
--- a/editor/libeditor/html/nsHTMLEditor.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/editor/libeditor/html/nsHTMLEditor.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -4268,36 +4268,10 @@ nsHTMLEditor::SelectAll()
 #pragma mark -
 #pragma mark  Random methods 
 #pragma mark -
 #endif
 
-
-NS_IMETHODIMP nsHTMLEditor::GetLayoutObject(nsIDOMNode *aNode, nsISupports **aLayoutObject)
-{
-  nsresult result = NS_ERROR_FAILURE;  // we return an error unless we get the index
-  if (!mPresShellWeak) return NS_ERROR_NOT_INITIALIZED;
-  nsCOMPtr<nsIPresShell> ps = do_QueryReferent(mPresShellWeak);
-  if (!ps) return NS_ERROR_NOT_INITIALIZED;
-
-  if ((nsnull!=aNode))
-  { // get the content interface
-    nsCOMPtr<nsIContent> nodeAsContent( do_QueryInterface(aNode) );
-    if (nodeAsContent)
-    { // get the frame from the content interface
-      //Note: frames are not ref counted, so don't use an nsCOMPtr
-      *aLayoutObject = nsnull;
-      result = ps->GetLayoutObjectFor(nodeAsContent, aLayoutObject);
-    }
-  }
-  else {
-    result = NS_ERROR_NULL_POINTER;
-  }
-
-  return result;
-}
-
-
 // this will NOT find aAttribute unless aAttribute has a non-null value
 // so singleton attributes like <Table border> will not be matched!
 void nsHTMLEditor::IsTextPropertySetByContent(nsIDOMNode        *aNode,
                                               nsIAtom           *aProperty, 
                                               const nsAString   *aAttribute, 
diff -r f3ac957eb4af editor/libeditor/html/nsHTMLEditor.h
--- a/editor/libeditor/html/nsHTMLEditor.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/editor/libeditor/html/nsHTMLEditor.h	Sat Sep 06 10:14:36 2008 +0300
@@ -455,18 +455,10 @@ protected:
   // used to style elements in the editor. Note that the editor is only CSS
   // aware by default in Composer and in the mail editor.
   void UpdateForFlags(PRUint32 aFlags) {
     mCSSAware = ((aFlags & (eEditorNoCSSMask | eEditorMailMask)) == 0);
   }
-
-  /** returns the layout object (nsIFrame in the real world) for aNode
-    * @param aNode          the content to get a frame for
-    * @param aLayoutObject  the "primary frame" for aNode, if one exists.  May be null
-    * @return NS_OK whether a frame is found or not
-    *         an error if some serious error occurs
-    */
-  NS_IMETHOD GetLayoutObject(nsIDOMNode *aInNode, nsISupports **aOutLayoutObject);
 
   // Return TRUE if aElement is a table-related elemet and caret was set
   PRBool SetCaretInTableCell(nsIDOMElement* aElement);
   PRBool IsElementInBody(nsIDOMElement* aElement);
 
diff -r f3ac957eb4af editor/libeditor/html/nsTableEditor.cpp
--- a/editor/libeditor/html/nsTableEditor.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/editor/libeditor/html/nsTableEditor.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -43,10 +43,12 @@
 #include "nsIDOMElement.h"
 #include "nsIDOMAttr.h"
 #include "nsIDOMNode.h"
 #include "nsIDOMNodeList.h"
 #include "nsIDOMRange.h"
+#include "nsIFrame.h"
+#include "nsIPresShell.h"
 #include "nsISelection.h"
 #include "nsISelectionPrivate.h"
 #include "nsLayoutCID.h"
 #include "nsIContent.h"
 #include "nsIContentIterator.h"
@@ -2716,13 +2718,18 @@ nsHTMLEditor::GetCellIndexes(nsIDOMEleme
       aCell = cell;
     else
       return NS_ERROR_FAILURE;
   }
 
-  nsISupports *layoutObject=nsnull; // frames are not ref counted, so don't use an nsCOMPtr
-  res = nsHTMLEditor::GetLayoutObject(aCell, &layoutObject);
-  if (NS_FAILED(res)) return res;
+  if (!mPresShellWeak) return NS_ERROR_NOT_INITIALIZED;
+  nsCOMPtr<nsIPresShell> ps = do_QueryReferent(mPresShellWeak);
+  if (!ps) return NS_ERROR_NOT_INITIALIZED;
+
+  nsCOMPtr<nsIContent> nodeAsContent( do_QueryInterface(aCell) );
+  if (!nodeAsContent) return NS_ERROR_FAILURE;
+  // frames are not ref counted, so don't use an nsCOMPtr
+  nsIFrame *layoutObject = ps->GetPrimaryFrameFor(nodeAsContent);
   if (!layoutObject)  return NS_ERROR_FAILURE;
 
   nsITableCellLayout *cellLayoutObject=nsnull; // again, frames are not ref-counted
   res = layoutObject->QueryInterface(NS_GET_IID(nsITableCellLayout), (void**)(&cellLayoutObject));
   if (NS_FAILED(res)) return res;
@@ -2732,18 +2739,21 @@ nsHTMLEditor::GetCellIndexes(nsIDOMEleme
 
 NS_IMETHODIMP
 nsHTMLEditor::GetTableLayoutObject(nsIDOMElement* aTable, nsITableLayout **tableLayoutObject)
 {
   *tableLayoutObject=nsnull;
-  if (!aTable)
-    return NS_ERROR_NOT_INITIALIZED;
-  
+  if (!aTable) return NS_ERROR_NOT_INITIALIZED;
+  if (!mPresShellWeak) return NS_ERROR_NOT_INITIALIZED;
+  nsCOMPtr<nsIPresShell> ps = do_QueryReferent(mPresShellWeak);
+  if (!ps) return NS_ERROR_NOT_INITIALIZED;
+
+  nsCOMPtr<nsIContent> nodeAsContent( do_QueryInterface(aTable) );
+  if (!nodeAsContent) return NS_ERROR_FAILURE;
   // frames are not ref counted, so don't use an nsCOMPtr
-  nsISupports *layoutObject=nsnull;
-  nsresult res = GetLayoutObject(aTable, &layoutObject); 
-  if (NS_FAILED(res)) return res;
+  nsIFrame *layoutObject = ps->GetPrimaryFrameFor(nodeAsContent);
   if (!layoutObject)  return NS_ERROR_FAILURE;
+
   return layoutObject->QueryInterface(NS_GET_IID(nsITableLayout), 
                                       (void**)(tableLayoutObject)); 
 }
 
 //Return actual number of cells (a cell with colspan > 1 counts as just 1)
diff -r f3ac957eb4af editor/libeditor/text/nsPlaintextEditor.cpp
--- a/editor/libeditor/text/nsPlaintextEditor.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/editor/libeditor/text/nsPlaintextEditor.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -1808,35 +1808,10 @@ nsPlaintextEditor::SelectEntireDocument(
 #pragma mark -
 #pragma mark  Random methods 
 #pragma mark -
 #endif
 
-
-NS_IMETHODIMP nsPlaintextEditor::GetLayoutObject(nsIDOMNode *aNode, nsISupports **aLayoutObject)
-{
-  nsCOMPtr<nsIPresShell> ps = do_QueryReferent(mPresShellWeak);
-  if (!ps) return NS_ERROR_NOT_INITIALIZED;
-
-  nsresult result = NS_ERROR_NULL_POINTER;
-  if (aNode)
-  { // get the content interface
-    nsCOMPtr<nsIContent> nodeAsContent( do_QueryInterface(aNode) );
-    if (nodeAsContent)
-    { // get the frame from the content interface
-      //Note: frames are not ref counted, so don't use an nsCOMPtr
-      *aLayoutObject = nsnull;
-      result = ps->GetLayoutObjectFor(nodeAsContent, aLayoutObject);
-    }
-  }
-
-  return result;
-}
-
-#ifdef XP_MAC
-#pragma mark -
-#endif
-
 nsresult
 nsPlaintextEditor::SetAttributeOrEquivalent(nsIDOMElement * aElement,
                                             const nsAString & aAttribute,
                                             const nsAString & aValue,
                                             PRBool aSuppressTransaction)
diff -r f3ac957eb4af editor/libeditor/text/nsPlaintextEditor.h
--- a/editor/libeditor/text/nsPlaintextEditor.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/editor/libeditor/text/nsPlaintextEditor.h	Sat Sep 06 10:14:36 2008 +0300
@@ -171,17 +171,10 @@ protected:
   nsresult    EndEditorInit();
 
   // Create the event listeners for the editor to install.
   virtual nsresult CreateEventListeners();
 
-  /** returns the layout object (nsIFrame in the real world) for aNode
-    * @param aNode          the content to get a frame for
-    * @param aLayoutObject  the "primary frame" for aNode, if one exists.  May be null
-    * @return NS_OK whether a frame is found or not
-    *         an error if some serious error occurs
-    */
-  NS_IMETHOD GetLayoutObject(nsIDOMNode *aInNode, nsISupports **aOutLayoutObject);
   // Helpers for output routines
   NS_IMETHOD GetAndInitDocEncoder(const nsAString& aFormatType,
                                   PRUint32 aFlags,
                                   const nsACString& aCharset,
                                   nsIDocumentEncoder** encoder);
diff -r f3ac957eb4af extensions/auth/nsAuthSSPI.cpp
--- a/extensions/auth/nsAuthSSPI.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/extensions/auth/nsAuthSSPI.cpp	Sat Sep 06 10:14:36 2008 +0300
@@ -68,14 +68,14 @@
 #define SECBUFFER_STREAM 10
 #endif
 
 //-----------------------------------------------------------------------------
 
-static const char *const pTypeName [] = {
-    "Kerberos",
-    "Negotiate",
-    "NTLM"
+static const PRUnichar *const pTypeName [] = {
+    L"Kerberos",
+    L"Negotiate",
+    L"NTLM"
 };
 
 #ifdef DEBUG
 #define CASE_(_x) case _x: return # _x;
 static const char *MapErrorCode(int rc)
@@ -267,18 +267,18 @@ nsAuthSSPI::Init(const char *serviceName
     (sspi->FreeContextBuffer)(pinfo);
 
     TimeStamp useBefore;
 
     rc = (sspi->AcquireCredentialsHandleW)(NULL,
-                                          package,
-                                          SECPKG_CRED_OUTBOUND,
-                                          NULL,
-                                          NULL,
-                                          NULL,
-                                          NULL,
-                                          &mCred,
-                                          &useBefore);
+                                           package,
+                                           SECPKG_CRED_OUTBOUND,
+                                           NULL,
+                                           NULL,
+                                           NULL,
+                                           NULL,
+                                           &mCred,
+                                           &useBefore);
     if (rc != SEC_E_OK)
         return NS_ERROR_UNEXPECTED;
 
     return NS_OK;
 }
@@ -334,28 +334,30 @@ nsAuthSSPI::GetNextToken(const void *inT
     ob.cbBuffer = mMaxTokenLen;
     ob.pvBuffer = nsMemory::Alloc(ob.cbBuffer);
     if (!ob.pvBuffer)
         return NS_ERROR_OUT_OF_MEMORY;
     memset(ob.pvBuffer, 0, ob.cbBuffer);
+
+    NS_ConvertUTF8toUTF16 wSN(mServiceName);
     SEC_WCHAR *sn;
     if (mPackage == PACKAGE_TYPE_NTLM)
         sn = NULL;
     else
-        sn = (SEC_WCHAR *) mServiceName.get();
+        sn = (SEC_WCHAR *) wSN.get();
 
     rc = (sspi->InitializeSecurityContextW)(&mCred,
-                                           ctxIn,
-                                           sn,
-                                           ctxReq,
-                                           0,
-                                           SECURITY_NATIVE_DREP,
-                                           inToken ? &ibd : NULL,
-                                           0,
-                                           &mCtxt,
-                                           &obd,
-                                           &ctxAttr,
-                                           &ignored);
+                                            ctxIn,
+                                            sn,
+                                            ctxReq,
+                                            0,
+                                            SECURITY_NATIVE_DREP,
+                                            inToken ? &ibd : NULL,
+                                            0,
+                                            &mCtxt,
+                                            &obd,
+                                            &ctxAttr,
+                                            &ignored);
     if (rc == SEC_I_CONTINUE_NEEDED || rc == SEC_E_OK) {
         if (!ob.cbBuffer) {
             nsMemory::Free(ob.pvBuffer);
             ob.pvBuffer = NULL;
         }
diff -r f3ac957eb4af js/src/Makefile.in
--- a/js/src/Makefile.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/Makefile.in	Sat Sep 06 10:14:37 2008 +0300
@@ -160,11 +160,10 @@ EXPORTS		= \
 		jsbit.h \
 		jsbool.h \
 		jsclist.h \
 		jscntxt.h \
 		jscompat.h \
-		jsconfig.h \
 		jsdate.h \
 		jsdbgapi.h \
 		jsdhash.h \
 		jsdtoa.h \
 		jsemit.h \
@@ -193,10 +192,11 @@ EXPORTS		= \
 		jsstddef.h \
 		jsstr.h \
 		jstracer.h \
 		jstypes.h \
 		jsutil.h \
+		jsversion.h \
 		jsxdrapi.h \
 		jsxml.h \
 		$(NULL)
 
 ifdef ENABLE_JIT
@@ -300,13 +300,10 @@ HOST_SIMPLE_PROGRAMS += host_jsoplengen$
 HOST_SIMPLE_PROGRAMS += host_jsoplengen$(HOST_BIN_SUFFIX)
 GARBAGE += jsautooplen.h host_jsoplengen$(HOST_BIN_SUFFIX)
 
 USE_HOST_CXX = 1
 
-HOST_SIMPLE_PROGRAMS += host_jsoplengen$(HOST_BIN_SUFFIX)
-GARBAGE += jsautooplen.h host_jsoplengen$(HOST_BIN_SUFFIX)
-
 ifdef HAVE_DTRACE
 ifneq ($(OS_ARCH),Darwin)
 DTRACE_PROBE_OBJ = $(LIBRARY_NAME)-dtrace.$(OBJ_SUFFIX)
 endif
 MOZILLA_DTRACE_SRC = $(srcdir)/javascript-trace.d
@@ -519,11 +516,11 @@ jscpucfg$(HOST_BIN_SUFFIX): jscpucfg.cpp
 	$(HOST_CXX) $(HOST_CXXFLAGS) $(JSCPUCFG_DEFINES) $(DEFINES) $(NSPR_CFLAGS) $(HOST_OUTOPTION)$@ $<
 endif
 endif
 
 # Extra dependancies and rules for auto-generated headers
-host_jskwgen.$(OBJ_SUFFIX): jsconfig.h jskeyword.tbl
+host_jskwgen.$(OBJ_SUFFIX): jsversion.h jskeyword.tbl
 
 jsautokw.h: host_jskwgen$(HOST_BIN_SUFFIX)
 	./host_jskwgen$(HOST_BIN_SUFFIX) $@
 
 host_jsoplengen.$(OBJ_SUFFIX): jsopcode.tbl
diff -r f3ac957eb4af js/src/Makefile.ref
--- a/js/src/Makefile.ref	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/Makefile.ref	Sat Sep 06 10:14:37 2008 +0300
@@ -173,11 +173,10 @@ PURE_CFLAGS     = -DXP_UNIX $(OPTIMIZER)
 #
 JS_HFILES =		\
 	jsarray.h	\
 	jsatom.h	\
 	jsbool.h	\
-	jsconfig.h	\
 	jscntxt.h	\
 	jsdate.h	\
 	jsemit.h	\
 	jsexn.h		\
 	jsfun.h		\
@@ -203,10 +202,11 @@ JS_HFILES =		\
 	jsregexp.h	\
 	jsscan.h	\
 	jsscope.h	\
 	jsscript.h	\
 	jsstr.h		\
+	jsversion.h	\
 	jsxdrapi.h	\
 	jsxml.h		\
 	$(NULL)
 
 ifdef ENABLE_JIT
diff -r f3ac957eb4af js/src/jsapi.cpp
--- a/js/src/jsapi.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsapi.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -55,11 +55,11 @@
 #include "jsapi.h"
 #include "jsarray.h"
 #include "jsatom.h"
 #include "jsbool.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsdate.h"
 #include "jsdtoa.h"
 #include "jsemit.h"
 #include "jsexn.h"
 #include "jsfun.h"
@@ -4134,20 +4134,10 @@ JS_CheckAccess(JSContext *cx, JSObject *
 {
     CHECK_REQUEST(cx);
     return OBJ_CHECK_ACCESS(cx, obj, id, mode, vp, attrsp);
 }
 
-JS_PUBLIC_API(JSCheckAccessOp)
-JS_SetCheckObjectAccessCallback(JSRuntime *rt, JSCheckAccessOp acb)
-{
-    JSCheckAccessOp oldacb;
-
-    oldacb = rt->checkObjectAccess;
-    rt->checkObjectAccess = acb;
-    return oldacb;
-}
-
 static JSBool
 ReservedSlotIndexOK(JSContext *cx, JSObject *obj, JSClass *clasp,
                     uint32 index, uint32 limit)
 {
     /* Check the computed, possibly per-instance, upper bound. */
@@ -4207,28 +4197,42 @@ JS_DropPrincipals(JSContext *cx, JSPrinc
         principals->destroy(cx, principals);
     return rc;
 }
 #endif
 
-JS_PUBLIC_API(JSPrincipalsTranscoder)
-JS_SetPrincipalsTranscoder(JSRuntime *rt, JSPrincipalsTranscoder px)
-{
-    JSPrincipalsTranscoder oldpx;
-
-    oldpx = rt->principalsTranscoder;
-    rt->principalsTranscoder = px;
-    return oldpx;
-}
-
-JS_PUBLIC_API(JSObjectPrincipalsFinder)
-JS_SetObjectPrincipalsFinder(JSRuntime *rt, JSObjectPrincipalsFinder fop)
-{
-    JSObjectPrincipalsFinder oldfop;
-
-    oldfop = rt->findObjectPrincipals;
-    rt->findObjectPrincipals = fop;
-    return oldfop;
+JS_PUBLIC_API(JSSecurityCallbacks *)
+JS_SetRuntimeSecurityCallbacks(JSRuntime *rt, JSSecurityCallbacks *callbacks)
+{
+    JSSecurityCallbacks *oldcallbacks;
+
+    oldcallbacks = rt->securityCallbacks;
+    rt->securityCallbacks = callbacks;
+    return oldcallbacks;
+}
+
+JS_PUBLIC_API(JSSecurityCallbacks *)
+JS_GetRuntimeSecurityCallbacks(JSRuntime *rt)
+{
+  return rt->securityCallbacks;
+}
+
+JS_PUBLIC_API(JSSecurityCallbacks *)
+JS_SetContextSecurityCallbacks(JSContext *cx, JSSecurityCallbacks *callbacks)
+{
+    JSSecurityCallbacks *oldcallbacks;
+
+    oldcallbacks = cx->securityCallbacks;
+    cx->securityCallbacks = callbacks;
+    return oldcallbacks;
+}
+
+JS_PUBLIC_API(JSSecurityCallbacks *)
+JS_GetSecurityCallbacks(JSContext *cx)
+{
+  return cx->securityCallbacks
+         ? cx->securityCallbacks
+         : cx->runtime->securityCallbacks;
 }
 
 JS_PUBLIC_API(JSFunction *)
 JS_NewFunction(JSContext *cx, JSNative native, uintN nargs, uintN flags,
                JSObject *parent, const char *name)
diff -r f3ac957eb4af js/src/jsapi.h
--- a/js/src/jsapi.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsapi.h	Sat Sep 06 10:14:37 2008 +0300
@@ -1792,13 +1792,10 @@ JS_NextProperty(JSContext *cx, JSObject 
 
 extern JS_PUBLIC_API(JSBool)
 JS_CheckAccess(JSContext *cx, JSObject *obj, jsid id, JSAccessMode mode,
                jsval *vp, uintN *attrsp);
 
-extern JS_PUBLIC_API(JSCheckAccessOp)
-JS_SetCheckObjectAccessCallback(JSRuntime *rt, JSCheckAccessOp acb);
-
 extern JS_PUBLIC_API(JSBool)
 JS_GetReservedSlot(JSContext *cx, JSObject *obj, uint32 index, jsval *vp);
 
 extern JS_PUBLIC_API(JSBool)
 JS_SetReservedSlot(JSContext *cx, JSObject *obj, uint32 index, jsval v);
@@ -1838,15 +1835,28 @@ JS_DropPrincipals(JSContext *cx, JSPrinc
     ((--(principals)->refcount == 0)                                          \
      ? ((*(principals)->destroy)((cx), (principals)), 0)                      \
      : (principals)->refcount)
 #endif
 
-extern JS_PUBLIC_API(JSPrincipalsTranscoder)
-JS_SetPrincipalsTranscoder(JSRuntime *rt, JSPrincipalsTranscoder px);
 
-extern JS_PUBLIC_API(JSObjectPrincipalsFinder)
-JS_SetObjectPrincipalsFinder(JSRuntime *rt, JSObjectPrincipalsFinder fop);
+struct JSSecurityCallbacks {
+  JSCheckAccessOp            checkObjectAccess;
+  JSPrincipalsTranscoder     principalsTranscoder;
+  JSObjectPrincipalsFinder   findObjectPrincipals;
+};
+
+extern JS_PUBLIC_API(JSSecurityCallbacks *)
+JS_SetRuntimeSecurityCallbacks(JSRuntime *rt, JSSecurityCallbacks *callbacks);
+
+extern JS_PUBLIC_API(JSSecurityCallbacks *)
+JS_GetRuntimeSecurityCallbacks(JSRuntime *rt);
+
+extern JS_PUBLIC_API(JSSecurityCallbacks *)
+JS_SetContextSecurityCallbacks(JSContext *cx, JSSecurityCallbacks *callbacks);
+
+extern JS_PUBLIC_API(JSSecurityCallbacks *)
+JS_GetSecurityCallbacks(JSContext *cx);
 
 /************************************************************************/
 
 /*
  * Functions and scripts.
diff -r f3ac957eb4af js/src/jsarray.cpp
--- a/js/src/jsarray.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsarray.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -84,11 +84,11 @@
 #include "jsarray.h"
 #include "jsatom.h"
 #include "jsbit.h"
 #include "jsbool.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsdbgapi.h" /* for js_TraceWatchPoints */
 #include "jsdtoa.h"
 #include "jsfun.h"
 #include "jsgc.h"
 #include "jsinterp.h"
diff -r f3ac957eb4af js/src/jsatom.cpp
--- a/js/src/jsatom.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsatom.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -48,11 +48,11 @@
 #include "jshash.h" /* Added by JSIFY */
 #include "jsprf.h"
 #include "jsapi.h"
 #include "jsatom.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsgc.h"
 #include "jslock.h"
 #include "jsnum.h"
 #include "jsscan.h"
 #include "jsstr.h"
diff -r f3ac957eb4af js/src/jsatom.h
--- a/js/src/jsatom.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsatom.h	Sat Sep 06 10:14:37 2008 +0300
@@ -41,11 +41,11 @@
 #define jsatom_h___
 /*
  * JS atom table.
  */
 #include <stddef.h>
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jstypes.h"
 #include "jshash.h" /* Added by JSIFY */
 #include "jsdhash.h"
 #include "jsapi.h"
 #include "jsprvtd.h"
diff -r f3ac957eb4af js/src/jsbool.cpp
--- a/js/src/jsbool.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsbool.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -45,11 +45,11 @@
 #include "jsutil.h" /* Added by JSIFY */
 #include "jsapi.h"
 #include "jsatom.h"
 #include "jsbool.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsinterp.h"
 #include "jslock.h"
 #include "jsnum.h"
 #include "jsobj.h"
 #include "jsstr.h"
diff -r f3ac957eb4af js/src/jscntxt.cpp
--- a/js/src/jscntxt.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jscntxt.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -50,11 +50,11 @@
 #include "jsutil.h" /* Added by JSIFY */
 #include "jsclist.h"
 #include "jsprf.h"
 #include "jsatom.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsdbgapi.h"
 #include "jsexn.h"
 #include "jsfun.h"
 #include "jsgc.h"
 #include "jslock.h"
diff -r f3ac957eb4af js/src/jscntxt.h
--- a/js/src/jscntxt.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jscntxt.h	Sat Sep 06 10:14:37 2008 +0300
@@ -45,11 +45,11 @@
  */
 #include "jsarena.h" /* Added by JSIFY */
 #include "jsclist.h"
 #include "jslong.h"
 #include "jsatom.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsdhash.h"
 #include "jsgc.h"
 #include "jsinterp.h"
 #include "jsobj.h"
 #include "jsprvtd.h"
@@ -389,20 +389,14 @@ struct JSRuntime {
     PRLock              *debuggerLock;
 #endif /* JS_THREADSAFE */
     uint32              debuggerMutations;
 
     /*
-     * Check property accessibility for objects of arbitrary class.  Used at
-     * present to check f.caller accessibility for any function object f.
+     * Security callbacks set on the runtime are used by each context unless
+     * an override is set on the context.
      */
-    JSCheckAccessOp     checkObjectAccess;
-
-    /* Security principals serialization support. */
-    JSPrincipalsTranscoder principalsTranscoder;
-
-    /* Optional hook to find principals for an object in this runtime. */
-    JSObjectPrincipalsFinder findObjectPrincipals;
+    JSSecurityCallbacks *securityCallbacks;
 
     /*
      * Shared scope property tree, and arena-pool for allocating its nodes.
      * The propertyRemovals counter is incremented for every js_ClearScope,
      * and for each js_RemoveScopeProperty that frees a slot in an object.
@@ -885,10 +879,13 @@ struct JSContext {
     /* List of pre-allocated doubles. */
     JSGCDoubleCell      *doubleFreeList;
 
     /* Debug hooks associated with the current context. */
     JSDebugHooks        *debugHooks;
+
+    /* Security callbacks that override any defined on the runtime. */
+    JSSecurityCallbacks *securityCallbacks;
 };
 
 #ifdef JS_THREADSAFE
 # define JS_THREAD_ID(cx)       ((cx)->thread ? (cx)->thread->id : 0)
 #endif
diff -r f3ac957eb4af js/src/jsconfig.h
--- a/js/src/jsconfig.h	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,243 +0,0 @@
-/* -*- Mode: C; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-
- *
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is Mozilla Communicator client code, released
- * March 31, 1998.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 1998
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either of the GNU General Public License Version 2 or later (the "GPL"),
- * or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-/*
- * JS configuration macros.
- */
-#ifndef JS_VERSION
-#define JS_VERSION 180
-#endif
-
-/*
- * Compile-time JS version configuration.  The JS version numbers lie on the
- * number line like so:
- *
- * 1.0     1.1     1.2     1.3     1.4     ECMAv3  1.5     1.6     1.7     1.8
- *         ^                       ^
- *         |                       |
- *         basis for ECMAv1        close to ECMAv2
- *
- * where ECMAv3 stands for ECMA-262 Edition 3.  See the runtime version enum
- * JSVersion in jspubtd.h.  Code in the engine can therefore count on version
- * <= JSVERSION_1_4 to mean "before the Third Edition of ECMA-262" and version
- * > JSVERSION_1_4 to mean "at or after the Third Edition".
- *
- * In the (likely?) event that SpiderMonkey grows to implement JavaScript 2.0,
- * or ECMA-262 Edition 4 (JS2 without certain extensions), the version number
- * to use would be near 200, or greater.
- *
- * The JS_VERSION_ECMA_3 version is the minimal configuration conforming to
- * the ECMA-262 Edition 3 specification.  Use it for minimal embeddings, where
- * you're sure you don't need any of the extensions disabled in this version.
- * In order to facilitate testing, JS_HAS_OBJ_PROTO_PROP is defined as part of
- * the JS_VERSION_ECMA_3_TEST version.
- *
- * To keep things sane in the modern age, where we need exceptions in order to
- * implement, e.g., iterators and generators, we are dropping support for all
- * versions <= 1.4.
- */
-#define JS_VERSION_ECMA_3       148
-#define JS_VERSION_ECMA_3_TEST  149
-
-#if JS_VERSION == JS_VERSION_ECMA_3 ||                                        \
-    JS_VERSION == JS_VERSION_ECMA_3_TEST
-
-#define JS_HAS_STR_HTML_HELPERS 0       /* has str.anchor, str.bold, etc. */
-#define JS_HAS_PERL_SUBSTR      0       /* has str.substr */
-#if JS_VERSION == JS_VERSION_ECMA_3_TEST
-#define JS_HAS_OBJ_PROTO_PROP   1       /* has o.__proto__ etc. */
-#else
-#define JS_HAS_OBJ_PROTO_PROP   0       /* has o.__proto__ etc. */
-#endif
-#define JS_HAS_OBJ_WATCHPOINT   0       /* has o.watch and o.unwatch */
-#define JS_HAS_EVAL_THIS_SCOPE  0       /* Math.eval is same as with (Math) */
-#define JS_HAS_SHARP_VARS       0       /* has #n=, #n# for object literals */
-#define JS_HAS_SCRIPT_OBJECT    0       /* has (new Script("x++")).exec() */
-#define JS_HAS_XDR              0       /* has XDR API and internal support */
-#define JS_HAS_XDR_FREEZE_THAW  0       /* has XDR freeze/thaw script methods */
-#define JS_HAS_TOSOURCE         0       /* has Object/Array toSource method */
-#define JS_HAS_DEBUGGER_KEYWORD 0       /* has hook for debugger keyword */
-#define JS_HAS_CATCH_GUARD      0       /* has exception handling catch guard */
-#define JS_HAS_SPARSE_ARRAYS    0       /* array methods preserve empty elems */
-#define JS_HAS_GETTER_SETTER    0       /* has JS2 getter/setter functions */
-#define JS_HAS_UNEVAL           0       /* has uneval() top-level function */
-#define JS_HAS_CONST            0       /* has JS2 const as alternative var */
-#define JS_HAS_FUN_EXPR_STMT    0       /* has function expression statement */
-#define JS_HAS_LVALUE_RETURN    1       /* has o.item(i) = j; for native item */
-#define JS_HAS_NO_SUCH_METHOD   0       /* has o.__noSuchMethod__ handler */
-#define JS_HAS_XML_SUPPORT      0       /* has ECMAScript for XML support */
-#define JS_HAS_ARRAY_EXTRAS     0       /* has indexOf and Lispy extras */
-#define JS_HAS_GENERATORS       0       /* has yield in generator function */
-#define JS_HAS_BLOCK_SCOPE      0       /* has block scope via let/arraycomp */
-#define JS_HAS_DESTRUCTURING    0       /* has [a,b] = ... or {p:a,q:b} = ... */
-#define JS_HAS_GENERATOR_EXPRS  0       /* has (expr for (lhs in iterable)) */
-#define JS_HAS_EXPR_CLOSURES    0       /* has function (formals) listexpr */
-
-#elif JS_VERSION < 150
-
-#error "unsupported JS_VERSION"
-
-#elif JS_VERSION == 150
-
-#define JS_HAS_STR_HTML_HELPERS 1       /* has str.anchor, str.bold, etc. */
-#define JS_HAS_PERL_SUBSTR      1       /* has str.substr */
-#define JS_HAS_OBJ_PROTO_PROP   1       /* has o.__proto__ etc. */
-#define JS_HAS_OBJ_WATCHPOINT   1       /* has o.watch and o.unwatch */
-#define JS_HAS_EVAL_THIS_SCOPE  1       /* Math.eval is same as with (Math) */
-#define JS_HAS_SHARP_VARS       1       /* has #n=, #n# for object literals */
-#define JS_HAS_SCRIPT_OBJECT    1       /* has (new Script("x++")).exec() */
-#define JS_HAS_XDR              1       /* has XDR API and internal support */
-#define JS_HAS_XDR_FREEZE_THAW  0       /* has XDR freeze/thaw script methods */
-#define JS_HAS_TOSOURCE         1       /* has Object/Array toSource method */
-#define JS_HAS_DEBUGGER_KEYWORD 1       /* has hook for debugger keyword */
-#define JS_HAS_CATCH_GUARD      1       /* has exception handling catch guard */
-#define JS_HAS_SPARSE_ARRAYS    0       /* array methods preserve empty elems */
-#define JS_HAS_GETTER_SETTER    1       /* has JS2 getter/setter functions */
-#define JS_HAS_UNEVAL           1       /* has uneval() top-level function */
-#define JS_HAS_CONST            1       /* has JS2 const as alternative var */
-#define JS_HAS_FUN_EXPR_STMT    1       /* has function expression statement */
-#define JS_HAS_LVALUE_RETURN    1       /* has o.item(i) = j; for native item */
-#define JS_HAS_NO_SUCH_METHOD   1       /* has o.__noSuchMethod__ handler */
-#define JS_HAS_XML_SUPPORT      0       /* has ECMAScript for XML support */
-#define JS_HAS_ARRAY_EXTRAS     0       /* has indexOf and Lispy extras */
-#define JS_HAS_GENERATORS       0       /* has yield in generator function */
-#define JS_HAS_BLOCK_SCOPE      0       /* has block scope via let/arraycomp */
-#define JS_HAS_DESTRUCTURING    0       /* has [a,b] = ... or {p:a,q:b} = ... */
-#define JS_HAS_GENERATOR_EXPRS  0       /* has (expr for (lhs in iterable)) */
-#define JS_HAS_EXPR_CLOSURES    0       /* has function (formals) listexpr */
-
-#elif JS_VERSION == 160
-
-#define JS_HAS_STR_HTML_HELPERS 1       /* has str.anchor, str.bold, etc. */
-#define JS_HAS_PERL_SUBSTR      1       /* has str.substr */
-#define JS_HAS_OBJ_PROTO_PROP   1       /* has o.__proto__ etc. */
-#define JS_HAS_OBJ_WATCHPOINT   1       /* has o.watch and o.unwatch */
-#define JS_HAS_EVAL_THIS_SCOPE  1       /* Math.eval is same as with (Math) */
-#define JS_HAS_SHARP_VARS       1       /* has #n=, #n# for object literals */
-#define JS_HAS_SCRIPT_OBJECT    1       /* has (new Script("x++")).exec() */
-#define JS_HAS_XDR              1       /* has XDR API and internal support */
-#define JS_HAS_XDR_FREEZE_THAW  0       /* has XDR freeze/thaw script methods */
-#define JS_HAS_TOSOURCE         1       /* has Object/Array toSource method */
-#define JS_HAS_DEBUGGER_KEYWORD 1       /* has hook for debugger keyword */
-#define JS_HAS_CATCH_GUARD      1       /* has exception handling catch guard */
-#define JS_HAS_SPARSE_ARRAYS    0       /* array methods preserve empty elems */
-#define JS_HAS_GETTER_SETTER    1       /* has JS2 getter/setter functions */
-#define JS_HAS_UNEVAL           1       /* has uneval() top-level function */
-#define JS_HAS_CONST            1       /* has JS2 const as alternative var */
-#define JS_HAS_FUN_EXPR_STMT    1       /* has function expression statement */
-#define JS_HAS_LVALUE_RETURN    1       /* has o.item(i) = j; for native item */
-#define JS_HAS_NO_SUCH_METHOD   1       /* has o.__noSuchMethod__ handler */
-#define JS_HAS_XML_SUPPORT      1       /* has ECMAScript for XML support */
-#define JS_HAS_ARRAY_EXTRAS     1       /* has indexOf and Lispy extras */
-#define JS_HAS_GENERATORS       0       /* has yield in generator function */
-#define JS_HAS_BLOCK_SCOPE      0       /* has block scope via let/arraycomp */
-#define JS_HAS_DESTRUCTURING    0       /* has [a,b] = ... or {p:a,q:b} = ... */
-#define JS_HAS_GENERATOR_EXPRS  0       /* has (expr for (lhs in iterable)) */
-#define JS_HAS_EXPR_CLOSURES    0       /* has function (formals) listexpr */
-
-#elif JS_VERSION == 170
-
-#define JS_HAS_STR_HTML_HELPERS 1       /* has str.anchor, str.bold, etc. */
-#define JS_HAS_PERL_SUBSTR      1       /* has str.substr */
-#define JS_HAS_OBJ_PROTO_PROP   1       /* has o.__proto__ etc. */
-#define JS_HAS_OBJ_WATCHPOINT   1       /* has o.watch and o.unwatch */
-#define JS_HAS_EVAL_THIS_SCOPE  1       /* Math.eval is same as with (Math) */
-#define JS_HAS_SHARP_VARS       1       /* has #n=, #n# for object literals */
-#define JS_HAS_SCRIPT_OBJECT    0       /* has (new Script("x++")).exec() */
-#define JS_HAS_XDR              1       /* has XDR API and internal support */
-#define JS_HAS_XDR_FREEZE_THAW  0       /* has XDR freeze/thaw script methods */
-#define JS_HAS_TOSOURCE         1       /* has Object/Array toSource method */
-#define JS_HAS_DEBUGGER_KEYWORD 1       /* has hook for debugger keyword */
-#define JS_HAS_CATCH_GUARD      1       /* has exception handling catch guard */
-#define JS_HAS_SPARSE_ARRAYS    0       /* array methods preserve empty elems */
-#define JS_HAS_GETTER_SETTER    1       /* has JS2 getter/setter functions */
-#define JS_HAS_UNEVAL           1       /* has uneval() top-level function */
-#define JS_HAS_CONST            1       /* has JS2 const as alternative var */
-#define JS_HAS_FUN_EXPR_STMT    1       /* has function expression statement */
-#define JS_HAS_LVALUE_RETURN    1       /* has o.item(i) = j; for native item */
-#define JS_HAS_NO_SUCH_METHOD   1       /* has o.__noSuchMethod__ handler */
-#define JS_HAS_XML_SUPPORT      1       /* has ECMAScript for XML support */
-#define JS_HAS_ARRAY_EXTRAS     1       /* has indexOf and Lispy extras */
-#define JS_HAS_GENERATORS       1       /* has yield in generator function */
-#define JS_HAS_BLOCK_SCOPE      1       /* has block scope via let/arraycomp */
-#define JS_HAS_DESTRUCTURING    1       /* has [a,b] = ... or {p:a,q:b} = ... */
-#define JS_HAS_GENERATOR_EXPRS  0       /* has (expr for (lhs in iterable)) */
-#define JS_HAS_EXPR_CLOSURES    0       /* has function (formals) listexpr */
-
-#elif JS_VERSION == 180
-
-#define JS_HAS_STR_HTML_HELPERS 1       /* has str.anchor, str.bold, etc. */
-#define JS_HAS_PERL_SUBSTR      1       /* has str.substr */
-#define JS_HAS_OBJ_PROTO_PROP   1       /* has o.__proto__ etc. */
-#define JS_HAS_OBJ_WATCHPOINT   1       /* has o.watch and o.unwatch */
-#define JS_HAS_EVAL_THIS_SCOPE  1       /* Math.eval is same as with (Math) */
-#define JS_HAS_SHARP_VARS       1       /* has #n=, #n# for object literals */
-#define JS_HAS_SCRIPT_OBJECT    0       /* has (new Script("x++")).exec() */
-#define JS_HAS_XDR              1       /* has XDR API and internal support */
-#define JS_HAS_XDR_FREEZE_THAW  0       /* has XDR freeze/thaw script methods */
-#define JS_HAS_TOSOURCE         1       /* has Object/Array toSource method */
-#define JS_HAS_DEBUGGER_KEYWORD 1       /* has hook for debugger keyword */
-#define JS_HAS_CATCH_GUARD      1       /* has exception handling catch guard */
-#define JS_HAS_SPARSE_ARRAYS    0       /* array methods preserve empty elems */
-#define JS_HAS_GETTER_SETTER    1       /* has JS2 getter/setter functions */
-#define JS_HAS_UNEVAL           1       /* has uneval() top-level function */
-#define JS_HAS_CONST            1       /* has JS2 const as alternative var */
-#define JS_HAS_FUN_EXPR_STMT    1       /* has function expression statement */
-#define JS_HAS_LVALUE_RETURN    1       /* has o.item(i) = j; for native item */
-#define JS_HAS_NO_SUCH_METHOD   1       /* has o.__noSuchMethod__ handler */
-#define JS_HAS_XML_SUPPORT      1       /* has ECMAScript for XML support */
-#define JS_HAS_ARRAY_EXTRAS     1       /* has indexOf and Lispy extras */
-#define JS_HAS_GENERATORS       1       /* has yield in generator function */
-#define JS_HAS_BLOCK_SCOPE      1       /* has block scope via let/arraycomp */
-#define JS_HAS_DESTRUCTURING    2       /* has [a,b] = ... or {p:a,q:b} = ... */
-#define JS_HAS_GENERATOR_EXPRS  1       /* has (expr for (lhs in iterable)) */
-#define JS_HAS_EXPR_CLOSURES    1       /* has function (formals) listexpr */
-
-#else
-
-#error "unknown JS_VERSION"
-
-#endif
-
-/* Features that are present in all versions. */
-#define JS_HAS_RESERVED_JAVA_KEYWORDS   1
-#define JS_HAS_RESERVED_ECMA_KEYWORDS   1
-
-/* Feature-test macro for evolving destructuring support. */
-#define JS_HAS_DESTRUCTURING_SHORTHAND  (JS_HAS_DESTRUCTURING == 2)
diff -r f3ac957eb4af js/src/jsdate.cpp
--- a/js/src/jsdate.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsdate.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -60,11 +60,11 @@
 #include "jstypes.h"
 #include "jsprf.h"
 #include "prmjtime.h"
 #include "jsutil.h" /* Added by JSIFY */
 #include "jsapi.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jscntxt.h"
 #include "jsdate.h"
 #include "jsinterp.h"
 #include "jsnum.h"
 #include "jsobj.h"
diff -r f3ac957eb4af js/src/jsdbgapi.cpp
--- a/js/src/jsdbgapi.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsdbgapi.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -46,11 +46,11 @@
 #include "jstypes.h"
 #include "jsutil.h" /* Added by JSIFY */
 #include "jsclist.h"
 #include "jsapi.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsdbgapi.h"
 #include "jsemit.h"
 #include "jsfun.h"
 #include "jsgc.h"
 #include "jsinterp.h"
@@ -1005,16 +1005,17 @@ JS_GetScriptedCaller(JSContext *cx, JSSt
 }
 
 JS_PUBLIC_API(JSPrincipals *)
 JS_StackFramePrincipals(JSContext *cx, JSStackFrame *fp)
 {
+    JSSecurityCallbacks *callbacks;
+
     if (fp->fun) {
-        JSRuntime *rt = cx->runtime;
-
-        if (rt->findObjectPrincipals) {
+        callbacks = JS_GetSecurityCallbacks(cx);
+        if (callbacks && callbacks->findObjectPrincipals) {
             if (FUN_OBJECT(fp->fun) != fp->callee)
-                return rt->findObjectPrincipals(cx, fp->callee);
+                return callbacks->findObjectPrincipals(cx, fp->callee);
             /* FALL THROUGH */
         }
     }
     if (fp->script)
         return fp->script->principals;
@@ -1022,16 +1023,16 @@ JS_StackFramePrincipals(JSContext *cx, J
 }
 
 JS_PUBLIC_API(JSPrincipals *)
 JS_EvalFramePrincipals(JSContext *cx, JSStackFrame *fp, JSStackFrame *caller)
 {
-    JSRuntime *rt;
     JSPrincipals *principals, *callerPrincipals;
+    JSSecurityCallbacks *callbacks;
 
-    rt = cx->runtime;
-    if (rt->findObjectPrincipals) {
-        principals = rt->findObjectPrincipals(cx, fp->callee);
+    callbacks = JS_GetSecurityCallbacks(cx);
+    if (callbacks && callbacks->findObjectPrincipals) {
+        principals = callbacks->findObjectPrincipals(cx, fp->callee);
     } else {
         principals = NULL;
     }
     if (!caller)
         return principals;
diff -r f3ac957eb4af js/src/jsdbgapi.h
--- a/js/src/jsdbgapi.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsdbgapi.h	Sat Sep 06 10:14:37 2008 +0300
@@ -100,11 +100,11 @@ JS_ClearAllWatchPoints(JSContext *cx);
 JS_ClearAllWatchPoints(JSContext *cx);
 
 #ifdef JS_HAS_OBJ_WATCHPOINT
 /*
  * Hide these non-API function prototypes by testing whether the internal
- * header file "jsconfig.h" has been included.
+ * header file "jsversion.h" has been included.
  */
 extern void
 js_TraceWatchPoints(JSTracer *trc, JSObject *obj);
 
 extern void
diff -r f3ac957eb4af js/src/jsemit.cpp
--- a/js/src/jsemit.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsemit.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -53,11 +53,11 @@
 #include "jsprf.h"
 #include "jsapi.h"
 #include "jsatom.h"
 #include "jsbool.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsemit.h"
 #include "jsfun.h"
 #include "jsnum.h"
 #include "jsopcode.h"
 #include "jsparse.h"
diff -r f3ac957eb4af js/src/jsexn.cpp
--- a/js/src/jsexn.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsexn.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -49,11 +49,11 @@
 #include "jsbit.h"
 #include "jsutil.h" /* Added by JSIFY */
 #include "jsprf.h"
 #include "jsapi.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsdbgapi.h"
 #include "jsexn.h"
 #include "jsfun.h"
 #include "jsinterp.h"
 #include "jsnum.h"
@@ -246,10 +246,11 @@ GetStackTraceValueBuffer(JSExnPrivate *p
 
 static JSBool
 InitExnPrivate(JSContext *cx, JSObject *exnObject, JSString *message,
                JSString *filename, uintN lineno, JSErrorReport *report)
 {
+    JSSecurityCallbacks *callbacks;
     JSCheckAccessOp checkAccess;
     JSErrorReporter older;
     JSExceptionState *state;
     jsval callerid, v;
     JSStackFrame *fp, *fpstop;
@@ -266,11 +267,14 @@ InitExnPrivate(JSContext *cx, JSObject *
      *
      * Set aside any error reporter for cx and save its exception state
      * so we can suppress any checkAccess failures.  Such failures should stop
      * the backtrace procedure, not result in a failure of this constructor.
      */
-    checkAccess = cx->runtime->checkObjectAccess;
+    callbacks = JS_GetSecurityCallbacks(cx);
+    checkAccess = callbacks
+                  ? callbacks->checkObjectAccess
+                  : NULL;
     older = JS_SetErrorReporter(cx, NULL);
     state = JS_SaveExceptionState(cx);
 
     callerid = ATOM_KEY(cx->runtime->atomState.callerAtom);
     stackDepth = 0;
diff -r f3ac957eb4af js/src/jsfun.cpp
--- a/js/src/jsfun.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsfun.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -1,7 +1,7 @@
 /* -*- Mode: C; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-
- * vim: set ts=8 sw=4 et tw=78:
+ * vim: set ts=8 sw=4 et tw=99:
  *
  * ***** BEGIN LICENSE BLOCK *****
  * Version: MPL 1.1/GPL 2.0/LGPL 2.1
  *
  * The contents of this file are subject to the Mozilla Public License Version
@@ -48,11 +48,11 @@
 #include "jsutil.h" /* Added by JSIFY */
 #include "jsapi.h"
 #include "jsarray.h"
 #include "jsatom.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsdbgapi.h"
 #include "jsfun.h"
 #include "jsgc.h"
 #include "jsinterp.h"
 #include "jslock.h"
@@ -958,51 +958,17 @@ JS_FRIEND_DATA(JSClass) js_CallClass = {
     NULL,               NULL,
     NULL,               NULL,
     JS_CLASS_TRACE(args_or_call_trace), call_reserveSlots
 };
 
-/*
- * ECMA-262 specifies that length is a property of function object instances,
- * but we can avoid that space cost by delegating to a prototype property that
- * is JSPROP_PERMANENT and JSPROP_SHARED.  Each fun_getProperty call computes
- * a fresh length value based on the arity of the individual function object's
- * private data.
- *
- * The extensions below other than length, i.e., the ones not in ECMA-262,
- * are neither JSPROP_READONLY nor JSPROP_SHARED, because for compatibility
- * with ECMA we must allow a delegating object to override them. Therefore to
- * avoid entraining garbage in Function.prototype slots, they must be resolved
- * in non-prototype function objects, wherefore the lazy_function_props table
- * and fun_resolve's use of it.
- */
-#define LENGTH_PROP_ATTRS (JSPROP_READONLY|JSPROP_PERMANENT|JSPROP_SHARED)
-
-static JSPropertySpec function_props[] = {
-    {js_length_str,    ARGS_LENGTH,    LENGTH_PROP_ATTRS, 0,0},
-    {0,0,0,0,0}
-};
-
-typedef struct LazyFunctionProp {
-    uint16      atomOffset;
-    int8        tinyid;
-    uint8       attrs;
-} LazyFunctionProp;
-
-/* NB: no sentinel at the end -- use JS_ARRAY_LENGTH to bound loops. */
-static LazyFunctionProp lazy_function_props[] = {
-    {ATOM_OFFSET(arguments), CALL_ARGUMENTS, JSPROP_PERMANENT},
-    {ATOM_OFFSET(arity),     FUN_ARITY,      JSPROP_PERMANENT},
-    {ATOM_OFFSET(caller),    FUN_CALLER,     JSPROP_PERMANENT},
-    {ATOM_OFFSET(name),      FUN_NAME,       JSPROP_PERMANENT},
-};
-
 static JSBool
 fun_getProperty(JSContext *cx, JSObject *obj, jsval id, jsval *vp)
 {
     jsint slot;
     JSFunction *fun;
     JSStackFrame *fp;
+    JSSecurityCallbacks *callbacks;
 
     if (!JSVAL_IS_INT(id))
         return JS_TRUE;
     slot = JSVAL_TO_INT(id);
 
@@ -1073,14 +1039,17 @@ fun_getProperty(JSContext *cx, JSObject 
       case FUN_CALLER:
         if (fp && fp->down && fp->down->fun)
             *vp = OBJECT_TO_JSVAL(fp->down->callee);
         else
             *vp = JSVAL_NULL;
-        if (!JSVAL_IS_PRIMITIVE(*vp) && cx->runtime->checkObjectAccess) {
-            id = ATOM_KEY(cx->runtime->atomState.callerAtom);
-            if (!cx->runtime->checkObjectAccess(cx, obj, id, JSACC_READ, vp))
-                return JS_FALSE;
+        if (!JSVAL_IS_PRIMITIVE(*vp)) {
+            callbacks = JS_GetSecurityCallbacks(cx);
+            if (callbacks && callbacks->checkObjectAccess) {
+                id = ATOM_KEY(cx->runtime->atomState.callerAtom);
+                if (!callbacks->checkObjectAccess(cx, obj, id, JSACC_READ, vp))
+                    return JS_FALSE;
+            }
         }
         break;
 
       default:
         /* XXX fun[0] and fun.arguments[0] are equivalent. */
@@ -1089,10 +1058,45 @@ fun_getProperty(JSContext *cx, JSObject 
         break;
     }
 
     return JS_TRUE;
 }
+
+/*
+ * ECMA-262 specifies that length is a property of function object instances,
+ * but we can avoid that space cost by delegating to a prototype property that
+ * is JSPROP_PERMANENT and JSPROP_SHARED.  Each fun_getProperty call computes
+ * a fresh length value based on the arity of the individual function object's
+ * private data.
+ *
+ * The extensions below other than length, i.e., the ones not in ECMA-262,
+ * are neither JSPROP_READONLY nor JSPROP_SHARED, because for compatibility
+ * with ECMA we must allow a delegating object to override them. Therefore to
+ * avoid entraining garbage in Function.prototype slots, they must be resolved
+ * in non-prototype function objects, wherefore the lazy_function_props table
+ * and fun_resolve's use of it.
+ */
+#define LENGTH_PROP_ATTRS (JSPROP_READONLY|JSPROP_PERMANENT|JSPROP_SHARED)
+
+static JSPropertySpec function_props[] = {
+    {js_length_str,    ARGS_LENGTH,    LENGTH_PROP_ATTRS, fun_getProperty, JS_PropertyStub},
+    {0,0,0,0,0}
+};
+
+typedef struct LazyFunctionProp {
+    uint16      atomOffset;
+    int8        tinyid;
+    uint8       attrs;
+} LazyFunctionProp;
+
+/* NB: no sentinel at the end -- use JS_ARRAY_LENGTH to bound loops. */
+static LazyFunctionProp lazy_function_props[] = {
+    {ATOM_OFFSET(arguments), CALL_ARGUMENTS, JSPROP_PERMANENT},
+    {ATOM_OFFSET(arity),     FUN_ARITY,      JSPROP_PERMANENT},
+    {ATOM_OFFSET(caller),    FUN_CALLER,     JSPROP_PERMANENT},
+    {ATOM_OFFSET(name),      FUN_NAME,       JSPROP_PERMANENT},
+};
 
 static JSBool
 fun_enumerate(JSContext *cx, JSObject *obj)
 {
     jsid prototypeId;
@@ -1180,13 +1184,13 @@ fun_resolve(JSContext *cx, JSObject *obj
 
         atom = OFFSET_TO_ATOM(cx->runtime, lfp->atomOffset);
         if (id == ATOM_KEY(atom)) {
             if (!js_DefineNativeProperty(cx, obj,
                                          ATOM_TO_JSID(atom), JSVAL_VOID,
-                                         NULL, NULL, lfp->attrs,
-                                         SPROP_HAS_SHORTID, lfp->tinyid,
-                                         NULL)) {
+                                         fun_getProperty, JS_PropertyStub,
+                                         lfp->attrs, SPROP_HAS_SHORTID,
+                                         lfp->tinyid, NULL)) {
                 return JS_FALSE;
             }
             *objp = obj;
             return JS_TRUE;
         }
@@ -1502,11 +1506,11 @@ JS_FRIEND_DATA(JSClass) js_FunctionClass
 JS_FRIEND_DATA(JSClass) js_FunctionClass = {
     js_Function_str,
     JSCLASS_HAS_PRIVATE | JSCLASS_NEW_RESOLVE | JSCLASS_HAS_RESERVED_SLOTS(2) |
     JSCLASS_MARK_IS_TRACE | JSCLASS_HAS_CACHED_PROTO(JSProto_Function),
     JS_PropertyStub,  JS_PropertyStub,
-    fun_getProperty,  JS_PropertyStub,
+    JS_PropertyStub,  JS_PropertyStub,
     fun_enumerate,    (JSResolveOp)fun_resolve,
     fun_convert,      fun_finalize,
     NULL,             NULL,
     NULL,             NULL,
     fun_xdrObject,    fun_hasInstance,
diff -r f3ac957eb4af js/src/jsgc.cpp
--- a/js/src/jsgc.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsgc.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -59,11 +59,11 @@
 #include "jsclist.h"
 #include "jsprf.h"
 #include "jsapi.h"
 #include "jsatom.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsdbgapi.h"
 #include "jsexn.h"
 #include "jsfun.h"
 #include "jsgc.h"
 #include "jsinterp.h"
diff -r f3ac957eb4af js/src/jsinterp.cpp
--- a/js/src/jsinterp.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsinterp.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -52,11 +52,11 @@
 #include "jsapi.h"
 #include "jsarray.h"
 #include "jsatom.h"
 #include "jsbool.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsdbgapi.h"
 #include "jsfun.h"
 #include "jsgc.h"
 #include "jsinterp.h"
 #include "jsiter.h"
@@ -1406,10 +1406,12 @@ js_InternalInvoke(JSContext *cx, JSObjec
 
 JSBool
 js_InternalGetOrSet(JSContext *cx, JSObject *obj, jsid id, jsval fval,
                     JSAccessMode mode, uintN argc, jsval *argv, jsval *rval)
 {
+    JSSecurityCallbacks *callbacks;
+
     /*
      * js_InternalInvoke could result in another try to get or set the same id
      * again, see bug 355497.
      */
     JS_CHECK_RECURSION(cx, return JS_FALSE);
@@ -1428,15 +1430,16 @@ js_InternalGetOrSet(JSContext *cx, JSObj
      * hook anyway.  Where we do call such a native, there's no need for the
      * engine to impose a separate access check callback on all embeddings --
      * many embeddings have no security policy at all.
      */
     JS_ASSERT(mode == JSACC_READ || mode == JSACC_WRITE);
-    if (cx->runtime->checkObjectAccess &&
+    callbacks = JS_GetSecurityCallbacks(cx);
+    if (callbacks &&
+        callbacks->checkObjectAccess &&
         VALUE_IS_FUNCTION(cx, fval) &&
         FUN_INTERPRETED(GET_FUNCTION_PRIVATE(cx, JSVAL_TO_OBJECT(fval))) &&
-        !cx->runtime->checkObjectAccess(cx, obj, ID_TO_VALUE(id), mode,
-                                        &fval)) {
+        !callbacks->checkObjectAccess(cx, obj, ID_TO_VALUE(id), mode, &fval)) {
         return JS_FALSE;
     }
 
     return js_InternalCall(cx, obj, fval, argc, argv, rval);
 }
diff -r f3ac957eb4af js/src/jsiter.cpp
--- a/js/src/jsiter.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsiter.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -49,11 +49,11 @@
 #include "jsapi.h"
 #include "jsarray.h"
 #include "jsatom.h"
 #include "jsbool.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsexn.h"
 #include "jsfun.h"
 #include "jsgc.h"
 #include "jsinterp.h"
 #include "jsiter.h"
diff -r f3ac957eb4af js/src/jskwgen.cpp
--- a/js/src/jskwgen.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jskwgen.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -44,11 +44,11 @@
 #include <stdlib.h>
 #include <string.h>
 #include <stdarg.h>
 #include <ctype.h>
 
-#include "jsconfig.h"
+#include "jsversion.h"
 
 const char * const keyword_list[] = {
 #define JS_KEYWORD(keyword, type, op, version) #keyword,
 #include "jskeyword.tbl"
 #undef JS_KEYWORD
diff -r f3ac957eb4af js/src/jslibmath.h
--- a/js/src/jslibmath.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jslibmath.h	Sat Sep 06 10:14:37 2008 +0300
@@ -40,11 +40,11 @@
 
 #ifndef _LIBMATH_H
 #define _LIBMATH_H
 
 #include <math.h>
-#include "jsconfig.h"
+#include "jsversion.h"
 
 /*
  * Use system provided math routines.
  */
 
diff -r f3ac957eb4af js/src/jsmath.cpp
--- a/js/src/jsmath.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsmath.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -47,11 +47,11 @@
 #include "jslong.h"
 #include "prmjtime.h"
 #include "jsapi.h"
 #include "jsatom.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jslock.h"
 #include "jsmath.h"
 #include "jsnum.h"
 #include "jsobj.h"
 
diff -r f3ac957eb4af js/src/jsnum.cpp
--- a/js/src/jsnum.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsnum.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -53,11 +53,11 @@
 #include "jstypes.h"
 #include "jsutil.h" /* Added by JSIFY */
 #include "jsapi.h"
 #include "jsatom.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsdtoa.h"
 #include "jsgc.h"
 #include "jsinterp.h"
 #include "jsnum.h"
 #include "jsobj.h"
diff -r f3ac957eb4af js/src/jsobj.cpp
--- a/js/src/jsobj.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsobj.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -54,11 +54,11 @@
 #include "jsapi.h"
 #include "jsarray.h"
 #include "jsatom.h"
 #include "jsbool.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsemit.h"
 #include "jsfun.h"
 #include "jsgc.h"
 #include "jsinterp.h"
 #include "jslock.h"
@@ -773,11 +773,11 @@ obj_toSource(JSContext *cx, uintN argc, 
 
 #else  /* !JS_HAS_GETTER_SETTER */
 
         /*
          * We simplify the source code at the price of minor dead code bloat in
-         * the ECMA version (for testing only, see jsconfig.h).  The null
+         * the ECMA version (for testing only, see jsversion.h).  The null
          * default values in gsop[j] suffice to disable non-ECMA getter and
          * setter code.
          */
         valcnt = 1;
         gsop[0] = NULL;
@@ -1081,17 +1081,17 @@ obj_valueOf(JSContext *cx, uintN argc, j
  */
 JSBool
 js_CheckPrincipalsAccess(JSContext *cx, JSObject *scopeobj,
                          JSPrincipals *principals, JSAtom *caller)
 {
-    JSRuntime *rt;
+    JSSecurityCallbacks *callbacks;
     JSPrincipals *scopePrincipals;
     const char *callerstr;
 
-    rt = cx->runtime;
-    if (rt->findObjectPrincipals) {
-        scopePrincipals = rt->findObjectPrincipals(cx, scopeobj);
+    callbacks = JS_GetSecurityCallbacks(cx);
+    if (callbacks && callbacks->findObjectPrincipals) {
+        scopePrincipals = callbacks->findObjectPrincipals(cx, scopeobj);
         if (!principals || !scopePrincipals ||
             !principals->subsume(principals, scopePrincipals)) {
             callerstr = js_AtomToPrintableString(cx, caller);
             if (!callerstr)
                 return JS_FALSE;
@@ -1144,12 +1144,15 @@ const char *
 const char *
 js_ComputeFilename(JSContext *cx, JSStackFrame *caller,
                    JSPrincipals *principals, uintN *linenop)
 {
     uint32 flags;
-
-    JS_ASSERT(principals || !cx->runtime->findObjectPrincipals);
+#ifdef DEBUG
+    JSSecurityCallbacks *callbacks = JS_GetSecurityCallbacks(cx);
+#endif
+
+    JS_ASSERT(principals || !(callbacks  && callbacks->findObjectPrincipals));
     flags = JS_GetScriptFilenameFlags(caller->script);
     if ((flags & JSFILENAME_PROTECTED) &&
         principals &&
         strcmp(principals->codebase, "[System Principal]")) {
         *linenop = 0;
@@ -1368,31 +1371,31 @@ static JSBool
 static JSBool
 obj_watch_handler(JSContext *cx, JSObject *obj, jsval id, jsval old, jsval *nvp,
                   void *closure)
 {
     JSObject *callable;
-    JSRuntime *rt;
+    JSSecurityCallbacks *callbacks;
     JSStackFrame *caller;
     JSPrincipals *subject, *watcher;
     JSResolvingKey key;
     JSResolvingEntry *entry;
     uint32 generation;
     jsval argv[3];
     JSBool ok;
 
     callable = (JSObject *) closure;
 
-    rt = cx->runtime;
-    if (rt->findObjectPrincipals) {
+    callbacks = JS_GetSecurityCallbacks(cx);
+    if (callbacks && callbacks->findObjectPrincipals) {
         /* Skip over any obj_watch_* frames between us and the real subject. */
         caller = JS_GetScriptedCaller(cx, cx->fp);
         if (caller) {
             /*
              * Only call the watch handler if the watcher is allowed to watch
              * the currently executing script.
              */
-            watcher = rt->findObjectPrincipals(cx, callable);
+            watcher = callbacks->findObjectPrincipals(cx, callable);
             subject = JS_StackFramePrincipals(cx, caller);
 
             if (watcher && subject && !watcher->subsume(watcher, subject)) {
                 /* Silently don't call the watch handler. */
                 return JS_TRUE;
@@ -4463,10 +4466,11 @@ js_CheckAccess(JSContext *cx, JSObject *
     JSBool writing;
     JSObject *pobj;
     JSProperty *prop;
     JSClass *clasp;
     JSScopeProperty *sprop;
+    JSSecurityCallbacks *callbacks;
     JSCheckAccessOp check;
 
     writing = (mode & JSACC_WRITE) != 0;
     switch (mode & JSACC_TYPEMASK) {
       case JSACC_PROTO:
@@ -4530,12 +4534,14 @@ js_CheckAccess(JSContext *cx, JSObject *
      * checkObjectAccess hook.  This covers precompilation-based sharing and
      * (possibly unintended) runtime sharing across trust boundaries.
      */
     clasp = OBJ_GET_CLASS(cx, pobj);
     check = clasp->checkAccess;
-    if (!check)
-        check = cx->runtime->checkObjectAccess;
+    if (!check) {
+        callbacks = JS_GetSecurityCallbacks(cx);
+        check = callbacks ? callbacks->checkObjectAccess : NULL;
+    }
     return !check || check(cx, pobj, ID_TO_VALUE(id), mode, vp);
 }
 
 #ifdef JS_THREADSAFE
 void
diff -r f3ac957eb4af js/src/jsopcode.cpp
--- a/js/src/jsopcode.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsopcode.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -56,11 +56,11 @@
 #include "jsprf.h"
 #include "jsapi.h"
 #include "jsarray.h"
 #include "jsatom.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsdbgapi.h"
 #include "jsemit.h"
 #include "jsfun.h"
 #include "jsiter.h"
 #include "jsobj.h"
diff -r f3ac957eb4af js/src/jsparse.cpp
--- a/js/src/jsparse.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsparse.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -60,11 +60,11 @@
 #include "jsutil.h" /* Added by JSIFY */
 #include "jsapi.h"
 #include "jsarray.h"
 #include "jsatom.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsemit.h"
 #include "jsfun.h"
 #include "jsinterp.h"
 #include "jsiter.h"
 #include "jslock.h"
diff -r f3ac957eb4af js/src/jsparse.h
--- a/js/src/jsparse.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsparse.h	Sat Sep 06 10:14:37 2008 +0300
@@ -41,11 +41,11 @@
 #ifndef jsparse_h___
 #define jsparse_h___
 /*
  * JS parser definitions.
  */
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsprvtd.h"
 #include "jspubtd.h"
 #include "jsscan.h"
 
 JS_BEGIN_EXTERN_C
diff -r f3ac957eb4af js/src/jsproto.tbl
--- a/js/src/jsproto.tbl	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsproto.tbl	Sat Sep 06 10:14:37 2008 +0300
@@ -34,11 +34,11 @@
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
-#include "jsconfig.h"
+#include "jsversion.h"
 
 #if JS_HAS_SCRIPT_OBJECT
 # define SCRIPT_INIT                    js_InitScriptClass
 #else
 # define SCRIPT_INIT                    js_InitNullClass
diff -r f3ac957eb4af js/src/jspubtd.h
--- a/js/src/jspubtd.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jspubtd.h	Sat Sep 06 10:14:37 2008 +0300
@@ -55,11 +55,11 @@ typedef jsword    jsval;
 typedef jsword    jsval;
 typedef jsword    jsid;
 typedef int32     jsrefcount;   /* PRInt32 if JS_THREADSAFE, see jslock.h */
 
 /*
- * Run-time version enumeration.  See jsconfig.h for compile-time counterparts
+ * Run-time version enumeration.  See jsversion.h for compile-time counterparts
  * to these values that may be selected by the JS_VERSION macro, and tested by
  * #if expressions.
  */
 typedef enum JSVersion {
     JSVERSION_1_0     = 100,
@@ -151,10 +151,11 @@ typedef struct JSStackFrame      JSStack
 typedef struct JSStackFrame      JSStackFrame;
 typedef struct JSString          JSString;
 typedef struct JSXDRState        JSXDRState;
 typedef struct JSExceptionState  JSExceptionState;
 typedef struct JSLocaleCallbacks JSLocaleCallbacks;
+typedef struct JSSecurityCallbacks JSSecurityCallbacks;
 
 /* JSClass (and JSObjectOps where appropriate) function pointer typedefs. */
 
 /*
  * Add, delete, get or set a property named by id in obj.  Note the jsval id
diff -r f3ac957eb4af js/src/jsregexp.cpp
--- a/js/src/jsregexp.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsregexp.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -50,11 +50,11 @@
 #include "jsutil.h" /* Added by JSIFY */
 #include "jsapi.h"
 #include "jsarray.h"
 #include "jsatom.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsfun.h"
 #include "jsgc.h"
 #include "jsinterp.h"
 #include "jslock.h"
 #include "jsnum.h"
@@ -2266,10 +2266,70 @@ AddCharacterRangeToCharSet(RECharSet *cs
             cs->u.bits[i] = 0xFF;
         cs->u.bits[byteIndex2] |= (uint8)0xFF >> (7 - c2);
     }
 }
 
+struct CharacterRange {
+    jschar start;
+    jschar end;
+};
+
+/*
+ * The following characters are taken from the ECMA-262 standard, section 7.2
+ * and 7.3, and the Unicode 3 standard, Table 6-1.
+ */
+static const CharacterRange WhiteSpaceRanges[] = {
+    /* TAB, LF, VT, FF, CR */
+    { 0x0009, 0x000D },
+    /* SPACE */
+    { 0x0020, 0x0020 },
+    /* NO-BREAK SPACE */
+    { 0x00A0, 0x00A0 },
+    /*
+     * EN QUAD, EM QUAD, EN SPACE, EM SPACE, THREE-PER-EM SPACE, FOUR-PER-EM
+     * SPACE, SIX-PER-EM SPACE, FIGURE SPACE, PUNCTUATION SPACE, THIN SPACE,
+     * HAIR SPACE, ZERO WIDTH SPACE
+     */
+    { 0x2000, 0x200B },
+    /* LS, PS */
+    { 0x2028, 0x2029 },
+    /* NARROW NO-BREAK SPACE */
+    { 0x202F, 0x202F },
+    /* IDEOGRAPHIC SPACE */
+    { 0x3000, 0x3000 }
+};
+
+/* ECMA-262 standard, section 15.10.2.6. */
+static const CharacterRange WordRanges[] = {
+    { jschar('0'), jschar('9') },
+    { jschar('A'), jschar('Z') },
+    { jschar('_'), jschar('_') },
+    { jschar('a'), jschar('z') }
+};
+
+static void
+AddCharacterRanges(RECharSet *charSet,
+                   const CharacterRange *range,
+                   const CharacterRange *end)
+{
+    for (; range < end; ++range)
+        AddCharacterRangeToCharSet(charSet, range->start, range->end);
+}
+
+static void
+AddInvertedCharacterRanges(RECharSet *charSet,
+                           const CharacterRange *range,
+                           const CharacterRange *end)
+{
+    uint16 previous = 0;
+    for (; range < end; ++range) {
+        AddCharacterRangeToCharSet(charSet, previous, range->start - 1);
+        previous = range->end + 1;
+    }
+    AddCharacterRangeToCharSet(charSet, previous, charSet->length);
+}
+    
 /* Compile the source of the class into a RECharSet */
 static JSBool
 ProcessCharSet(REGlobalData *gData, RECharSet *charSet)
 {
     const jschar *src, *end;
@@ -2409,28 +2469,24 @@ ProcessCharSet(REGlobalData *gData, RECh
                 AddCharacterRangeToCharSet(charSet,
                                            (jschar)('9' + 1),
                                            (jschar)charSet->length);
                 continue;
               case 's':
-                for (i = (intN)charSet->length; i >= 0; i--)
-                    if (JS_ISSPACE(i))
-                        AddCharacterToCharSet(charSet, (jschar)i);
+                AddCharacterRanges(charSet, WhiteSpaceRanges,
+                                   WhiteSpaceRanges + JS_ARRAY_LENGTH(WhiteSpaceRanges));
                 continue;
               case 'S':
-                for (i = (intN)charSet->length; i >= 0; i--)
-                    if (!JS_ISSPACE(i))
-                        AddCharacterToCharSet(charSet, (jschar)i);
+                AddInvertedCharacterRanges(charSet, WhiteSpaceRanges,
+                                           WhiteSpaceRanges + JS_ARRAY_LENGTH(WhiteSpaceRanges));
                 continue;
               case 'w':
-                for (i = (intN)charSet->length; i >= 0; i--)
-                    if (JS_ISWORD(i))
-                        AddCharacterToCharSet(charSet, (jschar)i);
+                AddCharacterRanges(charSet, WordRanges,
+                                   WordRanges + JS_ARRAY_LENGTH(WordRanges));
                 continue;
               case 'W':
-                for (i = (intN)charSet->length; i >= 0; i--)
-                    if (!JS_ISWORD(i))
-                        AddCharacterToCharSet(charSet, (jschar)i);
+                AddInvertedCharacterRanges(charSet, WordRanges,
+                                           WordRanges + JS_ARRAY_LENGTH(WordRanges));
                 continue;
               default:
                 thisCh = c;
                 break;
 
diff -r f3ac957eb4af js/src/jsscan.cpp
--- a/js/src/jsscan.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsscan.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -58,11 +58,11 @@
 #include "jsdtoa.h"
 #include "jsprf.h"
 #include "jsapi.h"
 #include "jsatom.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsemit.h"
 #include "jsexn.h"
 #include "jsnum.h"
 #include "jsopcode.h"
 #include "jsparse.h"
diff -r f3ac957eb4af js/src/jsscan.h
--- a/js/src/jsscan.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsscan.h	Sat Sep 06 10:14:37 2008 +0300
@@ -42,11 +42,11 @@
 /*
  * JS lexical scanner interface.
  */
 #include <stddef.h>
 #include <stdio.h>
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsopcode.h"
 #include "jsprvtd.h"
 #include "jspubtd.h"
 
 JS_BEGIN_EXTERN_C
diff -r f3ac957eb4af js/src/jsscript.cpp
--- a/js/src/jsscript.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsscript.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -47,11 +47,11 @@
 #include "jsutil.h" /* Added by JSIFY */
 #include "jsprf.h"
 #include "jsapi.h"
 #include "jsatom.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsdbgapi.h"
 #include "jsemit.h"
 #include "jsfun.h"
 #include "jsinterp.h"
 #include "jslock.h"
@@ -426,10 +426,11 @@ js_XDRScript(JSXDRState *xdr, JSScript *
     JSTempValueRooter tvr;
     JSPrincipals *principals;
     uint32 encodeable;
     JSBool filenameWasSaved;
     jssrcnote *notes, *sn;
+    JSSecurityCallbacks *callbacks;
 
     cx = xdr->cx;
     script = *scriptp;
     nsrcnotes = ntrynotes = natoms = nobjects = nupvars = nregexps = 0;
     filenameWasSaved = JS_FALSE;
@@ -545,29 +546,30 @@ js_XDRScript(JSXDRState *xdr, JSScript *
         !JS_XDRUint32(xdr, &lineno) ||
         !JS_XDRUint32(xdr, &nslots)) {
         goto error;
     }
 
+    callbacks = JS_GetSecurityCallbacks(cx);
     if (xdr->mode == JSXDR_ENCODE) {
         principals = script->principals;
-        encodeable = (cx->runtime->principalsTranscoder != NULL);
+        encodeable = callbacks && callbacks->principalsTranscoder;
         if (!JS_XDRUint32(xdr, &encodeable))
             goto error;
         if (encodeable &&
-            !cx->runtime->principalsTranscoder(xdr, &principals)) {
+            !callbacks->principalsTranscoder(xdr, &principals)) {
             goto error;
         }
     } else {
         if (!JS_XDRUint32(xdr, &encodeable))
             goto error;
         if (encodeable) {
-            if (!cx->runtime->principalsTranscoder) {
+            if (!(callbacks && callbacks->principalsTranscoder)) {
                 JS_ReportErrorNumber(cx, js_GetErrorMessage, NULL,
                                      JSMSG_CANT_DECODE_PRINCIPALS);
                 goto error;
             }
-            if (!cx->runtime->principalsTranscoder(xdr, &principals))
+            if (!callbacks->principalsTranscoder(xdr, &principals))
                 goto error;
             script->principals = principals;
         }
     }
 
diff -r f3ac957eb4af js/src/jsstr.cpp
--- a/js/src/jsstr.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsstr.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -58,11 +58,11 @@
 #include "jsapi.h"
 #include "jsarray.h"
 #include "jsatom.h"
 #include "jsbool.h"
 #include "jscntxt.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 #include "jsgc.h"
 #include "jsinterp.h"
 #include "jslock.h"
 #include "jsnum.h"
 #include "jsobj.h"
diff -r f3ac957eb4af js/src/jstracer.cpp
--- a/js/src/jstracer.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jstracer.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -3949,12 +3949,11 @@ TraceRecorder::record_JSOP_NEW()
 
     if (FUN_INTERPRETED(fun)) {
         LIns* args[] = { get(&fval), cx_ins };
         LIns* tv_ins = lir->insCall(F_FastNewObject, args);
         guard(false, lir->ins_eq0(tv_ins), OOM_EXIT);
-        jsval& tv = stackval(0 - (1 + argc));
-        set(&tv, tv_ins);
+        set(&tval, tv_ins);
         return interpretedFunctionCall(fval, fun, argc);
     }
 
     static JSTraceableNative knownNatives[] = {
         { (JSFastNative)js_Array,  F_FastNewArray,  "pC", "",    FAIL_NULL },
diff -r f3ac957eb4af js/src/jsversion.h
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/jsversion.h	Sat Sep 06 10:14:37 2008 +0300
@@ -0,0 +1,243 @@
+/* -*- Mode: C; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-
+ *
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Mozilla Communicator client code, released
+ * March 31, 1998.
+ *
+ * The Initial Developer of the Original Code is
+ * Netscape Communications Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 1998
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either of the GNU General Public License Version 2 or later (the "GPL"),
+ * or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+/*
+ * JS configuration macros.
+ */
+#ifndef JS_VERSION
+#define JS_VERSION 180
+#endif
+
+/*
+ * Compile-time JS version configuration.  The JS version numbers lie on the
+ * number line like so:
+ *
+ * 1.0     1.1     1.2     1.3     1.4     ECMAv3  1.5     1.6     1.7     1.8
+ *         ^                       ^
+ *         |                       |
+ *         basis for ECMAv1        close to ECMAv2
+ *
+ * where ECMAv3 stands for ECMA-262 Edition 3.  See the runtime version enum
+ * JSVersion in jspubtd.h.  Code in the engine can therefore count on version
+ * <= JSVERSION_1_4 to mean "before the Third Edition of ECMA-262" and version
+ * > JSVERSION_1_4 to mean "at or after the Third Edition".
+ *
+ * In the (likely?) event that SpiderMonkey grows to implement JavaScript 2.0,
+ * or ECMA-262 Edition 4 (JS2 without certain extensions), the version number
+ * to use would be near 200, or greater.
+ *
+ * The JS_VERSION_ECMA_3 version is the minimal configuration conforming to
+ * the ECMA-262 Edition 3 specification.  Use it for minimal embeddings, where
+ * you're sure you don't need any of the extensions disabled in this version.
+ * In order to facilitate testing, JS_HAS_OBJ_PROTO_PROP is defined as part of
+ * the JS_VERSION_ECMA_3_TEST version.
+ *
+ * To keep things sane in the modern age, where we need exceptions in order to
+ * implement, e.g., iterators and generators, we are dropping support for all
+ * versions <= 1.4.
+ */
+#define JS_VERSION_ECMA_3       148
+#define JS_VERSION_ECMA_3_TEST  149
+
+#if JS_VERSION == JS_VERSION_ECMA_3 ||                                        \
+    JS_VERSION == JS_VERSION_ECMA_3_TEST
+
+#define JS_HAS_STR_HTML_HELPERS 0       /* has str.anchor, str.bold, etc. */
+#define JS_HAS_PERL_SUBSTR      0       /* has str.substr */
+#if JS_VERSION == JS_VERSION_ECMA_3_TEST
+#define JS_HAS_OBJ_PROTO_PROP   1       /* has o.__proto__ etc. */
+#else
+#define JS_HAS_OBJ_PROTO_PROP   0       /* has o.__proto__ etc. */
+#endif
+#define JS_HAS_OBJ_WATCHPOINT   0       /* has o.watch and o.unwatch */
+#define JS_HAS_EVAL_THIS_SCOPE  0       /* Math.eval is same as with (Math) */
+#define JS_HAS_SHARP_VARS       0       /* has #n=, #n# for object literals */
+#define JS_HAS_SCRIPT_OBJECT    0       /* has (new Script("x++")).exec() */
+#define JS_HAS_XDR              0       /* has XDR API and internal support */
+#define JS_HAS_XDR_FREEZE_THAW  0       /* has XDR freeze/thaw script methods */
+#define JS_HAS_TOSOURCE         0       /* has Object/Array toSource method */
+#define JS_HAS_DEBUGGER_KEYWORD 0       /* has hook for debugger keyword */
+#define JS_HAS_CATCH_GUARD      0       /* has exception handling catch guard */
+#define JS_HAS_SPARSE_ARRAYS    0       /* array methods preserve empty elems */
+#define JS_HAS_GETTER_SETTER    0       /* has JS2 getter/setter functions */
+#define JS_HAS_UNEVAL           0       /* has uneval() top-level function */
+#define JS_HAS_CONST            0       /* has JS2 const as alternative var */
+#define JS_HAS_FUN_EXPR_STMT    0       /* has function expression statement */
+#define JS_HAS_LVALUE_RETURN    1       /* has o.item(i) = j; for native item */
+#define JS_HAS_NO_SUCH_METHOD   0       /* has o.__noSuchMethod__ handler */
+#define JS_HAS_XML_SUPPORT      0       /* has ECMAScript for XML support */
+#define JS_HAS_ARRAY_EXTRAS     0       /* has indexOf and Lispy extras */
+#define JS_HAS_GENERATORS       0       /* has yield in generator function */
+#define JS_HAS_BLOCK_SCOPE      0       /* has block scope via let/arraycomp */
+#define JS_HAS_DESTRUCTURING    0       /* has [a,b] = ... or {p:a,q:b} = ... */
+#define JS_HAS_GENERATOR_EXPRS  0       /* has (expr for (lhs in iterable)) */
+#define JS_HAS_EXPR_CLOSURES    0       /* has function (formals) listexpr */
+
+#elif JS_VERSION < 150
+
+#error "unsupported JS_VERSION"
+
+#elif JS_VERSION == 150
+
+#define JS_HAS_STR_HTML_HELPERS 1       /* has str.anchor, str.bold, etc. */
+#define JS_HAS_PERL_SUBSTR      1       /* has str.substr */
+#define JS_HAS_OBJ_PROTO_PROP   1       /* has o.__proto__ etc. */
+#define JS_HAS_OBJ_WATCHPOINT   1       /* has o.watch and o.unwatch */
+#define JS_HAS_EVAL_THIS_SCOPE  1       /* Math.eval is same as with (Math) */
+#define JS_HAS_SHARP_VARS       1       /* has #n=, #n# for object literals */
+#define JS_HAS_SCRIPT_OBJECT    1       /* has (new Script("x++")).exec() */
+#define JS_HAS_XDR              1       /* has XDR API and internal support */
+#define JS_HAS_XDR_FREEZE_THAW  0       /* has XDR freeze/thaw script methods */
+#define JS_HAS_TOSOURCE         1       /* has Object/Array toSource method */
+#define JS_HAS_DEBUGGER_KEYWORD 1       /* has hook for debugger keyword */
+#define JS_HAS_CATCH_GUARD      1       /* has exception handling catch guard */
+#define JS_HAS_SPARSE_ARRAYS    0       /* array methods preserve empty elems */
+#define JS_HAS_GETTER_SETTER    1       /* has JS2 getter/setter functions */
+#define JS_HAS_UNEVAL           1       /* has uneval() top-level function */
+#define JS_HAS_CONST            1       /* has JS2 const as alternative var */
+#define JS_HAS_FUN_EXPR_STMT    1       /* has function expression statement */
+#define JS_HAS_LVALUE_RETURN    1       /* has o.item(i) = j; for native item */
+#define JS_HAS_NO_SUCH_METHOD   1       /* has o.__noSuchMethod__ handler */
+#define JS_HAS_XML_SUPPORT      0       /* has ECMAScript for XML support */
+#define JS_HAS_ARRAY_EXTRAS     0       /* has indexOf and Lispy extras */
+#define JS_HAS_GENERATORS       0       /* has yield in generator function */
+#define JS_HAS_BLOCK_SCOPE      0       /* has block scope via let/arraycomp */
+#define JS_HAS_DESTRUCTURING    0       /* has [a,b] = ... or {p:a,q:b} = ... */
+#define JS_HAS_GENERATOR_EXPRS  0       /* has (expr for (lhs in iterable)) */
+#define JS_HAS_EXPR_CLOSURES    0       /* has function (formals) listexpr */
+
+#elif JS_VERSION == 160
+
+#define JS_HAS_STR_HTML_HELPERS 1       /* has str.anchor, str.bold, etc. */
+#define JS_HAS_PERL_SUBSTR      1       /* has str.substr */
+#define JS_HAS_OBJ_PROTO_PROP   1       /* has o.__proto__ etc. */
+#define JS_HAS_OBJ_WATCHPOINT   1       /* has o.watch and o.unwatch */
+#define JS_HAS_EVAL_THIS_SCOPE  1       /* Math.eval is same as with (Math) */
+#define JS_HAS_SHARP_VARS       1       /* has #n=, #n# for object literals */
+#define JS_HAS_SCRIPT_OBJECT    1       /* has (new Script("x++")).exec() */
+#define JS_HAS_XDR              1       /* has XDR API and internal support */
+#define JS_HAS_XDR_FREEZE_THAW  0       /* has XDR freeze/thaw script methods */
+#define JS_HAS_TOSOURCE         1       /* has Object/Array toSource method */
+#define JS_HAS_DEBUGGER_KEYWORD 1       /* has hook for debugger keyword */
+#define JS_HAS_CATCH_GUARD      1       /* has exception handling catch guard */
+#define JS_HAS_SPARSE_ARRAYS    0       /* array methods preserve empty elems */
+#define JS_HAS_GETTER_SETTER    1       /* has JS2 getter/setter functions */
+#define JS_HAS_UNEVAL           1       /* has uneval() top-level function */
+#define JS_HAS_CONST            1       /* has JS2 const as alternative var */
+#define JS_HAS_FUN_EXPR_STMT    1       /* has function expression statement */
+#define JS_HAS_LVALUE_RETURN    1       /* has o.item(i) = j; for native item */
+#define JS_HAS_NO_SUCH_METHOD   1       /* has o.__noSuchMethod__ handler */
+#define JS_HAS_XML_SUPPORT      1       /* has ECMAScript for XML support */
+#define JS_HAS_ARRAY_EXTRAS     1       /* has indexOf and Lispy extras */
+#define JS_HAS_GENERATORS       0       /* has yield in generator function */
+#define JS_HAS_BLOCK_SCOPE      0       /* has block scope via let/arraycomp */
+#define JS_HAS_DESTRUCTURING    0       /* has [a,b] = ... or {p:a,q:b} = ... */
+#define JS_HAS_GENERATOR_EXPRS  0       /* has (expr for (lhs in iterable)) */
+#define JS_HAS_EXPR_CLOSURES    0       /* has function (formals) listexpr */
+
+#elif JS_VERSION == 170
+
+#define JS_HAS_STR_HTML_HELPERS 1       /* has str.anchor, str.bold, etc. */
+#define JS_HAS_PERL_SUBSTR      1       /* has str.substr */
+#define JS_HAS_OBJ_PROTO_PROP   1       /* has o.__proto__ etc. */
+#define JS_HAS_OBJ_WATCHPOINT   1       /* has o.watch and o.unwatch */
+#define JS_HAS_EVAL_THIS_SCOPE  1       /* Math.eval is same as with (Math) */
+#define JS_HAS_SHARP_VARS       1       /* has #n=, #n# for object literals */
+#define JS_HAS_SCRIPT_OBJECT    0       /* has (new Script("x++")).exec() */
+#define JS_HAS_XDR              1       /* has XDR API and internal support */
+#define JS_HAS_XDR_FREEZE_THAW  0       /* has XDR freeze/thaw script methods */
+#define JS_HAS_TOSOURCE         1       /* has Object/Array toSource method */
+#define JS_HAS_DEBUGGER_KEYWORD 1       /* has hook for debugger keyword */
+#define JS_HAS_CATCH_GUARD      1       /* has exception handling catch guard */
+#define JS_HAS_SPARSE_ARRAYS    0       /* array methods preserve empty elems */
+#define JS_HAS_GETTER_SETTER    1       /* has JS2 getter/setter functions */
+#define JS_HAS_UNEVAL           1       /* has uneval() top-level function */
+#define JS_HAS_CONST            1       /* has JS2 const as alternative var */
+#define JS_HAS_FUN_EXPR_STMT    1       /* has function expression statement */
+#define JS_HAS_LVALUE_RETURN    1       /* has o.item(i) = j; for native item */
+#define JS_HAS_NO_SUCH_METHOD   1       /* has o.__noSuchMethod__ handler */
+#define JS_HAS_XML_SUPPORT      1       /* has ECMAScript for XML support */
+#define JS_HAS_ARRAY_EXTRAS     1       /* has indexOf and Lispy extras */
+#define JS_HAS_GENERATORS       1       /* has yield in generator function */
+#define JS_HAS_BLOCK_SCOPE      1       /* has block scope via let/arraycomp */
+#define JS_HAS_DESTRUCTURING    1       /* has [a,b] = ... or {p:a,q:b} = ... */
+#define JS_HAS_GENERATOR_EXPRS  0       /* has (expr for (lhs in iterable)) */
+#define JS_HAS_EXPR_CLOSURES    0       /* has function (formals) listexpr */
+
+#elif JS_VERSION == 180
+
+#define JS_HAS_STR_HTML_HELPERS 1       /* has str.anchor, str.bold, etc. */
+#define JS_HAS_PERL_SUBSTR      1       /* has str.substr */
+#define JS_HAS_OBJ_PROTO_PROP   1       /* has o.__proto__ etc. */
+#define JS_HAS_OBJ_WATCHPOINT   1       /* has o.watch and o.unwatch */
+#define JS_HAS_EVAL_THIS_SCOPE  1       /* Math.eval is same as with (Math) */
+#define JS_HAS_SHARP_VARS       1       /* has #n=, #n# for object literals */
+#define JS_HAS_SCRIPT_OBJECT    0       /* has (new Script("x++")).exec() */
+#define JS_HAS_XDR              1       /* has XDR API and internal support */
+#define JS_HAS_XDR_FREEZE_THAW  0       /* has XDR freeze/thaw script methods */
+#define JS_HAS_TOSOURCE         1       /* has Object/Array toSource method */
+#define JS_HAS_DEBUGGER_KEYWORD 1       /* has hook for debugger keyword */
+#define JS_HAS_CATCH_GUARD      1       /* has exception handling catch guard */
+#define JS_HAS_SPARSE_ARRAYS    0       /* array methods preserve empty elems */
+#define JS_HAS_GETTER_SETTER    1       /* has JS2 getter/setter functions */
+#define JS_HAS_UNEVAL           1       /* has uneval() top-level function */
+#define JS_HAS_CONST            1       /* has JS2 const as alternative var */
+#define JS_HAS_FUN_EXPR_STMT    1       /* has function expression statement */
+#define JS_HAS_LVALUE_RETURN    1       /* has o.item(i) = j; for native item */
+#define JS_HAS_NO_SUCH_METHOD   1       /* has o.__noSuchMethod__ handler */
+#define JS_HAS_XML_SUPPORT      1       /* has ECMAScript for XML support */
+#define JS_HAS_ARRAY_EXTRAS     1       /* has indexOf and Lispy extras */
+#define JS_HAS_GENERATORS       1       /* has yield in generator function */
+#define JS_HAS_BLOCK_SCOPE      1       /* has block scope via let/arraycomp */
+#define JS_HAS_DESTRUCTURING    2       /* has [a,b] = ... or {p:a,q:b} = ... */
+#define JS_HAS_GENERATOR_EXPRS  1       /* has (expr for (lhs in iterable)) */
+#define JS_HAS_EXPR_CLOSURES    1       /* has function (formals) listexpr */
+
+#else
+
+#error "unknown JS_VERSION"
+
+#endif
+
+/* Features that are present in all versions. */
+#define JS_HAS_RESERVED_JAVA_KEYWORDS   1
+#define JS_HAS_RESERVED_ECMA_KEYWORDS   1
+
+/* Feature-test macro for evolving destructuring support. */
+#define JS_HAS_DESTRUCTURING_SHORTHAND  (JS_HAS_DESTRUCTURING == 2)
diff -r f3ac957eb4af js/src/jsxdrapi.cpp
--- a/js/src/jsxdrapi.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsxdrapi.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -35,11 +35,11 @@
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 #include "jsstddef.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 
 #if JS_HAS_XDR
 
 #include <string.h>
 #include "jstypes.h"
diff -r f3ac957eb4af js/src/jsxml.cpp
--- a/js/src/jsxml.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/jsxml.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -36,11 +36,11 @@
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 #include "jsstddef.h"
-#include "jsconfig.h"
+#include "jsversion.h"
 
 #if JS_HAS_XML_SUPPORT
 
 #include <math.h>
 #include <stdlib.h>
diff -r f3ac957eb4af js/src/xpconnect/src/XPCNativeWrapper.cpp
--- a/js/src/xpconnect/src/XPCNativeWrapper.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/xpconnect/src/XPCNativeWrapper.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -677,12 +677,13 @@ XPC_NW_CheckAccess(JSContext *cx, JSObje
   if ((mode & JSACC_WATCH) == JSACC_PROTO && (mode & JSACC_WRITE)) {
     return ThrowException(NS_ERROR_XPC_SECURITY_MANAGER_VETO, cx);
   }
 
   // Forward to the checkObjectAccess hook in the JSContext, if any.
-  if (cx->runtime->checkObjectAccess &&
-      !cx->runtime->checkObjectAccess(cx, obj, id, mode, vp)) {
+  JSSecurityCallbacks *callbacks = JS_GetSecurityCallbacks(cx);
+  if (callbacks && callbacks->checkObjectAccess &&
+      !callbacks->checkObjectAccess(cx, obj, id, mode, vp)) {
     return JS_FALSE;
   }
 
   XPCWrappedNative *wrappedNative = XPCNativeWrapper::GetWrappedNative(obj);
   if (!wrappedNative) {
diff -r f3ac957eb4af js/src/xpconnect/src/XPCSafeJSObjectWrapper.cpp
--- a/js/src/xpconnect/src/XPCSafeJSObjectWrapper.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/src/xpconnect/src/XPCSafeJSObjectWrapper.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -689,24 +689,25 @@ XPC_SJOW_CheckAccess(JSContext *cx, JSOb
   if ((mode & JSACC_WATCH) == JSACC_PROTO && (mode & JSACC_WRITE)) {
     return ThrowException(NS_ERROR_XPC_SECURITY_MANAGER_VETO, cx);
   }
 
   // Forward to the checkObjectAccess hook in the runtime, if any.
-  if (cx->runtime->checkObjectAccess &&
-      !cx->runtime->checkObjectAccess(cx, obj, id, mode, vp)) {
+  JSSecurityCallbacks *callbacks = JS_GetSecurityCallbacks(cx);
+  if (callbacks && callbacks->checkObjectAccess &&
+      !callbacks->checkObjectAccess(cx, obj, id, mode, vp)) {
     return JS_FALSE;
   }
 
   JSObject *unsafeObj = GetUnsafeObject(obj);
   if (!unsafeObj) {
     return JS_TRUE;
   }
 
   // Forward the unsafe object to the checkObjectAccess hook in the
   // runtime too, if any.
-  if (cx->runtime->checkObjectAccess &&
-      !cx->runtime->checkObjectAccess(cx, unsafeObj, id, mode, vp)) {
+  if (callbacks && callbacks->checkObjectAccess &&
+      !callbacks->checkObjectAccess(cx, unsafeObj, id, mode, vp)) {
     return JS_FALSE;
   }
 
   JSClass *clazz = STOBJ_GET_CLASS(unsafeObj);
   return !clazz->checkAccess ||
diff -r f3ac957eb4af js/tests/browser.js
--- a/js/tests/browser.js	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/tests/browser.js	Sat Sep 06 10:14:37 2008 +0300
@@ -566,10 +566,17 @@ function gczeal(z)
 {
   var javascriptoptions = new Preferences('javascript.options.');
   javascriptoptions.setIntPref('gczeal', Number(z));
 }
 
+function jit()
+{
+  var javascriptoptions = new Preferences('javascript.options.jit.');
+  javascriptoptions.setBoolPref('content', true);
+  javascriptoptions.setBoolPref('chrome', true);
+}
+
 var gVersion = 150;
 
 function jsTestDriverBrowserInit()
 {
   if (typeof dump != 'function')
@@ -605,10 +612,17 @@ function jsTestDriverBrowserInit()
 
   if (gczealmatches)
   {
     var zeal = Number(gczealmatches[1]);
     gczeal(zeal);
+  }
+
+  var jitmatches = /;jit/.exec(document.location.search);
+
+  if (jitmatches)
+  {
+    jit();
   }
 
   var versionmatches = /version=([.0-9]*)/.exec(value);
 
   if (!versionmatches)
diff -r f3ac957eb4af js/tests/known-failures.pl
--- a/js/tests/known-failures.pl	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/tests/known-failures.pl	Sat Sep 06 10:14:37 2008 +0300
@@ -42,10 +42,11 @@ use Getopt::Mixed "nextOption";
 
 # predeclarations
 sub debug;
 sub usage;
 sub parse_options;
+sub escape_string;
 sub escape_pattern;
 sub unescape_pattern;
 
 # option arguments
 
@@ -301,10 +302,12 @@ debug "finding regressions";
 debug "finding regressions";
 
 my $pass = 0;
 my $changed = ($#patterns != -1);
 
+debug "changed=$changed, \$#patterns=$#patterns, \$#failures=$#failures";
+
 while ($changed) {
 
     $pass = $pass + 1;
 
     $changed = 0;
@@ -334,10 +337,12 @@ while ($changed) {
         debug "*****************************************";
     }
 
 }
 
+debug "\$#excludedtests=$#excludedtests, \$#failures=$#failures";
+
 foreach $excludedtest ( @excludedtests ) {
 
     if ($debug) {
         @results = grep m@$excludedtest@, @failures;
         if ($#results > -1) {
@@ -345,12 +350,16 @@ foreach $excludedtest ( @excludedtests )
         }
     }
 
     @results = grep !m@$excludedtest@, @failures;
 
+    debug "\$#results=$#results, \$excludedtest=$excludedtest, \$#failures=$#failures";
+
     @failures = @results;
 }
+
+debug "possible regressions: \$#failures=$#failures";
 
 open OUTPUT, ">$outputprefix-results-possible-regressions.log" or die "Unable to open $outputprefix-results-possible-regressions.log: $!";
 
 my $failure;
 foreach $failure (@failures) {
@@ -642,14 +651,41 @@ sub parse_options {
     if ($timezone eq "all") {
         $knownfailuretimezonepattern = "[^,]*";
         $failuretimezonepattern      = "[^,]*";
     }
     else {
-        $knownfailuretimezonepattern = "(" . $timezone . "|\\.\\*)";
-        $failuretimezonepattern      = "$timezone";
+        $knownfailuretimezonepattern = "(" . escape_string($timezone) . "|\\.\\*)";
+        $failuretimezonepattern      = escape_string("$timezone");
     }
 
+
+}
+
+sub escape_string {
+    my $s = shift;
+
+    # replace unescaped regular expression characters in the 
+    # string so they are not interpreted as regexp chars
+    # when matching descriptions. leave the escaped regexp chars
+    # `regexp` alone so they can be unescaped later and used in 
+    # pattern matching.
+
+    # see perldoc perlre
+
+    $s =~ s/\\/\\\\/g;
+
+    # escape non word chars that aren't surrounded by ``
+    $s =~ s/(?<!`)([$regchars])(?!`)/\\$1/g;
+    $s =~ s/(?<!`)([$regchars])(?=`)/\\$1/g;
+    $s =~ s/(?<=`)([$regchars])(?!`)/\\$1/g;
+
+    # unquote the regchars
+    $s =~ s/\`([^\`])\`/$1/g;
+
+    debug "escape_string  : $s";
+
+    return "$s";
 
 }
 
 sub escape_pattern {
 
@@ -659,28 +695,11 @@ sub escape_pattern {
 
     my ($leading, $trailing) = $line =~ /(.*TEST_DESCRIPTION=)(.*)/;
 
     #    debug "escape_pattern: before: $leading$trailing";
 
-    # replace unescaped regular expression characters in the 
-    # description so they are not interpreted as regexp chars
-    # when matching descriptions. leave the escaped regexp chars
-    # `regexp alone so they can be unescaped later and used in 
-    # pattern matching.
-
-    # see perldoc perlre
-
-    $trailing =~ s/\\/\\\\/g;
-
-    # escape non word chars that aren't surrounded by ``
-    $trailing =~ s/(?<!`)([$regchars])(?!`)/\\$1/g;
-    $trailing =~ s/(?<!`)([$regchars])(?=`)/\\$1/g;
-    $trailing =~ s/(?<=`)([$regchars])(?!`)/\\$1/g;
-    #    $trailing =~ s/(?<!`)(\W)(?!`)/\\$1/g;
-
-    # unquote the regchars
-    $trailing =~ s/\`([^\`])\`/$1/g;
+    $trailing = escape_string($trailing);
 
     debug "escape_pattern  : $leading$trailing";
 
     return "$leading$trailing";
 
diff -r f3ac957eb4af js/tests/public-failures.txt
--- a/js/tests/public-failures.txt	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/tests/public-failures.txt	Sat Sep 06 10:14:37 2008 +0300
@@ -1,25 +1,26 @@ TEST_ID=e4x/Expressions/11.1.4-08.js, TE
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 50 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 51 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 53 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 54 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 56 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
-TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=;
-TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=;
+TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/GC/regress-324278.js:`.``*`: out of memory
+TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/GC/regress-324278.js:`.``*`: out of memory
 TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/GC/regress-324278.js:`.``*`: out of memory
-TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/GC/regress-324278.js:`.``*`: out of memory
 TEST_ID=e4x/Global/13.1.2.1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 4 of test - 13.1.2.1 - isXMLName() reason: Expected value 'exception', Actual value 'no exception'
 TEST_ID=e4x/Global/13.1.2.1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6 of test - 13.1.2.1 - isXMLName() reason: Expected value '', Actual value '0xAA-0xAA : Invalid char accepted as start : Invalid Char accepted as other NL0xB5-0xB5 : Invalid char accepted as start : Invalid Char accepted as other NL0xB7-0xB7 : Other char not acceptedNL0xBA-0xBA : Invalid char accepted as start : Invalid Char accepted as other NL0x132-0x133 : Invalid char accepted as start : Invalid Char accepted as other NL0x13F-0x140 : Invalid char accepted as start : Invalid Char accepted as other NL0x149-0x149 : Invalid char accepted as start : Invalid Char accepted as other NL0x17F-0x17F : Invalid char accepted as start : Invalid Char accepted as other NL0x1C4-0x1CC : Invalid char accepted as start : Invalid Char accepted as other NL0x1F1-0x1F3 : Invalid char accepted as start : Invalid Char accepted as other NL0x2B0-0x2B8 : Invalid Char accepted as other NL0x2BB-0x2C1 : Start char not acceptedNL0x2E0-0x2E4 : Invalid Char accepted as other NL0x37A-0x37A : Invalid Char accepted as other NL0x387-0x387 : Other char not acceptedNL0x559-0x559 : Start char not acceptedNL0x587-0x587 : Invalid char accepted as start : Invalid Char accepted as other NL0x6E5-0x6E6 : Start char not acceptedNL0xEDC-0xEDD : Invalid char accepted as start : Invalid Char accepted as other NL0x1101-0x1101 : Invalid char accepted as start : Invalid Char accepted as other NL0x1104-0x1104 : Invalid char accepted as start : Invalid Char accepted as other NL0x1108-0x1108 : Invalid char accepted as start : Invalid Char accepted as other NL0x110A-0x110A : Invalid char accepted as start : Invalid Char accepted as other NL0x110D-0x110D : Invalid char accepted as start : Invalid Char accepted as other NL0x1113-0x113B : Invalid char accepted as start : Invalid Char accepted as other NL0x113D-0x113D : Invalid char accepted as start : Invalid Char accepted as other NL0x113F-0x113F : Invalid char accepted as start : Invalid Char accepted as other NL0x1141-0x114B : Invalid char accepted as start : Invalid Char accepted as other NL0x114D-0x114D : Invalid char accepted as start : Invalid Char accepted as other NL0x114F-0x114F : Invalid char accepted as start : Invalid Char accepted as other NL0x1151-0x1153 : Invalid char accepted as start : Invalid Char accepted as other NL0x1156-0x1158 : Invalid char accepted as start : Invalid Char accepted as other NL0x1162-0x1162 : Invalid char accepted as start : Invalid Char accepted as other NL0x1164-0x1164 : Invalid char accepted as start : Invalid Char accepted as other NL0x1166-0x1166 : Invalid char accepted as start : Invalid Char accepted as other NL0x1168-0x1168 : Invalid char accepted as start : Invalid Char accepted as other NL0x116A-0x116C : Invalid char accepted as start : Invalid Char accepted as other NL0x116F-0x1171 : Invalid char accepted as start : Invalid Char accepted as other NL0x1174-0x1174 : Invalid char accepted as start : Invalid Char accepted as other NL0x1176-0x119D : Invalid char accepted as start : Invalid Char accepted as other NL0x119F-0x11A2 : Invalid char accepted as start : Invalid Char accepted as other NL0x11A9-0x11AA : Invalid char accepted as start : Invalid Char accepted as other NL0x11AC-0x11AD : Invalid char accepted as start : Invalid Char accepted as other NL0x11B0-0x11B6 : Invalid char accepted as start : Invalid Char accepted as other NL0x11B9-0x11B9 : Invalid char accepted as start : Invalid Char accepted as other NL0x11BB-0x11BB : Invalid char accepted as start : Invalid Char accepted as other NL0x11C3-0x11EA : Invalid char accepted as start : Invalid Char accepted as other NL0x11EC-0x11EF : Invalid char accepted as start : Invalid Char accepted as other NL0x11F1-0x11F8 : Invalid char accepted as start : Invalid Char accepted as other NL0x207F-0x207F : Invalid char accepted as start : Invalid Char accepted as other NL0x20DD-0x20E0 : Invalid Char accepted as other NL0x2102-0x2102 : Invalid char accepted as start : Invalid Char accepted as other NL0x2107-0x2107 : Invalid char accepted as start : Invalid Char accepted as other NL0x210A-0x2113 : Invalid char accepted as start : Invalid Char accepted as other NL0x2115-0x2115 : Invalid char accepted as start : Invalid Char accepted as other NL0x2118-0x211D : Invalid char accepted as start : Invalid Char accepted as other NL0x2124-0x2124 : Invalid char accepted as start : Invalid Char accepted as other NL0x2128-0x2128 : Invalid char accepted as start : Invalid Char accepted as other NL0x212C-0x212D : Invalid char accepted as start : Invalid Char accepted as other NL0x212F-0x2131 : Invalid char accepted as start : Invalid Char accepted as other NL0x2133-0x2138 : Invalid char accepted as start : Invalid Char accepted as other NL0x2160-0x217F : Invalid char accepted as start : Invalid Char accepted as other NL0x309B-0x309C : Invalid Char accepted as other NL0x3131-0x318E : Invalid char accepted as start : Invalid Char accepted as other NL0xF900-0xFA2D : Invalid char accepted as start : Invalid Char accepted as other NL0xFB00-0xFB06 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB13-0xFB17 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB1E-0xFB1E : Invalid Char accepted as other NL0xFB1F-0xFB28 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB2A-0xFB36 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB38-0xFB3C : Invalid char accepted as start : Invalid Char accepted as other NL0xFB3E-0xFB3E : Invalid char accepted as start : Invalid Char accepted as other NL0xFB40-0xFB41 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB43-0xFB44 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB46-0xFBB1 : Invalid char accepted as start : Invalid Char accepted as other NL0xFBD3-0xFD3D : Invalid char accepted as start : Invalid Char accepted as other NL0xFD50-0xFD8F : Invalid char accepted as start : Invalid Char accepted as other NL0xFD92-0xFDC7 : Invalid char accepted as start : Invalid Char accepted as other NL0xFDF0-0xFDFB : Invalid char accepted as start : Invalid Char accepted as other NL0xFE20-0xFE23 : Invalid Char accepted as other NL0xFE70-0xFE72 : Invalid char accepted as start : Invalid Char accepted as other NL0xFE74-0xFE74 : Invalid char accepted as start : Invalid Char accepted as other NL0xFE76-0xFEFC : Invalid char accepted as start : Invalid Char accepted as other NL0xFF10-0xFF19 : Invalid Char accepted as other NL0xFF21-0xFF3A : Invalid char accepted as start : Invalid Char accepted as other NL0xFF41-0xFF5A : Invalid char accepted as start : Invalid Char accepted as other NL0xFF66-0xFF6F : Invalid char accepted as start : Invalid Char accepted as other NL0xFF70-0xFF70 : Invalid Char accepted as other NL0xFF71-0xFF9D : Invalid char accepted as start : Invalid Char accepted as other NL0xFF9E-0xFF9F : Invalid Char accepted as other NL0xFFA0-0xFFBE : Invalid char accepted as start : Invalid Char accepted as other NL0xFFC2-0xFFC7 : Invalid char accepted as start : Invalid Char accepted as other NL0xFFCA-0xFFCF : Invalid char accepted as start : Invalid Char accepted as other NL0xFFD2-0xFFD7 : Invalid char accepted as start : Invalid Char accepted as other NL0xFFDA-0xFFDC : Invalid char accepted as start : Invalid Char accepted as other NL'
 TEST_ID=e4x/Namespace/regress-292863.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Undeclaring namespace prefix should cause parse error reason: Expected value 'error', Actual value 'no error'
-TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=e4x/Regress/regress-352223.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Reject invalid spaces in tags reason: Expected value 'SyntaxError: invalid XML name', Actual value ''
 TEST_ID=e4x/Regress/regress-352223.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 2 of test - Reject invalid spaces in tags reason: Expected value 'SyntaxError: invalid XML tag syntax', Actual value ''
 TEST_ID=e4x/Regress/regress-369032.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: kid2->parent == xml || !kid2->parent, at `.``*`jsxml.c:
 TEST_ID=e4x/Regress/regress-369032.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: kid2->parent == xml || !kid2->parent, at `.``*`jsxml.c:
 TEST_ID=e4x/Regress/regress-369032.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
@@ -41,17 +42,13 @@ TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANC
 TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 5 of test - 13.4.4.26 - XML normalize() reason: Expected value '2', Actual value '0'
 TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6 of test - 13.4.4.26 - XML normalize() reason: Expected value '<alpha>  </alpha>', Actual value '<alpha/>'
 TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 7 of test - 13.4.4.26 - XML normalize() reason: Expected value '1', Actual value '0'
 TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 8 of test - 13.4.4.26 - XML normalize() reason: Expected value '<alpha>  <bravo> fun </bravo></alpha>', Actual value '<alpha><bravo> fun </bravo></alpha>'
 TEST_ID=e4x/XML/13.4.4.26.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 9 of test - 13.4.4.26 - XML normalize() reason: Expected value '2', Actual value '1'
-TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
-TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
-TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
 TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
 TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
-TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
+TEST_ID=e4x/XML/regress-324422-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported`.``*`/e4x/XML/regress-324422-2.js:`.``*`: out of memory
 TEST_ID=e4x/XML/regress-376773.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=xmlsimple.stringmethod === xmlsimple.function::stringmethod Section 61 reason: `.``*`/e4x/XML/regress-376773.js:`.``*`: reference to undefined XML name @mozilla.org/js/function::charAt
 TEST_ID=e4x/XML/regress-376773.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=Section 61 of test - xmlsimple.stringmethod === xmlsimple.function::stringmethod reason:
 TEST_ID=e4x/decompilation/decompile-xml-escapes.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Decompiler escapes line breaks/backslashes in E4X literals reason: Type mismatch, expected type boolean, actual type string Expected value 'false', Actual value ''function anonymous() {NL    return <![CDATA[\\\\]]>;NL}' does not contain '<![CDATA[\\]]>'!'
 TEST_ID=e4x/decompilation/decompile-xml-escapes.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Decompiler escapes line breaks/backslashes in E4X literals reason: Type mismatch, expected type boolean, actual type string Expected value 'false', Actual value ''function anonymous() {NL    return <?f bNLNLcNLc?>;NL}' does not contain '<?f bNLNLcNLc?>'!'
 TEST_ID=e4x/decompilation/decompile-xml-escapes.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Decompiler escapes line breaks/backslashes in E4X literals reason: Type mismatch, expected type boolean, actual type string Expected value 'false', Actual value ''function anonymous() {NL    return <?f bNLNLcNLc?>;NL}' does not contain '<?f bNLNLcNLc?>'!'
@@ -71,59 +68,73 @@ TEST_ID=e4x/decompilation/regress-355474
 TEST_ID=e4x/decompilation/regress-355474-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=;
 TEST_ID=e4x/decompilation/regress-355474-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Iterating over XML with WAY_TOO_MUCH_GC reason: Expected value ' function ( ) { for each ( var z in <y/> ) { print ( z ) ; } } ', Actual value ' function ( ) { while ( <y/> ) { print ( z ) ; } } '
 TEST_ID=e4x/decompilation/regress-429249.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=trap should not change decompilation <x/> : after trap reason: Expected value ' function g ( ) { return <x/>; } ', Actual value ' function g ( ) { return "<x/>"; } '
 TEST_ID=e4x/extensions/regress-337226.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=function::globalfunction Section  reason: `.``*`/e4x/extensions/regress-337226.js:`.``*`: reference to undefined XML name @mozilla.org/js/function::parseInt
 TEST_ID=e4x/extensions/regress-337226.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/extensions/regress-337226.js:`.``*`: ReferenceError: reference to undefined XML name @mozilla.org/js/function::parseInt
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/e4x/extensions/regress-374025.js:`.``*`: out of memory
 TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
 TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/extensions/regress-374025.js:`.``*`: out of memory
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`received signal 11
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`received signal 11
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
 TEST_ID=e4x/extensions/regress-410192.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Proper quoting of attribute by uneval/toSource reason: Expected value '"v"', Actual value 'v'
+TEST_ID=ecma/ExecutionContexts/10.2.2-1.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=globalStorage == THIS[globalStorage] reason: wrong value
+TEST_ID=ecma/ExecutionContexts/10.2.2-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=globalStorage == THIS[globalStorage] reason: wrong value
 TEST_ID=ecma/Math/15.8.2.5.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.atan2(-0, 1) reason: wrong value
 TEST_ID=ecma/Math/15.8.2.5.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.atan2(-1, Infinity) reason: wrong value
-TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-0.9) reason: wrong value
-TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-Number.MIN_VALUE) reason: wrong value
-TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-0.9) reason: wrong value
-TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-Number.MIN_VALUE) reason: wrong value
+TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-0.9) reason: wrong value
+TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-Number.MIN_VALUE) reason: wrong value
+TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-0.9) reason: wrong value
+TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-Number.MIN_VALUE) reason: wrong value
+TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-0.9) reason: wrong value
+TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-Number.MIN_VALUE) reason: wrong value
+TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-0.9) reason: wrong value
+TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-Number.MIN_VALUE) reason: wrong value
 TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-0.9) reason: wrong value
 TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-Number.MIN_VALUE) reason: wrong value
 TEST_ID=ecma/String/15.5.4.6-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var f = new Object( String.prototype.indexOf ); f('[object Window @ `.``*` (native @ `.``*`)]') reason: wrong value
 TEST_ID=ecma/TypeConversion/9.2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=!(0/0) reason: wrong value
 TEST_ID=ecma/TypeConversion/9.2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=1000 % 0 ? true : false reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
 TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-03.js:`.``*`: out of memory
+TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-03.js:`.``*`: out of memory
 TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-03.js:`.``*`: out of memory
-TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-03.js:`.``*`: out of memory
-TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-04.js:`.``*`: out of memory
+TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-04.js:`.``*`: out of memory
 TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-04.js:`.``*`: out of memory
-TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-04.js:`.``*`: out of memory
+TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-387501.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Array.prototype.toString|toSource|toLocaleString is not generic reason: Expected value 'TypeError: Array.prototype.toLocaleString called on incompatible String', Actual value 'f,o,o'
 TEST_ID=ecma_3/Array/regress-387501.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Array.prototype.toString|toSource|toLocaleString is not generic reason: Expected value 'TypeError: Array.prototype.toSource called on incompatible String', Actual value '["f", "o", "o"]'
 TEST_ID=ecma_3/Array/regress-387501.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Array.prototype.toString|toSource|toLocaleString is not generic reason: Expected value 'TypeError: Array.prototype.toString called on incompatible String', Actual value 'f,o,o'
 TEST_ID=ecma_3/Date/15.9.4.3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=15.9.4.3 - Date.UTC edge-case arguments.: date -1 reason: Expected value '30', Actual value '1'
 TEST_ID=ecma_3/Date/15.9.4.3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=15.9.4.3 - Date.UTC edge-case arguments.: date 0 reason: Expected value '31', Actual value '1'
@@ -200,10 +211,31 @@ TEST_ID=ecma_3/Unicode/regress-352044-02
 TEST_ID=ecma_3/Unicode/regress-352044-02-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=issues with Unicode escape sequences in JavaScript source code reason: Expected value 'SyntaxError', Actual value 'No Error'
 TEST_ID=ecma_3/Unicode/uc-005.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (uintN)js_GetSrcNoteOffset(sn, 0) == ss->top, at `.``*`jsopcode.c:
 TEST_ID=ecma_3/Unicode/uc-005.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: (uintN)js_GetSrcNoteOffset(sn, 0) == ss->top, at `.``*`jsopcode.c:
 TEST_ID=ecma_3/Unicode/uc-005.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=;
 TEST_ID=ecma_3/Unicode/uc-005.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is MEDIUM MATHEMATICAL SPACE a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is MONGOLIAN VOWEL SEPARATOR a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is NARROW NO-BREAK SPACE a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is OGHAM SPACE MARK a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is MEDIUM MATHEMATICAL SPACE a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is MONGOLIAN VOWEL SEPARATOR a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is NARROW NO-BREAK SPACE a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is OGHAM SPACE MARK a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is MEDIUM MATHEMATICAL SPACE a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is MONGOLIAN VOWEL SEPARATOR a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is NARROW NO-BREAK SPACE a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is OGHAM SPACE MARK a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is MEDIUM MATHEMATICAL SPACE a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is MONGOLIAN VOWEL SEPARATOR a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is NARROW NO-BREAK SPACE a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is OGHAM SPACE MARK a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is MEDIUM MATHEMATICAL SPACE a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is MONGOLIAN VOWEL SEPARATOR a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is NARROW NO-BREAK SPACE a space reason: Expected value 'true', Actual value 'false'
+TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is OGHAM SPACE MARK a space reason: Expected value 'true', Actual value 'false'
 TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is MEDIUM MATHEMATICAL SPACE a space reason: Expected value 'true', Actual value 'false'
 TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is MONGOLIAN VOWEL SEPARATOR a space reason: Expected value 'true', Actual value 'false'
 TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is NARROW NO-BREAK SPACE a space reason: Expected value 'true', Actual value 'false'
 TEST_ID=ecma_3_1/RegExp/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Is OGHAM SPACE MARK a space reason: Expected value 'true', Actual value 'false'
 TEST_ID=js1_2/function/regexparg-1.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=typeof f(/abc/) reason: wrong value
@@ -213,221 +245,93 @@ TEST_ID=js1_5/Array/11.1.4.js, TEST_BRAN
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 4 of test -  [1,,]  reason: Expected value '0', Actual value '01'
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 1 of test -  [,1]  reason: Expected value '1', Actual value '01'
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 2 of test -  [,,1]  reason: Expected value '2', Actual value '012'
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 4 of test -  [1,,]  reason: Expected value '0', Actual value '01'
 TEST_ID=js1_5/Array/regress-101964.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test -  reason: Expected value 'Truncation took less than 50 ms', Actual value 'Truncation took `.``*` ms'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 0-10 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'four', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 0-12 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'five', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 0-14 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'six', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 0-16 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'seven', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 0-18 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'eight', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 0-2 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'zero', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 0-20 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'nine', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 0-22 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'ten', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 0-4 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'one', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 0-6 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'two', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 0-8 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'three', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1-10 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'four', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1-12 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'five', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1-14 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'six', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1-16 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'seven', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1-18 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'eight', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1-2 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'zero', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1-20 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'nine', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1-22 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'ten', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1-4 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'one', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1-6 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'two', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1-8 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'three', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 2-10 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'four', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 2-12 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'five', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 2-14 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'six', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 2-16 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'seven', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 2-18 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'eight', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 2-2 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'zero', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 2-20 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'nine', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 2-22 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'ten', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 2-4 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'one', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 2-6 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'two', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 2-8 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'three', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 3-10 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'four', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 3-12 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'five', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 3-14 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'six', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 3-16 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'seven', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 3-18 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'eight', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 3-2 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'zero', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 3-20 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'nine', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 3-22 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'ten', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 3-4 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'one', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 3-6 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'two', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 3-8 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'three', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 4-10 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'four', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 4-12 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'five', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 4-14 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'six', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 4-16 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'seven', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 4-18 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'eight', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 4-2 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'zero', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 4-20 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'nine', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 4-22 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'ten', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 4-4 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'one', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 4-6 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'two', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 4-8 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'three', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 5-10 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'four', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 5-12 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'five', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 5-14 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'six', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 5-16 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'seven', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 5-18 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'eight', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 5-2 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'zero', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 5-20 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'nine', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 5-22 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'ten', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 5-4 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'one', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 5-6 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'two', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 5-8 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'three', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6-10 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'four', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6-12 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'five', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6-14 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'six', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6-16 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'seven', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6-18 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'eight', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6-2 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'zero', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6-20 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'nine', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6-22 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'ten', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6-4 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'one', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6-6 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'two', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6-8 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'three', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 7-10 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'four', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 7-12 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'five', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 7-14 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'six', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 7-16 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'seven', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 7-18 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'eight', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 7-2 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'zero', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 7-20 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'nine', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 7-22 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'ten', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 7-4 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'one', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 7-6 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'two', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 7-8 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'three', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 8-10 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'four', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 8-12 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'five', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 8-14 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'six', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 8-16 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'seven', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 8-18 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'eight', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 8-2 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'zero', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 8-20 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'nine', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 8-22 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'ten', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 8-4 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'one', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 8-6 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'two', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 8-8 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'three', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 9-10 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'four', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 9-12 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'five', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 9-14 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'six', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 9-16 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'seven', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 9-18 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'eight', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 9-2 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'zero', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 9-20 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'nine', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 9-22 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'ten', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 9-4 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'one', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 9-6 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'two', Actual value 'undefined'
-TEST_ID=js1_5/Array/regress-107138.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 9-8 of test -  reason: Type mismatch, expected type string, actual type undefined Expected value 'three', Actual value 'undefined'
 TEST_ID=js1_5/Array/regress-157652.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Array/regress-157652.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Array/regress-157652.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
 TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Error/regress-354246.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Error/regress-354246.js:`.``*`: x is not defined
 TEST_ID=js1_5/Error/regress-354246.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Error/regress-354246.js:`.``*`: x is not defined
 TEST_ID=js1_5/Expressions/regress-394673.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Expressions/regress-394673.js:`.``*`: too much recursion
 TEST_ID=js1_5/Expressions/regress-394673.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Expressions/regress-394673.js:`.``*`: InternalError: too much recursion
 TEST_ID=js1_5/Function/regress-338001.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=Issues with JS_ARENA_ALLOCATE_CAST reason: Expected value 'InternalError: script stack space quota is exhausted', Actual value 'SyntaxError: malformed formal parameter'
 TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
 TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
 TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=Issues with JS_ARENA_ALLOCATE_CAST reason: Expected value 'InternalError: script stack space quota is exhausted', Actual value 'SyntaxError: malformed formal parameter'
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Issues with JS_ARENA_ALLOCATE_CAST reason: Expected value 'InternalError: script stack space quota is exhausted', Actual value 'SyntaxError: malformed formal parameter'
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=Issues with JS_ARENA_ALLOCATE_CAST reason: Expected value 'InternalError: script stack space quota is exhausted', Actual value 'SyntaxError: malformed formal parameter'; messages: BUGNUMBER: 338121; `.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory; SyntaxError: malformed formal parameter
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Issues with JS_ARENA_ALLOCATE_CAST reason: Expected value 'InternalError: script stack space quota is exhausted', Actual value 'SyntaxError: malformed formal parameter'; messages: BUGNUMBER: 338121; `.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory; SyntaxError: malformed formal parameter
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Function/regress-338121-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Function/regress-338121-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-03.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-203278-2.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-203278-2.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-203278-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-203278-2.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=; messages: BUGNUMBER: 338653; This test should never fail explicitly. You must view the memory usage during the test. This test fails if the memory usage repeatedly spikes by several hundred megabytes.
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported`.``*`/js1_5/GC/regress-338653.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported`.``*`/js1_5/GC/regress-338653.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-203278-2.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-203278-2.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-203278-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-203278-2.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
 TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-348532.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-348532.js:`.``*`: too much recursion
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-348532.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-348532.js:`.``*`: too much recursion
 TEST_ID=js1_5/GC/regress-348532.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-348532.js:`.``*`: too much recursion
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
 TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
 TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/Regress/regress-203278-1.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-203278-1.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-203278-1.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-203278-1.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-203278-1.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-203278-1.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-203278-1.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-203278-1.js:`.``*`: out of memory
 TEST_ID=js1_5/Regress/regress-252892.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: top != 0, at `.``*`jsopcode.c:
 TEST_ID=js1_5/Regress/regress-252892.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: top != 0, at `.``*`jsopcode.c:
 TEST_ID=js1_5/Regress/regress-252892.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=;
 TEST_ID=js1_5/Regress/regress-252892.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=for (var i in o) in heavyweight function f should define i in f's activation reason: Expected value 'true', Actual value 'false'
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
 TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
 TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
 TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
 TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.* SIGABRT, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.* SIGABRT, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-274035.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=;
-TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=;
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-274035.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-274035.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-312588.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-314401.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-314401.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-314401.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Regress/regress-319384.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-319384.js:`.``*`: can't convert "foo" to an integer
 TEST_ID=js1_5/Regress/regress-320119.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=delegating objects and arguments, arity, caller, name: arguments no longer shared reason: Expected value 'false', Actual value 'true'
 TEST_ID=js1_5/Regress/regress-320119.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=delegating objects and arguments, arity, caller, name: arity no longer shared reason: Expected value 'false', Actual value 'true'
 TEST_ID=js1_5/Regress/regress-320119.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=delegating objects and arguments, arity, caller, name: caller no longer shared reason: Expected value 'false', Actual value 'true'
 TEST_ID=js1_5/Regress/regress-320119.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=delegating objects and arguments, arity, caller, name: name no longer shared reason: Expected value 'false', Actual value 'true'
@@ -452,28 +356,23 @@ TEST_ID=js1_5/Regress/regress-352604.js,
 TEST_ID=js1_5/Regress/regress-352604.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !OBJ_GET_PROTO(cx, ctor), at `.``*`jsapi.c:
 TEST_ID=js1_5/Regress/regress-352604.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_5/Regress/regress-362583.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: caller->fun && !JSFUN_HEAVYWEIGHT_TEST(caller->fun->flags), at `.``*`jsscript.c:
 TEST_ID=js1_5/Regress/regress-362583.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: caller->fun && !JSFUN_HEAVYWEIGHT_TEST(caller->fun->flags), at `.``*`jsscript.c:
 TEST_ID=js1_5/Regress/regress-362583.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Regress/regress-383674.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Statement that implicitly calls toString should not be optimized away as a "useless expression": 1 reason: Expected value 'toString called', Actual value 'toString not called'
 TEST_ID=js1_5/Regress/regress-383674.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Statement that implicitly calls toString should not be optimized away as a "useless expression": 2 reason: Expected value 'toString called', Actual value 'toString not called'
 TEST_ID=js1_5/Regress/regress-417893.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: top != 0, at `.``*`jsopcode.c:
 TEST_ID=js1_5/Regress/regress-417893.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: top != 0, at `.``*`jsopcode.c:
 TEST_ID=js1_5/Regress/regress-417893.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=;
 TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
-TEST_ID=js1_5/Scope/regress-154693.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test -  reason: Expected value 'true', Actual value 'false'
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
+TEST_ID=js1_5/Scope/regress-154693.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test -  reason: Expected value 'true', Actual value 'false'
 TEST_ID=js1_5/decompilation/regress-351219.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of immutable infinity, NaN decompile Infinity as 1/0 reason: Expected value ' function ( ) { return 1 / 0 ; } ', Actual value ' function ( ) { return Infinity ; } '
 TEST_ID=js1_5/decompilation/regress-351219.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of immutable infinity, NaN: decompile NaN as 0/0 reason: Expected value ' function ( ) { var NaN = 0 / 0 ; return NaN ; } ', Actual value ' function ( ) { var NaN = NaN ; return NaN ; } '
 TEST_ID=js1_5/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of new parenthetic expressions reason: Expected value ' function ( ) { new ( x ( y ) ( z ) ) ; } ', Actual value ' function ( ) { new x ( y ) ( z ) ; } '
 TEST_ID=js1_5/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of new parenthetic expressions reason: Expected value ' function ( ) { new ( x ( y ) . z ) ; } ', Actual value ' function ( ) { new x ( y ) . z ; } '
 TEST_ID=js1_5/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of new parenthetic expressions reason: Expected value ' function ( ) { new ( x ( z ) ) ( w ) ; } ', Actual value ' function ( ) { new x ( z ) ( w ) ; } '
@@ -488,53 +387,45 @@ TEST_ID=js1_5/decompilation/regress-3758
 TEST_ID=js1_5/decompilation/regress-375882.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of switch with case 0/0 reason: Expected value ' function ( ) { switch ( a ) { case 0 / 0 : a ; case 1 / 0 : b ; case 1 / - 0 : c ; case - 0 : d ; default : ; } } ', Actual value ' function ( ) { switch ( a ) { case NaN : a ; case Infinity : b ; case - Infinity : c ; case 0 : d ; default : ; } } '
 TEST_ID=js1_5/decompilation/regress-376564.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of new (eval()) reason: Expected value ' function ( ) { new ( eval ( ) ) ; } ', Actual value ' function ( ) { new eval ; } '
 TEST_ID=js1_5/decompilation/regress-376564.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of new (eval()) reason: Expected value ' function ( ) { new ( g ( ) ) ; } ', Actual value ' function ( ) { new g ; } '
 TEST_ID=js1_5/decompilation/regress-383721.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompiling Tabs: toString reason: Expected value ' function ( ) { return "\ t "; } ', Actual value ' function ( ) { return " "; } '
 TEST_ID=js1_5/decompilation/regress-383721.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompiling Tabs: uneval reason: Expected value ' ( function ( ) { return "\ t "; } ) ', Actual value ' ( function ( ) { return " "; } ) '
-TEST_ID=js1_5/extensions/regress-164697.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=([]).__proto__ == Array.prototype reason: Expected value 'true', Actual value 'false'
-TEST_ID=js1_5/extensions/regress-164697.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=(new Array()).__proto__ == Array.prototype reason: Expected value 'true', Actual value 'false'
+TEST_ID=js1_5/extensions/regress-164697.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=([]).__proto__ == Array.prototype reason: Expected value 'true', Actual value 'false'
+TEST_ID=js1_5/extensions/regress-164697.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=(new Array()).__proto__ == Array.prototype reason: Expected value 'true', Actual value 'false'
 TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
-TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
 TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
+TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
+TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
 TEST_ID=js1_5/extensions/regress-304897.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=uneval("\t"), uneval("\x09") reason: Expected value '"\t"', Actual value '"\x09"'
 TEST_ID=js1_5/extensions/regress-322957.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=TryMethod should not eat getter exceptions reason: Type mismatch, expected type boolean, actual type number Expected value 'true', Actual value '-1'
 TEST_ID=js1_5/extensions/regress-330569.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-336409-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-336410-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-342960.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-342960.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-342960.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-350531.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-350531.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-350531.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-350531.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-351448.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-351463-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Treat hyphens as not special adjacent to CharacterClassEscapes in character classes: /([\d-\S]+)/.exec("a0- z") reason: Expected value 'a0-,a0-', Actual value 'SyntaxError: invalid range in character class'
 TEST_ID=js1_5/extensions/regress-351463-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Treat hyphens as not special adjacent to CharacterClassEscapes in character classes: /([\d-\s]+)/.exec("a0- z") reason: Expected value '0- ,0- ', Actual value 'SyntaxError: invalid range in character class'
 TEST_ID=js1_5/extensions/regress-352455.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Eval object with non-function getters/setters reason: Expected value 'SyntaxError: invalid getter usage', Actual value ''
 TEST_ID=js1_5/extensions/regress-352604.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !OBJ_GET_PROTO(cx, ctor), at `.``*`jsapi.c:
@@ -553,12 +444,12 @@ TEST_ID=js1_5/extensions/regress-355820.
 TEST_ID=js1_5/extensions/regress-355820.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Remove non-standard Script object reason: Expected value 'undefined', Actual value 'function'
 TEST_ID=js1_5/extensions/regress-356085.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=js_obj_toString for getter/setter reason: Expected value ' ( { set p y ( ) { } } ) ', Actual value ' ( { set p ( ) { } } ) '
 TEST_ID=js1_5/extensions/regress-365869.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=strict warning for object literal with duplicate propery names reason: Expected value 'TypeError: redeclaration of property 1', Actual value 'No warning'
 TEST_ID=js1_5/extensions/regress-365869.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=strict warning for object literal with duplicate propery names reason: Expected value 'TypeError: redeclaration of property a', Actual value 'No warning'
 TEST_ID=js1_5/extensions/regress-367923.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=strict warning for variable redeclares argument reason: Expected value 'TypeError: variable v redeclares argument', Actual value 'TypeError: variable v hides argument'
+TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
 TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
-TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
 TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-375801.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=uneval should use "(void 0)" instead of "undefined": uneval reason: Expected value ' ( { a : ( void 0 ) } ) ', Actual value ' ( { a : undefined } ) '
 TEST_ID=js1_5/extensions/regress-376052.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=javascript.options.anonfunfix to allow function (){} expressions: 3 reason: Expected value 'SyntaxError: syntax error', Actual value 'No Error'
@@ -577,35 +468,38 @@ TEST_ID=js1_5/extensions/regress-385134.
 TEST_ID=js1_5/extensions/regress-385134.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-394967.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-407019.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not assert: !JS_IsExceptionPending(cx) - Browser only reason: Expected match to '/Illegal operation on WrappedNative prototype object/', Actual value 'TypeError: window.Option is not a function'
 TEST_ID=js1_5/extensions/regress-422592.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-422592.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: [1].__count__ reason: Expected value '1', Actual value '3'
-TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: [1].__count__ reason: Expected value '9', Actual value '3'
-TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: [].__count__ reason: Expected value '0', Actual value '3'
-TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: x.test1 reason: Expected value 'true', Actual value 'false'
-TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: x.test2 reason: Expected value 'false', Actual value 'true'
-TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: x.test3 (1) reason: Expected value 'true', Actual value 'false'
-TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: y.__count__ reason: Expected value '4', Actual value '3'
 TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: [1].__count__ reason: Expected value '1', Actual value '3'
 TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: [1].__count__ reason: Expected value '9', Actual value '3'
 TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: [].__count__ reason: Expected value '0', Actual value '3'
 TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: x.test1 reason: Expected value 'true', Actual value 'false'
 TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: x.test2 reason: Expected value 'false', Actual value 'true'
 TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: x.test3 (1) reason: Expected value 'true', Actual value 'false'
 TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: y.__count__ reason: Expected value '4', Actual value '3'
-TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 1 reason: Expected value 'watcher: propname=length, oldval=0, newval=1; ', Actual value 'TypeError: can't watch non-native objects of class Array'
-TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 2 reason: Expected value 'watcher: propname=length, oldval=1, newval=2; watcher: propname=length, oldval=2, newval=2; ', Actual value ''
-TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 3 reason: Expected value 'watcher: propname=length, oldval=2, newval=1; ', Actual value ''
-TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 4 reason: Expected value 'watcher: propname=length, oldval=1, newval=2; ', Actual value ''
-TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 5 reason: Expected value 'watcher: propname=length, oldval=2, newval=5; ', Actual value ''
+TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: [1].__count__ reason: Expected value '1', Actual value '3'
+TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: [1].__count__ reason: Expected value '9', Actual value '3'
+TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: [].__count__ reason: Expected value '0', Actual value '3'
+TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: x.test1 reason: Expected value 'true', Actual value 'false'
+TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: x.test2 reason: Expected value 'false', Actual value 'true'
+TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: x.test3 (1) reason: Expected value 'true', Actual value 'false'
+TEST_ID=js1_5/extensions/regress-434837-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=|this| in accessors in prototype chain of array: y.__count__ reason: Expected value '4', Actual value '3'
+TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 1 reason: Expected value 'watcher: propname=length, oldval=0, newval=1; ', Actual value ''
+TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 2 reason: Expected value 'watcher: propname=length, oldval=1, newval=2; watcher: propname=length, oldval=2, newval=2; ', Actual value 'watcher: propname=length, oldval=undefined, newval=2; '
+TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 3 reason: Expected value 'watcher: propname=length, oldval=2, newval=1; ', Actual value 'watcher: propname=length, oldval=undefined, newval=1; '
+TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 4 reason: Expected value 'watcher: propname=length, oldval=1, newval=2; ', Actual value 'watcher: propname=length, oldval=undefined, newval=2; '
+TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 5 reason: Expected value 'watcher: propname=length, oldval=2, newval=5; ', Actual value 'watcher: propname=length, oldval=undefined, newval=5; '
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 1 reason: Expected value 'watcher: propname=length, oldval=0, newval=1; ', Actual value ''
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 2 reason: Expected value 'watcher: propname=length, oldval=1, newval=2; watcher: propname=length, oldval=2, newval=2; ', Actual value 'watcher: propname=length, oldval=undefined, newval=2; '
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 3 reason: Expected value 'watcher: propname=length, oldval=2, newval=1; ', Actual value 'watcher: propname=length, oldval=undefined, newval=1; '
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 4 reason: Expected value 'watcher: propname=length, oldval=1, newval=2; ', Actual value 'watcher: propname=length, oldval=undefined, newval=2; '
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 5 reason: Expected value 'watcher: propname=length, oldval=2, newval=5; ', Actual value 'watcher: propname=length, oldval=undefined, newval=5; '
-TEST_ID=js1_5/extensions/regress-443569.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-443569.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-443569.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-443569.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-443569.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-1 99', Actual value '-001 -1'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-51 49', Actual value '-051 -51'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value '-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51', Actual value '-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'xxx-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51', Actual value 'xxx-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'Sat Jan 01 -0051 00:00:00 `.``*`', Actual value 'xxxx-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51'
@@ -724,28 +618,27 @@ TEST_ID=js1_7/geniter/regress-349012-01.
 TEST_ID=js1_7/geniter/regress-349012-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=closing a generator fails to report error if yield during close is ignored reason: Expected value 'Inner finally,Outer finally', Actual value ''
 TEST_ID=js1_7/geniter/regress-349331.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=test GC-invoke close reason: Expected value 'true', Actual value 'false'
 TEST_ID=js1_7/geniter/regress-349331.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=test GC-invoke close reason: Expected value 'true', Actual value 'false'
 TEST_ID=js1_7/iterable/regress-340526-02.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Iterators: cross-referenced objects with close handler can delay close handler execution reason: Expected value '2', Actual value '0'
 TEST_ID=js1_7/iterable/regress-340526-02.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Iterators: cross-referenced objects with close handler can delay close handler execution reason: Expected value '2', Actual value '0'
-TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_7/iterable/regress-415922.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Support exception from withing JSNewEnumerateOp on JSENUMERATE_NEXT reason: Expected value 'Error: its enumeration failed', Actual value 'No exception r: color'
 TEST_ID=js1_7/lexical/regress-346642-03.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 8 reason: Expected value 'TypeError: ++x is not a function', Actual value 'TypeError: ++e1 is not a function'
 TEST_ID=js1_7/lexical/regress-346642-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 2 reason: Expected match to '/TypeError: x.t (has no properties|is undefined)/', Actual value 'TypeError: e1.t has no properties'
 TEST_ID=js1_7/lexical/regress-346642-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 2 reason: Expected match to '/TypeError: x.t (has no properties|is undefined)/', Actual value 'TypeError: e1.t is undefined'
 TEST_ID=js1_7/lexical/regress-346642-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 2 reason: Expected match to '/TypeError: x.t (has no properties|is undefined)/', Actual value 'TypeError: e1.t is undefined'
 TEST_ID=js1_7/lexical/regress-351515.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Invalid uses of yield, let keywords in js17: global: yield = 1 reason: Expected value 'SyntaxError: syntax error', Actual value 'SyntaxError: yield not in function'
 TEST_ID=js1_7/regexp/yflag.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/regexp/yflag.js:`.``*`: invalid flag after regular expression
 TEST_ID=js1_7/regexp/yflag.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_7/regexp/yflag.js:`.``*`: SyntaxError: invalid flag after regular expression
+TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=
+TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=
 TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-350387.js:`.``*`: x is not defined
 TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-350387.js:`.``*`: ReferenceError: x is not defined
 TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: http://test.mozilla.com//tests/mozilla.org/js/js1_7/regress/regress-350387.js:`.``*`: x is not defined
-TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=
 TEST_ID=js1_7/regress/regress-361566.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-361566.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-361566.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/regress/regress-363040-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Test reduce of empty array without initializer. : TypeError: reduce of empty array with no initial value reason: Expected value 'TypeError: reduce of empty array with no initial value', Actual value 'TypeError: arr0elms.reduce is not a function'
 TEST_ID=js1_7/regress/regress-363040-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Test reduceRight of empty array without initializer. : TypeError: reduce of empty array with no initial value reason: Expected value 'TypeError: reduce of empty array with no initial value', Actual value 'TypeError: arr0elms.reduceRight is not a function'
@@ -765,9 +658,9 @@ TEST_ID=js1_7/regress/regress-373828.js,
 TEST_ID=js1_7/regress/regress-373828.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: op == JSOP_LEAVEBLOCKEXPR ? fp->spbase + OBJ_BLOCK_DEPTH(cx, obj) == sp - 1 : fp->spbase + OBJ_BLOCK_DEPTH(cx, obj) == sp, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-373828.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/regress/regress-375695.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-375695.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-375695.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
-TEST_ID=js1_7/regress/regress-385133-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_7/regress/regress-406477.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=eval of function x() in a function with an argument "x" and "let x" reason: Expected value '', Actual value 'Unexpected test_param_result value: 1NLUnexpected test_var_result value: 1NL'
 TEST_ID=js1_7/regress/regress-410649.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=type for destructuring parameter case reason: Expected value 'function', Actual value 'number'
+TEST_ID=js1_8/genexps/regress-380237-04.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_8/genexps/regress-380237-04.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Generator expressions parenthesization test: roundTripTest no round-trip change reason: Expected value 'function anonymous() {NL    for (;;) {NL    }NL}', Actual value 'function anonymous() {NL    for (; (x * x for (x in []));) {NL    }NL}'
diff -r f3ac957eb4af js/tests/test.sh
--- a/js/tests/test.sh	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/tests/test.sh	Sat Sep 06 10:14:37 2008 +0300
@@ -164,11 +164,12 @@ if [[ -n "$javascriptoptions" ]]; then
                 ;;
             z)
                 splitobjects="-z"
                 ;;
             j)
-                jit="-j"
+                jitshell="-j"
+                jitbrowser=";jit"
                 ;;
         esac
     done
 fi
 
@@ -414,11 +415,11 @@ case $testtype in
                     $EXECUTABLE_DRIVER \
                     $executable -v $version \
                     -S 524288 \
                     $gczealshell \
                     $splitobjects \
-                    $jit \
+                    $jitshell \
                     -f ./shell.js \
                     -f $suitetestdir/shell.js \
                     -f $subsuitetestdir/shell.js \
                     -f ./$jsfile \
                     -f ./js-test-driver-end.js; then
@@ -467,12 +468,12 @@ EOF
 
             if ! grep -q $jsfile $excludetestsfile; then
 
                 version=";version=`browserfileversion $jsfile`"
                 
-                echo "http://$TEST_HTTP/$TEST_WWW_JS/js-test-driver-standards.html?test=$jsfile;language=type;text/javascript$version$gczealbrowser" >> $urllist
-                echo "<li><a href='http://$TEST_HTTP/$TEST_WWW_JS/js-test-driver-standards.html?test=$jsfile;language=type;text/javascript$version$gczealbrowser'>$jsfile</a></li>" >> $urlhtml
+                echo "http://$TEST_HTTP/$TEST_WWW_JS/js-test-driver-standards.html?test=$jsfile;language=type;text/javascript$version$gczealbrowser$jitbrowser" >> $urllist
+                echo "<li><a href='http://$TEST_HTTP/$TEST_WWW_JS/js-test-driver-standards.html?test=$jsfile;language=type;text/javascript$version$gczealbrowser$jitbrowser'>$jsfile</a></li>" >> $urlhtml
             fi
         done
 
         cat >> $urlhtml <<EOF
 </ul>
diff -r f3ac957eb4af js/tests/universe.data
--- a/js/tests/universe.data	Thu Sep 04 12:36:46 2008 -0400
+++ b/js/tests/universe.data	Sat Sep 06 10:14:37 2008 +0300
@@ -1,13 +1,9 @@ TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST
 TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
@@ -16,34 +12,21 @@ TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=1, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
@@ -52,37 +35,27 @@ TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
-TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
diff -r f3ac957eb4af layout/base/nsIPresShell.h
--- a/layout/base/nsIPresShell.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/base/nsIPresShell.h	Sat Sep 06 10:14:37 2008 +0300
@@ -101,14 +101,14 @@ class gfxContext;
 
 typedef short SelectionType;
 typedef PRUint32 nsFrameState;
 
 
-// 23e048f6-49bb-4ac4-b900-c63865363ad3
+// 134e504f-4fd1-4590-9f5d-899afee63d0f
 #define NS_IPRESSHELL_IID \
-{ 0x23e048f6, 0x49bb, 0x4ac4, \
-  { 0xb9, 0x00, 0xc6, 0x38, 0x65, 0x36, 0x3a, 0xd3 } }
+{ 0x134e504f, 0x4fd1, 0x4590, \
+  { 0x9f, 0x5d, 0x89, 0x9a, 0xfe, 0xe6, 0x3d, 0x0f } }
 
 // Constants for ScrollContentIntoView() function
 #define NS_PRESSHELL_SCROLL_TOP      0
 #define NS_PRESSHELL_SCROLL_BOTTOM   100
 #define NS_PRESSHELL_SCROLL_LEFT     0
@@ -343,19 +343,10 @@ public:
    * In the case of absolutely positioned elements and floated elements,
    * the real primary frame is the frame that is out of the flow and not the
    * placeholder frame.
    */
   virtual NS_HIDDEN_(nsIFrame*) GetRealPrimaryFrameFor(nsIContent* aContent) const = 0;
-
-  /**
-   * Returns a layout object associated with the primary frame for the content object.
-   *
-   * @param aContent   the content object for which we seek a layout object
-   * @param aResult    the resulting layout object as an nsISupports, if found.
-   */
-  NS_IMETHOD GetLayoutObjectFor(nsIContent*   aContent,
-                                nsISupports** aResult) const = 0;
 
   /**
    * Gets the placeholder frame associated with the specified frame. This is
    * a helper frame that forwards the request to the frame manager.
    */
diff -r f3ac957eb4af layout/base/nsLayoutUtils.cpp
--- a/layout/base/nsLayoutUtils.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/base/nsLayoutUtils.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -262,12 +262,11 @@ nsLayoutUtils::IsGeneratedContentFor(nsI
     (aPseudoElement == nsCSSPseudoElements::before);
 }
 
 // static
 nsIFrame*
-nsLayoutUtils::GetCrossDocParentFrame(const nsIFrame* aFrame,
-                                      nsPoint* aExtraOffset)
+nsLayoutUtils::GetCrossDocParentFrame(nsIFrame* aFrame)
 {
   nsIFrame* p = aFrame->GetParent();
   if (p)
     return p;
 
@@ -275,13 +274,10 @@ nsLayoutUtils::GetCrossDocParentFrame(co
   if (!v)
     return nsnull;
   v = v->GetParent(); // anonymous inner view
   if (!v)
     return nsnull;
-  if (aExtraOffset) {
-    *aExtraOffset += v->GetPosition();
-  }
   v = v->GetParent(); // subdocumentframe's view
   if (!v)
     return nsnull;
   return static_cast<nsIFrame*>(v->GetClientData());
 }
diff -r f3ac957eb4af layout/base/nsLayoutUtils.h
--- a/layout/base/nsLayoutUtils.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/base/nsLayoutUtils.h	Sat Sep 06 10:14:37 2008 +0300
@@ -227,15 +227,12 @@ public:
 
   /**
    * Get the parent of aFrame. If aFrame is the root frame for a document,
    * and the document has a parent document in the same view hierarchy, then
    * we try to return the subdocumentframe in the parent document.
-   * @param aExtraOffset [in/out] if non-null, then as we cross documents
-   * an extra offset may be required and it will be added to aCrossDocOffset
    */
-  static nsIFrame* GetCrossDocParentFrame(const nsIFrame* aFrame,
-                                          nsPoint* aCrossDocOffset = nsnull);
+  static nsIFrame* GetCrossDocParentFrame(nsIFrame* aFrame);
   
   /**
    * IsProperAncestorFrame checks whether aAncestorFrame is an ancestor
    * of aFrame and not equal to aFrame.
    * @param aCommonAncestor nsnull, or a common ancestor of aFrame and
diff -r f3ac957eb4af layout/base/nsPresShell.cpp
--- a/layout/base/nsPresShell.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/base/nsPresShell.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -812,12 +812,10 @@ public:
   NS_IMETHOD StyleChangeReflow();
   NS_IMETHOD GetPageSequenceFrame(nsIPageSequenceFrame** aResult) const;
   virtual NS_HIDDEN_(nsIFrame*) GetPrimaryFrameFor(nsIContent* aContent) const;
   virtual NS_HIDDEN_(nsIFrame*) GetRealPrimaryFrameFor(nsIContent* aContent) const;
 
-  NS_IMETHOD GetLayoutObjectFor(nsIContent*   aContent,
-                                nsISupports** aResult) const;
   NS_IMETHOD GetPlaceholderFrameFor(nsIFrame*  aFrame,
                                     nsIFrame** aPlaceholderFrame) const;
   NS_IMETHOD FrameNeedsReflow(nsIFrame *aFrame, IntrinsicDirty aIntrinsicDirty,
                               nsFrameState aBitToAdd);
   NS_IMETHOD CancelAllPendingReflows();
@@ -4899,28 +4897,10 @@ PresShell::GetRealPrimaryFrameFor(nsICon
 {
   nsIFrame *primaryFrame = FrameManager()->GetPrimaryFrameFor(aContent, -1);
   if (!primaryFrame)
     return nsnull;
   return nsPlaceholderFrame::GetRealFrameFor(primaryFrame);
-}
-
-NS_IMETHODIMP
-PresShell::GetLayoutObjectFor(nsIContent*   aContent,
-                              nsISupports** aResult) const 
-{
-  nsresult result = NS_ERROR_NULL_POINTER;
-  if ((nsnull!=aResult) && (nsnull!=aContent))
-  {
-    *aResult = nsnull;
-    nsIFrame *primaryFrame = GetPrimaryFrameFor(aContent);
-    if (primaryFrame)
-    {
-      result = primaryFrame->QueryInterface(NS_GET_IID(nsISupports),
-                                            (void**)aResult);
-    }
-  }
-  return result;
 }
 
 NS_IMETHODIMP
 PresShell::GetPlaceholderFrameFor(nsIFrame*  aFrame,
                                   nsIFrame** aResult) const
diff -r f3ac957eb4af layout/forms/nsComboboxControlFrame.cpp
--- a/layout/forms/nsComboboxControlFrame.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/forms/nsComboboxControlFrame.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -477,11 +477,11 @@ nsComboboxControlFrame::ReflowDropdown(n
     viewManager->ResizeView(view, emptyRect);
   }
   
   // Allow the child to move/size/change-visibility its view if it's currently
   // dropped down
-  PRInt32 flags = NS_FRAME_NO_MOVE_FRAME | NS_FRAME_NO_VISIBILITY | NS_FRAME_NO_SIZE_VIEW;
+  PRInt32 flags = NS_FRAME_NO_MOVE_VIEW | NS_FRAME_NO_VISIBILITY | NS_FRAME_NO_SIZE_VIEW;
   if (mDroppedDown) {
     flags = 0;
   }
   nsRect rect = mDropdownFrame->GetRect();
   nsHTMLReflowMetrics desiredSize;
diff -r f3ac957eb4af layout/generic/nsContainerFrame.cpp
--- a/layout/generic/nsContainerFrame.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/generic/nsContainerFrame.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -762,11 +762,11 @@ nsContainerFrame::ReflowChild(nsIFrame* 
 
   // Send the WillReflow() notification, and position the child frame
   // and its view if requested
   aKidFrame->WillReflow(aPresContext);
 
-  if (NS_FRAME_NO_MOVE_FRAME == (aFlags & NS_FRAME_NO_MOVE_FRAME)) {
+  if (0 == (aFlags & NS_FRAME_NO_MOVE_FRAME)) {
     if ((aFlags & NS_FRAME_INVALIDATE_ON_MOVE) &&
         !(aKidFrame->GetStateBits() & NS_FRAME_FIRST_REFLOW) &&
         aKidFrame->GetPosition() != nsPoint(aX, aY)) {
       aKidFrame->InvalidateOverflowRect();
     }
diff -r f3ac957eb4af layout/generic/nsFrame.cpp
--- a/layout/generic/nsFrame.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/generic/nsFrame.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -2152,11 +2152,11 @@ NS_IMETHODIMP nsFrame::HandleDrag(nsPres
 {
   PRBool  selectable;
   PRUint8 selectStyle;
   IsSelectable(&selectable, &selectStyle);
   // XXX Do we really need to exclude non-selectable content here?
-  // GetContentOffsetsFromPoint can handle it just fine, although some
+  // GetContentAndOffsetsFromPoint can handle it just fine, although some
   // other stuff might not like it.
   if (!selectable)
     return NS_OK;
   if (DisplaySelection(aPresContext) == nsISelectionController::SELECTION_OFF) {
     return NS_OK;
@@ -3450,29 +3450,26 @@ nsPoint nsIFrame::GetOffsetToExternal(co
 
 nsPoint nsIFrame::GetOffsetTo(const nsIFrame* aOther) const
 {
   NS_PRECONDITION(aOther,
                   "Must have frame for destination coordinate system!");
+  // Note that if we hit a view while walking up the frame tree we need to stop
+  // and switch to traversing the view tree so that we will deal with scroll
+  // views properly.
   nsPoint offset(0, 0);
   const nsIFrame* f;
-  for (f = this; f != aOther && f;
-       f = nsLayoutUtils::GetCrossDocParentFrame(f, &offset)) {
+  for (f = this; !f->HasView() && f != aOther; f = f->GetParent()) {
     offset += f->GetPosition();
   }
-
+  
   if (f != aOther) {
-    // Looks like aOther wasn't an ancestor of |this|.  So now we have
-    // the root-document-relative position of |this| in |offset|.  Convert back
-    // to the coordinates of aOther
-    nsPoint negativeOffset(0,0);
-    while (aOther) {
-      offset -= aOther->GetPosition();
-      aOther = nsLayoutUtils::GetCrossDocParentFrame(aOther, &negativeOffset);
-    }
-    offset -= negativeOffset;
-  }
-
+    // We found a view.  Switch to the view tree
+    nsPoint toViewOffset(0, 0);
+    nsIView* otherView = aOther->GetClosestView(&toViewOffset);
+    offset += f->GetView()->GetOffsetTo(otherView) - toViewOffset;
+  }
+  
   return offset;
 }
 
 // virtual
 nsIntRect nsIFrame::GetScreenRectExternal() const
@@ -3533,10 +3530,92 @@ NS_IMETHODIMP nsFrame::GetOffsetFromView
     frame = frame->GetParent();
   } while (frame && !frame->HasView());
   if (frame)
     *aView = frame->GetView();
   return NS_OK;
+}
+
+// The (x,y) value of the frame's upper left corner is always
+// relative to its parentFrame's upper left corner, unless
+// its parentFrame has a view associated with it, in which case, it
+// will be relative to the upper left corner of the view returned
+// by a call to parentFrame->GetView().
+//
+// This means that while drilling down the frame hierarchy, from
+// parent to child frame, we sometimes need to take into account
+// crossing these view boundaries, because the coordinate system
+// changes from parent frame coordinate system, to the associated
+// view's coordinate system.
+//
+// GetOriginToViewOffset() is a utility method that returns the
+// offset necessary to map a point, relative to the frame's upper
+// left corner, into the coordinate system of the view associated
+// with the frame.
+//
+// If there is no view associated with the frame, or the view is
+// not a descendant of the frame's parent view (ex: scrolling popup menu),
+// the offset returned will be (0,0).
+
+NS_IMETHODIMP nsFrame::GetOriginToViewOffset(nsPoint&        aOffset,
+                                             nsIView**       aView) const
+{
+  nsresult rv = NS_OK;
+
+  aOffset.MoveTo(0,0);
+
+  if (aView)
+    *aView = nsnull;
+
+  if (HasView()) {
+    nsIView *view = GetView();
+    nsIView *parentView = nsnull;
+    nsPoint offsetToParentView;
+    rv = GetOffsetFromView(offsetToParentView, &parentView);
+
+    if (NS_SUCCEEDED(rv)) {
+      nsPoint viewOffsetFromParent(0,0);
+      nsIView *pview = view;
+
+      nsIViewManager* vVM = view->GetViewManager();
+
+      while (pview && pview != parentView) {
+        viewOffsetFromParent += pview->GetPosition();
+
+        nsIView *tmpView = pview->GetParent();
+        if (tmpView && vVM != tmpView->GetViewManager()) {
+          // Don't cross ViewManager boundaries!
+          // XXXbz why not?
+          break;
+        }
+        pview = tmpView;
+      }
+
+#ifdef DEBUG_KIN
+      if (pview != parentView) {
+        // XXX: At this point, pview is probably null since it traversed
+        //      all the way up view's parent hierarchy and did not run across
+        //      parentView. In the future, instead of just returning an offset
+        //      of (0,0) for this case, we may want offsetToParentView to
+        //      include the offset from the parentView to the top of the
+        //      view hierarchy which would make both offsetToParentView and
+        //      viewOffsetFromParent, offsets to the global coordinate space.
+        //      We'd have to investigate any perf impact this would have before
+        //      checking in such a change, so for now we just return (0,0).
+        //      -- kin    
+        NS_WARNING("view is not a descendant of parentView!");
+      }
+#endif // DEBUG
+
+      if (pview == parentView)
+        aOffset = offsetToParentView - viewOffsetFromParent;
+
+      if (aView)
+        *aView = view;
+    }
+  }
+
+  return rv;
 }
 
 /* virtual */ PRBool
 nsIFrame::AreAncestorViewsVisible() const
 {
diff -r f3ac957eb4af layout/generic/nsFrame.h
--- a/layout/generic/nsFrame.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/generic/nsFrame.h	Sat Sep 06 10:14:37 2008 +0300
@@ -226,10 +226,11 @@ public:
   virtual nsIFrame* GetPrevInFlowVirtual() const;
   NS_IMETHOD  SetPrevInFlow(nsIFrame*);
   virtual nsIFrame* GetNextInFlowVirtual() const;
   NS_IMETHOD  SetNextInFlow(nsIFrame*);
   NS_IMETHOD  GetOffsetFromView(nsPoint& aOffset, nsIView** aView) const;
+  NS_IMETHOD  GetOriginToViewOffset(nsPoint& aOffset, nsIView **aView) const;
   virtual nsIAtom* GetType() const;
   virtual PRBool IsContainingBlock() const;
 #ifdef NS_DEBUG
   NS_IMETHOD  List(FILE* out, PRInt32 aIndent) const;
   NS_IMETHOD  GetFrameName(nsAString& aResult) const;
diff -r f3ac957eb4af layout/generic/nsGfxScrollFrame.cpp
--- a/layout/generic/nsGfxScrollFrame.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/generic/nsGfxScrollFrame.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -1791,25 +1791,21 @@ nsGfxScrollFrameInner::InternalScrollPos
   if (mHScrollbarBox)
     SetCoordAttribute(mHScrollbarBox->GetContent(), nsGkAtoms::curpos,
                       aX - GetScrolledRect(GetScrollPortSize()).x);
 }
 
-void
-nsGfxScrollFrameInner::ViewPositionDidChange(nsIScrollableView* aScrollable)
-{
-  // Update frame position to match view offsets
-  nsPoint childOffset = mScrolledFrame->GetView()->GetOffsetTo(mOuter->GetView());
-  mScrolledFrame->SetPosition(childOffset);
-}
-
 /**
  * Called whenever actual scrolling happens for any reason.
  */
 NS_IMETHODIMP
 nsGfxScrollFrameInner::ScrollPositionDidChange(nsIScrollableView* aScrollable, nscoord aX, nscoord aY)
 {
   NS_ASSERTION(!mViewInitiatedScroll, "Cannot reenter ScrollPositionDidChange");
+
+  // Update frame position to match view offsets
+  nsPoint childOffset = mScrolledFrame->GetView()->GetOffsetTo(mOuter->GetView());
+  mScrolledFrame->SetPosition(childOffset);
 
   mViewInitiatedScroll = PR_TRUE;
   InternalScrollPositionDidChange(aX, aY);
   mViewInitiatedScroll = PR_FALSE;
   
diff -r f3ac957eb4af layout/generic/nsGfxScrollFrame.h
--- a/layout/generic/nsGfxScrollFrame.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/generic/nsGfxScrollFrame.h	Sat Sep 06 10:14:37 2008 +0300
@@ -97,11 +97,10 @@ public:
   virtual void ReflowCallbackCanceled();
 
   // nsIScrollPositionListener
 
   NS_IMETHOD ScrollPositionWillChange(nsIScrollableView* aScrollable, nscoord aX, nscoord aY);
-  virtual void ViewPositionDidChange(nsIScrollableView* aScrollable);
   NS_IMETHOD ScrollPositionDidChange(nsIScrollableView* aScrollable, nscoord aX, nscoord aY);
 
   // This gets called when the 'curpos' attribute on one of the scrollbars changes
   void CurPosAttributeChanged(nsIContent* aChild);
   void PostScrollEvent();
diff -r f3ac957eb4af layout/generic/nsHTMLFrame.cpp
--- a/layout/generic/nsHTMLFrame.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/generic/nsHTMLFrame.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -113,12 +113,11 @@ public:
 
   void PaintFocus(nsIRenderingContext& aRenderingContext, nsPoint aPt);
 
   // nsIScrollPositionListener
   NS_IMETHOD ScrollPositionWillChange(nsIScrollableView* aScrollable, nscoord aX, nscoord aY);
-  virtual void ViewPositionDidChange(nsIScrollableView* aScrollable) {}
-  NS_IMETHOD ScrollPositionDidChange(nsIScrollableView* aScrollable, nscoord aX, nscoord aY);
+	NS_IMETHOD ScrollPositionDidChange(nsIScrollableView* aScrollable, nscoord aX, nscoord aY);
 
   // nsICanvasFrame
   NS_IMETHOD SetHasFocus(PRBool aHasFocus);
 
   /**
diff -r f3ac957eb4af layout/generic/nsIFrame.h
--- a/layout/generic/nsIFrame.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/generic/nsIFrame.h	Sat Sep 06 10:14:37 2008 +0300
@@ -102,14 +102,14 @@ struct nsMargin;
 struct nsMargin;
 
 typedef class nsIFrame nsIBox;
 
 // IID for the nsIFrame interface
-// 98a0c040-09cf-408b-b55f-321b4f8d9d67
-#define NS_IFRAME_IID \
-    { 0x98a0c040, 0x09cf, 0x408b, \
-      { 0xb5, 0x5f, 0x32, 0x1b, 0x4f, 0x8d, 0x9d, 0x67 } }
+// 04a7dee5-3435-47dc-bd42-a36c0f66a42c
+  #define NS_IFRAME_IID \
+{ 0x04a7dee5, 0x3435, 0x47dc, \
+  { 0xbd, 0x42, 0xa3, 0x6c, 0x0f, 0x66, 0xa4, 0x2c } }
 
 /**
  * Indication of how the frame can be split. This is used when doing runaround
  * of floats, and when pulling up child frames from a next-in-flow.
  *
@@ -1528,10 +1528,21 @@ public:
    */
   NS_IMETHOD  GetOffsetFromView(nsPoint&  aOffset,
                                 nsIView** aView) const = 0;
 
   /**
+   * Returns the offset from this frame's upper left corner to the upper
+   * left corner of the view returned by a call to GetView(). aOffset
+   * will contain the offset to the view or (0,0) if the frame has no
+   * view. aView will contain a pointer to the view returned by GetView().
+   * aView is optional, that is, you may pass null if you are not interested
+   * in getting a pointer to the view.
+   */
+  NS_IMETHOD  GetOriginToViewOffset(nsPoint&        aOffset,
+                                    nsIView**       aView) const = 0;
+
+  /**
    * Returns true if and only if all views, from |GetClosestView| up to
    * the top of the view hierarchy are visible.
    */
   virtual PRBool AreAncestorViewsVisible() const;
 
diff -r f3ac957eb4af layout/generic/nsObjectFrame.cpp
--- a/layout/generic/nsObjectFrame.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/generic/nsObjectFrame.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -384,11 +384,10 @@ public:
   void CancelTimer();
   void StartTimer(unsigned int aDelay);
 
   // nsIScrollPositionListener interface
   NS_IMETHOD ScrollPositionWillChange(nsIScrollableView* aScrollable, nscoord aX, nscoord aY);
-  virtual void ViewPositionDidChange(nsIScrollableView* aScrollable) {}
   NS_IMETHOD ScrollPositionDidChange(nsIScrollableView* aScrollable, nscoord aX, nscoord aY);
 
   //locals
 
   nsresult Init(nsPresContext* aPresContext, nsObjectFrame* aFrame,
diff -r f3ac957eb4af layout/reftests/bugs/289480-ref.png
Binary file layout/reftests/bugs/289480-ref.png has changed
diff -r f3ac957eb4af layout/reftests/printing/reftest.list
--- a/layout/reftests/printing/reftest.list	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/reftests/printing/reftest.list	Sat Sep 06 10:14:37 2008 +0300
@@ -3,5 +3,6 @@
 
 # Bugs
 == 272830-1.html 272830-1-ref.html
 == 403669-1.html 403669-1-ref.html
 == 381497-n.html 381497-f.html
+== test-async-print.html 272830-1-ref.html
diff -r f3ac957eb4af layout/reftests/printing/test-async-print.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/printing/test-async-print.html	Sat Sep 06 10:14:37 2008 +0300
@@ -0,0 +1,33 @@
+<!DOCTYPE html><html class="reftest-wait reftest-print"><style>html{font-size:12pt}</style>
+<head>
+  <script type="text/javascript">
+
+    window.onload = function (){ 
+                      setTimeout(function() {
+                                   document.documentElement.className = "reftest-print";},
+                                 1000);
+                    }
+  </script>
+</head>
+<body>
+<table>
+ <tbody><tr><td>xxxxxxxxxxxxxxxxxxx</td></tr></tbody>
+ <tbody><tr><td>xxxxxxxxxxxxxxxxxxx</td></tr></tbody>
+ <tbody><tr><td>xxxxxxxxxxxxxxxxxxx</td></tr></tbody>
+ <tbody><tr><td>xxxxxxxxxxxxxxxxxxx</td></tr></tbody>
+ <tbody><tr><td>xxxxxxxxxxxxxxxxxxx</td></tr></tbody>
+ <tbody><tr><td>xxxxxxxxxxxxxxxxxxx</td></tr></tbody>
+ <tbody><tr><td>xxxxxxxxxxxxxxxxxxx</td></tr></tbody>
+ <tbody><tr><td>xxxxxxxxxxxxxxxxxxx</td></tr></tbody>
+ <tbody><tr><td>xxxxxxxxxxxxxxxxxxx</td></tr></tbody>
+ <tbody><tr><td>xxxxxxxxxxxxxxxxxxx</td></tr></tbody>
+ <tbody><tr><td>xxxxxxxxxxxxxxxxxxx</td></tr></tbody>
+ <tbody><tr><td>xxxxxxxxxxxxxxxxxxx</td></tr></tbody>
+ <tbody><tr><td>xxxxxxxxxxxxxxxxxxx</td></tr></tbody>
+ <tbody><tr><td>last line</td></tr></tbody>
+
+</table>
+
+</body>
+
+</html>
diff -r f3ac957eb4af layout/style/nsCSSRuleProcessor.cpp
--- a/layout/style/nsCSSRuleProcessor.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/style/nsCSSRuleProcessor.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -1010,10 +1010,15 @@ RuleProcessorData::GetNthIndex(PRBool aI
   PRInt32 result = 1;
   nsIContent* parent = mParentContent;
 
   PRUint32 childCount = parent->GetChildCount();
   nsIContent * const * curChildPtr = parent->GetChildArray();
+
+#ifdef DEBUG
+  nsMutationGuard debugMutationGuard;
+#endif  
+  
   PRInt32 increment;
   nsIContent * const * stopPtr;
   if (aIsFromEnd) {
     stopPtr = curChildPtr - 1;
     curChildPtr += childCount - 1;
@@ -1043,10 +1048,14 @@ RuleProcessorData::GetNthIndex(PRBool aI
         break;
       }
       ++result;
     }
   }
+
+#ifdef DEBUG
+  NS_ASSERTION(!debugMutationGuard.Mutated(0), "Unexpected mutations happened");
+#endif  
 
   slot = result;
   return result;
 }
 
diff -r f3ac957eb4af layout/style/nsCSSStyleSheet.cpp
--- a/layout/style/nsCSSStyleSheet.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/style/nsCSSStyleSheet.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -735,90 +735,10 @@ nsMediaList::Append(const nsAString& aNe
                    "is an auto array");
   return rv;
 }
 
 // -------------------------------
-// Imports Collection for the DOM
-//
-class CSSImportsCollectionImpl : public nsIDOMStyleSheetList
-{
-public:
-  CSSImportsCollectionImpl(nsICSSStyleSheet *aStyleSheet);
-
-  NS_DECL_ISUPPORTS
-
-  // nsIDOMCSSStyleSheetList interface
-  NS_IMETHOD    GetLength(PRUint32* aLength); 
-  NS_IMETHOD    Item(PRUint32 aIndex, nsIDOMStyleSheet** aReturn); 
-
-  void DropReference() { mStyleSheet = nsnull; }
-
-protected:
-  virtual ~CSSImportsCollectionImpl();
-
-  nsICSSStyleSheet*  mStyleSheet;
-};
-
-CSSImportsCollectionImpl::CSSImportsCollectionImpl(nsICSSStyleSheet *aStyleSheet)
-{
-  // Not reference counted to avoid circular references.
-  // The style sheet will tell us when its going away.
-  mStyleSheet = aStyleSheet;
-}
-
-CSSImportsCollectionImpl::~CSSImportsCollectionImpl()
-{
-}
-
-
-// QueryInterface implementation for CSSImportsCollectionImpl
-NS_INTERFACE_MAP_BEGIN(CSSImportsCollectionImpl)
-  NS_INTERFACE_MAP_ENTRY(nsIDOMStyleSheetList)
-  NS_INTERFACE_MAP_ENTRY(nsISupports)
-  NS_INTERFACE_MAP_ENTRY_CONTENT_CLASSINFO(StyleSheetList)
-NS_INTERFACE_MAP_END
-
-
-NS_IMPL_ADDREF(CSSImportsCollectionImpl)
-NS_IMPL_RELEASE(CSSImportsCollectionImpl)
-
-
-NS_IMETHODIMP
-CSSImportsCollectionImpl::GetLength(PRUint32* aLength)
-{
-  if (nsnull != mStyleSheet) {
-    PRInt32 count;
-    mStyleSheet->StyleSheetCount(count);
-    *aLength = (PRUint32)count;
-  }
-  else {
-    *aLength = 0;
-  }
-
-  return NS_OK;
-}
-
-NS_IMETHODIMP    
-CSSImportsCollectionImpl::Item(PRUint32 aIndex, nsIDOMStyleSheet** aReturn)
-{
-  nsresult result = NS_OK;
-
-  *aReturn = nsnull;
-
-  if (mStyleSheet) {
-    nsCOMPtr<nsICSSStyleSheet> sheet;
-
-    result = mStyleSheet->GetStyleSheetAt(aIndex, *getter_AddRefs(sheet));
-    if (NS_SUCCEEDED(result)) {
-      result = CallQueryInterface(sheet, aReturn);
-    }
-  }
-  
-  return result;
-}
-
-// -------------------------------
 // CSS Style Sheet Inner Data Container
 //
 
 
 static PRBool SetStyleSheetReference(nsICSSRule* aRule, void* aSheet)
@@ -960,11 +880,10 @@ nsCSSStyleSheet::nsCSSStyleSheet()
     mMedia(nsnull),
     mFirstChild(nsnull), 
     mNext(nsnull),
     mParent(nsnull),
     mOwnerRule(nsnull),
-    mImportsCollection(nsnull),
     mRuleCollection(nsnull),
     mDocument(nsnull),
     mOwningNode(nsnull),
     mDisabled(PR_FALSE),
     mDirty(PR_FALSE),
@@ -985,11 +904,10 @@ nsCSSStyleSheet::nsCSSStyleSheet(const n
     mMedia(nsnull),
     mFirstChild(nsnull), 
     mNext(nsnull),
     mParent(aParentToUse),
     mOwnerRule(aOwnerRuleToUse),
-    mImportsCollection(nsnull), // re-created lazily
     mRuleCollection(nsnull), // re-created lazily
     mDocument(aDocumentToUse),
     mOwningNode(aOwningNodeToUse),
     mDisabled(aCopy.mDisabled),
     mDirty(PR_FALSE),
@@ -1044,14 +962,10 @@ nsCSSStyleSheet::~nsCSSStyleSheet()
   }
   NS_IF_RELEASE(mNext);
   if (nsnull != mRuleCollection) {
     mRuleCollection->DropReference();
     NS_RELEASE(mRuleCollection);
-  }
-  if (nsnull != mImportsCollection) {
-    mImportsCollection->DropReference();
-    NS_RELEASE(mImportsCollection);
   }
   if (mMedia) {
     mMedia->SetStyleSheet(nsnull);
     mMedia = nsnull;
   }
@@ -1549,21 +1463,21 @@ nsCSSStyleSheet::EnsureUniqueInner()
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsCSSStyleSheet::Clone(nsICSSStyleSheet* aCloneParent,
-                         nsICSSImportRule* aCloneOwnerRule,
-                         nsIDocument* aCloneDocument,
-                         nsIDOMNode* aCloneOwningNode,
-                         nsICSSStyleSheet** aClone) const
+                       nsICSSImportRule* aCloneOwnerRule,
+                       nsIDocument* aCloneDocument,
+                       nsIDOMNode* aCloneOwningNode,
+                       nsICSSStyleSheet** aClone) const
 {
   NS_PRECONDITION(aClone, "Null out param!");
   nsCSSStyleSheet* clone = new nsCSSStyleSheet(*this,
-                                                   aCloneParent,
-                                                   aCloneOwnerRule,
-                                                   aCloneDocument,
-                                                   aCloneOwningNode);
+                                               aCloneParent,
+                                               aCloneOwnerRule,
+                                               aCloneDocument,
+                                               aCloneOwningNode);
   if (clone) {
     *aClone = static_cast<nsICSSStyleSheet*>(clone);
     NS_ADDREF(*aClone);
   }
   return NS_OK;
diff -r f3ac957eb4af layout/style/nsCSSStyleSheet.h
--- a/layout/style/nsCSSStyleSheet.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/style/nsCSSStyleSheet.h	Sat Sep 06 10:14:37 2008 +0300
@@ -90,11 +90,10 @@ public:
 
 // -------------------------------
 // CSS Style Sheet
 //
 
-class CSSImportsCollectionImpl;
 class CSSRuleListImpl;
 static PRBool CascadeSheetRulesInto(nsICSSStyleSheet* aSheet, void* aData);
 
 class nsCSSStyleSheet : public nsICSSStyleSheet, 
                         public nsIDOMCSSStyleSheet,
@@ -204,11 +203,10 @@ protected:
   nsCSSStyleSheet*      mFirstChild;
   nsCSSStyleSheet*      mNext;
   nsICSSStyleSheet*     mParent;    // weak ref
   nsICSSImportRule*     mOwnerRule; // weak ref
 
-  CSSImportsCollectionImpl* mImportsCollection;
   CSSRuleListImpl*      mRuleCollection;
   nsIDocument*          mDocument; // weak ref; parents maintain this for their children
   nsIDOMNode*           mOwningNode; // weak ref
   PRPackedBool          mDisabled;
   PRPackedBool          mDirty; // has been modified 
diff -r f3ac957eb4af layout/tools/reftest/reftest.js
--- a/layout/tools/reftest/reftest.js	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/tools/reftest/reftest.js	Sat Sep 06 10:14:37 2008 +0300
@@ -354,10 +354,32 @@ function OnDocumentLoad(event)
         return contentRootElement.hasAttribute('class') &&
                contentRootElement.getAttribute('class').split(/\s+/)
                                  .indexOf("reftest-print") != -1;
     }
 
+    function setupPrintMode() {
+       var PSSVC = Components.classes["@mozilla.org/gfx/printsettings-service;1"]
+                  .getService(Components.interfaces.nsIPrintSettingsService);
+       var ps = PSSVC.newPrintSettings;
+       ps.paperWidth = 5;
+       ps.paperHeight = 3;
+
+       // Override any os-specific unwriteable margins
+       ps.unwriteableMarginTop = 0;
+       ps.unwriteableMarginLeft = 0;
+       ps.unwriteableMarginBottom = 0;
+       ps.unwriteableMarginRight = 0;
+
+       ps.headerStrLeft = "";
+       ps.headerStrCenter = "";
+       ps.headerStrRight = "";
+       ps.footerStrLeft = "";
+       ps.footerStrCenter = "";
+       ps.footerStrRight = "";
+       gBrowser.docShell.contentViewer.setPageMode(true, ps);
+    }
+
     if (shouldWait()) {
         // The testcase will let us know when the test snapshot should be made.
         // Register a mutation listener to know when the 'reftest-wait' class
         // gets removed.
         contentRootElement.addEventListener(
@@ -366,35 +388,18 @@ function OnDocumentLoad(event)
                 if (!shouldWait()) {
                     contentRootElement.removeEventListener(
                         "DOMAttrModified",
                         arguments.callee,
                         false);
+                    if (doPrintMode())
+                        setupPrintMode();
                     setTimeout(DocumentLoaded, 0);
                 }
             }, false);
     } else {
-        if (doPrintMode()) {
-            var PSSVC = Components.classes["@mozilla.org/gfx/printsettings-service;1"]
-                    .getService(Components.interfaces.nsIPrintSettingsService);
-            var ps = PSSVC.newPrintSettings;
-            ps.paperWidth = 5;
-            ps.paperHeight = 3;
-
-            // Override any os-specific unwriteable margins
-            ps.unwriteableMarginTop = 0;
-            ps.unwriteableMarginLeft = 0;
-            ps.unwriteableMarginBottom = 0;
-            ps.unwriteableMarginRight = 0;
-
-            ps.headerStrLeft = "";
-            ps.headerStrCenter = "";
-            ps.headerStrRight = "";
-            ps.footerStrLeft = "";
-            ps.footerStrCenter = "";
-            ps.footerStrRight = "";
-            gBrowser.docShell.contentViewer.setPageMode(true, ps);
-        }
+        if (doPrintMode())
+            setupPrintMode();
 
         // Since we can't use a bubbling-phase load listener from chrome,
         // this is a capturing phase listener.  So do setTimeout twice, the
         // first to get us after the onload has fired in the content, and
         // the second to get us after any setTimeout(foo, 0) in the content.
diff -r f3ac957eb4af layout/xul/base/src/nsBox.cpp
--- a/layout/xul/base/src/nsBox.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/xul/base/src/nsBox.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -272,11 +272,11 @@ nsBox::SetBounds(nsBoxLayoutState& aStat
 
     PRUint32 stateFlags = aState.LayoutFlags();
 
     flags |= stateFlags;
 
-    if ((flags & NS_FRAME_NO_MOVE_FRAME) == NS_FRAME_NO_MOVE_FRAME)
+    if (flags & NS_FRAME_NO_MOVE_FRAME)
       SetSize(nsSize(aRect.width, aRect.height));
     else
       SetRect(aRect);
 
     // Nuke the overflow area. The caller is responsible for restoring
diff -r f3ac957eb4af layout/xul/base/src/nsMenuPopupFrame.cpp
--- a/layout/xul/base/src/nsMenuPopupFrame.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/layout/xul/base/src/nsMenuPopupFrame.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -883,13 +883,10 @@ nsMenuPopupFrame::SetPopupPosition(nsIFr
 
   PRBool sizedToPopup = PR_FALSE;
 
   nsPresContext* presContext = PresContext();
   nsIFrame* rootFrame = presContext->PresShell()->FrameManager()->GetRootFrame();
-  NS_ASSERTION(rootFrame->GetView() && GetView() &&
-               rootFrame->GetView() == GetView()->GetParent(),
-               "rootFrame's view is not our view's parent???");
 
   // if the frame is not specified, use the anchor node passed to ShowPopup. If
   // that wasn't specified either, use the root frame. Note that mAnchorContent
   // might be a different document so its presshell must be used.
   if (!aAnchorFrame) {
@@ -1238,13 +1235,15 @@ nsMenuPopupFrame::SetPopupPosition(nsIFr
   }
 
   presContext->GetViewManager()->MoveViewTo(GetView(), xpos, ypos); 
 
   // Now that we've positioned the view, sync up the frame's origin.
-  // Note that (xpos,ypos) is the position relative to rootFrame.
-  nsBoxFrame::SetPosition(nsPoint(xpos, ypos) -
-                          GetParent()->GetOffsetTo(rootFrame));
+  nsPoint frameOrigin = GetPosition();
+  nsPoint offsetToView;
+  GetOriginToViewOffset(offsetToView, nsnull);
+  frameOrigin -= offsetToView;
+  nsBoxFrame::SetPosition(frameOrigin);
 
   if (sizedToPopup) {
     nsBoxLayoutState state(PresContext());
     SetBounds(state, nsRect(mRect.x, mRect.y, parentSize.width, mRect.height));
   }
diff -r f3ac957eb4af modules/libpr0n/build/nsImageModule.cpp
--- a/modules/libpr0n/build/nsImageModule.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/modules/libpr0n/build/nsImageModule.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -51,11 +51,10 @@
 #include "nsIModule.h"
 #include "nsICategoryManager.h"
 #include "nsXPCOMCID.h"
 #include "nsServiceManagerUtils.h"
 
-#include "imgCache.h"
 #include "imgContainer.h"
 #include "imgLoader.h"
 #include "imgRequest.h"
 #include "imgRequestProxy.h"
 #include "imgTools.h"
@@ -97,11 +96,10 @@
 #endif
 
 
 // objects that just require generic constructors
 
-NS_GENERIC_FACTORY_CONSTRUCTOR(imgCache)
 NS_GENERIC_FACTORY_CONSTRUCTOR(imgContainer)
 NS_GENERIC_FACTORY_CONSTRUCTOR(imgLoader)
 NS_GENERIC_FACTORY_CONSTRUCTOR(imgRequestProxy)
 NS_GENERIC_FACTORY_CONSTRUCTOR(imgTools)
 
@@ -201,13 +199,13 @@ static NS_METHOD ImageUnregisterProc(nsI
 }
 
 static const nsModuleComponentInfo components[] =
 {
   { "image cache",
-    NS_IMGCACHE_CID,
+    NS_IMGLOADER_CID,
     "@mozilla.org/image/cache;1",
-    imgCacheConstructor, },
+    imgLoaderConstructor, },
   { "image container",
     NS_IMGCONTAINER_CID,
     "@mozilla.org/image/container;1",
     imgContainerConstructor, },
   { "image loader",
@@ -313,18 +311,18 @@ static const nsModuleComponentInfo compo
 };
 
 PR_STATIC_CALLBACK(nsresult)
 imglib_Initialize(nsIModule* aSelf)
 {
-  imgCache::Init();
+  imgLoader::InitCache();
   return NS_OK;
 }
 
 PR_STATIC_CALLBACK(void)
 imglib_Shutdown(nsIModule* aSelf)
 {
-  imgCache::Shutdown();
+  imgLoader::Shutdown();
 }
 
 NS_IMPL_NSGETMODULE_WITH_CTOR_DTOR(nsImageLib2Module, components,
                                    imglib_Initialize, imglib_Shutdown)
 
diff -r f3ac957eb4af modules/libpr0n/src/Makefile.in
--- a/modules/libpr0n/src/Makefile.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/modules/libpr0n/src/Makefile.in	Sat Sep 06 10:14:37 2008 +0300
@@ -59,11 +59,10 @@ REQUIRES	= xpcom \
 		  xpconnect \
 		  js \
 		  $(NULL)
 
 CPPSRCS		= \
-			imgCache.cpp     \
 			imgContainer.cpp \
 			imgLoader.cpp    \
 			imgRequest.cpp   \
 			imgRequestProxy.cpp \
 			imgTools.cpp
diff -r f3ac957eb4af modules/libpr0n/src/imgCache.cpp
--- a/modules/libpr0n/src/imgCache.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,357 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-
- *
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 2001
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *   Stuart Parmenter <pavlov@netscape.com>
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#include "imgCache.h"
-
-#include "ImageLogging.h"
-
-#include "imgRequest.h"
-
-#include "nsXPIDLString.h"
-#include "nsCOMPtr.h"
-#include "nsIServiceManager.h"
-#include "nsIMemory.h"
-#include "nsIObserverService.h"
-
-#include "nsICache.h"
-#include "nsICacheService.h"
-#include "nsICacheSession.h"
-#include "nsICacheEntryDescriptor.h"
-
-#include "nsIFile.h"
-#include "nsIFileURL.h"
-
-NS_IMPL_ISUPPORTS3(imgCache, imgICache, nsIObserver, nsISupportsWeakReference)
-
-imgCache::imgCache()
-{
-  /* member initializers and constructor code */
-}
-
-imgCache::~imgCache()
-{
-  /* destructor code */
-}
-
-nsresult imgCache::Init()
-{
-  nsresult rv;
-  nsCOMPtr<nsIObserverService> os = do_GetService("@mozilla.org/observer-service;1", &rv);
-  if (NS_FAILED(rv))
-    return rv;
-  
-  imgCache* cache = new imgCache();
-  if(!cache) return NS_ERROR_OUT_OF_MEMORY;
-
-  os->AddObserver(cache, "memory-pressure", PR_FALSE);
-  os->AddObserver(cache, "chrome-flush-skin-caches", PR_FALSE);
-  os->AddObserver(cache, "chrome-flush-caches", PR_FALSE);
-
-  return NS_OK;
-}
-
-/* void clearCache (in boolean chrome); */
-NS_IMETHODIMP imgCache::ClearCache(PRBool chrome)
-{
-  if (chrome)
-    return imgCache::ClearChromeImageCache();
-  else
-    return imgCache::ClearImageCache();
-}
-
-
-/* void removeEntry(in nsIURI uri); */
-NS_IMETHODIMP imgCache::RemoveEntry(nsIURI *uri)
-{
-  if (imgCache::Remove(uri))
-    return NS_OK;
-
-  return NS_ERROR_NOT_AVAILABLE;
-}
-
-/* imgIRequest findEntry(in nsIURI uri); */
-NS_IMETHODIMP imgCache::FindEntryProperties(nsIURI *uri, nsIProperties **_retval)
-{
-  PRBool expired;
-  // This is an owning reference that must be released.
-  imgRequest *request = nsnull;
-  nsCOMPtr<nsICacheEntryDescriptor> entry;
-
-  // addrefs request
-  imgCache::Get(uri, &expired, &request, getter_AddRefs(entry));
-
-  *_retval = nsnull;
-
-  if (request) {
-    *_retval = request->Properties();
-    NS_ADDREF(*_retval);
-  }
-
-  NS_IF_RELEASE(request);
-
-  return NS_OK;
-}
-
-
-static nsCOMPtr<nsICacheSession> gSession = nsnull;
-static nsCOMPtr<nsICacheSession> gChromeSession = nsnull;
-
-void GetCacheSession(nsIURI *aURI, nsICacheSession **_retval)
-{
-  NS_ASSERTION(aURI, "Null URI!");
-
-  PRBool isChrome = PR_FALSE;
-  aURI->SchemeIs("chrome", &isChrome);
-
-  if (gSession && !isChrome) {
-    *_retval = gSession;
-    NS_ADDREF(*_retval);
-    return;
-  }
-
-  if (gChromeSession && isChrome) {
-    *_retval = gChromeSession;
-    NS_ADDREF(*_retval);
-    return;
-  }
-
-  nsCOMPtr<nsICacheService> cacheService(do_GetService("@mozilla.org/network/cache-service;1"));
-  if (!cacheService) {
-    NS_WARNING("Unable to get the cache service");
-    return;
-  }
-
-  nsCOMPtr<nsICacheSession> newSession;
-  cacheService->CreateSession(isChrome ? "image-chrome" : "image",
-                              nsICache::STORE_IN_MEMORY,
-                              nsICache::NOT_STREAM_BASED,
-                              getter_AddRefs(newSession));
-
-  if (!newSession) {
-    NS_WARNING("Unable to create a cache session");
-    return;
-  }
-
-  if (isChrome)
-    gChromeSession = newSession;
-  else {
-    gSession = newSession;
-    gSession->SetDoomEntriesIfExpired(PR_FALSE);
-  }
-
-  *_retval = newSession;
-  NS_ADDREF(*_retval);
-}
-
-
-void imgCache::Shutdown()
-{
-  gSession = nsnull;
-  gChromeSession = nsnull;
-}
-
-
-nsresult imgCache::ClearChromeImageCache()
-{
-  if (!gChromeSession)
-    return NS_OK;
-
-  return gChromeSession->EvictEntries();
-}
-
-nsresult imgCache::ClearImageCache()
-{
-  if (!gSession)
-    return NS_OK;
-
-  return gSession->EvictEntries();
-}
-
-
-
-PRBool imgCache::Put(nsIURI *aKey, imgRequest *request, nsICacheEntryDescriptor **aEntry)
-{
-  LOG_STATIC_FUNC(gImgLog, "imgCache::Put");
-
-  nsresult rv;
-
-  nsCOMPtr<nsICacheSession> ses;
-  GetCacheSession(aKey, getter_AddRefs(ses));
-  if (!ses) return PR_FALSE;
-
-  nsCAutoString spec;
-  aKey->GetAsciiSpec(spec);
-
-  nsCOMPtr<nsICacheEntryDescriptor> entry;
-
-  rv = ses->OpenCacheEntry(spec, nsICache::ACCESS_WRITE, nsICache::BLOCKING, getter_AddRefs(entry));
-
-  if (NS_FAILED(rv) || !entry)
-    return PR_FALSE;
-
-  nsCOMPtr<nsISupports> sup = reinterpret_cast<nsISupports*>(request);
-  entry->SetCacheElement(sup);
-
-  entry->MarkValid();
-
-  // If file, force revalidation on expiration
-  PRBool isFile;
-  aKey->SchemeIs("file", &isFile);
-  if (isFile)
-    entry->SetMetaDataElement("MustValidateIfExpired", "true");
-
-  *aEntry = entry;
-  NS_ADDREF(*aEntry);
-
-  return PR_TRUE;
-}
-
-static PRUint32
-SecondsFromPRTime(PRTime prTime)
-{
-  PRInt64 microSecondsPerSecond, intermediateResult;
-  PRUint32 seconds;
-  
-  LL_I2L(microSecondsPerSecond, PR_USEC_PER_SEC);
-  LL_DIV(intermediateResult, prTime, microSecondsPerSecond);
-  LL_L2UI(seconds, intermediateResult);
-  return seconds;
-}
-
-
-PRBool imgCache::Get(nsIURI *aKey, PRBool *aHasExpired, imgRequest **aRequest, nsICacheEntryDescriptor **aEntry)
-{
-  LOG_STATIC_FUNC(gImgLog, "imgCache::Get");
-
-  nsresult rv;
-
-  nsCOMPtr<nsICacheSession> ses;
-  GetCacheSession(aKey, getter_AddRefs(ses));
-  if (!ses) return PR_FALSE;
-
-  nsCAutoString spec;
-  aKey->GetAsciiSpec(spec);
-
-  nsCOMPtr<nsICacheEntryDescriptor> entry;
-
-  rv = ses->OpenCacheEntry(spec, nsICache::ACCESS_READ, nsICache::BLOCKING, getter_AddRefs(entry));
-
-  if (NS_FAILED(rv) || !entry)
-    return PR_FALSE;
-
-  if (aHasExpired) {
-    PRUint32 expirationTime;
-    rv = entry->GetExpirationTime(&expirationTime);
-    if (NS_FAILED(rv) || (expirationTime <= SecondsFromPRTime(PR_Now()))) {
-      *aHasExpired = PR_TRUE;
-    } else {
-      *aHasExpired = PR_FALSE;
-    }
-    // Special treatment for file URLs - entry has expired if file has changed
-    nsCOMPtr<nsIFileURL> fileUrl(do_QueryInterface(aKey));
-    if (fileUrl) {
-      PRUint32 lastModTime;
-      entry->GetLastModified(&lastModTime);
-
-      nsCOMPtr<nsIFile> theFile;
-      rv = fileUrl->GetFile(getter_AddRefs(theFile));
-      if (NS_SUCCEEDED(rv)) {
-        PRInt64 fileLastMod;
-        rv = theFile->GetLastModifiedTime(&fileLastMod);
-        if (NS_SUCCEEDED(rv)) {
-          // nsIFile uses millisec, NSPR usec
-          PRInt64 one_thousand = LL_INIT(0, 1000);
-          LL_MUL(fileLastMod, fileLastMod, one_thousand);
-          *aHasExpired = SecondsFromPRTime((PRTime)fileLastMod) > lastModTime;
-        }
-      }
-    }
-  }
-
-  nsCOMPtr<nsISupports> sup;
-  entry->GetCacheElement(getter_AddRefs(sup));
-
-  *aRequest = reinterpret_cast<imgRequest*>(sup.get());
-  NS_IF_ADDREF(*aRequest);
-
-  *aEntry = entry;
-  NS_ADDREF(*aEntry);
-
-  return PR_TRUE;
-}
-
-
-PRBool imgCache::Remove(nsIURI *aKey)
-{
-  LOG_STATIC_FUNC(gImgLog, "imgCache::Remove");
-  if (!aKey) return PR_FALSE;
-
-  nsresult rv;
-  nsCOMPtr<nsICacheSession> ses;
-  GetCacheSession(aKey, getter_AddRefs(ses));
-  if (!ses) return PR_FALSE;
-
-  nsCAutoString spec;
-  aKey->GetAsciiSpec(spec);
-
-  nsCOMPtr<nsICacheEntryDescriptor> entry;
-
-  rv = ses->OpenCacheEntry(spec, nsICache::ACCESS_READ, nsICache::BLOCKING, getter_AddRefs(entry));
-
-  if (NS_FAILED(rv) || !entry)
-    return PR_FALSE;
-
-  entry->Doom();
-
-  return PR_TRUE;
-}
-
-
-NS_IMETHODIMP
-imgCache::Observe(nsISupports* aSubject, const char* aTopic, const PRUnichar* aSomeData)
-{
-  if (strcmp(aTopic, "memory-pressure") == 0) {
-    ClearCache(PR_FALSE);
-    ClearCache(PR_TRUE);
-  } else if (strcmp(aTopic, "chrome-flush-skin-caches") == 0 ||
-             strcmp(aTopic, "chrome-flush-caches") == 0) {
-    ClearCache(PR_TRUE);
-  }
-  return NS_OK;
-}
diff -r f3ac957eb4af modules/libpr0n/src/imgCache.h
--- a/modules/libpr0n/src/imgCache.h	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,82 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-
- *
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 2001
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *   Stuart Parmenter <pavlov@netscape.com>
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#include "imgICache.h"
-#include "nsIObserver.h"
-#include "nsWeakReference.h"
-
-#include "prtypes.h"
-
-class imgRequest;
-class nsIURI;
-class nsICacheEntryDescriptor;
-
-#define NS_IMGCACHE_CID \
-{ /* fb4fd28a-1dd1-11b2-8391-e14242c59a41 */         \
-     0xfb4fd28a,                                     \
-     0x1dd1,                                         \
-     0x11b2,                                         \
-    {0x83, 0x91, 0xe1, 0x42, 0x42, 0xc5, 0x9a, 0x41} \
-}
-
-class imgCache : public imgICache, 
-                 public nsIObserver,
-                 public nsSupportsWeakReference
-{
-public:
-  NS_DECL_ISUPPORTS
-  NS_DECL_IMGICACHE
-  NS_DECL_NSIOBSERVER
-
-  imgCache();
-  virtual ~imgCache();
-
-  static nsresult Init();
-
-  static void Shutdown(); // for use by the factory
-
-  /* additional members */
-  static PRBool Put(nsIURI *aKey, imgRequest *request, nsICacheEntryDescriptor **aEntry);
-  static PRBool Get(nsIURI *aKey, PRBool *aHasExpired, imgRequest **aRequest, nsICacheEntryDescriptor **aEntry);
-  static PRBool Remove(nsIURI *aKey);
-
-  static nsresult ClearChromeImageCache();
-  static nsresult ClearImageCache();
-};
-
diff -r f3ac957eb4af modules/libpr0n/src/imgLoader.cpp
--- a/modules/libpr0n/src/imgLoader.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/modules/libpr0n/src/imgLoader.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -42,19 +42,22 @@
 #include "nsCOMPtr.h"
 
 #include "nsNetUtil.h"
 #include "nsIHttpChannel.h"
 #include "nsICachingChannel.h"
+#include "nsIObserverService.h"
+#include "nsIPrefBranch.h"
+#include "nsIPrefService.h"
 #include "nsIProxyObjectManager.h"
 #include "nsIServiceManager.h"
+#include "nsIFileURL.h"
 #include "nsThreadUtils.h"
 #include "nsXPIDLString.h"
 #include "nsCRT.h"
 
 #include "netCore.h"
 
-#include "imgCache.h"
 #include "imgRequest.h"
 #include "imgRequestProxy.h"
 
 #include "ImageErrors.h"
 #include "ImageLogging.h"
@@ -101,41 +104,40 @@ static void PrintImageDecoders()
     }
   }
 }
 #endif
 
-NS_IMPL_ISUPPORTS2(imgLoader, imgILoader, nsIContentSniffer)
+static PRBool NewRequestAndEntry(nsIURI *uri, imgRequest **request, imgCacheEntry **entry)
+{
+  // If file, force revalidation on expiration
+  PRBool isFile;
+  uri->SchemeIs("file", &isFile);
 
-imgLoader::imgLoader()
-{
-  /* member initializers and constructor code */
-#ifdef DEBUG_pavlov
-  PrintImageDecoders();
-#endif
+  *request = new imgRequest();
+  if (!*request)
+    return PR_FALSE;
+
+  *entry = new imgCacheEntry(*request, /* mustValidateIfExpired = */ isFile);
+  if (!*entry) {
+    delete *request;
+    return PR_FALSE;
+  }
+
+  NS_ADDREF(*request);
+  NS_ADDREF(*entry);
+
+  return PR_TRUE;
 }
 
-imgLoader::~imgLoader()
-{
-  /* destructor code */
-}
-
-#define LOAD_FLAGS_CACHE_MASK    (nsIRequest::LOAD_BYPASS_CACHE | \
-                                  nsIRequest::LOAD_FROM_CACHE)
-
-#define LOAD_FLAGS_VALIDATE_MASK (nsIRequest::VALIDATE_ALWAYS |   \
-                                  nsIRequest::VALIDATE_NEVER |    \
-                                  nsIRequest::VALIDATE_ONCE_PER_SESSION)
-
-
-static PRBool RevalidateEntry(nsICacheEntryDescriptor *aEntry,
+static PRBool ShouldRevalidateEntry(imgCacheEntry *aEntry,
                               nsLoadFlags aFlags,
                               PRBool aHasExpired)
 {
   PRBool bValidateEntry = PR_FALSE;
 
-  NS_ASSERTION(!(aFlags & nsIRequest::LOAD_BYPASS_CACHE),
-               "MUST not revalidate when BYPASS_CACHE is specified.");
+  if (aFlags & nsIRequest::LOAD_BYPASS_CACHE)
+    return PR_FALSE;
 
   if (aFlags & nsIRequest::VALIDATE_ALWAYS) {
     bValidateEntry = PR_TRUE;
   }
   //
@@ -149,17 +151,11 @@ static PRBool RevalidateEntry(nsICacheEn
     // indicate that revalidation is necessary.
     //
     if (aFlags & (nsIRequest::VALIDATE_NEVER | 
                   nsIRequest::VALIDATE_ONCE_PER_SESSION)) 
     {
-      nsXPIDLCString value;
-
-      aEntry->GetMetaDataElement("MustValidateIfExpired",
-                                 getter_Copies(value));
-      if (PL_strcmp(value, "true")) {
-        bValidateEntry = PR_TRUE;
-      }
+      bValidateEntry = aEntry->GetMustValidateIfExpired();
     }
     //
     // LOAD_FROM_CACHE allows a stale cache entry to be used... Otherwise,
     // the entry must be revalidated.
     //
@@ -168,11 +164,10 @@ static PRBool RevalidateEntry(nsICacheEn
     }
   }
 
   return bValidateEntry;
 }
-
 
 static nsresult NewImageChannel(nsIChannel **aResult,
                                 nsIURI *aURI,
                                 nsIURI *aInitialDocumentURI,
                                 nsIURI *aReferringURI,
@@ -236,441 +231,147 @@ static nsresult NewImageChannel(nsIChann
   }
 
   return NS_OK;
 }
 
-/* imgIRequest loadImage (in nsIURI aURI, in nsIURI initialDocumentURI, in nsILoadGroup aLoadGroup, in imgIDecoderObserver aObserver, in nsISupports aCX, in nsLoadFlags aLoadFlags, in nsISupports cacheKey, in imgIRequest aRequest); */
-
-NS_IMETHODIMP imgLoader::LoadImage(nsIURI *aURI, 
-                                   nsIURI *aInitialDocumentURI,
-                                   nsIURI *aReferrerURI,
-                                   nsILoadGroup *aLoadGroup,
-                                   imgIDecoderObserver *aObserver,
-                                   nsISupports *aCX,
-                                   nsLoadFlags aLoadFlags,
-                                   nsISupports *cacheKey,
-                                   imgIRequest *aRequest,
-                                   imgIRequest **_retval)
+static PRUint32 SecondsFromPRTime(PRTime prTime)
 {
-  NS_ASSERTION(aURI, "imgLoader::LoadImage -- NULL URI pointer");
-
-  // CreateNewProxyForRequest treats _retval as inout - null out
-  // to make sure the passed value doesn't affect the behavior of
-  // this method
-  *_retval = nsnull;
-
-  if (!aURI)
-    return NS_ERROR_NULL_POINTER;
-
-#if defined(PR_LOGGING)
-  nsCAutoString spec;
-  aURI->GetAsciiSpec(spec);
-  LOG_SCOPE_WITH_PARAM(gImgLog, "imgLoader::LoadImage", "aURI", spec.get());
-#endif
-
-  // This is an owning reference that must be released.
-  imgRequest *request = nsnull;
-
-  nsresult rv;
-  nsLoadFlags requestFlags = nsIRequest::LOAD_NORMAL;
-
-  // Get the default load flags from the loadgroup (if possible)...
-  if (aLoadGroup) {
-    aLoadGroup->GetLoadFlags(&requestFlags);
-  }
-  //
-  // Merge the default load flags with those passed in via aLoadFlags.
-  // Currently, *only* the caching, validation and background load flags
-  // are merged...
-  //
-  // The flags in aLoadFlags take precidence over the default flags!
-  //
-  if (aLoadFlags & LOAD_FLAGS_CACHE_MASK) {
-    // Override the default caching flags...
-    requestFlags = (requestFlags & ~LOAD_FLAGS_CACHE_MASK) |
-                   (aLoadFlags & LOAD_FLAGS_CACHE_MASK);
-  }
-  if (aLoadFlags & LOAD_FLAGS_VALIDATE_MASK) {
-    // Override the default validation flags...
-    requestFlags = (requestFlags & ~LOAD_FLAGS_VALIDATE_MASK) |
-                   (aLoadFlags & LOAD_FLAGS_VALIDATE_MASK);
-  }
-  if (aLoadFlags & nsIRequest::LOAD_BACKGROUND) {
-    // Propagate background loading...
-    requestFlags |= nsIRequest::LOAD_BACKGROUND;
-  }
-
-  nsCOMPtr<nsICacheEntryDescriptor> entry;
-  PRBool bCanCacheRequest = PR_TRUE;
-  PRBool bHasExpired      = PR_FALSE;
-  PRBool bValidateRequest = PR_FALSE;
-
-  // XXX For now ignore the cache key. We will need it in the future
-  // for correctly dealing with image load requests that are a result
-  // of post data.
-  imgCache::Get(aURI, &bHasExpired,
-                &request, getter_AddRefs(entry)); // addrefs request
-
-  if (request && entry) {
-
-    // request's null out their mCacheEntry when all proxy's are removed.
-    // If we are about to add a new one back, go ahead and re-set the cache
-    // entry so it can be used.
-    if (!request->mCacheEntry) {
-      request->mCacheEntry = entry;
-    }
-
-    // If the request's loadId is the same as the aCX, then it is ok to use
-    // this one because it has already been validated for this context.
-    //
-    // XXX: nsnull seems to be a 'special' key value that indicates that NO
-    //      validation is required.
-    //
-    void *key = (void*)aCX;
-    if (request->mLoadId != key) {
-
-      // LOAD_BYPASS_CACHE - Always re-fetch
-      if (requestFlags & nsIRequest::LOAD_BYPASS_CACHE) {
-        // doom cache entry; be sure to break the reference cycle between the
-        // request and cache entry.  NOTE: the request might not own the cache
-        // entry at this point, so we explicitly Doom |entry| just in case.
-        entry->Doom();
-        entry = nsnull;
-        request->RemoveFromCache();
-        NS_RELEASE(request);
-      } else {
-        // Determine whether the cache entry must be revalidated...
-        bValidateRequest = RevalidateEntry(entry, requestFlags, bHasExpired);
-
-        PR_LOG(gImgLog, PR_LOG_DEBUG,
-               ("imgLoader::LoadImage validating cache entry. " 
-                "bValidateRequest = %d", bValidateRequest));
-      }
-
-    }
-#if defined(PR_LOGGING)
-    else if (!key) {
-      PR_LOG(gImgLog, PR_LOG_DEBUG,
-             ("imgLoader::LoadImage BYPASSING cache validation for %s " 
-              "because of NULL LoadID", spec.get()));
-    }
-#endif
-  }
-
-  //
-  // Get the current thread...  This is used as a cacheId to prevent
-  // sharing requests which are being loaded across multiple threads...
-  //
-  void *cacheId = NS_GetCurrentThread();
-  if (request && !request->IsReusable(cacheId)) {
-    //
-    // The current request is still being loaded and lives on a different
-    // event queue.
-    //
-    // Since its event queue is NOT active, do not reuse this imgRequest !!
-    // Instead, force a new request to be created but DO NOT allow it to be
-    // cached!
-    //
-    PR_LOG(gImgLog, PR_LOG_DEBUG,
-           ("[this=%p] imgLoader::LoadImage -- DANGER!! Unable to use cached "
-            "imgRequest [request=%p]\n", this, request));
-
-    entry = nsnull;
-    NS_RELEASE(request);
-
-    bCanCacheRequest = PR_FALSE;
-  }
-
-  //
-  // Time to load the request... There are 3 possible cases:
-  // =======================================================
-  //   1. There is no cached request (ie. nothing was found in the cache).
-  //
-  //   2. There is a cached request that must be validated.
-  //
-  //   3. There is a valid cached request.
-  //
-  if (request && bValidateRequest) {
-    /* Case #2: the cache request cache must be revalidated. */
-    LOG_SCOPE(gImgLog, "imgLoader::LoadImage |cache hit| must validate");
-
-    // now we need to insert a new channel request object inbetween the real
-    // request and the proxy that basically delays loading the image until it
-    // gets a 304 or figures out that this needs to be a new request
-
-    if (request->mValidator) {
-      rv = CreateNewProxyForRequest(request, aLoadGroup, aObserver,
-                                    requestFlags, aRequest, _retval);
-
-      if (*_retval)
-        request->mValidator->AddProxy(static_cast<imgRequestProxy*>(*_retval));
-
-      NS_RELEASE(request);
-      return rv;
-
-    } else {
-      nsCOMPtr<nsIChannel> newChannel;
-      rv = NewImageChannel(getter_AddRefs(newChannel),
-                           aURI,
-                           aInitialDocumentURI,
-                           aReferrerURI,
-                           aLoadGroup,
-                           requestFlags);
-      if (NS_FAILED(rv)) {
-        NS_RELEASE(request);
-        return NS_ERROR_FAILURE;
-      }
-
-      nsCOMPtr<nsICachingChannel> cacheChan(do_QueryInterface(newChannel));
-
-      if (cacheChan) {
-        // since this channel supports nsICachingChannel, we can ask it
-        // to only stream us data if the data comes off the net.
-        PRUint32 loadFlags;
-        if (NS_SUCCEEDED(newChannel->GetLoadFlags(&loadFlags)))
-            newChannel->SetLoadFlags(loadFlags | nsICachingChannel::LOAD_ONLY_IF_MODIFIED);
-
-      }
-      nsCOMPtr<imgIRequest> req;
-      rv = CreateNewProxyForRequest(request, aLoadGroup, aObserver,
-                                    requestFlags, aRequest, getter_AddRefs(req));
-      if (NS_FAILED(rv)) {
-        NS_RELEASE(request);
-        return rv;
-      }
-
-      imgCacheValidator *hvc = new imgCacheValidator(request, aCX);
-      if (!hvc) {
-        NS_RELEASE(request);
-        return NS_ERROR_OUT_OF_MEMORY;
-      }
-
-      NS_ADDREF(hvc);
-      request->mValidator = hvc;
-
-      hvc->AddProxy(static_cast<imgRequestProxy*>
-                               (static_cast<imgIRequest*>(req.get())));
-
-      rv = newChannel->AsyncOpen(static_cast<nsIStreamListener *>(hvc), nsnull);
-      if (NS_SUCCEEDED(rv))
-        NS_ADDREF(*_retval = req.get());
-
-      NS_RELEASE(hvc);
-
-      NS_RELEASE(request);
-
-      return rv;
-    }
-  } else if (!request) {
-    /* Case #1: no request from the cache.  do a new load */
-    LOG_SCOPE(gImgLog, "imgLoader::LoadImage |cache miss|");
-
-    nsCOMPtr<nsIChannel> newChannel;
-    rv = NewImageChannel(getter_AddRefs(newChannel),
-                         aURI,
-                         aInitialDocumentURI,
-                         aReferrerURI,
-                         aLoadGroup,
-                         requestFlags);
-    if (NS_FAILED(rv))
-      return NS_ERROR_FAILURE;
-
-    NS_NEWXPCOM(request, imgRequest);
-    if (!request) return NS_ERROR_OUT_OF_MEMORY;
-
-    NS_ADDREF(request);
-
-    PR_LOG(gImgLog, PR_LOG_DEBUG,
-           ("[this=%p] imgLoader::LoadImage -- Created new imgRequest [request=%p]\n", this, request));
-
-    // Add the new request into the imgCache if its cachable...
-    if (bCanCacheRequest) {
-      imgCache::Put(aURI, request, getter_AddRefs(entry));
-    }
-
-    // Create a loadgroup for this new channel.  This way if the channel
-    // is redirected, we'll have a way to cancel the resulting channel.
-    nsCOMPtr<nsILoadGroup> loadGroup =
-        do_CreateInstance(NS_LOADGROUP_CONTRACTID);
-    newChannel->SetLoadGroup(loadGroup);
-
-    request->Init(aURI, loadGroup, entry, cacheId, aCX);
-
-    // create the proxy listener
-    ProxyListener *pl = new ProxyListener(static_cast<nsIStreamListener *>(request));
-    if (!pl) {
-      request->Cancel(NS_ERROR_OUT_OF_MEMORY);
-      NS_RELEASE(request);
-      return NS_ERROR_OUT_OF_MEMORY;
-    }
-
-    NS_ADDREF(pl);
-
-    PR_LOG(gImgLog, PR_LOG_DEBUG,
-           ("[this=%p] imgLoader::LoadImage -- Calling channel->AsyncOpen()\n", this));
-
-    nsresult openRes;
-    openRes = newChannel->AsyncOpen(static_cast<nsIStreamListener *>(pl), nsnull);
-
-    NS_RELEASE(pl);
-
-    if (NS_FAILED(openRes)) {
-      PR_LOG(gImgLog, PR_LOG_DEBUG,
-             ("[this=%p] imgLoader::LoadImage -- AsyncOpen() failed: 0x%x\n",
-              this, openRes));
-      request->Cancel(openRes);
-      NS_RELEASE(request);
-      return openRes;
-    }
-
-  } else {
-    /* Case #3: request found in cache.  use it */
-    // XXX: Should this be executed if an expired cache entry does not have a caching channel??
-    LOG_MSG_WITH_PARAM(gImgLog, 
-                       "imgLoader::LoadImage |cache hit|", "request", request);
-
-    // Update the request's LoadId
-    request->SetLoadId(aCX);
-  }
-
-  LOG_MSG(gImgLog, "imgLoader::LoadImage", "creating proxy request.");
-
-  rv = CreateNewProxyForRequest(request, aLoadGroup, aObserver,
-                                requestFlags, aRequest, _retval);
-
-  imgRequestProxy *proxy = (imgRequestProxy *)*_retval;
-
-  // Note that it's OK to add here even if the request is done.  If it is,
-  // it'll send a OnStopRequest() to the proxy in NotifyProxyListener and the
-  // proxy will be removed from the loadgroup.
-  proxy->AddToLoadGroup();
-
-  // if we have to validate the request, then we will send the
-  // notifications later.
-  if (!bValidateRequest) {
-    request->NotifyProxyListener(proxy);
-  }
-
-  NS_RELEASE(request);
-
-  return rv;
+  return PRUint32(PRInt64(prTime) / PRInt64(PR_USEC_PER_SEC));
 }
 
-/* imgIRequest loadImageWithChannel(in nsIChannel channel, in imgIDecoderObserver aObserver, in nsISupports cx, out nsIStreamListener); */
-NS_IMETHODIMP imgLoader::LoadImageWithChannel(nsIChannel *channel, imgIDecoderObserver *aObserver, nsISupports *aCX, nsIStreamListener **listener, imgIRequest **_retval)
+imgCacheEntry::imgCacheEntry(imgRequest *request, PRBool mustValidateIfExpired /* = PR_FALSE */)
+ : mRequest(request),
+   mDataSize(0),
+   mTouchedTime(SecondsFromPRTime(PR_Now())),
+   mExpiryTime(0),
+   mMustValidateIfExpired(mustValidateIfExpired),
+   mEvicted(PR_FALSE)
+{}
+
+void imgCacheEntry::TouchWithSize(PRInt32 diff)
 {
-  NS_ASSERTION(channel, "imgLoader::LoadImageWithChannel -- NULL channel pointer");
+  LOG_SCOPE(gImgLog, "imgCacheEntry::TouchWithSize");
 
-  // CreateNewProxyForRequest treats _retval as inout - null out
-  // to make sure the passed value doesn't affect the behavior of
-  // this method
-  *_retval = nsnull;
+  mTouchedTime = SecondsFromPRTime(PR_Now());
 
-  nsresult rv;
-  imgRequest *request = nsnull;
-
-  nsCOMPtr<nsIURI> uri;
-  channel->GetURI(getter_AddRefs(uri));
-
-  nsCOMPtr<nsICacheEntryDescriptor> entry;
-  PRBool bHasExpired;
-
-  imgCache::Get(uri, &bHasExpired, &request, getter_AddRefs(entry)); // addrefs request
-
-  nsLoadFlags requestFlags = nsIRequest::LOAD_NORMAL;
-
-  channel->GetLoadFlags(&requestFlags);
-
-  if (request) {
-    PRBool bUseCacheCopy = PR_TRUE;
-
-    // LOAD_BYPASS_CACHE - Always re-fetch
-    if (requestFlags & nsIRequest::LOAD_BYPASS_CACHE) {
-      bUseCacheCopy = PR_FALSE;
-    }
-    else if (RevalidateEntry(entry, requestFlags, bHasExpired)) {
-      nsCOMPtr<nsICachingChannel> cacheChan(do_QueryInterface(channel));
-      if (cacheChan) {
-        cacheChan->IsFromCache(&bUseCacheCopy);
-      } else {
-        bUseCacheCopy = PR_FALSE;
-      }
-    }
-
-    if (!bUseCacheCopy) {
-      // doom cache entry; be sure to break the reference cycle between the
-      // request and cache entry.  NOTE: the request might not own the cache
-      // entry at this point, so we explicitly Doom |entry| just in case.
-      entry->Doom();
-      entry = nsnull;
-      request->RemoveFromCache();
-      NS_RELEASE(request);
-    }
+  if (!Evicted()) {
+    nsCOMPtr<nsIURI> uri;
+    mRequest->GetURI(getter_AddRefs(uri));
+    imgLoader::CacheEntriesChanged(uri, diff);
   }
-
-  nsCOMPtr<nsILoadGroup> loadGroup;
-  channel->GetLoadGroup(getter_AddRefs(loadGroup));
-
-  if (request) {
-    // we have this in our cache already.. cancel the current (document) load
-
-    channel->Cancel(NS_IMAGELIB_ERROR_LOAD_ABORTED); // this should fire an OnStopRequest
-
-    *listener = nsnull; // give them back a null nsIStreamListener
-  } else {
-    //
-    // Get the current Thread...  This is used as a cacheId to prevent
-    // sharing requests which are being loaded across multiple threads...
-    //
-    nsIThread *thread = NS_GetCurrentThread();
-
-    NS_NEWXPCOM(request, imgRequest);
-    if (!request) return NS_ERROR_OUT_OF_MEMORY;
-
-    NS_ADDREF(request);
-
-    imgCache::Put(uri, request, getter_AddRefs(entry));
-
-    // XXX(darin):  I'm not sure that using the original URI is correct here.
-    // Perhaps we should use the same URI that indexes the cache?  Or, perhaps
-    // the cache should use the original URI?  See bug 89419.
-    nsCOMPtr<nsIURI> originalURI;
-    channel->GetOriginalURI(getter_AddRefs(originalURI));
-    request->Init(originalURI, channel, entry, thread, aCX);
-
-    ProxyListener *pl = new ProxyListener(static_cast<nsIStreamListener *>(request));
-    if (!pl) {
-      NS_RELEASE(request);
-      return NS_ERROR_OUT_OF_MEMORY;
-    }
-
-    NS_ADDREF(pl);
-
-    *listener = static_cast<nsIStreamListener*>(pl);
-    NS_ADDREF(*listener);
-
-    NS_RELEASE(pl);
-  }
-
-  // XXX: It looks like the wrong load flags are being passed in...
-  requestFlags &= 0xFFFF;
-
-  rv = CreateNewProxyForRequest(request, loadGroup, aObserver,
-                                requestFlags, nsnull, _retval);
-  request->NotifyProxyListener(static_cast<imgRequestProxy*>(*_retval));
-
-  NS_RELEASE(request);
-
-  return rv;
 }
 
+void imgCacheEntry::Touch(PRBool updateTime /* = PR_TRUE */)
+{
+  LOG_SCOPE(gImgLog, "imgCacheEntry::Touch");
 
-nsresult
-imgLoader::CreateNewProxyForRequest(imgRequest *aRequest, nsILoadGroup *aLoadGroup,
-                                    imgIDecoderObserver *aObserver,
-                                    nsLoadFlags aLoadFlags, imgIRequest *aProxyRequest,
-                                    imgIRequest **_retval)
+  if (updateTime)
+    mTouchedTime = SecondsFromPRTime(PR_Now());
+
+  if (!Evicted()) {
+    nsCOMPtr<nsIURI> uri;
+    mRequest->GetURI(getter_AddRefs(uri));
+    imgLoader::CacheEntriesChanged(uri);
+  }
+}
+
+imgCacheQueue::imgCacheQueue()
+ : mDirty(PR_FALSE),
+   mSize(0)
+{}
+
+void imgCacheQueue::UpdateSize(PRInt32 diff)
+{
+  mSize += diff;
+}
+
+PRUint32 imgCacheQueue::GetSize() const
+{
+  return mSize;
+}
+
+#include <algorithm>
+
+void imgCacheQueue::Remove(imgCacheEntry *entry)
+{
+  queueContainer::iterator it = find(mQueue.begin(), mQueue.end(), entry);
+  if (it != mQueue.end()) {
+    mSize -= (*it)->GetDataSize();
+    mQueue.erase(it);
+    MarkDirty();
+  }
+}
+
+void imgCacheQueue::Push(imgCacheEntry *entry)
+{
+  mSize += entry->GetDataSize();
+
+  nsRefPtr<imgCacheEntry> refptr(entry);
+  mQueue.push_back(refptr);
+  MarkDirty();
+}
+
+already_AddRefed<imgCacheEntry> imgCacheQueue::Pop()
+{
+  if (mQueue.empty())
+    return nsnull;
+  if (IsDirty())
+    Refresh();
+
+  nsRefPtr<imgCacheEntry> entry = mQueue[0];
+  std::pop_heap(mQueue.begin(), mQueue.end(), imgLoader::CompareCacheEntries);
+  mQueue.pop_back();
+
+  mSize -= entry->GetDataSize();
+  imgCacheEntry *ret = entry;
+  NS_ADDREF(ret);
+  return ret;
+}
+
+void imgCacheQueue::Refresh()
+{
+  std::make_heap(mQueue.begin(), mQueue.end(), imgLoader::CompareCacheEntries);
+  mDirty = PR_FALSE;
+}
+
+void imgCacheQueue::MarkDirty()
+{
+  mDirty = PR_TRUE;
+}
+
+PRBool imgCacheQueue::IsDirty()
+{
+  return mDirty;
+}
+
+PRUint32 imgCacheQueue::GetNumElements() const
+{
+  return mQueue.size();
+}
+
+imgCacheQueue::iterator imgCacheQueue::begin()
+{
+  return mQueue.begin();
+}
+imgCacheQueue::const_iterator imgCacheQueue::begin() const
+{
+  return mQueue.begin();
+}
+
+imgCacheQueue::iterator imgCacheQueue::end()
+{
+  return mQueue.end();
+}
+imgCacheQueue::const_iterator imgCacheQueue::end() const
+{
+  return mQueue.end();
+}
+
+nsresult imgLoader::CreateNewProxyForRequest(imgRequest *aRequest, nsILoadGroup *aLoadGroup,
+                                             imgIDecoderObserver *aObserver,
+                                             nsLoadFlags aLoadFlags, imgIRequest *aProxyRequest,
+                                             imgIRequest **_retval)
 {
   LOG_SCOPE_WITH_PARAM(gImgLog, "imgLoader::CreateNewProxyForRequest", "imgRequest", aRequest);
 
   /* XXX If we move decoding onto separate threads, we should save off the
      calling thread here and pass it off to |proxyRequest| so that it call
@@ -696,19 +397,840 @@ imgLoader::CreateNewProxyForRequest(imgR
   if (NS_FAILED(rv)) {
     NS_RELEASE(proxyRequest);
     return rv;
   }
 
-  if (*_retval) {
-    (*_retval)->Cancel(NS_IMAGELIB_ERROR_LOAD_ABORTED);
-    NS_RELEASE(*_retval);
-  }
   // transfer reference to caller
   *_retval = static_cast<imgIRequest*>(proxyRequest);
 
   return NS_OK;
 }
+
+class imgCacheObserver : public nsIObserver
+{
+public:
+  NS_DECL_ISUPPORTS
+  NS_DECL_NSIOBSERVER
+private:
+  imgLoader mLoader;
+};
+
+NS_IMPL_ISUPPORTS1(imgCacheObserver, nsIObserver)
+
+NS_IMETHODIMP
+imgCacheObserver::Observe(nsISupports* aSubject, const char* aTopic, const PRUnichar* aSomeData)
+{
+  if (strcmp(aTopic, "memory-pressure") == 0) {
+    mLoader.ClearCache(PR_FALSE);
+    mLoader.ClearCache(PR_TRUE);
+  } else if (strcmp(aTopic, "chrome-flush-skin-caches") == 0 ||
+             strcmp(aTopic, "chrome-flush-caches") == 0) {
+    mLoader.ClearCache(PR_TRUE);
+  }
+  return NS_OK;
+}
+
+class imgCacheExpirationTracker : public nsExpirationTracker<imgCacheEntry, 3>
+{
+  enum { TIMEOUT_SECONDS = 10 };
+public:
+  imgCacheExpirationTracker();
+
+protected:
+  void NotifyExpired(imgCacheEntry *entry);
+};
+
+imgCacheExpirationTracker::imgCacheExpirationTracker()
+ : nsExpirationTracker<imgCacheEntry, 3>(TIMEOUT_SECONDS * 1000)
+{}
+
+void imgCacheExpirationTracker::NotifyExpired(imgCacheEntry *entry)
+{
+  // We can be called multiple times on the same entry. Don't do work multiple
+  // times.
+  if (!entry->Evicted())
+    imgLoader::RemoveFromCache(entry);
+
+  imgLoader::VerifyCacheSizes();
+}
+
+imgCacheObserver *gCacheObserver;
+imgCacheExpirationTracker *gCacheTracker;
+
+imgLoader::imgCacheTable imgLoader::sCache;
+imgCacheQueue imgLoader::sCacheQueue;
+
+imgLoader::imgCacheTable imgLoader::sChromeCache;
+imgCacheQueue imgLoader::sChromeCacheQueue;
+
+PRFloat64 imgLoader::sCacheTimeWeight;
+PRUint32 imgLoader::sCacheMaxSize;
+
+NS_IMPL_ISUPPORTS4(imgLoader, imgILoader, nsIContentSniffer, imgICache, nsISupportsWeakReference)
+
+imgLoader::imgLoader()
+{
+  /* member initializers and constructor code */
+#ifdef DEBUG_pavlov
+  PrintImageDecoders();
+#endif
+}
+
+imgLoader::~imgLoader()
+{
+  /* destructor code */
+}
+
+void imgLoader::VerifyCacheSizes()
+{
+  if (!gCacheTracker)
+    return;
+
+  PRUint32 queuesize = sCacheQueue.GetNumElements() + sChromeCacheQueue.GetNumElements();
+  PRUint32 cachesize = sCache.Count() + sChromeCache.Count();
+  PRUint32 trackersize = 0;
+  for (nsExpirationTracker<imgCacheEntry, 3>::Iterator it(gCacheTracker); it.Next(); )
+    trackersize++;
+  NS_ASSERTION(queuesize == cachesize, "Queue and cache sizes out of sync!");
+  NS_ASSERTION(queuesize == trackersize, "Queue and tracker sizes out of sync!");
+}
+
+imgLoader::imgCacheTable & imgLoader::GetCache(nsIURI *aURI)
+{
+  PRBool chrome = PR_FALSE;
+  aURI->SchemeIs("chrome", &chrome);
+  if (chrome)
+    return sChromeCache;
+  else
+    return sCache;
+}
+
+imgCacheQueue & imgLoader::GetCacheQueue(nsIURI *aURI)
+{
+  PRBool chrome = PR_FALSE;
+  aURI->SchemeIs("chrome", &chrome);
+  if (chrome)
+    return sChromeCacheQueue;
+  else
+    return sCacheQueue;
+}
+
+nsresult imgLoader::InitCache()
+{
+  nsresult rv;
+  nsCOMPtr<nsIObserverService> os = do_GetService("@mozilla.org/observer-service;1", &rv);
+  if (NS_FAILED(rv))
+    return rv;
+  
+  gCacheObserver = new imgCacheObserver();
+  if (!gCacheObserver) 
+    return NS_ERROR_OUT_OF_MEMORY;
+  NS_ADDREF(gCacheObserver);
+
+  os->AddObserver(gCacheObserver, "memory-pressure", PR_FALSE);
+  os->AddObserver(gCacheObserver, "chrome-flush-skin-caches", PR_FALSE);
+  os->AddObserver(gCacheObserver, "chrome-flush-caches", PR_FALSE);
+
+  gCacheTracker = new imgCacheExpirationTracker();
+  if (!gCacheTracker)
+    return NS_ERROR_OUT_OF_MEMORY;
+
+  if (!sCache.Init())
+      return NS_ERROR_OUT_OF_MEMORY;
+  if (!sChromeCache.Init())
+      return NS_ERROR_OUT_OF_MEMORY;
+
+  nsCOMPtr<nsIPrefBranch> prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &rv); 
+  if (NS_FAILED(rv))
+    return rv;
+
+  PRInt32 timeweight;
+  rv = prefs->GetIntPref("image.cache.timeweight", &timeweight);
+  if (NS_SUCCEEDED(rv))
+    sCacheTimeWeight = timeweight / 1000.0;
+  else
+    sCacheTimeWeight = 0.5;
+
+  PRInt32 cachesize;
+  rv = prefs->GetIntPref("image.cache.size", &cachesize);
+  if (NS_SUCCEEDED(rv))
+    sCacheMaxSize = cachesize;
+  else
+    sCacheMaxSize = 5 * 1024 * 1024;
+ 
+  return NS_OK;
+}
+
+/* void clearCache (in boolean chrome); */
+NS_IMETHODIMP imgLoader::ClearCache(PRBool chrome)
+{
+  if (chrome)
+    return ClearChromeImageCache();
+  else
+    return ClearImageCache();
+}
+
+/* void removeEntry(in nsIURI uri); */
+NS_IMETHODIMP imgLoader::RemoveEntry(nsIURI *uri)
+{
+  if (RemoveFromCache(uri))
+    return NS_OK;
+
+  return NS_ERROR_NOT_AVAILABLE;
+}
+
+/* imgIRequest findEntry(in nsIURI uri); */
+NS_IMETHODIMP imgLoader::FindEntryProperties(nsIURI *uri, nsIProperties **_retval)
+{
+  nsRefPtr<imgCacheEntry> entry;
+  nsCAutoString spec;
+  imgCacheTable &cache = GetCache(uri);
+
+  uri->GetSpec(spec);
+  *_retval = nsnull;
+
+  if (cache.Get(spec, getter_AddRefs(entry)) && entry) {
+    if (gCacheTracker)
+      gCacheTracker->MarkUsed(entry);
+    nsRefPtr<imgRequest> request = getter_AddRefs(entry->GetRequest());
+    if (request) {
+      *_retval = request->Properties();
+      NS_ADDREF(*_retval);
+    }
+  }
+
+  return NS_OK;
+}
+
+void imgLoader::Shutdown()
+{
+  ClearChromeImageCache();
+  ClearImageCache();
+  NS_IF_RELEASE(gCacheObserver);
+  delete gCacheTracker;
+  gCacheTracker = nsnull;
+}
+
+nsresult imgLoader::ClearChromeImageCache()
+{
+  return EvictEntries(sChromeCache, sChromeCacheQueue);
+}
+
+nsresult imgLoader::ClearImageCache()
+{
+  return EvictEntries(sCache, sCacheQueue);
+}
+
+PRBool imgLoader::PutIntoCache(nsIURI *key, imgCacheEntry *entry)
+{
+  LOG_STATIC_FUNC(gImgLog, "imgLoader::PutIntoCache");
+
+  imgCacheTable &cache = GetCache(key);
+
+  nsCAutoString spec;
+  key->GetSpec(spec);
+
+  // Check to see if this request already exists in the cache and is being
+  // loaded on a different thread. If so, don't allow this entry to be added to
+  // the cache.
+  nsRefPtr<imgCacheEntry> tmpCacheEntry;
+  if (cache.Get(spec, getter_AddRefs(tmpCacheEntry)) && tmpCacheEntry) {
+    PR_LOG(gImgLog, PR_LOG_DEBUG,
+           ("[this=%p] imgLoader::PutIntoCache -- Element already in the cache", nsnull));
+    nsRefPtr<imgRequest> tmpRequest = getter_AddRefs(tmpCacheEntry->GetRequest());
+    void *cacheId = NS_GetCurrentThread();
+
+    if (!tmpRequest->IsReusable(cacheId))
+      return PR_FALSE;
+
+    if (gCacheTracker)
+      gCacheTracker->MarkUsed(tmpCacheEntry);
+
+    return PR_TRUE;
+  }
+
+  PR_LOG(gImgLog, PR_LOG_DEBUG,
+         ("[this=%p] imgLoader::PutIntoCache -- Element NOT already in the cache", nsnull));
+
+  if (!cache.Put(spec, entry))
+    return PR_FALSE;
+
+  imgCacheQueue &queue = GetCacheQueue(key);
+  queue.Push(entry);
+
+  if (gCacheTracker)
+    gCacheTracker->AddObject(entry);
+
+  CheckCacheLimits(cache, queue);
+
+  return PR_TRUE;
+}
+
+void imgLoader::CacheEntriesChanged(nsIURI *uri, PRInt32 sizediff /* = 0 */)
+{
+  imgCacheQueue &queue = GetCacheQueue(uri);
+  queue.MarkDirty();
+  queue.UpdateSize(sizediff);
+}
+
+void imgLoader::CheckCacheLimits(imgCacheTable &cache, imgCacheQueue &queue)
+{
+  if (queue.GetNumElements() == 0)
+    NS_ASSERTION(queue.GetSize() == 0, 
+                 "imgLoader::CheckCacheLimits -- incorrect cache size");
+
+  // Remove entries from the cache until we're back under our desired size.
+  while (queue.GetSize() >= sCacheMaxSize) {
+    // Remove the first entry in the queue.
+    nsRefPtr<imgCacheEntry> entry(queue.Pop());
+
+    NS_ASSERTION(entry, "imgLoader::CheckCacheLimits -- NULL entry pointer");
+
+    if (entry)
+      RemoveFromCache(entry);
+  }
+}
+
+PRBool imgLoader::ValidateRequestWithNewChannel(imgRequest *request,
+                                                nsIURI *aURI,
+                                                nsIURI *aInitialDocumentURI,
+                                                nsIURI *aReferrerURI,
+                                                nsILoadGroup *aLoadGroup,
+                                                imgIDecoderObserver *aObserver,
+                                                nsISupports *aCX,
+                                                nsLoadFlags aLoadFlags,
+                                                imgIRequest *aExistingRequest,
+                                                imgIRequest **aProxyRequest)
+{
+  // now we need to insert a new channel request object inbetween the real
+  // request and the proxy that basically delays loading the image until it
+  // gets a 304 or figures out that this needs to be a new request
+
+  nsresult rv;
+
+  if (request->mValidator) {
+    rv = CreateNewProxyForRequest(request, aLoadGroup, aObserver,
+                                  aLoadFlags, aExistingRequest, 
+                                  reinterpret_cast<imgIRequest **>(aProxyRequest));
+
+    if (*aProxyRequest)
+      request->mValidator->AddProxy(static_cast<imgRequestProxy*>(*aProxyRequest));
+
+    return NS_SUCCEEDED(rv);
+
+  } else {
+    nsCOMPtr<nsIChannel> newChannel;
+    rv = NewImageChannel(getter_AddRefs(newChannel),
+                         aURI,
+                         aInitialDocumentURI,
+                         aReferrerURI,
+                         aLoadGroup,
+                         aLoadFlags);
+    if (NS_FAILED(rv)) {
+      return PR_FALSE;
+    }
+
+    nsCOMPtr<nsICachingChannel> cacheChan(do_QueryInterface(newChannel));
+
+    if (cacheChan) {
+      // since this channel supports nsICachingChannel, we can ask it
+      // to only stream us data if the data comes off the net.
+      PRUint32 loadFlags;
+      if (NS_SUCCEEDED(newChannel->GetLoadFlags(&loadFlags)))
+        newChannel->SetLoadFlags(loadFlags | nsICachingChannel::LOAD_ONLY_IF_MODIFIED);
+    }
+
+    nsCOMPtr<imgIRequest> req;
+    rv = CreateNewProxyForRequest(request, aLoadGroup, aObserver,
+                                  aLoadFlags, aExistingRequest, getter_AddRefs(req));
+    if (NS_FAILED(rv)) {
+      return PR_FALSE;
+    }
+
+    imgCacheValidator *hvc = new imgCacheValidator(request, aCX);
+    if (!hvc) {
+      return PR_FALSE;
+    }
+
+    NS_ADDREF(hvc);
+    request->mValidator = hvc;
+
+    hvc->AddProxy(static_cast<imgRequestProxy*>
+                             (static_cast<imgIRequest*>(req.get())));
+
+    rv = newChannel->AsyncOpen(static_cast<nsIStreamListener *>(hvc), nsnull);
+    if (NS_SUCCEEDED(rv))
+      NS_ADDREF(*aProxyRequest = req.get());
+
+    NS_RELEASE(hvc);
+
+    return NS_SUCCEEDED(rv);
+  }
+}
+
+PRBool imgLoader::ValidateEntry(imgCacheEntry *aEntry,
+                                nsIURI *aURI,
+                                nsIURI *aInitialDocumentURI,
+                                nsIURI *aReferrerURI,
+                                nsILoadGroup *aLoadGroup,
+                                imgIDecoderObserver *aObserver,
+                                nsISupports *aCX,
+                                nsLoadFlags aLoadFlags,
+                                PRBool aCanMakeNewChannel,
+                                imgIRequest *aExistingRequest,
+                                imgIRequest **aProxyRequest)
+{
+  LOG_SCOPE(gImgLog, "imgLoader::ValidateEntry");
+
+  PRBool hasExpired;
+  PRUint32 expirationTime = aEntry->GetExpiryTime();
+  if (expirationTime <= SecondsFromPRTime(PR_Now())) {
+    hasExpired = PR_TRUE;
+  } else {
+    hasExpired = PR_FALSE;
+  }
+
+  nsresult rv;
+
+  // Special treatment for file URLs - aEntry has expired if file has changed
+  nsCOMPtr<nsIFileURL> fileUrl(do_QueryInterface(aURI));
+  if (fileUrl) {
+    PRUint32 lastModTime = aEntry->GetTouchedTime();
+
+    nsCOMPtr<nsIFile> theFile;
+    rv = fileUrl->GetFile(getter_AddRefs(theFile));
+    if (NS_SUCCEEDED(rv)) {
+      PRInt64 fileLastMod;
+      rv = theFile->GetLastModifiedTime(&fileLastMod);
+      if (NS_SUCCEEDED(rv)) {
+        // nsIFile uses millisec, NSPR usec
+        fileLastMod *= 1000;
+        hasExpired = SecondsFromPRTime((PRTime)fileLastMod) > lastModTime;
+      }
+    }
+  }
+
+  nsRefPtr<imgRequest> request(aEntry->GetRequest());
+
+  if (!request)
+    return PR_FALSE;
+
+  PRBool validateRequest = PR_FALSE;
+
+  // If the request's loadId is the same as the aCX, then it is ok to use
+  // this one because it has already been validated for this context.
+  //
+  // XXX: nsnull seems to be a 'special' key value that indicates that NO
+  //      validation is required.
+  //
+  void *key = (void *)aCX;
+  if (request->mLoadId != key) {
+    // Determine whether the cache aEntry must be revalidated...
+    validateRequest = ShouldRevalidateEntry(aEntry, aLoadFlags, hasExpired);
+
+    PR_LOG(gImgLog, PR_LOG_DEBUG,
+           ("imgLoader::ValidateEntry validating cache entry. " 
+            "validateRequest = %d", validateRequest));
+  }
+#if defined(PR_LOGGING)
+  else if (!key) {
+    nsCAutoString spec;
+    aURI->GetSpec(spec);
+
+    PR_LOG(gImgLog, PR_LOG_DEBUG,
+           ("imgLoader::ValidateEntry BYPASSING cache validation for %s " 
+            "because of NULL LoadID", spec.get()));
+  }
+#endif
+
+  //
+  // Get the current thread...  This is used as a cacheId to prevent
+  // sharing requests which are being loaded across multiple threads...
+  //
+  void *cacheId = NS_GetCurrentThread();
+  if (!request->IsReusable(cacheId)) {
+    //
+    // The current request is still being loaded and lives on a different
+    // event queue.
+    //
+    // Since its event queue is NOT active, do not reuse this imgRequest.
+    // PutIntoCache() will also ensure that we don't cache it.
+    //
+    PR_LOG(gImgLog, PR_LOG_DEBUG,
+           ("imgLoader::ValidateEntry -- DANGER!! Unable to use cached "
+            "imgRequest [request=%p]\n", address_of(request)));
+
+    return PR_FALSE;
+  }
+
+  if (validateRequest && aCanMakeNewChannel) {
+    LOG_SCOPE(gImgLog, "imgLoader::ValidateRequest |cache hit| must validate");
+
+    return ValidateRequestWithNewChannel(request, aURI, aInitialDocumentURI,
+                                         aReferrerURI, aLoadGroup, aObserver,
+                                         aCX, aLoadFlags, aExistingRequest,
+                                         aProxyRequest);
+  } 
+
+  return !validateRequest;
+}
+
+
+PRBool imgLoader::RemoveFromCache(nsIURI *aKey)
+{
+  LOG_STATIC_FUNC(gImgLog, "imgLoader::RemoveFromCache uri");
+  if (!aKey) return PR_FALSE;
+
+  imgCacheTable &cache = GetCache(aKey);
+  imgCacheQueue &queue = GetCacheQueue(aKey);
+
+  nsCAutoString spec;
+  aKey->GetSpec(spec);
+
+  nsRefPtr<imgCacheEntry> entry;
+  if (cache.Get(spec, getter_AddRefs(entry)) && entry) {
+    if (gCacheTracker)
+      gCacheTracker->RemoveObject(entry);
+    cache.Remove(spec);
+    queue.Remove(entry);
+    entry->SetEvicted(PR_TRUE);
+    return PR_TRUE;
+  }
+  else
+    return PR_FALSE;
+}
+
+PRBool imgLoader::RemoveFromCache(imgCacheEntry *entry)
+{
+  LOG_STATIC_FUNC(gImgLog, "imgLoader::RemoveFromCache entry");
+  PRBool ret = PR_FALSE;
+  nsRefPtr<imgRequest> request(getter_AddRefs(entry->GetRequest()));
+  if (request) {
+    nsCOMPtr<nsIURI> key;
+    if (NS_SUCCEEDED(request->GetURI(getter_AddRefs(key))) && key)
+      ret = RemoveFromCache(key);
+  }
+
+  return ret;
+}
+
+nsresult imgLoader::EvictEntries(imgCacheTable &aCacheToClear, imgCacheQueue &aQueueToClear)
+{
+  LOG_STATIC_FUNC(gImgLog, "imgLoader::EvictEntries");
+
+  // We have to make a temporary, since RemoveFromCache removes the element
+  // from the queue, invalidating iterators.
+  nsTArray<nsRefPtr<imgCacheEntry> > entries;
+  for (imgCacheQueue::iterator it = aQueueToClear.begin(); it != aQueueToClear.end(); ++it)
+    entries.AppendElement(*it);
+  
+  for (PRUint32  i = 0; i < entries.Length(); ++i)
+    if (!RemoveFromCache(entries[i]))
+      return NS_ERROR_FAILURE;
+
+  return NS_OK;
+}
+
+#define LOAD_FLAGS_CACHE_MASK    (nsIRequest::LOAD_BYPASS_CACHE | \
+                                  nsIRequest::LOAD_FROM_CACHE)
+
+#define LOAD_FLAGS_VALIDATE_MASK (nsIRequest::VALIDATE_ALWAYS |   \
+                                  nsIRequest::VALIDATE_NEVER |    \
+                                  nsIRequest::VALIDATE_ONCE_PER_SESSION)
+
+
+/* imgIRequest loadImage (in nsIURI aURI, in nsIURI initialDocumentURI, in nsILoadGroup aLoadGroup, in imgIDecoderObserver aObserver, in nsISupports aCX, in nsLoadFlags aLoadFlags, in nsISupports cacheKey, in imgIRequest aRequest); */
+
+NS_IMETHODIMP imgLoader::LoadImage(nsIURI *aURI, 
+                                   nsIURI *aInitialDocumentURI,
+                                   nsIURI *aReferrerURI,
+                                   nsILoadGroup *aLoadGroup,
+                                   imgIDecoderObserver *aObserver,
+                                   nsISupports *aCX,
+                                   nsLoadFlags aLoadFlags,
+                                   nsISupports *aCacheKey,
+                                   imgIRequest *aRequest,
+                                   imgIRequest **_retval)
+{
+  VerifyCacheSizes();
+
+  NS_ASSERTION(aURI, "imgLoader::LoadImage -- NULL URI pointer");
+
+  if (!aURI)
+    return NS_ERROR_NULL_POINTER;
+
+#if defined(PR_LOGGING)
+  nsCAutoString spec;
+  aURI->GetSpec(spec);
+  LOG_SCOPE_WITH_PARAM(gImgLog, "imgLoader::LoadImage", "aURI", spec.get());
+#endif
+
+  *_retval = nsnull;
+
+  nsRefPtr<imgRequest> request;
+
+  nsresult rv;
+  nsLoadFlags requestFlags = nsIRequest::LOAD_NORMAL;
+
+  // Get the default load flags from the loadgroup (if possible)...
+  if (aLoadGroup) {
+    aLoadGroup->GetLoadFlags(&requestFlags);
+  }
+  //
+  // Merge the default load flags with those passed in via aLoadFlags.
+  // Currently, *only* the caching, validation and background load flags
+  // are merged...
+  //
+  // The flags in aLoadFlags take precedence over the default flags!
+  //
+  if (aLoadFlags & LOAD_FLAGS_CACHE_MASK) {
+    // Override the default caching flags...
+    requestFlags = (requestFlags & ~LOAD_FLAGS_CACHE_MASK) |
+                   (aLoadFlags & LOAD_FLAGS_CACHE_MASK);
+  }
+  if (aLoadFlags & LOAD_FLAGS_VALIDATE_MASK) {
+    // Override the default validation flags...
+    requestFlags = (requestFlags & ~LOAD_FLAGS_VALIDATE_MASK) |
+                   (aLoadFlags & LOAD_FLAGS_VALIDATE_MASK);
+  }
+  if (aLoadFlags & nsIRequest::LOAD_BACKGROUND) {
+    // Propagate background loading...
+    requestFlags |= nsIRequest::LOAD_BACKGROUND;
+  }
+
+  nsRefPtr<imgCacheEntry> entry;
+
+  // If we're bypassing the cache, we are guaranteed to want a new cache entry,
+  // since we're going to do a new load.
+  if (aLoadFlags & nsIRequest::LOAD_BYPASS_CACHE) {
+    RemoveFromCache(aURI);
+  } else {
+    // Look in the cache for our URI, and then validate it.
+    // XXX For now ignore aCacheKey. We will need it in the future
+    // for correctly dealing with image load requests that are a result
+    // of post data.
+    imgCacheTable &cache = GetCache(aURI);
+    nsCAutoString spec;
+
+    aURI->GetSpec(spec);
+
+    if (cache.Get(spec, getter_AddRefs(entry)) && entry) {
+      if (gCacheTracker)
+        gCacheTracker->MarkUsed(entry);
+
+      if (ValidateEntry(entry, aURI, aInitialDocumentURI, aReferrerURI, aLoadGroup, aObserver, aCX,
+                        requestFlags, PR_TRUE, aRequest, _retval)) {
+        request = getter_AddRefs(entry->GetRequest());
+
+        entry->Touch();
+#ifdef DEBUG_joe
+        printf("CACHEGET: %d %s %d\n", time(NULL), spec.get(), entry->GetDataSize());
+#endif
+      }
+      else
+        entry = nsnull;
+    }
+  }
+
+  // If we didn't get a cache hit, we need to load from the network.
+  if (!request) {
+    LOG_SCOPE(gImgLog, "imgLoader::LoadImage |cache miss|");
+
+    nsCOMPtr<nsIChannel> newChannel;
+    rv = NewImageChannel(getter_AddRefs(newChannel),
+                         aURI,
+                         aInitialDocumentURI,
+                         aReferrerURI,
+                         aLoadGroup,
+                         requestFlags);
+    if (NS_FAILED(rv))
+      return NS_ERROR_FAILURE;
+
+    if (!NewRequestAndEntry(aURI, getter_AddRefs(request), getter_AddRefs(entry)))
+      return NS_ERROR_OUT_OF_MEMORY;
+
+    PR_LOG(gImgLog, PR_LOG_DEBUG,
+           ("[this=%p] imgLoader::LoadImage -- Created new imgRequest [request=%p]\n", this, request.get()));
+
+    // Create a loadgroup for this new channel.  This way if the channel
+    // is redirected, we'll have a way to cancel the resulting channel.
+    nsCOMPtr<nsILoadGroup> loadGroup =
+        do_CreateInstance(NS_LOADGROUP_CONTRACTID);
+    newChannel->SetLoadGroup(loadGroup);
+
+    void *cacheId = NS_GetCurrentThread();
+    request->Init(aURI, loadGroup, entry, cacheId, aCX);
+
+    // create the proxy listener
+    ProxyListener *pl = new ProxyListener(static_cast<nsIStreamListener *>(request.get()));
+    if (!pl) {
+      request->Cancel(NS_ERROR_OUT_OF_MEMORY);
+      return NS_ERROR_OUT_OF_MEMORY;
+    }
+
+    NS_ADDREF(pl);
+
+    PR_LOG(gImgLog, PR_LOG_DEBUG,
+           ("[this=%p] imgLoader::LoadImage -- Calling channel->AsyncOpen()\n", this));
+
+    nsresult openRes = newChannel->AsyncOpen(static_cast<nsIStreamListener *>(pl), nsnull);
+
+    NS_RELEASE(pl);
+
+    if (NS_FAILED(openRes)) {
+      PR_LOG(gImgLog, PR_LOG_DEBUG,
+             ("[this=%p] imgLoader::LoadImage -- AsyncOpen() failed: 0x%x\n",
+              this, openRes));
+      request->Cancel(openRes);
+      return openRes;
+    }
+
+    // Try to add the new request into the cache.
+    PutIntoCache(aURI, entry);
+
+  // If we did get a cache hit, use it.
+  } else {
+    // XXX: Should this be executed if an expired cache entry does not have a caching channel??
+    LOG_MSG_WITH_PARAM(gImgLog, 
+                       "imgLoader::LoadImage |cache hit|", "request", request);
+
+    // Update the request's LoadId
+    request->SetLoadId(aCX);
+  }
+
+  // If we didn't get a proxy when validating the cache entry, we need to create one.
+  if (!*_retval) {
+    LOG_MSG(gImgLog, "imgLoader::LoadImage", "creating proxy request.");
+
+    rv = CreateNewProxyForRequest(request, aLoadGroup, aObserver,
+                                  requestFlags, aRequest, _retval);
+    imgRequestProxy *proxy = static_cast<imgRequestProxy *>(*_retval);
+
+    // Note that it's OK to add here even if the request is done.  If it is,
+    // it'll send a OnStopRequest() to the proxy in NotifyProxyListener and the
+    // proxy will be removed from the loadgroup.
+    proxy->AddToLoadGroup();
+
+    request->NotifyProxyListener(proxy);
+
+    return rv;
+  }
+
+  NS_ASSERTION(*_retval, "imgLoader::LoadImage -- no return value");
+
+  return NS_OK;
+}
+
+/* imgIRequest loadImageWithChannel(in nsIChannel channel, in imgIDecoderObserver aObserver, in nsISupports cx, out nsIStreamListener); */
+NS_IMETHODIMP imgLoader::LoadImageWithChannel(nsIChannel *channel, imgIDecoderObserver *aObserver, nsISupports *aCX, nsIStreamListener **listener, imgIRequest **_retval)
+{
+  NS_ASSERTION(channel, "imgLoader::LoadImageWithChannel -- NULL channel pointer");
+
+  nsresult rv;
+  nsRefPtr<imgRequest> request;
+
+  nsCOMPtr<nsIURI> uri;
+  channel->GetURI(getter_AddRefs(uri));
+
+  nsLoadFlags requestFlags = nsIRequest::LOAD_NORMAL;
+  channel->GetLoadFlags(&requestFlags);
+
+  nsRefPtr<imgCacheEntry> entry;
+
+  if (requestFlags & nsIRequest::LOAD_BYPASS_CACHE) {
+    RemoveFromCache(uri);
+  } else {
+    // Look in the cache for our URI, and then validate it.
+    // XXX For now ignore aCacheKey. We will need it in the future
+    // for correctly dealing with image load requests that are a result
+    // of post data.
+    imgCacheTable &cache = GetCache(uri);
+    nsCAutoString spec;
+
+    uri->GetSpec(spec);
+
+    if (cache.Get(spec, getter_AddRefs(entry)) && entry) {
+      if (gCacheTracker)
+        gCacheTracker->MarkUsed(entry);
+
+      // We don't want to kick off another network load. So we ask
+      // ValidateEntry to only do validation without creating a new proxy. If
+      // it says that the entry isn't valid any more, we'll only use the entry
+      // we're getting if the channel is loading from the cache anyways.
+      //
+      // XXX -- should this be changed? it's pretty much verbatim from the old
+      // code, but seems nonsensical.
+      if (ValidateEntry(entry, uri, nsnull, nsnull, nsnull, aObserver, aCX,
+                        requestFlags, PR_FALSE, nsnull, nsnull)) {
+        request = getter_AddRefs(entry->GetRequest());
+      } else {
+        nsCOMPtr<nsICachingChannel> cacheChan(do_QueryInterface(channel));
+        PRBool bUseCacheCopy;
+
+        if (cacheChan)
+          cacheChan->IsFromCache(&bUseCacheCopy);
+        else
+          bUseCacheCopy = PR_FALSE;
+
+        if (!bUseCacheCopy)
+          entry = nsnull;
+        else {
+          request = getter_AddRefs(entry->GetRequest());
+        }
+      }
+    }
+  }
+
+  nsCOMPtr<nsILoadGroup> loadGroup;
+  channel->GetLoadGroup(getter_AddRefs(loadGroup));
+
+  if (request) {
+    // we have this in our cache already.. cancel the current (document) load
+
+    channel->Cancel(NS_IMAGELIB_ERROR_LOAD_ABORTED); // this should fire an OnStopRequest
+
+    *listener = nsnull; // give them back a null nsIStreamListener
+  } else {
+
+    // Get the current Thread...  This is used as a cacheId to prevent
+    // sharing requests which are being loaded across multiple threads...
+    nsIThread *thread = NS_GetCurrentThread();
+
+    NewRequestAndEntry(uri, getter_AddRefs(request), getter_AddRefs(entry));
+
+    // XXX(darin):  I'm not sure that using the original URI is correct here.
+    // Perhaps we should use the same URI that indexes the cache?  Or, perhaps
+    // the cache should use the original URI?  See bug 89419.
+    nsCOMPtr<nsIURI> originalURI;
+    channel->GetOriginalURI(getter_AddRefs(originalURI));
+    request->Init(originalURI, channel, entry, thread, aCX);
+
+    ProxyListener *pl = new ProxyListener(static_cast<nsIStreamListener *>(request.get()));
+    if (!pl)
+      return NS_ERROR_OUT_OF_MEMORY;
+
+    NS_ADDREF(pl);
+
+    *listener = static_cast<nsIStreamListener*>(pl);
+    NS_ADDREF(*listener);
+
+    NS_RELEASE(pl);
+
+    // Try to add the new request into the cache.
+    PutIntoCache(uri, entry);
+  }
+
+  // XXX: It looks like the wrong load flags are being passed in...
+  requestFlags &= 0xFFFF;
+
+  rv = CreateNewProxyForRequest(request, loadGroup, aObserver,
+                                requestFlags, nsnull, _retval);
+  request->NotifyProxyListener(static_cast<imgRequestProxy*>(*_retval));
+
+  return rv;
+}
+
 
 NS_IMETHODIMP imgLoader::SupportImageWithMimeType(const char* aMimeType, PRBool *_retval)
 {
   *_retval = PR_FALSE;
   nsCOMPtr<nsIComponentRegistrar> reg;
@@ -875,35 +1397,28 @@ NS_IMETHODIMP ProxyListener::OnDataAvail
     return NS_ERROR_FAILURE;
 
   return mDestListener->OnDataAvailable(aRequest, ctxt, inStr, sourceOffset, count);
 }
 
-
-
-
-
 /**
  * http validate class.  check a channel for a 304
  */
 
 NS_IMPL_ISUPPORTS2(imgCacheValidator, nsIStreamListener, nsIRequestObserver)
 
+imgLoader imgCacheValidator::sImgLoader;
+
 imgCacheValidator::imgCacheValidator(imgRequest *request, void *aContext) :
+  mRequest(request),
   mContext(aContext)
-{
-  /* member initializers and constructor code */
-
-  mRequest = request;
-  NS_ADDREF(mRequest);
-}
+{}
 
 imgCacheValidator::~imgCacheValidator()
 {
   /* destructor code */
   if (mRequest) {
     mRequest->mValidator = nsnull;
-    NS_RELEASE(mRequest);
   }
 }
 
 void imgCacheValidator::AddProxy(imgRequestProxy *aProxy)
 {
@@ -931,34 +1446,33 @@ NS_IMETHODIMP imgCacheValidator::OnStart
       }
 
       mRequest->SetLoadId(mContext);
       mRequest->mValidator = nsnull;
 
-      NS_RELEASE(mRequest); // assigns null
+      mRequest = nsnull;
 
       return NS_OK;
     }
   }
+
   // fun stuff.
   nsCOMPtr<nsIChannel> channel(do_QueryInterface(aRequest));
-  nsCOMPtr<nsICacheEntryDescriptor> entry;
+  nsRefPtr<imgCacheEntry> entry;
   nsCOMPtr<nsIURI> uri;
 
   // Doom the old request's cache entry
   mRequest->RemoveFromCache();
 
   mRequest->GetURI(getter_AddRefs(uri));
 
   mRequest->mValidator = nsnull;
-  NS_RELEASE(mRequest); // assigns null
+  mRequest = nsnull;
 
   imgRequest *request;
-  NS_NEWXPCOM(request, imgRequest);
-  if (!request) return NS_ERROR_OUT_OF_MEMORY;
-  NS_ADDREF(request);
 
-  imgCache::Put(uri, request, getter_AddRefs(entry));
+  if (!NewRequestAndEntry(uri, &request, getter_AddRefs(entry)))
+      return NS_ERROR_OUT_OF_MEMORY;
 
   // XXX(darin):  I'm not sure that using the original URI is correct here.
   // Perhaps we should use the same URI that indexes the cache?  Or, perhaps
   // the cache should use the original URI?  See bug 89419.
   nsCOMPtr<nsIURI> originalURI;
@@ -977,10 +1491,13 @@ NS_IMETHODIMP imgCacheValidator::OnStart
   for (PRInt32 i = count-1; i>=0; i--) {
     imgRequestProxy *proxy = static_cast<imgRequestProxy *>(mProxies[i]);
     proxy->ChangeOwner(request);
     request->NotifyProxyListener(proxy);
   }
+
+  // Try to add the new request into the cache.
+  sImgLoader.PutIntoCache(uri, entry);
 
   NS_RELEASE(request);
 
   if (!mDestListener)
     return NS_OK;
diff -r f3ac957eb4af modules/libpr0n/src/imgLoader.h
--- a/modules/libpr0n/src/imgLoader.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/modules/libpr0n/src/imgLoader.h	Sat Sep 06 10:14:37 2008 +0300
@@ -36,11 +36,18 @@
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 #include "imgILoader.h"
+#include "imgICache.h"
+#include "nsWeakReference.h"
 #include "nsIContentSniffer.h"
+#include "nsRefPtrHashtable.h"
+#include "nsExpirationTracker.h"
+#include "nsAutoPtr.h"
+#include "prtypes.h"
+#include "imgRequest.h"
 
 #ifdef LOADER_THREADSAFE
 #include "prlock.h"
 #endif
 
@@ -48,35 +55,247 @@ class imgRequestProxy;
 class imgRequestProxy;
 class imgIRequest;
 class imgIDecoderObserver;
 class nsILoadGroup;
 
+class imgCacheEntry
+{
+public:
+  imgCacheEntry(imgRequest *request, PRBool mustValidateIfExpired = PR_FALSE);
+
+  nsrefcnt AddRef()
+  {
+    NS_PRECONDITION(PRInt32(mRefCnt) >= 0, "illegal refcnt");
+    NS_ASSERT_OWNINGTHREAD(imgCacheEntry);
+    ++mRefCnt;
+    NS_LOG_ADDREF(this, mRefCnt, "imgCacheEntry", sizeof(*this));
+    return mRefCnt;
+  }
+ 
+  nsrefcnt Release()
+  {
+    NS_PRECONDITION(0 != mRefCnt, "dup release");
+    NS_ASSERT_OWNINGTHREAD(imgCacheEntry);
+    --mRefCnt;
+    NS_LOG_RELEASE(this, mRefCnt, "imgCacheEntry");
+    if (mRefCnt == 0) {
+      mRefCnt = 1; /* stabilize */
+      delete this;
+      return 0;
+    }
+    return mRefCnt;                              
+  }
+
+  PRUint32 GetDataSize() const
+  {
+    return mDataSize;
+  }
+  void SetDataSize(PRUint32 aDataSize)
+  {
+    PRInt32 oldsize = mDataSize;
+    mDataSize = aDataSize;
+    TouchWithSize(mDataSize - oldsize);
+  }
+
+  PRInt32 GetTouchedTime() const
+  {
+    return mTouchedTime;
+  }
+  void SetTouchedTime(PRInt32 time)
+  {
+    mTouchedTime = time;
+    Touch(/* updateTime = */ PR_FALSE);
+  }
+
+  PRInt32 GetExpiryTime() const
+  {
+    return mExpiryTime;
+  }
+  void SetExpiryTime(PRInt32 aExpiryTime)
+  {
+    mExpiryTime = aExpiryTime;
+    Touch();
+  }
+
+  PRBool GetMustValidateIfExpired() const
+  {
+    return mMustValidateIfExpired;
+  }
+  void SetMustValidateIfExpired(PRBool aValidate)
+  {
+    mMustValidateIfExpired = aValidate;
+    Touch();
+  }
+
+  already_AddRefed<imgRequest> GetRequest() const
+  {
+    imgRequest *req = mRequest;
+    NS_ADDREF(req);
+    return req;
+  }
+
+  PRBool Evicted() const
+  {
+    return mEvicted;
+  }
+
+  nsExpirationState *GetExpirationState()
+  {
+    return &mExpirationState;
+  }
+
+private: // methods
+  friend class imgLoader;
+  friend class imgCacheQueue;
+  void Touch(PRBool updateTime = PR_TRUE);
+  void TouchWithSize(PRInt32 diff);
+  void SetEvicted(PRBool evict)
+  {
+    mEvicted = evict;
+  }
+
+private: // data
+  nsAutoRefCnt mRefCnt;
+  NS_DECL_OWNINGTHREAD
+
+  nsRefPtr<imgRequest> mRequest;
+  PRUint32 mDataSize;
+  PRInt32 mTouchedTime;
+  PRInt32 mExpiryTime;
+  nsExpirationState mExpirationState;
+  PRBool mMustValidateIfExpired;
+  PRBool mEvicted;
+};
+
+#include <vector>
+
 #define NS_IMGLOADER_CID \
 { /* 9f6a0d2e-1dd1-11b2-a5b8-951f13c846f7 */         \
      0x9f6a0d2e,                                     \
      0x1dd1,                                         \
      0x11b2,                                         \
     {0xa5, 0xb8, 0x95, 0x1f, 0x13, 0xc8, 0x46, 0xf7} \
 }
 
-class imgLoader : public imgILoader, public nsIContentSniffer
+class imgCacheQueue
+{
+public: 
+  imgCacheQueue();
+  void Remove(imgCacheEntry *);
+  void Push(imgCacheEntry *);
+  void MarkDirty();
+  PRBool IsDirty();
+  already_AddRefed<imgCacheEntry> Pop();
+  void Refresh();
+  PRUint32 GetSize() const;
+  void UpdateSize(PRInt32 diff);
+  PRUint32 GetNumElements() const;
+  typedef std::vector<nsRefPtr<imgCacheEntry> > queueContainer;  
+  typedef queueContainer::iterator iterator;
+  typedef queueContainer::const_iterator const_iterator;
+
+  iterator begin();
+  const_iterator begin() const;
+  iterator end();
+  const_iterator end() const;
+
+private:
+  queueContainer mQueue;
+  PRBool mDirty;
+  PRUint32 mSize;
+};
+
+class imgLoader : public imgILoader,
+                  public nsIContentSniffer,
+                  public imgICache,
+                  public nsSupportsWeakReference
 {
 public:
   NS_DECL_ISUPPORTS
   NS_DECL_IMGILOADER
   NS_DECL_NSICONTENTSNIFFER
+  NS_DECL_IMGICACHE
 
   imgLoader();
   virtual ~imgLoader();
 
   static nsresult GetMimeTypeFromContent(const char* aContents, PRUint32 aLength, nsACString& aContentType);
 
-private:
+  static void Shutdown(); // for use by the factory
+
+  static nsresult ClearChromeImageCache();
+  static nsresult ClearImageCache();
+
+  static nsresult InitCache();
+
+  static PRBool RemoveFromCache(nsIURI *aKey);
+  static PRBool RemoveFromCache(imgCacheEntry *entry);
+
+  static PRBool PutIntoCache(nsIURI *key, imgCacheEntry *entry);
+
+  // Returns true if |one| is less than |two|
+  // This mixes units in the worst way, but provides reasonable results.
+  inline static bool CompareCacheEntries(const nsRefPtr<imgCacheEntry> &one,
+                                  const nsRefPtr<imgCacheEntry> &two)
+  {
+    if (!one)
+      return false;
+    if (!two)
+      return true;
+
+    const PRFloat64 sizeweight = 1.0 - sCacheTimeWeight;
+    PRInt32 diffsize = PRInt32(two->GetDataSize()) - PRInt32(one->GetDataSize());
+    PRInt32 difftime = one->GetTouchedTime() - two->GetTouchedTime();
+    return difftime * sCacheTimeWeight + diffsize * sizeweight < 0;
+  }
+
+  static void VerifyCacheSizes();
+
+private: // methods
+
+
+  PRBool ValidateEntry(imgCacheEntry *aEntry, nsIURI *aKey,
+                       nsIURI *aInitialDocumentURI, nsIURI *aReferrerURI, 
+                       nsILoadGroup *aLoadGroup,
+                       imgIDecoderObserver *aObserver, nsISupports *aCX,
+                       nsLoadFlags aLoadFlags, PRBool aCanMakeNewChannel,
+                       imgIRequest *aExistingRequest,
+                       imgIRequest **aProxyRequest);
+  PRBool ValidateRequestWithNewChannel(imgRequest *request, nsIURI *aURI,
+                                       nsIURI *aInitialDocumentURI,
+                                       nsIURI *aReferrerURI,
+                                       nsILoadGroup *aLoadGroup,
+                                       imgIDecoderObserver *aObserver,
+                                       nsISupports *aCX, nsLoadFlags aLoadFlags,
+                                       imgIRequest *aExistingRequest,
+                                       imgIRequest **aProxyRequest);
+
   nsresult CreateNewProxyForRequest(imgRequest *aRequest, nsILoadGroup *aLoadGroup,
                                     imgIDecoderObserver *aObserver,
                                     nsLoadFlags aLoadFlags, imgIRequest *aRequestProxy,
                                     imgIRequest **_retval);
+
+
+  typedef nsRefPtrHashtable<nsCStringHashKey, imgCacheEntry> imgCacheTable;
+
+  static nsresult EvictEntries(imgCacheTable &aCacheToClear, imgCacheQueue &aQueueToClear);
+
+  static imgCacheTable &GetCache(nsIURI *aURI);
+  static imgCacheQueue &GetCacheQueue(nsIURI *aURI);
+  static void CacheEntriesChanged(nsIURI *aURI, PRInt32 sizediff = 0);
+  static void CheckCacheLimits(imgCacheTable &cache, imgCacheQueue &queue);
+
+private: // data
+  friend class imgCacheEntry;
+
+  static imgCacheTable sCache;
+  static imgCacheQueue sCacheQueue;
+
+  static imgCacheTable sChromeCache;
+  static imgCacheQueue sChromeCacheQueue;
+  static PRFloat64 sCacheTimeWeight;
+  static PRUint32 sCacheMaxSize;
 };
 
 
 
 /**
@@ -122,10 +341,12 @@ public:
   NS_DECL_NSIREQUESTOBSERVER
 
 private:
   nsCOMPtr<nsIStreamListener> mDestListener;
 
-  imgRequest *mRequest;
+  nsRefPtr<imgRequest> mRequest;
   nsCOMArray<imgIRequest> mProxies;
 
   void *mContext;
+
+  static imgLoader sImgLoader;
 };
diff -r f3ac957eb4af modules/libpr0n/src/imgRequest.cpp
--- a/modules/libpr0n/src/imgRequest.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/modules/libpr0n/src/imgRequest.cpp	Sat Sep 06 10:14:37 2008 +0300
@@ -61,10 +61,12 @@
 #include "nsIProxyObjectManager.h"
 #include "nsIServiceManager.h"
 #include "nsISupportsPrimitives.h"
 #include "nsIScriptSecurityManager.h"
 
+#include "nsICacheVisitor.h"
+
 #include "nsString.h"
 #include "nsXPIDLString.h"
 #include "plstr.h" // PL_strcasestr(...)
 
 #if defined(PR_LOGGING)
@@ -90,11 +92,11 @@ imgRequest::~imgRequest()
   /* destructor code */
 }
 
 nsresult imgRequest::Init(nsIURI *aURI,
                           nsIRequest *aRequest,
-                          nsICacheEntryDescriptor *aCacheEntry,
+                          imgCacheEntry *aCacheEntry,
                           void *aCacheId,
                           void *aLoadId)
 {
   LOG_FUNC(gImgLog, "imgRequest::Init");
 
@@ -334,11 +336,11 @@ void imgRequest::RemoveFromCache()
 void imgRequest::RemoveFromCache()
 {
   LOG_SCOPE(gImgLog, "imgRequest::RemoveFromCache");
 
   if (mCacheEntry) {
-    mCacheEntry->Doom();
+    imgLoader::RemoveFromCache(mURI);
     mCacheEntry = nsnull;
   }
 }
 
 PRBool imgRequest::HaveProxyWithObserver(imgRequestProxy* aProxyToIgnore) const
@@ -521,17 +523,23 @@ NS_IMETHODIMP imgRequest::OnStopFrame(im
   LOG_SCOPE(gImgLog, "imgRequest::OnStopFrame");
 
   mImageStatus |= imgIRequest::STATUS_FRAME_COMPLETE;
 
   if (mCacheEntry) {
-    PRUint32 cacheSize = 0;
-    mCacheEntry->GetDataSize(&cacheSize);
+    PRUint32 cacheSize = mCacheEntry->GetDataSize();
 
     PRUint32 imageSize = 0;
     frame->GetImageDataLength(&imageSize);
 
     mCacheEntry->SetDataSize(cacheSize + imageSize);
+
+#ifdef DEBUG_joe
+    nsCAutoString url;
+    mURI->GetSpec(url);
+
+    printf("CACHEPUT: %d %s %d\n", time(NULL), url.get(), cacheSize + imageSize);
+#endif
   }
 
   nsTObserverArray<imgRequestProxy*>::ForwardIterator iter(mObservers);
   while (iter.HasMore()) {
     iter.GetNext()->OnStopFrame(frame);
@@ -645,11 +653,11 @@ NS_IMETHODIMP imgRequest::OnStartRequest
           PRUint32 expiration;
           /* get the expiration time from the caching channel's token */
           entryDesc->GetExpirationTime(&expiration);
 
           /* set the expiration time on our entry */
-          mCacheEntry->SetExpirationTime(expiration);
+          mCacheEntry->SetExpiryTime(expiration);
         }
       }
     }
     //
     // Determine whether the cache entry must be revalidated when it expires.
@@ -676,13 +684,11 @@ NS_IMETHODIMP imgRequest::OnStartRequest
         if (PL_strcasestr(cacheHeader.get(), "must-revalidate")) {
           bMustRevalidate = PR_TRUE;
         }
       }
 
-      if (bMustRevalidate) {
-        mCacheEntry->SetMetaDataElement("MustValidateIfExpired", "true");
-      }
+      mCacheEntry->SetMustValidateIfExpired(bMustRevalidate);
     }
   }
 
 
   // Shouldn't we be dead already if this gets hit?  Probably multipart/x-mixed-replace...
@@ -750,13 +756,10 @@ NS_IMETHODIMP imgRequest::OnStopRequest(
     iter.GetNext()->OnStopRequest(aRequest, ctxt, status, mHadLastPart);
   }
 
   return NS_OK;
 }
-
-
-
 
 /* prototype for this defined below */
 static NS_METHOD sniff_mimetype_callback(nsIInputStream* in, void* closure, const char* fromRawSegment,
                                          PRUint32 toOffset, PRUint32 count, PRUint32 *writeCount);
 
diff -r f3ac957eb4af modules/libpr0n/src/imgRequest.h
--- a/modules/libpr0n/src/imgRequest.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/modules/libpr0n/src/imgRequest.h	Sat Sep 06 10:14:37 2008 +0300
@@ -44,11 +44,10 @@
 
 #include "imgIContainer.h"
 #include "imgIDecoder.h"
 #include "imgIDecoderObserver.h"
 
-#include "nsICacheEntryDescriptor.h"
 #include "nsIContentSniffer.h"
 #include "nsIRequest.h"
 #include "nsIProperties.h"
 #include "nsIStreamListener.h"
 #include "nsIURI.h"
@@ -61,10 +60,11 @@
 #include "nsWeakReference.h"
 
 class imgCacheValidator;
 
 class imgRequestProxy;
+class imgCacheEntry;
 
 enum {
   onStartRequest   = PR_BIT(0),
   onStartDecode    = PR_BIT(1),
   onStartContainer = PR_BIT(2),
@@ -84,11 +84,11 @@ public:
 
   NS_DECL_ISUPPORTS
 
   nsresult Init(nsIURI *aURI,
                 nsIRequest *aRequest,
-                nsICacheEntryDescriptor *aCacheEntry,
+                imgCacheEntry *aCacheEntry,
                 void *aCacheId,
                 void *aLoadId);
 
   // Callers must call NotifyProxyListener later.
   nsresult AddProxy(imgRequestProxy *proxy);
@@ -107,14 +107,14 @@ public:
   // get the current or last network status from our
   // internal nsIChannel.
   nsresult GetNetworkStatus();
 
 private:
+  friend class imgCacheEntry;
   friend class imgRequestProxy;
   friend class imgLoader;
   friend class imgCacheValidator;
-  friend class imgCache;
 
   inline void SetLoadId(void *aLoadId) {
     mLoadId = aLoadId;
     mLoadTime = PR_Now();
   }
@@ -168,11 +168,11 @@ private:
   PRUint32 mNetworkStatus;
   PRUint32 mImageStatus;
   PRUint32 mState;
   nsCString mContentType;
 
-  nsCOMPtr<nsICacheEntryDescriptor> mCacheEntry; /* we hold on to this to this so long as we have observers */
+  nsRefPtr<imgCacheEntry> mCacheEntry; /* we hold on to this to this so long as we have observers */
 
   void *mCacheId;
 
   void *mLoadId;
   PRTime mLoadTime;
diff -r f3ac957eb4af modules/libpr0n/test/Makefile.in
--- a/modules/libpr0n/test/Makefile.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/modules/libpr0n/test/Makefile.in	Sat Sep 06 10:14:37 2008 +0300
@@ -47,11 +47,11 @@ MODULE		= test_libpr0n
 MODULE		= test_libpr0n
 
 XPCSHELL_TESTS  = unit
 
 #ifdef MOZ_MOCHITEST
-#DIRS            += mochitest
+DIRS            += mochitest
 #endif
 
 include $(topsrcdir)/config/rules.mk
 
 # Note: Invoke any additional (non-xpcshell) test programs here.
diff -r f3ac957eb4af modules/libpr0n/test/reftest/apng/bug411852-1-ref.png
Binary file modules/libpr0n/test/reftest/apng/bug411852-1-ref.png has changed
diff -r f3ac957eb4af modules/libpref/src/init/all.js
--- a/modules/libpref/src/init/all.js	Thu Sep 04 12:36:46 2008 -0400
+++ b/modules/libpref/src/init/all.js	Sat Sep 06 10:14:37 2008 +0300
@@ -2620,5 +2620,12 @@ pref("signon.debug",                    
 // Zoom prefs
 pref("browser.zoom.full", false);
 pref("zoom.minPercent", 30);
 pref("zoom.maxPercent", 300);
 pref("toolkit.zoomManager.zoomValues", ".3,.5,.67,.8,.9,1,1.1,1.2,1.33,1.5,1.7,2,2.4,3");
+
+// Image cache prefs
+// The maximum size, in bytes, of the decoded images we cache
+pref("image.cache.size", 5242880);
+// A weight, from 0-1000, to place on time when comparing to size.
+// Size is given a weight of 1000 - timeweight.
+pref("image.cache.timeweight", 500);
diff -r f3ac957eb4af modules/plugin/sdk/samples/Makefile.in
--- a/modules/plugin/sdk/samples/Makefile.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/modules/plugin/sdk/samples/Makefile.in	Sat Sep 06 10:14:37 2008 +0300
@@ -43,9 +43,9 @@ include $(DEPTH)/config/autoconf.mk
 include $(DEPTH)/config/autoconf.mk
 
 DIRS = common
 
 ifeq ($(OS_ARCH),WINNT)
-DIRS += basic/windows scriptable/windows winless/windows
+DIRS += basic/windows winless/windows
 endif
 
 include $(topsrcdir)/config/rules.mk
diff -r f3ac957eb4af modules/plugin/sdk/samples/SanePlugin/Makefile.in
--- a/modules/plugin/sdk/samples/SanePlugin/Makefile.in	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,81 +0,0 @@
-# ***** BEGIN LICENSE BLOCK *****
-# Version: MPL 1.1/GPL 2.0/LGPL 2.1
-#
-# The contents of this file are subject to the Mozilla Public License Version
-# 1.1 (the "License"); you may not use this file except in compliance with
-# the License. You may obtain a copy of the License at
-# http://www.mozilla.org/MPL/
-#
-# Software distributed under the License is distributed on an "AS IS" basis,
-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
-# for the specific language governing rights and limitations under the
-# License.
-#
-# The Original Code is mozilla.org code
-#
-# The Initial Developer of the Original Code is
-# Rusty Lynch
-# Portions created by the Initial Developer are Copyright (C) 2004
-# the Initial Developer. All Rights Reserved.
-#
-# Contributor(s):
-#   Rusty Lynch <rusty.lynch@intel.com>
-#
-# Alternatively, the contents of this file may be used under the terms of
-# either the GNU General Public License Version 2 or later (the "GPL"), or
-# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
-# in which case the provisions of the GPL or the LGPL are applicable instead
-# of those above. If you wish to allow use of your version of this file only
-# under the terms of either the GPL or the LGPL, and not to allow others to
-# use your version of this file under the terms of the MPL, indicate your
-# decision by deleting the provisions above and replace them with the notice
-# and other provisions required by the GPL or the LGPL. If you do not delete
-# the provisions above, a recipient may use your version of this file under
-# the terms of any one of the MPL, the GPL or the LGPL.
-#
-# ***** END LICENSE BLOCK *****
-
-######################################
-# Makefile.in (Generic SANE Plugin Tree)
-######################################
-
-DEPTH		= ../../../..
-topsrcdir	= @top_srcdir@
-srcdir		= @srcdir@
-VPATH		= @srcdir@
-
-include $(DEPTH)/config/autoconf.mk
-
-MODULE = SanePlugin
-LIBRARY_NAME = Sane
-EXPORT_LIBRARY = 1
-IS_COMPONENT = 1
-
-
-CPPSRCS = \
-	nsSanePluginFactory.cpp	\
-	nsSanePlugin.cpp		\
-	$(NULL)
-
-LOCAL_INCLUDES  = -I$(srcdir)/.. -I$(srcdir)/../../public \
-		  -I/usr/lib/glib/include 
-
-EXTRA_DSO_LDOPTS += -L$(DIST)/lib -lgtksuperwin \
-		    $(TK_LIBS) -lsane -ljpeg
-
-XPIDLSRCS = nsSanePluginControl.idl	
-
-include $(topsrcdir)/config/rules.mk
-
-libs:: $(TARGETS)
-	$(INSTALL) $(srcdir)/test/camera.html $(DIST)/bin/res/samples
-	$(INSTALL) $(srcdir)/test/scanner.html $(DIST)/bin/res/samples
-	$(INSTALL) $(srcdir)/test/camera.html /home/httpd/html/test
-	$(INSTALL) $(srcdir)/test/scanner.html /home/httpd/html/test
-
-superclean: clean
-	rm -f *~ test/*~
-
-
-
-
diff -r f3ac957eb4af modules/plugin/sdk/samples/SanePlugin/nsSanePlugin.cpp
--- a/modules/plugin/sdk/samples/SanePlugin/nsSanePlugin.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,2648 +0,0 @@
-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
- *
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org Code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 2001
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-/*
- * Implements the nsSanePluginInterface for the SANE plugin
- */
-
-#include <unistd.h>
-#include <stdio.h>
-#include <string.h>
-#include <fcntl.h>
-#include <errno.h>
-#include <setjmp.h>
-#include <gdk/gdk.h>
-#include <gdk/gdkprivate.h>
-#include <gtk/gtk.h>
-#include <sys/mman.h>
-#include <sys/types.h>
-#include <sys/stat.h>
-#include "nsIIOService.h"
-#include "nsSanePlugin.h"
-#include "plstr.h"
-#include "prmem.h"
-#include "nsIEventQueueService.h"
-#include "nsIEventQueue.h"
-
-extern "C"
-{
-#include "jpeglib.h"
-#include "sane/sane.h"
-#include "sane/sanei.h"
-#include "sane/saneopts.h"
-}
-
-#define MAX_OPT_SIZE (1024 * 2)
-
-struct my_JPEG_error_mgr
-{
-    struct jpeg_error_mgr pub;
-    sigjmp_buf setjmp_buffer;
-};
-typedef struct my_JPEG_error_mgr *emptr;
-
-static void PR_CALLBACK ThreadedDestroyEvent(PLEvent* aEvent);
-static void* PR_CALLBACK ThreadedHandleEvent(PLEvent* aEvent);
-
-//static void PR_CALLBACK scanimage_thread_routine( void * arg );
-
-static void store_filename(GtkFileSelection *selector, gpointer user_data);
-static nsresult optioncat( char ** dest, const char * src, 
-                           const char * ending );
-static void my_jpeg_error_exit (j_common_ptr cinfo);
-static unsigned char* jpeg_file_to_rgb (FILE * f, int *w, int *h);
-static gboolean draw (GtkWidget *widget, GdkEventExpose *event, gpointer data);
-static unsigned char * crop_image(unsigned char *rgb_data, int *rgb_width, 
-                                  int *rgb_height,	gint x, gint y, 
-                                  gint w, gint h);
-static unsigned char * scale_image(unsigned char *rgb_data, int rgb_width, 
-                                   int rgb_height, int w, int h);
-
-static PRInt32 gPluginObjectCount = 0;
-
-static NS_DEFINE_CID(kCPluginManagerCID,        NS_PLUGINMANAGER_CID         );
-static NS_DEFINE_CID(kEventQueueService,        NS_EVENTQUEUESERVICE_CID     );
-
-
-///////////////////////////////////////////////////////////////////////////////
-// Plugin Instance API Methods
-
-nsSanePluginInstance::nsSanePluginInstance( void )
-    : fPeer( NULL ), fWindow( NULL ), fMode( nsPluginMode_Embedded )
-{
-#ifdef DEBUG
-    printf("nsSanePluginInstance::nsSanePluginInstance()\n");
-#endif
-
-    PR_AtomicIncrement(&gPluginObjectCount);
-
-    // set default jpeg compression attributes
-    mCompQuality = 10;
-    mCompMethod = JDCT_FASTEST;
-
-    // Initialize sane interface
-    mSaneDevice = nsnull;
-    mSaneOpen = SANE_FALSE;
-    mRGBData = nsnull;
-    mBottomRightXChange = mBottomRightYChange = 
-        mTopLeftXChange = mTopLeftYChange = 0;
-
-    // initialize JavaScript callback members
-    mOnScanCompleteScript = nsnull;
-    mOnInitCompleteScript = nsnull;
-    mScanThread = nsnull;
-    mUIThread = PR_GetCurrentThread();
-
-    mState = 0; // idle
-    mSuccess = 1; // success
-    mFileSelection = nsnull;
-
-    // initialize gtk widgets
-    fPlatform.widget = nsnull;
-    mEvent_box = nsnull;
-    mDrawing_area = nsnull;
-
-    if (NS_FAILED(CallCreateInstance(kCPluginManagerCID, &mPluginManager))) {
-        NS_ERROR("Error trying to create plugin manager!");
-        return;
-    }
-}
-
-nsSanePluginInstance::~nsSanePluginInstance(void)
-{
-#ifdef DEBUG
-    printf("nsSanePluginInstance::~nsSanePluginInstance(%i)\n", 
-           gPluginObjectCount );
-#endif 
-
-    PR_AtomicDecrement(&gPluginObjectCount);
-    PlatformDestroy(); // Perform platform specific cleanup
-
-    if (mPluginManager) {
-        mPluginManager->Release();
-        mPluginManager = nsnull;
-    }
-
-    sane_exit();
-
-    // cleanup old widgets
-    if (fPlatform.widget)
-        gtk_widget_destroy(fPlatform.widget);
-    if (mEvent_box)
-        gtk_widget_destroy(mEvent_box);
-    if (mDrawing_area)
-        gtk_widget_destroy(mDrawing_area);
-
-    NS_IF_RELEASE(fPeer); 
-    PR_FREEIF(mSaneDevice);
-    PR_FREEIF(mOnScanCompleteScript);
-    PR_FREEIF(mOnInitCompleteScript);
-
-}
-
-// This macro produces simple versions of QueryInterface, AddRef and Release
-// See the nsISupports.h header file for details.
-NS_IMPL_ISUPPORTS2(nsSanePluginInstance, 
-                   nsIPluginInstance, 
-                   nsISanePluginInstance)
-
-NS_METHOD
-nsSanePluginInstance::Initialize( nsIPluginInstancePeer* peer )
-{
-#ifdef DEBUG
-    printf("nsSanePluginInstance::Initialize()\n");
-#endif
-
-    NS_ASSERTION(peer != NULL, "null peer");
-
-    nsIPluginTagInfo * taginfo;
-    const char * const * names = nsnull;
-    const char * const * values = nsnull;
-    PRUint16 count = 0;
-    nsresult result;
-
-    gdk_rgb_init();
-
-    fPeer = peer;
-    peer->AddRef();
-    result = peer->GetMode( &fMode );
-
-    if ( NS_FAILED( result ) )
-        return result;
-
-    result = peer->QueryInterface( NS_GET_IID(nsIPluginTagInfo),
-                                   ( void ** )&taginfo );
-
-    if ( NS_SUCCEEDED( result ) )
-    {
-        taginfo->GetAttributes( count, names, values );
-        NS_IF_RELEASE( taginfo );
-    }
-
-    // Initialize default line attribute info
-    mLineWidth = 5;
-    mLineStyle = GDK_LINE_ON_OFF_DASH;
-    mCapStyle = GDK_CAP_BUTT;
-    mJoinStyle = GDK_JOIN_MITER;
-
-    // Get user requested attribute info
-    for (int i=0; i < count; i++) {
-
-        if (PL_strcasecmp(names[i], "line_width") == 0) {
-            //////////////
-            // Line width
-            sscanf(values[i], "%i", &mLineWidth);
-
-        } else if (PL_strcasecmp(names[i], "line_style") == 0) {
-            //////////////
-            // Line style
-            if (PL_strcasecmp(values[i], "dash") == 0) 
-                mLineStyle = GDK_LINE_ON_OFF_DASH;
-            else if (PL_strcasecmp(values[i], "solid") == 0)
-                mLineStyle = GDK_LINE_SOLID;
-            else if (PL_strcasecmp(values[i], "double_dash") == 0)
-                mLineStyle = GDK_LINE_DOUBLE_DASH;
-
-        } else if (PL_strcasecmp(names[i], "cap_style") == 0) {
-            /////////////
-            // Cap style
-            if (PL_strcasecmp(values[i], "round") == 0) 
-                mCapStyle = GDK_CAP_ROUND;
-            else if (PL_strcasecmp(values[i], "projecting") == 0)
-                mCapStyle = GDK_CAP_PROJECTING;
-            else if (PL_strcasecmp(values[i], "butt") == 0)
-                mCapStyle = GDK_CAP_BUTT;
-            else if (PL_strcasecmp(values[i], "not_last") == 0)
-                mCapStyle = GDK_CAP_NOT_LAST;
-
-        } else if (PL_strcasecmp(names[i], "join_style") == 0) {
-            //////////////
-            // Join style
-            if (PL_strcasecmp(values[i], "miter") == 0) 
-                mJoinStyle = GDK_JOIN_MITER;
-            else if (PL_strcasecmp(values[i], "round") == 0)
-                mJoinStyle = GDK_JOIN_ROUND;
-            else if (PL_strcasecmp(values[i], "bevel") == 0)
-                mJoinStyle = GDK_JOIN_BEVEL;
-
-        } else if (PL_strcasecmp(names[i], "device") == 0) {
-            //////////
-            // Device
-            PR_FREEIF(mSaneDevice);
-            mSaneDevice = PL_strdup(values[i]);
-        } else if (PL_strcasecmp(names[i], "onScanComplete") == 0) {
-            //////////////////////////
-            // onScanComplete Callback
-            PR_FREEIF(mOnScanCompleteScript);
-            mOnScanCompleteScript = PL_strdup(values[i]);
-        } else if(PL_strcasecmp(names[i], "onInitComplete") == 0) {
-            //////////////////////////
-            // onInitComplete Callback
-            PR_FREEIF(mOnInitCompleteScript);
-            mOnInitCompleteScript = PL_strdup(values[i]);
-        }
-	}
-    
-    // the mImageFilename is used to store data directly 
-    // from the sane device and also rendering to the screen
-    sprintf( mImageFilename, "/tmp/nsSanePlugin.%p.jpg", (void *)this );
-
-    PlatformNew(); 	/* Call Platform-specific initializations */
-    return NS_OK;
-
-}
-
-NS_METHOD
-nsSanePluginInstance::SaveImage()
-{
-#ifdef DEBUG
-    printf("nsSanePluginInstance::SaveImage()\n");
-#endif
-    
-    if (!mImageFilename) {
-        NS_ERROR("Attempt to save image before initial scan!");
-        return NS_ERROR_FAILURE;
-    }
-
-    mFileSelection = gtk_file_selection_new("Choose file to save image to.");
-    
-    // Set a default filename
-    gtk_file_selection_set_filename(GTK_FILE_SELECTION(mFileSelection),
-                                    "saved.jpg");
-
-    // Callback for getting the filename
-    gtk_signal_connect(GTK_OBJECT(GTK_FILE_SELECTION(mFileSelection)->ok_button),
-                       "clicked", GTK_SIGNAL_FUNC (store_filename), 
-                       (gpointer) this);
-
-    // Ensure the file selection dialog goes away after
-    // 'OK' or 'CANCEL' button is selected
-    gtk_signal_connect_object(GTK_OBJECT(GTK_FILE_SELECTION(mFileSelection)->ok_button),
-                              "clicked", GTK_SIGNAL_FUNC (gtk_widget_destroy),
-                              GTK_OBJECT(mFileSelection));
-    gtk_signal_connect_object(GTK_OBJECT(GTK_FILE_SELECTION(mFileSelection)->cancel_button),
-                              "clicked", GTK_SIGNAL_FUNC (gtk_widget_destroy),
-                              GTK_OBJECT(mFileSelection));
-
-    // ok, now show the file selection dialog
-    gtk_widget_show(mFileSelection);
-    
-    return NS_OK;
-}
-
-NS_METHOD
-nsSanePluginInstance::DoScanCompleteCallback()
-{
-#ifdef DEBUG
-    printf("nsSanePluginInstance::DoScanCompleteCallback()\n");
-#endif
-
-    char *url;
-
-    if (mOnScanCompleteScript && mPluginManager) {
-        url = (char *)PR_Malloc(PL_strlen(mOnScanCompleteScript) + 13);
-        if (!url)
-            return NS_ERROR_OUT_OF_MEMORY;
-
-        sprintf(url, "javascript:%s", mOnScanCompleteScript);   
-        mPluginManager->GetURL((nsIPluginInstance *)this, url, "_self");
-
-        PR_FREEIF(url);
-    }
-    return NS_OK;
-}
-
-NS_METHOD
-nsSanePluginInstance::DoInitCompleteCallback()
-{
-#ifdef DEBUG
-    printf("nsSanePluginInstance::DoInitCompleteCallback()\n");
-#endif
-
-    char *url;
-
-    if (mOnInitCompleteScript && mPluginManager) {
-        url = (char *)PR_Malloc(PL_strlen(mOnInitCompleteScript) + 13);
-        if (!url)
-            return NS_ERROR_OUT_OF_MEMORY;
-
-        sprintf(url, "javascript:%s", mOnInitCompleteScript);   
-        mPluginManager->GetURL((nsIPluginInstance *)this, url, "_self");
-
-        PR_FREEIF(url);
-    }
-
-    return NS_OK;
-}
-
-NS_METHOD
-nsSanePluginInstance::GetPeer( nsIPluginInstancePeer* *result )
-{
-#ifdef DEBUG
-    printf("nsSanePluginInstance::GetPeer()\n");
-#endif
-
-    fPeer->AddRef();
-    *result = fPeer;
-    return NS_OK;
-}
-
-NS_METHOD
-nsSanePluginInstance::Start( void )
-{
-#ifdef DEBUG
-    printf("nsSanePluginInstance::Start()\n");
-#endif
-
-    PR_FREEIF(mRGBData);
-    mRGBData = nsnull;
-
-    sane_init(0,0);
-    mSaneOpen = SANE_FALSE;
-    nsresult rv = OpenSaneDeviceIF();
-    if (rv != NS_OK) {
-        NS_ERROR("Failed to open device in Start()\n");
-        return rv;
-    }
-
-    PlatformNew();
-
-    // call onInitComplete callback
-    DoInitCompleteCallback();
-    return NS_OK;
-}
-
-NS_METHOD
-nsSanePluginInstance::Stop( void )
-{
-#ifdef DEBUG
-    printf("nsSanePluginInstance::Stop()\n");
-#endif
-
-    // Wait for scanner operation to complete.
-    // TODO: Warn user that they are still scanning
-    //       and send abort command to scanner if 
-    //       the user wishes.
-    if (mScanThread)
-        PR_JoinThread(mScanThread);
-
-    PR_FREEIF(mRGBData);
-
-    // close sane
-    if (mSaneOpen) {
-        sane_close(mSaneHandle);
-        sane_exit();
-        mSaneOpen = SANE_FALSE;
-    }
-
-    if (remove ( mImageFilename ) == -1)
-        perror(mImageFilename);
-
-    return NS_OK;
-}
-
-NS_METHOD
-nsSanePluginInstance::Destroy( void )
-{
-#ifdef DEBUG
-    printf("nsSanePluginInstance::Destroy()\n");
-#endif
-
-    return NS_OK;
-}
-
-NS_METHOD
-nsSanePluginInstance::SetWindow(nsPluginWindow* window)
-{
-#ifdef DEBUG
-    printf("nsSanePluginInstance::SetWindow()\n");
-#endif
-
-    nsresult result;
-
-    // The real work is handled in PlatformSetWindow
-    // (as if this plug-in was multiplatform)
-    result = PlatformSetWindow( window );
-    fWindow = window;
-
-    return result;
-}
-
-NS_METHOD
-nsSanePluginInstance::NewStream( nsIPluginStreamListener** listener )
-{
-#ifdef DEBUG
-    printf("nsSanePluginInstance::NewStream()\n");
-#endif
-
-    if ( listener != NULL )
-        *listener = new nsSanePluginStreamListener( this );
-    
-    return NS_OK;
-}
-
-NS_METHOD
-nsSanePluginInstance::Print( nsPluginPrint* printInfo )
-{
-#ifdef DEBUG
-    printf("nsSanePluginInstance::Print()\n");
-#endif
-
-    if ( printInfo == NULL )
-        return NS_ERROR_FAILURE;
-
-    // needs to be implemented
-    return NS_ERROR_NOT_IMPLEMENTED;
-}
-
-NS_METHOD
-nsSanePluginInstance::HandleEvent(nsPluginEvent* event, PRBool* handled)
-{
-#ifdef DEBUG
-    printf("nsSanePluginInstance::HandleEvent()\n");
-#endif
-
-    // Not used on unix platform.  Only here for potential
-    // future porting efforts
-    *handled = (PRBool)PlatformHandleEvent(event);
-    return NS_OK;
-}
-
-NS_METHOD
-nsSanePluginInstance::GetValue(nsPluginInstanceVariable variable, void *value)
-{
-#ifdef DEBUG
-    printf("nsSanePluginInstance::GetValue()\n");
-#endif
-
-    //Needs to be implemented
-    return NS_ERROR_NOT_IMPLEMENTED;
-}
-
-void
-nsSanePluginInstance::PlatformNew( void )
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::PlatformNew\n");
-#endif
-
-    fPlatform.window = 0;
-}
-
-nsresult
-nsSanePluginInstance::PlatformDestroy( void )
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::PlatformDestroy()\n");
-#endif
-
-	return NS_OK;
-}
-
-nsresult
-nsSanePluginInstance::PlatformSetWindow( nsPluginWindow* window )
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::PlatformSetWindow()\n");
-#endif
-
-
-    if ( window == NULL || window->window == NULL )
-        return NS_ERROR_NULL_POINTER;
-    
-    if ( fPlatform.superwin == (GdkSuperWin *)window->window )
-        return NS_OK;
-
-    // Record windowing info
-    fPlatform.superwin = (GdkSuperWin *)window->window;
-    fPlatform.height = window->height;
-    fPlatform.width = window->width;
-
-    // cleanup old widgets
-    if (fPlatform.widget)
-        gtk_widget_destroy(fPlatform.widget);
-    if (mEvent_box)
-        gtk_widget_destroy(mEvent_box);
-    if (mDrawing_area)
-        gtk_widget_destroy(mDrawing_area);
-
-    fPlatform.widget = gtk_mozbox_new(fPlatform.superwin->bin_window);
-
-    // Initialize the zoom box to outline the entire image
-    mZoom_box.x = 0;
-    mZoom_box.y = 0;
-    mZoom_box.width = fPlatform.width;
-    mZoom_box.height = fPlatform.height;
-
-    // Setup an event box to contain the drawable
-    mEvent_box = gtk_event_box_new();
-    gtk_container_add(GTK_CONTAINER(fPlatform.widget), mEvent_box);
-    gtk_widget_show(mEvent_box);
-
-    // Setup the drawable
-    mDrawing_area = ( GtkWidget * )gtk_drawing_area_new();
-    gtk_drawing_area_size( GTK_DRAWING_AREA( mDrawing_area ),
-                           window->width, window->height);
-    gtk_container_add(GTK_CONTAINER(mEvent_box), mDrawing_area);
-    gtk_widget_show(mDrawing_area);
-
-    // Initialize line attributes for GC
-    GdkGC * da_gc = mDrawing_area->style->fg_gc[mDrawing_area->state];
-    gdk_gc_set_line_attributes ( da_gc, mLineWidth, mLineStyle, 
-                                 mCapStyle, mJoinStyle);
-
-    // Register signals
-    gtk_signal_connect (GTK_OBJECT(mDrawing_area), "expose_event",
-                        GTK_SIGNAL_FUNC(draw), this);
-
-    // Now make everything visable
-    gtk_widget_show( fPlatform.widget );
-
-    return NS_OK;
-}
-
-int16
-nsSanePluginInstance::PlatformHandleEvent(nsPluginEvent* event)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::PlatformHandleEvent()\n");
-#endif
-
-    /* UNIX Plugins do not use HandleEvent */
-    return 0;
-}
-
-
-NS_IMETHODIMP
-nsSanePluginInstance::PaintImage(void)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::PaintImage(%p)\n", this);
-#endif
-
-    if (mDrawing_area && fPlatform.widget) {
-        if (mImageFilename) {
-
-            if (!mRGBData) {
-
-                if (mState)
-                    // we are currently scanning, so the jpeg file
-                    // is not valid yet
-                    return NS_OK;
-                
-                FILE * f = fopen(mImageFilename, "rb");
-                if (!f) 
-                    // it's possible that an image hasn't been scanned yet
-                    return NS_OK;
-
-                mRGBData = jpeg_file_to_rgb(f, &mRGBWidth, &mRGBHeight);
-                if (!mRGBData) {
-                    NS_ERROR("Error converting jpeg to rgb data!");
-                    return NS_ERROR_FAILURE;
-                }
-
-                fclose(f);
-
-                // scale down to window size
-                unsigned char * tmp = scale_image( mRGBData, 
-                                                   mRGBWidth, mRGBHeight,
-                                                   fPlatform.width,
-                                                   fPlatform.height);
-                if (!tmp) {
-                    NS_ERROR("Error trying to scale image!");
-                    return NS_ERROR_FAILURE;
-                }
-
-                // move to new data
-                PR_FREEIF(mRGBData);
-                mRGBData = tmp;
-            }
-
-            // render the image
-            gdk_draw_rgb_image (mDrawing_area->window, 
-                                mDrawing_area->style->fg_gc[GTK_STATE_NORMAL],
-                                0, 0, fPlatform.width, fPlatform.height,
-                                GDK_RGB_DITHER_MAX, mRGBData, 
-                                fPlatform.width * 3);
-
-            gdk_draw_rectangle (mDrawing_area->window,
-                                mDrawing_area->style->fg_gc[mDrawing_area->state],
-                                FALSE, mZoom_box.x, mZoom_box.y, 
-                                mZoom_box.width, mZoom_box.height);        
-            
-            gdk_flush();
-        }
-    }
-
-    return NS_OK;
-}
-
-char *
-nsSanePluginInstance::GetImageFilename()
-{
-    if (!mImageFilename)
-        return (char *)NULL;
-    
-    // Caller is responsible for freeing string
-    return PL_strdup(mImageFilename);
-}
-
-GtkWidget *
-nsSanePluginInstance::GetFileSelection()
-{
-    if (!mFileSelection)
-        return (GtkWidget *)NULL;
-
-    return mFileSelection;
-}
-
-PRBool
-nsSanePluginInstance::IsUIThread()
-{
-    if (!mUIThread)
-        return PR_FALSE;
-
-    return (mUIThread == PR_GetCurrentThread());
-}
-
-// End of Plugin Instance API Methods.
-//////////////////////////////////////////////////////////////////////////////
-
-//////////////////////////////////////////////////////////////////////////////
-// Image Preview Interface.
-
-NS_IMETHODIMP
-nsSanePluginInstance::ZoomImage( PRUint16 x, PRUint16 y, 
-                                 PRUint16 width, PRUint16 height)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::ZoomImage()\n");
-#endif
-
-    int im_width, im_height, c_width, c_height, c_x, c_y;
-
-    if (!mRGBData)
-        return NS_ERROR_FAILURE;
-
-    // get the actual image width and height
-    im_width = mRGBWidth;
-    im_height = mRGBHeight;
-
-    if ( x >= (PRUint16)fPlatform.width ||
-         y >= (PRUint16)fPlatform.height )
-        return NS_ERROR_FAILURE;
-
-    if ( width + mZoom_box.x >= (PRUint16)fPlatform.width )
-        mZoom_box.width = fPlatform.width - mZoom_box.x;
-
-    if ( height + mZoom_box.y >= (PRUint16) fPlatform.height )
-        mZoom_box.height = fPlatform.height - mZoom_box.y;
-
-    mZoom_box.x = x;
-    mZoom_box.y = y;
-
-    // translate the zoom box geometry to the image geometry
-    c_width = (int)(((double)im_width/(double)fPlatform.width) * 
-                    (double)mZoom_box.width);
-    c_height =(int)(((double)im_height/(double)fPlatform.height) * 
-                    (double)mZoom_box.height);
-    c_x = (int)(((double)im_width/(double)fPlatform.width) * 
-                (double)mZoom_box.x);
-    c_y = (int)(((double)im_height/(double)fPlatform.height) * 
-                (double)mZoom_box.y);
-
-    unsigned char * tmp = crop_image(mRGBData, &mRGBWidth, &mRGBHeight,
-                                     c_x, c_y, c_width, c_height);
-    if (!tmp)
-        return NS_ERROR_FAILURE;
-    PR_FREEIF(mRGBData);
-    mRGBData = tmp;
-
-    mRGBWidth = c_width;
-    mRGBHeight = c_height;
-
-    mTopLeftXChange = (float)x/(float)fPlatform.width;
-    mTopLeftYChange = (float)y/(float)fPlatform.height;
-    mBottomRightXChange = (float)(fPlatform.width - (PRInt32)(x + mZoom_box.width))/(float)fPlatform.width;
-    mBottomRightYChange = (float)(fPlatform.height - (PRInt32)(y + mZoom_box.height))/(float)fPlatform.height;
-
-    mZoom_box.x = 0;
-    mZoom_box.y = 0;
-    mZoom_box.width = (PRUint16)fPlatform.width;
-    mZoom_box.height = (PRUint16)fPlatform.height;
-
-    return PaintImage();
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::ZoomImageWithAttributes( PRUint16 x, PRUint16 y, 
-                                               PRUint16 width, PRUint16 height,
-                                               PRInt32 req_line_width,
-                                               const char * req_line_style,
-                                               const char * req_cap_style,
-                                               const char * req_join_style )
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::ZoomImageWithAttributes()\n");
-#endif
-
-    if (!mRGBData)
-        return NS_ERROR_FAILURE;
-
-    ZoomImage(x, y, width, height);
-
-    /*
-     * Set zoom box line attributes
-     */
-
-    // Line Width
-    mLineWidth = req_line_width;
-
-    // Line Style
-    if (PL_strcasecmp(req_line_style, "dash") == 0) 
-        mLineStyle = GDK_LINE_ON_OFF_DASH;
-    else if (PL_strcasecmp(req_line_style, "solid") == 0)
-        mLineStyle = GDK_LINE_SOLID;
-    else if (PL_strcasecmp(req_line_style, "double_dash") == 0)
-        mLineStyle = GDK_LINE_DOUBLE_DASH;
-
-    // Cap Style
-    if (PL_strcasecmp(req_cap_style, "round") == 0) 
-        mCapStyle = GDK_CAP_ROUND;
-    else if (PL_strcasecmp(req_cap_style, "projecting") == 0)
-        mCapStyle = GDK_CAP_PROJECTING;
-    else if (PL_strcasecmp(req_cap_style, "butt") == 0)
-        mCapStyle = GDK_CAP_BUTT;
-    else if (PL_strcasecmp(req_cap_style, "not_last") == 0)
-        mCapStyle = GDK_CAP_NOT_LAST;
-
-    // Join Style
-    if (PL_strcasecmp(req_join_style, "miter") == 0) 
-        mJoinStyle = GDK_JOIN_MITER;
-    else if (PL_strcasecmp(req_join_style, "round") == 0)
-        mJoinStyle = GDK_JOIN_ROUND;
-    else if (PL_strcasecmp(req_join_style, "bevel") == 0)
-        mJoinStyle = GDK_JOIN_BEVEL;
-
-    // Refresh
-    return PaintImage();
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::Crop(PRUint16 x, PRUint16 y, 
-                           PRUint16 width, PRUint16 height)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::Crop()\n");
-#endif
-
-    if ( (x <= (PRUint16)fPlatform.width - width ) &&
-         (y <= (PRUint16)fPlatform.height - height) ) {
-        
-        mZoom_box.x = x; mZoom_box.y = y;
-        mZoom_box.width = width;
-        mZoom_box.height = height;
-
-    } else {
-        return NS_ERROR_FAILURE;
-    }
-
-    return PaintImage();
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::Restore(void)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::Restore()\n");
-#endif
-
-    PR_FREEIF(mRGBData);
-    mRGBData = nsnull;
-
-    // Reset zoom box
-    mZoom_box.x = mZoom_box.y = 0;
-    mZoom_box.width = (PRUint16) fPlatform.width;
-    mZoom_box.height = (PRUint16) fPlatform.height;
-
-    PaintImage();
-
-    return NS_OK;
-}
-
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetZoomX(PRUint16 * x) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetZoomX()\n");
-#endif
-
-    NS_ASSERTION(x != NULL, "null x pointer");
-    if (!x)
-        return NS_ERROR_NULL_POINTER;
-
-    *x = mZoom_box.x;
-    
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetZoomX(PRUint16 x) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetZoomX()\n");
-#endif
-
-    if (x > (PRInt32) fPlatform.width)
-        mZoom_box.x = (PRInt32) fPlatform.width;
-    else
-        mZoom_box.x = x;
-
-    return PaintImage();
-}
-
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetZoomY(PRUint16 * y) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetZoomY()\n");
-#endif
-
-    NS_ASSERTION(y != NULL, "null y pointer");
-    if (!y)
-        return NS_ERROR_NULL_POINTER;
-
-    *y = mZoom_box.y;
-    
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetZoomY(PRUint16 y) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetZoomY()\n");
-#endif
-
-    if (y > (PRInt32) fPlatform.height)
-        mZoom_box.y = (PRInt32)fPlatform.height;
-    else
-        mZoom_box.y = y;
-    
-    return PaintImage();
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetZoomWidth(PRUint16 * width) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetZoomWidth()\n");
-#endif
-
-    NS_ASSERTION(width != NULL, "null width pointer");
-    if (!width)
-        return NS_ERROR_NULL_POINTER;
-
-    *width = mZoom_box.width;
-    
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetZoomWidth(PRUint16 width) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetZoomWidth()\n");
-#endif
-
-    if (width + mZoom_box.x > (PRUint16)fPlatform.width)
-        mZoom_box.width = (PRInt32) fPlatform.width - mZoom_box.x;
-    else
-        mZoom_box.width = width;
-
-    return PaintImage();
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetZoomHeight(PRUint16 * height) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetZoomHeight()\n");
-#endif
-
-    NS_ASSERTION(height != NULL, "null height pointer");
-    if (!height)
-        return NS_ERROR_NULL_POINTER;
-
-    *height = mZoom_box.height;
-    
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetZoomHeight(PRUint16 height) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetZoomHeight()\n");
-#endif
-
-    if (height + mZoom_box.y > (PRUint16) fPlatform.height)
-        mZoom_box.height = fPlatform.height - mZoom_box.y;
-    else
-        mZoom_box.height = height;
-
-    return PaintImage();
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetZoomLineWidth(PRInt32 * aZoomLineWidth) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetZoomLineWidth()\n");
-#endif
-
-    NS_ASSERTION(aZoomLineWidth != NULL, "null width pointer");   
-    if (!aZoomLineWidth)
-        return NS_ERROR_NULL_POINTER;
-
-    *aZoomLineWidth = mLineWidth;
-
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetZoomLineWidth(PRInt32 aZoomLineWidth) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetZoomLineWidth()\n");
-#endif
-
-    if (aZoomLineWidth <= 0)
-        return NS_ERROR_INVALID_ARG;
-
-    mLineWidth = aZoomLineWidth;
-
-    return PaintImage();
-}
-
-#define MAX_LINE_ATTRIBUTE_LENGTH 20
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetZoomLineStyle(char ** aZoomLineStyle) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetZoomLineStyle()\n");
-#endif
-
-    NS_ASSERTION(*aZoomLineStyle != NULL, "null width pointer");   
-    if (!*aZoomLineStyle)
-        return NS_ERROR_NULL_POINTER;
-
-    *aZoomLineStyle = (char*) nsMemory::Alloc(MAX_LINE_ATTRIBUTE_LENGTH);
-    if (! *aZoomLineStyle)
-        return NS_ERROR_OUT_OF_MEMORY;
-    
-    if (mLineStyle == GDK_LINE_ON_OFF_DASH)
-        PL_strcpy(*aZoomLineStyle, "dash");
-    else if (mLineStyle == GDK_LINE_SOLID)
-        PL_strcpy(*aZoomLineStyle, "solid");
-    else if (mLineStyle == GDK_LINE_DOUBLE_DASH)
-        PL_strcpy(*aZoomLineStyle, "double_dash");
-    else
-        PL_strcpy(*aZoomLineStyle, "unknown");
-
-    return PaintImage();
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetZoomLineStyle(const char * aZoomLineStyle) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetZoomLineStyle()\n");
-#endif
-
-    NS_ASSERTION(aZoomLineStyle != NULL, "null width pointer");   
-    if (!aZoomLineStyle)
-        return NS_ERROR_NULL_POINTER;
-
-    // Line Style
-    if (PL_strcasecmp(aZoomLineStyle, "dash") == 0) 
-        mLineStyle = GDK_LINE_ON_OFF_DASH;
-    else if (PL_strcasecmp(aZoomLineStyle, "solid") == 0)
-        mLineStyle = GDK_LINE_SOLID;
-    else if (PL_strcasecmp(aZoomLineStyle, "double_dash") == 0)
-        mLineStyle = GDK_LINE_DOUBLE_DASH;
-
-    return PaintImage();
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetZoomCapStyle(char ** aZoomCapStyle) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetZoomCapStyle()\n");
-#endif
-
-    NS_ASSERTION(*aZoomCapStyle != NULL, "null width pointer");   
-    if (!*aZoomCapStyle)
-        return NS_ERROR_NULL_POINTER;
-
-    *aZoomCapStyle = (char*) nsMemory::Alloc(MAX_LINE_ATTRIBUTE_LENGTH);
-    if (! *aZoomCapStyle)
-        return NS_ERROR_OUT_OF_MEMORY;
-    
-    if (mCapStyle == GDK_CAP_ROUND)
-        PL_strcpy(*aZoomCapStyle, "round");
-    else if (mCapStyle == GDK_CAP_PROJECTING)
-        PL_strcpy(*aZoomCapStyle, "projecting");
-    else if (mCapStyle == GDK_CAP_BUTT)
-        PL_strcpy(*aZoomCapStyle, "butt");
-    else if (mCapStyle == GDK_CAP_NOT_LAST)
-        PL_strcpy(*aZoomCapStyle, "not_last");
-    else
-        PL_strcpy(*aZoomCapStyle, "unknown");
-
-
-    return PaintImage();
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetZoomCapStyle(const char * aZoomCapStyle) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetZoomCapStyle()\n");
-#endif
-
-    NS_ASSERTION(aZoomCapStyle != NULL, "null width pointer");   
-    if (!aZoomCapStyle)
-        return NS_ERROR_NULL_POINTER;
-
-    // Cap Style
-    if (PL_strcasecmp(aZoomCapStyle, "round") == 0) 
-        mCapStyle = GDK_CAP_ROUND;
-    else if (PL_strcasecmp(aZoomCapStyle, "projecting") == 0)
-        mCapStyle = GDK_CAP_PROJECTING;
-    else if (PL_strcasecmp(aZoomCapStyle, "butt") == 0)
-        mCapStyle = GDK_CAP_BUTT;
-    else if (PL_strcasecmp(aZoomCapStyle, "not_last") == 0)
-        mCapStyle = GDK_CAP_NOT_LAST;
-
-    return PaintImage();
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetZoomJoinStyle(char ** aZoomJoinStyle) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetZoomJoinStyle()\n");
-#endif
-
-    NS_ASSERTION(*aZoomJoinStyle != NULL, "null width pointer");   
-    if (!*aZoomJoinStyle)
-        return NS_ERROR_NULL_POINTER;
-
-    *aZoomJoinStyle = (char*) nsMemory::Alloc(MAX_LINE_ATTRIBUTE_LENGTH);
-    if (! *aZoomJoinStyle)
-        return NS_ERROR_OUT_OF_MEMORY;
-    
-    if (mJoinStyle == GDK_JOIN_MITER)
-        PL_strcpy(*aZoomJoinStyle, "miter");
-    else if (mJoinStyle == GDK_JOIN_ROUND)
-        PL_strcpy(*aZoomJoinStyle, "round");
-    else if (mJoinStyle == GDK_JOIN_BEVEL)
-        PL_strcpy(*aZoomJoinStyle, "bevel");
-    else
-        PL_strcpy(*aZoomJoinStyle, "unknown");
-
-    return PaintImage();
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetZoomJoinStyle(const char * aZoomJoinStyle) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetZoomJoinStyle()\n");
-#endif
-
-    NS_ASSERTION(aZoomJoinStyle != NULL, "null width pointer");   
-    if (!aZoomJoinStyle)
-        return NS_ERROR_NULL_POINTER;
-
-    // Join Style
-    if (PL_strcasecmp(aZoomJoinStyle, "miter") == 0) 
-        mJoinStyle = GDK_JOIN_MITER;
-    else if (PL_strcasecmp(aZoomJoinStyle, "round") == 0)
-        mJoinStyle = GDK_JOIN_ROUND;
-    else if (PL_strcasecmp(aZoomJoinStyle, "bevel") == 0)
-        mJoinStyle = GDK_JOIN_BEVEL;
-
-    return PaintImage();
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetZoomBR_XChange(float * aZoomBR_XChange) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetZoomBR_XChange()\n");
-#endif
-
-    *aZoomBR_XChange = mBottomRightXChange;
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetZoomBR_XChange(float aZoomBR_XChange) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetZoomBR_XChange()\n");
-#endif
-
-    // Read-Only
-    return NS_ERROR_NOT_AVAILABLE;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetZoomBR_YChange(float * aZoomBR_YChange) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetZoomBR_YChange()\n");
-#endif
-
-    *aZoomBR_YChange = mBottomRightYChange;
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetZoomBR_YChange(float aZoomBR_YChange) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetZoomBR_YChange()\n");
-#endif
-
-    // Read-Only
-    return NS_ERROR_NOT_AVAILABLE;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetZoomTL_XChange(float * aZoomTL_XChange) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetZoomTL_XChange()\n");
-#endif
-
-    *aZoomTL_XChange = mTopLeftXChange;
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetZoomTL_XChange(float aZoomTL_XChange) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetZoomTL_XChange()\n");
-#endif
-
-    // Read-Only
-    return NS_ERROR_NOT_AVAILABLE;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetZoomTL_YChange(float * aZoomTL_YChange) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetZoomTL_YChange()\n");
-#endif
-
-    *aZoomTL_YChange = mTopLeftYChange;
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetZoomTL_YChange(float aZoomTL_YChange) 
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetZoomTL_YChange()\n");
-#endif
-
-    // Read-Only
-    return NS_ERROR_NOT_AVAILABLE;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetQuality(PRInt32 * aQuality)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetQuality()\n");
-#endif
-
-    NS_ASSERTION(aQuality != NULL, "null compression quality pointer");   
-    if (!aQuality)
-        return NS_ERROR_NULL_POINTER;    
-    
-    *aQuality = mCompQuality;
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetQuality(PRInt32 aQuality)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetQuality()\n");
-#endif
-
-    NS_ASSERTION(aQuality > -1 && aQuality < 101, 
-                 "Invalid compression quality");
-    if (aQuality < 0 || aQuality > 100)
-        return NS_ERROR_INVALID_ARG;
-
-    mCompQuality = aQuality;
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetMethod(char ** aMethod)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetMethod()\n");
-#endif
-
-    NS_ASSERTION(aMethod != NULL, "Null method pointer");
-    if (!aMethod)
-        return NS_ERROR_NULL_POINTER;
-
-    *aMethod = (char*) nsMemory::Alloc(8);
-    if (!*aMethod)
-        return NS_ERROR_OUT_OF_MEMORY;
-
-    switch (mCompMethod) {
-    case JDCT_ISLOW:
-        PL_strcpy(*aMethod, "SLOW");
-        break;
-    case JDCT_IFAST:
-        PL_strcpy(*aMethod, "FAST");
-        break;
-    case JDCT_FLOAT:
-        PL_strcpy(*aMethod, "FLOAT");
-        break;
-    default:
-        PL_strcpy(*aMethod, "DEFAULT");
-        
-    }
-
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetMethod(const char * aMethod)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetMethod()\n");
-#endif
-
-    NS_ASSERTION(aMethod != NULL, "Null method pointer");
-    if (!aMethod)
-        return NS_ERROR_NULL_POINTER;
-
-    if (PL_strcasecmp(aMethod, "SLOW") == 0)
-        mCompMethod = JDCT_ISLOW;
-    else if (PL_strcasecmp(aMethod, "FAST") == 0)
-        mCompMethod = JDCT_IFAST;
-    else if (PL_strcasecmp(aMethod, "FLOAT") == 0)
-        mCompMethod = JDCT_FLOAT;
-    else
-        mCompMethod = JDCT_DEFAULT;
-
-    return NS_OK;
-}
-
-// END of Image Preview Interface
-///////////////////////////////////////////////////////////////////////////
-
-///////////////////////////////////////////////////////////////////////////
-// Generic SANE Interface
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetDeviceOptions(char ** aDeviceOptions)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetDeviceOptions()\n");
-#endif
-
-    const SANE_Option_Descriptor * optdesc;
-    SANE_Int string_size;
-    char *range_string, *word_string;
-    nsresult rv;
-
-    NS_ASSERTION(aDeviceOptions != NULL, "null options pointer");   
-    if (!aDeviceOptions)
-        return NS_ERROR_NULL_POINTER;
-
-    *aDeviceOptions = nsnull;
-
-    rv = OpenSaneDeviceIF();
-    if (rv != NS_OK)
-        return rv;
-
-    // Find out how many options exist for device
-    optdesc = sane_get_option_descriptor(mSaneHandle, 0);
-    if (!optdesc || optdesc->size == 0) {
-        NS_ERROR("Error trying to get number of options for device!");
-        return NS_ERROR_FAILURE;
-    }
-
-    if (optdesc->size == 1) { /* size includes "size" option */
-        NS_ERROR("Hmm.. That's odd! No options for this device?");
-        return NS_OK; // I guess it's possible?
-    }
-
-    // allocate string to contain data to return to caller
-    string_size = ((optdesc->size - 1) * MAX_OPT_SIZE) + 1;
-    *aDeviceOptions = (char*) nsMemory::Alloc(string_size);
-    NS_ENSURE_TRUE(*aDeviceOptions, NS_ERROR_OUT_OF_MEMORY);
-
-    // initialize options string
-    for (int n=0; n<string_size; n++)
-        (*aDeviceOptions)[n] = '\0';
-
-    // step through each of the options and copy over relavent data
-    int i = 1;
-    while((optdesc = sane_get_option_descriptor(mSaneHandle, i)) != NULL) {
-        i++;
-
-        // don't return grouping options
-        if (optdesc->type == SANE_TYPE_GROUP) 
-            continue;
-        
-        /* 
-         * WARNING! Need to replace ','s and ';'s with
-         *          something else so that JavaScript parsing
-         *          doesn't get hosed!
-         */
-
-        // NAME
-        if (optdesc->name) 
-            optioncat(aDeviceOptions, optdesc->name, ", ");
-        else 
-            strcat(*aDeviceOptions, "N/A, ");
-
-        ////////////////////////////////////
-        // TITLE
-        if (optdesc->title)
-            optioncat(aDeviceOptions, optdesc->title, ", ");
-        else 
-            PL_strcat(*aDeviceOptions, "N/A, ");
-
-        ////////////////////////////////////
-        // DESCRIPTION
-        if (optdesc->desc) 
-            optioncat(aDeviceOptions, optdesc->desc, ", ");
-        else
-            PL_strcat(*aDeviceOptions, "N/A, ");
-
-        ////////////////////////////////////
-        // Option Type
-        switch (optdesc->type) {
-
-        case SANE_TYPE_BOOL:
-            PL_strcat(*aDeviceOptions, "BOOL, ");
-            break;
-
-        case SANE_TYPE_INT:
-            PL_strcat(*aDeviceOptions, "INT, ");
-            break;
-
-        case SANE_TYPE_FIXED:
-            PL_strcat(*aDeviceOptions, "FIXED, ");
-            break;
-
-        case SANE_TYPE_STRING:
-            PL_strcat(*aDeviceOptions, "STRING, ");
-            break;
-
-        case SANE_TYPE_BUTTON:
-            PL_strcat(*aDeviceOptions, "BUTTON, ");
-            break;
-
-        case SANE_TYPE_GROUP:
-            PL_strcat(*aDeviceOptions, "GROUP, ");
-            break;
-
-        default:
-            PL_strcat(*aDeviceOptions, "UNKNOWN, ");
-        }
-
-        ////////////////////////////////////////
-        // UNIT
-        switch (optdesc->unit) {
-        case SANE_UNIT_NONE:
-            PL_strcat(*aDeviceOptions, "NONE, ");
-            break;
-
-        case SANE_UNIT_PIXEL:
-            PL_strcat(*aDeviceOptions, "PIXEL, ");
-            break;
-
-        case SANE_UNIT_BIT:
-            PL_strcat(*aDeviceOptions, "BIT, ");
-            break;
-
-        case SANE_UNIT_MM:
-            PL_strcat(*aDeviceOptions, "MM, ");
-            break;
-
-        case SANE_UNIT_DPI:
-            PL_strcat(*aDeviceOptions, "PERCENT, ");
-            break;
-
-        case SANE_UNIT_MICROSECOND:
-            PL_strcat(*aDeviceOptions, "MICROSECOND, ");
-            break;
-
-        default:
-            PL_strcat(*aDeviceOptions, "UNKNOWN, ");
-        }
-
-        ////////////////////////////////////////
-        // SIZE
-        char * size_option = (char *)PR_MALLOC(64);
-        if (!size_option)
-            return NS_ERROR_OUT_OF_MEMORY;
-        sprintf(size_option, "%i, ", optdesc->size);
-        PL_strcat(*aDeviceOptions, size_option);
-        PR_FREEIF(size_option);
-
-        ////////////////////////////////////////
-        // ACTIVE?
-        if (SANE_OPTION_IS_ACTIVE(optdesc->cap))
-            PL_strcat(*aDeviceOptions, "ACTIVE, ");
-        else 
-            PL_strcat(*aDeviceOptions, "UNACTIVE, ");
-
-        ////////////////////////////////////////
-        // SW SETTABLE?
-        if (SANE_OPTION_IS_SETTABLE(optdesc->cap))
-            PL_strcat(*aDeviceOptions, "SETTABLE, ");
-        else 
-            PL_strcat(*aDeviceOptions, "UNSETTABLE, ");
-
-        ////////////////////////////////////////
-        // Contraints Union
-        switch (optdesc->constraint_type) {
-        case SANE_CONSTRAINT_RANGE:
-            range_string = (char *)PR_MALLOC(128);
-            if (!range_string)
-                return NS_ERROR_OUT_OF_MEMORY;
-            sprintf(range_string, "RANGE, %i, %i, %i; ",
-                    optdesc->constraint.range->min,
-                    optdesc->constraint.range->max,
-                    optdesc->constraint.range->quant);
-            PL_strcat(*aDeviceOptions, range_string);
-            PR_FREEIF(range_string);
-            break;
-
-        case SANE_CONSTRAINT_WORD_LIST:
-            word_string = (char *) PR_MALLOC(64);
-            if (!word_string)
-                return NS_ERROR_OUT_OF_MEMORY;
-            
-            PL_strcat(*aDeviceOptions, "WORD_LIST");
-            for (int word_index=1; 
-                 word_index <= optdesc->constraint.word_list[0]; 
-                 word_index++) {
-                sprintf(word_string, ", %i", optdesc->constraint.word_list[i]);
-                PL_strcat(*aDeviceOptions, word_string);
-            }
-            PL_strcat(*aDeviceOptions, ";");
-            PR_FREEIF(word_string);
-            break;
-
-        case SANE_CONSTRAINT_STRING_LIST:
-            PL_strcat(*aDeviceOptions, "STRING_LIST");
-            for (int string_index=0; 
-                 optdesc->constraint.string_list[string_index];
-                 string_index++) {
-                PL_strcat(*aDeviceOptions, ", ");
-                PL_strcat(*aDeviceOptions, 
-                          optdesc->constraint.string_list[string_index]);
-            }
-            PL_strcat(*aDeviceOptions, ";");
-            break;
-
-        default:
-            // no constraints
-            PL_strcat(*aDeviceOptions, "NONE;");
-        }        
-    }
-    
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetDeviceOptions(const char * aDeviceOptions)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetDeviceOptions()\n");
-#endif
-
-    NS_ERROR("DeviceOptions is read-only!\n");
-    return NS_ERROR_NOT_AVAILABLE;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetActiveDevice(char ** aActiveDevice)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetActiveDevice()\n");
-#endif
-
-    NS_ASSERTION(aActiveDevice != NULL, "null device pointer");   
-    if (!aActiveDevice)
-        return NS_ERROR_NULL_POINTER;
-
-    *aActiveDevice = nsnull;
-    if (!mSaneDevice)
-        return NS_OK;
-    
-    *aActiveDevice = (char*) nsMemory::Alloc(PL_strlen(mSaneDevice) + 1);
-    NS_ENSURE_TRUE(*aActiveDevice, NS_ERROR_OUT_OF_MEMORY);
-    PL_strcpy(*aActiveDevice, mSaneDevice);
-    
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetActiveDevice(const char * aActiveDevice)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetActiveDevice()\n");
-#endif
-
-    NS_ASSERTION(aActiveDevice, "null active device pointer");
-    if (!aActiveDevice)
-        return NS_ERROR_NULL_POINTER;
-
-    PR_FREEIF (mSaneDevice);
-    mSaneDevice = PL_strdup(aActiveDevice);
-
-    if (mSaneOpen) {
-        sane_close(mSaneHandle);
-        sane_exit();
-        sane_init(0,0);
-        if (sane_open(mSaneDevice, &mSaneHandle) != SANE_STATUS_GOOD) {
-            mSaneOpen = SANE_FALSE;
-            NS_ERROR("Error trying to reopen sane device!\n");
-            return NS_ERROR_FAILURE;
-        }
-            
-    } else {
-        if (sane_open(mSaneDevice, &mSaneHandle) != SANE_STATUS_GOOD) {
-            NS_ERROR("Error trying to open closed sane device!\n");
-            return NS_ERROR_FAILURE;
-        }
-        mSaneOpen = SANE_TRUE;
-    }
-
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::OpenSaneDeviceIF( void )
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::OpenSaneDeviceIF()\n");
-#endif
-
-    if (mSaneOpen) {
-        return NS_OK;
-    }
-
-    if (!mSaneDevice) {
-        NS_ERROR("Device name not set!");
-        return NS_ERROR_FAILURE;
-    }
-
-    SANE_Status status = sane_open(mSaneDevice, &mSaneHandle);
-    if (status != SANE_STATUS_GOOD) {
-        NS_ERROR ("sane_open returned error code");
-        return NS_ERROR_FAILURE;
-    }
-
-    mSaneOpen = SANE_TRUE;
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetImageParameters(char ** aImageParameters)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetImageParameters()\n");
-#endif
-
-    SANE_Status status;
-    SANE_Parameters params;
-    nsresult rv;
-    
-    NS_ASSERTION(aImageParameters != NULL, "null parameters pointer");   
-    if (!aImageParameters)
-        return NS_ERROR_NULL_POINTER;
-
-    *aImageParameters = nsnull;
-
-    rv = OpenSaneDeviceIF();;
-    if (rv != NS_OK)
-        return rv;
-    
-    status = sane_get_parameters(mSaneHandle, &params);
-    if (status != SANE_STATUS_GOOD) {
-        sane_close(mSaneHandle);
-        NS_ERROR("Failed to get parameters for sane device!");
-        return NS_ERROR_FAILURE;
-    }
-
-#define MAX_PARAM_LEN 256
-    *aImageParameters = (char *) nsMemory::Alloc(MAX_PARAM_LEN);
-    if (!*aImageParameters)
-        return NS_ERROR_OUT_OF_MEMORY;
-
-    char * format_string;
-    switch (params.format) {
-
-    case SANE_FRAME_GRAY:
-        format_string = PL_strdup("GRAY");
-        break;
-
-    case SANE_FRAME_RGB:
-        format_string = PL_strdup("RGB");
-        break;
-
-    case SANE_FRAME_RED:
-        format_string = PL_strdup("RED");
-        break;
-
-    case SANE_FRAME_GREEN:
-        format_string = PL_strdup("GREEN");
-        break;
-
-    case SANE_FRAME_BLUE:
-        format_string = PL_strdup("BLUE");
-        break;
-
-    default:
-        format_string = PL_strdup("UNKNOWN");
-    }
-
-    sprintf(*aImageParameters, "%s, %s, %i, %i, %i, %i",
-            format_string,
-            params.last_frame ? "TRUE" : "FALSE",
-            params.lines,
-            params.depth,
-            params.pixels_per_line,
-            params.bytes_per_line);
-
-
-    // cleanup
-    PR_FREEIF(format_string);
-
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetImageParameters(const char * aImageParameters)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetImageParameters()\n");
-#endif
-
-    NS_ERROR("ImageParameters is read-only!\n");
-    return NS_ERROR_NOT_AVAILABLE;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetAvailableDevices(char ** aAvailableDevices)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetAvailableDevices()\n");
-#endif
-
-    SANE_Status status;
-    const SANE_Device ** device_list;
-    int num, i;
-
-    NS_ASSERTION(aAvailableDevices != NULL, "null parameters pointer");   
-    if (!aAvailableDevices)
-        return NS_ERROR_NULL_POINTER;
-
-    *aAvailableDevices = nsnull;
-
-    status = sane_get_devices(&device_list, SANE_TRUE);
-    if (status != SANE_STATUS_GOOD)
-        return NS_ERROR_FAILURE;
-
-    // find out how many devices are available
-    for ( num=0; device_list[num]; num++);
-
-    // allocate return string
-#define MAX_DEVICE_SIZE 256
-    *aAvailableDevices = (char*) nsMemory::Alloc(num * MAX_DEVICE_SIZE);
-    if (!*aAvailableDevices)
-        return NS_ERROR_OUT_OF_MEMORY;
-
-    for ( i=0; i < num * MAX_DEVICE_SIZE; i++)
-        (*aAvailableDevices)[i] = '\0';
-
-    for ( i=0; i<num; i++) {
-        optioncat(aAvailableDevices, device_list[i]->name,   ", ");
-        optioncat(aAvailableDevices, device_list[i]->vendor, ", ");
-        optioncat(aAvailableDevices, device_list[i]->model,  ", ");
-        optioncat(aAvailableDevices, device_list[i]->type,   "; ");
-    }
-
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetAvailableDevices(const char * aAvailableDevices)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetAvailableDevices()\n");
-#endif
-
-    NS_ERROR("AvailableDevices is read-only!\n");
-    return NS_ERROR_NOT_AVAILABLE;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::ScanImage(void)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::ScanImage()\n");
-#endif
-
-    mState = 1;
-    mSuccess = 0;
-
-    mScanThread = PR_CreateThread( PR_USER_THREAD, scanimage_thread_routine, 
-                                  (void*)this, PR_PRIORITY_HIGH, 
-                                  PR_GLOBAL_THREAD, PR_JOINABLE_THREAD, 0);
-
-    if (mScanThread == NULL) {
-        NS_ERROR("Could not create thread!");
-        return NS_ERROR_FAILURE;
-    }
-
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetOption(const char * name, const char * value)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetOption()\n");
-#endif
-
-    nsresult rv;
-    SANE_Int optnum;
-    const SANE_Option_Descriptor * optdesc;
-    void * option_value;
-    SANE_Status status;
-
-    NS_ASSERTION(name != NULL && value != NULL, "null pointer");
-    if (!name || !value)
-        return NS_ERROR_NULL_POINTER;
-
-    rv = OpenSaneDeviceIF();
-    if (rv != NS_OK) 
-        return rv;
-
-    // find the option number
-    for ( optnum=1; 
-          ((optdesc = sane_get_option_descriptor(mSaneHandle, optnum)) != NULL)
-              && (PL_strcasecmp(name, optdesc->name) != 0);
-          optnum++ );
-    if (!optdesc) {
-        NS_ERROR("Option not found for sane device!");
-        return NS_ERROR_INVALID_ARG;
-    }
-
-    // determine the value to pass to device
-    if (optdesc->type == SANE_TYPE_BOOL) {
-        SANE_Bool sbool;
-        if (PL_strcasecmp(value, "TRUE") == 0) {
-            sbool = SANE_TRUE;
-        } else 
-            sbool = SANE_FALSE;
-
-        option_value = (void *) &sbool;
-
-    } else if ( optdesc->type == SANE_TYPE_INT ||
-                optdesc->type == SANE_TYPE_FIXED ) {
-        SANE_Int sint;
-        sscanf(value, "%i", &sint);
-
-        option_value = (void *) &sint;
-
-    } else if (optdesc->type == SANE_TYPE_STRING) {
-        option_value = (void *) value;
-    } else {
-        option_value = NULL;
-    }
-
-    // set the option
-    status = sane_control_option( mSaneHandle, optnum, 
-                                  SANE_ACTION_SET_VALUE, option_value,
-                                  NULL);
-    if (status != SANE_STATUS_GOOD) {
-        NS_ERROR("Error trying to set option!");
-        return NS_ERROR_FAILURE;
-    }
-
-    return NS_OK;
-}
-
-int
-nsSanePluginInstance::WritePNMHeader (int fd, SANE_Frame format, 
-                                  int width, int height, int depth)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::WritePNMHeader()\n");
-#endif
-
-    char b[32];
-
-    switch (format) {
-    case SANE_FRAME_RED:
-    case SANE_FRAME_GREEN:
-    case SANE_FRAME_BLUE:
-    case SANE_FRAME_RGB:
-        sprintf (b, "P6\n%d %d\n255\n", width, height);
-        break;
-
-    default:
-        if (depth == 1)
-            sprintf (b, "P4\n%d %d\n", width, height);
-        else
-            sprintf (b, "P5\n%d %d\n255\n", width, height);
-        break;
-    }
-
-    return write(fd, b, PL_strlen(b));
-}
-
-// END of Generic SANE Interface
-//////////////////////////////////////////////////////////////////////////////
-
-///////////////////////////////////////////////////////////////////////////////
-// Scanner Status Interface
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetSuccess(PRBool * aSuccess)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetSuccess()\n");
-#endif
-
-    NS_PRECONDITION(aSuccess != nsnull, "null ptr");
-    if (! aSuccess) {
-        NS_ERROR("Null pointer passed to GetSuccess!\n");
-        return NS_ERROR_NULL_POINTER;
-    }
-
-    *aSuccess = mSuccess;
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetSuccess(PRBool aSuccess)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetSuccess()\n");
-#endif
-
-    // This is a read-only flag.
-    NS_ERROR("Success is a read-only flag!\n");
-    return NS_ERROR_FAILURE;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::GetState(char ** aState)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::GetState()\n");
-#endif
-
-    NS_PRECONDITION(aState != nsnull, "null ptr");
-    if (! aState) {
-        NS_ERROR("Null pointer passed to GetSuccess!\n");
-        return NS_ERROR_NULL_POINTER;
-    }
-
-    *aState = (char*) nsMemory::Alloc(5);
-    if (!*aState) {
-        NS_ERROR("Unable to allocate State string!\n");
-        return NS_ERROR_OUT_OF_MEMORY;
-    }
-
-    if (mState == 0)
-        PL_strcpy(*aState, "IDLE");
-    else
-        PL_strcpy(*aState, "BUSY");
-
-    return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSanePluginInstance::SetState(const char * aState)
-{
-#ifdef DEBUG
-    printf("nsSaneInstance::SetState()\n");
-#endif
-
-    // This is a read-only flag.
-    NS_ERROR("Success is a read-only flag!\n");
-    return NS_ERROR_FAILURE;
-}
-
-// END of Scanner Status Interface
-//////////////////////////////////////////////////////////////////////////////
-
-///////////////////////////////////////////////////////////////////////////////
-// snPluginStreamListener Methods
-
-nsSanePluginStreamListener::nsSanePluginStreamListener(nsSanePluginInstance* inst)
-{
-#ifdef DEBUG
-    printf("nsSanePluginStreamListener::nsSanePluginStreamListener()\n");
-#endif
-
-    PR_AtomicIncrement(&gPluginObjectCount);
-
-    mPlugInst = inst;
-}
-
-nsSanePluginStreamListener::~nsSanePluginStreamListener(void)
-{
-#ifdef DEBUG
-    printf("nsSanePluginStreamListener::~nsSanePluginStreamListener()\n");
-#endif
-
-    PR_AtomicDecrement(&gPluginObjectCount);
-}
-
-
-// This macro produces a simple version of QueryInterface, AddRef and Release.
-// See the nsISupports.h header file for details.
-NS_IMPL_ISUPPORTS1(nsSanePluginStreamListener, nsIPluginStreamListener)
-
-NS_METHOD
-nsSanePluginStreamListener::OnStartBinding( nsIPluginStreamInfo* pluginInfo )
-{
-#ifdef DEBUG
-    printf("nsSanePluginStreamListener::OnStartBinding()\n");
-#endif
-
-    return NS_OK;
-}
-
-NS_METHOD
-nsSanePluginStreamListener::OnDataAvailable( nsIPluginStreamInfo* pluginInfo, 
-                                             nsIInputStream* input, 
-                                             PRUint32 length )
-{
-#ifdef DEBUG
-    printf("nsSanePluginStreamListener::OnDataAvailable()\n");
-#endif
-
-    // This plugin doesn't support 
-    // streaming input data.
-    return NS_OK;
-}
-
-
-NS_METHOD
-nsSanePluginStreamListener::OnFileAvailable( nsIPluginStreamInfo* pluginInfo, 
-                                             const char* fileName )
-{
-#ifdef DEBUG
-    printf("nsSanePluginStreamListener::OnFileAvailable()\n");
-#endif
-
-    return NS_OK;
-}
-
-NS_METHOD
-nsSanePluginStreamListener::OnStopBinding( nsIPluginStreamInfo* pluginInfo,
-                                           nsresult status )
-{
-#ifdef DEBUG
-    printf("nsSanePluginStreamListener::OnStopBinding()\n");
-#endif
-
-    return NS_OK;
-}
-
-NS_METHOD
-nsSanePluginStreamListener::OnNotify( const char* url, nsresult status )
-{
-#ifdef DEBUG
-    printf("nsSanePluginStreamListener::OnNotify()\n");
-#endif
-
-    return NS_OK;
-}
-
-NS_METHOD
-nsSanePluginStreamListener::GetStreamType(nsPluginStreamType *result)
-{
-#ifdef DEBUG
-    printf("nsSanePluginStreamListener::GetStreamType()\n");
-#endif
-
-    *result = nsPluginStreamType_Normal;
-    return NS_OK;
-}
-
-// End snPluginStreamListener methods
-//////////////////////////////////////////////////////////////////////////////
-
-/////////////////////////////////////////////////////////////////////////////
-// Helper Global Fuctions
-
-gboolean draw (GtkWidget *widget, GdkEventExpose *event, gpointer data) {
-
-    nsSanePluginInstance * pthis = (nsSanePluginInstance *)data;
-
-    pthis->PaintImage();
-    return TRUE;
-}
-
-nsresult optioncat ( char ** dest, const char * src, const char * ending )
-{
-    char * p;
-    int i;
-
-    NS_ASSERTION(dest != NULL, "null option string pointer");
-    if (!dest)
-        return NS_ERROR_NULL_POINTER;
-
-    NS_ASSERTION(src != NULL, "null option string pointer");
-    if (!src)
-        return NS_ERROR_NULL_POINTER;
-
-    NS_ASSERTION(ending != NULL, "null option string pointer");
-    if (!ending)
-        return NS_ERROR_NULL_POINTER;
-
-    // ensure that src string doesn't contain any ','s or ';'s
-    p = PL_strdup(src);
-    for ( i=0; p[i]; i++ ) {
-        if (p[i] == ',')
-            p[i] = '~';  // Replace ','s with '~'s
-        else if (p[i] == ';')
-            p[i] = '|';  // Replace ';'s with '|'s
-
-    }
-
-
-    PL_strcat(*dest, p);
-    PL_strcat(*dest, ending);
-    PR_FREEIF(p);
-
-    return NS_OK;
-}
-
-void
-my_jpeg_error_exit (j_common_ptr cinfo)
-{
-    emptr errmgr;
-
-    errmgr = (emptr) cinfo->err;
-    cinfo->err->output_message(cinfo);
-    siglongjmp(errmgr->setjmp_buffer, 1);
-    return;
-}
-
-unsigned char      *
-jpeg_file_to_rgb (FILE * f, int *w, int *h)
-{
-  struct jpeg_decompress_struct cinfo;
-  struct my_JPEG_error_mgr jerr;
-  unsigned char      *data, *line[16], *ptr;
-  int                 x, y, i;
-
-  cinfo.err = jpeg_std_error(&(jerr.pub));
-  jerr.pub.error_exit = my_jpeg_error_exit;
-
-  /* error handler to longjmp to, we want to preserve signals */
-  if (sigsetjmp(jerr.setjmp_buffer, 1)) {
-    
-    /* Whoops there was a jpeg error */
-    jpeg_destroy_decompress(&cinfo);
-    return NULL;
-  }
-
-  jpeg_create_decompress(&cinfo);
-  jpeg_stdio_src(&cinfo, f);
-  jpeg_read_header(&cinfo, TRUE);
-  cinfo.do_fancy_upsampling = FALSE;
-  cinfo.do_block_smoothing = FALSE;
-
-  cinfo.scale_num = 2;
-  cinfo.scale_denom = 1;
-  jpeg_start_decompress(&cinfo);
-  *w = cinfo.output_width;
-  *h = cinfo.output_height;
-  data = (unsigned char *)PR_Malloc(*w ** h * 3);
-  if (!data) {
-    NS_ERROR("jpeg_file_to_rgb: Error trying to allocate buffer!\n");
-    jpeg_destroy_decompress(&cinfo);
-    return NULL;
-  }
-  ptr = data;
-
-  if (cinfo.rec_outbuf_height > 16) {
-      NS_ERROR("ERROR: JPEG uses line buffers > 16. Cannot load.\n");
-      return NULL;
-  }
-
-  if (cinfo.output_components == 3) {
-    for (y = 0; y < *h; y += cinfo.rec_outbuf_height) {
-      for (i = 0; i < cinfo.rec_outbuf_height; i++) {
-	line[i] = ptr;
-	ptr += *w * 3;
-      }
-
-      jpeg_read_scanlines(&cinfo, line, cinfo.rec_outbuf_height);
-    }
-  } else if (cinfo.output_components == 1) {
-    for (i = 0; i < cinfo.rec_outbuf_height; i++) {
-      if ((line[i] = (unsigned char *)PR_Malloc(*w)) == NULL) {
-	int                 t = 0;
-	
-	NS_ERROR("jpeg_file_to_rgb: Error tying to allocate line!\n");
-	
-	for (t = 0; t < i; t++)
-	  PR_FREEIF(line[t]);
-	jpeg_destroy_decompress(&cinfo);
-	return NULL;
-      }
-    }
-
-    for (y = 0; y < *h; y += cinfo.rec_outbuf_height) {
-      jpeg_read_scanlines(&cinfo, line, cinfo.rec_outbuf_height);
-      for (i = 0; i < cinfo.rec_outbuf_height; i++) {
-	for (x = 0; x < *w; x++) {
-	  *ptr++ = line[i][x];
-	  *ptr++ = line[i][x];
-	  *ptr++ = line[i][x];
-	}
-      }
-    }
-
-    for (i = 0; i < cinfo.rec_outbuf_height; i++)
-      PR_FREEIF(line[i]);
-  }
-
-  jpeg_finish_decompress(&cinfo);
-  jpeg_destroy_decompress(&cinfo);
-
-  return data;
-}
-
-// Caller must free memory
-unsigned char *
-scale_image(unsigned char *rgb_data, int rgb_width, int rgb_height,
-	    int w, int h)
-{
-  int                 x, y, *xarray;
-  unsigned char     **yarray, *ptr, *ptr2, *ptr22, *new_data;
-  int                 l, r, m, pos, inc, w3;
-
-  new_data = (unsigned char *) PR_Malloc( w * h * 3);
-  if (!new_data) {
-    NS_ERROR("ERROR: Cannot allocate image buffer\n");
-    return NULL;
-  }
-
-  xarray = (int *)PR_Malloc(sizeof(int) * w);
-  if (!xarray) {
-    NS_ERROR("ERROR: Cannot allocate X co-ord buffer\n");
-    PR_FREEIF(new_data);
-    return NULL;
-  }
-
-  yarray = (unsigned char **)PR_Malloc(sizeof(unsigned char *) * h);
-  if (!yarray) {
-    NS_ERROR("ERROR: Cannot allocate Y co-ord buffer\n");
-    PR_FREEIF(new_data);
-    PR_FREEIF(xarray);
-    return NULL;
-  }
-  
-  ptr22 = rgb_data;
-  w3 = rgb_width * 3;
-  inc = 0;
-  l = 0;
-  r = 0;
-  m = w - l - r;
-
-  inc = (rgb_width << 16) / m;
-  pos = 0;
-
-  for (x = l; x < l + m; x++) {
-    xarray[x] = (pos >> 16) + (pos >> 16) + (pos >> 16);
-    pos += inc;
-  }
-
-  pos = (rgb_width - r) << 16;
-  for (x = w - r; x < w; x++) {
-    xarray[x] = (pos >> 16) + (pos >> 16) + (pos >> 16);
-    pos += 0x10000;
-  }
-
-  l = 0;
-  r = 0;
-  m = h - l - r;
-
-  if (m > 0)
-    inc = (rgb_height << 16) / m;
-
-  pos = 0;
-
-  for (x = l; x < l + m; x++) {
-    yarray[x] = ptr22 + ((pos >> 16) * w3);
-    pos += inc;
-  }
-
-  pos = (rgb_height - r) << 16;
-  for (x = h - r; x < h; x++) {
-    yarray[x] = ptr22 + ((pos >> 16) * w3);
-    pos += 0x10000;
-  }
-
-  ptr = new_data;
-  for (y = 0; y < h; y++) {
-    for (x = 0; x < w; x++) {
-      ptr2 = yarray[y] + xarray[x];
-      *ptr++ = (int)*ptr2++;
-      *ptr++ = (int)*ptr2++;
-      *ptr++ = (int)*ptr2;
-    }
-  }
-
-  PR_FREEIF(xarray);
-  PR_FREEIF(yarray);
-
-  return new_data;
-}
-
-
-// Caller must free memory
-unsigned char *
-crop_image(unsigned char *rgb_data, int *rgb_width, int *rgb_height,
-	   gint x, gint y, gint w, gint h)
-{
-  unsigned char      *data;
-  int                 xx, yy, w3, w4;
-  unsigned char      *ptr1, *ptr2;
-
-  if (!rgb_data)
-    return NULL;
-
-  if (x < 0)
-    {
-      w += x;
-      x = 0;
-    }
-  if (y < 0)
-    {
-      h += y;
-      y = 0;
-    }
-  if (x >= *rgb_width)
-    return NULL;
-  if (y >= *rgb_height)
-    return NULL;
-  if (w <= 0)
-    return NULL;
-  if (h <= 0)
-    return NULL;
-  if (x + w > *rgb_width)
-    w = *rgb_width - x;
-  if (y + h > *rgb_height)
-    h = *rgb_height - y;
-  if (w <= 0)
-    return NULL;
-  if (h <= 0)
-    return NULL;
-
-  w3 = *rgb_width * 3;
-  w4 = (*rgb_width - w) * 3;
-  data = (unsigned char *)PR_Malloc(w * h * 3);
-  if (data == NULL)
-    return NULL;
-  ptr1 = rgb_data + (y * w3) + (x * 3);
-  ptr2 = data;
-  for (yy = 0; yy < h; yy++)
-    {
-      for (xx = 0; xx < w; xx++)
-	{
-	  *ptr2++ = *ptr1++;
-	  *ptr2++ = *ptr1++;
-	  *ptr2++ = *ptr1++;
-	}
-      ptr1 += w4;
-    }
-  
-  *rgb_width = w;
-  *rgb_height = h;
-
-  return data;
-}
-
-void PR_CALLBACK scanimage_thread_routine( void * arg )
-{
-    nsSanePluginInstance * pthis = (nsSanePluginInstance *)arg;
-
-    nsresult rv;
-    SANE_Status status;
-    SANE_Parameters param;
-    int len;
-    FILE * out;
-    SANE_Byte * buf;
-    JSAMPROW row_pointer[1];
-    char *fname;
-
-    // JPEG stuff
-    struct jpeg_compress_struct cinfo;
-	struct jpeg_error_mgr jerr;
-
-	// Error handling
-    jerr.error_exit = my_jpeg_error_exit; // fatal errors
-	cinfo.err = jpeg_std_error(&jerr);
-
-	jpeg_create_compress(&cinfo);
-
-    rv = pthis->OpenSaneDeviceIF();
-    if (rv != NS_OK)
-        goto error_exit;
-
-    // open image file
-    fname = pthis->GetImageFilename();
-    if (!fname)
-        goto error_exit;
-    out = fopen(fname, "wb");
-    PR_FREEIF(fname);
-    if (out == NULL) {
-        NS_ERROR("Unable to open mImageFilename!\n");
-        sane_cancel(pthis->mSaneHandle);
-        goto error_exit;       
-    }
-    jpeg_stdio_dest(&cinfo, out);
-
-    status = sane_start(pthis->mSaneHandle);
-    if (status != SANE_STATUS_GOOD) {
-        NS_ERROR("Error trying to start sane device!");
-        goto error_exit;
-    }
-
-    status = sane_get_parameters(pthis->mSaneHandle, &param);
-    if (status != SANE_STATUS_GOOD) {
-        NS_ERROR("Error trying to get image parameters!\n");
-        sane_cancel(pthis->mSaneHandle);
-        goto error_exit;
-    }
-    cinfo.image_width = param.pixels_per_line;
-    cinfo.image_height = param.lines;
-
-    switch (param.format) {
-    case SANE_FRAME_RED:
-    case SANE_FRAME_GREEN:
-    case SANE_FRAME_BLUE:
-        // NOT Supported!
-        NS_ERROR("Multiframe devices not supported!\n");
-        sane_cancel(pthis->mSaneHandle);
-        goto error_exit;
-        break;
-                
-    case SANE_FRAME_RGB:
-        cinfo.input_components = 3;
-        cinfo.in_color_space = JCS_RGB;
-        break;
-
-    case SANE_FRAME_GRAY:
-        cinfo.input_components = 1;
-        cinfo.in_color_space = JCS_GRAYSCALE;
-        break;
-    }
-    jpeg_set_defaults(&cinfo); 
-    cinfo.dct_method = pthis->mCompMethod; 
-    jpeg_set_quality(&cinfo, pthis->mCompQuality, FALSE);
-    jpeg_start_compress(&cinfo, TRUE);
-
-    buf = (SANE_Byte *)PR_MALLOC(param.bytes_per_line);
-    if (!buf) {
-        NS_ERROR("Error trying to allocate buffer!\n");
-        jpeg_destroy_compress(&cinfo);
-        fclose(out);
-        sane_cancel(pthis->mSaneHandle);
-        goto error_exit;
-    }
-
-    int total;
-    while(1) {
-        total = 0;
-        while (total < param.bytes_per_line) {
-            // Read in data from sane device
-            status = sane_read(pthis->mSaneHandle, buf + total, 
-                               param.bytes_per_line - total, 
-                               &len);
-            if (status != SANE_STATUS_GOOD) {
-                if (status == SANE_STATUS_EOF)
-                    // done with this frame
-                    goto finished_scan;
-                else {
-                    NS_ERROR("Error trying to read from sane device!\n");
-                    PR_FREEIF(buf);
-                    jpeg_destroy_compress(&cinfo);
-                    fclose(out);
-                    sane_cancel(pthis->mSaneHandle);
-                    goto error_exit;
-                }
-            }
-            total += len;
-        }
-
-        row_pointer[0] = (JSAMPLE *) buf;
-        jpeg_write_scanlines(&cinfo, row_pointer, 1); 
-
-    } // end while
-
-    // cleanup
- finished_scan:
-    jpeg_finish_compress(&cinfo);
-    jpeg_destroy_compress(&cinfo);
-    PR_FREEIF(buf);
-    sane_cancel(pthis->mSaneHandle);
-    fclose(out);
-    pthis->SetSuccess(PR_TRUE); // allow caller to check for success
-
- error_exit:
-
-    ////////////////////////////////////////////////
-    // Call onScanComplete callback in the UI thread
-
-    nsCOMPtr<nsIEventQueue> eventQ;
-
-    // Get the event queue of the current thread...
-    nsCOMPtr<nsIEventQueueService> eventQService = 
-             do_GetService(kEventQueueService, &rv);
-    if (NS_FAILED(rv)) {
-        NS_ERROR("Unable to get event queue service!\n");
-        return;
-    }
-
-    rv = eventQService->GetThreadEventQueue(pthis->mUIThread,
-                                            getter_AddRefs(eventQ));
-    if (NS_FAILED(rv)) {
-        NS_ERROR("Unable to get thread queue!\n");
-        return;
-    }
-
-    PLEvent *event = new PLEvent;
-    if (!event) {
-        NS_ERROR("Unable to create new event!\n");
-        return;
-    }
-
-    // ThreadHandleEvent will now execute in the UI thread.
-    PL_InitEvent(event, pthis, ThreadedHandleEvent, ThreadedDestroyEvent);
-
-    if (NS_FAILED(eventQ->PostEvent(event))) {
-        NS_ERROR("Error trying to post event!\n");
-        PL_DestroyEvent(event);
-        return;
-    }
-}
-
-void* PR_CALLBACK ThreadedHandleEvent(PLEvent * event)
-{
-    nsSanePluginInstance *pthis = (nsSanePluginInstance *)event->owner;    
-   
-    // If this isn't the UI's thread then we are hosed!
-    if (PR_FALSE == pthis->IsUIThread()) {
-        NS_ERROR("Attempt to execute event from the wrong thread!\n");
-        return;
-    }
-
-    pthis->SetState(0); // no longer scanning
-    pthis->Restore();  // repaint image
-
-    // Notify user that routine is finished
-    pthis->DoScanCompleteCallback();
-
-    return nsnull;
-}
-
-void PR_CALLBACK ThreadedDestroyEvent(PLEvent* aEvent)
-{
-    delete aEvent;
-}
-
-void store_filename(GtkFileSelection *selector, gpointer user_data) 
-{
-    nsSanePluginInstance *pthis = (nsSanePluginInstance *) user_data;    
-    gchar *cmd;
-    GtkWidget * fs;
-    char * orig_filename;
-    char * dest_filename;
-
-    if (!user_data || !selector)
-        return;
-
-    fs = pthis->GetFileSelection();
-    orig_filename = pthis->GetImageFilename();
-    if ( !fs || !orig_filename )
-        return;
-
-    dest_filename = gtk_file_selection_get_filename (GTK_FILE_SELECTION(fs));
-    if ( !dest_filename )
-        return;
-
-#ifdef DEBUG
-    printf("Saving %s to %s\n", orig_filename, dest_filename);
-#endif
-
-    /*
-     * I'm just doing a simple 'cp' command with the shell.
-     * This probobly should be done in a NSPR safe kind
-     * of way.
-     */
-
-    // cp /tmp/nsSanePlugin.###.jpg /path/to/save/to.jpg
-    cmd = (gchar *)PR_Malloc(PL_strlen(orig_filename) + 
-                             PL_strlen(dest_filename) + 6);
-    if (!cmd)
-        return;
-        
-    sprintf(cmd, "cp %s %s", orig_filename, dest_filename);
-    system(cmd);
-
-    PR_FREEIF(cmd);
-}
-
-// END of Helper Global Functions
-//////////////////////////////////////////////////////////////////////////////
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
diff -r f3ac957eb4af modules/plugin/sdk/samples/SanePlugin/nsSanePlugin.h
--- a/modules/plugin/sdk/samples/SanePlugin/nsSanePlugin.h	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,261 +0,0 @@
-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
- *
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org Code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 2001
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *   Rusty Lynch <rusty.lynch@intel.com>
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-/*
- * Declares the nsSanePluginInterface class for the SANE plugin.
- */
-
-#ifndef __NS_SANE_PLUGIN_H__
-#define __NS_SANE_PLUGIN_H__
-
-#include "prthread.h"
-#include "nscore.h"
-#include "nsplugin.h"
-#include "gdksuperwin.h"
-#include "gtkmozbox.h"
-#include "gtk/gtk.h"
-#include "nsIPlugin.h"
-#include "nsSanePluginControl.h"
-#include "nsIScriptContext.h"
-#include "nsIServiceManager.h"
-#include "nsISupports.h"
-#include "nsISupportsUtils.h"
-#include "nsIEventQueueService.h"
-#include "nsIEventQueue.h"
-
-///////////////////////////////////
-// Needed for encoding jpeg images
-extern "C"
-{
-#include <jpeglib.h>
-}
-
-///////////////////////////////////
-// Needed for SANE interface
-extern "C"
-{
-#include <sane/sane.h>
-#include <sane/sanei.h>
-#include <sane/saneopts.h>
-}
-
-typedef struct _PlatformInstance
-{
-    Window        window;
-    GtkWidget   * widget;
-    GdkSuperWin * superwin;
-    Display     * display;
-    uint16        x;
-    uint16        y;
-    uint32        width; 
-    uint32        height;
-
-} PlatformInstance;
-
-// Threaded routine for grabbing a frame from device.
-// If a callback for onScanComplete was set in the embed/object
-// tag, then this routine will call it before exiting.
-//void PR_CALLBACK scanimage_thread_routine( void * arg);
-void PR_CALLBACK scanimage_thread_routine( void * arg );
-
-class nsSanePluginInstance : public nsIPluginInstance, 
-                             public nsISanePluginInstance
-{
-    friend void PR_CALLBACK scanimage_thread_routine( void *);
-
-    public:
-  
-    nsSanePluginInstance(void);
-    virtual ~nsSanePluginInstance(void);
-
-    /////////////////////////////////////////////////////////////////////
-    // nsIPluginInstance inherited interface
-    NS_IMETHOD Initialize(nsIPluginInstancePeer* peer);
-    NS_IMETHOD GetPeer(nsIPluginInstancePeer* *result);
-    NS_IMETHOD Start(void);
-    NS_IMETHOD Stop(void);
-    NS_IMETHOD Destroy( void );
-    NS_IMETHOD SetWindow( nsPluginWindow* window );
-    NS_IMETHOD NewStream( nsIPluginStreamListener** listener );
-    NS_IMETHOD Print( nsPluginPrint* platformPrint );
-    NS_IMETHOD GetValue( nsPluginInstanceVariable variable, void *value );
-
-    // Not used for this platform! Only a placeholder.
-    NS_IMETHOD HandleEvent( nsPluginEvent* event, PRBool* handled );
-
-    // End of nsIPlugIninstance inherited interface.
-    /////////////////////////////////////////////////////////////////////
-
-    /////////////////////////////////////////////////////////////////////
-    // nsSanePluginInstance specific methods:
-    NS_DECL_ISUPPORTS ;
-    
-    // Execute given callback in window's JavaScript
-    NS_IMETHOD DoScanCompleteCallback();
-    NS_IMETHOD DoInitCompleteCallback();
-
-    void SetMode(nsPluginMode mode) { fMode = mode; }
-    void SetState(PRInt32 aState) { mState = aState; };
-    NS_IMETHOD PaintImage(void);
-    char * GetImageFilename();
-    GtkWidget * GetFileSelection();
-    PRBool IsUIThread();
-    nsresult OpenSaneDeviceIF( void );
-
-    //*** Methods exposed through the XPConnect interface ***
-    NS_DECL_NSISANEPLUGININSTANCE
-
-private:
-
-    GtkWidget                  *mDrawing_area;
-    GtkWidget                  *mEvent_box;
-    PlatformInstance            fPlatform;
-    char                        mImageFilename[255];
-    GtkWidget                  *mFileSelection;
-    GdkRectangle                mZoom_box;
-    unsigned char              *mRGBData;
-    int                         mRGBWidth, mRGBHeight;
-
-    // line attributes for zoom box
-    PRInt32                     mLineWidth;
-    GdkLineStyle                mLineStyle;
-    GdkCapStyle                 mCapStyle;
-    GdkJoinStyle                mJoinStyle;
-
-    // zoom box change variables
-    float                       mTopLeftXChange;
-    float                       mTopLeftYChange;
-    float                       mBottomRightXChange;
-    float                       mBottomRightYChange;
-
-    // jpeg compression attributes
-    int                         mCompQuality;
-    enum J_DCT_METHOD           mCompMethod;
-
-    // sane specific members
-    SANE_Handle                 mSaneHandle;
-    SANE_String                 mSaneDevice;
-    SANE_Bool                   mSaneOpen;
-    PRBool                      mSuccess;
-    PRInt32                     mState;
-
-    // needed for JavaScript Callbacks
-    char                        *mOnScanCompleteScript;
-    char                        *mOnInitCompleteScript;
-    PRThread                    *mScanThread;
-    PRThread                    *mUIThread;
-
-protected:
-
-    nsIPluginInstancePeer*      fPeer;
-    nsPluginWindow*             fWindow;
-    nsPluginMode                fMode;
-    nsIPluginManager*           mPluginManager;
-
-private:
-
-    int                         WritePNMHeader (int fd, SANE_Frame format, 
-                                                int width, int height, 
-                                                int depth);
-
-    void                        PlatformNew( void );
-    nsresult                    PlatformDestroy( void );
-    PRInt16                     PlatformHandleEvent( nsPluginEvent* event );
-    nsresult                    PlatformSetWindow( nsPluginWindow* window );  
-};
-
-class nsSanePluginStreamListener : public nsIPluginStreamListener
-{
-    public:
-  
-    NS_DECL_ISUPPORTS ;
-  
-    /*
-     * Notify the observer that the URL has started to load.  This method is
-     * called only once, at the beginning of a URL load.<BR><BR>
-     *
-     * @return The return value is currently ignored.  In the future it may be
-     * used to cancel the URL load..
-     */
-    NS_IMETHOD OnStartBinding( nsIPluginStreamInfo* pluginInfo );
-  
-    /**
-     * Notify the client that data is available in the input stream.  This
-     * method is called whenver data is written into the input stream by the
-     * networking library...<BR><BR>
-     * 
-     * @param aIStream  The input stream containing the data.  This stream can
-     * be either a blocking or non-blocking stream.
-     * @param length    The amount of data that was just pushed into the 
-     * stream.
-     * @return The return value is currently ignored.
-     */
-    NS_IMETHOD OnDataAvailable( nsIPluginStreamInfo* pluginInfo,
-                                nsIInputStream* input, 
-                                PRUint32 length );
-    NS_IMETHOD OnFileAvailable( nsIPluginStreamInfo* pluginInfo,
-                         const char* fileName );
-  
-    /**
-     * Notify the observer that the URL has finished loading.  This method is 
-     * called once when the networking library has finished processing the 
-     * URL transaction initiatied via the nsINetService::Open(...) call.
-     * <BR><BR>
-     * 
-     * This method is called regardless of whether the URL loaded 
-     * successfully.<BR><BR>
-     * 
-     * @param status    Status code for the URL load.
-     * @param msg       A text string describing the error.
-     * @return          The return value is currently ignored.
-     */
-    NS_IMETHOD OnStopBinding( nsIPluginStreamInfo* pluginInfo,
-                              nsresult status );
-    NS_IMETHOD OnNotify( const char* url, nsresult status );
-    NS_IMETHOD GetStreamType( nsPluginStreamType *result );
-  
-    ///////////////////////////////////////////////////////////////////////////
-    // snPluginStreamListener specific methods:
-  
-    nsSanePluginStreamListener( nsSanePluginInstance* inst );
-    virtual ~nsSanePluginStreamListener( void );
-  
-    nsSanePluginInstance* mPlugInst;
-};
-
-#endif // __NS_SANE_PLUGIN_H__
diff -r f3ac957eb4af modules/plugin/sdk/samples/SanePlugin/nsSanePluginControl.idl
--- a/modules/plugin/sdk/samples/SanePlugin/nsSanePluginControl.idl	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,170 +0,0 @@
-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
- *
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org Code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 2001
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *   Rusty Lynch <rusty.lynch@intel.com>
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-/* 
- * Defines scriptable interface to SANE plugin.
- */
-
-#include "nsISupports.idl"
-
-[scriptable, uuid(10982800-365e-11d3-a2bf-0004ac779ef3)]
-/**
- * This interface can be obtained with the following HTML/JavaScript sequence:
- *
- * <pre>
- * <EMBED type="application/X-sane-plugin" 
- *        id="SaneObject" 
- *        onScanComplete="ScanCompleteCallback()"
- *        device="hp:/dev/usbscanner"
- *        line_width="5"
- *        line_style="dash"
- *        cap_style="round"
- *        join_style="round"
- *        width=320 height=240>
- *
- * <form name="myForm">
- *   <!-- Scan Selected Region -->
- *   <input type="button" 
- *          value="Start Scan" 
- *          onClick="scanner.ScanImage()">
- *   <!-- many more buttons for controlling scanner/camera... -->
- * </form>
- * <script>
- *  var scanner = document.SaneObject.nsISaneControl;
- *  dump("scanner = "+ scanner + "\n");
- * </script>
- * </pre>
- *
- * This fragment will create an embedded plugin, which can then be accessed
- * and controlled by the nsISanePluginInstance interface which is instantiated
- * in the script.
- */
-interface nsISanePluginInstance : nsISupports
-{
-    /////////////////////////////////////////////////////////////////////
-    // Plugin Status Interface
-    
-    // Read-Only: Contains completion status of last operation
-    attribute boolean Success;
-
-    // Read-Only: Contains the current state of the scanner (IDLE|BUSY)
-    attribute string State;
-
-    /////////////////////////////////////////////////////////////////////
-    // Image Preview Interface
-
-    // Move zoom box to a given geometry in one step
-    void ZoomImage(in unsigned short x, in unsigned short y, 
-                   in unsigned short width, in unsigned short height);
-    void ZoomImageWithAttributes(in unsigned short x, 
-                                 in unsigned short y, 
-                                 in unsigned short width, 
-                                 in unsigned short height,
-                                 in long req_line_width, 
-                                 in string req_line_style,
-                                 in string req_cap_style, 
-                                 in string req_join_style);
-
-    // Undo all croping and reset zoom box for entire image
-    void Restore ();
-
-    // Zoom in on the image and reset the zoom box to contain 
-    // the entire image.
-    void Crop(in unsigned short x, in unsigned short y,
-              in unsigned short width, in unsigned short height);
-
-    // Read/Write zoom box geometry
-    // (Each write will trigger a refresh!)
-    attribute unsigned short ZoomX;
-    attribute unsigned short ZoomY;
-    attribute unsigned short ZoomWidth;
-    attribute unsigned short ZoomHeight;
-
-    // Read/Write zoom box line attributes
-    // (Each write will trigger a refresh!)
-    attribute long   ZoomLineWidth;
-    attribute string ZoomLineStyle;
-    attribute string ZoomCapStyle;
-    attribute string ZoomJoinStyle;
-
-    // Read-Only zoom box change indicators
-    // (For SANE devices that support changing the scan area,
-    //  this allows for the controling JavaScript to safely adjust
-    //  the scan area in a device specific manner.)
-    attribute float ZoomBR_XChange;  // % bottom right x change on last zoom
-    attribute float ZoomBR_YChange;  // % bottom right y ...
-    attribute float ZoomTL_XChange;  // % top left x ...
-    attribute float ZoomTL_YChange;  // % top left y ...
-
-    // Read/Write JPEG compression attributes
-    attribute long Quality;
-    attribute string Method;
-
-    //////////////////////////////////////////////////////////////////////
-    // Generic SANE Interface
-
-    // READ_ONLY: returns a colon delimited list of option descriptions
-    //            where each option description is a comma delimited
-    //            list of values
-    attribute string DeviceOptions;
-
-    // Returns or sets the active device.
-    attribute string ActiveDevice;
-
-    // READ_ONLY: returns a comma delimited list of image parameters
-    attribute string ImageParameters;
-
-    // READ_ONLY: returns a comma delimited list of available devices
-    attribute string AvailableDevices;
-
-    // Pull image from device with current option settings.
-    // As a side effect, the zoom box is set to contain the
-    // entire image.
-    void ScanImage();
-    void SetOption(in string name, in string value);
-
-    // Pop up a dialog to save current image to a file
-    void SaveImage();
- };
-
-%{ C++
-//10982800-365e-11d3-a2bf-0004ac780ef3
-#define NS_SANE_PLUGIN_CONTROL_CID \
- { 0x10982800, 0x365e, 0x11d3, { 0xa2, 0xbf, 0x0, 0x04, 0xac, 0x78, 0x0e, 0xf3 }}
-
-%}
diff -r f3ac957eb4af modules/plugin/sdk/samples/SanePlugin/nsSanePluginFactory.cpp
--- a/modules/plugin/sdk/samples/SanePlugin/nsSanePluginFactory.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,333 +0,0 @@
-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
- *
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org Code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 2001
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *   Rusty Lynch <rusty.lynch@intel.com>
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-/*
- * Implements the SANE plugin factory class.
- */
-
-#include "nsString.h"
-#include "nsCOMPtr.h"
-#include "nsIServiceManager.h"
-#include "nsSanePlugin_CID.h"
-#include "nsSanePlugin.h"
-#include "nsSanePluginFactory.h"
-#include "plstr.h"
-
-#define PLUGIN_NAME             "SANE Plugin"
-#define PLUGIN_DESCRIPTION      "SANE Plugin is a generic scanner interface"
-#define PLUGIN_MIME_DESCRIPTION "application/X-sane-plugin::Scanner/Camera"
-#define PLUGIN_MIME_TYPE        "application/X-sane-plugin"
-
-static NS_DEFINE_IID( kISupportsIID,            NS_ISUPPORTS_IID           );
-static NS_DEFINE_IID( kIFactoryIID,             NS_IFACTORY_IID            );
-static NS_DEFINE_IID( kIPluginIID,              NS_IPLUGIN_IID             );
-static NS_DEFINE_CID( kComponentManagerCID,     NS_COMPONENTMANAGER_CID    );
-static NS_DEFINE_CID( knsSanePluginControlCID,  NS_SANE_PLUGIN_CONTROL_CID );
-static NS_DEFINE_CID( knsSanePluginInst,        NS_SANE_PLUGIN_CID         );
-
-////////////////////////////////////////////////////////////////////////
-
-nsSanePluginFactoryImpl::nsSanePluginFactoryImpl( const nsCID &aClass,
-                                                  const char* className,
-                                                  const char* contractID )
-    : mClassID(aClass), mClassName(className), mContractID(contractID)
-{
-#ifdef DEBUG
-    printf("nsSanePluginFactoryImpl::nsSanePluginFactoryImpl()\n");
-#endif
-}
-
-nsSanePluginFactoryImpl::~nsSanePluginFactoryImpl()
-{
-#ifdef DEBUG
-    printf("nsSanePluginFactoryImpl::~nsSanePluginFactoryImpl()\n");
-#endif
-
-    printf("mRefCnt = %i\n", mRefCnt);
-    NS_ASSERTION(mRefCnt == 0, "non-zero refcnt at destruction");
-}
-
-NS_IMETHODIMP
-nsSanePluginFactoryImpl::QueryInterface(const nsIID &aIID, 
-                                        void **aInstancePtr)
-{
-#ifdef DEBUG
-    printf("nsSanePluginFactoryImpl::QueryInterface()\n");
-#endif
-
-    if (!aInstancePtr)
-        return NS_ERROR_NULL_POINTER;
-
-    if (aIID.Equals(kISupportsIID)) {
-        *aInstancePtr = static_cast<nsISupports*>(this);
-    } else if (aIID.Equals(kIFactoryIID)) {
-        *aInstancePtr = static_cast<nsISupports*>
-                                   (static_cast<nsIFactory*>(this));
-    } else if (aIID.Equals(kIPluginIID)) {
-        *aInstancePtr = static_cast<nsISupports*>
-                                   (static_cast<nsIPlugin*>(this));
-    } else {
-        *aInstancePtr = nsnull;
-        return NS_ERROR_NO_INTERFACE;
-    }
-
-    NS_ADDREF(reinterpret_cast<nsISupports*>(*aInstancePtr));
-
-    return NS_OK;
-}
-
-// Standard implementation of AddRef and Release
-NS_IMPL_ADDREF( nsSanePluginFactoryImpl )
-NS_IMPL_RELEASE( nsSanePluginFactoryImpl )
-
-NS_IMETHODIMP
-nsSanePluginFactoryImpl::CreateInstance( nsISupports *aOuter,
-                                         const nsIID &aIID,
-                                         void **aResult)
-{
-#ifdef DEBUG
-    printf("nsSanePluginFactoryImpl::CreateInstance()\n");
-#endif
-
-    if ( !aResult )
-        return NS_ERROR_NULL_POINTER;
-  
-    if ( aOuter )
-        return NS_ERROR_NO_AGGREGATION;
-
-    nsSanePluginInstance * inst = new nsSanePluginInstance();
-    if (!inst)
-        return NS_ERROR_OUT_OF_MEMORY;
-           
-    inst->AddRef();
-    *aResult = inst;
-    return NS_OK;
-}
-
-nsresult 
-nsSanePluginFactoryImpl::LockFactory(PRBool aLock)
-{
-#ifdef DEBUG
-    printf("nsSanePluginFactoryImpl::LockFactory()\n");
-#endif
-
-    // Needs to be implemented
-
-    return NS_OK;
-}
-
-
-NS_METHOD
-nsSanePluginFactoryImpl::Initialize()
-{
-#ifdef DEBUG
-    printf("nsSanePluginFactoryImpl::Initialize()\n");
-#endif
-
-    return NS_OK;
-}
-
-
-NS_METHOD
-nsSanePluginFactoryImpl::Shutdown( void )
-{
-#ifdef DEBUG
-    printf("nsSanePluginFactoryImpl::Shutdown()\n");
-#endif
-
-    return NS_OK;
-}
-
-
-NS_METHOD 
-nsSanePluginFactoryImpl::GetMIMEDescription(const char* *result)
-{
-#ifdef DEBUG
-    printf("nsSanePluginFactoryImpl::GetMIMEDescription()\n");
-#endif
-
-    // caller is responsible for releasing
-    *result = PL_strdup( PLUGIN_MIME_DESCRIPTION );
-
-    return NS_OK;
-}
-
-NS_METHOD
-nsSanePluginFactoryImpl::GetValue( nsPluginVariable variable, void *value )
-{
-#ifdef DEBUG
-    printf("nsSanePluginFactoryImpl::GetValue()\n");
-#endif
-
-    nsresult err = NS_OK;
-
-    if ( variable == nsPluginVariable_NameString ) {
-    
-        *( ( char ** )value ) = strdup( PLUGIN_NAME );
-
-    } else if ( variable == nsPluginVariable_DescriptionString ) {
-
-        *( ( char ** )value ) = strdup( PLUGIN_DESCRIPTION );
-
-    } else {
-    
-        err = NS_ERROR_FAILURE;
-
-    }
-  
-    return err;
-}
-
-
-NS_IMETHODIMP 
-nsSanePluginFactoryImpl::CreatePluginInstance( nsISupports *aOuter, 
-                                               REFNSIID aIID, 
-                                               const char* aPluginMIMEType,
-                                               void **aResult)
-{
-#ifdef DEBUG
-    printf("nsSanePluginFactoryImpl::CreatePluginInstance()\n");
-#endif
-
-    // Need to find out what this is used for.  The npsimple
-    // plugin looks like it just does a CreateInstance and 
-    // ignores the mime type.
-    return NS_ERROR_NOT_IMPLEMENTED;
-}
-
-
-////////////////////////////////////////////////////////////////////////
-
-/**
- * The XPCOM runtime will call this to get a new factory object for the
- * CID/contractID it passes in.  XPCOM is responsible for caching the resulting
- * factory.
- *
- * return the proper factory to the caller
- */
-extern "C" PR_IMPLEMENT(nsresult)
-NSGetFactory( nsISupports* aServMgr,
-              const nsCID &aClass,
-              const char *aClassName,
-              const char *aContractID,
-              nsIFactory **aFactory)
-{
-    if (! aFactory)
-        return NS_ERROR_NULL_POINTER;
-  
-    nsSanePluginFactoryImpl* factory = new nsSanePluginFactoryImpl(aClass, 
-                                                                   aClassName,
-                                                                   aContractID);
-    if ( factory == nsnull )
-        return NS_ERROR_OUT_OF_MEMORY;
-  
-    NS_ADDREF(factory);
-    *aFactory = factory;
-    return NS_OK;
-
-}
-
-char *buf;
-
-extern "C" PR_IMPLEMENT( nsresult )
-NSRegisterSelf( nsISupports* aServMgr, const char* aPath )
-{
-    nsresult rv;
-  
-    nsCOMPtr<nsIServiceManager> servMgr( do_QueryInterface( aServMgr, &rv ) );
-    if ( NS_FAILED( rv ) )
-        return rv;
-  
-    nsCOMPtr<nsIComponentManager> compMgr = 
-             do_GetService( kComponentManagerCID, &rv );
-    if ( NS_FAILED( rv ) )
-        return rv;
-  
-    // Register the plugin control portion.
-    rv = compMgr->RegisterComponent(knsSanePluginControlCID,
-                                    "SANE Plugin Control",
-                                    "@mozilla.org/plugins/sane-control;1",
-                                    aPath, PR_TRUE, PR_TRUE );
-  
-    // Register the plugin portion.
-    rv = compMgr->RegisterComponent( knsSanePluginInst,
-                                     "SANE Plugin Component",
-                                     NS_INLINE_PLUGIN_CONTRACTID_PREFIX PLUGIN_MIME_TYPE
-                                     aPath, PR_TRUE, PR_TRUE);
-    if ( NS_FAILED( rv ) )
-        return rv;
-  
-    return NS_OK;
-
-}
-
-extern "C" PR_IMPLEMENT( nsresult )
-NSUnregisterSelf(nsISupports* aServMgr, const char* aPath)
-{
-    nsresult rv;
-  
-    nsCOMPtr<nsIServiceManager> servMgr(do_QueryInterface(aServMgr, &rv));
-    if (NS_FAILED(rv)) return rv;
-  
-    nsCOMPtr<nsIComponentManager> compMgr = 
-             do_GetService(kComponentManagerCID, &rv);
-    if (NS_FAILED(rv)) return rv;
-  
-    rv = compMgr->UnregisterComponent(knsSanePluginControlCID, aPath);
-    if (NS_FAILED(rv)) return rv;
-  
-    return NS_OK;
-}
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
diff -r f3ac957eb4af modules/plugin/sdk/samples/SanePlugin/nsSanePluginFactory.h
--- a/modules/plugin/sdk/samples/SanePlugin/nsSanePluginFactory.h	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,83 +0,0 @@
-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
- *
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org Code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 2001
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *   Rusty Lynch <rusty.lynch@intel.com>
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-/*
- * Declares the SANE plugin factory class.
- */
-
-#ifndef __NS_SANE_PLUGIN_FACTORY_H__
-#define __NS_SANE_PLUGIN_FACTORY_H__
-
-class nsSanePluginFactoryImpl : public nsIPlugin
-{
-public:
-    nsSanePluginFactoryImpl(const nsCID &aClass, const char* className,
-                            const char* contractID);
-
-    // nsISupports methods
-    NS_DECL_ISUPPORTS ;
-
-    // nsIFactory methods
-    NS_IMETHOD CreateInstance(nsISupports *aOuter,
-                              const nsIID &aIID,
-                              void **aResult);
-
-    NS_IMETHOD LockFactory(PRBool aLock);
-    NS_IMETHOD Initialize(void);
-    NS_IMETHOD Shutdown(void);
-    NS_IMETHOD GetMIMEDescription(const char* *result);
-    NS_IMETHOD GetValue(nsPluginVariable variable, void *value);
-    NS_IMETHOD CreatePluginInstance(nsISupports *aOuter, REFNSIID aIID, 
-                                    const char* aPluginMIMEType,
-                                    void **aResult);
-
-protected:
-    virtual ~nsSanePluginFactoryImpl();
-
-  nsCID       mClassID;
-  const char* mClassName;
-  const char* mContractID;
-
-};
-
-#endif // __NS_SANE_PLUGIN_FACTORY_H__
-
-
-
-
-
diff -r f3ac957eb4af modules/plugin/sdk/samples/SanePlugin/nsSanePlugin_CID.h
--- a/modules/plugin/sdk/samples/SanePlugin/nsSanePlugin_CID.h	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,47 +0,0 @@
-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
- *
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org Code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 2001
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-/*
- * Defines the CID for the SANE plugin.
- */
-
-#ifndef __NS_SANE_PLUGIN_CID_H__
-#define __NS_SANE_PLUGIN_CID_H__
-
-#define NS_SANE_PLUGIN_CID { 0x302da841, 0x3dbf, 0x11d3, { 0xbc, 0xfb, 0x0, 0xa0, 0xc9, 0xc8, 0xd9, 0x1d } }
-
-#endif //  __NS_SANE_PLUGIN_CID_H__
diff -r f3ac957eb4af modules/plugin/sdk/samples/SanePlugin/readme.txt
--- a/modules/plugin/sdk/samples/SanePlugin/readme.txt	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,45 +0,0 @@
-What is this plug-in?
----------------------
-
-This is a Linux/Mozilla plug-in that enables a scanner/digital 
-camera application to be created with JavaScript. To this end
-the SANE plug-in provides two things:
-	
-	1. I have attempted to export all of the SANE API's 
-	   from the SANE native libraries to JavaScript.
-           (I have provided two brain-dead samples for a 
-           CPia USB digital camera and HP 6300 scanner.)
-
-	2. A drawing surface for displaying the scanned image. 
-
-=====================================================================
-
-Why did you bother?
-------------------
-
-Originally, I used this plug-in to cut my teeth on the new Mozilla
-XPCom plug-in model.  Now I am hoping to provide a Linux/Mozilla
-plug-in sample that exercises most of the functionality that the 
-Linux community would want to use (like connecting JavaScript
-to native code.) 
-
-=====================================================================
-
-You know, Linux isn't the only UN*X around!
--------------------------------------------
-
-I say Linux because that is the only platform I have built/tested on.
-SANE is supported by a long list of UN*X OS's so there is no reason
-that other platforms shouldn't work with this plug-in.
-
-(I have tried to stick to NSPR functions for this reason, but it's easy
-to over look a couple of Linux specific functions.)
-
-======================================================================
-
-How do I build this beast?
--------------------------
-
-In order to build this plug-in, you need the SANE (Scanner Access
-Now Easy) libraries/headers installed on your system.  For more
-info on SANE, go to http://www.mostang.com/sane.
diff -r f3ac957eb4af modules/plugin/sdk/samples/SanePlugin/test/camera.html
--- a/modules/plugin/sdk/samples/SanePlugin/test/camera.html	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,167 +0,0 @@
-<HTML>
-  <HEAD>
-    <TITLE>CPia Digital Camera Test Application</TITLE>
-  </HEAD>
-  <BODY>
-
-  <P>
-  This is a test page for grabing frames from a USB Cpia camera
-  using the v4l (Video4Linux) SANE module. 
-  </P>
-
-    <TABLE>
-      <TR>
-        <TD>
-          <CENTER>
-            <EMBED type="application/X-sane-plugin"
-	           name="camera"
-                   onScanComplete="ScanCompleteCallback()"
-		   onInitComplete="InitCompleteCallback()"
-                   device="v4l:/dev/video" 
-                   width="400" height="400"
-                   line_width="0" line_style="solid">
-          </CENTER>
-        </TD>
-        <TD>
-          <CENTER>
-
-	    <!-- Start grabbing frames once a second -->
-            <INPUT type="button" onclick="start()" value="Start">
-
-	    <!-- Stop grabbing frames -->
-	    <INPUT type="button" onclick="stop()" value="Stop">
-
-	    <!-- Save the current image to a file -->
-            <INPUT type="button" onclick="save()" value="Save"><BR>
-
-            <input type="button" onclick="doDump()" value="Dump">
-            <input type="button" 
-                   onclick="document.camera.nsISanePluginInstance.ScanImage()"
-                   value="Single Shot">
-          </CENTER>
-        </TD>
-      </TR>
-    </TABLE>
-
-    <input type="text" id="status" size="20">
-    <!--
-    <textarea id="status" rows="20" cols="80"></textarea>
-    -->
-
-  <SCRIPT>
-
-// globals
-var gdelay = 500;
-var multigrab = false;
-var ingrab = false;
-
-function sdump(str)
-{
-    var status = document.getElementById('status');
-    
-    status.value = str;
-    dump(str + "\n");
-}
-
-function doDump()
-{
-  var aCamera = new Object;
-
-  try {
-    aCamera = document.camera.nsISanePluginInstance;
-  
-    sdump("ActiveDevice = " + aCamera.ActiveDevice + "\n" +
-	  "State = " + aCamera.State + "\n" + 
-	  "Quality = " + aCamera.Quality + "\n" + 
-	  "Method = " + aCamera.Method + "\n" + 
-	  "DeviceOptions = " + aCamera.DeviceOptions + "\n" + 
-	  "ImageParameters = " + aCamera.ImageParameters + "\n" + 
-	  "AvailableDevices = " + aCamera.AvailableDevices + "\n");
-  } catch (ex) {
-    sdump("Error trying dump data: " + ex + "\n");
-  }
-}
-
-function grabImage()
-{
-  if (multigrab || ingrab)
-    return;
-
-  try {
-    document.camera.nsISanePluginInstance.ScanImage();
-  } catch (ex) {
-    sdump("Error trying to grab image!\n");
-  }
-}
-
-function save()
-{
-    document.camera.nsISanePluginInstance.SaveImage();
-}
-
-function InitCompleteCallback()
-{
-  try {
-    var aCamera = document.camera.nsISanePluginInstance;
-    
-    aCamera.Quality = 100;
-    aCamera.ScanImage();
-    sdump("Initialization complete!\n");
-  } catch (ex) {
-    sdump("Error trying to set additional device specific parameters!" + ex);
-  }
-}
-
-function ScanCompleteCallback()
-{
-    sdump("Scan Complete!\n");
-
-    ingrab = false;
-    if (multigrab)
-	window.setTimeout("document.camera.nsISanePluginInstance.ScanImage()", 
-			  gdelay);
-}
-
-function stop()
-{
-  multigrab = false;
-}
-
-function start()
-{
-  if (multigrab)
-    return;
-
-  multigrab = true;
-
-  if (!ingrab) {
-      try {
-	  sdump("About to scan image!\n");
-
-	  ingrab = true;
-	  document.camera.nsISanePluginInstance.ScanImage();
-      } catch (ex) {
-	  sdump("Error trying to grab frame!\n" + ex + "\n");
-      }
-  }
-}
-
-    </SCRIPT>
-  </BODY>
-</HTML>
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
diff -r f3ac957eb4af modules/plugin/sdk/samples/SanePlugin/test/scanner.html
--- a/modules/plugin/sdk/samples/SanePlugin/test/scanner.html	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,301 +0,0 @@
-<HTML>
-  <HEAD>
-    <TITLE>Image Scanner Application</TITLE>
-  </HEAD>
-  <BODY>
-    <P>
-    This is a simple test page for the HP 6300C USB scanner. 
-    </P>
-    <TABLE>
-      <TR>
-        <TD>
-          <CENTER>
-            <EMBED type="application/X-sane-plugin"
-	           name="scanner"
-		   onScanComplete="ScanCompleteCallback()"
-		   onInitComplete="InitCompleteCallback()" 
-                   device="hp:/dev/usbscanner" 
-		   width="300" height="413"
-                   line_width="4" line_style="solid">
-          </CENTER>
-        </TD>
-        <TD>
-          <CENTER>
-
-	    <!-- Pan zoom box -->
-            <INPUT type="button" onclick="panRegionVert(-10)" 
-                   value="Pan Up" ><BR>
-            <INPUT type="button" onclick="panRegionHor(-10)"
-	           value="Pan Left" >
-            <INPUT type="button" onclick="panRegionHor(10)" 
-                   value="Pan Right" ><BR>
-            <INPUT type="button" onclick="panRegionVert(10)" 
-                   value="Pan Down" ><BR><BR>
-
-            <!-- Zoom in/out -->
-            <INPUT type="button" onclick="adjustRegion(-10)" 
-                   value="Zoom In" >
-            <INPUT type="button" onclick="adjustRegion(10)"
-	           value="Zoom Out" ><BR><BR>
-
-            <!-- Scanner controls -->
-            <INPUT type="button" onclick="ScanHi()" 
-                   value="Scan Selected Region">
-            <INPUT type="button" onclick="GetPreview()"
-	           value="Preview"><BR>
-            <INPUT type="button" onclick="Save()" 
-                   value="Save Current Image"><br><br>
-
-	    <!-- SANE test -->
-	    <INPUT type="button" onclick="doDump()"
-	           value="Dump">
-
-          </CENTER>
-        </TD>
-      </TR>
-    </TABLE>
-
-    <TEXTAREA id="status" rows="20" cols="80"></TEXTAREA>
-
-
-<SCRIPT>
-
-// globals
-var inscan = true;
-var br_x = 0, br_y = 0, tl_x = 0, tl_y = 0;
-var max_br_x = 0, max_br_y = 0;
-var last_br_x, last_br_y, last_tl_x, last_tl_y;
-
-function sdump(str)
-{
-    var status = document.getElementById('status');
-    
-    status.value = str;
-    dump(str + "\n");
-}
-
-function doDump()
-{
-    try {
-	var aScanner = document.scanner.nsISanePluginInstance;
-  	sdump("ActiveDevice = " + aScanner.ActiveDevice + "\n" +
-	      "State = " + aScanner.State + "\n" + 
-	      "Quality = " + aScanner.Quality + "\n" + 
-	      "Method = " + aScanner.Method + "\n" + 
-	      "DeviceOptions = " + aScanner.DeviceOptions + "\n" + 
-	      "ImageParameters = " + aScanner.ImageParameters + "\n" + 
-	      "AvailableDevices = " + aScanner.AvailableDevices + "\n");  
-    } catch (ex) {
-	sdump("Error trying to dump: \n" + ex + "\n");
-    }
-}
-
-function adjustRegion(factor) {
-    try {
-	var aScanner = document.scanner.nsISanePluginInstance;
-	var x, y, height, width;
-	x = aScanner.ZoomX;
-	y = aScanner.ZoomY;
-
-
-	width = aScanner.ZoomWidth 
-	    + factor;
-	height = Math.floor(width * 413/300);
-
-	aScanner.Crop(x, y, width, height);
-    } catch (ex) {
-	dump("Unable to zoom by " + factor + "\n" + ex + "\n");
-    }
-}
-
-function panRegionHor(factor) {
-  try {
-      var x, y, height, width;
-      var aScanner = document.scanner.nsISanePluginInstance;
-
-      if (aScanner.ZoomX + factor < 0) 
-	  x = aScanner.ZoomX;
-      else
-	  x = aScanner.ZoomX + factor;
-
-
-      y = aScanner.ZoomY;
-      width = aScanner.ZoomWidth;
-      height = aScanner.ZoomHeight;
-
-      aScanner.Crop(x, y, width, height);
-  } catch (ex) {
-      dump("Unable to pan to requested location!\n");
-  }
-}
-
-function panRegionVert(factor) {
-  try {
-      var x, y, height, width;
-      var aScanner = document.scanner.nsISanePluginInstance;
-
-      if (aScanner.ZoomY + factor < 0) 
-	  y = aScanner.ZoomY;
-      else
-	  y = aScanner.ZoomY + factor;
-      
-      x = aScanner.ZoomX;
-      width = aScanner.ZoomWidth;
-      height = aScanner.ZoomHeight;
-
-      aScanner.Crop(x, y, width, height);
-  } catch (ex) {
-      dump("Unable to pan to requested location!\n");
-  }
-}
-
-function Save() {
-    try {
-      var aScanner = document.scanner.nsISanePluginInstance;
-
-      aScanner.SaveImage();
-    } catch (ex) {
-	dump("Error trying to save current image!\n");
-    }
-}
-
-function GetPreview()
-{
-  if (inscan)
-    return;
-
-  try {
-      var aScanner = document.scanner.nsISanePluginInstance;
-
-      // Reset scan area for entire bed
-      tl_x = tl_y = 0;
-      br_x = max_br_x;
-      br_y = max_br_y;
-      aScanner.SetOption("tl-x", tl_x.toString(10));
-      aScanner.SetOption("tl-y", tl_y.toString(10));
-      aScanner.SetOption("br-x", br_x.toString(10));
-      aScanner.SetOption("br-y", br_y.toString(10));
-
-      // Set the lowest resolution the HP ScanJet 6300C supports
-      aScanner.SetOption("mode", "Color");
-      aScanner.SetOption("resolution", "12");
-      
-      inscan = true;
-      aScanner.ScanImage();
-
-      // Scanning is a threaded function, so getting here 
-      // only means that a scan operation was successfully started.
-  } catch (ex) {
-    dump("Error trying to get preview image!");
-  }
-}
-
-function ScanHi()
-{
-    if (inscan)
-	return;
-
-    try {
-	var aScanner = document.scanner.nsISanePluginInstance;
-
-	// store last scan area coordinates
-	// so that Restore() knows what scan
-	// area coordinates to restore to.
-	last_br_x = br_x;
-	last_br_y = br_y;
-	last_tl_x = tl_x;
-	last_tl_y = tl_y;
-
-	// factors used in converting from zoom box
-	// to scanner coordinates
-	var xfactor = last_br_x/300;
-	var yfactor = last_br_y/413;
-
-	// zoom box coordinates
-	var z_br_x = aScanner.ZoomWidth + aScanner.ZoomX;
-	var z_br_y = aScanner.ZoomHeight + aScanner.ZoomY;
-	var z_tl_x = aScanner.ZoomX;
-	var z_tl_y = aScanner.ZoomY;
-
-	br_x = Math.floor(z_br_x * xfactor);
-	br_y = Math.floor(z_br_y * yfactor);
-	tl_x = Math.floor((z_tl_x * xfactor) + last_tl_x);
-	tl_y = Math.floor((z_tl_y * yfactor) + last_tl_y);
-
-	last_br_x = br_x;
-	last_br_y = br_y;
-	last_tl_x = tl_x;
-	last_tl_y = tl_y;
-
-	// set the scan area for zoom box
-	aScanner.SetOption("tl-x", tl_x);
-	aScanner.SetOption("tl-y", tl_y);
-	aScanner.SetOption("br-x", br_x);
-	aScanner.SetOption("br-y", br_y);
-
-	// For speed of testing, high resolution is set to 
-	// just 150dpi
-	aScanner.SetOption("resolution", "150");
-
-	inscan = true;
-	aScanner.ScanImage();
-
-	// Scanning is a threaded operation so getting here
-	// only means that we have successfully started a scan.
-    } catch (ex) {
-	dump("Error trying to scan at 150!\n"+ ex + "\n");
-    }
-}
-
-function ScanCompleteCallback()
-{
-    inscan = false;
-    dump("Completed Scan!\n");
-}
-
-function InitCompleteCallback()
-{
-    // Additional device specific initialization
-    try {
-	var aScanner = document.scanner.nsISanePluginInstance;
-
-	// Reset scan area for entire bed
-	tl_x = tl_y = 0;
-	br_x = max_br_x;
-	br_y = max_br_y;
-	aScanner.SetOption("tl-x", tl_x.toString(10));
-	aScanner.SetOption("tl-y", tl_y.toString(10));
-	aScanner.SetOption("br-x", br_x.toString(10));
-	aScanner.SetOption("br-y", br_y.toString(10));
-	
-	// this particular scan seems to scan in a
-	// a little dark by default
-	aScanner.SetOption("brightness", "30");
-	aScanner.SetOption("contrast", "10");
-	aScanner.Quality = 80;
-	aScanner.Method = "FAST";
-	aScanner.SetOption("mode", "Color");
-
-	// Set the maximum bottom x and bottom y
-	// for the HP ScanJet 6300C
-	last_br_x = br_x = max_br_x = 14141852;
-	last_br_y = br_y = max_br_y = 19456836;
-	last_tl_x = tl_x;
-	last_tl_y = tl_y;
-
-	inscan = false;
-    } catch (ex) {
-	dump("Error trying to set device specific initialization!\n");
-    }
-}
-
-    </SCRIPT>
-  </BODY>
-</HTML>
-
-
-
-
-
-
-
diff -r f3ac957eb4af modules/plugin/sdk/samples/basic/mac/Basic Plugin.mcp
Binary file modules/plugin/sdk/samples/basic/mac/Basic Plugin.mcp has changed
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/mac/Scriptable Plugin.mcp
Binary file modules/plugin/sdk/samples/scriptable/mac/Scriptable Plugin.mcp has changed
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/mac/Scriptable PluginIDL.mcp
Binary file modules/plugin/sdk/samples/scriptable/mac/Scriptable PluginIDL.mcp has changed
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/mac/Scriptable.rsrc
Binary file modules/plugin/sdk/samples/scriptable/mac/Scriptable.rsrc has changed
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/mac/nsIScriptablePluginSample.idl
--- a/modules/plugin/sdk/samples/scriptable/mac/nsIScriptablePluginSample.idl	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,45 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-
- *
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 2001
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#include "nsISupports.idl"
-
-[scriptable, uuid(d2d536a0-b6fc-11d5-9d10-0060b0fbd8ac)]
-interface nsIScriptablePluginSample : nsISupports {
-  void showVersion();
-  void clear();
-};
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/mac/nsScriptablePeer.cpp
--- a/modules/plugin/sdk/samples/scriptable/mac/nsScriptablePeer.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,132 +0,0 @@
-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
-/* ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 1998
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-// ==============================
-// ! Scriptability related code !
-// ==============================
-
-/////////////////////////////////////////////////////
-//
-// This file implements the nsScriptablePeer object
-// The native methods of this class are supposed to
-// be callable from JavaScript
-//
-#include "plugin.h"
-
-static NS_DEFINE_IID(kIScriptableIID, NS_ISCRIPTABLEPLUGINSAMPLE_IID);
-static NS_DEFINE_IID(kIClassInfoIID, NS_ICLASSINFO_IID);
-static NS_DEFINE_IID(kISupportsIID, NS_ISUPPORTS_IID);
-
-nsScriptablePeer::nsScriptablePeer(nsPluginInstance* aPlugin)
-{
-  mPlugin = aPlugin;
-  mRefCnt = 0;
-}
-
-nsScriptablePeer::~nsScriptablePeer()
-{
-}
-
-// AddRef, Release and QueryInterface are common methods and must 
-// be implemented for any interface
-NS_IMETHODIMP_(nsrefcnt) nsScriptablePeer::AddRef() 
-{ 
-  ++mRefCnt; 
-  return mRefCnt; 
-} 
-
-NS_IMETHODIMP_(nsrefcnt) nsScriptablePeer::Release() 
-{ 
-  --mRefCnt; 
-  if (mRefCnt == 0) { 
-    delete this;
-    return 0; 
-  } 
-  return mRefCnt; 
-} 
-
-// here nsScriptablePeer should return three interfaces it can be asked for by their iid's
-// static casts are necessary to ensure that correct pointer is returned
-NS_IMETHODIMP nsScriptablePeer::QueryInterface(const nsIID& aIID, void** aInstancePtr) 
-{ 
-  if(!aInstancePtr) 
-    return NS_ERROR_NULL_POINTER; 
-
-  if(aIID.Equals(kIScriptableIID)) {
-    *aInstancePtr = static_cast<nsIScriptablePluginSample*>(this); 
-    AddRef();
-    return NS_OK;
-  }
-
-  if(aIID.Equals(kIClassInfoIID)) {
-    *aInstancePtr = static_cast<nsIClassInfo*>(this); 
-    AddRef();
-    return NS_OK;
-  }
-
-  if(aIID.Equals(kISupportsIID)) {
-    *aInstancePtr = static_cast<nsISupports*>(static_cast<nsIScriptablePluginSample*>(this)); 
-    AddRef();
-    return NS_OK;
-  }
-
-  return NS_NOINTERFACE; 
-}
-
-void nsScriptablePeer::SetInstance(nsPluginInstance* plugin)
-{
-  mPlugin = plugin;
-}
-
-//
-// the following methods will be callable from JavaScript
-//
-NS_IMETHODIMP nsScriptablePeer::ShowVersion()
-{
-  if (mPlugin)
-    mPlugin->showVersion();
-
-  return NS_OK;
-}
-
-NS_IMETHODIMP nsScriptablePeer::Clear()
-{
-  if (mPlugin)
-    mPlugin->clear();
-
-  return NS_OK;
-}
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/mac/nsScriptablePeer.h
--- a/modules/plugin/sdk/samples/scriptable/mac/nsScriptablePeer.h	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,108 +0,0 @@
-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
-/* ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 1998
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-// ==============================
-// ! Scriptability related code !
-// ==============================
-//
-// nsScriptablePeer - xpconnect scriptable peer
-//
-
-#ifndef __nsScriptablePeer_h__
-#define __nsScriptablePeer_h__
-
-#include "nsIScriptablePluginSample.h"
-#include "nsIClassInfo.h"
-#include "nsIProgrammingLanguage.h"
-
-class nsPluginInstance;
-
-// We must implement nsIClassInfo because it signals the
-// Mozilla Security Manager to allow calls from JavaScript.
-
-class nsClassInfoMixin : public nsIClassInfo
-{
-  // These flags are used by the DOM and security systems to signal that 
-  // JavaScript callers are allowed to call this object's scritable methods.
-  NS_IMETHOD GetFlags(PRUint32 *aFlags)
-    {*aFlags = nsIClassInfo::PLUGIN_OBJECT | nsIClassInfo::DOM_OBJECT;
-     return NS_OK;}
-  NS_IMETHOD GetImplementationLanguage(PRUint32 *aImplementationLanguage)
-    {*aImplementationLanguage = nsIProgrammingLanguage::CPLUSPLUS;
-     return NS_OK;}
-  // The rest of the methods can safely return error codes...
-  NS_IMETHOD GetInterfaces(PRUint32 *count, nsIID * **array)
-    {return NS_ERROR_NOT_IMPLEMENTED;}
-  NS_IMETHOD GetHelperForLanguage(PRUint32 language, nsISupports **_retval)
-    {return NS_ERROR_NOT_IMPLEMENTED;}
-  NS_IMETHOD GetContractID(char * *aContractID)
-    {return NS_ERROR_NOT_IMPLEMENTED;}
-  NS_IMETHOD GetClassDescription(char * *aClassDescription)
-    {return NS_ERROR_NOT_IMPLEMENTED;}
-  NS_IMETHOD GetClassID(nsCID * *aClassID)
-    {return NS_ERROR_NOT_IMPLEMENTED;}
-  NS_IMETHOD GetClassIDNoAlloc(nsCID *aClassIDNoAlloc)
-    {return NS_ERROR_NOT_IMPLEMENTED;}
-};
-
-class nsScriptablePeer : public nsIScriptablePluginSample,
-                         public nsClassInfoMixin
-{
-public:
-  nsScriptablePeer(nsPluginInstance* plugin);
-  ~nsScriptablePeer();
-
-public:
-  // methods from nsISupports
-  NS_IMETHOD QueryInterface(const nsIID& aIID, void** aInstancePtr); 
-  NS_IMETHOD_(nsrefcnt) AddRef(); 
-  NS_IMETHOD_(nsrefcnt) Release(); 
-
-protected: 
-  nsrefcnt mRefCnt;  
-
-public:
-  // native methods callable from JavaScript
-  NS_DECL_NSISCRIPTABLEPLUGINSAMPLE
-
-  void SetInstance(nsPluginInstance* plugin);
-
-protected:
-  nsPluginInstance* mPlugin;
-};
-
-#endif
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/mac/plugin.cpp
--- a/modules/plugin/sdk/samples/scriptable/mac/plugin.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,379 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
-/* ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 1998
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#include "plugin.h"
-#include "nsISupportsUtils.h" // some usefule macros are defined here
-
-#include <string.h>
-
-#if !TARGET_API_MAC_CARBON
-extern QDGlobals*	gQDPtr;
-#endif
-
-//////////////////////////////////////
-//
-// general initialization and shutdown
-//
-NPError NS_PluginInitialize()
-{
-  return NPERR_NO_ERROR;
-}
-
-void NS_PluginShutdown()
-{
-}
-
-/////////////////////////////////////////////////////////////
-//
-// construction and destruction of our plugin instance object
-//
-nsPluginInstanceBase * NS_NewPluginInstance(nsPluginCreateData * aCreateDataStruct)
-{
-  if(!aCreateDataStruct)
-    return NULL;
-
-  nsPluginInstance * plugin = new nsPluginInstance(aCreateDataStruct->instance);
-  return plugin;
-}
-
-void NS_DestroyPluginInstance(nsPluginInstanceBase * aPlugin)
-{
-  if(aPlugin)
-    delete (nsPluginInstance *)aPlugin;
-}
-
-////////////////////////////////////////
-//
-// nsPluginInstance class implementation
-//
-nsPluginInstance::nsPluginInstance(NPP aInstance) : nsPluginInstanceBase(),
-  mInstance(aInstance),
-  mInitialized(FALSE),
-  mScriptablePeer(NULL)
-{
-  mWindow = NULL;
-  mString[0] = '\0';
-}
-
-nsPluginInstance::~nsPluginInstance()
-{
-  // mScriptablePeer may be also held by the browser 
-  // so releasing it here does not guarantee that it is over
-  // we should take precaution in case it will be called later
-  // and zero its mPlugin member
-  if (mScriptablePeer) {
-    mScriptablePeer->SetInstance(NULL);
-    NS_RELEASE(mScriptablePeer);
-  }
-}
-
-NPBool nsPluginInstance::init(NPWindow* aWindow)
-{
-  if(aWindow == NULL)
-    return FALSE;
-  
-  mWindow = aWindow;
-  mInitialized = TRUE;
-  mSaveClip = NewRgn();
-  return TRUE;
-}
-
-void nsPluginInstance::shut()
-{
-  mWindow = NULL;
-  mInitialized = FALSE;
-}
-
-NPBool nsPluginInstance::isInitialized()
-{
-  return mInitialized;
-}
-
-/////////////////////////////////////////////////////////////
-//
-// DrawString
-//
-void
-nsPluginInstance::DrawString(const unsigned char* text, 
-                             short width, 
-                             short height, 
-                             short centerX, 
-                             Rect drawRect)
-{
-	short length, textHeight, textWidth;
- 
-	if(text == NULL)
-		return;
-	
-	length = strlen((char*)text);
-	TextFont(1);
-	TextFace(bold);
-	TextMode(srcCopy);
-	TextSize(12);
-	
-	FontInfo fontInfo;
-	GetFontInfo(&fontInfo);
-
-	textHeight = fontInfo.ascent + fontInfo.descent + fontInfo.leading;
-	textWidth = TextWidth(text, 0, length);
-		
-	if (width > textWidth && height > textHeight)
-	{
-		MoveTo(centerX - (textWidth >> 1), height >> 1);
-		DrawText(text, 0, length);
-	}		
-}
-
-/////////////////////////////////////////////////////////////
-//
-// DoDraw - paint
-//
-void 
-nsPluginInstance::DoDraw(void)
-{
-	Rect drawRect;
-  RGBColor	black = { 0x0000, 0x0000, 0x0000 };
-  RGBColor	white = { 0xFFFF, 0xFFFF, 0xFFFF };
-	SInt32		height = mWindow->height;
-	SInt32		width = mWindow->width;
-	SInt32		centerX = (width) >> 1;
-	SInt32		centerY = (height) >> 1;
-
-	UInt8		*pTheText = (unsigned char*) mString;
-
-	drawRect.top = 0;
-	drawRect.left = 0;
-	drawRect.bottom = drawRect.top + height;
-	drawRect.right = drawRect.left + width;
-
-  PenNormal();
-  RGBForeColor(&black);
-  RGBBackColor(&white);
-
-#if !TARGET_API_MAC_CARBON
-  FillRect(&drawRect, &(gQDPtr->white));
-#else
-  Pattern qdWhite;
-  FillRect(&drawRect, GetQDGlobalsWhite(&qdWhite));
-#endif
-
-	FrameRect(&drawRect);
-  DrawString(pTheText, width, height, centerX, drawRect);
-}
-
-/////////////////////////////////////////////////////////////
-//
-// SetWindow
-//
-NPError
-nsPluginInstance::SetWindow(NPWindow* window)
-{
-	mWindow = window;
-	if( StartDraw(window) ) {
-		DoDraw();
-		EndDraw(window);
-	}
-	return NPERR_NO_ERROR;
-}
-
-/////////////////////////////////////////////////////////////
-//
-// HandleEvent
-//
-uint16
-nsPluginInstance::HandleEvent(void* event)
-{
-	int16 eventHandled = FALSE;
-	
-	EventRecord* ev = (EventRecord*) event;
-	if (event != NULL)
-	{
-		switch (ev->what)
-		{
-			/*
-			 * Draw ourselves on update events
-			 */
-			case updateEvt:
-				if( StartDraw(mWindow) ) {
-					DoDraw();
-					EndDraw(mWindow);
-				}
-				eventHandled = true;
-				break;
-
-			default:
-				break;
-		}
-	}
-	return eventHandled;
-}
-
-/////////////////////////////////////////////////////////////
-//
-// StartDraw - setup port state
-//
-NPBool
-nsPluginInstance::StartDraw(NPWindow* window)
-{
-	if (mWindow == NULL)
-		return false;
-		
-	NP_Port* npport = (NP_Port*) mWindow->window;
-	CGrafPtr ourPort = npport->port;
-	
-	if (mWindow->clipRect.left < mWindow->clipRect.right)
-	{
-		GetPort(&mSavePort);
-		SetPort((GrafPtr) ourPort);
-    Rect portRect;
-#if !TARGET_API_MAC_CARBON
-    portRect = ourPort->portRect;
-#else
-    GetPortBounds(ourPort, &portRect);
-#endif
-		mSavePortTop = portRect.top;
-		mSavePortLeft = portRect.left;
-		GetClip(mSaveClip);
-		
-		mRevealedRect.top = mWindow->clipRect.top + npport->porty;
-		mRevealedRect.left = mWindow->clipRect.left + npport->portx;
-		mRevealedRect.bottom = mWindow->clipRect.bottom + npport->porty;
-		mRevealedRect.right = mWindow->clipRect.right + npport->portx;
-		SetOrigin(npport->portx, npport->porty);
-		ClipRect(&mRevealedRect);
-
-		return true;
-	}
-	else
-		return false;
-}
-
-/////////////////////////////////////////////////////////////
-//
-// EndDraw - restore port state
-//
-void
-nsPluginInstance::EndDraw(NPWindow* window)
-{
-	SetOrigin(mSavePortLeft, mSavePortTop);
-	SetClip(mSaveClip);
-	SetPort(mSavePort);
-}
-
-
-// this will force to draw a version string in the plugin window
-void nsPluginInstance::showVersion()
-{
-  const char *ua = NPN_UserAgent(mInstance);
-  strcpy(mString, ua);
-
-  StartDraw(mWindow);
-  DoDraw();
-  EndDraw(mWindow);
-}
-
-// this will clean the plugin window
-void nsPluginInstance::clear()
-{
-  strcpy(mString, "");
-
-  StartDraw(mWindow);
-  DoDraw();
-  EndDraw(mWindow);
-}
-
-// ==============================
-// ! Scriptability related code !
-// ==============================
-//
-// here the plugin is asked by Mozilla to tell if it is scriptable
-// we should return a valid interface id and a pointer to 
-// nsScriptablePeer interface which we should have implemented
-// and which should be defined in the corressponding *.xpt file
-// in the bin/components folder
-NPError	nsPluginInstance::GetValue(NPPVariable aVariable, void *aValue)
-{
-  NPError rv = NPERR_NO_ERROR;
-
-  switch (aVariable) {
-    case NPPVpluginScriptableInstance: {
-      // addref happens in getter, so we don't addref here
-      nsIScriptablePluginSample * scriptablePeer = getScriptablePeer();
-      if (scriptablePeer) {
-        *(nsISupports **)aValue = scriptablePeer;
-      } else
-        rv = NPERR_OUT_OF_MEMORY_ERROR;
-    }
-    break;
-
-    case NPPVpluginScriptableIID: {
-      static nsIID scriptableIID = NS_ISCRIPTABLEPLUGINSAMPLE_IID;
-      nsIID* ptr = (nsIID *)NPN_MemAlloc(sizeof(nsIID));
-      if (ptr) {
-          *ptr = scriptableIID;
-          *(nsIID **)aValue = ptr;
-      } else
-        rv = NPERR_OUT_OF_MEMORY_ERROR;
-    }
-    break;
-
-    default:
-      break;
-  }
-
-  return rv;
-}
-
-// ==============================
-// ! Scriptability related code !
-// ==============================
-//
-// this method will return the scriptable object (and create it if necessary)
-nsScriptablePeer* nsPluginInstance::getScriptablePeer()
-{
-  if (!mScriptablePeer) {
-    mScriptablePeer = new nsScriptablePeer(this);
-    if(!mScriptablePeer)
-      return NULL;
-
-    NS_ADDREF(mScriptablePeer);
-  }
-
-  // add reference for the caller requesting the object
-  NS_ADDREF(mScriptablePeer);
-  return mScriptablePeer;
-}
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/mac/plugin.h
--- a/modules/plugin/sdk/samples/scriptable/mac/plugin.h	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,82 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
-/* ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 1998
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#ifndef __PLUGIN_H__
-#define __PLUGIN_H__
-
-#include "pluginbase.h"
-#include "nsScriptablePeer.h"
-
-class nsPluginInstance : public nsPluginInstanceBase
-{
-public:
-  nsPluginInstance(NPP aInstance);
-  ~nsPluginInstance();
-
-  NPBool init(NPWindow* aWindow);
-  void shut();
-  NPBool isInitialized();
-  NPError SetWindow(NPWindow* pNPWindow);
-  uint16  HandleEvent(void* event);
-  NPError	GetValue(NPPVariable variable, void *value);
-
-  void showVersion();
-  void clear();
-  nsScriptablePeer* getScriptablePeer();  
-
-  char mString[128];
-
-private:
-  // locals
-  void DoDraw();
-  NPBool StartDraw(NPWindow* window);
-  void EndDraw(NPWindow* window);
-  void DrawString(const unsigned char* text, short width, short height, short centerX, Rect drawRect);
-
-  nsScriptablePeer * mScriptablePeer;
-  
-  NPWindow * mWindow;
-  NPP mInstance;
-  NPBool mInitialized;
-  GrafPtr mSavePort;
-  RgnHandle mSaveClip;
-  Rect mRevealedRect;
-  short mSavePortTop;
-  short mSavePortLeft;
-};
-
-#endif // __PLUGIN_H__
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/mac/pluginCarbonPrefix.h
--- a/modules/plugin/sdk/samples/scriptable/mac/pluginCarbonPrefix.h	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,41 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-
- *
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 1998
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#define XP_MAC 1
-#define TARGET_CARBON 1
-#define MOZILLA_STRICT_API
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/mac/pluginPrefix.h
--- a/modules/plugin/sdk/samples/scriptable/mac/pluginPrefix.h	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,40 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-
- *
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 1998
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#define XP_MAC 1
-#define MOZILLA_STRICT_API
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/readme.txt
--- a/modules/plugin/sdk/samples/scriptable/readme.txt	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,3 +0,0 @@
-Scriptable Plugin
-
-This sample plugin can be scripted, JavaScript can call into the plugin via NPRuntime.
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/test.html
--- a/modules/plugin/sdk/samples/scriptable/test.html	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,48 +0,0 @@
-<HTML>
-<HEAD>
-<TITLE>4x Scriptable Plug-in Test</TITLE>
-</HEAD>
-<BODY>
-
-<center>
-<h1> XPConnect Scriptable Sample Plug-in </h1>
-</center>
-
-This page contains a test case which demonstrates the work of scriptable plug-in 
-with Mozilla. The example plug-in occupies the area right below this text,
-and you should see a frame the plug-in draws around its window. Below the plug-in window 
-there are two buttons. Clicking on the buttons will result in calling native plugin 
-methods from JavaScript. Show Version will instruct the plug-in to retrieve the 
-Mozilla user agent string and display it in the plug-in window, Clear button will
-call plug-in method to erase the window.
-
-<br><br>
-
-<center>
-
-<embed type="application/scriptable-plugin" width=600 height=40><br>
-
-<script>
-var embed = document.embeds[0];
-
-function ShowVersion()
-{
-  embed.showVersion();
-}
-
-function Clear()
-{
-  embed.clear();
-}
-</script>
-
-<br>
-<form name="formname">
-<input type=button value="Show Version" onclick='ShowVersion()'>
-<input type=button value="Clear" onclick='Clear()'>
-</form>
-
-</center>
-
-</BODY>
-</HTML>
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/unix/Makefile.in
--- a/modules/plugin/sdk/samples/scriptable/unix/Makefile.in	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,83 +0,0 @@
-#
-# ***** BEGIN LICENSE BLOCK *****
-# Version: MPL 1.1/GPL 2.0/LGPL 2.1
-#
-# The contents of this file are subject to the Mozilla Public License Version
-# 1.1 (the "License"); you may not use this file except in compliance with
-# the License. You may obtain a copy of the License at
-# http://www.mozilla.org/MPL/
-#
-# Software distributed under the License is distributed on an "AS IS" basis,
-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
-# for the specific language governing rights and limitations under the
-# License.
-#
-# The Original Code is mozilla.org code.
-#
-# The Initial Developer of the Original Code is
-# Netscape Communications Corporation.
-# Portions created by the Initial Developer are Copyright (C) 1998
-# the Initial Developer. All Rights Reserved.
-#
-# Contributor(s):
-#
-# Alternatively, the contents of this file may be used under the terms of
-# either the GNU General Public License Version 2 or later (the "GPL"), or
-# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
-# in which case the provisions of the GPL or the LGPL are applicable instead
-# of those above. If you wish to allow use of your version of this file only
-# under the terms of either the GPL or the LGPL, and not to allow others to
-# use your version of this file under the terms of the MPL, indicate your
-# decision by deleting the provisions above and replace them with the notice
-# and other provisions required by the GPL or the LGPL. If you do not delete
-# the provisions above, a recipient may use your version of this file under
-# the terms of any one of the MPL, the GPL or the LGPL.
-#
-# ***** END LICENSE BLOCK *****
-
-DEPTH		= ../../../../../..
-topsrcdir	= @top_srcdir@
-srcdir		= @srcdir@
-VPATH		= @srcdir@
-
-include $(DEPTH)/config/autoconf.mk
-
-MODULE		= npSDKscriptable
-LIBRARY_NAME	= npSDKscriptable
-
-REQUIRES        = idl \
-                  xpcom \
-                  nspr \
-                  $(NULL)
-
-CPPSRCS         = plugin.cpp \
-		  nsScriptablePeer.cpp
-
-XPIDLSRCS 	= nsIScriptablePluginSample.idl 
-
-SHARED_LIBRARY_LIBS = $(DIST)/lib/libplugingate_s.$(LIB_SUFFIX)
-
-include $(topsrcdir)/config/rules.mk
-
-DEFINES += -DMOZILLA_STRICT_API
-
-EXTRA_DSO_LDOPTS +=  $(XLDFLAGS) -rdynamic  -lXi -lXext -lX11 -lm -lXt
-
-INSTALL_PLUGIN	= $(CONFIG_TOOLS)/nsinstall -R 
-INSTALL = true
-
-ifeq ($(OS_ARCH), UNIX)
-# This needs to get defined for npapi.h on unix platforms.
-DEFINES		+= -DXP_UNIX
-endif
-
-LOCAL_INCLUDES	+= -I$(srcdir)/$(XPIDL_GEN_DIR) -I$(srcdir)/../../include -I$(srcdir)/../../../include
-
-install-plugin:	$(SHARED_LIBRARY)
-	$(INSTALL_PLUGIN) $(IFLAGS1) $(XPIDL_GEN_DIR)/$(XPIDL_MODULE).xpt $(DIST)/bin/plugins
-ifdef SHARED_LIBRARY
-	$(INSTALL_PLUGIN) $(SHARED_LIBRARY) $(DIST)/bin/plugins
-endif
-
-libs:: install-plugin
-
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/unix/nsIScriptablePluginSample.idl
--- a/modules/plugin/sdk/samples/scriptable/unix/nsIScriptablePluginSample.idl	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,45 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-
- *
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 2001
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#include "nsISupports.idl"
-
-[scriptable, uuid(d2d536a0-b6fc-11d5-9d10-0060b0fbd8ac)]
-interface nsIScriptablePluginSample : nsISupports {
-  void showVersion();
-  void clear();
-};
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/unix/nsScriptablePeer.cpp
--- a/modules/plugin/sdk/samples/scriptable/unix/nsScriptablePeer.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,132 +0,0 @@
-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
-/* ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 1998
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-// ==============================
-// ! Scriptability related code !
-// ==============================
-
-/////////////////////////////////////////////////////
-//
-// This file implements the nsScriptablePeer object
-// The native methods of this class are supposed to
-// be callable from JavaScript
-//
-#include "plugin.h"
-
-static NS_DEFINE_IID(kIScriptableIID, NS_ISCRIPTABLEPLUGINSAMPLE_IID);
-static NS_DEFINE_IID(kIClassInfoIID, NS_ICLASSINFO_IID);
-static NS_DEFINE_IID(kISupportsIID, NS_ISUPPORTS_IID);
-
-nsScriptablePeer::nsScriptablePeer(nsPluginInstance* aPlugin)
-{
-  mPlugin = aPlugin;
-  mRefCnt = 0;
-}
-
-nsScriptablePeer::~nsScriptablePeer()
-{
-}
-
-// AddRef, Release and QueryInterface are common methods and must 
-// be implemented for any interface
-NS_IMETHODIMP_(nsrefcnt) nsScriptablePeer::AddRef() 
-{ 
-  ++mRefCnt; 
-  return mRefCnt; 
-} 
-
-NS_IMETHODIMP_(nsrefcnt) nsScriptablePeer::Release() 
-{ 
-  --mRefCnt; 
-  if (mRefCnt == 0) { 
-    delete this;
-    return 0; 
-  } 
-  return mRefCnt; 
-} 
-
-// here nsScriptablePeer should return three interfaces it can be asked for by their iid's
-// static casts are necessary to ensure that correct pointer is returned
-NS_IMETHODIMP nsScriptablePeer::QueryInterface(const nsIID& aIID, void** aInstancePtr) 
-{ 
-  if(!aInstancePtr) 
-    return NS_ERROR_NULL_POINTER; 
-
-  if(aIID.Equals(kIScriptableIID)) {
-    *aInstancePtr = static_cast<nsIScriptablePluginSample*>(this); 
-    AddRef();
-    return NS_OK;
-  }
-
-  if(aIID.Equals(kIClassInfoIID)) {
-    *aInstancePtr = static_cast<nsIClassInfo*>(this); 
-    AddRef();
-    return NS_OK;
-  }
-
-  if(aIID.Equals(kISupportsIID)) {
-    *aInstancePtr = static_cast<nsISupports*>(static_cast<nsIScriptablePluginSample*>(this)); 
-    AddRef();
-    return NS_OK;
-  }
-
-  return NS_NOINTERFACE; 
-}
-
-void nsScriptablePeer::SetInstance(nsPluginInstance* plugin)
-{
-  mPlugin = plugin;
-}
-
-//
-// the following methods will be callable from JavaScript
-//
-NS_IMETHODIMP nsScriptablePeer::ShowVersion()
-{
-  if (mPlugin)
-    mPlugin->showVersion();
-
-  return NS_OK;
-}
-
-NS_IMETHODIMP nsScriptablePeer::Clear()
-{
-  if (mPlugin)
-    mPlugin->clear();
-
-  return NS_OK;
-}
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/unix/nsScriptablePeer.h
--- a/modules/plugin/sdk/samples/scriptable/unix/nsScriptablePeer.h	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,108 +0,0 @@
-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
-/* ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 1998
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-// ==============================
-// ! Scriptability related code !
-// ==============================
-//
-// nsScriptablePeer - xpconnect scriptable peer
-//
-
-#ifndef __nsScriptablePeer_h__
-#define __nsScriptablePeer_h__
-
-#include "nsIScriptablePluginSample.h"
-#include "nsIClassInfo.h"
-#include "nsIProgrammingLanguage.h"
-
-class nsPluginInstance;
-
-// We must implement nsIClassInfo because it signals the
-// Mozilla Security Manager to allow calls from JavaScript.
-
-class nsClassInfoMixin : public nsIClassInfo
-{
-  // These flags are used by the DOM and security systems to signal that 
-  // JavaScript callers are allowed to call this object's scritable methods.
-  NS_IMETHOD GetFlags(PRUint32 *aFlags)
-    {*aFlags = nsIClassInfo::PLUGIN_OBJECT | nsIClassInfo::DOM_OBJECT;
-     return NS_OK;}
-  NS_IMETHOD GetImplementationLanguage(PRUint32 *aImplementationLanguage)
-    {*aImplementationLanguage = nsIProgrammingLanguage::CPLUSPLUS;
-     return NS_OK;}
-  // The rest of the methods can safely return error codes...
-  NS_IMETHOD GetInterfaces(PRUint32 *count, nsIID * **array)
-    {return NS_ERROR_NOT_IMPLEMENTED;}
-  NS_IMETHOD GetHelperForLanguage(PRUint32 language, nsISupports **_retval)
-    {return NS_ERROR_NOT_IMPLEMENTED;}
-  NS_IMETHOD GetContractID(char * *aContractID)
-    {return NS_ERROR_NOT_IMPLEMENTED;}
-  NS_IMETHOD GetClassDescription(char * *aClassDescription)
-    {return NS_ERROR_NOT_IMPLEMENTED;}
-  NS_IMETHOD GetClassID(nsCID * *aClassID)
-    {return NS_ERROR_NOT_IMPLEMENTED;}
-  NS_IMETHOD GetClassIDNoAlloc(nsCID *aClassIDNoAlloc)
-    {return NS_ERROR_NOT_IMPLEMENTED;}
-};
-
-class nsScriptablePeer : public nsIScriptablePluginSample,
-                         public nsClassInfoMixin
-{
-public:
-  nsScriptablePeer(nsPluginInstance* plugin);
-  virtual ~nsScriptablePeer();
-
-public:
-  // methods from nsISupports
-  NS_IMETHOD QueryInterface(const nsIID& aIID, void** aInstancePtr); 
-  NS_IMETHOD_(nsrefcnt) AddRef(); 
-  NS_IMETHOD_(nsrefcnt) Release(); 
-
-protected: 
-  nsrefcnt mRefCnt;  
-
-public:
-  // native methods callable from JavaScript
-  NS_DECL_NSISCRIPTABLEPLUGINSAMPLE
-
-  void SetInstance(nsPluginInstance* plugin);
-
-protected:
-  nsPluginInstance* mPlugin;
-};
-
-#endif
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/unix/plugin.cpp
--- a/modules/plugin/sdk/samples/scriptable/unix/plugin.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,298 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
-/* ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 1998
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-
-#include <X11/Xlib.h>
-#include <X11/Intrinsic.h>
-#include <X11/cursorfont.h>
-
-#include "plugin.h"
-#include "nsIServiceManager.h"
-#include "nsISupportsUtils.h" // some usefule macros are defined here
-
-#define MIME_TYPES_HANDLED  "application/scriptable-plugin"
-#define PLUGIN_NAME         "Scriptable Example Plugin for Mozilla"
-#define MIME_TYPES_DESCRIPTION  MIME_TYPES_HANDLED":scr:"PLUGIN_NAME
-#define PLUGIN_DESCRIPTION  PLUGIN_NAME " (Plug-ins SDK sample)"
-
-char* NPP_GetMIMEDescription(void)
-{
-    return(MIME_TYPES_DESCRIPTION);
-}
-
-//////////////////////////////////////
-//
-// general initialization and shutdown
-//
-NPError NS_PluginInitialize()
-{
-  return NPERR_NO_ERROR;
-}
-
-void NS_PluginShutdown()
-{
-}
-
-// get values per plugin
-NPError NS_PluginGetValue(NPPVariable aVariable, void *aValue)
-{
-  NPError err = NPERR_NO_ERROR;
-  switch (aVariable) {
-    case NPPVpluginNameString:
-      *((char **)aValue) = PLUGIN_NAME;
-      break;
-    case NPPVpluginDescriptionString:
-      *((char **)aValue) = PLUGIN_DESCRIPTION;
-      break;
-    default:
-      err = NPERR_INVALID_PARAM;
-      break;
-  }
-  return err;
-}
-
-
-/////////////////////////////////////////////////////////////
-//
-// construction and destruction of our plugin instance object
-//
-nsPluginInstanceBase * NS_NewPluginInstance(nsPluginCreateData * aCreateDataStruct)
-{
-  if(!aCreateDataStruct)
-    return NULL;
-
-  nsPluginInstance * plugin = new nsPluginInstance(aCreateDataStruct->instance);
-  return plugin;
-}
-
-void NS_DestroyPluginInstance(nsPluginInstanceBase * aPlugin)
-{
-  if(aPlugin)
-    delete (nsPluginInstance *)aPlugin;
-}
-
-////////////////////////////////////////
-//
-// nsPluginInstance class implementation
-//
-nsPluginInstance::nsPluginInstance(NPP aInstance) : nsPluginInstanceBase(),
-  mInstance(aInstance),
-  mInitialized(FALSE),
-  mWindow(0),
-  mXtwidget(0),
-  mFontInfo(0),
-  mScriptablePeer(NULL)
-{
-  mString[0] = '\0';
-}
-
-nsPluginInstance::~nsPluginInstance()
-{
-  // mScriptablePeer may be also held by the browser 
-  // so releasing it here does not guarantee that it is over
-  // we should take precaution in case it will be called later
-  // and zero its mPlugin member
-  if (mScriptablePeer) {
-    mScriptablePeer->SetInstance(NULL);
-    NS_RELEASE(mScriptablePeer);
-  }
-}
-
-static void
-xt_event_handler(Widget xtwidget, nsPluginInstance *plugin, XEvent *xevent, Boolean *b)
-{
-  switch (xevent->type) {
-    case Expose:
-      // get rid of all other exposure events
-      if (plugin) {
-        //while(XCheckTypedWindowEvent(plugin->Display(), plugin->Window(), Expose, xevent));
-        plugin->draw();
-      }
-      default:
-        break;
-  }
-}
-
-void nsPluginInstance::draw()
-{
-  unsigned int h = mHeight/2;
-  unsigned int w = 3 * mWidth/4;
-  int x = (mWidth - w)/2; // center
-  int y = h/2;
-  XClearArea(mDisplay, mWindow, 0, 0, 0, 0, False);
-  if (x >= 0 && y >= 0) {
-    GC gc = XCreateGC(mDisplay, mWindow, 0, NULL);
-    if (!gc)
-      return;
-    XDrawRectangle(mDisplay, mWindow, gc, x, y, w, h);
-    if (mString[0]) {
-  int l = strlen(mString);
-  int fmba = mFontInfo->max_bounds.ascent;
-  int fmbd = mFontInfo->max_bounds.descent;
-  int fh = fmba + fmbd;
-  y += fh;
-  x += 32;
-      XDrawString(mDisplay, mWindow, gc, x, y, mString, l);
-    }
-    XFreeGC(mDisplay, gc);
-  }
-}
-
-NPBool nsPluginInstance::init(NPWindow* aWindow)
-{
-  if(aWindow == NULL)
-    return FALSE;
-
-  if (SetWindow(aWindow))
-    mInitialized = TRUE;
-         
-  return mInitialized;
-}
-
-NPError nsPluginInstance::SetWindow(NPWindow* aWindow)
-{
-  if(aWindow == NULL)
-    return FALSE;
-
-  mX = aWindow->x;
-  mY = aWindow->y;
-  mWidth = aWindow->width;
-  mHeight = aWindow->height;
-  if (mWindow != (Window) aWindow->window) {
-    mWindow = (Window) aWindow->window;
-    NPSetWindowCallbackStruct *ws_info = (NPSetWindowCallbackStruct *)aWindow->ws_info;
-  mDisplay = ws_info->display;
-  mVisual = ws_info->visual;
-  mDepth = ws_info->depth;
-  mColormap = ws_info->colormap;
-
-  if (!mFontInfo) {
-      if (!(mFontInfo = XLoadQueryFont(mDisplay, "9x15")))
-    printf("Cannot open 9X15 font\n");
-  }
-  // add xt event handler
-  Widget xtwidget = XtWindowToWidget(mDisplay, mWindow);
-    if (xtwidget && mXtwidget != xtwidget) {
-      mXtwidget = xtwidget;
-    long event_mask = ExposureMask;
-    XSelectInput(mDisplay, mWindow, event_mask);
-    XtAddEventHandler(xtwidget, event_mask, False, (XtEventHandler)xt_event_handler, this);
-  }
-  }
-  draw();
-  return TRUE;
-}
-
-
-void nsPluginInstance::shut()
-{
-  mInitialized = FALSE;
-}
-
-NPBool nsPluginInstance::isInitialized()
-{
-  return mInitialized;
-}
-
-// this will force to draw a version string in the plugin window
-void nsPluginInstance::showVersion()
-{
-  const char *ua = NPN_UserAgent(mInstance);
-  strcpy(mString, ua);
-  draw();
-}
-
-// this will clean the plugin window
-void nsPluginInstance::clear()
-{
-  strcpy(mString, "");
-  draw();
-}
-
-// ==============================
-// ! Scriptability related code !
-// ==============================
-//
-// here the plugin is asked by Mozilla to tell if it is scriptable
-// we should return a valid interface id and a pointer to 
-// nsScriptablePeer interface which we should have implemented
-// and which should be defined in the corressponding *.xpt file
-// in the bin/components folder
-NPError	nsPluginInstance::GetValue(NPPVariable aVariable, void *aValue)
-{
-  NPError rv = NPERR_NO_ERROR;
-
-  if (aVariable == NPPVpluginScriptableInstance) {
-      // addref happens in getter, so we don't addref here
-    nsIScriptablePluginSample * scriptablePeer = getScriptablePeer();
-      if (scriptablePeer) {
-        *(nsISupports **)aValue = scriptablePeer;
-      } else
-        rv = NPERR_OUT_OF_MEMORY_ERROR;
-    }
-  else if (aVariable == NPPVpluginScriptableIID) {
-    static nsIID scriptableIID =  NS_ISCRIPTABLEPLUGINSAMPLE_IID;
-      nsIID* ptr = (nsIID *)NPN_MemAlloc(sizeof(nsIID));
-      if (ptr) {
-          *ptr = scriptableIID;
-          *(nsIID **)aValue = ptr;
-      } else
-        rv = NPERR_OUT_OF_MEMORY_ERROR;
-  }
-
-  return rv;
-}
-
-// ==============================
-// ! Scriptability related code !
-// ==============================
-//
-// this method will return the scriptable object (and create it if necessary)
-nsScriptablePeer* nsPluginInstance::getScriptablePeer()
-{
-  if (!mScriptablePeer) {
-    mScriptablePeer = new nsScriptablePeer(this);
-    if(!mScriptablePeer)
-      return NULL;
-
-    NS_ADDREF(mScriptablePeer);
-  }
-
-  // add reference for the caller requesting the object
-  NS_ADDREF(mScriptablePeer);
-  return mScriptablePeer;
-}
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/unix/plugin.h
--- a/modules/plugin/sdk/samples/scriptable/unix/plugin.h	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,89 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
-/* ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 1998
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#ifndef __PLUGIN_H__
-#define __PLUGIN_H__
-
-/* Xlib/Xt stuff */
-#include <X11/Xlib.h>
-#include <X11/Intrinsic.h>
-#include <X11/cursorfont.h>
-
-#include "pluginbase.h"
-#include "nsScriptablePeer.h"
-
-class nsPluginInstance : public nsPluginInstanceBase
-{
-public:
-  nsPluginInstance(NPP aInstance);
-  virtual ~nsPluginInstance();
-
-  NPBool init(NPWindow* aWindow);
-  void shut();
-  NPBool isInitialized();
-
-  NPError	GetValue(NPPVariable variable, void *value);
-  NPError SetWindow(NPWindow* aWindow);
-
-  // locals
-  void showVersion();
-  void clear();
-  void draw();
-
-  nsScriptablePeer* getScriptablePeer();
-
-private:
-  NPP mInstance;
-  NPBool mInitialized;
-
-  Window mWindow;
-  Display *mDisplay;
-  Widget mXtwidget;
-  int mX, mY;
-  int mWidth, mHeight;
-  Visual* mVisual;
-  Colormap mColormap;
-  unsigned int mDepth;
-  XFontStruct *mFontInfo;
-
-  nsScriptablePeer* mScriptablePeer;
-
-public:
-  char mString[128];
-};
-
-#endif // __PLUGIN_H__
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/windows/Makefile.in
--- a/modules/plugin/sdk/samples/scriptable/windows/Makefile.in	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,76 +0,0 @@
-#
-# ***** BEGIN LICENSE BLOCK *****
-# Version: MPL 1.1/GPL 2.0/LGPL 2.1
-#
-# The contents of this file are subject to the Mozilla Public License Version
-# 1.1 (the "License"); you may not use this file except in compliance with
-# the License. You may obtain a copy of the License at
-# http://www.mozilla.org/MPL/
-#
-# Software distributed under the License is distributed on an "AS IS" basis,
-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
-# for the specific language governing rights and limitations under the
-# License.
-#
-# The Original Code is mozilla.org code.
-#
-# The Initial Developer of the Original Code is
-# Netscape Communications Corporation.
-# Portions created by the Initial Developer are Copyright (C) 1998
-# the Initial Developer. All Rights Reserved.
-#
-# Contributor(s):
-#
-# Alternatively, the contents of this file may be used under the terms of
-# either the GNU General Public License Version 2 or later (the "GPL"), or
-# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
-# in which case the provisions of the GPL or the LGPL are applicable instead
-# of those above. If you wish to allow use of your version of this file only
-# under the terms of either the GPL or the LGPL, and not to allow others to
-# use your version of this file under the terms of the MPL, indicate your
-# decision by deleting the provisions above and replace them with the notice
-# and other provisions required by the GPL or the LGPL. If you do not delete
-# the provisions above, a recipient may use your version of this file under
-# the terms of any one of the MPL, the GPL or the LGPL.
-#
-# ***** END LICENSE BLOCK *****
-
-DEPTH = ../../../../../..
-topsrcdir = @top_srcdir@
-srcdir = @srcdir@
-VPATH = @srcdir@
-
-include $(DEPTH)/config/autoconf.mk
-
-XPIDL_MODULE = npscriptable
-LIBRARY_NAME = npscriptable
-
-NO_DIST_INSTALL = 1
-
-REQUIRES = plugin \
-           xpcom \
-           $(NULL)
-
-CPPSRCS = plugin.cpp \
-          nsScriptablePeer.cpp \
-          $(NULL)
-
-XPIDLSRCS = nsIScriptablePluginSample.idl
-
-SHARED_LIBRARY_LIBS = ../../common/$(LIB_PREFIX)plugingate_s.$(LIB_SUFFIX)
-
-DEFFILE = $(win_srcdir)/npscriptable.def
-RESFILE = npscriptable.res
-
-ifdef GNU_CC
-OS_LIBS	+= -lgdi32
-endif
-
-include $(topsrcdir)/config/rules.mk
-
-DEFINES += -DMOZILLA_STRICT_API
-
-LOCAL_INCLUDES = -I./$(XPIDL_GEN_DIR) \
-                 -I$(srcdir)/../../include \
-                 -I$(srcdir)/../../../include \
-                 $(NULL)
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/windows/npscriptable.def
--- a/modules/plugin/sdk/samples/scriptable/windows/npscriptable.def	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,6 +0,0 @@
-LIBRARY   NPSCRIPTABLE
-
-EXPORTS
-	NP_GetEntryPoints   @1
-	NP_Initialize       @2
-	NP_Shutdown         @3
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/windows/npscriptable.dsp
--- a/modules/plugin/sdk/samples/scriptable/windows/npscriptable.dsp	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,139 +0,0 @@
-# Microsoft Developer Studio Project File - Name="npscriptable" - Package Owner=<4>
-# Microsoft Developer Studio Generated Build File, Format Version 6.00
-# ** DO NOT EDIT **
-
-# TARGTYPE "Win32 (x86) Dynamic-Link Library" 0x0102
-
-CFG=npscriptable - Win32 Debug
-!MESSAGE This is not a valid makefile. To build this project using NMAKE,
-!MESSAGE use the Export Makefile command and run
-!MESSAGE 
-!MESSAGE NMAKE /f "npscriptable.mak".
-!MESSAGE 
-!MESSAGE You can specify a configuration when running NMAKE
-!MESSAGE by defining the macro CFG on the command line. For example:
-!MESSAGE 
-!MESSAGE NMAKE /f "npscriptable.mak" CFG="npscriptable - Win32 Debug"
-!MESSAGE 
-!MESSAGE Possible choices for configuration are:
-!MESSAGE 
-!MESSAGE "npscriptable - Win32 Release" (based on "Win32 (x86) Dynamic-Link Library")
-!MESSAGE "npscriptable - Win32 Debug" (based on "Win32 (x86) Dynamic-Link Library")
-!MESSAGE 
-
-# Begin Project
-# PROP AllowPerConfigDependencies 0
-# PROP Scc_ProjName ""
-# PROP Scc_LocalPath ""
-CPP=cl.exe
-MTL=midl.exe
-RSC=rc.exe
-
-!IF  "$(CFG)" == "npscriptable - Win32 Release"
-
-# PROP BASE Use_MFC 0
-# PROP BASE Use_Debug_Libraries 0
-# PROP BASE Output_Dir "Release"
-# PROP BASE Intermediate_Dir "Release"
-# PROP BASE Target_Dir ""
-# PROP Use_MFC 0
-# PROP Use_Debug_Libraries 0
-# PROP Output_Dir "Release"
-# PROP Intermediate_Dir "Release"
-# PROP Ignore_Export_Lib 0
-# PROP Target_Dir ""
-# ADD BASE CPP /nologo /MT /W3 /GX /O2 /D "WIN32" /D "NDEBUG" /D "_WINDOWS" /D "_MBCS" /D "_USRDLL" /D "NPSCRIPTABLE_EXPORTS" /YX /FD /c
-# ADD CPP /nologo /MT /W3 /GX /O2 /I "..\..\include" /I "..\..\..\include" /D "NDEBUG" /D "MOZILLA_STRICT_API" /D "XP_WIN" /D "XP_WIN32" /D "WIN32" /D "_WINDOWS" /D "_MBCS" /D "_USRDLL" /D "NPSCRIPTABLE_EXPORTS" /YX /FD /c
-# ADD BASE MTL /nologo /D "NDEBUG" /mktyplib203 /win32
-# ADD MTL /nologo /D "NDEBUG" /mktyplib203 /win32
-# ADD BASE RSC /l 0x409 /d "NDEBUG"
-# ADD RSC /l 0x409 /d "NDEBUG"
-BSC32=bscmake.exe
-# ADD BASE BSC32 /nologo
-# ADD BSC32 /nologo
-LINK32=link.exe
-# ADD BASE LINK32 kernel32.lib user32.lib gdi32.lib winspool.lib comdlg32.lib advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib odbc32.lib odbccp32.lib /nologo /dll /machine:I386
-# ADD LINK32 kernel32.lib user32.lib gdi32.lib /nologo /dll /machine:I386
-
-!ELSEIF  "$(CFG)" == "npscriptable - Win32 Debug"
-
-# PROP BASE Use_MFC 0
-# PROP BASE Use_Debug_Libraries 1
-# PROP BASE Output_Dir "npscriptable___Win32_Debug"
-# PROP BASE Intermediate_Dir "npscriptable___Win32_Debug"
-# PROP BASE Target_Dir ""
-# PROP Use_MFC 0
-# PROP Use_Debug_Libraries 1
-# PROP Output_Dir "Debug"
-# PROP Intermediate_Dir "Debug"
-# PROP Ignore_Export_Lib 0
-# PROP Target_Dir ""
-# ADD BASE CPP /nologo /MTd /W3 /Gm /GX /ZI /Od /D "WIN32" /D "_DEBUG" /D "_WINDOWS" /D "_MBCS" /D "_USRDLL" /D "NPSCRIPTABLE_EXPORTS" /YX /FD /GZ /c
-# ADD CPP /nologo /MTd /W3 /Gm /GX /ZI /Od /I "..\..\include" /I "..\..\..\include" /D "_DEBUG" /D "MOZILLA_STRICT_API" /D "XP_WIN" /D "XP_WIN32" /D "WIN32" /D "_WINDOWS" /D "_MBCS" /D "_USRDLL" /D "NPSCRIPTABLE_EXPORTS" /YX /FD /GZ /c
-# ADD BASE MTL /nologo /D "_DEBUG" /mktyplib203 /win32
-# ADD MTL /nologo /D "_DEBUG" /mktyplib203 /win32
-# ADD BASE RSC /l 0x409 /d "_DEBUG"
-# ADD RSC /l 0x409 /d "_DEBUG"
-BSC32=bscmake.exe
-# ADD BASE BSC32 /nologo
-# ADD BSC32 /nologo
-LINK32=link.exe
-# ADD BASE LINK32 kernel32.lib user32.lib gdi32.lib winspool.lib comdlg32.lib advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib odbc32.lib odbccp32.lib /nologo /dll /debug /machine:I386 /pdbtype:sept
-# ADD LINK32 kernel32.lib user32.lib gdi32.lib /nologo /dll /debug /machine:I386 /pdbtype:sept
-
-!ENDIF 
-
-# Begin Target
-
-# Name "npscriptable - Win32 Release"
-# Name "npscriptable - Win32 Debug"
-# Begin Group "Source Files"
-
-# PROP Default_Filter "cpp;c;cxx;rc;def;r;odl;idl;hpj;bat"
-# Begin Source File
-
-SOURCE=..\..\common\np_entry.cpp
-# End Source File
-# Begin Source File
-
-SOURCE=..\..\common\npn_gate.cpp
-# End Source File
-# Begin Source File
-
-SOURCE=..\..\common\npp_gate.cpp
-# End Source File
-# Begin Source File
-
-SOURCE=.\npscriptable.def
-# End Source File
-# Begin Source File
-
-SOURCE=.\nsScriptablePeer.cpp
-# End Source File
-# Begin Source File
-
-SOURCE=.\plugin.cpp
-# End Source File
-# End Group
-# Begin Group "Header Files"
-
-# PROP Default_Filter "h;hpp;hxx;hm;inl"
-# Begin Source File
-
-SOURCE=.\nsScriptablePeer.h
-# End Source File
-# Begin Source File
-
-SOURCE=.\plugin.h
-# End Source File
-# End Group
-# Begin Group "Resource Files"
-
-# PROP Default_Filter "ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe"
-# Begin Source File
-
-SOURCE=.\npscriptable.rc
-# End Source File
-# End Group
-# End Target
-# End Project
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/windows/npscriptable.dsw
--- a/modules/plugin/sdk/samples/scriptable/windows/npscriptable.dsw	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,29 +0,0 @@
-Microsoft Developer Studio Workspace File, Format Version 6.00
-# WARNING: DO NOT EDIT OR DELETE THIS WORKSPACE FILE!
-
-###############################################################################
-
-Project: "npscriptable"=.\npscriptable.dsp - Package Owner=<4>
-
-Package=<5>
-{{{
-}}}
-
-Package=<4>
-{{{
-}}}
-
-###############################################################################
-
-Global:
-
-Package=<5>
-{{{
-}}}
-
-Package=<3>
-{{{
-}}}
-
-###############################################################################
-
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/windows/npscriptable.rc
--- a/modules/plugin/sdk/samples/scriptable/windows/npscriptable.rc	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,112 +0,0 @@
-//Microsoft Developer Studio generated resource script.
-//
-#include "resource.h"
-
-#define APSTUDIO_READONLY_SYMBOLS
-/////////////////////////////////////////////////////////////////////////////
-//
-// Generated from the TEXTINCLUDE 2 resource.
-//
-#include "winresrc.h"
-
-/////////////////////////////////////////////////////////////////////////////
-#undef APSTUDIO_READONLY_SYMBOLS
-
-/////////////////////////////////////////////////////////////////////////////
-// English (U.S.) resources
-
-#if !defined(AFX_RESOURCE_DLL) || defined(AFX_TARG_ENU)
-#ifdef _WIN32
-LANGUAGE LANG_ENGLISH, SUBLANG_ENGLISH_US
-#pragma code_page(1252)
-#endif //_WIN32
-
-#ifndef _MAC
-/////////////////////////////////////////////////////////////////////////////
-//
-// Version
-//
-
-VS_VERSION_INFO VERSIONINFO
- FILEVERSION 1,0,0,1
- PRODUCTVERSION 1,0,0,1
- FILEFLAGSMASK 0x3fL
-#ifdef _DEBUG
- FILEFLAGS 0x1L
-#else
- FILEFLAGS 0x0L
-#endif
- FILEOS 0x40004L
- FILETYPE 0x2L
- FILESUBTYPE 0x0L
-BEGIN
-    BLOCK "StringFileInfo"
-    BEGIN
-        BLOCK "040904e4"
-        BEGIN
-            VALUE "Comments", "\0"
-            VALUE "CompanyName", " \0"
-            VALUE "FileDescription", "npscriptable\0"
-            VALUE "FileExtents", "scr\0"
-            VALUE "FileOpenName", "npscriptable\0"
-            VALUE "FileVersion", "1, 0, 0, 1\0"
-            VALUE "InternalName", "npscriptable\0"
-            VALUE "LegalCopyright", "Copyright © 2001\0"
-            VALUE "LegalTrademarks", "\0"
-            VALUE "MIMEType", "application/scriptable-plugin\0"
-            VALUE "OriginalFilename", "npscriptable.dll\0"
-            VALUE "PrivateBuild", "\0"
-            VALUE "ProductName", "Scriptable Plugin Example for Mozilla\0"
-            VALUE "ProductVersion", "1, 0, 0, 1\0"
-            VALUE "SpecialBuild", "\0"
-        END
-    END
-    BLOCK "VarFileInfo"
-    BEGIN
-        VALUE "Translation", 0x409, 1252
-    END
-END
-
-#endif    // !_MAC
-
-
-#ifdef APSTUDIO_INVOKED
-/////////////////////////////////////////////////////////////////////////////
-//
-// TEXTINCLUDE
-//
-
-1 TEXTINCLUDE DISCARDABLE 
-BEGIN
-    "resource.h\0"
-END
-
-2 TEXTINCLUDE DISCARDABLE 
-BEGIN
-    "#include ""winresrc.h""\r\n"
-    "\0"
-END
-
-3 TEXTINCLUDE DISCARDABLE 
-BEGIN
-    "\r\n"
-    "\0"
-END
-
-#endif    // APSTUDIO_INVOKED
-
-#endif    // English (U.S.) resources
-/////////////////////////////////////////////////////////////////////////////
-
-
-
-#ifndef APSTUDIO_INVOKED
-/////////////////////////////////////////////////////////////////////////////
-//
-// Generated from the TEXTINCLUDE 3 resource.
-//
-
-
-/////////////////////////////////////////////////////////////////////////////
-#endif    // not APSTUDIO_INVOKED
-
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/windows/nsIScriptablePluginSample.idl
--- a/modules/plugin/sdk/samples/scriptable/windows/nsIScriptablePluginSample.idl	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,45 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-
- *
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 2001
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#include "nsISupports.idl"
-
-[scriptable, uuid(d2d536a0-b6fc-11d5-9d10-0060b0fbd8ac)]
-interface nsIScriptablePluginSample : nsISupports {
-  void showVersion();
-  void clear();
-};
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/windows/nsScriptablePeer.cpp
--- a/modules/plugin/sdk/samples/scriptable/windows/nsScriptablePeer.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,132 +0,0 @@
-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
-/* ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 1998
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-// ==============================
-// ! Scriptability related code !
-// ==============================
-
-/////////////////////////////////////////////////////
-//
-// This file implements the nsScriptablePeer object
-// The native methods of this class are supposed to
-// be callable from JavaScript
-//
-#include "plugin.h"
-
-static NS_DEFINE_IID(kIScriptableIID, NS_ISCRIPTABLEPLUGINSAMPLE_IID);
-static NS_DEFINE_IID(kIClassInfoIID, NS_ICLASSINFO_IID);
-static NS_DEFINE_IID(kISupportsIID, NS_ISUPPORTS_IID);
-
-nsScriptablePeer::nsScriptablePeer(nsPluginInstance* aPlugin)
-{
-  mPlugin = aPlugin;
-  mRefCnt = 0;
-}
-
-nsScriptablePeer::~nsScriptablePeer()
-{
-}
-
-// AddRef, Release and QueryInterface are common methods and must 
-// be implemented for any interface
-NS_IMETHODIMP_(nsrefcnt) nsScriptablePeer::AddRef() 
-{ 
-  ++mRefCnt; 
-  return mRefCnt; 
-} 
-
-NS_IMETHODIMP_(nsrefcnt) nsScriptablePeer::Release() 
-{ 
-  --mRefCnt; 
-  if (mRefCnt == 0) { 
-    delete this;
-    return 0; 
-  } 
-  return mRefCnt; 
-} 
-
-// here nsScriptablePeer should return three interfaces it can be asked for by their iid's
-// static casts are necessary to ensure that correct pointer is returned
-NS_IMETHODIMP nsScriptablePeer::QueryInterface(const nsIID& aIID, void** aInstancePtr) 
-{ 
-  if(!aInstancePtr) 
-    return NS_ERROR_NULL_POINTER; 
-
-  if(aIID.Equals(kIScriptableIID)) {
-    *aInstancePtr = static_cast<nsIScriptablePluginSample*>(this); 
-    AddRef();
-    return NS_OK;
-  }
-
-  if(aIID.Equals(kIClassInfoIID)) {
-    *aInstancePtr = static_cast<nsIClassInfo*>(this); 
-    AddRef();
-    return NS_OK;
-  }
-
-  if(aIID.Equals(kISupportsIID)) {
-    *aInstancePtr = static_cast<nsISupports*>(static_cast<nsIScriptablePluginSample*>(this)); 
-    AddRef();
-    return NS_OK;
-  }
-
-  return NS_NOINTERFACE; 
-}
-
-void nsScriptablePeer::SetInstance(nsPluginInstance* plugin)
-{
-  mPlugin = plugin;
-}
-
-//
-// the following methods will be callable from JavaScript
-//
-NS_IMETHODIMP nsScriptablePeer::ShowVersion()
-{
-  if (mPlugin)
-    mPlugin->showVersion();
-
-  return NS_OK;
-}
-
-NS_IMETHODIMP nsScriptablePeer::Clear()
-{
-  if (mPlugin)
-    mPlugin->clear();
-
-  return NS_OK;
-}
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/windows/nsScriptablePeer.h
--- a/modules/plugin/sdk/samples/scriptable/windows/nsScriptablePeer.h	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,108 +0,0 @@
-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
-/* ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 1998
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-// ==============================
-// ! Scriptability related code !
-// ==============================
-//
-// nsScriptablePeer - xpconnect scriptable peer
-//
-
-#ifndef __nsScriptablePeer_h__
-#define __nsScriptablePeer_h__
-
-#include "nsIScriptablePluginSample.h"
-#include "nsIClassInfo.h"
-#include "nsIProgrammingLanguage.h"
-
-class nsPluginInstance;
-
-// We must implement nsIClassInfo because it signals the
-// Mozilla Security Manager to allow calls from JavaScript.
-
-class nsClassInfoMixin : public nsIClassInfo
-{
-  // These flags are used by the DOM and security systems to signal that 
-  // JavaScript callers are allowed to call this object's scritable methods.
-  NS_IMETHOD GetFlags(PRUint32 *aFlags)
-    {*aFlags = nsIClassInfo::PLUGIN_OBJECT | nsIClassInfo::DOM_OBJECT;
-     return NS_OK;}
-  NS_IMETHOD GetImplementationLanguage(PRUint32 *aImplementationLanguage)
-    {*aImplementationLanguage = nsIProgrammingLanguage::CPLUSPLUS;
-     return NS_OK;}
-  // The rest of the methods can safely return error codes...
-  NS_IMETHOD GetInterfaces(PRUint32 *count, nsIID * **array)
-    {return NS_ERROR_NOT_IMPLEMENTED;}
-  NS_IMETHOD GetHelperForLanguage(PRUint32 language, nsISupports **_retval)
-    {return NS_ERROR_NOT_IMPLEMENTED;}
-  NS_IMETHOD GetContractID(char * *aContractID)
-    {return NS_ERROR_NOT_IMPLEMENTED;}
-  NS_IMETHOD GetClassDescription(char * *aClassDescription)
-    {return NS_ERROR_NOT_IMPLEMENTED;}
-  NS_IMETHOD GetClassID(nsCID * *aClassID)
-    {return NS_ERROR_NOT_IMPLEMENTED;}
-  NS_IMETHOD GetClassIDNoAlloc(nsCID *aClassIDNoAlloc)
-    {return NS_ERROR_NOT_IMPLEMENTED;}
-};
-
-class nsScriptablePeer : public nsIScriptablePluginSample,
-                         public nsClassInfoMixin
-{
-public:
-  nsScriptablePeer(nsPluginInstance* plugin);
-  ~nsScriptablePeer();
-
-public:
-  // methods from nsISupports
-  NS_IMETHOD QueryInterface(const nsIID& aIID, void** aInstancePtr); 
-  NS_IMETHOD_(nsrefcnt) AddRef(); 
-  NS_IMETHOD_(nsrefcnt) Release(); 
-
-protected: 
-  nsrefcnt mRefCnt;  
-
-public:
-  // native methods callable from JavaScript
-  NS_DECL_NSISCRIPTABLEPLUGINSAMPLE
-
-  void SetInstance(nsPluginInstance* plugin);
-
-protected:
-  nsPluginInstance* mPlugin;
-};
-
-#endif
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/windows/plugin.cpp
--- a/modules/plugin/sdk/samples/scriptable/windows/plugin.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,239 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
-/* ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 1998
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#include <windows.h>
-#include <windowsx.h>
-
-#include "plugin.h"
-#include "nsIServiceManager.h"
-#include "nsISupportsUtils.h" // some usefule macros are defined here
-
-//////////////////////////////////////
-//
-// general initialization and shutdown
-//
-NPError NS_PluginInitialize()
-{
-  return NPERR_NO_ERROR;
-}
-
-void NS_PluginShutdown()
-{
-}
-
-/////////////////////////////////////////////////////////////
-//
-// construction and destruction of our plugin instance object
-//
-nsPluginInstanceBase * NS_NewPluginInstance(nsPluginCreateData * aCreateDataStruct)
-{
-  if(!aCreateDataStruct)
-    return NULL;
-
-  nsPluginInstance * plugin = new nsPluginInstance(aCreateDataStruct->instance);
-  return plugin;
-}
-
-void NS_DestroyPluginInstance(nsPluginInstanceBase * aPlugin)
-{
-  if(aPlugin)
-    delete (nsPluginInstance *)aPlugin;
-}
-
-////////////////////////////////////////
-//
-// nsPluginInstance class implementation
-//
-nsPluginInstance::nsPluginInstance(NPP aInstance) : nsPluginInstanceBase(),
-  mInstance(aInstance),
-  mInitialized(FALSE),
-  mScriptablePeer(NULL)
-{
-  mhWnd = NULL;
-  mString[0] = '\0';
-}
-
-nsPluginInstance::~nsPluginInstance()
-{
-  // mScriptablePeer may be also held by the browser 
-  // so releasing it here does not guarantee that it is over
-  // we should take precaution in case it will be called later
-  // and zero its mPlugin member
-  if (mScriptablePeer) {
-    mScriptablePeer->SetInstance(NULL);
-    NS_RELEASE(mScriptablePeer);
-  }
-}
-
-static LRESULT CALLBACK PluginWinProc(HWND, UINT, WPARAM, LPARAM);
-static WNDPROC lpOldProc = NULL;
-
-NPBool nsPluginInstance::init(NPWindow* aWindow)
-{
-  if(aWindow == NULL)
-    return FALSE;
-
-  mhWnd = (HWND)aWindow->window;
-  if(mhWnd == NULL)
-    return FALSE;
-
-  // subclass window so we can intercept window messages and
-  // do our drawing to it
-  lpOldProc = SubclassWindow(mhWnd, (WNDPROC)PluginWinProc);
-
-  // associate window with our nsPluginInstance object so we can access 
-  // it in the window procedure
-  SetWindowLong(mhWnd, GWL_USERDATA, (LONG)this);
-
-  mInitialized = TRUE;
-  return TRUE;
-}
-
-void nsPluginInstance::shut()
-{
-  // subclass it back
-  SubclassWindow(mhWnd, lpOldProc);
-  mhWnd = NULL;
-  mInitialized = FALSE;
-}
-
-NPBool nsPluginInstance::isInitialized()
-{
-  return mInitialized;
-}
-
-// this will force to draw a version string in the plugin window
-void nsPluginInstance::showVersion()
-{
-  const char *ua = NPN_UserAgent(mInstance);
-  strcpy(mString, ua);
-  InvalidateRect(mhWnd, NULL, TRUE);
-  UpdateWindow(mhWnd);
-}
-
-// this will clean the plugin window
-void nsPluginInstance::clear()
-{
-  strcpy(mString, "");
-  InvalidateRect(mhWnd, NULL, TRUE);
-  UpdateWindow(mhWnd);
-}
-
-// ==============================
-// ! Scriptability related code !
-// ==============================
-//
-// here the plugin is asked by Mozilla to tell if it is scriptable
-// we should return a valid interface id and a pointer to 
-// nsScriptablePeer interface which we should have implemented
-// and which should be defined in the corressponding *.xpt file
-// in the bin/components folder
-NPError	nsPluginInstance::GetValue(NPPVariable aVariable, void *aValue)
-{
-  NPError rv = NPERR_NO_ERROR;
-
-  if (aVariable == NPPVpluginScriptableInstance) {
-    // addref happens in getter, so we don't addref here
-    nsIScriptablePluginSample * scriptablePeer = getScriptablePeer();
-    if (scriptablePeer) {
-      *(nsISupports **)aValue = scriptablePeer;
-    } else
-      rv = NPERR_OUT_OF_MEMORY_ERROR;
-  }
-  else if (aVariable == NPPVpluginScriptableIID) {
-    static nsIID scriptableIID = NS_ISCRIPTABLEPLUGINSAMPLE_IID;
-    nsIID* ptr = (nsIID *)NPN_MemAlloc(sizeof(nsIID));
-    if (ptr) {
-        *ptr = scriptableIID;
-        *(nsIID **)aValue = ptr;
-    } else
-      rv = NPERR_OUT_OF_MEMORY_ERROR;
-  }
-
-  return rv;
-}
-
-// ==============================
-// ! Scriptability related code !
-// ==============================
-//
-// this method will return the scriptable object (and create it if necessary)
-nsScriptablePeer* nsPluginInstance::getScriptablePeer()
-{
-  if (!mScriptablePeer) {
-    mScriptablePeer = new nsScriptablePeer(this);
-    if(!mScriptablePeer)
-      return NULL;
-
-    NS_ADDREF(mScriptablePeer);
-  }
-
-  // add reference for the caller requesting the object
-  NS_ADDREF(mScriptablePeer);
-  return mScriptablePeer;
-}
-
-static LRESULT CALLBACK PluginWinProc(HWND hWnd, UINT msg, WPARAM wParam, LPARAM lParam)
-{
-  switch (msg) {
-    case WM_PAINT:
-      {
-        // draw a frame and display the string
-        PAINTSTRUCT ps;
-        HDC hdc = BeginPaint(hWnd, &ps);
-        RECT rc;
-        GetClientRect(hWnd, &rc);
-        FrameRect(hdc, &rc, GetStockBrush(BLACK_BRUSH));
-
-        // get our plugin instance object and ask it for the version string
-        nsPluginInstance *plugin = (nsPluginInstance *)GetWindowLong(hWnd, GWL_USERDATA);
-        if (plugin)
-          DrawText(hdc, plugin->mString, strlen(plugin->mString), &rc, DT_SINGLELINE | DT_CENTER | DT_VCENTER);
-        else {
-          char string[] = "Error occured";
-          DrawText(hdc, string, strlen(string), &rc, DT_SINGLELINE | DT_CENTER | DT_VCENTER);
-        }
-
-        EndPaint(hWnd, &ps);
-      }
-      break;
-    default:
-      break;
-  }
-
-  return DefWindowProc(hWnd, msg, wParam, lParam);
-}
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/windows/plugin.h
--- a/modules/plugin/sdk/samples/scriptable/windows/plugin.h	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,74 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
-/* ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is mozilla.org code.
- *
- * The Initial Developer of the Original Code is
- * Netscape Communications Corporation.
- * Portions created by the Initial Developer are Copyright (C) 1998
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#ifndef __PLUGIN_H__
-#define __PLUGIN_H__
-
-#include "pluginbase.h"
-#include "nsScriptablePeer.h"
-
-class nsPluginInstance : public nsPluginInstanceBase
-{
-public:
-  nsPluginInstance(NPP aInstance);
-  ~nsPluginInstance();
-
-  NPBool init(NPWindow* aWindow);
-  void shut();
-  NPBool isInitialized();
-
-  // we need to provide implementation of this method as it will be
-  // used by Mozilla to retrieve the scriptable peer
-  NPError	GetValue(NPPVariable variable, void *value);
-
-  // locals
-  void showVersion();
-  void clear();
-
-  nsScriptablePeer* getScriptablePeer();
-
-private:
-  NPP mInstance;
-  NPBool mInitialized;
-  HWND mhWnd;
-  nsScriptablePeer * mScriptablePeer;
-
-public:
-  char mString[128];
-};
-
-#endif // __PLUGIN_H__
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/windows/readme.txt
--- a/modules/plugin/sdk/samples/scriptable/windows/readme.txt	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,9 +0,0 @@
-Before building the project the following must be done.
-
-1. ..\..\..\bin\xpidl -m header -I..\..\..\idl nsIScriptablePlugin.idl
-This will generate nsIScriptablePlugin.h which is needed to successfuly
-compile the plugin
-
-2. ..\..\..\bin\xpidl -m typelib -I..\..\..\idl nsIScriptablePlugin.idl
-This will create nsIScriptablePlugin.xpt file which should go to the
-Mozilla Components folder.
diff -r f3ac957eb4af modules/plugin/sdk/samples/scriptable/windows/resource.h
--- a/modules/plugin/sdk/samples/scriptable/windows/resource.h	Thu Sep 04 12:36:46 2008 -0400
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,20 +0,0 @@
-//{{NO_DEPENDENCIES}}
-// Microsoft Developer Studio generated include file.
-// Used by scriptable.rc
-//
-#define IDD_MAIN                        101
-#define IDC_BUTTON_GO                   1002
-#define IDC_STATIC_UA                   1003
-#define IDC_BUTTON1                     1005
-#define IDC_BUTTON_DONT                 1005
-
-// Next default values for new objects
-// 
-#ifdef APSTUDIO_INVOKED
-#ifndef APSTUDIO_READONLY_SYMBOLS
-#define _APS_NEXT_RESOURCE_VALUE        102
-#define _APS_NEXT_COMMAND_VALUE         40001
-#define _APS_NEXT_CONTROL_VALUE         1006
-#define _APS_NEXT_SYMED_VALUE           101
-#endif
-#endif
diff -r f3ac957eb4af nsprpub/configure
--- a/nsprpub/configure	Thu Sep 04 12:36:46 2008 -0400
+++ b/nsprpub/configure	Sat Sep 06 10:14:38 2008 +0300
@@ -4769,14 +4769,14 @@ EOF
     if test -n "$GNU_CC"; then
         DSO_CFLAGS=-fPIC
         if `$CC -print-prog-name=ld` -v 2>&1 | grep -c GNU >/dev/null; then
             GCC_USE_GNU_LD=1
         fi
-        DSO_LDOPTS='-shared -Wl,-h,$(notdir $@),-z,combreloc,-z,defs,-z,ignore' 
+        DSO_LDOPTS='-shared -Wl,-h,$(notdir $@),-z,combreloc,-z,defs,-z,ignore,-Bdirect' 
     else
         DSO_CFLAGS=-KPIC
-        DSO_LDOPTS='-G -h $(notdir $@) -z combreloc -z defs -z ignore'
+        DSO_LDOPTS='-G -h $(notdir $@) -z combreloc -z defs -z ignore -Bdirect'
     fi
     if test -n "$GNU_CC"; then
         CFLAGS="$CFLAGS -Wall"
         CXXFLAGS="$CXXFLAGS -Wall"
         if test -n "$USE_MDUPDATE"; then
diff -r f3ac957eb4af nsprpub/configure.in
--- a/nsprpub/configure.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/nsprpub/configure.in	Sat Sep 06 10:14:38 2008 +0300
@@ -1992,14 +1992,14 @@ mips-sony-newsos*)
     if test -n "$GNU_CC"; then
         DSO_CFLAGS=-fPIC
         if `$CC -print-prog-name=ld` -v 2>&1 | grep -c GNU >/dev/null; then
             GCC_USE_GNU_LD=1
         fi
-        DSO_LDOPTS='-shared -Wl,-h,$(notdir $@),-z,combreloc,-z,defs,-z,ignore' 
+        DSO_LDOPTS='-shared -Wl,-h,$(notdir $@),-z,combreloc,-z,defs,-z,ignore,-Bdirect' 
     else
         DSO_CFLAGS=-KPIC
-        DSO_LDOPTS='-G -h $(notdir $@) -z combreloc -z defs -z ignore'
+        DSO_LDOPTS='-G -h $(notdir $@) -z combreloc -z defs -z ignore -Bdirect'
     fi
     if test -n "$GNU_CC"; then
         CFLAGS="$CFLAGS -Wall"
         CXXFLAGS="$CXXFLAGS -Wall"
         if test -n "$USE_MDUPDATE"; then
diff -r f3ac957eb4af nsprpub/lib/libc/src/strcase.c
--- a/nsprpub/lib/libc/src/strcase.c	Thu Sep 04 12:36:46 2008 -0400
+++ b/nsprpub/lib/libc/src/strcase.c	Sat Sep 06 10:14:38 2008 +0300
@@ -34,10 +34,11 @@
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 #include "plstr.h"
+#include <string.h>
 
 static const unsigned char uc[] =
 {
     '\000', '\001', '\002', '\003', '\004', '\005', '\006', '\007',
     '\010', '\011', '\012', '\013', '\014', '\015', '\016', '\017',
diff -r f3ac957eb4af nsprpub/pr/include/md/_beos.h
--- a/nsprpub/pr/include/md/_beos.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/nsprpub/pr/include/md/_beos.h	Sat Sep 06 10:14:38 2008 +0300
@@ -54,10 +54,11 @@
  * Internal configuration macros
  */
 
 #ifdef BONE_VERSION
 #define _PR_HAVE_SOCKADDR_LEN
+#define HAVE_NETINET_TCP_H
 #endif
 
 #define PR_LINKER_ARCH	"beos"
 #define _PR_SI_SYSNAME  "BEOS"
 #ifdef __powerpc__
diff -r f3ac957eb4af nsprpub/pr/include/md/_os2.h
--- a/nsprpub/pr/include/md/_os2.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/nsprpub/pr/include/md/_os2.h	Sat Sep 06 10:14:38 2008 +0300
@@ -64,10 +64,11 @@
 #define HAVE_DLL
 #define _PR_GLOBAL_THREADS_ONLY
 #undef  HAVE_THREAD_AFFINITY
 #define _PR_HAVE_THREADSAFE_GETHOST
 #define _PR_HAVE_ATOMIC_OPS
+#define HAVE_NETINET_TCP_H
 
 #define HANDLE unsigned long
 #define HINSTANCE HMODULE
 
 /* --- Common User-Thread/Native-Thread Definitions --------------------- */
diff -r f3ac957eb4af nsprpub/pr/include/md/_unixos.h
--- a/nsprpub/pr/include/md/_unixos.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/nsprpub/pr/include/md/_unixos.h	Sat Sep 06 10:14:38 2008 +0300
@@ -78,10 +78,14 @@
  */
 #include <sys/time.h>
 #include <sys/types.h>
 #if defined(AIX) || defined(SYMBIAN)
 #include <sys/select.h>
+#endif
+
+#ifndef SYMBIAN
+#define HAVE_NETINET_TCP_H
 #endif
 
 #define _PR_HAVE_O_APPEND
 
 #define PR_DIRECTORY_SEPARATOR		'/'
diff -r f3ac957eb4af nsprpub/pr/include/prinit.h
--- a/nsprpub/pr/include/prinit.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/nsprpub/pr/include/prinit.h	Sat Sep 06 10:14:38 2008 +0300
@@ -61,11 +61,11 @@ PR_BEGIN_EXTERN_C
 ** what is in the underlying library.
 **
 ** The format of the version string is
 **     "<major version>.<minor version>[.<patch level>] [<Beta>]"
 */
-#define PR_VERSION  "4.7.2 Beta 2"
+#define PR_VERSION  "4.7.2 Beta 3"
 #define PR_VMAJOR   4
 #define PR_VMINOR   7
 #define PR_VPATCH   2
 #define PR_BETA     PR_TRUE
 
diff -r f3ac957eb4af nsprpub/pr/src/io/prlog.c
--- a/nsprpub/pr/src/io/prlog.c	Thu Sep 04 12:36:46 2008 -0400
+++ b/nsprpub/pr/src/io/prlog.c	Sat Sep 06 10:14:38 2008 +0300
@@ -76,11 +76,10 @@ static PRLock *_pr_logLock;
 
 #endif
 
 #if defined(XP_PC)
 #define strcasecmp stricmp
-#define strncasecmp strnicmp
 #endif
 
 /*
  * On NT, we can't define _PUT_LOG as PR_Write or _PR_MD_WRITE,
  * because every asynchronous file io operation leads to a fiber context
diff -r f3ac957eb4af nsprpub/pr/src/io/prmapopt.c
--- a/nsprpub/pr/src/io/prmapopt.c	Thu Sep 04 12:36:46 2008 -0400
+++ b/nsprpub/pr/src/io/prmapopt.c	Sat Sep 06 10:14:38 2008 +0300
@@ -68,12 +68,11 @@
 #if defined(NEXTSTEP)
 /* NEXTSTEP is special: this must come before netinet/tcp.h. */
 #include <netinet/in_systm.h>  /* n_short, n_long, n_time */
 #endif
 
-#if (defined(XP_UNIX) && !defined(SYMBIAN)) \
-    || defined(OS2) || (defined(XP_BEOS) && defined(BONE_VERSION))
+#ifdef HAVE_NETINET_TCP_H
 #include <netinet/tcp.h>  /* TCP_NODELAY, TCP_MAXSEG */
 #endif
 
 #ifndef _PR_PTHREADS
 
diff -r f3ac957eb4af nsprpub/pr/src/md/unix/unix_errors.c
--- a/nsprpub/pr/src/md/unix/unix_errors.c	Thu Sep 04 12:36:46 2008 -0400
+++ b/nsprpub/pr/src/md/unix/unix_errors.c	Sat Sep 06 10:14:38 2008 +0300
@@ -192,10 +192,13 @@ void _MD_unix_map_default_error(int err)
 #ifdef ENOSR
         case ENOSR:
             prError = PR_INSUFFICIENT_RESOURCES_ERROR;
             break;
 #endif
+        case ENOSYS:
+            prError = PR_NOT_IMPLEMENTED_ERROR;
+            break;
         case ENOTCONN:
             prError = PR_NOT_CONNECTED_ERROR;
             break;
         case ENOTDIR:
             prError = PR_NOT_DIRECTORY_ERROR;
diff -r f3ac957eb4af nsprpub/pr/src/pthreads/ptio.c
--- a/nsprpub/pr/src/pthreads/ptio.c	Thu Sep 04 12:36:46 2008 -0400
+++ b/nsprpub/pr/src/pthreads/ptio.c	Sat Sep 06 10:14:38 2008 +0300
@@ -185,11 +185,14 @@ static ssize_t (*pt_aix_sendfile_fptr)()
 #include <sys/sendfile.h>
 #endif
 
 #include "primpl.h"
 
+#ifdef HAVE_NETINET_TCP_H
 #include <netinet/tcp.h>  /* TCP_NODELAY, TCP_MAXSEG */
+#endif
+
 #ifdef LINUX
 /* TCP_CORK is not defined in <netinet/tcp.h> on Red Hat Linux 6.0 */
 #ifndef TCP_CORK
 #define TCP_CORK 3
 #endif
@@ -207,11 +210,11 @@ static PRBool _pr_ipv6_v6only_on_by_defa
     || defined(OSF1) || defined(SOLARIS) \
     || defined(HPUX10_30) || defined(HPUX11) \
     || defined(LINUX) || defined(__GNU__) || defined(__GLIBC__) \
     || defined(FREEBSD) || defined(NETBSD) || defined(OPENBSD) \
     || defined(BSDI) || defined(VMS) || defined(NTO) || defined(DARWIN) \
-    || defined(UNIXWARE) || defined(RISCOS)
+    || defined(UNIXWARE) || defined(RISCOS) || defined(SYMBIAN)
 #define _PRSelectFdSetArg_t fd_set *
 #else
 #error "Cannot determine architecture"
 #endif
 
@@ -1654,12 +1657,21 @@ static PRFileDesc* pt_Accept(
     PRFileDesc *fd, PRNetAddr *addr, PRIntervalTime timeout)
 {
     PRFileDesc *newfd = NULL;
     PRIntn syserrno, osfd = -1;
     pt_SockLen addr_len = sizeof(PRNetAddr);
+#ifdef SYMBIAN
+    PRNetAddr dummy_addr;
+#endif
 
     if (pt_TestAbort()) return newfd;
+
+#ifdef SYMBIAN
+    /* On Symbian OS, accept crashes if addr is NULL. */
+    if (!addr)
+        addr = &dummy_addr;
+#endif
 
 #ifdef _PR_STRICT_ADDR_LEN
     if (addr)
     {
         /*
@@ -1824,11 +1836,19 @@ static PRInt32 pt_Recv(
     PRIntn osflags;
 
     if (0 == flags)
         osflags = 0;
     else if (PR_MSG_PEEK == flags)
+    {
+#ifdef SYMBIAN
+        /* MSG_PEEK doesn't work as expected. */
+        PR_SetError(PR_NOT_IMPLEMENTED_ERROR, 0);
+        return bytes;
+#else
         osflags = MSG_PEEK;
+#endif
+    }
     else
     {
         PR_SetError(PR_INVALID_ARGUMENT_ERROR, 0);
         return bytes;
     }
@@ -3249,11 +3269,12 @@ static PRIOMethods _pr_socketpollfd_meth
 
 #if defined(HPUX) || defined(OSF1) || defined(SOLARIS) || defined (IRIX) \
     || defined(LINUX) || defined(__GNU__) || defined(__GLIBC__) \
     || defined(AIX) || defined(FREEBSD) || defined(NETBSD) \
     || defined(OPENBSD) || defined(BSDI) || defined(VMS) || defined(NTO) \
-    || defined(DARWIN) || defined(UNIXWARE) || defined(RISCOS)
+    || defined(DARWIN) || defined(UNIXWARE) || defined(RISCOS) \
+    || defined(SYMBIAN)
 #define _PR_FCNTL_FLAGS O_NONBLOCK
 #else
 #error "Can't determine architecture"
 #endif
 
@@ -4352,10 +4373,88 @@ PR_IMPLEMENT(PRFileDesc*) PR_OpenTCPSock
     return PR_Socket(af, SOCK_STREAM, 0);
 }  /* PR_NewTCPSocket */
 
 PR_IMPLEMENT(PRStatus) PR_NewTCPSocketPair(PRFileDesc *fds[2])
 {
+#ifdef SYMBIAN
+    /*
+     * For the platforms that don't have socketpair.
+     *
+     * Copied from prsocket.c, with the parameter f[] renamed fds[] and the
+     * _PR_CONNECT_DOES_NOT_BIND code removed.
+     */
+    PRFileDesc *listenSock;
+    PRNetAddr selfAddr, peerAddr;
+    PRUint16 port;
+
+    fds[0] = fds[1] = NULL;
+    listenSock = PR_NewTCPSocket();
+    if (listenSock == NULL) {
+        goto failed;
+    }
+    PR_InitializeNetAddr(PR_IpAddrLoopback, 0, &selfAddr); /* BugZilla: 35408 */
+    if (PR_Bind(listenSock, &selfAddr) == PR_FAILURE) {
+        goto failed;
+    }
+    if (PR_GetSockName(listenSock, &selfAddr) == PR_FAILURE) {
+        goto failed;
+    }
+    port = ntohs(selfAddr.inet.port);
+    if (PR_Listen(listenSock, 5) == PR_FAILURE) {
+        goto failed;
+    }
+    fds[0] = PR_NewTCPSocket();
+    if (fds[0] == NULL) {
+        goto failed;
+    }
+    PR_InitializeNetAddr(PR_IpAddrLoopback, port, &selfAddr);
+
+    /*
+     * Only a thread is used to do the connect and accept.
+     * I am relying on the fact that PR_Connect returns
+     * successfully as soon as the connect request is put
+     * into the listen queue (but before PR_Accept is called).
+     * This is the behavior of the BSD socket code.  If
+     * connect does not return until accept is called, we
+     * will need to create another thread to call connect.
+     */
+    if (PR_Connect(fds[0], &selfAddr, PR_INTERVAL_NO_TIMEOUT)
+            == PR_FAILURE) {
+        goto failed;
+    }
+    /*
+     * A malicious local process may connect to the listening
+     * socket, so we need to verify that the accepted connection
+     * is made from our own socket fds[0].
+     */
+    if (PR_GetSockName(fds[0], &selfAddr) == PR_FAILURE) {
+        goto failed;
+    }
+    fds[1] = PR_Accept(listenSock, &peerAddr, PR_INTERVAL_NO_TIMEOUT);
+    if (fds[1] == NULL) {
+        goto failed;
+    }
+    if (peerAddr.inet.port != selfAddr.inet.port) {
+        /* the connection we accepted is not from fds[0] */
+        PR_SetError(PR_INSUFFICIENT_RESOURCES_ERROR, 0);
+        goto failed;
+    }
+    PR_Close(listenSock);
+    return PR_SUCCESS;
+
+failed:
+    if (listenSock) {
+        PR_Close(listenSock);
+    }
+    if (fds[0]) {
+        PR_Close(fds[0]);
+    }
+    if (fds[1]) {
+        PR_Close(fds[1]);
+    }
+    return PR_FAILURE;
+#else
     PRInt32 osfd[2];
 
     if (pt_TestAbort()) return PR_FAILURE;
 
     if (socketpair(AF_UNIX, SOCK_STREAM, 0, osfd) == -1) {
@@ -4374,10 +4473,11 @@ PR_IMPLEMENT(PRStatus) PR_NewTCPSocketPa
         PR_Close(fds[0]);
         close(osfd[1]);
         return PR_FAILURE;
     }
     return PR_SUCCESS;
+#endif
 }  /* PR_NewTCPSocketPair */
 
 PR_IMPLEMENT(PRStatus) PR_CreatePipe(
     PRFileDesc **readPipe,
     PRFileDesc **writePipe
@@ -4429,10 +4529,11 @@ PR_IMPLEMENT(PRStatus) PR_SetFDInheritab
     if (fd->secret->inheritable != inheritable)
     {
         if (fcntl(fd->secret->md.osfd, F_SETFD,
         inheritable ? 0 : FD_CLOEXEC) == -1)
         {
+            _PR_MD_MAP_DEFAULT_ERROR(errno);
             return PR_FAILURE;
         }
         fd->secret->inheritable = (_PRTriStateBool) inheritable;
     }
     return PR_SUCCESS;
@@ -4601,25 +4702,27 @@ PR_IMPLEMENT(PRStatus) PR_UnlockFile(PRF
  * defined here for historical (or hysterical) reasons.
  */
 
 PR_IMPLEMENT(PRInt32) PR_GetSysfdTableMax(void)
 {
-#if defined(XP_UNIX) && !defined(AIX) && !defined(VMS)
+#if defined(AIX) || defined(VMS) || defined(SYMBIAN)
+    return sysconf(_SC_OPEN_MAX);
+#else
     struct rlimit rlim;
 
     if ( getrlimit(RLIMIT_NOFILE, &rlim) < 0) 
        return -1;
 
     return rlim.rlim_max;
-#elif defined(AIX) || defined(VMS)
-    return sysconf(_SC_OPEN_MAX);
 #endif
 }
 
 PR_IMPLEMENT(PRInt32) PR_SetSysfdTableSize(PRIntn table_size)
 {
-#if defined(XP_UNIX) && !defined(AIX) && !defined(VMS)
+#if defined(AIX) || defined(VMS) || defined(SYMBIAN)
+    return -1;
+#else
     struct rlimit rlim;
     PRInt32 tableMax = PR_GetSysfdTableMax();
 
     if (tableMax < 0) return -1;
     rlim.rlim_max = tableMax;
@@ -4632,12 +4735,10 @@ PR_IMPLEMENT(PRInt32) PR_SetSysfdTableSi
 
     if ( setrlimit(RLIMIT_NOFILE, &rlim) < 0) 
         return -1;
 
     return rlim.rlim_cur;
-#elif defined(AIX) || defined(VMS)
-    return -1;
 #endif
 }
 
 /*
  * PR_Stat is supported for backward compatibility; some existing Java
diff -r f3ac957eb4af security/manager/Makefile.in
--- a/security/manager/Makefile.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/security/manager/Makefile.in	Sat Sep 06 10:14:38 2008 +0300
@@ -279,12 +279,20 @@ libs::
 libs::
 ifndef MOZ_NATIVE_NSS
 	$(MAKE) -C $(topsrcdir)/security/coreconf $(DEFAULT_GMAKE_FLAGS)
 	$(MAKE) -C $(topsrcdir)/security/dbm $(DEFAULT_GMAKE_FLAGS) 
 	$(MAKE) -C $(topsrcdir)/security/nss/lib $(DEFAULT_GMAKE_FLAGS)
+ifdef ENABLE_TESTS
+	# Need certutil binary for mochitest certificates generation
+	$(MAKE) -C $(topsrcdir)/security/nss/cmd/lib $(DEFAULT_GMAKE_FLAGS)
+	$(MAKE) -C $(topsrcdir)/security/nss/cmd/certutil $(DEFAULT_GMAKE_FLAGS)
+	$(MAKE) -C $(topsrcdir)/security/nss/cmd/pk12util $(DEFAULT_GMAKE_FLAGS)
+endif
 ifndef SKIP_CHK
+ifndef ENABLE_TESTS # Just avoid secondary compile
 	$(MAKE) -C $(topsrcdir)/security/nss/cmd/lib $(DEFAULT_GMAKE_FLAGS)
+endif
 	$(MAKE) -C $(topsrcdir)/security/nss/cmd/shlibsign $(DEFAULT_GMAKE_FLAGS)
 endif
 	$(INSTALL) -m 755 $(DIST)/lib/$(LOADABLE_ROOT_MODULE) $(DIST)/bin
 ifndef SKIP_CHK
 	$(INSTALL) -m 644 $(DIST)/lib/$(SOFTOKEN3_CHK) $(DIST)/bin
diff -r f3ac957eb4af security/nss/lib/nss/nss.h
--- a/security/nss/lib/nss/nss.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/security/nss/lib/nss/nss.h	Sat Sep 06 10:14:38 2008 +0300
@@ -34,11 +34,11 @@
  * and other provisions required by the GPL or the LGPL. If you do not delete
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
-/* $Id: nss.h,v 1.58 2008/08/11 20:48:30 christophe.ravel.bugs%sun.com Exp $ */
+/* $Id: nss.h,v 1.58.4.1 2008/09/05 17:02:49 kaie%kuix.de Exp $ */
 
 #ifndef __nss_h_
 #define __nss_h_
 
 #include "seccomon.h"
@@ -68,11 +68,11 @@ SEC_BEGIN_PROTOS
  * this is a beta release.
  *
  * The format of the version string should be
  *     "<major version>.<minor version>[.<patch level>][ <ECC>][ <Beta>]"
  */
-#define NSS_VERSION  "3.12.1.0" _NSS_ECC_STRING _NSS_CUSTOMIZED
+#define NSS_VERSION  "3.12.1.1" _NSS_ECC_STRING _NSS_CUSTOMIZED
 #define NSS_VMAJOR   3
 #define NSS_VMINOR   12
 #define NSS_VPATCH   1
 #define NSS_BETA     PR_FALSE
 
diff -r f3ac957eb4af security/nss/lib/pkcs7/certread.c
--- a/security/nss/lib/pkcs7/certread.c	Thu Sep 04 12:36:46 2008 -0400
+++ b/security/nss/lib/pkcs7/certread.c	Sat Sep 06 10:14:38 2008 +0300
@@ -330,12 +330,12 @@ notder:
 
     /* find the beginning marker */
     while ( cl > NS_CERT_HEADER_LEN ) {
 	if ( !PORT_Strncasecmp((char *)cp, NS_CERT_HEADER,
 			        NS_CERT_HEADER_LEN) ) {
-	    cl -= NS_CERT_HEADER_LEN;
-	    cp += NS_CERT_HEADER_LEN;
+	    cl -= NS_CERT_HEADER_LEN + 1; /* skip char after header     */
+	    cp += NS_CERT_HEADER_LEN + 1; /* as all prior versions did. */
 	    certbegin = cp;
 	    break;
 	}
 	
 	/* skip to next eol */
@@ -351,11 +351,11 @@ notder:
 	}
     }
 
     if ( certbegin ) {
 	/* find the ending marker */
-	while ( cl > NS_CERT_TRAILER_LEN ) {
+	while ( cl >= NS_CERT_TRAILER_LEN ) {
 	    if ( !PORT_Strncasecmp((char *)cp, NS_CERT_TRAILER,
 				   NS_CERT_TRAILER_LEN) ) {
 		certend = (unsigned char *)cp;
 		break;
 	    }
diff -r f3ac957eb4af testing/mochitest/Makefile.in
--- a/testing/mochitest/Makefile.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/testing/mochitest/Makefile.in	Sat Sep 06 10:14:38 2008 +0300
@@ -72,10 +72,11 @@ _SERV_FILES = 	\
 		mozprefs.js \
 		$(NULL)	
 
 
 _DEST_DIR = $(DEPTH)/_tests/$(relativesrcdir)
+_CERTS_DIR = $(DEPTH)/_profile/pgo/certs
 
 ifeq ($(USE_SHORT_LIBNAME), 1)
 PROGRAM = $(MOZ_APP_NAME)$(BIN_SUFFIX)
 else
 PROGRAM = $(MOZ_APP_NAME)-bin$(BIN_SUFFIX)
@@ -97,10 +98,12 @@ endif
 
 # These go in _tests/ so they need to go up an extra path segement
 TEST_DRIVER_PPARGS = 	\
 			-DBROWSER_PATH=$(browser_path) \
 			-DXPC_BIN_PATH=\"../$(DIST)/bin\" \
+			-DBIN_SUFFIX=\"$(BIN_SUFFIX)\" \
+			-DCERTS_DIR=\"../$(_CERTS_DIR)\" \
 			$(NULL)
 
 ifeq ($(OS_ARCH),Darwin)
 TEST_DRIVER_PPARGS += -DIS_MAC=1
 else
@@ -127,5 +130,11 @@ automation.py: $(topsrcdir)/build/pgo/au
 
 GARBAGE += runtests.py automation.py
 
 libs:: $(_SERV_FILES)
 	$(INSTALL) $^ $(_DEST_DIR)
+
+#XXX: need to fix bug 447642
+ifdef ENABLE_TESTS
+libs::
+	$(PYTHON) $(DEPTH)/_profile/pgo/genpgocert.py --gen-server
+endif
\ No newline at end of file
diff -r f3ac957eb4af testing/mochitest/server.js
--- a/testing/mochitest/server.js	Thu Sep 04 12:36:46 2008 -0400
+++ b/testing/mochitest/server.js	Sat Sep 06 10:14:38 2008 +0300
@@ -220,11 +220,11 @@ function processLocations(server)
                ")" +
                ":" +
                "(\\d+)" +
                "(?:" +
                "\\s+" +
-               "(\\w+(?:,\\w+)*)" +
+               "(\\S+(?:,\\S+)*)" +
                ")?$");
 
   var line = {};
   var lineno = 0;
   var seenPrimary = false;
diff -r f3ac957eb4af testing/mochitest/ssltunnel/ssltunnel.cpp
--- a/testing/mochitest/ssltunnel/ssltunnel.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/testing/mochitest/ssltunnel/ssltunnel.cpp	Sat Sep 06 10:14:38 2008 +0300
@@ -48,19 +48,20 @@
 #include "nss.h"
 #include "pk11func.h"
 #include "key.h"
 #include "keyt.h"
 #include "ssl.h"
+#include "plhash.h"
 
 using std::string;
 using std::vector;
 
 // Structs for passing data into jobs on the thread pool
 typedef struct {
   PRInt32 listen_port;
-  PRNetAddr remote_addr;
   string cert_nickname;
+  PLHashTable* host_cert_table;
 } server_info_t;
 
 typedef struct {
   PRFileDesc* client_sock;
   PRNetAddr client_addr;
@@ -111,24 +112,112 @@ const PRInt32 MAX_THREADS = 5;
 const PRInt32 MAX_THREADS = 5;
 const PRInt32 DEFAULT_STACKSIZE = (512 * 1024);
 const PRInt32 BUF_SIZE = 4096;
 
 // global data
+string nssconfigdir;
+vector<server_info_t> servers;
+PRNetAddr remote_addr;
 PRThreadPool* threads = NULL;
 PRLock* shutdown_lock = NULL;
 PRCondVar* shutdown_condvar = NULL;
 // Not really used, unless something fails to start
 bool shutdown_server = false;
+bool do_http_proxy = false;
+bool any_host_cert_mapping = false;
 
 /*
  * Signal the main thread that the application should shut down.
  */
 void SignalShutdown()
 {
   PR_Lock(shutdown_lock);
   PR_NotifyCondVar(shutdown_condvar);
   PR_Unlock(shutdown_lock);
+}
+
+bool ReadConnectRequest(server_info_t* server_info, 
+    char* bufferhead, char* buffertail, PRInt32* result, string* certificate)
+{
+  if (buffertail - bufferhead < 4)
+    return false;
+  if (strncmp(buffertail-4, "\r\n\r\n", 4))
+    return false;
+
+  *result = 400;
+
+  char* token;
+  token = strtok(bufferhead, " ");
+  if (!token) 
+    return true;
+  if (strcmp(token, "CONNECT")) 
+    return true;
+
+  token = strtok(NULL, " ");
+  void* c = PL_HashTableLookup(server_info->host_cert_table, token);
+  if (c)
+    *certificate = (char*)c;
+
+  token = strtok(NULL, "/");
+  if (strcmp(token, "HTTP"))
+    return true;
+
+  *result = 200;
+  return true;
+}
+
+bool ConfigureSSLServerSocket(PRFileDesc* socket, server_info_t* si, string &certificate)
+{
+  const char* certnick = certificate.empty() ?
+      si->cert_nickname.c_str() : certificate.c_str();
+
+  AutoCert cert(PK11_FindCertFromNickname(
+      certnick, NULL));
+  if (!cert) {
+    fprintf(stderr, "Failed to find cert %s\n", si->cert_nickname.c_str());
+    return false;
+  }
+
+  AutoKey privKey(PK11_FindKeyByAnyCert(cert, NULL));
+  if (!privKey) {
+    fprintf(stderr, "Failed to find private key\n");
+    return false;
+  }
+
+  PRFileDesc* ssl_socket = SSL_ImportFD(NULL, socket);
+  if (!ssl_socket) {
+    fprintf(stderr, "Error importing SSL socket\n");
+    return false;
+  }
+
+  SSLKEAType certKEA = NSS_FindCertKEAType(cert);
+  if (SSL_ConfigSecureServer(ssl_socket, cert, privKey, certKEA)
+      != SECSuccess) {
+    fprintf(stderr, "Error configuring SSL server socket\n");
+    return false;
+  }
+
+  SSL_OptionSet(ssl_socket, SSL_SECURITY, PR_TRUE);
+  SSL_OptionSet(ssl_socket, SSL_HANDSHAKE_AS_CLIENT, PR_FALSE);
+  SSL_OptionSet(ssl_socket, SSL_HANDSHAKE_AS_SERVER, PR_TRUE);
+  SSL_ResetHandshake(ssl_socket, PR_TRUE);
+
+  return true;
+}
+
+bool ConnectSocket(PRFileDesc *fd, const PRNetAddr *addr, PRIntervalTime timeout)
+{
+  PRStatus stat = PR_Connect(fd, addr, timeout);
+  if (stat != PR_SUCCESS)
+    return false;
+
+  PRSocketOptionData option;
+  option.option = PR_SockOpt_Nonblocking;
+  option.value.non_blocking = PR_TRUE;
+  PR_SetSocketOption(fd, &option);
+
+  return true;
 }
 
 /*
  * Handle an incoming client connection. The server thread has already
  * accepted the connection, so we just need to connect to the remote
@@ -143,47 +232,198 @@ void PR_CALLBACK HandleConnection(void* 
   PRIntervalTime short_timeout = PR_MillisecondsToInterval(250);
 
   AutoFD other_sock(PR_NewTCPSocket());
   bool client_done = false;
   bool client_error = false;
-  PRUint8 buf[BUF_SIZE];
+  bool connect_accepted = !do_http_proxy;
+  bool ssl_updated = !do_http_proxy;
+  string certificateToUse;
 
-  if (other_sock &&
-      PR_Connect(other_sock, &ci->server_info->remote_addr, connect_timeout)
-      == PR_SUCCESS) {
-    PRInt32 bytes = PR_Recv(ci->client_sock, buf, BUF_SIZE, 0, short_timeout);
-    if (bytes > 0 &&
-        PR_Send(other_sock, buf, bytes, 0, short_timeout) > 0) {
-      bytes = PR_Recv(other_sock, buf, BUF_SIZE, 0, short_timeout);
-      while (bytes > 0) {
-        if (PR_Send(ci->client_sock, buf, bytes, 0, short_timeout) == -1) {
+  if (other_sock) 
+  {
+    PRInt32 numberOfSockets = 1;
+
+    struct relayBuffer
+    {
+      char *buffer, *bufferhead, *buffertail, *bufferend;
+      relayBuffer() 
+      { 
+        bufferhead = buffertail = buffer = new char[BUF_SIZE]; 
+        bufferend = buffer + BUF_SIZE; 
+      }
+      ~relayBuffer() 
+      { 
+        delete [] buffer; 
+      }
+
+      bool empty() 
+      { 
+        return bufferhead == buffertail; 
+      }
+      PRInt32 free() 
+      { 
+        return bufferend - buffertail; 
+      }
+      PRInt32 present() 
+      { 
+        return buffertail - bufferhead; 
+      }
+      void compact() 
+      { 
+        if (buffertail == bufferhead) 
+          buffertail = bufferhead = buffer;
+      }
+    } buffers[2];
+
+    if (!do_http_proxy)
+    {
+      if (!ConfigureSSLServerSocket(ci->client_sock, ci->server_info, certificateToUse))
+        client_error = true;
+      else if (!ConnectSocket(other_sock, &remote_addr, connect_timeout))
+        client_error = true;
+      else
+        numberOfSockets = 2;
+    }
+
+    PRPollDesc sockets[2] = 
+    { 
+      {ci->client_sock, PR_POLL_READ, 0},
+      {other_sock, PR_POLL_READ, 0}
+    };
+
+    while (!((client_error||client_done) && buffers[0].empty() && buffers[1].empty()))
+    {
+      sockets[0].in_flags |= PR_POLL_EXCEPT;
+      sockets[1].in_flags |= PR_POLL_EXCEPT;
+      PRInt32 pollStatus = PR_Poll(sockets, numberOfSockets, PR_MillisecondsToInterval(1000));
+      if (pollStatus < 0)
+      {
+        client_error = true;
+        break;
+      }
+
+      if (pollStatus == 0)
+        // timeout
+        continue;
+
+      for (PRInt32 s = 0; s < numberOfSockets; ++s)
+      {
+        PRInt32 s2 = s == 1 ? 0 : 1;
+        PRInt16 out_flags = sockets[s].out_flags;
+        PRInt16 &in_flags = sockets[s].in_flags;
+        PRInt16 &in_flags2 = sockets[s2].in_flags;
+        sockets[s].out_flags = 0;
+
+        if (out_flags & PR_POLL_EXCEPT)
+        {
           client_error = true;
-          break;
-        }
-        if (!client_done) {
-          bytes = PR_Recv(ci->client_sock, buf, BUF_SIZE, 0, short_timeout);
-          if (bytes > 0) {
-            if (PR_Send(other_sock, buf, bytes, 0, short_timeout) == -1)
+          continue;
+        } // PR_POLL_EXCEPT handling
+
+        if (out_flags & PR_POLL_READ && buffers[s].free())
+        {
+          PRInt32 bytesRead = PR_Recv(sockets[s].fd, buffers[s].buffertail, 
+              buffers[s].free(), 0, PR_INTERVAL_NO_TIMEOUT);
+
+          if (bytesRead == 0)
+          {
+            client_done = true;
+            in_flags &= ~PR_POLL_READ;
+          }
+          else if (bytesRead < 0)
+          {
+            if (PR_GetError() != PR_WOULD_BLOCK_ERROR)
+              client_error = true;
+          }
+          else
+          {
+            buffers[s].buffertail += bytesRead;
+
+            // We have to accept and handle the initial CONNECT request here
+            PRInt32 response;
+            if (!connect_accepted && ReadConnectRequest(ci->server_info, buffers[s].bufferhead, buffers[s].buffertail, 
+                &response, &certificateToUse))
+            {
+              // Clean the request as it would be read
+              buffers[s].bufferhead = buffers[s].buffertail = buffers[s].buffer;
+
+              // Store response to the oposite buffer
+              if (response != 200)
+              {
+                client_done = true;
+                sprintf(buffers[s2].buffer, "HTTP/1.1 %d ERROR\r\nConnection: close\r\n\r\n", response);
+                buffers[s2].buffertail = buffers[s2].buffer + strlen(buffers[s2].buffer);
+                break;
+              }
+
+              strcpy(buffers[s2].buffer, "HTTP/1.1 200 Connected\r\nConnection: keep-alive\r\n\r\n");
+              buffers[s2].buffertail = buffers[s2].buffer + strlen(buffers[s2].buffer);
+
+              if (!ConnectSocket(other_sock, &remote_addr, connect_timeout))
+              {
+                client_error = true;
+                break;
+              }
+
+              // Send the response to the client socket
+              in_flags |= PR_POLL_WRITE;
+              connect_accepted = true;
               break;
+            } // end of CONNECT handling
+
+            if (!buffers[s].free()) // Do not poll for read when the buffer is full
+              in_flags &= ~PR_POLL_READ;
+
+            if (ssl_updated)
+              in_flags2 |= PR_POLL_WRITE;
           }
-          else if (bytes == 0) {
-            client_done = true;
+        } // PR_POLL_READ handling
+
+        if (out_flags & PR_POLL_WRITE)
+        {
+          PRInt32 bytesWrite = PR_Send(sockets[s].fd, buffers[s2].bufferhead, 
+              buffers[s2].present(), 0, PR_INTERVAL_NO_TIMEOUT);
+
+          if (bytesWrite < 0)
+          {
+            if (PR_GetError() != PR_WOULD_BLOCK_ERROR)
+              client_error = true;
           }
-          else  {// error
-            client_error = true;
-            break;
+          else
+          {
+            buffers[s2].bufferhead += bytesWrite;
+            if (buffers[s2].present())
+              in_flags |= PR_POLL_WRITE;              
+            else
+            {
+              if (!ssl_updated)
+              {
+                // Proxy response has just been writen, update to ssl
+                ssl_updated = true;
+                if (!ConfigureSSLServerSocket(ci->client_sock, ci->server_info, certificateToUse))
+                {
+                  client_error = true;
+                  break;
+                }
+
+                numberOfSockets = 2;
+              } // sslUpdate
+
+              in_flags &= ~PR_POLL_WRITE;              
+              in_flags2 |= PR_POLL_READ;
+              buffers[s2].compact();
+            }
           }
-        }
-        bytes = PR_Recv(other_sock, buf, BUF_SIZE, 0, short_timeout);
-      }
-    }
-    else if (bytes == -1) {
-      client_error = true;
-    }
+        } // PR_POLL_WRITE handling
+      } // for...
+    } // while, poll
   }
+  else
+    client_error = true;
+
   if (!client_error)
-    PR_Shutdown(ci->client_sock, PR_SHUTDOWN_BOTH);
+    PR_Shutdown(ci->client_sock, PR_SHUTDOWN_SEND);
   PR_Close(ci->client_sock);
 
   delete ci;
 }
 
@@ -196,25 +436,10 @@ void PR_CALLBACK StartServer(void* data)
 void PR_CALLBACK StartServer(void* data)
 {
   server_info_t* si = static_cast<server_info_t*>(data);
 
   //TODO: select ciphers?
-  AutoCert cert(PK11_FindCertFromNickname(si->cert_nickname.c_str(),
-                                          NULL));
-  if (!cert) {
-    fprintf(stderr, "Failed to find cert %s\n", si->cert_nickname.c_str());
-    SignalShutdown();
-    return;
-  }
-
-  AutoKey privKey(PK11_FindKeyByAnyCert(cert, NULL));
-  if (!privKey) {
-    fprintf(stderr, "Failed to find private key\n");
-    SignalShutdown();
-    return;
-  }
-
   AutoFD listen_socket(PR_NewTCPSocket());
   if (!listen_socket) {
     fprintf(stderr, "failed to create socket\n");
     SignalShutdown();
     return;
@@ -232,34 +457,25 @@ void PR_CALLBACK StartServer(void* data)
     fprintf(stderr, "failed to listen on socket\n");
     SignalShutdown();
     return;
   }
 
-  PRFileDesc* ssl_socket = SSL_ImportFD(NULL, listen_socket);
-  if (!ssl_socket) {
-    fprintf(stderr, "Error importing SSL socket\n");
-    SignalShutdown();
-    return;
-  }
-  listen_socket.reset(ssl_socket);
-
-  if (SSL_ConfigSecureServer(listen_socket, cert, privKey, kt_rsa)
-      != SECSuccess) {
-    fprintf(stderr, "Error configuring SSL listen socket\n");
-    SignalShutdown();
-    return;
-  }
-
   printf("Server listening on port %d with cert %s\n", si->listen_port,
          si->cert_nickname.c_str());
 
   while (!shutdown_server) {
     connection_info_t* ci = new connection_info_t();
     ci->server_info = si;
     // block waiting for connections
     ci->client_sock = PR_Accept(listen_socket, &ci->client_addr,
                                 PR_INTERVAL_NO_TIMEOUT);
+    
+    PRSocketOptionData option;
+    option.option = PR_SockOpt_Nonblocking;
+    option.value.non_blocking = PR_TRUE;
+    PR_SetSocketOption(ci->client_sock, &option);
+
     if (ci->client_sock)
       // Not actually using this PRJob*...
       //PRJob* job =
       PR_QueueJob(threads, HandleConnection, ci, PR_TRUE);
     else
@@ -274,49 +490,198 @@ char* password_func(PK11SlotInfo* slot, 
     return NULL;
 
   return "";
 }
 
-int main(int argc, char** argv)
+server_info_t* findServerInfo(int portnumber)
 {
-  if (argc < 6) {
-    fprintf(stderr, "Error: not enough arguments\n"
-            "Usage: ssltunnel <NSS db path> <remote ip> <remote port> (<certname> <port>)+\n"
-            "       Provide SSL encrypted tunnels to <remote ip>:<remote port>\n"
-            "       from each port specified in a <certname>,<port> pair.\n"
-            "       <certname> must be the nickname of a server certificate\n"
-            "       installed in the NSS db pointed to by the <NSS db path>.\n");
+  for (vector<server_info_t>::iterator it = servers.begin();
+       it != servers.end(); it++) 
+  {
+    if (it->listen_port == portnumber)
+      return &(*it);
+  }
+
+  return NULL;
+}
+
+int processConfigLine(char* configLine)
+{
+  if (*configLine == 0 || *configLine == '#')
+    return 0;
+
+  char* keyword = strtok(configLine, ":");
+
+  // Configure usage of http/ssl tunneling proxy behavior
+  if (!strcmp(keyword, "httpproxy"))
+  {
+    char* value = strtok(NULL, ":");
+    if (!strcmp(value, "1"))
+      do_http_proxy = true;
+
+    return 0;
+  }
+
+  // Configure the forward address of the target server
+  if (!strcmp(keyword, "forward"))
+  {
+    char* ipstring = strtok(NULL, ":");
+    if (PR_StringToNetAddr(ipstring, &remote_addr) != PR_SUCCESS) {
+      fprintf(stderr, "Invalid remote IP address: %s\n", ipstring);
+      return 1;
+    }
+    char* portstring = strtok(NULL, ":");
+    int port = atoi(portstring);
+    if (port <= 0) {
+      fprintf(stderr, "Invalid remote port: %s\n", portstring);
+      return 1;
+    }
+    remote_addr.inet.port = PR_htons(port);
+
+    return 0;
+  }
+
+  // Configure all listen sockets and port+certificate bindings
+  if (!strcmp(keyword, "listen"))
+  {
+    char* hostname = strtok(NULL, ":");
+    char* hostportstring = NULL;
+    if (strcmp(hostname, "*"))
+    {
+      any_host_cert_mapping = true;
+      hostportstring = strtok(NULL, ":");
+    }
+
+    char* portstring = strtok(NULL, ":");
+    char* certnick = strtok(NULL, ":");
+
+    int port = atoi(portstring);
+    if (port <= 0) {
+      fprintf(stderr, "Invalid port specified: %s\n", portstring);
+      return 1;
+    }
+
+    if (server_info_t* existingServer = findServerInfo(port))
+    {
+      char *certnick_copy = new char[strlen(certnick)+1];
+      char *hostname_copy = new char[strlen(hostname)+strlen(hostportstring)+2];
+
+      strcpy(hostname_copy, hostname);
+      strcat(hostname_copy, ":");
+      strcat(hostname_copy, hostportstring);
+      strcpy(certnick_copy, certnick);
+
+      PL_HashTableAdd(existingServer->host_cert_table, hostname_copy, certnick_copy);
+    }
+    else
+    {
+      server_info_t server;
+      server.cert_nickname = certnick;
+      server.listen_port = port;
+      server.host_cert_table = PL_NewHashTable(0, PL_HashString, PL_CompareStrings, PL_CompareStrings, NULL, NULL);
+      if (!server.host_cert_table)
+      {
+        fprintf(stderr, "Internal, could not create hash table\n");
+        return 1;
+      }
+      servers.push_back(server);
+    }
+
+    return 0;
+  }
+  
+  // Configure the NSS certificate database directory
+  if (!strcmp(keyword, "certdbdir"))
+  {
+    nssconfigdir = strtok(NULL, "\n");
+    return 0;
+  }
+
+  printf("Error: keyword \"%s\" unexpected\n", keyword);
+  return 1;
+}
+
+int parseConfigFile(const char* filePath)
+{
+  FILE* f = fopen(filePath, "r");
+  if (!f)
+    return 1;
+
+  char buffer[1024], *b = buffer;
+  while (!feof(f))
+  {
+    char c;
+    fscanf(f, "%c", &c);
+    switch (c)
+    {
+    case '\n':
+      *b++ = 0;
+      if (processConfigLine(buffer))
+        return 1;
+      b = buffer;
+    case '\r':
+      continue;
+    default:
+      *b++ = c;
+    }
+  }
+
+  fclose(f);
+
+  // Check mandatory items
+  if (nssconfigdir.empty())
+  {
+    printf("Error: missing path to NSS certification database\n,use certdbdir:<path> in the config file\n");
     return 1;
   }
 
-
-  PRNetAddr remote_addr;
-  if (PR_StringToNetAddr(argv[2], &remote_addr) != PR_SUCCESS) {
-    fprintf(stderr, "Invalid remote IP address: %s\n", argv[2]);
-    return 1;
+  if (any_host_cert_mapping && !do_http_proxy)
+  {
+    printf("Warning: any host-specific certificate configurations are ignored, add httpproxy:1 to allow them\n");
   }
 
-  int port = atoi(argv[3]);
-  if (port <= 0) {
-    fprintf(stderr, "Invalid remote port: %s\n", argv[2]);
+  return 0;
+}
+
+PRIntn PR_CALLBACK freeHashItems(PLHashEntry *he, PRIntn i, void *arg)
+{
+  delete [] (char*)he->key;
+  delete [] (char*)he->value;
+  return HT_ENUMERATE_REMOVE;
+}
+
+int main(int argc, char** argv)
+{
+  char* configFilePath;
+  if (argc == 1)
+    configFilePath = "ssltunnel.cfg";
+  else
+    configFilePath = argv[1];
+
+  if (parseConfigFile(configFilePath)) {
+    fprintf(stderr, "Error: config file \"%s\" missing or formating incorrect\n"
+      "Specify path to the config file as parameter to ssltunnel or \n"
+      "create ssltunnel.cfg in the working directory.\n\n"
+      "Example format of the config file:\n\n"
+      "       # Enable http/ssl tunneling proxy-like behavior.\n"
+      "       # If not specified ssltunnel simply does direct forward.\n"
+      "       httpproxy:1\n\n"
+      "       # Specify path to the certification database used.\n"
+      "       certdbdir:/path/to/certdb\n\n"
+      "       # Forward/proxy all requests in raw to 127.0.0.1:8888.\n"
+      "       forward:127.0.0.1:8888\n\n"
+      "       # Accept connections on port 4443 or 5678 resp. and authenticate\n"
+      "       # to any host ('*') using the 'server cert' or 'server cert 2' resp.\n"
+      "       listen:*:4443:server cert\n"
+      "       listen:*:5678:server cert 2\n\n"
+      "       # Accept connections on port 4443 and authenticate using\n"
+      "       # 'a different cert' when target host is 'my.host.name:443'.\n"
+      "       # This works only in httpproxy mode and has higher priority\n"
+      "       # then the previews option.\n"
+      "       listen:my.host.name:443:4443:a different cert\n",
+      configFilePath);
     return 1;
-  }
-  remote_addr.inet.port = PR_htons(port);
-
-  // get our list of cert:port from the remaining args
-  vector<server_info_t> servers;
-  for (int i=4; i<argc; i++) {
-    server_info_t server;
-    memcpy(&server.remote_addr, &remote_addr, sizeof(PRNetAddr));
-    server.cert_nickname = argv[i++];
-    port = atoi(argv[i]);
-    if (port <= 0) {
-      fprintf(stderr, "Invalid port specified: %s\n", argv[i]);
-      return 1;
-    }
-    server.listen_port = port;
-    servers.push_back(server);
   }
 
   // create a thread pool to handle connections
   threads = PR_CreateThreadPool(std::max<PRInt32>(INITIAL_THREADS,
                                                   servers.size()*2),
@@ -343,13 +708,11 @@ int main(int argc, char** argv)
   }
 
   PK11_SetPasswordFunc(password_func);
 
   // Initialize NSS
-  char* configdir = argv[1];
-
-  if (NSS_Init(configdir) != SECSuccess) {
+  if (NSS_Init(nssconfigdir.c_str()) != SECSuccess) {
     PRInt32 errorlen = PR_GetErrorTextLength();
     char* err = new char[errorlen+1];
     PR_GetErrorText(err);
     fprintf(stderr, "Failed to init NSS: %s", err);
     delete[] err;
@@ -396,8 +759,16 @@ int main(int argc, char** argv)
   PR_DestroyCondVar(shutdown_condvar);
   PR_DestroyLock(shutdown_lock);
   if (NSS_Shutdown() == SECFailure) {
     fprintf(stderr, "Leaked NSS objects!\n");
   }
+  
+  for (vector<server_info_t>::iterator it = servers.begin();
+       it != servers.end(); it++) 
+  {
+    PL_HashTableEnumerateEntries(it->host_cert_table, freeHashItems, NULL);
+    PL_HashTableDestroy(it->host_cert_table);
+  }
+
   PR_Cleanup();
   return 0;
 }
diff -r f3ac957eb4af testing/sisyphus/bin/builder.sh
--- a/testing/sisyphus/bin/builder.sh	Thu Sep 04 12:36:46 2008 -0400
+++ b/testing/sisyphus/bin/builder.sh	Sat Sep 06 10:14:38 2008 +0300
@@ -53,11 +53,11 @@ usage:
 
 variable            description
 ===============     ===========================================================
 -p products         required. one or more of firefox thunderbird
 -b branches         required. one or more of 1.8.0 1.8.1 1.9.0 1.9.1
--B buildcommands    required. one or more of clean checkout build
+-B buildcommands    required. one or more of clean clobber checkout build
 -T buildtypes       required. one or more of opt debug
 -e extra            optional. extra qualifier to pick build tree and mozconfig.
 -d datafiles        optional. one or more filenames of files containing 
                     environment variable definitions to be included.
 -v                  optional. verbose - copies log file output to stdout.
@@ -112,10 +112,31 @@ if echo "$buildcommands" | grep -iq clea
             done
         done
     done
 fi
 
+# clobber first in case checkout changes the configuration
+if echo "$buildcommands" | grep -iq clobber; then
+    for product in $products; do
+        for branch in $branches; do
+            for buildtype in $buildtypes; do
+
+                TEST_DATE=`date -u +%Y-%m-%d-%H-%M-%S``date +%z`
+                TEST_LOG="${TEST_DIR}/results/${TEST_DATE},$product,$branch$extra,$buildtype,$OSID,${TEST_MACHINE},clobber.log"
+
+                echo "log: $TEST_LOG"
+
+                if [[ "$verbose" == "1" ]]; then
+                    clobber.sh -p $product -b $branch -T $buildtype $extraflag 2>&1 | tee $TEST_LOG
+                else
+                    clobber.sh -p $product -b $branch -T $buildtype $extraflag > $TEST_LOG 2>&1
+                fi
+            done
+        done
+    done
+fi
+
 # if checkout, ignore buildtypes
 if echo "$buildcommands" | grep -iq checkout; then
     for product in $products; do
         for branch in $branches; do
 
diff -r f3ac957eb4af testing/sisyphus/bin/checkout.sh
--- a/testing/sisyphus/bin/checkout.sh	Thu Sep 04 12:36:46 2008 -0400
+++ b/testing/sisyphus/bin/checkout.sh	Sat Sep 06 10:14:38 2008 +0300
@@ -58,17 +58,18 @@ if [[ "$branch" == "1.9.1" ]]; then
     if [[ ! -d $BUILDDIR/hg.mozilla.org ]]; then
         mkdir $BUILDDIR/hg.mozilla.org
     fi
 
     if [[ ! -d $TEST_MOZILLA_HG_LOCAL ]]; then
-        if ! hg clone -r $TEST_MOZILLA_HG_REV $TEST_MOZILLA_HG $TEST_MOZILLA_HG_LOCAL; then
+        if ! hg clone $TEST_MOZILLA_HG $TEST_MOZILLA_HG_LOCAL; then
             error "during hg clone of $TEST_MOZILLA_HG" $LINENO
         fi
     fi
 
     cd $TEST_MOZILLA_HG_LOCAL
-    hg pull
+    hg pull -u
+    echo "`hg root` id `hg id`"
 fi
 
 cd $BUILDTREE
 
 case $product in
@@ -88,18 +89,27 @@ case $product in
                 fi
                 ;;
 
             1.9.1)
 
-                if [[ ! -e mozilla/client.py ]]; then
+                if [[ ! -d mozilla/.hg ]]; then
                     if ! hg clone $TEST_MOZILLA_HG_LOCAL $BUILDTREE/mozilla; then
                         error "during hg clone of $TEST_MOZILLA_HG_LOCAL" $LINENO
                     fi
                 fi
 
                 cd mozilla
-                hg pull -u -r $TEST_MOZILLA_HG_REV
+                hg pull
+
+                hg update -r $TEST_MOZILLA_HG_REV
+
+                echo "`hg root` id `hg id`"
+
+                if [[ -n "$DATE_CO_FLAGS" ]]; then
+                    eval hg update $DATE_CO_FLAGS
+                    echo "Update to date $MOZ_CO_DATE `hg root` id `hg id`"
+                fi
                 
                 # do not use mozilla-build on windows systems as we 
                 # must use the cygwin python with the cygwin mercurial.
 
                 if ! python client.py checkout; then
@@ -139,18 +149,28 @@ case $product in
                     error "during checkout of $project tree" $LINENO
                 fi
                 ;;
 
             1.9.1)
-                if [[ ! -e mozilla/client.py ]]; then
+                if [[ ! -d mozilla/.hg ]]; then
                     if ! hg clone $TEST_MOZILLA_HG_LOCAL $BUILDTREE/mozilla; then
                         error "during hg clone of $TEST_MOZILLA_HG_LOCAL" $LINENO
                     fi
                 fi
 
                 cd mozilla
-                hg pull -u -r $TEST_MOZILLA_HG_REV
+                hg pull
+
+                hg update -r $TEST_MOZILLA_HG_REV
+
+                echo "`hg root` id `hg id`"
+
+                if [[ -n "$DATE_CO_FLAGS" ]]; then
+                    eval hg update $DATE_CO_FLAGS
+                    echo "Update to date $MOZ_CO_DATE `hg root` id `hg id`"
+                fi
+                
 
                 # do not use mozilla-build on windows systems as we 
                 # must use the cygwin python with the cygwin mercurial.
 
                 if ! python client.py checkout; then
@@ -187,18 +207,28 @@ case $product in
                 fi
                 ;;
 
             1.9.1)
 
-                if [[ ! -e mozilla/client.py ]]; then
+                if [[ ! -d mozilla/.hg ]]; then
                     if ! hg clone $TEST_MOZILLA_HG_LOCAL $BUILDTREE/mozilla; then
                         error "during hg clone of $TEST_MOZILLA_HG_LOCAL" $LINENO
                     fi
                 fi
 
                 cd mozilla
-                hg pull -u -r $TEST_MOZILLA_HG_REV
+                hg pull
+
+                hg update -r $TEST_MOZILLA_HG_REV
+
+                echo "`hg root` id `hg id`"
+
+                if [[ -n "$DATE_CO_FLAGS" ]]; then
+                    eval hg update $DATE_CO_FLAGS
+                    echo "Update to date $MOZ_CO_DATE `hg root` id `hg id`"
+                fi
+                
 
                 # do not use mozilla-build on windows systems as we 
                 # must use the cygwin python with the cygwin mercurial.
 
                 if ! python client.py checkout; then
diff -r f3ac957eb4af testing/sisyphus/bin/set-build-env.sh
--- a/testing/sisyphus/bin/set-build-env.sh	Thu Sep 04 12:36:46 2008 -0400
+++ b/testing/sisyphus/bin/set-build-env.sh	Sat Sep 06 10:14:38 2008 +0300
@@ -133,11 +133,15 @@ for step in step1; do # dummy loop for h
         echo "Unknown branch: $branch"
         myexit 1
     fi
 
     if [[ -n "$MOZ_CO_DATE" ]]; then
-        export DATE_CO_FLAGS="-D \"$MOZ_CO_DATE\""
+        if [[ $branch == "1.8.0" || $branch == "1.8.1" || $branch == "1.9.0" ]]; then
+            export DATE_CO_FLAGS="-D \"$MOZ_CO_DATE\""
+        else
+            export DATE_CO_FLAGS="--date \"<$MOZ_CO_DATE\""
+        fi
     fi
 
     case $OSID in 
         nt)
 
@@ -222,17 +226,14 @@ for step in step1; do # dummy loop for h
     export SHELL=$buildbash
     export CONFIG_SHELL=$buildbash
     export CONFIGURE_ENV_ARGS=$buildbash
 
 
-    export TEST_MOZILLA_HG=${TEST_MOZILLA_HG:-http://hg.mozilla.org/mozilla-central/}
-    export TEST_MOZILLA_HG_REV=${TEST_MOZILLA_HG_REV:-tip}
-
     if [[ -z $extra ]]; then
-        export BUILDTREE="$BUILDDIR/$branch"
+        export BUILDTREE="${BUILDTREE:-$BUILDDIR/$branch}"
     else
-        export BUILDTREE="$BUILDDIR/$branch$extra"
+        export BUILDTREE="${BUILDTREE:-$BUILDDIR/$branch$extra}"
 
         #
         # extras can't be placed in mozconfigs since not all parts
         # of the build system use mozconfig (e.g. js shell) and since
         # the obj directory is not configurable for them as well thus
@@ -254,11 +255,12 @@ for step in step1; do # dummy loop for h
                 export CFLAGS="--coverage"
                 export CXXFLAGS="--coverage"
                 export XCFLAGS="--coverage"
                 export OS_CFLAGS="--coverage"
                 export LDFLAGS="--coverage"
-                export XLDOPTS="--coverage"	
+                export XLDFLAGS="--coverage"
+                export XLDOPTS="--coverage"
                 ;;
             -jprof)
                 ;;
         esac
     fi
@@ -270,19 +272,24 @@ for step in step1; do # dummy loop for h
 
     # here project refers to either browser or mail
     # and is used to find mozilla/(browser|mail)/config/mozconfig
     if [[ $product == "firefox" ]]; then
         project=browser
+        export TEST_MOZILLA_HG=${TEST_MOZILLA_HG:-http://hg.mozilla.org/mozilla-central/}
         export MOZCONFIG=${MOZCONFIG:-"$BUILDTREE/mozconfig-firefox-$OSID-$TEST_PROCESSORTYPE-$buildtype"}
     elif [[ $product == "thunderbird" ]]; then
         project=mail
+        export TEST_MOZILLA_HG=${TEST_MOZILLA_HG:-http://hg.mozilla.org/comm-central/}
         export MOZCONFIG=${MOZCONFIG:-"$BUILDTREE/mozconfig-thunderbird-$OSID-$TEST_PROCESSORTYPE-$buildtype"}
     else
         echo "Assuming project=browser for product: $product"
         project=browser
+        export TEST_MOZILLA_HG=${TEST_MOZILLA_HG:-http://hg.mozilla.org/mozilla-central/}
         export MOZCONFIG=${MOZCONFIG:-"$BUILDTREE/mozconfig-firefox-$OSID-$TEST_PROCESSORTYPE-$buildtype"}
     fi
+
+    export TEST_MOZILLA_HG_REV=${TEST_MOZILLA_HG_REV:-tip}
 
     # js shell builds
     if [[ $buildtype == "debug" ]]; then
         unset BUILD_OPT
     else
diff -r f3ac957eb4af testing/sisyphus/data/firefox,1.9.1,nightly-darwin.data
--- a/testing/sisyphus/data/firefox,1.9.1,nightly-darwin.data	Thu Sep 04 12:36:46 2008 -0400
+++ b/testing/sisyphus/data/firefox,1.9.1,nightly-darwin.data	Sat Sep 06 10:14:38 2008 +0300
@@ -5,5 +5,6 @@ profiledirectory=/tmp/firefox-1.9.1-prof
 profiledirectory=/tmp/firefox-1.9.1-profile
 executablepath=/tmp/firefox-1.9.1
 userpreferences=${TEST_DIR}/prefs/test-user.js
 extensiondir=${TEST_DIR}/xpi
 buildtype=nightly
+TEST_MOZILLA_HG=http://hg.mozilla.org/mozilla-central
diff -r f3ac957eb4af testing/sisyphus/data/firefox,1.9.1,nightly-linux.data
--- a/testing/sisyphus/data/firefox,1.9.1,nightly-linux.data	Thu Sep 04 12:36:46 2008 -0400
+++ b/testing/sisyphus/data/firefox,1.9.1,nightly-linux.data	Sat Sep 06 10:14:38 2008 +0300
@@ -5,5 +5,6 @@ profiledirectory=/tmp/firefox-1.9.1-prof
 profiledirectory=/tmp/firefox-1.9.1-profile
 executablepath=/tmp/firefox-1.9.1
 userpreferences=${TEST_DIR}/prefs/test-user.js
 extensiondir=${TEST_DIR}/xpi
 buildtype=nightly
+TEST_MOZILLA_HG=http://hg.mozilla.org/mozilla-central
diff -r f3ac957eb4af testing/sisyphus/data/firefox,1.9.1,nightly-nt.data
--- a/testing/sisyphus/data/firefox,1.9.1,nightly-nt.data	Thu Sep 04 12:36:46 2008 -0400
+++ b/testing/sisyphus/data/firefox,1.9.1,nightly-nt.data	Sat Sep 06 10:14:38 2008 +0300
@@ -5,5 +5,6 @@ profiledirectory=/tmp/firefox-1.9.1-prof
 profiledirectory=/tmp/firefox-1.9.1-profile
 executablepath=/tmp/firefox-1.9.1
 userpreferences=${TEST_DIR}/prefs/test-user.js
 extensiondir=${TEST_DIR}/xpi
 buildtype=nightly
+TEST_MOZILLA_HG=http://hg.mozilla.org/mozilla-central
diff -r f3ac957eb4af testing/sisyphus/data/firefox,1.9.1-actionmonkey,debug.data
--- a/testing/sisyphus/data/firefox,1.9.1-actionmonkey,debug.data	Thu Sep 04 12:36:46 2008 -0400
+++ b/testing/sisyphus/data/firefox,1.9.1-actionmonkey,debug.data	Sat Sep 06 10:14:38 2008 +0300
@@ -1,9 +1,9 @@ product=firefox
 product=firefox
 branch=1.9.1
-profilename=firefox-1.9.1-test-profile
-profiledirectory=/tmp/firefox-1.9.1-test-profile
-executablepath=${BUILDDIR}/1.9.1-test/mozilla/firefox-debug/dist
+profilename=firefox-1.9.1-actionmonkey-profile
+profiledirectory=/tmp/firefox-1.9.1-actionmonkey-profile
+executablepath=${BUILDDIR}/1.9.1-actionmonkey/mozilla/firefox-debug/dist
 userpreferences=${TEST_DIR}/prefs/test-user.js
 extensiondir=${TEST_DIR}/xpi
 buildtype=debug
 TEST_MOZILLA_HG=http://hg.mozilla.org/actionmonkey
diff -r f3ac957eb4af testing/sisyphus/data/firefox,1.9.1-actionmonkey,opt.data
--- a/testing/sisyphus/data/firefox,1.9.1-actionmonkey,opt.data	Thu Sep 04 12:36:46 2008 -0400
+++ b/testing/sisyphus/data/firefox,1.9.1-actionmonkey,opt.data	Sat Sep 06 10:14:38 2008 +0300
@@ -1,9 +1,9 @@ product=firefox
 product=firefox
 branch=1.9.1
-profilename=firefox-1.9.1-test-profile
-profiledirectory=/tmp/firefox-1.9.1-test-profile
-executablepath=${BUILDDIR}/1.9.1-test/mozilla/firefox-opt/dist
+profilename=firefox-1.9.1-actionmonkey-profile
+profiledirectory=/tmp/firefox-1.9.1-actionmonkey-profile
+executablepath=${BUILDDIR}/1.9.1-actionmonkey/mozilla/firefox-opt/dist
 userpreferences=${TEST_DIR}/prefs/test-user.js
 extensiondir=${TEST_DIR}/xpi
 buildtype=opt
 TEST_MOZILLA_HG=http://hg.mozilla.org/actionmonkey
diff -r f3ac957eb4af testing/sisyphus/data/js,1.9.1-actionmonkey,debug.data
--- a/testing/sisyphus/data/js,1.9.1-actionmonkey,debug.data	Thu Sep 04 12:36:46 2008 -0400
+++ b/testing/sisyphus/data/js,1.9.1-actionmonkey,debug.data	Sat Sep 06 10:14:38 2008 +0300
@@ -1,5 +1,5 @@ product=js
 product=js
 branch=1.9.1
-jsshellsourcepath=${BUILDDIR}/1.9.1/mozilla/js/src
+jsshellsourcepath=${BUILDDIR}/1.9.1-actionmonkey/mozilla/js/src
 buildtype=debug
 TEST_MOZILLA_HG=http://hg.mozilla.org/actionmonkey
diff -r f3ac957eb4af testing/sisyphus/data/js,1.9.1-actionmonkey,opt.data
--- a/testing/sisyphus/data/js,1.9.1-actionmonkey,opt.data	Thu Sep 04 12:36:46 2008 -0400
+++ b/testing/sisyphus/data/js,1.9.1-actionmonkey,opt.data	Sat Sep 06 10:14:38 2008 +0300
@@ -1,5 +1,5 @@ product=js
 product=js
 branch=1.9.1
-jsshellsourcepath=${BUILDDIR}/1.9.1/mozilla/js/src
+jsshellsourcepath=${BUILDDIR}/1.9.1-actionmonkey/mozilla/js/src
 buildtype=opt
 TEST_MOZILLA_HG=http://hg.mozilla.org/actionmonkey
diff -r f3ac957eb4af testing/sisyphus/data/js,1.9.1-test,opt.data
--- a/testing/sisyphus/data/js,1.9.1-test,opt.data	Thu Sep 04 12:36:46 2008 -0400
+++ b/testing/sisyphus/data/js,1.9.1-test,opt.data	Sat Sep 06 10:14:38 2008 +0300
@@ -1,5 +1,5 @@ product=js
 product=js
 branch=1.9.1
 jsshellsourcepath=${BUILDDIR}/1.9.1-test/mozilla/js/src
 buildtype=opt
-TEST_MOZILLA_HG=http://hg.mozilla.org/mozilla-central
+TEST_MOZILLA_HG=http://hg.mozilla.org/mozilla-central
\ No newline at end of file
diff -r f3ac957eb4af testing/sisyphus/data/thunderbird,1.9.1,debug.data
--- a/testing/sisyphus/data/thunderbird,1.9.1,debug.data	Thu Sep 04 12:36:46 2008 -0400
+++ b/testing/sisyphus/data/thunderbird,1.9.1,debug.data	Sat Sep 06 10:14:38 2008 +0300
@@ -1,10 +1,14 @@ product=thunderbird
 product=thunderbird
 branch=1.9.1
 profilename=thunderbird-1.9.1-profile
 profiledirectory=/tmp/thunderbird-1.9.1-profile
-executablepath=${BUILDDIR}/1.9.1/mozilla/thunderbird-debug/dist
+# thunderbird from comm-central can not live in the same source tree as firefox
+# anymore since it comes from a different repository.
+# override the default build tree since the default tree location has changed
+BUILDTREE=${BUILDDIR}/1.9.1-thunderbird
+executablepath=${BUILDTREE}/mozilla/thunderbird-debug/mozilla/dist
 userpreferences=${TEST_DIR}/prefs/test-user.js
 extensiondir=${TEST_DIR}/xpi
 profiletemplate=${TEST_DIR}/profiles/imap
 buildtype=debug
-TEST_MOZILLA_HG=http://hg.mozilla.org/mozilla-central
+TEST_MOZILLA_HG=http://hg.mozilla.org/comm-central
diff -r f3ac957eb4af testing/sisyphus/data/thunderbird,1.9.1-test,debug.data
--- a/testing/sisyphus/data/thunderbird,1.9.1-test,debug.data	Thu Sep 04 12:36:46 2008 -0400
+++ b/testing/sisyphus/data/thunderbird,1.9.1-test,debug.data	Sat Sep 06 10:14:38 2008 +0300
@@ -1,13 +1,14 @@ product=thunderbird
 product=thunderbird
 branch=1.9.1
 profilename=thunderbird-1.9.1-test-profile
 profiledirectory=/tmp/thunderbird-1.9.1-test-profile
-executablepath=${BUILDDIR}/1.9.1-test/mozilla/thunderbird-debug/dist
+# thunderbird from comm-central can not live in the same source tree as firefox
+# anymore since it comes from a different repository.
+# override the default mozconfig since the default tree location has changed
+BUILDTREE=${BUILDDIR}/1.9.1-thunderbird-test
+executablepath=${BUILDTREE}/mozilla/thunderbird-debug/mozilla/dist
 userpreferences=${TEST_DIR}/prefs/test-user.js
 extensiondir=${TEST_DIR}/xpi
 profiletemplate=${TEST_DIR}/profiles/imap
 buildtype=debug
-TEST_MOZILLA_HG=http://hg.mozilla.org/mozilla-central
-
-
-
+TEST_MOZILLA_HG=http://hg.mozilla.org/comm-central
diff -r f3ac957eb4af testing/tools/profiles/createTestingProfile.py
--- a/testing/tools/profiles/createTestingProfile.py	Thu Sep 04 12:36:46 2008 -0400
+++ b/testing/tools/profiles/createTestingProfile.py	Sat Sep 06 10:14:38 2008 +0300
@@ -22,10 +22,11 @@ userPrefs = {
     'dom.disable_window_move_resize': 'false',
     'layout.fire_onload_after_image_background_loads': 'true',
     'javascript.options.showInConsole': 'true',
     'privacy.popups.firstTime': 'false',
     'layout.debug.enable_data_xbl': 'true',
+    'shell.checkDefaultClient': 'false',
     'browser.EULA.override': 'true'
 }
 
 def usage():
     print "python " + sys.argv[0] + " --binary=binary_location [--profileName=default] [--clobber] [--help]" 
diff -r f3ac957eb4af toolkit/components/alerts/src/mac/Makefile.in
--- a/toolkit/components/alerts/src/mac/Makefile.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/components/alerts/src/mac/Makefile.in	Sat Sep 06 10:14:38 2008 +0300
@@ -49,10 +49,15 @@ REQUIRES = \
 REQUIRES = \
   xpcom \
   string \
   necko \
   intl \
+  js \
+  xpconnect \
+  dom \
+  content \
+  widget \
   $(NULL)
 
 CMMSRCS = \
   nsAlertsService.mm \
   mozGrowlDelegate.mm \
@@ -79,8 +84,9 @@ SHARED_LIBRARY_LIBS = \
 
 EXTRA_DSO_LDOPTS += \
   -framework Carbon \
   $(XPCOM_GLUE_LDOPTS) \
   $(NSPR_LIBS) \
+  $(MOZ_JS_LIBS) \
   $(NULL)
 
 include $(topsrcdir)/config/rules.mk
diff -r f3ac957eb4af toolkit/components/alerts/src/mac/mozGrowlDelegate.h
--- a/toolkit/components/alerts/src/mac/mozGrowlDelegate.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/components/alerts/src/mac/mozGrowlDelegate.h	Sat Sep 06 10:14:38 2008 +0300
@@ -33,19 +33,24 @@
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 #import "GrowlApplicationBridge.h"
-#include "nsIObserver.h"
+
+#include "nscore.h"
+#include "nsStringGlue.h"
 
 #import <Cocoa/Cocoa.h>
 
 #define GROWL_STRING_BUNDLE_LOCATION \
   "chrome://alerts/locale/notificationNames.properties"
 
 #define OBSERVER_KEY      @"ALERT_OBSERVER"
 #define COOKIE_KEY        @"ALERT_COOKIE"
+
+class nsIObserver;
+class nsIDOMWindow;
 
 @interface mozGrowlDelegate : NSObject <GrowlApplicationBridgeDelegate>
 {
 @private
   PRUint32 mKey;
@@ -116,6 +121,18 @@
  *
  * @param clickContext The object passed back from growl.
  */
 - (void) growlNotificationWasClicked:(id)clickContext;
 
+/**
+ * Called when a window was closed and the observers are no longer valid.
+ *
+ * @param window The window that was closed.
+ */
+- (void) forgetObserversForWindow:(nsIDOMWindow*)window;
+
+/**
+ * Called when all observers should be released.
+ */
+- (void) forgetObservers;
+
 @end
diff -r f3ac957eb4af toolkit/components/alerts/src/mac/mozGrowlDelegate.mm
--- a/toolkit/components/alerts/src/mac/mozGrowlDelegate.mm	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/components/alerts/src/mac/mozGrowlDelegate.mm	Sat Sep 06 10:14:38 2008 +0300
@@ -35,17 +35,114 @@
  * ***** END LICENSE BLOCK ***** */
 
 #import "mozGrowlDelegate.h"
 
 #include "nsIObserver.h"
-#include "nsStringAPI.h"
-#include "nscore.h"
+#include "nsIXPConnect.h"
+#include "nsIXULAppInfo.h"
+#include "nsIStringBundle.h"
+#include "nsIJSContextStack.h"
+#include "nsIDOMWindow.h"
+
+#include "jsapi.h"
 #include "nsCOMPtr.h"
 #include "nsObjCExceptions.h"
 #include "nsServiceManagerUtils.h"
-#include "nsIXULAppInfo.h"
-#include "nsIStringBundle.h"
+#include "nsWeakReference.h"
+
+/**
+ * Returns the DOM window that owns the given observer in the case that the
+ * observer is implemented in JS and was created in a DOM window's scope.
+ *
+ * We need this so that we can properly clean up in cases where the window gets
+ * closed before the growl timeout/click notifications have fired. Otherwise we
+ * leak those windows.
+ */
+static already_AddRefed<nsIDOMWindow>
+GetWindowOfObserver(nsIObserver* aObserver)
+{
+  nsCOMPtr<nsIXPConnectWrappedJS> wrappedJS(do_QueryInterface(aObserver));
+  if (!wrappedJS) {
+    // We can't do anything with objects that aren't implemented in JS...
+    return nsnull;
+  }
+
+  JSObject* obj;
+  nsresult rv = wrappedJS->GetJSObject(&obj);
+  NS_ENSURE_SUCCESS(rv, nsnull);
+
+  nsCOMPtr<nsIThreadJSContextStack> stack =
+    do_GetService("@mozilla.org/js/xpc/ContextStack;1", &rv);
+  NS_ENSURE_SUCCESS(rv, nsnull);
+
+  JSContext* cx;
+  rv = stack->GetSafeJSContext(&cx);
+  NS_ENSURE_SUCCESS(rv, nsnull);
+
+  JSAutoRequest ar(cx);
+
+  JSObject* global = JS_GetGlobalForObject(cx, obj);
+  NS_ENSURE_TRUE(global, nsnull);
+
+  nsCOMPtr<nsIXPConnect> xpc(do_GetService(nsIXPConnect::GetCID()));
+  NS_ENSURE_TRUE(xpc, nsnull);
+
+  nsCOMPtr<nsIXPConnectWrappedNative> wrapper;
+  rv = xpc->GetWrappedNativeOfJSObject(cx, global, getter_AddRefs(wrapper));
+  NS_ENSURE_SUCCESS(rv, nsnull);
+
+  nsCOMPtr<nsIDOMWindow> window = do_QueryWrappedNative(wrapper);
+  NS_ENSURE_TRUE(window, nsnull);
+
+  return window.forget();
+}
+
+@interface ObserverPair : NSObject
+{
+@public
+  nsIObserver *observer;
+  nsIDOMWindow *window;
+}
+
+- (id) initWithObserver:(nsIObserver *)aObserver window:(nsIDOMWindow *)aWindow;
+- (void) dealloc;
+
+@end
+
+@implementation ObserverPair
+
+- (id) initWithObserver:(nsIObserver *)aObserver window:(nsIDOMWindow *)aWindow
+{
+  NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NIL;
+
+  if ((self = [super init])) {
+    NS_ADDREF(observer = aObserver);
+    NS_IF_ADDREF(window = aWindow);
+    return self;
+  }
+
+  // Safeguard against calling NS_RELEASE on uninitialized memory.
+  observer = nsnull;
+  window = nsnull;
+
+  return nil;
+
+  NS_OBJC_END_TRY_ABORT_BLOCK_NIL;
+}
+
+- (void) dealloc
+{
+  NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
+
+  NS_IF_RELEASE(observer);
+  NS_IF_RELEASE(window);
+  [super dealloc];
+
+  NS_OBJC_END_TRY_ABORT_BLOCK;
+}
+
+@end
 
 @implementation mozGrowlDelegate
 
 - (id) init
 {
@@ -161,19 +258,22 @@
         clickContext: clickContext];
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
-- (PRUint32) addObserver:(nsIObserver*)aObserver
+- (PRUint32) addObserver:(nsIObserver *)aObserver
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_RETURN;
 
-  NS_ADDREF(aObserver);  // We now own a reference to this!
+  nsCOMPtr<nsIDOMWindow> parentWindow = GetWindowOfObserver(aObserver);
 
-  mKey++;
-  [mDict setObject: [NSValue valueWithPointer: aObserver]
-            forKey: [NSNumber numberWithUnsignedInt: mKey]];
+  ObserverPair* pair = [[ObserverPair alloc] initWithObserver: aObserver
+                                                       window: parentWindow];
+  [pair autorelease];
+
+  [mDict setObject: pair
+            forKey: [NSNumber numberWithUnsignedInt: ++mKey]];
   return mKey;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_RETURN(0);
 }
 
@@ -217,24 +317,23 @@
   NS_ASSERTION([clickContext valueForKey: OBSERVER_KEY] != nil,
                "OBSERVER_KEY not found!");
   NS_ASSERTION([clickContext valueForKey: COOKIE_KEY] != nil,
                "COOKIE_KEY not found!");
 
-  nsIObserver* observer = static_cast<nsIObserver*>
-                                     ([[mDict objectForKey: [clickContext valueForKey: OBSERVER_KEY]]
-      pointerValue]);
+  ObserverPair* pair =
+    [mDict objectForKey: [clickContext valueForKey: OBSERVER_KEY]];
+  nsCOMPtr<nsIObserver> observer = pair ? pair->observer : nsnull;
+
   [mDict removeObjectForKey: [clickContext valueForKey: OBSERVER_KEY]];
   NSString* cookie = [[clickContext valueForKey: COOKIE_KEY] objectAtIndex: 0];
 
   if (observer) {
     nsAutoString tmp;
     tmp.SetLength([cookie length]);
     [cookie getCharacters:tmp.BeginWriting()];
 
     observer->Observe(nsnull, "alertfinished", tmp.get());
-
-    NS_RELEASE(observer);
   }
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
@@ -245,26 +344,55 @@
   NS_ASSERTION([clickContext valueForKey: OBSERVER_KEY] != nil,
                "OBSERVER_KEY not found!");
   NS_ASSERTION([clickContext valueForKey: COOKIE_KEY] != nil,
                "COOKIE_KEY not found!");
 
-  nsIObserver* observer = static_cast<nsIObserver*>
-                                     ([[mDict objectForKey: [clickContext valueForKey: OBSERVER_KEY]]
-      pointerValue]);
+  ObserverPair* pair =
+    [mDict objectForKey: [clickContext valueForKey: OBSERVER_KEY]];
+  nsCOMPtr<nsIObserver> observer = pair ? pair->observer : nsnull;
+
   [mDict removeObjectForKey: [clickContext valueForKey: OBSERVER_KEY]];
   NSString* cookie = [[clickContext valueForKey: COOKIE_KEY] objectAtIndex: 0];
 
   if (observer) {
     nsAutoString tmp;
     tmp.SetLength([cookie length]);
     [cookie getCharacters:tmp.BeginWriting()];
 
     observer->Observe(nsnull, "alertclickcallback", tmp.get());
     observer->Observe(nsnull, "alertfinished", tmp.get());
-
-    NS_RELEASE(observer);
   }
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
+- (void) forgetObserversForWindow:(nsIDOMWindow*)window
+{
+  NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
+
+  NS_ASSERTION(window, "No window!");
+
+  NSMutableArray *keysToRemove = [NSMutableArray array];
+
+  NSEnumerator *keyEnumerator = [[mDict allKeys] objectEnumerator];
+  NSNumber *key;
+  while ((key = [keyEnumerator nextObject])) {
+    ObserverPair *pair = [mDict objectForKey:key];
+    if (pair && pair->window == window)
+      [keysToRemove addObject:key];
+  }
+
+  [mDict removeObjectsForKeys:keysToRemove];
+
+  NS_OBJC_END_TRY_ABORT_BLOCK;
+}
+
+- (void) forgetObservers
+{
+  NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
+
+  [mDict removeAllObjects];
+
+  NS_OBJC_END_TRY_ABORT_BLOCK;
+}
+
 @end
diff -r f3ac957eb4af toolkit/components/alerts/src/mac/nsAlertsService.mm
--- a/toolkit/components/alerts/src/mac/nsAlertsService.mm	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/components/alerts/src/mac/nsAlertsService.mm	Sat Sep 06 10:14:38 2008 +0300
@@ -46,10 +46,11 @@
 #include "nsIStringBundle.h"
 #include "nsIObserverService.h"
 #include "nsAutoPtr.h"
 #include "nsNotificationsList.h"
 #include "nsObjCExceptions.h"
+#include "nsPIDOMWindow.h"
 
 #import "mozGrowlDelegate.h"
 #import "GrowlApplicationBridge.h"
 
 ////////////////////////////////////////////////////////////////////////////////
@@ -151,21 +152,26 @@ nsAlertsService::Init()
   nsresult rv;
   nsCOMPtr<nsIObserverService> os =
     do_GetService("@mozilla.org/observer-service;1", &rv);
   NS_ENSURE_SUCCESS(rv, rv);
 
-  return os->AddObserver(this, "final-ui-startup", PR_FALSE);
+  rv = os->AddObserver(this, "final-ui-startup", PR_FALSE);
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  (void)os->AddObserver(this, DOM_WINDOW_DESTROYED_TOPIC, PR_FALSE);
+  (void)os->AddObserver(this, "profile-before-change", PR_FALSE);
+
+  return NS_OK;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
 }
 
 nsAlertsService::nsAlertsService() : mDelegate(nsnull) {}
 
 nsAlertsService::~nsAlertsService()
 {
-  if (mDelegate)
-    delete mDelegate;
+  delete mDelegate;
 }
 
 ////////////////////////////////////////////////////////////////////////////////
 //// nsIAlertsService
 
@@ -239,10 +245,18 @@ nsAlertsService::Observe(nsISupports* aS
       notifications->informController(mDelegate->delegate);
 
     // registers with Growl
     [GrowlApplicationBridge setGrowlDelegate: mDelegate->delegate];
   }
+  else if (strcmp(aTopic, DOM_WINDOW_DESTROYED_TOPIC) == 0 && mDelegate) {
+    nsCOMPtr<nsIDOMWindow> window(do_QueryInterface(aSubject));
+    if (window)
+      [mDelegate->delegate forgetObserversForWindow:window];
+  }
+  else if (strcmp(aTopic, "profile-before-change") == 0 && mDelegate) {
+    [mDelegate->delegate forgetObservers];
+  }
 
   return NS_OK;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
 }
diff -r f3ac957eb4af toolkit/components/passwordmgr/src/nsLoginManager.js
--- a/toolkit/components/passwordmgr/src/nsLoginManager.js	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/components/passwordmgr/src/nsLoginManager.js	Sat Sep 06 10:14:38 2008 +0300
@@ -999,10 +999,18 @@ LoginManager.prototype = {
             this._getFormFields(form, false);
 
         // Need a valid password field to do anything.
         if (passwordField == null)
             return [false, foundLogins];
+
+        // If the fields are disabled or read-only, there's nothing to do.
+        if (passwordField.disabled || passwordField.readOnly ||
+            usernameField && (usernameField.disabled ||
+                              usernameField.readOnly)) {
+            this.log("not filling form, login fields disabled");
+            return [false, foundLogins];
+        }
 
         // If there's only a password field and it has a value, there's
         // nothing for us to do. (Don't clobber the existing value)
         if (!usernameField && passwordField.value)
             return [false, foundLogins];
diff -r f3ac957eb4af toolkit/components/passwordmgr/test/Makefile.in
--- a/toolkit/components/passwordmgr/test/Makefile.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/components/passwordmgr/test/Makefile.in	Sat Sep 06 10:14:38 2008 +0300
@@ -51,10 +51,11 @@ MOCHI_TESTS = \
 		test_0init.html \
 		test_basic_form.html \
 		test_basic_form_2.html \
 		test_basic_form_0pw.html \
 		test_basic_form_1pw.html \
+		test_basic_form_1pw_2.html \
 		test_basic_form_2pw_1.html \
 		test_basic_form_2pw_2.html \
 		test_basic_form_3pw_1.html \
 		test_basic_form_autocomplete.html \
 		test_basic_form_observer_autofillForms.html \
diff -r f3ac957eb4af toolkit/components/passwordmgr/test/test_basic_form_1pw_2.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/toolkit/components/passwordmgr/test/test_basic_form_1pw_2.html	Sat Sep 06 10:14:38 2008 +0300
@@ -0,0 +1,88 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+  <title>Test for Login Manager</title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>  
+  <script type="text/javascript" src="pwmgr_common.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+Login Manager test: forms with 1 password field, part 2
+<p id="display"></p>
+
+<div id="content" style="display: none">
+
+<form id='form1' action='formtest.js'> 1
+    <input type='password' name='pname' value=''>
+    <button type='submit'>Submit</button>
+</form>
+
+<form id='form2' action='formtest.js'> 2
+    <input type='password' name='pname' value='' disabled>
+    <button type='submit'>Submit</button>
+</form>
+
+<form id='form3' action='formtest.js'> 3
+    <input type='password' name='pname' value='' readonly>
+    <button type='submit'>Submit</button>
+</form>
+
+<form id='form4' action='formtest.js'> 4
+    <input type='text'     name='uname' value=''>
+    <input type='password' name='pname' value=''>
+    <button type='submit'>Submit</button>
+</form>
+
+<form id='form5' action='formtest.js'> 5
+    <input type='text'     name='uname' value='' disabled>
+    <input type='password' name='pname' value=''>
+    <button type='submit'>Submit</button>
+</form>
+
+<form id='form6' action='formtest.js'> 6
+    <input type='text'     name='uname' value='' readonly>
+    <input type='password' name='pname' value=''>
+    <button type='submit'>Submit</button>
+</form>
+
+<form id='form7' action='formtest.js'> 7
+    <input type='text'     name='uname' value=''>
+    <input type='password' name='pname' value='' disabled>
+    <button type='submit'>Submit</button>
+</form>
+
+<form id='form8' action='formtest.js'> 8
+    <input type='text'     name='uname' value=''>
+    <input type='password' name='pname' value='' readonly>
+    <button type='submit'>Submit</button>
+</form>
+
+</div>
+
+<pre id="test">
+<script class="testbody" type="text/javascript">
+
+/** Test for Login Manager: simple form fill, part 2 **/
+
+function startTest() {
+    var f;
+
+    checkForm(1, "testpass"); // control
+    checkUnmodifiedForm(2);
+    checkUnmodifiedForm(3);
+    checkForm(4, "testuser", "testpass"); // control
+    for (f = 5;  f <= 8;  f++) { checkUnmodifiedForm(f); }
+
+    SimpleTest.finish();
+}
+
+
+window.onload = startTest;
+
+SimpleTest.waitForExplicitFinish();
+</script>
+</pre>
+</body>
+</html>
+
diff -r f3ac957eb4af toolkit/components/places/src/nsLivemarkService.js
--- a/toolkit/components/places/src/nsLivemarkService.js	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/components/places/src/nsLivemarkService.js	Sat Sep 06 10:14:38 2008 +0300
@@ -554,13 +554,11 @@ LivemarkLoadListener.prototype = {
       let entry = feed.items.queryElementAt(i, Ci.nsIFeedEntry);
       let href = entry.link;
       if (!href)
         continue;
 
-      let title = entry.title ? entry.title.plainText() : entry.updated;
-      if (!title)
-        continue;
+      let title = entry.title ? entry.title.plainText() : "";
 
       try {
         secMan.checkLoadURIWithPrincipal(feedPrincipal, href, SEC_FLAGS);
       }
       catch(ex) {
diff -r f3ac957eb4af toolkit/components/places/src/nsNavHistory.cpp
--- a/toolkit/components/places/src/nsNavHistory.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/components/places/src/nsNavHistory.cpp	Sat Sep 06 10:14:38 2008 +0300
@@ -76,10 +76,12 @@
 #include "nsEscape.h"
 #include "nsIVariant.h"
 #include "nsVariant.h"
 #include "nsIEffectiveTLDService.h"
 #include "nsIIDNService.h"
+#include "nsIClassInfoImpl.h"
+#include "nsThreadUtils.h"
 
 #include "mozIStorageService.h"
 #include "mozIStorageConnection.h"
 #include "mozIStorageValueArray.h"
 #include "mozIStorageStatement.h"
@@ -194,14 +196,10 @@
 // See StartLazyTimer()
 #define MAX_LAZY_TIMER_DEFERMENTS 2
 
 #endif // LAZY_ADD
 
-// Perform "long idle" tasks after 15 minutes of idle time, repeating.
-// 15 minutes = 900 seconds = 900000 milliseconds
-#define LONG_IDLE_TIME_IN_MSECS (900000)
-
 // Perform expiration after 5 minutes of idle time, repeating.
 // 5 minutes = 300 seconds = 300000 milliseconds
 #define EXPIRE_IDLE_TIME_IN_MSECS (300000)
 
 // Amount of items to expire at idle time.
@@ -234,11 +232,22 @@ NS_INTERFACE_MAP_BEGIN(nsNavHistory)
 #ifdef MOZ_XUL
   NS_INTERFACE_MAP_ENTRY(nsIAutoCompleteSearch)
   NS_INTERFACE_MAP_ENTRY(nsIAutoCompleteSimpleResultListener)
 #endif
   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsINavHistoryService)
+  NS_IMPL_QUERY_CLASSINFO(nsNavHistory)
 NS_INTERFACE_MAP_END
+
+// We don't care about flattening everything
+NS_IMPL_CI_INTERFACE_GETTER5(
+  nsNavHistory
+, nsINavHistoryService
+, nsIGlobalHistory3
+, nsIGlobalHistory2
+, nsIDownloadHistory
+, nsIBrowserHistory
+)
 
 static nsresult GetReversedHostname(nsIURI* aURI, nsAString& host);
 static void GetReversedHostname(const nsString& aForward, nsAString& aReversed);
 static nsresult GenerateTitleFromURI(nsIURI* aURI, nsAString& aTitle);
 static PRInt64 GetSimpleBookmarksQueryFolder(
@@ -886,12 +895,11 @@ nsNavHistory::InitializeIdleTimer()
   }
   nsresult rv;
   mIdleTimer = do_CreateInstance("@mozilla.org/timer;1", &rv);
   NS_ENSURE_SUCCESS(rv, rv);
 
-  PRInt32 idleTimerTimeout = PR_MIN(LONG_IDLE_TIME_IN_MSECS,
-                                    EXPIRE_IDLE_TIME_IN_MSECS);
+  PRInt32 idleTimerTimeout = EXPIRE_IDLE_TIME_IN_MSECS;
   if (mFrecencyUpdateIdleTime)
     idleTimerTimeout = PR_MIN(idleTimerTimeout, mFrecencyUpdateIdleTime);
 
   rv = mIdleTimer->InitWithFuncCallback(IdleTimerCallback, this,
                                         idleTimerTimeout,
@@ -2316,10 +2324,12 @@ nsNavHistory::DomainNameFromURI(nsIURI *
 // nsNavHistory::GetHasHistoryEntries
 
 NS_IMETHODIMP
 nsNavHistory::GetHasHistoryEntries(PRBool* aHasEntries)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   nsCOMPtr<mozIStorageStatement> dbSelectStatement;
   nsresult rv = mDBConn->CreateStatement(
       NS_LITERAL_CSTRING("SELECT id FROM moz_historyvisits LIMIT 1"),
       getter_AddRefs(dbSelectStatement));
   NS_ENSURE_SUCCESS(rv, rv);
@@ -2391,10 +2401,12 @@ nsNavHistory::CalculateFullVisitCount(PR
 // @see MarkPageAsTyped
 
 NS_IMETHODIMP
 nsNavHistory::MarkPageAsFollowedBookmark(nsIURI* aURI)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   // don't add when history is disabled
   if (IsHistoryDisabled())
     return NS_OK;
 
   nsCAutoString uriString;
@@ -2423,10 +2435,12 @@ nsNavHistory::MarkPageAsFollowedBookmark
 //    we don't bail go on and allow it in.
 
 NS_IMETHODIMP
 nsNavHistory::CanAddURI(nsIURI* aURI, PRBool* canAdd)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   NS_ENSURE_ARG_POINTER(aURI);
 
   nsCAutoString scheme;
   nsresult rv = aURI->GetScheme(scheme);
   NS_ENSURE_SUCCESS(rv, rv);
@@ -2470,10 +2484,11 @@ nsNavHistory::AddVisit(nsIURI* aURI, PRT
 nsNavHistory::AddVisit(nsIURI* aURI, PRTime aTime, nsIURI* aReferringURI,
                        PRInt32 aTransitionType, PRBool aIsRedirect,
                        PRInt64 aSessionID, PRInt64* aVisitID)
 {
   NS_ENSURE_ARG_POINTER(aURI);
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
 
   // Filter out unwanted URIs, silently failing
   PRBool canAdd = PR_FALSE;
   nsresult rv = CanAddURI(aURI, &canAdd);
   NS_ENSURE_SUCCESS(rv, rv);
@@ -2626,10 +2641,12 @@ nsNavHistory::AddVisit(nsIURI* aURI, PRT
 
 // nsNavHistory::GetNewQuery
 
 NS_IMETHODIMP nsNavHistory::GetNewQuery(nsINavHistoryQuery **_retval)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   *_retval = new nsNavHistoryQuery();
   if (! *_retval)
     return NS_ERROR_OUT_OF_MEMORY;
   NS_ADDREF(*_retval);
   return NS_OK;
@@ -2637,10 +2654,12 @@ NS_IMETHODIMP nsNavHistory::GetNewQuery(
 
 // nsNavHistory::GetNewQueryOptions
 
 NS_IMETHODIMP nsNavHistory::GetNewQueryOptions(nsINavHistoryQueryOptions **_retval)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   *_retval = new nsNavHistoryQueryOptions();
   NS_ENSURE_TRUE(*_retval, NS_ERROR_OUT_OF_MEMORY);
   NS_ADDREF(*_retval);
   return NS_OK;
 }
@@ -2650,10 +2669,12 @@ NS_IMETHODIMP nsNavHistory::GetNewQueryO
 
 NS_IMETHODIMP
 nsNavHistory::ExecuteQuery(nsINavHistoryQuery *aQuery, nsINavHistoryQueryOptions *aOptions,
                            nsINavHistoryResult** _retval)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   return ExecuteQueries(&aQuery, 1, aOptions, _retval);
 }
 
 
 // nsNavHistory::ExecuteQueries
@@ -2671,10 +2692,12 @@ NS_IMETHODIMP
 NS_IMETHODIMP
 nsNavHistory::ExecuteQueries(nsINavHistoryQuery** aQueries, PRUint32 aQueryCount,
                              nsINavHistoryQueryOptions *aOptions,
                              nsINavHistoryResult** _retval)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   nsresult rv;
   NS_ENSURE_ARG_POINTER(aQueries);
   NS_ENSURE_ARG_POINTER(aOptions);
   if (! aQueryCount)
     return NS_ERROR_INVALID_ARG;
@@ -3555,19 +3578,23 @@ nsNavHistory::GetQueryResults(nsNavHisto
 // nsNavHistory::AddObserver
 
 NS_IMETHODIMP
 nsNavHistory::AddObserver(nsINavHistoryObserver* aObserver, PRBool aOwnsWeak)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   return mObservers.AppendWeakElement(aObserver, aOwnsWeak);
 }
 
 
 // nsNavHistory::RemoveObserver
 
 NS_IMETHODIMP
 nsNavHistory::RemoveObserver(nsINavHistoryObserver* aObserver)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   return mObservers.RemoveWeakElement(aObserver);
 }
 
 // nsNavHistory::BeginUpdateBatch
 // See RunInBatchMode
@@ -3603,19 +3630,22 @@ NS_IMETHODIMP
 NS_IMETHODIMP
 nsNavHistory::RunInBatchMode(nsINavHistoryBatchCallback* aCallback,
                              nsISupports* aUserData) 
 {
   NS_ENSURE_ARG_POINTER(aCallback);
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
 
   UpdateBatchScoper batch(*this);
   return aCallback->RunBatched(aUserData);
 }
 
 NS_IMETHODIMP
 nsNavHistory::GetHistoryDisabled(PRBool *_retval)
 {
   NS_ENSURE_ARG_POINTER(_retval);
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   *_retval = IsHistoryDisabled();
   return NS_OK;
 }
 
 // Browser history *************************************************************
@@ -3630,10 +3660,12 @@ nsNavHistory::GetHistoryDisabled(PRBool 
 
 NS_IMETHODIMP
 nsNavHistory::AddPageWithDetails(nsIURI *aURI, const PRUnichar *aTitle,
                                  PRInt64 aLastVisited)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   PRInt64 visitID;
   nsresult rv = AddVisit(aURI, aLastVisited, 0, TRANSITION_LINK, PR_FALSE,
                          0, &visitID);
   NS_ENSURE_SUCCESS(rv, rv);
 
@@ -3648,10 +3680,12 @@ nsNavHistory::AddPageWithDetails(nsIURI 
 //    the statement.
 
 NS_IMETHODIMP
 nsNavHistory::GetLastPageVisited(nsACString & aLastPageVisited)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   nsCOMPtr<mozIStorageStatement> statement;
   nsresult rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING(
       "SELECT h.url "
       "FROM moz_places h LEFT OUTER JOIN moz_historyvisits v ON h.id = v.place_id "
       "WHERE v.visit_date IN "
@@ -3678,10 +3712,12 @@ nsNavHistory::GetLastPageVisited(nsACStr
 //    all the code that uses this function happy.
 
 NS_IMETHODIMP
 nsNavHistory::GetCount(PRUint32 *aCount)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   PRBool hasEntries = PR_FALSE;
   nsresult rv = GetHasHistoryEntries(&hasEntries);
   if (hasEntries)
     *aCount = 1;
   else
@@ -3771,10 +3807,12 @@ nsNavHistory::RemovePagesInternal(const 
 //    We don't do duplicates removal, URIs array should be cleaned-up before.
 
 NS_IMETHODIMP
 nsNavHistory::RemovePages(nsIURI **aURIs, PRUint32 aLength, PRBool aDoBatchNotify)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   nsresult rv;
   // build a list of place ids to delete
   nsCString deletePlaceIdsQueryString;
   for (PRUint32 i = 0; i < aLength; i++) {
     PRInt64 placeId;
@@ -3801,13 +3839,15 @@ nsNavHistory::RemovePages(nsIURI **aURIs
 // nsNavHistory::RemovePage
 //
 //    Removes all visits and the main history entry for the given URI.
 //    Silently fails if we have no knowledge of the page.
 
- NS_IMETHODIMP
+NS_IMETHODIMP
 nsNavHistory::RemovePage(nsIURI *aURI)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   nsIURI** URIs = &aURI;
   nsresult rv = RemovePages(URIs, 1, PR_FALSE);
   NS_ENSURE_SUCCESS(rv, rv);
   // call observers here for the removed url
   ENUMERATE_WEAKARRAY(mObservers, nsINavHistoryObserver, OnDeleteURI(aURI))
@@ -3829,10 +3869,12 @@ nsNavHistory::RemovePage(nsIURI *aURI)
 //    This sends onBeginUpdateBatch/onEndUpdateBatch to observers
 
 NS_IMETHODIMP
 nsNavHistory::RemovePagesFromHost(const nsACString& aHost, PRBool aEntireDomain)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   nsresult rv;
   // Local files don't have any host name. We don't want to delete all files in
   // history when we get passed an empty string, so force to exact match
   if (aHost.IsEmpty())
     aEntireDomain = PR_FALSE;
@@ -3910,10 +3952,12 @@ nsNavHistory::RemovePagesFromHost(const 
 //    This method sends onBeginUpdateBatch/onEndUpdateBatch to observers
 
 NS_IMETHODIMP
 nsNavHistory::RemovePagesByTimeframe(PRTime aBeginTime, PRTime aEndTime)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   nsresult rv;
   // build a list of place ids to delete
   nsCString deletePlaceIdsQueryString;
 
   // we only need to know if a place has a visit into the given timeframe
@@ -3957,10 +4001,12 @@ nsNavHistory::RemovePagesByTimeframe(PRT
 //    This function is used to clear history.
 
 NS_IMETHODIMP
 nsNavHistory::RemoveAllPages()
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   // expire everything
   mExpire.ClearHistory();
 
   // Compress DB. Currently commented out because compression is very slow.
   // Deleted data will be overwritten with 0s by sqlite.
@@ -3991,10 +4037,12 @@ nsNavHistory::RemoveAllPages()
 //    succeed and do nothing.
 
 NS_IMETHODIMP
 nsNavHistory::HidePage(nsIURI *aURI)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   return NS_ERROR_NOT_IMPLEMENTED;
   /*
   // for speed to save disk accesses
   mozStorageTransaction transaction(mDBConn, PR_FALSE,
                                   mozIStorageConnection::TRANSACTION_EXCLUSIVE);
@@ -4068,10 +4116,12 @@ nsNavHistory::HidePage(nsIURI *aURI)
 // @see MarkPageAsFollowedBookmark
 
 NS_IMETHODIMP
 nsNavHistory::MarkPageAsTyped(nsIURI *aURI)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   // don't add when history is disabled
   if (IsHistoryDisabled())
     return NS_OK;
 
   nsCAutoString uriString;
@@ -4098,10 +4148,12 @@ nsNavHistory::MarkPageAsTyped(nsIURI *aU
 
 NS_IMETHODIMP
 nsNavHistory::SetCharsetForURI(nsIURI* aURI,
                                const nsAString& aCharset)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   nsAnnotationService* annosvc = nsAnnotationService::GetAnnotationService();
   NS_ENSURE_TRUE(annosvc, NS_ERROR_OUT_OF_MEMORY);
 
   if (aCharset.IsEmpty()) {
     // remove the current page character-set annotation
@@ -4126,10 +4178,12 @@ nsNavHistory::SetCharsetForURI(nsIURI* a
 
 NS_IMETHODIMP
 nsNavHistory::GetCharsetForURI(nsIURI* aURI, 
                                nsAString& aCharset)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   nsAnnotationService* annosvc = nsAnnotationService::GetAnnotationService();
   NS_ENSURE_TRUE(annosvc, NS_ERROR_OUT_OF_MEMORY);
 
   nsAutoString charset;
   nsresult rv = annosvc->GetPageAnnotationString(aURI, CHARSET_ANNO, aCharset);
@@ -4150,10 +4204,12 @@ nsNavHistory::GetCharsetForURI(nsIURI* a
 
 NS_IMETHODIMP
 nsNavHistory::AddURI(nsIURI *aURI, PRBool aRedirect,
                      PRBool aToplevel, nsIURI *aReferrer)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   // don't add when history is disabled
   if (IsHistoryDisabled())
     return NS_OK;
 
   // filter out any unwanted URIs
@@ -4370,10 +4426,12 @@ nsNavHistory::AddVisitChain(nsIURI* aURI
 //    the history list view and autocomplete.
 
 NS_IMETHODIMP
 nsNavHistory::IsVisited(nsIURI *aURI, PRBool *_retval)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   // if history is disabled, we can optimize
   if (IsHistoryDisabled()) {
     *_retval = PR_FALSE;
     return NS_OK;
   }
@@ -4400,10 +4458,12 @@ nsNavHistory::IsVisited(nsIURI *aURI, PR
 
 NS_IMETHODIMP
 nsNavHistory::SetPageTitle(nsIURI* aURI,
                            const nsAString& aTitle)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   // if aTitle is empty we want to clear the previous title.
   // We don't want to set it to an empty string, but to a NULL value,
   // so we use SetIsVoid and SetPageTitleInternal will take care of that
 
 #ifdef LAZY_ADD
@@ -4425,10 +4485,12 @@ nsNavHistory::SetPageTitle(nsIURI* aURI,
 }
 
 NS_IMETHODIMP
 nsNavHistory::GetPageTitle(nsIURI* aURI, nsAString& aTitle)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   aTitle.Truncate(0);
 
   mozIStorageStatement *statement = DBGetURLPageInfo();
   mozStorageStatementScoper scope(statement);
   nsresult rv = BindStatementURI(statement, 0, aURI);
@@ -4453,10 +4515,12 @@ nsNavHistory::GetPageTitle(nsIURI* aURI,
 //    FIXME: should we try to use annotations for this stuff?
 
 NS_IMETHODIMP
 nsNavHistory::GetURIGeckoFlags(nsIURI* aURI, PRUint32* aResult)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   return NS_ERROR_NOT_IMPLEMENTED;
 }
 
 
 // nsNavHistory::SetURIGeckoFlags
@@ -4464,10 +4528,12 @@ nsNavHistory::GetURIGeckoFlags(nsIURI* a
 //    FIXME: should we try to use annotations for this stuff?
 
 NS_IMETHODIMP
 nsNavHistory::SetURIGeckoFlags(nsIURI* aURI, PRUint32 aFlags)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   return NS_ERROR_NOT_IMPLEMENTED;
 }
 
 // nsIGlobalHistory3 ***********************************************************
 
@@ -4492,10 +4558,12 @@ nsNavHistory::AddDocumentRedirect(nsICha
 nsNavHistory::AddDocumentRedirect(nsIChannel *aOldChannel,
                                   nsIChannel *aNewChannel,
                                   PRInt32 aFlags,
                                   PRBool aTopLevel)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   nsresult rv;
   nsCOMPtr<nsIURI> oldURI, newURI;
   rv = aOldChannel->GetURI(getter_AddRefs(oldURI));
   NS_ENSURE_SUCCESS(rv, rv);
   rv = aNewChannel->GetURI(getter_AddRefs(newURI));
@@ -4557,91 +4625,10 @@ nsNavHistory::OnIdle()
   if (idleTime > EXPIRE_IDLE_TIME_IN_MSECS) {
     PRBool dummy;
     (void)mExpire.ExpireItems(MAX_EXPIRE_RECORDS_ON_IDLE, &dummy);
   }
 
-  // If we've been idle for more than LONG_IDLE_TIME_IN_MSECS
-  // perform long-idle tasks.
-  if (idleTime > LONG_IDLE_TIME_IN_MSECS) {
-    // Do a one-time re-creation of the moz_places.url index (bug 381795)
-    // XXX REMOVE ME AFTER BETA2.
-    PRBool oldIndexExists = PR_FALSE;
-    rv = mDBConn->IndexExists(NS_LITERAL_CSTRING("moz_places_urlindex"), &oldIndexExists);
-    NS_ENSURE_SUCCESS(rv, rv);
- 
-    if (oldIndexExists) {
-      // wrap in a transaction for safety and performance
-      mozStorageTransaction urlindexTransaction(mDBConn, PR_FALSE);
-      // drop old index
-      rv = mDBConn->ExecuteSimpleSQL(
-          NS_LITERAL_CSTRING("DROP INDEX IF EXISTS moz_places_urlindex"));
-      NS_ENSURE_SUCCESS(rv, rv);
-      // remove any duplicates
-      rv = RemoveDuplicateURIs();
-      NS_ENSURE_SUCCESS(rv, rv);
-      // create new index
-      rv = mDBConn->ExecuteSimpleSQL(
-        NS_LITERAL_CSTRING("CREATE UNIQUE INDEX moz_places_url_uniqueindex ON moz_places (url)"));
-      NS_ENSURE_SUCCESS(rv, rv);
-      rv = urlindexTransaction.Commit();
-      NS_ENSURE_SUCCESS(rv, rv);
-    }
-
-    // detect and replace bogus moz_places_visitcount index
-    // see bug 402161
-    // XXX REMOVE ME AFTER FINAL
-    nsCOMPtr<mozIStorageStatement> detectBogusIndex;
-    rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING(
-        "SELECT name FROM sqlite_master WHERE type = 'index' AND "
-        "name = 'moz_places_visitcount' AND sql LIKE ?1 ESCAPE '/'"),
-        getter_AddRefs(detectBogusIndex));
-    NS_ENSURE_SUCCESS(rv, rv);
-
-    nsAutoString escapedString;
-    rv = detectBogusIndex->EscapeStringForLIKE(NS_LITERAL_STRING("rev_host"),
-                                               '/', escapedString);
-    NS_ENSURE_SUCCESS(rv, rv);
-    rv = detectBogusIndex->BindStringParameter(0, NS_LITERAL_STRING("%") +
-                                                  escapedString +
-                                                  NS_LITERAL_STRING("%"));
-    NS_ENSURE_SUCCESS(rv, rv);
-
-    PRBool hasResult;
-    rv = detectBogusIndex->ExecuteStep(&hasResult);
-    NS_ENSURE_SUCCESS(rv, rv);
-    rv = detectBogusIndex->Reset();
-    NS_ENSURE_SUCCESS(rv, rv);
-    if (hasResult) {
-      // drop old index
-      rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
-          "DROP INDEX IF EXISTS moz_places_visitcount"));
-      NS_ENSURE_SUCCESS(rv, rv);
-      // create new index
-      rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
-          "CREATE INDEX IF NOT EXISTS moz_places_visitcount "
-          "ON moz_places (visit_count)"));
-      NS_ENSURE_SUCCESS(rv, rv);
-    }
-
-    // Remove dangling livemark annotations
-    // we have moved expiration pageAnnotations to itemAnnotations
-    // we must remove pageAnnotations to allow expire do the cleanup
-    // see bug 388716
-    // XXX REMOVE ME AFTER FINAL
-    rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
-        "DELETE FROM moz_annos WHERE id IN (SELECT a.id FROM moz_annos a "
-        "JOIN moz_anno_attributes n ON a.anno_attribute_id = n.id "
-        "WHERE n.name = 'livemark/expiration')"));
-    NS_ENSURE_SUCCESS(rv, rv);
-
-#if 0
-    // Currently commented out because vacuum is very slow
-    // see bug #390244 for more details.
-    rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING("VACUUM;"));
-    NS_ENSURE_SUCCESS(rv, rv);
-#endif
-  }
   return NS_OK;
 }
 
 void // static
 nsNavHistory::IdleTimerCallback(nsITimer* aTimer, void* aClosure)
@@ -4654,10 +4641,12 @@ nsNavHistory::IdleTimerCallback(nsITimer
 
 NS_IMETHODIMP
 nsNavHistory::AddDownload(nsIURI* aSource, nsIURI* aReferrer,
                           PRTime aStartTime)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   PRInt64 visitID;
   return AddVisit(aSource, aStartTime, aReferrer, TRANSITION_DOWNLOAD, PR_FALSE,
                   0, &visitID);
 }
 
@@ -4674,10 +4663,12 @@ nsNavHistory::GetDBConnection(mozIStorag
 
 NS_IMETHODIMP
 nsNavHistory::Observe(nsISupports *aSubject, const char *aTopic,
                     const PRUnichar *aData)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   if (nsCRT::strcmp(aTopic, gQuitApplicationMessage) == 0) {
     if (mIdleTimer) {
       mIdleTimer->Cancel();
       mIdleTimer = nsnull;
     }
@@ -4710,10 +4701,11 @@ nsNavHistory::Observe(nsISupports *aSubj
     NS_ENSURE_SUCCESS(rv, rv);
     observerService->RemoveObserver(this, gAutoCompleteFeedback);
     observerService->RemoveObserver(this, gXpcomShutdown);
     observerService->RemoveObserver(this, gQuitApplicationMessage);
   } else if (nsCRT::strcmp(aTopic, gAutoCompleteFeedback) == 0) {
+#ifdef MOZ_XUL
     nsCOMPtr<nsIAutoCompleteInput> input = do_QueryInterface(aSubject);
     if (!input)
       return NS_OK;
 
     nsCOMPtr<nsIAutoCompletePopup> popup;
@@ -4740,10 +4732,11 @@ nsNavHistory::Observe(nsISupports *aSubj
     if (selectedIndex == -1)
       return NS_OK;
 
     rv = AutoCompleteFeedback(selectedIndex, controller);
     NS_ENSURE_SUCCESS(rv, rv);
+#endif
   } else if (nsCRT::strcmp(aTopic, "nsPref:changed") == 0) {
     PRInt32 oldDaysMin = mExpireDaysMin;
     PRInt32 oldDaysMax = mExpireDaysMax;
     PRInt32 oldVisits = mExpireSites;
     LoadPrefs(PR_FALSE);
@@ -6621,10 +6614,12 @@ nsNavHistory::RequestCharset(nsIWebNavig
                              nsIChannel* aChannel,
                              PRBool* aWantCharset,
                              nsISupports** aClosure,
                              nsACString& aResult)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   *aWantCharset = PR_FALSE;
   *aClosure = nsnull;
 
   nsCOMPtr<nsIURI> uri;
   nsresult rv = aChannel->GetURI(getter_AddRefs(uri));
@@ -6641,8 +6636,10 @@ nsNavHistory::RequestCharset(nsIWebNavig
 
 NS_IMETHODIMP
 nsNavHistory::NotifyResolvedCharset(const nsACString& aCharset,
                                     nsISupports* aClosure)
 {
-    NS_ERROR("Unexpected call to NotifyResolvedCharset -- we never set aWantCharset to true!");
-    return NS_ERROR_NOT_IMPLEMENTED;
-}
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
+  NS_ERROR("Unexpected call to NotifyResolvedCharset -- we never set aWantCharset to true!");
+  return NS_ERROR_NOT_IMPLEMENTED;
+}
diff -r f3ac957eb4af toolkit/components/places/src/nsNavHistory.h
--- a/toolkit/components/places/src/nsNavHistory.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/components/places/src/nsNavHistory.h	Sat Sep 06 10:14:38 2008 +0300
@@ -696,14 +696,14 @@ protected:
   nsStringArray mCurrentSearchTokens;
   void GenerateSearchTokens();
   void AddSearchToken(nsAutoString &aToken);
   void ProcessTokensForSpecialSearch();
 
+#ifdef MOZ_XUL
   nsresult AutoCompleteFeedback(PRInt32 aIndex,
                                 nsIAutoCompleteController *aController);
 
-#ifdef MOZ_XUL
   nsCOMPtr<nsIAutoCompleteObserver> mCurrentListener;
   nsCOMPtr<nsIAutoCompleteSimpleResult> mCurrentResult;
 #endif
 
   MatchType mCurrentMatchType;
diff -r f3ac957eb4af toolkit/components/places/src/nsNavHistoryAutoComplete.cpp
--- a/toolkit/components/places/src/nsNavHistoryAutoComplete.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/components/places/src/nsNavHistoryAutoComplete.cpp	Sat Sep 06 10:14:38 2008 +0300
@@ -60,10 +60,11 @@
  */
 
 #include "nsNavHistory.h"
 #include "nsNetUtil.h"
 #include "nsEscape.h"
+#include "nsThreadUtils.h"
 
 #include "mozIStorageService.h"
 #include "mozIStorageConnection.h"
 #include "mozIStorageValueArray.h"
 #include "mozIStorageStatement.h"
@@ -482,10 +483,11 @@ nsNavHistory::StartSearch(const nsAStrin
   // We don't use aPreviousResult to get some matches from previous results in
   // order to make sure ordering of results are consistent between reusing and
   // not reusing results, see bug #412730 for details
 
   NS_ENSURE_ARG_POINTER(aListener);
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
 
   // Lazily init nsITextToSubURI service
   if (!mTextURIService)
     mTextURIService = do_GetService(NS_ITEXTTOSUBURI_CONTRACTID);
 
@@ -625,10 +627,12 @@ nsNavHistory::StartSearch(const nsAStrin
 // nsNavHistory::StopSearch
 
 NS_IMETHODIMP
 nsNavHistory::StopSearch()
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   if (mAutoCompleteTimer)
     mAutoCompleteTimer->Cancel();
 
   DoneSearching(PR_FALSE);
 
@@ -985,10 +989,12 @@ nsNavHistory::AutoCompleteHasEnoughResul
 
 NS_IMETHODIMP
 nsNavHistory::OnValueRemoved(nsIAutoCompleteSimpleResult* aResult,
                              const nsAString& aValue, PRBool aRemoveFromDb)
 {
+  NS_ASSERTION(NS_IsMainThread(), "This can only be called on the main thread");
+
   if (!aRemoveFromDb)
     return NS_OK;
 
   nsresult rv;
   nsCOMPtr<nsIURI> uri;
diff -r f3ac957eb4af toolkit/components/places/src/nsNavHistoryExpire.cpp
--- a/toolkit/components/places/src/nsNavHistoryExpire.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/components/places/src/nsNavHistoryExpire.cpp	Sat Sep 06 10:14:38 2008 +0300
@@ -906,53 +906,10 @@ nsNavHistoryExpire::ExpireAnnotationsPar
       "OR (v.id IS NULL AND a.expiration != ") +
       nsPrintfCString("%d", nsIAnnotationService::EXPIRE_NEVER) +
       NS_LITERAL_CSTRING("))"));
   NS_ENSURE_SUCCESS(rv, rv);
 
-  // XXX REMOVE ME LATE AFTER FINAL
-  // Move current charset item annos to page annos.
-  // There was a period in which EXPIRE_NEVER annos were undeletable
-  // so we moved charset annos from pageAnnos to itemAnnos.
-  // Since this has been fixed in RC1, we can use pageAnnos for charset
-  // so we must revert old itemAnnos to pageAnnos.
-  // see bug 317472 for details.
-  nsCAutoString charsetAnno("URIProperties/characterSet");
-  // In the migration query we use NULL as the id, since we don't know the
-  // new id where the annotation will be inserted
-  // The GROUP BY is needed because we have a unique index on annos tables
-  // INSERT OR REPLACE is needed to overwrite existing values and not fail
-  nsCOMPtr<mozIStorageStatement> migrateCharsetStatement;
-  rv = aConnection->CreateStatement(NS_LITERAL_CSTRING(
-        "INSERT OR REPLACE INTO moz_annos "
-        "SELECT null, b.fk, t.anno_attribute_id, t.mime_type, t.content, "
-          "t.flags, t.expiration, t.type, t.dateAdded, t.lastModified "
-        "FROM moz_items_annos t "
-          "JOIN moz_anno_attributes n ON t.anno_attribute_id = n.id "
-          "JOIN moz_bookmarks b ON b.id = t.item_id "
-        "WHERE n.name = ?1 "
-        "GROUP BY b.fk, t.anno_attribute_id"),
-      getter_AddRefs(migrateCharsetStatement));
-  NS_ENSURE_SUCCESS(rv, rv);
-  rv = migrateCharsetStatement->BindUTF8StringParameter(0, charsetAnno);
-  NS_ENSURE_SUCCESS(rv, rv);
-  rv = migrateCharsetStatement->Execute();
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  // delete old charset item annos
-  nsCOMPtr<mozIStorageStatement> deleteCharsetStatement;
-  rv = aConnection->CreateStatement(NS_LITERAL_CSTRING(
-    "DELETE FROM moz_items_annos WHERE id IN "
-      "(SELECT t.id FROM moz_items_annos t "
-        "JOIN moz_anno_attributes n ON t.anno_attribute_id = n.id "
-        "WHERE n.name = ?1)"),
-    getter_AddRefs(deleteCharsetStatement));
-  NS_ENSURE_SUCCESS(rv, rv);
-  rv = deleteCharsetStatement->BindUTF8StringParameter(0, charsetAnno);
-  NS_ENSURE_SUCCESS(rv, rv);
-  rv = deleteCharsetStatement->Execute();
-  NS_ENSURE_SUCCESS(rv, rv);
-
   // delete item annos w/o a corresponding item id
   rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
     "DELETE FROM moz_items_annos WHERE id IN "
       "(SELECT a.id FROM moz_items_annos a "
       "LEFT OUTER JOIN moz_bookmarks b ON a.item_id = b.id "
diff -r f3ac957eb4af toolkit/components/places/src/nsPlacesModule.cpp
--- a/toolkit/components/places/src/nsPlacesModule.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/components/places/src/nsPlacesModule.cpp	Sat Sep 06 10:14:38 2008 +0300
@@ -1,42 +1,55 @@
 #include "nsIGenericFactory.h"
+#include "nsIClassInfoImpl.h"
 
 #include "nsAnnoProtocolHandler.h"
 #include "nsAnnotationService.h"
 #include "nsNavHistory.h"
 #include "nsNavBookmarks.h"
 #include "nsFaviconService.h"
 #include "nsDocShellCID.h"
 
+#define NS_NAVHISTORY_CLASSINFO \
+  nsnull, nsnull, nsnull, \
+  NS_CI_INTERFACE_GETTER_NAME(nsNavHistory), \
+  nsnull, \
+  &NS_CLASSINFO_NAME(nsNavHistory), \
+  nsIClassInfo::SINGLETON | nsIClassInfo::THREADSAFE
+
 NS_GENERIC_FACTORY_SINGLETON_CONSTRUCTOR(nsNavHistory,
                                          nsNavHistory::GetSingleton)
+NS_DECL_CLASSINFO(nsNavHistory)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsAnnoProtocolHandler)
 NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsAnnotationService, Init)
 NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsNavBookmarks, Init)
 NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsFaviconService, Init)
 
 static const nsModuleComponentInfo components[] =
 {
   { "Browser Navigation History",
     NS_NAVHISTORYSERVICE_CID,
     NS_NAVHISTORYSERVICE_CONTRACTID,
-    nsNavHistoryConstructor },
+    nsNavHistoryConstructor,
+    NS_NAVHISTORY_CLASSINFO },
 
   { "Browser Navigation History",
     NS_NAVHISTORYSERVICE_CID,
     "@mozilla.org/browser/global-history;2",
-    nsNavHistoryConstructor },
+    nsNavHistoryConstructor,
+    NS_NAVHISTORY_CLASSINFO },
 
   { "Browser Navigation History",
     NS_NAVHISTORYSERVICE_CID,
     "@mozilla.org/autocomplete/search;1?name=history",
-    nsNavHistoryConstructor },
+    nsNavHistoryConstructor,
+    NS_NAVHISTORY_CLASSINFO },
 
   { "Download Navigation History",
     NS_NAVHISTORYSERVICE_CID,
     NS_DOWNLOADHISTORY_CONTRACTID,
-    nsNavHistoryConstructor },
+    nsNavHistoryConstructor,
+    NS_NAVHISTORY_CLASSINFO },
 
   { "Page Annotation Service",
     NS_ANNOTATIONSERVICE_CID,
     NS_ANNOTATIONSERVICE_CONTRACTID,
     nsAnnotationServiceConstructor },
@@ -57,10 +70,11 @@ static const nsModuleComponentInfo compo
     nsFaviconServiceConstructor },
 
   { "Browser History Charset Resolver",
     NS_NAVHISTORYSERVICE_CID,
     "@mozilla.org/embeddor.implemented/bookmark-charset-resolver;1",
-    nsNavHistoryConstructor },
+    nsNavHistoryConstructor,
+    NS_NAVHISTORY_CLASSINFO },
 
 };
 
 NS_IMPL_NSGETMODULE(nsPlacesModule, components)
diff -r f3ac957eb4af toolkit/components/satchel/src/nsStorageFormHistory.cpp
--- a/toolkit/components/satchel/src/nsStorageFormHistory.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/components/satchel/src/nsStorageFormHistory.cpp	Sat Sep 06 10:14:38 2008 +0300
@@ -446,11 +446,11 @@ nsFormHistory::OpenDatabase()
 
   rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING("SELECT * FROM moz_formhistory WHERE fieldname=?1"),
                                 getter_AddRefs(mDBFindEntryByName));
   NS_ENSURE_SUCCESS(rv,rv);
 
-  rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING("SELECT value FROM moz_formhistory WHERE fieldname=?1"),
+  rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING("SELECT value FROM moz_formhistory WHERE fieldname=?1 ORDER BY value ASC"),
                                 getter_AddRefs(mDBGetMatchingField));
   NS_ENSURE_SUCCESS(rv,rv);
 
   rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING("INSERT INTO moz_formhistory (fieldname, value) VALUES (?1, ?2)"),
                                 getter_AddRefs(mDBInsertNameValue));
diff -r f3ac957eb4af toolkit/content/widgets/menu.xml
--- a/toolkit/content/widgets/menu.xml	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/content/widgets/menu.xml	Sat Sep 06 10:14:38 2008 +0300
@@ -246,11 +246,11 @@
 
   <binding id="menu-iconic"
            extends="chrome://global/content/bindings/menu.xml#menu-base">
     <content>
       <xul:hbox class="menu-iconic-left" align="center" pack="center">
-        <xul:image xbl:inherits="src=image"/>
+        <xul:image class="menu-iconic-icon" xbl:inherits="src=image"/>
       </xul:hbox>
       <xul:label class="menu-iconic-text" flex="1" xbl:inherits="value=label,accesskey,crop" crop="right"/>
       <xul:hbox class="menu-accel-container" anonid="accel">
         <xul:label class="menu-iconic-accel" xbl:inherits="value=acceltext"/>
       </xul:hbox>
diff -r f3ac957eb4af toolkit/locales/en-US/chrome/mozapps/update/updates.properties
--- a/toolkit/locales/en-US/chrome/mozapps/update/updates.properties	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/locales/en-US/chrome/mozapps/update/updates.properties	Sat Sep 06 10:14:38 2008 +0300
@@ -70,10 +70,11 @@ checker_error-2152398890=Proxy Server No
 checker_error-2152398890=Proxy Server Not Found (Check your internet connection or contact your Administrator)
 # NS_ERROR_DOCUMENT_NOT_CACHED
 checker_error-2152398918=Network is Offline (Go online)
 checker_error-2152398919=AUS: Data transfer was interrupted (Please try again)
 checker_error-2152398920=Proxy Server Connection Refused (Contact your Administrator)
+checker_error-2153390069=Server certificate has expired (Please adjust your system clock to the correct date and time if it is incorrect or contact your Administrator)
 checker_error-verification_failed=The integrity of the update could not be verified (Contact your Administrator)
 
 installSuccess=The Update was successfully installed
 patchApplyFailure=The Update could not be installed (Patch Apply Failed)
 installPending=Install Pending
diff -r f3ac957eb4af toolkit/mozapps/extensions/content/extensions.xul
--- a/toolkit/mozapps/extensions/content/extensions.xul	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/mozapps/extensions/content/extensions.xul	Sat Sep 06 10:14:38 2008 +0300
@@ -197,13 +197,13 @@
                      ondragenter="nsDragAndDrop.dragEnter(event, gExtensionsDNDObserver);"
                      ondragover="nsDragAndDrop.dragOver(event, gExtensionsDNDObserver);"
                      ondragdrop="nsDragAndDrop.drop(event, gExtensionsDNDObserver);"
                      ondblclick="onViewDoubleClick(event);"/>
   
-        <splitter id="themeSplitter" hidden="true" collapse="after" persist="state"/>
+        <splitter id="themeSplitter" hidden="true" collapse="none" persist="state"/>
   
-        <vbox id="themePreviewArea" hidden="true" width="220" persist="width">
+        <vbox id="themePreviewArea" hidden="true" width="220" flex="1" persist="width">
           <deck id="previewImageDeck" flex="1">
             <vbox id="noThemeSelected" pack="center" align="center">
               <label class="previewText">&previewNoThemeSelected.label;</label>
             </vbox>
             <vbox id="noPreviewImage" pack="center" align="center">
@@ -233,46 +233,85 @@
       </hbox>
     </vbox>
   </notificationbox>
   <vbox>
     <hbox id="commandBarBottom" align="center">
-      <button id="installFileButton" label="&cmd.installLocalFile.label;"
-              accesskey="&cmd.installLocalFile.accesskey;"
-              tooltiptextaddons="&cmd.installFileAddon.tooltip;"
-              tooltiptextthemes="&cmd.installFileTheme.tooltip;"
-              command="cmd_installFile"/>
-      <button id="installUpdatesAllButton" label="&cmd.installUpdatesAll.label;"
-              accesskey="&cmd.installUpdatesAll.accesskey;"
-              tooltiptext="&cmd.installUpdatesAll.tooltip;"
-              command="cmd_installUpdatesAll"/>
+#ifdef XP_UNIX
       <button id="showUpdateInfoButton" label="&cmd.showUpdateInfo.label;"
               accesskey="&cmd.showUpdateInfo.accesskey;"
               tooltiptext="&cmd.showUpdateInfo.tooltip;"
               command="cmd_showUpdateInfo"/>
       <button id="hideUpdateInfoButton" label="&cmd.hideUpdateInfo.label;"
               accesskey="&cmd.hideUpdateInfo.accesskey;"
               tooltiptext="&cmd.hideUpdateInfo.tooltip;"
               command="cmd_hideUpdateInfo"/>
+      <label id="getMore" class="text-link"
+             onclick="if (event.button == 0) { openURL(this.getAttribute('getMoreURL')); }"
+             valuethemes="&getThemes.label;"
+             valueplugins="&getPlugins.label;"
+             valueextensions="&getExtensions.label;"/>
+      <button id="installFileButton" label="&cmd.installLocalFile.label;"
+              accesskey="&cmd.installLocalFile.accesskey;"
+              tooltiptextaddons="&cmd.installFileAddon.tooltip;"
+              tooltiptextthemes="&cmd.installFileTheme.tooltip;"
+              command="cmd_installFile"/>
       <button id="checkUpdatesAllButton" label="&cmd.checkUpdatesAll.label;"
               accesskey="&cmd.checkUpdatesAll.accesskey;"
               tooltiptextaddons="&cmd.checkUpdatesAllAddon.tooltip;"
               tooltiptextthemes="&cmd.checkUpdatesAllTheme.tooltip;"
               command="cmd_checkUpdatesAll"/>
       <spacer flex="1"/>
+      <button id="skipDialogButton" label="&cmd.skip.label;"
+              accesskey="&cmd.skip.accesskey;"
+              tooltiptext="&cmd.skip.tooltip;"
+              command="cmd_close"/>
+      <button id="continueDialogButton" label="&cmd.continue.label;"
+              accesskey="&cmd.continue.accesskey;"
+              tooltiptext="&cmd.continue.tooltip;"
+              command="cmd_continue"/>
+      <button id="installUpdatesAllButton" label="&cmd.installUpdatesAll.label;"
+              accesskey="&cmd.installUpdatesAll.accesskey;"
+              tooltiptext="&cmd.installUpdatesAll.tooltip;"
+              command="cmd_installUpdatesAll"/>
+#else
+      <button id="installFileButton" label="&cmd.installLocalFile.label;"
+              accesskey="&cmd.installLocalFile.accesskey;"
+              tooltiptextaddons="&cmd.installFileAddon.tooltip;"
+              tooltiptextthemes="&cmd.installFileTheme.tooltip;"
+              command="cmd_installFile"/>
+      <spacer flex="1"/>
+      <button id="continueDialogButton" label="&cmd.continue.label;"
+              accesskey="&cmd.continue.accesskey;"
+              tooltiptext="&cmd.continue.tooltip;"
+              command="cmd_continue"/>
+      <button id="installUpdatesAllButton" label="&cmd.installUpdatesAll.label;"
+              accesskey="&cmd.installUpdatesAll.accesskey;"
+              tooltiptext="&cmd.installUpdatesAll.tooltip;"
+              command="cmd_installUpdatesAll"/>
+      <button id="checkUpdatesAllButton" label="&cmd.checkUpdatesAll.label;"
+              accesskey="&cmd.checkUpdatesAll.accesskey;"
+              tooltiptextaddons="&cmd.checkUpdatesAllAddon.tooltip;"
+              tooltiptextthemes="&cmd.checkUpdatesAllTheme.tooltip;"
+              command="cmd_checkUpdatesAll"/>
+      <button id="skipDialogButton" label="&cmd.skip.label;"
+              accesskey="&cmd.skip.accesskey;"
+              tooltiptext="&cmd.skip.tooltip;"
+              command="cmd_close"/>
+      <button id="showUpdateInfoButton" label="&cmd.showUpdateInfo.label;"
+              accesskey="&cmd.showUpdateInfo.accesskey;"
+              tooltiptext="&cmd.showUpdateInfo.tooltip;"
+              command="cmd_showUpdateInfo"/>
+      <button id="hideUpdateInfoButton" label="&cmd.hideUpdateInfo.label;"
+              accesskey="&cmd.hideUpdateInfo.accesskey;"
+              tooltiptext="&cmd.hideUpdateInfo.tooltip;"
+              command="cmd_hideUpdateInfo"/>
       <label id="getMore" class="text-link"
              onclick="if (event.button == 0) { openURL(this.getAttribute('getMoreURL')); }"
              valuethemes="&getThemes.label;"
              valueplugins="&getPlugins.label;"
              valueextensions="&getExtensions.label;"/>
-      <button id="continueDialogButton" label="&cmd.continue.label;"
-              accesskey="&cmd.continue.accesskey;"
-              tooltiptext="&cmd.continue.tooltip;"
-              command="cmd_continue"/>
-      <button id="skipDialogButton" label="&cmd.skip.label;"
-              accesskey="&cmd.skip.accesskey;"
-              tooltiptext="&cmd.skip.tooltip;"
-              command="cmd_close"/>
+#endif
     </hbox>
     <hbox id="resizerBox" style="min-width:1px;">
       <spacer flex="1"/>
       <resizer dir="bottomright"/>
     </hbox>
diff -r f3ac957eb4af toolkit/mozapps/installer/packager.mk
--- a/toolkit/mozapps/installer/packager.mk	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/mozapps/installer/packager.mk	Sat Sep 06 10:14:38 2008 +0300
@@ -243,10 +243,12 @@ NO_PKG_FILES += \
 	rebasedlls* \
 	res/samples \
 	res/throbber \
 	shlibsign* \
 	ssltunnel* \
+	certutil* \
+	pk12util* \
 	winEmbed.exe \
 	os2Embed.exe \
 	chrome/chrome.rdf \
 	chrome/app-chrome.manifest \
 	chrome/overlayinfo \
diff -r f3ac957eb4af toolkit/mozapps/update/content/updates.js
--- a/toolkit/mozapps/update/content/updates.js	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/mozapps/update/content/updates.js	Sat Sep 06 10:14:38 2008 +0300
@@ -1168,10 +1168,14 @@ var gDownloadingPage = {
     this._downloadProgress = document.getElementById("downloadProgress");
     this._downloadThrobber = document.getElementById("downloadThrobber");
     this._pauseButton = document.getElementById("pauseButton");
     this._label_downloadStatus = this._downloadStatus.textContent;
 
+    // move focus to the pause/resume button and then disable it (bug #353177)
+    this._pauseButton.focus();
+    this._pauseButton.disabled = true;
+
     var updates =
         Components.classes["@mozilla.org/updates/update-service;1"].
         getService(Components.interfaces.nsIApplicationUpdateService);
 
     var um =
diff -r f3ac957eb4af toolkit/mozapps/update/content/updates.xul
--- a/toolkit/mozapps/update/content/updates.xul	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/mozapps/update/content/updates.xul	Sat Sep 06 10:14:38 2008 +0300
@@ -171,11 +171,11 @@
     <progressmeter id="downloadProgress" mode="undetermined"/>
     <hbox id="downloadStatusLine">
       <image id="downloadThrobber"/>
       <description id="downloadStatus" flex="1">&connecting.label;</description>
       <button id="pauseButton" oncommand="gDownloadingPage.onPause();" 
-              disabled="true" label="&pause.label;" accesskey="&pause.accesskey;"/>
+              label="&pause.label;" accesskey="&pause.accesskey;"/>
     </hbox>
     <separator/>
     <hbox id="verificationFailed" align="start" hidden="true">
       <image id="verificationFailedIcon"/>
       <description flex="1">&verificationFailedText.label;</description>
diff -r f3ac957eb4af toolkit/mozapps/update/src/updater/updater.cpp
--- a/toolkit/mozapps/update/src/updater/updater.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/mozapps/update/src/updater/updater.cpp	Sat Sep 06 10:14:38 2008 +0300
@@ -1220,11 +1220,11 @@ int NS_main(int argc, NS_tchar **argv)
   HANDLE updateLockFileHandle;
   NS_tchar elevatedLockFilePath[MAXPATHLEN];
   if (argc > 4) {
     NS_tchar updateLockFilePath[MAXPATHLEN];
     NS_tsnprintf(updateLockFilePath, MAXPATHLEN,
-                 NS_T("%s/update_in_progress.lock"), argv[3]);
+                 NS_T("%s.update_in_progress.lock"), argv[4]);
 
     // The update_in_progress.lock file should only exist during an update. In
     // case it exists attempt to remove it and exit if that fails to prevent
     // simultaneous updates occurring.
     if (!_waccess(updateLockFilePath, F_OK) &&
diff -r f3ac957eb4af toolkit/mozapps/update/test/unit/test_0051_general.js
--- a/toolkit/mozapps/update/test/unit/test_0051_general.js	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/mozapps/update/test/unit/test_0051_general.js	Sat Sep 06 10:14:38 2008 +0300
@@ -165,13 +165,19 @@ function run_test_pt9() {
 function run_test_pt9() {
   run_test_helper("aus-0051_general-9.xml", "proxy server connection refused",
                   2152398920, getStatusText("2152398920"), run_test_pt10);
 }
 
+// server certificate expired
+function run_test_pt10() {
+  run_test_helper("aus-0051_general-10.xml", "server certificate expired",
+                  2153390069, getStatusText("2153390069"), run_test_pt11);
+}
+
 // default onload error message (error code 1152398920 is not defined)
-function run_test_pt10() {
-  run_test_helper("aus-0051_general-10.xml", "default onload error message",
+function run_test_pt11() {
+  run_test_helper("aus-0051_general-11.xml", "default onload error message",
                   1152398920, getStatusText("404"), end_test);
 }
 
 // Update check listener
 const updateCheckListener = {
diff -r f3ac957eb4af toolkit/themes/gnomestripe/mozapps/extensions/extensions.css
--- a/toolkit/themes/gnomestripe/mozapps/extensions/extensions.css	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/themes/gnomestripe/mozapps/extensions/extensions.css	Sat Sep 06 10:14:38 2008 +0300
@@ -18,10 +18,11 @@ notification {
   -moz-border-top-colors: ThreeDShadow ThreeDDarkShadow;
   -moz-border-right-colors: ThreeDHighlight ThreeDLightShadow;
   -moz-border-bottom-colors: ThreeDHighlight ThreeDLightShadow;
   -moz-border-left-colors: ThreeDShadow ThreeDDarkShadow;
   margin: 0;
+  min-width: 245px;
 }
 
 #resizerBox {
   margin-top: -12px;
   visibility: hidden;
@@ -112,12 +113,16 @@ richlistitem[selected="true"]:not([opTyp
   -moz-border-right-colors: ThreeDHighlight ThreeDLightShadow;
   -moz-border-bottom-colors: ThreeDHighlight ThreeDLightShadow;
   -moz-border-left-colors: ThreeDShadow ThreeDDarkShadow;
   background-color: -moz-Field;
   color: -moz-FieldText;
+  min-width: 65px;
   overflow: auto;
-  width: 0px;
+}
+
+#previewImageDeck {
+  min-width: 220px;
 }
 
 #themeSplitter {
  border-width: 0;
 }
diff -r f3ac957eb4af toolkit/themes/pinstripe/mozapps/extensions/extensions.css
--- a/toolkit/themes/pinstripe/mozapps/extensions/extensions.css	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/themes/pinstripe/mozapps/extensions/extensions.css	Sat Sep 06 10:14:38 2008 +0300
@@ -13,10 +13,14 @@
 }
 
 #extensionsBox {
   padding: 0;
   min-width:1px;
+}
+
+#extensionsView {
+  min-width: 245px;
 }
 
 #resizerBox {
   margin-top: -12px;
   visibility: hidden;
@@ -112,10 +116,19 @@ richlistitem[selected="true"]:not([opTyp
   -moz-border-start: 2px solid;
   -moz-border-right-colors: #383E48 #57606F;
   -moz-border-left-colors: #383E48 #57606F;
   width: 4px;
   background-image: none;
+}
+
+#themePreviewArea {
+  min-width: 65px;
+  overflow: auto;
+}
+
+#previewImageDeck {
+  min-width: 220px;
 }
 
 #themePreviewArea,
 #themeSplitter {
   background-color: #737E8E;
diff -r f3ac957eb4af toolkit/themes/winstripe/global/menu.css
--- a/toolkit/themes/winstripe/global/menu.css	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/themes/winstripe/global/menu.css	Sat Sep 06 10:14:38 2008 +0300
@@ -73,11 +73,11 @@ menuitem.spell-suggestion {
 .menu-accel,
 .menu-iconic-accel,
 .menu-text,
 .menu-iconic-text {
   margin: 0px !important;
-  padding: 0px;
+  padding: 1px 0px;
   color: inherit;
 }
 
 .menu-text {
   -moz-padding-start: 1.45em !important;
@@ -102,39 +102,33 @@ menuitem.spell-suggestion {
   color: inherit;
   -moz-margin-start: 0.74em !important;
   -moz-margin-end: 1.35em !important;
 }
 
-.menu-iconic-left,
-.menu-right {
-  min-width:  1.45em;
-  min-height: 1.21em;
+.menu-iconic-left {
+  min-width: 1.45em;
 }
 
 .menu-iconic-icon {
   width: 16px;
   height: 16px;
 }
 
 menu.menu-iconic > .menu-iconic-left,
 menuitem.menuitem-iconic > .menu-iconic-left {
   -moz-appearance: menuimage;
-}
-
-menu.menu-iconic > .menu-iconic-left > .menu-iconic-icon,
-menuitem.menuitem-iconic > .menu-iconic-left > .menu-iconic-icon {
-  /* reduce icon-text crowding */
-  -moz-margin-start: -1px;
-  -moz-margin-end: 1px;
+  padding-top: 2px;
 }
 
 /* ..... menu arrow box ..... */
 
 .menu-right {
   -moz-appearance: menuarrow;
   -moz-margin-end: -2px;
   list-style-image: none;
+  min-width: 1.28em;
+  padding-top: 1px;
 }
 
 /* ::::: menu/menuitems in menubar ::::: */
 
 menubar > menu {
@@ -196,10 +190,19 @@ menulist > menupopup > menu {
 .menulist-menupopup > menuitem > .menu-iconic-left,
 menulist > menupopup > menuitem > .menu-iconic-left,
 .menulist-menupopup > menu > .menu-iconic-left,
 menulist > menupopup > menu > .menu-iconic-left {
   display: none;
+  padding-top: 0px;
+}
+
+.menulist-menupopup > menuitem > label,
+menulist > menupopup > menuitem > label,
+.menulist-menupopup > menu > label,
+menulist > menupopup > menu > label {
+  padding-top: 0px;
+  padding-bottom: 0px;
 }
 
 menulist > menupopup > menuitem[_moz-menuactive="true"] {
   border: 1px dotted #F5DB95;
   background-color: highlight;
@@ -221,17 +224,19 @@ menuitem[checked="true"] {
   -moz-appearance: checkmenuitem;
 }
 menuitem[type="checkbox"] > .menu-iconic-left,
 menuitem[checked="true"] > .menu-iconic-left {
   -moz-appearance: menucheckbox;
+  padding-top: 0px;
 }
 
 menuitem[type="radio"] {
   -moz-appearance: radiomenuitem;
 }
 menuitem[type="radio"] > .menu-iconic-left {
   -moz-appearance: menuradio;
+  padding-top: 0px;
 }
 
 menuitem[type="checkbox"] > .menu-iconic-left > .menu-iconic-icon,
 menuitem[checked="true"] > .menu-iconic-left > .menu-iconic-icon,
 menuitem[type="radio"] > .menu-iconic-left > .menu-iconic-icon {
diff -r f3ac957eb4af toolkit/themes/winstripe/mozapps/extensions/extensions.css
--- a/toolkit/themes/winstripe/mozapps/extensions/extensions.css	Thu Sep 04 12:36:46 2008 -0400
+++ b/toolkit/themes/winstripe/mozapps/extensions/extensions.css	Sat Sep 06 10:14:38 2008 +0300
@@ -8,10 +8,11 @@
   -moz-border-top-colors: ThreeDShadow ThreeDDarkShadow;
   -moz-border-right-colors: ThreeDHighlight ThreeDLightShadow;
   -moz-border-bottom-colors: ThreeDHighlight ThreeDLightShadow;
   -moz-border-left-colors: ThreeDShadow ThreeDDarkShadow;
   margin: 0;
+  min-width: 245px;
 }
 
 #resizerBox {
   margin-top: -12px;
   visibility: hidden;
@@ -102,12 +103,16 @@ richlistitem[selected="true"]:not([opTyp
   -moz-border-right-colors: ThreeDHighlight ThreeDLightShadow;
   -moz-border-bottom-colors: ThreeDHighlight ThreeDLightShadow;
   -moz-border-left-colors: ThreeDShadow ThreeDDarkShadow;
   background-color: -moz-Field;
   color: -moz-FieldText;
+  min-width: 65px;
   overflow: auto;
-  width: 0px;
+}
+
+#previewImageDeck {
+  min-width: 220px;
 }
 
 #themeSplitter {
  border-width: 0;
 }
diff -r f3ac957eb4af view/public/nsIScrollPositionListener.h
--- a/view/public/nsIScrollPositionListener.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/view/public/nsIScrollPositionListener.h	Sat Sep 06 10:14:38 2008 +0300
@@ -45,26 +45,23 @@
 
 // forward declarations
 class nsIScrollableView;
 
 // IID for the nsIScrollPositionListener interface
-// {98a0c040-09cf-408b-b55f-321b4f8d9d67}
-
+// {f8dfc500-6ad1-11d3-8360-a3f373ff79fc}
 #define NS_ISCROLLPOSITIONLISTENER_IID \
-    { 0x98a0c040, 0x09cf, 0x408b, \
-      { 0xb5, 0x5f, 0x32, 0x1b, 0x4f, 0x8d, 0x9d, 0x67 } }
+{ 0xf8dfc500, 0x6ad1, 0x11d3, { 0x83, 0x60, 0xa3, 0xf3, 0x73, 0xff, 0x79, 0xfc } }
 
 /**
  * Provides a way for a client of an nsIScrollableView to learn about scroll position
  * changes.
  */
 class nsIScrollPositionListener : public nsISupports {
 public:
 	NS_DECLARE_STATIC_IID_ACCESSOR(NS_ISCROLLPOSITIONLISTENER_IID)
 
 	NS_IMETHOD ScrollPositionWillChange(nsIScrollableView* aScrollable, nscoord aX, nscoord aY) = 0;
-	virtual void ViewPositionDidChange(nsIScrollableView* aScrollable) = 0;
 	NS_IMETHOD ScrollPositionDidChange(nsIScrollableView* aScrollable, nscoord aX, nscoord aY) = 0;
 };
 
 NS_DEFINE_STATIC_IID_ACCESSOR(nsIScrollPositionListener,
                               NS_ISCROLLPOSITIONLISTENER_IID)
diff -r f3ac957eb4af view/src/nsScrollPortView.cpp
--- a/view/src/nsScrollPortView.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/view/src/nsScrollPortView.cpp	Sat Sep 06 10:14:38 2008 +0300
@@ -645,22 +645,10 @@ NS_IMETHODIMP nsScrollPortView::ScrollTo
   // move the scrolled view to the new location
   // Note that child widgets may be scrolled by the native widget scrolling,
   // so don't update their positions
   scrolledView->SetPositionIgnoringChildWidgets(-aX, -aY);
       
-  // notify the listeners.
-  if (nsnull != mListeners) {
-    if (NS_SUCCEEDED(mListeners->Count(&listenerCount))) {
-      for (PRUint32 i = 0; i < listenerCount; i++) {
-        if (NS_SUCCEEDED(mListeners->QueryElementAt(i, kScrollPositionListenerIID, (void**)&listener))) {
-          listener->ViewPositionDidChange(this);
-          NS_RELEASE(listener);
-        }
-      }
-    }
-  }
-
   nsPoint twipsDelta(aX - mOffsetX, aY - mOffsetY);
 
   // store the new position
   mOffsetX = aX;
   mOffsetY = aY;
diff -r f3ac957eb4af widget/src/windows/nsNativeThemeWin.cpp
--- a/widget/src/windows/nsNativeThemeWin.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/widget/src/windows/nsNativeThemeWin.cpp	Sat Sep 06 10:14:38 2008 +0300
@@ -1805,13 +1805,12 @@ nsNativeThemeWin::ClassicGetWidgetBorder
           (*aResult).top = (*aResult).left = 3;
           (*aResult).bottom = (*aResult).right = 1;
         }
       }
       else {
-        (*aResult).top = 1;
-        (*aResult).bottom = 3;
-        (*aResult).left = (*aResult).right = 2;
+        (*aResult).top = 0;
+        (*aResult).bottom = (*aResult).left = (*aResult).right = 2;
       }
       break;
     }
     default:
       (*aResult).top = (*aResult).bottom = (*aResult).left = (*aResult).right = 0;
diff -r f3ac957eb4af widget/src/xpwidgets/nsXPLookAndFeel.cpp
--- a/widget/src/xpwidgets/nsXPLookAndFeel.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/widget/src/xpwidgets/nsXPLookAndFeel.cpp	Sat Sep 06 10:14:38 2008 +0300
@@ -324,10 +324,15 @@ nsXPLookAndFeel::ColorPrefChanged (unsig
 #ifdef DEBUG_akkana
         printf("====== Changed color pref %s to 0x%lx\n",
                prefName, thecolor);
 #endif
       }
+    } else if (colorStr.IsEmpty()) {
+      // Reset to the default color, by clearing the cache
+      // to force lookup when the color is next used
+      PRInt32 id = NS_PTR_TO_INT32(index);
+      CLEAR_COLOR_CACHE(id);
     }
   }
 }
 
 void
diff -r f3ac957eb4af widget/src/xpwidgets/nsXPLookAndFeel.h
--- a/widget/src/xpwidgets/nsXPLookAndFeel.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/widget/src/xpwidgets/nsXPLookAndFeel.h	Sat Sep 06 10:14:38 2008 +0300
@@ -74,10 +74,12 @@ struct nsLookAndFeelFloatPref
 #define CACHE_BLOCK(x)     ((x) >> 5)
 #define CACHE_BIT(x)       (1 << ((x) & 31))
 
 #define COLOR_CACHE_SIZE   (CACHE_BLOCK(nsILookAndFeel::eColor_LAST_COLOR) + 1)
 #define IS_COLOR_CACHED(x) (CACHE_BIT(x) & nsXPLookAndFeel::sCachedColorBits[CACHE_BLOCK(x)])
+#define CLEAR_COLOR_CACHE(x) nsXPLookAndFeel::sCachedColors[(x)] =0; \
+              nsXPLookAndFeel::sCachedColorBits[CACHE_BLOCK(x)] &= ~(CACHE_BIT(x));
 #define CACHE_COLOR(x, y)  nsXPLookAndFeel::sCachedColors[(x)] = y; \
               nsXPLookAndFeel::sCachedColorBits[CACHE_BLOCK(x)] |= CACHE_BIT(x);
 
 class nsXPLookAndFeel: public nsILookAndFeel, public nsIObserver
 {
diff -r f3ac957eb4af xpcom/base/nsMemoryImpl.cpp
--- a/xpcom/base/nsMemoryImpl.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/xpcom/base/nsMemoryImpl.cpp	Sat Sep 06 10:14:38 2008 +0300
@@ -55,10 +55,13 @@
 #if defined(XP_WIN)
 #include <windows.h>
 #define NS_MEMORY_FLUSHER
 #elif defined (NS_OSSO)
 #include <osso-mem.h>
+#include <fcntl.h>
+#include <unistd.h>
+const char* kHighMark = "/sys/kernel/high_watermark";
 #else
 // Need to implement the nsIMemory::IsLowMemory() predicate
 #undef NS_MEMORY_FLUSHER
 #endif
 
@@ -190,19 +193,19 @@ nsMemoryImpl::IsLowMemory(PRBool *result
 #elif defined(XP_WIN)
     MEMORYSTATUS stat;
     GlobalMemoryStatus(&stat);
     *result = ((float)stat.dwAvailPageFile / stat.dwTotalPageFile) < 0.1;
 #elif defined(NS_OSSO)
-    osso_mem_usage_t usage;
-    osso_mem_get_usage(&usage);
-    
-    // According to the docs, low memory limit isn't set if it is
-    // zero, or if it is greater than 100%.
-    if (usage.low == 0 || usage.low > usage.total)
-      *result = PR_FALSE;
-    else
-      *result = (PRBool) usage.low <= usage.used;
+    int fd = open (kHighMark, O_RDONLY);
+    if (fd == -1) {
+        *result = PR_FALSE;
+        return NS_OK;
+    }
+    int c = 0;
+    read (fd, &c, 1);
+    close(fd);
+    *result = (c == '1');
 #else
     *result = PR_FALSE;
 #endif
     return NS_OK;
 }
diff -r f3ac957eb4af xpcom/components/nsComponentManager.cpp
--- a/xpcom/components/nsComponentManager.cpp	Thu Sep 04 12:36:46 2008 -0400
+++ b/xpcom/components/nsComponentManager.cpp	Sat Sep 06 10:14:38 2008 +0300
@@ -80,10 +80,12 @@
 #include "nsReadableUtils.h"
 #include "nsString.h"
 #include "nsXPIDLString.h"
 #include "prcmon.h"
 #include "xptinfo.h" // this after nsISupports, to pick up IID so that xpt stuff doesn't try to define it itself...
+#include "nsThreadUtils.h"
+#include "prthread.h"
 
 #include "nsInt64.h"
 #include "nsManifestLineReader.h"
 
 #include NEW_H     // for placement new
@@ -99,11 +101,10 @@ NS_COM PRLogModuleInfo* nsComponentManag
 NS_COM PRLogModuleInfo* nsComponentManagerLog = nsnull;
 
 #if 0 || defined (DEBUG_timeless)
  #define SHOW_DENIED_ON_SHUTDOWN
  #define SHOW_CI_ON_EXISTING_SERVICE
- #define XPCOM_CHECK_PENDING_CIDS
 #endif
 
 // Bloated registry buffer size to improve startup performance -- needs to
 // be big enough to fit the entire file into memory or it'll thrash.
 // 512K is big enough to allow for some future growth in the registry.
@@ -1039,50 +1040,10 @@ nsComponentManagerImpl::ReadPersistentRe
         }
 
         contractIDTableEntry->mFactoryEntry = cidEntry;
     }
 
-#ifdef XPCOM_CHECK_PENDING_CIDS
-    {
-/*
- * If you get Asserts when you define SHOW_CI_ON_EXISTING_SERVICE and want to
- * track down their cause, then you should add the contracts listed by the
- * assertion to abusedContracts. The next time you run your xpcom app, xpcom
- * will assert the first time the object associated with the contract is
- * instantiated (which in many cases is the source of the problem).
- *
- * If you're doing this then you might want to NOP and soft breakpoint the
- * lines labeled: NOP_AND_BREAK.
- *
- * Otherwise XPCOM will refuse to create the object for the caller, which
- * while reasonable at some level, will almost certainly cause the app to
- * stop functioning normally.
- */
-        static char abusedContracts[][128] = {
-        /*// Example contracts:
-            "@mozilla.org/rdf/container;1",
-            "@mozilla.org/intl/charsetalias;1",
-            "@mozilla.org/locale/win32-locale;1",
-            "@mozilla.org/widget/lookandfeel/win;1",
-        // */
-            0
-        };
-        for (int i=0; abusedContracts[i] && *abusedContracts[i]; i++) {
-            nsFactoryEntry *entry = nsnull;
-            nsContractIDTableEntry* contractIDTableEntry =
-                static_cast<nsContractIDTableEntry*>
-                           (PL_DHashTableOperate(&mContractIDs, abusedContracts[i],
-                                                    PL_DHASH_LOOKUP));
-
-            if (PL_DHASH_ENTRY_IS_BUSY(contractIDTableEntry)) {
-                entry = contractIDTableEntry->mFactoryEntry;
-                AddPendingCID(entry->mCid);
-            }
-        }
-    }
-#endif
-
     if (ReadSectionHeader(reader, "CATEGORIES"))
         goto out;
 
     mCategoryManager->SuppressNotifications(PR_TRUE);
 
@@ -1579,44 +1540,10 @@ nsComponentManagerImpl::CLSIDToContractI
     }
 #endif
     return rv;
 }
 
-#ifdef XPCOM_CHECK_PENDING_CIDS
-
-// This method must be called from within the mMon monitor
-nsresult
-nsComponentManagerImpl::AddPendingCID(const nsCID &aClass)
-{
-    int max = mPendingCIDs.Count();
-    for (int index = 0; index < max; index++)
-    {
-        nsCID *cidp = (nsCID*) mPendingCIDs.ElementAt(index);
-        NS_ASSERTION(cidp, "Bad CID in pending list");
-        if (cidp->Equals(aClass)) {
-            nsXPIDLCString cid;
-            cid.Adopt(aClass.ToString());
-            nsCAutoString message;
-            message = NS_LITERAL_CSTRING("Creation of \"") +
-                      cid + NS_LITERAL_CSTRING("\" in progress (Reentrant GS - see bug 194568)");
-            // Note that you may see this assertion by near-simultaneous
-            // calls to GetService on multiple threads.
-            NS_WARNING(message.get());
-            return NS_ERROR_NOT_AVAILABLE;
-        }
-    }
-    mPendingCIDs.AppendElement((void*)&aClass);
-    return NS_OK;
-}
-
-// This method must be called from within the mMon monitor
-void
-nsComponentManagerImpl::RemovePendingCID(const nsCID &aClass)
-{
-    mPendingCIDs.RemoveElement((void*)&aClass);
-}
-#endif
 /**
  * CreateInstance()
  *
  * Create an instance of an object that implements an interface and belongs
  * to the implementation aClass using the factory. The factory is immediately
@@ -1829,10 +1756,51 @@ nsComponentManagerImpl::FreeServices()
     }
 
     return NS_OK;
 }
 
+// This should only ever be called within the monitor!
+nsComponentManagerImpl::PendingServiceInfo*
+nsComponentManagerImpl::AddPendingService(const nsCID& aServiceCID,
+                                          PRThread* aThread)
+{
+  PendingServiceInfo* newInfo = mPendingServices.AppendElement();
+  if (newInfo) {
+    newInfo->cid = &aServiceCID;
+    newInfo->thread = aThread;
+  }
+  return newInfo;
+}
+
+// This should only ever be called within the monitor!
+void
+nsComponentManagerImpl::RemovePendingService(const nsCID& aServiceCID)
+{
+  PRUint32 pendingCount = mPendingServices.Length();
+  for (PRUint32 index = 0; index < pendingCount; ++index) {
+    const PendingServiceInfo& info = mPendingServices.ElementAt(index);
+    if (info.cid->Equals(aServiceCID)) {
+      mPendingServices.RemoveElementAt(index);
+      return;
+    }
+  }
+}
+
+// This should only ever be called within the monitor!
+PRThread*
+nsComponentManagerImpl::GetPendingServiceThread(const nsCID& aServiceCID) const
+{
+  PRUint32 pendingCount = mPendingServices.Length();
+  for (PRUint32 index = 0; index < pendingCount; ++index) {
+    const PendingServiceInfo& info = mPendingServices.ElementAt(index);
+    if (info.cid->Equals(aServiceCID)) {
+      return info.thread;
+    }
+  }
+  return nsnull;
+}
+
 NS_IMETHODIMP
 nsComponentManagerImpl::GetService(const nsCID& aClass,
                                    const nsIID& aIID,
                                    void* *result)
 {
@@ -1851,11 +1819,10 @@ nsComponentManagerImpl::GetService(const
         return NS_ERROR_UNEXPECTED;
     }
 
     nsAutoMonitor mon(mMon);
 
-    nsresult rv = NS_OK;
     nsIDKey key(aClass);
     nsFactoryEntry* entry = nsnull;
     nsFactoryTableEntry* factoryTableEntry =
         static_cast<nsFactoryTableEntry*>
                    (PL_DHashTableOperate(&mFactories, &aClass,
@@ -1869,28 +1836,82 @@ nsComponentManagerImpl::GetService(const
         nsCOMPtr<nsISupports> supports = entry->mServiceObject;
         mon.Exit();
         return supports->QueryInterface(aIID, result);
     }
 
-#ifdef XPCOM_CHECK_PENDING_CIDS
-    rv = AddPendingCID(aClass);
-    if (NS_FAILED(rv))
-        return rv; // NOP_AND_BREAK
+    PRThread* currentPRThread = PR_GetCurrentThread();
+    NS_ASSERTION(currentPRThread, "This should never be null!");
+
+    // Needed to optimize the event loop below.
+    nsIThread* currentThread = nsnull;
+
+    PRThread* pendingPRThread;
+    while ((pendingPRThread = GetPendingServiceThread(aClass))) {
+        if (pendingPRThread == currentPRThread) {
+            NS_ERROR("Recursive GetService!");
+            return NS_ERROR_NOT_AVAILABLE;
+        }
+
+        mon.Exit();
+
+        if (!currentThread) {
+            currentThread = NS_GetCurrentThread();
+            NS_ASSERTION(currentThread, "This should never be null!");
+        }
+
+        // This will process a single event or yield the thread if no event is
+        // pending.
+        if (!NS_ProcessNextEvent(currentThread, PR_FALSE)) {
+            PR_Sleep(PR_INTERVAL_NO_WAIT);
+        }
+
+        mon.Enter();
+    }
+
+    if (currentThread) {
+        // If we have a currentThread then we must have waited on another thread
+        // to create the service. Grab it now if that succeeded.
+        if (!entry) {
+            factoryTableEntry = static_cast<nsFactoryTableEntry*>
+                (PL_DHashTableOperate(&mFactories, &aClass, PL_DHASH_LOOKUP));
+
+            if (PL_DHASH_ENTRY_IS_BUSY(factoryTableEntry)) {
+                entry = factoryTableEntry->mFactoryEntry;
+            }
+        }
+
+        // It's still possible that the other thread failed to create the
+        // service so we're not guaranteed to have an entry or service yet.
+        if (entry && entry->mServiceObject) {
+            nsCOMPtr<nsISupports> supports = entry->mServiceObject;
+            mon.Exit();
+            return supports->QueryInterface(aIID, result);
+        }
+    }
+
+#ifdef DEBUG
+    PendingServiceInfo* newInfo =
 #endif
+    AddPendingService(aClass, currentPRThread);
+    NS_ASSERTION(newInfo, "Failed to add info to the array!");
+
     nsCOMPtr<nsISupports> service;
     // We need to not be holding the service manager's monitor while calling
     // CreateInstance, because it invokes user code which could try to re-enter
     // the service manager:
     mon.Exit();
 
-    rv = CreateInstance(aClass, nsnull, aIID, getter_AddRefs(service));
+    nsresult rv = CreateInstance(aClass, nsnull, aIID, getter_AddRefs(service));
 
     mon.Enter();
 
-#ifdef XPCOM_CHECK_PENDING_CIDS
-    RemovePendingCID(aClass);
+#ifdef DEBUG
+    pendingPRThread = GetPendingServiceThread(aClass);
+    NS_ASSERTION(pendingPRThread == currentPRThread,
+                 "Pending service array has been changed!");
 #endif
+    RemovePendingService(aClass);
 
     if (NS_FAILED(rv))
         return rv;
 
     if (!entry) { // second hash lookup for GetService
@@ -1902,10 +1923,12 @@ nsComponentManagerImpl::GetService(const
             entry = factoryTableEntry->mFactoryEntry;
         }
         NS_ASSERTION(entry, "we should have a factory entry since CI succeeded - we should not get here");
         if (!entry) return NS_ERROR_FAILURE;
     }
+
+    NS_ASSERTION(!entry->mServiceObject, "Created two instances of a service!");
 
     entry->mServiceObject = service;
     *result = service.get();
     if (!*result) {
         NS_ERROR("Factory did not return an object but returned success!");
@@ -2152,69 +2175,98 @@ nsComponentManagerImpl::GetServiceByCont
         return NS_ERROR_UNEXPECTED;
     }
 
     nsAutoMonitor mon(mMon);
 
-    nsresult rv = NS_OK;
     nsFactoryEntry *entry = nsnull;
     nsContractIDTableEntry* contractIDTableEntry =
         static_cast<nsContractIDTableEntry*>
                    (PL_DHashTableOperate(&mContractIDs, aContractID,
                                             PL_DHASH_LOOKUP));
 
-    if (PL_DHASH_ENTRY_IS_BUSY(contractIDTableEntry)) {
-        entry = contractIDTableEntry->mFactoryEntry;
+    if (!PL_DHASH_ENTRY_IS_BUSY(contractIDTableEntry))
+        return NS_ERROR_FACTORY_NOT_REGISTERED;
+
+    entry = contractIDTableEntry->mFactoryEntry;
+    NS_ASSERTION(entry, "This should never be null!");
+
+    if (entry->mServiceObject) {
+        nsCOMPtr<nsISupports> serviceObject = entry->mServiceObject;
+
+        // We need to not be holding the service manager's monitor while calling
+        // QueryInterface, because it invokes user code which could try to re-enter
+        // the service manager, or try to grab some other lock/monitor/condvar
+        // and deadlock, e.g. bug 282743.
+        mon.Exit();
+        return serviceObject->QueryInterface(aIID, result);
     }
 
-    if (entry) {
-        if (entry->mServiceObject) {
-            nsCOMPtr<nsISupports> serviceObject = entry->mServiceObject;
+    PRThread* currentPRThread = PR_GetCurrentThread();
+    NS_ASSERTION(currentPRThread, "This should never be null!");
 
-            // We need to not be holding the service manager's monitor while calling
-            // QueryInterface, because it invokes user code which could try to re-enter
-            // the service manager, or try to grab some other lock/monitor/condvar
-            // and deadlock, e.g. bug 282743.
-            mon.Exit();
-            return serviceObject->QueryInterface(aIID, result);
+    // Needed to optimize the event loop below.
+    nsIThread* currentThread = nsnull;
+
+    PRThread* pendingPRThread;
+    while ((pendingPRThread = GetPendingServiceThread(entry->mCid))) {
+        if (pendingPRThread == currentPRThread) {
+            NS_ERROR("Recursive GetService!");
+            return NS_ERROR_NOT_AVAILABLE;
         }
-#ifdef XPCOM_CHECK_PENDING_CIDS
-        rv = AddPendingCID(entry->mCid);
-        if (NS_FAILED(rv))
-            return rv; // NOP_AND_BREAK
+
+        mon.Exit();
+
+        if (!currentThread) {
+            currentThread = NS_GetCurrentThread();
+            NS_ASSERTION(currentThread, "This should never be null!");
+        }
+
+        // This will process a single event or yield the thread if no event is
+        // pending.
+        if (!NS_ProcessNextEvent(currentThread, PR_FALSE)) {
+            PR_Sleep(PR_INTERVAL_NO_WAIT);
+        }
+
+        mon.Enter();
+    }
+
+    if (currentThread && entry->mServiceObject) {
+        // If we have a currentThread then we must have waited on another thread
+        // to create the service. Grab it now if that succeeded.
+        nsCOMPtr<nsISupports> serviceObject = entry->mServiceObject;
+        mon.Exit();
+        return serviceObject->QueryInterface(aIID, result);
+    }
+
+#ifdef DEBUG
+    PendingServiceInfo* newInfo =
 #endif
-    }
+    AddPendingService(entry->mCid, currentPRThread);
+    NS_ASSERTION(newInfo, "Failed to add info to the array!");
 
     nsCOMPtr<nsISupports> service;
     // We need to not be holding the service manager's monitor while calling
     // CreateInstance, because it invokes user code which could try to re-enter
     // the service manager:
     mon.Exit();
 
-    rv = CreateInstanceByContractID(aContractID, nsnull, aIID, getter_AddRefs(service));
+    nsresult rv = CreateInstanceByContractID(aContractID, nsnull, aIID,
+                                             getter_AddRefs(service));
 
     mon.Enter();
 
-#ifdef XPCOM_CHECK_PENDING_CIDS 
-    if (entry)
-        RemovePendingCID(entry->mCid);
+#ifdef DEBUG
+    pendingPRThread = GetPendingServiceThread(entry->mCid);
+    NS_ASSERTION(pendingPRThread == currentPRThread,
+                 "Pending service array has been changed!");
 #endif
+    RemovePendingService(entry->mCid);
 
     if (NS_FAILED(rv))
         return rv;
 
-    if (!entry) { // second hash lookup for GetService
-        nsContractIDTableEntry* contractIDTableEntry =
-            static_cast<nsContractIDTableEntry*>
-                       (PL_DHashTableOperate(&mContractIDs, aContractID,
-                                                PL_DHASH_LOOKUP));
-
-        if (PL_DHASH_ENTRY_IS_BUSY(contractIDTableEntry)) {
-            entry = contractIDTableEntry->mFactoryEntry;
-        }
-        NS_ASSERTION(entry, "we should have a factory entry since CI succeeded - we should not get here");
-        if (!entry) return NS_ERROR_FAILURE;
-    }
+    NS_ASSERTION(!entry->mServiceObject, "Created two instances of a service!");
 
     entry->mServiceObject = service;
     *result = service.get();
     NS_ADDREF(static_cast<nsISupports*>(*result));
     return rv;
diff -r f3ac957eb4af xpcom/components/nsComponentManager.h
--- a/xpcom/components/nsComponentManager.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/xpcom/components/nsComponentManager.h	Sat Sep 06 10:14:38 2008 +0300
@@ -65,10 +65,11 @@
 #include "nsDataHashtable.h"
 #include "nsTArray.h"
 
 struct nsFactoryEntry;
 class nsIServiceManager;
+struct PRThread;
 
 #define NS_COMPONENTMANAGER_CID                      \
 { /* 91775d60-d5dc-11d2-92fb-00e09805570f */         \
     0x91775d60,                                      \
     0xd5dc,                                          \
@@ -258,16 +259,21 @@ public:
     PRBool              mRegistryDirty;
     nsCOMPtr<nsCategoryManager>  mCategoryManager;
 
     PLArenaPool   mArena;
 
-#ifdef XPCOM_CHECK_PENDING_CIDS
-    nsresult AddPendingCID(const nsCID &aClass);
-    void RemovePendingCID(const nsCID &aClass);
+    struct PendingServiceInfo {
+      const nsCID* cid;
+      PRThread* thread;
+    };
 
-    nsVoidArray         mPendingCIDs;
-#endif
+    inline PendingServiceInfo* AddPendingService(const nsCID& aServiceCID,
+                                                 PRThread* aThread);
+    inline void RemovePendingService(const nsCID& aServiceCID);
+    inline PRThread* GetPendingServiceThread(const nsCID& aServiceCID) const;
+
+    nsTArray<PendingServiceInfo> mPendingServices;
 
 private:
     ~nsComponentManagerImpl();
 };
 
diff -r f3ac957eb4af xpcom/tests/Makefile.in
--- a/xpcom/tests/Makefile.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/xpcom/tests/Makefile.in	Sat Sep 06 10:14:38 2008 +0300
@@ -75,10 +75,11 @@ CPPSRCS		= \
 		TestServMgr.cpp \
 		TestAutoPtr.cpp \
 		TestVersionComparator.cpp \
 		TestTextFormatter.cpp \
 		TestPipe.cpp \
+		TestRacingServiceManager.cpp \
 		TestRegistrationOrder.cpp \
 		TestProxies.cpp \
 		TestThreadPoolListener.cpp \
 		TestTimers.cpp \
 		TestOOM.cpp \
@@ -139,10 +140,11 @@ CPP_UNIT_TESTS = \
   TestFactory \
   TestHashtables \
   TestID \
   TestObserverService \
   TestPipe \
+  TestRacingServiceManager \
   TestServMgr \
   TestTextFormatter \
   TestThreadPoolListener \
   TestTimers \
   $(NULL)
diff -r f3ac957eb4af xpcom/tests/TestRacingServiceManager.cpp
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/xpcom/tests/TestRacingServiceManager.cpp	Sat Sep 06 10:14:38 2008 +0300
@@ -0,0 +1,312 @@
+/* -*- Mode: C; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Racing Service Manager Test Code.
+ *
+ * The Initial Developer of the Original Code is
+ *   Ben Turner <bent.mozilla@gmail.com>.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#include "TestHarness.h"
+
+#include "nsIFactory.h"
+#include "nsIThread.h"
+#include "nsIComponentRegistrar.h"
+
+#include "nsAutoLock.h"
+#include "nsAutoPtr.h"
+#include "nsThreadUtils.h"
+#include "nsXPCOMCIDInternal.h"
+#include "prmon.h"
+
+#ifdef DEBUG
+#define TEST_ASSERTION(_test, _msg) \
+    NS_ASSERTION(_test, _msg);
+#else
+#define TEST_ASSERTION(_test, _msg) \
+  PR_BEGIN_MACRO \
+    if (!(_test)) { \
+      NS_DebugBreak(NS_DEBUG_ABORT, _msg, #_test, __FILE__, __LINE__); \
+    } \
+  PR_END_MACRO
+#endif
+
+/* f93f6bdc-88af-42d7-9d64-1b43c649a3e5 */ 
+#define FACTORY_CID1                                 \
+{                                                    \
+  0xf93f6bdc,                                        \
+  0x88af,                                            \
+  0x42d7,                                            \
+  { 0x9d, 0x64, 0x1b, 0x43, 0xc6, 0x49, 0xa3, 0xe5 } \
+}
+NS_DEFINE_CID(kFactoryCID1, FACTORY_CID1);
+
+/* ef38ad65-6595-49f0-8048-e819f81d15e2 */
+#define FACTORY_CID2                                 \
+{                                                    \
+  0xef38ad65,                                        \
+  0x6595,                                            \
+  0x49f0,                                            \
+  { 0x80, 0x48, 0xe8, 0x19, 0xf8, 0x1d, 0x15, 0xe2 } \
+}
+NS_DEFINE_CID(kFactoryCID2, FACTORY_CID2);
+
+#define FACTORY_CONTRACTID                           \
+  "TestRacingThreadManager/factory;1"
+
+PRInt32 gComponent1Count = 0;
+PRInt32 gComponent2Count = 0;
+
+PRMonitor* gMonitor = nsnull;
+
+PRBool gCreateInstanceCalled = PR_FALSE;
+PRBool gMainThreadWaiting = PR_FALSE;
+
+class AutoCreateAndDestroyMonitor
+{
+public:
+  AutoCreateAndDestroyMonitor(PRMonitor** aMonitorPtr)
+  : mMonitorPtr(aMonitorPtr) {
+    *aMonitorPtr =
+      nsAutoMonitor::NewMonitor("TestRacingServiceManager::AutoMon");
+    TEST_ASSERTION(*aMonitorPtr, "Out of memory!");
+  }
+
+  ~AutoCreateAndDestroyMonitor() {
+    if (*mMonitorPtr) {
+      nsAutoMonitor::DestroyMonitor(*mMonitorPtr);
+      *mMonitorPtr = nsnull;
+    }
+  }
+
+private:
+  PRMonitor** mMonitorPtr;
+};
+
+class Factory : public nsIFactory
+{
+public:
+  NS_DECL_ISUPPORTS
+
+  Factory() : mFirstComponentCreated(PR_FALSE) { }
+
+  NS_IMETHOD CreateInstance(nsISupports* aDelegate,
+                            const nsIID& aIID,
+                            void** aResult);
+
+  NS_IMETHOD LockFactory(PRBool aLock) {
+    return NS_OK;
+  }
+
+  PRBool mFirstComponentCreated;
+};
+
+NS_IMPL_THREADSAFE_ISUPPORTS1(Factory, nsIFactory)
+
+class Component1 : public nsISupports
+{
+public:
+  NS_DECL_ISUPPORTS
+
+  Component1() {
+    // This is the real test - make sure that only one instance is ever created.
+    PRInt32 count = PR_AtomicIncrement(&gComponent1Count);
+    TEST_ASSERTION(count == 1, "Too many components created!");
+  }
+};
+
+NS_IMPL_THREADSAFE_ADDREF(Component1)
+NS_IMPL_THREADSAFE_RELEASE(Component1)
+
+NS_INTERFACE_MAP_BEGIN(Component1)
+  NS_INTERFACE_MAP_ENTRY(Component1)
+  NS_INTERFACE_MAP_ENTRY(nsISupports)
+NS_INTERFACE_MAP_END
+
+class Component2 : public nsISupports
+{
+public:
+  NS_DECL_ISUPPORTS
+
+  Component2() {
+    // This is the real test - make sure that only one instance is ever created.
+    PRInt32 count = PR_AtomicIncrement(&gComponent2Count);
+    TEST_ASSERTION(count == 1, "Too many components created!");
+  }
+};
+
+NS_IMPL_THREADSAFE_ADDREF(Component2)
+NS_IMPL_THREADSAFE_RELEASE(Component2)
+
+NS_INTERFACE_MAP_BEGIN(Component2)
+  NS_INTERFACE_MAP_ENTRY(Component2)
+  NS_INTERFACE_MAP_ENTRY(nsISupports)
+NS_INTERFACE_MAP_END
+
+NS_IMETHODIMP
+Factory::CreateInstance(nsISupports* aDelegate,
+                        const nsIID& aIID,
+                        void** aResult)
+{
+  // Make sure that the second thread beat the main thread to the getService
+  // call.
+  TEST_ASSERTION(!NS_IsMainThread(), "Wrong thread!");
+
+  {
+    nsAutoMonitor mon(gMonitor);
+
+    gCreateInstanceCalled = PR_TRUE;
+    mon.Notify();
+
+    mon.Wait(PR_MillisecondsToInterval(3000));
+  }
+
+  NS_ENSURE_FALSE(aDelegate, NS_ERROR_NO_AGGREGATION);
+  NS_ENSURE_ARG_POINTER(aResult);
+
+  nsCOMPtr<nsISupports> instance;
+
+  if (!mFirstComponentCreated) {
+    instance = new Component1();
+  }
+  else {
+    instance = new Component2();
+  }
+  NS_ENSURE_TRUE(instance, NS_ERROR_OUT_OF_MEMORY);
+
+  nsresult rv = instance->QueryInterface(aIID, aResult);
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  return NS_OK;
+}
+
+class Runnable : public nsRunnable
+{
+public:
+  NS_DECL_NSIRUNNABLE
+
+  Runnable() : mFirstRunnableDone(PR_FALSE) { }
+
+  PRBool mFirstRunnableDone;
+};
+
+NS_IMETHODIMP
+Runnable::Run()
+{
+  {
+    nsAutoMonitor mon(gMonitor);
+
+    while (!gMainThreadWaiting) {
+      mon.Wait();
+    }
+  }
+
+  nsresult rv;
+  nsCOMPtr<nsISupports> component;
+
+  if (!mFirstRunnableDone) {
+    component = do_GetService(kFactoryCID1, &rv);
+  }
+  else {
+    component = do_GetService(FACTORY_CONTRACTID, &rv);
+  }
+  TEST_ASSERTION(NS_SUCCEEDED(rv), "GetService failed!");
+
+  return NS_OK;
+}
+
+int main(int argc, char** argv)
+{
+  ScopedXPCOM xpcom("RacingServiceManager");
+  NS_ENSURE_FALSE(xpcom.failed(), 1);
+
+  nsCOMPtr<nsIComponentRegistrar> registrar;
+  nsresult rv = NS_GetComponentRegistrar(getter_AddRefs(registrar));
+  NS_ENSURE_SUCCESS(rv, 1);
+
+  nsRefPtr<Factory> factory = new Factory();
+  NS_ENSURE_TRUE(factory, 1);
+
+  rv = registrar->RegisterFactory(kFactoryCID1, nsnull, nsnull, factory);
+  NS_ENSURE_SUCCESS(rv, 1);
+
+  rv = registrar->RegisterFactory(kFactoryCID2, nsnull, FACTORY_CONTRACTID,
+                                  factory);
+  NS_ENSURE_SUCCESS(rv, 1);
+
+  AutoCreateAndDestroyMonitor mon(&gMonitor);
+
+  nsRefPtr<Runnable> runnable = new Runnable();
+  NS_ENSURE_TRUE(runnable, 1);
+
+  // Run the classID test
+  nsCOMPtr<nsIThread> newThread;
+  rv = NS_NewThread(getter_AddRefs(newThread), runnable);
+  NS_ENSURE_SUCCESS(rv, 1);
+
+  {
+    nsAutoMonitor mon(gMonitor);
+
+    gMainThreadWaiting = PR_TRUE;
+    mon.Notify();
+
+    while (!gCreateInstanceCalled) {
+      mon.Wait();
+    }
+  }
+
+  nsCOMPtr<nsISupports> component(do_GetService(kFactoryCID1, &rv));
+  NS_ENSURE_SUCCESS(rv, 1);
+
+  // Reset for the contractID test
+  gMainThreadWaiting = gCreateInstanceCalled = PR_FALSE;
+  factory->mFirstComponentCreated = runnable->mFirstRunnableDone = PR_TRUE;
+  component = nsnull;
+
+  rv = newThread->Dispatch(runnable, NS_DISPATCH_NORMAL);
+  NS_ENSURE_SUCCESS(rv, 1);
+
+  {
+    nsAutoMonitor mon(gMonitor);
+
+    gMainThreadWaiting = PR_TRUE;
+    mon.Notify();
+
+    while (!gCreateInstanceCalled) {
+      mon.Wait();
+    }
+  }
+
+  component = do_GetService(FACTORY_CONTRACTID, &rv);
+  NS_ENSURE_SUCCESS(rv, 1);
+
+  return 0;
+}
diff -r f3ac957eb4af xpcom/tests/windows/Makefile.in
--- a/xpcom/tests/windows/Makefile.in	Thu Sep 04 12:36:46 2008 -0400
+++ b/xpcom/tests/windows/Makefile.in	Sat Sep 06 10:14:38 2008 +0300
@@ -66,12 +66,11 @@ CPP_UNIT_TESTS	= \
 # multiple times, and then leaving them in a state where they can't be cleaned
 #			TestNTFSPermissions \
 
 include $(topsrcdir)/config/rules.mk
 
-OS_LIBS	= $(call EXPAND_LIBNAME,rpcrt4 uuid)
-OS_LIBS	+= advapi32.lib
+OS_LIBS	= $(call EXPAND_LIBNAME,rpcrt4 uuid advapi32)
 
 LIBS = \
 	$(DIST)/lib/$(LIB_PREFIX)xpcomglue_s.$(LIB_SUFFIX) \
 	$(XPCOM_LIBS) \
 	$(NSPR_LIBS) \
diff -r f3ac957eb4af xpinstall/public/nsIDOMInstallTriggerGlobal.h
--- a/xpinstall/public/nsIDOMInstallTriggerGlobal.h	Thu Sep 04 12:36:46 2008 -0400
+++ b/xpinstall/public/nsIDOMInstallTriggerGlobal.h	Sat Sep 06 10:14:38 2008 +0300
@@ -46,11 +46,11 @@
 #include "nsIXPIInstallInfo.h"
 
 
 #define NS_IDOMINSTALLTRIGGERGLOBAL_IID \
  { 0x23bb93a4, 0xdaee, 0x4a47, \
-  {0x87, 0xe76, 0xb1, 0x72, 0x35, 0x86, 0x2d, 0xac}}
+  {0x87, 0x76, 0xb1, 0x72, 0x35, 0x86, 0x2d, 0xac}}
 
 class nsIDOMInstallTriggerGlobal : public nsISupports {
 public:
   NS_DECLARE_STATIC_IID_ACCESSOR(NS_IDOMINSTALLTRIGGERGLOBAL_IID)
   enum {
