diff -r 1aecd2a9914d accessible/public/nsIAccessible.idl
--- a/accessible/public/nsIAccessible.idl	Tue Sep 16 16:40:57 2008 +1200
+++ b/accessible/public/nsIAccessible.idl	Thu Sep 18 08:03:21 2008 -0500
@@ -53,17 +53,17 @@ interface nsIAccessibleRelation;
  * Can also be used by in-process accessibility clients to get information
  * about objects in the accessible tree. The accessible tree is a subset of 
  * nodes in the DOM tree -- such as documents, focusable elements and text.
  * Mozilla creates the implementations of nsIAccessible on demand.
  * See http://www.mozilla.org/projects/ui/accessibility for more information.
  *
  * @status UNDER_REVIEW
  */
-[scriptable, uuid(004b6882-2df1-49df-bb5f-0fb81a5b1edf)]
+[scriptable, uuid(c7520419-87ec-42bc-98cc-04c0bf173530)]
 interface nsIAccessible : nsISupports
 {
   /**
    * Parent node in accessible tree.
    */
   readonly attribute nsIAccessible parent;
 
   /**
@@ -194,18 +194,34 @@ interface nsIAccessible : nsISupports
                      out long aPositionInGroup);
 
   /**
    * Accessible child which contains the coordinate at (x, y) in screen pixels.
    * If the point is in the current accessible but not in a child, the
    * current accessible will be returned.
    * If the point is in neither the current accessible or a child, then
    * null will be returned.
+   *
+   * @param x  screen's x coordinate
+   * @param y  screen's y coordinate
+   * @return   the deepest accessible child containing the given point
    */
   nsIAccessible getChildAtPoint(in long x, in long y);
+
+  /**
+   * Deepest accessible child which contains the coordinate at (x, y) in screen
+   * pixels. If the point is in the current accessible but not in a child, the
+   * current accessible will be returned. If the point is in neither the current
+   * accessible or a child, then null will be returned.
+   *
+   * @param x  screen's x coordinate
+   * @param y  screen's y coordinate
+   * @return   the deepest accessible child containing the given point
+   */
+  nsIAccessible getDeepestChildAtPoint(in long x, in long y);
 
   /**
    * Nth accessible child using zero-based index or last child if index less than zero
    */
   nsIAccessible getChildAt(in long aChildIndex);
 
   /**
    * Accessible node geometrically to the right of this one
diff -r 1aecd2a9914d accessible/src/base/nsAccessNode.cpp
--- a/accessible/src/base/nsAccessNode.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/accessible/src/base/nsAccessNode.cpp	Thu Sep 18 08:03:21 2008 -0500
@@ -603,76 +603,76 @@ nsAccessNode::GetChildNodeAt(PRInt32 aCh
 
   nsCOMPtr<nsIDOMNode> domNode =
     do_QueryInterface(content->GetChildAt(aChildNum));
 
   return domNode ? MakeAccessNode(domNode, aAccessNode) : NS_OK;
 }
 
 NS_IMETHODIMP
-nsAccessNode::GetComputedStyleValue(const nsAString& aPseudoElt, const nsAString& aPropertyName, nsAString& aValue)
+nsAccessNode::GetComputedStyleValue(const nsAString& aPseudoElt,
+                                    const nsAString& aPropertyName,
+                                    nsAString& aValue)
 {
-  nsCOMPtr<nsIDOMElement> domElement(do_QueryInterface(mDOMNode));
-  if (!domElement) {
+  if (IsDefunct())
     return NS_ERROR_FAILURE;
-  }
+
   nsCOMPtr<nsIDOMCSSStyleDeclaration> styleDecl;
-  GetComputedStyleDeclaration(aPseudoElt, domElement, getter_AddRefs(styleDecl));
+  GetComputedStyleDeclaration(aPseudoElt, mDOMNode, getter_AddRefs(styleDecl));
   NS_ENSURE_TRUE(styleDecl, NS_ERROR_FAILURE);
-  
+
   return styleDecl->GetPropertyValue(aPropertyName, aValue);
 }
 
 NS_IMETHODIMP
 nsAccessNode::GetComputedStyleCSSValue(const nsAString& aPseudoElt,
                                        const nsAString& aPropertyName,
                                        nsIDOMCSSPrimitiveValue **aCSSValue)
 {
   NS_ENSURE_ARG_POINTER(aCSSValue);
-
   *aCSSValue = nsnull;
 
-  nsCOMPtr<nsIDOMElement> domElement(do_QueryInterface(mDOMNode));
-  if (!domElement)
+  if (IsDefunct())
     return NS_ERROR_FAILURE;
 
   nsCOMPtr<nsIDOMCSSStyleDeclaration> styleDecl;
-  GetComputedStyleDeclaration(aPseudoElt, domElement,
+  GetComputedStyleDeclaration(aPseudoElt, mDOMNode,
                               getter_AddRefs(styleDecl));
   NS_ENSURE_STATE(styleDecl);
 
   nsCOMPtr<nsIDOMCSSValue> cssValue;
   styleDecl->GetPropertyCSSValue(aPropertyName, getter_AddRefs(cssValue));
   NS_ENSURE_TRUE(cssValue, NS_ERROR_FAILURE);
 
   return CallQueryInterface(cssValue, aCSSValue);
 }
 
-void nsAccessNode::GetComputedStyleDeclaration(const nsAString& aPseudoElt,
-                                               nsIDOMElement *aElement,
-                                               nsIDOMCSSStyleDeclaration **aCssDecl)
+void
+nsAccessNode::GetComputedStyleDeclaration(const nsAString& aPseudoElt,
+                                          nsIDOMNode *aNode,
+                                          nsIDOMCSSStyleDeclaration **aCssDecl)
 {
   *aCssDecl = nsnull;
+
+  nsCOMPtr<nsIDOMElement> domElement = nsAccUtils::GetDOMElementFor(aNode);
+  if (!domElement)
+    return;
+
   // Returns number of items in style declaration
-  nsCOMPtr<nsIContent> content = do_QueryInterface(aElement);
-  if (!content) {
+  nsCOMPtr<nsIContent> content = do_QueryInterface(domElement);
+  nsCOMPtr<nsIDocument> doc = content->GetDocument();
+  if (!doc)
     return;
-  }
-  nsCOMPtr<nsIDocument> doc = content->GetDocument();
-  if (!doc) {
-    return;
-  }
 
   nsCOMPtr<nsIDOMViewCSS> viewCSS(do_QueryInterface(doc->GetWindow()));
-  if (!viewCSS) {
+  if (!viewCSS)
     return;
-  }
 
   nsCOMPtr<nsIDOMCSSStyleDeclaration> cssDecl;
-  viewCSS->GetComputedStyle(aElement, aPseudoElt, getter_AddRefs(cssDecl));
+  viewCSS->GetComputedStyle(domElement, aPseudoElt, getter_AddRefs(cssDecl));
   NS_IF_ADDREF(*aCssDecl = cssDecl);
 }
 
 /***************** Hashtable of nsIAccessNode's *****************/
 
 already_AddRefed<nsIAccessibleDocument>
 nsAccessNode::GetDocAccessibleFor(nsIDocument *aDocument)
 {
diff -r 1aecd2a9914d accessible/src/base/nsAccessNode.h
--- a/accessible/src/base/nsAccessNode.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/accessible/src/base/nsAccessNode.h	Thu Sep 18 08:03:21 2008 -0500
@@ -109,17 +109,17 @@ class nsAccessNode: public nsIAccessNode
     static already_AddRefed<nsIAccessibleDocument> GetDocAccessibleFor(nsIWeakReference *aWeakShell);
     static already_AddRefed<nsIAccessibleDocument> GetDocAccessibleFor(nsIDocShellTreeItem *aContainer, PRBool aCanCreate = PR_FALSE);
     static already_AddRefed<nsIAccessibleDocument> GetDocAccessibleFor(nsIDOMNode *aNode);
 
     static already_AddRefed<nsIDOMNode> GetDOMNodeForContainer(nsISupports *aContainer);
     static already_AddRefed<nsIPresShell> GetPresShellFor(nsIDOMNode *aStartNode);
     
     static void GetComputedStyleDeclaration(const nsAString& aPseudoElt,
-                                            nsIDOMElement *aElement,
+                                            nsIDOMNode *aNode,
                                             nsIDOMCSSStyleDeclaration **aCssDecl);
 
     already_AddRefed<nsRootAccessible> GetRootAccessible();
 
     static nsIDOMNode *gLastFocusedNode;
     static nsIAccessibilityService* GetAccService();
     already_AddRefed<nsIDOMNode> GetCurrentFocus();
 
diff -r 1aecd2a9914d accessible/src/base/nsAccessible.cpp
--- a/accessible/src/base/nsAccessible.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/accessible/src/base/nsAccessible.cpp	Thu Sep 18 08:03:21 2008 -0500
@@ -1099,20 +1099,20 @@ NS_IMETHODIMP nsAccessible::GetFocusedCh
       }
     }
   }
 
   NS_IF_ADDREF(*aFocusedChild = focusedChild);
   return NS_OK;
 }
 
-  /* nsIAccessible getChildAtPoint (in long x, in long y); */
+// nsIAccessible getDeepestChildAtPoint(in long x, in long y)
 NS_IMETHODIMP
-nsAccessible::GetChildAtPoint(PRInt32 aX, PRInt32 aY,
-                              nsIAccessible **aAccessible)
+nsAccessible::GetDeepestChildAtPoint(PRInt32 aX, PRInt32 aY,
+                                     nsIAccessible **aAccessible)
 {
   NS_ENSURE_ARG_POINTER(aAccessible);
   *aAccessible = nsnull;
 
   if (!mDOMNode) {
     return NS_ERROR_FAILURE;  // Already shut down
   }
 
@@ -1200,36 +1200,59 @@ nsAccessible::GetChildAtPoint(PRInt32 aX
         // Don't walk into offscreen or invisible items
         NS_IF_ADDREF(*aAccessible = child);
         return NS_OK;
       }
     }
     // Fall through -- the point is in this accessible but not in a child
     // We are allowed to return |this| as the answer
   }
-  else {
-    nsCOMPtr<nsIAccessible> parent;
-    while (PR_TRUE) {
-      accessible->GetParent(getter_AddRefs(parent));
-      if (!parent) {
-        // Reached the top of the hierarchy
-        // these bounds were inside an accessible that is not a descendant of this one
-        NS_IF_ADDREF(*aAccessible = fallbackAnswer);
-        return NS_OK;
-      }
-      if (parent == this) {
-        // We reached |this|, so |accessible| is the
-        // child we want to return
-        break;
-      }
-      accessible.swap(parent);
+
+  NS_IF_ADDREF(*aAccessible = accessible);
+  return NS_OK;
+}
+
+// nsIAccessible getChildAtPoint(in long x, in long y)
+NS_IMETHODIMP
+nsAccessible::GetChildAtPoint(PRInt32 aX, PRInt32 aY,
+                              nsIAccessible **aAccessible)
+{
+  nsresult rv = GetDeepestChildAtPoint(aX, aY, aAccessible);
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  if (!*aAccessible)
+    return NS_OK;
+
+  nsCOMPtr<nsIAccessible> parent, accessible(*aAccessible);
+  while (PR_TRUE) {
+    accessible->GetParent(getter_AddRefs(parent));
+    if (!parent) {
+      NS_ASSERTION(PR_FALSE,
+                   "Obtained accessible isn't a child of this accessible.");
+      // Reached the top of the hierarchy. These bounds were inside an
+      // accessible that is not a descendant of this one.
+
+      // If we can't find the point in a child, we will return the fallback
+      // answer: we return |this| if the point is within it, otherwise nsnull.
+      PRInt32 x, y, width, height;
+      GetBounds(&x, &y, &width, &height);
+      if (aX >= x && aX < x + width && aY >= y && aY < y + height)
+        NS_ADDREF(*aAccessible = this);
+
+      return NS_OK;
     }
+
+    if (parent == this) {
+      // We reached |this|, so |accessible| is the child we want to return.
+      NS_ADDREF(*aAccessible = accessible);
+      return NS_OK;
+    }
+    accessible.swap(parent);
   }
 
-  NS_IF_ADDREF(*aAccessible = accessible);
   return NS_OK;
 }
 
 void nsAccessible::GetBoundsRect(nsRect& aTotalBounds, nsIFrame** aBoundingFrame)
 {
 /*
  * This method is used to determine the bounds of a content node.
  * Because HTML wraps and links are not always rectangular, this
diff -r 1aecd2a9914d accessible/src/base/nsCaretAccessible.cpp
--- a/accessible/src/base/nsCaretAccessible.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/accessible/src/base/nsCaretAccessible.cpp	Thu Sep 18 08:03:22 2008 -0500
@@ -242,18 +242,27 @@ nsCaretAccessible::NormalSelectionChange
     return NS_OK;
   }
   PRUint32 docState;
   accessibleForDoc->GetFinalState(&docState, nsnull);
   if (docState & nsIAccessibleStates::STATE_BUSY) {
     return NS_OK;  // Don't fire caret moves until doc loaded
   }
 
-  nsCOMPtr<nsIDOMNode> nodeWithCaret = focusNode;
+  // Get focused node.
+  nsCOMPtr<nsIContent> focusContainer(do_QueryInterface(focusNode));
+  if (focusContainer && focusContainer->IsNodeOfType(nsINode::eELEMENT)) {
+    PRInt32 focusOffset = 0;
+    aSel->GetFocusOffset(&focusOffset);
 
+    nsCOMPtr<nsIContent> focusContent = focusContainer->GetChildAt(focusOffset);
+    focusNode = do_QueryInterface(focusContent);
+  }
+
+  // Get relevant accessible for the focused node.
   nsCOMPtr<nsIAccessibleText> textAcc;
   while (focusNode) {
     // Make sure to get the correct starting node for selection events inside XBL content trees
     nsCOMPtr<nsIDOMNode> relevantNode;
     if (NS_SUCCEEDED(accService->GetRelevantContentNodeFor(focusNode, getter_AddRefs(relevantNode))) && relevantNode) {
       focusNode  = relevantNode;
     }
 
@@ -301,16 +310,26 @@ nsCaretAccessible::SpellcheckSelectionCh
   // spellchecking is enabled then we will fire the number of events for
   // the same accessible for newly appended range of the selection (for every
   // misspelled word). If spellchecking is disabled (for example,
   // @spellcheck="false" on html:body) then we won't fire any event.
   nsCOMPtr<nsIDOMNode> targetNode;
   aSel->GetFocusNode(getter_AddRefs(targetNode));
   if (!targetNode)
     return NS_OK;
+
+  // Get focused node.
+  nsCOMPtr<nsIContent> focusContainer(do_QueryInterface(targetNode));
+  if (focusContainer && focusContainer->IsNodeOfType(nsINode::eELEMENT)) {
+    PRInt32 focusOffset = 0;
+    aSel->GetFocusOffset(&focusOffset);
+    
+    nsCOMPtr<nsIContent> focusContent = focusContainer->GetChildAt(focusOffset);
+    targetNode = do_QueryInterface(focusContent);
+  }
 
   nsCOMPtr<nsIAccessibleDocument> docAccessible =
     nsAccessNode::GetDocAccessibleFor(targetNode);
   NS_ENSURE_STATE(docAccessible);
 
   nsCOMPtr<nsIAccessible> containerAccessible;
   nsresult rv =
     docAccessible->GetAccessibleInParentChain(targetNode, PR_TRUE,
diff -r 1aecd2a9914d accessible/src/base/nsOuterDocAccessible.cpp
--- a/accessible/src/base/nsOuterDocAccessible.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/accessible/src/base/nsOuterDocAccessible.cpp	Thu Sep 18 08:03:22 2008 -0500
@@ -62,32 +62,50 @@ NS_IMETHODIMP
 NS_IMETHODIMP
 nsOuterDocAccessible::GetState(PRUint32 *aState, PRUint32 *aExtraState)
 {
   nsAccessible::GetState(aState, aExtraState);
   *aState &= ~nsIAccessibleStates::STATE_FOCUSABLE;
   return NS_OK;
 }
 
+// nsIAccessible::getChildAtPoint(in long x, in long y)
 NS_IMETHODIMP
 nsOuterDocAccessible::GetChildAtPoint(PRInt32 aX, PRInt32 aY,
                                       nsIAccessible **aAccessible)
 {
   NS_ENSURE_ARG_POINTER(aAccessible);
   *aAccessible = nsnull;
   if (!mDOMNode) {
     return NS_ERROR_FAILURE;
   }
   PRInt32 docX, docY, docWidth, docHeight;
   GetBounds(&docX, &docY, &docWidth, &docHeight);
   if (aX < docX || aX >= docX + docWidth || aY < docY || aY >= docY + docHeight) {
     return NS_ERROR_FAILURE;
   }
 
   return GetFirstChild(aAccessible);  // Always return the inner doc unless bounds outside of it
+}
+
+// nsIAccessible::getDeepestChildAtPoint(in long x, in long y)
+NS_IMETHODIMP
+nsOuterDocAccessible::GetDeepestChildAtPoint(PRInt32 aX, PRInt32 aY,
+                                      nsIAccessible **aAccessible)
+{
+  // Call getDeepestChildAtPoint on the fist child accessible of the outer
+  // document accessible if the given point is inside of outer document.
+  nsCOMPtr<nsIAccessible> childAcc;
+  nsresult rv = GetChildAtPoint(aX, aY, getter_AddRefs(childAcc));
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  if (!childAcc)
+    return NS_OK;
+
+  return childAcc->GetDeepestChildAtPoint(aX, aY, aAccessible);
 }
 
 void nsOuterDocAccessible::CacheChildren()
 {  
   // An outer doc accessible usually has 1 nsDocAccessible child,
   // but could have none if we can't get to the inner documnet
   if (!mWeakShell) {
     mAccChildCount = eChildCountUninitialized;
diff -r 1aecd2a9914d accessible/src/base/nsOuterDocAccessible.h
--- a/accessible/src/base/nsOuterDocAccessible.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/accessible/src/base/nsOuterDocAccessible.h	Thu Sep 18 08:03:22 2008 -0500
@@ -49,18 +49,22 @@ class nsOuterDocAccessible : public nsAc
   NS_DECL_ISUPPORTS_INHERITED
 
   public:
     nsOuterDocAccessible(nsIDOMNode* aNode, 
                          nsIWeakReference* aShell);
 
     NS_IMETHOD GetRole(PRUint32 *aRole);
     NS_IMETHOD GetState(PRUint32 *aState, PRUint32 *aExtraState);
+
     NS_IMETHOD GetChildAtPoint(PRInt32 aX, PRInt32 aY,
                                nsIAccessible **aAccessible);
+    NS_IMETHOD GetDeepestChildAtPoint(PRInt32 aX, PRInt32 aY,
+                                      nsIAccessible **aAccessible);
+
     void CacheChildren();
     nsresult GetAttributesInternal(nsIPersistentProperties *aAttributes);
     NS_IMETHOD GetNumActions(PRUint8 *aNumActions);
     NS_IMETHOD GetActionName(PRUint8 aIndex, nsAString& aName);
     NS_IMETHODIMP GetActionDescription(PRUint8 aIndex, nsAString& aDescription);
     NS_IMETHOD DoAction(PRUint8 aIndex);
 };
 
diff -r 1aecd2a9914d accessible/src/html/nsHTMLTableAccessible.cpp
--- a/accessible/src/html/nsHTMLTableAccessible.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/accessible/src/html/nsHTMLTableAccessible.cpp	Thu Sep 18 08:03:22 2008 -0500
@@ -1133,20 +1133,22 @@ NS_IMETHODIMP nsHTMLTableAccessible::IsP
   tableElt->GetElementsByTagName(NS_LITERAL_STRING("tr"), getter_AddRefs(nodeList));
   NS_ENSURE_TRUE(nodeList, NS_ERROR_FAILURE);
   PRUint32 length;
   nodeList->GetLength(&length);
   nsAutoString color, lastRowColor;
   for (PRInt32 rowCount = 0; rowCount < rows; rowCount ++) {
     nsCOMPtr<nsIDOMNode> rowNode;
     nodeList->Item(rowCount, getter_AddRefs(rowNode));
-    nsCOMPtr<nsIDOMElement> rowElement = do_QueryInterface(rowNode);
+
     nsCOMPtr<nsIDOMCSSStyleDeclaration> styleDecl;
-    GetComputedStyleDeclaration(EmptyString(), rowElement, getter_AddRefs(styleDecl));
+    GetComputedStyleDeclaration(EmptyString(), rowNode,
+                                getter_AddRefs(styleDecl));
     NS_ENSURE_TRUE(styleDecl, NS_ERROR_FAILURE);
+
     lastRowColor = color;
     styleDecl->GetPropertyValue(NS_LITERAL_STRING("background-color"), color);
     if (rowCount > 0 && PR_FALSE == lastRowColor.Equals(color)) {
       RETURN_LAYOUT_ANSWER(PR_FALSE, "2 styles of row background color, non-bordered");
     }
   }
 
   // Check for many rows
diff -r 1aecd2a9914d accessible/src/mac/mozAccessible.mm
--- a/accessible/src/mac/mozAccessible.mm	Tue Sep 16 16:40:57 2008 +1200
+++ b/accessible/src/mac/mozAccessible.mm	Thu Sep 18 08:03:22 2008 -0500
@@ -288,32 +288,27 @@ GetNativeFromGeckoAccessible(nsIAccessib
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
 - (id)accessibilityHitTest:(NSPoint)point
 {
   if (mIsExpired)
     return nil;
-  
+
   // Convert from cocoa's coordinate system to gecko's. According to the docs
   // the point we're given is guaranteed to be bottom-left screen coordinates.
   nsPoint geckoPoint;
   ConvertCocoaToGeckoPoint (point, geckoPoint);
 
-  // start iterating as deep down as we can on this point, with the current accessible as the root.
-  // as soon as GetChildAtPoint() returns null, or can't descend further (without getting the same accessible again)
-  // we stop.
-  nsCOMPtr<nsIAccessible> deepestFoundChild, newChild(mGeckoAccessible);
-  do {
-    deepestFoundChild = newChild;
-    deepestFoundChild->GetChildAtPoint((PRInt32)geckoPoint.x, (PRInt32)geckoPoint.y, getter_AddRefs(newChild));
-  } while (newChild && newChild.get() != deepestFoundChild.get());
+  nsCOMPtr<nsIAccessible> deepestFoundChild;
+  mGeckoAccessible->GetDeepestChildAtPoint((PRInt32)geckoPoint.x,
+                                           (PRInt32)geckoPoint.y,
+                                           getter_AddRefs(deepestFoundChild));
   
-
   // if we found something, return its native accessible.
   if (deepestFoundChild) {
     mozAccessible *nativeChild = GetNativeFromGeckoAccessible(deepestFoundChild);
     if (nativeChild)
       return GetClosestInterestingAccessible(nativeChild);
   }
   
   // if we didn't find anything, return ourself (or the first unignored ancestor).
diff -r 1aecd2a9914d accessible/src/msaa/nsAccessNodeWrap.cpp
--- a/accessible/src/msaa/nsAccessNodeWrap.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/accessible/src/msaa/nsAccessNodeWrap.cpp	Thu Sep 18 08:03:22 2008 -0500
@@ -305,23 +305,23 @@ STDMETHODIMP nsAccessNodeWrap::get_compu
 STDMETHODIMP nsAccessNodeWrap::get_computedStyle( 
     /* [in] */ unsigned short aMaxStyleProperties,
     /* [in] */ boolean aUseAlternateView,
     /* [length_is][size_is][out] */ BSTR __RPC_FAR *aStyleProperties,
     /* [length_is][size_is][out] */ BSTR __RPC_FAR *aStyleValues,
     /* [out] */ unsigned short __RPC_FAR *aNumStyleProperties)
 {
 __try{
-  nsCOMPtr<nsIDOMElement> domElement(do_QueryInterface(mDOMNode));
-  if (!domElement)
+  *aNumStyleProperties = 0;
+
+  if (IsDefunct())
     return E_FAIL;
-  
-  *aNumStyleProperties = 0;
+
   nsCOMPtr<nsIDOMCSSStyleDeclaration> cssDecl;
-  GetComputedStyleDeclaration(EmptyString(), domElement, getter_AddRefs(cssDecl));
+  GetComputedStyleDeclaration(EmptyString(), mDOMNode, getter_AddRefs(cssDecl));
   NS_ENSURE_TRUE(cssDecl, E_FAIL);
 
   PRUint32 length;
   cssDecl->GetLength(&length);
 
   PRUint32 index, realIndex;
   for (index = realIndex = 0; index < length && realIndex < aMaxStyleProperties; index ++) {
     nsAutoString property, value;
@@ -342,22 +342,21 @@ __try{
 
 STDMETHODIMP nsAccessNodeWrap::get_computedStyleForProperties( 
     /* [in] */ unsigned short aNumStyleProperties,
     /* [in] */ boolean aUseAlternateView,
     /* [length_is][size_is][in] */ BSTR __RPC_FAR *aStyleProperties,
     /* [length_is][size_is][out] */ BSTR __RPC_FAR *aStyleValues)
 {
 __try {
-  nsCOMPtr<nsIDOMElement> domElement(do_QueryInterface(mDOMNode));
-  if (!domElement)
+  if (IsDefunct())
     return E_FAIL;
  
   nsCOMPtr<nsIDOMCSSStyleDeclaration> cssDecl;
-  GetComputedStyleDeclaration(EmptyString(), domElement, getter_AddRefs(cssDecl));
+  GetComputedStyleDeclaration(EmptyString(), mDOMNode, getter_AddRefs(cssDecl));
   NS_ENSURE_TRUE(cssDecl, E_FAIL);
 
   PRUint32 index;
   for (index = 0; index < aNumStyleProperties; index ++) {
     nsAutoString value;
     if (aStyleProperties[index])
       cssDecl->GetPropertyValue(nsDependentString(static_cast<PRUnichar*>(aStyleProperties[index])), value);  // Get property value
     aStyleValues[index] = ::SysAllocString(value.get());
diff -r 1aecd2a9914d accessible/src/xul/nsXULTreeAccessible.cpp
--- a/accessible/src/xul/nsXULTreeAccessible.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/accessible/src/xul/nsXULTreeAccessible.cpp	Thu Sep 18 08:03:22 2008 -0500
@@ -348,16 +348,25 @@ nsXULTreeAccessible::GetChildAtPoint(PRI
                    childEltUnused);
 
   // If we failed to find tree cell for the given point then it might be
   // tree columns.
   if (row == -1 || !column)
     return nsXULSelectableAccessible::GetChildAtPoint(aX, aY, aAccessible);
 
   return GetCachedTreeitemAccessible(row, column, aAccessible);
+}
+
+// nsIAccessible::getDeepestChildAtPoint(in long x, in long y)
+NS_IMETHODIMP
+nsXULTreeAccessible::GetDeepestChildAtPoint(PRInt32 aX, PRInt32 aY,
+                                            nsIAccessible **aAccessible)
+{
+  // Call getChildAtPoint until tree doesn't support complex content.
+  return GetChildAtPoint(aX, aY, aAccessible);
 }
 
 // Ask treeselection to get all selected children
 NS_IMETHODIMP nsXULTreeAccessible::GetSelectedChildren(nsIArray **_retval)
 {
   *_retval = nsnull;
 
   NS_ENSURE_TRUE(mTree && mTreeView, NS_ERROR_FAILURE);
diff -r 1aecd2a9914d accessible/src/xul/nsXULTreeAccessible.h
--- a/accessible/src/xul/nsXULTreeAccessible.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/accessible/src/xul/nsXULTreeAccessible.h	Thu Sep 18 08:03:22 2008 -0500
@@ -66,18 +66,21 @@ public:
   NS_IMETHOD GetRole(PRUint32 *_retval);
   NS_IMETHOD GetState(PRUint32 *aState, PRUint32 *aExtraState);
   NS_IMETHOD GetValue(nsAString& _retval);
 
   NS_IMETHOD GetFirstChild(nsIAccessible **_retval);
   NS_IMETHOD GetLastChild(nsIAccessible **_retval);
   NS_IMETHOD GetChildCount(PRInt32 *_retval);
   NS_IMETHOD GetFocusedChild(nsIAccessible **aFocusedChild);
+
   NS_IMETHOD GetChildAtPoint(PRInt32 aX, PRInt32 aY,
                              nsIAccessible **aAccessible);
+  NS_IMETHOD GetDeepestChildAtPoint(PRInt32 aX, PRInt32 aY,
+                                    nsIAccessible **aAccessible);
 
   static void GetTreeBoxObject(nsIDOMNode* aDOMNode, nsITreeBoxObject** aBoxObject);
   static nsresult GetColumnCount(nsITreeBoxObject* aBoxObject, PRInt32 *aCount);
 
   static PRBool IsColumnHidden(nsITreeColumn *aColumn);
   static already_AddRefed<nsITreeColumn> GetNextVisibleColumn(nsITreeColumn *aColumn);
   static already_AddRefed<nsITreeColumn> GetFirstVisibleColumn(nsITreeBoxObject *aTree);
   static already_AddRefed<nsITreeColumn> GetLastVisibleColumn(nsITreeBoxObject *aTree);
diff -r 1aecd2a9914d accessible/tests/mochitest/Makefile.in
--- a/accessible/tests/mochitest/Makefile.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/accessible/tests/mochitest/Makefile.in	Thu Sep 18 08:03:22 2008 -0500
@@ -54,16 +54,17 @@ _TEST_FILES =\
 		nsIAccessible_name.js \
 		nsIAccessible_name.xbl \
 		nsIAccessibleEditableText.js \
 		test_aria_activedescendant.html \
 		test_aria_role_article.html \
 		test_bug368835.xul \
 		test_bug420863.html \
 		test_cssattrs.html \
+		test_events_caretmove.html \
 		test_groupattrs.xul \
 	$(warning test_table_indexes.html temporarily disabled) \
 		test_nsIAccessible_actions.html \
 		test_nsIAccessible_actions.xul \
 		test_nsIAccessible_name.html \
 		test_nsIAccessible_name.xul \
 		test_nsIAccessible_focus.html \
 		test_nsIAccessibleDocument.html \
@@ -72,16 +73,17 @@ _TEST_FILES =\
 		test_nsIAccessibleHyperLink.xul \
 		test_nsIAccessibleHyperText.html \
 		test_nsIAccessibleImage.html \
 		test_nsIAccessibleTable_1.html \
 		test_nsIAccessibleTable_2.html \
 		test_nsIAccessibleTable_3.html \
 		test_nsIAccessibleTable_4.html \
 		test_nsIAccessibleTable_listboxes.xul \
+		test_nsIAccessNode_utils.html \
 		test_nsOuterDocAccessible.html \
 		test_textattrs.html \
 		test_textboxes.html \
 		test_textboxes.xul \
 		testTextboxes.js \
 		test_bug428479.html \
 		test_bug429285.html \
 		test_bug434464.html \
diff -r 1aecd2a9914d accessible/tests/mochitest/common.js
--- a/accessible/tests/mochitest/common.js	Tue Sep 16 16:40:57 2008 +1200
+++ b/accessible/tests/mochitest/common.js	Thu Sep 18 08:03:22 2008 -0500
@@ -72,26 +72,26 @@ function getAccessible(aAccOrElmOrID, aI
     aElmObj.value = elm;
 
   var acc = (aAccOrElmOrID instanceof nsIAccessible) ? aAccOrElmOrID : null;
   if (!acc) {
     try {
       acc = gAccRetrieval.getAccessibleFor(elm);
     } catch (e) {
     }
-    
+
     if (!acc) {
-      ok(false, "Can't get accessible for " + aID);
+      ok(false, "Can't get accessible for " + aAccOrElmOrID);
       return null;
     }
   }
-  
+
   if (!aInterfaces)
     return acc;
-  
+
   if (aInterfaces instanceof Array) {
     for (var index = 0; index < aInterfaces.length; index++) {
       try {
         acc.QueryInterface(aInterfaces[index]);
       } catch (e) {
         ok(false, "Can't query " + aInterfaces[index] + " for " + aID);
         return null;
       }
diff -r 1aecd2a9914d accessible/tests/mochitest/testTextboxes.js
--- a/accessible/tests/mochitest/testTextboxes.js	Tue Sep 16 16:40:57 2008 +1200
+++ b/accessible/tests/mochitest/testTextboxes.js	Thu Sep 18 08:03:22 2008 -0500
@@ -1,33 +1,21 @@ const nsIAccessibleRetrieval = Component
-const nsIAccessibleRetrieval = Components.interfaces.nsIAccessibleRetrieval;
+// Mapping needed state flags for easier handling.
+const state_focusable = nsIAccessibleStates.STATE_FOCUSABLE;
+const state_focused = nsIAccessibleStates.STATE_FOCUSED;
+const state_readonly = nsIAccessibleStates.STATE_READONLY;
 
-// Mapping needed state flags for easier handling.
-const state_focusable = 
-      Components.interfaces.nsIAccessibleStates.STATE_FOCUSABLE;
-const state_focused = 
-      Components.interfaces.nsIAccessibleStates.STATE_FOCUSED;
-const state_readonly = 
-      Components.interfaces.nsIAccessibleStates.STATE_READONLY;
-
-const ext_state_multi_line = 
-      Components.interfaces.nsIAccessibleStates.EXT_STATE_MULTI_LINE;
-const ext_state_editable = 
-      Components.interfaces.nsIAccessibleStates.EXT_STATE_EDITABLE;
-const ext_state_required = 
-      Components.interfaces.nsIAccessibleStates.STATE_REQUIRED;
-const ext_state_invalid = 
-      Components.interfaces.nsIAccessibleStates.STATE_INVALID;
+const ext_state_multi_line = nsIAccessibleStates.EXT_STATE_MULTI_LINE;
+const ext_state_editable = nsIAccessibleStates.EXT_STATE_EDITABLE;
+const ext_state_required = nsIAccessibleStates.STATE_REQUIRED;
+const ext_state_invalid = nsIAccessibleStates.STATE_INVALID;
 
 // Mapping needed final roles
-const role_entry = Components.interfaces.nsIAccessibleRole.ROLE_ENTRY;
-const role_password_text =
-      Components.interfaces.nsIAccessibleRole.ROLE_PASSWORD_TEXT;
-
-var gAccRetrieval = null;
+const role_entry = nsIAccessibleRole.ROLE_ENTRY;
+const role_password_text = nsIAccessibleRole.ROLE_PASSWORD_TEXT;
 
 function testValue(aID, aAcc, aValue, aRole)
 {
   if (aRole == role_password_text) {
     var value;
     try {
       value = aAcc.value;
       do_throw("We do not want a value on " + aID + "!");
diff -r 1aecd2a9914d accessible/tests/mochitest/test_events_caretmove.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/accessible/tests/mochitest/test_events_caretmove.html	Thu Sep 18 08:03:22 2008 -0500
@@ -0,0 +1,130 @@
+<html>
+
+<head>
+  <title>Accessible caret move events testing</title>
+
+  <link rel="stylesheet" type="text/css"
+        href="chrome://mochikit/content/tests/SimpleTest/test.css" />
+
+  <script type="application/javascript"
+          src="chrome://mochikit/content/MochiKit/packed.js"></script>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/tests/SimpleTest/EventUtils.js"></script>
+
+  <script type="application/javascript"
+          src="chrome://mochikit/content/a11y/accessible/common.js"></script>
+
+  <script type="application/javascript">
+    function synthMouseTest(aNode)
+    {
+      this.node = aNode;
+      this.testFunc = function testFunc()
+      {
+        synthesizeMouse(this.node, 1, 1, {});
+      }
+    }
+
+    function synthKeyTest(aNode, aKey)
+    {
+      this.node = aNode;
+      this.testFunc = function testFunc()
+      {
+        synthesizeKey(aKey, {});
+      }
+    }
+
+    function synthTabTest(aNode, aBackTab)
+    {
+      this.node = aNode;
+      this.testFunc = function testFunc()
+      {
+        synthesizeKey("VK_TAB", {shiftKey: aBackTab});
+      }
+    }
+
+    var gTestsArray = [];
+    var gTestIdx = -1;
+
+    var gCaretMoveHandler =
+    {
+      handleEvent: function handleEvent(aEvent)
+      {
+        if (aEvent.DOMNode == gTestsArray[gTestIdx].node)
+          gTestsArray[gTestIdx].wasCaught = true;
+      }
+    };
+
+    function doTest()
+    {
+      window.setTimeout(
+        function()
+        {
+          if (gTestIdx == gTestsArray.length - 1) {
+          
+            unregisterA11yEventListener(nsIAccessibleEvent.EVENT_TEXT_CARET_MOVED,
+                                        gCaretMoveHandler);
+
+            for (var idx = 0; idx < gTestsArray.length; idx++)
+              ok(gTestsArray[idx].wasCaught, "test " + idx + " failed");
+
+            SimpleTest.finish();
+            return;
+          }
+
+          gTestsArray[++gTestIdx].testFunc();
+          doTest();
+        },
+        100
+      );
+    }
+
+    function doTests()
+    {
+      var textbox = document.getElementById("textbox");
+      gTestsArray.push(new synthMouseTest(textbox));
+      gTestsArray.push(new synthKeyTest(textbox, "VK_RIGHT"));
+
+      var textarea = document.getElementById("textarea");
+      gTestsArray.push(new synthMouseTest(textarea));
+      gTestsArray.push(new synthKeyTest(textarea, "VK_RIGHT"));
+      gTestsArray.push(new synthKeyTest(textarea, "VK_DOWN"));
+
+      var p = document.getElementById("p");
+      gTestsArray.push(new synthMouseTest(p));
+      gTestsArray.push(new synthKeyTest(p, "VK_RIGHT"));
+      gTestsArray.push(new synthKeyTest(p, "VK_DOWN"));
+
+      gTestsArray.push(new synthTabTest(textarea, true));
+      gTestsArray.push(new synthTabTest(p));
+
+      registerA11yEventListener(nsIAccessibleEvent.EVENT_TEXT_CARET_MOVED,
+                                gCaretMoveHandler);
+
+      doTest();
+    }
+
+    SimpleTest.waitForExplicitFinish();
+    addLoadEvent(doTests);
+  </script>
+</head>
+
+<body>
+
+  <a target="_blank"
+     href="https://bugzilla.mozilla.org/show_bug.cgi?id=454377"
+     title="Accessible caret move events testing">
+    Mozilla Bug 454377
+  </a>
+  <p id="display"></p>
+  <div id="content" style="display: none"></div>
+  <pre id="test">
+  </pre>
+
+  <input id="textbox" value="hello"/>
+  <textarea id="textarea">text<br>text</textarea>
+  <p id="p" contentEditable="true"><span>text</span><br/>text</p>
+
+</body>
+</html>
diff -r 1aecd2a9914d accessible/tests/mochitest/test_nsIAccessNode_utils.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/accessible/tests/mochitest/test_nsIAccessNode_utils.html	Thu Sep 18 08:03:22 2008 -0500
@@ -0,0 +1,55 @@
+<html>
+
+<head>
+  <title>nsIAccessNode util methods testing</title>
+
+  <link rel="stylesheet" type="text/css"
+        href="chrome://mochikit/content/tests/SimpleTest/test.css" />
+
+  <script type="application/javascript"
+          src="chrome://mochikit/content/MochiKit/packed.js"></script>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/a11y/accessible/common.js"></script>
+
+  <script type="application/javascript">
+    function doTest()
+    {
+      var elmObj = {};
+      var acc = getAccessible("span", [nsIAccessNode], elmObj);
+      computedStyle = document.defaultView.getComputedStyle(elmObj.value, "");
+
+      // html:span element
+      is(acc.getComputedStyleValue("", "color"), computedStyle.color,
+         "Wrong color for element with ID 'span'");
+
+      // text child of html:span element
+      acc = getAccessible(acc.firstChild, [nsIAccessNode]);
+      is(acc.getComputedStyleValue("", "color"), computedStyle.color,
+         "Wrong color for text child of element with ID 'span'");
+
+      SimpleTest.finish();
+    }
+
+    SimpleTest.waitForExplicitFinish();
+    addLoadEvent(doTest);
+  </script>
+</head>
+
+<body>
+
+  <a target="_blank"
+     href="https://bugzilla.mozilla.org/show_bug.cgi?id=454211"
+     title="nsIAccessNode util methods testing">
+    Mozilla Bug 454211
+  </a>
+  <p id="display"></p>
+  <div id="content" style="display: none"></div>
+  <pre id="test">
+  </pre>
+
+  <span role="description" style="color: red" id="span">text</span>
+
+</body>
+</html>
diff -r 1aecd2a9914d accessible/tests/mochitest/test_textboxes.html
--- a/accessible/tests/mochitest/test_textboxes.html	Tue Sep 16 16:40:57 2008 +1200
+++ b/accessible/tests/mochitest/test_textboxes.html	Thu Sep 18 08:03:22 2008 -0500
@@ -2,27 +2,29 @@
 <html>
 <!--
 https://bugzilla.mozilla.org/show_bug.cgi?id=442648
 -->
 <head>
   <title>nsIAccessible textboxes chrome tests</title>
   <link rel="stylesheet" type="text/css" href="chrome://mochikit/content/tests/SimpleTest/test.css" />
 
-  <script type="application/javascript" src="chrome://mochikit/content/MochiKit/packed.js"></script>
-  <script type="application/javascript" src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/MochiKit/packed.js"></script>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"></script>
 
-  <script type="application/javascript" src="chrome://mochikit/content/a11y/accessible/testTextboxes.js"></script>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/a11y/accessible/common.js"></script>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/a11y/accessible/testTextboxes.js"></script>
 
   <script type="application/javascript">
     function doTest()
     {
-      gAccRetrieval = Components.classes["@mozilla.org/accessibleRetrieval;1"].
-                      getService(nsIAccessibleRetrieval);
-
       //////////////////////////////////////////////////////////////////////////
       // normal textbox without content and with no proper label
       testThis("unlabelled_Textbox", // ID
                null, // name
                "", // value
                "", // description
                role_entry, // role
                (state_focusable), // state
diff -r 1aecd2a9914d accessible/tests/mochitest/test_textboxes.xul
--- a/accessible/tests/mochitest/test_textboxes.xul	Tue Sep 16 16:40:57 2008 +1200
+++ b/accessible/tests/mochitest/test_textboxes.xul	Thu Sep 18 08:03:22 2008 -0500
@@ -7,25 +7,24 @@
         title="nsIAccessible XUL textboxes chrome tests">
 
   <script type="application/javascript" 
           src="chrome://mochikit/content/MochiKit/packed.js"></script>
   <script type="application/javascript"
           src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js" />
 
   <script type="application/javascript"
-          src="chrome://mochikit/content/a11y/accessible/testTextboxes.js"></script>
+          src="chrome://mochikit/content/a11y/accessible/common.js" />
+  <script type="application/javascript"
+          src="chrome://mochikit/content/a11y/accessible/testTextboxes.js" />
 
   <script type="application/javascript">
   <![CDATA[
     function doTest()
     {
-      gAccRetrieval = Components.classes["@mozilla.org/accessibleRetrieval;1"].
-                      getService(nsIAccessibleRetrieval);
-
       //////////////////////////////////////////////////////////////////////////
       // normal textbox without content and with no proper label
       testThis("unlabelled_Textbox", // ID
                "", // name
                "", // value
                "", // description
                role_entry, // role
                (state_focusable), // state
diff -r 1aecd2a9914d browser/app/Makefile.in
--- a/browser/app/Makefile.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/browser/app/Makefile.in	Thu Sep 18 08:03:22 2008 -0500
@@ -66,16 +66,26 @@ DEFINES += -DAPP_UA_NAME="$(APP_UA_NAME)
 DEFINES += -DAPP_UA_NAME="$(APP_UA_NAME)"
 
 DIST_FILES = application.ini
 
 GRE_MILESTONE = $(shell $(PYTHON) $(topsrcdir)/config/printconfigsetting.py $(LIBXUL_DIST)/bin/platform.ini Build Milestone)
 GRE_BUILDID = $(shell $(PYTHON) $(topsrcdir)/config/printconfigsetting.py $(LIBXUL_DIST)/bin/platform.ini Build BuildID)
 
 DEFINES += -DGRE_MILESTONE=$(GRE_MILESTONE) -DGRE_BUILDID=$(GRE_BUILDID)
+
+SOURCE_STAMP := $(shell hg identify -i $(topsrcdir) 2>/dev/null)
+ifdef SOURCE_STAMP
+DEFINES += -DMOZ_SOURCE_STAMP="$(SOURCE_STAMP)"
+endif
+
+SOURCE_REPO := $(shell hg -R $(topsrcdir) showconfig paths.default 2>/dev/null | sed s/^ssh:/http:/)
+ifdef SOURCE_REPO
+DEFINES += -DMOZ_SOURCE_REPO="$(SOURCE_REPO)"
+endif
 
 LIBS += $(JEMALLOC_LIBS)
 
 ifdef LIBXUL_SDK
 include $(topsrcdir)/config/rules.mk
 else
 # Build a binary bootstrapping with XRE_main
 
diff -r 1aecd2a9914d browser/app/application.ini
--- a/browser/app/application.ini	Tue Sep 16 16:40:57 2008 +1200
+++ b/browser/app/application.ini	Thu Sep 18 08:03:22 2008 -0500
@@ -36,16 +36,22 @@
 ; ***** END LICENSE BLOCK *****
 
 #filter substitution
 [App]
 Vendor=Mozilla
 Name=Firefox
 Version=@APP_VERSION@
 BuildID=@GRE_BUILDID@
+#ifdef MOZ_SOURCE_REPO
+SourceRepository=@MOZ_SOURCE_REPO@
+#endif
+#ifdef MOZ_SOURCE_STAMP
+SourceStamp=@MOZ_SOURCE_STAMP@
+#endif
 Copyright=Copyright (c) 1998 - 2008 mozilla.org
 ID={ec8030f7-c20a-464f-9b0e-13a3a9e97384}
 
 [Gecko]
 MinVersion=@GRE_MILESTONE@
 MaxVersion=@GRE_MILESTONE@
 
 [XRE]
diff -r 1aecd2a9914d browser/app/profile/firefox.js
--- a/browser/app/profile/firefox.js	Tue Sep 16 16:40:57 2008 +1200
+++ b/browser/app/profile/firefox.js	Thu Sep 18 08:03:22 2008 -0500
@@ -304,18 +304,17 @@ pref("browser.link.open_newwindow", 3);
 pref("browser.link.open_newwindow", 3);
 
 // 0: no restrictions - divert everything
 // 1: don't divert window.open at all
 // 2: don't divert window.open with features
 pref("browser.link.open_newwindow.restriction", 2);
 
 // Tabbed browser
-pref("browser.tabs.autoHide", true);
-pref("browser.tabs.forceHide", false);
+pref("browser.tabs.autoHide", false);
 pref("browser.tabs.warnOnClose", true);
 pref("browser.tabs.warnOnOpen", true);
 pref("browser.tabs.maxOpenBeforeWarn", 15);
 pref("browser.tabs.loadInBackground", true);
 pref("browser.tabs.loadFolderAndReplace", true);
 pref("browser.tabs.opentabfor.middleclick", true);
 pref("browser.tabs.loadDivertedInBackground", false);
 pref("browser.tabs.loadBookmarksInBackground", false);
diff -r 1aecd2a9914d browser/base/content/browser.js
--- a/browser/base/content/browser.js	Tue Sep 16 16:40:57 2008 +1200
+++ b/browser/base/content/browser.js	Thu Sep 18 08:03:22 2008 -0500
@@ -64,17 +64,16 @@ Cu.import("resource://gre/modules/XPCOMU
 
 const nsIWebNavigation = Components.interfaces.nsIWebNavigation;
 
 const MAX_HISTORY_MENU_ITEMS = 15;
 
 // We use this once, for Clear Private Data
 const GLUE_CID = "@mozilla.org/browser/browserglue;1";
 
-var gURIFixup = null;
 var gCharsetMenu = null;
 var gLastBrowserCharset = null;
 var gPrevCharset = null;
 var gProxyFavIcon = null;
 var gLastValidURLStr = "";
 var gProgressCollapseTimer = null;
 var appCore = null;
 var gSidebarCommand = "";
@@ -1309,17 +1308,16 @@ AutoHideTabbarPrefListener.prototype =
         window.toolbar.visible) {
       var aVisible = false;
       try {
         aVisible = !gPrefService.getBoolPref(this.domain);
       }
       catch (e) {
       }
       gBrowser.setStripVisibilityTo(aVisible);
-      gPrefService.setBoolPref("browser.tabs.forceHide", false);
     }
   }
 }
 
 function SanitizeListener()
 {
   gPrefService.addObserver(this.promptDomain, this, false);
 
@@ -1632,43 +1630,27 @@ function BrowserOpenFileWindow()
                      nsIFilePicker.filterXML | nsIFilePicker.filterHTML);
 
     if (fp.show() == nsIFilePicker.returnOK)
       openTopWin(fp.fileURL.spec);
   } catch (ex) {
   }
 }
 
-function BrowserCloseTabOrWindow()
-{
+function BrowserCloseTabOrWindow() {
 #ifdef XP_MACOSX
   // If we're not a browser window, just close the window
   if (window.location.href != getBrowserURL()) {
     closeWindow(true);
     return;
   }
 #endif
 
-  if (gBrowser.tabContainer.childNodes.length > 1) {
-    gBrowser.removeCurrentTab(); 
-    return;
-  }
-
-#ifndef XP_MACOSX
-  if (gBrowser.localName == "tabbrowser" && window.toolbar.visible &&
-      !gPrefService.getBoolPref("browser.tabs.autoHide")) {
-    // Replace the remaining tab with a blank one and focus the address bar
-    gBrowser.removeCurrentTab();
-    if (gURLBar)
-      setTimeout(function() { gURLBar.focus(); }, 0);
-    return;
-  }
-#endif
-
-  closeWindow(true);
+  // If the current tab is the last one, this will close the window.
+  gBrowser.removeCurrentTab();
 }
 
 function BrowserTryToCloseWindow()
 {
   if (WindowIsClosing()) {
     if (window.fullScreen) {
       gBrowser.mPanelContainer.removeEventListener("mousemove",
                                                    FullScreen._collapseCallback, false);
@@ -1961,47 +1943,35 @@ function checkForDirectoryListing()
 {
   if ( "HTTPIndex" in content &&
        content.HTTPIndex instanceof Components.interfaces.nsIHTTPIndex ) {
     content.wrappedJSObject.defaultCharacterset =
       getMarkupDocumentViewer().defaultCharacterSet;
   }
 }
 
-function URLBarSetURI(aURI) {
+function URLBarSetURI(aURI, aValid) {
   var value = gBrowser.userTypedValue;
-  var state = "invalid";
+  var valid = false;
 
   if (!value) {
-    if (aURI) {
-      // If the url has "wyciwyg://" as the protocol, strip it off.
-      // Nobody wants to see it on the urlbar for dynamically generated
-      // pages.
-      if (!gURIFixup)
-        gURIFixup = Cc["@mozilla.org/docshell/urifixup;1"]
-                      .getService(Ci.nsIURIFixup);
-      try {
-        aURI = gURIFixup.createExposableURI(aURI);
-      } catch (ex) {}
-    } else {
-      aURI = getWebNavigation().currentURI;
-    }
-
-    if (aURI.spec == "about:blank") {
-      // Replace "about:blank" with an empty string
-      // only if there's no opener (bug 370555).
-      value = content.opener ? aURI.spec : "";
-    } else {
-      value = losslessDecodeURI(aURI);
-      state = "valid";
-    }
+    let uri = aURI || getWebNavigation().currentURI;
+
+    // Replace "about:blank" with an empty string
+    // only if there's no opener (bug 370555).
+    if (uri.spec == "about:blank")
+      value = content.opener ? "about:blank" : "";
+    else
+      value = losslessDecodeURI(uri);
+
+    valid = value && (!aURI || aValid);
   }
 
   gURLBar.value = value;
-  SetPageProxyState(state);
+  SetPageProxyState(valid ? "valid" : "invalid");
 }
 
 function losslessDecodeURI(aURI) {
   var value = aURI.spec;
   // Try to decode as UTF-8 if there's no encoding sequence that we would break.
   if (!/%25(?:3B|2F|3F|3A|40|26|3D|2B|24|2C|23)/i.test(value))
     try {
       value = decodeURI(value)
@@ -3750,16 +3720,21 @@ var XULBrowserWindow = {
   },
   get securityButton () {
     delete this.securityButton;
     return this.securityButton = document.getElementById("security-button");
   },
   get isImage () {
     delete this.isImage;
     return this.isImage = document.getElementById("isImage");
+  },
+  get _uriFixup () {
+    delete this._uriFixup;
+    return this._uriFixup = Cc["@mozilla.org/docshell/urifixup;1"]
+                              .getService(Ci.nsIURIFixup);
   },
 
   init: function () {
     this.throbberElement = document.getElementById("navigator-throbber");
 
     // Initialize the security button's state and tooltip text.  Remember to reset
     // _hostChanged, otherwise onSecurityChange will short circuit.
     var securityUI = gBrowser.securityUI;
@@ -4008,18 +3983,25 @@ var XULBrowserWindow = {
       } else {
         this.reloadCommand.removeAttribute("disabled");
       }
 
       if (!gBrowser.mTabbedMode && aWebProgress.isLoadingDocument)
         gBrowser.setIcon(gBrowser.mCurrentTab, null);
 
       if (gURLBar) {
-        URLBarSetURI(aLocationURI);
-        PlacesStarButton.updateState(); // Update starring UI
+        // Strip off "wyciwyg://" and passwords for the location bar
+        let uri = aLocationURI;
+        try {
+          uri = this._uriFixup.createExposableURI(uri);
+        } catch (e) {}
+        URLBarSetURI(uri, true);
+
+        // Update starring UI
+        PlacesStarButton.updateState();
       }
 
       FullZoom.onLocationChange(aLocationURI);
     }
     UpdateBackForwardCommands(gBrowser.webNavigation);
 
     if (gFindBar.findMode != gFindBar.FIND_NORMAL) {
       // Close the Find toolbar if we're in old-style TAF mode
@@ -4216,32 +4198,36 @@ var XULBrowserWindow = {
 
   startDocumentLoad: function (aRequest) {
     // clear out feed data
     gBrowser.mCurrentBrowser.feeds = null;
 
     // clear out search-engine data
     gBrowser.mCurrentBrowser.engines = null;    
 
-    const nsIChannel = Components.interfaces.nsIChannel;
-    var urlStr = aRequest.QueryInterface(nsIChannel).URI.spec;
-    var observerService = Components.classes["@mozilla.org/observer-service;1"]
-                                    .getService(Components.interfaces.nsIObserverService);
-    try {
-      observerService.notifyObservers(content, "StartDocumentLoad", urlStr);
+    var uri = aRequest.QueryInterface(Ci.nsIChannel).URI;
+    var observerService = Cc["@mozilla.org/observer-service;1"]
+                            .getService(Ci.nsIObserverService);
+
+    if (gURLBar &&
+        gURLBar.value == "" &&
+        getWebNavigation().currentURI.spec == "about:blank")
+      URLBarSetURI(uri);
+
+    try {
+      observerService.notifyObservers(content, "StartDocumentLoad", uri.spec);
     } catch (e) {
     }
   },
 
   endDocumentLoad: function (aRequest, aStatus) {
-    const nsIChannel = Components.interfaces.nsIChannel;
-    var urlStr = aRequest.QueryInterface(nsIChannel).originalURI.spec;
-
-    var observerService = Components.classes["@mozilla.org/observer-service;1"]
-                                    .getService(Components.interfaces.nsIObserverService);
+    var urlStr = aRequest.QueryInterface(Ci.nsIChannel).originalURI.spec;
+
+    var observerService = Cc["@mozilla.org/observer-service;1"]
+                            .getService(Ci.nsIObserverService);
 
     var notification = Components.isSuccessCode(aStatus) ? "EndDocumentLoad" : "FailDocumentLoad";
     try {
       observerService.notifyObservers(content, notification, urlStr);
     } catch (e) {
     }
   }
 }
diff -r 1aecd2a9914d browser/base/content/tabbrowser.xml
--- a/browser/base/content/tabbrowser.xml	Tue Sep 16 16:40:57 2008 +1200
+++ b/browser/base/content/tabbrowser.xml	Thu Sep 18 08:03:22 2008 -0500
@@ -1212,18 +1212,16 @@
             b.setAttribute("flex", "1");
             this.mPanelContainer.appendChild(notificationbox);
 
             b.addEventListener("DOMTitleChanged", this.onTitleChanged, true);
 
             if (this.mStrip.collapsed)
               this.setStripVisibilityTo(true);
 
-            this.mPrefs.setBoolPref("browser.tabs.forceHide", false);
-
             // wire up a progress listener for the new browser object.
             var position = this.mTabContainer.childNodes.length-1;
             var tabListener = this.mTabProgressListener(t, b, blank);
             const filter = Components.classes["@mozilla.org/appshell/component/browser-status-filter;1"]
                                      .createInstance(Components.interfaces.nsIWebProgress);
             filter.addProgressListener(tabListener, Components.interfaces.nsIWebProgress.NOTIFY_ALL);
             b.webProgress.addProgressListener(filter, Components.interfaces.nsIWebProgress.NOTIFY_ALL);
             this.mTabListeners[position] = tabListener;
@@ -1399,49 +1397,40 @@
         <parameter name="aTab"/>
         <parameter name="aFireBeforeUnload"/>
         <body>
           <![CDATA[
             this._browsers = null; // invalidate cache
             if (aTab.localName != "tab")
               aTab = this.mCurrentTab;
 
-            var l = this.mTabContainer.childNodes.length;
-            if (l == 1 && this.mPrefs.getBoolPref("browser.tabs.autoHide")) {
-              // hide the tab bar
-              this.mPrefs.setBoolPref("browser.tabs.forceHide", true);
-              this.setStripVisibilityTo(false);
-              return;
+            if (aFireBeforeUnload) {
+              let ds = this.getBrowserForTab(aTab).docShell;
+              if (ds.contentViewer && !ds.contentViewer.permitUnload())
+                return null;
             }
 
-            if (aFireBeforeUnload) {
-              var ds = this.getBrowserForTab(aTab).docShell;
-              if (ds.contentViewer && !ds.contentViewer.permitUnload())
-                return;
+            var l = this.mTabContainer.childNodes.length;
+            if (l == 1) {
+              closeWindow(true);
+              return null;
             }
-
-            // see notes in addTab
-            var _delayedUpdate = function(aTabContainer) {
-              aTabContainer.adjustTabstrip();
-              aTabContainer.mTabstrip._updateScrollButtonsDisabledState();
-            }
-            setTimeout(_delayedUpdate, 0, this.mTabContainer);
-
-            if (l == 1) {
-              // add a new blank tab to replace the one we're about to close
-              // (this ensures that the remaining tab is as good as new)
-              this.addTab("about:blank");
-              l++;
-            }
-            else if (l == 2) {
+            if (l == 2) {
               var autohide = this.mPrefs.getBoolPref("browser.tabs.autoHide");
               var tabStripHide = !window.toolbar.visible;
               if (autohide || tabStripHide)
                 this.setStripVisibilityTo(false);
             }
+
+            // see notes in addTab
+            var _delayedUpdate = function (aTabContainer) {
+              aTabContainer.adjustTabstrip();
+              aTabContainer.mTabstrip._updateScrollButtonsDisabledState();
+            };
+            setTimeout(_delayedUpdate, 0, this.mTabContainer);
 
             // We're committed to closing the tab now.  
             // Dispatch a notification.
             // We dispatch it before any teardown so that event listeners can
             // inspect the tab that's about to close.
             var evt = document.createEvent("Events");
             evt.initEvent("TabClose", true, false);
             aTab.dispatchEvent(evt);
@@ -1474,16 +1463,19 @@
           ]]>
         </body>
       </method>
 
       <method name="_endRemoveTab">
         <parameter name="aTab"/>
         <body>
           <![CDATA[
+            if (!aTab)
+              return null;
+
             var browser = this.getBrowserForTab(aTab);
             var length = this.mTabs.length;
 
             // Get the index of the tab we're removing before unselecting it
             var currentIndex = this.mTabContainer.selectedIndex;
             var index = aTab._tPos;
 
             // clean up the before/afterselected attributes before removing the
@@ -1663,19 +1655,18 @@
       <method name="addProgressListener">
         <parameter name="aListener"/>
         <parameter name="aMask"/>
         <body>
           <![CDATA[
             if (!this.mAddProgressListenerWasCalled) {
               this.mAddProgressListenerWasCalled = true;
               var autoHide = this.mPrefs.getBoolPref("browser.tabs.autoHide");
-              var forceHide = this.mPrefs.getBoolPref("browser.tabs.forceHide");
               var tabStripHide = !window.toolbar.visible;
-              if (!autoHide && !forceHide && !tabStripHide)
+              if (!autoHide && !tabStripHide)
                 this.setStripVisibilityTo(true);
             }
 
             if (!this.mTabbedMode && this.mProgressListeners.length == 1) {
               // If we are adding a 2nd progress listener, we need to enter tabbed mode
               // because the browser status filter can only handle one progress listener.
               // In tabbed mode, mTabProgressListener is used which will iterate over all listeners.
               this.enterTabbedMode();
diff -r 1aecd2a9914d browser/installer/windows/Makefile.in
--- a/browser/installer/windows/Makefile.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/browser/installer/windows/Makefile.in	Thu Sep 18 08:03:22 2008 -0500
@@ -64,16 +64,17 @@ BRANDING_FILES = \
 	wizHeader.bmp \
 	wizHeaderRTL.bmp \
 	wizWatermark.bmp \
 	$(NULL)
 
 DEFINES += \
 	-DAB_CD=$(AB_CD) \
 	-DPKG_BASENAME=$(PKG_BASENAME) \
+	-DPKG_INST_BASENAME=$(PKG_INST_BASENAME) \
 	-DMOZ_APP_VERSION=$(MOZ_APP_VERSION) \
 	-DMOZ_APP_NAME=$(MOZ_APP_NAME) \
 	-DMOZ_APP_DISPLAYNAME=${MOZ_APP_DISPLAYNAME} \
 	-DMOZILLA_VERSION=${MOZILLA_VERSION} \
 	$(NULL)
 
 include $(topsrcdir)/config/config.mk
 include $(call EXPAND_LOCALE_SRCDIR,toolkit/locales)/installer/windows/charset.mk
diff -r 1aecd2a9914d browser/installer/windows/nsis/defines.nsi.in
--- a/browser/installer/windows/nsis/defines.nsi.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/browser/installer/windows/nsis/defines.nsi.in	Thu Sep 18 08:03:22 2008 -0500
@@ -1,13 +1,13 @@
 #filter substitution
 !define AppVersion            "@MOZ_APP_VERSION@"
 !define GREVersion            @MOZILLA_VERSION@
 !define AB_CD                 "@AB_CD@"
-!define FileInstallerEXE      "@PKG_BASENAME@.installer.exe"
-!define FileInstallerMSI      "@PKG_BASENAME@.installer.msi"
+!define FileInstallerEXE      "@PKG_INST_BASENAME@.exe"
+!define FileInstallerMSI      "@PKG_INST_BASENAME@.msi"
 !define FileInstallerNETRoot  "@PKG_BASENAME@.net-installer"
 
 !define FileMainEXE           "@MOZ_APP_NAME@.exe"
 !define WindowClass           "FirefoxMessageWindow"
 !define DDEApplication        "Firefox"
 !define AppRegName            "Firefox"
 !define MinUnsupportedVer     "Microsoft Windows 2000"
diff -r 1aecd2a9914d browser/locales/Makefile.in
--- a/browser/locales/Makefile.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/browser/locales/Makefile.in	Thu Sep 18 08:03:22 2008 -0500
@@ -69,16 +69,17 @@ core_abspath = $(if $(findstring :,$(1))
 core_abspath = $(if $(findstring :,$(1)),$(1),$(if $(filter /%,$(1)),$(1),$(PWD)/$(1)))
 
 DEFINES += \
 	-DAB_CD=$(AB_CD) \
 	-DMOZ_LANGPACK_EID=langpack-$(AB_CD)@firefox.mozilla.org \
 	-DMOZ_APP_VERSION=$(MOZ_APP_VERSION) \
 	-DLOCALE_SRCDIR=$(call core_abspath,$(LOCALE_SRCDIR)) \
 	-DPKG_BASENAME=$(PKG_BASENAME) \
+	-DPKG_INST_BASENAME=$(PKG_INST_BASENAME) \
 	$(NULL)
 
 ifndef MOZ_BRANDING_DIRECTORY
 DEFINES += -DMOZ_USE_GENERIC_BRANDING
 endif
 
 ifeq (,$(filter-out pref,$(MOZ_EXTENSIONS)))
 DEFINES += -DEXTENSION_PREF
@@ -187,17 +188,17 @@ MOZ_PKG_MAC_RSRC=$(_ABS_DIST)/branding/l
 MOZ_PKG_MAC_RSRC=$(_ABS_DIST)/branding/license.r
 MOZ_PKG_MAC_EXTRA=--symlink "/Applications:/ "
 endif
 
 PACKAGER_NO_LIBS = 1
 include $(topsrcdir)/toolkit/mozapps/installer/packager.mk
 include $(call EXPAND_LOCALE_SRCDIR,toolkit/locales)/installer/windows/charset.mk
 
-repackage-win32-installer: WIN32_INSTALLER_OUT=$(_ABS_DIST)/install/sea/$(PKG_BASENAME).installer.exe
+repackage-win32-installer: WIN32_INSTALLER_OUT=$(_ABS_DIST)/$(PKG_INST_PATH)$(PKG_INST_BASENAME).exe
 repackage-win32-installer: $(WIN32_INSTALLER_IN) $(SUBMAKEFILES)
 ifneq (en-US,$(AB_CD))
 	@echo "Verifying $(AB_CD) installer variable usage"
 	@$(PERL) $(topsrcdir)/toolkit/mozapps/installer/windows/nsis/check-locales.pl $(LOCALE_SRCDIR)/installer
 endif
 	@echo "Repackaging $(WIN32_INSTALLER_IN) into $(WIN32_INSTALLER_OUT)."
 ifdef MOZ_BRANDING_DIRECTORY
 	$(MAKE) -C $(DEPTH)/$(MOZ_BRANDING_DIRECTORY) export
@@ -222,17 +223,17 @@ endif
 	rm -f app.7z
 	cd l10n-stage && \
 	  $(CYGWIN_WRAPPER) 7z a -r -t7z ../app.7z -mx -m0=BCJ2 -m1=LZMA:d24 -m2=LZMA:d19 -m3=LZMA:d19 -mb0:1 -mb0s1:2 -mb0s2:3
 	cat ../installer/windows/l10ngen/7zSD.sfx \
 	    $(topsrcdir)/browser/installer/windows/app.tag \
 	    app.7z > $(WIN32_INSTALLER_OUT)
 	chmod 0755 $(WIN32_INSTALLER_OUT)
 
-repackage-win32-installer-%: WIN32_INSTALLER_IN=$(_ABS_DIST)/install/sea/$(PKG_BASENAME).installer.exe
+repackage-win32-installer-%: WIN32_INSTALLER_IN=$(_ABS_DIST)/$(PKG_INST_PATH)$(PKG_INST_BASENAME).exe
 repackage-win32-installer-%: $(WIN32_INSTALLER_IN)
 	@$(MAKE) repackage-win32-installer AB_CD=$* WIN32_INSTALLER_IN=$(WIN32_INSTALLER_IN)
 
 ifneq (,$(filter mac cocoa,$(MOZ_WIDGET_TOOLKIT)))
 STAGEDIST = $(_ABS_DIST)/l10n-stage/$(MOZ_PKG_APPNAME)/$(_APPNAME)/Contents/MacOS
 else
 STAGEDIST = $(_ABS_DIST)/l10n-stage/$(MOZ_PKG_APPNAME)
 endif
@@ -262,30 +263,32 @@ endif
 	$(RM) -r $(DIST)/xpi-stage/locale-$(AB_CD)/chrome/$(AB_CD)
 	cd $(DIST)/xpi-stage/locale-$(AB_CD) && \
 	  tar $(TAR_CREATE_FLAGS) - * | ( cd $(STAGEDIST) && tar -xf - )
 ifneq (en,$(AB))
 ifneq (,$(filter mac cocoa,$(MOZ_WIDGET_TOOLKIT)))
 	mv $(_ABS_DIST)/l10n-stage/$(MOZ_PKG_APPNAME)/$(_APPNAME)/Contents/Resources/en.lproj $(_ABS_DIST)/l10n-stage/$(MOZ_PKG_APPNAME)/$(_APPNAME)/Contents/Resources/$(AB).lproj
 endif
 endif
+	$(NSINSTALL) -D $(DIST)/l10n-stage/$(PKG_PATH)
 	cd $(DIST)/l10n-stage; \
 	  $(MAKE_PACKAGE)
-	mv -f $(DIST)/l10n-stage/$(PACKAGE) $(DIST)
+	$(NSINSTALL) -D $(DIST)/$(PKG_PATH)
+	mv -f $(DIST)/l10n-stage/$(PACKAGE) $(DIST)/$(PACKAGE)
 
 repackage-zip-%: ZIP_IN=$(_ABS_DIST)/$(PACKAGE)
 repackage-zip-%: $(ZIP_IN)
 	@$(MAKE) repackage-zip AB_CD=$* ZIP_IN=$(ZIP_IN)
 
-langpack-%: LANGPACK_FILE=$(_ABS_DIST)/install/firefox-$(MOZ_APP_VERSION).$(AB_CD).langpack.xpi
+langpack-%: LANGPACK_FILE=$(_ABS_DIST)/$(PKG_LANGPACK_PATH)$(PKG_LANGPACK_BASENAME).xpi
 langpack-%: AB_CD=$*
 langpack-%: XPI_NAME=locale-$*
 langpack-%:
 	@echo "Making langpack $(LANGPACK_FILE)"
-	$(NSINSTALL) -D $(DIST)/install
+	$(NSINSTALL) -D $(DIST)/$(PKG_LANGPACK_PATH)
 	@$(RM) -rf $(DIST)/xpi-stage/locale-$(AB_CD)
 	@$(MAKE) libs-$(AB_CD) USE_EXTENSION_MANIFEST=1
 	$(PERL) $(topsrcdir)/config/preprocessor.pl $(DEFINES) $(ACDEFINES) -I$(call EXPAND_LOCALE_SRCDIR,toolkit/locales)/defines.inc -I$(LOCALE_SRCDIR)/defines.inc $(srcdir)/generic/install.rdf > $(FINAL_TARGET)/install.rdf
 	cd $(DIST)/xpi-stage/locale-$(AB_CD) && \
 	  $(ZIP) -r9D $(LANGPACK_FILE) install.rdf chrome chrome.manifest
 
 # This is a generic target that will make a langpack, repack ZIP (+tarball)
 # builds, and repack an installer if applicable. It is called from the
@@ -330,12 +333,12 @@ endif
 # and for the windows repackages we need the .installer.exe in dist/sea
 wget-en-US:
 ifndef WGET
 	$(error Wget not installed)
 endif
 	@$(WGET) -nv --output-document $(_ABS_DIST)/$(PACKAGE) $(EN_US_BINARY_URL)/$(PACKAGE)
 	@echo "Downloaded $(EN_US_BINARY_URL)/$(PACKAGE) to $(_ABS_DIST)/$(PACKAGE)"
 ifeq ($(OS_ARCH), WINNT)
-	$(NSINSTALL) -D $(_ABS_DIST)/install/sea
-	@$(WGET) -nv --output-document $(_ABS_DIST)/install/sea/$(PKG_BASENAME).installer.exe $(EN_US_BINARY_URL)/$(PKG_BASENAME).installer.exe
-	@echo "Downloaded $(EN_US_BINARY_URL)/$(PKG_BASENAME).installer.exe to $(_ABS_DIST)/install/sea/$(PKG_BASENAME)"
+	$(NSINSTALL) -D $(_ABS_DIST)/$(PKG_INST_PATH)
+	@$(WGET) -nv --output-document $(_ABS_DIST)/$(PKG_INST_PATH)$(PKG_INST_BASENAME).exe $(EN_US_BINARY_URL)/$(PKG_PATH)$(PKG_INST_BASENAME).exe
+	@echo "Downloaded $(EN_US_BINARY_URL)/$(PKG_PATH)$(PKG_INST_BASENAME).exe to $(_ABS_DIST)/$(PKG_INST_PATH)$(PKG_INST_BASENAME)"
 endif
diff -r 1aecd2a9914d browser/themes/pinstripe/browser/bookmark_toolbar_background-inactive.png
Binary file browser/themes/pinstripe/browser/bookmark_toolbar_background-inactive.png has changed
diff -r 1aecd2a9914d browser/themes/pinstripe/browser/bookmark_toolbar_background.gif
Binary file browser/themes/pinstripe/browser/bookmark_toolbar_background.gif has changed
diff -r 1aecd2a9914d browser/themes/pinstripe/browser/bookmark_toolbar_background.png
Binary file browser/themes/pinstripe/browser/bookmark_toolbar_background.png has changed
diff -r 1aecd2a9914d browser/themes/pinstripe/browser/browser.css
--- a/browser/themes/pinstripe/browser/browser.css	Tue Sep 16 16:40:57 2008 +1200
+++ b/browser/themes/pinstripe/browser/browser.css	Thu Sep 18 08:03:22 2008 -0500
@@ -42,40 +42,30 @@
  * ***** END LICENSE BLOCK ***** */
 
 @import url("chrome://global/skin/");
 
 @namespace url("http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul");
 @namespace html url("http://www.w3.org/1999/xhtml");
 @namespace svg url("http://www.w3.org/2000/svg");
 
-#main-window {
-  -moz-binding: url("chrome://global/skin/globalBindings.xml#unifiedWindow");
-}
-
 #main-window[chromehidden~="toolbar"][chromehidden~="location"][chromehidden~="directories"] {
   border-top: 1px solid rgba(0,0,0,0.65);
   -moz-appearance: none;
   background-color: #eeeeee;
 }
 
 /* ----- INACTIVE WINDOW ----- */
 
-#main-window:not([active="true"]) > #navigator-toolbox > toolbar {
-  border-top-color: rgba(255,255,255,0.45);
-  border-bottom-color: rgba(0,0,0,0.35);
-  background-color: #cfcfcf;
-}
-
 #main-window:not([active="true"]) > #navigator-toolbox > #nav-bar {
   background-image: url("chrome://global/skin/toolbar/toolbar-background-inactive.png");
 }
 
 #main-window:not([active="true"]) > #navigator-toolbox > #PersonalToolbar {
-  background-image: url("chrome://browser/skin/bookmark_toolbar_background-inactive.png");
+  background-color: -moz-mac-chrome-inactive;
 }
 
 #main-window:not([active="true"]) > #navigator-toolbox > toolbar > toolbaritem,
 #main-window:not([active="true"]) > #navigator-toolbox > toolbar > toolbarbutton,
 #main-window:not([active="true"]) > #browser-bottombox {
   opacity: 0.75;
 }
 
@@ -87,42 +77,30 @@
 #main-window:not([active="true"]) .tabbrowser-strip {
   background-color: #cfcfcf;
 }
 
 #main-window:not([active="true"]) .tabbrowser-tab {
   color: #575757;
 }
 
-#main-window:not([active="true"]) .tabbrowser-tab[selected="true"] > .tab-image-middle,
-#main-window:not([active="true"]) .tabbrowser-tab[selected="true"] > .tab-closebutton,
-#main-window:not([active="true"]) .tabbrowser-tab[selected="true"] > .tab-close-button {
-  background-image: url("chrome://browser/skin/tabbrowser/tab-middle-inactive.png");
-}
-
-#main-window:not([active="true"]) .tabbrowser-tab[selected="true"] > .tab-image-left,
-#main-window:not([active="true"]) .tabbrowser-tab[selected="true"][chromedir="rtl"] > .tab-image-right {
-  background: url("chrome://browser/skin/tabbrowser/tab-left-inactive.png") no-repeat;
-}
-
-#main-window:not([active="true"]) .tabbrowser-tab[selected="true"] > .tab-image-right,
-#main-window:not([active="true"]) .tabbrowser-tab[selected="true"][chromedir="rtl"] > .tab-image-left {
-  background: url("chrome://browser/skin/tabbrowser/tab-right-inactive.png") no-repeat;
+#main-window:not([active="true"]) .tabbrowser-tab[selected="true"] {
+  background-color: -moz-mac-chrome-inactive;
 }
 
 /* ----- SEARCH FIELD ----- */
 
 #wrapper-search-container #searchbar html|*.textbox-input {
   visibility: hidden;
 }
 
 /* ----- BOOKMARK TOOLBAR ----- */
 
 #PersonalToolbar {
-  background: url("chrome://browser/skin/bookmark_toolbar_background.gif") repeat-x center center;
+  background: url("chrome://browser/skin/bookmark_toolbar_background.png") repeat-x center center -moz-mac-chrome-active;
   border-top: 1px solid rgba(255,255,255,0.25);
   border-bottom: 2px solid;
   -moz-border-bottom-colors: rgba(0,0,0,0.35) transparent;
   padding: 2px 0;
 }
 
 
 /* ----- BOOKMARK BUTTONS ----- */	
@@ -1592,18 +1570,16 @@ toolbarbutton.chevron {
 
 
 toolbarbutton.chevron > .toolbarbutton-menu-dropmarker {
   display: none;
 }
 
 #nav-bar {
   background-color: #9e9e9e;
-  border-top: none;
-  border-bottom: 1px solid rgba(0,0,0,0.35);
   background-image: url("chrome://global/skin/toolbar/toolbar-background.gif");
   background-repeat: repeat-x;
   background-position: top right;
   padding: 0 4px;
 }
 
 #nav-bar[collapsed="true"] + toolbar[customindex] {
  border-top: 2px solid;
@@ -1622,17 +1598,17 @@ toolbarbutton.chevron > .toolbarbutton-m
 
 .tab-icon-image {
   width: 16px;
   height: 16px;
   list-style-image: url("chrome://global/skin/tree/item.png");
 }
 
 .tab-icon {
-  margin: 0 0 4px 0;
+  margin: 0 0 3px 0;
   opacity: 0.6;
 }
 
 .tabbrowser-tab:not([selected="true"]):hover .tab-icon,
 .tabbrowser-tab[selected="true"] .tab-icon {
   opacity: 1.0;
 }
 
@@ -1649,27 +1625,30 @@ toolbarbutton.chevron > .toolbarbutton-m
 .tabbrowser-tab[busy] > .tab-icon-image,
 .tabbrowser-tab[busy] > .tab-image-middle > .tab-icon > .tab-icon-image {
  list-style-image: url("chrome://global/skin/icons/loading_16.png") !important; 
 }
 
 .tabbrowser-tab {
   -moz-binding: url("chrome://browser/skin/browser.xml#tabbrowser-tab") !important;
   -moz-appearance: none;
+  -moz-border-radius: 0 0 3px 3px;
   color: #222;
   -moz-box-pack: center;
+  margin: 0 3px 3px 2px;
   padding: 0px;
   border: none !important;
   min-width: 1px !important;
   text-align: center;
-  height: 27px;
+  height: 22px;
 }
 
 .tabbrowser-tab[selected="true"] {
   -moz-user-focus: normal;
+  background-color: -moz-mac-chrome-active;
 }
 
 .tabbrowser-tab[selected="true"]:focus > .tab-image-middle > .tab-text-stack > .tab-text {
   outline: 2px solid #4F8EC9;
   outline-offset: -2px;
   -moz-outline-radius: 3px;
 }
 
@@ -1680,73 +1659,74 @@ toolbarbutton.chevron > .toolbarbutton-m
 
 .tab-image-left,
 .tab-image-right {
   width: 8px;
   margin: 0px;
   padding: 0px;
 }
 
+.tab-image-left,
+.tab-image-right,
+.tabbrowser-tab > .tab-image-middle,
+.tabbrowser-tab > .tab-close-button {
+  margin-bottom: -3px;
+  padding-top: 1px;
+}
+
 .tabbrowser-tab > .tab-image-right,
 .tabbrowser-tab[chromedir="rtl"] > .tab-image-left {
+  margin-right: -3px;
   background: url("chrome://browser/skin/tabbrowser/tab-right.png") no-repeat;
 }
 
 .tabbrowser-tab:not([selected="true"]) > .tab-image-right,
 .tabbrowser-tab:not([selected="true"])[chromedir="rtl"] > .tab-image-left {
   background: url("chrome://browser/skin/tabbrowser/tab-right-bkgnd.png") no-repeat;
 }
 
 .tabbrowser-tab > .tab-image-left,
 .tabbrowser-tab[chromedir="rtl"] > .tab-image-right {
+  margin-left: -2px;
   background: url("chrome://browser/skin/tabbrowser/tab-left.png") no-repeat;
 }
 
 .tabbrowser-tab:not([selected="true"]) > .tab-image-left,
 .tabbrowser-tab:not([selected="true"])[chromedir="rtl"] > .tab-image-right {
   background: url("chrome://browser/skin/tabbrowser/tab-left-bkgnd.png") no-repeat;
 }
 
 .tabbrowser-tab > .tab-image-middle,
-.tabbrowser-tab > .tab-closebutton {
+.tabbrowser-tab > .tab-close-button {
   background: url("chrome://browser/skin/tabbrowser/tab-middle.png") repeat-x;
   -moz-box-pack: center;
 }
 
 .tabbrowser-tab:not([selected="true"]) > .tab-image-middle,
 .tabbrowser-tab:not([selected="true"]) > .tab-close-button {
   background: url("chrome://browser/skin/tabbrowser/tab-middle-bkgnd.png");
 }
 
 .tabbrowser-tab:not([selected="true"]) > .tab-image-middle > .tab-icon > .tab-icon-image  {
   list-style-image: url("chrome://global/skin/tree/item-grayscale.png");
 }
 
-.tabs-closebutton {
-  margin: 0;
-  list-style-image: url("chrome://global/skin/icons/closetab.png") !important;
-}
-
-.tabs-closebutton:hover:active {
-  list-style-image: url("chrome://global/skin/icons/closetab-active.png") !important;
-  border: none !important;
-}
-
 .tabbrowser-strip {
   margin-top: -1px;
   border-bottom: 1px solid #404040;
   background-color: #9B9B9B;
 }
 
 .tabbrowser-tabs {
   border: none;
   -moz-box-pack: center;
   -moz-box-align: center;
   background: url("chrome://browser/skin/tabbrowser/tabbrowser-tabs-bkgnd.png") repeat-x;
-  height: 27px;
+  height: 25px;
+  margin-bottom: 0;
 }
 
 .tabs-left {
   display: -moz-box;
   width: 3px;
 }
 
 .tabbrowser-tabs[overflow="true"] .tabs-left {
@@ -1785,45 +1765,36 @@ tabbrowser > tabbox > tabpanels {
   -moz-margin-end: 0px !important;
   margin-top: 1px;
 }
 
 .tab-close-button {
   list-style-image: url("chrome://global/skin/icons/closetab.png");
   -moz-appearance: none;
   border: none !important;
-  padding: 0 0 4px 0;
+  padding: 0 0 3px 0;
   margin: 0;
   background: inherit;
   cursor: default;
 }
 
 .tab-close-button:hover,
 .tabbrowser-tab[selected="true"] > .tab-close-button:hover {
   list-style-image: url("chrome://global/skin/icons/closetab-hover.png");
 }
 
 .tab-close-button:hover:active,
 .tabbrowser-tab[selected="true"] > .tab-close-button:hover:active {
   list-style-image: url("chrome://global/skin/icons/closetab-active.png");
 }
 
-.tabbrowser-tab > .tab-close-button {
-  background-image: url("chrome://browser/skin/tabbrowser/tab-middle.png");
-  background-repeat: repeat-x;
-}
-
 .tabbrowser-tab[selected="true"] > .tab-close-button {
   /* Make this button focusable so clicking on it will not focus the tab while
      it's getting closed */
   -moz-user-focus: normal;
-}
-
-.tabbrowser-tab:not([selected="true"]) > .tab-close-button {
-  background-image: url("chrome://browser/skin/tabbrowser/tab-middle-bkgnd.png");
 }
 
 .tabbrowser-arrowscrollbox > .scrollbutton-up,
 .tabbrowser-arrowscrollbox > .scrollbutton-down-stack > .scrollbutton-down[chromedir="rtl"] {
   border: 0;
   border-right: 2px solid;
   -moz-border-right-colors: rgba(0,0,0,0.25) rgba(255,255,255,0.15);
   list-style-image: url("chrome://browser/skin/tabbrowser/tab-arrow-start.png");
@@ -1892,18 +1863,17 @@ tabbrowser > tabbox > tabpanels {
 }
 
 .tabs-alltabs-button {
   list-style-image: url("chrome://browser/skin/tabbrowser/alltabs-box-bkgnd-icon.png");
   -moz-border-start: 2px solid;
   -moz-border-left-colors: rgba(0,0,0,0.25) rgba(255,255,255,0.15);
   -moz-border-right-colors: rgba(0,0,0,0.25) rgba(255,255,255,0.15);
   margin: 0;
-  padding-left: 0;
-  padding-right: 0;
+  padding: 2px 0 0 0;
 }
 .tabs-alltabs-button:hover {
   background-color: rgba(0,0,0,0.10);
 }
 .tabs-alltabs-button:hover:active,
 .tabs-alltabs-button[open="true"] {
   background-color: rgba(0,0,0,0.20);
 }
diff -r 1aecd2a9914d browser/themes/pinstripe/browser/jar.mn
--- a/browser/themes/pinstripe/browser/jar.mn	Tue Sep 16 16:40:57 2008 +1200
+++ b/browser/themes/pinstripe/browser/jar.mn	Thu Sep 18 08:03:22 2008 -0500
@@ -1,12 +1,11 @@ classic.jar:
 classic.jar:
 % skin browser classic/1.0 %skin/classic/browser/
-  skin/classic/browser/bookmark_toolbar_background.gif
-  skin/classic/browser/bookmark_toolbar_background-inactive.png
+  skin/classic/browser/bookmark_toolbar_background.png
   skin/classic/browser/bookmark-open-left.png
   skin/classic/browser/bookmark-open-mid.png
   skin/classic/browser/bookmark-open-right.png
 * skin/classic/browser/browser.css                          (browser.css)
   skin/classic/browser/browser.xml
   skin/classic/browser/contextDialogBackground.png
 * skin/classic/browser/engineManager.css                    (engineManager.css)
   skin/classic/browser/expander-round.png 
@@ -124,26 +123,20 @@ classic.jar:
   skin/classic/browser/tabbrowser/tab-arrow-start-bkgnd-animate.png      (tabbrowser/tab-arrow-start-bkgnd-animate.png)
   skin/classic/browser/tabbrowser/tab-arrow-end.png                      (tabbrowser/tab-arrow-end.png)
   skin/classic/browser/tabbrowser/tab-arrow-end-bkgnd.png                (tabbrowser/tab-arrow-end-bkgnd.png)
   skin/classic/browser/tabbrowser/tab-arrow-end-bkgnd-animate.png        (tabbrowser/tab-arrow-end-bkgnd-animate.png)
   skin/classic/browser/tabbrowser/tabbrowser-tabs-bkgnd.png              (tabbrowser/tabbrowser-tabs-bkgnd.png)
   skin/classic/browser/tabbrowser/tabDragIndicator.png                   (tabbrowser/tabDragIndicator.png)
   skin/classic/browser/tabbrowser/tab-left.png                           (tabbrowser/tab-left.png)
   skin/classic/browser/tabbrowser/tab-left-bkgnd.png                     (tabbrowser/tab-left-bkgnd.png)
-  skin/classic/browser/tabbrowser/tab-left-hover.png                     (tabbrowser/tab-left-hover.png)
-  skin/classic/browser/tabbrowser/tab-left-inactive.png                  (tabbrowser/tab-left-inactive.png)
   skin/classic/browser/tabbrowser/tab-middle.png                         (tabbrowser/tab-middle.png)
   skin/classic/browser/tabbrowser/tab-middle-bkgnd.png                   (tabbrowser/tab-middle-bkgnd.png)
-  skin/classic/browser/tabbrowser/tab-middle-hover.png                   (tabbrowser/tab-middle-hover.png)
-  skin/classic/browser/tabbrowser/tab-middle-inactive.png                (tabbrowser/tab-middle-inactive.png)
   skin/classic/browser/tabbrowser/tab-right.png                          (tabbrowser/tab-right.png)
   skin/classic/browser/tabbrowser/tab-right-bkgnd.png                    (tabbrowser/tab-right-bkgnd.png)
-  skin/classic/browser/tabbrowser/tab-right-hover.png                    (tabbrowser/tab-right-hover.png)
-  skin/classic/browser/tabbrowser/tab-right-inactive.png                 (tabbrowser/tab-right-inactive.png)
   skin/classic/browser/tabbrowser/tabs-bottom-bg.png                     (tabbrowser/tabs-bottom-bg.png)
   skin/classic/browser/urlbar/endcap.png                                 (urlbar/endcap.png)
   skin/classic/browser/urlbar/endcap-rtl.png                             (urlbar/endcap-rtl.png)
   skin/classic/browser/urlbar/endcap-focused.png                         (urlbar/endcap-focused.png)
   skin/classic/browser/urlbar/endcap-focused-rtl.png                     (urlbar/endcap-focused-rtl.png)
   skin/classic/browser/urlbar/startcap.png                               (urlbar/startcap.png)
   skin/classic/browser/urlbar/startcap-rtl.png                           (urlbar/startcap-rtl.png)
   skin/classic/browser/urlbar/startcap-focused.png                       (urlbar/startcap-focused.png)
diff -r 1aecd2a9914d browser/themes/pinstripe/browser/pageInfo.css
--- a/browser/themes/pinstripe/browser/pageInfo.css	Tue Sep 16 16:40:57 2008 +1200
+++ b/browser/themes/pinstripe/browser/pageInfo.css	Thu Sep 18 08:03:22 2008 -0500
@@ -34,37 +34,23 @@
  * and other provisions required by the GPL or the LGPL. If you do not delete
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 @import "chrome://global/skin/";
 
-#main-window {
-  -moz-binding: url("chrome://global/skin/globalBindings.xml#unifiedWindow");
-}
-
-#main-window:not([active="true"]) > #topStackBar {
-  background-image: url("chrome://global/skin/toolbar/toolbar-background-inactive.png");
-  background-color: #cfcfcf;
-  border-bottom: 1px solid rgba(0,0,0,0.35);
-}
-
 #main-window:not([active="true"]) > #topStackBar > #viewGroup {
   opacity: 0.7;
 }
 
 #topStackBar {
   display: -moz-box;
-  background-color: #969696;
-  border-bottom: 1px solid #404040;
-  background-image: url("chrome://global/skin/toolbar/toolbar-background.gif");
-  background-repeat: repeat-x;
-  background-position: top right;
+  -moz-appearance: -moz-mac-unified-toolbar;
   padding: 4px 0 8px;
   -moz-box-pack: center;
 }
 
 /* View buttons */
 
 #viewGroup {
   border: 1px solid #404040;
diff -r 1aecd2a9914d browser/themes/pinstripe/browser/places/organizer.css
--- a/browser/themes/pinstripe/browser/places/organizer.css	Tue Sep 16 16:40:57 2008 +1200
+++ b/browser/themes/pinstripe/browser/places/organizer.css	Thu Sep 18 08:03:22 2008 -0500
@@ -1,21 +1,9 @@
-/* Unified toolbar */
-
-#places {
-  -moz-binding: url("chrome://global/skin/globalBindings.xml#unifiedWindow");
-}
-
 /* Inactive Window */
-
-#places:not([active="true"]) > #placesToolbox > #placesToolbar {
-  background-image: url("chrome://global/skin/toolbar/toolbar-background-inactive.png");
-  background-color: #cfcfcf;
-  border-bottom: 1px solid rgba(0,0,0,0.35);
-}
 
 #places:not([active="true"]) > #placesToolbox > #placesToolbar > toolbarbutton,
 #places:not([active="true"]) > #placesToolbox > #placesToolbar > #searchFilter {
   opacity: 0.7;
 }
 
 #places:not([active="true"]) > #placesView > #placesList {
   background-color: #e8e8e8;
@@ -74,21 +62,16 @@
 }
 
 #placesList treechildren::-moz-tree-cell-text(selected) {  
   font-weight: bold !important;
   color: #ffffff !important;
 }
 
 #placesToolbar {
-  background-color: #999;
-  border-bottom: 1px solid #404040;
-  background-image: url("chrome://global/skin/toolbar/toolbar-background.gif");
-  background-repeat: repeat-x;
-  background-position: 3px 0px;
   margin-top: -3px;
   padding: 0 4px;
 }
 
 #placesView {
   border-top: none !important;
 }
 
diff -r 1aecd2a9914d browser/themes/pinstripe/browser/preferences/preferences.css
--- a/browser/themes/pinstripe/browser/preferences/preferences.css	Tue Sep 16 16:40:57 2008 +1200
+++ b/browser/themes/pinstripe/browser/preferences/preferences.css	Thu Sep 18 08:03:22 2008 -0500
@@ -34,26 +34,16 @@
 # decision by deleting the provisions above and replace them with the notice
 # and other provisions required by the GPL or the LGPL. If you do not delete
 # the provisions above, a recipient may use your version of this file under
 # the terms of any one of the MPL, the GPL or the LGPL.
 #
 # ***** END LICENSE BLOCK *****
 */
 
-#BrowserPreferences {
-  -moz-binding: url("chrome://global/skin/globalBindings.xml#unifiedPrefwindow");
-}
-
-#BrowserPreferences:not([active="true"]) > .paneSelector {
-  background-image: url("chrome://global/skin/toolbar/toolbar-background-tall-inactive.png");
-  background-color: #cfcfcf;
-  border-bottom: 1px solid rgba(0,0,0,0.35);
-}
-
 #BrowserPreferences:not([active="true"]) > .paneSelector > radio {
   opacity: 0.7;
 }
 
 .prefWindow-dlgbuttons {
   margin: 0 12px 8px 12px;
 }
 
@@ -64,21 +54,17 @@
 .windowDialog {
   padding: 12px;
   font: -moz-dialog;
 }
 
 .paneSelector {
   list-style-image: url("chrome://browser/skin/preferences/Options.png");
   padding: 0 5px 2px 5px;
-  background-color: #999;
-  border-bottom: 1px solid #404040;
-  background-image: url("chrome://global/skin/toolbar/toolbar-background-tall.png");
-  background-repeat: repeat-x;
-  background-position: top right;
+  -moz-appearance: -moz-mac-unified-toolbar;
   margin: 0;
 }
 
 .paneSelector > radio[pane] {
   -moz-binding: url("chrome://browser/skin/browser.xml#radio-shadow") !important;
 }
 
 .paneSelector radio {
diff -r 1aecd2a9914d browser/themes/pinstripe/browser/tabbrowser/tab-left-hover.png
Binary file browser/themes/pinstripe/browser/tabbrowser/tab-left-hover.png has changed
diff -r 1aecd2a9914d browser/themes/pinstripe/browser/tabbrowser/tab-left-inactive.png
Binary file browser/themes/pinstripe/browser/tabbrowser/tab-left-inactive.png has changed
diff -r 1aecd2a9914d browser/themes/pinstripe/browser/tabbrowser/tab-left.png
Binary file browser/themes/pinstripe/browser/tabbrowser/tab-left.png has changed
diff -r 1aecd2a9914d browser/themes/pinstripe/browser/tabbrowser/tab-middle-hover.png
Binary file browser/themes/pinstripe/browser/tabbrowser/tab-middle-hover.png has changed
diff -r 1aecd2a9914d browser/themes/pinstripe/browser/tabbrowser/tab-middle-inactive.png
Binary file browser/themes/pinstripe/browser/tabbrowser/tab-middle-inactive.png has changed
diff -r 1aecd2a9914d browser/themes/pinstripe/browser/tabbrowser/tab-middle.png
Binary file browser/themes/pinstripe/browser/tabbrowser/tab-middle.png has changed
diff -r 1aecd2a9914d browser/themes/pinstripe/browser/tabbrowser/tab-right-hover.png
Binary file browser/themes/pinstripe/browser/tabbrowser/tab-right-hover.png has changed
diff -r 1aecd2a9914d browser/themes/pinstripe/browser/tabbrowser/tab-right-inactive.png
Binary file browser/themes/pinstripe/browser/tabbrowser/tab-right-inactive.png has changed
diff -r 1aecd2a9914d browser/themes/pinstripe/browser/tabbrowser/tab-right.png
Binary file browser/themes/pinstripe/browser/tabbrowser/tab-right.png has changed
diff -r 1aecd2a9914d config/autoconf.mk.in
--- a/config/autoconf.mk.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/config/autoconf.mk.in	Thu Sep 18 08:03:22 2008 -0500
@@ -639,8 +639,10 @@ VISIBILITY_FLAGS = @VISIBILITY_FLAGS@
 VISIBILITY_FLAGS = @VISIBILITY_FLAGS@
 WRAP_SYSTEM_INCLUDES = @WRAP_SYSTEM_INCLUDES@
 
 MOZ_V1_STRING_ABI = @MOZ_V1_STRING_ABI@
 
 MOZ_EMBEDDING_LEVEL_DEFAULT = @MOZ_EMBEDDING_LEVEL_DEFAULT@
 MOZ_EMBEDDING_LEVEL_BASIC = @MOZ_EMBEDDING_LEVEL_BASIC@
 MOZ_EMBEDDING_LEVEL_MINIMAL = @MOZ_EMBEDDING_LEVEL_MINIMAL@
+
+HAVE_ARM_SIMD= @HAVE_ARM_SIMD@
diff -r 1aecd2a9914d configure.in
--- a/configure.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/configure.in	Thu Sep 18 08:03:22 2008 -0500
@@ -1869,21 +1869,26 @@ case "$target" in
 *-wince*)
 
     MOZ_TOOLS_DIR=`echo $MOZ_TOOLS`
     AR_LIST="$AR -list"
     AR_EXTRACT="$AR -extract"
     AR_DELETE="$AR d"
     AR_FLAGS='-OUT:"$@"'
 
+    if test -z "$AS_BIN"; then
+        AS="$AS_BIN"
+    fi
     DSO_CFLAGS=
     DSO_PIC_CFLAGS=
     DLL_SUFFIX=.dll
     BIN_SUFFIX='.exe'
-    RC=rc.exe
+    if test -z "$RC"; then 
+        RC=rc.exe  
+    fi
     # certain versions of cygwin's makedepend barf on the 
     # #include <string> vs -I./dist/include/string issue so don't use it
     SYSTEM_MAKEDEPEND=
 
     HOST_CC=cl
     HOST_CXX=cl
     HOST_LD=link
     HOST_AR='lib -OUT:$@'
@@ -2980,16 +2985,27 @@ AC_CHECK_HEADERS(X11/XKBlib.h)
 
 dnl These are all the places some variant of statfs can be hiding.
 AC_CHECK_HEADERS(sys/statvfs.h sys/statfs.h sys/vfs.h sys/mount.h)
 
 dnl Try for MMX support
 dnl NB - later gcc versions require -mmmx for this header to be successfully
 dnl included (or another option which implies it, such as -march=pentium-mmx)
 AC_CHECK_HEADERS(mmintrin.h)
+
+AC_MSG_CHECKING(for ARM SIMD support)
+AC_TRY_COMPILE([],
+               [asm("uqadd8 r1, r1, r2");],
+               result="yes", result="no")
+AC_MSG_RESULT("$result")
+if test "$result" = "yes"; then
+    AC_DEFINE(HAVE_ARM_SIMD)
+    HAVE_ARM_SIMD=1
+fi
+AC_SUBST(HAVE_ARM_SIMD)
 
 dnl Check whether the compiler supports the new-style C++ standard
 dnl library headers (i.e. <new>) or needs the old "new.h"
 AC_LANG_CPLUSPLUS
 NEW_H=new.h
 AC_CHECK_HEADER(new, [NEW_H=new])
 AC_DEFINE_UNQUOTED(NEW_H, <$NEW_H>)
 AC_LANG_C
diff -r 1aecd2a9914d content/base/src/nsContentUtils.cpp
--- a/content/base/src/nsContentUtils.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/content/base/src/nsContentUtils.cpp	Thu Sep 18 08:03:22 2008 -0500
@@ -405,16 +405,17 @@ nsContentUtils::InitializeEventTable() {
     { &nsGkAtoms::onDOMNodeRemoved,              { NS_MUTATION_NODEREMOVED, EventNameType_HTMLXUL }},
     { &nsGkAtoms::onDOMNodeInsertedIntoDocument, { NS_MUTATION_NODEINSERTEDINTODOCUMENT, EventNameType_HTMLXUL }},
     { &nsGkAtoms::onDOMNodeRemovedFromDocument,  { NS_MUTATION_NODEREMOVEDFROMDOCUMENT, EventNameType_HTMLXUL }},
     { &nsGkAtoms::onDOMSubtreeModified,          { NS_MUTATION_SUBTREEMODIFIED, EventNameType_HTMLXUL }},
     { &nsGkAtoms::onDOMActivate,                 { NS_UI_ACTIVATE, EventNameType_HTMLXUL }},
     { &nsGkAtoms::onDOMFocusIn,                  { NS_UI_FOCUSIN, EventNameType_HTMLXUL }},
     { &nsGkAtoms::onDOMFocusOut,                 { NS_UI_FOCUSOUT, EventNameType_HTMLXUL }},
     { &nsGkAtoms::onDOMMouseScroll,              { NS_MOUSE_SCROLL, EventNameType_HTMLXUL }},
+    { &nsGkAtoms::onMozMousePixelScroll,         { NS_MOUSE_PIXEL_SCROLL, EventNameType_HTMLXUL }},
     { &nsGkAtoms::oninput,                       { NS_FORM_INPUT, EventNameType_HTMLXUL }},
     { &nsGkAtoms::onpageshow,                    { NS_PAGE_SHOW, EventNameType_HTML }},
     { &nsGkAtoms::onpagehide,                    { NS_PAGE_HIDE, EventNameType_HTML }},
     { &nsGkAtoms::onresize,                      { NS_RESIZE_EVENT,
                                                  (EventNameType_HTMLXUL | EventNameType_SVGSVG) }},
     { &nsGkAtoms::onscroll,                      { NS_SCROLL_EVENT,
                                                  (EventNameType_HTMLXUL | EventNameType_SVGSVG) }},
     { &nsGkAtoms::oncopy,                        { NS_COPY, EventNameType_HTMLXUL }},
@@ -3894,26 +3895,20 @@ nsContentUtils::TriggerLink(nsIContent *
     handler->OnLinkClick(aContent, aLinkURI, aTargetSpec.get());
   }
 }
 
 /* static */
 nsIWidget*
 nsContentUtils::GetTopLevelWidget(nsIWidget* aWidget)
 {
-  if (!aWidget) {
-    return nsnull;
-  }
-
-  nsIWidget* currWidget = aWidget;
-  nsIWidget* parentWidget;
-  while ((parentWidget = currWidget->GetParent()) != nsnull) {
-    currWidget = parentWidget;
-  }
-  return currWidget;
+  if (!aWidget)
+    return nsnull;
+
+  return aWidget->GetTopLevelWidget();
 }
 
 /* static */
 const nsDependentString
 nsContentUtils::GetLocalizedEllipsis()
 {
   static PRUnichar sBuf[4] = { 0, 0, 0, 0 };
   if (!sBuf[0]) {
diff -r 1aecd2a9914d content/base/src/nsGkAtomList.h
--- a/content/base/src/nsGkAtomList.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/content/base/src/nsGkAtomList.h	Thu Sep 18 08:03:22 2008 -0500
@@ -636,16 +636,17 @@ GK_ATOM(onLoad, "onLoad")
 GK_ATOM(onLoad, "onLoad")
 GK_ATOM(onload, "onload")
 GK_ATOM(only, "only")               // this one is not an event
 GK_ATOM(onmousedown, "onmousedown")
 GK_ATOM(onmousemove, "onmousemove")
 GK_ATOM(onmouseout, "onmouseout")
 GK_ATOM(onmouseover, "onmouseover")
 GK_ATOM(onmouseup, "onmouseup")
+GK_ATOM(onMozMousePixelScroll, "onMozMousePixelScroll")
 GK_ATOM(ononline, "ononline")
 GK_ATOM(onoffline, "onoffline")
 GK_ATOM(onoverflow, "onoverflow")
 GK_ATOM(onoverflowchanged, "onoverflowchanged")
 GK_ATOM(onpagehide, "onpagehide")
 GK_ATOM(onpageshow, "onpageshow")
 GK_ATOM(onpaint, "onpaint")
 GK_ATOM(onpaste, "onpaste")
diff -r 1aecd2a9914d content/base/src/nsRange.cpp
--- a/content/base/src/nsRange.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/content/base/src/nsRange.cpp	Thu Sep 18 08:03:22 2008 -0500
@@ -1751,17 +1751,37 @@ nsresult nsRange::InsertNode(nsIDOMNode*
   
   nsCOMPtr<nsIDOMNode> tResultNode;
   return tStartContainer->InsertBefore(aN, tChildNode, getter_AddRefs(tResultNode));
 }
 
 nsresult nsRange::SurroundContents(nsIDOMNode* aNewParent)
 {
   VALIDATE_ACCESS(aNewParent);
-  
+
+  NS_ENSURE_TRUE(mRoot, NS_ERROR_DOM_INVALID_STATE_ERR);
+  // BAD_BOUNDARYPOINTS_ERR: Raised if the Range partially selects a non-text
+  // node.
+  if (mStartParent != mEndParent) {
+    PRBool startIsText = mStartParent->IsNodeOfType(nsINode::eTEXT);
+    PRBool endIsText = mEndParent->IsNodeOfType(nsINode::eTEXT);
+    nsINode* startGrandParent = mStartParent->GetNodeParent();
+    nsINode* endGrandParent = mEndParent->GetNodeParent();
+    NS_ENSURE_TRUE((startIsText && endIsText &&
+                    startGrandParent &&
+                    startGrandParent == endGrandParent) ||
+                   (startIsText &&
+                    startGrandParent &&
+                    startGrandParent == mEndParent) ||
+                   (endIsText &&
+                    endGrandParent &&
+                    endGrandParent == mStartParent),
+                   NS_ERROR_DOM_RANGE_BAD_BOUNDARYPOINTS_ERR);
+  }
+
   // Extract the contents within the range.
 
   nsCOMPtr<nsIDOMDocumentFragment> docFrag;
 
   nsresult res = ExtractContents(getter_AddRefs(docFrag));
 
   if (NS_FAILED(res)) return res;
   if (!docFrag) return NS_ERROR_FAILURE;
diff -r 1aecd2a9914d content/base/test/Makefile.in
--- a/content/base/test/Makefile.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/content/base/test/Makefile.in	Thu Sep 18 08:03:22 2008 -0500
@@ -205,16 +205,17 @@ _TEST_FILES = 	test_bug5141.html \
 		file_bug445225_multipart.txt \
 		file_bug445225_multipart.txt^headers^ \
 		test_title.html \
 		test_bug453521.html \
 		test_bug391728.html \
 		file_bug391728.html \
 		file_bug391728_2.html \
 		test_bug368972.html \
+		test_bug454326.html \
 		$(NULL)
 
 libs:: $(_TEST_FILES)
 	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
 
 check::
 	@$(EXIT_ON_ERROR) \
 	for f in $(subst .cpp,,$(CPP_UNIT_TESTS)); do \
diff -r 1aecd2a9914d content/base/test/test_bug454326.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/content/base/test/test_bug454326.html	Thu Sep 18 08:03:22 2008 -0500
@@ -0,0 +1,130 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=454326
+-->
+<head>
+  <title>Test for Bug 454326</title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=454326">Mozilla Bug 454326</a>
+<p id="display"></p>
+<div id="content" style="display: none">
+</div>
+
+<div id="partial-text-selection">Hello Hello <div></div>World!</div>
+<div id="partial-element-selection"><div id="begin">Hello Hello </div><div></div><div id="end">World!</div></div>
+<pre id="test">
+<script class="testbody" type="text/javascript">
+
+/** Test for Bug 454326 **/
+
+  function reinitPartialTextSelection() {
+    var pts = document.getElementById("partial-text-selection");
+    pts.textContent = null;
+    pts.appendChild(document.createTextNode("Hello Hello "));
+    pts.appendChild(document.createElement("div"));
+    pts.appendChild(document.createTextNode("World!"));
+  }
+
+
+  function doTest() {
+    var pts = document.getElementById("partial-text-selection");
+    var ex = null;
+    try {
+      var r1 = document.createRange();
+      r1.setStart(pts.firstChild, 6);
+      r1.setEnd(pts.lastChild, 6);
+      is(r1.toString(), "Hello World!", "Wrong range!");
+      r1.surroundContents(document.createElement("div"));
+      is(r1.toString(), "Hello World!", "Wrong range!");
+    } catch(e) {
+      ex = e;
+    }
+    is(ex, null, "Unexpected exception!");
+
+    reinitPartialTextSelection();
+    ex = null;
+    try {
+      var r2 = document.createRange();
+      r2.setStart(pts.firstChild, 6);
+      r2.setEnd(pts, 2);
+      is(r2.toString(), "Hello ", "Wrong range!");
+      r2.surroundContents(document.createElement("div"));
+      is(r2.toString(), "Hello ", "Wrong range!");
+    } catch(e) {
+      ex = e;
+    }
+    is(ex, null, "Unexpected exception!");
+
+    reinitPartialTextSelection();
+    ex = null;
+    try {
+      var r3 = document.createRange();
+      r3.setStart(pts, 1);
+      r3.setEnd(pts.lastChild, 6);
+      is(r3.toString(), "World!", "Wrong range!");
+      r3.surroundContents(document.createElement("div"));
+      is(r3.toString(), "World!", "Wrong range!");
+    } catch(e) {
+      ex = e;
+    }
+    is(ex, null, "Unexpected exception!");
+
+    reinitPartialTextSelection();
+    ex = null;
+    try {
+      var r3 = document.createRange();
+      r3.setStart(pts.firstChild, 6);
+      r3.setEnd(pts.firstChild.nextSibling, 0);
+      is(r3.toString(), "Hello ", "Wrong range!");
+      r3.surroundContents(document.createElement("div"));
+      is(r3.toString(), "Hello ", "Wrong range!");
+    } catch(e) {
+      ex = e;
+      is(e.code, 1, "Didn't get BAD_BOUNDARYPOINTS_ERR exception!");
+    }
+    ok(ex, "There should have been an exception!");
+
+    reinitPartialTextSelection();
+    ex = null;
+    try {
+      var r3 = document.createRange();
+      r3.setStart(pts.firstChild.nextSibling, 0);
+      r3.setEnd(pts.lastChild, 6);
+      is(r3.toString(), "World!", "Wrong range!");
+      r3.surroundContents(document.createElement("div"));
+      is(r3.toString(), "World!", "Wrong range!");
+    } catch(e) {
+      ex = e;
+      is(e.code, 1, "Didn't get BAD_BOUNDARYPOINTS_ERR exception!");
+    }
+    ok(ex, "There should have been an exception!");
+
+    ex = null;
+    try {
+      var pes = document.getElementById("partial-element-selection");
+      var r4 = document.createRange();
+      r4.setStart(pes.firstChild.firstChild, 6);
+      r4.setEnd(pes.lastChild.firstChild, 6);
+      is(r4.toString(), "Hello World!", "Wrong range!");
+      r4.surroundContents(document.createElement("div"));
+      is(r4.toString(), "Hello World!", "Wrong range!");
+    } catch(e) {
+      ex = e;
+      is(e.code, 1, "Didn't get BAD_BOUNDARYPOINTS_ERR exception!");
+    }
+    ok(ex, "There should have been an exception!");
+  }
+
+  SimpleTest.waitForExplicitFinish();
+  addLoadEvent(doTest);
+  addLoadEvent(SimpleTest.finish);
+</script>
+</pre>
+</body>
+</html>
+
diff -r 1aecd2a9914d content/events/src/nsDOMEvent.cpp
--- a/content/events/src/nsDOMEvent.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/content/events/src/nsDOMEvent.cpp	Thu Sep 18 08:03:22 2008 -0500
@@ -65,18 +65,18 @@ static const char* const sEventNames[] =
   "popuphiding", "popuphidden", "close", "command", "broadcast", "commandupdate",
   "dragenter", "dragover", "dragexit", "dragdrop", "draggesture",
   "drag", "dragend", "dragstart", "dragleave", "drop", "resize",
   "scroll", "overflow", "underflow", "overflowchanged",
   "DOMSubtreeModified", "DOMNodeInserted", "DOMNodeRemoved", 
   "DOMNodeRemovedFromDocument", "DOMNodeInsertedIntoDocument",
   "DOMAttrModified", "DOMCharacterDataModified",
   "DOMActivate", "DOMFocusIn", "DOMFocusOut",
-  "pageshow", "pagehide", "DOMMouseScroll", "offline", "online",
-  "copy", "cut", "paste"
+  "pageshow", "pagehide", "DOMMouseScroll", "MozMousePixelScroll",
+  "offline", "online", "copy", "cut", "paste"
 #ifdef MOZ_SVG
  ,
   "SVGLoad", "SVGUnload", "SVGAbort", "SVGError", "SVGResize", "SVGScroll",
   "SVGZoom"
 #endif // MOZ_SVG
 #ifdef MOZ_MEDIA
   ,
   "loadstart", "progress", "loadedmetadata", "loadedfirstframe",
@@ -474,16 +474,18 @@ nsDOMEvent::SetEventType(const nsAString
       mEvent->message = NS_MOUSE_EXIT_SYNTH;
     else if (atom == nsGkAtoms::onmousemove)
       mEvent->message = NS_MOUSE_MOVE;
     else if (atom == nsGkAtoms::oncontextmenu)
       mEvent->message = NS_CONTEXTMENU;
   } else if (mEvent->eventStructType == NS_MOUSE_SCROLL_EVENT) {
     if (atom == nsGkAtoms::onDOMMouseScroll)
       mEvent->message = NS_MOUSE_SCROLL;
+    else if (atom == nsGkAtoms::onMozMousePixelScroll)
+      mEvent->message = NS_MOUSE_PIXEL_SCROLL;
   } else if (mEvent->eventStructType == NS_DRAG_EVENT) {
     if (atom == nsGkAtoms::ondragstart)
       mEvent->message = NS_DRAGDROP_START;
     else if (atom == nsGkAtoms::ondraggesture)
       mEvent->message = NS_DRAGDROP_GESTURE;
     else if (atom == nsGkAtoms::ondragenter)
       mEvent->message = NS_DRAGDROP_ENTER;
     else if (atom == nsGkAtoms::ondragover)
@@ -1388,16 +1390,18 @@ const char* nsDOMEvent::GetEventName(PRU
   case NS_UI_FOCUSOUT:
     return sEventNames[eDOMEvents_DOMFocusOut];
   case NS_PAGE_SHOW:
     return sEventNames[eDOMEvents_pageshow];
   case NS_PAGE_HIDE:
     return sEventNames[eDOMEvents_pagehide];
   case NS_MOUSE_SCROLL:
     return sEventNames[eDOMEvents_DOMMouseScroll];
+  case NS_MOUSE_PIXEL_SCROLL:
+    return sEventNames[eDOMEvents_MozMousePixelScroll];
   case NS_OFFLINE:
     return sEventNames[eDOMEvents_offline];
   case NS_ONLINE:
     return sEventNames[eDOMEvents_online];
   case NS_COPY:
     return sEventNames[eDOMEvents_copy];
   case NS_CUT:
     return sEventNames[eDOMEvents_cut];
diff -r 1aecd2a9914d content/events/src/nsDOMEvent.h
--- a/content/events/src/nsDOMEvent.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/content/events/src/nsDOMEvent.h	Thu Sep 18 08:03:22 2008 -0500
@@ -119,16 +119,17 @@ public:
     eDOMEvents_attrmodified,
     eDOMEvents_characterdatamodified,
     eDOMEvents_DOMActivate,
     eDOMEvents_DOMFocusIn,
     eDOMEvents_DOMFocusOut,
     eDOMEvents_pageshow,
     eDOMEvents_pagehide,
     eDOMEvents_DOMMouseScroll,
+    eDOMEvents_MozMousePixelScroll,
     eDOMEvents_offline,
     eDOMEvents_online,
     eDOMEvents_copy,
     eDOMEvents_cut,
     eDOMEvents_paste
 #ifdef MOZ_SVG
    ,
     eDOMEvents_SVGLoad,
diff -r 1aecd2a9914d content/events/src/nsEventStateManager.cpp
--- a/content/events/src/nsEventStateManager.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/content/events/src/nsEventStateManager.cpp	Thu Sep 18 08:03:22 2008 -0500
@@ -108,17 +108,17 @@
 #include "nsIDOMDocument.h"
 #include "nsIDOMKeyEvent.h"
 #include "nsIObserverService.h"
 #include "nsIDocShell.h"
 #include "nsIMarkupDocumentViewer.h"
 #include "nsIScrollableViewProvider.h"
 #include "nsIDOMDocumentRange.h"
 #include "nsIDOMDocumentEvent.h"
-#include "nsIDOMMouseEvent.h"
+#include "nsIDOMMouseScrollEvent.h"
 #include "nsIDOMDragEvent.h"
 #include "nsIDOMEventTarget.h"
 #include "nsIDOMDocumentView.h"
 #include "nsIDOMNSUIEvent.h"
 #include "nsDOMDragEvent.h"
 
 #include "nsIDOMRange.h"
 #include "nsCaret.h"
@@ -136,16 +136,17 @@
 #include "imgIContainer.h"
 #include "nsIProperties.h"
 #include "nsISupportsPrimitives.h"
 #include "nsEventDispatcher.h"
 #include "nsPresShellIterator.h"
 
 #include "nsServiceManagerUtils.h"
 #include "nsITimer.h"
+#include "nsIFontMetrics.h"
 
 #include "nsIDragService.h"
 #include "nsIDragSession.h"
 #include "nsDOMDataTransfer.h"
 #include "nsContentAreaDragDrop.h"
 #ifdef MOZ_XUL
 #include "nsITreeBoxObject.h"
 #endif
@@ -455,17 +456,19 @@ nsEventStateManager::nsEventStateManager
     mLastFocusedWith(eEventFocusedByUnknown),
     mPresContext(nsnull),
     mLClickCount(0),
     mMClickCount(0),
     mRClickCount(0),
     mNormalLMouseEventInProcess(PR_FALSE),
     m_haveShutdown(PR_FALSE),
     mBrowseWithCaret(PR_FALSE),
-    mTabbedThroughDocument(PR_FALSE)
+    mTabbedThroughDocument(PR_FALSE),
+    mLastLineScrollConsumedX(PR_FALSE),
+    mLastLineScrollConsumedY(PR_FALSE)
 {
   if (sESMInstanceCount == 0) {
     gUserInteractionTimerCallback = new nsUITimerCallback();
     if (gUserInteractionTimerCallback) {
       NS_ADDREF(gUserInteractionTimerCallback);
       CallCreateInstance("@mozilla.org/timer;1", &gUserInteractionTimer);
       if (gUserInteractionTimer) {
         gUserInteractionTimer->InitWithCallback(gUserInteractionTimerCallback,
@@ -1402,16 +1405,30 @@ nsEventStateManager::PreHandleEvent(nsPr
            (msEvent->scrollFlags & nsMouseScrollEvent::kIsFullPage)) ||
           action == MOUSE_SCROLL_PAGE) {
           msEvent->delta = (msEvent->delta > 0)
             ? nsIDOMNSUIEvent::SCROLL_PAGE_DOWN
             : nsIDOMNSUIEvent::SCROLL_PAGE_UP;
       }
     }
     break;
+  case NS_MOUSE_PIXEL_SCROLL:
+    {
+      if (mCurrentFocus) {
+        mCurrentTargetContent = mCurrentFocus;
+      }
+
+      // When the last line scroll has been canceled, eat the pixel scroll event
+      nsMouseScrollEvent *msEvent = static_cast<nsMouseScrollEvent*>(aEvent);
+      if ((msEvent->scrollFlags & nsMouseScrollEvent::kIsHorizontal) ?
+           mLastLineScrollConsumedX : mLastLineScrollConsumedY) {
+        *aStatus = nsEventStatus_eConsumeNoDefault;
+      }
+    }
+    break;
   case NS_QUERY_SELECTED_TEXT:
     {
       nsQueryContentEventHandler handler(mPresContext);
       handler.OnQuerySelectedText((nsQueryContentEvent*)aEvent);
     }
     break;
   case NS_QUERY_TEXT_CONTENT:
     {
@@ -2409,16 +2426,76 @@ GetParentFrameToScroll(nsPresContext* aP
     return nsnull;
 
   if (aFrame->GetStyleDisplay()->mPosition == NS_STYLE_POSITION_FIXED)
     return aPresContext->GetPresShell()->GetRootScrollFrame();
 
   return aFrame->GetParent();
 }
 
+static nsIScrollableView*
+GetScrollableViewForFrame(nsPresContext* aPresContext, nsIFrame* aFrame)
+{
+  for (; aFrame; aFrame = GetParentFrameToScroll(aPresContext, aFrame)) {
+    nsIScrollableViewProvider* svp;
+    CallQueryInterface(aFrame, &svp);
+    if (svp) {
+      nsIScrollableView* scrollView = svp->GetScrollableView();
+      if (scrollView)
+        return scrollView;
+    }
+  }
+  return nsnull;
+}
+
+void
+nsEventStateManager::SendPixelScrollEvent(nsIFrame* aTargetFrame,
+                                          nsMouseScrollEvent* aEvent,
+                                          nsPresContext* aPresContext,
+                                          nsEventStatus* aStatus)
+{
+  nsCOMPtr<nsIContent> targetContent = aTargetFrame->GetContent();
+  if (!targetContent)
+    GetFocusedContent(getter_AddRefs(targetContent));
+  if (!targetContent)
+    return;
+
+  while (targetContent->IsNodeOfType(nsINode::eTEXT)) {
+    targetContent = targetContent->GetParent();
+  }
+
+  nsIScrollableView* scrollView = GetScrollableViewForFrame(aPresContext, aTargetFrame);
+  nscoord lineHeight = 0;
+  if (scrollView) {
+    scrollView->GetLineHeight(&lineHeight);
+  } else {
+    // Fall back to the font height of the target frame.
+    const nsStyleFont* font = aTargetFrame->GetStyleFont();
+    const nsFont& f = font->mFont;
+    nsCOMPtr<nsIFontMetrics> fm = aPresContext->GetMetricsFor(f);
+    NS_ASSERTION(fm, "FontMetrics is null!");
+    if (fm)
+      fm->GetHeight(lineHeight);
+  }
+
+  PRBool isTrusted = (aEvent->flags & NS_EVENT_FLAG_TRUSTED) != 0;
+  nsMouseScrollEvent event(isTrusted, NS_MOUSE_PIXEL_SCROLL, nsnull);
+  event.refPoint = aEvent->refPoint;
+  event.widget = aEvent->widget;
+  event.time = aEvent->time;
+  event.isShift = aEvent->isShift;
+  event.isControl = aEvent->isControl;
+  event.isAlt = aEvent->isAlt;
+  event.isMeta = aEvent->isMeta;
+  event.scrollFlags = aEvent->scrollFlags;
+  event.delta = aPresContext->AppUnitsToIntCSSPixels(aEvent->delta * lineHeight);
+
+  nsEventDispatcher::Dispatch(targetContent, aPresContext, &event, nsnull, aStatus);
+}
+
 nsresult
 nsEventStateManager::DoScrollText(nsPresContext* aPresContext,
                                   nsIFrame* aTargetFrame,
                                   nsInputEvent* aEvent,
                                   PRInt32 aNumLines,
                                   PRBool aScrollHorizontal,
                                   ScrollQuantity aScrollQuantity)
 {
@@ -2727,89 +2804,116 @@ nsEventStateManager::PostHandleEvent(nsP
           }
         }
         nsCOMPtr<nsFrameSelection> frameSelection = shell->FrameSelection();
         frameSelection->SetMouseDownState(PR_FALSE);
       }
     }
     break;
   case NS_MOUSE_SCROLL:
-    if (nsEventStatus_eConsumeNoDefault != *aStatus) {
-
-      // Build the preference keys, based on the event properties.
-      nsMouseScrollEvent *msEvent = (nsMouseScrollEvent*) aEvent;
-
-      NS_NAMED_LITERAL_CSTRING(actionslot,      ".action");
-      NS_NAMED_LITERAL_CSTRING(sysnumlinesslot, ".sysnumlines");
-
-      nsCAutoString baseKey;
-      GetBasePrefKeyForMouseWheel(msEvent, baseKey);
-
-      // Extract the preferences
-      nsCAutoString actionKey(baseKey);
-      actionKey.Append(actionslot);
-
-      nsCAutoString sysNumLinesKey(baseKey);
-      sysNumLinesKey.Append(sysnumlinesslot);
-
-      PRInt32 action = nsContentUtils::GetIntPref(actionKey.get());
-      PRBool useSysNumLines =
-        nsContentUtils::GetBoolPref(sysNumLinesKey.get());
-
-      if (useSysNumLines) {
-        if (msEvent->scrollFlags & nsMouseScrollEvent::kIsFullPage)
-          action = MOUSE_SCROLL_PAGE;
-        else if (msEvent->scrollFlags & nsMouseScrollEvent::kIsPixels)
-          action = MOUSE_SCROLL_PIXELS;
-      }
-
-      switch (action) {
-      case MOUSE_SCROLL_N_LINES:
-        {
-          DoScrollText(presContext, aTargetFrame, msEvent, msEvent->delta,
-                       (msEvent->scrollFlags & nsMouseScrollEvent::kIsHorizontal),
-                       eScrollByLine);
-        }
-        break;
-
-      case MOUSE_SCROLL_PAGE:
-        {
-          DoScrollText(presContext, aTargetFrame, msEvent, msEvent->delta,
-                       (msEvent->scrollFlags & nsMouseScrollEvent::kIsHorizontal),
-                       eScrollByPage);
-        }
-        break;
-
-      case MOUSE_SCROLL_PIXELS:
-        {
-          DoScrollText(presContext, aTargetFrame, msEvent, msEvent->delta,
-                       (msEvent->scrollFlags & nsMouseScrollEvent::kIsHorizontal),
-                       eScrollByPixel);
-        }
-        break;
-
-      case MOUSE_SCROLL_HISTORY:
-        {
-          DoScrollHistory(msEvent->delta);
-        }
-        break;
-
-      case MOUSE_SCROLL_ZOOM:
-        {
-          DoScrollZoom(aTargetFrame, msEvent->delta);
-        }
-        break;
-
-      default:  // Including -1 (do nothing)
-        break;
-      }
-      *aStatus = nsEventStatus_eConsumeNoDefault;
-
-    }
-
+  case NS_MOUSE_PIXEL_SCROLL:
+    {
+      nsMouseScrollEvent *msEvent = static_cast<nsMouseScrollEvent*>(aEvent);
+
+      if (aEvent->message == NS_MOUSE_SCROLL) {
+        // Mark the subsequent pixel scrolls as valid / invalid, based on the
+        // observation if the previous line scroll has been canceled
+        if (msEvent->scrollFlags & nsMouseScrollEvent::kIsHorizontal) {
+          mLastLineScrollConsumedX = (nsEventStatus_eConsumeNoDefault == *aStatus);
+        } else if (msEvent->scrollFlags & nsMouseScrollEvent::kIsVertical) {
+          mLastLineScrollConsumedY = (nsEventStatus_eConsumeNoDefault == *aStatus);
+        }
+        if (!(msEvent->scrollFlags & nsMouseScrollEvent::kHasPixels)) {
+          // No generated pixel scroll event will follow.
+          // Create and send a pixel scroll DOM event now.
+          SendPixelScrollEvent(aTargetFrame, msEvent, presContext, aStatus);
+        }
+      }
+
+      if (*aStatus != nsEventStatus_eConsumeNoDefault) {
+        // Build the preference keys, based on the event properties.
+        NS_NAMED_LITERAL_CSTRING(actionslot,      ".action");
+        NS_NAMED_LITERAL_CSTRING(sysnumlinesslot, ".sysnumlines");
+
+        nsCAutoString baseKey;
+        GetBasePrefKeyForMouseWheel(msEvent, baseKey);
+
+        // Extract the preferences
+        nsCAutoString actionKey(baseKey);
+        actionKey.Append(actionslot);
+
+        nsCAutoString sysNumLinesKey(baseKey);
+        sysNumLinesKey.Append(sysnumlinesslot);
+
+        PRInt32 action = nsContentUtils::GetIntPref(actionKey.get());
+        PRBool useSysNumLines =
+          nsContentUtils::GetBoolPref(sysNumLinesKey.get());
+
+        if (useSysNumLines) {
+          if (msEvent->scrollFlags & nsMouseScrollEvent::kIsFullPage)
+            action = MOUSE_SCROLL_PAGE;
+        }
+
+        if (aEvent->message == NS_MOUSE_PIXEL_SCROLL) {
+          if (action == MOUSE_SCROLL_N_LINES) {
+             action = MOUSE_SCROLL_PIXELS;
+          } else {
+            // Do not scroll pixels when zooming
+            action = -1;
+          }
+        } else if (msEvent->scrollFlags & nsMouseScrollEvent::kHasPixels) {
+          if (action == MOUSE_SCROLL_N_LINES) {
+            // We shouldn't scroll lines when a pixel scroll event will follow.
+            action = -1;
+          }
+        }
+
+        switch (action) {
+        case MOUSE_SCROLL_N_LINES:
+          {
+            DoScrollText(presContext, aTargetFrame, msEvent, msEvent->delta,
+                         (msEvent->scrollFlags & nsMouseScrollEvent::kIsHorizontal),
+                         eScrollByLine);
+          }
+          break;
+
+        case MOUSE_SCROLL_PAGE:
+          {
+            DoScrollText(presContext, aTargetFrame, msEvent, msEvent->delta,
+                         (msEvent->scrollFlags & nsMouseScrollEvent::kIsHorizontal),
+                         eScrollByPage);
+          }
+          break;
+
+        case MOUSE_SCROLL_PIXELS:
+          {
+            DoScrollText(presContext, aTargetFrame, msEvent, msEvent->delta,
+                         (msEvent->scrollFlags & nsMouseScrollEvent::kIsHorizontal),
+                         eScrollByPixel);
+          }
+          break;
+
+        case MOUSE_SCROLL_HISTORY:
+          {
+            DoScrollHistory(msEvent->delta);
+          }
+          break;
+
+        case MOUSE_SCROLL_ZOOM:
+          {
+            DoScrollZoom(aTargetFrame, msEvent->delta);
+          }
+          break;
+
+        default:  // Including -1 (do nothing)
+          break;
+        }
+        *aStatus = nsEventStatus_eConsumeNoDefault;
+      }
+    }
     break;
 
   case NS_DRAGDROP_ENTER:
   case NS_DRAGDROP_OVER:
     {
       NS_ASSERTION(aEvent->eventStructType == NS_DRAG_EVENT, "Expected a drag event");
 
       nsCOMPtr<nsIDragSession> dragSession = nsContentUtils::GetDragSession();
diff -r 1aecd2a9914d content/events/src/nsEventStateManager.h
--- a/content/events/src/nsEventStateManager.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/content/events/src/nsEventStateManager.h	Thu Sep 18 08:03:22 2008 -0500
@@ -290,16 +290,20 @@ protected:
                        nsIDocShellTreeItem** aResult);
 
   // These functions are for mousewheel scrolling
   nsresult GetParentScrollingView(nsInputEvent* aEvent,
                                   nsPresContext* aPresContext,
                                   nsIFrame* &targetOuterFrame,
                                   nsPresContext* &presCtxOuter);
 
+  void SendPixelScrollEvent(nsIFrame* aTargetFrame,
+                            nsMouseScrollEvent* aEvent,
+                            nsPresContext* aPresContext,
+                            nsEventStatus* aStatus);
   typedef enum {
     eScrollByPixel,
     eScrollByLine,
     eScrollByPage
   } ScrollQuantity;
   nsresult DoScrollText(nsPresContext* aPresContext,
                         nsIFrame* aTargetFrame,
                         nsInputEvent* aEvent,
@@ -440,16 +444,20 @@ protected:
   // Recursion guard for tabbing
   PRPackedBool mTabbedThroughDocument;
 
   // Array for accesskey support
   nsCOMArray<nsIContent> mAccessKeys;
 
   nsCOMArray<nsIDocShell> mTabbingFromDocShells;
 
+  // Unlocks pixel scrolling
+  PRPackedBool mLastLineScrollConsumedX;
+  PRPackedBool mLastLineScrollConsumedY;
+
 #ifdef CLICK_HOLD_CONTEXT_MENUS
   enum { kClickHoldDelay = 500 } ;        // 500ms == 1/2 second
 
   void CreateClickHoldTimer ( nsPresContext* aPresContext, nsIFrame* inDownFrame,
                               nsGUIEvent* inMouseDownEvent ) ;
   void KillClickHoldTimer ( ) ;
   void FireContextClick ( ) ;
   static void sClickHoldCallback ( nsITimer* aTimer, void* aESM ) ;
diff -r 1aecd2a9914d content/events/test/Makefile.in
--- a/content/events/test/Makefile.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/content/events/test/Makefile.in	Thu Sep 18 08:03:22 2008 -0500
@@ -46,16 +46,17 @@ include $(topsrcdir)/config/rules.mk
 
 _TEST_FILES = \
 		test_bug238987.html \
 		test_bug288392.html \
 		test_bug328885.html \
 		test_bug336682_1.html \
 		test_bug336682_2.xul \
 		test_bug336682.js \
+		test_bug350471.xul \
 		test_bug367781.html \
 		test_bug368835.html \
 		test_bug379120.html \
 		test_bug391568.xhtml \
 		test_bug402089.html \
 		test_bug405632.html \
 		test_bug409604.html \
 		test_bug412567.html \
diff -r 1aecd2a9914d content/events/test/test_bug350471.xul
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/content/events/test/test_bug350471.xul	Thu Sep 18 08:03:22 2008 -0500
@@ -0,0 +1,236 @@
+<?xml version="1.0"?>
+<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
+<?xml-stylesheet href="/tests/SimpleTest/test.css" type="text/css"?>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=350471
+-->
+<window title="Mozilla Bug 350471"
+  xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
+
+  <title>Test for Bug 350471</title>
+  <script type="application/javascript" src="/MochiKit/packed.js" />
+  <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"/>
+  <script type="application/javascript" src="/tests/SimpleTest/EventUtils.js"/>
+<body  xmlns="http://www.w3.org/1999/xhtml">
+  <a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=350471">Mozilla Bug 350471</a>
+
+  <p id="display"></p>
+<div id="content" style="display: none">
+</div>
+</body>
+
+<vbox style="height: 150px; background: cyan; overflow: auto;" id="scrollbox">
+  <hbox style="height: 8000px;"><vbox style="width: 8000px;"/></hbox>
+</vbox>
+
+<script class="testbody" type="application/javascript;version=1.7"><![CDATA[
+
+/** Test for Bug 350471 **/
+
+// This test depends on general.smoothScroll being off.
+
+const minLineHeight = 10, maxLineHeight = 20;
+
+function between(x, min, max) (min <= max) ? (min <= x && x <= max) : (max <= x && x <= min);
+function isbetween(x, min, max, msg) ok(between(x, min, max), msg + " - Expected " + min + " to " + max + ", got " + x);
+
+function testEventDispatching() {
+  function helper(aAxis, aDelta, aKind, aShiftKey, aCtrlKey, aAltKey, aMetaKey) {
+    let expectedEvents = [];
+    let deltaUnit = "";
+    function listener(e) {
+      if (!expectedEvents.length) {
+        ok(false, "Received an event that I didn't expect. type: " + e.type +
+           ", axis: " + e.axis + ", delta: " + e.delta);
+        return;
+      }
+      let expected = expectedEvents.shift();
+      
+      ["type", "shiftKey", "ctrlKey", "altKey", "metaKey"].forEach(function(field) {
+        is(e[field], expected[field],
+          "e." + field + " (" + e[field] + ") does not match expected value (" + expected[field] + ")");
+      });
+      
+      let expectedAxis = expected.axis == "horizontal" ? e.HORIZONTAL_AXIS : e.VERTICAL_AXIS;
+      is(e.axis, expectedAxis,
+         "e.axis (" + e.axis + ") does not match expected value (" + expectedAxis + ")");
+      
+      // When modifier keys are pressed, cancel the event.
+      // We don't want to zoom or navigate back / forward (history scroll).
+      if (aShiftKey || aCtrlKey || aAltKey || aMetaKey) {
+        e.preventDefault();
+        // Note: If this is a DOMMouseScroll event without hasPixels, we still
+        // expect a follow-up MozMousePixelScroll event.
+      } else {
+        // Only check the delta if no modifiers are pressed.
+        // History scroll and zoom change the deltas in nsESM::PreHandleEvent.
+        if (deltaUnit == (e.type == "DOMMouseScroll" ? "lines" : "pixels")) {
+          // no unit conversion necessary
+          is(e.detail, expected.delta,
+             "e.detail (" + e.detail + ") does not match expected value (" + expected.delta + ")");
+        } else if (e.type == "MozMousePixelScroll") {
+          // We sent a line scroll event but are receiving a pixel scroll event,
+          // so we need to convert the delta.
+          let minDelta = expected.delta * minLineHeight;
+          let maxDelta = expected.delta * maxLineHeight;
+          isbetween(e.detail, minDelta, maxDelta, "wrong pixel scroll event delta");
+        }
+      }
+      e.stopPropagation();
+    }
+    // Set up the expected values.
+    if (aKind == 0 || aKind == 1) {
+      expectedEvents.push({
+        type: "DOMMouseScroll",
+        axis: aAxis,
+        delta: aDelta,
+        hasPixels: (aKind == 1),
+        shiftKey: aShiftKey,
+        ctrlKey: aCtrlKey,
+        altKey: aAltKey,
+        metaKey: aMetaKey
+      });
+    }
+    if (aKind == 0 || aKind == 2) {
+      expectedEvents.push({
+        type: "MozMousePixelScroll",
+        axis: aAxis,
+        delta: aDelta,
+        shiftKey: aShiftKey,
+        ctrlKey: aCtrlKey,
+        altKey: aAltKey,
+        metaKey: aMetaKey
+      });
+    }
+    deltaUnit = aKind == 2 ? "pixels" : "lines";
+    
+    document.addEventListener("DOMMouseScroll", listener, true);
+    document.addEventListener("MozMousePixelScroll", listener, true);
+  
+    // Send the event to the documentElement.
+    synthesizeMouseScroll(document.documentElement, 10, 10, expectedEvents[0]);
+  
+    document.removeEventListener("DOMMouseScroll", listener, true);
+    document.removeEventListener("MozMousePixelScroll", listener, true);
+  
+    // expectedEvents should be empty now. If it's not, print errors.
+    expectedEvents.forEach(function(e) {
+      ok(false, "Didn't receive expected event: " + JSON.toString(e));
+    });
+  };
+  let i = 0;
+  [0, 1, 2].forEach(function(aKind) {
+    ["horizontal", "vertical"].forEach(function(aAxis) {
+      [false, true].forEach(function(aShift) {
+        [false, true].forEach(function(aCtrl) {
+          [false, true].forEach(function(aAlt) {
+            [false, true].forEach(function(aMeta) {
+              helper(aAxis, [-5, -1, 0, 1, 5][i++ % 5], aKind, aShift, aCtrl, aAlt, aMeta);
+            });
+          });
+        });
+      });
+    });
+  });
+}
+
+function testDefaultHandling() {
+  let scrollbox = document.getElementById("scrollbox");
+  let currentTest = "";
+  
+  function scrollWithPreventDefault(aEvent, aDoConsume) {
+    function listener(e) {
+      if (aDoConsume[e.type])
+        e.preventDefault();
+    }
+    scrollbox.addEventListener("DOMMouseScroll", listener, true);
+    scrollbox.addEventListener("MozMousePixelScroll", listener, true);
+    synthesizeMouseScroll(scrollbox, 10, 10, aEvent);
+    scrollbox.removeEventListener("DOMMouseScroll", listener, true);
+    scrollbox.removeEventListener("MozMousePixelScroll", listener, true);
+  }
+  
+  function helper(aType, aHasPixels, aAxis, aStart, aDelta, aConsumeLine, aConsumePixel, aPositionShouldChange) {
+    scrollbox.scrollLeft = aStart;
+    scrollbox.scrollTop = aStart;
+    scrollWithPreventDefault({
+      type: aType,
+      axis: aAxis,
+      hasPixels: aHasPixels,
+      delta: aDelta
+    }, {
+      "DOMMouseScroll": aConsumeLine,
+      "MozMousePixelScroll": aConsumePixel
+    });
+    let newPos = scrollbox[aAxis == "horizontal" ? "scrollLeft" : "scrollTop"];
+    let newPosWrongAxis = scrollbox[aAxis == "horizontal" ? "scrollTop" : "scrollLeft"];
+
+    is(newPosWrongAxis, aStart, currentTest + " wrong axis scrolled - type: " + aType);
+
+    if (aPositionShouldChange) {
+      if (aType == "MozMousePixelScroll") {
+        // aDelta is in pixels, no conversion necessary
+        is(newPos, aStart + aDelta, currentTest + " wrong scroll position - type: " + aType);
+      } else {
+        // Use minLineHeight and maxLineHeight as an estimate for the conversion factor.
+        isbetween(newPos, aStart + aDelta * minLineHeight, aStart + aDelta * maxLineHeight,
+                  currentTest + " wrong scroll position - type: " + aType);
+      }
+    } else {
+      is(newPos, aStart, currentTest + " The scroll position shouldn't have changed. - type: " + aType);
+    }
+  }
+
+  ["horizontal", "vertical"].forEach(function(aAxis) {
+    [-5, 5].forEach(function(aDelta) {
+      [false, true].forEach(function(aConsumeLine) {
+        [false, true].forEach(function(aConsumePixel) {
+          let shouldScroll = !aConsumeLine && !aConsumePixel;
+          
+          currentTest = "normal DOMMouseScroll: only scroll if neither line nor pixel scroll are consumed.";
+          helper("DOMMouseScroll", false, aAxis, 4000, aDelta, aConsumeLine, aConsumePixel, shouldScroll);
+          
+          currentTest = "DOMMouseScroll with hasPixels: never scroll.";
+          helper("DOMMouseScroll", true, aAxis, 4000, aDelta, aConsumeLine, aConsumePixel, false);
+          
+          currentTest = "MozMousePixelScroll (consumed: " + aConsumePixel +
+                        ") with preceding DOMMouseScroll (consumed: " + aConsumeLine +
+                        "): " + (shouldScroll ? "scroll." : "don't scroll.");
+          // It shouldn't matter:
+          //  1. whether hasPixels is set on the preceding DOMMouseScroll event or
+          //  2. whether the preceding DOMMouseScroll event's MozMousePixelScroll event is consumed.
+          helper("DOMMouseScroll", true, aAxis, 4000, aDelta, aConsumeLine, false, false);
+          helper("MozMousePixelScroll", false, aAxis, 4000, aDelta, false, aConsumePixel, shouldScroll);
+          helper("DOMMouseScroll", false, aAxis, 4000, aDelta, aConsumeLine, false, !aConsumeLine);
+          helper("MozMousePixelScroll", false, aAxis, 4000, aDelta, false, aConsumePixel, shouldScroll);
+          helper("DOMMouseScroll", false, aAxis, 4000, aDelta, aConsumeLine, true, false);
+          helper("MozMousePixelScroll", false, aAxis, 4000, aDelta, false, aConsumePixel, shouldScroll);
+        });
+      });
+    });
+  });
+}
+
+function runTests() {
+  netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
+  Components.utils.import("resource://gre/modules/JSON.jsm");
+
+  testEventDispatching();
+
+  let scrollbox = document.getElementById("scrollbox");
+  synthesizeMouse(scrollbox, 10, 10, { type: "mousemove" });
+
+  setTimeout(runOtherTests, 1000);
+}
+function runOtherTests() {
+  testDefaultHandling();
+
+  SimpleTest.finish();
+}
+
+window.onload = function() { setTimeout(runTests, 0); };
+SimpleTest.waitForExplicitFinish();
+
+]]></script>
+
+</window>
diff -r 1aecd2a9914d content/html/document/src/nsHTMLDocument.cpp
--- a/content/html/document/src/nsHTMLDocument.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/content/html/document/src/nsHTMLDocument.cpp	Thu Sep 18 08:03:22 2008 -0500
@@ -3340,75 +3340,74 @@ nsHTMLDocument::EditingStateChanged()
 
   if (!HasPresShell(window)) {
     // We should not make the window editable or setup its editor.
     // It's probably style=display:none.
     return NS_OK;
   }
 
   PRBool makeWindowEditable = mEditingState == eOff;
-  if (makeWindowEditable) {
-    // Editing is being turned on (through designMode or contentEditable)
-    // Turn on editor.
-    // XXX This can cause flushing which can change the editing state, so make
-    //     sure to avoid recursing.
-    EditingState oldState = mEditingState;
-    mEditingState = eSettingUp;
-
-    rv = editSession->MakeWindowEditable(window, "html", PR_FALSE, PR_FALSE,
-                                         PR_TRUE);
-    NS_ENSURE_SUCCESS(rv, rv);
-
-    mEditingState = oldState;
-  }
-
-  // XXX Need to call TearDownEditorOnWindow for all failures.
-  nsCOMPtr<nsIEditorDocShell> editorDocShell =
-    do_QueryInterface(docshell, &rv);
-  NS_ENSURE_SUCCESS(rv, rv);
-
+  PRBool updateState;
+  PRBool spellRecheckAll = PR_FALSE;
   nsCOMPtr<nsIEditor> editor;
-  editorDocShell->GetEditor(getter_AddRefs(editor));
-  if (!editor)
-    return NS_ERROR_FAILURE;
-
-  nsCOMPtr<nsIEditorStyleSheets> editorss = do_QueryInterface(editor, &rv);
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  editorss->AddOverrideStyleSheet(NS_LITERAL_STRING("resource://gre/res/contenteditable.css"));
-
-  // Should we update the editable state of all the nodes in the document? We
-  // need to do this when the designMode value changes, as that overrides
-  // specific states on the elements.
-  PRBool updateState;
-
-  PRBool spellRecheckAll = PR_FALSE;
-  if (designMode) {
-    // designMode is being turned on (overrides contentEditable).
-    editorss->AddOverrideStyleSheet(NS_LITERAL_STRING("resource://gre/res/designmode.css"));
-
-    // Disable scripting and plugins.
-    rv = editSession->DisableJSAndPlugins(window);
-    NS_ENSURE_SUCCESS(rv, rv);
-
-    updateState = PR_TRUE;
-    spellRecheckAll = mEditingState == eContentEditable;
-  }
-  else if (mEditingState == eDesignMode) {
-    // designMode is being turned off (contentEditable is still on).
-    editorss->RemoveOverrideStyleSheet(NS_LITERAL_STRING("resource://gre/res/designmode.css"));
-
-    rv = editSession->RestoreJSAndPlugins(window);
-    NS_ENSURE_SUCCESS(rv, rv);
-
-    updateState = PR_TRUE;
-  }
-  else {
-    // contentEditable is being turned on (and designMode is off).
-    updateState = PR_FALSE;
+
+  {
+    nsAutoEditingState push(this, eSettingUp);
+
+    if (makeWindowEditable) {
+      // Editing is being turned on (through designMode or contentEditable)
+      // Turn on editor.
+      // XXX This can cause flushing which can change the editing state, so make
+      //     sure to avoid recursing.
+      rv = editSession->MakeWindowEditable(window, "html", PR_FALSE, PR_FALSE,
+                                           PR_TRUE);
+      NS_ENSURE_SUCCESS(rv, rv);
+    }
+
+    // XXX Need to call TearDownEditorOnWindow for all failures.
+    nsCOMPtr<nsIEditorDocShell> editorDocShell =
+      do_QueryInterface(docshell, &rv);
+    NS_ENSURE_SUCCESS(rv, rv);
+
+    editorDocShell->GetEditor(getter_AddRefs(editor));
+    if (!editor)
+      return NS_ERROR_FAILURE;
+
+    nsCOMPtr<nsIEditorStyleSheets> editorss = do_QueryInterface(editor, &rv);
+    NS_ENSURE_SUCCESS(rv, rv);
+
+    editorss->AddOverrideStyleSheet(NS_LITERAL_STRING("resource://gre/res/contenteditable.css"));
+
+    // Should we update the editable state of all the nodes in the document? We
+    // need to do this when the designMode value changes, as that overrides
+    // specific states on the elements.
+    if (designMode) {
+      // designMode is being turned on (overrides contentEditable).
+      editorss->AddOverrideStyleSheet(NS_LITERAL_STRING("resource://gre/res/designmode.css"));
+
+      // Disable scripting and plugins.
+      rv = editSession->DisableJSAndPlugins(window);
+      NS_ENSURE_SUCCESS(rv, rv);
+
+      updateState = PR_TRUE;
+      spellRecheckAll = mEditingState == eContentEditable;
+    }
+    else if (mEditingState == eDesignMode) {
+      // designMode is being turned off (contentEditable is still on).
+      editorss->RemoveOverrideStyleSheet(NS_LITERAL_STRING("resource://gre/res/designmode.css"));
+
+      rv = editSession->RestoreJSAndPlugins(window);
+      NS_ENSURE_SUCCESS(rv, rv);
+
+      updateState = PR_TRUE;
+    }
+    else {
+      // contentEditable is being turned on (and designMode is off).
+      updateState = PR_FALSE;
+    }
   }
 
   mEditingState = newState;
 
   if (makeWindowEditable) {
     // Set the editor to not insert br's on return when in p
     // elements by default.
     // XXX Do we only want to do this for designMode?
diff -r 1aecd2a9914d content/html/document/src/nsHTMLDocument.h
--- a/content/html/document/src/nsHTMLDocument.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/content/html/document/src/nsHTMLDocument.h	Thu Sep 18 08:03:22 2008 -0500
@@ -193,16 +193,32 @@ public:
   nsresult ChangeContentEditableCount(nsIContent *aElement, PRInt32 aChange);
 
   virtual EditingState GetEditingState()
   {
     return mEditingState;
   }
 
   virtual nsIContent* GetBodyContentExternal();
+  
+  class nsAutoEditingState {
+  public:
+    nsAutoEditingState(nsHTMLDocument* aDoc, EditingState aState)
+      : mDoc(aDoc), mSavedState(aDoc->mEditingState)
+    {
+      aDoc->mEditingState = aState;
+    }
+    ~nsAutoEditingState() {
+      mDoc->mEditingState = mSavedState;
+    }
+  private:
+    nsHTMLDocument* mDoc;
+    EditingState    mSavedState;
+  };
+  friend class nsAutoEditingState;
 
   void EndUpdate(nsUpdateType aUpdateType);
 
   NS_DECL_CYCLE_COLLECTION_CLASS_INHERITED_NO_UNLINK(nsHTMLDocument, nsDocument)
 
   virtual already_AddRefed<nsIParser> GetFragmentParser() {
     return mFragmentParser.forget();
   }
diff -r 1aecd2a9914d content/xul/document/src/nsXULDocument.cpp
--- a/content/xul/document/src/nsXULDocument.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/content/xul/document/src/nsXULDocument.cpp	Thu Sep 18 08:03:22 2008 -0500
@@ -674,16 +674,22 @@ CanBroadcast(PRInt32 aNameSpaceID, nsIAt
     return PR_TRUE;
 }
 
 void
 nsXULDocument::SynchronizeBroadcastListener(nsIDOMElement   *aBroadcaster,
                                             nsIDOMElement   *aListener,
                                             const nsAString &aAttr)
 {
+    if (mUpdateNestLevel > 0) {
+        nsDelayedBroadcastUpdate delayedUpdate(aBroadcaster, aListener,
+                                               aAttr);
+        mDelayedBroadcasters.AppendElement(delayedUpdate);
+        return;
+    }
     nsCOMPtr<nsIContent> broadcaster = do_QueryInterface(aBroadcaster);
     nsCOMPtr<nsIContent> listener = do_QueryInterface(aListener);
 
 	// We may be copying event handlers etc, so we must also copy
 	// the script-type to the listener.
 	listener->SetScriptTypeID(broadcaster->GetScriptTypeID());
 
     if (aAttr.EqualsLiteral("*")) {
@@ -3213,16 +3219,34 @@ nsXULDocument::StyleSheetLoaded(nsICSSSt
         --mPendingSheets;
 
         if (!mStillWalking && mPendingSheets == 0) {
             return DoneWalking();
         }
     }
 
     return NS_OK;
+}
+
+void
+nsXULDocument::EndUpdate(nsUpdateType aUpdateType)
+{
+    nsXMLDocument::EndUpdate(aUpdateType);
+    if (mUpdateNestLevel == 0) {
+        PRUint32 length = mDelayedBroadcasters.Length();
+        if (length) {
+            nsTArray<nsDelayedBroadcastUpdate> delayedBroadcasters;
+            mDelayedBroadcasters.SwapElements(delayedBroadcasters);
+            for (PRUint32 i = 0; i < length; ++i) {
+                SynchronizeBroadcastListener(delayedBroadcasters[i].mBroadcaster,
+                                             delayedBroadcasters[i].mListener,
+                                             delayedBroadcasters[i].mAttr);
+            }
+        }
+    }
 }
 
 void
 nsXULDocument::ReportMissingOverlay(nsIURI* aURI)
 {
     NS_PRECONDITION(aURI, "Must have a URI");
     
     nsCAutoString spec;
diff -r 1aecd2a9914d content/xul/document/src/nsXULDocument.h
--- a/content/xul/document/src/nsXULDocument.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/content/xul/document/src/nsXULDocument.h	Thu Sep 18 08:03:23 2008 -0500
@@ -177,16 +177,18 @@ public:
 
     // nsIDOMNSDocument
     NS_IMETHOD GetContentType(nsAString& aContentType);
 
     // nsICSSLoaderObserver
     NS_IMETHOD StyleSheetLoaded(nsICSSStyleSheet* aSheet,
                                 PRBool aWasAlternate,
                                 nsresult aStatus);
+
+    virtual void EndUpdate(nsUpdateType aUpdateType);
 
     static PRBool
     MatchAttribute(nsIContent* aContent,
                    PRInt32 aNameSpaceID,
                    nsIAtom* aAttrName,
                    void* aData);
 
     NS_DECL_CYCLE_COLLECTION_CLASS_INHERITED(nsXULDocument, nsXMLDocument)
@@ -686,14 +688,33 @@ protected:
      * A map from a broadcaster element to a list of listener elements.
      */
     PLDHashTable* mBroadcasterMap;
 
     nsInterfaceHashtable<nsURIHashKey,nsIObserver> mOverlayLoadObservers;
     nsInterfaceHashtable<nsURIHashKey,nsIObserver> mPendingOverlayLoadNotifications;
     
     PRBool mInitialLayoutComplete;
+
+    class nsDelayedBroadcastUpdate
+    {
+    public:
+      nsDelayedBroadcastUpdate(nsIDOMElement* aBroadcaster,
+                               nsIDOMElement* aListener,
+                               const nsAString &aAttr)
+      : mBroadcaster(aBroadcaster), mListener(aListener), mAttr(aAttr) {}
+
+      nsDelayedBroadcastUpdate(const nsDelayedBroadcastUpdate& aOther)
+      : mBroadcaster(aOther.mBroadcaster), mListener(aOther.mListener),
+        mAttr(aOther.mAttr) {}
+
+      nsCOMPtr<nsIDOMElement> mBroadcaster;
+      nsCOMPtr<nsIDOMElement> mListener;
+      nsString                mAttr;
+    };
+
+    nsTArray<nsDelayedBroadcastUpdate> mDelayedBroadcasters;
 private:
     // helpers
 
 };
 
 #endif // nsXULDocument_h__
diff -r 1aecd2a9914d content/xul/document/test/Makefile.in
--- a/content/xul/document/test/Makefile.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/content/xul/document/test/Makefile.in	Thu Sep 18 08:03:23 2008 -0500
@@ -46,13 +46,14 @@ include $(topsrcdir)/config/rules.mk
 
 _TEST_FILES	= \
 		test_bug311681.xul \
 		test_bug199692.xul \
 		test_bug391002.xul \
 		test_bug403868.xul \
 		test_bug414907.xul \
 		test_bug418216.xul \
+		test_bug445177.xul \
 		test_bug449457.xul \
 		$(NULL)
 
 libs:: $(_TEST_FILES)
 	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
diff -r 1aecd2a9914d content/xul/document/test/test_bug445177.xul
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/content/xul/document/test/test_bug445177.xul	Thu Sep 18 08:03:23 2008 -0500
@@ -0,0 +1,86 @@
+<?xml version="1.0"?>
+<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
+<?xml-stylesheet href="/tests/SimpleTest/test.css" type="text/css"?>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=445177
+-->
+<window title="Test for Bug 445177"
+  id="test_bug445177_xul"
+  xmlns:html="http://www.w3.org/1999/xhtml"
+  xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+  xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
+
+  <script type="application/javascript" src="/MochiKit/packed.js"></script>
+  <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+
+<body id="body" xmlns="http://www.w3.org/1999/xhtml">
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=445177">Mozilla Bug 445177</a>
+
+
+<hbox id="b1" value="foo"/>
+<hbox id="o1" observes="b1"/>
+
+<pre id="test">
+  <script class="testbody" type="text/javascript">
+<![CDATA[
+  SimpleTest.waitForExplicitFinish();
+  function do_test() {
+    var b1 = document.getElementById("b1");
+    var o1 = document.getElementById("o1");
+
+    is(o1.getAttribute("value"), b1.getAttribute("value"), "Wrong value (1)");
+
+    b1.setAttribute("value", "bar");
+    is(o1.getAttribute("value"), b1.getAttribute("value"), "Wrong value (2)");
+
+    b1.removeAttribute("value");
+    is(o1.hasAttribute("value"), b1.hasAttribute("value"), "Wrong value (3)");
+
+    o1.setAttribute("value", "foo");
+    isnot(o1.getAttribute("value"), b1.getAttribute("value"), "Wrong value (4)");
+
+    b1.setAttribute("value", "foobar");
+    is(o1.getAttribute("value"), b1.getAttribute("value"), "Wrong value (5)");
+
+    //After removing listener, changes to broadcaster shouldn't have any effect.
+    o1.parentNode.removeChild(o1);
+    b1.setAttribute("value", "foo");
+    isnot(o1.getAttribute("value"), b1.getAttribute("value"), "Wrong value (6)");
+
+    b1.parentNode.appendChild(o1);
+    is(o1.getAttribute("value"), b1.getAttribute("value"), "Wrong value (7)");
+
+    o1.parentNode.removeChild(o1);
+    o1.removeAttribute("observes");
+    o1.removeAttribute("value");
+    b1.parentNode.appendChild(o1);
+    isnot(o1.getAttribute("value"), b1.getAttribute("value"), "Wrong value (8)");
+
+    document.addBroadcastListenerFor(b1, o1, "value");
+    is(o1.getAttribute("value"), b1.getAttribute("value"), "Wrong value (9)");
+
+    o1.parentNode.removeChild(o1);
+    b1.setAttribute("value", "foobar");
+    is(o1.getAttribute("value"), b1.getAttribute("value"), "Wrong value (10)");
+
+    b1.parentNode.appendChild(o1);
+    is(o1.getAttribute("value"), b1.getAttribute("value"), "Wrong value (11)");
+
+    o1.setAttribute("observes", "b1");
+    is(o1.getAttribute("value"), b1.getAttribute("value"), "Wrong value (12)");
+
+    // When broadcaster isn't in document, changes to its attributes aren't
+    // reflected to listener.
+    b1.parentNode.removeChild(b1);
+    b1.setAttribute("value", "foo");
+    isnot(o1.getAttribute("value"), b1.getAttribute("value"), "Wrong value (13)");
+
+    SimpleTest.finish();
+  }
+
+  addLoadEvent(do_test);
+]]>
+  </script>
+</pre>
+</body>
+</window>
diff -r 1aecd2a9914d docshell/build/Makefile.in
--- a/docshell/build/Makefile.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/docshell/build/Makefile.in	Thu Sep 18 08:03:23 2008 -0500
@@ -137,8 +137,12 @@ endif
 
 ifeq ($(MOZ_WIDGET_TOOLKIT),gtk2)
 EXTRA_DSO_LDOPTS	+= $(TK_LIBS)
 endif
 
 ifdef MOZ_ENABLE_DBUS
  EXTRA_DSO_LDOPTS += $(MOZ_DBUS_GLIB_LIBS)
 endif
+
+ifdef MOZ_PLATFORM_HILDON
+EXTRA_DSO_LDOPTS += $(LIBHILDONMIME_LIBS)
+endif
diff -r 1aecd2a9914d dom/public/idl/base/nsIDOMWindowUtils.idl
--- a/dom/public/idl/base/nsIDOMWindowUtils.idl	Tue Sep 16 16:40:57 2008 +1200
+++ b/dom/public/idl/base/nsIDOMWindowUtils.idl	Thu Sep 18 08:03:23 2008 -0500
@@ -125,30 +125,31 @@ interface nsIDOMWindowUtils : nsISupport
                       in long aY,
                       in long aButton,
                       in long aClickCount,
                       in long aModifiers);
 
   /** Synthesize a mouse scroll event for a window. The event types supported
    *  are: 
    *    DOMMouseScroll
+   *    MozMousePixelScroll
    *
    * Events are sent in coordinates offset by aX and aY from the window.
    *
    * Cannot be accessed from unprivileged context (not content-accessible)
    * Will throw a DOM security error if called without UniversalXPConnect
    * privileges.
    *
    * @param aType event type
    * @param aX x offset
    * @param aY y offset
    * @param aButton button to synthesize
    * @param aScrollFlags flag bits --- see nsMouseScrollFlags in nsGUIEvent.h
    * @param aDelta the direction and amount to scroll (in lines or pixels,
-   * depending on whether kIsPixels is set in aScrollFlags)
+   * depending on the event type)
    * @param aModifiers modifiers pressed, using constants defined in nsIDOMNSEvent
    */
   void sendMouseScrollEvent(in AString aType,
                             in long aX,
                             in long aY,
                             in long aButton,
                             in long aScrollFlags,
                             in long aDelta,
diff -r 1aecd2a9914d dom/src/base/nsDOMWindowUtils.cpp
--- a/dom/src/base/nsDOMWindowUtils.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/dom/src/base/nsDOMWindowUtils.cpp	Thu Sep 18 08:03:23 2008 -0500
@@ -265,16 +265,18 @@ nsDOMWindowUtils::SendMouseScrollEvent(c
   // get the widget to send the event to
   nsCOMPtr<nsIWidget> widget = GetWidget();
   if (!widget)
     return NS_ERROR_NULL_POINTER;
 
   PRInt32 msg;
   if (aType.EqualsLiteral("DOMMouseScroll"))
     msg = NS_MOUSE_SCROLL;
+  else if (aType.EqualsLiteral("MozMousePixelScroll"))
+    msg = NS_MOUSE_PIXEL_SCROLL;
   else
     return NS_ERROR_UNEXPECTED;
 
   nsMouseScrollEvent event(PR_TRUE, msg, widget);
   event.isShift = (aModifiers & nsIDOMNSEvent::SHIFT_MASK) ? PR_TRUE : PR_FALSE;
   event.isControl = (aModifiers & nsIDOMNSEvent::CONTROL_MASK) ? PR_TRUE : PR_FALSE;
   event.isAlt = (aModifiers & nsIDOMNSEvent::ALT_MASK) ? PR_TRUE : PR_FALSE;
   event.isMeta = (aModifiers & nsIDOMNSEvent::META_MASK) ? PR_TRUE : PR_FALSE;
diff -r 1aecd2a9914d editor/libeditor/base/Makefile.in
--- a/editor/libeditor/base/Makefile.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/editor/libeditor/base/Makefile.in	Thu Sep 18 08:03:23 2008 -0500
@@ -36,16 +36,20 @@
 # ***** END LICENSE BLOCK *****
 
 DEPTH		= ../../..
 topsrcdir	= @top_srcdir@
 srcdir		= @srcdir@
 VPATH		= @srcdir@
 
 include $(DEPTH)/config/autoconf.mk
+
+ifdef ENABLE_TESTS
+DIRS            += tests
+endif
 
 MODULE		= editor
 LIBRARY_NAME	= editorbase_s
 LIBXUL_LIBRARY	= 1
 
 REQUIRES	= xpcom \
 		  string \
 		  dom \
diff -r 1aecd2a9914d editor/libeditor/base/tests/Makefile.in
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/editor/libeditor/base/tests/Makefile.in	Thu Sep 18 08:03:23 2008 -0500
@@ -0,0 +1,53 @@
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is mozilla.org code.
+#
+# The Initial Developer of the Original Code is
+# Mozilla Foundation.
+# Portions created by the Initial Developer are Copyright (C) 2008
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either of the GNU General Public License Version 2 or later (the "GPL"),
+# or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+DEPTH		= ../../../..
+topsrcdir	= @top_srcdir@
+srcdir		= @srcdir@
+VPATH		= @srcdir@
+relativesrcdir  = editor/libeditor/base/tests
+
+include $(DEPTH)/config/autoconf.mk
+include $(topsrcdir)/config/rules.mk
+
+_TEST_FILES = \
+		test_selection_move_commands.xul \
+		$(NULL)
+
+libs:: $(_TEST_FILES)
+	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
+
diff -r 1aecd2a9914d editor/libeditor/base/tests/test_selection_move_commands.xul
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/editor/libeditor/base/tests/test_selection_move_commands.xul	Thu Sep 18 08:03:23 2008 -0500
@@ -0,0 +1,177 @@
+<?xml version="1.0"?>
+<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
+<?xml-stylesheet href="/tests/SimpleTest/test.css" type="text/css"?>
+<window xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+        xmlns:html="http://www.w3.org/1999/xhtml"
+        title="Test for nsSelectionMoveCommands">
+  <script type="application/javascript" src="/MochiKit/packed.js"></script>
+  <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+
+<script class="testbody" type="application/javascript">
+<![CDATA[
+
+function runTest() {
+  var e = document.getElementById("edit");
+  var doc = e.contentDocument;
+  var win = e.contentWindow;
+  var root = doc.documentElement;
+  var sel = win.getSelection();
+  doc.designMode='on';
+  doc.body.innerHTML = "1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>";
+  win.focus();
+
+  netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
+
+  function doCommand(cmd) {
+    var controller = document.commandDispatcher.getControllerForCommand(cmd);
+    if (controller) {
+      controller.doCommand(cmd);
+    }
+  }
+
+  function testScrollCommand(cmd, expectTop) {
+    doCommand(cmd);
+    is(root.getBoundingClientRect().top, -expectTop, cmd);
+  }
+
+  function testMoveCommand(cmd, expectNode, expectOffset) {
+    doCommand(cmd);
+    is(sel.isCollapsed, true, "collapsed after " + cmd);
+    is(sel.anchorNode, expectNode, "node after " + cmd);
+    is(sel.anchorOffset, expectOffset, "offset after " + cmd);
+  }
+
+  function findChildNum(e, child) {
+    var i = 0;
+    var n = e.firstChild;
+    while (n && n != child) {
+      n = n.nextSibling;
+      ++i;
+    }
+    if (!n)
+      return -1;
+    return i;
+  }
+
+  function testPageMoveCommand(cmd, expectOffset) {
+    doCommand(cmd);
+    is(sel.isCollapsed, true, "collapsed after " + cmd);
+    is(sel.anchorOffset, expectOffset, "offset after " + cmd);
+    return findChildNum(doc.body, sel.anchorNode);
+  }
+
+  function testSelectCommand(cmd, expectNode, expectOffset) {
+    var anchorNode = sel.anchorNode;
+    var anchorOffset = sel.anchorOffset;
+    doCommand(cmd);
+    is(sel.isCollapsed, false, "not collapsed after " + cmd);
+    is(sel.anchorNode, anchorNode, "anchor not moved after " + cmd);
+    is(sel.anchorOffset, anchorOffset, "anchor not moved after " + cmd);
+    is(sel.focusNode, expectNode, "node after " + cmd);
+    is(sel.focusOffset, expectOffset, "offset after " + cmd);
+  }
+
+  function testPageSelectCommand(cmd, expectOffset) {
+    var anchorNode = sel.anchorNode;
+    var anchorOffset = sel.anchorOffset;
+    doCommand(cmd);
+    is(sel.isCollapsed, false, "not collapsed after " + cmd);
+    is(sel.anchorNode, anchorNode, "anchor not moved after " + cmd);
+    is(sel.anchorOffset, anchorOffset, "anchor not moved after " + cmd);
+    is(sel.focusOffset, expectOffset, "offset after " + cmd);
+    return findChildNum(doc.body, sel.focusNode);
+  }
+
+  function node(i) {
+    var n = doc.body.firstChild;
+    while (i > 0) {
+      n = n.nextSibling;
+      --i;
+    }
+    return n;
+  }
+
+  testScrollCommand("cmd_scrollBottom", root.scrollHeight - 100);
+  testScrollCommand("cmd_scrollTop", 0);
+
+  doCommand("cmd_scrollPageDown");
+  var pageHeight = -root.getBoundingClientRect().top;
+  ok(pageHeight > 0, "cmd_scrollPageDown works");
+  ok(pageHeight <= 100, "cmd_scrollPageDown doesn't scroll too much");
+  doCommand("cmd_scrollBottom");
+  testScrollCommand("cmd_scrollPageUp", root.scrollHeight - 100 - pageHeight);
+
+  doCommand("cmd_scrollTop");
+  doCommand("cmd_scrollLineDown");
+  var lineHeight = -root.getBoundingClientRect().top;
+  ok(lineHeight > 0, "Can scroll by lines");
+  doCommand("cmd_scrollBottom");
+  testScrollCommand("cmd_scrollLineUp", root.scrollHeight - 100 - lineHeight);
+
+  testMoveCommand("cmd_moveBottom", doc.body, 23);
+  testMoveCommand("cmd_moveTop", node(0), 0);
+  testSelectCommand("cmd_selectBottom", doc.body, 23);
+  doCommand("cmd_moveBottom");
+  testSelectCommand("cmd_selectTop", node(0), 0);
+
+  doCommand("cmd_moveTop");
+  testMoveCommand("cmd_lineNext", node(2), 0);
+  testMoveCommand("cmd_linePrevious", node(0), 0);
+  testSelectCommand("cmd_selectLineNext", node(2), 0);
+  doCommand("cmd_moveBottom");
+  testSelectCommand("cmd_selectLinePrevious", node(20), 2);
+
+  doCommand("cmd_moveBottom");
+  testMoveCommand("cmd_charPrevious", node(22), 1);
+  testMoveCommand("cmd_charNext", node(22), 2);
+  testSelectCommand("cmd_selectCharPrevious", node(22), 1);
+  doCommand("cmd_moveTop");
+  testSelectCommand("cmd_selectCharNext", node(0), 1);
+
+  doCommand("cmd_moveTop");
+  testMoveCommand("cmd_endLine", doc.body, 1);
+  testMoveCommand("cmd_beginLine", node(0), 0);
+  testSelectCommand("cmd_selectEndLine", doc.body, 1);
+  doCommand("cmd_moveBottom");
+  testSelectCommand("cmd_selectBeginLine", node(22), 0);
+
+  doCommand("cmd_moveBottom");
+  testMoveCommand("cmd_wordPrevious", node(22), 0);
+  testMoveCommand("cmd_wordNext", doc.body, 23);
+  testSelectCommand("cmd_selectWordPrevious", node(22), 0);
+  // XXX this fails on Windows, bug 455818
+  // doCommand("cmd_moveTop");
+  // testSelectCommand("cmd_selectWordNext", doc.body, 1);
+
+  doCommand("cmd_moveTop");
+  var lineNum = testPageMoveCommand("cmd_movePageDown", 0);
+  ok(lineNum > 0, "cmd_movePageDown works");
+  doCommand("cmd_moveBottom");
+  doCommand("cmd_beginLine");
+  // XXX this fails on Windows, bug 455818
+  // is(testPageMoveCommand("cmd_movePageUp", 0), 22 - lineNum, "cmd_movePageUp works");
+
+  doCommand("cmd_moveTop");
+  is(testPageSelectCommand("cmd_selectPageDown", 0), lineNum, "cmd_selectPageUp works");
+  doCommand("cmd_moveBottom");
+  doCommand("cmd_beginLine");
+  // XXX this fails on Windows, bug 455818
+  // is(testPageSelectCommand("cmd_selectPageUp", 0), 22 - lineNum, "cmd_selectPageUp works");
+
+  SimpleTest.finish();
+}
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(runTest);
+]]>
+</script>
+
+<body  id="html_body" xmlns="http://www.w3.org/1999/xhtml">
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=372685">Mozilla Bug 372685</a>
+<p id="display"></p>
+
+<pre id="test">
+</pre>
+<iframe id="edit" width="200" height="100" src="about:blank"/>
+</body>
+</window>
diff -r 1aecd2a9914d embedding/tests/cocoaEmbed/CocoaEmbed.pbproj/project.pbxproj
--- a/embedding/tests/cocoaEmbed/CocoaEmbed.pbproj/project.pbxproj	Tue Sep 16 16:40:57 2008 +1200
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,2223 +0,0 @@
-// !$*UTF8*$!
-{
-	archiveVersion = 1;
-	classes = {
-	};
-	objectVersion = 38;
-	objects = {
-		080E96DCFE201CFB7F000001 = {
-			fileRef = 29B97318FDCFA39411CA2CEA;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		080E96DDFE201D6D7F000001 = {
-			children = (
-				F6BA6D4E01B2F8A601A962F7,
-			);
-			isa = PBXGroup;
-			name = Classes;
-			refType = 4;
-		};
-		089C165CFE840E0CC02AAC07 = {
-			children = (
-				089C165DFE840E0CC02AAC07,
-			);
-			isa = PBXVariantGroup;
-			name = InfoPlist.strings;
-			refType = 4;
-		};
-		089C165DFE840E0CC02AAC07 = {
-			fileEncoding = 10;
-			isa = PBXFileReference;
-			name = English;
-			path = English.lproj/InfoPlist.strings;
-			refType = 4;
-		};
-		089C165EFE840E0CC02AAC07 = {
-			fileRef = 089C165CFE840E0CC02AAC07;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-//080
-//081
-//082
-//083
-//084
-//100
-//101
-//102
-//103
-//104
-		1058C7A0FEA54F0111CA2CBB = {
-			children = (
-				1058C7A1FEA54F0111CA2CBB,
-				F6C4515D01B5A8A601A962F7,
-			);
-			isa = PBXGroup;
-			name = "Linked Frameworks";
-			refType = 4;
-		};
-		1058C7A1FEA54F0111CA2CBB = {
-			isa = PBXFrameworkReference;
-			name = Cocoa.framework;
-			path = /System/Library/Frameworks/Cocoa.framework;
-			refType = 0;
-		};
-		1058C7A2FEA54F0111CA2CBB = {
-			children = (
-				29B97325FDCFA39411CA2CEA,
-				29B97324FDCFA39411CA2CEA,
-			);
-			isa = PBXGroup;
-			name = "Other Frameworks";
-			refType = 4;
-		};
-		1058C7A3FEA54F0111CA2CBB = {
-			fileRef = 1058C7A1FEA54F0111CA2CBB;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-//100
-//101
-//102
-//103
-//104
-//170
-//171
-//172
-//173
-//174
-		17587328FF379C6511CA2CBB = {
-			isa = PBXApplicationReference;
-			path = CocoaEmbed.app;
-			refType = 3;
-		};
-//170
-//171
-//172
-//173
-//174
-//190
-//191
-//192
-//193
-//194
-		19C28FACFE9D520D11CA2CBB = {
-			children = (
-				17587328FF379C6511CA2CBB,
-			);
-			isa = PBXGroup;
-			name = Products;
-			refType = 4;
-		};
-//190
-//191
-//192
-//193
-//194
-//1B0
-//1B1
-//1B2
-//1B3
-//1B4
-		1BD0F22A050FFDAB00A80011 = {
-			isa = PBXFileReference;
-			path = libmozz.dylib;
-			refType = 4;
-		};
-		1BD0F22B050FFDAB00A80011 = {
-			fileRef = 1BD0F22A050FFDAB00A80011;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		1BD0F22D050FFDE000A80011 = {
-			fileRef = 1BD0F22A050FFDAB00A80011;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		1BD0F22E050FFE0100A80011 = {
-			isa = PBXFileReference;
-			path = libxpcom_compat.dylib;
-			refType = 4;
-		};
-		1BD0F22F050FFE0100A80011 = {
-			fileRef = 1BD0F22E050FFE0100A80011;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		1BD0F230050FFE0500A80011 = {
-			fileRef = 1BD0F22E050FFE0100A80011;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-//1B0
-//1B1
-//1B2
-//1B3
-//1B4
-//290
-//291
-//292
-//293
-//294
-		29B97313FDCFA39411CA2CEA = {
-			buildStyles = (
-				4A9504CCFFE6A4B311CA0CBA,
-				4A9504CDFFE6A4B311CA0CBA,
-			);
-			hasScannedForEncodings = 1;
-			isa = PBXProject;
-			mainGroup = 29B97314FDCFA39411CA2CEA;
-			projectDirPath = "";
-			targets = (
-				29B97326FDCFA39411CA2CEA,
-			);
-		};
-		29B97314FDCFA39411CA2CEA = {
-			children = (
-				080E96DDFE201D6D7F000001,
-				29B97315FDCFA39411CA2CEA,
-				29B97317FDCFA39411CA2CEA,
-				29B97323FDCFA39411CA2CEA,
-				19C28FACFE9D520D11CA2CBB,
-				F6BD637A01B30E0F01A962F7,
-			);
-			isa = PBXGroup;
-			name = CocoaEmbed;
-			path = "";
-			refType = 4;
-		};
-		29B97315FDCFA39411CA2CEA = {
-			children = (
-				29B97316FDCFA39411CA2CEA,
-			);
-			isa = PBXGroup;
-			name = "Other Sources";
-			path = "";
-			refType = 4;
-		};
-		29B97316FDCFA39411CA2CEA = {
-			fileEncoding = 30;
-			isa = PBXFileReference;
-			name = main.mm;
-			path = src/main.mm;
-			refType = 2;
-		};
-		29B97317FDCFA39411CA2CEA = {
-			children = (
-				29B97318FDCFA39411CA2CEA,
-				089C165CFE840E0CC02AAC07,
-			);
-			isa = PBXGroup;
-			name = Resources;
-			path = res;
-			refType = 4;
-		};
-		29B97318FDCFA39411CA2CEA = {
-			children = (
-				29B97319FDCFA39411CA2CEA,
-			);
-			isa = PBXVariantGroup;
-			name = MainMenu.nib;
-			path = "";
-			refType = 4;
-		};
-		29B97319FDCFA39411CA2CEA = {
-			isa = PBXFileReference;
-			name = English;
-			path = English.lproj/MainMenu.nib;
-			refType = 4;
-		};
-		29B97323FDCFA39411CA2CEA = {
-			children = (
-				1058C7A0FEA54F0111CA2CBB,
-				1058C7A2FEA54F0111CA2CBB,
-			);
-			isa = PBXGroup;
-			name = Frameworks;
-			path = "";
-			refType = 4;
-		};
-		29B97324FDCFA39411CA2CEA = {
-			isa = PBXFrameworkReference;
-			name = AppKit.framework;
-			path = /System/Library/Frameworks/AppKit.framework;
-			refType = 0;
-		};
-		29B97325FDCFA39411CA2CEA = {
-			isa = PBXFrameworkReference;
-			name = Foundation.framework;
-			path = /System/Library/Frameworks/Foundation.framework;
-			refType = 0;
-		};
-		29B97326FDCFA39411CA2CEA = {
-			buildPhases = (
-				29B97327FDCFA39411CA2CEA,
-				29B97328FDCFA39411CA2CEA,
-				29B9732BFDCFA39411CA2CEA,
-				F6BD637B01B30E0F01A962F7,
-				3FA6DE98042F9B6F0002AD8F,
-				F6BD639001B30F5301A962F7,
-				F6BD64B701B3167601A962F7,
-				F6BD650A01B3184301A962F7,
-				79C23703043A014D00202892,
-				F6BD651901B3184301A962F7,
-				F6BD651F01B3184301A962F7,
-				F6BD652301B3184301A962F7,
-				79C2371C043A1B1E00202892,
-				29B9732DFDCFA39411CA2CEA,
-			);
-			buildSettings = {
-				FRAMEWORK_SEARCH_PATHS = ../../browser/cocoa/build;
-				GCC_TREAT_WARNINGS_AS_ERRORS = YES;
-				HEADER_SEARCH_PATHS = "../../../dist/include/string ../../../dist/include/nspr ../../../dist/include/xpcom ../../../dist/sdk/xpcom/include ../../../dist/include/embed_base ../../browser/cocoa/build/CHBrowserView.framework/Headers";
-				INSTALL_PATH = "$(HOME)/Applications";
-				LIBRARY_SEARCH_PATHS = "../../../dist/Embed /Volumes/moose/floppy/cocoamoz/mozilla/embedding/tests/cocoaEmbed /Volumes/moose/floppy/cocoamoz/mozilla/dist/Embed";
-				OPTIMIZATION_CFLAGS = "-O0";
-				OTHER_CFLAGS = "-fno-rtti -fno-exceptions -fpascal-strings -fshort-wchar -DOSTYPE=\\\"Darwin1.4\\\" -DOSARCH=\\\"Darwin\\\" -DIBMBIDI";
-				OTHER_LDFLAGS = "-lxpcom -lplds4 -lplc4 -lnspr4 -lpthread -lm";
-				PREBINDING = NO;
-				PREFIX_HEADER = "../../../mozilla-config.h";
-				PRODUCT_NAME = CocoaEmbed;
-				SECTORDER_FLAGS = "";
-				WARNING_CFLAGS = "-Wmost -Wno-four-char-constants -Wno-unknown-pragmas";
-				WRAPPER_EXTENSION = app;
-			};
-			dependencies = (
-			);
-			isa = PBXApplicationTarget;
-			name = CocoaEmbed;
-			productInstallPath = "$(HOME)/Applications";
-			productName = CocoaEmbed;
-			productReference = 17587328FF379C6511CA2CBB;
-			productSettingsXML = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>
-<!DOCTYPE plist PUBLIC \"-//Apple Computer//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">
-<plist version=\"1.0\">
-<dict>
-	<key>CFBundleDevelopmentRegion</key>
-	<string>English</string>
-	<key>CFBundleExecutable</key>
-	<string>CocoaEmbed</string>
-	<key>CFBundleIconFile</key>
-	<string></string>
-	<key>CFBundleInfoDictionaryVersion</key>
-	<string>6.0</string>
-	<key>CFBundlePackageType</key>
-	<string>APPL</string>
-	<key>CFBundleSignature</key>
-	<string>????</string>
-	<key>CFBundleVersion</key>
-	<string>0.1</string>
-	<key>NSMainNibFile</key>
-	<string>MainMenu</string>
-	<key>NSPrincipalClass</key>
-	<string>NSApplication</string>
-</dict>
-</plist>
-";
-		};
-		29B97327FDCFA39411CA2CEA = {
-			buildActionMask = 2147483647;
-			files = (
-			);
-			isa = PBXHeadersBuildPhase;
-			runOnlyForDeploymentPostprocessing = 0;
-		};
-		29B97328FDCFA39411CA2CEA = {
-			buildActionMask = 2147483647;
-			files = (
-				080E96DCFE201CFB7F000001,
-				089C165EFE840E0CC02AAC07,
-			);
-			isa = PBXResourcesBuildPhase;
-			runOnlyForDeploymentPostprocessing = 0;
-		};
-		29B9732BFDCFA39411CA2CEA = {
-			buildActionMask = 2147483647;
-			files = (
-				29B9732CFDCFA39411CA2CEA,
-				F6BA6D4F01B2F8A601A962F7,
-			);
-			isa = PBXSourcesBuildPhase;
-			runOnlyForDeploymentPostprocessing = 0;
-		};
-		29B9732CFDCFA39411CA2CEA = {
-			fileRef = 29B97316FDCFA39411CA2CEA;
-			isa = PBXBuildFile;
-			settings = {
-				ATTRIBUTES = (
-				);
-			};
-		};
-		29B9732DFDCFA39411CA2CEA = {
-			buildActionMask = 2147483647;
-			files = (
-				1058C7A3FEA54F0111CA2CBB,
-				3FA6DEBF042FC3E20002AD8F,
-				1BD0F22B050FFDAB00A80011,
-				1BD0F22F050FFE0100A80011,
-			);
-			isa = PBXFrameworksBuildPhase;
-			runOnlyForDeploymentPostprocessing = 0;
-		};
-//290
-//291
-//292
-//293
-//294
-//3F0
-//3F1
-//3F2
-//3F3
-//3F4
-		3FA6DE8E042F9B380002AD8F = {
-			isa = PBXFileReference;
-			path = libnss3.dylib;
-			refType = 4;
-		};
-		3FA6DE8F042F9B380002AD8F = {
-			isa = PBXFileReference;
-			path = libnssckbi.dylib;
-			refType = 4;
-		};
-		3FA6DE90042F9B380002AD8F = {
-			isa = PBXFileReference;
-			path = libsmime3.dylib;
-			refType = 4;
-		};
-		3FA6DE91042F9B380002AD8F = {
-			isa = PBXFileReference;
-			path = libsoftokn3.dylib;
-			refType = 4;
-		};
-		3FA6DE92042F9B380002AD8F = {
-			isa = PBXFileReference;
-			path = libssl3.dylib;
-			refType = 4;
-		};
-		3FA6DE98042F9B6F0002AD8F = {
-			buildActionMask = 2147483647;
-			dstPath = "";
-			dstSubfolderSpec = 6;
-			files = (
-				3FA6DE99042F9B780002AD8F,
-				3FA6DE9A042F9B780002AD8F,
-				3FA6DE9B042F9B780002AD8F,
-				3FA6DE9C042F9B780002AD8F,
-				3FA6DE9D042F9B780002AD8F,
-			);
-			isa = PBXCopyFilesBuildPhase;
-			runOnlyForDeploymentPostprocessing = 0;
-		};
-		3FA6DE99042F9B780002AD8F = {
-			fileRef = 3FA6DE8E042F9B380002AD8F;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		3FA6DE9A042F9B780002AD8F = {
-			fileRef = 3FA6DE8F042F9B380002AD8F;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		3FA6DE9B042F9B780002AD8F = {
-			fileRef = 3FA6DE90042F9B380002AD8F;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		3FA6DE9C042F9B780002AD8F = {
-			fileRef = 3FA6DE91042F9B380002AD8F;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		3FA6DE9D042F9B780002AD8F = {
-			fileRef = 3FA6DE92042F9B380002AD8F;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		3FA6DEBF042FC3E20002AD8F = {
-			fileRef = F6C4515D01B5A8A601A962F7;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		3FA6DEC2042FC4270002AD8F = {
-			fileRef = F6BD638101B30EA301A962F7;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		3FA6DEC6042FCC4C0002AD8F = {
-			isa = PBXFileReference;
-			path = "security-prefs.js";
-			refType = 4;
-		};
-		3FA6DEC8042FCC590002AD8F = {
-			fileRef = 3FA6DEC6042FCC4C0002AD8F;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-//3F0
-//3F1
-//3F2
-//3F3
-//3F4
-//4A0
-//4A1
-//4A2
-//4A3
-//4A4
-		4A9504CCFFE6A4B311CA0CBA = {
-			buildRules = (
-			);
-			buildSettings = {
-				COPY_PHASE_STRIP = NO;
-				OTHER_CFLAGS = "-DDEBUG -DMOZ_DEBUG -DTRACING";
-			};
-			isa = PBXBuildStyle;
-			name = Development;
-		};
-		4A9504CDFFE6A4B311CA0CBA = {
-			buildRules = (
-			);
-			buildSettings = {
-				COPY_PHASE_STRIP = YES;
-				DEBUGGING_SYMBOLS = NO;
-				OPTIMIZATION_CFLAGS = "-O";
-			};
-			isa = PBXBuildStyle;
-			name = Deployment;
-		};
-//4A0
-//4A1
-//4A2
-//4A3
-//4A4
-//790
-//791
-//792
-//793
-//794
-		79C235C20439FBC700202892 = {
-			children = (
-				F6BD64FC01B3184301A962F7,
-				F6BD64FE01B3184301A962F7,
-				3FA6DEC6042FCC4C0002AD8F,
-			);
-			isa = PBXGroup;
-			path = pref;
-			refType = 4;
-		};
-		79C235C30439FC0100202892 = {
-			children = (
-				F6BD637C01B30E2901A962F7,
-				F6BD637F01B30EA301A962F7,
-				F6BD638001B30EA301A962F7,
-				F6BD638101B30EA301A962F7,
-				F6BD638201B30EA301A962F7,
-				F6BD638701B30F5301A962F7,
-				3FA6DE8E042F9B380002AD8F,
-				3FA6DE8F042F9B380002AD8F,
-				3FA6DE90042F9B380002AD8F,
-				3FA6DE91042F9B380002AD8F,
-				3FA6DE92042F9B380002AD8F,
-				1BD0F22A050FFDAB00A80011,
-				1BD0F22E050FFE0100A80011,
-			);
-			isa = PBXGroup;
-			name = bin;
-			refType = 4;
-		};
-		79C235C40439FD4400202892 = {
-			isa = PBXFileReference;
-			path = appshell.xpt;
-			refType = 4;
-		};
-		79C235C50439FD4400202892 = {
-			isa = PBXFileReference;
-			path = caps.xpt;
-			refType = 4;
-		};
-		79C235C60439FD4400202892 = {
-			isa = PBXFileReference;
-			path = chrome.xpt;
-			refType = 4;
-		};
-		79C235C70439FD4400202892 = {
-			isa = PBXFileReference;
-			path = content_base.xpt;
-			refType = 4;
-		};
-		79C235C80439FD4400202892 = {
-			isa = PBXFileReference;
-			path = docshell.xpt;
-			refType = 4;
-		};
-		79C235C90439FD4500202892 = {
-			isa = PBXFileReference;
-			path = dom_base.xpt;
-			refType = 4;
-		};
-		79C235CA0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = dom_core.xpt;
-			refType = 4;
-		};
-		79C235CB0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = dom_css.xpt;
-			refType = 4;
-		};
-		79C235CC0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = dom_events.xpt;
-			refType = 4;
-		};
-		79C235CD0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = dom_html.xpt;
-			refType = 4;
-		};
-		79C235CE0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = dom_range.xpt;
-			refType = 4;
-		};
-		79C235CF0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = dom_stylesheets.xpt;
-			refType = 4;
-		};
-		79C235D00439FD4500202892 = {
-			isa = PBXFileReference;
-			path = dom_traversal.xpt;
-			refType = 4;
-		};
-		79C235D10439FD4500202892 = {
-			isa = PBXFileReference;
-			path = dom_views.xpt;
-			refType = 4;
-		};
-		79C235D20439FD4500202892 = {
-			isa = PBXFileReference;
-			path = dom_xbl.xpt;
-			refType = 4;
-		};
-		79C235D30439FD4500202892 = {
-			isa = PBXFileReference;
-			path = dom_xul.xpt;
-			refType = 4;
-		};
-		79C235D40439FD4500202892 = {
-			isa = PBXFileReference;
-			path = dom.xpt;
-			refType = 4;
-		};
-		79C235D50439FD4500202892 = {
-			isa = PBXFileReference;
-			path = editor.xpt;
-			refType = 4;
-		};
-		79C235D60439FD4500202892 = {
-			isa = PBXFileReference;
-			path = gfx.xpt;
-			refType = 4;
-		};
-		79C235D70439FD4500202892 = {
-			isa = PBXFileReference;
-			path = imglib2.xpt;
-			refType = 4;
-		};
-		79C235D80439FD4500202892 = {
-			isa = PBXFileReference;
-			path = jar.xpt;
-			refType = 4;
-		};
-		79C235DA0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = layout_base.xpt;
-			refType = 4;
-		};
-		79C235DB0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = layout_xul.xpt;
-			refType = 4;
-		};
-		79C235DC0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libcaps.dylib;
-			refType = 4;
-		};
-		79C235DD0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libchrome.dylib;
-			refType = 4;
-		};
-		79C235DE0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libcookie.dylib;
-			refType = 4;
-		};
-		79C235DF0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libdocshell.dylib;
-			refType = 4;
-		};
-		79C235E00439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libeditor.dylib;
-			refType = 4;
-		};
-		79C235E10439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libembed_lite.dylib;
-			refType = 4;
-		};
-		79C235E20439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libembedcomponents.dylib;
-			refType = 4;
-		};
-		79C235E30439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libgfx_mac.dylib;
-			refType = 4;
-		};
-		79C235E40439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libgklayout.dylib;
-			refType = 4;
-		};
-		79C235E50439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libhtmlpars.dylib;
-			refType = 4;
-		};
-		79C235E60439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libi18n.dylib;
-			refType = 4;
-		};
-		79C235E70439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libimglib2.dylib;
-			refType = 4;
-		};
-		79C235E80439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libjar50.dylib;
-			refType = 4;
-		};
-		79C235E90439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libjsdom.dylib;
-			refType = 4;
-		};
-		79C235EA0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libnecko.dylib;
-			refType = 4;
-		};
-		79C235EC0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libnsappshell.dylib;
-			refType = 4;
-		};
-		79C235ED0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libpipboot.dylib;
-			refType = 4;
-		};
-		79C235EE0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libpipnss.dylib;
-			refType = 4;
-		};
-		79C235EF0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libpref.dylib;
-			refType = 4;
-		};
-		79C235F00439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libprofile.dylib;
-			refType = 4;
-		};
-		79C235F10439FD4500202892 = {
-			isa = PBXFileReference;
-			path = librdf.dylib;
-			refType = 4;
-		};
-		79C235F20439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libuconv.dylib;
-			refType = 4;
-		};
-		79C235F30439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libwebbrwsr.dylib;
-			refType = 4;
-		};
-		79C235F40439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libwidget_mac.dylib;
-			refType = 4;
-		};
-		79C235F50439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libxmlextras.dylib;
-			refType = 4;
-		};
-		79C235F60439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libxpcom_compat_c.dylib;
-			refType = 4;
-		};
-		79C235F70439FD4500202892 = {
-			isa = PBXFileReference;
-			path = libxpconnect.dylib;
-			refType = 4;
-		};
-		79C235F80439FD4500202892 = {
-			isa = PBXFileReference;
-			path = necko_about.xpt;
-			refType = 4;
-		};
-		79C235F90439FD4500202892 = {
-			isa = PBXFileReference;
-			path = necko_cache.xpt;
-			refType = 4;
-		};
-		79C235FB0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = necko_dns.xpt;
-			refType = 4;
-		};
-		79C235FC0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = necko_ftp.xpt;
-			refType = 4;
-		};
-		79C235FD0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = necko_http.xpt;
-			refType = 4;
-		};
-		79C235FE0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = necko_jar.xpt;
-			refType = 4;
-		};
-		79C235FF0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = necko_res.xpt;
-			refType = 4;
-		};
-		79C236000439FD4500202892 = {
-			isa = PBXFileReference;
-			path = necko_strconv.xpt;
-			refType = 4;
-		};
-		79C236010439FD4500202892 = {
-			isa = PBXFileReference;
-			path = necko.xpt;
-			refType = 4;
-		};
-		79C236020439FD4500202892 = {
-			isa = PBXFileReference;
-			path = pipboot.xpt;
-			refType = 4;
-		};
-		79C236030439FD4500202892 = {
-			isa = PBXFileReference;
-			path = pipnss.xpt;
-			refType = 4;
-		};
-		79C236040439FD4500202892 = {
-			isa = PBXFileReference;
-			path = pref.xpt;
-			refType = 4;
-		};
-		79C236050439FD4500202892 = {
-			isa = PBXFileReference;
-			path = profile.xpt;
-			refType = 4;
-		};
-		79C236060439FD4500202892 = {
-			isa = PBXFileReference;
-			path = rdf.xpt;
-			refType = 4;
-		};
-		79C236070439FD4500202892 = {
-			isa = PBXFileReference;
-			path = shistory.xpt;
-			refType = 4;
-		};
-		79C236080439FD4500202892 = {
-			isa = PBXFileReference;
-			path = txtsvc.xpt;
-			refType = 4;
-		};
-		79C236090439FD4500202892 = {
-			isa = PBXFileReference;
-			path = uconv.xpt;
-			refType = 4;
-		};
-		79C2360A0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = unicharutil.xpt;
-			refType = 4;
-		};
-		79C2360B0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = uriloader.xpt;
-			refType = 4;
-		};
-		79C2360C0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = webBrowser_core.xpt;
-			refType = 4;
-		};
-		79C2360D0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = widget.xpt;
-			refType = 4;
-		};
-		79C2360E0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = windowwatcher.xpt;
-			refType = 4;
-		};
-		79C2360F0439FD4500202892 = {
-			isa = PBXFileReference;
-			path = xmlextras_interfaceinfo.xpt;
-			refType = 4;
-		};
-		79C236100439FD4500202892 = {
-			isa = PBXFileReference;
-			path = xmlextras.xpt;
-			refType = 4;
-		};
-		79C236110439FD4500202892 = {
-			isa = PBXFileReference;
-			path = xpcom_base.xpt;
-			refType = 4;
-		};
-		79C236120439FD4500202892 = {
-			isa = PBXFileReference;
-			path = xpcom_components.xpt;
-			refType = 4;
-		};
-		79C236130439FD4500202892 = {
-			isa = PBXFileReference;
-			path = xpcom_ds.xpt;
-			refType = 4;
-		};
-		79C236140439FD4500202892 = {
-			isa = PBXFileReference;
-			path = xpcom_io.xpt;
-			refType = 4;
-		};
-		79C236150439FD4500202892 = {
-			isa = PBXFileReference;
-			path = xpcom_obsolete.xpt;
-			refType = 4;
-		};
-		79C236160439FD4500202892 = {
-			isa = PBXFileReference;
-			path = xpcom_threads.xpt;
-			refType = 4;
-		};
-		79C236170439FD4500202892 = {
-			isa = PBXFileReference;
-			path = xpcom_xpti.xpt;
-			refType = 4;
-		};
-		79C236180439FD4500202892 = {
-			isa = PBXFileReference;
-			path = xpconnect.xpt;
-			refType = 4;
-		};
-		79C236190439FD4500202892 = {
-			isa = PBXFileReference;
-			path = layout_printing.xpt;
-			refType = 4;
-		};
-		79C2366E0439FF2600202892 = {
-			isa = PBXFileReference;
-			path = arrow.gif;
-			refType = 4;
-		};
-		79C2366F0439FF2600202892 = {
-			isa = PBXFileReference;
-			path = arrowd.gif;
-			refType = 4;
-		};
-		79C236700439FF2600202892 = {
-			isa = PBXFileReference;
-			path = "broken-image.gif";
-			refType = 4;
-		};
-		79C236710439FF2600202892 = {
-			fileEncoding = 30;
-			isa = PBXFileReference;
-			path = charsetalias.properties;
-			refType = 4;
-		};
-		79C236720439FF2600202892 = {
-			fileEncoding = 30;
-			isa = PBXFileReference;
-			path = charsetData.properties;
-			refType = 4;
-		};
-		79C236730439FF2600202892 = {
-			isa = PBXFileReference;
-			path = forms.css;
-			refType = 4;
-		};
-		79C236740439FF2600202892 = {
-			isa = PBXFileReference;
-			path = html.css;
-			refType = 4;
-		};
-		79C236750439FF2600202892 = {
-			fileEncoding = 30;
-			isa = PBXFileReference;
-			path = langGroups.properties;
-			refType = 4;
-		};
-		79C236760439FF2600202892 = {
-			fileEncoding = 30;
-			isa = PBXFileReference;
-			path = language.properties;
-			refType = 4;
-		};
-		79C236770439FF2600202892 = {
-			isa = PBXFileReference;
-			path = "loading-image.gif";
-			refType = 4;
-		};
-		79C236780439FF2600202892 = {
-			fileEncoding = 30;
-			isa = PBXFileReference;
-			path = maccharset.properties;
-			refType = 4;
-		};
-		79C2367A0439FF2600202892 = {
-			isa = PBXFileReference;
-			path = quirk.css;
-			refType = 4;
-		};
-		79C2367B0439FF2600202892 = {
-			isa = PBXFileReference;
-			path = ua.css;
-			refType = 4;
-		};
-		79C2367C0439FF2600202892 = {
-			isa = PBXFileReference;
-			path = viewsource.css;
-			refType = 4;
-		};
-		79C2368C0439FF3700202892 = {
-			children = (
-				79C236910439FF9A00202892,
-			);
-			isa = PBXGroup;
-			path = dtd;
-			refType = 4;
-		};
-		79C2368D0439FF8600202892 = {
-			fileEncoding = 30;
-			isa = PBXFileReference;
-			path = htmlBindings.xml;
-			refType = 4;
-		};
-		79C2368E0439FF8600202892 = {
-			fileEncoding = 30;
-			isa = PBXFileReference;
-			path = platformHTMLBindings.xml;
-			refType = 4;
-		};
-		79C236910439FF9A00202892 = {
-			fileEncoding = 30;
-			isa = PBXFileReference;
-			path = xhtml11.dtd;
-			refType = 4;
-		};
-		79C236930439FFAE00202892 = {
-			fileEncoding = 30;
-			isa = PBXFileReference;
-			path = html40Latin1.properties;
-			refType = 4;
-		};
-		79C236940439FFAE00202892 = {
-			fileEncoding = 30;
-			isa = PBXFileReference;
-			path = html40Special.properties;
-			refType = 4;
-		};
-		79C236950439FFAE00202892 = {
-			fileEncoding = 30;
-			isa = PBXFileReference;
-			path = html40Symbols.properties;
-			refType = 4;
-		};
-		79C236960439FFAE00202892 = {
-			fileEncoding = 30;
-			isa = PBXFileReference;
-			path = transliterate.properties;
-			refType = 4;
-		};
-		79C2369D043A00AC00202892 = {
-			fileRef = 79C235C40439FD4400202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C2369E043A00AC00202892 = {
-			fileRef = 79C235C50439FD4400202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C2369F043A00AC00202892 = {
-			fileRef = 79C235C60439FD4400202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236A0043A00AC00202892 = {
-			fileRef = 79C235C70439FD4400202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236A1043A00AC00202892 = {
-			fileRef = 79C235C80439FD4400202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236A2043A00AC00202892 = {
-			fileRef = 79C235C90439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236A3043A00AC00202892 = {
-			fileRef = 79C235CA0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236A4043A00AC00202892 = {
-			fileRef = 79C235CB0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236A5043A00AC00202892 = {
-			fileRef = 79C235CC0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236A6043A00AC00202892 = {
-			fileRef = 79C235CD0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236A7043A00AC00202892 = {
-			fileRef = 79C235CE0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236A8043A00AC00202892 = {
-			fileRef = 79C235CF0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236A9043A00AC00202892 = {
-			fileRef = 79C235D00439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236AA043A00AC00202892 = {
-			fileRef = 79C235D10439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236AB043A00AC00202892 = {
-			fileRef = 79C235D20439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236AC043A00AC00202892 = {
-			fileRef = 79C235D30439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236AD043A00AC00202892 = {
-			fileRef = 79C235D40439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236AE043A00AC00202892 = {
-			fileRef = 79C235D50439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236AF043A00AC00202892 = {
-			fileRef = 79C235D60439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236B0043A00AC00202892 = {
-			fileRef = 79C235D70439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236B1043A00AC00202892 = {
-			fileRef = 79C235D80439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236B4043A00AC00202892 = {
-			fileRef = 79C235DB0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236B5043A00AC00202892 = {
-			fileRef = 79C235DC0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236B6043A00AC00202892 = {
-			fileRef = 79C235DD0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236B7043A00AC00202892 = {
-			fileRef = 79C235DE0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236B8043A00AC00202892 = {
-			fileRef = 79C235DF0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236B9043A00AC00202892 = {
-			fileRef = 79C235E00439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236BA043A00AC00202892 = {
-			fileRef = 79C235E10439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236BB043A00AC00202892 = {
-			fileRef = 79C235E20439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236BC043A00AC00202892 = {
-			fileRef = 79C235E30439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236BD043A00AC00202892 = {
-			fileRef = 79C235E40439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236BE043A00AC00202892 = {
-			fileRef = 79C235E50439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236BF043A00AC00202892 = {
-			fileRef = 79C235E60439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236C0043A00AC00202892 = {
-			fileRef = 79C235E70439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236C1043A00AC00202892 = {
-			fileRef = 79C235E80439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236C2043A00AC00202892 = {
-			fileRef = 79C235E90439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236C3043A00AC00202892 = {
-			fileRef = 79C235EA0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236C5043A00AC00202892 = {
-			fileRef = 79C235EC0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236C6043A00AC00202892 = {
-			fileRef = 79C235ED0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236C7043A00AC00202892 = {
-			fileRef = 79C235EE0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236C8043A00AC00202892 = {
-			fileRef = 79C235EF0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236C9043A00AC00202892 = {
-			fileRef = 79C235F00439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236CA043A00AC00202892 = {
-			fileRef = 79C235F10439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236CB043A00AC00202892 = {
-			fileRef = 79C235F20439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236CC043A00AC00202892 = {
-			fileRef = 79C235F30439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236CD043A00AC00202892 = {
-			fileRef = 79C235F40439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236CE043A00AC00202892 = {
-			fileRef = 79C235F50439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236CF043A00AC00202892 = {
-			fileRef = 79C235F60439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236D0043A00AC00202892 = {
-			fileRef = 79C235F70439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236D1043A00AC00202892 = {
-			fileRef = 79C235F80439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236D2043A00AC00202892 = {
-			fileRef = 79C235F90439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236D4043A00AC00202892 = {
-			fileRef = 79C235FB0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236D5043A00AC00202892 = {
-			fileRef = 79C235FC0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236D6043A00AC00202892 = {
-			fileRef = 79C235FD0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236D7043A00AC00202892 = {
-			fileRef = 79C235FE0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236D8043A00AC00202892 = {
-			fileRef = 79C235FF0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236D9043A00AC00202892 = {
-			fileRef = 79C236000439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236DA043A00AC00202892 = {
-			fileRef = 79C236010439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236DB043A00AC00202892 = {
-			fileRef = 79C236020439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236DC043A00AC00202892 = {
-			fileRef = 79C236030439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236DD043A00AC00202892 = {
-			fileRef = 79C236040439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236DE043A00AC00202892 = {
-			fileRef = 79C236050439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236DF043A00AC00202892 = {
-			fileRef = 79C236060439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236E0043A00AC00202892 = {
-			fileRef = 79C236070439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236E1043A00AC00202892 = {
-			fileRef = 79C236080439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236E2043A00AC00202892 = {
-			fileRef = 79C236090439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236E3043A00AC00202892 = {
-			fileRef = 79C2360A0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236E4043A00AC00202892 = {
-			fileRef = 79C2360B0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236E5043A00AC00202892 = {
-			fileRef = 79C2360C0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236E6043A00AC00202892 = {
-			fileRef = 79C2360D0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236E7043A00AC00202892 = {
-			fileRef = 79C2360E0439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236E9043A00AC00202892 = {
-			fileRef = 79C236100439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236EA043A00AC00202892 = {
-			fileRef = 79C236110439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236EB043A00AC00202892 = {
-			fileRef = 79C236120439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236EC043A00AC00202892 = {
-			fileRef = 79C236130439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236ED043A00AC00202892 = {
-			fileRef = 79C236140439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236EE043A00AC00202892 = {
-			fileRef = 79C236150439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236EF043A00AC00202892 = {
-			fileRef = 79C236160439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236F0043A00AC00202892 = {
-			fileRef = 79C236170439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236F1043A00AC00202892 = {
-			fileRef = 79C236180439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236F2043A010D00202892 = {
-			fileRef = 79C2366E0439FF2600202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236F3043A010D00202892 = {
-			fileRef = 79C2366F0439FF2600202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236F4043A010D00202892 = {
-			fileRef = 79C236700439FF2600202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236F5043A010D00202892 = {
-			fileRef = 79C236710439FF2600202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236F6043A010D00202892 = {
-			fileRef = 79C236720439FF2600202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236F7043A010D00202892 = {
-			fileRef = 79C236730439FF2600202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236F8043A010D00202892 = {
-			fileRef = 79C236740439FF2600202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236F9043A010D00202892 = {
-			fileRef = 79C236750439FF2600202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236FA043A010D00202892 = {
-			fileRef = 79C236760439FF2600202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236FB043A010D00202892 = {
-			fileRef = 79C236770439FF2600202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236FC043A010D00202892 = {
-			fileRef = 79C236780439FF2600202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236FE043A010D00202892 = {
-			fileRef = 79C2367A0439FF2600202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C236FF043A010D00202892 = {
-			fileRef = 79C2367B0439FF2600202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C23700043A010D00202892 = {
-			fileRef = 79C2367C0439FF2600202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C23701043A012800202892 = {
-			fileRef = 79C2368D0439FF8600202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C23702043A012800202892 = {
-			fileRef = 79C2368E0439FF8600202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C23703043A014D00202892 = {
-			buildActionMask = 2147483647;
-			dstPath = res/dtd;
-			dstSubfolderSpec = 6;
-			files = (
-				79C23704043A016C00202892,
-			);
-			isa = PBXCopyFilesBuildPhase;
-			runOnlyForDeploymentPostprocessing = 0;
-		};
-		79C23704043A016C00202892 = {
-			fileRef = 79C236910439FF9A00202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C23705043A018300202892 = {
-			fileRef = 79C236930439FFAE00202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C23706043A018300202892 = {
-			fileRef = 79C236940439FFAE00202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C23707043A018300202892 = {
-			fileRef = 79C236950439FFAE00202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C23708043A018300202892 = {
-			fileRef = 79C236960439FFAE00202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C23709043A00AC00202892 = {
-			fileRef = 79C236190439FD4500202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		79C2371A043A1AE800202892 = {
-			isa = PBXFileReference;
-			name = libwidget.rsrc;
-			path = ../../../dist/bin/libwidget.rsrc;
-			refType = 2;
-		};
-		79C2371C043A1B1E00202892 = {
-			buildActionMask = 2147483647;
-			dstPath = "";
-			dstSubfolderSpec = 6;
-			files = (
-				79C2371D043A1B3100202892,
-			);
-			isa = PBXCopyFilesBuildPhase;
-			runOnlyForDeploymentPostprocessing = 0;
-		};
-		79C2371D043A1B3100202892 = {
-			fileRef = 79C2371A043A1AE800202892;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-//790
-//791
-//792
-//793
-//794
-//F50
-//F51
-//F52
-//F53
-//F54
-		F52978A80371A46C01026DCE = {
-			includeInIndex = 1;
-			isa = PBXZipArchiveReference;
-			path = pipnss.jar;
-			refType = 4;
-		};
-//F50
-//F51
-//F52
-//F53
-//F54
-//F60
-//F61
-//F62
-//F63
-//F64
-		F6901D3F01B70DB301A962F7 = {
-			fileEncoding = 30;
-			isa = PBXFileReference;
-			path = "installed-chrome.txt";
-			refType = 4;
-		};
-		F6901D4001B70DB301A962F7 = {
-			fileRef = F6901D3F01B70DB301A962F7;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		F6BA6D4E01B2F8A601A962F7 = {
-			fileEncoding = 30;
-			isa = PBXFileReference;
-			name = MyBrowserView.mm;
-			path = src/MyBrowserView.mm;
-			refType = 2;
-		};
-		F6BA6D4F01B2F8A601A962F7 = {
-			fileRef = F6BA6D4E01B2F8A601A962F7;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		F6BD637A01B30E0F01A962F7 = {
-			children = (
-				79C235C30439FC0100202892,
-				F6BD64FF01B3184301A962F7,
-				F6BD638901B30F5301A962F7,
-				F6BD64FB01B3184301A962F7,
-				F6BD645501B3167601A962F7,
-				79C2371A043A1AE800202892,
-			);
-			isa = PBXGroup;
-			name = Gecko;
-			path = ../../../dist/Embed;
-			refType = 2;
-		};
-		F6BD637B01B30E0F01A962F7 = {
-			buildActionMask = 2147483647;
-			dstPath = "";
-			dstSubfolderSpec = 6;
-			files = (
-				F6BD638A01B30F5301A962F7,
-				F6BD638B01B30F5301A962F7,
-				F6BD638D01B30F5301A962F7,
-				F6BD638E01B30F5301A962F7,
-				F6BD637D01B30E2901A962F7,
-				1BD0F22D050FFDE000A80011,
-				1BD0F230050FFE0500A80011,
-				3FA6DEC2042FC4270002AD8F,
-			);
-			isa = PBXCopyFilesBuildPhase;
-			runOnlyForDeploymentPostprocessing = 0;
-		};
-		F6BD637C01B30E2901A962F7 = {
-			isa = PBXFileReference;
-			path = libxpcom.dylib;
-			refType = 4;
-		};
-		F6BD637D01B30E2901A962F7 = {
-			fileRef = F6BD637C01B30E2901A962F7;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		F6BD637F01B30EA301A962F7 = {
-			isa = PBXFileReference;
-			path = libmozjs.dylib;
-			refType = 4;
-		};
-		F6BD638001B30EA301A962F7 = {
-			isa = PBXFileReference;
-			path = libnspr4.dylib;
-			refType = 4;
-		};
-		F6BD638101B30EA301A962F7 = {
-			isa = PBXFileReference;
-			path = libplc4.dylib;
-			refType = 4;
-		};
-		F6BD638201B30EA301A962F7 = {
-			isa = PBXFileReference;
-			path = libplds4.dylib;
-			refType = 4;
-		};
-		F6BD638701B30F5301A962F7 = {
-			isa = PBXFileReference;
-			path = libgkgfx.dylib;
-			refType = 4;
-		};
-		F6BD638901B30F5301A962F7 = {
-			children = (
-				79C235C40439FD4400202892,
-				79C235C50439FD4400202892,
-				79C235C60439FD4400202892,
-				79C235C70439FD4400202892,
-				79C235C80439FD4400202892,
-				79C235C90439FD4500202892,
-				79C235CA0439FD4500202892,
-				79C235CB0439FD4500202892,
-				79C235CC0439FD4500202892,
-				79C235CD0439FD4500202892,
-				79C235CE0439FD4500202892,
-				79C235CF0439FD4500202892,
-				79C235D00439FD4500202892,
-				79C235D10439FD4500202892,
-				79C235D20439FD4500202892,
-				79C235D30439FD4500202892,
-				79C235D40439FD4500202892,
-				79C235D50439FD4500202892,
-				79C235D60439FD4500202892,
-				79C235D70439FD4500202892,
-				79C235D80439FD4500202892,
-				79C235DA0439FD4500202892,
-				79C235DB0439FD4500202892,
-				79C235DC0439FD4500202892,
-				79C235DD0439FD4500202892,
-				79C235DE0439FD4500202892,
-				79C235DF0439FD4500202892,
-				79C235E00439FD4500202892,
-				79C235E10439FD4500202892,
-				79C235E20439FD4500202892,
-				79C235E30439FD4500202892,
-				79C235E40439FD4500202892,
-				79C235E50439FD4500202892,
-				79C235E60439FD4500202892,
-				79C235E70439FD4500202892,
-				79C235E80439FD4500202892,
-				79C235E90439FD4500202892,
-				79C235EA0439FD4500202892,
-				79C235EC0439FD4500202892,
-				79C235ED0439FD4500202892,
-				79C235EE0439FD4500202892,
-				79C235EF0439FD4500202892,
-				79C235F00439FD4500202892,
-				79C235F10439FD4500202892,
-				79C235F20439FD4500202892,
-				79C235F30439FD4500202892,
-				79C235F40439FD4500202892,
-				79C235F50439FD4500202892,
-				79C235F60439FD4500202892,
-				79C235F70439FD4500202892,
-				79C235F80439FD4500202892,
-				79C235F90439FD4500202892,
-				79C235FB0439FD4500202892,
-				79C235FC0439FD4500202892,
-				79C235FD0439FD4500202892,
-				79C235FE0439FD4500202892,
-				79C235FF0439FD4500202892,
-				79C236000439FD4500202892,
-				79C236010439FD4500202892,
-				79C236020439FD4500202892,
-				79C236030439FD4500202892,
-				79C236040439FD4500202892,
-				79C236050439FD4500202892,
-				79C236060439FD4500202892,
-				79C236070439FD4500202892,
-				79C236080439FD4500202892,
-				79C236090439FD4500202892,
-				79C2360A0439FD4500202892,
-				79C2360B0439FD4500202892,
-				79C2360C0439FD4500202892,
-				79C2360D0439FD4500202892,
-				79C2360E0439FD4500202892,
-				79C2360F0439FD4500202892,
-				79C236100439FD4500202892,
-				79C236110439FD4500202892,
-				79C236120439FD4500202892,
-				79C236130439FD4500202892,
-				79C236140439FD4500202892,
-				79C236150439FD4500202892,
-				79C236160439FD4500202892,
-				79C236170439FD4500202892,
-				79C236180439FD4500202892,
-				79C236190439FD4500202892,
-			);
-			isa = PBXGroup;
-			path = components;
-			refType = 4;
-		};
-		F6BD638A01B30F5301A962F7 = {
-			fileRef = F6BD637F01B30EA301A962F7;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		F6BD638B01B30F5301A962F7 = {
-			fileRef = F6BD638001B30EA301A962F7;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		F6BD638D01B30F5301A962F7 = {
-			fileRef = F6BD638201B30EA301A962F7;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		F6BD638E01B30F5301A962F7 = {
-			fileRef = F6BD638701B30F5301A962F7;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		F6BD639001B30F5301A962F7 = {
-			buildActionMask = 2147483647;
-			dstPath = components;
-			dstSubfolderSpec = 6;
-			files = (
-				79C2369D043A00AC00202892,
-				79C2369E043A00AC00202892,
-				79C2369F043A00AC00202892,
-				79C236A0043A00AC00202892,
-				79C236A1043A00AC00202892,
-				79C236A2043A00AC00202892,
-				79C236A3043A00AC00202892,
-				79C236A4043A00AC00202892,
-				79C236A5043A00AC00202892,
-				79C236A6043A00AC00202892,
-				79C236A7043A00AC00202892,
-				79C236A8043A00AC00202892,
-				79C236A9043A00AC00202892,
-				79C236AA043A00AC00202892,
-				79C236AB043A00AC00202892,
-				79C236AC043A00AC00202892,
-				79C236AD043A00AC00202892,
-				79C236AE043A00AC00202892,
-				79C236AF043A00AC00202892,
-				79C236B0043A00AC00202892,
-				79C236B1043A00AC00202892,
-				79C236B3043A00AC00202892,
-				79C236B4043A00AC00202892,
-				79C236B5043A00AC00202892,
-				79C236B6043A00AC00202892,
-				79C236B7043A00AC00202892,
-				79C236B8043A00AC00202892,
-				79C236B9043A00AC00202892,
-				79C236BA043A00AC00202892,
-				79C236BB043A00AC00202892,
-				79C236BC043A00AC00202892,
-				79C236BD043A00AC00202892,
-				79C236BE043A00AC00202892,
-				79C236BF043A00AC00202892,
-				79C236C0043A00AC00202892,
-				79C236C1043A00AC00202892,
-				79C236C2043A00AC00202892,
-				79C236C3043A00AC00202892,
-				79C236C5043A00AC00202892,
-				79C236C6043A00AC00202892,
-				79C236C7043A00AC00202892,
-				79C236C8043A00AC00202892,
-				79C236C9043A00AC00202892,
-				79C236CA043A00AC00202892,
-				79C236CB043A00AC00202892,
-				79C236CC043A00AC00202892,
-				79C236CD043A00AC00202892,
-				79C236CE043A00AC00202892,
-				79C236CF043A00AC00202892,
-				79C236D0043A00AC00202892,
-				79C236D1043A00AC00202892,
-				79C236D2043A00AC00202892,
-				79C236D4043A00AC00202892,
-				79C236D5043A00AC00202892,
-				79C236D6043A00AC00202892,
-				79C236D7043A00AC00202892,
-				79C236D8043A00AC00202892,
-				79C236D9043A00AC00202892,
-				79C236DA043A00AC00202892,
-				79C236DB043A00AC00202892,
-				79C236DC043A00AC00202892,
-				79C236DD043A00AC00202892,
-				79C236DE043A00AC00202892,
-				79C236DF043A00AC00202892,
-				79C236E0043A00AC00202892,
-				79C236E1043A00AC00202892,
-				79C236E2043A00AC00202892,
-				79C236E3043A00AC00202892,
-				79C236E4043A00AC00202892,
-				79C236E5043A00AC00202892,
-				79C236E6043A00AC00202892,
-				79C236E7043A00AC00202892,
-				79C236E9043A00AC00202892,
-				79C236EA043A00AC00202892,
-				79C236EB043A00AC00202892,
-				79C236EC043A00AC00202892,
-				79C236ED043A00AC00202892,
-				79C236EE043A00AC00202892,
-				79C236EF043A00AC00202892,
-				79C236F0043A00AC00202892,
-				79C236F1043A00AC00202892,
-				79C23709043A00AC00202892,
-			);
-			isa = PBXCopyFilesBuildPhase;
-			runOnlyForDeploymentPostprocessing = 0;
-		};
-		F6BD645501B3167601A962F7 = {
-			children = (
-				79C2366E0439FF2600202892,
-				79C2366F0439FF2600202892,
-				79C236700439FF2600202892,
-				F6BD64C801B3172601A962F7,
-				79C236710439FF2600202892,
-				79C236720439FF2600202892,
-				79C2368C0439FF3700202892,
-				F6BD64D701B3172601A962F7,
-				79C236730439FF2600202892,
-				79C236740439FF2600202892,
-				79C236750439FF2600202892,
-				79C236760439FF2600202892,
-				79C236770439FF2600202892,
-				79C236780439FF2600202892,
-				79C2367A0439FF2600202892,
-				79C2367B0439FF2600202892,
-				79C2367C0439FF2600202892,
-			);
-			isa = PBXGroup;
-			path = res;
-			refType = 4;
-		};
-		F6BD64B701B3167601A962F7 = {
-			buildActionMask = 2147483647;
-			dstPath = res;
-			dstSubfolderSpec = 6;
-			files = (
-				79C236F2043A010D00202892,
-				79C236F3043A010D00202892,
-				79C236F4043A010D00202892,
-				79C236F5043A010D00202892,
-				79C236F6043A010D00202892,
-				79C236F7043A010D00202892,
-				79C236F8043A010D00202892,
-				79C236F9043A010D00202892,
-				79C236FA043A010D00202892,
-				79C236FB043A010D00202892,
-				79C236FC043A010D00202892,
-				79C236FE043A010D00202892,
-				79C236FF043A010D00202892,
-				79C23700043A010D00202892,
-			);
-			isa = PBXCopyFilesBuildPhase;
-			runOnlyForDeploymentPostprocessing = 0;
-		};
-		F6BD64C801B3172601A962F7 = {
-			children = (
-				79C2368D0439FF8600202892,
-				79C2368E0439FF8600202892,
-			);
-			isa = PBXGroup;
-			path = builtin;
-			refType = 4;
-		};
-		F6BD64D701B3172601A962F7 = {
-			children = (
-				79C236930439FFAE00202892,
-				79C236940439FFAE00202892,
-				79C236950439FFAE00202892,
-				79C236960439FFAE00202892,
-			);
-			isa = PBXGroup;
-			path = entityTables;
-			refType = 4;
-		};
-		F6BD64FB01B3184301A962F7 = {
-			children = (
-				79C235C20439FBC700202892,
-			);
-			isa = PBXGroup;
-			path = defaults;
-			refType = 4;
-		};
-		F6BD64FC01B3184301A962F7 = {
-			isa = PBXFileReference;
-			path = all.js;
-			refType = 4;
-		};
-		F6BD64FE01B3184301A962F7 = {
-			isa = PBXFileReference;
-			path = macprefs.js;
-			refType = 4;
-		};
-		F6BD64FF01B3184301A962F7 = {
-			children = (
-				F6BD650001B3184301A962F7,
-				F6901D3F01B70DB301A962F7,
-				F52978A80371A46C01026DCE,
-			);
-			isa = PBXGroup;
-			path = chrome;
-			refType = 4;
-		};
-		F6BD650001B3184301A962F7 = {
-			isa = PBXFileReference;
-			path = embed.jar;
-			refType = 4;
-		};
-		F6BD650A01B3184301A962F7 = {
-			buildActionMask = 2147483647;
-			dstPath = res/builtin;
-			dstSubfolderSpec = 6;
-			files = (
-				79C23701043A012800202892,
-				79C23702043A012800202892,
-			);
-			isa = PBXCopyFilesBuildPhase;
-			runOnlyForDeploymentPostprocessing = 0;
-		};
-		F6BD651901B3184301A962F7 = {
-			buildActionMask = 2147483647;
-			dstPath = res/entityTables;
-			dstSubfolderSpec = 6;
-			files = (
-				79C23705043A018300202892,
-				79C23706043A018300202892,
-				79C23707043A018300202892,
-				79C23708043A018300202892,
-			);
-			isa = PBXCopyFilesBuildPhase;
-			runOnlyForDeploymentPostprocessing = 0;
-		};
-		F6BD651F01B3184301A962F7 = {
-			buildActionMask = 2147483647;
-			dstPath = defaults/pref;
-			dstSubfolderSpec = 6;
-			files = (
-				F6BD652001B3184301A962F7,
-				F6BD652201B3184301A962F7,
-				3FA6DEC8042FCC590002AD8F,
-			);
-			isa = PBXCopyFilesBuildPhase;
-			runOnlyForDeploymentPostprocessing = 0;
-		};
-		F6BD652001B3184301A962F7 = {
-			fileRef = F6BD64FC01B3184301A962F7;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		F6BD652201B3184301A962F7 = {
-			fileRef = F6BD64FE01B3184301A962F7;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		F6BD652301B3184301A962F7 = {
-			buildActionMask = 2147483647;
-			dstPath = chrome;
-			dstSubfolderSpec = 6;
-			files = (
-				F6BD652401B3184301A962F7,
-				F6901D4001B70DB301A962F7,
-			);
-			isa = PBXCopyFilesBuildPhase;
-			runOnlyForDeploymentPostprocessing = 0;
-		};
-		F6BD652401B3184301A962F7 = {
-			fileRef = F6BD650001B3184301A962F7;
-			isa = PBXBuildFile;
-			settings = {
-			};
-		};
-		F6C4515D01B5A8A601A962F7 = {
-			isa = PBXFrameworkReference;
-			name = CHBrowserView.framework;
-			path = ../../browser/cocoa/build/CHBrowserView.framework;
-			refType = 2;
-		};
-	};
-	rootObject = 29B97313FDCFA39411CA2CEA;
-}
diff -r 1aecd2a9914d embedding/tests/cocoaEmbed/Makefile.in
--- a/embedding/tests/cocoaEmbed/Makefile.in	Tue Sep 16 16:40:57 2008 +1200
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,58 +0,0 @@
-# ***** BEGIN LICENSE BLOCK *****
-# Version: Mozilla-sample-code 1.0
-#
-# Copyright (c) 2002 Netscape Communications Corporation and
-# other contributors
-#
-# Permission is hereby granted, free of charge, to any person obtaining a
-# copy of this Mozilla sample software and associated documentation files
-# (the "Software"), to deal in the Software without restriction, including
-# without limitation the rights to use, copy, modify, merge, publish,
-# distribute, sublicense, and/or sell copies of the Software, and to permit
-# persons to whom the Software is furnished to do so, subject to the
-# following conditions:
-#
-# The above copyright notice and this permission notice shall be included
-# in all copies or substantial portions of the Software.
-#
-# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
-# OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
-# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
-# THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
-# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
-# FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
-# DEALINGS IN THE SOFTWARE.
-#
-# Contributor(s):
-#   Conrad Carlen <ccarlen@netscape.com>
-#
-# ***** END LICENSE BLOCK *****
-
-DEPTH		= ../../../
-topsrcdir	= @top_srcdir@
-srcdir		= @srcdir@
-VPATH		= @srcdir@
-
-include $(DEPTH)/config/autoconf.mk
-
-ifdef MOZ_DEBUG
-BUILDSTYLE	= Development
-else
-BUILDSTYLE	= Deployment
-endif
-
-include $(topsrcdir)/config/rules.mk
-
-ABS_topsrcdir   := $(shell cd $(topsrcdir); pwd)
-ifneq ($(ABS_topsrcdir),$(MOZ_BUILD_ROOT))
-export::
-	rsync -a --exclude .DS_Store --exclude "CVS/" $(srcdir)/CocoaEmbed.pbproj .
-	ln -fs $(srcdir)/src
-	ln -fs $(srcdir)/res
-endif
-
-libs::
-	pbxbuild -buildstyle $(BUILDSTYLE) build
-
-clean clobber::
-	rm -rf build
diff -r 1aecd2a9914d embedding/tests/cocoaEmbed/res/English.lproj/InfoPlist.strings
Binary file embedding/tests/cocoaEmbed/res/English.lproj/InfoPlist.strings has changed
diff -r 1aecd2a9914d embedding/tests/cocoaEmbed/res/English.lproj/MainMenu.nib/classes.nib
--- a/embedding/tests/cocoaEmbed/res/English.lproj/MainMenu.nib/classes.nib	Tue Sep 16 16:40:57 2008 +1200
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,13 +0,0 @@
-{
-    IBClasses = (
-        {CLASS = FirstResponder; LANGUAGE = ObjC; SUPERCLASS = NSObject; }, 
-        {
-            ACTIONS = {load = id; }; 
-            CLASS = MyBrowserView; 
-            LANGUAGE = ObjC; 
-            OUTLETS = {progress = id; progressSuper = id; status = id; urlbar = id; }; 
-            SUPERCLASS = NSView; 
-        }
-    ); 
-    IBVersion = 1; 
-}
\ No newline at end of file
diff -r 1aecd2a9914d embedding/tests/cocoaEmbed/res/English.lproj/MainMenu.nib/info.nib
--- a/embedding/tests/cocoaEmbed/res/English.lproj/MainMenu.nib/info.nib	Tue Sep 16 16:40:57 2008 +1200
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,22 +0,0 @@
-<?xml version="1.0" encoding="UTF-8"?>
-<!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
-<plist version="1.0">
-<dict>
-	<key>IBDocumentLocation</key>
-	<string>546 55 356 240 0 0 1152 848 </string>
-	<key>IBEditorPositions</key>
-	<dict>
-		<key>29</key>
-		<string>69 252 302 44 0 0 1152 848 </string>
-	</dict>
-	<key>IBFramework Version</key>
-	<string>291.0</string>
-	<key>IBOpenObjects</key>
-	<array>
-		<integer>21</integer>
-		<integer>29</integer>
-	</array>
-	<key>IBSystem Version</key>
-	<string>6I32</string>
-</dict>
-</plist>
diff -r 1aecd2a9914d embedding/tests/cocoaEmbed/res/English.lproj/MainMenu.nib/objects.nib
Binary file embedding/tests/cocoaEmbed/res/English.lproj/MainMenu.nib/objects.nib has changed
diff -r 1aecd2a9914d embedding/tests/cocoaEmbed/src/MyBrowserView.h
--- a/embedding/tests/cocoaEmbed/src/MyBrowserView.h	Tue Sep 16 16:40:57 2008 +1200
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,41 +0,0 @@
-#import <Cocoa/Cocoa.h>
-#import "CHBrowserView.h"
-
-@interface MyBrowserView : NSView <CHBrowserListener, CHBrowserContainer>
-{
-    IBOutlet id urlbar;
-    IBOutlet id status;
-    IBOutlet id progress;
-    IBOutlet id progressSuper;
-    CHBrowserView* browserView;
-    NSString* defaultStatus;
-    NSString* loadingStatus;
-}
-- (IBAction)load:(id)sender;
-- (void)awakeFromNib;
-- (void)setFrame:(NSRect)frameRect;
-
-// CHBrowserListener messages
-- (void)onLoadingStarted;
-- (void)onLoadingCompleted:(BOOL)succeeded;
-- (void)onProgressChange:(int)currentBytes outOf:(int)maxBytes;
-- (void)onLocationChange:(NSString*)url;
-- (void)onStatusChange:(NSString*)aMessage;
-- (void)onSecurityStateChange:(unsigned long)newState;
-// Called when a context menu should be shown.
-- (void)onShowContextMenu:(int)flags domEvent:(nsIDOMEvent*)aEvent domNode:(nsIDOMNode*)aNode;
-// Called when a tooltip should be shown or hidden
-- (void)onShowTooltip:(NSPoint)where withText:(NSString*)text;
-- (void)onHideTooltip;
-
-// CHBrowserContainer messages
-- (void)setStatus:(NSString *)statusString ofType:(NSStatusType)type;
-- (NSString *)title;
-- (void)setTitle:(NSString *)title;
-- (void)sizeBrowserTo:(NSSize)dimensions;
-- (CHBrowserView*)createBrowserWindow:(unsigned int)mask;
-- (NSMenu*)contextMenu;
-- (NSWindow*)nativeWindow;
-- (BOOL)shouldAcceptDragFromSource:(id)dragSource;
-
-@end
diff -r 1aecd2a9914d embedding/tests/cocoaEmbed/src/MyBrowserView.mm
--- a/embedding/tests/cocoaEmbed/src/MyBrowserView.mm	Tue Sep 16 16:40:57 2008 +1200
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,198 +0,0 @@
-#import "MyBrowserView.h"
-
-#define DOCUMENT_DONE_STRING @"Document: Done"
-#define LOADING_STRING @"Loading..."
-
-@implementation MyBrowserView
-
-- (IBAction)load:(id)sender
-{
-  NSString* str = [urlbar stringValue];
-  [browserView loadURI:str referrer:nil flags:NSLoadFlagsNone];
-}
-
-- (void)awakeFromNib 
-{
-  NSRect bounds = [self bounds];
-  browserView = [[CHBrowserView alloc] initWithFrame:bounds];
-  [self addSubview:browserView];
-  [browserView setContainer:self];
-  [browserView addListener:self];
-
-  defaultStatus = NULL;
-  loadingStatus = DOCUMENT_DONE_STRING;
-  [status setStringValue:loadingStatus];
-
-  [progress retain];
-  [progress removeFromSuperview];
-}
-
-- (void)setFrame:(NSRect)frameRect
-{
-  [super setFrame:frameRect];
-  NSRect bounds = [self bounds];
-  [browserView setFrame:bounds];
-}
-
-- (void)onLoadingStarted 
-{
-  if (defaultStatus) {
-    [defaultStatus release];
-    defaultStatus = NULL;
-  }
-
-  [progressSuper addSubview:progress];
-  [progress release];
-  [progress setIndeterminate:YES];
-  [progress startAnimation:self];
-
-  loadingStatus = LOADING_STRING;
-  [status setStringValue:loadingStatus];
-
-#ifdef DEBUG_vidur
-  printf("Starting to load\n");
-#endif
-}
-
-- (void)onLoadingCompleted:(BOOL)succeeded
-{
-  [progress setIndeterminate:YES];
-  [progress stopAnimation:self];
-  [progress retain];
-  [progress removeFromSuperview];
-
-  loadingStatus = DOCUMENT_DONE_STRING;
-  if (defaultStatus) {
-    [status setStringValue:defaultStatus];
-  }
-  else {
-    [status setStringValue:loadingStatus];
-  }
-
-  [browserView setActive:YES];
-#ifdef DEBUG_vidur
-  printf("Loading completed\n");
-#endif
-}
-
-- (void)onProgressChange:(int)currentBytes outOf:(int)maxBytes 
-{
-  if (maxBytes > 0) {
-    BOOL isIndeterminate = [progress isIndeterminate];
-    if (isIndeterminate) {
-      [progress setIndeterminate:NO];
-    }
-    double val = ((double)currentBytes / (double)maxBytes) * 100.0;
-    [progress setDoubleValue:val];
-#ifdef DEBUG_vidur
-    printf("Progress notification: %f%%\n", val);
-#endif
-  }
-}
-
-- (void)onLocationChange:(NSString*)url 
-{
-  [urlbar setStringValue:url];
-  
-#ifdef DEBUG_vidur
-  const char* str = [spec cString];
-  printf("Location changed to: %s\n", str);
-#endif
-}
-
-- (void)setStatus:(NSString *)statusString ofType:(NSStatusType)type 
-{
-  if (type == NSStatusTypeScriptDefault) {
-    if (defaultStatus) {
-      [defaultStatus release];
-    }
-    defaultStatus = statusString;
-    if (defaultStatus) {
-      [defaultStatus retain];
-    }
-  }
-  else if (!statusString) {
-    if (defaultStatus) {
-      [status setStringValue:defaultStatus];
-    }
-    else {
-      [status setStringValue:loadingStatus];
-    }      
-  }
-  else {
-    [status setStringValue:statusString];
-  }
-}
-
-- (void)onStatusChange:(NSString*)aMessage
-{
-  NSLog(@"Status is %@", aMessage);
-}
-
-- (void)onSecurityStateChange:(unsigned long)newState
-{
-}
-
-- (void)onShowContextMenu:(int)flags domEvent:(nsIDOMEvent*)aEvent domNode:(nsIDOMNode*)aNode
-{
-  NSLog(@"Showing context menu");
-}
-
-- (void)onShowTooltip:(NSPoint)where withText:(NSString*)text
-{
-  NSLog(@"Showing tooltip %@", text);
-}
-
-- (void)onHideTooltip
-{
-}
-
-- (NSString *)title 
-{
-  NSWindow* window = [self window];
-  NSString* str = [window title];
-  return str;
-}
-
-- (void)setTitle:(NSString *)title
-{
-  NSWindow* window = [self window];
-  [window setTitle:title];
-}
-
-- (void)sizeBrowserTo:(NSSize)dimensions
-{
-  NSRect bounds = [self bounds];
-  float dx = dimensions.width - bounds.size.width;
-  float dy = dimensions.height - bounds.size.height;
-
-  NSWindow* window = [self window];
-  NSRect frame = [window frame];
-  frame.size.width += dx;
-  frame.size.height += dy;
-
-  [window setFrame:frame display:YES];
-}
-
-- (CHBrowserView*)createBrowserWindow:(unsigned int)mask
-{
-  // XXX not implemented 
-  return NULL;
-}
-
-- (NSMenu*)contextMenu
-{
-  return nil;
-}
-
-- (NSWindow*)nativeWindow
-{
-  return [self window];
-}
-
-- (BOOL)shouldAcceptDragFromSource:(id)dragSource
-{
-  return NO;
-}
-
-@end
diff -r 1aecd2a9914d embedding/tests/cocoaEmbed/src/main.mm
--- a/embedding/tests/cocoaEmbed/src/main.mm	Tue Sep 16 16:40:57 2008 +1200
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,6 +0,0 @@
-#import <Cocoa/Cocoa.h>
-
-int main(int argc, const char *argv[])
-{
-    return NSApplicationMain(argc, argv);
-}
diff -r 1aecd2a9914d gfx/cairo/README
--- a/gfx/cairo/README	Tue Sep 16 16:40:57 2008 +1200
+++ b/gfx/cairo/README	Thu Sep 18 08:03:23 2008 -0500
@@ -3,17 +3,17 @@ We only include the relevant parts of ea
 We only include the relevant parts of each release (generally, src/*.[ch]),
 as we have Makefile.in's that integrate into the Mozilla build system.  For
 documentation and similar, please see the official tarballs at
 http://www.cairographics.org/.
 
 VERSIONS:
 
   cairo (1.7.4-136-g5ea2555)
-  pixman (pixman-0.11.8-17-gf9d3f37)
+  pixman (pixman-0.11.10-8-g7180230)
 
 ***** NOTE FOR VISUAL C++ 6.0 *****
 
 VC6 is not supported.  Please upgrade to VC8.
 
 ==== Patches ====
 
 Some specific things:
diff -r 1aecd2a9914d gfx/cairo/libpixman/src/Makefile.in
--- a/gfx/cairo/libpixman/src/Makefile.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/gfx/cairo/libpixman/src/Makefile.in	Thu Sep 18 08:03:23 2008 -0500
@@ -57,31 +57,38 @@ ifeq ($(OS_ARCH),WINNT)
 ifeq ($(OS_ARCH),WINNT)
 # FIXME: bug 413019
 OS_COMPILE_CFLAGS += -GL-
 MODULE_OPTIMIZE_FLAGS = -O2
 endif
 endif
 
 # Build MMX code either with VC or with gcc-on-x86
+ifneq (arm,$(findstring arm,$(OS_TEST)))
 ifdef _MSC_VER
 USE_MMX=1
 #USE_SSE2=1
 MMX_CFLAGS=
 endif
 
 ifdef GNU_CC
 ifeq (86,$(findstring 86,$(OS_TEST)))
 USE_MMX=1
 MMX_CFLAGS=-mmmx -Winline
 # See bug 410509 why we can't use SSE2 yet on linux
 #USE_SSE2=1
 #MMX_CFLAGS+=-msse -msse2
 ifneq ($(MOZ_WIDGET_TOOLKIT),os2)
 MMX_CFLAGS+=--param inline-unit-growth=10000 --param large-function-growth=10000
+endif
+endif
+endif
+ifeq (arm,$(findstring arm,$(OS_TEST)))
+ifdef HAVE_ARM_SIMD
+USE_ARM=1
 endif
 endif
 endif
 
 
 CSRCS	= \
 	pixman-access.c \
 	pixman-access-accessors.c \
@@ -113,16 +120,21 @@ DEFINES += -DUSE_SSE -DUSE_SSE2
 DEFINES += -DUSE_SSE -DUSE_SSE2
 endif
 
 ifdef USE_VMX
 CSRCS += pixman-vmx.c
 DEFINES += -DUSE_VMX
 endif
 
+ifdef USE_ARM
+CSRCS += pixman-arm.c
+DEFINE += -DUSE_ARM
+endif
+
 EXPORTS		= pixman.h pixman-version.h
 
 LOCAL_INCLUDES	+= -I$(srcdir) -I$(srcdir)/../../cairo/src
 
 FORCE_STATIC_LIB = 1
 # This library is used by other shared libs in a static build
 FORCE_USE_PIC = 1
 
diff -r 1aecd2a9914d gfx/cairo/libpixman/src/pixman-arm.c
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/gfx/cairo/libpixman/src/pixman-arm.c	Thu Sep 18 08:03:23 2008 -0500
@@ -0,0 +1,409 @@
+/*
+ * Copyright  2008 Mozilla Corporation
+ *
+ * Permission to use, copy, modify, distribute, and sell this software and its
+ * documentation for any purpose is hereby granted without fee, provided that
+ * the above copyright notice appear in all copies and that both that
+ * copyright notice and this permission notice appear in supporting
+ * documentation, and that the name of Mozilla Corporation not be used in
+ * advertising or publicity pertaining to distribution of the software without
+ * specific, written prior permission.  Mozilla Corporation makes no
+ * representations about the suitability of this software for any purpose.  It
+ * is provided "as is" without express or implied warranty.
+ *
+ * THE COPYRIGHT HOLDERS DISCLAIM ALL WARRANTIES WITH REGARD TO THIS
+ * SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND
+ * FITNESS, IN NO EVENT SHALL THE COPYRIGHT HOLDERS BE LIABLE FOR ANY
+ * SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
+ * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN
+ * AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING
+ * OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS
+ * SOFTWARE.
+ *
+ * Author:  Jeff Muizelaar (jeff@infidigm.net)
+ *
+ */
+#ifdef HAVE_CONFIG_H
+#include <config.h>
+#endif
+
+#include "pixman-arm.h"
+
+void
+fbCompositeSrcAdd_8000x8000arm (pixman_op_t op,
+				pixman_image_t * pSrc,
+				pixman_image_t * pMask,
+				pixman_image_t * pDst,
+				int16_t      xSrc,
+				int16_t      ySrc,
+				int16_t      xMask,
+				int16_t      yMask,
+				int16_t      xDst,
+				int16_t      yDst,
+				uint16_t     width,
+				uint16_t     height)
+{
+    uint8_t	*dstLine, *dst;
+    uint8_t	*srcLine, *src;
+    int	dstStride, srcStride;
+    uint16_t	w;
+    uint8_t	s, d;
+
+    fbComposeGetStart (pSrc, xSrc, ySrc, uint8_t, srcStride, srcLine, 1);
+    fbComposeGetStart (pDst, xDst, yDst, uint8_t, dstStride, dstLine, 1);
+
+    while (height--)
+    {
+	dst = dstLine;
+	dstLine += dstStride;
+	src = srcLine;
+	srcLine += srcStride;
+	w = width;
+
+	while (w && (unsigned long)dst & 3)
+	{
+	    s = *src;
+	    d = *dst;
+	    asm("uqadd8 %0, %1, %2" : "+r"(d) : "r"(s));
+	    *dst = d;
+
+	    dst++;
+	    src++;
+	    w--;
+	}
+
+	while (w >= 4)
+	{
+	    asm("uqadd8 %0, %1, %2" : "=r"(*(uint32_t*)dst) : "r"(*(uint32_t*)src), "r"(*(uint32_t*)dst));
+	    dst += 4;
+	    src += 4;
+	    w -= 4;
+	}
+
+	while (w)
+	{
+	    s = *src;
+	    d = *dst;
+	    asm("uqadd8 %0, %1, %2" : "+r"(d) : "r"(s));
+	    *dst = d;
+
+	    dst++;
+	    src++;
+	    w--;
+	}
+    }
+
+}
+
+void
+fbCompositeSrc_8888x8888arm (pixman_op_t op,
+			 pixman_image_t * pSrc,
+			 pixman_image_t * pMask,
+			 pixman_image_t * pDst,
+			 int16_t      xSrc,
+			 int16_t      ySrc,
+			 int16_t      xMask,
+			 int16_t      yMask,
+			 int16_t      xDst,
+			 int16_t      yDst,
+			 uint16_t     width,
+			 uint16_t     height)
+{
+    uint32_t	*dstLine, *dst;
+    uint32_t	*srcLine, *src;
+    int	dstStride, srcStride;
+    uint16_t	w;
+    uint32_t component_half = 0x800080;
+    uint32_t upper_component_mask = 0xff00ff00;
+    uint32_t alpha_mask = 0xff;
+
+    fbComposeGetStart (pDst, xDst, yDst, uint32_t, dstStride, dstLine, 1);
+    fbComposeGetStart (pSrc, xSrc, ySrc, uint32_t, srcStride, srcLine, 1);
+
+    while (height--)
+    {
+	dst = dstLine;
+	dstLine += dstStride;
+	src = srcLine;
+	srcLine += srcStride;
+	w = width;
+
+//#define inner_branch
+	asm volatile (
+			"cmp %[w], #0\n\t"
+			"beq 2f\n\t"
+			"1:\n\t"
+			/* load dest */
+			"ldr r5, [%[src]], #4\n\t"
+#ifdef inner_branch
+			/* We can avoid doing the multiplication in two cases: 0x0 or 0xff.
+			 * The 0x0 case also allows us to avoid doing an unecessary data
+			 * write which is more valuable so we only check for that */
+			"cmp r5, #0x1000000\n\t"
+			"blt 3f\n\t"
+
+			/* = 255 - alpha */
+			"sub r8, %[alpha_mask], r5, lsr #24\n\t"
+
+			"ldr r4, [%[dest]] \n\t"
+
+#else
+			"ldr r4, [%[dest]] \n\t"
+
+			/* = 255 - alpha */
+			"sub r8, %[alpha_mask], r5, lsr #24\n\t"
+#endif
+			"uxtb16 r6, r4\n\t"
+			"uxtb16 r7, r4, ror #8\n\t"
+
+			/* multiply by 257 and divide by 65536 */
+			"mla r6, r6, r8, %[component_half]\n\t"
+			"mla r7, r7, r8, %[component_half]\n\t"
+
+			"uxtab16 r6, r6, r6, ror #8\n\t"
+			"uxtab16 r7, r7, r7, ror #8\n\t"
+
+			/* recombine the 0xff00ff00 bytes of r6 and r7 */
+			"and r7, %[upper_component_mask]\n\t"
+			"uxtab16 r6, r7, r6, ror #8\n\t"
+
+			"uqadd8 r5, r6, r5\n\t"
+
+#ifdef inner_branch
+			"3:\n\t"
+
+#endif
+			"str r5, [%[dest]], #4\n\t"
+			/* increment counter and jmp to top */
+			"subs	%[w], %[w], #1\n\t"
+			"bne	1b\n\t"
+			"2:\n\t"
+			: [w] "+r" (w), [dest] "+r" (dst), [src] "+r" (src)
+			: [component_half] "r" (component_half), [upper_component_mask] "r" (upper_component_mask),
+			  [alpha_mask] "r" (alpha_mask)
+			: "r4", "r5", "r6", "r7", "r8", "cc", "memory"
+			);
+    }
+}
+
+void
+fbCompositeSrc_8888x8x8888arm (pixman_op_t op,
+			       pixman_image_t * pSrc,
+			       pixman_image_t * pMask,
+			       pixman_image_t * pDst,
+			       int16_t	xSrc,
+			       int16_t	ySrc,
+			       int16_t      xMask,
+			       int16_t      yMask,
+			       int16_t      xDst,
+			       int16_t      yDst,
+			       uint16_t     width,
+			       uint16_t     height)
+{
+    uint32_t	*dstLine, *dst;
+    uint32_t	*srcLine, *src;
+    uint32_t	mask;
+    int	dstStride, srcStride;
+    uint16_t	w;
+    uint32_t component_half = 0x800080;
+    uint32_t alpha_mask = 0xff;
+
+    fbComposeGetStart (pDst, xDst, yDst, uint32_t, dstStride, dstLine, 1);
+    fbComposeGetStart (pSrc, xSrc, ySrc, uint32_t, srcStride, srcLine, 1);
+
+    fbComposeGetSolid (pMask, mask, pDst->bits.format);
+    mask = (mask) >> 24;
+
+    while (height--)
+    {
+	dst = dstLine;
+	dstLine += dstStride;
+	src = srcLine;
+	srcLine += srcStride;
+	w = width;
+
+//#define inner_branch
+	asm volatile (
+			"cmp %[w], #0\n\t"
+			"beq 2f\n\t"
+			"1:\n\t"
+			/* load dest */
+			"ldr r5, [%[src]], #4\n\t"
+#ifdef inner_branch
+			/* We can avoid doing the multiplication in two cases: 0x0 or 0xff.
+			 * The 0x0 case also allows us to avoid doing an unecessary data
+			 * write which is more valuable so we only check for that */
+			"cmp r5, #0x1000000\n\t"
+			"blt 3f\n\t"
+
+#endif
+			"ldr r4, [%[dest]] \n\t"
+
+			"uxtb16 r6, r5\n\t"
+			"uxtb16 r7, r5, ror #8\n\t"
+
+			/* multiply by alpha (r8) then by 257 and divide by 65536 */
+			"mla r6, r6, %[mask_alpha], %[component_half]\n\t"
+			"mla r7, r7, %[mask_alpha], %[component_half]\n\t"
+
+			"uxtab16 r6, r6, r6, ror #8\n\t"
+			"uxtab16 r7, r7, r7, ror #8\n\t"
+
+			"uxtb16 r6, r6, ror #8\n\t"
+			"uxtb16 r7, r7, ror #8\n\t"
+
+			/* recombine */
+			"orr r5, r6, r7, lsl #8\n\t"
+
+			"uxtb16 r6, r4\n\t"
+			"uxtb16 r7, r4, ror #8\n\t"
+
+			/* 255 - alpha */
+			"sub r8, %[alpha_mask], r5, lsr #24\n\t"
+
+			/* multiply by alpha (r8) then by 257 and divide by 65536 */
+			"mla r6, r6, r8, %[component_half]\n\t"
+			"mla r7, r7, r8, %[component_half]\n\t"
+
+			"uxtab16 r6, r6, r6, ror #8\n\t"
+			"uxtab16 r7, r7, r7, ror #8\n\t"
+
+			"uxtb16 r6, r6, ror #8\n\t"
+			"uxtb16 r7, r7, ror #8\n\t"
+
+			/* recombine */
+			"orr r6, r6, r7, lsl #8\n\t"
+
+			"uqadd8 r5, r6, r5\n\t"
+
+#ifdef inner_branch
+			"3:\n\t"
+
+#endif
+			"str r5, [%[dest]], #4\n\t"
+			/* increment counter and jmp to top */
+			"subs	%[w], %[w], #1\n\t"
+			"bne	1b\n\t"
+			"2:\n\t"
+			: [w] "+r" (w), [dest] "+r" (dst), [src] "+r" (src)
+			: [component_half] "r" (component_half), [mask_alpha] "r" (mask),
+			  [alpha_mask] "r" (alpha_mask)
+			: "r4", "r5", "r6", "r7", "r8", "r9", "cc", "memory"
+			);
+    }
+}
+
+void
+fbCompositeSolidMask_nx8x8888arm (pixman_op_t      op,
+			       pixman_image_t * pSrc,
+			       pixman_image_t * pMask,
+			       pixman_image_t * pDst,
+			       int16_t      xSrc,
+			       int16_t      ySrc,
+			       int16_t      xMask,
+			       int16_t      yMask,
+			       int16_t      xDst,
+			       int16_t      yDst,
+			       uint16_t     width,
+			       uint16_t     height)
+{
+    uint32_t	 src, srca;
+    uint32_t	*dstLine, *dst;
+    uint8_t	*maskLine, *mask;
+    int		 dstStride, maskStride;
+    uint16_t	 w;
+
+    fbComposeGetSolid(pSrc, src, pDst->bits.format);
+
+    srca = src >> 24;
+    if (src == 0)
+	return;
+
+    uint32_t component_mask = 0xff00ff;
+    uint32_t component_half = 0x800080;
+
+    uint32_t src_hi = (src >> 8) & component_mask;
+    uint32_t src_lo = src & component_mask;
+
+    fbComposeGetStart (pDst, xDst, yDst, uint32_t, dstStride, dstLine, 1);
+    fbComposeGetStart (pMask, xMask, yMask, uint8_t, maskStride, maskLine, 1);
+
+    while (height--)
+    {
+	dst = dstLine;
+	dstLine += dstStride;
+	mask = maskLine;
+	maskLine += maskStride;
+	w = width;
+
+//#define inner_branch
+	asm volatile (
+			"cmp %[w], #0\n\t"
+			"beq 2f\n\t"
+			"1:\n\t"
+			/* load mask */
+			"ldrb r5, [%[mask]], #1\n\t"
+#ifdef inner_branch
+			/* We can avoid doing the multiplication in two cases: 0x0 or 0xff.
+			 * The 0x0 case also allows us to avoid doing an unecessary data
+			 * write which is more valuable so we only check for that */
+			/* 0x1000000 is the least value that contains alpha all values
+			 * less than it have a 0 alpha value */
+			"cmp r5, #0x0\n\t"
+			"beq 3f\n\t"
+
+#endif
+			"ldr r4, [%[dest]] \n\t"
+
+			/* multiply by alpha (r8) then by 257 and divide by 65536 */
+			"mla r6, %[src_lo], r5, %[component_half]\n\t"
+			"mla r7, %[src_hi], r5, %[component_half]\n\t"
+
+			"uxtab16 r6, r6, r6, ror #8\n\t"
+			"uxtab16 r7, r7, r7, ror #8\n\t"
+
+			"uxtb16 r6, r6, ror #8\n\t"
+			"uxtb16 r7, r7, ror #8\n\t"
+
+			/* recombine */
+			"orr r5, r6, r7, lsl #8\n\t"
+
+			"uxtb16 r6, r4\n\t"
+			"uxtb16 r7, r4, ror #8\n\t"
+
+			/* we could simplify this to use 'sub' if we were
+			 * willing to give up a register for alpha_mask */
+			"mvn r8, r5\n\t"
+			"mov r8, r8, lsr #24\n\t"
+
+			/* multiply by alpha (r8) then by 257 and divide by 65536 */
+			"mla r6, r6, r8, %[component_half]\n\t"
+			"mla r7, r7, r8, %[component_half]\n\t"
+
+			"uxtab16 r6, r6, r6, ror #8\n\t"
+			"uxtab16 r7, r7, r7, ror #8\n\t"
+
+			"uxtb16 r6, r6, ror #8\n\t"
+			"uxtb16 r7, r7, ror #8\n\t"
+
+			/* recombine */
+			"orr r6, r6, r7, lsl #8\n\t"
+
+			"uqadd8 r5, r6, r5\n\t"
+
+#ifdef inner_branch
+			"3:\n\t"
+
+#endif
+			"str r5, [%[dest]], #4\n\t"
+			/* increment counter and jmp to top */
+			"subs	%[w], %[w], #1\n\t"
+			"bne	1b\n\t"
+			"2:\n\t"
+			: [w] "+r" (w), [dest] "+r" (dst), [src] "+r" (src), [mask] "+r" (mask)
+			: [component_half] "r" (component_half),
+			  [src_hi] "r" (src_hi), [src_lo] "r" (src_lo)
+			: "r4", "r5", "r6", "r7", "r8", "cc", "memory"
+			);
+    }
+}
diff -r 1aecd2a9914d gfx/cairo/libpixman/src/pixman-arm.h
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/gfx/cairo/libpixman/src/pixman-arm.h	Thu Sep 18 08:03:23 2008 -0500
@@ -0,0 +1,94 @@
+/*
+ * Copyright  2008 Mozilla Corporation
+ *
+ * Permission to use, copy, modify, distribute, and sell this software and its
+ * documentation for any purpose is hereby granted without fee, provided that
+ * the above copyright notice appear in all copies and that both that
+ * copyright notice and this permission notice appear in supporting
+ * documentation, and that the name of Mozilla Corporation not be used in
+ * advertising or publicity pertaining to distribution of the software without
+ * specific, written prior permission.  Mozilla Corporation makes no
+ * representations about the suitability of this software for any purpose.  It
+ * is provided "as is" without express or implied warranty.
+ *
+ * THE COPYRIGHT HOLDERS DISCLAIM ALL WARRANTIES WITH REGARD TO THIS
+ * SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND
+ * FITNESS, IN NO EVENT SHALL THE COPYRIGHT HOLDERS BE LIABLE FOR ANY
+ * SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
+ * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN
+ * AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING
+ * OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS
+ * SOFTWARE.
+ *
+ * Author:  Jeff Muizelaar (jeff@infidigm.net)
+ *
+ */
+
+#include "pixman-private.h"
+
+#ifdef USE_ARM
+
+static inline pixman_bool_t pixman_have_arm(void) { return TRUE; }
+
+#else
+#define pixman_have_arm() FALSE
+#endif
+
+#ifdef USE_ARM
+
+void
+fbCompositeSrcAdd_8000x8000arm (pixman_op_t op,
+				pixman_image_t * pSrc,
+				pixman_image_t * pMask,
+				pixman_image_t * pDst,
+				int16_t      xSrc,
+				int16_t      ySrc,
+				int16_t      xMask,
+				int16_t      yMask,
+				int16_t      xDst,
+				int16_t      yDst,
+				uint16_t     width,
+				uint16_t     height);
+void
+fbCompositeSrc_8888x8888arm (pixman_op_t op,
+			 pixman_image_t * pSrc,
+			 pixman_image_t * pMask,
+			 pixman_image_t * pDst,
+			 int16_t      xSrc,
+			 int16_t      ySrc,
+			 int16_t      xMask,
+			 int16_t      yMask,
+			 int16_t      xDst,
+			 int16_t      yDst,
+			 uint16_t     width,
+			 uint16_t     height);
+
+void
+fbCompositeSrc_8888x8x8888arm (pixman_op_t op,
+			 pixman_image_t * pSrc,
+			 pixman_image_t * pMask,
+			 pixman_image_t * pDst,
+			 int16_t      xSrc,
+			 int16_t      ySrc,
+			 int16_t      xMask,
+			 int16_t      yMask,
+			 int16_t      xDst,
+			 int16_t      yDst,
+			 uint16_t     width,
+			 uint16_t     height);
+void
+fbCompositeSolidMask_nx8x8888arm (pixman_op_t op,
+			 pixman_image_t * pSrc,
+			 pixman_image_t * pMask,
+			 pixman_image_t * pDst,
+			 int16_t      xSrc,
+			 int16_t      ySrc,
+			 int16_t      xMask,
+			 int16_t      yMask,
+			 int16_t      xDst,
+			 int16_t      yDst,
+			 uint16_t     width,
+			 uint16_t     height);
+
+
+#endif /* USE_ARM */
diff -r 1aecd2a9914d gfx/cairo/libpixman/src/pixman-image.c
--- a/gfx/cairo/libpixman/src/pixman-image.c	Tue Sep 16 16:40:57 2008 +1200
+++ b/gfx/cairo/libpixman/src/pixman-image.c	Thu Sep 18 08:03:23 2008 -0500
@@ -813,12 +813,16 @@ pixman_image_is_opaque(pixman_image_t *i
 
     if (image->common.repeat == PIXMAN_REPEAT_NONE)
     {
         if (image->common.filter != PIXMAN_FILTER_NEAREST)
             return FALSE;
 
         if (image->common.transform)
             return FALSE;
+
+	/* Gradients do not necessarily cover the entire compositing area */
+	if (image->type == LINEAR || image->type == CONICAL || image->type == RADIAL)
+	    return FALSE;
     }
 
      return TRUE;
 }
diff -r 1aecd2a9914d gfx/cairo/libpixman/src/pixman-pict.c
--- a/gfx/cairo/libpixman/src/pixman-pict.c	Tue Sep 16 16:40:57 2008 +1200
+++ b/gfx/cairo/libpixman/src/pixman-pict.c	Thu Sep 18 08:03:23 2008 -0500
@@ -29,16 +29,17 @@
 
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
 #include "pixman-private.h"
 #include "pixman-mmx.h"
 #include "pixman-vmx.h"
 #include "pixman-sse2.h"
+#include "pixman-arm.h"
 #include "pixman-combine32.h"
 
 #ifdef __GNUC__
 #   define inline __inline__ __attribute__ ((__always_inline__))
 #endif
 
 #define FbFullMask(n)   ((n) == 32 ? (uint32_t)-1 : ((((uint32_t) 1) << n) - 1))
 
@@ -748,16 +749,56 @@ fbCompositeSrc_8888x0565 (pixman_op_t op
 		    d = s;
 		else
 		{
 		    d = READ(pDst, dst);
 		    d = fbOver24 (s, cvt0565to0888(d));
 		}
 		WRITE(pDst, dst, cvt8888to0565(d));
 	    }
+	    dst++;
+	}
+    }
+}
+
+
+void
+fbCompositeSrc_x888x0565 (pixman_op_t op,
+                          pixman_image_t * pSrc,
+                          pixman_image_t * pMask,
+                          pixman_image_t * pDst,
+                          int16_t      xSrc,
+                          int16_t      ySrc,
+                          int16_t      xMask,
+                          int16_t      yMask,
+                          int16_t      xDst,
+                          int16_t      yDst,
+                          uint16_t     width,
+                          uint16_t     height)
+{
+    uint16_t	*dstLine, *dst;
+    uint32_t	*srcLine, *src, s;
+    int	dstStride, srcStride;
+    uint16_t	w;
+
+    fbComposeGetStart (pSrc, xSrc, ySrc, uint32_t, srcStride, srcLine, 1);
+    fbComposeGetStart (pDst, xDst, yDst, uint16_t, dstStride, dstLine, 1);
+
+    while (height--)
+    {
+	dst = dstLine;
+	dstLine += dstStride;
+	src = srcLine;
+	srcLine += srcStride;
+	w = width;
+
+	while (w--)
+	{
+	    s = READ(pSrc, src++);
+	    WRITE(pDst, dst, cvt8888to0565(s));
 	    dst++;
 	}
     }
 }
 
 void
 fbCompositeSrcAdd_8000x8000 (pixman_op_t	op,
 			     pixman_image_t * pSrc,
@@ -1474,16 +1515,36 @@ static const FastPathInfo sse2_fast_path
 
 #ifdef USE_VMX
 static const FastPathInfo vmx_fast_paths[] =
 {
     { PIXMAN_OP_NONE },
 };
 #endif
 
+#ifdef USE_ARM
+static const FastPathInfo arm_fast_paths[] =
+{
+    { PIXMAN_OP_OVER, PIXMAN_a8r8g8b8, PIXMAN_null,     PIXMAN_a8r8g8b8, fbCompositeSrc_8888x8888arm,      0 },
+    { PIXMAN_OP_OVER, PIXMAN_a8r8g8b8, PIXMAN_null,	PIXMAN_x8r8g8b8, fbCompositeSrc_8888x8888arm,	   0 },
+    { PIXMAN_OP_OVER, PIXMAN_a8b8g8r8, PIXMAN_null,	PIXMAN_a8b8g8r8, fbCompositeSrc_8888x8888arm,	   0 },
+    { PIXMAN_OP_OVER, PIXMAN_a8b8g8r8, PIXMAN_null,	PIXMAN_x8b8g8r8, fbCompositeSrc_8888x8888arm,	   0 },
+    { PIXMAN_OP_OVER, PIXMAN_a8r8g8b8, PIXMAN_a8,       PIXMAN_a8r8g8b8, fbCompositeSrc_8888x8x8888arm,    NEED_SOLID_MASK },
+    { PIXMAN_OP_OVER, PIXMAN_a8r8g8b8, PIXMAN_a8,       PIXMAN_x8r8g8b8, fbCompositeSrc_8888x8x8888arm,	   NEED_SOLID_MASK },
+
+    { PIXMAN_OP_ADD, PIXMAN_a8,        PIXMAN_null,     PIXMAN_a8,       fbCompositeSrcAdd_8000x8000arm,   0 },
+
+    { PIXMAN_OP_OVER, PIXMAN_solid,    PIXMAN_a8,       PIXMAN_a8r8g8b8, fbCompositeSolidMask_nx8x8888arm,     0 },
+    { PIXMAN_OP_OVER, PIXMAN_solid,    PIXMAN_a8,       PIXMAN_x8r8g8b8, fbCompositeSolidMask_nx8x8888arm,     0 },
+    { PIXMAN_OP_OVER, PIXMAN_solid,    PIXMAN_a8,       PIXMAN_a8b8g8r8, fbCompositeSolidMask_nx8x8888arm,     0 },
+    { PIXMAN_OP_OVER, PIXMAN_solid,    PIXMAN_a8,       PIXMAN_x8b8g8r8, fbCompositeSolidMask_nx8x8888arm,     0 },
+
+    { PIXMAN_OP_NONE },
+};
+#endif
 
 static const FastPathInfo c_fast_paths[] =
 {
     { PIXMAN_OP_OVER, PIXMAN_solid,    PIXMAN_a8,       PIXMAN_r5g6b5,   fbCompositeSolidMask_nx8x0565, 0 },
     { PIXMAN_OP_OVER, PIXMAN_solid,    PIXMAN_a8,       PIXMAN_b5g6r5,   fbCompositeSolidMask_nx8x0565, 0 },
     { PIXMAN_OP_OVER, PIXMAN_solid,    PIXMAN_a8,       PIXMAN_r8g8b8,   fbCompositeSolidMask_nx8x0888, 0 },
     { PIXMAN_OP_OVER, PIXMAN_solid,    PIXMAN_a8,       PIXMAN_b8g8r8,   fbCompositeSolidMask_nx8x0888, 0 },
     { PIXMAN_OP_OVER, PIXMAN_solid,    PIXMAN_a8,       PIXMAN_a8r8g8b8, fbCompositeSolidMask_nx8x8888, 0 },
@@ -1542,16 +1603,20 @@ static const FastPathInfo c_fast_paths[]
     /* FIXME */
     { PIXMAN_OP_SRC, PIXMAN_a8r8g8b8,  PIXMAN_null,	PIXMAN_a8r8g8b8, fbCompositeSrcSrc_nxn, 0 },
     { PIXMAN_OP_SRC, PIXMAN_a8b8g8r8,  PIXMAN_null,	PIXMAN_a8b8g8r8, fbCompositeSrcSrc_nxn, 0 },
     { PIXMAN_OP_SRC, PIXMAN_x8r8g8b8,  PIXMAN_null,	PIXMAN_x8r8g8b8, fbCompositeSrcSrc_nxn, 0 },
     { PIXMAN_OP_SRC, PIXMAN_x8b8g8r8,  PIXMAN_null,	PIXMAN_x8b8g8r8, fbCompositeSrcSrc_nxn, 0 },
     { PIXMAN_OP_SRC, PIXMAN_r5g6b5,    PIXMAN_null,     PIXMAN_r5g6b5,   fbCompositeSrcSrc_nxn, 0 },
     { PIXMAN_OP_SRC, PIXMAN_b5g6r5,    PIXMAN_null,     PIXMAN_b5g6r5,   fbCompositeSrcSrc_nxn, 0 },
 #endif
+    { PIXMAN_OP_SRC, PIXMAN_a8r8g8b8,  PIXMAN_null,     PIXMAN_r5g6b5,   fbCompositeSrc_x888x0565, 0 },
+    { PIXMAN_OP_SRC, PIXMAN_x8r8g8b8,  PIXMAN_null,     PIXMAN_r5g6b5,   fbCompositeSrc_x888x0565, 0 },
+    { PIXMAN_OP_SRC, PIXMAN_a8b8g8r8,  PIXMAN_null,     PIXMAN_b5g6r5,   fbCompositeSrc_x888x0565, 0 },
+    { PIXMAN_OP_SRC, PIXMAN_x8b8g8r8,  PIXMAN_null,     PIXMAN_b5g6r5,   fbCompositeSrc_x888x0565, 0 },
     { PIXMAN_OP_IN,  PIXMAN_a8,        PIXMAN_null,     PIXMAN_a8,       fbCompositeSrcIn_8x8,   0 },
     { PIXMAN_OP_IN,  PIXMAN_solid,     PIXMAN_a8,	PIXMAN_a8,	 fbCompositeSolidMaskIn_nx8x8, 0 },
     { PIXMAN_OP_NONE },
 };
 
 static pixman_bool_t
 mask_is_solid (pixman_image_t *mask)
 {
@@ -1824,16 +1889,22 @@ pixman_image_composite (pixman_op_t     
 	    info = get_fast_path (mmx_fast_paths, op, pSrc, pMask, pDst, pixbuf);
 #endif
 
 #ifdef USE_VMX
 
 	if (!info && pixman_have_vmx())
 	    info = get_fast_path (vmx_fast_paths, op, pSrc, pMask, pDst, pixbuf);
 #endif
+
+#ifdef USE_ARM
+	if (!info && pixman_have_arm())
+	    info = get_fast_path (arm_fast_paths, op, pSrc, pMask, pDst, pixbuf);
+#endif
+
         if (!info)
 	    info = get_fast_path (c_fast_paths, op, pSrc, pMask, pDst, pixbuf);
 
 	if (info)
 	{
 	    func = info->func;
 
 	    if (info->src_format == PIXMAN_solid)
diff -r 1aecd2a9914d gfx/cairo/libpixman/src/pixman-sse2.c
--- a/gfx/cairo/libpixman/src/pixman-sse2.c	Tue Sep 16 16:40:57 2008 +1200
+++ b/gfx/cairo/libpixman/src/pixman-sse2.c	Thu Sep 18 08:03:23 2008 -0500
@@ -68,52 +68,66 @@ static __m128i MaskAlpha;
 
 static __m128i Mask565r;
 static __m128i Mask565g1, Mask565g2;
 static __m128i Mask565b;
 static __m128i MaskRed;
 static __m128i MaskGreen;
 static __m128i MaskBlue;
 
+static __m128i Mask565FixRB;
+static __m128i Mask565FixG;
+
 /* -------------------------------------------------------------------------------------------------
  * SSE2 Inlines
  */
 static inline __m128i
 unpack_32_1x128 (uint32_t data)
 {
     return _mm_unpacklo_epi8 (_mm_cvtsi32_si128 (data), _mm_setzero_si128());
 }
 
 static inline void
 unpack_128_2x128 (__m128i data, __m128i* dataLo, __m128i* dataHi)
 {
     *dataLo = _mm_unpacklo_epi8 (data, _mm_setzero_si128 ());
     *dataHi = _mm_unpackhi_epi8 (data, _mm_setzero_si128 ());
 }
 
-static inline void
-unpack565_128_4x128 (__m128i data, __m128i* data0, __m128i* data1, __m128i* data2, __m128i* data3)
-{
-    __m128i lo, hi;
-    __m128i r, g, b;
-
-    lo = _mm_unpacklo_epi16 (data, _mm_setzero_si128 ());
-    hi = _mm_unpackhi_epi16 (data, _mm_setzero_si128 ());
-
+static inline __m128i
+unpack565to8888 (__m128i lo)
+{
+    __m128i r, g, b, rb, t;
+    
     r = _mm_and_si128 (_mm_slli_epi32 (lo, 8), MaskRed);
     g = _mm_and_si128 (_mm_slli_epi32 (lo, 5), MaskGreen);
     b = _mm_and_si128 (_mm_slli_epi32 (lo, 3), MaskBlue);
 
-    lo = _mm_or_si128 (_mm_or_si128 (r, g), b);
-
-    r = _mm_and_si128 (_mm_slli_epi32 (hi, 8), MaskRed);
-    g = _mm_and_si128 (_mm_slli_epi32 (hi, 5), MaskGreen);
-    b = _mm_and_si128 (_mm_slli_epi32 (hi, 3), MaskBlue);
-
-    hi = _mm_or_si128 (_mm_or_si128 (r, g), b);
+    rb = _mm_or_si128 (r, b);
+    t  = _mm_and_si128 (rb, Mask565FixRB);
+    t  = _mm_srli_epi32 (t, 5);
+    rb = _mm_or_si128 (rb, t);
+
+    t  = _mm_and_si128 (g, Mask565FixG);
+    t  = _mm_srli_epi32 (t, 6);
+    g  = _mm_or_si128 (g, t);
+    
+    return _mm_or_si128 (rb, g);
+}
+
+static inline void
+unpack565_128_4x128 (__m128i data, __m128i* data0, __m128i* data1, __m128i* data2, __m128i* data3)
+{
+    __m128i lo, hi;
+
+    lo = _mm_unpacklo_epi16 (data, _mm_setzero_si128 ());
+    hi = _mm_unpackhi_epi16 (data, _mm_setzero_si128 ());
+
+    lo = unpack565to8888 (lo);
+    hi = unpack565to8888 (hi);
 
     unpack_128_2x128 (lo, data0, data1);
     unpack_128_2x128 (hi, data2, data3);
 }
 
 static inline uint16_t
 pack565_32_16 (uint32_t pixel)
 {
@@ -239,19 +253,21 @@ invertColors_2x128 (__m128i dataLo, __m1
     hi = _mm_shufflelo_epi16 (dataHi, _MM_SHUFFLE(3, 0, 1, 2));
     *invLo = _mm_shufflehi_epi16 (lo, _MM_SHUFFLE(3, 0, 1, 2));
     *invHi = _mm_shufflehi_epi16 (hi, _MM_SHUFFLE(3, 0, 1, 2));
 }
 
 static inline void
 over_2x128 (__m128i* srcLo, __m128i* srcHi, __m128i* alphaLo, __m128i* alphaHi, __m128i* dstLo, __m128i* dstHi)
 {
-    negate_2x128 (*alphaLo, *alphaHi, alphaLo, alphaHi);
-
-    pixMultiply_2x128 (dstLo, dstHi, alphaLo, alphaHi, dstLo, dstHi);
+    __m128i t1, t2;
+
+    negate_2x128 (*alphaLo, *alphaHi, &t1, &t2);
+
+    pixMultiply_2x128 (dstLo, dstHi, &t1, &t2, dstLo, dstHi);
 
     *dstLo = _mm_adds_epu8 (*srcLo, *dstLo);
     *dstHi = _mm_adds_epu8 (*srcHi, *dstHi);
 }
 
 static inline void
 overRevNonPre_2x128 (__m128i srcLo, __m128i srcHi, __m128i* dstLo, __m128i* dstHi)
 {
@@ -2290,17 +2306,18 @@ fbComposeSetupSSE2(void)
         /* SSE2 constants */
         Mask565r  = createMask_2x32_128 (0x00f80000, 0x00f80000);
         Mask565g1 = createMask_2x32_128 (0x00070000, 0x00070000);
         Mask565g2 = createMask_2x32_128 (0x000000e0, 0x000000e0);
         Mask565b  = createMask_2x32_128 (0x0000001f, 0x0000001f);
         MaskRed   = createMask_2x32_128 (0x00f80000, 0x00f80000);
         MaskGreen = createMask_2x32_128 (0x0000fc00, 0x0000fc00);
         MaskBlue  = createMask_2x32_128 (0x000000f8, 0x000000f8);
-
+	Mask565FixRB = createMask_2x32_128 (0x00e000e0, 0x00e000e0);
+	Mask565FixG = createMask_2x32_128  (0x0000c000, 0x0000c000);
         Mask0080 = createMask_16_128 (0x0080);
         Mask00ff = createMask_16_128 (0x00ff);
         Mask0101 = createMask_16_128 (0x0101);
         Maskffff = createMask_16_128 (0xffff);
         Maskff000000 = createMask_2x32_128 (0xff000000, 0xff000000);
         MaskAlpha = createMask_2x32_128 (0x00ff0000, 0x00000000);
 
         /* MMX constants */
@@ -2477,39 +2494,39 @@ fbCompositeSolid_nx0565sse2 (pixman_op_t
         cachePrefetch ((__m128i*)dst);
 
         dstLine += dstStride;
         w = width;
 
         while (w && (unsigned long)dst & 15)
         {
             d = *dst;
+
             *dst++ = pack565_32_16 (pack_1x64_32 (over_1x64 (_mm_movepi64_pi64 (xmmSrc),
                                                              _mm_movepi64_pi64 (xmmAlpha),
                                                              expand565_16_1x64 (d))));
             w--;
         }
 
         /* call prefetch hint to optimize cache load*/
         cachePrefetch ((__m128i*)dst);
 
         while (w >= 8)
         {
             /* fill cache line with next memory */
             cachePrefetchNext ((__m128i*)dst);
 
-            xmmDst = load128Aligned ((__m128i*)dst);
-
-            unpack565_128_4x128 (xmmDst, &xmmDst0, &xmmDst1, &xmmDst2, &xmmDst3);
-
+	    xmmDst = load128Aligned ((__m128i*)dst);
+	    
+	    unpack565_128_4x128 (xmmDst, &xmmDst0, &xmmDst1, &xmmDst2, &xmmDst3);
+	    
             over_2x128 (&xmmSrc, &xmmSrc, &xmmAlpha, &xmmAlpha, &xmmDst0, &xmmDst1);
             over_2x128 (&xmmSrc, &xmmSrc, &xmmAlpha, &xmmAlpha, &xmmDst2, &xmmDst3);
 
             xmmDst = pack565_4x128_128 (&xmmDst0, &xmmDst1, &xmmDst2, &xmmDst3);
-
             save128Aligned ((__m128i*)dst, xmmDst);
 
             dst += 8;
             w -= 8;
         }
 
         while (w--)
         {
diff -r 1aecd2a9914d gfx/cairo/libpixman/src/pixman-transformed.c
--- a/gfx/cairo/libpixman/src/pixman-transformed.c	Tue Sep 16 16:40:57 2008 +1200
+++ b/gfx/cairo/libpixman/src/pixman-transformed.c	Thu Sep 18 08:03:23 2008 -0500
@@ -588,26 +588,25 @@ ACCESS(fbFetchTransformed)(bits_image_t 
     {
         unit.vector[0] = pixman_fixed_1;
         unit.vector[1] = 0;
         unit.vector[2] = 0;
     }
 
     /* This allows filtering code to pretend that pixels are located at integer coordinates */
     adjust (&v, &unit, -(pixman_fixed_1 / 2));
-    
+
     if (pict->common.filter == PIXMAN_FILTER_NEAREST || pict->common.filter == PIXMAN_FILTER_FAST)
     {
 	/* Round down to closest integer, ensuring that 0.5 rounds to 0, not 1 */
 	adjust (&v, &unit, pixman_fixed_1 / 2 - pixman_fixed_e);
 	
         if (pict->common.repeat == PIXMAN_REPEAT_NORMAL)
         {
             fbFetchTransformed_Nearest_Normal(pict, width, buffer, mask, maskBits, affine, v, unit);
-
         }
         else if (pict->common.repeat == PIXMAN_REPEAT_PAD)
         {
             fbFetchTransformed_Nearest_Pad(pict, width, buffer, mask, maskBits, affine, v, unit);
         }
         else
         {
             fbFetchTransformed_Nearest_General(pict, width, buffer, mask, maskBits, affine, v, unit);
diff -r 1aecd2a9914d gfx/cairo/libpixman/src/pixman-version.h
--- a/gfx/cairo/libpixman/src/pixman-version.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/gfx/cairo/libpixman/src/pixman-version.h	Thu Sep 18 08:03:23 2008 -0500
@@ -27,20 +27,20 @@
 #ifndef PIXMAN_VERSION_H__
 #define PIXMAN_VERSION_H__
 
 #ifndef PIXMAN_H__
 #  error pixman-version.h should only be included by pixman.h
 #endif
 
 #define PIXMAN_VERSION_MAJOR 0
-#define PIXMAN_VERSION_MINOR 11
-#define PIXMAN_VERSION_MICRO 9
+#define PIXMAN_VERSION_MINOR 12
+#define PIXMAN_VERSION_MICRO 0
 
-#define PIXMAN_VERSION_STRING "0.11.9"
+#define PIXMAN_VERSION_STRING "0.12.0"
 
 #define PIXMAN_VERSION_ENCODE(major, minor, micro) (	\
 	  ((major) * 10000)				\
 	+ ((minor) *   100)				\
 	+ ((micro) *     1))
 
 #define PIXMAN_VERSION PIXMAN_VERSION_ENCODE(	\
 	PIXMAN_VERSION_MAJOR,			\
diff -r 1aecd2a9914d gfx/cairo/libpixman/src/pixman.h
--- a/gfx/cairo/libpixman/src/pixman.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/gfx/cairo/libpixman/src/pixman.h	Thu Sep 18 08:03:23 2008 -0500
@@ -69,17 +69,17 @@ SOFTWARE.
 #ifndef PIXMAN_H__
 #define PIXMAN_H__
 
 #include <pixman-version.h>
 
 /*
  * Standard integers
  */
-#if defined (_SVR4) || defined (SVR4) || defined (__OpenBSD__) || defined (_sgi)
+#if defined (_SVR4) || defined (SVR4) || defined (__OpenBSD__) || defined (_sgi) || defined (__sun) || defined (sun)
 #  include <inttypes.h>
 #elif defined (_MSC_VER)
 typedef __int8 int8_t;
 typedef unsigned __int8 uint8_t;
 typedef __int16 int16_t;
 typedef unsigned __int16 uint16_t;
 typedef __int32 int32_t;
 typedef unsigned __int32 uint32_t;
diff -r 1aecd2a9914d gfx/public/nsThemeConstants.h
--- a/gfx/public/nsThemeConstants.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/gfx/public/nsThemeConstants.h	Thu Sep 18 08:03:23 2008 -0500
@@ -230,10 +230,13 @@
 // For text on non-iconic menuitems only
 #define NS_THEME_MENUITEMTEXT                              220
 
 // Vista Rebars
 #define NS_THEME_WIN_COMMUNICATIONS_TOOLBOX                221
 #define NS_THEME_WIN_MEDIA_TOOLBOX                         222
 #define NS_THEME_WIN_BROWSER_TAB_BAR_TOOLBOX               223
 
+// Unified toolbar on the Mac
+#define NS_THEME_MOZ_MAC_UNIFIED_TOOLBAR                   224
+
 // Vista glass
 #define NS_THEME_WIN_GLASS                                 230
diff -r 1aecd2a9914d gfx/thebes/crashtests/441360_data.gif
Binary file gfx/thebes/crashtests/441360_data.gif has changed
diff -r 1aecd2a9914d gfx/thebes/crashtests/crashtests.list
--- a/gfx/thebes/crashtests/crashtests.list	Tue Sep 16 16:40:57 2008 +1200
+++ b/gfx/thebes/crashtests/crashtests.list	Thu Sep 18 08:03:24 2008 -0500
@@ -34,10 +34,10 @@ load 416637-1.html
 load 416637-1.html
 load 419095-1.html
 load 420945-1.html
 load 420962-1.html
 load 421393-1.html
 load 421813-1.html
 load 423270-1.html
 load 429899-1.html
-load 441360.html
+skip-if(MOZ_WIDGET_TOOLKIT=="gtk2") load 441360.html # filed bug 455463 for gtk2
 
diff -r 1aecd2a9914d gfx/thebes/public/gfxPangoFonts.h
--- a/gfx/thebes/public/gfxPangoFonts.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/gfx/thebes/public/gfxPangoFonts.h	Thu Sep 18 08:03:24 2008 -0500
@@ -123,19 +123,17 @@ public:
     virtual gfxFontGroup *Copy(const gfxFontStyle *aStyle);
 
     // Create and initialize a textrun using Pango
     virtual gfxTextRun *MakeTextRun(const PRUnichar *aString, PRUint32 aLength,
                                     const Parameters *aParams, PRUint32 aFlags);
     virtual gfxTextRun *MakeTextRun(const PRUint8 *aString, PRUint32 aLength,
                                     const Parameters *aParams, PRUint32 aFlags);
 
-    gfxPangoFont *GetFontAt(PRInt32 i) {
-        return static_cast<gfxPangoFont*>(static_cast<gfxFont*>(mFonts[i]));
-    }
+    virtual gfxPangoFont *GetFontAt(PRInt32 i);
 
 protected:
     // ****** Textrun glyph conversion helpers ******
 
     /**
      * Fill in the glyph-runs for the textrun.
      * @param aTake8BitPath the text contains only characters below 0x100
      * (TEXT_IS_8BIT can return false when the characters are all below 0x100
@@ -158,19 +156,17 @@ protected:
                                   const gchar *aUTF8, PRUint32 aUTF8Length,
                                   PRUint32 aUTF8HeaderLength);
 #if defined(ENABLE_FAST_PATH_8BIT) || defined(ENABLE_FAST_PATH_ALWAYS)
     PRBool CanTakeFastPath(PRUint32 aFlags);
     nsresult CreateGlyphRunsFast(gfxTextRun *aTextRun,
                                  const gchar *aUTF8, PRUint32 aUTF8Length);
 #endif
 
-    static PRBool FontCallback (const nsAString& fontName,
-                                const nsACString& genericName,
-                                void *closure);
+    void GetFcFamilies(nsAString &aFcFamilies);
 };
 
 class gfxPangoFontWrapper {
 public:
     gfxPangoFontWrapper(PangoFont *aFont) {
         mFont = aFont;
         g_object_ref(mFont);
     }
diff -r 1aecd2a9914d gfx/thebes/src/gfxPangoFonts.cpp
--- a/gfx/thebes/src/gfxPangoFonts.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/gfx/thebes/src/gfxPangoFonts.cpp	Thu Sep 18 08:03:24 2008 -0500
@@ -455,20 +455,19 @@ FFRECountHyphens (const nsAString &aFFRE
     PRInt32 hyphen = 0;
     while ((hyphen = aFFREName.FindChar('-', hyphen)) >= 0) {
         ++h;
         ++hyphen;
     }
     return h;
 }
 
-PRBool
-gfxPangoFontGroup::FontCallback (const nsAString& fontName,
-                                 const nsACString& genericName,
-                                 void *closure)
+static PRBool
+FontCallback (const nsAString& fontName, const nsACString& genericName,
+              void *closure)
 {
     nsStringArray *sa = static_cast<nsStringArray*>(closure);
 
     // We ignore prefs that have three hypens since they are X style prefs.
     if (genericName.Length() && FFRECountHyphens(fontName) >= 3)
         return PR_TRUE;
 
     if (sa->IndexOf(fontName) < 0) {
@@ -498,60 +497,72 @@ GetOrMakeFont(const nsAString& aName, co
     font.swap(f);
     return static_cast<gfxPangoFont *>(f);
 }
 
 gfxPangoFontGroup::gfxPangoFontGroup (const nsAString& families,
                                       const gfxFontStyle *aStyle)
     : gfxFontGroup(families, aStyle)
 {
-    g_type_init();
-
-    nsStringArray familyArray;
-
-    // Leave non-existing fonts in the list so that fontconfig can get the
-    // best match.
-    ForEachFontInternal(families, aStyle->langGroup, PR_TRUE, PR_FALSE,
-                        FontCallback, &familyArray);
-
-    // Construct a string suitable for fontconfig
-    nsAutoString fcFamilies;
-    if (familyArray.Count()) {
-        int i = 0;
-        while (1) {
-            fcFamilies.Append(*familyArray[i]);
-            ++i;
-            if (i >= familyArray.Count())
-                break;
-            fcFamilies.Append(NS_LITERAL_STRING(","));
-        }
-    }
-    else {
-        // XXX If there are no fonts, we should use dummy family.
-        // Pango will resolve from this.
-        // behdad: yep, looks good.
-        // printf("%s(%s)\n", NS_ConvertUTF16toUTF8(families).get(),
-        //                    aStyle->langGroup.get());
-        fcFamilies.Append(NS_LITERAL_STRING("sans-serif"));
-    }
-
-    nsRefPtr<gfxPangoFont> font = GetOrMakeFont(fcFamilies, &mStyle);
-    if (font) {
-        mFonts.AppendElement(font);
-    }
+    mFonts.AppendElements(1);
 }
 
 gfxPangoFontGroup::~gfxPangoFontGroup()
 {
 }
 
 gfxFontGroup *
 gfxPangoFontGroup::Copy(const gfxFontStyle *aStyle)
 {
     return new gfxPangoFontGroup(mFamilies, aStyle);
+}
+
+// A string of family names suitable for fontconfig
+void
+gfxPangoFontGroup::GetFcFamilies(nsAString& aFcFamilies)
+{
+    nsStringArray familyArray;
+
+    // Leave non-existing fonts in the list so that fontconfig can get the
+    // best match.
+    ForEachFontInternal(mFamilies, mStyle.langGroup, PR_TRUE, PR_FALSE,
+                        FontCallback, &familyArray);
+
+    if (familyArray.Count()) {
+        int i = 0;
+        while (1) {
+            aFcFamilies.Append(*familyArray[i]);
+            ++i;
+            if (i >= familyArray.Count())
+                break;
+            aFcFamilies.Append(NS_LITERAL_STRING(","));
+        }
+    }
+    else {
+        // XXX If there are no fonts, we should use dummy family.
+        // Pango will resolve from this.
+        // behdad: yep, looks good.
+        // printf("%s(%s)\n", NS_ConvertUTF16toUTF8(families).get(),
+        //                    aStyle->langGroup.get());
+        aFcFamilies.Append(NS_LITERAL_STRING("sans-serif"));
+    }
+}
+
+gfxPangoFont *
+gfxPangoFontGroup::GetFontAt(PRInt32 i) {
+    NS_PRECONDITION(i == 0, "Only have one font");
+
+    if (!mFonts[0]) {
+        nsAutoString fcFamilies;
+        GetFcFamilies(fcFamilies);
+        nsRefPtr<gfxPangoFont> font = GetOrMakeFont(fcFamilies, &mStyle);
+        mFonts[0] = font;
+    }
+
+    return static_cast<gfxPangoFont*>(mFonts[i].get());
 }
 
 /**
  ** gfxPangoFont
  **/
 
 gfxPangoFont::gfxPangoFont(gfxPangoFontEntry *aFontEntry,
                            const gfxFontStyle *aFontStyle)
diff -r 1aecd2a9914d js/src/xpconnect/src/XPCDispTearOff.cpp
--- a/js/src/xpconnect/src/XPCDispTearOff.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/js/src/xpconnect/src/XPCDispTearOff.cpp	Thu Sep 18 08:03:24 2008 -0500
@@ -460,17 +460,17 @@ pre_call_clean_up:
             char* sz = nsnull;
 
             if(nsXPCException::NameAndFormatForNSResult(code, nsnull, &msg) && msg)
                 sz = JS_smprintf(format, msg, name);
 
             nsCOMPtr<nsIException> e;
 
             XPCConvert::ConstructException(code, sz, "IDispatch", name.get(),
-                                           nsnull, getter_AddRefs(e));
+                                           nsnull, getter_AddRefs(e), nsnull);
             xpcc->SetException(e);
             if(sz)
                 JS_smprintf_free(sz);
         }
 
         if(!success)
         {
             retval = nsXPCWrappedJSClass::CheckForException(ccx, name.get(),
diff -r 1aecd2a9914d js/src/xpconnect/src/dom_quickstubs.qsconf
--- a/js/src/xpconnect/src/dom_quickstubs.qsconf	Tue Sep 16 16:40:57 2008 +1200
+++ b/js/src/xpconnect/src/dom_quickstubs.qsconf	Thu Sep 18 08:03:24 2008 -0500
@@ -65,28 +65,29 @@ members = [
     #
     'nsIDOMWindow.name',
     'nsIDOMWindow.parent',
     'nsIDOMWindow.top',
     'nsIDOMWindow.document',
     'nsIDOMWindow.getSelection',
     'nsIDOMWindowCollection.item',
     'nsIDOMWindowCollection.length',
-    'nsIDOMLocation.hostname',
-    'nsIDOMLocation.href',
     'nsIDOMScreen.top',
     'nsIDOMScreen.height',
     'nsIDOMScreen.width',
     'nsIDOMScreen.left',
     'nsIDOMClientRect.top',
     'nsIDOMClientRect.right',
     'nsIDOMClientRect.bottom',
     'nsIDOMClientRect.left',
     'nsIDOMClientRectList.item',
     'nsIDOMClientRectList.length',
+    # nsLocationSH has ~ALLOW_PROP_MODS_TO_PROTOTYPE, so don't try.
+    #'nsIDOMLocation.hostname',
+    #'nsIDOMLocation.href',
 
     # dom/public/idl/canvas
     #
     # nsIDOMCanvasRenderingContext2D
     # NOTE: attributes strokeStyle and fillStyle are nsIVariant
     # NOTE: drawImage(), getImageData(), and putImageData() use
     #       GetCurrentNativeCallContext
     'nsIDOMCanvasRenderingContext2D.canvas',
diff -r 1aecd2a9914d js/src/xpconnect/src/xpcconvert.cpp
--- a/js/src/xpconnect/src/xpcconvert.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/js/src/xpconnect/src/xpcconvert.cpp	Thu Sep 18 08:03:24 2008 -0500
@@ -1354,17 +1354,18 @@ XPCConvert::JSObject2NativeInterface(XPC
 /***************************************************************************/
 /***************************************************************************/
 
 // static
 nsresult
 XPCConvert::ConstructException(nsresult rv, const char* message,
                                const char* ifaceName, const char* methodName,
                                nsISupports* data,
-                               nsIException** exceptn)
+                               nsIException** exceptn,
+                               const jsval *jsExceptionPtr)
 {
     static const char format[] = "\'%s\' when calling method: [%s::%s]";
     const char * msg = message;
     char* sz = nsnull;
     nsXPIDLString xmsg;
     nsCAutoString sxmsg;
 
     nsCOMPtr<nsIScriptError> errorObject = do_QueryInterface(data);
@@ -1376,16 +1377,23 @@ XPCConvert::ConstructException(nsresult 
     }
     if(!msg)
         if(!nsXPCException::NameAndFormatForNSResult(rv, nsnull, &msg) || ! msg)
             msg = "<error>";
     if(ifaceName && methodName)
         msg = sz = JS_smprintf(format, msg, ifaceName, methodName);
 
     nsresult res = nsXPCException::NewException(msg, rv, nsnull, data, exceptn);
+
+    if(NS_SUCCEEDED(res) && jsExceptionPtr && *exceptn)
+    {
+        nsCOMPtr<nsXPCException> xpcEx = do_QueryInterface(*exceptn);
+        if(xpcEx)
+            xpcEx->SetThrownJSVal(*jsExceptionPtr);
+    }
 
     if(sz)
         JS_smprintf_free(sz);
     return res;
 }
 
 /********************************/
 
@@ -1425,17 +1433,17 @@ XPCConvert::JSValToXPCException(XPCCallC
                 *exceptn = temp;
                 return NS_OK;
             }
             else
             {
                 // it is a wrapped native, but not an exception!
                 return ConstructException(NS_ERROR_XPC_JS_THREW_NATIVE_OBJECT,
                                           nsnull, ifaceName, methodName, supports,
-                                          exceptn);
+                                          exceptn, nsnull);
             }
         }
         else
         {
             // It is a JSObject, but not a wrapped native...
 
             // If it is an engine Error with an error report then let's
             // extract the report and build an xpcexception from that
@@ -1487,25 +1495,25 @@ XPCConvert::JSValToXPCException(XPCCallC
 
             JSString* str = JS_ValueToString(cx, s);
             if(!str)
                 return NS_ERROR_FAILURE;
 
             return ConstructException(NS_ERROR_XPC_JS_THREW_JS_OBJECT,
                                       JS_GetStringBytes(str),
                                       ifaceName, methodName, nsnull,
-                                      exceptn);
+                                      exceptn, &s);
         }
     }
 
     if(JSVAL_IS_VOID(s) || JSVAL_IS_NULL(s))
     {
         return ConstructException(NS_ERROR_XPC_JS_THREW_NULL,
                                   nsnull, ifaceName, methodName, nsnull,
-                                  exceptn);
+                                  exceptn, &s);
     }
 
     if(JSVAL_IS_NUMBER(s))
     {
         // lets see if it looks like an nsresult
         nsresult rv;
         double number;
         JSBool isResult = JS_FALSE;
@@ -1528,44 +1536,47 @@ XPCConvert::JSValToXPCException(XPCCallC
                 rv = (nsresult) number;
                 if(NS_FAILED(rv))
                     isResult = JS_TRUE;
             }
         }
 
         if(isResult)
             return ConstructException(rv, nsnull, ifaceName, methodName,
-                                      nsnull, exceptn);
+                                      nsnull, exceptn, &s);
         else
         {
+            // XXX all this nsISupportsDouble code seems a little redundant
+            // now that we're storing the jsval in the exception...
             nsISupportsDouble* data;
             nsCOMPtr<nsIComponentManager> cm;
             if(NS_FAILED(NS_GetComponentManager(getter_AddRefs(cm))) || !cm ||
                NS_FAILED(cm->CreateInstanceByContractID(
                                 NS_SUPPORTS_DOUBLE_CONTRACTID,
                                 nsnull,
                                 NS_GET_IID(nsISupportsDouble),
                                 (void**)&data)))
                 return NS_ERROR_FAILURE;
             data->SetData(number);
             rv = ConstructException(NS_ERROR_XPC_JS_THREW_NUMBER, nsnull,
-                                    ifaceName, methodName, data, exceptn);
+                                    ifaceName, methodName, data, exceptn, &s);
             NS_RELEASE(data);
             return rv;
         }
     }
 
     // otherwise we'll just try to convert it to a string
+    // Note: e.g., JSBools get converted to JSStrings by this code.
 
     JSString* str = JS_ValueToString(cx, s);
     if(str)
         return ConstructException(NS_ERROR_XPC_JS_THREW_STRING,
                                   JS_GetStringBytes(str),
                                   ifaceName, methodName, nsnull,
-                                  exceptn);
+                                  exceptn, &s);
     return NS_ERROR_FAILURE;
 }
 
 /********************************/
 
 // static
 nsresult
 XPCConvert::JSErrorToXPCException(XPCCallContext& ccx,
@@ -1609,25 +1620,25 @@ XPCConvert::JSErrorToXPCException(XPCCal
 
     if(data)
     {
         nsCAutoString formattedMsg;
         data->ToString(formattedMsg);
 
         rv = ConstructException(NS_ERROR_XPC_JAVASCRIPT_ERROR_WITH_DETAILS,
                                 formattedMsg.get(), ifaceName, methodName, data,
-                                exceptn);
+                                exceptn, nsnull);
 
         NS_RELEASE(data);
     }
     else
     {
         rv = ConstructException(NS_ERROR_XPC_JAVASCRIPT_ERROR,
                                 nsnull, ifaceName, methodName, nsnull,
-                                exceptn);
+                                exceptn, nsnull);
     }
     return rv;
 }
 
 
 /***************************************************************************/
 
 /*
diff -r 1aecd2a9914d js/src/xpconnect/src/xpcexception.cpp
--- a/js/src/xpconnect/src/xpcexception.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/js/src/xpconnect/src/xpcexception.cpp	Thu Sep 18 08:03:24 2008 -0500
@@ -144,16 +144,36 @@ nsXPCException::nsXPCException()
 {
     MOZ_COUNT_CTOR(nsXPCException);
 }
 
 nsXPCException::~nsXPCException()
 {
     MOZ_COUNT_DTOR(nsXPCException);
     Reset();
+}
+
+PRBool
+nsXPCException::GetThrownJSVal(jsval *vp) const
+{
+    if(mThrownJSVal)
+    {
+        if(vp)
+            *vp = mThrownJSVal->GetJSVal();
+        return PR_TRUE;
+    }
+    return PR_FALSE;
+}
+
+void
+nsXPCException::SetThrownJSVal(jsval v)
+{
+    mThrownJSVal = JSVAL_IS_TRACEABLE(v)
+        ? new XPCTraceableVariant(nsXPConnect::GetRuntime(), v)
+        : new XPCVariant(v);
 }
 
 void
 nsXPCException::Reset()
 {
     if(mMessage)
     {
         nsMemory::Free(mMessage);
diff -r 1aecd2a9914d js/src/xpconnect/src/xpcprivate.h
--- a/js/src/xpconnect/src/xpcprivate.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/js/src/xpconnect/src/xpcprivate.h	Thu Sep 18 08:03:24 2008 -0500
@@ -2767,18 +2767,19 @@ public:
                                           const char* ifaceName,
                                           const char* methodName,
                                           const JSErrorReport* report,
                                           nsIException** exception);
 
     static nsresult ConstructException(nsresult rv, const char* message,
                                        const char* ifaceName,
                                        const char* methodName,
-                                       nsISupports* data,                                       
-                                       nsIException** exception);
+                                       nsISupports* data,
+                                       nsIException** exception,
+                                       const jsval *jsExceptionPtr);
 
     static void RemoveXPCOMUCStringFinalizer();
 
 private:
     XPCConvert(); // not implemented
 
 };
 
@@ -2854,16 +2855,18 @@ public:
                              nsIStackFrame* aCaller,
                              nsIStackFrame** stack);
 private:
     XPCJSStack();   // not implemented
 };
 
 /***************************************************************************/
 
+class XPCVariant;
+
 class nsXPCException :
             public nsIXPCException
 {
 public:
     NS_DEFINE_STATIC_CID_ACCESSOR(NS_XPCEXCEPTION_CID)
 
     NS_DECL_ISUPPORTS
     NS_DECL_NSIEXCEPTION
@@ -2885,29 +2888,34 @@ public:
                                   void** iterp);
 
     static PRUint32 GetNSResultCount();
 
     nsXPCException();
     virtual ~nsXPCException();
 
     static void InitStatics() { sEverMadeOneFromFactory = JS_FALSE; }
+
+    PRBool GetThrownJSVal(jsval *vp) const;
+    void   SetThrownJSVal(jsval v);
 
 protected:
     void Reset();
 private:
     char*           mMessage;
     nsresult        mResult;
     char*           mName;
     nsIStackFrame*  mLocation;
     nsISupports*    mData;
     char*           mFilename;
     int             mLineNumber;
     nsIException*   mInner;
     PRBool          mInitialized;
+
+    nsCOMPtr<XPCVariant> mThrownJSVal;
 
     static JSBool sEverMadeOneFromFactory;
 };
 
 /***************************************************************************/
 /*
 * nsJSID implements nsIJSID. It is also used by nsJSIID and nsJSCID as a
 * member (as a hidden implementaion detail) to which they delegate many calls.
diff -r 1aecd2a9914d js/src/xpconnect/src/xpcthrower.cpp
--- a/js/src/xpconnect/src/xpcthrower.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/js/src/xpconnect/src/xpcthrower.cpp	Thu Sep 18 08:03:24 2008 -0500
@@ -254,25 +254,48 @@ XPCThrower::BuildAndThrowException(JSCon
     if(finalException)
         success = ThrowExceptionObject(cx, finalException);
     // If we weren't able to build or throw an exception we're
     // most likely out of memory 
     if(!success)
         JS_ReportOutOfMemory(cx);
 }
 
+static PRBool
+IsCallerChrome()
+{
+    PRBool isChrome = PR_FALSE;
+    nsCOMPtr<nsIScriptSecurityManager> securityManager =
+        do_GetService(NS_SCRIPTSECURITYMANAGER_CONTRACTID);
+    nsresult rv = securityManager->SubjectPrincipalIsSystem(&isChrome);
+    return NS_SUCCEEDED(rv) && isChrome;
+}
+
 // static
 JSBool
 XPCThrower::ThrowExceptionObject(JSContext* cx, nsIException* e)
 {
     JSBool success = JS_FALSE;
     if(e)
     {
-        nsXPConnect* xpc = nsXPConnect::GetXPConnect();
-        if(xpc)
+        nsCOMPtr<nsXPCException> xpcEx;
+        jsval thrown;
+        nsXPConnect* xpc;
+
+        // If we stored the original thrown JS value in the exception
+        // (see XPCConvert::ConstructException) and we are in a web
+        // context (i.e., not chrome), rethrow the original value.
+        if((xpcEx = do_QueryInterface(e)) &&
+           xpcEx->GetThrownJSVal(&thrown) &&
+           !IsCallerChrome())
+        {
+            JS_SetPendingException(cx, thrown);
+            success = JS_TRUE;
+        }
+        else if((xpc = nsXPConnect::GetXPConnect()))
         {
             JSObject* glob = JS_GetScopeChain(cx);
             if(!glob)
                 return JS_FALSE;
             glob = JS_GetGlobalForObject(cx, glob);
 
             nsCOMPtr<nsIXPConnectJSObjectHolder> holder;
             nsresult rv = xpc->WrapNative(cx, glob, e,
diff -r 1aecd2a9914d js/src/xpconnect/src/xpcwrappedjsclass.cpp
--- a/js/src/xpconnect/src/xpcwrappedjsclass.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/js/src/xpconnect/src/xpcwrappedjsclass.cpp	Thu Sep 18 08:03:24 2008 -0500
@@ -1535,17 +1535,17 @@ pre_call_clean_up:
             char* sz = nsnull;
 
             if(nsXPCException::NameAndFormatForNSResult(code, nsnull, &msg) && msg)
                 sz = JS_smprintf(format, msg, name);
 
             nsCOMPtr<nsIException> e;
 
             XPCConvert::ConstructException(code, sz, GetInterfaceName(), name,
-                                           nsnull, getter_AddRefs(e));
+                                           nsnull, getter_AddRefs(e), nsnull);
             xpcc->SetException(e);
             if(sz)
                 JS_smprintf_free(sz);
             success = JS_FALSE;
         }
     }
 
     if (!success)
diff -r 1aecd2a9914d js/src/xpconnect/tests/mochitest/Makefile.in
--- a/js/src/xpconnect/tests/mochitest/Makefile.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/js/src/xpconnect/tests/mochitest/Makefile.in	Thu Sep 18 08:03:24 2008 -0500
@@ -45,12 +45,13 @@ include $(topsrcdir)/config/rules.mk
 include $(topsrcdir)/config/rules.mk
 
 _TEST_FILES =	test_bug361111.xul \
 		test_bug390488.html \
 		test_bug393269.html \
 		test_bug428021.html \
 		test_bug448587.html \
 		test_wrappers.html \
+		test_bug446584.html \
 		$(NULL)
 
 libs:: $(_TEST_FILES)
 	$(INSTALL) $^ $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
diff -r 1aecd2a9914d js/src/xpconnect/tests/mochitest/test_bug446584.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/xpconnect/tests/mochitest/test_bug446584.html	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,49 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=446584
+-->
+<head>
+  <title>Test for Bug 446584</title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=446584">Mozilla Bug 446584</a>
+<p id="display"></p>
+<div id="content" style="display: none">
+  
+</div>
+<pre id="test">
+<script class="testbody" type="text/javascript">
+
+/** Test for Bug 446584 **/
+
+function test(val) {
+  try {
+    document.createNodeIterator(document.body,
+                                NodeFilter.SHOW_ALL,
+                                function() { throw val },
+                                true).nextNode();
+    ok(false, "NodeIterator::nextNode() should have thrown an exception.");
+  } catch (ex) {
+    ok(val === ex, "NodeIterator did not properly forward exception " +
+       val + " of type " + typeof val + ".  Thrown value was " + ex + ".");
+  }
+}
+
+test(0);
+test(1);
+test(3.14);
+test('roses');
+test({});
+test(false);
+test(true);
+test([1,2,3]);
+test(function(){});
+
+</script>
+</pre>
+</body>
+</html>
diff -r 1aecd2a9914d js/tests/browser.js
--- a/js/tests/browser.js	Tue Sep 16 16:40:57 2008 +1200
+++ b/js/tests/browser.js	Thu Sep 18 08:03:24 2008 -0500
@@ -563,21 +563,29 @@ function optionsInit() {
 }
 
 function gczeal(z)
 {
   var javascriptoptions = new Preferences('javascript.options.');
   javascriptoptions.setIntPref('gczeal', Number(z));
 }
 
-function jit()
+function jit(on)
 {
   var javascriptoptions = new Preferences('javascript.options.jit.');
-  javascriptoptions.setBoolPref('content', true);
-  javascriptoptions.setBoolPref('chrome', true);
+  if (on)
+  {
+    javascriptoptions.setBoolPref('content', true);
+    javascriptoptions.setBoolPref('chrome', true);
+  }
+  else
+  {
+    javascriptoptions.setBoolPref('content', false);
+    javascriptoptions.setBoolPref('chrome', false);
+  }
 }
 
 var gVersion = 150;
 
 function jsTestDriverBrowserInit()
 {
   if (typeof dump != 'function')
   {
@@ -615,17 +623,17 @@ function jsTestDriverBrowserInit()
     var zeal = Number(gczealmatches[1]);
     gczeal(zeal);
   }
 
   var jitmatches = /;jit/.exec(document.location.search);
 
   if (jitmatches)
   {
-    jit();
+    jit(true);
   }
 
   var versionmatches = /version=([.0-9]*)/.exec(value);
 
   if (!versionmatches)
   {
     gVersion = 150;
   }
diff -r 1aecd2a9914d js/tests/js1_5/Regress/regress-452853.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/Regress/regress-452853.js	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,64 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-452853.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 452853;
+var summary = 'Do not crash in simple loop with array';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+  
+  jit(true);
+
+  for (var j=0; j<4; ++j) { var a = ["", ""]; a[0] * a[1]; }
+ 
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r 1aecd2a9914d js/tests/js1_5/Regress/regress-452884-01.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/Regress/regress-452884-01.js	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,64 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-452884-01.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 452884;
+var summary = 'Do not crash in switch';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  jit(true);
+
+  for (var j=0;j<5;++j) { switch(1.1) { case NaN: case 2: } }
+ 
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r 1aecd2a9914d js/tests/js1_5/Regress/regress-452884-02.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/Regress/regress-452884-02.js	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,64 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-452884-02.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 452884;
+var summary = 'Do not crash in switch';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  jit(true);
+
+  for (var j=0;j<5;++j) { switch(1.1) { case 2: case NaN: } }
+ 
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r 1aecd2a9914d js/tests/js1_5/Regress/regress-453173.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/Regress/regress-453173.js	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,66 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-453173.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 453173;
+var summary = 'Do not Crash with JIT [@ TraceRecorder::record_JSOP_ENDINIT] with "[,]"';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  var i;
+
+  jit(true);
+
+  for(i=0;i<4;++i) [,];
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r 1aecd2a9914d js/tests/js1_5/Regress/regress-453701.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/Regress/regress-453701.js	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,64 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-453701.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 453701;
+var summary = 'Do not assert with JIT: (rmask(rr) & FpRegs) != 0';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  jit(true);
+
+  (function() { for (var j = 0; j < 5; ++j) { (1).hasOwnProperty(""); } })();
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r 1aecd2a9914d js/tests/js1_5/Regress/regress-453747.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/Regress/regress-453747.js	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,72 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-453747.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 453747;
+var summary = 'Do not assert with JIT: JSVAL_IS_VOID(boxed) || JSVAL_IS_BOOLEAN(boxed)';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  jit(true);
+
+  (function(){
+    var a = [];
+    var s = 10;
+    for (var i = 0; i < s; ++i)
+      a[i] = 1;
+    a[4*s-1] = 2;
+    for (var i = s+1; i < s+4; ++i)
+      typeof a[i];
+  })();
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r 1aecd2a9914d js/tests/js1_5/Regress/regress-454981.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/Regress/regress-454981.js	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,69 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Makoto Kato
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-454981.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 454981;
+var summary = 'Do not assert with JIT: size_t(p - cx->fp->slots) < cx->fp->script->nslots';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  jit(true);
+
+  function f1() { 
+    function f0() { return arguments[0]; } 
+    for (var i = 0; i < 4; i++) f0('a'); 
+  } 
+  f1();
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r 1aecd2a9914d js/tests/js1_5/extensions/regress-454744.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/extensions/regress-454744.js	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,71 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-454744.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 454744;
+var summary = 'Do not assert with JIT: PCVAL_IS_SPROP(entry->vword)';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  jit(true);
+
+  try
+  {
+    this.__defineGetter__('x', function() 2); for (var j=0;j<4;++j) { x=1; }
+  }
+  catch(ex)
+  {
+    print(ex + '');
+  }
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r 1aecd2a9914d js/tests/js1_5/extensions/regress-455380.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/extensions/regress-455380.js	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,93 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Robert Sayre
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-455380.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 455380;
+var summary = 'Do not assert with JIT: !lhs->isQuad() && !rhs->isQuad()';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+printBugNumber(BUGNUMBER);
+printStatus (summary);
+
+jit(true);
+
+const IS_TOKEN_ARRAY =
+  [0, 0, 0, 0, 0, 0, 0, 0, //   0
+   0, 0, 0, 0, 0, 0, 0, 0, //   8
+   0, 0, 0, 0, 0, 0, 0, 0, //  16
+   0, 0, 0, 0, 0, 0, 0, 0, //  24
+
+   0, 1, 0, 1, 1, 1, 1, 1, //  32
+   0, 0, 1, 1, 0, 1, 1, 0, //  40
+   1, 1, 1, 1, 1, 1, 1, 1, //  48
+   1, 1, 0, 0, 0, 0, 0, 0, //  56
+
+   0, 1, 1, 1, 1, 1, 1, 1, //  64
+   1, 1, 1, 1, 1, 1, 1, 1, //  72
+   1, 1, 1, 1, 1, 1, 1, 1, //  80
+   1, 1, 1, 0, 0, 0, 1, 1, //  88
+
+   1, 1, 1, 1, 1, 1, 1, 1, //  96
+   1, 1, 1, 1, 1, 1, 1, 1, // 104
+   1, 1, 1, 1, 1, 1, 1, 1, // 112
+   1, 1, 1, 0, 1, 0, 1];   // 120
+
+const headerUtils = {
+normalizeFieldName: function(fieldName)
+{
+  if (fieldName == "")
+    throw "error: empty string";
+
+  for (var i = 0, sz = fieldName.length; i < sz; i++)
+  {
+    if (!IS_TOKEN_ARRAY[fieldName.charCodeAt(i)])
+    {
+      throw (fieldName + " is not a valid header field name!");
+    }
+  }
+
+  return fieldName.toLowerCase();
+}
+};
+
+headerUtils.normalizeFieldName("Host");
+
+jit(false);
+
+reportCompare(expect, actual, summary);
diff -r 1aecd2a9914d js/tests/js1_5/extensions/regress-455408.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_5/extensions/regress-455408.js	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,64 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-455408.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 455408;
+var summary = 'Do not assert with JIT: "Should not move data from GPR to XMM": false';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  jit(true);
+
+  for (var j = 0; j < 5; ++j) { if (({}).__proto__ = 1) { } }
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r 1aecd2a9914d js/tests/js1_6/extensions/regress-455464-01.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_6/extensions/regress-455464-01.js	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,54 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-455464-01.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 455464;
+var summary = 'Do not assert with JIT: !TRACE_RECORDER(cx) ^ (jumpTable == recordingJumpTable)';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+printBugNumber(BUGNUMBER);
+printStatus (summary);
+
+jit(true);
+
+a=b=c=d=0; this.__defineGetter__('g', gc); for each (y in this);
+
+jit(false);
+
+reportCompare(expect, actual, summary);
diff -r 1aecd2a9914d js/tests/js1_6/extensions/regress-455464-02.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_6/extensions/regress-455464-02.js	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,64 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-455464-02.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 455464;
+var summary = 'Do not assert with JIT: !TRACE_RECORDER(cx) ^ (jumpTable == recordingJumpTable)';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  jit(true);
+
+  a=b=c=d=0; this.__defineGetter__('g', gc); for each (y in this);
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r 1aecd2a9914d js/tests/js1_6/extensions/regress-455464-03.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_6/extensions/regress-455464-03.js	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,66 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-455464-03.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 455464;
+var summary = 'Do not assert with JIT: !TRACE_RECORDER(cx) ^ (jumpTable == recordingJumpTable)';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+a=b=c=d=0; this.__defineGetter__('g', gc); for each (y in this);
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  jit(true);
+
+  a=b=c=d=0; this.__defineGetter__('g', gc); for each (y in this);
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r 1aecd2a9914d js/tests/js1_6/extensions/regress-455464-04.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_6/extensions/regress-455464-04.js	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,68 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-455464-04.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 455464;
+var summary = 'Do not assert with JIT, gczeal 2: !TRACE_RECORDER(cx) ^ (jumpTable == recordingJumpTable)';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+a=b=c=d=0; this.__defineGetter__('g', gc); for each (y in this);
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  jit(true);
+  gczeal(2);
+
+  a=b=c=d=0; this.__defineGetter__('g', gc); for each (y in this);
+
+  gczeal(0);
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r 1aecd2a9914d js/tests/js1_7/regress/regress-453049.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_7/regress/regress-453049.js	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,64 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-453049.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 453049;
+var summary = 'Do not assert with JIT: (*m != JSVAL_INT) || isInt32(*vp)';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  jit(true);
+
+  var z = 0; for (let j = 0; j < 5; ++j) { ({p: (-z)}); }
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r 1aecd2a9914d js/tests/js1_7/regress/regress-453051.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/tests/js1_7/regress/regress-453051.js	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,64 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-453051.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 453051;
+var summary = 'Do not assert with JIT: !(((*pc == JSOP_GOTO) || (*pc == JSOP_GOTOX)) && (exitType != LOOP_EXIT))';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  jit(true);
+
+  for (var p in this){} for (let a in [5,6,7]) for (var b=0;b<1;++b) break;
+
+  jit(false);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff -r 1aecd2a9914d js/tests/js1_8_1/trace/trace-test.js
--- a/js/tests/js1_8_1/trace/trace-test.js	Tue Sep 16 16:40:57 2008 +1200
+++ b/js/tests/js1_8_1/trace/trace-test.js	Thu Sep 18 08:03:24 2008 -0500
@@ -40,16 +40,18 @@
 
 var gTestfile = 'trace-test.js';
 //-----------------------------------------------------------------------------
 var BUGNUMBER = 'none';
 var summary = 'trace-capability mini-testsuite';
 
 printBugNumber(BUGNUMBER);
 printStatus (summary);
+
+jit(true);
  
 var testName = null;
 if ("arguments" in this && arguments.length > 0)
   testName = arguments[0];
 var fails = [], passes=[];
 
 function test(f)
 {
@@ -101,35 +103,43 @@ if (!testName || testName == "bitwiseGlo
   for (var i = 0; i < 60000; i++)
     bitwiseAndValue = bitwiseAndValue & i;
   check("bitwiseGlobal", bitwiseAndValue, 0);
 }
 
 
 function equalInt()
 {
-  var i1 = 55;
-  var hits = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
+  var i1 = 55, one = 1, zero = 0, undef;
+  var o1 = { }, o2 = { };
+  var s = "5";
+  var hits = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
   for (var i = 0; i < 5000; i++) {
     if (i1 == 55) hits[0]++;
     if (i1 != 56) hits[1]++;
     if (i1 < 56)  hits[2]++;
     if (i1 > 50)  hits[3]++;
     if (i1 <= 60) hits[4]++;
     if (i1 >= 30) hits[5]++;
     if (i1 == 7)  hits[6]++;
     if (i1 != 55) hits[7]++;
     if (i1 < 30)  hits[8]++;
     if (i1 > 90)  hits[9]++;
     if (i1 <= 40) hits[10]++;
     if (i1 >= 70) hits[11]++;
+    if (o1 == o2) hits[12]++;
+    if (o2 != null) hits[13]++;
+    if (s < 10) hits[14]++;
+    if (true < zero) hits[15]++;
+    if (undef > one) hits[16]++;
+    if (undef < zero) hits[17]++;
   }
   return hits.toString();
 }
-equalInt.expected = "5000,5000,5000,5000,5000,5000,0,0,0,0,0,0,0,0,0,0,0,0,0";
+equalInt.expected = "5000,5000,5000,5000,5000,5000,0,0,0,0,0,0,0,5000,5000,0,0,0";
 test(equalInt);
 
 var a;
 function setelem()
 {
   a = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
   a = a.concat(a, a, a);
   var l = a.length;
@@ -360,39 +370,40 @@ function testif() {
 		else
 			q--;
 	}
     return q;
 }
 testif.expected = "0";
 test(testif);
 
+var globalinc = 0;
 function testincops(n) {
   var i = 0, o = {p:0}, a = [0];
   n = 100;
 
   for (i = 0; i < n; i++);
   while (i-- > 0);
   for (i = 0; i < n; ++i);
   while (--i >= 0);
 
-  for (o.p = 0; o.p < n; o.p++);
-  while (o.p-- > 0);
-  for (o.p = 0; o.p < n; ++o.p);
-  while (--o.p >= 0);
+  for (o.p = 0; o.p < n; o.p++) globalinc++;
+  while (o.p-- > 0) --globalinc;
+  for (o.p = 0; o.p < n; ++o.p) ++globalinc;
+  while (--o.p >= 0) globalinc--;
 
   ++i; // set to 0
   for (a[i] = 0; a[i] < n; a[i]++);
   while (a[i]-- > 0);
   for (a[i] = 0; a[i] < n; ++a[i]);
   while (--a[i] >= 0);
 
-  return [++o.p, ++a[i]].toString();
+  return [++o.p, ++a[i], globalinc].toString();
 }
-testincops.expected = "0,0";
+testincops.expected = "0,0,0";
 test(testincops);
 
 function trees() {
   var i = 0, o = [0,0,0];
   for (i = 0; i < 100; ++i) {
     if ((i & 1) == 0) o[0]++;
     else if ((i & 2) == 0) o[1]++;
     else o[2]++;
@@ -414,61 +425,85 @@ test(unboxint);
 
 function strings()
 {
   var a = [], b = -1;
   var s = "abcdefghij", s2 = "a";
   var f = "f";
   var c = 0, d = 0, e = 0, g = 0;
   for (var i = 0; i < 10; i++) {
-    a[i] = (s.substring(i, i+1) + s[i] + String.fromCharCode(s2.charCodeAt(0) + i)).concat(i);
+    a[i] = (s.substring(i, i+1) + s[i] + String.fromCharCode(s2.charCodeAt(0) + i)).concat(i) + i;
     if (s[i] == f)
       c++;
     if (s[i] != 'b')
       d++;
     if ("B" > s2)
       g++; // f already used
     if (s2 < "b")
       e++;
     b = s.length;
   }
   return a.toString() + b + c + d + e + g;
 }
-strings.expected = "aaa0,bbb1,ccc2,ddd3,eee4,fff5,ggg6,hhh7,iii8,jjj91019100";
+strings.expected = "aaa00,bbb11,ccc22,ddd33,eee44,fff55,ggg66,hhh77,iii88,jjj991019100";
 test(strings);
+
+function dependentStrings()
+{
+  var a = [];
+  var t = "abcdefghijklmnopqrst";
+  for (var i = 0; i < 10; i++) {
+    var s = t.substring(2*i, 2*i + 2);
+    a[i] = s + s.length;
+  }
+  return a.join("");
+}
+dependentStrings.expected = "ab2cd2ef2gh2ij2kl2mn2op2qr2st2";
+test(dependentStrings);
 
 function stringConvert()
 {
   var a = [];
   var s1 = "F", s2 = "1.3", s3 = "5";
   for (var i = 0; i < 10; i++) {
     a[0] = 1 >> s1;
     a[1] = 10 - s2;
     a[2] = 15 * s3;
     a[3] = s3 | 32;
-    // a[4] = s2 + 60;
+    a[4] = s2 + 60;
     // a[5] = 9 + s3;
     // a[6] = -s3;
     a[7] = s3 & "7";
     // a[8] = ~s3;
   }
   return a.toString();
 }
-stringConvert.expected = "1,8.7,75,37,,,,5";
+stringConvert.expected = "1,8.7,75,37,1.360,,,5";
 test(stringConvert);
 
 function orTestHelper(a, b, n)
 {
   var k = 0;
   for (var i = 0; i < n; i++) {
     if (a || b)
       k += i;
   }
   return k;
 }
+
+var orNaNTest1, orNaNTest2;
+
+orNaNTest1 = new Function("return orTestHelper(NaN, NaN, 10);");
+orNaNTest1.name = 'orNaNTest1';
+orNaNTest1.expected = '0';
+orNaNTest2 = new Function("return orTestHelper(NaN, 1, 10);");
+orNaNTest2.name = 'orNaNTest2';
+orNaNTest2.expected = '45';
+test(orNaNTest1);
+test(orNaNTest2);
 
 function andTestHelper(a, b, n)
 {
   var k = 0;
   for (var i = 0; i < n; i++) {
     if (a && b)
       k += i;
   }
@@ -560,69 +595,766 @@ function newTest()
   var a = [];
   for (var i = 0; i < 10; i++)
     a[i] = new MyConstructor(i);
   return a.join("");
 }
 newTest.expected = "0123456789";
 test(newTest);
 
-function shapelessArgCalleeLoop(f, a)
-{
-  for (var i = 0; i < 10; i++)
-    f(i, a);
-}
-
-function shapelessVarCalleeLoop(f, a)
-{
-  var g = f;
-  for (var i = 0; i < 10; i++)
-    g(i, a);
-}
-
-function shapelessLetCalleeLoop(f, a)
+// The following functions use a delay line of length 2 to change the value
+// of the callee without exiting the traced loop. This is obviously tuned to
+// match the current HOTLOOP setting of 2.
+function shapelessArgCalleeLoop(f, g, h, a)
 {
   for (var i = 0; i < 10; i++) {
-    let g = f;
-    g(i, a);
+    f(i, a);
+    f = g;
+    g = h;
   }
 }
 
-function shapelessUnknownCalleeLoop(f, g, a)
+function shapelessVarCalleeLoop(f0, g, h, a)
+{
+  var f = f0;
+  for (var i = 0; i < 10; i++) {
+    f(i, a);
+    f = g;
+    g = h;
+  }
+}
+
+function shapelessLetCalleeLoop(f0, g, h, a)
 {
   for (var i = 0; i < 10; i++) {
-    (f || g)(i, a);
-    f = null;
+    let f = f0;
+    f(i, a);
+    f = g;
+    g = h;
+  }
+}
+
+function shapelessUnknownCalleeLoop(n, f, g, h, a)
+{
+  for (var i = 0; i < 10; i++) {
+    (n || f)(i, a);
+    f = g;
+    g = h;
   }
 }
 
 function shapelessCalleeTest()
 {
   var a = [];
-  shapelessArgCalleeLoop(function (i, a) a[i] = i, a);
-  shapelessVarCalleeLoop(function (i, a) a[10 + i] = i, a);
-  shapelessLetCalleeLoop(function (i, a) a[20 + i] = i, a);
-  shapelessUnknownCalleeLoop(null, function (i, a) a[30 + i] = i, a);
+
+  var helper = function (i, a) a[i] = i;
+  shapelessArgCalleeLoop(helper, helper, function (i, a) a[i] = -i, a);
+
+  helper = function (i, a) a[10 + i] = i;
+  shapelessVarCalleeLoop(helper, helper, function (i, a) a[10 + i] = -i, a);
+
+  helper = function (i, a) a[20 + i] = i;
+  shapelessLetCalleeLoop(helper, helper, function (i, a) a[20 + i] = -i, a);
+
+  helper = function (i, a) a[30 + i] = i;
+  shapelessUnknownCalleeLoop(null, helper, helper, function (i, a) a[30 + i] = -i, a);
+
   try {
-    shapelessUnknownCalleeLoop(null, {hack: 42}, a);
+    helper = {hack: 42};
+    shapelessUnknownCalleeLoop(null, helper, helper, helper, a);
   } catch (e) {
-    if (e + "" != "TypeError: g is not a function")
+    if (e + "" != "TypeError: f is not a function")
       print("shapelessUnknownCalleeLoop: unexpected exception " + e);
   }
   return a.join("");
 }
-shapelessCalleeTest.expected = "0123456789012345678901234567890123456789";
+shapelessCalleeTest.expected = "01-2-3-4-5-6-7-8-901-2-3-4-5-6-7-8-9012345678901-2-3-4-5-6-7-8-9";
 test(shapelessCalleeTest);
 
 function typeofTest()
 {
   var values = ["hi", "hi", "hi", null, 5, 5.1, true, undefined, /foo/, typeofTest, [], {}], types = [];
   for (var i = 0; i < values.length; i++)
     types[i] = typeof values[i];
   return types.toString();
 }
 typeofTest.expected = "string,string,string,object,number,number,boolean,undefined,object,function,object,object";
 test(typeofTest);
 
+function joinTest()
+{
+  var s = "";
+  var a = [];
+  for (var i = 0; i < 8; i++)
+    a[i] = [String.fromCharCode(97 + i)];
+  for (i = 0; i < 8; i++) {
+    for (var j = 0; j < 8; j++)
+      a[i][1 + j] = j;
+  }
+  for (i = 0; i < 8; i++)
+    s += a[i].join(",");
+  return s;
+}
+joinTest.expected = "a,0,1,2,3,4,5,6,7b,0,1,2,3,4,5,6,7c,0,1,2,3,4,5,6,7d,0,1,2,3,4,5,6,7e,0,1,2,3,4,5,6,7f,0,1,2,3,4,5,6,7g,0,1,2,3,4,5,6,7h,0,1,2,3,4,5,6,7";
+test(joinTest);
+
+function arity1(x)
+{
+  return (x == undefined) ? 1 : 0;
+}
+function missingArgTest() {
+  var q;
+  for (var i = 0; i < 10; i++) {
+    q = arity1();
+  }
+  return q;
+}
+missingArgTest.expected = "1"
+test(missingArgTest);
+
+JSON = function () {
+    return {
+        stringify: function stringify(value, whitelist) {
+            switch (typeof(value)) {
+              case "object":
+                return value.constructor.name;
+            }
+        }
+    };
+}();
+
+function missingArgTest2() {
+  var testPairs = [
+    ["{}", {}],
+    ["[]", []],
+    ['{"foo":"bar"}', {"foo":"bar"}],
+  ]
+
+  var a = [];
+  for (var i=0; i < testPairs.length; i++) {
+    var s = JSON.stringify(testPairs[i][1])
+    a[i] = s;
+  }
+  return a.join(",");
+}
+missingArgTest2.expected = "Object,Array,Object";
+test(missingArgTest2);
+
+function deepForInLoop() {
+  // NB: the number of props set in C is arefully tuned to match HOTLOOP = 2.
+  function C(){this.p = 1, this.q = 2}
+  C.prototype = {p:1, q:2, r:3, s:4, t:5};
+  var o = new C;
+  var j = 0;
+  var a = [];
+  for (var i in o)
+    a[j++] = i;
+  return a.join("");
+}
+deepForInLoop.expected = "pqrst";
+test(deepForInLoop);
+
+function nestedExit(x) {
+    var q = 0;
+    for (var i = 0; i < 10; ++i)
+	if (x)
+	    ++q;
+}
+function nestedExitLoop() {
+    for (var j = 0; j < 10; ++j)
+	nestedExit(j < 7);
+    return "ok";
+}
+nestedExitLoop.expected = "ok";
+test(nestedExitLoop);
+
+function bitsinbyte(b) {
+    var m = 1, c = 0;
+    while(m<0x100) {
+        if(b & m) c++;
+        m <<= 1;
+    }
+    return 1;
+}
+function TimeFunc(func) {
+    var x,y;
+    for(var y=0; y<256; y++) func(y);
+}
+function nestedExit2() {
+    TimeFunc(bitsinbyte);
+    return "ok";
+}
+nestedExit2.expected = "ok";
+test(nestedExit2);
+
+function parsingNumbers() {
+    var s1 = "123";
+    var s1z = "123zzz";
+    var s2 = "123.456";
+    var s2z = "123.456zzz";
+
+    var e1 = 123;
+    var e2 = 123.456;
+
+    var r1, r1z, r2, r2z;
+
+    for (var i = 0; i < 10; i++) {
+	r1 = parseInt(s1);
+	r1z = parseInt(s1z);
+	r2 = parseFloat(s2);
+	r2z = parseFloat(s2z);
+    }
+
+    if (r1 == e1 && r1z == e1 && r2 == e2 && r2z == e2)
+	return "ok";
+    return "fail";
+}
+parsingNumbers.expected = "ok";
+test(parsingNumbers);
+
+function matchInLoop() {
+    var k = "hi";
+    for (var i = 0; i < 10; i++) {
+        var result = k.match(/hi/) != null;
+    }
+    return result;
+}
+matchInLoop.expected = true;
+test(matchInLoop);
+
+function deep1(x) {
+    if (x > 90)
+	return 1;
+    return 2;
+}
+function deep2() {
+    for (var i = 0; i < 100; ++i)
+	deep1(i);
+    return "ok";
+}
+deep2.expected = "ok";
+test(deep2);
+
+var merge_type_maps_x = 0, merge_type_maps_y = 0;
+function merge_type_maps() {
+    for (merge_type_maps_x = 0; merge_type_maps_x < 50; ++merge_type_maps_x)
+        if ((merge_type_maps_x & 1) == 1)
+	    ++merge_type_maps_y;
+    return [merge_type_maps_x,merge_type_maps_y].join(",");
+}
+merge_type_maps.expected = "50,25";
+test(merge_type_maps)
+
+function inner_double_outer_int() {
+    function f(i) {
+	for (var m = 0; m < 20; ++m)
+	    for (var n = 0; n < 100; n += i)
+		;
+	return n;
+    }
+    return f(.5);
+}
+inner_double_outer_int.expected = "100";
+test(inner_double_outer_int);
+
+function newArrayTest()
+{
+  var a = [];
+  for (var i = 0; i < 10; i++)
+    a[i] = new Array();
+  return a.map(function(x) x.length).toString();
+}
+newArrayTest.expected="0,0,0,0,0,0,0,0,0,0";
+test(newArrayTest);
+
+function stringSplitTest()
+{
+  var s = "a,b"
+  var a = null;
+  for (var i = 0; i < 10; ++i)
+    a = s.split(",");
+  return a.join();
+}
+stringSplitTest.expected="a,b";
+test(stringSplitTest);
+
+function stringSplitIntoArrayTest()
+{
+  var s = "a,b"
+  var a = [];
+  for (var i = 0; i < 10; ++i)
+    a[i] = s.split(",");
+  return a.join();
+}
+stringSplitIntoArrayTest.expected="a,b,a,b,a,b,a,b,a,b,a,b,a,b,a,b,a,b,a,b";
+test(stringSplitIntoArrayTest);
+
+function forVarInWith() {
+    function foo() ({notk:42});
+    function bar() ({p:1, q:2, r:3, s:4, t:5});
+    var o = foo();
+    var a = [];
+    with (o) {
+        for (var k in bar())
+            a[a.length] = k;
+    }
+    return a.join("");
+}
+forVarInWith.expected = "pqrst";
+test(forVarInWith);
+
+function inObjectTest() {
+    var o = {p: 1, q: 2, r: 3, s: 4, t: 5};
+    var r = 0;
+    for (var i in o) {
+        if (!(i in o))
+            break;
+        if ((i + i) in o)
+            break;
+        ++r;
+    }
+    return r;
+}
+inObjectTest.expected = 5;
+test(inObjectTest);
+
+function inArrayTest() {
+    var a = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
+    for (var i = 0; i < a.length; i++) {
+        if (!(i in a))
+            break;
+    }
+    return i;
+}
+inArrayTest.expected = 10;
+test(inArrayTest);
+
+function innerLoopIntOuterDouble() {
+    var n = 10000, i=0, j=0, count=0, limit=0;
+    for (i = 1; i <= n; ++i) {
+	limit = i * 1;
+	for (j = 0; j < limit; ++j) {
+	    ++count;
+	}
+    }
+    return "" + count;
+}
+innerLoopIntOuterDouble.expected="50005000";
+test(innerLoopIntOuterDouble);
+
+function outerline(){
+    var i=0;
+    var j=0;
+
+    for (i = 3; i<= 100000; i+=2)
+	for (j = 3; j < 1000; j+=2)
+	    if ((i & 1) == 1)
+		break;
+    return "ok";
+}
+outerline.expected="ok";
+test(outerline);
+
+function addAccumulations(f) {
+  var a = f();
+  var b = f();
+  return a() + b();
+}
+
+function loopingAccumulator() {
+  var x = 0;
+  return function () {
+    for (var i = 0; i < 10; ++i) {
+      ++x;
+    }
+    return x;
+  }
+}
+
+function testLoopingAccumulator() {
+	var x = addAccumulations(loopingAccumulator);
+	return x;
+}
+testLoopingAccumulator.expected = 20;
+test(testLoopingAccumulator);
+
+function testBranchingLoop() {
+  var x = 0;
+  for (var i=0; i < 100; ++i) {
+    if (i == 51) {
+      x += 10;
+    }
+    x++;
+  }
+  return x;
+}
+testBranchingLoop.expected = 110;
+test(testBranchingLoop);
+
+function testBranchingUnstableLoop() {
+  var x = 0;
+  for (var i=0; i < 100; ++i) {
+    if (i == 51) {
+      x += 10.1;
+    }
+    x++;
+  }
+  return x;
+}
+testBranchingUnstableLoop.expected = 110.1;
+test(testBranchingUnstableLoop);
+
+function testBranchingUnstableLoopCounter() {
+  var x = 0;
+  for (var i=0; i < 100; ++i) {
+    if (i == 51) {
+      i += 1.1;
+    }
+    x++;    
+  }
+  return x;
+}
+testBranchingUnstableLoopCounter.expected = 99;
+test(testBranchingUnstableLoopCounter);
+
+
+function testBranchingUnstableObject() {
+  var x = {s: "a"};
+  var t = "";
+  for (var i=0; i < 100; ++i) {
+      if (i == 51)
+      {
+        x.s = 5;
+      }
+      t += x.s;
+  }
+  return t.length;
+}
+testBranchingUnstableObject.expected = 100;
+test(testBranchingUnstableObject);
+
+function testArrayDensityChange() {
+  var x = [];
+  var count = 0;
+  for (var i=0; i < 100; ++i) {
+    x[i] = "asdf";
+  }
+  for (var i=0; i < x.length; ++i) {
+      if (i == 51)
+      {
+        x[199] = "asdf";
+      }
+      if (x[i])
+        count += x[i].length;
+  }
+  return count;
+}
+testArrayDensityChange.expected = 404;
+test(testArrayDensityChange);
+
+function testDoubleToStr() {
+    var x = 0.0;
+    var y = 5.5;
+    for (var i = 0; i < 200; i++) {
+       x += parseFloat(y.toString());
+    }
+    return x;
+}
+testDoubleToStr.expected = 5.5*200;
+test(testDoubleToStr);
+
+function testDecayingInnerLoop() {
+    var i, j, k = 10;
+    for (i = 0; i < 5000; ++i) {
+	for (j = 0; j < k; ++j);
+	--k;
+    }
+    return i;
+}
+testDecayingInnerLoop.expected = 5000;
+test(testDecayingInnerLoop);
+
+function testContinue() {
+    var i;
+    var total = 0;
+    for (i = 0; i < 20; ++i) {
+	if (i == 11)
+	    continue;
+	total++;
+    }
+    return total;
+}
+testContinue.expected = 19;
+test(testContinue);
+
+function testContinueWithLabel() {
+    var i = 0;
+    var j = 20;
+    checkiandj :
+    while (i<10) {
+	i+=1;
+	checkj :
+	while (j>10) {
+	    j-=1;
+	    if ((j%2)==0)
+		continue checkj;
+	}   
+    }
+    return i + j;
+}
+testContinueWithLabel.expected = 20;
+test(testContinueWithLabel);
+
+function testDivision() {
+    var a = 32768;
+    var b;
+    while (b !== 1) {
+	b = a / 2;
+	a = b;
+    }
+    return a;
+}
+testDivision.expected = 1;
+test(testDivision);
+
+function testDivisionFloat() {
+    var a = 32768.0;
+    var b;
+    while (b !== 1) {
+	b = a / 2.0;
+	a = b;
+    }
+    return a === 1.0;
+}
+testDivisionFloat.expected = true;
+test(testDivisionFloat);
+
+function testToUpperToLower() {
+    var s = "Hello", s1, s2;
+    for (i = 0; i < 100; ++i) {
+	s1 = s.toLowerCase();
+	s2 = s.toUpperCase();
+    }
+    return s1 + s2;
+}
+testToUpperToLower.expected = "helloHELLO";
+test(testToUpperToLower);
+
+function testReplace2() {
+    var s = "H e l l o", s1;
+    for (i = 0; i < 100; ++i) {
+	s1 = s.replace(" ", "");
+    }
+    return s1;
+}
+testReplace2.expected = "He l l o";
+test(testReplace2);
+
+function testBitwise() {
+    var x = 10000;
+    var y = 123456;
+    var z = 987234;
+    for (var i = 0; i < 50; i++) {
+        x = x ^ y;
+        y = y | z;
+        z = ~x;
+    }
+    return x + y + z;
+}
+testBitwise.expected = -1298;
+test(testBitwise);
+
+function testSwitch() {
+    var x = 0;
+    var ret = 0;
+    for (var i = 0; i < 100; ++i) {
+        switch (x) {
+            case 0:
+                ret += 1;
+                break;
+            case 1:
+                ret += 2;
+                break;
+            case 2:
+                ret += 3;
+                break;
+            case 3:
+                ret += 4;
+                break;
+            default:
+                x = 0;
+        }
+        x++;
+    }
+    return ret;
+}
+testSwitch.expected = 226;
+test(testSwitch);
+
+function testSwitchString() {
+    var x = "asdf";
+    var ret = 0;
+    for (var i = 0; i < 100; ++i) {
+        switch (x) {
+        case "asdf":
+            x = "asd";
+            ret += 1;
+            break;
+        case "asd":
+            x = "as";
+            ret += 2;
+            break;
+        case "as":
+            x = "a";
+            ret += 3;
+            break;
+        case "a":
+            x = "foo";
+            ret += 4;
+            break;
+        default:
+            x = "asdf";
+        }
+    }
+    return ret;
+}
+testSwitchString.expected = 200;
+test(testSwitchString);
+
+function testNegZero1Helper(z) {
+    for (let j = 0; j < 5; ++j) { z = -z; }
+    return Math.atan2(0, -0) == Math.atan2(0, z);
+}
+
+var testNegZero1 = function() { return testNegZero1Helper(0); }
+testNegZero1.expected = true;
+testNegZero1.name = 'testNegZero1';
+testNegZero1Helper(1);
+test(testNegZero1);
+
+// No test case, just make sure this doesn't assert. 
+function testNegZero2() {
+    var z = 0;
+    for (let j = 0; j < 5; ++j) { ({p: (-z)}); }
+}
+testNegZero2();
+
+function testConstSwitch() {
+    var x;
+    for (var j=0;j<5;++j) { switch(1.1) { case NaN: case 2: } x = 2; }
+    return x;
+}
+testConstSwitch.expected = 2;
+test(testConstSwitch);
+
+function testConstIf() {
+    var x;
+    for (var j=0;j<5;++j) { if (1.1 || 5) { } x = 2;}
+    return x;
+}
+testConstIf.expected = 2;
+test(testConstIf);
+
+function testTypeofHole() {
+  var a = new Array(6);
+  a[5] = 3;
+  for (var i = 0; i < 6; ++i)
+    a[i] = typeof a[i];
+  return a.join(",");
+}
+testTypeofHole.expected = "undefined,undefined,undefined,undefined,undefined,number"
+test(testTypeofHole);
+
+function testNativeLog() {
+  var a = new Array(5);
+  for (var i = 0; i < 5; i++) {
+    a[i] = Math.log(Math.pow(Math.E, 10));
+  }
+  return a.join(",");
+}
+testNativeLog.expected = "10,10,10,10,10";
+test(testNativeLog);
+
+function test_JSOP_ARGSUB() {
+    function f0() { return arguments[0]; }
+    function f1() { return arguments[1]; }
+    function f2() { return arguments[2]; }
+    function f3() { return arguments[3]; }
+    function f4() { return arguments[4]; }
+    function f5() { return arguments[5]; }
+    function f6() { return arguments[6]; }
+    function f7() { return arguments[7]; }
+    function f8() { return arguments[8]; }
+    function f9() { return arguments[9]; }
+    var a = [];
+    for (var i = 0; i < 10; i++) {
+        a[0] = f0('a');
+        a[1] = f1('a','b');
+        a[2] = f2('a','b','c');
+        a[3] = f3('a','b','c','d');
+        a[4] = f4('a','b','c','d','e');
+        a[5] = f5('a','b','c','d','e','f');
+        a[6] = f6('a','b','c','d','e','f','g');
+        a[7] = f7('a','b','c','d','e','f','g','h');
+        a[8] = f8('a','b','c','d','e','f','g','h','i');
+        a[9] = f9('a','b','c','d','e','f','g','h','i','j');
+    }
+    return a.join("");
+}
+test_JSOP_ARGSUB.expected = "abcdefghij";
+test(test_JSOP_ARGSUB);
+
+function test_JSOP_ARGCNT() {
+    function f0() { return arguments.length; }
+    function f1() { return arguments.length; }
+    function f2() { return arguments.length; }
+    function f3() { return arguments.length; }
+    function f4() { return arguments.length; }
+    function f5() { return arguments.length; }
+    function f6() { return arguments.length; }
+    function f7() { return arguments.length; }
+    function f8() { return arguments.length; }
+    function f9() { return arguments.length; }
+    var a = [];
+    for (var i = 0; i < 10; i++) {
+        a[0] = f0('a');
+        a[1] = f1('a','b');
+        a[2] = f2('a','b','c');
+        a[3] = f3('a','b','c','d');
+        a[4] = f4('a','b','c','d','e');
+        a[5] = f5('a','b','c','d','e','f');
+        a[6] = f6('a','b','c','d','e','f','g');
+        a[7] = f7('a','b','c','d','e','f','g','h');
+        a[8] = f8('a','b','c','d','e','f','g','h','i');
+        a[9] = f9('a','b','c','d','e','f','g','h','i','j');
+    }
+    return a.join(",");
+}
+test_JSOP_ARGCNT.expected = "1,2,3,4,5,6,7,8,9,10";
+test(test_JSOP_ARGCNT);
+
+function testNativeMax() {
+    var out = [], k;
+    for (var i = 0; i < 5; ++i) {
+        k = Math.max(k, i);
+    }
+    out.push(k);
+
+    k = 0;
+    for (var i = 0; i < 5; ++i) {
+        k = Math.max(k, i);
+    }
+    out.push(k);
+
+    for (var i = 0; i < 5; ++i) {
+        k = Math.max(0, -0);
+    }
+    out.push((1 / k) < 0);
+    return out.join(",");
+}
+testNativeMax.expected = "NaN,4,false";
+test(testNativeMax);
+
+jit(false);
+
 /* Keep these at the end so that we can see the summary after the trace-debug spew. */
 print("\npassed:", passes.length && passes.join(","));
 print("\nFAILED:", fails.length && fails.join(","));
-
diff -r 1aecd2a9914d js/tests/public-failures.txt
--- a/js/tests/public-failures.txt	Tue Sep 16 16:40:57 2008 +1200
+++ b/js/tests/public-failures.txt	Thu Sep 18 08:03:24 2008 -0500
@@ -1,20 +1,21 @@ TEST_ID=e4x/Expressions/11.1.4-08.js, TE
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 50 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 51 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 53 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 54 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
 TEST_ID=e4x/Expressions/11.1.4-08.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 56 of test - 11.1.4 - XML Initializer - {} Expressions - 08 reason: Expected value 'true', Actual value 'false'
-TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/GC/regress-324278.js:`.``*`: out of memory
-TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/GC/regress-324278.js:`.``*`: out of memory
+TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/GC/regress-324278.js:`.``*`: out of memory
+TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/GC/regress-324278.js:`.``*`: out of memory
+TEST_ID=e4x/GC/regress-324278.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/GC/regress-324278.js:`.``*`: out of memory
 TEST_ID=e4x/Global/13.1.2.1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 4 of test - 13.1.2.1 - isXMLName() reason: Expected value 'exception', Actual value 'no exception'
 TEST_ID=e4x/Global/13.1.2.1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 6 of test - 13.1.2.1 - isXMLName() reason: Expected value '', Actual value '0xAA-0xAA : Invalid char accepted as start : Invalid Char accepted as other NL0xB5-0xB5 : Invalid char accepted as start : Invalid Char accepted as other NL0xB7-0xB7 : Other char not acceptedNL0xBA-0xBA : Invalid char accepted as start : Invalid Char accepted as other NL0x132-0x133 : Invalid char accepted as start : Invalid Char accepted as other NL0x13F-0x140 : Invalid char accepted as start : Invalid Char accepted as other NL0x149-0x149 : Invalid char accepted as start : Invalid Char accepted as other NL0x17F-0x17F : Invalid char accepted as start : Invalid Char accepted as other NL0x1C4-0x1CC : Invalid char accepted as start : Invalid Char accepted as other NL0x1F1-0x1F3 : Invalid char accepted as start : Invalid Char accepted as other NL0x2B0-0x2B8 : Invalid Char accepted as other NL0x2BB-0x2C1 : Start char not acceptedNL0x2E0-0x2E4 : Invalid Char accepted as other NL0x37A-0x37A : Invalid Char accepted as other NL0x387-0x387 : Other char not acceptedNL0x559-0x559 : Start char not acceptedNL0x587-0x587 : Invalid char accepted as start : Invalid Char accepted as other NL0x6E5-0x6E6 : Start char not acceptedNL0xEDC-0xEDD : Invalid char accepted as start : Invalid Char accepted as other NL0x1101-0x1101 : Invalid char accepted as start : Invalid Char accepted as other NL0x1104-0x1104 : Invalid char accepted as start : Invalid Char accepted as other NL0x1108-0x1108 : Invalid char accepted as start : Invalid Char accepted as other NL0x110A-0x110A : Invalid char accepted as start : Invalid Char accepted as other NL0x110D-0x110D : Invalid char accepted as start : Invalid Char accepted as other NL0x1113-0x113B : Invalid char accepted as start : Invalid Char accepted as other NL0x113D-0x113D : Invalid char accepted as start : Invalid Char accepted as other NL0x113F-0x113F : Invalid char accepted as start : Invalid Char accepted as other NL0x1141-0x114B : Invalid char accepted as start : Invalid Char accepted as other NL0x114D-0x114D : Invalid char accepted as start : Invalid Char accepted as other NL0x114F-0x114F : Invalid char accepted as start : Invalid Char accepted as other NL0x1151-0x1153 : Invalid char accepted as start : Invalid Char accepted as other NL0x1156-0x1158 : Invalid char accepted as start : Invalid Char accepted as other NL0x1162-0x1162 : Invalid char accepted as start : Invalid Char accepted as other NL0x1164-0x1164 : Invalid char accepted as start : Invalid Char accepted as other NL0x1166-0x1166 : Invalid char accepted as start : Invalid Char accepted as other NL0x1168-0x1168 : Invalid char accepted as start : Invalid Char accepted as other NL0x116A-0x116C : Invalid char accepted as start : Invalid Char accepted as other NL0x116F-0x1171 : Invalid char accepted as start : Invalid Char accepted as other NL0x1174-0x1174 : Invalid char accepted as start : Invalid Char accepted as other NL0x1176-0x119D : Invalid char accepted as start : Invalid Char accepted as other NL0x119F-0x11A2 : Invalid char accepted as start : Invalid Char accepted as other NL0x11A9-0x11AA : Invalid char accepted as start : Invalid Char accepted as other NL0x11AC-0x11AD : Invalid char accepted as start : Invalid Char accepted as other NL0x11B0-0x11B6 : Invalid char accepted as start : Invalid Char accepted as other NL0x11B9-0x11B9 : Invalid char accepted as start : Invalid Char accepted as other NL0x11BB-0x11BB : Invalid char accepted as start : Invalid Char accepted as other NL0x11C3-0x11EA : Invalid char accepted as start : Invalid Char accepted as other NL0x11EC-0x11EF : Invalid char accepted as start : Invalid Char accepted as other NL0x11F1-0x11F8 : Invalid char accepted as start : Invalid Char accepted as other NL0x207F-0x207F : Invalid char accepted as start : Invalid Char accepted as other NL0x20DD-0x20E0 : Invalid Char accepted as other NL0x2102-0x2102 : Invalid char accepted as start : Invalid Char accepted as other NL0x2107-0x2107 : Invalid char accepted as start : Invalid Char accepted as other NL0x210A-0x2113 : Invalid char accepted as start : Invalid Char accepted as other NL0x2115-0x2115 : Invalid char accepted as start : Invalid Char accepted as other NL0x2118-0x211D : Invalid char accepted as start : Invalid Char accepted as other NL0x2124-0x2124 : Invalid char accepted as start : Invalid Char accepted as other NL0x2128-0x2128 : Invalid char accepted as start : Invalid Char accepted as other NL0x212C-0x212D : Invalid char accepted as start : Invalid Char accepted as other NL0x212F-0x2131 : Invalid char accepted as start : Invalid Char accepted as other NL0x2133-0x2138 : Invalid char accepted as start : Invalid Char accepted as other NL0x2160-0x217F : Invalid char accepted as start : Invalid Char accepted as other NL0x309B-0x309C : Invalid Char accepted as other NL0x3131-0x318E : Invalid char accepted as start : Invalid Char accepted as other NL0xF900-0xFA2D : Invalid char accepted as start : Invalid Char accepted as other NL0xFB00-0xFB06 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB13-0xFB17 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB1E-0xFB1E : Invalid Char accepted as other NL0xFB1F-0xFB28 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB2A-0xFB36 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB38-0xFB3C : Invalid char accepted as start : Invalid Char accepted as other NL0xFB3E-0xFB3E : Invalid char accepted as start : Invalid Char accepted as other NL0xFB40-0xFB41 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB43-0xFB44 : Invalid char accepted as start : Invalid Char accepted as other NL0xFB46-0xFBB1 : Invalid char accepted as start : Invalid Char accepted as other NL0xFBD3-0xFD3D : Invalid char accepted as start : Invalid Char accepted as other NL0xFD50-0xFD8F : Invalid char accepted as start : Invalid Char accepted as other NL0xFD92-0xFDC7 : Invalid char accepted as start : Invalid Char accepted as other NL0xFDF0-0xFDFB : Invalid char accepted as start : Invalid Char accepted as other NL0xFE20-0xFE23 : Invalid Char accepted as other NL0xFE70-0xFE72 : Invalid char accepted as start : Invalid Char accepted as other NL0xFE74-0xFE74 : Invalid char accepted as start : Invalid Char accepted as other NL0xFE76-0xFEFC : Invalid char accepted as start : Invalid Char accepted as other NL0xFF10-0xFF19 : Invalid Char accepted as other NL0xFF21-0xFF3A : Invalid char accepted as start : Invalid Char accepted as other NL0xFF41-0xFF5A : Invalid char accepted as start : Invalid Char accepted as other NL0xFF66-0xFF6F : Invalid char accepted as start : Invalid Char accepted as other NL0xFF70-0xFF70 : Invalid Char accepted as other NL0xFF71-0xFF9D : Invalid char accepted as start : Invalid Char accepted as other NL0xFF9E-0xFF9F : Invalid Char accepted as other NL0xFFA0-0xFFBE : Invalid char accepted as start : Invalid Char accepted as other NL0xFFC2-0xFFC7 : Invalid char accepted as start : Invalid Char accepted as other NL0xFFCA-0xFFCF : Invalid char accepted as start : Invalid Char accepted as other NL0xFFD2-0xFFD7 : Invalid char accepted as start : Invalid Char accepted as other NL0xFFDA-0xFFDC : Invalid char accepted as start : Invalid Char accepted as other NL'
 TEST_ID=e4x/Namespace/regress-292863.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Undeclaring namespace prefix should cause parse error reason: Expected value 'error', Actual value 'no error'
 TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=e4x/Regress/regress-319872.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
@@ -65,22 +66,23 @@ TEST_ID=e4x/decompilation/regress-352789
 TEST_ID=e4x/decompilation/regress-352789.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Decompilation of new and .@ reason: Expected value ' function ( ) { return new ( a ( ) . @ z ) ; } ', Actual value ' function ( ) { return new a . @ z ; } '
 TEST_ID=e4x/decompilation/regress-355474-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: top != 0, at `.``*`jsopcode.c:
 TEST_ID=e4x/decompilation/regress-355474-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: top != 0, at `.``*`jsopcode.c:
 TEST_ID=e4x/decompilation/regress-355474-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=;
 TEST_ID=e4x/decompilation/regress-355474-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Iterating over XML with WAY_TOO_MUCH_GC reason: Expected value ' function ( ) { for each ( var z in <y/> ) { print ( z ) ; } } ', Actual value ' function ( ) { while ( <y/> ) { print ( z ) ; } } '
 TEST_ID=e4x/decompilation/regress-429249.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=trap should not change decompilation <x/> : after trap reason: Expected value ' function g ( ) { return <x/>; } ', Actual value ' function g ( ) { return "<x/>"; } '
 TEST_ID=e4x/extensions/regress-337226.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=function::globalfunction Section  reason: `.``*`/e4x/extensions/regress-337226.js:`.``*`: reference to undefined XML name @mozilla.org/js/function::parseInt
 TEST_ID=e4x/extensions/regress-337226.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/e4x/extensions/regress-337226.js:`.``*`: ReferenceError: reference to undefined XML name @mozilla.org/js/function::parseInt
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/e4x/extensions/regress-374025.js:`.``*`: out of memory
 TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
 TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`received signal 11
-TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/e4x/extensions/regress-374025.js:`.``*`: out of memory
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`received signal 11
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
+TEST_ID=e4x/extensions/regress-374025.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=
 TEST_ID=e4x/extensions/regress-410192.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test - Proper quoting of attribute by uneval/toSource reason: Expected value '"v"', Actual value 'v'
 TEST_ID=ecma/ExecutionContexts/10.2.2-1.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=globalStorage == THIS[globalStorage] reason: wrong value
 TEST_ID=ecma/ExecutionContexts/10.2.2-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=globalStorage == THIS[globalStorage] reason: wrong value
 TEST_ID=ecma/Math/15.8.2.5.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.atan2(-0, 1) reason: wrong value
 TEST_ID=ecma/Math/15.8.2.5.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.atan2(-1, Infinity) reason: wrong value
 TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-0.9) reason: wrong value
 TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-Number.MIN_VALUE) reason: wrong value
 TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-0.9) reason: wrong value
@@ -89,55 +91,52 @@ TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRAN
 TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-Number.MIN_VALUE) reason: wrong value
 TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-0.9) reason: wrong value
 TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-Number.MIN_VALUE) reason: wrong value
 TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-0.9) reason: wrong value
 TEST_ID=ecma/Math/15.8.2.6.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Infinity/Math.ceil(-Number.MIN_VALUE) reason: wrong value
 TEST_ID=ecma/String/15.5.4.6-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=var f = new Object( String.prototype.indexOf ); f('[object Window @ `.``*` (native @ `.``*`)]') reason: wrong value
 TEST_ID=ecma/TypeConversion/9.2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=!(0/0) reason: wrong value
 TEST_ID=ecma/TypeConversion/9.2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=1000 % 0 ? true : false reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
 TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
 TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
 TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
 TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
 TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
 TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
-TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
+TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
 TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
 TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
 TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
 TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=-s2 == -Infinity || -s2 == -1.7976931348623157e+308  reason: wrong value
 TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2) == Infinity || parseInt(s2) == 1.7976931348623157e+308 reason: wrong value
 TEST_ID=ecma/TypeConversion/9.3.1-3.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=parseInt(s2,10) == Infinity || parseInt(s2,10) == 1.7976931348623157e+308 reason: wrong value
 TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-03.js:`.``*`: out of memory
-TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-03.js:`.``*`: out of memory
+TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-03.js:`.``*`: out of memory
 TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-03.js:`.``*`: out of memory
 TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-04.js:`.``*`: out of memory
-TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-04.js:`.``*`: out of memory
+TEST_ID=ecma_3/Array/regress-322135-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-03.js:`.``*`: out of memory
+TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-04.js:`.``*`: out of memory
 TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-04.js:`.``*`: out of memory
 TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=ecma_3/Array/regress-322135-04.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/ecma_3/Array/regress-322135-04.js:`.``*`: out of memory
 TEST_ID=ecma_3/Array/regress-387501.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Array.prototype.toString|toSource|toLocaleString is not generic reason: Expected value 'TypeError: Array.prototype.toLocaleString called on incompatible String', Actual value 'f,o,o'
 TEST_ID=ecma_3/Array/regress-387501.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Array.prototype.toString|toSource|toLocaleString is not generic reason: Expected value 'TypeError: Array.prototype.toSource called on incompatible String', Actual value '["f", "o", "o"]'
 TEST_ID=ecma_3/Array/regress-387501.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Array.prototype.toString|toSource|toLocaleString is not generic reason: Expected value 'TypeError: Array.prototype.toString called on incompatible String', Actual value 'f,o,o'
 TEST_ID=ecma_3/Date/15.9.4.3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=15.9.4.3 - Date.UTC edge-case arguments.: date -1 reason: Expected value '30', Actual value '1'
 TEST_ID=ecma_3/Date/15.9.4.3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=15.9.4.3 - Date.UTC edge-case arguments.: date 0 reason: Expected value '31', Actual value '1'
 TEST_ID=ecma_3/Date/15.9.4.3.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=15.9.4.3 - Date.UTC edge-case arguments.: date null reason: Expected value '31', Actual value '1'
 TEST_ID=ecma_3/Date/15.9.5.5-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.prototype.toLocaleString should not clamp year: check toLocaleString reason: Expected value '-271821', Actual value 'null'
 TEST_ID=ecma_3/Date/15.9.5.5-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.prototype.toLocaleString should not clamp year: check toLocaleString reason: Expected value '275760', Actual value 'null'
@@ -242,95 +241,129 @@ TEST_ID=js1_2/function/regexparg-1.js, T
 TEST_ID=js1_2/function/regexparg-1.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=typeof new f(/abc/) reason: wrong value
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 1 of test -  [,1]  reason: Expected value '1', Actual value '01'
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 2 of test -  [,,1]  reason: Expected value '2', Actual value '012'
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 4 of test -  [1,,]  reason: Expected value '0', Actual value '01'
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 1 of test -  [,1]  reason: Expected value '1', Actual value '01'
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 2 of test -  [,,1]  reason: Expected value '2', Actual value '012'
 TEST_ID=js1_5/Array/11.1.4.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Elisons in Array literals should not be enumed Section 4 of test -  [1,,]  reason: Expected value '0', Actual value '01'
 TEST_ID=js1_5/Array/regress-101964.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test -  reason: Expected value 'Truncation took less than 50 ms', Actual value 'Truncation took `.``*` ms'
+TEST_ID=js1_5/Array/regress-157652.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Array/regress-157652.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Array/regress-157652.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-157652.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Array/regress-157652.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
 TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
-TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
-TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Array/regress-330812.js:`.``*`: out of memory
+TEST_ID=js1_5/Array/regress-330812.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Array/regress-350256-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Error/regress-354246.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Error/regress-354246.js:`.``*`: x is not defined
 TEST_ID=js1_5/Error/regress-354246.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Error/regress-354246.js:`.``*`: x is not defined
 TEST_ID=js1_5/Expressions/regress-394673.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Expressions/regress-394673.js:`.``*`: too much recursion
 TEST_ID=js1_5/Expressions/regress-394673.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Expressions/regress-394673.js:`.``*`: InternalError: too much recursion
 TEST_ID=js1_5/Function/regress-338001.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
 TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-01.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`Expected value 'InternalError: script stack space quota is exhausted', Actual value 'SyntaxError: malformed formal parameter'
+TEST_ID=js1_5/Function/regress-338121-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
 TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
-TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-02.js:`.``*`: out of memory
+TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Function/regress-338121-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Function/regress-338121-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Function/regress-338121-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Function/regress-338121-03.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-203278-2.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-203278-2.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-203278-2.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-203278-2.js:`.``*`: out of memory
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-203278-2.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-203278-2.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-203278-2.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-203278-2.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-203278-2.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-203278-2.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-203278-2.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-203278-2.js:`.``*`: out of memory
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=
 TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-338653.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED signal 9 SIGKILL, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
 TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-346794.js:`.``*`: out of memory
 TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/GC/regress-346794.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/GC/regress-348532.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-348532.js:`.``*`: too much recursion
+TEST_ID=js1_5/GC/regress-348532.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-348532.js:`.``*`: too much recursion
 TEST_ID=js1_5/GC/regress-348532.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-348532.js:`.``*`: too much recursion
-TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-348532.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/GC/regress-348532.js:`.``*`: too much recursion
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
+TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
 TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
 TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/GC/regress-383269-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
 TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
 TEST_ID=js1_5/GC/regress-383269-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`uncaught exception: generate_big_object_graph() leaked
-TEST_ID=js1_5/Regress/regress-203278-1.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-203278-1.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-203278-1.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-203278-1.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-203278-1.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-203278-1.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-203278-1.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-203278-1.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-203278-1.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-203278-1.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-203278-1.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-203278-1.js:`.``*`: out of memory
 TEST_ID=js1_5/Regress/regress-252892.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: top != 0, at `.``*`jsopcode.c:
 TEST_ID=js1_5/Regress/regress-252892.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: top != 0, at `.``*`jsopcode.c:
 TEST_ID=js1_5/Regress/regress-252892.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=;
 TEST_ID=js1_5/Regress/regress-252892.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=for (var i in o) in heavyweight function f should define i in f's activation reason: Expected value 'true', Actual value 'false'
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
 TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
 TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
 TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
 TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
 TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=.* SIGABRT, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-271716-n.js:`.``*`: out of memory
 TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Regress/regress-271716-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Regress/regress-274035.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Regress/regress-274035.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-303213.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Regress/regress-312588.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-312588.js:`.``*`: out of memory
 TEST_ID=js1_5/Regress/regress-314401.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Regress/regress-314401.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/Regress/regress-319384.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-319384.js:`.``*`: can't convert "foo" to an integer
 TEST_ID=js1_5/Regress/regress-320119.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=delegating objects and arguments, arity, caller, name: arguments no longer shared reason: Expected value 'false', Actual value 'true'
 TEST_ID=js1_5/Regress/regress-320119.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=delegating objects and arguments, arity, caller, name: arity no longer shared reason: Expected value 'false', Actual value 'true'
 TEST_ID=js1_5/Regress/regress-320119.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=delegating objects and arguments, arity, caller, name: caller no longer shared reason: Expected value 'false', Actual value 'true'
@@ -353,29 +386,38 @@ TEST_ID=js1_5/Regress/regress-350268.js,
 TEST_ID=js1_5/Regress/regress-350268.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=new Function with unbalanced braces: } { reason: Expected value 'SyntaxError', Actual value 'No Error'
 TEST_ID=js1_5/Regress/regress-350268.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=new Function with unbalanced braces: }}}}} reason: Expected value 'SyntaxError', Actual value 'No Error'
 TEST_ID=js1_5/Regress/regress-352604.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !OBJ_GET_PROTO(cx, ctor), at `.``*`jsapi.c:
 TEST_ID=js1_5/Regress/regress-352604.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !OBJ_GET_PROTO(cx, ctor), at `.``*`jsapi.c:
 TEST_ID=js1_5/Regress/regress-352604.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_5/Regress/regress-362583.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: caller->fun && !JSFUN_HEAVYWEIGHT_TEST(caller->fun->flags), at `.``*`jsscript.c:
 TEST_ID=js1_5/Regress/regress-362583.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: caller->fun && !JSFUN_HEAVYWEIGHT_TEST(caller->fun->flags), at `.``*`jsscript.c:
 TEST_ID=js1_5/Regress/regress-362583.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
+TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-3649-n.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Regress/regress-383674.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Statement that implicitly calls toString should not be optimized away as a "useless expression": 1 reason: Expected value 'toString called', Actual value 'toString not called'
 TEST_ID=js1_5/Regress/regress-383674.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Statement that implicitly calls toString should not be optimized away as a "useless expression": 2 reason: Expected value 'toString called', Actual value 'toString not called'
 TEST_ID=js1_5/Regress/regress-417893.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: top != 0, at `.``*`jsopcode.c:
 TEST_ID=js1_5/Regress/regress-417893.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: top != 0, at `.``*`jsopcode.c:
 TEST_ID=js1_5/Regress/regress-417893.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=;
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
 TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
-TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
-TEST_ID=js1_5/Scope/regress-154693.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Section 1 of test -  reason: Expected value 'true', Actual value 'false'
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/Regress/regress-422348.js:`.``*`: out of memory
+TEST_ID=js1_5/Regress/regress-422348.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/decompilation/regress-351219.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of immutable infinity, NaN decompile Infinity as 1/0 reason: Expected value ' function ( ) { return 1 / 0 ; } ', Actual value ' function ( ) { return Infinity ; } '
 TEST_ID=js1_5/decompilation/regress-351219.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of immutable infinity, NaN: decompile NaN as 0/0 reason: Expected value ' function ( ) { var NaN = 0 / 0 ; return NaN ; } ', Actual value ' function ( ) { var NaN = NaN ; return NaN ; } '
 TEST_ID=js1_5/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of new parenthetic expressions reason: Expected value ' function ( ) { new ( x ( y ) ( z ) ) ; } ', Actual value ' function ( ) { new x ( y ) ( z ) ; } '
 TEST_ID=js1_5/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of new parenthetic expressions reason: Expected value ' function ( ) { new ( x ( y ) . z ) ; } ', Actual value ' function ( ) { new x ( y ) . z ; } '
 TEST_ID=js1_5/decompilation/regress-352013.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of new parenthetic expressions reason: Expected value ' function ( ) { new ( x ( z ) ) ( w ) ; } ', Actual value ' function ( ) { new x ( z ) ( w ) ; } '
 TEST_ID=js1_5/decompilation/regress-352360.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of negative 0 reason: Expected value ' function ( ) { return - 0 ; } ', Actual value ' function ( ) { return 0 ; } '
 TEST_ID=js1_5/decompilation/regress-352360.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of negative 0: 8 / eval("" + f)() reason: Expected value '-Infinity', Actual value 'Infinity'
 TEST_ID=js1_5/decompilation/regress-352453.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_5/decompilation/regress-352453.js:`.``*`: invalid decrement operand
@@ -393,42 +435,48 @@ TEST_ID=js1_5/extensions/regress-164697.
 TEST_ID=js1_5/extensions/regress-164697.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=(new Array()).__proto__ == Array.prototype reason: Expected value 'true', Actual value 'false'
 TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
 TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
 TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
 TEST_ID=js1_5/extensions/regress-226507.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION= reason: Expected value '', Actual value 'InternalError: too much recursion'
 TEST_ID=js1_5/extensions/regress-304897.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=uneval("\t"), uneval("\x09") reason: Expected value '"\t"', Actual value '"\x09"'
 TEST_ID=js1_5/extensions/regress-322957.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=TryMethod should not eat getter exceptions reason: Type mismatch, expected type boolean, actual type number Expected value 'true', Actual value '-1'
 TEST_ID=js1_5/extensions/regress-330569.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336409-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-336409-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-336410-1.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-336410-2.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-342960.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/regress-342960.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-342960.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-345967.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-350531.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-350531.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-350531.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-350531.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-350531.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=slow, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-350531.js:`.``*`: out of memory
+TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-350531.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_5/extensions/regress-350531.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 5, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-350531.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-351448.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-351463-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Treat hyphens as not special adjacent to CharacterClassEscapes in character classes: /([\d-\S]+)/.exec("a0- z") reason: Expected value 'a0-,a0-', Actual value 'SyntaxError: invalid range in character class'
 TEST_ID=js1_5/extensions/regress-351463-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Treat hyphens as not special adjacent to CharacterClassEscapes in character classes: /([\d-\s]+)/.exec("a0- z") reason: Expected value '0- ,0- ', Actual value 'SyntaxError: invalid range in character class'
 TEST_ID=js1_5/extensions/regress-352455.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Eval object with non-function getters/setters reason: Expected value 'SyntaxError: invalid getter usage', Actual value ''
 TEST_ID=js1_5/extensions/regress-352604.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !OBJ_GET_PROTO(cx, ctor), at `.``*`jsapi.c:
 TEST_ID=js1_5/extensions/regress-352604.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !OBJ_GET_PROTO(cx, ctor), at `.``*`jsapi.c:
 TEST_ID=js1_5/extensions/regress-352604.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_5/extensions/regress-352604.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Do not assert: !OBJ_GET_PROTO(cx, ctor) reason: Expected value 'function f() {NL}', Actual value 'function () {NL}'
@@ -441,18 +489,18 @@ TEST_ID=js1_5/extensions/regress-355736.
 TEST_ID=js1_5/extensions/regress-355736.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of "[reserved]" has extra quotes: 2 reason: Expected value ' function ( ) { return { super getter : function ( ) { } } ; } ', Actual value ' function ( ) { return { ' super ' getter : function ( ) { } } ; } '
 TEST_ID=js1_5/extensions/regress-355736.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of "[reserved]" has extra quotes: 3 reason: Expected value ' function ( ) { [ goto ] = a ; } ', Actual value ' function ( ) { [ " goto " ] = a ; } '
 TEST_ID=js1_5/extensions/regress-355736.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of "[reserved]" has extra quotes: 3: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: invalid assignment left-hand side'
 TEST_ID=js1_5/extensions/regress-355820.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Remove non-standard Script object reason: Expected value 'undefined', Actual value 'function'
 TEST_ID=js1_5/extensions/regress-356085.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=js_obj_toString for getter/setter reason: Expected value ' ( { set p y ( ) { } } ) ', Actual value ' ( { set p ( ) { } } ) '
 TEST_ID=js1_5/extensions/regress-365869.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=strict warning for object literal with duplicate propery names reason: Expected value 'TypeError: redeclaration of property 1', Actual value 'No warning'
 TEST_ID=js1_5/extensions/regress-365869.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=strict warning for object literal with duplicate propery names reason: Expected value 'TypeError: redeclaration of property a', Actual value 'No warning'
 TEST_ID=js1_5/extensions/regress-367923.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=strict warning for variable redeclares argument reason: Expected value 'TypeError: variable v redeclares argument', Actual value 'TypeError: variable v hides argument'
-TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
 TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
+TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Numeric sort performance reason: Expected value '(tint/tstr < 3)=true', Actual value '(tint/tstr < 3)=false'
 TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-371636.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_5/extensions/regress-371636.js:`.``*`: out of memory
 TEST_ID=js1_5/extensions/regress-375801.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=uneval should use "(void 0)" instead of "undefined": uneval reason: Expected value ' ( { a : ( void 0 ) } ) ', Actual value ' ( { a : undefined } ) '
 TEST_ID=js1_5/extensions/regress-376052.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=javascript.options.anonfunfix to allow function (){} expressions: 3 reason: Expected value 'SyntaxError: syntax error', Actual value 'No Error'
 TEST_ID=js1_5/extensions/regress-379523.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of sharp declaration: 1 reason: Expected value ' ( function ( ) { return # 1 = [ a ] ; } ) ', Actual value ' ( function ( ) { return # 1 = [ , a ] ; } ) '
 TEST_ID=js1_5/extensions/regress-379523.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of sharp declaration: 1 reason: Expected value ' ( function ( ) { return # 1 = { a : b } ; } ) ', Actual value ' ( function ( ) { return # 1 = { , a : b } ; } ) '
 TEST_ID=js1_5/extensions/regress-379523.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Decompilation of sharp declaration: 1: compile actual reason: Expected value 'No Error', Actual value 'SyntaxError: invalid property id'
@@ -489,20 +537,18 @@ TEST_ID=js1_5/extensions/regress-435345-
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 3 reason: Expected value 'watcher: propname=length, oldval=2, newval=1; ', Actual value 'watcher: propname=length, oldval=undefined, newval=1; '
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 4 reason: Expected value 'watcher: propname=length, oldval=1, newval=2; ', Actual value 'watcher: propname=length, oldval=undefined, newval=2; '
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 5 reason: Expected value 'watcher: propname=length, oldval=2, newval=5; ', Actual value 'watcher: propname=length, oldval=undefined, newval=5; '
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 1 reason: Expected value 'watcher: propname=length, oldval=0, newval=1; ', Actual value ''
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 2 reason: Expected value 'watcher: propname=length, oldval=1, newval=2; watcher: propname=length, oldval=2, newval=2; ', Actual value 'watcher: propname=length, oldval=undefined, newval=2; '
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 3 reason: Expected value 'watcher: propname=length, oldval=2, newval=1; ', Actual value 'watcher: propname=length, oldval=undefined, newval=1; '
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 4 reason: Expected value 'watcher: propname=length, oldval=1, newval=2; ', Actual value 'watcher: propname=length, oldval=undefined, newval=2; '
 TEST_ID=js1_5/extensions/regress-435345-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Watch the length property of arrays: 5 reason: Expected value 'watcher: propname=length, oldval=2, newval=5; ', Actual value 'watcher: propname=length, oldval=undefined, newval=5; '
-TEST_ID=js1_5/extensions/regress-443569.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-443569.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-443569.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
-TEST_ID=js1_5/extensions/regress-443569.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-443569.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
+TEST_ID=js1_5/extensions/regress-443569.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=No test results reported
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-1 99', Actual value '-001 -1'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-51 49', Actual value '-051 -51'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value '-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51', Actual value '-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'xxx-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51', Actual value 'xxx-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051-051'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("xxxx%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y%Y") reason: Expected value 'Sat Jan 01 -0051 00:00:00 `.``*`', Actual value 'xxxx-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51-51'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-1 99', Actual value '000/ 0/'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-100 00', Actual value '0/00 00'
 TEST_ID=js1_5/extensions/toLocaleFormat-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Date.toLocaleFormat("%Y %y") reason: Expected value '-51 49', Actual value '00+/ +/'
@@ -616,32 +662,35 @@ TEST_ID=js1_7/geniter/regress-349012-01.
 TEST_ID=js1_7/geniter/regress-349012-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/geniter/regress-349012-01.js:`.``*`: yield from closing generator function gen() {try {try {yield 1;} finally {actual += "Inner finally";yield 2;}} finally {actual += ",Outer finally";}}
 TEST_ID=js1_7/geniter/regress-349012-01.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=closing a generator fails to report error if yield during close is ignored reason: Expected value 'Inner finally,Outer finally', Actual value ''
 TEST_ID=js1_7/geniter/regress-349012-01.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=closing a generator fails to report error if yield during close is ignored reason: Expected value 'Inner finally,Outer finally', Actual value ''
 TEST_ID=js1_7/geniter/regress-349331.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=test GC-invoke close reason: Expected value 'true', Actual value 'false'
 TEST_ID=js1_7/geniter/regress-349331.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=test GC-invoke close reason: Expected value 'true', Actual value 'false'
 TEST_ID=js1_7/iterable/regress-340526-02.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Iterators: cross-referenced objects with close handler can delay close handler execution reason: Expected value '2', Actual value '0'
 TEST_ID=js1_7/iterable/regress-340526-02.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Iterators: cross-referenced objects with close handler can delay close handler execution reason: Expected value '2', Actual value '0'
 TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_7/iterable/regress-341815.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
-TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
+TEST_ID=js1_7/iterable/regress-341821.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=opt, TEST_TYPE=browser, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_7/iterable/regress-415922.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Support exception from withing JSNewEnumerateOp on JSENUMERATE_NEXT reason: Expected value 'Error: its enumeration failed', Actual value 'No exception r: color'
 TEST_ID=js1_7/lexical/regress-346642-03.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 8 reason: Expected value 'TypeError: ++x is not a function', Actual value 'TypeError: ++e1 is not a function'
 TEST_ID=js1_7/lexical/regress-346642-03.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 2 reason: Expected match to '/TypeError: x.t (has no properties|is undefined)/', Actual value 'TypeError: e1.t has no properties'
 TEST_ID=js1_7/lexical/regress-346642-03.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 2 reason: Expected match to '/TypeError: x.t (has no properties|is undefined)/', Actual value 'TypeError: e1.t is undefined'
 TEST_ID=js1_7/lexical/regress-346642-03.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=decompilation of destructuring assignment: 2 reason: Expected match to '/TypeError: x.t (has no properties|is undefined)/', Actual value 'TypeError: e1.t is undefined'
 TEST_ID=js1_7/lexical/regress-351515.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Invalid uses of yield, let keywords in js17: global: yield = 1 reason: Expected value 'SyntaxError: syntax error', Actual value 'SyntaxError: yield not in function'
 TEST_ID=js1_7/regexp/yflag.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/regexp/yflag.js:`.``*`: invalid flag after regular expression
 TEST_ID=js1_7/regexp/yflag.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_7/regexp/yflag.js:`.``*`: SyntaxError: invalid flag after regular expression
-TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=.*, TEST_REPO=mozilla-central, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=
-TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=
+TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=.*, TEST_REPO=tracemonkey, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=medium, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=
 TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-350387.js:`.``*`: x is not defined
 TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-350387.js:`.``*`: ReferenceError: x is not defined
 TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Unknown reason: http://test.mozilla.com//tests/mozilla.org/js/js1_7/regress/regress-350387.js:`.``*`: x is not defined
+TEST_ID=js1_7/regress/regress-350387.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL 3, TEST_DESCRIPTION=
 TEST_ID=js1_7/regress/regress-361566.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-361566.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-361566.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/regress/regress-363040-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Test reduce of empty array without initializer. : TypeError: reduce of empty array with no initial value reason: Expected value 'TypeError: reduce of empty array with no initial value', Actual value 'TypeError: arr0elms.reduce is not a function'
 TEST_ID=js1_7/regress/regress-363040-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Test reduceRight of empty array without initializer. : TypeError: reduce of empty array with no initial value reason: Expected value 'TypeError: reduce of empty array with no initial value', Actual value 'TypeError: arr0elms.reduceRight is not a function'
 TEST_ID=js1_7/regress/regress-363040-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-363040-01.js:`.``*`: arr0elms.reduce is not a function
 TEST_ID=js1_7/regress/regress-363040-01.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=shell, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=Test reduceRight of empty array without initializer. : TypeError: reduce of empty array with no initial value reason: Expected value 'TypeError: reduce of empty array with no initial value', Actual value 'TypeError: arr0elms.reduceRight is not a function';
 TEST_ID=js1_7/regress/regress-363040-02.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=`.``*`/js1_7/regress/regress-363040-02.js:`.``*`: arr.reduce is not a function
@@ -659,8 +708,48 @@ TEST_ID=js1_7/regress/regress-373828.js,
 TEST_ID=js1_7/regress/regress-373828.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/regress/regress-375695.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=darwin, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-375695.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=linux, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=CRASHED.*, TEST_DESCRIPTION=`.``*`Assertion failure: !fp->blockChain || OBJ_GET_PARENT(cx, obj) == fp->blockChain, at `.``*`jsinterp.c:
 TEST_ID=js1_7/regress/regress-375695.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=debug, TEST_TYPE=.*, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=ABNORMAL.*, TEST_DESCRIPTION=
 TEST_ID=js1_7/regress/regress-406477.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=eval of function x() in a function with an argument "x" and "let x" reason: Expected value '', Actual value 'Unexpected test_param_result value: 1NLUnexpected test_var_result value: 1NL'
 TEST_ID=js1_7/regress/regress-410649.js, TEST_BRANCH=.*, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=type for destructuring parameter case reason: Expected value 'function', Actual value 'number'
 TEST_ID=js1_8/genexps/regress-380237-04.js, TEST_BRANCH=1.8.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=browser, TEST_OS=nt, TEST_KERNEL=.*, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=TIMED OUT, TEST_DESCRIPTION=
 TEST_ID=js1_8/genexps/regress-380237-04.js, TEST_BRANCH=1.9.0, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=Generator expressions parenthesization test: roundTripTest no round-trip change reason: Expected value 'function anonymous() {NL    for (;;) {NL    }NL}', Actual value 'function anonymous() {NL    for (; (x * x for (x in []));) {NL    }NL}'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205F".trim() reason: Expected value '', Actual value '\u205F\u205F\u205F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205F".trimLeft() reason: Expected value '', Actual value '\u205F\u205F\u205F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205F".trimRight() reason: Expected value '', Actual value '\u205F\u205F\u205F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205Fa".trim() reason: Expected value 'a', Actual value '\u205F\u205F\u205Fa'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205Fa".trimLeft() reason: Expected value 'a', Actual value '\u205F\u205F\u205Fa'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205Fa\u205F\u205F\u205F".trim() reason: Expected value 'a', Actual value '\u205F\u205F\u205Fa\u205F\u205F\u205F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205Fa\u205F\u205F\u205F".trimLeft() reason: Expected value 'a\u205F\u205F\u205F', Actual value '\u205F\u205F\u205Fa\u205F\u205F\u205F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"\u205F\u205F\u205Fa\u205F\u205F\u205F".trimRight() reason: Expected value '\u205F\u205F\u205Fa', Actual value '\u205F\u205F\u205Fa\u205F\u205F\u205F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"a\u205F\u205F\u205F".trim() reason: Expected value 'a', Actual value 'a\u205F\u205F\u205F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MEDIUM MATHEMATICAL SPACE:"a\u205F\u205F\u205F".trimRight() reason: Expected value 'a', Actual value 'a\u205F\u205F\u205F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180E".trim() reason: Expected value '', Actual value '\u180E\u180E\u180E'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180E".trimLeft() reason: Expected value '', Actual value '\u180E\u180E\u180E'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180E".trimRight() reason: Expected value '', Actual value '\u180E\u180E\u180E'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180Ea".trim() reason: Expected value 'a', Actual value '\u180E\u180E\u180Ea'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180Ea".trimLeft() reason: Expected value 'a', Actual value '\u180E\u180E\u180Ea'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180Ea\u180E\u180E\u180E".trim() reason: Expected value 'a', Actual value '\u180E\u180E\u180Ea\u180E\u180E\u180E'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180Ea\u180E\u180E\u180E".trimLeft() reason: Expected value 'a\u180E\u180E\u180E', Actual value '\u180E\u180E\u180Ea\u180E\u180E\u180E'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"\u180E\u180E\u180Ea\u180E\u180E\u180E".trimRight() reason: Expected value '\u180E\u180E\u180Ea', Actual value '\u180E\u180E\u180Ea\u180E\u180E\u180E'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"a\u180E\u180E\u180E".trim() reason: Expected value 'a', Actual value 'a\u180E\u180E\u180E'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=MONGOLIAN VOWEL SEPARATOR:"a\u180E\u180E\u180E".trimRight() reason: Expected value 'a', Actual value 'a\u180E\u180E\u180E'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202F".trim() reason: Expected value '', Actual value '\u202F\u202F\u202F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202F".trimLeft() reason: Expected value '', Actual value '\u202F\u202F\u202F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202F".trimRight() reason: Expected value '', Actual value '\u202F\u202F\u202F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202Fa".trim() reason: Expected value 'a', Actual value '\u202F\u202F\u202Fa'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202Fa".trimLeft() reason: Expected value 'a', Actual value '\u202F\u202F\u202Fa'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202Fa\u202F\u202F\u202F".trim() reason: Expected value 'a', Actual value '\u202F\u202F\u202Fa\u202F\u202F\u202F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202Fa\u202F\u202F\u202F".trimLeft() reason: Expected value 'a\u202F\u202F\u202F', Actual value '\u202F\u202F\u202Fa\u202F\u202F\u202F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"\u202F\u202F\u202Fa\u202F\u202F\u202F".trimRight() reason: Expected value '\u202F\u202F\u202Fa', Actual value '\u202F\u202F\u202Fa\u202F\u202F\u202F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"a\u202F\u202F\u202F".trim() reason: Expected value 'a', Actual value 'a\u202F\u202F\u202F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=NARROW NO-BREAK SPACE:"a\u202F\u202F\u202F".trimRight() reason: Expected value 'a', Actual value 'a\u202F\u202F\u202F'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680".trim() reason: Expected value '', Actual value '\u1680\u1680\u1680'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680".trimLeft() reason: Expected value '', Actual value '\u1680\u1680\u1680'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680".trimRight() reason: Expected value '', Actual value '\u1680\u1680\u1680'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680a".trim() reason: Expected value 'a', Actual value '\u1680\u1680\u1680a'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680a".trimLeft() reason: Expected value 'a', Actual value '\u1680\u1680\u1680a'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680a\u1680\u1680\u1680".trim() reason: Expected value 'a', Actual value '\u1680\u1680\u1680a\u1680\u1680\u1680'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680a\u1680\u1680\u1680".trimLeft() reason: Expected value 'a\u1680\u1680\u1680', Actual value '\u1680\u1680\u1680a\u1680\u1680\u1680'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"\u1680\u1680\u1680a\u1680\u1680\u1680".trimRight() reason: Expected value '\u1680\u1680\u1680a', Actual value '\u1680\u1680\u1680a\u1680\u1680\u1680'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"a\u1680\u1680\u1680".trim() reason: Expected value 'a', Actual value 'a\u1680\u1680\u1680'
+TEST_ID=js1_8_1/String/regress-305064.js, TEST_BRANCH=1.9.1, TEST_REPO=.*, TEST_BUILDTYPE=.*, TEST_TYPE=.*, TEST_OS=.*, TEST_KERNEL=.*, TEST_PROCESSORTYPE=.*, TEST_MEMORY=.*, TEST_CPUSPEED=.*, TEST_TIMEZONE=.*, TEST_RESULT=FAILED, TEST_EXITSTATUS=NORMAL, TEST_DESCRIPTION=OGHAM SPACE MARK:"a\u1680\u1680\u1680".trimRight() reason: Expected value 'a', Actual value 'a\u1680\u1680\u1680'
diff -r 1aecd2a9914d js/tests/runtests.sh
--- a/js/tests/runtests.sh	Tue Sep 16 16:40:57 2008 +1200
+++ b/js/tests/runtests.sh	Thu Sep 18 08:03:24 2008 -0500
@@ -64,17 +64,17 @@ TEST_JSDIR=${TEST_JSDIR:-$TEST_DIR/tests
 TEST_JSDIR=${TEST_JSDIR:-$TEST_DIR/tests/mozilla.org/js}
 
 usage()
 {
     cat <<EOF
 usage: runtests.sh -p products -b branches -e extra\\
                    -T  buildtypes -B buildcommands  \\
                    [-v] [-S] [-X excludetests] [-I includetests] [-c] [-t] \\
-                   [-Z n]
+                   [-J javascriptoptions]
 
 variable            description
 ===============     ============================================================
 -p products         space separated list of js, firefox
 -b branches         space separated list of branches 1.8.0, 1.8.1, 1.9.0, 1.9.1
 -e extra            optional. extra qualifier to pick build tree and mozconfig.
 -T buildtypes       space separated list of build types opt debug
 -B buildcommands    optional space separated list of build commands
diff -r 1aecd2a9914d js/tests/shell.js
--- a/js/tests/shell.js	Tue Sep 16 16:40:57 2008 +1200
+++ b/js/tests/shell.js	Thu Sep 18 08:03:24 2008 -0500
@@ -846,16 +846,28 @@ function jsTestDriverEnd()
 
   for (var i = 0; i < gTestcases.length; i++)
   {
     gTestcases[i].dump();
   }
 
 }
 
+function jit(on)
+{
+  if (on && !options().match(/jit/))
+  {
+    options('jit');
+  }
+  else if (!on && options().match(/jit/))
+  {
+    options('jit');
+  }
+}
+
 /*
  * Some tests need to know if we are in Rhino as opposed to SpiderMonkey
  */
 function inRhino()
 {
   return (typeof defineClass == "function");
 }
 
diff -r 1aecd2a9914d js/tests/universe.data
--- a/js/tests/universe.data	Tue Sep 16 16:40:57 2008 +1200
+++ b/js/tests/universe.data	Thu Sep 18 08:03:24 2008 -0500
@@ -1,29 +1,33 @@ TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST
 TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=8.11.0, TEST_PROCESSORTYPE=powerpc32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=+0200, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=darwin, TEST_KERNEL=9.4.0, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
@@ -32,22 +36,45 @@ TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=4, TEST_CPUSPEED=slow, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=mozilla-central, TEST_BUILDTYPE=opt, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=debug, TEST_TYPE=shell
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=browser
+TEST_OS=linux, TEST_KERNEL=2.6.18, TEST_PROCESSORTYPE=intel64, TEST_MEMORY=4, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.1, TEST_REPO=tracemonkey, TEST_BUILDTYPE=opt, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=amd32, TEST_MEMORY=2, TEST_CPUSPEED=medium, TEST_TIMEZONE=-0700, TEST_BRANCH=1.9.0, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=debug, TEST_TYPE=shell
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=browser
 TEST_OS=nt, TEST_KERNEL=5.1, TEST_PROCESSORTYPE=intel32, TEST_MEMORY=2, TEST_CPUSPEED=fast, TEST_TIMEZONE=-0700, TEST_BRANCH=1.8.1, TEST_REPO=CVS, TEST_BUILDTYPE=opt, TEST_TYPE=shell
diff -r 1aecd2a9914d layout/base/nsPresShell.cpp
--- a/layout/base/nsPresShell.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/layout/base/nsPresShell.cpp	Thu Sep 18 08:03:24 2008 -0500
@@ -2931,46 +2931,19 @@ PresShell::CompleteMove(PRBool aForward,
     // After ScrollSelectionIntoView(), the pending notifications might be
     // flushed and PresShell/PresContext/Frames may be dead. See bug 418470.
     return
       ScrollSelectionIntoView(nsISelectionController::SELECTION_NORMAL, 
                               nsISelectionController::SELECTION_FOCUS_REGION,
                               PR_TRUE);
   }
 
-  nsIScrollableView *scrollableView;
-  if (!mViewManager) 
-    return NS_ERROR_UNEXPECTED;
-  nsresult result = mViewManager->GetRootScrollableView(&scrollableView);
-  if (NS_FAILED(result)) 
-    return result;
-  if (!scrollableView) 
-    return NS_ERROR_UNEXPECTED;
-  nsIView *scrolledView;
-  result = scrollableView->GetScrolledView(scrolledView);
-  // get a frame
-  nsIFrame *frame = (nsIFrame*)scrolledView->GetClientData();
+  nsIFrame *frame = FrameConstructor()->GetRootElementFrame();
   if (!frame)
     return NS_ERROR_FAILURE;
-  //we need to get to the area frame.
-  nsIAtom* frameType;
-  do 
-  {
-    frameType = frame->GetType();
-    if (frameType != nsGkAtoms::areaFrame)
-    {
-      frame = frame->GetFirstChild(nsnull);
-      if (!frame)
-        break;
-    }
-  }while(frameType != nsGkAtoms::areaFrame);
-  
-  if (!frame)
-    return NS_ERROR_FAILURE; //could not find an area frame.
-
   nsPeekOffsetStruct pos = frame->GetExtremeCaretPosition(!aForward);
 
   mSelection->HandleClick(pos.mResultContent ,pos.mContentOffset ,pos.mContentOffset/*End*/ ,aExtend, PR_FALSE, aForward);
 
   // After ScrollSelectionIntoView(), the pending notifications might be
   // flushed and PresShell/PresContext/Frames may be dead. See bug 418470.
   return ScrollSelectionIntoView(nsISelectionController::SELECTION_NORMAL, 
                                  nsISelectionController::SELECTION_FOCUS_REGION,
diff -r 1aecd2a9914d layout/printing/nsPrintEngine.cpp
--- a/layout/printing/nsPrintEngine.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/layout/printing/nsPrintEngine.cpp	Thu Sep 18 08:03:24 2008 -0500
@@ -1424,16 +1424,19 @@ nsPrintEngine::GetDisplayTitleAndURL(nsP
         break;
 
       case eDocTitleDefURLDoc:
         if (*aURLStr) {
           *aTitle = NS_strdup(*aURLStr);
         } else if (mPrt->mBrandName) {
           *aTitle = NS_strdup(mPrt->mBrandName);
         }
+        break;
+      case eDocTitleDefNone:
+        // *aTitle defaults to nsnull
         break;
     }
   }
 }
 
 //---------------------------------------------------------------------
 nsresult nsPrintEngine::DocumentReadyForPrinting()
 {
diff -r 1aecd2a9914d layout/reftests/bugs/212563-1-inner.html
--- a/layout/reftests/bugs/212563-1-inner.html	Tue Sep 16 16:40:57 2008 +1200
+++ b/layout/reftests/bugs/212563-1-inner.html	Thu Sep 18 08:03:24 2008 -0500
@@ -1,3 +1,7 @@
-<frameset resizable="yes" rows="100%">
-  <frame src="data:text/html,<body onload=%22var d = parent.document; d.write('<body onload=parent.document.documentElement.removeAttribute(\'class\');>foo'); d.close();%22>">
+<html>
+<head>
+</head>
+<frameset resizable="yes" rows="100%" onload="top.p(1);">
+  <frame src="data:text/html,<body onload=%22top.p(0); var t = top; var d = parent.document; d.write('<body onload=top.p(5);><script>top.p(2);</script>'); t.p(3); t.p(d.documentElement.innerHTML); d.close(); t.p(4); %22>">
 </frameset>
+</html>
diff -r 1aecd2a9914d layout/reftests/bugs/212563-1-ref-inner.html
--- a/layout/reftests/bugs/212563-1-ref-inner.html	Tue Sep 16 16:40:57 2008 +1200
+++ b/layout/reftests/bugs/212563-1-ref-inner.html	Thu Sep 18 08:03:24 2008 -0500
@@ -1,7 +1,6 @@
 <html>
 <head>
 </head>
 <body>
-foo
 </body>
 </html>
diff -r 1aecd2a9914d layout/reftests/bugs/212563-1-ref.html
--- a/layout/reftests/bugs/212563-1-ref.html	Tue Sep 16 16:40:57 2008 +1200
+++ b/layout/reftests/bugs/212563-1-ref.html	Thu Sep 18 08:03:24 2008 -0500
@@ -1,7 +1,8 @@
 <html>
 <head>
 </head>
 <body>
+<p>This test is designed to pass regardless of who wins the document.write race.</p>
 <iframe src="212563-1-ref-inner.html"></iframe>
 </body>
 </html>
diff -r 1aecd2a9914d layout/reftests/bugs/212563-1.html
--- a/layout/reftests/bugs/212563-1.html	Tue Sep 16 16:40:57 2008 +1200
+++ b/layout/reftests/bugs/212563-1.html	Thu Sep 18 08:03:24 2008 -0500
@@ -1,7 +1,14 @@
-<html class="reftest-wait">
+<html>
 <head>
+<script type="text/javascript">
+function p(n)
+{
+  dump("Test 212563-1 says: " + n + "\n");
+}
+</script>
 </head>
 <body>
+<p>This test is designed to pass regardless of who wins the document.write race.</p>
 <iframe src="212563-1-inner.html"></iframe>
 </body>
 </html>
diff -r 1aecd2a9914d layout/reftests/bugs/212563-2-inner.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/bugs/212563-2-inner.html	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,9 @@
+<html>
+<head>
+</head>
+<frameset resizable="yes" rows="100%" onload="parent.changeInnermost(document.getElementById(&quot;innermost&quot;))">
+
+  <frame id="innermost" src="data:text/html,<font color=red>old innermost"></frame>
+
+</frameset>
+</html>
diff -r 1aecd2a9914d layout/reftests/bugs/212563-2-ref-inner.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/bugs/212563-2-ref-inner.html	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,7 @@
+<html>
+<head>
+</head>
+<body>
+replacement for middle frame
+</body>
+</html>
diff -r 1aecd2a9914d layout/reftests/bugs/212563-2-ref.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/bugs/212563-2-ref.html	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,7 @@
+<html>
+<head>
+</head>
+<body>
+<iframe src="212563-2-ref-inner.html"></iframe>
+</body>
+</html>
diff -r 1aecd2a9914d layout/reftests/bugs/212563-2.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/reftests/bugs/212563-2.html	Thu Sep 18 08:03:24 2008 -0500
@@ -0,0 +1,36 @@
+<html class="reftest-wait">
+<head>
+<script type="text/javascript">
+
+function p(n)
+{
+  dump("Test 212563-2 says: " + n + "\n");
+}
+
+// Step 1: replace the innermost frame
+function changeInnermost(iframeElement)
+{
+  iframeElement.setAttribute("src", 
+    "data:text/html,<body onload='" + w + "w(parent.document, top);'><font color=blue>new innermost");
+}
+
+// Step 2: replace the middle iframe (from the new innermost iframe's onload handler)
+var replacementForMiddleFrame = "<body onload=top.p(5);parent.document.documentElement.removeAttribute('class');>replacement for middle frame<script>top.p(2);<\/script><\/body>";
+
+function w(md, t)
+{
+  t.p(0); 
+  md.write(t.replacementForMiddleFrame);
+  t.p(3);
+  t.p(md.documentElement.innerHTML); 
+  md.close(); 
+  t.p(4);
+}
+
+
+</script>
+</head>
+<body>
+<iframe src="212563-2-inner.html"></iframe>
+</body>
+</html>
diff -r 1aecd2a9914d layout/reftests/bugs/reftest.list
--- a/layout/reftests/bugs/reftest.list	Tue Sep 16 16:40:57 2008 +1200
+++ b/layout/reftests/bugs/reftest.list	Thu Sep 18 08:03:24 2008 -0500
@@ -133,16 +133,17 @@ fails == 25888-3r.html 25888-3r-ref.html
 == 201293-1c.html 201293-1-ref.html
 == 201293-1d.html 201293-1-ref.html
 == 206516-1.html 206516-1-ref.html
 == 210094-1a.html 210094-1-ref.html
 == 210094-1b.html 210094-1-ref.html
 != 210094-1c.html 210094-1-ref.html
 == 210876-1.html 210876-1-ref.html
 == 212563-1.html 212563-1-ref.html
+== 212563-2.html 212563-2-ref.html
 == 214077-1a.html 214077-1-ref.html
 == 214077-1b.html 214077-1-ref.html
 == 218473-1.html 218473-1-ref.html
 # == 231823-1.html 231823-1-ref.html
 == 234686-1.html 234686-ref.html
 == 234686-2.html 234686-ref.html
 == 234686-3.html 234686-ref.html
 == 234686-4.html 234686-ref.html
diff -r 1aecd2a9914d layout/reftests/text/reftest.list
--- a/layout/reftests/text/reftest.list	Tue Sep 16 16:40:57 2008 +1200
+++ b/layout/reftests/text/reftest.list	Thu Sep 18 08:03:24 2008 -0500
@@ -16,11 +16,11 @@ random-if(MOZ_WIDGET_TOOLKIT=="gtk2") ==
 random-if(MOZ_WIDGET_TOOLKIT=="gtk2") == wordwrap-03.html wordwrap-03-ref.html # Bad fonts on test boxes
 == wordwrap-04.html wordwrap-04-ref.html
 == wordwrap-05.html wordwrap-05-ref.html
 == wordwrap-06.html wordwrap-06-ref.html
 == wordwrap-07.html wordwrap-07-ref.html
 == zwnj-01.html zwnj-01-ref.html
 == zwnj-02.html zwnj-02-ref.html
 random-if(MOZ_WIDGET_TOOLKIT=="gtk2") != zwnj-01.html zwnj-02-ref.html # Bad fonts on the tinderbox -- works locally
-== cgj-01.html cgj-01-ref.html
+fails-if(MOZ_WIDGET_TOOLKIT=="windows") == cgj-01.html cgj-01-ref.html # bug 455455
 == 444656.html 444656-ref.html
 == 449555-1.html 449555-1-ref.html
diff -r 1aecd2a9914d layout/style/nsCSSDeclaration.cpp
--- a/layout/style/nsCSSDeclaration.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/layout/style/nsCSSDeclaration.cpp	Thu Sep 18 08:03:24 2008 -0500
@@ -465,24 +465,27 @@ nsCSSDeclaration::AppendCSSValueToString
   switch (unit) {
     case eCSSUnit_Null:         break;
     case eCSSUnit_Auto:         aResult.AppendLiteral("auto");     break;
     case eCSSUnit_Inherit:      aResult.AppendLiteral("inherit");  break;
     case eCSSUnit_Initial:      aResult.AppendLiteral("-moz-initial"); break;
     case eCSSUnit_None:         aResult.AppendLiteral("none");     break;
     case eCSSUnit_Normal:       aResult.AppendLiteral("normal");   break;
     case eCSSUnit_System_Font:  aResult.AppendLiteral("-moz-use-system-font"); break;
+    case eCSSUnit_Dummy:        break;
 
     case eCSSUnit_String:       break;
     case eCSSUnit_URL:          break;
     case eCSSUnit_Image:        break;
     case eCSSUnit_Array:        break;
     case eCSSUnit_Attr:
     case eCSSUnit_Counter:
     case eCSSUnit_Counters:     aResult.Append(PRUnichar(')'));    break;
+    case eCSSUnit_Local_Font:   break;
+    case eCSSUnit_Font_Format:  break;
     case eCSSUnit_Function:     break;
     case eCSSUnit_Integer:      break;
     case eCSSUnit_Enumerated:   break;
     case eCSSUnit_EnumColor:    break;
     case eCSSUnit_Color:        break;
     case eCSSUnit_Percent:      aResult.Append(PRUnichar('%'));    break;
     case eCSSUnit_Number:       break;
 
diff -r 1aecd2a9914d layout/style/nsCSSKeywordList.h
--- a/layout/style/nsCSSKeywordList.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/layout/style/nsCSSKeywordList.h	Thu Sep 18 08:03:25 2008 -0500
@@ -134,16 +134,18 @@ CSS_KEY(-moz-mac-accentdarkestshadow, _m
 CSS_KEY(-moz-mac-accentdarkestshadow, _moz_mac_accentdarkestshadow)
 CSS_KEY(-moz-mac-accentdarkshadow, _moz_mac_accentdarkshadow)
 CSS_KEY(-moz-mac-accentface, _moz_mac_accentface)
 CSS_KEY(-moz-mac-accentlightesthighlight, _moz_mac_accentlightesthighlight)
 CSS_KEY(-moz-mac-accentlightshadow, _moz_mac_accentlightshadow)
 CSS_KEY(-moz-mac-accentregularhighlight, _moz_mac_accentregularhighlight)
 CSS_KEY(-moz-mac-accentregularshadow, _moz_mac_accentregularshadow)
 CSS_KEY(-moz-mac-alternateprimaryhighlight, _moz_mac_alternateprimaryhighlight)
+CSS_KEY(-moz-mac-chrome-active, _moz_mac_chrome_active)
+CSS_KEY(-moz-mac-chrome-inactive, _moz_mac_chrome_inactive)
 CSS_KEY(-moz-mac-focusring, _moz_mac_focusring)
 CSS_KEY(-moz-mac-menuselect, _moz_mac_menuselect)
 CSS_KEY(-moz-mac-menushadow, _moz_mac_menushadow)
 CSS_KEY(-moz-mac-menutextdisable, _moz_mac_menutextdisable)
 CSS_KEY(-moz-mac-menutextselect, _moz_mac_menutextselect)
 CSS_KEY(-moz-mac-secondaryhighlight, _moz_mac_secondaryhighlight)
 CSS_KEY(-moz-malayalam, _moz_malayalam)
 CSS_KEY(-moz-marker, _moz_marker) // Disabled because not supported correctly.
@@ -574,16 +576,17 @@ CSS_KEY(radio-label, radiolabel)
 CSS_KEY(radio-label, radiolabel)
 CSS_KEY(button-focus, buttonfocus)
 CSS_KEY(-moz-win-media-toolbox, _moz_win_media_toolbox)
 CSS_KEY(-moz-win-communications-toolbox, _moz_win_communications_toolbox)
 CSS_KEY(-moz-win-browsertabbar-toolbox, _moz_win_browsertabbar_toolbox)
 CSS_KEY(-moz-win-mediatext, _moz_win_mediatext)
 CSS_KEY(-moz-win-communicationstext, _moz_win_communicationstext)
 CSS_KEY(-moz-win-glass, _moz_win_glass)
+CSS_KEY(-moz-mac-unified-toolbar, _moz_mac_unified_toolbar)
 
 #ifdef MOZ_SVG
 //CSS_KEY(all, all)
 CSS_KEY(alphabetic, alphabetic)
 //CSS_KEY(auto, auto)
 CSS_KEY(bevel, bevel)
 CSS_KEY(butt, butt)
 CSS_KEY(central, central)
diff -r 1aecd2a9914d layout/style/nsCSSProps.cpp
--- a/layout/style/nsCSSProps.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/layout/style/nsCSSProps.cpp	Thu Sep 18 08:03:25 2008 -0500
@@ -323,16 +323,17 @@ const PRInt32 nsCSSProps::kAppearanceKTa
   eCSSKeyword_menuseparator,          NS_THEME_MENUSEPARATOR,
   eCSSKeyword_menuarrow,              NS_THEME_MENUARROW,
   eCSSKeyword_menuimage,              NS_THEME_MENUIMAGE,
   eCSSKeyword_menuitemtext,           NS_THEME_MENUITEMTEXT,
   eCSSKeyword__moz_win_media_toolbox, NS_THEME_WIN_MEDIA_TOOLBOX,
   eCSSKeyword__moz_win_communications_toolbox, NS_THEME_WIN_COMMUNICATIONS_TOOLBOX,
   eCSSKeyword__moz_win_browsertabbar_toolbox,  NS_THEME_WIN_BROWSER_TAB_BAR_TOOLBOX,
   eCSSKeyword__moz_win_glass,         NS_THEME_WIN_GLASS,
+  eCSSKeyword__moz_mac_unified_toolbar,        NS_THEME_MOZ_MAC_UNIFIED_TOOLBAR,
   eCSSKeyword_UNKNOWN,-1
 };
 
 // Keyword id tables for variant/enum parsing
 const PRInt32 nsCSSProps::kAzimuthKTable[] = {
   eCSSKeyword_left_side,    NS_STYLE_AZIMUTH_LEFT_SIDE,
   eCSSKeyword_far_left,     NS_STYLE_AZIMUTH_FAR_LEFT,
   eCSSKeyword_left,         NS_STYLE_AZIMUTH_LEFT,
@@ -501,16 +502,18 @@ const PRInt32 nsCSSProps::kColorKTable[]
   eCSSKeyword__moz_field, nsILookAndFeel::eColor__moz_field,
   eCSSKeyword__moz_fieldtext, nsILookAndFeel::eColor__moz_fieldtext,
   eCSSKeyword__moz_dialog, nsILookAndFeel::eColor__moz_dialog,
   eCSSKeyword__moz_dialogtext, nsILookAndFeel::eColor__moz_dialogtext,
   eCSSKeyword__moz_dragtargetzone, nsILookAndFeel::eColor__moz_dragtargetzone,
   eCSSKeyword__moz_hyperlinktext, NS_COLOR_MOZ_HYPERLINKTEXT,
   eCSSKeyword__moz_html_cellhighlight, nsILookAndFeel::eColor__moz_html_cellhighlight,
   eCSSKeyword__moz_html_cellhighlighttext, nsILookAndFeel::eColor__moz_html_cellhighlighttext,
+  eCSSKeyword__moz_mac_chrome_active, nsILookAndFeel::eColor__moz_mac_chrome_active,
+  eCSSKeyword__moz_mac_chrome_inactive, nsILookAndFeel::eColor__moz_mac_chrome_inactive,
   eCSSKeyword__moz_mac_focusring, nsILookAndFeel::eColor__moz_mac_focusring,
   eCSSKeyword__moz_mac_menuselect, nsILookAndFeel::eColor__moz_mac_menuselect,
   eCSSKeyword__moz_mac_menushadow, nsILookAndFeel::eColor__moz_mac_menushadow,
   eCSSKeyword__moz_mac_menutextdisable, nsILookAndFeel::eColor__moz_mac_menutextdisable,
   eCSSKeyword__moz_mac_menutextselect, nsILookAndFeel::eColor__moz_mac_menutextselect,
   eCSSKeyword__moz_mac_accentlightesthighlight, nsILookAndFeel::eColor__moz_mac_accentlightesthighlight,
   eCSSKeyword__moz_mac_accentregularhighlight, nsILookAndFeel::eColor__moz_mac_accentregularhighlight,
   eCSSKeyword__moz_mac_accentface, nsILookAndFeel::eColor__moz_mac_accentface,
diff -r 1aecd2a9914d layout/style/nsCSSRuleProcessor.cpp
--- a/layout/style/nsCSSRuleProcessor.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/layout/style/nsCSSRuleProcessor.cpp	Thu Sep 18 08:03:25 2008 -0500
@@ -785,16 +785,21 @@ InitSystemMetrics()
   lookAndFeel->GetMetric(nsILookAndFeel::eMetric_ImagesInMenus, metricResult);
   if (metricResult) {
     sSystemMetrics->AppendElement(do_GetAtom("images-in-menus"));
   }
 
   rv = lookAndFeel->GetMetric(nsILookAndFeel::eMetric_WindowsDefaultTheme, metricResult);
   if (NS_SUCCEEDED(rv) && metricResult) {
     sSystemMetrics->AppendElement(do_GetAtom("windows-default-theme"));
+  }
+
+  rv = lookAndFeel->GetMetric(nsILookAndFeel::eMetric_MacGraphiteTheme, metricResult);
+  if (NS_SUCCEEDED(rv) && metricResult) {
+    sSystemMetrics->AppendElement(do_GetAtom("mac-graphite-theme"));
   }
 
   rv = lookAndFeel->GetMetric(nsILookAndFeel::eMetric_DWMCompositor, metricResult);
   if (NS_SUCCEEDED(rv) && metricResult) {
     sSystemMetrics->AppendElement(do_GetAtom("windows-compositor"));
   }
 
   rv = lookAndFeel->GetMetric(nsILookAndFeel::eMetric_WindowsClassic, metricResult);
diff -r 1aecd2a9914d layout/style/nsRuleNode.cpp
--- a/layout/style/nsRuleNode.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/layout/style/nsRuleNode.cpp	Thu Sep 18 08:03:25 2008 -0500
@@ -1896,16 +1896,22 @@ nsRuleNode::SetDefaultOnRoot(const nsSty
     {
       nsStyleSVGReset* svgReset = new (mPresContext) nsStyleSVGReset();
       if (NS_LIKELY(svgReset != nsnull)) {
         aContext->SetStyle(eStyleStruct_SVGReset, svgReset);
       }
       return svgReset;
     }
 #endif
+    default:
+      /*
+       * unhandled case: nsStyleStructID_Length.
+       * last item of nsStyleStructID, to know its length.
+       */
+      return nsnull;
   }
   return nsnull;
 }
 
 /*
  * This function handles cascading of *-left or *-right box properties
  * against *-start (which is L for LTR and R for RTL) or *-end (which is
  * R for LTR and L for RTL).
diff -r 1aecd2a9914d layout/svg/base/src/nsSVGEffects.cpp
--- a/layout/svg/base/src/nsSVGEffects.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/layout/svg/base/src/nsSVGEffects.cpp	Thu Sep 18 08:03:25 2008 -0500
@@ -123,16 +123,17 @@ nsSVGFilterProperty::nsSVGFilterProperty
 }
 
 void
 nsSVGFilterProperty::UpdateRect()
 {
   nsSVGFilterFrame *filter = GetFilterFrame(nsnull);
   if (filter) {
     mFilterRect = filter->GetFilterBBox(mFrame, nsnull);
+    mFilterRect.ScaleRoundOut(filter->PresContext()->AppUnitsPerDevPixel());
   } else {
     mFilterRect = nsRect();
   }
 }
 
 void
 nsSVGFilterProperty::DoUpdate()
 {
diff -r 1aecd2a9914d layout/svg/base/src/nsSVGUtils.cpp
--- a/layout/svg/base/src/nsSVGUtils.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/layout/svg/base/src/nsSVGUtils.cpp	Thu Sep 18 08:03:25 2008 -0500
@@ -579,32 +579,35 @@ nsSVGUtils::GetBBox(nsFrameList *aFrames
   }
 
   return NS_ERROR_FAILURE;
 }
 
 nsRect
 nsSVGUtils::FindFilterInvalidation(nsIFrame *aFrame, const nsRect& aRect)
 {
+  PRInt32 appUnitsPerDevPixel = aFrame->PresContext()->AppUnitsPerDevPixel();
   nsRect rect = aRect;
+  rect.ScaleRoundOutInverse(appUnitsPerDevPixel);
 
   while (aFrame) {
     if (aFrame->GetStateBits() & NS_STATE_IS_OUTER_SVG)
       break;
 
     nsSVGFilterProperty *property = nsSVGEffects::GetFilterProperty(aFrame);
     if (property) {
       nsSVGFilterFrame *filter = property->GetFilterFrame(nsnull);
       if (filter) {
         rect = filter->GetInvalidationBBox(aFrame, rect);
       }
     }
     aFrame = aFrame->GetParent();
   }
 
+  rect.ScaleRoundOut(appUnitsPerDevPixel);
   return rect;
 }
 
 void
 nsSVGUtils::UpdateFilterRegion(nsIFrame *aFrame)
 {
   nsSVGEffects::EffectProperties props =
     nsSVGEffects::GetEffectProperties(aFrame);
diff -r 1aecd2a9914d layout/svg/base/src/nsSVGUtils.h
--- a/layout/svg/base/src/nsSVGUtils.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/layout/svg/base/src/nsSVGUtils.h	Thu Sep 18 08:03:25 2008 -0500
@@ -264,18 +264,18 @@ public:
   /*
    * Creates a bounding box by walking the children and doing union.
    */
   static nsresult GetBBox(nsFrameList *aFrames, nsIDOMSVGRect **_retval);
 
   /**
    * Figures out the worst case invalidation area for a frame, taking
    * filters into account.
-   * @param aRect the area in device pixels that needs to be invalidated in aFrame
-   * @return the rect in device pixels that should be invalidated, taking
+   * @param aRect the area in app units that needs to be invalidated in aFrame
+   * @return the rect in app units that should be invalidated, taking
    * filters into account. Will return aRect when no filters are present.
    */
   static nsRect FindFilterInvalidation(nsIFrame *aFrame, const nsRect& aRect);
 
   /*
    * Update the filter invalidation region for this frame, if relevant.
    */
   static void UpdateFilterRegion(nsIFrame *aFrame);
diff -r 1aecd2a9914d layout/xul/base/src/nsPopupBoxObject.cpp
--- a/layout/xul/base/src/nsPopupBoxObject.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/layout/xul/base/src/nsPopupBoxObject.cpp	Thu Sep 18 08:03:25 2008 -0500
@@ -227,32 +227,36 @@ nsPopupBoxObject::EnableKeyboardNavigato
                       NS_LITERAL_STRING("true"), PR_TRUE);
 
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsPopupBoxObject::GetPopupState(nsAString& aState)
 {
-  aState.AssignLiteral("closed");
-
   nsMenuPopupFrame *menuPopupFrame = GetMenuPopupFrame();
   if (menuPopupFrame) {
     switch (menuPopupFrame->PopupState()) {
       case ePopupShowing:
       case ePopupOpen:
         aState.AssignLiteral("showing");
         break;
       case ePopupOpenAndVisible:
         aState.AssignLiteral("open");
         break;
       case ePopupHiding:
       case ePopupInvisible:
         aState.AssignLiteral("hiding");
         break;
+      case ePopupClosed:
+        aState.AssignLiteral("closed");
+        break;
+      default:
+        NS_NOTREACHED("Bad popup state");
+        break;
     }
   }
 
   return NS_OK;
 }
 
 
 // Creation Routine ///////////////////////////////////////////////////////////////////////
diff -r 1aecd2a9914d layout/xul/base/src/nsSplitterFrame.cpp
--- a/layout/xul/base/src/nsSplitterFrame.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/layout/xul/base/src/nsSplitterFrame.cpp	Thu Sep 18 08:03:25 2008 -0500
@@ -521,16 +521,18 @@ nsSplitterFrameInner::MouseUp(nsPresCont
 
     //printf("MouseUp\n");
   }
 
   delete[] mChildInfosBefore;
   delete[] mChildInfosAfter;
   mChildInfosBefore = nsnull;
   mChildInfosAfter = nsnull;
+  mChildInfosBeforeCount = 0;
+  mChildInfosAfterCount = 0;
 }
 
 void
 nsSplitterFrameInner::MouseDrag(nsPresContext* aPresContext, nsGUIEvent* aEvent)
 {
   if (mDragging && mOuter) {
 
     //printf("Dragging\n");
diff -r 1aecd2a9914d modules/libpref/src/init/all.js
--- a/modules/libpref/src/init/all.js	Tue Sep 16 16:40:57 2008 +1200
+++ b/modules/libpref/src/init/all.js	Thu Sep 18 08:03:25 2008 -0500
@@ -896,16 +896,19 @@ pref("middlemouse.scrollbarPosition", fa
 
 // Clipboard behavior
 pref("clipboard.autocopy", false);
 
 // mouse wheel scroll transaction period of time (in milliseconds)
 pref("mousewheel.transaction.timeout", 1500);
 // mouse wheel scroll transaction is held even if the mouse cursor is moved.
 pref("mousewheel.transaction.ignoremovedelay", 100);
+
+// Macbook touchpad two finger pixel scrolling
+pref("mousewheel.enable_pixel_scrolling", true);
 
 // 0=lines, 1=pages, 2=history , 3=text size
 pref("mousewheel.withnokey.action",0);
 pref("mousewheel.withnokey.numlines",1);	
 pref("mousewheel.withnokey.sysnumlines",true);
 pref("mousewheel.withcontrolkey.action",0);
 pref("mousewheel.withcontrolkey.numlines",1);
 pref("mousewheel.withcontrolkey.sysnumlines",true);
@@ -2260,17 +2263,17 @@ pref("autocomplete.grab_during_popup", t
 pref("autocomplete.grab_during_popup", true);
 pref("autocomplete.ungrab_during_mode_switch", true);
 
 // Default to using the system filepicker if possible, but allow
 // toggling to use the XUL filepicker
 pref("ui.allow_platform_file_picker", true);
 
 // should NetworkManager be authoritative for online/offline status?
-pref("toolkit.networkmanager.disable", false);
+pref("toolkit.networkmanager.disable", true);
 
 pref("helpers.global_mime_types_file", "/etc/mime.types");
 pref("helpers.global_mailcap_file", "/etc/mailcap");
 pref("helpers.private_mime_types_file", "~/.mime.types");
 pref("helpers.private_mailcap_file", "~/.mailcap");
 pref("java.global_java_version_file", "/etc/.java/versions");
 pref("java.private_java_version_file", "~/.java/versions");
 pref("java.default_java_location_solaris", "/usr/j2se");
diff -r 1aecd2a9914d modules/plugin/default/os2/npos2.cpp
--- a/modules/plugin/default/os2/npos2.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/modules/plugin/default/os2/npos2.cpp	Thu Sep 18 08:03:25 2008 -0500
@@ -49,277 +49,294 @@
 //\\// DEFINE
 #define NP_EXPORT
 
 //\\// GLOBAL DATA
 NPNetscapeFuncs* g_pNavigatorFuncs = 0;
 
 //\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\.
 ////\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//.
-//						PLUGIN DLL entry points   
+//                        PLUGIN DLL entry points
 //
 // These are the Windows specific DLL entry points. They must be exoprted
 //
 
 // we need these to be global since we have to fill one of its field
 // with a data (class) which requires knowlwdge of the navigator
 // jump-table. This jump table is known at Initialize time (NP_Initialize)
 // which is called after NP_GetEntryPoint
 static NPPluginFuncs* g_pluginFuncs;
 
 //\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\.
 ////\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//.
 // NP_GetEntryPoints
 //
-//	fills in the func table used by Navigator to call entry points in
-//  plugin DLL.  Note that these entry points ensure that DS is loaded
-//  by using the NP_LOADDS macro, when compiling for Win16
+//    fills in the func table used by Navigator to call entry points in
+//    plugin DLL.  Note that these entry points ensure that DS is loaded
+//    by using the NP_LOADDS macro, when compiling for Win16
 //
 NPError OSCALL NP_EXPORT
 NP_GetEntryPoints(NPPluginFuncs* pFuncs)
 {
-    // trap a NULL ptr 
+    // trap a NULL ptr
     if(pFuncs == NULL)
         return NPERR_INVALID_FUNCTABLE_ERROR;
 
     // if the plugin's function table is smaller than the plugin expects,
-    // then they are incompatible, and should return an error 
+    // then they are incompatible, and should return an error
 
     pFuncs->version       = (NP_VERSION_MAJOR << 8) | NP_VERSION_MINOR;
     pFuncs->newp          = NPP_New;
     pFuncs->destroy       = NPP_Destroy;
     pFuncs->setwindow     = NPP_SetWindow;
     pFuncs->newstream     = NPP_NewStream;
     pFuncs->destroystream = NPP_DestroyStream;
     pFuncs->asfile        = NPP_StreamAsFile;
     pFuncs->writeready    = NPP_WriteReady;
     pFuncs->write         = NPP_Write;
     pFuncs->print         = NPP_Print;
-    pFuncs->event         = 0;       /// reserved 
+    pFuncs->event         = 0;       /// reserved
 
-	g_pluginFuncs		  = pFuncs;
+    g_pluginFuncs         = pFuncs;
 
     return NPERR_NO_ERROR;
 }
 
 //\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\.
 ////\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//.
 // NP_Initialize
 //
-//	called immediately after the plugin DLL is loaded
+//    called immediately after the plugin DLL is loaded
 //
-NPError OSCALL NP_EXPORT 
+NPError OSCALL NP_EXPORT
 NP_Initialize(NPNetscapeFuncs* pFuncs)
 {
-    // trap a NULL ptr 
+    // trap a NULL ptr
     if(pFuncs == NULL)
         return NPERR_INVALID_FUNCTABLE_ERROR;
 
-    g_pNavigatorFuncs = pFuncs; // save it for future reference 
+    g_pNavigatorFuncs = pFuncs; // save it for future reference
 
     // if the plugin's major ver level is lower than the Navigator's,
-    // then they are incompatible, and should return an error 
+    // then they are incompatible, and should return an error
     if(HIBYTE(pFuncs->version) > NP_VERSION_MAJOR)
         return NPERR_INCOMPATIBLE_VERSION_ERROR;
 
-	// We have to defer these assignments until g_pNavigatorFuncs is set
+    // We have to defer these assignments until g_pNavigatorFuncs is set
     int navMinorVers = g_pNavigatorFuncs->version & 0xFF;
 
-	if( navMinorVers >= NPVERS_HAS_NOTIFICATION ) {
-		g_pluginFuncs->urlnotify = NPP_URLNotify;
-	}
-	if( navMinorVers >= NPVERS_HAS_LIVECONNECT ) {
-		g_pluginFuncs->javaClass = NULL;
-	}
-	// NPP_Initialize is a standard (cross-platform) initialize function.
+    if( navMinorVers >= NPVERS_HAS_NOTIFICATION ) {
+        g_pluginFuncs->urlnotify = NPP_URLNotify;
+    }
+    if( navMinorVers >= NPVERS_HAS_LIVECONNECT ) {
+        g_pluginFuncs->javaClass = NULL;
+    }
+    // NPP_Initialize is a standard (cross-platform) initialize function.
     return NPP_Initialize();
 }
 
 //\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\.
 ////\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//.
 // NP_Shutdown
 //
-//	called immediately before the plugin DLL is unloaded.
-//	This function should check for some ref count on the dll to see if it is
-//	unloadable or it needs to stay in memory. 
+//    called immediately before the plugin DLL is unloaded.
+//    This function should check for some ref count on the dll to see if it is
+//    unloadable or it needs to stay in memory.
 //
-NPError OSCALL NP_EXPORT 
+NPError OSCALL NP_EXPORT
 NP_Shutdown()
 {
     NPP_Shutdown();
     g_pNavigatorFuncs = NULL;
     return NPERR_NO_ERROR;
 }
 
-char * NP_GetMIMEDescription()
+char*
+NP_GetMIMEDescription()
 {
     static char mimetype[] = NS_PLUGIN_DEFAULT_MIME_DESCRIPTION;
     return mimetype;
 }
 
-//						END - PLUGIN DLL entry points   
+//                        END - PLUGIN DLL entry points
 ////\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//.
 //\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\//\\.
 
-/*    NAVIGATOR Entry points    */
+/* NAVIGATOR Entry points */
 
 /* These entry points expect to be called from within the plugin.  The
    noteworthy assumption is that DS has already been set to point to the
    plugin's DLL data segment.  Don't call these functions from outside
    the plugin without ensuring DS is set to the DLLs data segment first,
    typically using the NP_LOADDS macro
 */
 
 /* returns the major/minor version numbers of the Plugin API for the plugin
    and the Navigator
 */
-void NPN_Version(int* plugin_major, int* plugin_minor, int* netscape_major, int* netscape_minor)
+void
+NPN_Version(int* plugin_major, int* plugin_minor, int* netscape_major,
+            int* netscape_minor)
 {
     *plugin_major   = NP_VERSION_MAJOR;
     *plugin_minor   = NP_VERSION_MINOR;
     *netscape_major = HIBYTE(g_pNavigatorFuncs->version);
     *netscape_minor = LOBYTE(g_pNavigatorFuncs->version);
 }
 
-NPError NPN_GetValue(NPP instance, NPNVariable variable, void *result)
+NPError
+NPN_GetValue(NPP instance, NPNVariable variable, void *result)
 {
     return g_pNavigatorFuncs->getvalue(instance, variable, result);
 }
 
 
 /* causes the specified URL to be fetched and streamed in
 */
-NPError NPN_GetURLNotify(NPP instance, const char *url, const char *target, void* notifyData)
-
+NPError
+NPN_GetURLNotify(NPP instance, const char *url, const char *target,
+                 void* notifyData)
 {
-	int navMinorVers = g_pNavigatorFuncs->version & 0xFF;
-	NPError err;
-	if( navMinorVers >= NPVERS_HAS_NOTIFICATION ) {
-		err = g_pNavigatorFuncs->geturlnotify(instance, url, target, notifyData);
-	}
-	else {
-		err = NPERR_INCOMPATIBLE_VERSION_ERROR;
-	}
-	return err;
+    int navMinorVers = g_pNavigatorFuncs->version & 0xFF;
+    NPError err;
+    if( navMinorVers >= NPVERS_HAS_NOTIFICATION ) {
+        err = g_pNavigatorFuncs->geturlnotify(instance, url, target, notifyData);
+    }
+    else {
+        err = NPERR_INCOMPATIBLE_VERSION_ERROR;
+    }
+    return err;
 }
 
 
-NPError NPN_GetURL(NPP instance, const char *url, const char *target)
+NPError
+NPN_GetURL(NPP instance, const char *url, const char *target)
 {
     return g_pNavigatorFuncs->geturl(instance, url, target);
 }
 
-NPError NPN_PostURLNotify(NPP instance, const char* url, const char* window, uint32 len, const char* buf, NPBool file, void* notifyData)
+NPError
+NPN_PostURLNotify(NPP instance, const char* url, const char* window,
+                  uint32_t len, const char* buf, NPBool file, void* notifyData)
 {
-	int navMinorVers = g_pNavigatorFuncs->version & 0xFF;
-	NPError err;
-	if( navMinorVers >= NPVERS_HAS_NOTIFICATION ) {
-		err = g_pNavigatorFuncs->posturlnotify(instance, url, window, len, buf, file, notifyData);
-	}
-	else {
-		err = NPERR_INCOMPATIBLE_VERSION_ERROR;
-	}
-	return err;
+    int navMinorVers = g_pNavigatorFuncs->version & 0xFF;
+    NPError err;
+    if( navMinorVers >= NPVERS_HAS_NOTIFICATION ) {
+        err = g_pNavigatorFuncs->posturlnotify(instance, url, window, len, buf, file, notifyData);
+    }
+    else {
+        err = NPERR_INCOMPATIBLE_VERSION_ERROR;
+    }
+    return err;
 }
 
 
-NPError NPN_PostURL(NPP instance, const char* url, const char* window, uint32 len, const char* buf, NPBool file)
+NPError
+NPN_PostURL(NPP instance, const char* url, const char* window, uint32_t len,
+            const char* buf, NPBool file)
 {
     return g_pNavigatorFuncs->posturl(instance, url, window, len, buf, file);
 }
 
 /* Requests that a number of bytes be provided on a stream.  Typically
    this would be used if a stream was in "pull" mode.  An optional
    position can be provided for streams which are seekable.
 */
-NPError NPN_RequestRead(NPStream* stream, NPByteRange* rangeList)
+NPError
+NPN_RequestRead(NPStream* stream, NPByteRange* rangeList)
 {
     return g_pNavigatorFuncs->requestread(stream, rangeList);
 }
 
 /* Creates a new stream of data from the plug-in to be interpreted
    by Netscape in the current window.
 */
-NPError NPN_NewStream(NPP instance, NPMIMEType type, 
-								const char* target, NPStream** stream)
+NPError
+NPN_NewStream(NPP instance, NPMIMEType type, const char* target,
+              NPStream** stream)
 {
-	int navMinorVersion = g_pNavigatorFuncs->version & 0xFF;
-	NPError err;
+    int navMinorVersion = g_pNavigatorFuncs->version & 0xFF;
+    NPError err;
 
-	if( navMinorVersion >= NPVERS_HAS_STREAMOUTPUT ) {
-		err = g_pNavigatorFuncs->newstream(instance, type, target, stream);
-	}
-	else {
-		err = NPERR_INCOMPATIBLE_VERSION_ERROR;
-	}
-	return err;
+    if( navMinorVersion >= NPVERS_HAS_STREAMOUTPUT ) {
+        err = g_pNavigatorFuncs->newstream(instance, type, target, stream);
+    }
+    else {
+        err = NPERR_INCOMPATIBLE_VERSION_ERROR;
+    }
+    return err;
 }
 
 /* Provides len bytes of data.
 */
-int32 NPN_Write(NPP instance, NPStream *stream,
-                int32 len, void *buffer)
+int32_t
+NPN_Write(NPP instance, NPStream *stream, int32_t len, void *buffer)
 {
-	int navMinorVersion = g_pNavigatorFuncs->version & 0xFF;
-	int32 result;
+    int navMinorVersion = g_pNavigatorFuncs->version & 0xFF;
+    int32_t result;
 
-	if( navMinorVersion >= NPVERS_HAS_STREAMOUTPUT ) {
-		result = g_pNavigatorFuncs->write(instance, stream, len, buffer);
-	}
-	else {
-		result = -1;
-	}
-	return result;
+    if( navMinorVersion >= NPVERS_HAS_STREAMOUTPUT ) {
+        result = g_pNavigatorFuncs->write(instance, stream, len, buffer);
+    }
+    else {
+        result = -1;
+    }
+    return result;
 }
 
-/* Closes a stream object.  
-reason indicates why the stream was closed.
+/* Closes a stream object.
+   reason indicates why the stream was closed.
 */
-NPError NPN_DestroyStream(NPP instance, NPStream* stream, NPError reason)
+NPError
+NPN_DestroyStream(NPP instance, NPStream* stream, NPError reason)
 {
-	int navMinorVersion = g_pNavigatorFuncs->version & 0xFF;
-	NPError err;
+    int navMinorVersion = g_pNavigatorFuncs->version & 0xFF;
+    NPError err;
 
-	if( navMinorVersion >= NPVERS_HAS_STREAMOUTPUT ) {
-		err = g_pNavigatorFuncs->destroystream(instance, stream, reason);
-	}
-	else {
-		err = NPERR_INCOMPATIBLE_VERSION_ERROR;
-	}
-	return err;
+    if( navMinorVersion >= NPVERS_HAS_STREAMOUTPUT ) {
+        err = g_pNavigatorFuncs->destroystream(instance, stream, reason);
+    }
+    else {
+        err = NPERR_INCOMPATIBLE_VERSION_ERROR;
+    }
+    return err;
 }
 
 /* Provides a text status message in the Netscape client user interface
 */
-void NPN_Status(NPP instance, const char *message)
+void
+NPN_Status(NPP instance, const char *message)
 {
     g_pNavigatorFuncs->status(instance, message);
 }
 
 /* returns the user agent string of Navigator, which contains version info
 */
-const char* NPN_UserAgent(NPP instance)
+const char*
+NPN_UserAgent(NPP instance)
 {
     return g_pNavigatorFuncs->uagent(instance);
 }
 
 /* allocates memory from the Navigator's memory space.  Necessary so that
    saved instance data may be freed by Navigator when exiting.
 */
-
-
-void* NPN_MemAlloc(uint32 size)
+void*
+NPN_MemAlloc(uint32_t size)
 {
     return g_pNavigatorFuncs->memalloc(size);
 }
 
 /* reciprocal of MemAlloc() above
 */
-void NPN_MemFree(void* ptr)
+void
+NPN_MemFree(void* ptr)
 {
     g_pNavigatorFuncs->memfree(ptr);
 }
+
 /* private function to Netscape.  do not use!
 */
-void NPN_ReloadPlugins(NPBool reloadPages)
+void
+NPN_ReloadPlugins(NPBool reloadPages)
 {
     g_pNavigatorFuncs->reloadplugins(reloadPages);
 }
diff -r 1aecd2a9914d modules/plugin/default/os2/npshell.cpp
--- a/modules/plugin/default/os2/npshell.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/modules/plugin/default/os2/npshell.cpp	Thu Sep 18 08:03:25 2008 -0500
@@ -238,17 +238,17 @@ NPP_NewStream(NPP pInstance,
     return NPERR_GENERIC_ERROR;
 
   return pPlugin->newStream(type, stream, seekable, stype);
 }
 
 //------------------------------------------------------------------------------------
 // NPP_WriteReady:
 //------------------------------------------------------------------------------------
-int32 NP_LOADDS
+int32_t NP_LOADDS
 NPP_WriteReady(NPP pInstance, NPStream *stream)
 {
   dbgOut1("NPP_WriteReady");
   if(pInstance == NULL)
     return NPERR_INVALID_INSTANCE_ERROR;
 
   CPlugin * pPlugin = (CPlugin *)pInstance->pdata;
   assert(pPlugin != NULL);
@@ -257,18 +257,19 @@ NPP_WriteReady(NPP pInstance, NPStream *
   NPN_DestroyStream(pInstance, stream, NPRES_DONE);
 
   return -1L;   // don't accept any bytes in NPP_Write()
 }
 
 //------------------------------------------------------------------------------------
 // NPP_Write:
 //------------------------------------------------------------------------------------
-int32 NP_LOADDS
-NPP_Write(NPP pInstance, NPStream *stream, int32 offset, int32 len, void *buffer)
+int32_t NP_LOADDS
+NPP_Write(NPP pInstance, NPStream *stream, int32_t offset, int32_t len,
+          void *buffer)
 {
   //dbgOut1("NPP_Write");
   if(pInstance == NULL)
     return NPERR_INVALID_INSTANCE_ERROR;
 
   CPlugin * pPlugin = (CPlugin *)pInstance->pdata;
   assert(pPlugin != NULL);
 
diff -r 1aecd2a9914d netwerk/cookie/src/nsCookieService.cpp
--- a/netwerk/cookie/src/nsCookieService.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/netwerk/cookie/src/nsCookieService.cpp	Thu Sep 18 08:03:25 2008 -0500
@@ -2044,20 +2044,26 @@ NS_IMETHODIMP
 NS_IMETHODIMP
 nsCookieService::CookieExists(nsICookie2 *aCookie,
                               PRBool     *aFoundCookie)
 {
   NS_ENSURE_ARG_POINTER(aCookie);
 
   // just a placeholder
   nsListIter iter;
-  nsCookie *cookie = static_cast<nsCookie*>(aCookie);
+  nsCAutoString host, name, path;
+  nsresult rv = aCookie->GetHost(host);
+  NS_ENSURE_SUCCESS(rv, rv);
+  rv = aCookie->GetName(name);
+  NS_ENSURE_SUCCESS(rv, rv);
+  rv = aCookie->GetPath(path);
+  NS_ENSURE_SUCCESS(rv, rv);
 
-  *aFoundCookie = FindCookie(cookie->Host(), cookie->Name(), cookie->Path(),
-                             iter, PR_Now() / PR_USEC_PER_SEC);
+  *aFoundCookie = FindCookie(host, name, path, iter,
+                             PR_Now() / PR_USEC_PER_SEC);
   return NS_OK;
 }
 
 // count the number of cookies from a given host, and simultaneously find the
 // oldest cookie from the host.
 PRUint32
 nsCookieService::CountCookiesFromHostInternal(const nsACString  &aHost,
                                               nsEnumerationData &aData)
diff -r 1aecd2a9914d security/manager/Makefile.in
--- a/security/manager/Makefile.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/security/manager/Makefile.in	Thu Sep 18 08:03:25 2008 -0500
@@ -234,16 +234,17 @@ DEFAULT_GMAKE_FLAGS += \
 	CC="$(CC)" \
 	CCC="$(CXX)" \
 	LINK="$(LD)" \
 	AS="$(AS)" \
 	AR='$(AR) $(AR_FLAGS:$@=$$@)' \
 	RANLIB="$(RANLIB)" \
 	RC="$(RC) $(RCFLAGS)" \
 	OS_ARCH="$(OS_ARCH)" \
+	OS_TEST="$(OS_TEST)" \
 	CPU_ARCH="$(TARGET_CPU)" \
 	$(NULL)
 SKIP_CHK=1
 endif
 SUBMAKEFILES = boot/Makefile ssl/Makefile pki/Makefile locales/Makefile
 
 include $(topsrcdir)/config/rules.mk
 
diff -r 1aecd2a9914d testing/mochitest/static/test.template.txt
--- a/testing/mochitest/static/test.template.txt	Tue Sep 16 16:40:57 2008 +1200
+++ b/testing/mochitest/static/test.template.txt	Thu Sep 18 08:03:25 2008 -0500
@@ -1,31 +1,30 @@
 <!DOCTYPE HTML>
 <html>
 <!--
 https://bugzilla.mozilla.org/show_bug.cgi?id={BUGNUMBER}
 -->
 <head>
   <title>Test for Bug {BUGNUMBER}</title>
-  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
-  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
-  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+  <script type="application/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css"/>
 </head>
 <body>
 <a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id={BUGNUMBER}">Mozilla Bug {BUGNUMBER}</a>
 <p id="display"></p>
 <div id="content" style="display: none">
   
 </div>
 <pre id="test">
-<script class="testbody" type="text/javascript">
+<script type="application/javascript">
 
 /** Test for Bug {BUGNUMBER} **/
 
 
 
 
 
 </script>
 </pre>
 </body>
 </html>
-
diff -r 1aecd2a9914d testing/mochitest/static/xhtml.template.txt
--- a/testing/mochitest/static/xhtml.template.txt	Tue Sep 16 16:40:57 2008 +1200
+++ b/testing/mochitest/static/xhtml.template.txt	Thu Sep 18 08:03:25 2008 -0500
@@ -1,31 +1,30 @@
 <html xmlns="http://www.w3.org/1999/xhtml">
 <!--
 https://bugzilla.mozilla.org/show_bug.cgi?id={BUGNUMBER}
 -->
 <head>
   <title>Test for Bug {BUGNUMBER}</title>
-  <script type="text/javascript" src="/MochiKit/packed.js"></script>
-  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
-  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+  <script type="application/javascript" src="/MochiKit/packed.js"></script>
+  <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css"/>
 </head>
 <body>
 <a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id={BUGNUMBER}">Mozilla Bug {BUGNUMBER}</a>
 <p id="display"></p>
 <div id="content" style="display: none">
   
 </div>
 <pre id="test">
-<script class="testbody" type="text/javascript">
+<script type="application/javascript">
 <![CDATA[
 
 /** Test for Bug {BUGNUMBER} **/
 
 
 
 
 ]]>
 </script>
 </pre>
 </body>
 </html>
-
diff -r 1aecd2a9914d testing/mochitest/static/xul.template.txt
--- a/testing/mochitest/static/xul.template.txt	Tue Sep 16 16:40:57 2008 +1200
+++ b/testing/mochitest/static/xul.template.txt	Thu Sep 18 08:03:25 2008 -0500
@@ -1,26 +1,28 @@
 <?xml version="1.0"?>
-<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
-<?xml-stylesheet href="/tests/SimpleTest/test.css" type="text/css"?>
+<?xml-stylesheet type="text/css" href="chrome://global/skin"?>
+<?xml-stylesheet type="text/css" href="/tests/SimpleTest/test.css"?>
 <!--
 https://bugzilla.mozilla.org/show_bug.cgi?id={BUGNUMBER}
 -->
 <window title="Mozilla Bug {BUGNUMBER}"
-  xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
-  <script type="application/javascript" src="/MochiKit/packed.js" />
+        xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
+  <script type="application/javascript" src="/MochiKit/packed.js"/>
   <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"/>
 
   <!-- test results are displayed in the html:body -->
   <body xmlns="http://www.w3.org/1999/xhtml">
   <a href="https://bugzilla.mozilla.org/show_bug.cgi?id={BUGNUMBER}"
      target="_blank">Mozilla Bug {BUGNUMBER}</a>
   </body>
 
   <!-- test code goes here -->
-  <script type="application/javascript"><![CDATA[
+  <script type="application/javascript">
+  <![CDATA[
 
-    /** Test for Bug {BUGNUMBER} **/
+  /** Test for Bug {BUGNUMBER} **/
 
 
 
-  ]]></script>
+  ]]>
+  </script>
 </window>
diff -r 1aecd2a9914d testing/mochitest/tests/SimpleTest/EventUtils.js
--- a/testing/mochitest/tests/SimpleTest/EventUtils.js	Tue Sep 16 16:40:57 2008 +1200
+++ b/testing/mochitest/tests/SimpleTest/EventUtils.js	Thu Sep 18 08:03:25 2008 -0500
@@ -225,57 +225,57 @@ function synthesizeMouse(aTarget, aOffse
 }
 
 /**
  * Synthesize a mouse scroll event on a target. The actual client point is determined
  * by taking the aTarget's client box and offseting it by aOffsetX and
  * aOffsetY.
  *
  * aEvent is an object which may contain the properties:
- *   shiftKey, ctrlKey, altKey, metaKey, accessKey, button, type, axis, units, delta
+ *   shiftKey, ctrlKey, altKey, metaKey, accessKey, button, type, axis, delta, hasPixels
  *
- * If the type is specified, an mouse scroll event of that type is fired. Otherwise,
+ * If the type is specified, a mouse scroll event of that type is fired. Otherwise,
  * "DOMMouseScroll" is used.
  *
  * If the axis is specified, it must be one of "horizontal" or "vertical". If not specified,
  * "vertical" is used.
  * 
  * 'delta' is the amount to scroll by (can be positive or negative). It must
- * be specified. 'units' is the units of 'delta', either "pixels" or "lines"; "lines"
- * is the default if 'units' is ommitted.
+ * be specified.
+ *
+ * 'hasPixels' specifies whether kHasPixels should be set in the scrollFlags.
  *
  * aWindow is optional, and defaults to the current window object.
  */
 function synthesizeMouseScroll(aTarget, aOffsetX, aOffsetY, aEvent, aWindow)
 {
   netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
 
   if (!aWindow)
     aWindow = window;
 
   var utils = aWindow.QueryInterface(Components.interfaces.nsIInterfaceRequestor).
                       getInterface(Components.interfaces.nsIDOMWindowUtils);
   if (utils) {
     // See nsMouseScrollFlags in nsGUIEvent.h
     const kIsVertical = 0x02;
     const kIsHorizontal = 0x04;
-    const kIsPixels = 0x08;
+    const kHasPixels = 0x08;
 
     var button = aEvent.button || 0;
     var modifiers = _parseModifiers(aEvent);
 
     var left = aTarget.boxObject.x;
     var top = aTarget.boxObject.y;
 
     var type = aEvent.type || "DOMMouseScroll";
     var axis = aEvent.axis || "vertical";
-    var units = aEvent.units || "lines";
     var scrollFlags = (axis == "horizontal") ? kIsHorizontal : kIsVertical;
-    if (units == "pixels") {
-      scrollFlags |= kIsPixels;
+    if (aEvent.hasPixels) {
+      scrollFlags |= kHasPixels;
     }
     utils.sendMouseScrollEvent(type, left + aOffsetX, top + aOffsetY, button,
                                scrollFlags, aEvent.delta, modifiers);
   }
 }
 
 /**
  * Synthesize a key event. It is targeted at whatever would be targeted by an
diff -r 1aecd2a9914d toolkit/components/help/content/help.xul
--- a/toolkit/components/help/content/help.xul	Tue Sep 16 16:40:57 2008 +1200
+++ b/toolkit/components/help/content/help.xul	Thu Sep 18 08:03:25 2008 -0500
@@ -193,17 +193,17 @@
     <hbox flex="1">
       <vbox id="help-sidebar" persist="width">
         <vbox flex="1" id="help-toc-sidebar">
           <sidebarheader align="center">
             <label id="help-toc-sidebar-header" flex="1" crop="end" value="&toctab.label;"
                    accesskey="&toctab.accesskey;" control="help-toc-panel"/>
           </sidebarheader>
           <tree id="help-toc-panel" class="focusring"
-                flex="1"  hidecolumnpicker="true"
+                flex="1" treelines="true" hidecolumnpicker="true"
                 datasources="rdf:null"
                 containment="http://home.netscape.com/NC-rdf#subheadings"
                 ref="urn:root" flags="dont-build-content"
                 onselect="onselect_loadURI(this)">
             <template>
               <rule>
                 <conditions>
                   <content uri="?uri"/>
diff -r 1aecd2a9914d toolkit/components/url-classifier/content/url-crypto-key-manager.js
--- a/toolkit/components/url-classifier/content/url-crypto-key-manager.js	Tue Sep 16 16:40:57 2008 +1200
+++ b/toolkit/components/url-classifier/content/url-crypto-key-manager.js	Thu Sep 18 08:03:25 2008 -0500
@@ -255,17 +255,17 @@ PROT_UrlCryptoKeyManager.prototype.dropK
  * @returns Boolean indicating if we have a key we can use 
  */
 PROT_UrlCryptoKeyManager.prototype.hasKey = function() {
   return this.clientKey_ != null && this.wrappedKey_ != null;
 }
 
 PROT_UrlCryptoKeyManager.prototype.unUrlSafe = function(key)
 {
-    return key.replace("-", "+").replace("_", "/");
+    return key ? key.replace("-", "+").replace("_", "/") : "";
 }
 
 /**
  * Set a new key and serialize it to disk.
  *
  * @param clientKey String containing the base64-encoded client key 
  *                  we wish to use
  *
diff -r 1aecd2a9914d toolkit/content/tests/chrome/Makefile.in
--- a/toolkit/content/tests/chrome/Makefile.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/toolkit/content/tests/chrome/Makefile.in	Thu Sep 18 08:03:25 2008 -0500
@@ -61,16 +61,18 @@ _TEST_FILES = 	findbar_window.xul \
 		window_popup_preventdefault_chrome.xul \
 		test_largemenu.xul \
 		window_largemenu.xul \
 		test_popup_anchor.xul \
 		window_popup_anchor.xul \
 		frame_popup_anchor.xul \
 		test_preferences.xul \
 		window_preferences.xul \
+		window_preferences2.xul \
+		window_preferences3.xul \
 		test_autocomplete2.xul \
 		test_keys.xul \
 		window_keys.xul \
 		$(NULL)
 
 ifeq (,$(filter mac cocoa,$(MOZ_WIDGET_TOOLKIT)))
 _TEST_FILES += test_panel_focus.xul \
                window_panel_focus.xul
diff -r 1aecd2a9914d toolkit/content/tests/chrome/test_preferences.xul
--- a/toolkit/content/tests/chrome/test_preferences.xul	Tue Sep 16 16:40:57 2008 +1200
+++ b/toolkit/content/tests/chrome/test_preferences.xul	Thu Sep 18 08:03:25 2008 -0500
@@ -298,16 +298,24 @@
       found = ReadPrefsFromUI(aPrefWindow);
       ok(found.int          === expected.int,          "instant reset element int"    );
       ok(found.bool         === expected.bool,         "instant reset element bool"   );
       ok(found.string       === expected.string,       "instant reset element string" );
       ok(found.wstring_data === expected.wstring_data, "instant reset element wstring");
       ok(found.unichar_data === expected.unichar_data, "instant reset element unichar");
 //      ok(found.file_data    === expected.file_data,    "instant reset element file"   );
 
+      // check hasUserValue
+      ok(GetXULElement(aPrefWindow, "tests.static_preference_int"    ).hasUserValue === false, "instant reset hasUserValue int"    );
+      ok(GetXULElement(aPrefWindow, "tests.static_preference_bool"   ).hasUserValue === false, "instant reset hasUserValue bool"   );
+      ok(GetXULElement(aPrefWindow, "tests.static_preference_string" ).hasUserValue === false, "instant reset hasUserValue string" );
+      ok(GetXULElement(aPrefWindow, "tests.static_preference_wstring").hasUserValue === false, "instant reset hasUserValue wstring");
+      ok(GetXULElement(aPrefWindow, "tests.static_preference_unichar").hasUserValue === false, "instant reset hasUserValue unichar");
+      ok(GetXULElement(aPrefWindow, "tests.static_preference_file"   ).hasUserValue === false, "instant reset hasUserValue file"   );
+
       // done with instant apply checks
     }
 
     function RunNonInstantPrefTestGeneral(aPrefWindow)
     {
       // Non-instant apply tests are harder: not only do we need to check that
       // fiddling with the values does *not* change the system settings, but
       // also that they *are* (not) set after closing (cancelling) the dialog...
@@ -395,35 +403,66 @@
       };
       found = ReadPrefsFromUI(aPrefWindow);
       ok(found.int          === expected.int,          "non-instant reset element int"    );
       ok(found.bool         === expected.bool,         "non-instant reset element bool"   );
       ok(found.string       === expected.string,       "non-instant reset element string" );
       ok(found.wstring_data === expected.wstring_data, "non-instant reset element wstring");
       ok(found.unichar_data === expected.unichar_data, "non-instant reset element unichar");
 //      ok(found.file_data    === expected.file_data,    "non-instant reset element file"   );
+
+      // check hasUserValue
+      ok(GetXULElement(aPrefWindow, "tests.static_preference_int"    ).hasUserValue === false, "non-instant reset hasUserValue int"    );
+      ok(GetXULElement(aPrefWindow, "tests.static_preference_bool"   ).hasUserValue === false, "non-instant reset hasUserValue bool"   );
+      ok(GetXULElement(aPrefWindow, "tests.static_preference_string" ).hasUserValue === false, "non-instant reset hasUserValue string" );
+      ok(GetXULElement(aPrefWindow, "tests.static_preference_wstring").hasUserValue === false, "non-instant reset hasUserValue wstring");
+      ok(GetXULElement(aPrefWindow, "tests.static_preference_unichar").hasUserValue === false, "non-instant reset hasUserValue unichar");
+      ok(GetXULElement(aPrefWindow, "tests.static_preference_file"   ).hasUserValue === false, "non-instant reset hasUserValue file"   );
     }
 
     function RunNonInstantPrefTestClose(aPrefWindow)
     {
       WritePrefsToPreferences(aPrefWindow, kPrefValueSet2);
+    }
+
+    function RunResetPrefTest(aPrefWindow)
+    {
+      // try resetting the prefs to default values
+      GetXULElement(aPrefWindow, "tests.static_preference_int"    ).reset();
+      GetXULElement(aPrefWindow, "tests.static_preference_bool"   ).reset();
+      GetXULElement(aPrefWindow, "tests.static_preference_string" ).reset();
+      GetXULElement(aPrefWindow, "tests.static_preference_wstring").reset();
+      GetXULElement(aPrefWindow, "tests.static_preference_unichar").reset();
+      GetXULElement(aPrefWindow, "tests.static_preference_file"   ).reset();
     }
 
     function InitTestPrefs(aInstantApply)
     {
       // set instant apply mode and init prefs to set 1
       kPref.setBoolPref("browser.preferences.instantApply", aInstantApply);
       WritePrefsToSystem(kPrefValueSet1);
     }
 
     function RunTestInstant()
     {
       // test with instantApply
       InitTestPrefs(true);
       openDialog("window_preferences.xul", "", "modal", RunInstantPrefTest, false);
+
+      // - test deferred reset in child window
+      InitTestPrefs(true);
+      openDialog("window_preferences2.xul", "", "modal", RunResetPrefTest, false);
+      expected = kPrefValueSet1;
+      found    = ReadPrefsFromSystem();
+      ok(found.int          === expected.int,          "instant reset deferred int"    );
+      ok(found.bool         === expected.bool,         "instant reset deferred bool"   );
+      ok(found.string       === expected.string,       "instant reset deferred string" );
+      ok(found.wstring_data === expected.wstring_data, "instant reset deferred wstring");
+      ok(found.unichar_data === expected.unichar_data, "instant reset deferred unichar");
+      todo(found.file_data  === expected.file_data,    "instant reset deferred file"   );
     }
 
     function RunTestNonInstant()
     {
       // test without instantApply
       // - general tests, similar to instant apply
       InitTestPrefs(false);
       openDialog("window_preferences.xul", "", "modal", RunNonInstantPrefTestGeneral, false);
@@ -446,16 +485,28 @@
       expected = kPrefValueSet2;
       found    = ReadPrefsFromSystem();
       ok(found.int          === expected.int,          "non-instant accept system int"    );
       ok(found.bool         === expected.bool,         "non-instant accept system bool"   );
       ok(found.string       === expected.string,       "non-instant accept system string" );
       ok(found.wstring_data === expected.wstring_data, "non-instant accept system wstring");
       ok(found.unichar_data === expected.unichar_data, "non-instant accept system unichar");
       todo(found.file_data  === expected.file_data,    "non-instant accept system file"   );
+
+      // - test deferred reset in child window
+      InitTestPrefs(false);
+      openDialog("window_preferences2.xul", "", "modal", RunResetPrefTest, true);
+      expected = CreateEmptyPrefValueSet();
+      found    = ReadPrefsFromSystem();
+      ok(found.int          === expected.int,          "non-instant reset deferred int"    );
+      ok(found.bool         === expected.bool,         "non-instant reset deferred bool"   );
+      ok(found.string       === expected.string,       "non-instant reset deferred string" );
+      ok(found.wstring_data === expected.wstring_data, "non-instant reset deferred wstring");
+      ok(found.unichar_data === expected.unichar_data, "non-instant reset deferred unichar");
+      ok(found.file_data    === expected.file_data,    "non-instant reset deferred file"   );
     }
 
     function RunTest()
     {
       RunTestInstant();
       RunTestNonInstant();
       SimpleTest.finish();
     }
diff -r 1aecd2a9914d toolkit/content/tests/chrome/window_preferences2.xul
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/toolkit/content/tests/chrome/window_preferences2.xul	Thu Sep 18 08:03:25 2008 -0500
@@ -0,0 +1,25 @@
+<?xml version="1.0"?>
+<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
+<!--
+  XUL Widget Test for preferences window
+-->
+<prefwindow xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+            title="preferences window"
+            windowtype="test:preferences2"
+            buttons="accept,cancel"
+            onload="RunTest(window.arguments)"
+>
+  <script type="application/javascript">
+  <![CDATA[
+    function RunTest(aArgs)
+    {
+      // open child
+      document.documentElement.openSubDialog("window_preferences3.xul", "", {test: aArgs[0], accept: aArgs[1]});
+      // close dialog
+      document.documentElement[aArgs[1] ? "acceptDialog" : "cancelDialog"]();
+    }
+  ]]>
+  </script>
+
+  <prefpane id="sample_pane" label="Sample Prefpane"/>
+</prefwindow>
diff -r 1aecd2a9914d toolkit/content/tests/chrome/window_preferences3.xul
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/toolkit/content/tests/chrome/window_preferences3.xul	Thu Sep 18 08:03:25 2008 -0500
@@ -0,0 +1,74 @@
+<?xml version="1.0"?>
+<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
+<!--
+  XUL Widget Test for preferences window
+-->
+<prefwindow xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+            title="preferences window"
+            windowtype="test:preferences3"
+            buttons="accept,cancel"
+            onload="RunTest(window.arguments)"
+            type="child"
+>
+  <script type="application/javascript">
+  <![CDATA[
+    function RunTest(aArgs)
+    {
+      // run test
+      aArgs[0].test(this);
+      // close dialog
+      document.documentElement[aArgs[0].accept ? "acceptDialog" : "cancelDialog"]();
+    }
+  ]]>
+  </script>
+
+  <prefpane id="sample_pane" label="Sample Prefpane">
+    <preferences id="sample_preferences">
+      <!-- one of each type known to <preferences>.valueFromPreferences -->
+      <preference id  ="tests.static_preference_int"
+                  name="tests.static_preference_int"
+                  type="int"/>
+      <preference id  ="tests.static_preference_bool"
+                  name="tests.static_preference_bool"
+                  type="bool"/>
+      <preference id  ="tests.static_preference_string"
+                  name="tests.static_preference_string"
+                  type="string"/>
+      <preference id  ="tests.static_preference_wstring"
+                  name="tests.static_preference_wstring"
+                  type="wstring"/>
+      <preference id  ="tests.static_preference_unichar"
+                  name="tests.static_preference_unichar"
+                  type="unichar"/>
+      <preference id  ="tests.static_preference_file"
+                  name="tests.static_preference_file"
+                  type="file"/>
+    </preferences>
+
+    <!-- one element for each preference type above -->
+    <hbox>
+      <label flex="1" value="int"/>
+      <textbox id="static_element_int"     preference="tests.static_preference_int"/>
+    </hbox>
+    <hbox>
+      <label flex="1" value="bool"/>
+      <checkbox id="static_element_bool"   preference="tests.static_preference_bool"/>
+    </hbox>
+    <hbox>
+      <label flex="1" value="string"/>
+      <textbox id="static_element_string"  preference="tests.static_preference_string"/>
+    </hbox>
+    <hbox>
+      <label flex="1" value="wstring"/>
+      <textbox id="static_element_wstring" preference="tests.static_preference_wstring"/>
+    </hbox>
+    <hbox>
+      <label flex="1" value="unichar"/>
+      <textbox id="static_element_unichar" preference="tests.static_preference_unichar"/>
+    </hbox>
+    <hbox>
+      <label flex="1" value="file"/>
+      <textbox id="static_element_file"    preference="tests.static_preference_file"/>
+    </hbox>
+  </prefpane>
+</prefwindow>
diff -r 1aecd2a9914d toolkit/content/tests/widgets/test_mousescroll.xul
--- a/toolkit/content/tests/widgets/test_mousescroll.xul	Tue Sep 16 16:40:57 2008 +1200
+++ b/toolkit/content/tests/widgets/test_mousescroll.xul	Thu Sep 18 08:03:25 2008 -0500
@@ -68,113 +68,146 @@ https://bugzilla.mozilla.org/show_bug.cg
       <vbox style="width:100px; height:40px; background:white;"/>
       <vbox style="width:100px; height:40px; background:black;"/>
   </arrowscrollbox>
   
   <!-- test code goes here -->
   <script type="application/javascript"><![CDATA[
 
 /** Test for Bug 378028 **/
+/*   and for Bug 350471 **/
 SimpleTest.waitForExplicitFinish();
+
+/* There are three kinds of scroll events:
+    1. line scrolls without hasPixels
+    2. line scrolls with hasPixels
+    3. pixel scrolls
+   Listboxes and arrowscrollboxes (DOM event scrolling) should only react to
+   line scrolls and ignore hasPixels.
+   Richlistboxes ("native" scrolling) should be scrollable by kind 1 and 3.
+*/
+const kinds = [
+  { eventType: "DOMMouseScroll", hasPixels: false, shouldScrollDOM: true, shouldScrollNative: true },
+  { eventType: "DOMMouseScroll", hasPixels: true, shouldScrollDOM: true, shouldScrollNative: false },
+  { eventType: "MozMousePixelScroll", hasPixels: false, shouldScrollDOM: false, shouldScrollNative: true }
+];
+
 
 function testListbox(id)
 {
   var listbox = document.getElementById(id);
   
-  function helper(aStart, aDelta)
+  function helper(aStart, aDelta, aKind)
   {
     listbox.scrollToIndex(aStart);
     synthesizeMouseScroll(listbox, 10, 10,
-                          {axis:"vertical", delta:aDelta});
-    is(listbox.getIndexOfFirstVisibleRow(), aStart + aDelta,
-       "mouse-scroll of '" + id + "' vertical starting " + aStart + " delta " + aDelta);
+                          {axis:"vertical", delta:aDelta, type:aKind.eventType,
+                           hasPixels:aKind.hasPixels});
+    is(listbox.getIndexOfFirstVisibleRow(), aKind.shouldScrollDOM ? aStart + aDelta : aStart,
+       "mouse-scroll of '" + id + "' vertical starting " + aStart + " delta " + aDelta
+       + " eventType " + aKind.eventType + " hasPixels " + aKind.hasPixels);
 
     // Check that horizontal scrolling has no effect
     listbox.scrollToIndex(aStart);
     synthesizeMouseScroll(listbox, 10, 10,
-                          {axis:"horizontal", delta:aDelta});  
+                          {axis:"horizontal", delta:aDelta, type:aKind.eventType,
+                           hasPixels:aKind.hasPixels});  
     is(listbox.getIndexOfFirstVisibleRow(), aStart,
-       "mouse-scroll of '" + id + "' horizontal starting " + aStart + " delta " + aDelta);
+       "mouse-scroll of '" + id + "' horizontal starting " + aStart + " delta " + aDelta
+       + " eventType " + aKind.eventType + " hasPixels " + aKind.hasPixels);
   }
-  
-  helper(2, -1);
-  helper(2, 1);
-  helper(2, -2);
-  helper(2, 2);
+  kinds.forEach(function(aKind) {
+    helper(2, -1, aKind);
+    helper(2, 1, aKind);
+    helper(2, -2, aKind);
+    helper(2, 2, aKind);
+  });
 }
 
 function testRichListbox(id)
 {
   var listbox = document.getElementById(id);
   
-  function helper(aStart, aDelta, aExpected)
+  function helper(aStart, aDelta, aExpected, aKind)
   {
     listbox.scrollToIndex(aStart);
     synthesizeMouseScroll(listbox, 10, 10,
-                          {axis:"vertical", delta:aDelta});
-    is(listbox.getIndexOfFirstVisibleRow(), aExpected,
-       "mouse-scroll of '" + id + "' vertical starting " + aStart + " delta " + aDelta);
+                          {axis:"vertical", delta:aDelta, type:aKind.eventType,
+                           hasPixels:aKind.hasPixels});
+    is(listbox.getIndexOfFirstVisibleRow(), aKind.shouldScrollNative ? aExpected : aStart,
+       "mouse-scroll of '" + id + "' vertical starting " + aStart + " delta " + aDelta
+       + " eventType " + aKind.eventType + " hasPixels " + aKind.hasPixels);
 
     // Check that horizontal scrolling has no effect
     listbox.scrollToIndex(aStart);
     synthesizeMouseScroll(listbox, 10, 10,
-                          {axis:"horizontal", delta:aDelta});  
+                          {axis:"horizontal", delta:aDelta, type:aKind.eventType,
+                           hasPixels:aKind.hasPixels});  
     is(listbox.getIndexOfFirstVisibleRow(), aStart,
-       "mouse-scroll of '" + id + "' horizontal starting " + aStart + " delta " + aDelta);
+       "mouse-scroll of '" + id + "' horizontal starting " + aStart + " delta " + aDelta
+       + " eventType " + aKind.eventType + " hasPixels " + aKind.hasPixels);
   }
   
   // richlistbox currently uses native XUL scrolling, so the "line"
   // amounts don't necessarily correspond 1-to-1 with listbox items. So
   // we just check that scrolling up/down a lot hits the first/last items
-  helper(2, -100, 0);
-  helper(2, 100, listbox.getRowCount() - listbox.getNumberOfVisibleRows());
+  kinds.forEach(function(aKind) {
+    helper(2, -100, 0, aKind);
+    helper(2, 100, listbox.getRowCount() - listbox.getNumberOfVisibleRows(), aKind);
+  });
 }
 
 function testArrowScrollbox(id)
 {
   var scrollbox = document.getElementById(id);
   var scrollBoxObject = scrollbox.scrollBoxObject;
   var orient = scrollbox.getAttribute("orient");
   
-  function helper(aStart, aDelta, aExpected)
+  function helper(aStart, aDelta, aExpected, aKind)
   {
     var xpos = {};
     var ypos = {};
     var pos = orient == "horizontal" ? xpos : ypos;
 
     scrollBoxObject.scrollTo(aStart, aStart);
     synthesizeMouseScroll(scrollbox, 5, 5,
-                          {axis:"vertical", delta:aDelta});
+                          {axis:"vertical", delta:aDelta, type:aKind.eventType,
+                           hasPixels:aKind.hasPixels});
     scrollBoxObject.getPosition(xpos, ypos);
     // Note, vertical mouse scrolling is allowed to scroll horizontal
     // arrowscrollboxes, because many users have no horizontal mouse scroll
     // capability
-    is(pos.value, aExpected,
-       "mouse-scroll of '" + id + "' vertical starting " + aStart + " delta " + aDelta);
+    is(pos.value, aKind.shouldScrollDOM ? aExpected : aStart,
+       "mouse-scroll of '" + id + "' vertical starting " + aStart + " delta " + aDelta
+       + " eventType " + aKind.eventType + " hasPixels " + aKind.hasPixels);
 
     scrollBoxObject.scrollTo(aStart, aStart);
     synthesizeMouseScroll(scrollbox, 5, 5,
-                          {axis:"horizontal", delta:aDelta});
+                          {axis:"horizontal", delta:aDelta, type:aKind.eventType,
+                           hasPixels:aKind.hasPixels});
     // horizontal mouse scrolling is never allowed to scroll vertical
     // arrowscrollboxes
     scrollBoxObject.getPosition(xpos, ypos);
-    var expected = orient == "horizontal" ? aExpected : aStart;
+    var expected = (aKind.shouldScrollDOM && (orient == "horizontal")) ? aExpected : aStart;
     is(pos.value, expected,
-       "mouse-scroll of '" + id + "' horizontal starting " + aStart + " delta " + aDelta);
+       "mouse-scroll of '" + id + "' horizontal starting " + aStart + " delta " + aDelta
+       + " eventType " + aKind.eventType + " hasPixels " + aKind.hasPixels);
   }
 
   var scrolledWidth = {};
   var scrolledHeight = {};
   scrollBoxObject.getScrolledSize(scrolledWidth, scrolledHeight);
   var scrollMaxX = scrolledWidth.value - scrollBoxObject.width;
   var scrollMaxY = scrolledHeight.value - scrollBoxObject.height;
   var scrollMax = orient == "horizontal" ? scrollMaxX : scrollMaxY;
 
-  helper(50, -100, 0);
-  helper(50, 100, scrollMax);
+  kinds.forEach(function(aKind) {
+    helper(50, -100, 0, aKind);
+    helper(50, 100, scrollMax, aKind);
+  });
 }
 
 function runTests()
 {
   testRichListbox("richlistbox");
   testListbox("listbox");
   testArrowScrollbox("hscrollbox");
   testArrowScrollbox("vscrollbox");
diff -r 1aecd2a9914d toolkit/content/tests/widgets/tree_shared.js
--- a/toolkit/content/tests/widgets/tree_shared.js	Tue Sep 16 16:40:57 2008 +1200
+++ b/toolkit/content/tests/widgets/tree_shared.js	Thu Sep 18 08:03:25 2008 -0500
@@ -1091,34 +1091,47 @@ function testtag_tree_column_reorder()
   is(document.treecolDragging, null, "drag to itself completed");
 
   // XXX roc should this be here???
   SimpleTest.finish();
 }
 
 function testtag_tree_mousescroll(aTree)
 {
-  function helper(aStart, aDelta)
+  /* Scroll event kinds, see test_mousescroll.xul */
+  const kinds = [
+    { eventType: "DOMMouseScroll", hasPixels: false, shouldScrollDOM: true, shouldScrollNative: true },
+    { eventType: "DOMMouseScroll", hasPixels: true, shouldScrollDOM: true, shouldScrollNative: false },
+    { eventType: "MozMousePixelScroll", hasPixels: false, shouldScrollDOM: false, shouldScrollNative: true }
+  ];
+  function helper(aStart, aDelta, aKind)
   {
     aTree.treeBoxObject.scrollToRow(aStart);
     synthesizeMouseScroll(aTree.body, 1, 1,
-                         {type:"DOMMouseScroll", axis:"vertical", delta:aDelta});
-    is(aTree.treeBoxObject.getFirstVisibleRow(), aStart + aDelta, "mouse-scroll vertical starting " + aStart + " delta " + aDelta);
+                          {axis:"vertical", delta:aDelta, type:aKind.eventType,
+                           hasPixels:aKind.hasPixels});
+    var expected = aKind.shouldScrollDOM ? aStart + aDelta : aStart;
+    is(aTree.treeBoxObject.getFirstVisibleRow(), expected, "mouse-scroll vertical starting " + aStart + " delta " + aDelta
+       + " eventType " + aKind.eventType + " hasPixels " + aKind.hasPixels);
 
     aTree.treeBoxObject.scrollToRow(aStart);
     // Check that horizontal scrolling has no effect
     synthesizeMouseScroll(aTree.body, 1, 1,
-                          {type:"DOMMouseScroll", axis:"horizontal", delta:aDelta});  
-    is(aTree.treeBoxObject.getFirstVisibleRow(), aStart, "mouse-scroll horizontal starting " + aStart + " delta " + aDelta);
+                          {axis:"horizontal", delta:aDelta, type:aKind.eventType,
+                           hasPixels:aKind.hasPixels});  
+    is(aTree.treeBoxObject.getFirstVisibleRow(), aStart, "mouse-scroll horizontal starting " + aStart + " delta " + aDelta
+       + " eventType " + aKind.eventType + " hasPixels " + aKind.hasPixels);
   }
   
-  helper(2, -1);
-  helper(2, 1);
-  helper(2, -2);
-  helper(2, 2);
+  kinds.forEach(function(aKind) {
+    helper(2, -1, aKind);
+    helper(2, 1, aKind);
+    helper(2, -2, aKind);
+    helper(2, 2, aKind);
+  });
 }
 
 function synthesizeColumnDrag(aTree, aMouseDownColumnNumber, aMouseUpColumnNumber, aAfter)
 {
   var columns = getSortedColumnArray(aTree);
 
   var down = columns[aMouseDownColumnNumber].element;
   var up   = columns[aMouseUpColumnNumber].element;
diff -r 1aecd2a9914d toolkit/content/widgets/preferences.xml
--- a/toolkit/content/widgets/preferences.xml	Tue Sep 16 16:40:57 2008 +1200
+++ b/toolkit/content/widgets/preferences.xml	Thu Sep 18 08:03:25 2008 -0500
@@ -146,17 +146,17 @@
                                 onset="this.setAttribute('readonly', val); return val;"/>
 
       <field name="_value">null</field>
       <method name="_setValue">
         <parameter name="aValue"/>
         <parameter name="aUpdate"/>
         <body>
         <![CDATA[
-          if (aUpdate && this.value != aValue) {
+          if (aUpdate && this.value !== aValue) {
             this._value = aValue;
             if (this.instantApply)
               this.valueFromPreferences = aValue;
             this.preferences.fireChangedEvent(this);
           }
           else if (!aUpdate) {
             this._value = aValue;
             this.updateElements();
@@ -226,17 +226,20 @@
             
           return val;
         ]]>
         </setter>
       </property>
 
       <property name="hasUserValue">
         <getter>
-          return this.preferences.rootBranch.prefHasUserValue(this.name);
+        <![CDATA[
+          return this.preferences.rootBranch.prefHasUserValue(this.name) &&
+                 this.value !== undefined;
+        ]]>
         </getter>
       </property>
       
       <method name="reset">
         <body>
           // defer reset until preference update
           this.value = undefined;
         </body>
diff -r 1aecd2a9914d toolkit/mozapps/installer/package-name.mk
--- a/toolkit/mozapps/installer/package-name.mk	Tue Sep 16 16:40:57 2008 +1200
+++ b/toolkit/mozapps/installer/package-name.mk	Thu Sep 18 08:03:25 2008 -0500
@@ -15,34 +15,37 @@
 #
 # The Initial Developer of the Original Code is
 # Benjamin Smedberg <bsmedberg@covad.net>
 # 
 # Portions created by the Initial Developer are Copyright (C) 2004
 # the Initial Developer. All Rights Reserved.
 #
 # Contributor(s):
+#   Robert Kaiser <kairo@kairo.at>
 #
 # Alternatively, the contents of this file may be used under the terms of
 # either the GNU General Public License Version 2 or later (the "GPL"), or
 # the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
 # in which case the provisions of the GPL or the LGPL are applicable instead
 # of those above. If you wish to allow use of your version of this file only
 # under the terms of either the GPL or the LGPL, and not to allow others to
 # use your version of this file under the terms of the MPL, indicate your
 # decision by deleting the provisions above and replace them with the notice
 # and other provisions required by the GPL or the LGPL. If you do not delete
 # the provisions above, a recipient may use your version of this file under
 # the terms of any one of the MPL, the GPL or the LGPL.
 #
 # ***** END LICENSE BLOCK *****
 
-ifndef MOZ_PKG_APPNAME
-MOZ_PKG_APPNAME = $(MOZ_APP_NAME)
-endif
+# assemble package names, see convention at
+# http://developer.mozilla.org/index.php?title=En/Package_Filename_Convention
+# for (at least Firefox) releases we use a different format with directories,
+# e.g. win32/de/Firefox Setup 3.0.1.exe
+# the latter format is triggered with MOZ_PKG_PRETTYNAMES=1
 
 ifndef MOZ_PKG_VERSION
 MOZ_PKG_VERSION = $(MOZ_APP_VERSION)
 endif
 
 ifndef MOZ_PKG_PLATFORM
 MOZ_PKG_PLATFORM := $(TARGET_OS)-$(TARGET_CPU)
 
@@ -79,9 +82,50 @@ endif # 6.
 endif # 6.
 endif # OS_ARCH BeOS
 endif #MOZ_PKG_PLATFORM
 
 ifdef MOZ_PKG_SPECIAL
 MOZ_PKG_PLATFORM := $(MOZ_PKG_PLATFORM)-$(MOZ_PKG_SPECIAL)
 endif
 
+
+ifndef MOZ_PKG_PRETTYNAMES # standard package names
+
+ifndef MOZ_PKG_APPNAME
+MOZ_PKG_APPNAME = $(MOZ_APP_NAME)
+endif
+
 PKG_BASENAME = $(MOZ_PKG_APPNAME)-$(MOZ_PKG_VERSION).$(AB_CD).$(MOZ_PKG_PLATFORM)
+PKG_PATH =
+PKG_INST_BASENAME = $(PKG_BASENAME).installer
+PKG_INST_PATH = install/sea/
+PKG_UPDATE_BASENAME = $(PKG_BASENAME)
+PKG_UPDATE_PATH = update/
+PKG_LANGPACK_BASENAME = $(MOZ_PKG_APPNAME)-$(MOZ_PKG_VERSION).$(AB_CD).langpack
+PKG_LANGPACK_PATH = install/
+
+else # "pretty" release package names
+
+ifndef MOZ_PKG_APPNAME
+MOZ_PKG_APPNAME = $(MOZ_APP_DISPLAYNAME)
+endif
+MOZ_PKG_APPNAME_LC = $(shell echo $(MOZ_PKG_APPNAME) | tr '[A-Z]' '[a-z]')
+
+ifndef MOZ_PKG_LONGVERSION
+MOZ_PKG_LONGVERSION = $(MOZ_PKG_VERSION)
+endif
+
+ifeq (,$(filter-out Darwin OS2 WINNT, $(OS_ARCH)))
+PKG_BASENAME = $(MOZ_PKG_APPNAME) $(MOZ_PKG_LONGVERSION)
+PKG_INST_BASENAME = $(MOZ_PKG_APPNAME) Setup $(MOZ_PKG_LONGVERSION)
+else # unix (actually, not Windows, Mac or OS/2)
+PKG_BASENAME = $(MOZ_PKG_APPNAME_LC)-$(MOZ_PKG_VERSION)
+PKG_INST_BASENAME = $(MOZ_PKG_APPNAME_LC)-setup-$(MOZ_PKG_VERSION)
+endif
+PKG_PATH = $(MOZ_PKG_PLATFORM)/$(AB_CD)/
+PKG_INST_PATH = $(PKG_PATH)
+PKG_UPDATE_BASENAME = $(MOZ_PKG_APPNAME_LC)-$(MOZ_PKG_VERSION)
+PKG_UPDATE_PATH = update/$(PKG_PATH)
+PKG_LANGPACK_BASENAME = $(AB_CD)
+PKG_LANGPACK_PATH = langpack/
+
+endif # MOZ_PKG_PRETTYNAMES
diff -r 1aecd2a9914d toolkit/mozapps/installer/packager.mk
--- a/toolkit/mozapps/installer/packager.mk	Tue Sep 16 16:40:57 2008 +1200
+++ b/toolkit/mozapps/installer/packager.mk	Thu Sep 18 08:03:25 2008 -0500
@@ -67,22 +67,22 @@ MOZ_PKG_FORMAT  = TGZ
 MOZ_PKG_FORMAT  = TGZ
 endif
 endif
 INSTALLER_DIR   = unix
 endif
 endif
 endif # MOZ_PKG_FORMAT
 
-PACKAGE       = $(PKG_BASENAME)$(PKG_SUFFIX)
+PACKAGE       = $(PKG_PATH)$(PKG_BASENAME)$(PKG_SUFFIX)
 
 # By default, the SDK uses the same packaging type as the main bundle,
 # but on mac it is a .tar.bz2
 SDK_SUFFIX    = $(PKG_SUFFIX)
-SDK           = $(PKG_BASENAME).sdk$(SDK_SUFFIX)
+SDK           = $(PKG_PATH)$(PKG_BASENAME).sdk$(SDK_SUFFIX)
 
 MAKE_PACKAGE	= $(error What is a $(MOZ_PKG_FORMAT) package format?);
 
 CREATE_FINAL_TAR = $(TAR) -c --owner=0 --group=0 --numeric-owner \
   --mode="go-w" -f
 UNPACK_TAR       = tar -x
 
 ifeq ($(MOZ_PKG_FORMAT),TAR)
@@ -332,17 +332,17 @@ ifdef MOZ_OPTIONAL_PKG_LIST
 	$(call PACKAGER_COPY, "$(DIST)",\
 		"$(DEPTH)/installer-stage/optional", \
 		"$(MOZ_PKG_MANIFEST)", "$(PKGCP_OS)", 1, 0, 1 \
 		$(foreach pkg,$(MOZ_OPTIONAL_PKG_LIST),$(PKG_ARG)) )
 endif
 	$(PERL) $(MOZILLA_DIR)/xpinstall/packager/xptlink.pl -s $(DIST) -d $(DIST)/xpt -f $(DEPTH)/installer-stage/nonlocalized/components -v -x "$(XPIDL_LINK)"
 
 stage-package: $(MOZ_PKG_MANIFEST) $(MOZ_PKG_REMOVALS_GEN)
-	@rm -rf $(DIST)/$(MOZ_PKG_APPNAME) $(DIST)/$(PKG_BASENAME).tar $(DIST)/$(PKG_BASENAME).dmg $@ $(EXCLUDE_LIST)
+	@rm -rf $(DIST)/$(MOZ_PKG_APPNAME) $(DIST)/$(PKG_PATH)$(PKG_BASENAME).tar $(DIST)/$(PKG_PATH)$(PKG_BASENAME).dmg $@ $(EXCLUDE_LIST)
 # NOTE: this must be a tar now that dist links into the tree so that we
 # do not strip the binaries actually in the tree.
 	@echo "Creating package directory..."
 	@mkdir $(DIST)/$(MOZ_PKG_APPNAME)
 ifdef MOZ_PKG_MANIFEST
 	$(RM) -rf $(DIST)/xpt
 	$(call PACKAGER_COPY, "$(DIST)",\
 		 "$(DIST)/$(MOZ_PKG_APPNAME)", \
@@ -395,16 +395,17 @@ ifdef NO_PKG_FILES
 	cd $(DIST)/$(STAGEPATH)$(MOZ_PKG_APPNAME)$(_BINPATH); rm -rf $(NO_PKG_FILES)
 endif
 ifdef MOZ_PKG_REMOVALS
 	$(SYSINSTALL) $(MOZ_PKG_REMOVALS_GEN) $(DIST)/$(STAGEPATH)$(MOZ_PKG_APPNAME)$(_BINPATH)
 endif # MOZ_PKG_REMOVALS
 
 make-package: stage-package
 	@echo "Compressing..."
+	$(NSINSTALL) -D $(DIST)/$(PKG_PATH)
 	cd $(DIST) && $(MAKE_PACKAGE)
 
 # The install target will install the application to prefix/lib/appname-version
 # In addition if INSTALL_SDK is set, it will install the development headers,
 # libraries, and IDL files as follows:
 # dist/sdk/include -> prefix/include/appname-version/stable
 # dist/include -> prefix/include/appname-version/unstable
 # dist/sdk/idl -> prefix/share/idl/appname-version/stable
diff -r 1aecd2a9914d toolkit/mozapps/installer/windows/nsis/makensis.mk
--- a/toolkit/mozapps/installer/windows/nsis/makensis.mk	Tue Sep 16 16:40:57 2008 +1200
+++ b/toolkit/mozapps/installer/windows/nsis/makensis.mk	Thu Sep 18 08:03:25 2008 -0500
@@ -66,19 +66,19 @@ endif
 
 $(CONFIG_DIR)/7zSD.sfx:
 	$(CYGWIN_WRAPPER) upx --best -o $(CONFIG_DIR)/7zSD.sfx $(SFX_MODULE)
 
 installer::
 	$(INSTALL) $(CONFIG_DIR)/removed-files.log $(CONFIG_DIR)/setup.exe $(DEPTH)/installer-stage
 	cd $(DEPTH)/installer-stage && $(CYGWIN_WRAPPER) 7z a -r -t7z $(ABS_CONFIG_DIR)/app.7z -mx -m0=BCJ2 -m1=LZMA:d24 -m2=LZMA:d19 -m3=LZMA:d19  -mb0:1 -mb0s1:2 -mb0s2:3
 	$(MAKE) $(CONFIG_DIR)/7zSD.sfx
-	$(NSINSTALL) -D $(DIST)/install/sea
-	cat $(CONFIG_DIR)/7zSD.sfx $(CONFIG_DIR)/app.tag $(CONFIG_DIR)/app.7z > $(DIST)/install/sea/$(PKG_BASENAME).installer.exe
-	chmod 0755 $(DIST)/install/sea/$(PKG_BASENAME).installer.exe
+	$(NSINSTALL) -D $(DIST)/$(PKG_INST_PATH)
+	cat $(CONFIG_DIR)/7zSD.sfx $(CONFIG_DIR)/app.tag $(CONFIG_DIR)/app.7z > $(DIST)/$(PKG_INST_PATH)$(PKG_INST_BASENAME).exe
+	chmod 0755 $(DIST)/$(PKG_INST_PATH)$(PKG_INST_BASENAME).exe
 
 # For building the uninstaller during the application build so it can be
 # included for mar file generation.
 uninstaller::
 	$(INSTALL) $(addprefix $(MOZILLA_DIR)/toolkit/mozapps/installer/windows/nsis/,$(TOOLKIT_NSIS_FILES)) $(CONFIG_DIR)
 	$(INSTALL) $(MOZILLA_DIR)/toolkit/mozapps/installer/windows/nsis/setup.ico $(CONFIG_DIR)
 	cd $(CONFIG_DIR) && makensis.exe uninstaller.nsi
 	$(NSINSTALL) -D $(DIST)/bin/uninstall
diff -r 1aecd2a9914d toolkit/themes/pinstripe/global/console/console.css
--- a/toolkit/themes/pinstripe/global/console/console.css	Tue Sep 16 16:40:57 2008 +1200
+++ b/toolkit/themes/pinstripe/global/console/console.css	Thu Sep 18 08:03:25 2008 -0500
@@ -35,26 +35,16 @@
  *
  * ***** END LICENSE BLOCK ***** */
 
 /* ===== console.css ====================================================
   == Styles used by the Error Console window.
   ======================================================================= */
 
 @namespace url("http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul");
-
-#JSConsoleWindow {
-  -moz-binding: url("chrome://global/skin/globalBindings.xml#unifiedWindow");
-}
-
-#JSConsoleWindow:not([active="true"]) > #console-toolbox > #ToolbarMode {
-  background-image: url("chrome://global/skin/toolbar/toolbar-background-inactive.png");
-  background-color: #cfcfcf;
-  border-bottom: 1px solid rgba(0,0,0,0.35);
-}
 
 #JSConsoleWindow:not([active="true"]) > #console-toolbox > #ToolbarMode > toolbarbutton {
   opacity: 0.7;
 }
 
 .console-box {
   background-color: -moz-Field;
   color: -moz-FieldText;
diff -r 1aecd2a9914d toolkit/themes/pinstripe/global/toolbar.css
--- a/toolkit/themes/pinstripe/global/toolbar.css	Tue Sep 16 16:40:57 2008 +1200
+++ b/toolkit/themes/pinstripe/global/toolbar.css	Thu Sep 18 08:03:25 2008 -0500
@@ -87,16 +87,21 @@ toolbarseparator {
   padding: 0px;
   width: 1px !important;
 }
 
 .toolbar-primary {
 	min-height: 24px !important;
 }
 
+.toolbar-primary,
+window > toolbox:nth-of-type(1) > toolbar:nth-of-type(1) {
+  -moz-appearance: -moz-mac-unified-toolbar;
+}
+
 
 /* ::::: toolbarpaletteitem ::::: */
 
 toolbarpaletteitem {
   cursor: -moz-grab;
 }
 
 toolbar[iconsize="small"] toolbarpaletteitem[type="spacer"] {
diff -r 1aecd2a9914d toolkit/themes/pinstripe/mozapps/extensions/extensions.css
--- a/toolkit/themes/pinstripe/mozapps/extensions/extensions.css	Tue Sep 16 16:40:57 2008 +1200
+++ b/toolkit/themes/pinstripe/mozapps/extensions/extensions.css	Thu Sep 18 08:03:25 2008 -0500
@@ -1,18 +1,8 @@
-#extensionsManager {
-  -moz-binding: url("chrome://global/skin/globalBindings.xml#unifiedWindow");
-}
-
-#extensionsManager:not([active="true"]) > #topStackBar > #viewGroup {
-  background-image: url("chrome://global/skin/toolbar/toolbar-background-inactive.png");
-  background-color: #cfcfcf;
-  border-bottom: 1px solid rgba(0,0,0,0.35);
-}
-
 #extensionsManager:not([active="true"]) > #topStackBar > #viewGroup > .radiogroupWrapper {
   opacity: 0.7;
 }
 
 #extensionsBox {
   padding: 0;
   min-width:1px;
 }
@@ -368,20 +358,17 @@ vbox[typeName="status"][type="header-rec
 }
 
 #progressBox > hbox {
   -moz-box-align: center;
 }
 
 /* View buttons */
 .viewSelector {
-  background-color: #969696;
-  border-bottom: 1px solid #404040;
-  background-image: url("chrome://global/skin/toolbar/toolbar-background.gif");
-  background-repeat: repeat-x;
+  -moz-appearance: -moz-mac-unified-toolbar;
   padding: 4px 0 8px;
   margin: 0;
   -moz-box-pack: center;
 }
 
 #viewGroup {
   -moz-binding: url("chrome://mozapps/skin/extensions/extensions.xml#radiogroupWrapper");
 }
diff -r 1aecd2a9914d toolkit/toolkit-makefiles.sh
--- a/toolkit/toolkit-makefiles.sh	Tue Sep 16 16:40:57 2008 +1200
+++ b/toolkit/toolkit-makefiles.sh	Thu Sep 18 08:03:25 2008 -0500
@@ -83,16 +83,21 @@ MAKEFILES_editor="
   editor/txmgr/tests/Makefile
   editor/txtsvc/Makefile
   editor/txtsvc/public/Makefile
   editor/txtsvc/src/Makefile
   editor/composer/Makefile
   editor/composer/public/Makefile
   editor/composer/src/Makefile
   editor/composer/test/Makefile
+  editor/libeditor/Makefile
+  editor/libeditor/base/Makefile
+  editor/libeditor/base/tests/Makefile
+  editor/libeditor/html/Makefile
+  editor/libeditor/text/Makefile
 "
 
 MAKEFILES_expat="
   parser/expat/Makefile
   parser/expat/lib/Makefile
 "
 
 MAKEFILES_gfx="
diff -r 1aecd2a9914d tools/update-packaging/Makefile.in
--- a/tools/update-packaging/Makefile.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/tools/update-packaging/Makefile.in	Thu Sep 18 08:03:25 2008 -0500
@@ -41,47 +41,51 @@ topsrcdir	= @top_srcdir@
 topsrcdir	= @top_srcdir@
 srcdir		= @srcdir@
 VPATH		= @srcdir@
 
 include $(DEPTH)/config/autoconf.mk
 
 include $(topsrcdir)/toolkit/mozapps/installer/package-name.mk
 
+# input location for the build, usually $(DIST)
+# set this to $(DIST)/l10n-stage per override for L10n builds
+PACKAGE_BASE_DIR	= $(DIST)
+
 # Default output location for update archive
-STAGE_DIR	= $(DIST)/update
+STAGE_DIR	= $(DIST)/$(PKG_UPDATE_PATH)
 
 ifneq (,$(filter mac cocoa,$(MOZ_WIDGET_TOOLKIT)))
 ifdef UNIVERSAL_BINARY
-ifneq (,$(filter %/l10n-stage,$(DIST)))
-PACKAGE_DIR	= $(DIST)/$(MOZ_PKG_APPNAME)/$(MOZ_APP_DISPLAYNAME).app
+ifneq (,$(filter %/l10n-stage,$(PACKAGE_BASE_DIR)))
+PACKAGE_DIR	= $(PACKAGE_BASE_DIR)/$(MOZ_PKG_APPNAME)/$(MOZ_APP_DISPLAYNAME).app
 else
-PACKAGE_DIR	= $(DIST)/universal/$(MOZ_PKG_APPNAME)/$(MOZ_APP_DISPLAYNAME).app
+PACKAGE_DIR	= $(PACKAGE_BASE_DIR)/universal/$(MOZ_PKG_APPNAME)/$(MOZ_APP_DISPLAYNAME).app
 endif
 else
-PACKAGE_DIR	= $(DIST)/$(MOZ_PKG_APPNAME)/$(MOZ_APP_DISPLAYNAME).app
+PACKAGE_DIR	= $(PACKAGE_BASE_DIR)/$(MOZ_PKG_APPNAME)/$(MOZ_APP_DISPLAYNAME).app
 endif
 else
-PACKAGE_DIR	= $(DIST)/$(MOZ_PKG_APPNAME)
+PACKAGE_DIR	= $(PACKAGE_BASE_DIR)/$(MOZ_PKG_APPNAME)
 endif
 
 MAR_BIN	= $(DIST)/host/bin/mar$(HOST_BIN_SUFFIX)
 MBSDIFF_BIN	= $(DIST)/host/bin/mbsdiff$(HOST_BIN_SUFFIX)
 
 full-update:: complete-patch
 
 complete-patch::
 	mkdir -p $(STAGE_DIR)
 	MAR=$(MAR_BIN) \
 	  $(srcdir)/make_full_update.sh \
-	  "$(STAGE_DIR)/$(PKG_BASENAME).complete.mar" \
+	  "$(STAGE_DIR)/$(PKG_UPDATE_BASENAME).complete.mar" \
 	  "$(PACKAGE_DIR)"
 
 partial-patch::
 	mkdir -p $(STAGE_DIR)
 	MAR=$(MAR_BIN) \
 	MBSDIFF=$(MBSDIFF_BIN) \
 	  $(srcdir)/make_incremental_update.sh \
-	  "$(STAGE_DIR)/$(PKG_BASENAME).partial.$(SRC_BUILD_ID)-$(DST_BUILD_ID).mar" \
+	  "$(STAGE_DIR)/$(PKG_UPDATE_BASENAME).partial.$(SRC_BUILD_ID)-$(DST_BUILD_ID).mar" \
 	  "$(SRC_BUILD)" \
 	  "$(DST_BUILD)"
 
 include $(topsrcdir)/config/rules.mk
diff -r 1aecd2a9914d widget/public/nsGUIEvent.h
--- a/widget/public/nsGUIEvent.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/public/nsGUIEvent.h	Thu Sep 18 08:03:25 2008 -0500
@@ -266,16 +266,17 @@ class nsHashKey;
 // NS_XUL_COMMAND used to be here     (NS_XUL_EVENT_START+4)
 #define NS_XUL_BROADCAST              (NS_XUL_EVENT_START+5)
 #define NS_XUL_COMMAND_UPDATE         (NS_XUL_EVENT_START+6)
 //@}
 
 // Scroll events
 #define NS_MOUSE_SCROLL_START         1600
 #define NS_MOUSE_SCROLL               (NS_MOUSE_SCROLL_START)
+#define NS_MOUSE_PIXEL_SCROLL         (NS_MOUSE_SCROLL_START + 1)
 
 #define NS_SCROLLPORT_START           1700
 #define NS_SCROLLPORT_UNDERFLOW       (NS_SCROLLPORT_START)
 #define NS_SCROLLPORT_OVERFLOW        (NS_SCROLLPORT_START+1)
 #define NS_SCROLLPORT_OVERFLOWCHANGED (NS_SCROLLPORT_START+2)
 
 // Mutation events defined elsewhere starting at 1800
 
@@ -844,24 +845,69 @@ public:
   nsCompositionEvent(PRBool isTrusted, PRUint32 msg, nsIWidget *w)
     : nsInputEvent(isTrusted, msg, w, NS_COMPOSITION_EVENT)
   {
   }
 
   nsTextEventReply theReply;
 };
 
+/* Mouse Scroll Events: Line Scrolling, Pixel Scrolling and Common Event Flows
+ *
+ * There are two common event flows:
+ *  (1) Normal line scrolling:
+ *      1. An NS_MOUSE_SCROLL event without kHasPixels is dispatched to Gecko.
+ *      2. A DOMMouseScroll event is sent into the DOM.
+ *      3. A MozMousePixelScroll event is sent into the DOM.
+ *      4. If neither event has been consumed, the default handling of the
+ *         NS_MOUSE_SCROLL event is executed.
+ *
+ *  (2) Pixel scrolling:
+ *      1. An NS_MOUSE_SCROLL event with kHasPixels is dispatched to Gecko.
+ *      2. A DOMMouseScroll event is sent into the DOM.
+ *      3. No scrolling takes place in the default handler.
+ *      4. An NS_MOUSE_PIXEL_SCROLL event is dispatched to Gecko.
+ *      5. A MozMousePixelScroll event is sent into the DOM.
+ *      6. If neither the NS_MOUSE_PIXELSCROLL event nor the preceding
+ *         NS_MOUSE_SCROLL event have been consumed, the default handler scrolls.
+ *      7. Steps 4.-6. are repeated for every pixel scroll that belongs to
+ *         the announced line scroll. Once enough pixels have been sent to
+ *         complete a line, a new NS_MOUSE_SCROLL event is sent (goto step 1.).
+ *
+ * If a DOMMouseScroll event has been preventDefaulted, the associated
+ * following MozMousePixelScroll events are still sent - they just don't result
+ * in any scrolling (their default handler isn't executed).
+ *
+ * How many pixel scrolls make up one line scroll is decided in the widget layer
+ * where the NS_MOUSE(_PIXEL)_SCROLL events are created.
+ *
+ * This event flow model satisfies several requirements:
+ *  - DOMMouseScroll handlers don't need to be aware of the existence of pixel
+ *    scrolling.
+ *  - preventDefault on a DOMMouseScroll event results in no scrolling.
+ *  - DOMMouseScroll events aren't polluted with a kHasPixels flag.
+ *  - You can make use of pixel scroll DOM events (MozMousePixelScroll).
+ */
+
 class nsMouseScrollEvent : public nsMouseEvent_base
 {
 public:
   enum nsMouseScrollFlags {
     kIsFullPage =   1 << 0,
     kIsVertical =   1 << 1,
     kIsHorizontal = 1 << 2,
-    kIsPixels =     1 << 3
+    kHasPixels =    1 << 3  // Marks line scroll events that are provided as
+                            // a fallback for pixel scroll events.
+                            // These scroll events are used by things that can't
+                            // be scrolled pixel-wise, like trees. You should
+                            // ignore them when processing pixel scroll events
+                            // to avoid double-processing the same scroll gesture.
+                            // When kHasPixels is set, the event is guaranteed to
+                            // be followed up by an event that contains pixel
+                            // scrolling information.
   };
 
   nsMouseScrollEvent(PRBool isTrusted, PRUint32 msg, nsIWidget *w)
     : nsMouseEvent_base(isTrusted, msg, w, NS_MOUSE_SCROLL_EVENT),
       scrollFlags(0), delta(0)
   {
   }
 
diff -r 1aecd2a9914d widget/public/nsILookAndFeel.h
--- a/widget/public/nsILookAndFeel.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/public/nsILookAndFeel.h	Thu Sep 18 08:03:25 2008 -0500
@@ -138,17 +138,19 @@ public:
     eColor__moz_menuhover,                                   //used to menu item background, when mouse is over
     eColor__moz_menuhovertext,                               //used to menu item text, when mouse is over
     eColor__moz_menubarhovertext,                            //used to menu bar item text, when mouse is over
     // On platforms where these colors are the same as
     // -moz-field, use -moz-fieldtext as foreground color
     eColor__moz_eventreerow,
     eColor__moz_oddtreerow,
 
-    //colours needed by Mac Classic skin
+    // colors needed by the Mac OS X theme
+    eColor__moz_mac_chrome_active,                          // background color of chrome toolbars in active windows
+    eColor__moz_mac_chrome_inactive,                        // background color of chrome toolbars in inactive windows
     eColor__moz_mac_focusring,				//ring around text fields and lists
     eColor__moz_mac_menuselect,				//colour used when mouse is over a menu item
     eColor__moz_mac_menushadow,				//colour used to do shadows on menu items
     eColor__moz_mac_menutextdisable,                    // color used to display text for disabled menu items
     eColor__moz_mac_menutextselect,			//colour used to display text while mouse is over a menu item
 
   	//all of the accent colours
   	eColor__moz_mac_accentlightesthighlight,
@@ -249,16 +251,25 @@ public:
      * uxtheme)
      *
      * This is Windows-specific and is not implemented on other platforms
      * (will return the default of NS_ERROR_FAILURE).
      */
     eMetric_WindowsClassic,
 
     /*
+     * A Boolean value to determine whether the Mac graphite theme is
+     * being used.
+     *
+     * The value of this metric is not used on other platforms. These platforms
+     * should return NS_ERROR_NOT_IMPLEMENTED when queried for this metric.
+     */
+    eMetric_MacGraphiteTheme,
+
+    /*
      * eMetric_AlertNotificationOrigin indicates from which corner of the
      * screen alerts slide in, and from which direction (horizontal/vertical).
      * 0, the default, represents bottom right, sliding vertically.
      * Use any bitwise combination of the following constants:
      * NS_ALERT_HORIZONTAL (1), NS_ALERT_LEFT (2), NS_ALERT_TOP (4).
      *
      *       6       4
      *     +-----------+
diff -r 1aecd2a9914d widget/public/nsIWidget.h
--- a/widget/public/nsIWidget.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/public/nsIWidget.h	Thu Sep 18 08:03:25 2008 -0500
@@ -88,20 +88,20 @@ typedef nsEventStatus (*PR_CALLBACK EVEN
 #define NS_NATIVE_PLUGIN_PORT 8
 #define NS_NATIVE_SCREEN      9
 #define NS_NATIVE_SHELLWIDGET 10      // Get the shell GtkWidget
 #ifdef XP_MACOSX
 #define NS_NATIVE_PLUGIN_PORT_QD    100
 #define NS_NATIVE_PLUGIN_PORT_CG    101
 #endif
 
-// AE42543F-BF61-4164-96BA-AF8F4EDCEEAD
+// 0e64821f-00a2-4adc-ac3b-3439d61f4491
 #define NS_IWIDGET_IID \
-{ 0xae42543f, 0xbf61, 0x4164, \
-  { 0x96, 0xba, 0xaf, 0x8f, 0x4e, 0xdc, 0xee, 0xad } }
+{ 0x0e64821f, 0x00a2, 0x4adc, \
+  { 0xac, 0x3b, 0x34, 0x39, 0xd6, 0x1f, 0x44, 0x91 } }
 
 // Hide the native window systems real window type so as to avoid
 // including native window system types and APIs. This is necessary
 // to ensure cross-platform code.
 typedef void* nsNativeWidget;
 
 /**
  * Border styles
@@ -377,16 +377,25 @@ class nsIWidget : public nsISupports {
     /**
      * Return the parent Widget of this Widget or nsnull if this is a 
      * top level window
      *
      * @return the parent widget or nsnull if it does not have a parent
      *
      */
     virtual nsIWidget* GetParent(void) = 0;
+
+    /**
+     * Return the top level Widget of this Widget
+     *
+     * @param     aLevelsUp   returns the number of GetParent() calls that
+     *                        were necessary to get to the top level widget
+     * @return the top level widget
+     */
+    virtual nsIWidget* GetTopLevelWidget(PRInt32* aLevelsUp = NULL) = 0;
 
     /**
      * Return the top (non-sheet) parent of this Widget if it's a sheet,
      * or nsnull if this isn't a sheet (or some other error occurred).
      * Sheets are only supported on some platforms (currently only OS X).
      *
      * @return the top (non-sheet) parent widget or nsnull
      *
diff -r 1aecd2a9914d widget/src/beos/nsLookAndFeel.cpp
--- a/widget/src/beos/nsLookAndFeel.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/beos/nsLookAndFeel.cpp	Thu Sep 18 08:03:25 2008 -0500
@@ -422,16 +422,20 @@ NS_IMETHODIMP nsLookAndFeel::GetMetric(c
       aMetric = 3;
       break;
     case eMetric_DWMCompositor:
     case eMetric_WindowsClassic:
     case eMetric_WindowsDefaultTheme:
       aMetric = 0;
       res = NS_ERROR_NOT_IMPLEMENTED;
       break;
+    case eMetric_MacGraphiteTheme:
+      aMetric = 0;
+      res = NS_ERROR_NOT_IMPLEMENTED;
+      break;
     case eMetric_IMERawInputUnderlineStyle:
     case eMetric_IMEConvertedTextUnderlineStyle:
       aMetric = NS_UNDERLINE_STYLE_SOLID;
       break;
     case eMetric_IMESelectedRawTextUnderlineStyle:
     case eMetric_IMESelectedConvertedTextUnderline:
       aMetric = NS_UNDERLINE_STYLE_NONE;
       break;
diff -r 1aecd2a9914d widget/src/cocoa/nsChildView.h
--- a/widget/src/cocoa/nsChildView.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/cocoa/nsChildView.h	Thu Sep 18 08:03:25 2008 -0500
@@ -94,16 +94,32 @@ extern "C" long TSMProcessRawKeyEvent(Ev
 
 // Return Cocoa event's corresponding Carbon event.  Not initialized (on
 // synthetic events) until the OS actually "sends" the event.  This method
 // has been present in the same form since at least OS X 10.2.8.
 - (EventRef)_eventRef;
 
 @end
 
+// Needed to support pixel scrolling.
+// See http://developer.apple.com/qa/qa2005/qa1453.html.
+// kEventMouseScroll is only defined on 10.5+. Using the moz prefix avoids
+// potential symbol conflicts.
+// This should be changed when 10.4 support is dropped.
+enum {
+  mozkEventMouseScroll             = 11
+};
+
+// Support for pixel scroll deltas, not part of NSEvent.h
+// See http://lists.apple.com/archives/cocoa-dev/2007/Feb/msg00050.html
+@interface NSEvent (DeviceDelta)
+  - (float)deviceDeltaX;
+  - (float)deviceDeltaY;
+@end
+
 @interface ChildView : NSView<
 #ifdef ACCESSIBILITY
                               mozAccessible,
 #endif
                               mozView, NSTextInput>
 {
 @private
   NSWindow* mWindow; // shortcut to the top window, [WEAK]
@@ -270,17 +286,16 @@ public:
                               nsNativeWidget aNativeParent = nsnull);
 
   NS_IMETHOD              Destroy();
 
   NS_IMETHOD              Show(PRBool aState);
   NS_IMETHOD              IsVisible(PRBool& outState);
 
   virtual nsIWidget*      GetParent(void);
-  nsIWidget*              GetTopLevelWidget();
 
   NS_IMETHOD              ModalEventFilter(PRBool aRealEvent, void *aEvent,
                                            PRBool *aForWindow);
 
   NS_IMETHOD              ConstrainPosition(PRBool aAllowSlop,
                                             PRInt32 *aX, PRInt32 *aY);
   NS_IMETHOD              Move(PRInt32 aX, PRInt32 aY);
   NS_IMETHOD              Resize(PRInt32 aWidth,PRInt32 aHeight, PRBool aRepaint);
diff -r 1aecd2a9914d widget/src/cocoa/nsChildView.mm
--- a/widget/src/cocoa/nsChildView.mm	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/cocoa/nsChildView.mm	Thu Sep 18 08:03:26 2008 -0500
@@ -171,16 +171,18 @@ nsIWidget         * gRollupWidget   = ns
 
 - (PRBool)processKeyDownEvent:(NSEvent*)theEvent keyEquiv:(BOOL)isKeyEquiv;
 
 - (BOOL)ensureCorrectMouseEventTarget:(NSEvent *)anEvent;
 
 - (void)maybeInitContextMenuTracking;
 
 + (NSEvent*)makeNewCocoaEventWithType:(NSEventType)type fromEvent:(NSEvent*)theEvent;
+
+- (BOOL)isPaintingSuppressed;
 
 #if USE_CLICK_HOLD_CONTEXTMENU
  // called on a timer two seconds after a mouse down to see if we should display
  // a context menu (click-hold)
 - (void)clickHoldCallback:(id)inEvent;
 #endif
 
 #ifdef ACCESSIBILITY
@@ -872,24 +874,16 @@ NS_IMETHODIMP nsChildView::Show(PRBool a
 
 
 nsIWidget*
 nsChildView::GetParent(void)
 {
   return mParentWidget;
 }
 
-nsIWidget*
-nsChildView::GetTopLevelWidget()
-{
-  nsIWidget* current = this;
-  for (nsIWidget* parent = GetParent(); parent ; parent = parent->GetParent())
-    current = parent;
-  return current;
-}
 
 NS_IMETHODIMP nsChildView::ModalEventFilter(PRBool aRealEvent, void *aEvent,
                                             PRBool *aForWindow)
 {
   if (aForWindow)
     *aForWindow = PR_FALSE;
   return NS_ERROR_NOT_IMPLEMENTED;
 }
@@ -2249,16 +2243,20 @@ NSEvent* gLastDragEvent = nil;
                                                           NSStringPboardType,
                                                           NSURLPboardType,
                                                           NSFilesPromisePboardType,
                                                           kWildcardPboardType,
                                                           kCorePboardType_url,
                                                           kCorePboardType_urld,
                                                           kCorePboardType_urln,
                                                           nil]];
+  [[NSNotificationCenter defaultCenter] addObserver:self
+                                           selector:@selector(controlTintChanged)
+                                               name:NSControlTintDidChangeNotification
+                                             object:nil];
 
   return self;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NIL;
 }
 
 
 - (void)dealloc
@@ -2267,16 +2265,18 @@ NSEvent* gLastDragEvent = nil;
 
   [mPendingDirtyRects release];
   [mLastMouseDownEvent release];
   if (mPluginTSMDoc)
     ::DeleteTSMDocument(mPluginTSMDoc);
   
   if (sLastViewEntered == self)
     sLastViewEntered = nil;
+
+  [[NSNotificationCenter defaultCenter] removeObserver:self];
 
   [super dealloc];    
 
   // This sets the current port to _savePort.
   // todo: Only do if a Quickdraw plugin is present in the hierarchy!
   ::SetPort(NULL);
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
@@ -2315,16 +2315,26 @@ NSEvent* gLastDragEvent = nil;
 }
 
 
 // mozView method, set the NSWindow that this view is associated with (even when
 // not in the view hierarchy).
 - (void)setNativeWindow:(NSWindow*)aWindow
 {
   mWindow = aWindow;
+}
+
+
+- (void)controlTintChanged
+{
+  if (!mGeckoChild)
+    return;
+
+  nsGUIEvent guiEvent(PR_TRUE, NS_THEMECHANGED, mGeckoChild);
+  mGeckoChild->DispatchWindowEvent(guiEvent);
 }
 
 
 - (void)setNeedsPendingDisplay
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
   mPendingFullDisplay = YES;
@@ -2716,24 +2726,33 @@ NSEvent* gLastDragEvent = nil;
   // It will set the port back to this port on destruction.
   ::SetPort(NULL);  // todo: only do if a Quickdraw plugin is present in the hierarchy!
   [super lockFocus];
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
 
+- (BOOL)isPaintingSuppressed
+{
+  NSWindow* win = [self window];
+  return ([win isKindOfClass:[ToolbarWindow class]] &&
+          [(ToolbarWindow*)win isPaintingSuppressed]);
+}
+
+
 // The display system has told us that a portion of our view is dirty. Tell
 // gecko to paint it
 - (void)drawRect:(NSRect)aRect
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
   PRBool isVisible;
-  if (!mGeckoChild || NS_FAILED(mGeckoChild->IsVisible(isVisible)) || !isVisible)
+  if (!mGeckoChild || NS_FAILED(mGeckoChild->IsVisible(isVisible)) ||
+      !isVisible || [self isPaintingSuppressed])
     return;
 
   CGContextRef cgContext = (CGContextRef)[[NSGraphicsContext currentContext] graphicsPort];
 
   nsRect geckoBounds;
   mGeckoChild->GetBounds(geckoBounds);
 
   NSRect bounds = [self bounds];
@@ -3485,87 +3504,129 @@ static nsEventStatus SendGeckoMouseEnter
 // Handle an NSScrollWheel event for a single axis only.
 -(void)scrollWheel:(NSEvent*)theEvent forAxis:(enum nsMouseScrollEvent::nsMouseScrollFlags)inAxis
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
   if (!mGeckoChild)
     return;
 
-  float scrollDelta;
-
-  if (inAxis & nsMouseScrollEvent::kIsVertical)
-    scrollDelta = -[theEvent deltaY];
-  else if (inAxis & nsMouseScrollEvent::kIsHorizontal)
-    scrollDelta = -[theEvent deltaX];
-  else
+  float scrollDelta = 0;
+  float scrollDeltaPixels = 0;
+  PRBool checkPixels = PR_TRUE;
+
+  nsCOMPtr<nsIPrefBranch> prefs = do_GetService(NS_PREFSERVICE_CONTRACTID);
+  if (prefs)
+    prefs->GetBoolPref("mousewheel.enable_pixel_scrolling", &checkPixels);
+
+  EventRef theCarbonEvent = [theEvent _eventRef];
+  UInt32 carbonEventKind = theCarbonEvent ? ::GetEventKind(theCarbonEvent) : 0;
+  // Calling deviceDeltaX or deviceDeltaY on theEvent will trigger a Cocoa
+  // assertion and an Objective-C NSInternalInconsistencyException if the
+  // underlying "Carbon" event doesn't contain pixel scrolling information.
+  // For these events, carbonEventKind is kEventMouseWheelMoved instead of
+  // kEventMouseScroll.
+  if (carbonEventKind != mozkEventMouseScroll)
+    checkPixels = PR_FALSE;
+  // Some scrolling devices supports pixel scrolling, e.g. a Macbook
+  // touchpad or a Mighty Mouse. On those devices, [event deviceDeltaX/Y]
+  // contains the amount of pixels to scroll. 
+  if (inAxis & nsMouseScrollEvent::kIsVertical) {
+    scrollDelta       = -[theEvent deltaY];
+    if (checkPixels && (scrollDelta == 0 || scrollDelta != floor(scrollDelta))) {
+      scrollDeltaPixels = -[theEvent deviceDeltaY];
+    }
+  } else if (inAxis & nsMouseScrollEvent::kIsHorizontal) {
+    scrollDelta       = -[theEvent deltaX];
+    if (checkPixels && (scrollDelta == 0 || scrollDelta != floor(scrollDelta))) {
+      scrollDeltaPixels = -[theEvent deviceDeltaX];
+    }
+  } else {
     return; // caller screwed up
-
-  if (scrollDelta == 0)
-    // No sense in firing off a Gecko event.  Note that as of 10.4 Tiger,
-    // a single NSScrollWheel event might result in deltaX = deltaY = 0.
-    return;
-  
-  nsMouseScrollEvent geckoEvent(PR_TRUE, NS_MOUSE_SCROLL, nsnull);
-  [self convertCocoaMouseEvent:theEvent toGeckoEvent:&geckoEvent];
-  geckoEvent.scrollFlags |= inAxis;
-
-  // Gecko only understands how to scroll by an integer value.  Using floor
-  // and ceil is better than truncating the fraction, especially when
-  // |delta| < 1.
-  if (scrollDelta < 0)
-    geckoEvent.delta = (PRInt32)floorf(scrollDelta);
-  else
-    geckoEvent.delta = (PRInt32)ceilf(scrollDelta);
-
-  nsAutoRetainCocoaObject kungFuDeathGrip(self);
-  mGeckoChild->DispatchWindowEvent(geckoEvent);
-  if (!mGeckoChild)
-    return;
-
-  // dispatch scroll wheel carbon event for plugins
-  {
-    EventRef theEvent;
-    OSStatus err = ::MacCreateEvent(NULL,
-                          kEventClassMouse,
-                          kEventMouseWheelMoved,
-                          TicksToEventTime(TickCount()),
-                          kEventAttributeUserEvent,
-                          &theEvent);
-    if (err == noErr) {
-      EventMouseWheelAxis axis;
-      if (inAxis & nsMouseScrollEvent::kIsVertical)
-        axis = kEventMouseWheelAxisY;
-      else if (inAxis & nsMouseScrollEvent::kIsHorizontal)
-        axis = kEventMouseWheelAxisX;
-      
-      SetEventParameter(theEvent,
-                            kEventParamMouseWheelAxis,
-                            typeMouseWheelAxis,
-                            sizeof(EventMouseWheelAxis),
-                            &axis);
-
-      SInt32 delta = (SInt32)-geckoEvent.delta;
-      SetEventParameter(theEvent,
-                            kEventParamMouseWheelDelta,
-                            typeLongInteger,
-                            sizeof(SInt32),
-                            &delta);
-
-      Point mouseLoc;
-      ::GetGlobalMouse(&mouseLoc);
-      SetEventParameter(theEvent,
-                            kEventParamMouseLocation,
-                            typeQDPoint,
-                            sizeof(Point),
-                            &mouseLoc);
-      
-      ::SendEventToEventTarget(theEvent, GetWindowEventTarget((WindowRef)[[self window] windowRef]));
-      ReleaseEvent(theEvent);
-    }
+  }
+
+  BOOL hasPixels = (scrollDeltaPixels != 0);
+
+  if (!hasPixels && scrollDelta == 0)
+    // No sense in firing off a Gecko event.
+     return;
+
+  if (scrollDelta != 0) {
+    // Send the line scroll event.
+    nsMouseScrollEvent geckoEvent(PR_TRUE, NS_MOUSE_SCROLL, nsnull);
+    [self convertCocoaMouseEvent:theEvent toGeckoEvent:&geckoEvent];
+    geckoEvent.scrollFlags |= inAxis;
+
+    if (hasPixels)
+      geckoEvent.scrollFlags |= nsMouseScrollEvent::kHasPixels;
+
+    // Gecko only understands how to scroll by an integer value. Using floor
+    // and ceil is better than truncating the fraction, especially when
+    // |delta| < 1.
+    if (scrollDelta < 0)
+      geckoEvent.delta = (PRInt32)floorf(scrollDelta);
+    else
+      geckoEvent.delta = (PRInt32)ceilf(scrollDelta);
+
+    nsAutoRetainCocoaObject kungFuDeathGrip(self);
+    mGeckoChild->DispatchWindowEvent(geckoEvent);
+    if (!mGeckoChild)
+      return;
+
+    // dispatch scroll wheel carbon event for plugins
+    {
+      EventRef theEvent;
+      OSStatus err = ::MacCreateEvent(NULL,
+                                      kEventClassMouse,
+                                      kEventMouseWheelMoved,
+                                      TicksToEventTime(TickCount()),
+                                      kEventAttributeUserEvent,
+                                      &theEvent);
+      if (err == noErr) {
+        EventMouseWheelAxis axis;
+        if (inAxis & nsMouseScrollEvent::kIsVertical)
+          axis = kEventMouseWheelAxisY;
+        else if (inAxis & nsMouseScrollEvent::kIsHorizontal)
+          axis = kEventMouseWheelAxisX;
+        
+        SetEventParameter(theEvent,
+                          kEventParamMouseWheelAxis,
+                          typeMouseWheelAxis,
+                          sizeof(EventMouseWheelAxis),
+                          &axis);
+        
+        SInt32 delta = (SInt32)-geckoEvent.delta;
+        SetEventParameter(theEvent,
+                          kEventParamMouseWheelDelta,
+                          typeLongInteger,
+                          sizeof(SInt32),
+                          &delta);
+        
+        Point mouseLoc;
+        ::GetGlobalMouse(&mouseLoc);
+        SetEventParameter(theEvent,
+                          kEventParamMouseLocation,
+                          typeQDPoint,
+                          sizeof(Point),
+                          &mouseLoc);
+        
+        ::SendEventToEventTarget(theEvent, GetWindowEventTarget((WindowRef)[[self window] windowRef]));
+        ReleaseEvent(theEvent);
+      }
+    }
+  }
+
+  if (hasPixels) {
+    // Send the pixel scroll event.
+    nsMouseScrollEvent geckoEvent(PR_TRUE, NS_MOUSE_PIXEL_SCROLL, nsnull);
+    [self convertCocoaMouseEvent:theEvent toGeckoEvent:&geckoEvent];
+    geckoEvent.scrollFlags |= inAxis;
+    geckoEvent.delta = NSToIntRound(scrollDeltaPixels);
+    nsAutoRetainCocoaObject kungFuDeathGrip(self);
+    mGeckoChild->DispatchWindowEvent(geckoEvent);
   }
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
 
 -(void)scrollWheel:(NSEvent*)theEvent
 {
diff -r 1aecd2a9914d widget/src/cocoa/nsCocoaWindow.h
--- a/widget/src/cocoa/nsCocoaWindow.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/cocoa/nsCocoaWindow.h	Thu Sep 18 08:03:26 2008 -0500
@@ -42,16 +42,17 @@
 
 #undef DARWIN
 
 #import <Cocoa/Cocoa.h>
 
 #include "nsBaseWidget.h"
 #include "nsPIWidgetCocoa.h"
 #include "nsAutoPtr.h"
+#include "nsNativeThemeColors.h"
 
 class nsCocoaWindow;
 class nsChildView;
 class nsMenuBarX;
 
 typedef struct _nsCocoaWindowList {
   _nsCocoaWindowList() : prev(NULL), window(NULL) {}
   struct _nsCocoaWindowList *prev;
@@ -113,53 +114,80 @@ typedef struct _nsCocoaWindowList {
 - (void)windowDidResize:(NSNotification*)aNotification;
 - (void)sendFocusEvent:(PRUint32)eventType;
 - (nsCocoaWindow*)geckoWidget;
 - (PRBool)toplevelActiveState;
 - (void)sendToplevelActivateEvents;
 - (void)sendToplevelDeactivateEvents;
 @end
 
+struct UnifiedGradientInfo {
+  float titlebarHeight;
+  float toolbarHeight;
+  BOOL windowIsMain;
+  BOOL drawTitlebar; // NO for toolbar, YES for titlebar
+};
+
+// Callback used by the default titlebar and toolbar shading.
+// *aIn == 0 at the top of the titlebar/toolbar, *aIn == 1 at the bottom
+static void unifiedShading(void* aInfo, const float* aIn, float* aOut)
+{
+  UnifiedGradientInfo* info = (UnifiedGradientInfo*)aInfo;
+  // The gradient percentage at the bottom of the titlebar / top of the toolbar
+  float start = info->titlebarHeight / (info->titlebarHeight + info->toolbarHeight - 1);
+  const float startGrey = NativeGreyColorAsFloat(headerStartGrey, info->windowIsMain);
+  const float endGrey = NativeGreyColorAsFloat(headerEndGrey, info->windowIsMain);
+  // *aIn is the gradient percentage of the titlebar or toolbar gradient,
+  // a is the gradient percentage of the whole unified gradient.
+  float a = info->drawTitlebar ? *aIn * start : start + *aIn * (1 - start);
+  float result = (1.0f - a) * startGrey + a * endGrey;
+  aOut[0] = result;
+  aOut[1] = result;
+  aOut[2] = result;
+  aOut[3] = 1.0f;
+}
 
 // NSColor subclass that allows us to draw separate colors both in the titlebar 
 // and for background of the window.
 @interface TitlebarAndBackgroundColor : NSColor
 {
   NSColor *mActiveTitlebarColor;
   NSColor *mInactiveTitlebarColor;
   NSColor *mBackgroundColor;
   NSWindow *mWindow; // [WEAK] (we are owned by the window)
-  float mTitlebarHeight;
 }
 
 - (id)initWithActiveTitlebarColor:(NSColor*)aActiveTitlebarColor
             inactiveTitlebarColor:(NSColor*)aInactiveTitlebarColor
                   backgroundColor:(NSColor*)aBackgroundColor
                         forWindow:(NSWindow*)aWindow;
 
 // Pass nil here to get the default appearance.
 - (void)setTitlebarColor:(NSColor*)aColor forActiveWindow:(BOOL)aActive;
 - (NSColor*)activeTitlebarColor;
 - (NSColor*)inactiveTitlebarColor;
 
 - (void)setBackgroundColor:(NSColor*)aColor;
 - (NSColor*)backgroundColor;
 
 - (NSWindow*)window;
-- (float)titlebarHeight;
 @end
 
 // NSWindow subclass for handling windows with toolbars.
 @interface ToolbarWindow : NSWindow
 {
   TitlebarAndBackgroundColor *mColor;
+  float mUnifiedToolbarHeight;
+  BOOL mSuppressPainting;
 }
 - (void)setTitlebarColor:(NSColor*)aColor forActiveWindow:(BOOL)aActive;
-- (NSColor*)activeTitlebarColor;
-- (NSColor*)inactiveTitlebarColor;
+- (void)setUnifiedToolbarHeight:(float)aToolbarHeight;
+- (float)unifiedToolbarHeight;
+- (float)titlebarHeight;
+- (BOOL)isPaintingSuppressed;
 // This method is also available on NSWindows (via a category), and is the 
 // preferred way to check the background color of a window.
 - (NSColor*)windowBackgroundColor;
 @end
 
 class nsCocoaWindow : public nsBaseWidget, public nsPIWidgetCocoa
 {
 private:
diff -r 1aecd2a9914d widget/src/cocoa/nsCocoaWindow.mm
--- a/widget/src/cocoa/nsCocoaWindow.mm	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/cocoa/nsCocoaWindow.mm	Thu Sep 18 08:03:26 2008 -0500
@@ -1670,42 +1670,73 @@ NS_IMETHODIMP nsCocoaWindow::EndSecureKe
   return [self backgroundColor];
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NIL;
 }
 
 @end
 
 
+@interface ToolbarWindow(Private)
+
+- (void)redrawTitlebar;
+
+@end
+
+
 // This class allows us to have a "unified toolbar" style window. It works like this:
 // 1) We set the window's style to textured.
 // 2) Because of this, the background color applies to the entire window, including
 //     the titlebar area. For normal textured windows, the default pattern is a 
-//    "brushed metal" image.
+//    "brushed metal" image on Tiger and a unified gradient on Leopard.
 // 3) We set the background color to a custom NSColor subclass that knows how tall the window is.
 //    When -set is called on it, it sets a pattern (with a draw callback) as the fill. In that callback,
-//    it paints the the titlebar and background colrs in the correct areas of the context its given,
+//    it paints the the titlebar and background colors in the correct areas of the context it's given,
 //    which will fill the entire window (CG will tile it horizontally for us).
+// 4) Whenever the window's main state changes and when [window display] is called,
+//    Cocoa redraws the titlebar using the patternDraw callback function.
 //
 // This class also provides us with a pill button to show/hide the toolbar.
+//
+// Drawing the unified gradient in the titlebar and the toolbar works like this:
+// 1) In the style sheet we set the toolbar's -moz-appearance to -moz-mac-unified-toolbar.
+// 2) When the toolbar is drawn, Gecko calls nsNativeThemeCocoa::DrawWidgetBackground
+//    for the widget type NS_THEME_MOZ_MAC_UNIFIED_TOOLBAR.
+// 3) This calls DrawUnifiedToolbar which finds the toolbar frame's ToolbarWindow
+//    and passes the toolbar frame's height to setUnifiedToolbarHeight.
+// 4) If the toolbar height has changed, a titlebar redraw is triggered by
+//    [self display] and the upper part of the unified gradient is drawn in the
+//    titlebar.
+// 5) DrawUnifiedToolbar draws the lower part of the unified gradient in the toolbar.
+//
+// Whenever the unified gradient is drawn in the titlebar or the toolbar, both
+// titlebar height and toolbar height must be known in order to construct the
+// correct gradient (which is a linear gradient with the length
+// titlebarHeight + toolbarHeight - 1). But you can only get from the toolbar frame
+// to the containing window - the other direction doesn't work. That's why the
+// toolbar height is cached in the ToolbarWindow but nsNativeThemeCocoa can simply
+// query the window for its titlebar height when drawing the toolbar.
 @implementation ToolbarWindow
 
 - (id)initWithContentRect:(NSRect)aContentRect styleMask:(unsigned int)aStyle backing:(NSBackingStoreType)aBufferingType defer:(BOOL)aFlag
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NIL;
 
   aStyle = aStyle | NSTexturedBackgroundWindowMask;
   if ((self = [super initWithContentRect:aContentRect styleMask:aStyle backing:aBufferingType defer:aFlag])) {
     mColor = [[TitlebarAndBackgroundColor alloc] initWithActiveTitlebarColor:nil
                                                        inactiveTitlebarColor:nil
                                                              backgroundColor:[NSColor whiteColor]
                                                                    forWindow:self];
     // Call the superclass's implementation, to avoid our guard method below.
     [super setBackgroundColor:mColor];
 
+    mUnifiedToolbarHeight = 0.0f;
+    mSuppressPainting = NO;
+
     // setBottomCornerRounded: is a private API call, so we check to make sure
     // we respond to it just in case.
     if ([self respondsToSelector:@selector(setBottomCornerRounded:)])
       [self setBottomCornerRounded:NO];
   }
   return self;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NIL;
@@ -1753,36 +1784,43 @@ NS_IMETHODIMP nsCocoaWindow::EndSecureKe
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
   [mColor setTitlebarColor:aColor forActiveWindow:aActive];
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
-
-- (NSColor*)activeTitlebarColor
+// This is called by nsNativeThemeCocoa.mm's DrawUnifiedToolbar.
+// We need to know the toolbar's height in order to draw the correct
+// unified gradient in the titlebar.
+- (void)setUnifiedToolbarHeight:(float)aToolbarHeight
 {
-  NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NIL;
-
-  return [mColor activeTitlebarColor];
-
-  NS_OBJC_END_TRY_ABORT_BLOCK_NIL;
+  if (mUnifiedToolbarHeight == aToolbarHeight)
+    return;
+  mUnifiedToolbarHeight = aToolbarHeight;
+  [self redrawTitlebar];
 }
 
 
-- (NSColor*)inactiveTitlebarColor
+- (float)unifiedToolbarHeight
 {
-  NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NIL;
-
-  return [mColor inactiveTitlebarColor];
-
-  NS_OBJC_END_TRY_ABORT_BLOCK_NIL;
+  return mUnifiedToolbarHeight;
 }
 
+- (float)titlebarHeight
+{
+  NSRect frameRect = [self frame];
+  return frameRect.size.height - [self contentRectForFrameRect:frameRect].size.height;
+}
+
+- (BOOL)isPaintingSuppressed
+{
+  return mSuppressPainting;
+}
 
 // Always show the toolbar pill button.
 - (BOOL)_hasToolbar
 {
   return YES;
 }
 
 
@@ -1854,16 +1892,29 @@ NS_IMETHODIMP nsCocoaWindow::EndSecureKe
       break;
   }
 
   [super sendEvent:anEvent];
 }
 
 @end
 
+@implementation ToolbarWindow(Private)
+
+// [self display] seems to be the only way to repaint a window's titlebar.
+// The bad thing about it is that it repaints all the window's subviews as well.
+// So we use a guard to prevent unnecessary redrawing.
+- (void)redrawTitlebar
+{
+  mSuppressPainting = YES;
+  [self display];
+  mSuppressPainting = NO;
+}
+
+@end
 
 // Custom NSColor subclass where most of the work takes place for drawing in
 // the titlebar area.
 @implementation TitlebarAndBackgroundColor
 
 - (id)initWithActiveTitlebarColor:(NSColor*)aActiveTitlebarColor
             inactiveTitlebarColor:(NSColor*)aInactiveTitlebarColor
                   backgroundColor:(NSColor*)aBackgroundColor
@@ -1871,21 +1922,16 @@ NS_IMETHODIMP nsCocoaWindow::EndSecureKe
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NIL;
 
   if ((self = [super init])) {
     mActiveTitlebarColor = [aActiveTitlebarColor retain];
     mInactiveTitlebarColor = [aInactiveTitlebarColor retain];
     mBackgroundColor = [aBackgroundColor retain];
     mWindow = aWindow; // weak ref to avoid a cycle
-    NSRect frameRect = [aWindow frame];
-
-    // We cant just use a static because the height can vary by window, and we don't
-    // want to recalculate this every time we draw. A member is the best solution.
-    mTitlebarHeight = frameRect.size.height - [aWindow contentRectForFrameRect:frameRect].size.height;
   }
   return self;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NIL;
 }
 
 
 - (void)dealloc
@@ -1898,93 +1944,56 @@ NS_IMETHODIMP nsCocoaWindow::EndSecureKe
   [super dealloc];
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
 // Our pattern width is 1 pixel. CoreGraphics can cache and tile for us.
 static const float sPatternWidth = 1.0f;
 
-// These are the start and end greys for the default titlebar gradient.
-static const float sLeopardHeaderStartGrey = 196/255.0f;
-static const float sLeopardHeaderEndGrey = 149/255.0f;
-static const float sLeopardHeaderBackgroundStartGrey = 232/255.0f;
-static const float sLeopardHeaderBackgroundEndGrey = 207/255.0f;
-static const float sTigerHeaderStartGrey = 239/255.0f;
-static const float sTigerHeaderEndGrey = 202/255.0f;
-
-// This is the grey for the border at the bottom of the titlebar.
-static const float sLeopardTitlebarBorderGrey = 64/255.0f;
-static const float sLeopardTitlebarBackgroundBorderGrey = 134/255.0f;
-static const float sTigerTitlebarBorderGrey = 140/255.0f;
-
-// Callback used by the default titlebar shading.
-static void headerShading(void* aInfo, const float* aIn, float* aOut)
-{
-  float startGrey, endGrey;
-  BOOL isMain = *(BOOL*)aInfo;
-  if (nsToolkit::OnLeopardOrLater()) {
-    startGrey = isMain ? sLeopardHeaderStartGrey : sLeopardHeaderBackgroundStartGrey;
-    endGrey = isMain ? sLeopardHeaderEndGrey : sLeopardHeaderBackgroundEndGrey;
-  }
-  else {
-    startGrey = sTigerHeaderStartGrey;
-    endGrey = sTigerHeaderEndGrey;
-  }
-  float result = (*aIn) * startGrey + (1.0f - *aIn) * endGrey;
-  aOut[0] = result;
-  aOut[1] = result;
-  aOut[2] = result;
-  aOut[3] = 1.0f;
-}
-
-
 // Callback where all of the drawing for this color takes place.
 void patternDraw(void* aInfo, CGContextRef aContext)
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
   TitlebarAndBackgroundColor *color = (TitlebarAndBackgroundColor*)aInfo;
   NSColor *backgroundColor = [color backgroundColor];
-  NSWindow *window = [color window];
+  ToolbarWindow *window = (ToolbarWindow*)[color window];
   BOOL isMain = [window isMainWindow];
   NSColor *titlebarColor = isMain ? [color activeTitlebarColor] : [color inactiveTitlebarColor];
 
   // Remember: this context is NOT flipped, so the origin is in the bottom left.
-  float titlebarHeight = [color titlebarHeight];
+  float titlebarHeight = [window titlebarHeight];
   float titlebarOrigin = [window frame].size.height - titlebarHeight;
+
+  UnifiedGradientInfo info = { titlebarHeight, [window unifiedToolbarHeight], isMain, YES };
 
   [NSGraphicsContext saveGraphicsState];
   [NSGraphicsContext setCurrentContext:[NSGraphicsContext graphicsContextWithGraphicsPort:aContext flipped:NO]];
 
   // If the titlebar color is nil, draw the default titlebar shading.
   if (!titlebarColor) {
-    // On Tiger when the window is not main, we want to draw a pinstripe pattern instead.
-    if (!nsToolkit::OnLeopardOrLater() && !isMain) {
-      [[NSColor windowBackgroundColor] set];
-      NSRectFill(NSMakeRect(0.0f, titlebarOrigin, 1.0f, titlebarOrigin + titlebarHeight));
-    } else {
-      // Otherwise, create and draw a CGShading that uses headerShading() as its callback.
-      CGFunctionCallbacks callbacks = {0, headerShading, NULL};
-      CGFunctionRef function = CGFunctionCreate(&isMain, 1, NULL, 4, NULL, &callbacks);
-      CGColorSpaceRef colorSpace = CGColorSpaceCreateDeviceRGB();
-      CGShadingRef shading = CGShadingCreateAxial(colorSpace, CGPointMake(0.0f, titlebarOrigin),
-                                                  CGPointMake(0.0f, titlebarOrigin + titlebarHeight),
-                                                  function, NO, NO);
-      CGColorSpaceRelease(colorSpace);
-      CGFunctionRelease(function);
-      CGContextDrawShading(aContext, shading);
-      CGShadingRelease(shading);
-    }
+    // Create and draw a CGShading that uses unifiedShading() as its callback.
+    CGFunctionCallbacks callbacks = {0, unifiedShading, NULL};
+    CGFunctionRef function = CGFunctionCreate(&info, 1, NULL, 4, NULL, &callbacks);
+    CGColorSpaceRef colorSpace = CGColorSpaceCreateDeviceRGB();
+    CGShadingRef shading = CGShadingCreateAxial(colorSpace,
+                                                CGPointMake(0.0f, titlebarOrigin + titlebarHeight),
+                                                CGPointMake(0.0f, titlebarOrigin),
+                                                function, NO, NO);
+    CGColorSpaceRelease(colorSpace);
+    CGFunctionRelease(function);
+    CGContextDrawShading(aContext, shading);
+    CGShadingRelease(shading);
 
     // Draw the one pixel border at the bottom of the titlebar.
-    float borderGrey = !nsToolkit::OnLeopardOrLater() ? sTigerTitlebarBorderGrey :
-      (isMain ? sLeopardTitlebarBorderGrey : sLeopardTitlebarBackgroundBorderGrey);
-    [[NSColor colorWithDeviceWhite:borderGrey alpha:1.0f] set];
-    NSRectFill(NSMakeRect(0.0f, titlebarOrigin, sPatternWidth, 1.0f));
+    if ([window unifiedToolbarHeight] == 0) {
+      [NativeGreyColorAsNSColor(headerBorderGrey, isMain) set];
+      NSRectFill(NSMakeRect(0.0f, titlebarOrigin, sPatternWidth, 1.0f));
+    }
   } else {
     // if the titlebar color is not nil, just set and draw it normally.
     [titlebarColor set];
     NSRectFill(NSMakeRect(0.0f, titlebarOrigin, sPatternWidth, titlebarHeight));
   }
 
   // Draw the background color of the window everywhere but where the titlebar is.
   [backgroundColor set];
@@ -2082,22 +2091,16 @@ void patternDraw(void* aInfo, CGContextR
 
 - (void)set
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
   [self setFill];
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
-}
-
-
-- (float)titlebarHeight
-{
-  return mTitlebarHeight;
 }
 
 @end
 
 
 // This is an internal Apple class, which we need to work around a bug in. It is
 // the class responsible for drawing the titlebar for metal windows. It actually
 // is a few levels deep in the inhertiance graph, but we don't need to know about
diff -r 1aecd2a9914d widget/src/cocoa/nsLookAndFeel.mm
--- a/widget/src/cocoa/nsLookAndFeel.mm	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/cocoa/nsLookAndFeel.mm	Thu Sep 18 08:03:26 2008 -0500
@@ -35,18 +35,20 @@
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 #include "nsLookAndFeel.h"
 #include "nsObjCExceptions.h"
 #include "nsIInternetConfigService.h"
 #include "nsIServiceManager.h"
+#include "nsNativeThemeColors.h"
 
 #import <Carbon/Carbon.h>
+#import <Cocoa/Cocoa.h>
 
 nsLookAndFeel::nsLookAndFeel() : nsXPLookAndFeel()
 {
 }
 
 nsLookAndFeel::~nsLookAndFeel()
 {
 }
@@ -279,16 +281,22 @@ nsresult nsLookAndFeel::NativeGetColor(c
       // XXX There may be a better color for this, but I'm making it
       // the same as WindowText since that's what's currently used where
       // I will use -moz-DialogText.
       res = GetMacTextColor(kThemeTextColorDialogActive, aColor, NS_RGB(0x00,0x00,0x00));
       break;
     case eColor__moz_dragtargetzone:
       //default to lavender if not available
       res = GetMacBrushColor(kThemeBrushDragHilite, aColor, NS_RGB(0x63,0x63,0xCE));
+      break;
+    case eColor__moz_mac_chrome_active:
+    case eColor__moz_mac_chrome_inactive: {
+      int grey = NativeGreyColorAsInt(headerEndGrey, (aID == eColor__moz_mac_chrome_active));
+      aColor = NS_RGB(grey, grey, grey);
+    }
       break;
     case eColor__moz_mac_focusring:
       //default to lavender if not available
       res = GetMacBrushColor(kThemeBrushFocusHighlight, aColor, NS_RGB(0x63,0x63,0xCE));
       break;
     case eColor__moz_mac_menushadow:
       res = GetMacBrushColor(kThemeBrushBevelActiveDark, aColor, NS_RGB(0x88,0x88,0x88));
       break;          
@@ -601,16 +609,19 @@ NS_IMETHODIMP nsLookAndFeel::GetMetric(c
       aMetric = 3;
       break;
     case eMetric_DWMCompositor:
     case eMetric_WindowsClassic:
     case eMetric_WindowsDefaultTheme:
       aMetric = 0;
       res = NS_ERROR_NOT_IMPLEMENTED;
       break;
+    case eMetric_MacGraphiteTheme:
+      aMetric = [NSColor currentControlTint] == NSGraphiteControlTint;
+      break;
     case eMetric_TabFocusModel:
     {
       // we should probably cache this
       CFPropertyListRef fullKeyboardAccessProperty;
       fullKeyboardAccessProperty = ::CFPreferencesCopyValue(CFSTR("AppleKeyboardUIMode"),
                                                             kCFPreferencesAnyApplication,
                                                             kCFPreferencesCurrentUser,
                                                             kCFPreferencesAnyHost);
diff -r 1aecd2a9914d widget/src/cocoa/nsNativeThemeCocoa.h
--- a/widget/src/cocoa/nsNativeThemeCocoa.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/cocoa/nsNativeThemeCocoa.h	Thu Sep 18 08:03:26 2008 -0500
@@ -121,16 +121,19 @@ protected:
                    ThemeButtonAdornment inAdornment, PRInt32 inState);
   void DrawSpinButtons (CGContextRef context, ThemeButtonKind inKind,
                         const HIRect& inBoxRect,
                         PRBool inDisabled, ThemeDrawState inDrawState,
                         ThemeButtonAdornment inAdornment, PRInt32 inState);
   void DrawCheckbox(CGContextRef context, ThemeButtonKind inKind,
                     const HIRect& inBoxRect, PRBool inChecked, 
                     PRBool inDisabled, PRInt32 inState);
+  void DrawUnifiedToolbar(CGContextRef cgContext, const HIRect& inBoxRect,
+                          nsIFrame *aFrame);
+
   // Scrollbars
   void DrawScrollbar(CGContextRef aCGContext, const HIRect& aBoxRect, nsIFrame *aFrame);
   void GetScrollbarPressStates (nsIFrame *aFrame, PRInt32 aButtonStates[]);
   void GetScrollbarDrawInfo (HIThemeTrackDrawInfo& aTdi, nsIFrame *aFrame, 
                              const HIRect& aRect, PRBool aShouldGetButtonStates);
   nsIFrame* GetParentScrollbarFrame(nsIFrame *aFrame);
 
   void DrawCellWithScaling(NSCell *cell,
diff -r 1aecd2a9914d widget/src/cocoa/nsNativeThemeCocoa.mm
--- a/widget/src/cocoa/nsNativeThemeCocoa.mm	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/cocoa/nsNativeThemeCocoa.mm	Thu Sep 18 08:03:26 2008 -0500
@@ -52,16 +52,17 @@
 #include "nsIFrame.h"
 #include "nsIAtom.h"
 #include "nsIEventStateManager.h"
 #include "nsINameSpaceManager.h"
 #include "nsPresContext.h"
 #include "nsILookAndFeel.h"
 #include "nsWidgetAtoms.h"
 #include "nsToolkit.h"
+#include "nsCocoaWindow.h"
 
 #include "gfxContext.h"
 #include "gfxQuartzSurface.h"
 #include "gfxQuartzNativeDrawing.h"
 
 #define DRAW_IN_FRAME_DEBUG 0
 #define SCROLLBARS_VISUAL_DEBUG 0
 
@@ -111,16 +112,29 @@ static void InflateControlRect(NSRect* r
   int controlSize = EnumSizeForCocoaSize(cocoaControlSize);
   const float* buttonMargins = marginSet[osIndex][controlSize];
   rect->origin.x -= buttonMargins[leftMargin];
   rect->origin.y -= buttonMargins[bottomMargin];
   rect->size.width += buttonMargins[leftMargin] + buttonMargins[rightMargin];
   rect->size.height += buttonMargins[bottomMargin] + buttonMargins[topMargin];
 }
 
+static NSWindow* NativeWindowForFrame(nsIFrame* aFrame, int* aLevelsUp = NULL)
+{
+  if (!aFrame)
+    return nil;  
+
+  nsIWidget* widget = aFrame->GetWindow();
+  if (!widget)
+    return nil;
+
+  nsIWidget* topLevelWidget = widget->GetTopLevelWidget(aLevelsUp);
+
+  return (NSWindow*)topLevelWidget->GetNativeData(NS_NATIVE_WINDOW);
+}
 
 NS_IMPL_ISUPPORTS1(nsNativeThemeCocoa, nsITheme)
 
 
 nsNativeThemeCocoa::nsNativeThemeCocoa()
 {
   NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
 
@@ -178,16 +192,25 @@ nsNativeThemeCocoa::DrawCheckbox(CGConte
 
 #if DRAW_IN_FRAME_DEBUG
   CGContextSetRGBFillColor(cgContext, 0.0, 0.0, 0.5, 0.25);
   CGContextFillRect(cgContext, inBoxRect);
 #endif
 
   NS_OBJC_END_TRY_ABORT_BLOCK;
 }
+
+// Limit on the area of destRect (in pixels^2) in DrawCellWithScaling(),
+// above which we don't do any scaling.  This is to avoid crashes in
+// [NSGraphicsContext graphicsContextWithGraphicsPort:flipped:] and
+// CGContextDrawImage(), and also to avoid very poor drawing performance in
+// CGContextDrawImage() (particularly if xscale or yscale is less than but
+// near 1 -- e.g. 0.9).  This value was determined by trial and error, on
+// OS X 10.4.11 and 10.5.4, and on systems with different amounts of RAM.
+#define CELL_SCALING_MAX_AREA 500000
 
 /*
  * Draw the given NSCell into the given cgContext.
  *
  * destRect - the size and position of the resulting control rectangle
  * controlSize - the NSControlSize which will be given to the NSCell before
  *  asking it to render
  * naturalWidth, naturalHeight - The natural dimensions of this control.
@@ -246,24 +269,30 @@ nsNativeThemeCocoa::DrawCellWithScaling(
   {
     yscale = drawRect.size.height / minHeight;
     drawRect.size.height = minHeight;
   }
 
   if (doSaveCTM)
     savedCTM = CGContextGetCTM(cgContext);
 
+  // Fall back to no scaling if the area of our cell (in pixels^2) is too large.
+  if (drawRect.size.width * drawRect.size.height > CELL_SCALING_MAX_AREA)
+    xscale = yscale = 1.0f;
+
   if (xscale == 1.0f && yscale == 1.0f) {
     // Inflate the rect Gecko gave us by the margin for the control.
     InflateControlRect(&drawRect, controlSize, marginSet);
 
     // Set up the graphics context we've been asked to draw to.
     savedContext = [NSGraphicsContext currentContext];
     [NSGraphicsContext setCurrentContext:[NSGraphicsContext graphicsContextWithGraphicsPort:cgContext flipped:YES]];
 
+    // [NSView focusView] may return nil here, but
+    // [NSCell drawWithFrame:inView:] can deal with that.
     [cell drawWithFrame:drawRect inView:[NSView focusView]];
   }
   else {
     float w = ceil(drawRect.size.width);
     float h = ceil(drawRect.size.height);
 
     NSRect tmpRect = NSMakeRect(0.0f, 0.0f, w, h);
 
@@ -281,16 +310,18 @@ nsNativeThemeCocoa::DrawCellWithScaling(
                                              rgb, kCGImageAlphaPremultipliedFirst);
     CGColorSpaceRelease(rgb);
 
     CGContextTranslateCTM(ctx, MAX_FOCUS_RING_WIDTH, MAX_FOCUS_RING_WIDTH);
 
     savedContext = [NSGraphicsContext currentContext];
     [NSGraphicsContext setCurrentContext:[NSGraphicsContext graphicsContextWithGraphicsPort:ctx flipped:YES]];
 
+    // [NSView focusView] may return nil here, but
+    // [NSCell drawWithFrame:inView:] can deal with that.
     [cell drawWithFrame:tmpRect inView:[NSView focusView]];
 
     [NSGraphicsContext setCurrentContext:savedContext];
 
     CGImageRef img = CGBitmapContextCreateImage(ctx);
 
     // Drop the image into the original destination rectangle, scaling to fit
     // XXX in theory we should scale this MAX_FOCUS_RING_WIDTH here by xscale/yscale,
@@ -973,16 +1004,64 @@ nsNativeThemeCocoa::GetParentScrollbarFr
   // Walk our parents to find a scrollbar frame
   nsIFrame *scrollbarFrame = aFrame;
   do {
     if (scrollbarFrame->GetType() == nsWidgetAtoms::scrollbarFrame) break;
   } while ((scrollbarFrame = scrollbarFrame->GetParent()));
   
   // We return null if we can't find a parent scrollbar frame
   return scrollbarFrame;
+}
+
+
+void
+nsNativeThemeCocoa::DrawUnifiedToolbar(CGContextRef cgContext, const HIRect& inBoxRect,
+                                       nsIFrame *aFrame)
+{
+  NS_OBJC_BEGIN_TRY_ABORT_BLOCK;
+
+  float titlebarHeight = 0;
+  int levelsUp = 0;
+  NSWindow* win = NativeWindowForFrame(aFrame, &levelsUp);
+
+  // If the toolbar is directly below the titlebar in the top level view of a ToolbarWindow
+  if ([win isKindOfClass:[ToolbarWindow class]] && levelsUp == 0 &&
+      inBoxRect.origin.y <= 0) {
+    // Consider the titlebar height when calculating the gradient.
+    titlebarHeight = [(ToolbarWindow*)win titlebarHeight];
+    // Notify the window about the toolbar's height so that it can draw the
+    // correct gradient in the titlebar.
+    [(ToolbarWindow*)win setUnifiedToolbarHeight:inBoxRect.size.height];
+  }
+  
+  BOOL isMain = win ? [win isMainWindow] : YES;
+
+  // Draw the gradient
+  UnifiedGradientInfo info = { titlebarHeight, inBoxRect.size.height, isMain, NO };
+  struct CGFunctionCallbacks callbacks = { 0, unifiedShading, NULL };
+  CGFunctionRef function = CGFunctionCreate(&info, 1,  NULL, 4, NULL, &callbacks);
+  float srcY = inBoxRect.origin.y;
+  float dstY = srcY + inBoxRect.size.height - 1;
+  CGColorSpaceRef colorSpace = CGColorSpaceCreateDeviceRGB();
+  CGShadingRef shading = CGShadingCreateAxial(colorSpace,
+                                              CGPointMake(0, srcY),
+                                              CGPointMake(0, dstY), function,
+                                              NO, NO);
+  CGColorSpaceRelease(colorSpace);
+  CGFunctionRelease(function);
+  CGContextClipToRect(cgContext, inBoxRect);
+  CGContextDrawShading(cgContext, shading);
+  CGShadingRelease(shading);
+
+  // Draw the border at the bottom of the toolbar.
+  [NativeGreyColorAsNSColor(headerBorderGrey, isMain) set];
+  NSRectFill(NSMakeRect(inBoxRect.origin.x, inBoxRect.origin.y +
+                        inBoxRect.size.height - 1.0f, inBoxRect.size.width, 1.0f));
+
+  NS_OBJC_END_TRY_ABORT_BLOCK;
 }
 
 
 NS_IMETHODIMP
 nsNativeThemeCocoa::DrawWidgetBackground(nsIRenderingContext* aContext, nsIFrame* aFrame,
                                          PRUint8 aWidgetType, const nsRect& aRect,
                                          const nsRect& aDirtyRect)
 {
@@ -1142,16 +1221,20 @@ nsNativeThemeCocoa::DrawWidgetBackground
                  IsDefaultButton(aFrame), IsDisabled(aFrame),
                  kThemeButtonOn, kThemeAdornmentNone, eventState);
       break;
 
     case NS_THEME_TOOLBAR_SEPARATOR: {
       HIThemeSeparatorDrawInfo sdi = { 0, kThemeStateActive };
       HIThemeDrawSeparator(&macRect, &sdi, cgContext, HITHEME_ORIENTATION);
     }
+      break;
+
+    case NS_THEME_MOZ_MAC_UNIFIED_TOOLBAR:
+      DrawUnifiedToolbar(cgContext, macRect, aFrame);
       break;
 
     case NS_THEME_TOOLBAR:
     case NS_THEME_TOOLBOX:
     case NS_THEME_STATUSBAR: {
       HIThemeHeaderDrawInfo hdi = { 0, kThemeStateActive, kHIThemeHeaderKindWindow };
       HIThemeDrawHeader(&macRect, &hdi, cgContext, HITHEME_ORIENTATION);
     }
@@ -1431,16 +1514,20 @@ nsNativeThemeCocoa::GetWidgetBorder(nsID
 
         if (isHorizontal)
           aResult->SizeTo(endcapSize, 0, 0, 0);
         else
           aResult->SizeTo(0, endcapSize, 0, 0);
       }
       break;
     }
+
+    case NS_THEME_MOZ_MAC_UNIFIED_TOOLBAR:
+      aResult->SizeTo(0, 0, 1, 0);
+      break;
   }
 
   return NS_OK;
 
   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
 }
 
 
@@ -1743,16 +1830,17 @@ NS_IMETHODIMP
 NS_IMETHODIMP
 nsNativeThemeCocoa::WidgetStateChanged(nsIFrame* aFrame, PRUint8 aWidgetType, 
                                      nsIAtom* aAttribute, PRBool* aShouldRepaint)
 {
   // Some widget types just never change state.
   switch (aWidgetType) {
     case NS_THEME_TOOLBOX:
     case NS_THEME_TOOLBAR:
+    case NS_THEME_MOZ_MAC_UNIFIED_TOOLBAR:
     case NS_THEME_TOOLBAR_BUTTON:
     case NS_THEME_SCROLLBAR_TRACK_VERTICAL: 
     case NS_THEME_SCROLLBAR_TRACK_HORIZONTAL:
     case NS_THEME_STATUSBAR:
     case NS_THEME_STATUSBAR_PANEL:
     case NS_THEME_STATUSBAR_RESIZER_PANEL:
     case NS_THEME_TOOLTIP:
     case NS_THEME_TAB_PANELS:
@@ -1833,16 +1921,17 @@ nsNativeThemeCocoa::ThemeSupportsWidget(
     case NS_THEME_RADIO:
     case NS_THEME_RADIO_SMALL:
     case NS_THEME_RADIO_CONTAINER:
     case NS_THEME_GROUPBOX:
     case NS_THEME_BUTTON:
     case NS_THEME_BUTTON_BEVEL:
     case NS_THEME_SPINNER:
     case NS_THEME_TOOLBAR:
+    case NS_THEME_MOZ_MAC_UNIFIED_TOOLBAR:
     case NS_THEME_STATUSBAR:
     case NS_THEME_TEXTFIELD:
     case NS_THEME_TEXTFIELD_MULTILINE:
     //case NS_THEME_TOOLBOX:
     //case NS_THEME_TOOLBAR_BUTTON:
     case NS_THEME_PROGRESSBAR:
     case NS_THEME_PROGRESSBAR_VERTICAL:
     case NS_THEME_PROGRESSBAR_CHUNK:
diff -r 1aecd2a9914d widget/src/gtk2/Makefile.in
--- a/widget/src/gtk2/Makefile.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/gtk2/Makefile.in	Thu Sep 18 08:03:26 2008 -0500
@@ -147,17 +147,17 @@ EXTRA_DSO_LDOPTS += \
 		$(XLDFLAGS) \
 		$(XLIBS) \
 		$(MOZ_GTK2_LIBS) \
 		-lthebes \
 		$(LCMS_LIBS) \
 		$(NULL)
 
 ifdef MOZ_X11
-EXTRA_DSO_LDOPTS += -lgtkxtbin
+EXTRA_DSO_LDOPTS += -lgtkxtbin -lXrender
 endif
 
 EXPORTS		= \
                 nsGTKToolkit.h \
 		nsIImageToPixbuf.h \
 		mozdrawingarea.h \
 		mozcontainer.h \
 		$(NULL)
diff -r 1aecd2a9914d widget/src/gtk2/nsLookAndFeel.cpp
--- a/widget/src/gtk2/nsLookAndFeel.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/gtk2/nsLookAndFeel.cpp	Thu Sep 18 08:03:26 2008 -0500
@@ -555,16 +555,20 @@ NS_IMETHODIMP nsLookAndFeel::GetMetric(c
         aMetric = 3;
         break;
     case eMetric_DWMCompositor:
     case eMetric_WindowsClassic:
     case eMetric_WindowsDefaultTheme:
         aMetric = 0;
         res = NS_ERROR_NOT_IMPLEMENTED;
         break;
+    case eMetric_MacGraphiteTheme:
+        aMetric = 0;
+        res = NS_ERROR_NOT_IMPLEMENTED;
+        break;
     case eMetric_IMERawInputUnderlineStyle:
     case eMetric_IMEConvertedTextUnderlineStyle:
         aMetric = NS_UNDERLINE_STYLE_SOLID;
         break;
     case eMetric_IMESelectedRawTextUnderlineStyle:
     case eMetric_IMESelectedConvertedTextUnderline:
         aMetric = NS_UNDERLINE_STYLE_NONE;
         break;
diff -r 1aecd2a9914d widget/src/gtk2/nsWidgetFactory.cpp
--- a/widget/src/gtk2/nsWidgetFactory.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/gtk2/nsWidgetFactory.cpp	Thu Sep 18 08:03:26 2008 -0500
@@ -97,20 +97,51 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsHTMLFor
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsHTMLFormatConverter)
 #ifdef MOZ_X11
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsClipboardHelper)
 NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsClipboard, Init)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsDragService)
 #endif
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsSound)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsScreenManagerGtk)
+NS_GENERIC_FACTORY_CONSTRUCTOR(nsImageToPixbuf)
+
+
 #ifdef NATIVE_THEME_SUPPORT
-NS_GENERIC_FACTORY_CONSTRUCTOR(nsNativeThemeGTK)
+// from nsWindow.cpp
+extern PRBool gDisableNativeTheme;
+
+static NS_IMETHODIMP
+nsNativeThemeGTKConstructor(nsISupports *aOuter, REFNSIID aIID,
+                            void **aResult)
+{
+    nsresult rv;
+    nsNativeThemeGTK * inst;
+
+    if (gDisableNativeTheme)
+        return NS_ERROR_NO_INTERFACE;
+
+    *aResult = NULL;
+    if (NULL != aOuter) {
+        rv = NS_ERROR_NO_AGGREGATION;
+        return rv;
+    }
+
+    NS_NEWXPCOM(inst, nsNativeThemeGTK);
+    if (NULL == inst) {
+        rv = NS_ERROR_OUT_OF_MEMORY;
+        return rv;
+    }
+    NS_ADDREF(inst);
+    rv = inst->QueryInterface(aIID, aResult);
+    NS_RELEASE(inst);
+
+    return rv;
+}
 #endif
-NS_GENERIC_FACTORY_CONSTRUCTOR(nsImageToPixbuf)
 
 #if defined(NS_OSSO)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsIdleServiceOSSO)
 #elif defined(MOZ_X11)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsIdleServiceGTK)
 #endif
 
 #ifdef NS_PRINTING
diff -r 1aecd2a9914d widget/src/gtk2/nsWindow.cpp
--- a/widget/src/gtk2/nsWindow.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/gtk2/nsWindow.cpp	Thu Sep 18 08:03:26 2008 -0500
@@ -334,16 +334,30 @@ typedef void (*_gdk_window_set_urgency_h
 typedef void (*_gdk_window_set_urgency_hint_fn)(GdkWindow *window,
                                                 gboolean urgency);
 
 #define kWindowPositionSlop 20
 
 // cursor cache
 static GdkCursor *gCursorCache[eCursorCount];
 
+// Global update pixmap
+static PRBool gUseBufferPixmap = PR_FALSE;
+static GdkPixmap *gBufferPixmap = nsnull;
+static gfxIntSize gBufferPixmapSize(0,0);
+static gfxIntSize gBufferPixmapMaxSize(0,0);
+static int gBufferPixmapUsageCount = 0;
+
+// imported in nsWidgetFactory.cpp
+PRBool gDisableNativeTheme = PR_FALSE;
+
+// If this is 1, then a 24bpp buffer surface is always
+// created for exposes, even if the display has a different depth
+static PRBool gForce24bpp = PR_FALSE;
+
 nsWindow::nsWindow()
 {
     mContainer           = nsnull;
     mDrawingarea         = nsnull;
     mShell               = nsnull;
     mWindowGroup         = nsnull;
     mContainerGotFocus   = PR_FALSE;
     mContainerLostFocus  = PR_FALSE;
@@ -396,16 +410,27 @@ nsWindow::nsWindow()
     mDFBCursorX     = 0;
     mDFBCursorY     = 0;
 
     mDFBCursorCount = 0;
 
     mDFB            = NULL;
     mDFBLayer       = NULL;
 #endif
+
+    
+    if (gUseBufferPixmap) {
+        if (gBufferPixmapMaxSize.width == 0) {
+            gBufferPixmapMaxSize.width = gdk_screen_width();
+            gBufferPixmapMaxSize.height = gdk_screen_height();
+        }
+
+        gBufferPixmapUsageCount++;
+    }
+
 }
 
 nsWindow::~nsWindow()
 {
     LOG(("nsWindow::~nsWindow() [%p]\n", (void *)this));
     if (mLastDragMotionWindow == this) {
         mLastDragMotionWindow = NULL;
     }
@@ -470,17 +495,29 @@ nsWindow::Destroy(void)
 nsWindow::Destroy(void)
 {
     if (mIsDestroyed || !mCreated)
         return NS_OK;
 
     LOG(("nsWindow::Destroy [%p]\n", (void *)this));
     mIsDestroyed = PR_TRUE;
     mCreated = PR_FALSE;
-    
+
+    if (gUseBufferPixmap &&
+        gBufferPixmapUsageCount &&
+        --gBufferPixmapUsageCount == 0)
+    {
+        if (gBufferPixmap)
+            g_object_unref(G_OBJECT(gBufferPixmap));
+
+        gBufferPixmap = nsnull;
+        gBufferPixmapSize.width = 0;
+        gBufferPixmapSize.height = 0;
+    }
+
     g_signal_handlers_disconnect_by_func(gtk_settings_get_default(),
                                          (gpointer)G_CALLBACK(theme_changed_cb),
                                          this);
 
     // ungrab if required
     nsCOMPtr<nsIWidget> rollupWidget = do_QueryReferent(gRollupWindow);
     if (static_cast<nsIWidget *>(this) == rollupWidget.get()) {
         if (gRollupListener)
@@ -1774,17 +1811,20 @@ nsWindow::OnExposeEvent(GtkWidget *aWidg
     if (NS_UNLIKELY(!rc)) {
         g_free(rects);
         return FALSE;
     }
 
     PRBool translucent;
     translucent = eTransparencyTransparent == GetTransparencyMode();
     nsIntRect boundsRect;
+
     GdkPixmap* bufferPixmap = nsnull;
+    gfxIntSize bufferPixmapSize;
+
     nsRefPtr<gfxASurface> bufferPixmapSurface;
 
     updateRegion->GetBoundingBox(&boundsRect.x, &boundsRect.y,
                                  &boundsRect.width, &boundsRect.height);
 
     // do double-buffering and clipping here
     nsRefPtr<gfxContext> ctx = rc->ThebesContext();
     ctx->Save();
@@ -1802,30 +1842,66 @@ nsWindow::OnExposeEvent(GtkWidget *aWidg
         }
     }
     ctx->Clip();
 
     // double buffer
     if (translucent) {
         ctx->PushGroup(gfxASurface::CONTENT_COLOR_ALPHA);
     } else {
-#ifdef MOZ_ENABLE_GLITZ
-        ctx->PushGroup(gfxASurface::CONTENT_COLOR);
-#else // MOZ_ENABLE_GLITZ
         // Instead of just doing PushGroup we're going to do a little dance
         // to ensure that GDK creates the pixmap, so it doesn't go all
         // XGetGeometry on us in gdk_pixmap_foreign_new_for_display when we
         // paint native themes
-        GdkDrawable* d = GDK_DRAWABLE(mDrawingarea->inner_window);
-        gint depth = gdk_drawable_get_depth(d);
-        bufferPixmap = gdk_pixmap_new(d, boundsRect.width, boundsRect.height, depth);
+        gint depth;
+
+        if (gForce24bpp) {
+            depth = 24; // 24 always
+        } else {
+            depth = gdk_drawable_get_depth(GDK_DRAWABLE(mDrawingarea->inner_window));
+        }
+
+        if (!gUseBufferPixmap ||
+            boundsRect.width > gBufferPixmapMaxSize.width ||
+            boundsRect.height > gBufferPixmapMaxSize.height)
+        {
+            // create a one-off always if we're not using the global pixmap
+            // if gUseBufferPixmap == TRUE, who's redrawing an area bigger than the screen?
+            bufferPixmap = gdk_pixmap_new(GDK_DRAWABLE(mDrawingarea->inner_window),
+                                          boundsRect.width, boundsRect.height,
+                                          depth);
+            bufferPixmapSize.width = boundsRect.width;
+            bufferPixmapSize.height = boundsRect.height;
+        } else if (boundsRect.width > gBufferPixmapSize.width ||
+                   boundsRect.height > gBufferPixmapSize.height)
+        {
+            // grow the global pixmap
+            if (gBufferPixmap)
+                g_object_unref(G_OBJECT(gBufferPixmap));
+
+            gBufferPixmapSize.width = PR_MAX(gBufferPixmapSize.width, boundsRect.width);
+            gBufferPixmapSize.height = PR_MAX(gBufferPixmapSize.height, boundsRect.height);
+
+            gBufferPixmap = gdk_pixmap_new(GDK_DRAWABLE(mDrawingarea->inner_window),
+                                           gBufferPixmapSize.width, gBufferPixmapSize.height,
+                                           depth);
+
+            // use the newly-resized global
+            bufferPixmap = gBufferPixmap;
+            bufferPixmapSize = gBufferPixmapSize;
+        }  else {
+            // global's big enough, just use it
+            bufferPixmap = gBufferPixmap;
+            bufferPixmapSize = gBufferPixmapSize;
+        }
 
         if (bufferPixmap) {
             bufferPixmapSurface = GetSurfaceForGdkDrawable(GDK_DRAWABLE(bufferPixmap),
-                                                           boundsRect.Size());
+                                                           nsSize(bufferPixmapSize.width, bufferPixmapSize.height));
+
             if (bufferPixmapSurface && bufferPixmapSurface->CairoStatus()) {
                 bufferPixmapSurface = nsnull;
             }
             if (bufferPixmapSurface) {
                 gfxPlatformGtk::GetPlatform()->SetGdkDrawable(
                         static_cast<gfxASurface *>(bufferPixmapSurface), 
                         GDK_DRAWABLE(bufferPixmap));
 
@@ -1840,17 +1916,16 @@ nsWindow::OnExposeEvent(GtkWidget *aWidg
                     if (NS_FAILED(rv)) {
                         bufferPixmapSurface = nsnull;
                     } else {
                         rc = newRC;
                     }
                 }
             }
         }
-#endif // MOZ_ENABLE_GLITZ
     }
 
 #if 0
     // NOTE: Paint flashing region would be wrong for cairo, since
     // cairo inflates the update region, etc.  So don't paint flash
     // for cairo.
 #ifdef DEBUG
     if (WANT_PAINT_FLASHING && aEvent->window)
@@ -1894,40 +1969,31 @@ nsWindow::OnExposeEvent(GtkWidget *aWidg
                         imgCtx->Paint();
                     }
 
                     UpdateTranslucentWindowAlphaInternal(nsRect(boundsRect.x, boundsRect.y,
                                                                 boundsRect.width, boundsRect.height),
                                                          img->Data(), img->Stride());
                 }
             } else {
-#ifdef MOZ_ENABLE_GLITZ
-                ctx->PopGroupToSource();
-                ctx->Paint();
-#else // MOZ_ENABLE_GLITZ
                 if (bufferPixmapSurface) {
+                    ctx->SetOperator(gfxContext::OPERATOR_SOURCE);
                     ctx->SetSource(bufferPixmapSurface);
                     ctx->Paint();
                 }
-#endif // MOZ_ENABLE_GLITZ
             }
         } else {
             // ignore
-            if (translucent) {
+            if (translucent)
                 ctx->PopGroup();
-            } else {
-#ifdef MOZ_ENABLE_GLITZ
-                ctx->PopGroup();
-#endif // MOZ_ENABLE_GLITZ
-            }
-        }
-
-        if (bufferPixmap) {
+        }
+
+        // if we had to allocate a local pixmap, free it here
+        if (bufferPixmap && bufferPixmap != gBufferPixmap)
             g_object_unref(G_OBJECT(bufferPixmap));
-        }
 
         ctx->Restore();
     }
 #endif // MOZ_X11
 
 #ifdef MOZ_DFB
     ctx->Restore();
 #endif
@@ -5282,26 +5348,38 @@ drag_data_received_event_cb(GtkWidget *a
                                     aSelectionData,
                                     aInfo, aTime, aData);
 }
 
 /* static */
 nsresult
 initialize_prefs(void)
 {
-    // check to see if we should set our raise pref
     nsCOMPtr<nsIPrefBranch> prefs = do_GetService(NS_PREFSERVICE_CONTRACTID);
     if (!prefs)
         return NS_OK;
 
     PRBool val = PR_TRUE;
     nsresult rv;
+
     rv = prefs->GetBoolPref("mozilla.widget.raise-on-setfocus", &val);
     if (NS_SUCCEEDED(rv))
         gRaiseWindows = val;
+
+    rv = prefs->GetBoolPref("mozilla.widget.force-24bpp", &val);
+    if (NS_SUCCEEDED(rv))
+        gForce24bpp = val;
+
+    rv = prefs->GetBoolPref("mozilla.widget.use-buffer-pixmap", &val);
+    if (NS_SUCCEEDED(rv))
+        gUseBufferPixmap = val;
+
+    rv = prefs->GetBoolPref("mozilla.widget.disable-native-theme", &val);
+    if (NS_SUCCEEDED(rv))
+        gDisableNativeTheme = val;
 
     return NS_OK;
 }
 
 void
 nsWindow::ResetDragMotionTimer(GtkWidget *aWidget,
                                GdkDragContext *aDragContext,
                                gint aX, gint aY, guint aTime)
@@ -6496,22 +6574,46 @@ IM_get_input_context(nsWindow *aWindow)
 #endif
 
 #ifdef MOZ_X11
 /* static */ already_AddRefed<gfxASurface>
 nsWindow::GetSurfaceForGdkDrawable(GdkDrawable* aDrawable,
                                    const nsSize& aSize)
 {
     GdkVisual* visual = gdk_drawable_get_visual(aDrawable);
-    Visual* xVisual = gdk_x11_visual_get_xvisual(visual);
     Display* xDisplay = gdk_x11_drawable_get_xdisplay(aDrawable);
     Drawable xDrawable = gdk_x11_drawable_get_xid(aDrawable);
 
-    gfxASurface* result = new gfxXlibSurface(xDisplay, xDrawable, xVisual,
-                                       gfxIntSize(aSize.width, aSize.height));
+    gfxASurface* result = nsnull;
+
+    if (visual) {
+        Visual* xVisual = gdk_x11_visual_get_xvisual(visual);
+
+        result = new gfxXlibSurface(xDisplay, xDrawable, xVisual,
+                                    gfxIntSize(aSize.width, aSize.height));
+    } else {
+        // no visual? we must be using an xrender format.  Find a format
+        // for this depth.
+        XRenderPictFormat *pf = NULL;
+        switch (gdk_drawable_get_depth(aDrawable)) {
+            case 32:
+                pf = XRenderFindStandardFormat(xDisplay, PictStandardARGB32);
+                break;
+            case 24:
+                pf = XRenderFindStandardFormat(xDisplay, PictStandardRGB24);
+                break;
+            default:
+                NS_ERROR("Don't know how to handle the given depth!");
+                break;
+        }
+
+        result = new gfxXlibSurface(xDisplay, xDrawable, pf,
+                                    gfxIntSize(aSize.width, aSize.height));
+    }
+
     NS_IF_ADDREF(result);
     return result;
 }
 #endif
 
 // return the gfxASurface for rendering to this widget
 gfxASurface*
 nsWindow::GetThebesSurface()
diff -r 1aecd2a9914d widget/src/os2/nsLookAndFeel.cpp
--- a/widget/src/os2/nsLookAndFeel.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/os2/nsLookAndFeel.cpp	Thu Sep 18 08:03:26 2008 -0500
@@ -370,16 +370,20 @@ NS_IMETHODIMP nsLookAndFeel::GetMetric(c
         aMetric = 3;
         break;
     case eMetric_DWMCompositor:
     case eMetric_WindowsClassic:
     case eMetric_WindowsDefaultTheme:
         aMetric = 0;
         res = NS_ERROR_NOT_IMPLEMENTED;
         break;
+    case eMetric_MacGraphiteTheme:
+        aMetric = 0;
+        res = NS_ERROR_NOT_IMPLEMENTED;
+        break;
     case eMetric_IMERawInputUnderlineStyle:
     case eMetric_IMEConvertedTextUnderlineStyle:
         aMetric = NS_UNDERLINE_STYLE_SOLID;
         break;
     case eMetric_IMESelectedRawTextUnderlineStyle:
     case eMetric_IMESelectedConvertedTextUnderline:
         aMetric = NS_UNDERLINE_STYLE_NONE;
         break;
diff -r 1aecd2a9914d widget/src/photon/nsLookAndFeel.cpp
--- a/widget/src/photon/nsLookAndFeel.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/photon/nsLookAndFeel.cpp	Thu Sep 18 08:03:26 2008 -0500
@@ -364,16 +364,20 @@ NS_IMETHODIMP nsLookAndFeel::GetMetric(c
     aMetric = 3;
     break;
   case eMetric_DWMCompositor:
   case eMetric_WindowsClassic:
   case eMetric_WindowsDefaultTheme:
     aMetric = 0;
     res = NS_ERROR_NOT_IMPLEMENTED;
     break;
+  case eMetric_MacGraphiteTheme:
+    aMetric = 0;
+    res = NS_ERROR_NOT_IMPLEMENTED;
+    break;
   case eMetric_IMERawInputUnderlineStyle:
   case eMetric_IMEConvertedTextUnderlineStyle:
     aMetric = NS_UNDERLINE_STYLE_SOLID;
     break;
   case eMetric_IMESelectedRawTextUnderlineStyle:
   case eMetric_IMESelectedConvertedTextUnderline:
     aMetric = NS_UNDERLINE_STYLE_NONE;
     break;
diff -r 1aecd2a9914d widget/src/qt/nsNativeThemeQt.cpp
--- a/widget/src/qt/nsNativeThemeQt.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/qt/nsNativeThemeQt.cpp	Thu Sep 18 08:03:26 2008 -0500
@@ -255,38 +255,49 @@ nsNativeThemeQt::DrawWidgetBackground(ns
             contentRect.adjust(mFrameWidth, mFrameWidth, -mFrameWidth, -mFrameWidth);
             qPainter->fillRect(contentRect, QBrush(Qt::white));
         }
         
         frameOpt.palette = mNoBackgroundPalette;
         style->drawPrimitive(QStyle::PE_FrameLineEdit, &frameOpt, qPainter, NULL);
         break;
     }
+    case NS_THEME_MENUPOPUP: {
+        QStyleOptionMenuItem option;
+        InitPlainStyle(aWidgetType, aFrame, r, (QStyleOption&)option, extraFlags);
+        style->drawPrimitive(QStyle::PE_FrameMenu, &option, qPainter, NULL);
+        break;
+    }
     default:
         break;
     }
 
     qPainter->restore();
     return NS_OK;
 }
 
 NS_IMETHODIMP
 nsNativeThemeQt::GetWidgetBorder(nsIDeviceContext* aContext,
                                  nsIFrame* aFrame,
                                  PRUint8 aWidgetType,
                                  nsMargin* aResult)
 {
     (*aResult).top = (*aResult).bottom = (*aResult).left = (*aResult).right = 0;
 
-//     switch(aWidgetType) {
+    QStyle* style = qApp->style();
+    switch(aWidgetType) {
 //     case NS_THEME_TEXTFIELD:
 //     case NS_THEME_LISTBOX:
-//         (*aResult).top = (*aResult).bottom = (*aResult).left = (*aResult).right =
-//                          frameWidth;
-//     }
+    case NS_THEME_MENUPOPUP: {
+       (*aResult).top = (*aResult).bottom = (*aResult).left = (*aResult).right = style->pixelMetric(QStyle::PM_MenuPanelWidth);
+       break;
+    }
+    default:
+        break;
+    }
 
     return NS_OK;
 }
 
 PRBool
 nsNativeThemeQt::GetWidgetPadding(nsIDeviceContext* ,
                                   nsIFrame*, PRUint8 aWidgetType,
                                   nsMargin* aResult)
@@ -510,16 +521,17 @@ nsNativeThemeQt::ThemeSupportsWidget(nsP
     case NS_THEME_BUTTON:
     case NS_THEME_DROPDOWN:
     case NS_THEME_DROPDOWN_BUTTON:
     case NS_THEME_DROPDOWN_TEXT:
     case NS_THEME_DROPDOWN_TEXTFIELD:
     case NS_THEME_TEXTFIELD:
     case NS_THEME_TEXTFIELD_MULTILINE:
     case NS_THEME_LISTBOX:
+    case NS_THEME_MENUPOPUP:
         return !IsWidgetStyled(aPresContext, aFrame, aWidgetType);
     default:
         break;
     }
     return PR_FALSE;
 }
 
 PRBool
diff -r 1aecd2a9914d widget/src/windows/nsLookAndFeel.cpp
--- a/widget/src/windows/nsLookAndFeel.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/windows/nsLookAndFeel.cpp	Thu Sep 18 08:03:26 2008 -0500
@@ -517,16 +517,20 @@ NS_IMETHODIMP nsLookAndFeel::GetMetric(c
             res = NS_ERROR_NOT_IMPLEMENTED;
           }
         } else
 #endif
         {
           res = NS_ERROR_NOT_IMPLEMENTED;
         }
         break;
+    case eMetric_MacGraphiteTheme:
+        aMetric = 0;
+        res = NS_ERROR_NOT_IMPLEMENTED;
+        break;
 #ifndef WINCE
     case eMetric_DWMCompositor:
         aMetric = nsUXThemeData::sHaveCompositor;
         break;
     case eMetric_AlertNotificationOrigin:
         aMetric = 0;
         if (gSHAppBarMessage)
         {
diff -r 1aecd2a9914d widget/src/xpwidgets/nsBaseWidget.cpp
--- a/widget/src/xpwidgets/nsBaseWidget.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/xpwidgets/nsBaseWidget.cpp	Thu Sep 18 08:03:26 2008 -0500
@@ -282,16 +282,35 @@ NS_IMETHODIMP nsBaseWidget::SetParent(ns
 //-------------------------------------------------------------------------
 //
 // Get this nsBaseWidget parent
 //
 //-------------------------------------------------------------------------
 nsIWidget* nsBaseWidget::GetParent(void)
 {
   return nsnull;
+}
+
+//-------------------------------------------------------------------------
+//
+// Get this nsBaseWidget top level widget
+//
+//-------------------------------------------------------------------------
+nsIWidget* nsBaseWidget::GetTopLevelWidget(PRInt32* aLevelsUp)
+{
+  nsIWidget *topLevelWidget, *widget = this;
+  if (aLevelsUp)
+    *aLevelsUp = -1;
+  while (widget) {
+    topLevelWidget = widget;
+    widget = widget->GetParent();
+    if (aLevelsUp)
+      ++*aLevelsUp;
+  }
+  return topLevelWidget;
 }
 
 //-------------------------------------------------------------------------
 //
 // Get this nsBaseWidget's top (non-sheet) parent (if it's a sheet)
 //
 //-------------------------------------------------------------------------
 nsIWidget* nsBaseWidget::GetSheetWindowParent(void)
diff -r 1aecd2a9914d widget/src/xpwidgets/nsBaseWidget.h
--- a/widget/src/xpwidgets/nsBaseWidget.h	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/xpwidgets/nsBaseWidget.h	Thu Sep 18 08:03:26 2008 -0500
@@ -76,16 +76,17 @@ public:
   NS_IMETHOD              CaptureMouse(PRBool aCapture);
   NS_IMETHOD              Validate();
   NS_IMETHOD              InvalidateRegion(const nsIRegion *aRegion, PRBool aIsSynchronous);
   NS_IMETHOD              GetClientData(void*& aClientData);
   NS_IMETHOD              SetClientData(void* aClientData);
   NS_IMETHOD              Destroy();
   NS_IMETHOD              SetParent(nsIWidget* aNewParent);
   virtual nsIWidget*      GetParent(void);
+  virtual nsIWidget*      GetTopLevelWidget(PRInt32* aLevelsUp = NULL);
   virtual nsIWidget*      GetSheetWindowParent(void);
   virtual void            AddChild(nsIWidget* aChild);
   virtual void            RemoveChild(nsIWidget* aChild);
 
   NS_IMETHOD              SetZIndex(PRInt32 aZIndex);
   NS_IMETHOD              GetZIndex(PRInt32* aZIndex);
   NS_IMETHOD              PlaceBehind(nsTopLevelWidgetZPlacement aPlacement,
                                       nsIWidget *aWidget, PRBool aActivate);
diff -r 1aecd2a9914d widget/src/xpwidgets/nsXPLookAndFeel.cpp
--- a/widget/src/xpwidgets/nsXPLookAndFeel.cpp	Tue Sep 16 16:40:57 2008 +1200
+++ b/widget/src/xpwidgets/nsXPLookAndFeel.cpp	Thu Sep 18 08:03:26 2008 -0500
@@ -470,16 +470,22 @@ nsXPLookAndFeel::IsSpecialColor(const ns
     case eColor_IMESelectedConvertedTextForeground:
     case eColor_IMERawInputForeground:
     case eColor_IMEConvertedTextForeground:
     case eColor_IMERawInputUnderline:
     case eColor_IMEConvertedTextUnderline:
     case eColor_IMESelectedRawTextUnderline:
     case eColor_IMESelectedConvertedTextUnderline:
       return NS_IS_IME_SPECIAL_COLOR(aColor);
+    default:
+      /*
+       * In GetColor(), every color that is not a special color is color
+       * corrected. Use PR_FALSE to make other colors color corrected.
+       */
+      return PR_FALSE;
   }
   return PR_FALSE;
 }
 
 //
 // All these routines will return NS_OK if they have a value,
 // in which case the nsLookAndFeel should use that value;
 // otherwise we'll return NS_ERROR_NOT_AVAILABLE, in which case, the
@@ -639,16 +645,22 @@ nsXPLookAndFeel::GetMetric(const nsMetri
       aMetric = 0;
       return NS_OK;
     case eMetric_ScrollButtonMiddleMouseButtonAction:
       aMetric = 3;
       return NS_OK;
     case eMetric_ScrollButtonRightMouseButtonAction:
       aMetric = 3;
       return NS_OK;
+    default:
+      /*
+       * The metrics above are hardcoded platform defaults. All the other
+       * metrics are stored in sIntPrefs and can be changed at runtime.
+       */
+    break;
   }
 
   for (unsigned int i = 0; i < ((sizeof (sIntPrefs) / sizeof (*sIntPrefs))); ++i)
     if (sIntPrefs[i].isSet && (sIntPrefs[i].id == aID))
     {
       aMetric = sIntPrefs[i].intVar;
       return NS_OK;
     }
diff -r 1aecd2a9914d xulrunner/installer/Makefile.in
--- a/xulrunner/installer/Makefile.in	Tue Sep 16 16:40:57 2008 +1200
+++ b/xulrunner/installer/Makefile.in	Thu Sep 18 08:03:26 2008 -0500
@@ -146,17 +146,15 @@ debian/changelog: $(srcdir)/debian/chang
 	mkdir -p debian
 	$(PYTHON) $(topsrcdir)/config/Preprocessor.py \
         $(AUTOMATION_PPARGS) $(DEFINES) $(ACDEFINES) $^ > $@
 
 deb: debian/changelog
 	$(NSINSTALL)  $(topsrcdir)/$(MOZ_BUILD_APP)/installer/debian .
 	rm -rf $(DEBDESTDIR)/usr/local/*
 	$(NSINSTALL) -D $(DEBDESTDIR)/usr/local
-	cd $(DEBDESTDIR)/usr/local; cat ../../../../$(DEPTH)/dist/$(PKG_BASENAME)$(PKG_SUFFIX) | $(UNMAKE_PACKAGE)
+	cd $(DEBDESTDIR)/usr/local; cat ../../../../$(DEPTH)/dist/$(PKG_PATH)$(PKG_BASENAME)$(PKG_SUFFIX) | $(UNMAKE_PACKAGE)
 	$(NSINSTALL) -D $(DEBDESTDIR)/usr/share/dbus-1/services/
 	cp debian/$(MOZ_BUILD_APP).service $(DEBDESTDIR)/usr/share/dbus-1/services/org.mozilla.$(MOZ_BUILD_APP).service
-	$(NSINSTALL) debian/postinst $(DEBDESTDIR)/DEBIAN
-	$(NSINSTALL) debian/prerm $(DEBDESTDIR)/DEBIAN
 	rm  $(DEBDESTDIR)/usr/local/$(MOZ_BUILD_APP)/xpidl
-	dh_shlibdeps; fakeroot dh_gencontrol; fakeroot dh_md5sums; dh_builddeb
+	dh_shlibdeps; fakeroot dh_fixperms; fakeroot dh_installdeb ; fakeroot dh_gencontrol; fakeroot dh_md5sums; dh_builddeb
 endif
 
