diff --git a/accessible/build/Makefile.in b/accessible/build/Makefile.in
--- a/accessible/build/Makefile.in
+++ b/accessible/build/Makefile.in
@@ -92,10 +92,13 @@ ifeq ($(MOZ_WIDGET_TOOLKIT),gtk2)
 ifeq ($(MOZ_WIDGET_TOOLKIT),gtk2)
 EXTRA_DSO_LDOPTS += $(MOZ_GTK2_LIBS)
 endif
 
 ifeq ($(OS_ARCH),WINNT)
-OS_LIBS += oleaut32.lib
+OS_LIBS += \
+	oleaut32.lib \
+	version.lib \
+	$(NULL)
 endif
 
 include $(topsrcdir)/config/rules.mk
 
diff --git a/accessible/src/base/nsAccessNode.cpp b/accessible/src/base/nsAccessNode.cpp
--- a/accessible/src/base/nsAccessNode.cpp
+++ b/accessible/src/base/nsAccessNode.cpp
@@ -110,16 +110,27 @@ nsIAccessibilityService *nsAccessNode::G
 
 /*
  * Class nsAccessNode
  */
  
-//-----------------------------------------------------
-// construction 
-//-----------------------------------------------------
-NS_IMPL_QUERY_INTERFACE2(nsAccessNode, nsIAccessNode, nsPIAccessNode)
-NS_IMPL_ADDREF(nsAccessNode)
-NS_IMPL_RELEASE_WITH_DESTROY(nsAccessNode, LastRelease())
+////////////////////////////////////////////////////////////////////////////////
+// nsAccessible. nsISupports
+
+NS_IMPL_CYCLE_COLLECTION_0(nsAccessNode)
+
+NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(nsAccessNode)
+  NS_INTERFACE_MAP_ENTRY(nsIAccessNode)
+  NS_INTERFACE_MAP_ENTRY(nsPIAccessNode)
+  NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIAccessNode)
+NS_INTERFACE_MAP_END
+ 
+NS_IMPL_CYCLE_COLLECTING_ADDREF_AMBIGUOUS(nsAccessNode, nsIAccessNode)
+NS_IMPL_CYCLE_COLLECTING_RELEASE_FULL(nsAccessNode, nsIAccessNode,
+                                      LastRelease())
+
+////////////////////////////////////////////////////////////////////////////////
+// nsAccessible. Constructor
 
 nsAccessNode::nsAccessNode(nsIDOMNode *aNode, nsIWeakReference* aShell): 
   mDOMNode(aNode), mWeakShell(aShell)
 {
 #ifdef DEBUG_A11Y
diff --git a/accessible/src/base/nsAccessNode.h b/accessible/src/base/nsAccessNode.h
--- a/accessible/src/base/nsAccessNode.h
+++ b/accessible/src/base/nsAccessNode.h
@@ -72,17 +72,20 @@ class nsIDocShellTreeItem;
 #define PLATFORM_KEYS_BUNDLE_URL "chrome://global-platform/locale/platformKeys.properties"
 
 typedef nsInterfaceHashtable<nsVoidPtrHashKey, nsIAccessNode>
         nsAccessNodeHashtable;
 
-class nsAccessNode: public nsIAccessNode, public nsPIAccessNode
+class nsAccessNode: public nsIAccessNode,
+                    public nsPIAccessNode
 {
   public: // construction, destruction
     nsAccessNode(nsIDOMNode *, nsIWeakReference* aShell);
     virtual ~nsAccessNode();
 
-    NS_DECL_ISUPPORTS
+    NS_DECL_CYCLE_COLLECTING_ISUPPORTS
+    NS_DECL_CYCLE_COLLECTION_CLASS_AMBIGUOUS(nsAccessNode, nsIAccessNode)
+
     NS_DECL_NSIACCESSNODE
     NS_DECL_NSPIACCESSNODE
 
     static void InitXPAccessibility();
     static void ShutdownXPAccessibility();
diff --git a/accessible/src/base/nsAccessibilityUtils.cpp b/accessible/src/base/nsAccessibilityUtils.cpp
--- a/accessible/src/base/nsAccessibilityUtils.cpp
+++ b/accessible/src/base/nsAccessibilityUtils.cpp
@@ -63,10 +63,11 @@
 #include "nsPresContext.h"
 #include "nsIScrollableFrame.h"
 #include "nsIEventStateManager.h"
 #include "nsISelection2.h"
 #include "nsISelectionController.h"
+#include "nsGUIEvent.h"
 
 #include "nsContentCID.h"
 #include "nsComponentManagerUtils.h"
 #include "nsIInterfaceRequestorUtils.h"
 #include "nsWhitespaceTokenizer.h"
@@ -287,10 +288,52 @@ nsAccUtils::HasListener(nsIContent *aCon
   NS_ENSURE_TRUE(aContent, PR_FALSE);
   nsCOMPtr<nsIEventListenerManager> listenerManager;
   aContent->GetListenerManager(PR_FALSE, getter_AddRefs(listenerManager));
 
   return listenerManager && listenerManager->HasListenersFor(aEventType);  
+}
+
+PRBool
+nsAccUtils::DispatchMouseEvent(PRUint32 aEventType,
+                               nsIPresShell *aPresShell,
+                               nsIContent *aContent)
+{
+  nsIFrame *frame = aPresShell->GetPrimaryFrameFor(aContent);
+  if (!frame)
+    return PR_FALSE;
+
+  nsIFrame* rootFrame = aPresShell->GetRootFrame();
+  if (!rootFrame)
+    return PR_FALSE;
+
+  nsCOMPtr<nsIWidget> rootWidget = rootFrame->GetWindow();
+  if (!rootWidget)
+    return PR_FALSE;
+
+  // Compute x and y coordinates.
+  nsPoint point = frame->GetOffsetToExternal(rootFrame);
+  nsSize size = frame->GetSize();
+
+  nsPresContext* presContext = aPresShell->GetPresContext();
+
+  PRInt32 x = presContext->AppUnitsToDevPixels(point.x + size.width / 2);
+  PRInt32 y = presContext->AppUnitsToDevPixels(point.y + size.height / 2);
+  
+  // Fire mouse event.
+  nsMouseEvent event(PR_TRUE, aEventType, rootWidget,
+                     nsMouseEvent::eReal, nsMouseEvent::eNormal);
+
+  event.refPoint = nsIntPoint(x, y);
+  
+  event.clickCount = 1;
+  event.button = nsMouseEvent::eLeftButton;
+  event.time = PR_IntervalNow();
+  
+  nsEventStatus status = nsEventStatus_eIgnore;
+  aPresShell->HandleEventWithTarget(&event, frame, aContent, &status);
+
+  return PR_TRUE;
 }
 
 PRUint32
 nsAccUtils::GetAccessKeyFor(nsIContent *aContent)
 {
diff --git a/accessible/src/base/nsAccessibilityUtils.h b/accessible/src/base/nsAccessibilityUtils.h
--- a/accessible/src/base/nsAccessibilityUtils.h
+++ b/accessible/src/base/nsAccessibilityUtils.h
@@ -121,10 +121,21 @@ public:
   /**
    * Return true if the given node has registered event listener of the given
    * type.
    */
   static PRBool HasListener(nsIContent *aContent, const nsAString& aEventType);
+
+  /**
+   * Send mouse events to the given element.
+   *
+   * @param aEventType  an event type (see nsGUIEvent.h for constants)
+   * @param aPresShell  the presshell for the given element
+   * @param aContent    the element element
+   */
+  static PRBool DispatchMouseEvent(PRUint32 aEventType,
+                                   nsIPresShell *aPresShell,
+                                   nsIContent *aContent);
 
   /**
    * Return an accesskey registered on the given element by
    * nsIEventStateManager or 0 if there is no registered accesskey.
    *
diff --git a/accessible/src/base/nsAccessible.cpp b/accessible/src/base/nsAccessible.cpp
--- a/accessible/src/base/nsAccessible.cpp
+++ b/accessible/src/base/nsAccessible.cpp
@@ -138,13 +138,27 @@ nsAccessibleDOMStringList::Contains(cons
 
 /*
  * Class nsAccessible
  */
 
-//-----------------------------------------------------
-// construction 
-//-----------------------------------------------------
+////////////////////////////////////////////////////////////////////////////////
+// nsAccessible. nsISupports
+
+NS_IMPL_CYCLE_COLLECTION_CLASS(nsAccessible)
+
+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN_INHERITED(nsAccessible, nsAccessNode)
+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mParent)
+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mFirstChild)
+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMPTR(mNextSibling)
+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
+
+NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN_INHERITED(nsAccessible, nsAccessNode)
+  NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mParent)
+  NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mFirstChild)
+  NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMPTR(mNextSibling)
+NS_IMPL_CYCLE_COLLECTION_UNLINK_END
+
 NS_IMPL_ADDREF_INHERITED(nsAccessible, nsAccessNode)
 NS_IMPL_RELEASE_INHERITED(nsAccessible, nsAccessNode)
 
 #ifdef DEBUG_A11Y
 /*
@@ -186,11 +200,16 @@ nsresult nsAccessible::QueryInterface(RE
 nsresult nsAccessible::QueryInterface(REFNSIID aIID, void** aInstancePtr)
 {
   // Custom-built QueryInterface() knows when we support nsIAccessibleSelectable
   // based on role attribute and aria-multiselectable
   *aInstancePtr = nsnull;
-  
+
+  if (aIID.Equals(NS_GET_IID(nsXPCOMCycleCollectionParticipant))) {
+    *aInstancePtr = &NS_CYCLE_COLLECTION_NAME(nsAccessible);
+    return NS_OK;
+  }
+
   if (aIID.Equals(NS_GET_IID(nsIAccessible))) {
     *aInstancePtr = static_cast<nsIAccessible*>(this);
     NS_ADDREF_THIS();
     return NS_OK;
   }
@@ -481,11 +500,11 @@ NS_IMETHODIMP nsAccessible::SetFirstChil
   return NS_OK;
 }
 
 NS_IMETHODIMP nsAccessible::SetNextSibling(nsIAccessible *aNextSibling)
 {
-  mNextSibling = aNextSibling? aNextSibling: DEAD_END_ACCESSIBLE;
+  mNextSibling = aNextSibling;
   return NS_OK;
 }
 
 nsIContent *nsAccessible::GetRoleContent(nsIDOMNode *aDOMNode)
 {
@@ -536,19 +555,17 @@ NS_IMETHODIMP nsAccessible::InvalidateCh
 
   // Reset the sibling pointers, they will be set up again the next time
   // CacheChildren() is called.
   // Note: we don't want to start creating accessibles at this point,
   // so don't use GetNextSibling() here. (bug 387252)
-  nsAccessible* child = static_cast<nsAccessible*>(mFirstChild);
+  nsAccessible* child = static_cast<nsAccessible*>(mFirstChild.get());
   while (child) {
     child->mParent = nsnull;
-    if (child->mNextSibling == DEAD_END_ACCESSIBLE) {
-      break;
-    }
-    nsIAccessible *next = child->mNextSibling;
+
+    nsCOMPtr<nsIAccessible> next = child->mNextSibling;
     child->mNextSibling = nsnull;
-    child = static_cast<nsAccessible*>(next);
+    child = static_cast<nsAccessible*>(next.get());
   }
 
   mAccChildCount = eChildCountUninitialized;
   mFirstChild = nsnull;
   return NS_OK;
@@ -606,13 +623,12 @@ NS_IMETHODIMP nsAccessible::GetNextSibli
   }
 
   if (mNextSibling || !mParent) {
     // If no parent, don't try to calculate a new sibling
     // It either means we're at the root or shutting down the parent
-    if (mNextSibling != DEAD_END_ACCESSIBLE) {
-      NS_IF_ADDREF(*aNextSibling = mNextSibling);
-    }
+    NS_IF_ADDREF(*aNextSibling = mNextSibling);
+
     return NS_OK;
   }
 
   return NS_ERROR_FAILURE;
 }
@@ -3135,44 +3151,34 @@ NS_IMETHODIMP nsAccessible::GetNativeInt
   return NS_ERROR_NOT_IMPLEMENTED;
 }
 
 void nsAccessible::DoCommandCallback(nsITimer *aTimer, void *aClosure)
 {
-  NS_ASSERTION(gDoCommandTimer, "How did we get here if there was no gDoCommandTimer?");
+  NS_ASSERTION(gDoCommandTimer,
+               "How did we get here if there was no gDoCommandTimer?");
   NS_RELEASE(gDoCommandTimer);
 
-  nsIContent *content = reinterpret_cast<nsIContent*>(aClosure);
-  nsCOMPtr<nsIDOMXULElement> xulElement(do_QueryInterface(content));
-  if (xulElement) {
-    xulElement->Click();
-  }
-  else {
-    nsIDocument *doc = content->GetDocument();
-    if (!doc) {
-      return;
-    }
-    nsCOMPtr<nsIPresShell> presShell = doc->GetPrimaryShell();
-    nsPIDOMWindow *outerWindow = doc->GetWindow();
-    if (presShell && outerWindow) {
-      nsAutoPopupStatePusher popupStatePusher(outerWindow, openAllowed);
+  nsCOMPtr<nsIContent> content =
+    reinterpret_cast<nsIContent*>(aClosure);
 
-      nsMouseEvent downEvent(PR_TRUE, NS_MOUSE_BUTTON_DOWN, nsnull,
-                             nsMouseEvent::eSynthesized);
-      nsMouseEvent upEvent(PR_TRUE, NS_MOUSE_BUTTON_UP, nsnull,
-                           nsMouseEvent::eSynthesized);
-      nsMouseEvent clickEvent(PR_TRUE, NS_MOUSE_CLICK, nsnull,
-                              nsMouseEvent::eSynthesized);
+  nsIDocument *doc = content->GetDocument();
+  if (!doc)
+    return;
 
-      nsEventStatus eventStatus = nsEventStatus_eIgnore;
-      content->DispatchDOMEvent(&downEvent, nsnull,
-                                 presShell->GetPresContext(), &eventStatus);
-      content->DispatchDOMEvent(&upEvent, nsnull,
-                                 presShell->GetPresContext(), &eventStatus);
-      content->DispatchDOMEvent(&clickEvent, nsnull,
-                                 presShell->GetPresContext(), &eventStatus);
-    }
-  }
+  nsCOMPtr<nsIPresShell> presShell = doc->GetPrimaryShell();
+
+  // Scroll into view.
+  presShell->ScrollContentIntoView(content, NS_PRESSHELL_SCROLL_ANYWHERE,
+                                   NS_PRESSHELL_SCROLL_ANYWHERE);
+
+  // Fire mouse down and mouse up events.
+  PRBool res = nsAccUtils::DispatchMouseEvent(NS_MOUSE_BUTTON_DOWN, presShell,
+                                              content);
+  if (!res)
+    return;
+
+  nsAccUtils::DispatchMouseEvent(NS_MOUSE_BUTTON_UP, presShell, content);
 }
 
 /*
  * Use Timer to execute "Click" command of XUL/HTML element (e.g. menuitem, button...).
  *
diff --git a/accessible/src/base/nsAccessible.h b/accessible/src/base/nsAccessible.h
--- a/accessible/src/base/nsAccessible.h
+++ b/accessible/src/base/nsAccessible.h
@@ -67,13 +67,10 @@ class nsIView;
 class nsIView;
 
 #define NS_OK_NO_ARIA_VALUE \
 NS_ERROR_GENERATE_SUCCESS(NS_ERROR_MODULE_GENERAL, 0x21)
 
-// When mNextSibling is set to this, it indicates there ar eno more siblings
-#define DEAD_END_ACCESSIBLE static_cast<nsIAccessible*>((void*)1)
-
 // Saves a data member -- if child count equals this value we haven't
 // cached children or child count yet
 enum { eChildCountUninitialized = -1 };
 
 class nsAccessibleDOMStringList : public nsIDOMDOMStringList
@@ -104,10 +101,12 @@ public:
 public:
   nsAccessible(nsIDOMNode* aNode, nsIWeakReference* aShell);
   virtual ~nsAccessible();
 
   NS_DECL_ISUPPORTS_INHERITED
+  NS_DECL_CYCLE_COLLECTION_CLASS_INHERITED(nsAccessible, nsAccessNode)
+
   NS_DECL_NSIACCESSIBLE
   NS_DECL_NSPIACCESSIBLE
   NS_DECL_NSIACCESSIBLEHYPERLINK
   NS_DECL_NSIACCESSIBLESELECTABLE
   NS_DECL_NSIACCESSIBLEVALUE
@@ -270,11 +269,13 @@ protected:
    */
   virtual nsresult FirePlatformEvent(nsIAccessibleEvent *aEvent) = 0;
 
   // Data Members
   nsCOMPtr<nsIAccessible> mParent;
-  nsIAccessible *mFirstChild, *mNextSibling;
+  nsCOMPtr<nsIAccessible> mFirstChild;
+  nsCOMPtr<nsIAccessible> mNextSibling;
+
   nsRoleMapEntry *mRoleMapEntry; // Non-null indicates author-supplied role; possibly state & value as well
   PRInt32 mAccChildCount;
 };
 
 
diff --git a/accessible/src/base/nsAccessibleEventData.cpp b/accessible/src/base/nsAccessibleEventData.cpp
--- a/accessible/src/base/nsAccessibleEventData.cpp
+++ b/accessible/src/base/nsAccessibleEventData.cpp
@@ -55,11 +55,26 @@
 #include "nsPresContext.h"
 
 PRBool nsAccEvent::gLastEventFromUserInput = PR_FALSE;
 nsIDOMNode* nsAccEvent::gLastEventNodeWeak = 0;
 
-NS_IMPL_ISUPPORTS2(nsAccEvent, nsAccEvent, nsIAccessibleEvent)
+////////////////////////////////////////////////////////////////////////////////
+// nsAccEvent. nsISupports
+
+NS_IMPL_CYCLE_COLLECTION_2(nsAccEvent, mAccessible, mDocAccessible)
+
+NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(nsAccEvent)
+  NS_INTERFACE_MAP_ENTRY(nsIAccessibleEvent)
+  NS_INTERFACE_MAP_ENTRY(nsAccEvent)
+  NS_INTERFACE_MAP_ENTRY(nsISupports)
+NS_INTERFACE_MAP_END
+
+NS_IMPL_CYCLE_COLLECTING_ADDREF(nsAccEvent)
+NS_IMPL_CYCLE_COLLECTING_RELEASE(nsAccEvent)
+
+////////////////////////////////////////////////////////////////////////////////
+// nsAccEvent. Constructors
 
 nsAccEvent::nsAccEvent(PRUint32 aEventType, nsIAccessible *aAccessible,
                        PRBool aIsAsynch, EEventRule aEventRule):
   mEventType(aEventType), mAccessible(aAccessible), mEventRule(aEventRule)
 {
diff --git a/accessible/src/base/nsAccessibleEventData.h b/accessible/src/base/nsAccessibleEventData.h
--- a/accessible/src/base/nsAccessibleEventData.h
+++ b/accessible/src/base/nsAccessibleEventData.h
@@ -47,10 +47,11 @@
 #include "nsIAccessibleEvent.h"
 #include "nsIAccessible.h"
 #include "nsIAccessibleDocument.h"
 #include "nsIDOMNode.h"
 #include "nsString.h"
+#include "nsCycleCollectionParticipant.h"
 
 class nsIPresShell;
 
 #define NS_ACCEVENT_IMPL_CID                            \
 {  /* 55b89892-a83d-4252-ba78-cbdf53a86936 */           \
@@ -91,11 +92,13 @@ public:
   nsAccEvent(PRUint32 aEventType, nsIDOMNode *aDOMNode,
              PRBool aIsAsynch = PR_FALSE,
              EEventRule aEventRule = eRemoveDupes);
   virtual ~nsAccEvent() {}
 
-  NS_DECL_ISUPPORTS
+  NS_DECL_CYCLE_COLLECTING_ISUPPORTS
+  NS_DECL_CYCLE_COLLECTION_CLASS(nsAccEvent)
+
   NS_DECL_NSIACCESSIBLEEVENT
 
   static void GetLastEventAttributes(nsIDOMNode *aNode,
                                      nsIPersistentProperties *aAttributes);
 
@@ -103,17 +106,17 @@ protected:
   already_AddRefed<nsIAccessible> GetAccessibleByNode();
 
   void CaptureIsFromUserInput(PRBool aIsAsynch);
   PRBool mIsFromUserInput;
 
-private:
   PRUint32 mEventType;
   EEventRule mEventRule;
   nsCOMPtr<nsIAccessible> mAccessible;
   nsCOMPtr<nsIDOMNode> mDOMNode;
   nsCOMPtr<nsIAccessibleDocument> mDocAccessible;
 
+private:
   static PRBool gLastEventFromUserInput;
   static nsIDOMNode* gLastEventNodeWeak;
 
 public:
   static PRUint32 EventType(nsIAccessibleEvent *aAccEvent) {
diff --git a/accessible/src/base/nsApplicationAccessible.cpp b/accessible/src/base/nsApplicationAccessible.cpp
--- a/accessible/src/base/nsApplicationAccessible.cpp
+++ b/accessible/src/base/nsApplicationAccessible.cpp
@@ -48,15 +48,52 @@ nsApplicationAccessible::nsApplicationAc
 nsApplicationAccessible::nsApplicationAccessible():
     nsAccessibleWrap(nsnull, nsnull), mChildren(nsnull)
 {
 }
 
+////////////////////////////////////////////////////////////////////////////////
 // nsISupports
-NS_IMPL_ISUPPORTS_INHERITED0(nsApplicationAccessible,
-                             nsAccessible)
 
+NS_IMPL_CYCLE_COLLECTION_CLASS(nsApplicationAccessible)
+
+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN_INHERITED(nsApplicationAccessible,
+                                                  nsAccessible)
+
+  nsCOMPtr<nsISimpleEnumerator> enumerator;
+  tmp->mChildren->Enumerate(getter_AddRefs(enumerator));
+
+  nsCOMPtr<nsIWeakReference> childWeakRef;
+  nsCOMPtr<nsIAccessible> accessible;
+
+  PRBool hasMoreElements;
+  while(NS_SUCCEEDED(enumerator->HasMoreElements(&hasMoreElements))
+        && hasMoreElements) {
+
+    enumerator->GetNext(getter_AddRefs(childWeakRef));
+    accessible = do_QueryReferent(childWeakRef);
+    if (accessible) {
+      NS_CYCLE_COLLECTION_NOTE_EDGE_NAME(cb, accessible);
+      cb.NoteXPCOMChild(accessible);
+    }
+  }
+  
+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
+
+NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN_INHERITED(nsApplicationAccessible,
+                                                nsAccessible)
+  tmp->mChildren->Clear();
+NS_IMPL_CYCLE_COLLECTION_UNLINK_END
+
+NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION_INHERITED(nsApplicationAccessible)
+NS_INTERFACE_MAP_END_INHERITING(nsAccessible)
+
+NS_IMPL_ADDREF_INHERITED(nsApplicationAccessible, nsAccessible)
+NS_IMPL_RELEASE_INHERITED(nsApplicationAccessible, nsAccessible)
+
+////////////////////////////////////////////////////////////////////////////////
 // nsIAccessNode
+
 NS_IMETHODIMP
 nsApplicationAccessible::Init()
 {
   nsresult rv;
   mChildren = do_CreateInstance(NS_ARRAY_CONTRACTID, &rv);
diff --git a/accessible/src/base/nsApplicationAccessible.h b/accessible/src/base/nsApplicationAccessible.h
--- a/accessible/src/base/nsApplicationAccessible.h
+++ b/accessible/src/base/nsApplicationAccessible.h
@@ -61,10 +61,12 @@ public:
 public:
   nsApplicationAccessible();
 
   // nsISupports
   NS_DECL_ISUPPORTS_INHERITED
+  NS_DECL_CYCLE_COLLECTION_CLASS_INHERITED(nsApplicationAccessible,
+                                           nsAccessible)
 
   // nsPIAccessNode
   NS_IMETHOD Init();
 
   // nsIAccessible
diff --git a/accessible/src/base/nsBaseWidgetAccessible.cpp b/accessible/src/base/nsBaseWidgetAccessible.cpp
--- a/accessible/src/base/nsBaseWidgetAccessible.cpp
+++ b/accessible/src/base/nsBaseWidgetAccessible.cpp
@@ -186,15 +186,18 @@ nsLinkableAccessible::GetActionName(PRUi
 }
 
 NS_IMETHODIMP
 nsLinkableAccessible::DoAction(PRUint8 aIndex)
 {
+  if (aIndex != eAction_Jump)
+    return NS_ERROR_INVALID_ARG;
+  
   nsCOMPtr<nsIAccessible> actionAcc = GetActionAccessible();
   if (actionAcc)
     return actionAcc->DoAction(aIndex);
-
-  return NS_ERROR_INVALID_ARG;
+  
+  return nsHyperTextAccessibleWrap::DoAction(aIndex);
 }
 
 NS_IMETHODIMP
 nsLinkableAccessible::GetKeyboardShortcut(nsAString& aKeyboardShortcut)
 {
diff --git a/accessible/src/base/nsDocAccessible.cpp b/accessible/src/base/nsDocAccessible.cpp
--- a/accessible/src/base/nsDocAccessible.cpp
+++ b/accessible/src/base/nsDocAccessible.cpp
@@ -133,11 +133,38 @@ nsDocAccessible::nsDocAccessible(nsIDOMN
 //-----------------------------------------------------
 nsDocAccessible::~nsDocAccessible()
 {
 }
 
-NS_INTERFACE_MAP_BEGIN(nsDocAccessible)
+////////////////////////////////////////////////////////////////////////////////
+// nsDocAccessible. nsISupports
+
+PR_STATIC_CALLBACK(PLDHashOperator)
+ElementTraverser(const void *aKey, nsIAccessNode *aAccessNode,
+                 void *aUserArg)
+{
+  nsCycleCollectionTraversalCallback *cb = 
+    static_cast<nsCycleCollectionTraversalCallback*>(aUserArg);
+
+  NS_CYCLE_COLLECTION_NOTE_EDGE_NAME(*cb, aAccessNode);
+  cb->NoteXPCOMChild(aAccessNode);
+  return PL_DHASH_NEXT;
+}
+
+NS_IMPL_CYCLE_COLLECTION_CLASS(nsDocAccessible)
+
+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN_INHERITED(nsDocAccessible, nsAccessible)
+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE_NSCOMARRAY(mEventsToFire)
+  tmp->mAccessNodeCache.EnumerateRead(ElementTraverser, &cb); 
+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
+
+NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN_INHERITED(nsDocAccessible, nsAccessible)
+  NS_IMPL_CYCLE_COLLECTION_UNLINK_NSCOMARRAY(mEventsToFire)
+  tmp->ClearCache(tmp->mAccessNodeCache);
+NS_IMPL_CYCLE_COLLECTION_UNLINK_END
+
+NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION_INHERITED(nsDocAccessible)
   NS_INTERFACE_MAP_ENTRY(nsIAccessibleDocument)
   NS_INTERFACE_MAP_ENTRY(nsPIAccessibleDocument)
   NS_INTERFACE_MAP_ENTRY(nsIDocumentObserver)
   NS_INTERFACE_MAP_ENTRY(nsIMutationObserver)
   NS_INTERFACE_MAP_ENTRY(nsIScrollPositionListener)
diff --git a/accessible/src/base/nsDocAccessible.h b/accessible/src/base/nsDocAccessible.h
--- a/accessible/src/base/nsDocAccessible.h
+++ b/accessible/src/base/nsDocAccessible.h
@@ -63,10 +63,12 @@ class nsDocAccessible : public nsHyperTe
                         public nsIObserver,
                         public nsIScrollPositionListener,
                         public nsSupportsWeakReference
 {  
   NS_DECL_ISUPPORTS_INHERITED
+  NS_DECL_CYCLE_COLLECTION_CLASS_INHERITED(nsDocAccessible, nsAccessible)
+
   NS_DECL_NSIACCESSIBLEDOCUMENT
   NS_DECL_NSPIACCESSIBLEDOCUMENT
   NS_DECL_NSIOBSERVER
 
   public:
diff --git a/accessible/src/msaa/nsAccessNodeWrap.cpp b/accessible/src/msaa/nsAccessNodeWrap.cpp
--- a/accessible/src/msaa/nsAccessNodeWrap.cpp
+++ b/accessible/src/msaa/nsAccessNodeWrap.cpp
@@ -35,10 +35,11 @@
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
 #include "nsAccessNodeWrap.h"
+#include <tchar.h> 
 #include "ISimpleDOMNode_i.c"
 #include "nsAccessibilityAtoms.h"
 #include "nsIAccessibilityService.h"
 #include "nsIAccessible.h"
 #include "nsAttrName.h"
@@ -64,10 +65,12 @@ LPFNACCESSIBLEOBJECTFROMWINDOW nsAccessN
 LPFNACCESSIBLEOBJECTFROMWINDOW nsAccessNodeWrap::gmAccessibleObjectFromWindow = nsnull;
 LPFNNOTIFYWINEVENT nsAccessNodeWrap::gmNotifyWinEvent = nsnull;
 LPFNGETGUITHREADINFO nsAccessNodeWrap::gmGetGUIThreadInfo = nsnull;
 
 PRBool nsAccessNodeWrap::gIsEnumVariantSupportDisabled = 0;
+// Used to determine whether an IAccessible2 compatible screen reader is loaded.
+PRBool nsAccessNodeWrap::gIsIA2Disabled = PR_FALSE;
 
 nsIAccessibleTextChangeEvent *nsAccessNodeWrap::gTextEvent = nsnull;
 
 
 /* For documentation of the accessibility architecture, 
@@ -597,10 +600,12 @@ void nsAccessNodeWrap::InitAccessibility
       gmNotifyWinEvent = (LPFNNOTIFYWINEVENT)GetProcAddress(gmUserLib,"NotifyWinEvent");
     if (!gmGetGUIThreadInfo)
       gmGetGUIThreadInfo = (LPFNGETGUITHREADINFO)GetProcAddress(gmUserLib,"GetGUIThreadInfo");
   }
 
+  DoATSpecificProcessing();
+  
   nsAccessNode::InitXPAccessibility();
 }
 
 void nsAccessNodeWrap::ShutdownAccessibility()
 {
@@ -653,5 +658,42 @@ GetHRESULT(nsresult aResult)
     default:
       return E_FAIL;
   }
 }
 
+PRBool nsAccessNodeWrap::IsOnlyMsaaCompatibleJawsPresent()
+{
+  HMODULE jhookhandle = ::GetModuleHandleW(NS_LITERAL_STRING("jhook").get());
+  if (!jhookhandle)
+    return PR_FALSE;  // No JAWS, or some other screen reader, use IA2
+
+  PRUnichar fileName[MAX_PATH];
+  ::GetModuleFileNameW(jhookhandle, fileName, MAX_PATH);
+
+  DWORD dummy;
+  DWORD length = ::GetFileVersionInfoSizeW(fileName, &dummy);
+
+  LPBYTE versionInfo = new BYTE[length];
+  ::GetFileVersionInfoW(fileName, 0, length, versionInfo);
+
+  UINT uLen;
+  VS_FIXEDFILEINFO *fixedFileInfo;
+  ::VerQueryValueW(versionInfo, L"\\", (LPVOID*)&fixedFileInfo, &uLen);
+  DWORD dwFileVersionMS = fixedFileInfo->dwFileVersionMS;
+  DWORD dwFileVersionLS = fixedFileInfo->dwFileVersionLS;
+  delete [] versionInfo;
+
+  DWORD dwLeftMost = HIWORD(dwFileVersionMS);
+//  DWORD dwSecondLeft = LOWORD(dwFileVersionMS);
+  DWORD dwSecondRight = HIWORD(dwFileVersionLS);
+//  DWORD dwRightMost = LOWORD(dwFileVersionLS);
+
+  return (dwLeftMost < 8
+          || (dwLeftMost == 8 && dwSecondRight < 2173));
+}
+
+void nsAccessNodeWrap::DoATSpecificProcessing()
+{
+  if (IsOnlyMsaaCompatibleJawsPresent())
+    // All versions below 8.0.2173 are not compatible
+    gIsIA2Disabled  = PR_TRUE;
+}
diff --git a/accessible/src/msaa/nsAccessNodeWrap.h b/accessible/src/msaa/nsAccessNodeWrap.h
--- a/accessible/src/msaa/nsAccessNodeWrap.h
+++ b/accessible/src/msaa/nsAccessNodeWrap.h
@@ -156,15 +156,23 @@ class nsAccessNodeWrap :  public nsAcces
     static LPFNNOTIFYWINEVENT gmNotifyWinEvent;
     static LPFNGETGUITHREADINFO gmGetGUIThreadInfo;
 
     static int FilterA11yExceptions(unsigned int aCode, EXCEPTION_POINTERS *aExceptionInfo);
 
+    static PRBool IsOnlyMsaaCompatibleJawsPresent();
+    static void DoATSpecificProcessing();
   protected:
     void GetAccessibleFor(nsIDOMNode *node, nsIAccessible **newAcc);
     ISimpleDOMNode* MakeAccessNode(nsIDOMNode *node);
 
     static PRBool gIsEnumVariantSupportDisabled;
+
+    /**
+     * Used to determine whether an IAccessible2 compatible screen reader is
+     * loaded. Currently used for JAWS versions older than 8.0.2173.
+     */
+     static PRBool gIsIA2Disabled;
 
     /**
      * It is used in nsHyperTextAccessibleWrap for IA2::newText/oldText
      * implementation.
      */
diff --git a/accessible/src/msaa/nsAccessibleWrap.cpp b/accessible/src/msaa/nsAccessibleWrap.cpp
--- a/accessible/src/msaa/nsAccessibleWrap.cpp
+++ b/accessible/src/msaa/nsAccessibleWrap.cpp
@@ -115,11 +115,11 @@ __try {
     get_accChildCount(&numChildren);
     if (numChildren > 0)  // Don't support this interface for leaf elements
       *ppv = static_cast<IEnumVARIANT*>(this);
   } else if (IID_IServiceProvider == iid)
     *ppv = static_cast<IServiceProvider*>(this);
-  else if (IID_IAccessible2 == iid)
+  else if (IID_IAccessible2 == iid && !gIsIA2Disabled)
     *ppv = static_cast<IAccessible2*>(this);
 
   if (NULL == *ppv) {
     HRESULT hr = CAccessibleComponent::QueryInterface(iid, ppv);
     if (SUCCEEDED(hr))
diff --git a/accessible/tests/mochitest/Makefile.in b/accessible/tests/mochitest/Makefile.in
--- a/accessible/tests/mochitest/Makefile.in
+++ b/accessible/tests/mochitest/Makefile.in
@@ -45,19 +45,22 @@ include $(DEPTH)/config/autoconf.mk
 include $(DEPTH)/config/autoconf.mk
 include $(topsrcdir)/config/rules.mk
 
 _TEST_FILES =\
 		moz.png \
+		nsIAccessible_actions.js \
 		nsIAccessible_name.css \
 		nsIAccessible_name.xbl \
 		test_aria_activedescendant.html \
 		test_aria_role_article.html \
 		test_bug368835.xul \
 		test_bug420863.html \
 		test_cssattrs.html \
 		test_groupattrs.xul \
 	$(warning test_table_indexes.html temporarily disabled) \
+		test_nsIAccessible_actions.html \
+		test_nsIAccessible_actions.xul \
 		test_nsIAccessible_name.html \
 		test_nsIAccessible_name.xul \
 		test_nsIAccessibleTable_1.html \
 		test_nsIAccessibleTable_2.html \
 		test_nsIAccessibleTable_3.html \
diff --git a/accessible/tests/mochitest/nsIAccessible_actions.js b/accessible/tests/mochitest/nsIAccessible_actions.js
new file mode 100644
--- /dev/null
+++ b/accessible/tests/mochitest/nsIAccessible_actions.js
@@ -0,0 +1,150 @@
+////////////////////////////////////////////////////////////////////////////////
+// General
+
+const nsIAccessibleRetrieval = Components.interfaces.nsIAccessibleRetrieval;
+const nsIAccessibleRole = Components.interfaces.nsIAccessibleRole;
+
+var gAccRetrieval = null;
+
+function initialize()
+{
+  gAccRetrieval = Components.classes["@mozilla.org/accessibleRetrieval;1"].
+  getService(nsIAccessibleRetrieval);
+}
+
+addLoadEvent(initialize);
+
+////////////////////////////////////////////////////////////////////////////////
+// Event constants
+
+const MOUSEDOWN_EVENT = 1;
+const MOUSEUP_EVENT = 2;
+const CLICK_EVENT = 4;
+const COMMAND_EVENT = 8;
+
+const CLICK_EVENTS = MOUSEDOWN_EVENT | MOUSEUP_EVENT | CLICK_EVENT;
+const ALL_EVENTS = CLICK_EVENTS | COMMAND_EVENT;
+
+////////////////////////////////////////////////////////////////////////////////
+// Public functions
+
+function testActions(aArray, aIndex)
+{
+  if (!aIndex)
+    aIndex = 0;
+
+  if (aIndex == aArray.length) {
+    SimpleTest.finish();
+    return;
+  }
+
+  var ID = aArray[aIndex].ID;
+  var actionName = aArray[aIndex].actionName;
+  var events = aArray[aIndex].events;
+
+  var elm = document.getElementById(ID);
+  if (!elm) {
+    ok(false, "There is no element with ID " + ID);
+    SimpleTest.finish();
+    return null;
+  }
+
+  var acc = null;
+  try {
+    acc = gAccRetrieval.getAccessibleFor(elm);
+  } catch(e) {
+  }
+
+  if (!acc) {
+    ok(false, "There is no accessible for " + ID);
+    SimpleTest.finish();
+    return null;
+  }
+
+  is(acc.getActionName(0), actionName,
+     "Wrong action name of the accessible for " + ID);
+
+  gEventHandler.initialize(ID, elm, events);
+
+  acc.doAction(0);
+
+  window.setTimeout(
+    function()
+    {
+      gEventHandler.checkEvents();
+      testActions(aArray, aIndex + 1);
+    },
+    200
+  );
+}
+
+////////////////////////////////////////////////////////////////////////////////
+// Private
+
+var gEventHandler =
+{
+  initialize: function(aID, aElm, aExpectedEvents)
+  {
+    this.ID = aID,
+    this.element = aElm;
+    this.mExpectedEvents = aExpectedEvents;
+    this.mFiredEvents = 0;
+
+    if (this.mExpectedEvents & MOUSEDOWN_EVENT)
+      aElm.addEventListener("mousedown", this, false);
+
+    if (this.mExpectedEvents & MOUSEUP_EVENT)
+      aElm.addEventListener("mouseup", this, false);
+
+    if (this.mExpectedEvents & CLICK_EVENT)
+      aElm.addEventListener("click", this, false);
+
+    if (this.mExpectedEvents & COMMAND_EVENT)
+      aElm.addEventListener("command", this, false);
+  },
+
+  checkEvents: function()
+  {
+    if (this.mExpectedEvents & MOUSEDOWN_EVENT) {
+      ok(this.mFiredEvents & MOUSEDOWN_EVENT,
+         "mousedown hasn't been fired for " + this.ID);
+      this.element.removeEventListener("mousedown", this, false);
+    }
+
+    if (this.mExpectedEvents & MOUSEUP_EVENT) {
+      ok(this.mFiredEvents & MOUSEUP_EVENT,
+         "mouseup hasn't been fired for " + this.ID);
+      this.element.removeEventListener("mouseup", this, false);
+    }
+
+    if (this.mExpectedEvents & CLICK_EVENT) {
+      ok(this.mFiredEvents & CLICK_EVENT,
+         "click hasn't been fired for " + this.ID);
+      this.element.removeEventListener("click", this, false);
+    }
+
+    if (this.mExpectedEvents & COMMAND_EVENT) {
+      ok(this.mFiredEvents & COMMAND_EVENT,
+         "command hasn't been fired for " + this.ID);
+      this.element.removeEventListener("command", this, false);
+    }
+  },
+
+  ID: "",
+  element: null,
+
+  handleEvent : function(aEvent)
+  {
+    if (aEvent.type == "mousedown")
+      this.mFiredEvents |= MOUSEDOWN_EVENT;
+    else if(aEvent.type == "mouseup")
+      this.mFiredEvents |= MOUSEUP_EVENT;
+    else if(aEvent.type == "click")
+      this.mFiredEvents |= CLICK_EVENT;
+    else if(aEvent.type == "command")
+      this.mFiredEvents |= COMMAND_EVENT;
+  },
+
+  mExpectedEvents: 0,
+  mFiredEvents: 0
+};
diff --git a/accessible/tests/mochitest/test_nsIAccessible_actions.html b/accessible/tests/mochitest/test_nsIAccessible_actions.html
new file mode 100644
--- /dev/null
+++ b/accessible/tests/mochitest/test_nsIAccessible_actions.html
@@ -0,0 +1,49 @@
+<html>
+
+<head>
+  <title>nsIAccessible actions testing</title>
+
+  <link rel="stylesheet" type="text/css"
+        href="chrome://mochikit/content/tests/SimpleTest/test.css" />
+
+  <script type="application/javascript"
+          src="chrome://mochikit/content/MochiKit/packed.js"></script>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/a11y/accessible/nsIAccessible_actions.js"></script>
+
+  <script type="application/javascript">
+    function doTest()
+    {
+      var actionsArray = [
+        {
+          ID: "clickable",
+          actionName: "click",
+          events: CLICK_EVENTS
+        }
+      ];
+      testActions(actionsArray);
+    }
+
+    SimpleTest.waitForExplicitFinish();
+    addLoadEvent(doTest);
+  </script>
+</head>
+
+<body>
+
+  <a target="_blank"
+     href="https://bugzilla.mozilla.org/show_bug.cgi?id=410765"
+     title="nsIAccessible actions testing">
+    Mozilla Bug 410765
+  </a>
+  <p id="display"></p>
+  <div id="content" style="display: none"></div>
+  <pre id="test">
+  </pre>
+
+  <div id="clickable" onclick="">Clickable text</div>
+
+</body>
+</html>
diff --git a/accessible/tests/mochitest/test_nsIAccessible_actions.xul b/accessible/tests/mochitest/test_nsIAccessible_actions.xul
new file mode 100644
--- /dev/null
+++ b/accessible/tests/mochitest/test_nsIAccessible_actions.xul
@@ -0,0 +1,98 @@
+<?xml version="1.0"?>
+<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
+<?xml-stylesheet href="chrome://mochikit/content/tests/SimpleTest/test.css"
+                 type="text/css"?>
+<?xml-stylesheet href="chrome://mochikit/content/a11y/accessible/nsIAccessible_name.css"
+                 type="text/css"?>
+
+
+<window xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+        title="nsIAccessible actions testing">
+
+  <script type="application/javascript" 
+          src="chrome://mochikit/content/MochiKit/packed.js"></script>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js" />
+  <script type="application/javascript"
+          src="chrome://mochikit/content/a11y/accessible/nsIAccessible_actions.js" />
+
+  <script type="application/javascript">
+  <![CDATA[
+    function doTest()
+    {
+      var actionsArray = [
+        {
+          ID: "menu",
+          actionName: "click",
+          events: CLICK_EVENTS
+        },
+        {
+          ID: "submenu",
+          actionName: "click",
+          events: CLICK_EVENTS
+        },
+        {
+          ID: "menuitem",
+          actionName: "click",
+          events: ALL_EVENTS
+        },
+        {
+          ID: "button",
+          actionName: "press",
+          events: ALL_EVENTS
+        },
+        {
+          ID: "buttonmenu",
+          actionName: "press",
+          events: CLICK_EVENTS
+        },
+        {
+          ID: "buttonmenu_item",
+          actionName: "click",
+          events: CLICK_EVENTS
+        }
+      ];
+      testActions(actionsArray);
+    }
+
+    SimpleTest.waitForExplicitFinish();
+    addLoadEvent(doTest);
+  ]]>
+  </script>
+
+  <body xmlns="http://www.w3.org/1999/xhtml">
+    <a target="_blank"
+       href="https://bugzilla.mozilla.org/show_bug.cgi?id=410765"
+       title="nsIAccessible actions testing">
+      Mozilla Bug 410765
+    </a>
+    <p id="display"></p>
+    <div id="content" style="display: none">
+    </div>
+    <pre id="test">
+    </pre>
+  </body>
+
+  <menubar>
+    <menu label="menu" id="menu">
+      <menupopup>
+        <menuitem label="menu item" id="menuitem"/>
+        <menu label="submenu" id="submenu">
+          <menupopup>
+            <menuitem label="menu item"/>
+          </menupopup>
+        </menu>
+      </menupopup>
+    </menu>
+  </menubar>
+
+  <button label="button" id="button"/>
+
+  <button type="menu" id="buttonmenu" label="button">
+    <menupopup>
+      <menuitem label="item1" id="buttonmenu_item"/>
+      <menuitem label="item1"/>
+    </menupopup>
+  </button>
+</window>
+
diff --git a/browser/app/profile/firefox.js b/browser/app/profile/firefox.js
--- a/browser/app/profile/firefox.js
+++ b/browser/app/profile/firefox.js
@@ -335,11 +335,10 @@ pref("browser.tabs.closeButtons", 1);
 // true   return to the tab that opened this tab (its owner)
 // false  return to the adjacent tab (old default)
 pref("browser.tabs.selectOwnerOnClose", true);
 
 pref("browser.ctrlTab.mostRecentlyUsed", true);
-pref("browser.ctrlTab.previewsCount", 3);
 pref("browser.ctrlTab.smoothScroll", true);
 
 // Default bookmark sorting
 pref("browser.bookmarks.sort.direction", "descending");
 pref("browser.bookmarks.sort.resource", "rdf:http://home.netscape.com/NC-rdf#Name");
diff --git a/browser/base/content/aboutRobots-icon-rtl.png b/browser/base/content/aboutRobots-icon-rtl.png
new file mode 100644
index 0000000000000000000000000000000000000000..0cf87d712919a07e9be01bf4024c1a598cbd7e6f
GIT binary patch
literal 7897
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
DJYPrh

diff --git a/browser/base/content/aboutRobots.xhtml b/browser/base/content/aboutRobots.xhtml
--- a/browser/base/content/aboutRobots.xhtml
+++ b/browser/base/content/aboutRobots.xhtml
@@ -27,10 +27,11 @@
 #   William R. Price <wrprice@alumni.rice.edu>
 #   Henrik Skupin <mozilla@hskupin.info>
 #   Jeff Walden <jwalden+code@mit.edu>
 #   Johnathan Nightingale <johnath@mozilla.com>
 #   Justin Dolske <dolske@mozilla.com>
+#   Ehsan Akhgari <ehsan.akhgari@gmail.com>
 #
 # Alternatively, the contents of this file may be used under the terms of
 # either the GNU General Public License Version 2 or later (the "GPL"), or
 # the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
 # in which case the provisions of the GPL or the LGPL are applicable instead
@@ -78,17 +79,36 @@
           button.setAttribute("label", newLabel);
           buttonClicked = true;
         }
       }
     ]]></script>
+
+    <style type="text/css"><![CDATA[
+      #errorPageContainer {
+        background: url('chrome://browser/content/aboutRobots-icon.png') left 0 no-repeat -moz-Field;
+        -moz-background-origin: content;
+      }
+
+      #errorTrailerDescText {
+        float: right;
+      }
+
+      body[dir=rtl] #errorPageContainer {
+        background-image: url('chrome://browser/content/aboutRobots-icon-rtl.png');
+        background-position: right 0;
+      }
+
+      body[dir=rtl] #errorTrailerDescText {
+        float: left;
+      }
+    ]]></style>
   </head>
 
   <body dir="&locale.dir;">
 
     <!-- PAGE CONTAINER (for styling purposes only) -->
-    <div id="errorPageContainer"
-         style="background: url('chrome://browser/content/aboutRobots-icon.png') left 0 no-repeat -moz-Field; -moz-background-origin: content;">
+    <div id="errorPageContainer">
     
       <!-- Error Title -->
       <div id="errorTitle">
         <h1 id="errorTitleText">&robots.errorTitleText;</h1>
       </div>
@@ -111,11 +131,11 @@
           </ul>
         </div>
 
         <!-- Short Description -->
         <div id="errorTrailerDesc">
-          <p id="errorTrailerDescText" style="float: right;">&robots.errorTrailerDescText;</p>
+          <p id="errorTrailerDescText">&robots.errorTrailerDescText;</p>
         </div>
 
       </div>
 
       <!-- Button -->
diff --git a/browser/base/content/browser-tabPreviews.js b/browser/base/content/browser-tabPreviews.js
--- a/browser/base/content/browser-tabPreviews.js
+++ b/browser/base/content/browser-tabPreviews.js
@@ -102,11 +102,12 @@ var tabPreviews = {
 
 /**
  * Ctrl-Tab panel
  */
 var ctrlTab = {
-  tabs: [],
+  tabs: null,
+  visibleCount: 3,
   _uniqid: 0,
   get panel () {
     delete this.panel;
     return this.panel = document.getElementById("ctrlTab-panel");
   },
@@ -136,33 +137,39 @@ var ctrlTab = {
   },
   get iconSize () {
     delete this.iconSize;
     return this.iconSize = Math.round(tabPreviews.height / 4);
   },
+  get closeCharCode () {
+    delete this.closeCharCode;
+    return this.closeCharCode = document.getElementById("key_close")
+                                        .getAttribute("key")
+                                        .toLowerCase().charCodeAt(0);
+  },
   get smoothScroll () {
     delete this.smoothScroll;
     return this.smoothScroll = gPrefService.getBoolPref("browser.ctrlTab.smoothScroll");
-  },
-  get previewsCount () {
-    delete this.previewsCount;
-    return this.previewsCount = Math.max(gPrefService.getIntPref("browser.ctrlTab.previewsCount"), 3);
-  },
-  get visibleCount () {
-    return Math.min(this.previewsCount, this.tabs.length);
   },
   get offscreenStart () {
     return Array.indexOf(this.container.childNodes, this.selected) - 1;
   },
   get offscreenEnd () {
     return this.container.childNodes.length - this.visibleCount - this.offscreenStart;
   },
   get offsetX () {
     return - tabPreviews.width * (this.rtl ? this.offscreenEnd : this.offscreenStart);
   },
+  get isOpen () {
+    return this.panel.state == "open" || this.panel.state == "showing";
+  },
   init: function () {
+    if (this.tabs)
+      return;
+
     var tabContainer = gBrowser.tabContainer;
 
+    this.tabs = [];
     Array.forEach(tabContainer.childNodes, function (tab) {
       this.attachTab(tab, tab == gBrowser.selectedTab);
     }, this);
 
     tabContainer.addEventListener("TabOpen", this, false);
@@ -171,10 +178,12 @@ var ctrlTab = {
 
     gBrowser.mTabBox.handleCtrlTab = false;
     window.addEventListener("keydown", this, true);
   },
   uninit: function () {
+    this.tabs = null;
+
     var tabContainer = gBrowser.tabContainer;
     tabContainer.removeEventListener("TabOpen", this, false);
     tabContainer.removeEventListener("TabSelect", this, false);
     tabContainer.removeEventListener("TabClose", this, false);
 
@@ -287,17 +296,16 @@ var ctrlTab = {
         break;
     }
   },
   scroll: function () {
     if (!this.smoothScroll) {
-      this._move = true;
-      this.stopScroll();
+      this.advanceSelected();
+      this.arrangeBoxes();
       return;
     }
 
     this.stopScroll();
-    this._move = true;
     let (next = this.invertDirection ? this.selected.previousSibling : this.selected.nextSibling) {
       this.setStatusbarValue(next);
       this.label.value = next._tab.label;
       this.label.crop = next._tab.crop;
     }
@@ -324,33 +332,26 @@ var ctrlTab = {
   },
   stopScroll: function () {
     if (this._scrollTimer) {
       clearInterval(this._scrollTimer);
       this._scrollTimer = 0;
+      this.advanceSelected();
+      this.arrangeBoxes();
     }
-    if (this._move)
-      this.updateSelected();
   },
-  updateSelected: function (aClosing) {
-    var index = 1;
-    if (this._move) {
-      this._move = false;
-      index += this.invertDirection ? -1 : 1;
-    }
-    if (this.selected) {
-      index += this.offscreenStart + this.tabs.length;
-      index %= this.tabs.length;
-      if (index < 2)
-        index += this.tabs.length;
-      if (index > this.container.childNodes.length - this.visibleCount + 1)
-        index -= this.tabs.length;
-    }
+  advanceSelected: function () {
+    // regardless of visibleCount, the new highlighted tab will be
+    // the first or third-visible tab, depending on whether Shift is pressed
+    var index = ((this.invertDirection ? 0 : 2) + this.offscreenStart + this.tabs.length)
+                % this.tabs.length;
+    if (index < 2)
+      index += this.tabs.length;
+    if (index > this.container.childNodes.length - this.visibleCount + 1)
+      index -= this.tabs.length;
     this.selected = this.container.childNodes[index];
-
-    if (aClosing)
-      return;
-
+  },
+  arrangeBoxes: function () {
     this.addOffscreenBox(this.invertDirection);
     this.addOffscreenBox(!this.invertDirection);
 
     // having lots of off-screen boxes reduce the scrolling speed, remove some
     for (let i = this.offscreenStart; i > 1; i--)
@@ -418,26 +419,33 @@ var ctrlTab = {
     var i = this.tabs.indexOf(aTab);
     if (i >= 0)
       this.tabs.splice(i, 1);
   },
   open: function () {
+    this._deferOnTabSelect = [];
+
     window.addEventListener("keyup", this, true);
     window.addEventListener("keypress", this, true);
     this.panel.addEventListener("popuphiding", this, false);
     this.panel.hidden = false;
     this.panel.width = tabPreviews.width * this.visibleCount;
     this.panel.openPopupAtScreen(screen.availLeft + (screen.availWidth - this.panel.width) / 2,
                                  screen.availTop + (screen.availHeight - this.svgRoot.getAttribute("height")) / 2,
                                  false);
 
+    // display $visibleCount tabs, starting with the first or
+    // the second to the last tab, depending on whether Shift is pressed
     for (let index = this.invertDirection ? this.tabs.length - 2 : 0,
              i = this.visibleCount; i > 0; i--)
       this.addPreview(this.addBox(), this.tabs[index++ % this.tabs.length]);
-    this.updateSelected();
+
+    // regardless of visibleCount, highlight the second-visible tab
+    this.selected = this.container.childNodes[1];
+    this.arrangeBoxes();
   },
   onKeyDown: function (event) {
-    var isOpen = this.panel.state == "open" || this.panel.state == "showing";
+    var isOpen = this.isOpen;
     var propagate = !isOpen;
     switch (event.keyCode) {
       case event.DOM_VK_TAB:
         if (event.ctrlKey && !event.altKey && !event.metaKey && this.tabs.length > 1) {
           propagate = false;
@@ -460,12 +468,11 @@ var ctrlTab = {
       event.preventDefault();
     }
   },
   onKeyUp: function (event) {
     if (event.keyCode == event.DOM_VK_CONTROL) {
-      if (this._move)
-        this.updateSelected(true);
+      this.stopScroll();
       let selectedTab = this.selected._tab;
       this.panel.hidePopup();
       gBrowser.selectedTab = selectedTab;
     }
   },
@@ -475,41 +482,75 @@ var ctrlTab = {
     window.removeEventListener("keypress", this, true);
     while (this.container.childNodes.length)
       this.removeBox(this.container.lastChild);
     this.selected = null;
     this.invertDirection = false;
-    this._move = false;
     this._uniqid = 0;
     this.label.value = "";
     this.setStatusbarValue();
     this.container.removeAttribute("transform");
     this.svgRoot.forceRedraw();
+
+    this._deferOnTabSelect.forEach(this.onTabSelect, this);
+    this._deferOnTabSelect = null;
+  },
+  onTabSelect: function (aTab) {
+    if (aTab.parentNode) {
+      this.detachTab(aTab);
+      this.attachTab(aTab, true);
+    }
   },
   handleEvent: function (event) {
     switch (event.type) {
       case "DOMAttrModified":
         this.tabAttrModified(event.target, event.attrName);
         break;
       case "TabSelect":
-        this.detachTab(event.target);
-        this.attachTab(event.target, true);
+        if (this.isOpen)
+          // don't change the tab order while the panel is open
+          this._deferOnTabSelect.push(event.target);
+        else
+          this.onTabSelect(event.target);
         break;
       case "TabOpen":
         this.attachTab(event.target);
         break;
       case "TabClose":
+        if (this.isOpen) {
+          if (this.tabs.length == 2) {
+            // we have two tabs, one is being closed, so the panel isn't needed anymore
+            this.panel.hidePopup();
+          } else {
+            if (event.target == this.selected._tab)
+              this.advanceSelected();
+            this.detachTab(event.target);
+            Array.slice(this.container.childNodes).forEach(function (box) {
+              if (box._tab == event.target) {
+                this.removeBox(box);
+                this.arrangeBoxes();
+              }
+            }, this);
+          }
+        }
         this.detachTab(event.target);
         break;
       case "keydown":
         this.onKeyDown(event);
         break;
-      case "keyup":
       case "keypress":
         // the panel is open; don't propagate any key events
         event.stopPropagation();
         event.preventDefault();
+        if (event.charCode == this.closeCharCode) {
+          this.stopScroll();
+          gBrowser.removeTab(this.selected._tab);
+        }
+        break;
       case "keyup":
+        // the panel is open; don't propagate any key events
+        event.stopPropagation();
+        event.preventDefault();
         this.onKeyUp(event);
         break;
       case "popuphiding":
         this.onPopupHiding();
         break;
diff --git a/browser/base/content/browser.js b/browser/base/content/browser.js
--- a/browser/base/content/browser.js
+++ b/browser/base/content/browser.js
@@ -5097,74 +5097,63 @@ function charsetLoadListener (event)
         gLastBrowserCharset = charset;
     }
 }
 
 /* Begin Page Style Functions */
-function getStyleSheetArray(frame)
-{
-  var styleSheets = frame.document.styleSheets;
-  var styleSheetsArray = new Array(styleSheets.length);
-  for (var i = 0; i < styleSheets.length; i++) {
-    styleSheetsArray[i] = styleSheets[i];
+function getAllStyleSheets(frameset) {
+  var styleSheetsArray = Array.slice(frameset.document.styleSheets);
+  for (let i = 0; i < frameset.frames.length; i++) {
+    let frameSheets = getAllStyleSheets(frameset.frames[i]);
+    styleSheetsArray = styleSheetsArray.concat(frameSheets);
   }
   return styleSheetsArray;
 }
 
-function getAllStyleSheets(frameset)
-{
-  var styleSheetsArray = getStyleSheetArray(frameset);
-  for (var i = 0; i < frameset.frames.length; i++) {
-    var frameSheets = getAllStyleSheets(frameset.frames[i]);
-    styleSheetsArray = styleSheetsArray.concat(frameSheets);
-  }
-  return styleSheetsArray;
-}
-
-function stylesheetFillPopup(menuPopup)
-{
+function stylesheetFillPopup(menuPopup) {
   var noStyle = menuPopup.firstChild;
   var persistentOnly = noStyle.nextSibling;
   var sep = persistentOnly.nextSibling;
   while (sep.nextSibling)
     menuPopup.removeChild(sep.nextSibling);
 
   var styleSheets = getAllStyleSheets(window.content);
-  var currentStyleSheets = [];
+  var currentStyleSheets = {};
   var styleDisabled = getMarkupDocumentViewer().authorStyleDisabled;
   var haveAltSheets = false;
   var altStyleSelected = false;
 
-  for (var i = 0; i < styleSheets.length; ++i) {
-    var currentStyleSheet = styleSheets[i];
+  for (let i = 0; i < styleSheets.length; ++i) {
+    let currentStyleSheet = styleSheets[i];
+
+    if (!currentStyleSheet.title)
+      continue;
 
     // Skip any stylesheets that don't match the screen media type.
-    var media = currentStyleSheet.media.mediaText.toLowerCase();
-    if (media && (media.indexOf("screen") == -1) && (media.indexOf("all") == -1))
+    let (media = currentStyleSheet.media.mediaText.toLowerCase()) {
+      if (media && (media.indexOf("screen") == -1) && (media.indexOf("all") == -1))
         continue;
-
-    if (currentStyleSheet.title) {
-      if (!currentStyleSheet.disabled)
-        altStyleSelected = true;
-
-      haveAltSheets = true;
-
-      var lastWithSameTitle = null;
-      if (currentStyleSheet.title in currentStyleSheets)
-        lastWithSameTitle = currentStyleSheets[currentStyleSheet.title];
-
-      if (!lastWithSameTitle) {
-        var menuItem = document.createElement("menuitem");
-        menuItem.setAttribute("type", "radio");
-        menuItem.setAttribute("label", currentStyleSheet.title);
-        menuItem.setAttribute("data", currentStyleSheet.title);
-        menuItem.setAttribute("checked", !currentStyleSheet.disabled && !styleDisabled);
-        menuPopup.appendChild(menuItem);
-        currentStyleSheets[currentStyleSheet.title] = menuItem;
-      } else {
-        if (currentStyleSheet.disabled)
-          lastWithSameTitle.removeAttribute("checked");
-      }
+    }
+
+    if (!currentStyleSheet.disabled)
+      altStyleSelected = true;
+
+    haveAltSheets = true;
+
+    let lastWithSameTitle = null;
+    if (currentStyleSheet.title in currentStyleSheets)
+      lastWithSameTitle = currentStyleSheets[currentStyleSheet.title];
+
+    if (!lastWithSameTitle) {
+      let menuItem = document.createElement("menuitem");
+      menuItem.setAttribute("type", "radio");
+      menuItem.setAttribute("label", currentStyleSheet.title);
+      menuItem.setAttribute("data", currentStyleSheet.title);
+      menuItem.setAttribute("checked", !currentStyleSheet.disabled && !styleDisabled);
+      menuPopup.appendChild(menuItem);
+      currentStyleSheets[currentStyleSheet.title] = menuItem;
+    } else if (currentStyleSheet.disabled) {
+      lastWithSameTitle.removeAttribute("checked");
     }
   }
 
   noStyle.setAttribute("checked", styleDisabled);
   persistentOnly.setAttribute("checked", !altStyleSelected && !styleDisabled);
@@ -5172,24 +5161,19 @@ function stylesheetFillPopup(menuPopup)
   sep.hidden = (noStyle.hidden && persistentOnly.hidden) || !haveAltSheets;
   return true;
 }
 
 function stylesheetInFrame(frame, title) {
-  var docStyleSheets = frame.document.styleSheets;
-
-  for (var i = 0; i < docStyleSheets.length; ++i) {
-    if (docStyleSheets[i].title == title)
-      return true;
-  }
-  return false;
+  return Array.some(frame.document.styleSheets,
+                    function (stylesheet) stylesheet.title == title);
 }
 
 function stylesheetSwitchFrame(frame, title) {
   var docStyleSheets = frame.document.styleSheets;
 
-  for (var i = 0; i < docStyleSheets.length; ++i) {
-    var docStyleSheet = docStyleSheets[i];
+  for (let i = 0; i < docStyleSheets.length; ++i) {
+    let docStyleSheet = docStyleSheets[i];
 
     if (title == "_nostyle")
       docStyleSheet.disabled = true;
     else if (docStyleSheet.title)
       docStyleSheet.disabled = (docStyleSheet.title != title);
@@ -5197,22 +5181,20 @@ function stylesheetSwitchFrame(frame, ti
       docStyleSheet.disabled = false;
   }
 }
 
 function stylesheetSwitchAll(frameset, title) {
-  if (!title || title == "_nostyle" || stylesheetInFrame(frameset, title)) {
+  if (!title || title == "_nostyle" || stylesheetInFrame(frameset, title))
     stylesheetSwitchFrame(frameset, title);
-  }
-  for (var i = 0; i < frameset.frames.length; i++) {
+
+  for (let i = 0; i < frameset.frames.length; i++)
     stylesheetSwitchAll(frameset.frames[i], title);
-  }
 }
 
 function setStyleDisabled(disabled) {
   getMarkupDocumentViewer().authorStyleDisabled = disabled;
 }
-
 /* End of the Page Style functions */
 
 var BrowserOffline = {
   /////////////////////////////////////////////////////////////////////////////
   // BrowserOffline Public Methods
diff --git a/browser/base/content/browser.xul b/browser/base/content/browser.xul
--- a/browser/base/content/browser.xul
+++ b/browser/base/content/browser.xul
@@ -102,14 +102,18 @@
     <panel type="autocomplete" chromedir="&locale.dir;" id="PopupAutoComplete" noautofocus="true" hidden="true"/>
 
     <!-- for url bar autocomplete -->
     <panel type="autocomplete-richlistbox" chromedir="&locale.dir;" id="PopupAutoCompleteRichResult" noautofocus="true" hidden="true"/>
 
+    <!-- XXX panel element that has one or more text fields should not be
+             top-most panel, for IME users. See bug 433340 comment 100. -->
     <panel id="editBookmarkPanel"
            orient="vertical"
            ignorekeys="true"
            hidden="true"
+           noautohide="true"
+           onpopupshowing="this.removeAttribute('noautohide');"
            onpopupshown="StarUI.panelShown(event);"
            aria-labelledby="editBookmarkPanelTitle">
       <hbox flex="1" align="top">
         <image id="editBookmarkPanelStarIcon"/>
         <vbox flex="1">
diff --git a/browser/base/content/tabbrowser.xml b/browser/base/content/tabbrowser.xml
--- a/browser/base/content/tabbrowser.xml
+++ b/browser/base/content/tabbrowser.xml
@@ -276,11 +276,10 @@
           return ({
             mTabBrowser: this,
             mTab: aTab,
             mBrowser: aBrowser,
             mBlank: aStartsBlank,
-            mLastURI: null,
 
             // cache flags for correct status bar update after tab switching
             mStateFlags: 0,
             mStatus: 0,
             mMessage: "",
@@ -1389,10 +1388,22 @@
 
       <method name="removeTab">
         <parameter name="aTab"/>
         <body>
           <![CDATA[
+            this._endRemoveTab(this._beginRemoveTab(aTab, true));
+          ]]>
+        </body>
+      </method>
+
+      <!-- Returns the tab being removed.  This might not be the same as aTab,
+           in cases when aTab is not actually a tab -->
+      <method name="_beginRemoveTab">
+        <parameter name="aTab"/>
+        <parameter name="aFireBeforeUnload"/>
+        <body>
+          <![CDATA[
             this._browsers = null; // invalidate cache
             if (aTab.localName != "tab")
               aTab = this.mCurrentTab;
 
             var l = this.mTabContainer.childNodes.length;
@@ -1401,13 +1412,15 @@
               this.mPrefs.setBoolPref("browser.tabs.forceHide", true);
               this.setStripVisibilityTo(false);
               return;
             }
 
-            var ds = this.getBrowserForTab(aTab).docShell;
-            if (ds.contentViewer && !ds.contentViewer.permitUnload())
-              return;
+            if (aFireBeforeUnload) {
+              var ds = this.getBrowserForTab(aTab).docShell;
+              if (ds.contentViewer && !ds.contentViewer.permitUnload())
+                return;
+            }
 
             // see notes in addTab
             var _delayedUpdate = function(aTabContainer) {
               aTabContainer.adjustTabstrip();
               aTabContainer.mTabstrip._updateScrollButtonsDisabledState();
@@ -1433,19 +1446,11 @@
             // inspect the tab that's about to close.
             var evt = document.createEvent("Events");
             evt.initEvent("TabClose", true, false);
             aTab.dispatchEvent(evt);
 
-            var index = -1;
-            if (this.mCurrentTab == aTab)
-              index = this.mTabContainer.selectedIndex;
-            else {
-              // Find and locate the tab in our list.
-              for (var i = 0; i < l; i++)
-                if (this.mTabContainer.childNodes[i] == aTab)
-                  index = i;
-            }
+            var index = aTab._tPos;
 
             // Remove the tab's filter and progress listener.
             const filter = this.mTabFilters[index];
             var oldBrowser = this.getBrowserAtIndex(index);
             oldBrowser.webProgress.removeProgressListener(filter);
@@ -1457,25 +1462,37 @@
             oldBrowser.removeEventListener("DOMTitleChanged", this.onTitleChanged, true);
 
             // We are no longer the primary content area.
             oldBrowser.setAttribute("type", "content-targetable");
 
-            // Get the index of the tab we're removing before unselecting it
-            var currentIndex = this.mTabContainer.selectedIndex;
-
-            var oldTab = aTab;
-
-            // clean up the before/afterselected attributes before removing the tab
-            oldTab._selected = false;
-
             // Remove this tab as the owner of any other tabs, since it's going away.
-            for (i = 0; i < this.mTabContainer.childNodes.length; ++i) {
+            for (var i = 0; i < this.mTabs.length; ++i) {
               var tab = this.mTabContainer.childNodes[i];
-              if ("owner" in tab && tab.owner == oldTab)
+              if ("owner" in tab && tab.owner == aTab)
                 // |tab| is a child of the tab we're removing, make it an orphan
                 tab.owner = null;
             }
+
+            return aTab;
+          ]]>
+        </body>
+      </method>
+
+      <method name="_endRemoveTab">
+        <parameter name="aTab"/>
+        <body>
+          <![CDATA[
+            var browser = this.getBrowserForTab(aTab);
+            var length = this.mTabs.length;
+
+            // Get the index of the tab we're removing before unselecting it
+            var currentIndex = this.mTabContainer.selectedIndex;
+            var index = aTab._tPos;
+
+            // clean up the before/afterselected attributes before removing the
+            // tab.  But make sure this happens after we grab currentIndex.
+            aTab._selected = false;
 
             // Because of the way XBL works (fields just set JS
             // properties on the element) and the code we have in place
             // to preserve the JS objects for any elements that have
             // JS properties set on them, the browser element won't be
@@ -1483,20 +1500,22 @@
             // cleanup ourselves.
             // This has to happen before we remove the child so that the
             // XBL implementation of nsIObserver still works.  But
             // clearing focusedWindow happens below because it gets
             // reset by updateCurrentBrowser.
-            oldBrowser.destroy();
+            browser.destroy();
 
-            if (oldBrowser == this.mCurrentBrowser)
+            if (browser == this.mCurrentBrowser)
               this.mCurrentBrowser = null;
 
             // Remove the tab
-            this.mTabContainer.removeChild(oldTab);
+            this.mTabContainer.removeChild(aTab);
+            // Update our length
+            --length;
             // invalidate cache, because mTabContainer is about to change
             this._browsers = null; 
-            this.mPanelContainer.removeChild(oldBrowser.parentNode);
+            this.mPanelContainer.removeChild(browser.parentNode);
 
             try {
               // if we're at the right side (and not the logical end,
               // which is why this works for both LTR and RTL)
               // of the tabstrip, we need to ensure that we stay 
@@ -1521,38 +1540,83 @@
             if (currentIndex > index)
               newIndex = currentIndex-1;
             else if (currentIndex < index)
               newIndex = currentIndex;
             else {
-              if ("owner" in oldTab && oldTab.owner &&
+              if ("owner" in aTab && aTab.owner &&
                   this.mPrefs.getBoolPref("browser.tabs.selectOwnerOnClose")) {
-                for (i = 0; i < this.mTabContainer.childNodes.length; ++i) {
+                for (var i = 0; i < length; ++i) {
                   tab = this.mTabContainer.childNodes[i];
-                  if (tab == oldTab.owner) {
+                  if (tab == aTab.owner) {
                     newIndex = i;
                     break;
                   }
                 }
               }
               if (newIndex == -1)
-                newIndex = (index == l - 1) ? index - 1 : index;
+                newIndex = (index == length) ? index - 1 : index;
             }
 
             // Select the new tab
-            this.selectedTab = this.mTabContainer.childNodes[newIndex];
+            this.selectedTab = this.mTabs[newIndex];
 
-            for (i = oldTab._tPos; i < this.mTabContainer.childNodes.length; i++) {
+            for (i = aTab._tPos; i < length; i++) {
               this.mTabContainer.childNodes[i]._tPos = i;
             }
             this.mTabBox.selectedPanel = this.getBrowserForTab(this.mCurrentTab).parentNode;
             this.mCurrentTab._selected = true;
 
             this.updateCurrentBrowser();
 
             // see comment above destroy above
-            oldBrowser.focusedWindow = null;
-            oldBrowser.focusedElement = null;
+            browser.focusedWindow = null;
+            browser.focusedElement = null;
+          ]]>
+        </body>
+      </method>
+
+      <method name="swapBrowsersAndCloseOther">
+        <parameter name="aOurTab"/>
+        <parameter name="aOtherTab"/>
+        <body>
+          <![CDATA[
+            var remoteBrowser =
+              aOtherTab.ownerDocument.defaultView.getBrowser();
+            var tabCount = remoteBrowser.mTabs.length;
+
+            // First, start teardown of the other browser.  Make sure to not
+            // fire the beforeunload event in the process.
+            var tabToRemove = remoteBrowser._beginRemoveTab(aOtherTab, false);
+
+            // Unhook our progress listener
+            var ourIndex = aOurTab._tPos;
+            const filter = this.mTabFilters[ourIndex];
+            var tabListener = this.mTabListeners[ourIndex];
+            var ourBrowser = this.getBrowserForTab(aOurTab);
+            ourBrowser.webProgress.removeProgressListener(filter);
+            filter.removeProgressListener(tabListener);
+            var tabListenerBlank = tabListener.mBlank;
+
+            // Swap the docshells
+            ourBrowser.swapDocShells(remoteBrowser.getBrowserForTab(aOtherTab));
+
+            // Finish tearing down the tab that's going away.
+            remoteBrowser._endRemoveTab(tabToRemove);
+
+            // Restore the progress listener
+            tabListener = this.mTabProgressListener(aOurTab, ourBrowser,
+                                                    tabListenerBlank);
+            this.mTabListeners[ourIndex] = tabListener;
+            filter.addProgressListener(tabListener,
+              Components.interfaces.nsIWebProgress.NOTIFY_ALL);
+              
+            ourBrowser.webProgress.addProgressListener(filter,
+              Components.interfaces.nsIWebProgress.NOTIFY_ALL);
+
+            // close the other window if this was its last tab
+            if (tabCount == 1)
+              aOtherTab.ownerDocument.defaultView.close();
           ]]>
         </body>
       </method>
 
       <method name="reloadAllTabs">
@@ -1877,23 +1941,30 @@
                 if (newIndex != draggedTab._tPos)
                   this.moveTabTo(draggedTab, newIndex);
               }
             }
             else if (draggedTab) {
-              // copy the dropped tab and remove it from the other window
-              // (making it seem to have moved between windows)
+              // swap the dropped tab with a new one we create and then close
+              // it in the other window (making it seem to have moved between
+              // windows)
               newIndex = this.getNewIndex(aEvent);
-              newTab = this.duplicateTab(draggedTab);
+              newTab = this.addTab("about:blank");
+              var newBrowser = this.getBrowserForTab(newTab);
+              // Stop the about:blank load
+              newBrowser.stop();
+              // make sure it has a docshell
+              newBrowser.docShell;
+              
               this.moveTabTo(newTab, newIndex);
+              
+              this.swapBrowsersAndCloseOther(newTab, draggedTab);
+
+              // We need to set selectedTab after we've done
+              // swapBrowsersAndCloseOther, so that the updateCurrentBrowser
+              // it triggers will correctly update our URL bar.
               this.selectedTab = newTab;
-              
-              var remoteBrowser = draggedTab.ownerDocument.defaultView.getBrowser();
-              var tabCount = remoteBrowser.tabContainer.childNodes.length;
-              remoteBrowser.removeTab(draggedTab);
-              // close the other window if this was its last tab
-              if (tabCount == 1)
-                draggedTab.ownerDocument.defaultView.close();
+              this.setTabTitle(newTab);
             }
             else {
               var url = transferUtils.retrieveURLFromData(aXferData.data, aXferData.flavour.contentType);
 
               // valid urls don't contain spaces ' '; if we have a space it isn't a valid url.
diff --git a/browser/base/content/test/Makefile.in b/browser/base/content/test/Makefile.in
--- a/browser/base/content/test/Makefile.in
+++ b/browser/base/content/test/Makefile.in
@@ -57,10 +57,12 @@ _BROWSER_FILES = browser_bug321000.js \
                  browser_autodiscovery.js \
                  browser_bug420160.js \
                  autodiscovery.html \
                  moz.png \
                  browser_getshortcutoruri.js \
+                 browser_page_style_menu.js \
+                 page_style_sample.html \
     $(NULL)
 
 ifneq (,$(filter mac cocoa,$(MOZ_WIDGET_TOOLKIT)))
 _BROWSER_FILES += browser_customize.js \
     $(NULL)
diff --git a/browser/base/content/test/browser_page_style_menu.js b/browser/base/content/test/browser_page_style_menu.js
new file mode 100644
--- /dev/null
+++ b/browser/base/content/test/browser_page_style_menu.js
@@ -0,0 +1,64 @@
+function test() {
+  waitForExplicitFinish();
+
+  var tab = gBrowser.addTab();
+  gBrowser.selectedTab = tab;
+  tab.linkedBrowser.addEventListener("load", checkPageStyleMenu, true);
+  content.location =
+    "chrome://mochikit/content/browser/browser/base/content/test/page_style_sample.html";
+}
+
+function checkPageStyleMenu() {
+  var menupopup = document.getElementById("pageStyleMenu")
+                          .getElementsByTagName("menupopup")[0];
+  stylesheetFillPopup(menupopup);
+
+  var items = [];
+  var current = menupopup.getElementsByTagName("menuseparator")[0];
+  while (current.nextSibling) {
+    current = current.nextSibling;
+    items.push(current);
+  }
+
+  var validLinks = 0;
+  Array.forEach(content.document.getElementsByTagName("link"), function (link) {
+    var title = link.getAttribute("title");
+    var rel = link.getAttribute("rel");
+    var media = link.getAttribute("media");
+    var idstring = "link " + (title ? title : "without title and") +
+                   " with rel=\"" + rel + "\"" +
+                   (media ? " and media=\"" + media + "\"" : "");
+
+    var item = items.filter(function (item) item.getAttribute("label") == title);
+    var found = item.length == 1;
+    var checked = found && (item[0].getAttribute("checked") == "true");
+
+    switch (link.getAttribute("data-state")) {
+      case "0":
+        ok(!found, idstring + " does not show up in page style menu");
+        break;
+      case "0-todo":
+        validLinks++;
+        todo(!found, idstring + " should not show up in page style menu");
+        ok(!checked, idstring + " is not selected");
+        break;
+      case "1":
+        validLinks++;
+        ok(found, idstring + " shows up in page style menu");
+        ok(!checked, idstring + " is not selected");
+        break;
+      case "2":
+        validLinks++;
+        ok(found, idstring + " shows up in page style menu");
+        ok(checked, idstring + " is selected");
+        break;
+      default:
+        throw "data-state attribute is missing or has invalid value";
+    }
+  });
+
+  is(validLinks, items.length, "all valid links found");
+
+  gBrowser.removeCurrentTab();
+  finish();
+}
diff --git a/browser/base/content/test/page_style_sample.html b/browser/base/content/test/page_style_sample.html
new file mode 100644
--- /dev/null
+++ b/browser/base/content/test/page_style_sample.html
@@ -0,0 +1,31 @@
+<html>
+  <head>
+    <title>Test for page style menu</title>
+    <!-- data-state values:
+      0:      should not appear in the page style menu
+      0-todo: should not appear in the page style menu, but does
+      1:      should appear in the page style menu
+      2:      should appear in the page style menu as the selected stylesheet -->
+    <link data-state="1" href="404.css" title="1" rel="alternate stylesheet">
+    <link data-state="0"                title="2" rel="alternate stylesheet">
+    <link data-state="0" href="404.css"           rel="alternate stylesheet">
+    <link data-state="0" href="404.css" title=""  rel="alternate stylesheet">
+    <link data-state="1" href="404.css" title="3" rel="stylesheet alternate">
+    <link data-state="1" href="404.css" title="4" rel=" alternate stylesheet ">
+    <link data-state="1" href="404.css" title="5" rel="alternate stylesheet">
+    <link data-state="2" href="404.css" title="6" rel="stylesheet">
+    <link data-state="1" href="404.css" title="7" rel="foo stylesheet">
+    <link data-state="0" href="404.css" title="8" rel="alternate">
+    <link data-state="1" href="404.css" title="9" rel="alternate STYLEsheet">
+    <link data-state="1" href="404.css" title="10" rel="alternate stylesheet" media="">
+    <link data-state="1" href="404.css" title="11" rel="alternate stylesheet" media="all">
+    <link data-state="1" href="404.css" title="12" rel="alternate stylesheet" media="ALL ">
+    <link data-state="1" href="404.css" title="13" rel="alternate stylesheet" media="screen">
+    <link data-state="1" href="404.css" title="14" rel="alternate stylesheet" media=" Screen">
+    <link data-state="1" href="404.css" title="15" rel="alternate stylesheet" media="screen foo">
+    <link data-state="1" href="404.css" title="16" rel="alternate stylesheet" media="all  screen">
+    <link data-state="0-todo" href="404.css" title="17" rel="alternate stylesheet" media="allscreen">
+    <link data-state="0-todo" href="404.css" title="18" rel="alternate stylesheet" media="_all">
+  </head>
+  <body></body>
+</html>
diff --git a/browser/base/jar.mn b/browser/base/jar.mn
--- a/browser/base/jar.mn
+++ b/browser/base/jar.mn
@@ -13,10 +13,11 @@ browser.jar:
 *       content/browser/aboutDialog.xul               (content/aboutDialog.xul)
 *       content/browser/aboutDialog.js                (content/aboutDialog.js)
         content/browser/aboutDialog.css               (content/aboutDialog.css)
 *       content/browser/aboutRobots.xhtml             (content/aboutRobots.xhtml)
         content/browser/aboutRobots-icon.png          (content/aboutRobots-icon.png)
+        content/browser/aboutRobots-icon-rtl.png      (content/aboutRobots-icon-rtl.png)
         content/browser/aboutRobots-widget-left.png   (content/aboutRobots-widget-left.png)
         content/browser/aboutRobots-widget-right.png  (content/aboutRobots-widget-right.png)
 *       content/browser/browser.css                   (content/browser.css)
 *       content/browser/browser.js                    (content/browser.js)
 *       content/browser/browser.xul                   (content/browser.xul)
diff --git a/browser/components/places/content/bookmarksPanel.xul b/browser/components/places/content/bookmarksPanel.xul
--- a/browser/components/places/content/bookmarksPanel.xul
+++ b/browser/components/places/content/bookmarksPanel.xul
@@ -61,12 +61,11 @@
   <commandset id="editMenuCommands"/>
   <popup id="placesContext"/>
 
   <hbox align="center">
     <label value="&search.label;" accesskey="&search.accesskey;" control="search-box"/>
-    <textbox id="search-box" flex="1"
-             type="timed" timeout="500"
+    <textbox id="search-box" flex="1" type="search"
              oncommand="searchBookmarks(this.value);"/>
   </hbox>
 
   <tree id="bookmarks-view" class="sidebar-placesTree" type="places"
         flex="1"
diff --git a/browser/components/places/content/history-panel.xul b/browser/components/places/content/history-panel.xul
--- a/browser/components/places/content/history-panel.xul
+++ b/browser/components/places/content/history-panel.xul
@@ -84,11 +84,11 @@
   </popup>
 
   <hbox align="center">
     <label value="&find.label;" accesskey="&find.accesskey;" 
            control="search-box"/>
-    <textbox id="search-box" flex="1" type="timed" timeout="500"
+    <textbox id="search-box" flex="1" type="search"
              oncommand="searchHistory(this.value);"/>
     <button id="viewButton" style="min-width:0px !important;" type="menu"
             label="&view.label;" accesskey="&view.accesskey;" selectedsort="day"
             persist="selectedsort">
       <menupopup>
diff --git a/browser/components/places/content/menu.xml b/browser/components/places/content/menu.xml
--- a/browser/components/places/content/menu.xml
+++ b/browser/components/places/content/menu.xml
@@ -900,38 +900,55 @@
       <!-- nsIPlacesView -->
       <property name="insertionPoint">
         <getter><![CDATA[
           // By default, the insertion point is at the top level, at the end.
           var index = PlacesUtils.bookmarks.DEFAULT_INDEX;
-          var folderId = 0;
+          var container = null;
           var orientation = Ci.nsITreeView.DROP_BEFORE;
           var isTag = false;
 
           if (PlacesUtils.nodeIsFolder(this._resultNode)) {
-            folderId = PlacesUtils.getConcreteItemId(this._resultNode);
+            container = this._resultNode;
             isTag = PlacesUtils.nodeIsTagQuery(this._resultNode);
           }
 
           var selectedNode = this.selectedNode;
           if (selectedNode) {
             var popupNode = document.popupNode;
             if (!popupNode.node) {
               // If a static menuitem is selected the insertion point
               // is inside the folder, at the end.
-              folderId = PlacesUtils.getConcreteItemId(selectedNode);
+              container = selectedNode;
               orientation = Ci.nsITreeView.DROP_ON;
             }
             else {
               // In all other cases the insertion point is before that node.
-              folderId = PlacesUtils.getConcreteItemId(selectedNode.parent);
+              container = selectedNode.parent;
               index = PlacesUtils.getIndexOfNode(selectedNode);
               isTag = PlacesUtils.nodeIsTagQuery(selectedNode.parent);
             }
           }
-          return new InsertionPoint(folderId, index, orientation, isTag);
+
+          if (this._disallowInsertion(container))
+            return null;
+
+          return new InsertionPoint(PlacesUtils.getConcreteItemId(container),
+                                    index, orientation, isTag);
         ]]></getter>
       </property>
+
+      <method name="_disallowInsertion">
+        <parameter name="aContainer"/>
+        <body><![CDATA[
+          // allow dropping into Tag containers
+          if (PlacesUtils.nodeIsTagQuery(aContainer))
+            return false;
+          // Disallow insertion of items under readonly folders
+          return (!PlacesUtils.nodeIsFolder(aContainer) ||
+                   PlacesUtils.nodeIsReadOnly(aContainer));
+        ]]></body>
+      </method>
 
       <!-- nsIPlacesView -->
       <method name="selectAll">
         <body/>
       </method>
diff --git a/browser/components/places/content/toolbar.xml b/browser/components/places/content/toolbar.xml
--- a/browser/components/places/content/toolbar.xml
+++ b/browser/components/places/content/toolbar.xml
@@ -383,33 +383,50 @@
       <!-- nsIPlacesView -->
       <property name="insertionPoint">
         <getter><![CDATA[
           // By default, the insertion point is at the top level, at the end. 
           var index = PlacesUtils.bookmarks.DEFAULT_INDEX;
-          var folderId = PlacesUtils.getConcreteItemId(this._result.root);
+          var container = this._result.root;
           var orientation = Ci.nsITreeView.DROP_BEFORE;
           var isTag = false;
 
           var selectedNode = this.selectedNode;
           if (selectedNode) {
             var popupNode = document.popupNode;
             if (!popupNode.node) {
               // If a static menuitem is selected the insertion point
               // is inside the folder, at the end.
-              folderId = PlacesUtils.getConcreteItemId(selectedNode);
+              container = selectedNode;
               orientation = Ci.nsITreeView.DROP_ON;
             }
             else {
               // In all other cases the insertion point is before that node.
-              folderId = PlacesUtils.getConcreteItemId(selectedNode.parent);
+              container = selectedNode.parent;
               index = PlacesUtils.getIndexOfNode(selectedNode);
               isTag = PlacesUtils.nodeIsTagQuery(selectedNode.parent);
             }
           }
-          return new InsertionPoint(folderId, index, orientation, isTag);
+
+          if (this._disallowInsertion(container))
+            return null;
+
+          return new InsertionPoint(PlacesUtils.getConcreteItemId(container),
+                                    index, orientation, isTag);
         ]]></getter>
       </property>
+
+      <method name="_disallowInsertion">
+        <parameter name="aContainer"/>
+        <body><![CDATA[
+          // allow dropping into Tag containers
+          if (PlacesUtils.nodeIsTagQuery(aContainer))
+            return false;
+          // Disallow insertion of items under readonly folders
+          return (!PlacesUtils.nodeIsFolder(aContainer) ||
+                   PlacesUtils.nodeIsReadOnly(aContainer));
+        ]]></body>
+      </method>
 
       <!-- nsIPlacesView -->
       <method name="selectAll">
         <body><![CDATA[ 
           // Nothing
diff --git a/browser/components/places/content/tree.xml b/browser/components/places/content/tree.xml
--- a/browser/components/places/content/tree.xml
+++ b/browser/components/places/content/tree.xml
@@ -485,11 +485,11 @@
           this._cachedInsertionPoint =
             this._getInsertionPoint(max.value, orientation);
           return this._cachedInsertionPoint;
         ]]></getter>
       </property>
-      
+
       <method name="_disallowInsertion">
         <parameter name="aContainer"/>
         <body><![CDATA[
           // allow dropping into Tag containers
           if (PlacesUtils.nodeIsTagQuery(aContainer))
diff --git a/browser/components/preferences/applications.js b/browser/components/preferences/applications.js
--- a/browser/components/preferences/applications.js
+++ b/browser/components/preferences/applications.js
@@ -1600,40 +1600,11 @@ var gApplicationsPane = {
 
   /**
    * Filter the list when the user enters a filter term into the filter field.
    */
   filter: function() {
-    if (this._filter.value == "") {
-      this.clearFilter();
-      return;
-    }
-
     this._rebuildView();
-
-    document.getElementById("clearFilter").disabled = false;
-  },
-
-  _filterTimeout: null,
-
-  onFilterInput: function() {
-    if (this._filterTimeout)
-      clearTimeout(this._filterTimeout);
-   
-    this._filterTimeout = setTimeout("gApplicationsPane.filter()", 500);
-  },
-
-  onFilterKeyPress: function(aEvent) {
-    if (aEvent.keyCode == KeyEvent.DOM_VK_ESCAPE)
-      this.clearFilter();
-  },
-  
-  clearFilter: function() {
-    this._filter.value = "";
-    this._rebuildView();
-
-    this._filter.focus();
-    document.getElementById("clearFilter").disabled = true;
   },
 
   focusFilterBox: function() {
     this._filter.focus();
     this._filter.select();
diff --git a/browser/components/preferences/applications.xul b/browser/components/preferences/applications.xul
--- a/browser/components/preferences/applications.xul
+++ b/browser/components/preferences/applications.xul
@@ -108,16 +108,15 @@
     <keyset>
       <key key="&focusSearch1.key;" modifiers="accel" oncommand="gApplicationsPane.focusFilterBox();"/>
       <key key="&focusSearch2.key;" modifiers="accel" oncommand="gApplicationsPane.focusFilterBox();"/>
     </keyset>
 
-    <hbox align="center">
-      <label accesskey="&filter.accesskey;" control="filter">&filter.label;</label>
-      <textbox id="filter" flex="1" oninput="gApplicationsPane.onFilterInput();" 
-              onkeypress="gApplicationsPane.onFilterKeyPress(event);"/>
-      <button id="clearFilter" icon="clear" label="&clear.label;" accesskey="&clear.accesskey;" 
-              oncommand="gApplicationsPane.clearFilter();" disabled="true"/>
+    <hbox>
+      <textbox id="filter" flex="1"
+               type="search"
+               emptytext="&filter.emptytext;"
+               oncommand="gApplicationsPane.filter();"/>
     </hbox>
 
     <separator class="thin"/>
 
     <richlistbox id="handlersView" orient="vertical" persist="lastSelectedType"
diff --git a/browser/components/sessionstore/src/nsSessionStore.js b/browser/components/sessionstore/src/nsSessionStore.js
--- a/browser/components/sessionstore/src/nsSessionStore.js
+++ b/browser/components/sessionstore/src/nsSessionStore.js
@@ -226,14 +226,11 @@ SessionStoreService.prototype = {
         // set bool detecting crash
         this._lastSessionCrashed =
           this._initialState.session && this._initialState.session.state &&
           this._initialState.session.state == STATE_RUNNING_STR;
         
-        // restore the features of the first window from localstore.rdf
-        WINDOW_ATTRIBUTES.forEach(function(aAttr) {
-          delete this._initialState.windows[0][aAttr];
-        }, this);
+        // make sure that at least the first window doesn't have anything hidden
         delete this._initialState.windows[0].hidden;
       }
       catch (ex) { debug("The session file is invalid: " + ex); }
     }
     
diff --git a/browser/components/shell/src/nsWindowsShellService.cpp b/browser/components/shell/src/nsWindowsShellService.cpp
--- a/browser/components/shell/src/nsWindowsShellService.cpp
+++ b/browser/components/shell/src/nsWindowsShellService.cpp
@@ -220,32 +220,26 @@ static SETTING gSettings[] = {
   { MAKE_KEY_NAME1("HTTPS", DI),   "", VAL_FILE_ICON, APP_PATH_SUBSTITUTION },
   { MAKE_KEY_NAME1("HTTPS", SOP),  "", VAL_OPEN, APP_PATH_SUBSTITUTION }
 };
 
 PRBool
-nsWindowsShellService::IsDefaultBrowserVista(PRBool aStartupCheck, PRBool* aIsDefaultBrowser)
+nsWindowsShellService::IsDefaultBrowserVista(PRBool* aIsDefaultBrowser)
 {
 #if !defined(MOZ_DISABLE_VISTA_SDK_REQUIREMENTS)
   IApplicationAssociationRegistration* pAAR;
   
   HRESULT hr = CoCreateInstance(CLSID_ApplicationAssociationRegistration,
                                 NULL,
                                 CLSCTX_INPROC,
                                 IID_IApplicationAssociationRegistration,
                                 (void**)&pAAR);
-  
+
   if (SUCCEEDED(hr)) {
     hr = pAAR->QueryAppIsDefaultAll(AL_EFFECTIVE,
                                     APP_REG_NAME,
                                     aIsDefaultBrowser);
-    
-    // If this is the first browser window, maintain internal state that we've
-    // checked this session (so that subsequent window opens don't show the 
-    // default browser dialog).
-    if (aStartupCheck)
-      mCheckedThisSession = PR_TRUE;
-    
+
     pAAR->Release();
     return PR_TRUE;
   }
 #endif  
   return PR_FALSE;
@@ -314,30 +308,33 @@ nsWindowsShellService::IsDefaultBrowser(
     }
 
     ::ZeroMemory(currValue, sizeof(currValue));
     HKEY theKey;
     rv = OpenKeyForReading(HKEY_CLASSES_ROOT, key, &theKey);
-    if (NS_SUCCEEDED(rv)) {
-      DWORD len = sizeof currValue;
-      DWORD res = ::RegQueryValueExW(theKey, PromiseFlatString(value).get(),
-                                     NULL, NULL, (LPBYTE)currValue, &len);
-      // Close the key we opened.
-      ::RegCloseKey(theKey);
-      if (REG_FAILED(res) ||
-          !dataLongPath.Equals(currValue, CaseInsensitiveCompare) &&
-          !dataShortPath.Equals(currValue, CaseInsensitiveCompare)) {
-        // Key wasn't set, or was set to something else (something else became the default browser)
-        *aIsDefaultBrowser = PR_FALSE;
-        return NS_OK;
-      }
+    if (NS_FAILED(rv)) {
+      *aIsDefaultBrowser = PR_FALSE;
+      return NS_OK;
+    }
+
+    DWORD len = sizeof currValue;
+    DWORD res = ::RegQueryValueExW(theKey, PromiseFlatString(value).get(),
+                                   NULL, NULL, (LPBYTE)currValue, &len);
+    // Close the key we opened.
+    ::RegCloseKey(theKey);
+    if (REG_FAILED(res) ||
+        !dataLongPath.Equals(currValue, CaseInsensitiveCompare) &&
+        !dataShortPath.Equals(currValue, CaseInsensitiveCompare)) {
+      // Key wasn't set, or was set to something other than our registry entry
+      *aIsDefaultBrowser = PR_FALSE;
+      return NS_OK;
     }
   }
 
   // Only check if Firefox is the default browser on Vista if the previous
   // checks show that Firefox is the default browser.
-  if (aIsDefaultBrowser)
-    IsDefaultBrowserVista(aStartupCheck, aIsDefaultBrowser);
+  if (*aIsDefaultBrowser)
+    IsDefaultBrowserVista(aIsDefaultBrowser);
 
   return NS_OK;
 }
 
 NS_IMETHODIMP
@@ -356,25 +353,25 @@ nsWindowsShellService::SetDefaultBrowser
   NS_ENSURE_SUCCESS(rv, rv);
 
   rv = appHelper->AppendNative(NS_LITERAL_CSTRING("helper.exe"));
   NS_ENSURE_SUCCESS(rv, rv);
 
-  nsCAutoString appHelperPath;
-  rv = appHelper->GetNativePath(appHelperPath);
+  nsAutoString appHelperPath;
+  rv = appHelper->GetPath(appHelperPath);
   NS_ENSURE_SUCCESS(rv, rv);
 
   if (aForAllUsers) {
     appHelperPath.AppendLiteral(" /SetAsDefaultAppGlobal");
   } else {
     appHelperPath.AppendLiteral(" /SetAsDefaultAppUser");
   }
 
-  STARTUPINFO si = {sizeof(si), 0};
+  STARTUPINFOW si = {sizeof(si), 0};
   PROCESS_INFORMATION pi = {0};
 
-  BOOL ok = CreateProcess(NULL, (LPSTR)appHelperPath.get(), NULL, NULL,
-                          FALSE, 0, NULL, NULL, &si, &pi);
+  BOOL ok = CreateProcessW(NULL, (LPWSTR)appHelperPath.get(), NULL, NULL,
+                           FALSE, 0, NULL, NULL, &si, &pi);
 
   if (!ok)
     return NS_ERROR_FAILURE;
 
   CloseHandle(pi.hProcess);
@@ -764,12 +761,12 @@ nsWindowsShellService::GetUnreadMailCoun
     DWORD res = ::RegQueryValueExW(accountKey, L"MessageCount", 0,
                                    &type, (LPBYTE)&unreadCount, &len);
     if (REG_SUCCEEDED(res))
       *aCount = unreadCount;
 
-  // Close the key we opened.
-  ::RegCloseKey(accountKey);
+    // Close the key we opened.
+    ::RegCloseKey(accountKey);
   }
 
   return NS_OK;
 }
 
diff --git a/browser/components/shell/src/nsWindowsShellService.h b/browser/components/shell/src/nsWindowsShellService.h
--- a/browser/components/shell/src/nsWindowsShellService.h
+++ b/browser/components/shell/src/nsWindowsShellService.h
@@ -55,20 +55,13 @@ public:
   NS_DECL_ISUPPORTS
   NS_DECL_NSISHELLSERVICE
   NS_DECL_NSIWINDOWSSHELLSERVICE
 
 protected:
-  PRBool    IsDefaultBrowserVista(PRBool aStartupCheck, PRBool* aIsDefaultBrowser);
+  PRBool    IsDefaultBrowserVista(PRBool* aIsDefaultBrowser);
 
   PRBool    GetMailAccountKey(HKEY* aResult);
-  void      SetRegKey(const nsString& aKeyName,
-                      const nsString& aValueName,
-                      const nsString& aValue, PRBool aHKLMOnly);
-
-  DWORD     DeleteRegKey(HKEY baseKey, const nsString& keyName);
-  DWORD     DeleteRegKeyDefaultValue(HKEY baseKey,
-                                     const nsString& keyName);
 
 private:
   PRBool    mCheckedThisSession;
 };
 
diff --git a/browser/locales/all-locales b/browser/locales/all-locales
--- a/browser/locales/all-locales
+++ b/browser/locales/all-locales
@@ -1,9 +1,8 @@ af
 af
 ar
 be
-bg
 ca
 cs
 da
 de
 el
@@ -16,11 +15,10 @@ fy-NL
 fy-NL
 ga-IE
 gu-IN
 he
 hu
-hy-AM
 id
 it
 ja
 ja-JP-mac
 ka
@@ -36,13 +34,11 @@ pl
 pl
 pt-BR
 pt-PT
 ro
 ru
-si
 sk
-sl
 sq
 sr
 sv-SE
 tr
 uk
diff --git a/browser/locales/en-US/chrome/browser/preferences/applications.dtd b/browser/locales/en-US/chrome/browser/preferences/applications.dtd
--- a/browser/locales/en-US/chrome/browser/preferences/applications.dtd
+++ b/browser/locales/en-US/chrome/browser/preferences/applications.dtd
@@ -5,10 +5,6 @@
 <!ENTITY  actionColumn2.accesskey "A">
 
 <!ENTITY  focusSearch1.key        "f">
 <!ENTITY  focusSearch2.key        "k">
 
-<!ENTITY  filter.label            "Search:">
-<!ENTITY  filter.accesskey        "S">
-
-<!ENTITY  clear.label             "Clear">
-<!ENTITY  clear.accesskey         "l">
+<!ENTITY  filter.emptytext        "Search">
diff --git a/config/autoconf.mk.in b/config/autoconf.mk.in
--- a/config/autoconf.mk.in
+++ b/config/autoconf.mk.in
@@ -82,11 +82,14 @@ XULRUNNER_STUB_NAME = @XULRUNNER_STUB_NA
 
 MOZ_CHROME_FILE_FORMAT	= @MOZ_CHROME_FILE_FORMAT@
 
 MOZ_WIDGET_TOOLKIT	= @MOZ_WIDGET_TOOLKIT@
 MOZ_GFX_TOOLKIT		= @MOZ_GFX_TOOLKIT@
+MOZ_DFB			= @MOZ_DFB@
 MOZ_X11			= @MOZ_X11@
+
+MOZ_PANGO = @MOZ_PANGO@
 
 MOZ_JS_LIBS		   = @MOZ_JS_LIBS@
 
 MOZ_DEBUG	= @MOZ_DEBUG@
 MOZ_DEBUG_MODULES = @MOZ_DEBUG_MODULES@
diff --git a/config/system-headers b/config/system-headers
--- a/config/system-headers
+++ b/config/system-headers
@@ -78,19 +78,73 @@ cairo.h
 cairo.h
 cairo-atsui.h
 cairo-beos.h
 cairo-ft.h
 cairo-glitz.h
-cairo-nquartz.h
 cairo-os2.h
 cairo-pdf.h
 cairo-ps.h
 cairo-quartz.h
 cairo-win32.h
 cairo-xlib.h
 cairo-xlib-xrender.h
+cairo-directfb.h
+cairo-qpainter.h
 #endif
+dfiff.h
+fusion/reactor.h
+fusion/property.h
+fusion/conf.h
+fusion/build.h
+fusion/hash.h
+fusion/shm/shm.h
+fusion/shm/shm_internal.h
+fusion/shm/pool.h
+fusion/ref.h
+fusion/fusion_internal.h
+fusion/lock.h
+fusion/types.h
+fusion/vector.h
+fusion/call.h
+fusion/shmalloc.h
+fusion/protocol.h
+fusion/fusion.h
+fusion/arena.h
+fusion/object.h
+directfbgl.h
+directfb_version.h
+directfb.h
+directfb_util.h
+directfb_keynames.h
+dgiff.h
+direct/util.h
+direct/memcpy.h
+direct/interface.h
+direct/conf.h
+direct/tree.h
+direct/signals.h
+direct/build.h
+direct/interface_implementation.h
+direct/utf8.h
+direct/serial.h
+direct/hash.h
+direct/direct.h
+direct/clock.h
+direct/types.h
+direct/mem.h
+direct/thread.h
+direct/debug.h
+direct/stream.h
+direct/messages.h
+direct/trace.h
+direct/modules.h
+direct/log.h
+direct/system.h
+direct/list.h
+dfb_types.h
+directfb_strings.h
+directfb_keyboard.h
 callconv.h
 Carbon/Carbon.h
 CarbonEvents.h
 Carbon.h
 cassert
@@ -227,10 +281,11 @@ gdk/gdkprivate.h
 gdk/gdkprivate.h
 gdk/gdkscreen.h
 gdk/gdkregion.h
 gdk/gdkwindow.h
 gdk/gdkx.h
+gdk/gdkdirectfb.h
 gdk-pixbuf/gdk-pixbuf.h
 Gestalt.h
 getopt.h
 glibconfig.h
 glib.h
diff --git a/config/version_win.pl b/config/version_win.pl
--- a/config/version_win.pl
+++ b/config/version_win.pl
@@ -48,11 +48,11 @@ use POSIX;
 # Calculate the number of days since Jan. 1, 2000 from a buildid string
 sub daysFromBuildID
 {
     my ($buildid,) = @_;
 
-    my ($y, $m, $d, $h) = ($buildid =~ /^(\d{4})(\d{2})(\d{2})(\d{2})$/);
+    my ($y, $m, $d, $h) = ($buildid =~ /^(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})$/);
     $d || die("Unrecognized buildid string.");
 
     my $secondstodays = 60 * 60 * 24;
     return (POSIX::mktime(00, 00, 00, $d, $m, $y - 1900) -
             POSIX::mktime(00, 00, 00, 01, 01, 100)) / $secondstodays;
diff --git a/configure.in b/configure.in
--- a/configure.in
+++ b/configure.in
@@ -963,11 +963,11 @@ MOZ_PNG_CFLAGS=
 MOZ_PNG_CFLAGS=
 MOZ_PNG_LIBS='$(call EXPAND_LIBNAME_PATH,mozpng,$(DEPTH)/modules/libimg/png)'
 
 MOZ_JS_LIBS='-L$(LIBXUL_DIST)/bin -lmozjs'
 DYNAMIC_XPCOM_LIBS='-L$(LIBXUL_DIST)/bin -lxpcom -lxpcom_core'
-MOZ_FIX_LINK_PATHS='-Wl,-rpath-link,$(LIBXUL_DIST)/bin'
+MOZ_FIX_LINK_PATHS='-Wl,-rpath-link,$(LIBXUL_DIST)/bin -Wl,-rpath-link,$(PREFIX)/lib'
 XPCOM_FROZEN_LDOPTS='-L$(LIBXUL_DIST)/bin -lxpcom'
 LIBXUL_LIBS='$(XPCOM_FROZEN_LDOPTS) -lxul'
 XPCOM_GLUE_LDOPTS='$(LIBXUL_DIST)/lib/$(LIB_PREFIX)xpcomglue_s.$(LIB_SUFFIX) $(XPCOM_FROZEN_LDOPTS)'
 XPCOM_STANDALONE_GLUE_LDOPTS='$(LIBXUL_DIST)/lib/$(LIB_PREFIX)xpcomglue.$(LIB_SUFFIX)'
 
@@ -4706,31 +4706,30 @@ MOZ_ARG_HEADER(Toolkit Options)
                             Mac OS X - cairo-cocoa
                             Neutrino/QNX - photon
                             OS/2 - cairo-os2
                             Win32 - cairo-windows
                             WinCE - windows
+                            Gtk2 with DirectFB - cairo-gtk2-dfb
                             * - cairo-gtk2],
     [ _DEFAULT_TOOLKIT=$enableval ],
     [ _DEFAULT_TOOLKIT=$_PLATFORM_DEFAULT_TOOLKIT])
 
     if test "$_DEFAULT_TOOLKIT" = "photon" \
         -o "$_DEFAULT_TOOLKIT" = "cairo-windows" \
         -o "$_DEFAULT_TOOLKIT" = "cairo-gtk2" \
+        -o "$_DEFAULT_TOOLKIT" = "cairo-gtk2-dfb" \
+        -o "$_DEFAULT_TOOLKIT" = "cairo-gtk2-x11" \
         -o "$_DEFAULT_TOOLKIT" = "cairo-beos" \
         -o "$_DEFAULT_TOOLKIT" = "cairo-os2" \
         -o "$_DEFAULT_TOOLKIT" = "cairo-mac" \
         -o "$_DEFAULT_TOOLKIT" = "cairo-cocoa"
     then
         dnl nglayout only supports building with one toolkit,
         dnl so ignore everything after the first comma (",").
         MOZ_WIDGET_TOOLKIT=`echo "$_DEFAULT_TOOLKIT" | sed -e "s/,.*$//"`
     else
-        if test "$no_x" != "yes"; then
-            AC_MSG_ERROR([Toolkit must be cairo-gtk2.])
-        else
-            AC_MSG_ERROR([Toolkit must be $_PLATFORM_DEFAULT_TOOLKIT (if supported).])
-        fi
+        AC_MSG_ERROR([You must specify a default toolkit (perhaps $_PLATFORM_DEFAULT_TOOLKIT).])
     fi
 
 AC_DEFINE_UNQUOTED(MOZ_DEFAULT_TOOLKIT,"$MOZ_WIDGET_TOOLKIT")
 
 dnl ========================================================
@@ -4746,19 +4745,41 @@ cairo-windows)
 cairo-windows)
     MOZ_WIDGET_TOOLKIT=windows
     MOZ_GFX_TOOLKIT=cairo
     ;;
 
-cairo-gtk2)
+cairo-gtk2|cairo-gtk2-x11)
     MOZ_WIDGET_TOOLKIT=gtk2
     MOZ_GFX_TOOLKIT=cairo
     MOZ_ENABLE_GTK2=1
     MOZ_ENABLE_XREMOTE=1
+
+    AC_DEFINE(MOZ_X11)
+    MOZ_X11=1
+
     TK_CFLAGS='$(MOZ_GTK2_CFLAGS)'
     TK_LIBS='$(MOZ_GTK2_LIBS)'
     AC_DEFINE(MOZ_WIDGET_GTK2)
     ;;
+
+cairo-gtk2-dfb)
+    MOZ_WIDGET_TOOLKIT=gtk2
+    MOZ_GFX_TOOLKIT=cairo
+    MOZ_ENABLE_GTK2=1
+
+    AC_DEFINE(MOZ_DFB)
+    MOZ_DFB=1
+
+    TK_CFLAGS='$(MOZ_GTK2_CFLAGS)'
+    TK_LIBS='$(MOZ_GTK2_LIBS)'
+    AC_DEFINE(MOZ_WIDGET_GTK2)
+    if test "$no_x" != "yes"; then
+        AC_MSG_WARN([Disabling X when DirectFB is specified.])
+        no_x=yes
+    fi
+    ;;
+
 cairo-beos)
     MOZ_WIDGET_TOOLKIT=beos
     MOZ_GFX_TOOLKIT=cairo
     TK_CFLAGS='$(MOZ_CAIRO_CFLAGS)'
     TK_LIBS='$(MOZ_CAIRO_LIBS)'
@@ -4794,14 +4815,21 @@ if test "$MOZ_ENABLE_XREMOTE"; then
 if test "$MOZ_ENABLE_XREMOTE"; then
     AC_DEFINE(MOZ_ENABLE_XREMOTE)
 fi
 
 if test "$COMPILE_ENVIRONMENT"; then
-if test "$MOZ_ENABLE_GTK2"
-then
-    PKG_CHECK_MODULES(MOZ_GTK2, gtk+-2.0 >= $GTK2_VERSION gtk+-unix-print-2.0 gdk-x11-2.0 glib-2.0 gobject-2.0)
-fi
+  if test "$MOZ_ENABLE_GTK2"; then
+    if test "$MOZ_X11"; then
+      GDK_PACKAGES=gdk-x11-2.0
+    elif test "$MOZ_DFB"; then
+      PKG_CHECK_MODULES(MOZ_DFB, directfb >= 1.1.0)
+      GDK_PACKAGES=directfb
+    fi
+
+    PKG_CHECK_MODULES(MOZ_GTK2, gtk+-2.0 >= $GTK2_VERSION gtk+-unix-print-2.0 glib-2.0 gobject-2.0 $GDK_PACKAGES)
+  fi
+
 fi # COMPILE_ENVIRONMENT
 
 AC_SUBST(MOZ_DEFAULT_TOOLKIT)
 
 dnl ========================================================
@@ -4851,15 +4879,11 @@ AC_SUBST(MOZ_GTK2_CFLAGS)
 AC_SUBST(MOZ_GTK2_CFLAGS)
 AC_SUBST(MOZ_GTK2_LIBS)
 
 AC_SUBST(MOC)
 
-if test "$MOZ_ENABLE_GTK2"
-then
-    AC_DEFINE(MOZ_X11)
-    MOZ_X11=1
-fi
+AC_SUBST(MOZ_DFB)
 AC_SUBST(MOZ_X11)
 
 dnl ========================================================
 dnl =
 dnl = Components & Features
@@ -4970,23 +4994,51 @@ fi
 fi
 
 AC_DEFINE_UNQUOTED(MOZ_DISTRIBUTION_ID,"$MOZ_DISTRIBUTION_ID")
 AC_SUBST(MOZ_DISTRIBUTION_ID)
 
+
+dnl ========================================================
+dnl complex text support off by default
+dnl ========================================================
+MOZ_PANGO=1
+MOZ_ARG_DISABLE_BOOL(pango,
+[  --disable-pango Disable usage of Pango ],
+    MOZ_PANGO=,
+    MOZ_PANGO=1)
+
+
 dnl ========================================================
 dnl = Xft and Pango
 dnl ========================================================
 if test "$MOZ_ENABLE_GTK2"
 then
-    PKG_CHECK_MODULES(MOZ_XFT, xft)
-    AC_SUBST(MOZ_XFT_CFLAGS)
-    AC_SUBST(MOZ_XFT_LIBS)
+    if test "$MOZ_X11"; then
+        PKG_CHECK_MODULES(MOZ_XFT, xft)
+        AC_SUBST(MOZ_XFT_CFLAGS)
+        AC_SUBST(MOZ_XFT_LIBS)
+    fi
+
+    AC_SUBST(MOZ_PANGO)
 
     PKG_CHECK_MODULES(_PANGOCHK, pango >= $PANGO_VERSION)
-    PKG_CHECK_MODULES(MOZ_PANGO, pango >= $PANGO_VERSION pangocairo >= $PANGO_VERSION pangoft2 >= $PANGO_VERSION)
-    AC_SUBST(MOZ_PANGO_CFLAGS)
-    AC_SUBST(MOZ_PANGO_LIBS)
+
+    if test "$MOZ_PANGO"
+    then
+        PKG_CHECK_MODULES(MOZ_PANGO, pango >= $PANGO_VERSION pangocairo >= $PANGO_VERSION pangoft2 >= $PANGO_VERSION)
+        AC_SUBST(MOZ_PANGO_CFLAGS)
+        AC_SUBST(MOZ_PANGO_LIBS)
+        AC_DEFINE(MOZ_PANGO)
+    else
+        PKG_CHECK_MODULES(MOZ_PANGO, pango >= $PANGO_VERSION pangoft2 >= $PANGO_VERSION)
+        AC_SUBST(MOZ_PANGO_CFLAGS)
+        AC_SUBST(MOZ_PANGO_LIBS)
+
+        PKG_CHECK_MODULES(FT2, freetype2 > 6.1.0 fontconfig)
+        AC_SUBST(FT2_CFLAGS)
+        AC_SUBST(FT2_LIBS)
+    fi
 fi
 
 dnl ========================================================
 dnl = PostScript print module
 dnl ========================================================
diff --git a/content/base/public/nsIDocument.h b/content/base/public/nsIDocument.h
--- a/content/base/public/nsIDocument.h
+++ b/content/base/public/nsIDocument.h
@@ -221,13 +221,11 @@ public:
    */
   virtual void GetBaseTarget(nsAString &aBaseTarget) const = 0;
   virtual void SetBaseTarget(const nsAString &aBaseTarget) = 0;
 
   /**
-   * Return a standard name for the document's character set. This
-   * will trigger a startDocumentLoad if necessary to answer the
-   * question.
+   * Return a standard name for the document's character set.
    */
   const nsCString& GetDocumentCharacterSet() const
   {
     return mCharacterSet;
   }
diff --git a/content/base/public/nsIFrameLoader.idl b/content/base/public/nsIFrameLoader.idl
--- a/content/base/public/nsIFrameLoader.idl
+++ b/content/base/public/nsIFrameLoader.idl
@@ -74,10 +74,25 @@ interface nsIFrameLoader : nsISupports
    * or may not be allowed on the loader's docshell.
    */
   readonly attribute boolean depthTooGreat;
 };
 
-[scriptable, uuid(feaf9285-05ac-4898-a69f-c3bd350767e4)]
+[scriptable, uuid(641c2d90-4ada-4367-bdb1-80831614161d)]
 interface nsIFrameLoaderOwner : nsISupports
 {
+  /**
+   * The frame loader owned by this nsIFrameLoaderOwner
+   */
   readonly attribute nsIFrameLoader frameLoader;
+
+  /**
+   * Swap frame loaders with the given nsIFrameLoaderOwner.  This may
+   * only be posible in a very limited range of circumstances, or
+   * never, depending on the object implementing this interface.
+   *
+   * @throws NS_ERROR_NOT_IMPLEMENTED if the swapping logic is not
+   *   implemented for the two given frame loader owners.
+   * @throws NS_ERROR_DOM_SECURITY_ERR if the swap is not allowed on
+   *   security grounds.
+   */
+  void swapFrameLoaders(in nsIFrameLoaderOwner aOtherOwner);
 };
diff --git a/content/base/public/nsIScriptElement.h b/content/base/public/nsIScriptElement.h
--- a/content/base/public/nsIScriptElement.h
+++ b/content/base/public/nsIScriptElement.h
@@ -79,11 +79,16 @@ public:
    * Script source text for inline script elements.
    */
   virtual void GetScriptText(nsAString& text) = 0;
 
   virtual void GetScriptCharset(nsAString& charset) = 0;
-  
+
+  /**
+   * Is the script deferred. Currently only supported by HTML scripts.
+   */
+  virtual PRBool GetScriptDeferred() = 0;
+
   void SetScriptLineNumber(PRUint32 aLineNumber)
   {
     mLineNumber = aLineNumber;
   }
   PRUint32 GetScriptLineNumber()
diff --git a/content/base/public/nsPresShellIterator.h b/content/base/public/nsPresShellIterator.h
--- a/content/base/public/nsPresShellIterator.h
+++ b/content/base/public/nsPresShellIterator.h
@@ -56,10 +56,15 @@ public:
       shell = GetNext();
       NS_IF_ADDREF(shell);
     }
     return shell;
   }
+
+  PRBool HasMoreThanOneShell() {
+    return mDoc->mPresShells.Length() > 1;
+  }
+  
 private:
   static void* operator new(size_t) CPP_THROW_NEW { return 0; }
   static void operator delete(void*, size_t) {}
 
   nsCOMPtr<nsIDocument> mDoc;
diff --git a/content/base/src/nsDocument.cpp b/content/base/src/nsDocument.cpp
--- a/content/base/src/nsDocument.cpp
+++ b/content/base/src/nsDocument.cpp
@@ -1709,10 +1709,12 @@ nsDocument::StartDocumentLoad(const char
     CSSLoader()->SetEnabled(PR_FALSE); // Do not load/process styles when loading as data
   }
 
   mMayStartLayout = PR_FALSE;
 
+  mHaveInputEncoding = PR_TRUE;
+
   if (aReset) {
     Reset(aChannel, aLoadGroup);
   }
 
   nsCAutoString contentType;
@@ -3172,10 +3174,14 @@ nsDocument::BeginLoad()
 {
   // Block onload here to prevent having to deal with blocking and
   // unblocking it while we know the document is loading.
   BlockOnload();
 
+  if (mScriptLoader) {
+    mScriptLoader->BeginDeferringScripts();
+  }
+
   NS_DOCUMENT_NOTIFY_OBSERVERS(BeginLoad, (this));
 }
 
 PRBool
 nsDocument::CheckGetElementByIdArg(const nsIAtom* aId)
@@ -3413,10 +3419,14 @@ nsDocument::DispatchContentLoadedEvents(
         }
       }
       
       parent = parent->GetParentDocument();
     } while (parent);
+  }
+
+  if (mScriptLoader) {
+    mScriptLoader->EndDeferringScripts();
   }
 
   UnblockOnload(PR_TRUE);
 }
 
@@ -4957,11 +4967,16 @@ nsDocument::LookupNamespaceURI(const nsA
 }
 
 NS_IMETHODIMP
 nsDocument::GetInputEncoding(nsAString& aInputEncoding)
 {
-  return GetCharacterSet(aInputEncoding);
+  if (mHaveInputEncoding) {
+    return GetCharacterSet(aInputEncoding);
+  }
+
+  SetDOMStringToNull(aInputEncoding);
+  return NS_OK;
 }
 
 NS_IMETHODIMP
 nsDocument::GetXmlEncoding(nsAString& aXmlEncoding)
 {
diff --git a/content/base/src/nsDocument.h b/content/base/src/nsDocument.h
--- a/content/base/src/nsDocument.h
+++ b/content/base/src/nsDocument.h
@@ -945,10 +945,14 @@ protected:
 
   PRPackedBool mDelayFrameLoaderInitialization:1;
 
   PRPackedBool mSynchronousDOMContentLoaded:1;
 
+  // If true, we have an input encoding.  If this is false, then the
+  // document was created entirely in memory
+  PRPackedBool mHaveInputEncoding:1;
+
   PRUint8 mXMLDeclarationBits;
 
   PRUint8 mDefaultElementType;
 
   PRBool IdTableIsLive() const {
diff --git a/content/base/src/nsDocumentEncoder.cpp b/content/base/src/nsDocumentEncoder.cpp
--- a/content/base/src/nsDocumentEncoder.cpp
+++ b/content/base/src/nsDocumentEncoder.cpp
@@ -352,11 +352,11 @@ nsDocumentEncoder::SerializeToStringRecu
 nsDocumentEncoder::SerializeToStringRecursive(nsIDOMNode* aNode,
                                               nsAString& aStr,
                                               PRBool aDontSerializeRoot)
 {
   nsresult rv = NS_OK;
-  PRBool serializeClonedChildren;
+  PRBool serializeClonedChildren = PR_FALSE;
   nsCOMPtr<nsIDOMNode> maybeFixedNode;
   
   if (mNodeFixup)
     mNodeFixup->FixupNode(aNode, &serializeClonedChildren, getter_AddRefs(maybeFixedNode));
 
diff --git a/content/base/src/nsFrameLoader.cpp b/content/base/src/nsFrameLoader.cpp
--- a/content/base/src/nsFrameLoader.cpp
+++ b/content/base/src/nsFrameLoader.cpp
@@ -20,10 +20,11 @@
  * Portions created by the Initial Developer are Copyright (C) 1998
  * the Initial Developer. All Rights Reserved.
  *
  * Contributor(s):
  *   Johnny Stenback <jst@netscape.com> (original author)
+ *   Boris Zbarsky <bzbarsky@mit.edu>
  *
  * Alternatively, the contents of this file may be used under the terms of
  * either of the GNU General Public License Version 2 or later (the "GPL"),
  * or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
  * in which case the provisions of the GPL or the LGPL are applicable instead
@@ -63,10 +64,16 @@
 #include "nsUnicharUtils.h"
 #include "nsIScriptGlobalObject.h"
 #include "nsIScriptSecurityManager.h"
 #include "nsFrameLoader.h"
 #include "nsIDOMEventTarget.h"
+#include "nsIFrame.h"
+#include "nsIFrameFrame.h"
+#include "nsDOMError.h"
+#include "nsPresShellIterator.h"
+#include "nsGUIEvent.h"
+#include "nsEventDispatcher.h"
 
 #include "nsIURI.h"
 #include "nsIURL.h"
 #include "nsNetUtil.h"
 
@@ -279,10 +286,371 @@ nsFrameLoader::Finalize()
     base_win->Destroy();
   }
   mDocShell = nsnull;
 }
 
+static void
+FirePageHideEvent(nsIDocShellTreeItem* aItem,
+                  nsIDOMEventTarget* aChromeEventHandler)
+{
+  nsPageTransitionEvent event(PR_TRUE, NS_PAGE_HIDE, PR_TRUE);
+  nsCOMPtr<nsIDOMDocument> doc = do_GetInterface(aItem);
+  event.target = do_QueryInterface(doc);
+  nsEventDispatcher::Dispatch(aChromeEventHandler, nsnull, &event);
+  
+  PRInt32 childCount = 0;
+  aItem->GetChildCount(&childCount);
+  nsAutoTArray<nsCOMPtr<nsIDocShellTreeItem>, 8> kids;
+  kids.AppendElements(childCount);
+  for (PRInt32 i = 0; i < childCount; ++i) {
+    aItem->GetChildAt(i, getter_AddRefs(kids[i]));
+  }
+
+  for (PRUint32 i = 0; i < kids.Length(); ++i) {
+    if (kids[i]) {
+      FirePageHideEvent(kids[i], aChromeEventHandler);
+    }
+  }
+}
+
+static void
+FirePageShowEvent(nsIDocShellTreeItem* aItem,
+                  nsIDOMEventTarget* aChromeEventHandler)
+{
+  PRInt32 childCount = 0;
+  aItem->GetChildCount(&childCount);
+  nsAutoTArray<nsCOMPtr<nsIDocShellTreeItem>, 8> kids;
+  kids.AppendElements(childCount);
+  for (PRInt32 i = 0; i < childCount; ++i) {
+    aItem->GetChildAt(i, getter_AddRefs(kids[i]));
+  }
+
+  for (PRUint32 i = 0; i < kids.Length(); ++i) {
+    if (kids[i]) {
+      FirePageShowEvent(kids[i], aChromeEventHandler);
+    }
+  }
+
+  nsPageTransitionEvent event(PR_TRUE, NS_PAGE_SHOW, PR_TRUE);
+  nsCOMPtr<nsIDOMDocument> doc = do_GetInterface(aItem);
+  event.target = do_QueryInterface(doc);
+  nsEventDispatcher::Dispatch(aChromeEventHandler, nsnull, &event);
+}
+
+static void
+SetTreeOwnerAndChromeEventHandlerOnDocshellTree(nsIDocShellTreeItem* aItem,
+                                                nsIDocShellTreeOwner* aOwner,
+                                                nsIDOMEventTarget* aHandler)
+{
+  NS_PRECONDITION(aItem, "Must have item");
+#ifdef DEBUG
+  PRInt32 itemType;
+  aItem->GetItemType(&itemType);
+  NS_ASSERTION(itemType == nsIDocShellTreeItem::typeContent,
+               "How did something else get in here?");
+#endif
+
+  aItem->SetTreeOwner(aOwner);
+  nsCOMPtr<nsIDocShell> shell(do_QueryInterface(aItem));
+  shell->SetChromeEventHandler(aHandler);
+
+  PRInt32 childCount = 0;
+  aItem->GetChildCount(&childCount);
+  for (PRInt32 i = 0; i < childCount; ++i) {
+    nsCOMPtr<nsIDocShellTreeItem> item;
+    aItem->GetChildAt(i, getter_AddRefs(item));
+    SetTreeOwnerAndChromeEventHandlerOnDocshellTree(item, aOwner, aHandler);
+  }
+}
+
+/**
+ * Set the type of the treeitem and hook it up to the treeowner.
+ * @param aItem the treeitem we're wrking working with
+ * @param aOwningContent the content node that owns aItem
+ * @param aTreeOwner the relevant treeowner; might be null
+ * @param aParentType the nsIDocShellTreeItem::GetType of our parent docshell
+ * @param aParentNode if non-null, the docshell we should be added as a child to
+ *
+ * @return whether aItem is top-level content
+ */
+static PRBool
+AddTreeItemToTreeOwner(nsIDocShellTreeItem* aItem, nsIContent* aOwningContent,
+                       nsIDocShellTreeOwner* aOwner, PRInt32 aParentType,
+                       nsIDocShellTreeNode* aParentNode)
+{
+  NS_PRECONDITION(aItem, "Must have docshell treeitem");
+  NS_PRECONDITION(aOwningContent, "Must have owning content");
+  
+  nsAutoString value;
+  PRBool isContent = PR_FALSE;
+
+  if (aOwningContent->IsNodeOfType(nsINode::eXUL)) {
+      aOwningContent->GetAttr(kNameSpaceID_None, nsGkAtoms::type, value);
+  }
+
+  // we accept "content" and "content-xxx" values.
+  // at time of writing, we expect "xxx" to be "primary" or "targetable", but
+  // someday it might be an integer expressing priority or something else.
+
+  isContent = value.LowerCaseEqualsLiteral("content") ||
+    StringBeginsWith(value, NS_LITERAL_STRING("content-"),
+                     nsCaseInsensitiveStringComparator());
+
+  if (isContent) {
+    // The web shell's type is content.
+
+    aItem->SetItemType(nsIDocShellTreeItem::typeContent);
+  } else {
+    // Inherit our type from our parent webshell.  If it is
+    // chrome, we'll be chrome.  If it is content, we'll be
+    // content.
+
+    aItem->SetItemType(aParentType);
+  }
+
+  // Now that we have our type set, add ourselves to the parent, as needed.
+  if (aParentNode) {
+    aParentNode->AddChild(aItem);
+  }
+
+  PRBool retval = PR_FALSE;
+  if (aParentType == nsIDocShellTreeItem::typeChrome && isContent) {
+    retval = PR_TRUE;
+
+    PRBool is_primary = value.LowerCaseEqualsLiteral("content-primary");
+
+    if (aOwner) {
+      PRBool is_targetable = is_primary ||
+        value.LowerCaseEqualsLiteral("content-targetable");
+      aOwner->ContentShellAdded(aItem, is_primary, is_targetable, value);
+    }
+  }
+
+  return retval;
+}
+
+nsresult
+nsFrameLoader::SwapWithOtherLoader(nsFrameLoader* aOther,
+                                   nsRefPtr<nsFrameLoader>& aFirstToSwap,
+                                   nsRefPtr<nsFrameLoader>& aSecondToSwap)
+{
+  NS_PRECONDITION((aFirstToSwap == this && aSecondToSwap == aOther) ||
+                  (aFirstToSwap == aOther && aSecondToSwap == this),
+                  "Swapping some sort of random loaders?");
+
+  nsIContent* ourContent = mOwnerContent;
+  nsIContent* otherContent = aOther->mOwnerContent;
+
+  if (!ourContent || !otherContent) {
+    // Can't handle this
+    return NS_ERROR_NOT_IMPLEMENTED;
+  }
+
+  // Make sure there are no same-origin issues
+  PRBool equal;
+  nsresult rv =
+    ourContent->NodePrincipal()->Equals(otherContent->NodePrincipal(), &equal);
+  if (NS_FAILED(rv) || !equal) {
+    // Security problems loom.  Just bail on it all
+    return NS_ERROR_DOM_SECURITY_ERR;
+  }
+
+  nsCOMPtr<nsIDocShell> ourDochell = GetExistingDocShell();
+  nsCOMPtr<nsIDocShell> otherDocshell = aOther->GetExistingDocShell();
+  if (!ourDochell || !otherDocshell) {
+    // How odd
+    return NS_ERROR_NOT_IMPLEMENTED;
+  }
+
+  // To avoid having to mess with session history, avoid swapping
+  // frameloaders that don't correspond to root same-type docshells.
+  nsCOMPtr<nsIDocShellTreeItem> ourTreeItem = do_QueryInterface(ourDochell);
+  nsCOMPtr<nsIDocShellTreeItem> otherTreeItem =
+    do_QueryInterface(otherDocshell);
+  nsCOMPtr<nsIDocShellTreeItem> ourRootTreeItem, otherRootTreeItem;
+  ourTreeItem->GetSameTypeRootTreeItem(getter_AddRefs(ourRootTreeItem));
+  otherTreeItem->GetSameTypeRootTreeItem(getter_AddRefs(otherRootTreeItem));
+  if (ourRootTreeItem != ourTreeItem || otherRootTreeItem != otherTreeItem) {
+    return NS_ERROR_NOT_IMPLEMENTED;
+  }
+
+  // Also make sure that the two docshells are the same type. Otherwise
+  // swapping is certainly not safe.  As far as that goes, make sure we only
+  // swap typeContent docshells, since otherwise it's hard to get treeowners
+  // right.
+  PRInt32 ourType = nsIDocShellTreeItem::typeChrome;
+  PRInt32 otherType = nsIDocShellTreeItem::typeChrome;
+  ourTreeItem->GetItemType(&ourType);
+  otherTreeItem->GetItemType(&otherType);
+  if (ourType != nsIDocShellTreeItem::typeContent ||
+      otherType != nsIDocShellTreeItem::typeContent) {
+    return NS_ERROR_NOT_IMPLEMENTED;
+  }
+  
+  // Save off the tree owners, frame elements, chrome event handlers, and
+  // docshell and document parents before doing anything else.
+  nsCOMPtr<nsIDocShellTreeOwner> ourOwner, otherOwner;
+  ourTreeItem->GetTreeOwner(getter_AddRefs(ourOwner));
+  otherTreeItem->GetTreeOwner(getter_AddRefs(otherOwner));
+  // Note: it's OK to have null treeowners.
+
+  nsCOMPtr<nsIDocShellTreeItem> ourParentItem, otherParentItem;
+  ourTreeItem->GetParent(getter_AddRefs(ourParentItem));
+  otherTreeItem->GetParent(getter_AddRefs(otherParentItem));
+  if (!ourParentItem || !otherParentItem) {
+    return NS_ERROR_NOT_IMPLEMENTED;
+  }
+
+  nsCOMPtr<nsPIDOMWindow> ourWindow = do_GetInterface(ourDochell);
+  nsCOMPtr<nsPIDOMWindow> otherWindow = do_GetInterface(otherDocshell);
+
+  nsCOMPtr<nsIDOMElement> ourFrameElement =
+    ourWindow->GetFrameElementInternal();
+  nsCOMPtr<nsIDOMElement> otherFrameElement =
+    otherWindow->GetFrameElementInternal();
+
+  nsCOMPtr<nsIDOMEventTarget> ourChromeEventHandler =
+    do_QueryInterface(ourWindow->GetChromeEventHandler());
+  nsCOMPtr<nsIDOMEventTarget> otherChromeEventHandler =
+    do_QueryInterface(otherWindow->GetChromeEventHandler());
+
+  NS_ASSERTION(SameCOMIdentity(ourFrameElement, ourContent) &&
+               SameCOMIdentity(otherFrameElement, otherContent) &&
+               SameCOMIdentity(ourChromeEventHandler, ourContent) &&
+               SameCOMIdentity(otherChromeEventHandler, otherContent),
+               "How did that happen, exactly?");
+
+  nsCOMPtr<nsIDocument> ourChildDocument =
+    do_QueryInterface(ourWindow->GetExtantDocument());
+  nsCOMPtr<nsIDocument> otherChildDocument =
+    do_QueryInterface(otherWindow->GetExtantDocument());
+  if (!ourChildDocument || !otherChildDocument) {
+    // This shouldn't be happening
+    return NS_ERROR_NOT_IMPLEMENTED;
+  }
+
+  nsCOMPtr<nsIDocument> ourParentDocument =
+    ourChildDocument->GetParentDocument();
+  nsCOMPtr<nsIDocument> otherParentDocument =
+    otherChildDocument->GetParentDocument();
+
+  // Make sure to swap docshells between the two frames.
+  nsIDocument* ourDoc = ourContent->GetCurrentDoc();
+  nsIDocument* otherDoc = otherContent->GetCurrentDoc();
+  if (!ourDoc || !otherDoc) {
+    // Again, how odd, given that we had docshells
+    return NS_ERROR_NOT_IMPLEMENTED;
+  }
+
+  NS_ASSERTION(ourDoc == ourParentDocument, "Unexpected parent document");
+  NS_ASSERTION(otherDoc == otherParentDocument, "Unexpected parent document");
+
+  nsPresShellIterator iter1(ourDoc);
+  nsPresShellIterator iter2(otherDoc);
+  if (iter1.HasMoreThanOneShell() || iter2.HasMoreThanOneShell()) {
+    return NS_ERROR_NOT_IMPLEMENTED;
+  }
+
+  nsIPresShell* ourShell = ourDoc->GetPrimaryShell();
+  nsIPresShell* otherShell = otherDoc->GetPrimaryShell();
+  if (!ourShell || !otherShell) {
+    return NS_ERROR_NOT_IMPLEMENTED;
+  }
+
+  if (mInSwap || aOther->mInSwap) {
+    return NS_ERROR_NOT_IMPLEMENTED;
+  }
+  mInSwap = aOther->mInSwap = PR_TRUE;
+
+  // Fire pagehide events.  Note that we do NOT fire these in the normal way,
+  // but just fire them on the chrome event handlers.
+  FirePageHideEvent(ourTreeItem, ourChromeEventHandler);
+  FirePageHideEvent(otherTreeItem, otherChromeEventHandler);
+  
+  nsIFrame* ourFrame = ourShell->GetPrimaryFrameFor(ourContent);
+  nsIFrame* otherFrame = otherShell->GetPrimaryFrameFor(otherContent);
+  if (!ourFrame || !otherFrame) {
+    mInSwap = aOther->mInSwap = PR_FALSE;
+    FirePageShowEvent(ourTreeItem, ourChromeEventHandler);
+    FirePageShowEvent(otherTreeItem, otherChromeEventHandler);
+    return NS_ERROR_NOT_IMPLEMENTED;
+  }
+
+  nsIFrameFrame* ourFrameFrame = nsnull;
+  CallQueryInterface(ourFrame, &ourFrameFrame);
+  if (!ourFrameFrame) {
+    mInSwap = aOther->mInSwap = PR_FALSE;
+    FirePageShowEvent(ourTreeItem, ourChromeEventHandler);
+    FirePageShowEvent(otherTreeItem, otherChromeEventHandler);
+    return NS_ERROR_NOT_IMPLEMENTED;
+  }
+
+  // OK.  First begin to swap the docshells in the two nsIFrames
+  rv = ourFrameFrame->BeginSwapDocShells(otherFrame);
+  if (NS_FAILED(rv)) {
+    mInSwap = aOther->mInSwap = PR_FALSE;
+    FirePageShowEvent(ourTreeItem, ourChromeEventHandler);
+    FirePageShowEvent(otherTreeItem, otherChromeEventHandler);
+    return rv;
+  }
+
+  // Now move the docshells to the right docshell trees.  Note that this
+  // resets their treeowners to null.
+  ourParentItem->RemoveChild(ourTreeItem);
+  otherParentItem->RemoveChild(otherTreeItem);
+  if (ourType == nsIDocShellTreeItem::typeContent) {
+    ourOwner->ContentShellRemoved(ourTreeItem);
+    otherOwner->ContentShellRemoved(otherTreeItem);
+  }
+  
+  ourParentItem->AddChild(otherTreeItem);
+  otherParentItem->AddChild(ourTreeItem);
+
+  // Restore the correct treeowners
+  SetTreeOwnerAndChromeEventHandlerOnDocshellTree(ourTreeItem, otherOwner,
+                                                  otherChromeEventHandler);
+  SetTreeOwnerAndChromeEventHandlerOnDocshellTree(otherTreeItem, ourOwner,
+                                                  ourChromeEventHandler);
+
+  AddTreeItemToTreeOwner(ourTreeItem, otherContent, otherOwner,
+                         nsIDocShellTreeItem::typeChrome, nsnull);
+  AddTreeItemToTreeOwner(otherTreeItem, ourContent, ourOwner,
+                         nsIDocShellTreeItem::typeChrome, nsnull);
+
+  // SetSubDocumentFor nulls out parent documents on the old child doc if a
+  // new non-null document is passed in, so just go ahead and remove both
+  // kids before reinserting in the parent subdoc maps, to avoid
+  // complications.
+  ourParentDocument->SetSubDocumentFor(ourContent, nsnull);
+  otherParentDocument->SetSubDocumentFor(otherContent, nsnull);
+  ourParentDocument->SetSubDocumentFor(ourContent, otherChildDocument);
+  otherParentDocument->SetSubDocumentFor(otherContent, ourChildDocument);
+
+  ourWindow->SetFrameElementInternal(otherFrameElement);
+  otherWindow->SetFrameElementInternal(ourFrameElement);
+
+  mOwnerContent = otherContent;
+  aOther->mOwnerContent = ourContent;
+
+  aFirstToSwap.swap(aSecondToSwap);
+
+  // We shouldn't have changed frames, but be really careful about it
+  if (ourFrame == ourShell->GetPrimaryFrameFor(ourContent) &&
+      otherFrame == otherShell->GetPrimaryFrameFor(otherContent)) {
+    ourFrameFrame->EndSwapDocShells(otherFrame);
+  }
+
+  ourParentDocument->FlushPendingNotifications(Flush_Layout);
+  otherParentDocument->FlushPendingNotifications(Flush_Layout);
+  
+  FirePageShowEvent(ourTreeItem, otherChromeEventHandler);
+  FirePageShowEvent(otherTreeItem, ourChromeEventHandler);
+
+  mInSwap = aOther->mInSwap = PR_FALSE;
+  return NS_OK;
+}
+
 NS_IMETHODIMP
 nsFrameLoader::Destroy()
 {
   if (mDestroyCalled) {
     return NS_OK;
@@ -400,56 +768,17 @@ nsFrameLoader::EnsureDocShell()
       do_QueryInterface(parentAsNode);
 
     PRInt32 parentType;
     parentAsItem->GetItemType(&parentType);
 
-    nsAutoString value;
-    PRBool isContent = PR_FALSE;
-
-    if (mOwnerContent->IsNodeOfType(nsINode::eXUL)) {
-      mOwnerContent->GetAttr(kNameSpaceID_None, nsGkAtoms::type, value);
-    }
-
-    // we accept "content" and "content-xxx" values.
-    // at time of writing, we expect "xxx" to be "primary" or "targetable", but
-    // someday it might be an integer expressing priority or something else.
-
-    isContent = value.LowerCaseEqualsLiteral("content") ||
-      StringBeginsWith(value, NS_LITERAL_STRING("content-"),
-                       nsCaseInsensitiveStringComparator());
-
-    if (isContent) {
-      // The web shell's type is content.
-
-      docShellAsItem->SetItemType(nsIDocShellTreeItem::typeContent);
-    } else {
-      // Inherit our type from our parent webshell.  If it is
-      // chrome, we'll be chrome.  If it is content, we'll be
-      // content.
-
-      docShellAsItem->SetItemType(parentType);
-    }
-
-    parentAsNode->AddChild(docShellAsItem);
-
-    if (parentType == nsIDocShellTreeItem::typeChrome && isContent) {
-      mIsTopLevelContent = PR_TRUE;
-      
-      // XXXbz why is this in content code, exactly?  We should handle
-      // this some other way.....  Not sure how yet.
-      nsCOMPtr<nsIDocShellTreeOwner> parentTreeOwner;
-      parentAsItem->GetTreeOwner(getter_AddRefs(parentTreeOwner));
-
-      PRBool is_primary = value.LowerCaseEqualsLiteral("content-primary");
-
-      if (parentTreeOwner) {
-        PRBool is_targetable = is_primary ||
-          value.LowerCaseEqualsLiteral("content-targetable");
-        parentTreeOwner->ContentShellAdded(docShellAsItem, is_primary,
-                                            is_targetable, value);
-      }
-    }
+    // XXXbz why is this in content code, exactly?  We should handle
+    // this some other way.....  Not sure how yet.
+    nsCOMPtr<nsIDocShellTreeOwner> parentTreeOwner;
+    parentAsItem->GetTreeOwner(getter_AddRefs(parentTreeOwner));
+    mIsTopLevelContent =
+      AddTreeItemToTreeOwner(docShellAsItem, mOwnerContent, parentTreeOwner,
+                             parentType, parentAsNode);
 
     // Make sure all shells have links back to the content element
     // in the nearest enclosing chrome shell.
     nsCOMPtr<nsIDOMEventTarget> chromeEventHandler;
 
diff --git a/content/base/src/nsFrameLoader.h b/content/base/src/nsFrameLoader.h
--- a/content/base/src/nsFrameLoader.h
+++ b/content/base/src/nsFrameLoader.h
@@ -58,11 +58,12 @@ public:
   nsFrameLoader(nsIContent *aOwner) :
     mOwnerContent(aOwner),
     mDepthTooGreat(PR_FALSE),
     mIsTopLevelContent(PR_FALSE),
     mDestroyCalled(PR_FALSE),
-    mInDestructor(PR_FALSE)
+    mInDestructor(PR_FALSE),
+    mInSwap(PR_FALSE)
   {}
 
   ~nsFrameLoader() {
     mInDestructor = PR_TRUE;
     nsFrameLoader::Destroy();
@@ -73,21 +74,29 @@ public:
   NS_DECL_NSIFRAMELOADER
   NS_HIDDEN_(nsresult) CheckForRecursiveLoad(nsIURI* aURI);
   nsresult ReallyStartLoading();
   void Finalize();
   nsIDocShell* GetExistingDocShell() { return mDocShell; }
+
+  // The guts of an nsIFrameLoaderOwner::SwapFrameLoader implementation.  A
+  // frame loader owner needs to call this, and pass in the two references to
+  // nsRefPtrs for frame loaders that need to be swapped.
+  nsresult SwapWithOtherLoader(nsFrameLoader* aOther,
+                               nsRefPtr<nsFrameLoader>& aFirstToSwap,
+                               nsRefPtr<nsFrameLoader>& aSecondToSwap);
 private:
 
   NS_HIDDEN_(nsresult) EnsureDocShell();
   NS_HIDDEN_(void) GetURL(nsString& aURL);
   nsresult CheckURILoad(nsIURI* aURI);
 
   nsCOMPtr<nsIDocShell> mDocShell;
   nsCOMPtr<nsIURI> mURIToLoad;
   nsIContent *mOwnerContent; // WEAK
-  PRPackedBool mDepthTooGreat;
-  PRPackedBool mIsTopLevelContent;
-  PRPackedBool mDestroyCalled;
-  PRPackedBool mInDestructor;
+  PRPackedBool mDepthTooGreat : 1;
+  PRPackedBool mIsTopLevelContent : 1;
+  PRPackedBool mDestroyCalled : 1;
+  PRPackedBool mInDestructor : 1;
+  PRPackedBool mInSwap : 1;
 };
 
 #endif
diff --git a/content/base/src/nsImageLoadingContent.cpp b/content/base/src/nsImageLoadingContent.cpp
--- a/content/base/src/nsImageLoadingContent.cpp
+++ b/content/base/src/nsImageLoadingContent.cpp
@@ -483,10 +483,26 @@ nsImageLoadingContent::LoadImage(const n
 
   nsCOMPtr<nsIURI> imageURI;
   nsresult rv = StringToURI(aNewURI, doc, getter_AddRefs(imageURI));
   NS_ENSURE_SUCCESS(rv, rv);
   // XXXbiesi fire onerror if that failed?
+
+  PRBool equal;
+
+  if (aNewURI.IsEmpty() &&
+      doc->GetDocumentURI() &&
+      NS_SUCCEEDED(doc->GetDocumentURI()->Equals(imageURI, &equal)) && 
+      equal)  {
+
+    // Loading an embedded img from the same URI as the document URI will not work
+    // as a resource cannot recursively embed itself. Attempting to do so generally
+    // results in having to pre-emptively close down an in-flight HTTP transaction 
+    // and then incurring the significant cost of establishing a new TCP channel.
+    // This is generally triggered from <img src=""> 
+    // In light of that, just skip loading it..
+    return NS_OK;
+  }
 
   NS_TryToSetImmutable(imageURI);
 
   return LoadImage(imageURI, aForce, aNotify, doc);
 }
diff --git a/content/base/src/nsObjectLoadingContent.cpp b/content/base/src/nsObjectLoadingContent.cpp
--- a/content/base/src/nsObjectLoadingContent.cpp
+++ b/content/base/src/nsObjectLoadingContent.cpp
@@ -666,10 +666,16 @@ nsObjectLoadingContent::GetFrameLoader(n
 nsObjectLoadingContent::GetFrameLoader(nsIFrameLoader** aFrameLoader)
 {
   *aFrameLoader = mFrameLoader;
   NS_IF_ADDREF(*aFrameLoader);
   return NS_OK;
+}
+
+NS_IMETHODIMP
+nsObjectLoadingContent::SwapFrameLoaders(nsIFrameLoaderOwner* aOtherLoader)
+{
+  return NS_ERROR_NOT_IMPLEMENTED;
 }
 
 // nsIObjectLoadingContent
 NS_IMETHODIMP
 nsObjectLoadingContent::GetActualType(nsACString& aType)
diff --git a/content/base/src/nsScriptLoader.cpp b/content/base/src/nsScriptLoader.cpp
--- a/content/base/src/nsScriptLoader.cpp
+++ b/content/base/src/nsScriptLoader.cpp
@@ -96,10 +96,11 @@ public:
     mElement->ScriptEvaluated(aResult, mElement, mIsInline);
   }
 
   nsCOMPtr<nsIScriptElement> mElement;
   PRPackedBool mLoading;             // Are we still waiting for a load to complete?
+  PRPackedBool mDefer;               // Is execution defered?
   PRPackedBool mIsInline;            // Is the script inline or loaded?
   nsString mScriptText;              // Holds script for loaded scripts
   PRUint32 mJSVersion;
   nsCOMPtr<nsIURI> mURI;
   PRInt32 mLineNo;
@@ -123,12 +124,12 @@ nsScriptLoader::nsScriptLoader(nsIDocume
 
 nsScriptLoader::~nsScriptLoader()
 {
   mObservers.Clear();
 
-  for (PRInt32 i = 0; i < mPendingRequests.Count(); i++) {
-    mPendingRequests[i]->FireScriptAvailable(NS_ERROR_ABORT);
+  for (PRInt32 i = 0; i < mRequests.Count(); i++) {
+    mRequests[i]->FireScriptAvailable(NS_ERROR_ABORT);
   }
 
   // Unblock the kids, in case any of them moved to a different document
   // subtree in the meantime and therefore aren't actually going away.
   for (PRUint32 j = 0; j < mPendingChildLoaders.Length(); ++j) {
@@ -377,10 +378,14 @@ nsScriptLoader::ProcessScriptElement(nsI
 
   // Create a request object for this script
   nsRefPtr<nsScriptLoadRequest> request = new nsScriptLoadRequest(aElement, version);
   NS_ENSURE_TRUE(request, NS_ERROR_OUT_OF_MEMORY);
 
+  request->mDefer = mDeferEnabled && aElement->GetScriptDeferred();
+
+  PRBool hadPendingRequests = !!GetFirstPendingRequest();
+
   // First check to see if this is an external script
   nsCOMPtr<nsIURI> scriptURI = aElement->GetScriptURI();
   if (scriptURI) {
     // Check that the containing page is allowed to load this URI.
     rv = nsContentUtils::GetSecurityManager()->
@@ -446,24 +451,27 @@ nsScriptLoader::ProcessScriptElement(nsI
 
     request->mLineNo = aElement->GetScriptLineNumber();
 
     // If we've got existing pending requests, add ourselves
     // to this list.
-    if (mPendingRequests.Count() == 0 && ReadyToExecuteScripts() &&
-        nsContentUtils::IsSafeToRunScript()) {
+    if (!request->mDefer && !hadPendingRequests &&
+        ReadyToExecuteScripts() && nsContentUtils::IsSafeToRunScript()) {
       return ProcessRequest(request);
     }
   }
 
-  // Add the request to our pending requests list
-  NS_ENSURE_TRUE(mPendingRequests.AppendObject(request),
+  // Add the request to our requests list
+  NS_ENSURE_TRUE(mRequests.AppendObject(request),
                  NS_ERROR_OUT_OF_MEMORY);
+
+  if (request->mDefer) {
+    return NS_OK;
+  }
 
   // If there weren't any pending requests before, and this one is
   // ready to execute, do that as soon as it's safe.
-  if (mPendingRequests.Count() == 1 && !request->mLoading &&
-      ReadyToExecuteScripts()) {
+  if (!request->mLoading && !hadPendingRequests && ReadyToExecuteScripts()) {
     nsContentUtils::AddScriptRunner(new nsRunnableMethod<nsScriptLoader>(this,
       &nsScriptLoader::ProcessPendingRequests));
   }
 
   // Added as pending request, now we can send blocking back
@@ -610,14 +618,26 @@ nsScriptLoader::EvaluateScript(nsScriptL
     ::JS_EndRequest(cx);
   }
   return rv;
 }
 
+nsScriptLoadRequest*
+nsScriptLoader::GetFirstPendingRequest()
+{
+  for (PRInt32 i = 0; i < mRequests.Count(); ++i) {
+    if (!mRequests[i]->mDefer) {
+      return mRequests[i];
+    }
+  }
+
+  return nsnull;
+}
+
 void
 nsScriptLoader::ProcessPendingRequestsAsync()
 {
-  if (mPendingRequests.Count() || !mPendingChildLoaders.IsEmpty()) {
+  if (GetFirstPendingRequest() || !mPendingChildLoaders.IsEmpty()) {
     nsCOMPtr<nsIRunnable> ev = new nsRunnableMethod<nsScriptLoader>(this,
       &nsScriptLoader::ProcessPendingRequests);
 
     NS_DispatchToCurrentThread(ev);
   }
@@ -625,13 +645,14 @@ nsScriptLoader::ProcessPendingRequestsAs
 
 void
 nsScriptLoader::ProcessPendingRequests()
 {
   nsRefPtr<nsScriptLoadRequest> request;
-  while (mPendingRequests.Count() && ReadyToExecuteScripts() &&
-         !(request = mPendingRequests[0])->mLoading) {
-    mPendingRequests.RemoveObjectAt(0);
+  while (ReadyToExecuteScripts() &&
+         (request = GetFirstPendingRequest()) &&
+         !request->mLoading) {
+    mRequests.RemoveObject(request);
     ProcessRequest(request);
   }
 
   while (!mPendingChildLoaders.IsEmpty() && ReadyToExecuteScripts()) {
     nsRefPtr<nsScriptLoader> child = mPendingChildLoaders[0];
@@ -798,11 +819,11 @@ nsScriptLoader::OnStreamComplete(nsIStre
   NS_ENSURE_TRUE(request, NS_ERROR_FAILURE);
 
   nsresult rv = PrepareLoadedRequest(request, aLoader, aStatus, aStringLen,
                                      aString);
   if (NS_FAILED(rv)) {
-    mPendingRequests.RemoveObject(request);
+    mRequests.RemoveObject(request);
     FireScriptAvailable(rv, request);
   }
 
   // Process our request and/or any pending ones
   ProcessPendingRequests();
@@ -861,11 +882,11 @@ nsScriptLoader::PrepareLoadedRequest(nsS
 
   // This assertion could fire errorously if we ran out of memory when
   // inserting the request in the array. However it's an unlikely case
   // so if you see this assertion it is likely something else that is
   // wrong, especially if you see it more than once.
-  NS_ASSERTION(mPendingRequests.IndexOf(aRequest) >= 0,
+  NS_ASSERTION(mRequests.IndexOf(aRequest) >= 0,
                "aRequest should be pending!");
 
   // Mark this as loaded
   aRequest->mLoading = PR_FALSE;
 
@@ -899,5 +920,16 @@ nsScriptLoader::ShouldExecuteScript(nsID
   // document principal, then we don't execute the script.
   PRBool subsumes;
   rv = channelPrincipal->Subsumes(docPrincipal, &subsumes);
   return NS_SUCCEEDED(rv) && subsumes;
 }
+
+void
+nsScriptLoader::EndDeferringScripts()
+{
+  mDeferEnabled = PR_FALSE;
+  for (PRUint32 i = 0; i < mRequests.Count(); ++i) {
+    mRequests[i]->mDefer = PR_FALSE;
+  }
+
+  ProcessPendingRequests();
+}
diff --git a/content/base/src/nsScriptLoader.h b/content/base/src/nsScriptLoader.h
--- a/content/base/src/nsScriptLoader.h
+++ b/content/base/src/nsScriptLoader.h
@@ -185,10 +185,28 @@ public:
    * aDocument.
    */
   static PRBool ShouldExecuteScript(nsIDocument* aDocument,
                                     nsIChannel* aChannel);
 
+  /**
+   * Starts deferring deferred scripts and puts them in the mDeferredRequests
+   * queue instead.
+   */
+  void BeginDeferringScripts()
+  {
+    mDeferEnabled = PR_TRUE;
+  }
+
+  /**
+   * Stops defering scripts and immediately processes the mDeferredRequests
+   * queue.
+   *
+   * WARNING: This function will syncronously execute content scripts, so be
+   * prepared that the world might change around you.
+   */
+  void EndDeferringScripts();
+
 protected:
   /**
    * Process any pending requests asyncronously (i.e. off an event) if there
    * are any. Note that this is a no-op if there aren't any currently pending
    * requests.
@@ -227,16 +245,20 @@ protected:
                                 nsIStreamLoader* aLoader,
                                 nsresult aStatus,
                                 PRUint32 aStringLen,
                                 const PRUint8* aString);
 
+  // Returns the first pending (non deferred) request
+  nsScriptLoadRequest* GetFirstPendingRequest();
+
   nsIDocument* mDocument;                   // [WEAK]
   nsCOMArray<nsIScriptLoaderObserver> mObservers;
-  nsCOMArray<nsScriptLoadRequest> mPendingRequests;
+  nsCOMArray<nsScriptLoadRequest> mRequests;
   nsCOMPtr<nsIScriptElement> mCurrentScript;
   // XXXbz do we want to cycle-collect these or something?  Not sure.
   nsTArray< nsRefPtr<nsScriptLoader> > mPendingChildLoaders;
   PRUint32 mBlockerCount;
   PRPackedBool mEnabled;
+  PRPackedBool mDeferEnabled;
 };
 
 #endif //__nsScriptLoader_h__
diff --git a/content/base/src/nsXMLHttpRequest.cpp b/content/base/src/nsXMLHttpRequest.cpp
--- a/content/base/src/nsXMLHttpRequest.cpp
+++ b/content/base/src/nsXMLHttpRequest.cpp
@@ -82,10 +82,11 @@
 #include "nsContentPolicyUtils.h"
 #include "nsContentErrors.h"
 #include "nsLayoutStatics.h"
 #include "nsDOMError.h"
 #include "nsIHTMLDocument.h"
+#include "nsIDOM3Document.h"
 #include "nsWhitespaceTokenizer.h"
 #include "nsIMultiPartChannel.h"
 #include "nsIScriptObjectPrincipal.h"
 #include "nsIStorageStream.h"
 #include "nsIPromptFactory.h"
@@ -700,13 +701,19 @@ nsXMLHttpRequest::ConvertBodyToText(nsAS
     return NS_OK;
 
   nsresult rv = NS_OK;
 
   nsCAutoString dataCharset;
-  nsCOMPtr<nsIDocument> document(do_QueryInterface(mDocument));
+  nsCOMPtr<nsIDOM3Document> document(do_QueryInterface(mDocument));
   if (document) {
-    dataCharset = document->GetDocumentCharacterSet();
+    nsAutoString inputEncoding;
+    document->GetInputEncoding(inputEncoding);
+    if (DOMStringIsNull(inputEncoding)) {
+      dataCharset.AssignLiteral("UTF-8");
+    } else {
+      CopyUTF16toUTF8(inputEncoding, dataCharset);
+    }
   } else {
     if (NS_FAILED(DetectCharset(dataCharset)) || dataCharset.IsEmpty()) {
       // MS documentation states UTF-8 is default for responseText
       dataCharset.AssignLiteral("UTF-8");
     }
diff --git a/content/base/test/Makefile.in b/content/base/test/Makefile.in
--- a/content/base/test/Makefile.in
+++ b/content/base/test/Makefile.in
@@ -190,10 +190,12 @@ _TEST_FILES = 	test_bug5141.html \
 		wholeTexty-helper.xml \
 		test_bug444030.xhtml \
 		test_NodeIterator_basics_filters.xhtml \
 		test_NodeIterator_mutations_1.xhtml \
 		test_NodeIterator_mutations_2.html \
+		test_bug28293.html \
+		file_bug28293.sjs \
 		$(NULL)
 
 libs:: $(_TEST_FILES)
 	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
 
diff --git a/content/base/test/file_bug28293.sjs b/content/base/test/file_bug28293.sjs
new file mode 100644
--- /dev/null
+++ b/content/base/test/file_bug28293.sjs
@@ -0,0 +1,5 @@
+function handleRequest(request, response)
+{
+  response.setHeader("Content-Type", "text/plain", false);
+  response.write(decodeURIComponent(request.queryString));
+}
diff --git a/content/base/test/test_bug28293.html b/content/base/test/test_bug28293.html
new file mode 100644
--- /dev/null
+++ b/content/base/test/test_bug28293.html
@@ -0,0 +1,99 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=28293
+-->
+<head>
+  <title>Test for Bug 28293</title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>        
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+  <script>
+res = 'A';
+
+SimpleTest.waitForExplicitFinish();
+onload = function () {
+
+  res+='2';
+
+  s = document.createElement('script');
+  s.textContent="res+='g';";
+  s.defer = true;
+  document.body.appendChild(s);
+
+  res+='3';
+
+  s = document.createElement('script');
+  s.src="file_bug28293.sjs?res+='h';";
+  s.defer = true;
+  document.body.appendChild(s);
+
+  s = document.createElement('script');
+  s.textContent="res+='i';done()";
+  s.defer = true;
+  document.body.appendChild(s);
+
+  res+='4';
+}
+
+function done() {
+  is(res, "ABCDEFGHIJ1abcdefM2g34hi", "scripts executed in the wrong order");
+  ok(!fHadExecuted, "Dynamic script executed too late");
+  SimpleTest.finish();
+}
+</script>
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=28293">Mozilla Bug 28293</a>
+
+<script defer>
+res += 'a';
+</script>
+<script defer src="data:text/plain,res+='b'"></script>
+<script defer>
+res += 'c';
+</script>
+<script>
+res += 'B';
+</script>
+<script>
+res += 'C';
+
+s = document.createElement('script');
+s.src="file_bug28293.sjs?res+='d';";
+s.defer = true;
+document.body.appendChild(s);
+
+s = document.createElement('script');
+s.textContent="res+='D';";
+document.body.appendChild(s);
+
+res += 'E';
+</script>
+<script>
+res += 'F';
+document.addEventListener("DOMContentLoaded", function() {
+  res += '1'
+  s = document.createElement('script');
+  s.src="file_bug28293.sjs?res+='M';";
+  document.body.appendChild(s);
+}, false);
+res += 'G';
+</script>
+<script defer>
+res += 'e';
+</script>
+<script src="file_bug28293.sjs?res+='H';"></script>
+<script>
+res += 'I';
+s = document.createElement('script');
+s.src="file_bug28293.sjs?fHadExecuted=(res.indexOf('f')>=0);";
+document.body.appendChild(s);
+res += 'J';
+</script>
+<script defer>
+res += 'f';
+</script>
+
+</body>
+</html>
diff --git a/content/canvas/src/nsCanvasRenderingContext2D.cpp b/content/canvas/src/nsCanvasRenderingContext2D.cpp
--- a/content/canvas/src/nsCanvasRenderingContext2D.cpp
+++ b/content/canvas/src/nsCanvasRenderingContext2D.cpp
@@ -374,10 +374,16 @@ protected:
     nsRefPtr<gfxASurface> mSurface;
 
     PRUint32 mSaveCount;
 
     /**
+     * Flag to avoid duplicate calls to InvalidateFrame. Set to true whenever
+     * Redraw is called, reset to false when Render is called.
+     */
+    PRBool mIsFrameInvalid;
+
+    /**
      * Draws a rectangle in the given style; used by FillRect and StrokeRect.
      */
     nsresult DrawRect(const gfxRect& rect, Style style);
 
     // text
@@ -549,11 +555,11 @@ NS_NewCanvasRenderingContext2D(nsIDOMCan
     return NS_OK;
 }
 
 nsCanvasRenderingContext2D::nsCanvasRenderingContext2D()
     : mValid(PR_FALSE), mOpaque(PR_FALSE), mCanvasElement(nsnull),
-      mSaveCount(0), mStyleStack(20)
+      mSaveCount(0), mIsFrameInvalid(PR_FALSE), mStyleStack(20)
 {
 }
 
 nsCanvasRenderingContext2D::~nsCanvasRenderingContext2D()
 {
@@ -564,10 +570,11 @@ nsCanvasRenderingContext2D::Destroy()
 nsCanvasRenderingContext2D::Destroy()
 {
     mSurface = nsnull;
     mThebes = nsnull;
     mValid = PR_FALSE;
+    mIsFrameInvalid = PR_FALSE;
 }
 
 nsresult
 nsCanvasRenderingContext2D::SetStyleFromVariant(nsIVariant* aStyle, Style aWhichStyle)
 {
@@ -735,11 +742,16 @@ nsCanvasRenderingContext2D::Redraw()
 nsCanvasRenderingContext2D::Redraw()
 {
     if (!mCanvasElement)
         return NS_OK;
 
-    return mCanvasElement->InvalidateFrame();
+    if (!mIsFrameInvalid) {
+        mIsFrameInvalid = PR_TRUE;
+        return mCanvasElement->InvalidateFrame();
+    }
+
+    return NS_OK;
 }
 
 void
 nsCanvasRenderingContext2D::SetThebesColor(nscolor c)
 {
@@ -853,10 +865,11 @@ nsCanvasRenderingContext2D::Render(gfxCo
     ctx->Fill();
 
     if (mOpaque)
         ctx->SetOperator(op);
 
+    mIsFrameInvalid = PR_FALSE;
     return rv;
 }
 
 NS_IMETHODIMP
 nsCanvasRenderingContext2D::GetInputStream(const char *aMimeType,
@@ -1376,11 +1389,11 @@ nsCanvasRenderingContext2D::Stroke()
 
 NS_IMETHODIMP
 nsCanvasRenderingContext2D::Clip()
 {
     mThebes->Clip();
-    return Redraw();
+    return NS_OK;
 }
 
 NS_IMETHODIMP
 nsCanvasRenderingContext2D::MoveTo(float x, float y)
 {
diff --git a/content/events/public/nsIPrivateCompositionEvent.h b/content/events/public/nsIPrivateCompositionEvent.h
--- a/content/events/public/nsIPrivateCompositionEvent.h
+++ b/content/events/public/nsIPrivateCompositionEvent.h
@@ -39,23 +39,21 @@
 #define nsIPrivateCompositionEvent_h__
 
 #include "nsEvent.h"
 #include "nsISupports.h"
 
-// {889792DC-22D8-4d1a-AC3D-58AD7DEBA17B}
+// {901B82D5-67C0-45ad-86AE-AB9A6BD74111}
 #define NS_IPRIVATECOMPOSITIONEVENT_IID	\
-{ 0x889792dc, 0x22d8, 0x4d1a, \
-{ 0xac, 0x3d, 0x58, 0xad, 0x7d, 0xeb, 0xa1, 0x7b }}
+{ 0x901b82d5, 0x67c0, 0x45ad, \
+{ 0x86, 0xae, 0xab, 0x9a, 0x6b, 0xd7, 0x41, 0x11 } }
 
 class nsIPrivateCompositionEvent : public nsISupports {
 
 public:
   NS_DECLARE_STATIC_IID_ACCESSOR(NS_IPRIVATECOMPOSITIONEVENT_IID)
 
   NS_IMETHOD GetCompositionReply(struct nsTextEventReply** aReply) = 0;
-  NS_IMETHOD GetReconversionReply(nsReconversionEventReply** aReply) = 0;
-  NS_IMETHOD GetQueryCaretRectReply(nsQueryCaretRectEventReply** aReply) = 0;
 };
 
 NS_DEFINE_STATIC_IID_ACCESSOR(nsIPrivateCompositionEvent,
                               NS_IPRIVATECOMPOSITIONEVENT_IID)
 
diff --git a/content/events/src/nsDOMEvent.cpp b/content/events/src/nsDOMEvent.cpp
--- a/content/events/src/nsDOMEvent.cpp
+++ b/content/events/src/nsDOMEvent.cpp
@@ -786,16 +786,10 @@ NS_METHOD nsDOMEvent::DuplicatePrivateDa
     {
       newEvent = new nsCompositionEvent(PR_FALSE, msg, nsnull);
       isInputEvent = PR_TRUE;
       break;
     }
-    case NS_RECONVERSION_EVENT:
-    {
-      newEvent = new nsReconversionEvent(PR_FALSE, msg, nsnull);
-      isInputEvent = PR_TRUE;
-      break;
-    }
     case NS_MOUSE_SCROLL_EVENT:
     {
       nsMouseScrollEvent* mouseScrollEvent =
         new nsMouseScrollEvent(PR_FALSE, msg, nsnull);
       NS_ENSURE_TRUE(mouseScrollEvent, NS_ERROR_OUT_OF_MEMORY);
@@ -881,16 +875,10 @@ NS_METHOD nsDOMEvent::DuplicatePrivateDa
     }
     case NS_UI_EVENT:
     {
       newEvent = new nsUIEvent(PR_FALSE, msg,
                                static_cast<nsUIEvent*>(mEvent)->detail);
-      break;
-    }
-    case NS_QUERYCARETRECT_EVENT:
-    {
-      newEvent = new nsQueryCaretRectEvent(PR_FALSE, msg, nsnull);
-      isInputEvent = PR_TRUE;
       break;
     }
     case NS_PAGETRANSITION_EVENT:
     {
       newEvent =
diff --git a/content/events/src/nsDOMUIEvent.cpp b/content/events/src/nsDOMUIEvent.cpp
--- a/content/events/src/nsDOMUIEvent.cpp
+++ b/content/events/src/nsDOMUIEvent.cpp
@@ -368,39 +368,14 @@ nsDOMUIEvent::GetPreventDefault(PRBool* 
   return NS_OK;
 }
 
 NS_METHOD nsDOMUIEvent::GetCompositionReply(nsTextEventReply** aReply)
 {
-  if((mEvent->eventStructType == NS_RECONVERSION_EVENT) ||
-     (mEvent->message == NS_COMPOSITION_START) ||
+  if((mEvent->message == NS_COMPOSITION_START) ||
      (mEvent->message == NS_COMPOSITION_QUERY))
   {
     *aReply = &(static_cast<nsCompositionEvent*>(mEvent)->theReply);
-    return NS_OK;
-  }
-  *aReply = nsnull;
-  return NS_ERROR_FAILURE;
-}
-
-NS_METHOD
-nsDOMUIEvent::GetReconversionReply(nsReconversionEventReply** aReply)
-{
-  if (mEvent->eventStructType == NS_RECONVERSION_EVENT)
-  {
-    *aReply = &(static_cast<nsReconversionEvent*>(mEvent)->theReply);
-    return NS_OK;
-  }
-  *aReply = nsnull;
-  return NS_ERROR_FAILURE;
-}
-
-NS_METHOD
-nsDOMUIEvent::GetQueryCaretRectReply(nsQueryCaretRectEventReply** aReply)
-{
-  if (mEvent->eventStructType == NS_QUERYCARETRECT_EVENT)
-  {
-    *aReply = &(static_cast<nsQueryCaretRectEvent*>(mEvent)->theReply);
     return NS_OK;
   }
   *aReply = nsnull;
   return NS_ERROR_FAILURE;
 }
diff --git a/content/events/src/nsDOMUIEvent.h b/content/events/src/nsDOMUIEvent.h
--- a/content/events/src/nsDOMUIEvent.h
+++ b/content/events/src/nsDOMUIEvent.h
@@ -65,12 +65,10 @@ public:
   // nsIPrivateDOMEvent interface
   NS_IMETHOD DuplicatePrivateData();
   
   // nsIPrivateCompositionEvent interface
   NS_IMETHOD GetCompositionReply(nsTextEventReply** aReply);
-  NS_IMETHOD GetReconversionReply(nsReconversionEventReply** aReply);
-  NS_IMETHOD GetQueryCaretRectReply(nsQueryCaretRectEventReply** aReply);
   
   // Forward to nsDOMEvent
   NS_FORWARD_TO_NSDOMEVENT
 
 protected:
diff --git a/content/events/src/nsEventDispatcher.cpp b/content/events/src/nsEventDispatcher.cpp
--- a/content/events/src/nsEventDispatcher.cpp
+++ b/content/events/src/nsEventDispatcher.cpp
@@ -560,12 +560,10 @@ nsEventDispatcher::CreateEvent(nsPresCon
     case NS_MUTATION_EVENT:
       return NS_NewDOMMutationEvent(aDOMEvent, aPresContext,
                                     static_cast<nsMutationEvent*>(aEvent));
     case NS_GUI_EVENT:
     case NS_COMPOSITION_EVENT:
-    case NS_RECONVERSION_EVENT:
-    case NS_QUERYCARETRECT_EVENT:
     case NS_SCROLLPORT_EVENT:
       return NS_NewDOMUIEvent(aDOMEvent, aPresContext,
                               static_cast<nsGUIEvent*>(aEvent));
     case NS_KEY_EVENT:
       return NS_NewDOMKeyboardEvent(aDOMEvent, aPresContext,
diff --git a/content/events/src/nsEventListenerManager.cpp b/content/events/src/nsEventListenerManager.cpp
--- a/content/events/src/nsEventListenerManager.cpp
+++ b/content/events/src/nsEventListenerManager.cpp
@@ -223,15 +223,11 @@ static const EventDispatchData sComposit
   { NS_COMPOSITION_START,
     HANDLER(&nsIDOMCompositionListener::HandleStartComposition)  },
   { NS_COMPOSITION_END,
     HANDLER(&nsIDOMCompositionListener::HandleEndComposition)    },
   { NS_COMPOSITION_QUERY,
-    HANDLER(&nsIDOMCompositionListener::HandleQueryComposition)  },
-  { NS_RECONVERSION_QUERY,
-    HANDLER(&nsIDOMCompositionListener::HandleQueryReconversion) },
-  { NS_QUERYCARETRECT,
-    HANDLER(&nsIDOMCompositionListener::HandleQueryCaretRect)    }
+    HANDLER(&nsIDOMCompositionListener::HandleQueryComposition)  }
 };
 
 static const EventDispatchData sTextEvents[] = {
   { NS_TEXT_TEXT, HANDLER(&nsIDOMTextListener::HandleText) }
 };
diff --git a/content/html/content/src/nsGenericHTMLElement.cpp b/content/html/content/src/nsGenericHTMLElement.cpp
--- a/content/html/content/src/nsGenericHTMLElement.cpp
+++ b/content/html/content/src/nsGenericHTMLElement.cpp
@@ -2999,10 +2999,17 @@ nsGenericHTMLFrameElement::GetFrameLoade
 {
   NS_IF_ADDREF(*aFrameLoader = mFrameLoader);
   return NS_OK;
 }
 
+NS_IMETHODIMP
+nsGenericHTMLFrameElement::SwapFrameLoaders(nsIFrameLoaderOwner* aOtherOwner)
+{
+  // We don't support this yet
+  return NS_ERROR_NOT_IMPLEMENTED;
+}
+
 nsresult
 nsGenericHTMLFrameElement::LoadSrc()
 {
   nsresult rv = EnsureFrameLoader();
   NS_ENSURE_SUCCESS(rv, rv);
diff --git a/content/html/content/src/nsHTMLScriptElement.cpp b/content/html/content/src/nsHTMLScriptElement.cpp
--- a/content/html/content/src/nsHTMLScriptElement.cpp
+++ b/content/html/content/src/nsHTMLScriptElement.cpp
@@ -335,11 +335,12 @@ public:
 
   // nsIScriptElement
   virtual void GetScriptType(nsAString& type);
   virtual already_AddRefed<nsIURI> GetScriptURI();
   virtual void GetScriptText(nsAString& text);
-  virtual void GetScriptCharset(nsAString& charset); 
+  virtual void GetScriptCharset(nsAString& charset);
+  virtual PRBool GetScriptDeferred();
 
   // nsIContent
   virtual nsresult BindToTree(nsIDocument* aDocument, nsIContent* aParent,
                               nsIContent* aBindingParent,
                               PRBool aCompileEventHandlers);
@@ -523,10 +524,19 @@ nsHTMLScriptElement::GetScriptCharset(ns
 {
   GetCharset(charset);
 }
 
 PRBool
+nsHTMLScriptElement::GetScriptDeferred()
+{
+  PRBool defer;
+  GetDefer(&defer);
+
+  return defer;
+}
+
+PRBool
 nsHTMLScriptElement::HasScriptContent()
 {
   return HasAttr(kNameSpaceID_None, nsGkAtoms::src) ||
          nsContentUtils::HasNonEmptyTextContent(this);
 }
diff --git a/content/svg/content/src/nsSVGAElement.cpp b/content/svg/content/src/nsSVGAElement.cpp
--- a/content/svg/content/src/nsSVGAElement.cpp
+++ b/content/svg/content/src/nsSVGAElement.cpp
@@ -254,16 +254,12 @@ nsSVGAElement::IsLink(nsIURI** aURI) con
       FindAttrValueIn(kNameSpaceID_XLink, nsGkAtoms::actuate,
                       sActuateVals, eCaseMatters) !=
                       nsIContent::ATTR_VALUE_NO_MATCH) {
     nsCOMPtr<nsIURI> baseURI = GetBaseURI();
     // Get absolute URI
-    // XXX: should really be using href->GetStringValue(), but nsSVGElement::
-    // ParseAttribute has set the nsAttrValue type to eSVGValue, so we need
-    // to use the more expensive ToString (generates, rather than fetches).
-    nsAutoString hrefStr;
-    href->ToString(hrefStr);
-    nsContentUtils::NewURIWithDocumentCharset(aURI, hrefStr,
+    nsContentUtils::NewURIWithDocumentCharset(aURI,
+                                              mStringAttributes[HREF].GetAnimValue(),
                                               GetOwnerDoc(), baseURI);
     // must promise out param is non-null if we return true
     return !!*aURI;
   }
 
@@ -272,11 +268,11 @@ nsSVGAElement::IsLink(nsIURI** aURI) con
 }
 
 void
 nsSVGAElement::GetLinkTarget(nsAString& aTarget)
 {
-  GetAttr(kNameSpaceID_None, nsGkAtoms::target, aTarget);
+  aTarget = mStringAttributes[TARGET].GetAnimValue();
   if (aTarget.IsEmpty()) {
 
     static nsIContent::AttrValuesArray sShowVals[] =
       { &nsGkAtoms::_new, &nsGkAtoms::replace, nsnull };
 
diff --git a/content/svg/content/src/nsSVGElement.cpp b/content/svg/content/src/nsSVGElement.cpp
--- a/content/svg/content/src/nsSVGElement.cpp
+++ b/content/svg/content/src/nsSVGElement.cpp
@@ -639,10 +639,28 @@ nsSVGElement::ResetOldStyleBaseType(nsIS
     tl->GetBaseVal(getter_AddRefs(transform));
     transform->Clear();
   }
 }
 
+nsChangeHint
+nsSVGElement::GetAttributeChangeHint(const nsIAtom* aAttribute,
+                                     PRInt32 aModType) const
+{
+  nsChangeHint retval =
+    nsSVGElementBase::GetAttributeChangeHint(aAttribute, aModType);
+
+  if (aAttribute == nsGkAtoms::requiredFeatures ||
+      aAttribute == nsGkAtoms::requiredExtensions ||
+      aAttribute == nsGkAtoms::systemLanguage) {
+    // It would be nice to only reconstruct the frame if the value returned by
+    // NS_SVG_PassesConditionalProcessingTests has changed, but we don't know
+    // that
+    NS_UpdateHint(retval, nsChangeHint_ReconstructFrame);
+  }
+  return retval;
+}
+
 PRBool
 nsSVGElement::IsNodeOfType(PRUint32 aFlags) const
 {
   return !(aFlags & ~(eCONTENT | eELEMENT | eSVG));
 }
diff --git a/content/svg/content/src/nsSVGElement.h b/content/svg/content/src/nsSVGElement.h
--- a/content/svg/content/src/nsSVGElement.h
+++ b/content/svg/content/src/nsSVGElement.h
@@ -84,10 +84,13 @@ public:
                               nsIContent* aBindingParent,
                               PRBool aCompileEventHandlers);
 
   virtual nsresult UnsetAttr(PRInt32 aNameSpaceID, nsIAtom* aAttribute,
                              PRBool aNotify);
+
+  virtual nsChangeHint GetAttributeChangeHint(const nsIAtom* aAttribute,
+                                              PRInt32 aModType) const;
 
   virtual PRBool IsNodeOfType(PRUint32 aFlags) const;
 
   virtual already_AddRefed<nsIURI> GetBaseURI() const;
 
diff --git a/content/svg/content/src/nsSVGFeatures.cpp b/content/svg/content/src/nsSVGFeatures.cpp
--- a/content/svg/content/src/nsSVGFeatures.cpp
+++ b/content/svg/content/src/nsSVGFeatures.cpp
@@ -187,10 +187,14 @@ ElementSupportsAttributes(const nsIAtom 
  * @param aContent the element to test
  */
 PRBool
 NS_SVG_PassesConditionalProcessingTests(nsIContent *aContent)
 {
+  if (!aContent->IsNodeOfType(nsINode::eELEMENT)) {
+    return PR_FALSE;
+  }
+
   if (!ElementSupportsAttributes(aContent->Tag(), ATTRS_CONDITIONAL)) {
     return PR_TRUE;
   }
 
   // Required Features
diff --git a/content/svg/content/src/nsSVGFilters.cpp b/content/svg/content/src/nsSVGFilters.cpp
--- a/content/svg/content/src/nsSVGFilters.cpp
+++ b/content/svg/content/src/nsSVGFilters.cpp
@@ -61,10 +61,11 @@
 #include "nsIDOMSVGURIReference.h"
 #include "nsImageLoadingContent.h"
 #include "imgIContainer.h"
 #include "gfxIImageFrame.h"
 #include "nsIImage.h"
+#include "nsNetUtil.h"
 #include "nsSVGAnimatedPreserveAspectRatio.h"
 #include "nsSVGPreserveAspectRatio.h"
 #include "nsIInterfaceRequestorUtils.h"
 #include "nsSVGMatrix.h"
 #include "nsSVGFilterElement.h"
@@ -5192,14 +5193,15 @@ public:
   NS_FORWARD_NSIDOMSVGELEMENT(nsSVGFEImageElementBase::)
 
   NS_FORWARD_NSIDOMNODE(nsSVGFEImageElementBase::)
   NS_FORWARD_NSIDOMELEMENT(nsSVGFEImageElementBase::)
 
-  virtual nsresult Clone(nsINodeInfo *aNodeInfo, nsINode **aResult) const;
-
-  virtual nsresult AfterSetAttr(PRInt32 aNamespaceID, nsIAtom* aName,
-                                const nsAString* aValue, PRBool aNotify);
+  // nsSVGElement
+  virtual void DidChangeString(PRUint8 aAttrEnum, PRBool aDoSetAttr);
+
+  // nsIContent
+  virtual nsresult Clone(nsINodeInfo *aNodeInfo, nsINode **aResult) const;
 
   virtual nsresult BindToTree(nsIDocument* aDocument, nsIContent* aParent,
                               nsIContent* aBindingParent,
                               PRBool aCompileEventHandlers);
   virtual PRInt32 IntrinsicState() const;
@@ -5216,10 +5218,12 @@ public:
 
 private:
   // Invalidate users of the filter containing this element.
   void Invalidate();
 
+  nsresult LoadSVGImage(PRBool aForce, PRBool aNotify);
+
 protected:
   virtual PRBool OperatesOnSRGB(nsSVGFilterInstance*,
                                 PRUint32, Image*) { return PR_TRUE; }
 
   virtual StringAttributesInfo GetStringInfo();
@@ -5291,28 +5295,28 @@ nsSVGFEImageElement::Init()
 
   return rv;
 }
 
 //----------------------------------------------------------------------
+
+nsresult
+nsSVGFEImageElement::LoadSVGImage(PRBool aForce, PRBool aNotify)
+{
+  // resolve href attribute
+  nsCOMPtr<nsIURI> baseURI = GetBaseURI();
+
+  nsAutoString href(mStringAttributes[HREF].GetAnimValue());
+  href.Trim(" \t\n\r");
+
+  if (baseURI && !href.IsEmpty())
+    NS_MakeAbsoluteURI(href, href, baseURI);
+
+  return LoadImage(href, aForce, aNotify);
+}
+
+//----------------------------------------------------------------------
 // nsIContent methods:
-
-nsresult
-nsSVGFEImageElement::AfterSetAttr(PRInt32 aNamespaceID, nsIAtom* aName,
-                                  const nsAString* aValue, PRBool aNotify)
-{
-  if (aNamespaceID == kNameSpaceID_XLink && aName == nsGkAtoms::href) {
-    nsAutoString href;
-    if (GetAttr(kNameSpaceID_XLink, nsGkAtoms::href, href)) {
-      // Note: no need to notify here; since we're just now being bound
-      // we don't have any frames or anything yet.
-      LoadImage(href, PR_FALSE, PR_FALSE);
-    }
-  }
-
-  return nsSVGFEImageElementBase::AfterSetAttr(aNamespaceID, aName,
-                                               aValue, aNotify);
-}
 
 nsresult
 nsSVGFEImageElement::BindToTree(nsIDocument* aDocument, nsIContent* aParent,
                                 nsIContent* aBindingParent,
                                 PRBool aCompileEventHandlers)
@@ -5322,16 +5326,13 @@ nsSVGFEImageElement::BindToTree(nsIDocum
                                                     aCompileEventHandlers);
   NS_ENSURE_SUCCESS(rv, rv);
 
   // Our base URI may have changed; claim that our URI changed, and the
   // nsImageLoadingContent will decide whether a new image load is warranted.
-  nsAutoString href;
-  if (GetAttr(kNameSpaceID_XLink, nsGkAtoms::href, href)) {
-    // Note: no need to notify here; since we're just now being bound
-    // we don't have any frames or anything yet.
-    LoadImage(href, PR_FALSE, PR_FALSE);
-  }
+  // Note: no need to notify here; since we're just now being bound
+  // we don't have any frames or anything yet.
+  LoadSVGImage(PR_FALSE, PR_FALSE);
 
   return rv;
 }
 
 PRInt32
@@ -5431,10 +5432,20 @@ nsSVGFEImageElement::GetStringInfo()
 {
   return StringAttributesInfo(mStringAttributes, sStringInfo,
                               NS_ARRAY_LENGTH(sStringInfo));
 }
 
+void
+nsSVGFEImageElement::DidChangeString(PRUint8 aAttrEnum, PRBool aDoSetAttr)
+{
+  nsSVGFEImageElementBase::DidChangeString(aAttrEnum, aDoSetAttr);
+
+  if (aAttrEnum == HREF) {
+    LoadSVGImage(PR_TRUE, PR_TRUE);
+  }
+}
+
 //----------------------------------------------------------------------
 // imgIDecoderObserver methods
 
 NS_IMETHODIMP
 nsSVGFEImageElement::OnStopDecode(imgIRequest *aRequest,
@@ -5653,12 +5664,10 @@ nsSVGFEDisplacementMapElement::Filter(ns
   if (scale == 0.0f) {
     CopyRect(aTarget, aSources[0], rect);
     return NS_OK;
   }
 
-  NS_ASSERTION(instance->GetSurfaceRect().Size() == instance->GetFilterSpaceSize(),
-               "Surface size optimization should have been disabled, see ComputeNeededSourceBBoxes");
   PRInt32 width = instance->GetSurfaceWidth();
   PRInt32 height = instance->GetSurfaceHeight();
 
   PRUint8* sourceData = aSources[0]->mImage->Data();
   PRUint8* displacementData = aSources[1]->mImage->Data();
diff --git a/content/svg/content/src/nsSVGImageElement.cpp b/content/svg/content/src/nsSVGImageElement.cpp
--- a/content/svg/content/src/nsSVGImageElement.cpp
+++ b/content/svg/content/src/nsSVGImageElement.cpp
@@ -97,11 +97,11 @@ public:
   virtual void ConstructPath(gfxContext *aCtx);
 
   virtual nsresult Clone(nsINodeInfo *aNodeInfo, nsINode **aResult) const;
 
 protected:
-  void GetSrc(nsAString& src);
+  nsresult LoadSVGImage(PRBool aForce, PRBool aNotify);
 
   virtual LengthAttributesInfo GetLengthInfo();
   virtual StringAttributesInfo GetStringInfo();
 
   enum { X, Y, WIDTH, HEIGHT };
@@ -253,43 +253,36 @@ nsSVGImageElement::DidChangeString(PRUin
 nsSVGImageElement::DidChangeString(PRUint8 aAttrEnum, PRBool aDoSetAttr)
 {
   nsSVGImageElementBase::DidChangeString(aAttrEnum, aDoSetAttr);
 
   if (aAttrEnum == HREF) {
-    nsAutoString href;
-    GetSrc(href);
-
-#ifdef DEBUG_tor
-    fprintf(stderr, "nsSVGImageElement - URI <%s>\n", ToNewCString(href));
-#endif
-
     // If caller is not chrome and dom.disable_image_src_set is true,
     // prevent setting image.src by exiting early
     if (nsContentUtils::GetBoolPref("dom.disable_image_src_set") &&
         !nsContentUtils::IsCallerChrome()) {
       return;
     }
 
-    LoadImage(href, PR_TRUE, PR_TRUE);
+    LoadSVGImage(PR_TRUE, PR_TRUE);
   }
 }
 
 //----------------------------------------------------------------------
 
-void nsSVGImageElement::GetSrc(nsAString& src)
+nsresult
+nsSVGImageElement::LoadSVGImage(PRBool aForce, PRBool aNotify)
 {
   // resolve href attribute
-
   nsCOMPtr<nsIURI> baseURI = GetBaseURI();
 
-  nsAutoString relURIStr(mStringAttributes[HREF].GetAnimValue());
-  relURIStr.Trim(" \t\n\r");
+  nsAutoString href(mStringAttributes[HREF].GetAnimValue());
+  href.Trim(" \t\n\r");
 
-  if (baseURI && !relURIStr.IsEmpty()) 
-    NS_MakeAbsoluteURI(src, relURIStr, baseURI);
-  else
-    src = relURIStr;
+  if (baseURI && !href.IsEmpty())
+    NS_MakeAbsoluteURI(href, href, baseURI);
+
+  return LoadImage(href, aForce, aNotify);
 }
 
 //----------------------------------------------------------------------
 // nsIContent methods:
 
@@ -303,16 +296,13 @@ nsSVGImageElement::BindToTree(nsIDocumen
                                                   aCompileEventHandlers);
   NS_ENSURE_SUCCESS(rv, rv);
 
   // Our base URI may have changed; claim that our URI changed, and the
   // nsImageLoadingContent will decide whether a new image load is warranted.
-  nsAutoString href;
-  if (GetAttr(kNameSpaceID_XLink, nsGkAtoms::href, href)) {
-    // Note: no need to notify here; since we're just now being bound
-    // we don't have any frames or anything yet.
-    LoadImage(href, PR_FALSE, PR_FALSE);
-  }
+  // Note: no need to notify here; since we're just now being bound
+  // we don't have any frames or anything yet.
+  LoadSVGImage(PR_FALSE, PR_FALSE);
 
   return rv;
 }
 
 PRInt32
diff --git a/content/svg/content/src/nsSVGScriptElement.cpp b/content/svg/content/src/nsSVGScriptElement.cpp
--- a/content/svg/content/src/nsSVGScriptElement.cpp
+++ b/content/svg/content/src/nsSVGScriptElement.cpp
@@ -76,11 +76,12 @@ public:
 
   // nsIScriptElement
   virtual void GetScriptType(nsAString& type);
   virtual already_AddRefed<nsIURI> GetScriptURI();
   virtual void GetScriptText(nsAString& text);
-  virtual void GetScriptCharset(nsAString& charset); 
+  virtual void GetScriptCharset(nsAString& charset);
+  virtual PRBool GetScriptDeferred();
 
   // nsScriptElement
   virtual PRBool HasScriptContent();
 
   // nsSVGElement specializations:
@@ -210,10 +211,16 @@ nsSVGScriptElement::GetScriptCharset(nsA
 nsSVGScriptElement::GetScriptCharset(nsAString& charset)
 {
   charset.Truncate();
 }
 
+PRBool
+nsSVGScriptElement::GetScriptDeferred()
+{
+  return PR_FALSE;
+}
+
 //----------------------------------------------------------------------
 // nsScriptElement methods
 
 PRBool
 nsSVGScriptElement::HasScriptContent()
diff --git a/content/svg/content/src/nsSVGSwitchElement.cpp b/content/svg/content/src/nsSVGSwitchElement.cpp
--- a/content/svg/content/src/nsSVGSwitchElement.cpp
+++ b/content/svg/content/src/nsSVGSwitchElement.cpp
@@ -79,12 +79,11 @@ nsSVGSwitchElement::MaybeInvalidate()
   // nsSVGUtils::UpdateGraphic would not invalidate the old mActiveChild area!
 
   PRUint32 count = GetChildCount();
   for (PRUint32 i = 0; i < count; i++) {
     nsIContent * child = GetChildAt(i);
-    if (child->IsNodeOfType(nsINode::eELEMENT) &&
-        NS_SVG_PassesConditionalProcessingTests(child)) {
+    if (NS_SVG_PassesConditionalProcessingTests(child)) {
 
       if (mActiveChild == child) {
         return;
       }
 
@@ -106,12 +105,11 @@ nsSVGSwitchElement::UpdateActiveChild()
 nsSVGSwitchElement::UpdateActiveChild()
 {
   PRUint32 count = GetChildCount();
   for (PRUint32 i = 0; i < count; i++) {
     nsIContent * child = GetChildAt(i);
-    if (child->IsNodeOfType(nsINode::eELEMENT) &&
-        NS_SVG_PassesConditionalProcessingTests(child)) {
+    if (NS_SVG_PassesConditionalProcessingTests(child)) {
       mActiveChild = child;
       return;
     }
   }
   mActiveChild = nsnull;
diff --git a/content/xbl/public/nsIXBLService.h b/content/xbl/public/nsIXBLService.h
--- a/content/xbl/public/nsIXBLService.h
+++ b/content/xbl/public/nsIXBLService.h
@@ -56,12 +56,12 @@ class nsIURI;
 class nsIURI;
 class nsIAtom;
 class nsIPrincipal;
 
 #define NS_IXBLSERVICE_IID      \
-{ 0x98b28f4e, 0x698f, 0x4f77,   \
- { 0xa8, 0x9e, 0x65, 0xf5, 0xd0, 0xde, 0x6a, 0xbf } }
+{ 0x8d3b37f5, 0xde7e, 0x4595,   \
+ { 0xb8, 0x56, 0xf7, 0x11, 0xe8, 0xe7, 0xb5, 0x59 } }
 
 class nsIXBLService : public nsISupports
 {
 public:
   NS_DECLARE_STATIC_IID_ACCESSOR(NS_IXBLSERVICE_IID)
@@ -88,10 +88,11 @@ public:
                                      PRBool aForceSyncLoad,
                                      nsIXBLDocumentInfo** aResult) = 0;
 
   // Hooks up the global key event handlers to the document root.
   NS_IMETHOD AttachGlobalKeyHandler(nsPIDOMEventTarget* aTarget)=0;
+  NS_IMETHOD DetachGlobalKeyHandler(nsPIDOMEventTarget* aTarget)=0;
   
 };
 
 NS_DEFINE_STATIC_IID_ACCESSOR(nsIXBLService, NS_IXBLSERVICE_IID)
 
diff --git a/content/xbl/src/nsXBLService.cpp b/content/xbl/src/nsXBLService.cpp
--- a/content/xbl/src/nsXBLService.cpp
+++ b/content/xbl/src/nsXBLService.cpp
@@ -697,10 +697,14 @@ nsXBLService::AttachGlobalKeyHandler(nsP
       piTarget = do_QueryInterface(doc); // We're a XUL keyset. Attach to our document.
   }
     
   if (!piTarget)
     return NS_ERROR_FAILURE;
+
+  // the listener already exists, so skip this
+  if (contentNode && contentNode->GetProperty(nsGkAtoms::listener))
+    return NS_OK;
     
   nsCOMPtr<nsIDOMElement> elt(do_QueryInterface(contentNode));
 
   // Create the key handler
   nsXBLWindowKeyHandler* handler;
@@ -718,12 +722,57 @@ nsXBLService::AttachGlobalKeyHandler(nsP
   target->AddGroupedEventListener(NS_LITERAL_STRING("keyup"), handler, 
                                   PR_FALSE, systemGroup);
   target->AddGroupedEventListener(NS_LITERAL_STRING("keypress"), handler, 
                                   PR_FALSE, systemGroup);
 
-  // Release.  Do this so that only the event receiver holds onto the key handler.
+  if (contentNode)
+    return contentNode->SetProperty(nsGkAtoms::listener, handler,
+                                    nsPropertyTable::SupportsDtorFunc, PR_TRUE);
+
+  // release the handler. The reference will be maintained by the event target,
+  // and, if there is a content node, the property.
   NS_RELEASE(handler);
+  return NS_OK;
+}
+
+//
+// DetachGlobalKeyHandler
+//
+// Removes a key handler added by DeatchGlobalKeyHandler.
+//
+NS_IMETHODIMP
+nsXBLService::DetachGlobalKeyHandler(nsPIDOMEventTarget* aTarget)
+{
+  nsCOMPtr<nsPIDOMEventTarget> piTarget = aTarget;
+  nsCOMPtr<nsIContent> contentNode(do_QueryInterface(aTarget));
+  if (!contentNode) // detaching is only supported for content nodes
+    return NS_ERROR_FAILURE;
+
+  // Only attach if we're really in a document
+  nsCOMPtr<nsIDocument> doc = contentNode->GetCurrentDoc();
+  if (doc)
+    piTarget = do_QueryInterface(doc);
+  if (!piTarget)
+    return NS_ERROR_FAILURE;
+
+  nsIDOMEventListener* handler =
+    static_cast<nsIDOMEventListener*>(contentNode->GetProperty(nsGkAtoms::listener));
+  if (!handler)
+    return NS_ERROR_FAILURE;
+
+  nsCOMPtr<nsIDOMEventGroup> systemGroup;
+  piTarget->GetSystemEventGroup(getter_AddRefs(systemGroup));
+  nsCOMPtr<nsIDOM3EventTarget> target = do_QueryInterface(piTarget);
+
+  target->RemoveGroupedEventListener(NS_LITERAL_STRING("keydown"), handler,
+                                     PR_FALSE, systemGroup);
+  target->RemoveGroupedEventListener(NS_LITERAL_STRING("keyup"), handler, 
+                                     PR_FALSE, systemGroup);
+  target->RemoveGroupedEventListener(NS_LITERAL_STRING("keypress"), handler, 
+                                     PR_FALSE, systemGroup);
+
+  contentNode->DeleteProperty(nsGkAtoms::listener);
 
   return NS_OK;
 }
 
 NS_IMETHODIMP
diff --git a/content/xbl/src/nsXBLService.h b/content/xbl/src/nsXBLService.h
--- a/content/xbl/src/nsXBLService.h
+++ b/content/xbl/src/nsXBLService.h
@@ -86,10 +86,11 @@ class nsXBLService : public nsIXBLServic
                                      PRBool aForceSyncLoad,
                                      nsIXBLDocumentInfo** aResult);
 
   // Used by XUL key bindings and for window XBL.
   NS_IMETHOD AttachGlobalKeyHandler(nsPIDOMEventTarget* aTarget);
+  NS_IMETHOD DetachGlobalKeyHandler(nsPIDOMEventTarget* aTarget);
 
   NS_DECL_NSIOBSERVER
 
 public:
   nsXBLService();
diff --git a/content/xbl/src/nsXBLWindowKeyHandler.cpp b/content/xbl/src/nsXBLWindowKeyHandler.cpp
--- a/content/xbl/src/nsXBLWindowKeyHandler.cpp
+++ b/content/xbl/src/nsXBLWindowKeyHandler.cpp
@@ -354,10 +354,17 @@ nsXBLWindowKeyHandler::WalkHandlers(nsID
       if (prevent)
         return NS_OK; // Handled by the user bindings. Our work here is done.
     }
   }
 
+  nsCOMPtr<nsIContent> content = do_QueryInterface(el);
+  // skip keysets that are disabled
+  if (content && content->AttrValueIs(kNameSpaceID_None, nsGkAtoms::disabled,
+                                      nsGkAtoms::_true, eCaseMatters)) {
+    return NS_OK;
+  }
+
   WalkHandlersInternal(aKeyEvent, aEventType, mHandler);
 
   nsINativeKeyBindings *nativeBindings;
   if (isEditor && (nativeBindings = GetEditorKeyBindings())) {
     nsNativeKeyEvent nativeEvent;
diff --git a/content/xslt/src/xslt/txMozillaXMLOutput.cpp b/content/xslt/src/xslt/txMozillaXMLOutput.cpp
--- a/content/xslt/src/xslt/txMozillaXMLOutput.cpp
+++ b/content/xslt/src/xslt/txMozillaXMLOutput.cpp
@@ -762,11 +762,10 @@ txMozillaXMLOutput::startHTMLElement(nsI
 }
 
 nsresult
 txMozillaXMLOutput::endHTMLElement(nsIContent* aElement)
 {
-    nsresult rv;
     nsIAtom *atom = aElement->Tag();
 
     if (mTableState == ADDED_TBODY) {
         NS_ASSERTION(atom == txHTMLAtoms::tbody,
                      "Element flagged as added tbody isn't a tbody");
@@ -807,14 +806,15 @@ txMozillaXMLOutput::endHTMLElement(nsICo
         aElement->GetAttr(kNameSpaceID_None, txHTMLAtoms::target, value);
         doc->SetBaseTarget(value);
 
         aElement->GetAttr(kNameSpaceID_None, txHTMLAtoms::href, value);
         nsCOMPtr<nsIURI> baseURI;
-        rv = NS_NewURI(getter_AddRefs(baseURI), value, nsnull);
-        NS_ENSURE_SUCCESS(rv, rv);
+        NS_NewURI(getter_AddRefs(baseURI), value, nsnull);
 
-        doc->SetBaseURI(baseURI); // The document checks if it is legal to set this base
+        if (baseURI) {
+            doc->SetBaseURI(baseURI); // The document checks if it is legal to set this base
+        }
     }
     else if (mCreatingNewDocument && atom == txHTMLAtoms::meta) {
         // handle HTTP-EQUIV data
         nsAutoString httpEquiv;
         aElement->GetAttr(kNameSpaceID_None, txHTMLAtoms::httpEquiv, httpEquiv);
diff --git a/content/xul/content/src/nsXULElement.cpp b/content/xul/content/src/nsXULElement.cpp
--- a/content/xul/content/src/nsXULElement.cpp
+++ b/content/xul/content/src/nsXULElement.cpp
@@ -164,12 +164,10 @@
 #define XUL_ELEMENT_TEMPLATE_CONTENTS_BUILT \
   (nsXULElement::eTemplateContentsBuilt << XUL_ELEMENT_LAZY_STATE_OFFSET)
 
 #define XUL_ELEMENT_CONTAINER_CONTENTS_BUILT \
   (nsXULElement::eContainerContentsBuilt << XUL_ELEMENT_LAZY_STATE_OFFSET)
-
-class nsIDocShell;
 
 // Global object maintenance
 nsICSSParser* nsXULPrototypeElement::sCSSParser = nsnull;
 nsIXBLService * nsXULElement::gXBLService = nsnull;
 nsICSSOMFactory* nsXULElement::gCSSOMFactory = nsnull;
@@ -2116,10 +2114,40 @@ nsXULElement::GetFrameLoader(nsIFrameLoa
         NS_IF_ADDREF(*aFrameLoader = slots->mFrameLoader);
     }
     return NS_OK;
 }
 
+nsresult
+nsXULElement::SwapFrameLoaders(nsIFrameLoaderOwner* aOtherOwner)
+{
+    nsCOMPtr<nsIContent> otherContent(do_QueryInterface(aOtherOwner));
+    NS_ENSURE_TRUE(otherContent, NS_ERROR_NOT_IMPLEMENTED);
+
+    nsXULElement* otherEl = FromContent(otherContent);
+    NS_ENSURE_TRUE(otherEl, NS_ERROR_NOT_IMPLEMENTED);
+
+    if (otherEl == this) {
+        // nothing to do
+        return NS_OK;
+    }
+
+    nsXULSlots *ourSlots = static_cast<nsXULSlots*>(GetExistingDOMSlots());
+    nsXULSlots *otherSlots =
+        static_cast<nsXULSlots*>(otherEl->GetExistingDOMSlots());
+    if (!ourSlots || !ourSlots->mFrameLoader ||
+        !otherSlots || !otherSlots->mFrameLoader) {
+        // Can't handle swapping when there is nothing to swap... yet.
+        return NS_ERROR_NOT_IMPLEMENTED;
+    }
+
+    return
+        ourSlots->mFrameLoader->SwapWithOtherLoader(otherSlots->mFrameLoader,
+                                                    ourSlots->mFrameLoader,
+                                                    otherSlots->mFrameLoader);
+}
+
+
 NS_IMETHODIMP
 nsXULElement::GetParentTree(nsIDOMXULMultiSelectControlElement** aTreeElement)
 {
     for (nsIContent* current = GetParent(); current;
          current = current->GetParent()) {
diff --git a/content/xul/content/src/nsXULElement.h b/content/xul/content/src/nsXULElement.h
--- a/content/xul/content/src/nsXULElement.h
+++ b/content/xul/content/src/nsXULElement.h
@@ -623,12 +623,12 @@ public:
     virtual nsresult Clone(nsINodeInfo *aNodeInfo, nsINode **aResult) const;
     virtual PRInt32 IntrinsicState() const;
 
     nsresult GetStyle(nsIDOMCSSStyleDeclaration** aStyle);
 
-    
     nsresult GetFrameLoader(nsIFrameLoader** aFrameLoader);
+    nsresult SwapFrameLoaders(nsIFrameLoaderOwner* aOtherOwner);
 
     virtual void RecompileScriptEventListeners();
 
     // This function should ONLY be used by BindToTree implementations.
     // The function exists solely because XUL elements store the binding
@@ -662,11 +662,11 @@ protected:
     {
     public:
        nsXULSlots(PtrBits aFlags);
        virtual ~nsXULSlots();
 
-       nsCOMPtr<nsIFrameLoader> mFrameLoader;
+       nsRefPtr<nsFrameLoader> mFrameLoader;
     };
 
     virtual nsINode::nsSlots* CreateSlots();
 
     nsresult LoadSrc();
diff --git a/content/xul/document/src/nsXULDocument.cpp b/content/xul/document/src/nsXULDocument.cpp
--- a/content/xul/document/src/nsXULDocument.cpp
+++ b/content/xul/document/src/nsXULDocument.cpp
@@ -439,10 +439,12 @@ nsXULDocument::StartDocumentLoad(const c
 
     mDocumentTitle.SetIsVoid(PR_TRUE);
 
     mChannel = aChannel;
 
+    mHaveInputEncoding = PR_TRUE;
+
     // Get the URI.  Note that this should match nsDocShell::OnLoadingSite
     nsresult rv =
         NS_GetFinalChannelURI(aChannel, getter_AddRefs(mDocumentURI));
     NS_ENSURE_SUCCESS(rv, rv);
     
@@ -1728,10 +1730,18 @@ nsXULDocument::RemoveSubtreeFromDocument
     }
 
     // Do a bunch of cleanup to remove an element from the XUL
     // document.
     nsresult rv;
+
+    if (aElement->NodeInfo()->Equals(nsGkAtoms::keyset, kNameSpaceID_XUL)) {
+        nsCOMPtr<nsIXBLService> xblService(do_GetService("@mozilla.org/xbl;1"));
+        if (xblService) {
+            nsCOMPtr<nsPIDOMEventTarget> piTarget(do_QueryInterface(aElement));
+            xblService->DetachGlobalKeyHandler(piTarget);
+        }
+    }
 
     // 1. Remove any children from the document.
     PRUint32 count = aElement->GetChildCount();
 
     while (count-- > 0) {
diff --git a/db/mork/src/morkRow.cpp b/db/mork/src/morkRow.cpp
--- a/db/mork/src/morkRow.cpp
+++ b/db/mork/src/morkRow.cpp
@@ -943,11 +943,11 @@ morkRow::NewRowCellCursor(morkEnv* ev, m
          
         if ( cursor )
         {
           if ( ev->Good() )
           {
-            cursor->mCursor_Pos = inPos;
+            cursor->mRowCellCursor_Col = inPos;
             outCursor = cursor;
           }
           else
             cursor->CutStrongRef(ev->mEnv_SelfAsMdbEnv);
         }
diff --git a/docshell/base/nsDocShell.cpp b/docshell/base/nsDocShell.cpp
--- a/docshell/base/nsDocShell.cpp
+++ b/docshell/base/nsDocShell.cpp
@@ -1188,16 +1188,14 @@ nsDocShell::SetChromeEventHandler(nsIDOM
     nsCOMPtr<nsPIDOMEventTarget> piTarget =
       do_QueryInterface(aChromeEventHandler);
     // Weak reference. Don't addref.
     mChromeEventHandler = piTarget;
 
-    NS_ASSERTION(!mScriptGlobal,
-                 "SetChromeEventHandler() called after the script global "
-                 "object was created! This means that the script global "
-                 "object in this docshell won't get the right chrome event "
-                 "handler. You really don't want to see this assert, FIX "
-                 "YOUR CODE!");
+    nsCOMPtr<nsPIDOMWindow> win(do_QueryInterface(mScriptGlobal));
+    if (win) {
+        win->SetChromeEventHandler(piTarget);
+    }
 
     return NS_OK;
 }
 
 NS_IMETHODIMP
diff --git a/dom/public/base/nsPIDOMWindow.h b/dom/public/base/nsPIDOMWindow.h
--- a/dom/public/base/nsPIDOMWindow.h
+++ b/dom/public/base/nsPIDOMWindow.h
@@ -93,10 +93,12 @@ public:
 
   nsPIDOMEventTarget* GetChromeEventHandler() const
   {
     return mChromeEventHandler;
   }
+
+  virtual void SetChromeEventHandler(nsPIDOMEventTarget* aChromeEventHandler) = 0;
 
   PRBool HasMutationListeners(PRUint32 aMutationEventType) const
   {
     const nsPIDOMWindow *win;
 
@@ -399,10 +401,14 @@ protected:
       mIsModalContentWindow(PR_FALSE), mInnerWindow(nsnull),
       mOuterWindow(aOuterWindow)
   {
   }
 
+  void SetChromeEventHandlerInternal(nsPIDOMEventTarget* aChromeEventHandler) {
+    mChromeEventHandler = aChromeEventHandler;
+  }
+
   // These two variables are special in that they're set to the same
   // value on both the outer window and the current inner window. Make
   // sure you keep them in sync!
   nsCOMPtr<nsPIDOMEventTarget> mChromeEventHandler; // strong
   nsCOMPtr<nsIDOMDocument> mDocument; // strong
diff --git a/dom/public/coreEvents/nsIDOMCompositionListener.h b/dom/public/coreEvents/nsIDOMCompositionListener.h
--- a/dom/public/coreEvents/nsIDOMCompositionListener.h
+++ b/dom/public/coreEvents/nsIDOMCompositionListener.h
@@ -42,14 +42,14 @@
 #include "nsIDOMEventListener.h"
 
 /*
  * Key pressed / released / typed listener interface.
  */
-// {F14B6491-E95B-11d2-9E85-0060089FE59B}
+// {93A5A335-AA51-4d32-977D-3680B7722AD5}
 #define NS_IDOMCOMPOSITIONLISTENER_IID	\
-{ 0xf14b6491, 0xe95b, 0x11d2, \
-{ 0x9e, 0x85, 0x0, 0x60, 0x8, 0x9f, 0xe5, 0x9b } }
+{ 0x93a5a335, 0xaa51, 0x4d32, \
+{ 0x97, 0x7d, 0x36, 0x80, 0xb7, 0x72, 0x2a, 0xd5 } }
 
 
 class nsIDOMCompositionListener : public nsIDOMEventListener {
 
 public:
@@ -57,12 +57,10 @@ public:
   NS_DECLARE_STATIC_IID_ACCESSOR(NS_IDOMCOMPOSITIONLISTENER_IID)
 
   NS_IMETHOD HandleStartComposition(nsIDOMEvent* aCompositionEvent) = 0;
   NS_IMETHOD HandleEndComposition(nsIDOMEvent* aCompositionEvent) = 0;
   NS_IMETHOD HandleQueryComposition(nsIDOMEvent* aCompositionEvent) = 0;
-  NS_IMETHOD HandleQueryReconversion(nsIDOMEvent* aCompositionEvent) = 0;
-  NS_IMETHOD HandleQueryCaretRect(nsIDOMEvent* aCompositionEvent) = 0;
 };
 
 NS_DEFINE_STATIC_IID_ACCESSOR(nsIDOMCompositionListener,
                               NS_IDOMCOMPOSITIONLISTENER_IID)
 
diff --git a/dom/src/base/nsGlobalWindow.cpp b/dom/src/base/nsGlobalWindow.cpp
--- a/dom/src/base/nsGlobalWindow.cpp
+++ b/dom/src/base/nsGlobalWindow.cpp
@@ -6808,10 +6808,31 @@ nsGlobalWindow::Deactivate()
   FORWARD_TO_OUTER(Deactivate, (), NS_ERROR_NOT_INITIALIZED);
 
   return FireWidgetEvent(mDocShell, NS_DEACTIVATE);
 }
 
+void
+nsGlobalWindow::SetChromeEventHandler(nsPIDOMEventTarget* aChromeEventHandler)
+{
+  SetChromeEventHandlerInternal(aChromeEventHandler);
+  if (IsOuterWindow()) {
+    // update the chrome event handler on all our inner windows
+    for (nsGlobalWindow *inner = (nsGlobalWindow *)PR_LIST_HEAD(this);
+         inner != this;
+         inner = (nsGlobalWindow*)PR_NEXT_LINK(inner)) {
+      NS_ASSERTION(inner->mOuterWindow == this, "bad outer window pointer");
+      inner->SetChromeEventHandlerInternal(aChromeEventHandler);
+    }
+  } else if (mOuterWindow) {
+    // Need the cast to be able to call the protected method on a
+    // superclass. We could make the method public instead, but it's really
+    // better this way.
+    static_cast<nsGlobalWindow*>(mOuterWindow)->
+      SetChromeEventHandlerInternal(aChromeEventHandler);
+  }
+}
+
 nsIFocusController*
 nsGlobalWindow::GetRootFocusController()
 {
   nsIDOMWindowInternal* rootWindow = nsGlobalWindow::GetPrivateRoot();
   nsCOMPtr<nsIFocusController> fc;
diff --git a/dom/src/base/nsGlobalWindow.h b/dom/src/base/nsGlobalWindow.h
--- a/dom/src/base/nsGlobalWindow.h
+++ b/dom/src/base/nsGlobalWindow.h
@@ -288,10 +288,11 @@ public:
 
   // nsPIDOMWindow
   virtual NS_HIDDEN_(nsPIDOMWindow*) GetPrivateRoot();
   virtual NS_HIDDEN_(nsresult) Activate();
   virtual NS_HIDDEN_(nsresult) Deactivate();
+  virtual NS_HIDDEN_(void) SetChromeEventHandler(nsPIDOMEventTarget* aChromeEventHandler);
   virtual NS_HIDDEN_(nsIFocusController*) GetRootFocusController();
 
   virtual NS_HIDDEN_(void) SetOpenerScriptPrincipal(nsIPrincipal* aPrincipal);
   virtual NS_HIDDEN_(nsIPrincipal*) GetOpenerScriptPrincipal();
 
diff --git a/dom/tests/mochitest/ajax/jquery/ChangeLog.txt b/dom/tests/mochitest/ajax/jquery/ChangeLog.txt
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/ChangeLog.txt
@@ -0,0 +1,98 @@
+== jQuery ChangeLog ==
+
+== 1.2.2 ==
+
+* show is now element aware (uses default display type instead of just forcing block)
+* New special events api: jQuery.events.special
+* ready is now a real event and can be bound, unbound and triggered.
+* mouseenter and mouseleave now work on all supported browsers
+* The hover helper method now uses the mouseenter and mouseleave events
+* New offset test suite test/offset.html (requires your pop-up blocker to be disabled)
+* Refactored the width and height methods (fixes lots of bugs)
+* Fixed event memory leaks in IE (html, remove, empty also no longer leak memory)
+* Fixed window/document width/height values
+* Fixed event.pageX and event.pageY in IE
+
+== 1.2 ==
+
+=== 1.1.3 ===
+* Always create an ActiveXObject when it is available instead of the XMLHttpRequest, even in IE7
+* Removed XMLHttpRequest shadowing, may break code that relies on existence of that function for browser checking
+* ...
+
+=== 1.1.2 ===
+
+* Event handlers (like element.onclick) are now removed when no more functions are bound to the event.
+* Fixed DOM Manipulations for form elements.
+* Fixed jQuery.isFunction to return false on nodes.
+* Fixed jQuery.className.has, escaping regex characters in className (for metadata)
+* Fixed an issue in IE where an event on a cloned element is fired during a .clone() inside of an event handler.
+* Fixed IE ID selectors selecting by the name attribute.
+* Change: Events are now internally stored in elem.$events rather than elem.events (due to a nasty bug relating to DOM 0 expandos).
+* .attr('href') is now consistent in all browsers.
+* @href is now consistent in all browsers.
+* Fixed the slideDown flickering bug.
+* Having a \r endline in $("...") caused a never-ending loop.
+* Fixed IE6 AJAX memory leak
+* Fixed bug in pushStack, reporting an element at [0] in a jQuery object with length 0
+
+=== 1.1.1 ===
+
+* Setting the numerical value of a css property failed, for example: .css("opacity",0.5) (also occurred with zIndex, fontWeight)
+* Calling $(..., jqobj) with a context of a jQuery object failed.
+* Accessing a property on an element that doesn't exist caused an error, for example: $("#foobar").attr("id")
+* Calling .load() without a callback caused an error.
+* You couldn't cancel an event that was triggered using .trigger() or .click() (for example).
+* .add()ing a single DOM element to a jQuery object was broken.
+* Passing in undefined values to a $.post() caused weird errors to occur.
+* Accessing child nodes within an xml document didn't work properly.
+* jQuery.isFunction() was unable to reliably determine a function, in a cross-browser way.
+* Triggering a .click() failed in IE.
+* Triggered click handlers were executed twice in most browsers.
+* A newline passed into $(...) caused Firefox to go into a never-ending loop.
+* Calling $.post() without any data caused an error.
+* Calling a descendant selector after a child selector caused strange results, for example: $("ul > li ul")
+* Triggered events did not occur if an event handler was not bound for that event.
+
+== 1.1 ==
+
+* Massive speed-ups (4x-10x) in the selector engine.
+* You can now unbind event handlers from within themselves
+* Added new .one( "type", fn ) method
+* text(String) now escapes HTML
+* Added attr(String,Function) to calculate the value
+* Performming .click(), .blur(), .focus(), .submit() will actually trigger the browsers default action for those events.
+* Added global settings for AJAX (in addition to timeout), use $.ajaxSetup() to modify them
+* Implemented a better error handling for ajax requests. Exceptions caused by dropping connections are now handled, too.
+* Improved event fixing (Opera provides event.srcElement, must ignore it if target is available; only create pageX if clientX is available)
+* Fixed nth-child selectors to start on the right number
+* jQuery is no longer destructive. Doing var a = $("a"); a.find("span"); does not change the original "a" variable.
+* Fixed synchronous requests
+* Fixed ID with context selectors (eg. div #id doesn't ignore "div" anymore)
+* Fixed docs for html(): Now mentions that is not available for XML documents
+* Improved AJAX docs (eg. more examples for $.ajax)
+* Documented filter(Function), a very powerful approach for custom filtering
+* Improved docs for FX module, merging method descriptions and marking optional arguments
+* Improved docs for append, prepend, before and after, merging the three pairs into one
+* Improved show/hide animations to show only hidden and hide only visible elements
+* Removed .oneEvent() and .unEvent() helper methods.
+* Removed all CSS helper methods.
+* Removed most attribute helper methods.
+* Removed the (undocumented) .find( "selector", fn ) for all destructive methods.
+* $.get, $.getIfModified, $.post, $.getScript and $.getJSON now all pass through the XMLHttpRequest as returned by $.ajax
+
+== 1.0.4 ==
+
+* Tons of bug fixes
+* Extensions to $.ajax: $.ajax accepts additonal options: beforeSend, async and processData; returns XMLHttpRequest to allow manual aborting of requests, see docs for details
+* AJAX module: the public $.ajax API is now used internally (for $.get/$.post etc.); loading scripts works now much more reliable on all browers except Safari
+* New global ajax handler: ajaxSend - called before an ajax request is sent
+* Extensions to global ajax handlers: ajaxSend, ajaxSuccess, ajaxError and ajaxComplete get XMLHttpRequest and settings passed as arguments
+* Extensions to event handling: pageX and pageY are available x-browser (IE does not provide native pageX/Y)
+* Improved docs: $(String) method has now two seperate descriptions, one for selecting elements, one for creating (html on-the-fly)
+* FX module: Most inline stlyes added by animations are now removed when the animation is complete, eg. height style when animating height (exception: display styles)
+* Added note to attr(String, Object) about issues with setting the name property on input elements
+* Seperated internal stuff from get() into set()
+* Merged the two API examples for each() into one more precise example
+* Improved docs for $.browser and added docs for $.boxModel
+* Docs for the jQuery constructor $() were improved: There is now $(String expression[, Object context]) and $(String html)
diff --git a/dom/tests/mochitest/ajax/jquery/MIT-LICENSE.txt b/dom/tests/mochitest/ajax/jquery/MIT-LICENSE.txt
--- a/dom/tests/mochitest/ajax/jquery/MIT-LICENSE.txt
+++ b/dom/tests/mochitest/ajax/jquery/MIT-LICENSE.txt
@@ -1,6 +1,6 @@ Copyright (c) 2007 John Resig, http://jq
-Copyright (c) 2007 John Resig, http://jquery.com/
+Copyright (c) 2008 John Resig, http://jquery.com/
 
 Permission is hereby granted, free of charge, to any person obtaining
 a copy of this software and associated documentation files (the
 "Software"), to deal in the Software without restriction, including
 without limitation the rights to use, copy, modify, merge, publish,
diff --git a/dom/tests/mochitest/ajax/jquery/Makefile.in b/dom/tests/mochitest/ajax/jquery/Makefile.in
--- a/dom/tests/mochitest/ajax/jquery/Makefile.in
+++ b/dom/tests/mochitest/ajax/jquery/Makefile.in
@@ -43,20 +43,17 @@ relativesrcdir	= dom/tests/mochitest/aja
 
 include $(DEPTH)/config/autoconf.mk
 
 DIRS	= \
 	dist \
-	src \
 	test \
 	$(NULL)
 
 include $(topsrcdir)/config/rules.mk
 
 _TEST_FILES	= \
-	GPL-LICENSE.txt \
 	manifest.json \
-	MIT-LICENSE.txt \
 	test_jQuery.html \
 	$(NULL)
 
 libs::	$(_TEST_FILES)
 	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
diff --git a/dom/tests/mochitest/ajax/jquery/dist/jquery.js b/dom/tests/mochitest/ajax/jquery/dist/jquery.js
--- a/dom/tests/mochitest/ajax/jquery/dist/jquery.js
+++ b/dom/tests/mochitest/ajax/jquery/dist/jquery.js
@@ -1,2431 +1,1452 @@
-// prevent execution of jQuery if included more than once
-if(typeof window.jQuery == "undefined") {
+(function(){
 /*
- * jQuery 1.1.3a - New Wave Javascript
+ * jQuery 1.2.6 - New Wave Javascript
  *
- * Copyright (c) 2007 John Resig (jquery.com)
+ * Copyright (c) 2008 John Resig (jquery.com)
  * Dual licensed under the MIT (MIT-LICENSE.txt)
  * and GPL (GPL-LICENSE.txt) licenses.
  *
- * $Date: 2007/06/29 15:10:42 $
- * $Rev: 1961 $
+ * $Date: 2008-05-24 11:09:21 -0700 (Sat, 24 May 2008) $
+ * $Rev: 5683 $
  */
 
-// Global undefined variable
-window.undefined = window.undefined;
+// Map over jQuery in case of overwrite
+var _jQuery = window.jQuery,
+// Map over the $ in case of overwrite
+	_$ = window.$;
 
-/**
- * Create a new jQuery Object
- *
- * @constructor
- * @private
- * @name jQuery
- * @param String|Function|Element|Array<Element>|jQuery a selector
- * @param jQuery|Element|Array<Element> c context
- * @cat Core
- */
-var jQuery = function(a,c) {
-	// If the context is global, return a new object
-	if ( window == this )
-		return new jQuery(a,c);
-	
-	return this.init(a,c);
+var jQuery = window.jQuery = window.$ = function( selector, context ) {
+	// The jQuery object is actually just the init constructor 'enhanced'
+	return new jQuery.fn.init( selector, context );
 };
 
-// Map over the $ in case of overwrite
-if ( typeof $ != "undefined" )
-	jQuery._$ = $;
-	
-// Map the jQuery namespace to the '$' one
-var $ = jQuery;
+// A simple way to check for HTML strings or ID strings
+// (both of which we optimize for)
+var quickExpr = /^[^<]*(<(.|\s)+>)[^>]*$|^#(\w+)$/,
 
-/**
- * This function accepts a string containing a CSS or
- * basic XPath selector which is then used to match a set of elements.
- *
- * The core functionality of jQuery centers around this function.
- * Everything in jQuery is based upon this, or uses this in some way.
- * The most basic use of this function is to pass in an expression
- * (usually consisting of CSS or XPath), which then finds all matching
- * elements.
- *
- * By default, if no context is specified, $() looks for DOM elements within the context of the
- * current HTML document. If you do specify a context, such as a DOM
- * element or jQuery object, the expression will be matched against
- * the contents of that context.
- *
- * See [[DOM/Traversing/Selectors]] for the allowed CSS/XPath syntax for expressions.
- *
- * @example $("div > p")
- * @desc Finds all p elements that are children of a div element.
- * @before <p>one</p> <div><p>two</p></div> <p>three</p>
- * @result [ <p>two</p> ]
- *
- * @example $("input:radio", document.forms[0])
- * @desc Searches for all inputs of type radio within the first form in the document
- *
- * @example $("div", xml.responseXML)
- * @desc This finds all div elements within the specified XML document.
- *
- * @name $
- * @param String expr An expression to search with
- * @param Element|jQuery context (optional) A DOM Element, Document or jQuery to use as context
- * @cat Core
- * @type jQuery
- * @see $(Element)
- * @see $(Element<Array>)
- */
- 
-/**
- * Create DOM elements on-the-fly from the provided String of raw HTML.
- *
- * @example $("<div><p>Hello</p></div>").appendTo("body")
- * @desc Creates a div element (and all of its contents) dynamically, 
- * and appends it to the body element. Internally, an
- * element is created and its innerHTML property set to the given markup.
- * It is therefore both quite flexible and limited. 
- *
- * @name $
- * @param String html A string of HTML to create on the fly.
- * @cat Core
- * @type jQuery
- * @see appendTo(String)
- */
+// Is it a simple selector
+	isSimple = /^.[^:#\[\.]*$/,
 
-/**
- * Wrap jQuery functionality around a single or multiple DOM Element(s).
- *
- * This function also accepts XML Documents and Window objects
- * as valid arguments (even though they are not DOM Elements).
- *
- * @example $(document.body).css( "background", "black" );
- * @desc Sets the background color of the page to black.
- *
- * @example $( myForm.elements ).hide()
- * @desc Hides all the input elements within a form
- *
- * @name $
- * @param Element|Array<Element> elems DOM element(s) to be encapsulated by a jQuery object.
- * @cat Core
- * @type jQuery
- */
-
-/**
- * A shorthand for $(document).ready(), allowing you to bind a function
- * to be executed when the DOM document has finished loading. This function
- * behaves just like $(document).ready(), in that it should be used to wrap
- * other $() operations on your page that depend on the DOM being ready to be
- * operated on. While this function is, technically, chainable - there really
- * isn't much use for chaining against it.
- *
- * You can have as many $(document).ready events on your page as you like.
- *
- * See ready(Function) for details about the ready event. 
- * 
- * @example $(function(){
- *   // Document is ready
- * });
- * @desc Executes the function when the DOM is ready to be used.
- *
- * @example jQuery(function($) {
- *   // Your code using failsafe $ alias here...
- * });
- * @desc Uses both the shortcut for $(document).ready() and the argument
- * to write failsafe jQuery code using the $ alias, without relying on the
- * global alias.
- *
- * @name $
- * @param Function fn The function to execute when the DOM is ready.
- * @cat Core
- * @type jQuery
- * @see ready(Function)
- */
+// Will speed up references to undefined, and allows munging its name.
+	undefined;
 
 jQuery.fn = jQuery.prototype = {
-	/**
-	 * Initialize a new jQuery object
-	 *
-	 * @private
-	 * @name init
-	 * @param String|Function|Element|Array<Element>|jQuery a selector
-	 * @param jQuery|Element|Array<Element> c context
-	 * @cat Core
-	 */
-	init: function(a,c) {
+	init: function( selector, context ) {
 		// Make sure that a selection was provided
-		a = a || document;
+		selector = selector || document;
+
+		// Handle $(DOMElement)
+		if ( selector.nodeType ) {
+			this[0] = selector;
+			this.length = 1;
+			return this;
+		}
+		// Handle HTML strings
+		if ( typeof selector == "string" ) {
+			// Are we dealing with HTML string or an ID?
+			var match = quickExpr.exec( selector );
+
+			// Verify a match, and that no context was specified for #id
+			if ( match && (match[1] || !context) ) {
+
+				// HANDLE: $(html) -> $(array)
+				if ( match[1] )
+					selector = jQuery.clean( [ match[1] ], context );
+
+				// HANDLE: $("#id")
+				else {
+					var elem = document.getElementById( match[3] );
+
+					// Make sure an element was located
+					if ( elem ){
+						// Handle the case where IE and Opera return items
+						// by name instead of ID
+						if ( elem.id != match[3] )
+							return jQuery().find( selector );
+
+						// Otherwise, we inject the element directly into the jQuery object
+						return jQuery( elem );
+					}
+					selector = [];
+				}
+
+			// HANDLE: $(expr, [context])
+			// (which is just equivalent to: $(content).find(expr)
+			} else
+				return jQuery( context ).find( selector );
 
 		// HANDLE: $(function)
 		// Shortcut for document ready
-		if ( jQuery.isFunction(a) )
-			return new jQuery(document)[ jQuery.fn.ready ? "ready" : "load" ]( a );
+		} else if ( jQuery.isFunction( selector ) )
+			return jQuery( document )[ jQuery.fn.ready ? "ready" : "load" ]( selector );
 
-		// Handle HTML strings
-		if ( typeof a  == "string" ) {
-			// HANDLE: $(html) -> $(array)
-			var m = /^[^<]*(<(.|\s)+>)[^>]*$/.exec(a);
-			if ( m )
-				a = jQuery.clean( [ m[1] ] );
+		return this.setArray(jQuery.makeArray(selector));
+	},
 
-			// HANDLE: $(expr)
-			else
-				return new jQuery( c ).find( a );
-		}
+	// The current version of jQuery being used
+	jquery: "1.2.6",
 
-		return this.setArray(
-			// HANDLE: $(array)
-			a.constructor == Array && a ||
-
-			// HANDLE: $(arraylike)
-			// Watch for when an array-like object is passed as the selector
-			(a.jquery || a.length && a != window && !a.nodeType && a[0] != undefined && a[0].nodeType) && jQuery.makeArray( a ) ||
-
-			// HANDLE: $(*)
-			[ a ] );
-	},
-	
-	/**
-	 * The current version of jQuery.
-	 *
-	 * @private
-	 * @property
-	 * @name jquery
-	 * @type String
-	 * @cat Core
-	 */
-	jquery: "1.1.3a",
-
-	/**
-	 * The number of elements currently matched. The size function will return the same value.
-	 *
-	 * @example $("img").length;
-	 * @before <img src="test1.jpg"/> <img src="test2.jpg"/>
-	 * @result 2
-	 *
-	 * @property
-	 * @name length
-	 * @type Number
-	 * @cat Core
-	 */
-
-	/**
-	 * Get the number of elements currently matched. This returns the same
-	 * number as the 'length' property of the jQuery object.
-	 *
-	 * @example $("img").size();
-	 * @before <img src="test1.jpg"/> <img src="test2.jpg"/>
-	 * @result 2
-	 *
-	 * @name size
-	 * @type Number
-	 * @cat Core
-	 */
+	// The number of elements contained in the matched element set
 	size: function() {
 		return this.length;
 	},
-	
+
+	// The number of elements contained in the matched element set
 	length: 0,
 
-	/**
-	 * Access all matched DOM elements. This serves as a backwards-compatible
-	 * way of accessing all matched elements (other than the jQuery object
-	 * itself, which is, in fact, an array of elements).
-	 *
-	 * It is useful if you need to operate on the DOM elements themselves instead of using built-in jQuery functions.
-	 *
-	 * @example $("img").get();
-	 * @before <img src="test1.jpg"/> <img src="test2.jpg"/>
-	 * @result [ <img src="test1.jpg"/> <img src="test2.jpg"/> ]
-	 * @desc Selects all images in the document and returns the DOM Elements as an Array
-	 *
-	 * @name get
-	 * @type Array<Element>
-	 * @cat Core
-	 */
-
-	/**
-	 * Access a single matched DOM element at a specified index in the matched set.
-	 * This allows you to extract the actual DOM element and operate on it
-	 * directly without necessarily using jQuery functionality on it.
-	 *
-	 * @example $("img").get(0);
-	 * @before <img src="test1.jpg"/> <img src="test2.jpg"/>
-	 * @result <img src="test1.jpg"/>
-	 * @desc Selects all images in the document and returns the first one
-	 *
-	 * @name get
-	 * @type Element
-	 * @param Number num Access the element in the Nth position.
-	 * @cat Core
-	 */
+	// Get the Nth element in the matched element set OR
+	// Get the whole matched element set as a clean array
 	get: function( num ) {
 		return num == undefined ?
 
 			// Return a 'clean' array
 			jQuery.makeArray( this ) :
 
 			// Return just the object
-			this[num];
+			this[ num ];
 	},
-	
-	/**
-	 * Set the jQuery object to an array of elements, while maintaining
-	 * the stack.
-	 *
-	 * @example $("img").pushStack([ document.body ]);
-	 * @result $("img").pushStack() == [ document.body ]
-	 *
-	 * @private
-	 * @name pushStack
-	 * @type jQuery
-	 * @param Elements elems An array of elements
-	 * @cat Core
-	 */
-	pushStack: function( a ) {
-		var ret = jQuery(a);
+
+	// Take an array of elements and push it onto the stack
+	// (returning the new matched element set)
+	pushStack: function( elems ) {
+		// Build a new jQuery matched element set
+		var ret = jQuery( elems );
+
+		// Add the old object onto the stack (as a reference)
 		ret.prevObject = this;
+
+		// Return the newly-formed element set
 		return ret;
 	},
-	
-	/**
-	 * Set the jQuery object to an array of elements. This operation is
-	 * completely destructive - be sure to use .pushStack() if you wish to maintain
-	 * the jQuery stack.
-	 *
-	 * @example $("img").setArray([ document.body ]);
-	 * @result $("img").setArray() == [ document.body ]
-	 *
-	 * @private
-	 * @name setArray
-	 * @type jQuery
-	 * @param Elements elems An array of elements
-	 * @cat Core
-	 */
-	setArray: function( a ) {
+
+	// Force the current matched set of elements to become
+	// the specified array of elements (destroying the stack in the process)
+	// You should use pushStack() in order to do this, but maintain the stack
+	setArray: function( elems ) {
+		// Resetting the length to 0, then using the native Array push
+		// is a super-fast way to populate an object with array-like properties
 		this.length = 0;
-		[].push.apply( this, a );
+		Array.prototype.push.apply( this, elems );
+
 		return this;
 	},
 
-	/**
-	 * Execute a function within the context of every matched element.
-	 * This means that every time the passed-in function is executed
-	 * (which is once for every element matched) the 'this' keyword
-	 * points to the specific DOM element.
-	 *
-	 * Additionally, the function, when executed, is passed a single
-	 * argument representing the position of the element in the matched
-	 * set (integer, zero-index).
-	 *
-	 * @example $("img").each(function(i){
-	 *   this.src = "test" + i + ".jpg";
-	 * });
-	 * @before <img/><img/>
-	 * @result <img src="test0.jpg"/><img src="test1.jpg"/>
-	 * @desc Iterates over two images and sets their src property
-	 *
-	 * @name each
-	 * @type jQuery
-	 * @param Function fn A function to execute
-	 * @cat Core
-	 */
-	each: function( fn, args ) {
-		return jQuery.each( this, fn, args );
+	// Execute a callback for every element in the matched set.
+	// (You can seed the arguments with an array of args, but this is
+	// only used internally.)
+	each: function( callback, args ) {
+		return jQuery.each( this, callback, args );
 	},
 
-	/**
-	 * Searches every matched element for the object and returns
-	 * the index of the element, if found, starting with zero. 
-	 * Returns -1 if the object wasn't found.
-	 *
-	 * @example $("*").index( $('#foobar')[0] ) 
-	 * @before <div id="foobar"><b></b><span id="foo"></span></div>
-	 * @result 0
-	 * @desc Returns the index for the element with ID foobar
-	 *
-	 * @example $("*").index( $('#foo')[0] ) 
-	 * @before <div id="foobar"><b></b><span id="foo"></span></div>
-	 * @result 2
-	 * @desc Returns the index for the element with ID foo within another element
-	 *
-	 * @example $("*").index( $('#bar')[0] ) 
-	 * @before <div id="foobar"><b></b><span id="foo"></span></div>
-	 * @result -1
-	 * @desc Returns -1, as there is no element with ID bar
-	 *
-	 * @name index
-	 * @type Number
-	 * @param Element subject Object to search for
-	 * @cat Core
-	 */
-	index: function( obj ) {
-		var pos = -1;
-		this.each(function(i){
-			if ( this == obj ) pos = i;
-		});
-		return pos;
+	// Determine the position of an element within
+	// the matched set of elements
+	index: function( elem ) {
+		var ret = -1;
+
+		// Locate the position of the desired element
+		return jQuery.inArray(
+			// If it receives a jQuery object, the first element is used
+			elem && elem.jquery ? elem[0] : elem
+		, this );
 	},
 
-	/**
-	 * Access a property on the first matched element.
-	 * This method makes it easy to retrieve a property value
-	 * from the first matched element.
-	 *
-	 * If the element does not have an attribute with such a
- 	 * name, undefined is returned.
-	 *
-	 * @example $("img").attr("src");
-	 * @before <img src="test.jpg"/>
-	 * @result test.jpg
-	 * @desc Returns the src attribute from the first image in the document.
-	 *
-	 * @name attr
-	 * @type Object
-	 * @param String name The name of the property to access.
-	 * @cat DOM/Attributes
-	 */
+	attr: function( name, value, type ) {
+		var options = name;
 
-	/**
-	 * Set a key/value object as properties to all matched elements.
-	 *
-	 * This serves as the best way to set a large number of properties
-	 * on all matched elements.
-	 *
-	 * @example $("img").attr({ src: "test.jpg", alt: "Test Image" });
-	 * @before <img/>
-	 * @result <img src="test.jpg" alt="Test Image"/>
-	 * @desc Sets src and alt attributes to all images.
-	 *
-	 * @name attr
-	 * @type jQuery
-	 * @param Map properties Key/value pairs to set as object properties.
-	 * @cat DOM/Attributes
-	 */
+		// Look for the case where we're accessing a style value
+		if ( name.constructor == String )
+			if ( value === undefined )
+				return this[0] && jQuery[ type || "attr" ]( this[0], name );
 
-	/**
-	 * Set a single property to a value, on all matched elements.
-	 *
-	 * Note that you can't set the name property of input elements in IE.
-	 * Use $(html) or .append(html) or .html(html) to create elements
-	 * on the fly including the name property.
-	 *
-	 * @example $("img").attr("src","test.jpg");
-	 * @before <img/>
-	 * @result <img src="test.jpg"/>
-	 * @desc Sets src attribute to all images.
-	 *
-	 * @name attr
-	 * @type jQuery
-	 * @param String key The name of the property to set.
-	 * @param Object value The value to set the property to.
-	 * @cat DOM/Attributes
-	 */
-	 
-	/**
-	 * Set a single property to a computed value, on all matched elements.
-	 *
-	 * Instead of supplying a string value as described
-	 * [[DOM/Attributes#attr.28_key.2C_value_.29|above]],
-	 * a function is provided that computes the value.
-	 *
-	 * @example $("img").attr("title", function() { return this.src });
-	 * @before <img src="test.jpg" />
-	 * @result <img src="test.jpg" title="test.jpg" />
-	 * @desc Sets title attribute from src attribute.
-	 *
-	 * @example $("img").attr("title", function(index) { return this.title + (i + 1); });
-	 * @before <img title="pic" /><img title="pic" /><img title="pic" />
-	 * @result <img title="pic1" /><img title="pic2" /><img title="pic3" />
-	 * @desc Enumerate title attribute.
-	 *
-	 * @name attr
-	 * @type jQuery
-	 * @param String key The name of the property to set.
-	 * @param Function value A function returning the value to set.
-	 * 	 	  Scope: Current element, argument: Index of current element
-	 * @cat DOM/Attributes
-	 */
-	attr: function( key, value, type ) {
-		var obj = key;
-		
-		// Look for the case where we're accessing a style value
-		if ( key.constructor == String )
-			if ( value == undefined )
-				return this.length && jQuery[ type || "attr" ]( this[0], key ) || undefined;
 			else {
-				obj = {};
-				obj[ key ] = value;
+				options = {};
+				options[ name ] = value;
 			}
-		
+
 		// Check to see if we're setting style values
-		return this.each(function(index){
+		return this.each(function(i){
 			// Set all the styles
-			for ( var prop in obj )
+			for ( name in options )
 				jQuery.attr(
-					type ? this.style : this,
-					prop, jQuery.prop(this, obj[prop], type, index, prop)
+					type ?
+						this.style :
+						this,
+					name, jQuery.prop( this, options[ name ], type, i, name )
 				);
 		});
 	},
 
-	/**
-	 * Access a style property on the first matched element.
-	 * This method makes it easy to retrieve a style property value
-	 * from the first matched element.
-	 *
-	 * @example $("p").css("color");
-	 * @before <p style="color:red;">Test Paragraph.</p>
-	 * @result "red"
-	 * @desc Retrieves the color style of the first paragraph
-	 *
-	 * @example $("p").css("font-weight");
-	 * @before <p style="font-weight: bold;">Test Paragraph.</p>
-	 * @result "bold"
-	 * @desc Retrieves the font-weight style of the first paragraph.
-	 *
-	 * @name css
-	 * @type String
-	 * @param String name The name of the property to access.
-	 * @cat CSS
-	 */
-
-	/**
-	 * Set a key/value object as style properties to all matched elements.
-	 *
-	 * This serves as the best way to set a large number of style properties
-	 * on all matched elements.
-	 *
-	 * @example $("p").css({ color: "red", background: "blue" });
-	 * @before <p>Test Paragraph.</p>
-	 * @result <p style="color:red; background:blue;">Test Paragraph.</p>
-	 * @desc Sets color and background styles to all p elements.
-	 *
-	 * @name css
-	 * @type jQuery
-	 * @param Map properties Key/value pairs to set as style properties.
-	 * @cat CSS
-	 */
-
-	/**
-	 * Set a single style property to a value, on all matched elements.
-	 * If a number is provided, it is automatically converted into a pixel value.
-	 *
-	 * @example $("p").css("color","red");
-	 * @before <p>Test Paragraph.</p>
-	 * @result <p style="color:red;">Test Paragraph.</p>
-	 * @desc Changes the color of all paragraphs to red
-	 *
-	 * @example $("p").css("left",30);
-	 * @before <p>Test Paragraph.</p>
-	 * @result <p style="left:30px;">Test Paragraph.</p>
-	 * @desc Changes the left of all paragraphs to "30px"
-	 *
-	 * @name css
-	 * @type jQuery
-	 * @param String key The name of the property to set.
-	 * @param String|Number value The value to set the property to.
-	 * @cat CSS
-	 */
 	css: function( key, value ) {
+		// ignore negative width and height values
+		if ( (key == 'width' || key == 'height') && parseFloat(value) < 0 )
+			value = undefined;
 		return this.attr( key, value, "curCSS" );
 	},
 
-	/**
-	 * Get the text contents of all matched elements. The result is
-	 * a string that contains the combined text contents of all matched
-	 * elements. This method works on both HTML and XML documents.
-	 *
-	 * @example $("p").text();
-	 * @before <p><b>Test</b> Paragraph.</p><p>Paraparagraph</p>
-	 * @result Test Paragraph.Paraparagraph
-	 * @desc Gets the concatenated text of all paragraphs
-	 *
-	 * @name text
-	 * @type String
-	 * @cat DOM/Attributes
-	 */
+	text: function( text ) {
+		if ( typeof text != "object" && text != null )
+			return this.empty().append( (this[0] && this[0].ownerDocument || document).createTextNode( text ) );
 
-	/**
-	 * Set the text contents of all matched elements.
-	 *
-	 * Similar to html(), but escapes HTML (replace "<" and ">" with their
-	 * HTML entities).
-	 *
-	 * @example $("p").text("<b>Some</b> new text.");
-	 * @before <p>Test Paragraph.</p>
-	 * @result <p>&lt;b&gt;Some&lt;/b&gt; new text.</p>
-	 * @desc Sets the text of all paragraphs.
-	 *
-	 * @example $("p").text("<b>Some</b> new text.", true);
-	 * @before <p>Test Paragraph.</p>
-	 * @result <p>Some new text.</p>
-	 * @desc Sets the text of all paragraphs.
-	 *
-	 * @name text
-	 * @type String
-	 * @param String val The text value to set the contents of the element to.
-	 * @cat DOM/Attributes
-	 */
-	text: function(e) {
-		if ( typeof e == "string" )
-			return this.empty().append( document.createTextNode( e ) );
+		var ret = "";
 
-		var t = "";
-		jQuery.each( e || this, function(){
+		jQuery.each( text || this, function(){
 			jQuery.each( this.childNodes, function(){
 				if ( this.nodeType != 8 )
-					t += this.nodeType != 1 ?
-						this.nodeValue : jQuery.fn.text([ this ]);
+					ret += this.nodeType != 1 ?
+						this.nodeValue :
+						jQuery.fn.text( [ this ] );
 			});
 		});
-		return t;
+
+		return ret;
 	},
 
-	/**
-	 * Wrap all matched elements with a structure of other elements.
-	 * This wrapping process is most useful for injecting additional
-	 * stucture into a document, without ruining the original semantic
-	 * qualities of a document.
-	 *
-	 * This works by going through the first element
-	 * provided (which is generated, on the fly, from the provided HTML)
-	 * and finds the deepest ancestor element within its
-	 * structure - it is that element that will en-wrap everything else.
-	 *
-	 * This does not work with elements that contain text. Any necessary text
-	 * must be added after the wrapping is done.
-	 *
-	 * @example $("p").wrap("<div class='wrap'></div>");
-	 * @before <p>Test Paragraph.</p>
-	 * @result <div class='wrap'><p>Test Paragraph.</p></div>
-	 * 
-	 * @name wrap
-	 * @type jQuery
-	 * @param String html A string of HTML, that will be created on the fly and wrapped around the target.
-	 * @cat DOM/Manipulation
-	 */
+	wrapAll: function( html ) {
+		if ( this[0] )
+			// The elements to wrap the target around
+			jQuery( html, this[0].ownerDocument )
+				.clone()
+				.insertBefore( this[0] )
+				.map(function(){
+					var elem = this;
 
-	/**
-	 * Wrap all matched elements with a structure of other elements.
-	 * This wrapping process is most useful for injecting additional
-	 * stucture into a document, without ruining the original semantic
-	 * qualities of a document.
-	 *
-	 * This works by going through the first element
-	 * provided and finding the deepest ancestor element within its
-	 * structure - it is that element that will en-wrap everything else.
-	 *
- 	 * This does not work with elements that contain text. Any necessary text
-	 * must be added after the wrapping is done.
-	 *
-	 * @example $("p").wrap( document.getElementById('content') );
-	 * @before <p>Test Paragraph.</p><div id="content"></div>
-	 * @result <div id="content"><p>Test Paragraph.</p></div>
-	 *
-	 * @name wrap
-	 * @type jQuery
-	 * @param Element elem A DOM element that will be wrapped around the target.
-	 * @cat DOM/Manipulation
-	 */
-	wrap: function() {
-		// The elements to wrap the target around
-		var a, args = arguments;
+					while ( elem.firstChild )
+						elem = elem.firstChild;
 
-		// Wrap each of the matched elements individually
+					return elem;
+				})
+				.append(this);
+
+		return this;
+	},
+
+	wrapInner: function( html ) {
 		return this.each(function(){
-			if ( !a )
-				a = jQuery.clean(args, this.ownerDocument);
-
-			// Clone the structure that we're using to wrap
-			var b = a[0].cloneNode(true);
-
-			// Insert it before the element to be wrapped
-			this.parentNode.insertBefore( b, this );
-
-			// Find the deepest point in the wrap structure
-			while ( b.firstChild )
-				b = b.firstChild;
-
-			// Move the matched element to within the wrap structure
-			b.appendChild( this );
+			jQuery( this ).contents().wrapAll( html );
 		});
 	},
 
-	/**
-	 * Append content to the inside of every matched element.
-	 *
-	 * This operation is similar to doing an appendChild to all the
-	 * specified elements, adding them into the document.
-	 *
-	 * @example $("p").append("<b>Hello</b>");
-	 * @before <p>I would like to say: </p>
-	 * @result <p>I would like to say: <b>Hello</b></p>
-	 * @desc Appends some HTML to all paragraphs.
-	 *
-	 * @example $("p").append( $("#foo")[0] );
-	 * @before <p>I would like to say: </p><b id="foo">Hello</b>
-	 * @result <p>I would like to say: <b id="foo">Hello</b></p>
-	 * @desc Appends an Element to all paragraphs.
-	 *
-	 * @example $("p").append( $("b") );
-	 * @before <p>I would like to say: </p><b>Hello</b>
-	 * @result <p>I would like to say: <b>Hello</b></p>
-	 * @desc Appends a jQuery object (similar to an Array of DOM Elements) to all paragraphs.
-	 *
-	 * @name append
-	 * @type jQuery
-	 * @param <Content> content Content to append to the target
-	 * @cat DOM/Manipulation
-	 * @see prepend(<Content>)
-	 * @see before(<Content>)
-	 * @see after(<Content>)
-	 */
-	append: function() {
-		return this.domManip(arguments, true, 1, function(a){
-			this.appendChild( a );
+	wrap: function( html ) {
+		return this.each(function(){
+			jQuery( this ).wrapAll( html );
 		});
 	},
 
-	/**
-	 * Prepend content to the inside of every matched element.
-	 *
-	 * This operation is the best way to insert elements
-	 * inside, at the beginning, of all matched elements.
-	 *
-	 * @example $("p").prepend("<b>Hello</b>");
-	 * @before <p>I would like to say: </p>
-	 * @result <p><b>Hello</b>I would like to say: </p>
-	 * @desc Prepends some HTML to all paragraphs.
-	 *
-	 * @example $("p").prepend( $("#foo")[0] );
-	 * @before <p>I would like to say: </p><b id="foo">Hello</b>
-	 * @result <p><b id="foo">Hello</b>I would like to say: </p>
-	 * @desc Prepends an Element to all paragraphs.
-	 *	
-	 * @example $("p").prepend( $("b") );
-	 * @before <p>I would like to say: </p><b>Hello</b>
-	 * @result <p><b>Hello</b>I would like to say: </p>
-	 * @desc Prepends a jQuery object (similar to an Array of DOM Elements) to all paragraphs.
-	 *
-	 * @name prepend
-	 * @type jQuery
-	 * @param <Content> content Content to prepend to the target.
-	 * @cat DOM/Manipulation
-	 * @see append(<Content>)
-	 * @see before(<Content>)
-	 * @see after(<Content>)
-	 */
-	prepend: function() {
-		return this.domManip(arguments, true, -1, function(a){
-			this.insertBefore( a, this.firstChild );
-		});
-	},
-	
-	/**
-	 * Insert content before each of the matched elements.
-	 *
-	 * @example $("p").before("<b>Hello</b>");
-	 * @before <p>I would like to say: </p>
-	 * @result <b>Hello</b><p>I would like to say: </p>
-	 * @desc Inserts some HTML before all paragraphs.
-	 *
-	 * @example $("p").before( $("#foo")[0] );
-	 * @before <p>I would like to say: </p><b id="foo">Hello</b>
-	 * @result <b id="foo">Hello</b><p>I would like to say: </p>
-	 * @desc Inserts an Element before all paragraphs.
-	 *
-	 * @example $("p").before( $("b") );
-	 * @before <p>I would like to say: </p><b>Hello</b>
-	 * @result <b>Hello</b><p>I would like to say: </p>
-	 * @desc Inserts a jQuery object (similar to an Array of DOM Elements) before all paragraphs.
-	 *
-	 * @name before
-	 * @type jQuery
-	 * @param <Content> content Content to insert before each target.
-	 * @cat DOM/Manipulation
-	 * @see append(<Content>)
-	 * @see prepend(<Content>)
-	 * @see after(<Content>)
-	 */
-	before: function() {
-		return this.domManip(arguments, false, 1, function(a){
-			this.parentNode.insertBefore( a, this );
+	append: function() {
+		return this.domManip(arguments, true, false, function(elem){
+			if (this.nodeType == 1)
+				this.appendChild( elem );
 		});
 	},
 
-	/**
-	 * Insert content after each of the matched elements.
-	 *
-	 * @example $("p").after("<b>Hello</b>");
-	 * @before <p>I would like to say: </p>
-	 * @result <p>I would like to say: </p><b>Hello</b>
-	 * @desc Inserts some HTML after all paragraphs.
-	 *
-	 * @example $("p").after( $("#foo")[0] );
-	 * @before <b id="foo">Hello</b><p>I would like to say: </p>
-	 * @result <p>I would like to say: </p><b id="foo">Hello</b>
-	 * @desc Inserts an Element after all paragraphs.
-	 *
-	 * @example $("p").after( $("b") );
-	 * @before <b>Hello</b><p>I would like to say: </p>
-	 * @result <p>I would like to say: </p><b>Hello</b>
-	 * @desc Inserts a jQuery object (similar to an Array of DOM Elements) after all paragraphs.
-	 *
-	 * @name after
-	 * @type jQuery
-	 * @param <Content> content Content to insert after each target.
-	 * @cat DOM/Manipulation
-	 * @see append(<Content>)
-	 * @see prepend(<Content>)
-	 * @see before(<Content>)
-	 */
-	after: function() {
-		return this.domManip(arguments, false, -1, function(a){
-			this.parentNode.insertBefore( a, this.nextSibling );
+	prepend: function() {
+		return this.domManip(arguments, true, true, function(elem){
+			if (this.nodeType == 1)
+				this.insertBefore( elem, this.firstChild );
 		});
 	},
 
-	/**
-	 * Revert the most recent 'destructive' operation, changing the set of matched elements
-	 * to its previous state (right before the destructive operation).
-	 *
-	 * If there was no destructive operation before, an empty set is returned.
-	 *
-	 * A 'destructive' operation is any operation that changes the set of
-	 * matched jQuery elements. These functions are: <code>add</code>,
-	 * <code>children</code>, <code>clone</code>, <code>filter</code>,
-	 * <code>find</code>, <code>not</code>, <code>next</code>,
-	 * <code>parent</code>, <code>parents</code>, <code>prev</code> and <code>siblings</code>.
-	 *
-	 * @example $("p").find("span").end();
-	 * @before <p><span>Hello</span>, how are you?</p>
-	 * @result [ <p>...</p> ]
-	 * @desc Selects all paragraphs, finds span elements inside these, and reverts the
-	 * selection back to the paragraphs.
-	 *
-	 * @name end
-	 * @type jQuery
-	 * @cat DOM/Traversing
-	 */
-	end: function() {
-		return this.prevObject || jQuery([]);
+	before: function() {
+		return this.domManip(arguments, false, false, function(elem){
+			this.parentNode.insertBefore( elem, this );
+		});
 	},
 
-	/**
-	 * Searches for all elements that match the specified expression.
-	 
-	 * This method is a good way to find additional descendant
-	 * elements with which to process.
-	 *
-	 * All searching is done using a jQuery expression. The expression can be
-	 * written using CSS 1-3 Selector syntax, or basic XPath.
-	 *
-	 * @example $("p").find("span");
-	 * @before <p><span>Hello</span>, how are you?</p>
-	 * @result [ <span>Hello</span> ]
-	 * @desc Starts with all paragraphs and searches for descendant span
-	 * elements, same as $("p span")
-	 *
-	 * @name find
-	 * @type jQuery
-	 * @param String expr An expression to search with.
-	 * @cat DOM/Traversing
-	 */
-	find: function(t) {
-		return this.pushStack( jQuery.unique( jQuery.map( this, function(a){
-			return jQuery.find(t,a);
-		}) ), t );
+	after: function() {
+		return this.domManip(arguments, false, true, function(elem){
+			this.parentNode.insertBefore( elem, this.nextSibling );
+		});
 	},
 
-	/**
-	 * Clone matched DOM Elements and select the clones. 
-	 *
-	 * This is useful for moving copies of the elements to another
-	 * location in the DOM.
-	 *
-	 * @example $("b").clone().prependTo("p");
-	 * @before <b>Hello</b><p>, how are you?</p>
-	 * @result <b>Hello</b><p><b>Hello</b>, how are you?</p>
-	 * @desc Clones all b elements (and selects the clones) and prepends them to all paragraphs.
-	 *
-	 * @name clone
-	 * @type jQuery
-	 * @param Boolean deep (Optional) Set to false if you don't want to clone all descendant nodes, in addition to the element itself.
-	 * @cat DOM/Manipulation
-	 */
-	clone: function(deep) {
-		// Need to remove events on the element and its descendants
-		var $this = this.add(this.find("*"));
-		$this.each(function() {
-			this._$events = {};
-			for (var type in this.$events)
-				this._$events[type] = jQuery.extend({},this.$events[type]);
-		}).unbind();
+	end: function() {
+		return this.prevObject || jQuery( [] );
+	},
 
-		// Do the clone
-		var r = this.pushStack( jQuery.map( this, function(a){
-			return a.cloneNode( deep != undefined ? deep : true );
-		}) );
-
-		// Add the events back to the original and its descendants
-		$this.each(function() {
-			var events = this._$events;
-			for (var type in events)
-				for (var handler in events[type])
-					jQuery.event.add(this, type, events[type][handler], events[type][handler].data);
-			this._$events = null;
+	find: function( selector ) {
+		var elems = jQuery.map(this, function(elem){
+			return jQuery.find( selector, elem );
 		});
 
-		// Return the cloned set
-		return r;
+		return this.pushStack( /[^+>] [^+>]/.test( selector ) || selector.indexOf("..") > -1 ?
+			jQuery.unique( elems ) :
+			elems );
 	},
 
-	/**
-	 * Removes all elements from the set of matched elements that do not
-	 * match the specified expression(s). This method is used to narrow down
-	 * the results of a search.
-	 *
-	 * Provide a comma-separated list of expressions to apply multiple filters at once.
-	 *
-	 * @example $("p").filter(".selected")
-	 * @before <p class="selected">Hello</p><p>How are you?</p>
-	 * @result [ <p class="selected">Hello</p> ]
-	 * @desc Selects all paragraphs and removes those without a class "selected".
-	 *
-	 * @example $("p").filter(".selected, :first")
-	 * @before <p>Hello</p><p>Hello Again</p><p class="selected">And Again</p>
-	 * @result [ <p>Hello</p>, <p class="selected">And Again</p> ]
-	 * @desc Selects all paragraphs and removes those without class "selected" and being the first one.
-	 *
-	 * @name filter
-	 * @type jQuery
-	 * @param String expression Expression(s) to search with.
-	 * @cat DOM/Traversing
-	 */
-	 
-	/**
-	 * Removes all elements from the set of matched elements that do not
-	 * pass the specified filter. This method is used to narrow down
-	 * the results of a search.
-	 *
-	 * @example $("p").filter(function(index) {
-	 *   return $("ol", this).length == 0;
-	 * })
-	 * @before <p><ol><li>Hello</li></ol></p><p>How are you?</p>
-	 * @result [ <p>How are you?</p> ]
-	 * @desc Remove all elements that have a child ol element
-	 *
-	 * @name filter
-	 * @type jQuery
-	 * @param Function filter A function to use for filtering
-	 * @cat DOM/Traversing
-	 */
-	filter: function(t) {
+	clone: function( events ) {
+		// Do the clone
+		var ret = this.map(function(){
+			if ( jQuery.browser.msie && !jQuery.isXMLDoc(this) ) {
+				// IE copies events bound via attachEvent when
+				// using cloneNode. Calling detachEvent on the
+				// clone will also remove the events from the orignal
+				// In order to get around this, we use innerHTML.
+				// Unfortunately, this means some modifications to
+				// attributes in IE that are actually only stored
+				// as properties will not be copied (such as the
+				// the name attribute on an input).
+				var clone = this.cloneNode(true),
+					container = document.createElement("div");
+				container.appendChild(clone);
+				return jQuery.clean([container.innerHTML])[0];
+			} else
+				return this.cloneNode(true);
+		});
+
+		// Need to set the expando to null on the cloned set if it exists
+		// removeData doesn't work here, IE removes it from the original as well
+		// this is primarily for IE but the data expando shouldn't be copied over in any browser
+		var clone = ret.find("*").andSelf().each(function(){
+			if ( this[ expando ] != undefined )
+				this[ expando ] = null;
+		});
+
+		// Copy the events from the original to the clone
+		if ( events === true )
+			this.find("*").andSelf().each(function(i){
+				if (this.nodeType == 3)
+					return;
+				var events = jQuery.data( this, "events" );
+
+				for ( var type in events )
+					for ( var handler in events[ type ] )
+						jQuery.event.add( clone[ i ], type, events[ type ][ handler ], events[ type ][ handler ].data );
+			});
+
+		// Return the cloned set
+		return ret;
+	},
+
+	filter: function( selector ) {
 		return this.pushStack(
-			jQuery.isFunction( t ) &&
-			jQuery.grep(this, function(el, index){
-				return t.apply(el, [index])
+			jQuery.isFunction( selector ) &&
+			jQuery.grep(this, function(elem, i){
+				return selector.call( elem, i );
 			}) ||
 
-			jQuery.multiFilter(t,this) );
+			jQuery.multiFilter( selector, this ) );
 	},
 
-	/**
-	 * Removes the specified Element from the set of matched elements. This
-	 * method is used to remove a single Element from a jQuery object.
-	 *
-	 * @example $("p").not( $("#selected")[0] )
-	 * @before <p>Hello</p><p id="selected">Hello Again</p>
-	 * @result [ <p>Hello</p> ]
-	 * @desc Removes the element with the ID "selected" from the set of all paragraphs.
-	 *
-	 * @name not
-	 * @type jQuery
-	 * @param Element el An element to remove from the set
-	 * @cat DOM/Traversing
-	 */
+	not: function( selector ) {
+		if ( selector.constructor == String )
+			// test special case where just one selector is passed in
+			if ( isSimple.test( selector ) )
+				return this.pushStack( jQuery.multiFilter( selector, this, true ) );
+			else
+				selector = jQuery.multiFilter( selector, this );
 
-	/**
-	 * Removes elements matching the specified expression from the set
-	 * of matched elements. This method is used to remove one or more
-	 * elements from a jQuery object.
-	 *
-	 * @example $("p").not("#selected")
-	 * @before <p>Hello</p><p id="selected">Hello Again</p>
-	 * @result [ <p>Hello</p> ]
-	 * @desc Removes the element with the ID "selected" from the set of all paragraphs.
-	 *
-	 * @name not
-	 * @type jQuery
-	 * @param String expr An expression with which to remove matching elements
-	 * @cat DOM/Traversing
-	 */
-
-	/**
-	 * Removes any elements inside the array of elements from the set
-	 * of matched elements. This method is used to remove one or more
-	 * elements from a jQuery object.
-	 *
-	 * Please note: the expression cannot use a reference to the
-	 * element name. See the two examples below.
-	 *
-	 * @example $("p").not( $("div p.selected") )
-	 * @before <div><p>Hello</p><p class="selected">Hello Again</p></div>
-	 * @result [ <p>Hello</p> ]
-	 * @desc Removes all elements that match "div p.selected" from the total set of all paragraphs.
-	 *
-	 * @name not
-	 * @type jQuery
-	 * @param jQuery elems A set of elements to remove from the jQuery set of matched elements.
-	 * @cat DOM/Traversing
-	 */
-	not: function(t) {
-		return this.pushStack(
-			t.constructor == String &&
-			jQuery.multiFilter(t, this, true) ||
-
-			jQuery.grep(this, function(a) {
-				return ( t.constructor == Array || t.jquery )
-					? jQuery.inArray( a, t ) < 0
-					: a != t;
-			})
-		);
+		var isArrayLike = selector.length && selector[selector.length - 1] !== undefined && !selector.nodeType;
+		return this.filter(function() {
+			return isArrayLike ? jQuery.inArray( this, selector ) < 0 : this != selector;
+		});
 	},
 
-	/**
-	 * Adds more elements, matched by the given expression,
-	 * to the set of matched elements.
-	 *
-	 * @example $("p").add("span")
-	 * @before (HTML) <p>Hello</p><span>Hello Again</span>
-	 * @result (jQuery object matching 2 elements) [ <p>Hello</p>, <span>Hello Again</span> ]
-	 * @desc Compare the above result to the result of <code>$('p')</code>,
-	 * which would just result in <code><nowiki>[ <p>Hello</p> ]</nowiki></code>.
-	 * Using add(), matched elements of <code>$('span')</code> are simply
-	 * added to the returned jQuery-object.
-	 *
-	 * @name add
-	 * @type jQuery
-	 * @param String expr An expression whose matched elements are added
-	 * @cat DOM/Traversing
-	 */
-	 
-	/**
-	 * Adds more elements, created on the fly, to the set of
-	 * matched elements.
-	 *
-	 * @example $("p").add("<span>Again</span>")
-	 * @before <p>Hello</p>
-	 * @result [ <p>Hello</p>, <span>Again</span> ]
-	 *
-	 * @name add
-	 * @type jQuery
-	 * @param String html A string of HTML to create on the fly.
-	 * @cat DOM/Traversing
-	 */
-
-	/**
-	 * Adds one or more Elements to the set of matched elements.
-	 *
-	 * @example $("p").add( document.getElementById("a") )
-	 * @before <p>Hello</p><p><span id="a">Hello Again</span></p>
-	 * @result [ <p>Hello</p>, <span id="a">Hello Again</span> ]
-	 *
-	 * @example $("p").add( document.forms[0].elements )
-	 * @before <p>Hello</p><p><form><input/><button/></form>
-	 * @result [ <p>Hello</p>, <input/>, <button/> ]
-	 *
-	 * @name add
-	 * @type jQuery
-	 * @param Element|Array<Element> elements One or more Elements to add
-	 * @cat DOM/Traversing
-	 */
-	add: function(t) {
-		return this.pushStack( jQuery.merge(
+	add: function( selector ) {
+		return this.pushStack( jQuery.unique( jQuery.merge(
 			this.get(),
-			t.constructor == String ?
-				jQuery(t).get() :
-				t.length != undefined && (!t.nodeName || t.nodeName == "FORM") ?
-					t : [t] )
-		);
+			typeof selector == 'string' ?
+				jQuery( selector ) :
+				jQuery.makeArray( selector )
+		)));
 	},
 
-	/**
-	 * Checks the current selection against an expression and returns true,
-	 * if at least one element of the selection fits the given expression.
-	 *
-	 * Does return false, if no element fits or the expression is not valid.
-	 *
-	 * filter(String) is used internally, therefore all rules that apply there
-	 * apply here, too.
-	 *
-	 * @example $("input[@type='checkbox']").parent().is("form")
-	 * @before <form><input type="checkbox" /></form>
-	 * @result true
-	 * @desc Returns true, because the parent of the input is a form element
-	 * 
-	 * @example $("input[@type='checkbox']").parent().is("form")
-	 * @before <form><p><input type="checkbox" /></p></form>
-	 * @result false
-	 * @desc Returns false, because the parent of the input is a p element
-	 *
-	 * @name is
-	 * @type Boolean
-	 * @param String expr The expression with which to filter
-	 * @cat DOM/Traversing
-	 */
-	is: function(expr) {
-		return expr ? jQuery.multiFilter(expr,this).length > 0 : false;
+	is: function( selector ) {
+		return !!selector && jQuery.multiFilter( selector, this ).length > 0;
 	},
-	
-	/**
-	 * Get the content of the value attribute of the first matched element.
-	 *
-	 * Use caution when relying on this function to check the value of
-	 * multiple-select elements and checkboxes in a form. While it will
-	 * still work as intended, it may not accurately represent the value
-	 * the server will receive because these elements may send an array
-	 * of values. For more robust handling of field values, see the
-	 * [http://www.malsup.com/jquery/form/#fields fieldValue function of the Form Plugin].
-	 *
-	 * @example $("input").val();
-	 * @before <input type="text" value="some text"/>
-	 * @result "some text"
-	 *
-	 * @name val
-	 * @type String
-	 * @cat DOM/Attributes
-	 */
-	
-	/**
-	 * 	Set the value attribute of every matched element.
-	 *
-	 * @example $("input").val("test");
-	 * @before <input type="text" value="some text"/>
-	 * @result <input type="text" value="test"/>
-	 *
-	 * @name val
-	 * @type jQuery
-	 * @param String val Set the property to the specified value.
-	 * @cat DOM/Attributes
-	 */
-	val: function( val ) {
-		return val == undefined ?
-			( this.length ? this[0].value : null ) :
-			this.attr( "value", val );
+
+	hasClass: function( selector ) {
+		return this.is( "." + selector );
 	},
-	
-	/**
-	 * Get the html contents of the first matched element.
-	 * This property is not available on XML documents.
-	 *
-	 * @example $("div").html();
-	 * @before <div><input/></div>
-	 * @result <input/>
-	 *
-	 * @name html
-	 * @type String
-	 * @cat DOM/Attributes
-	 */
-	
-	/**
-	 * Set the html contents of every matched element.
-	 * This property is not available on XML documents.
-	 *
-	 * @example $("div").html("<b>new stuff</b>");
-	 * @before <div><input/></div>
-	 * @result <div><b>new stuff</b></div>
-	 *
-	 * @name html
-	 * @type jQuery
-	 * @param String val Set the html contents to the specified value.
-	 * @cat DOM/Attributes
-	 */
-	html: function( val ) {
-		return val == undefined ?
-			( this.length ? this[0].innerHTML : null ) :
-			this.empty().append( val );
-	},
-	
-	/**
-	 * @private
-	 * @name domManip
-	 * @param Array args
-	 * @param Boolean table Insert TBODY in TABLEs if one is not found.
-	 * @param Number dir If dir<0, process args in reverse order.
-	 * @param Function fn The function doing the DOM manipulation.
-	 * @type jQuery
-	 * @cat Core
-	 */
-	domManip: function(args, table, dir, fn){
-		var clone = this.length > 1, a; 
+
+	val: function( value ) {
+		if ( value == undefined ) {
+
+			if ( this.length ) {
+				var elem = this[0];
+
+				// We need to handle select boxes special
+				if ( jQuery.nodeName( elem, "select" ) ) {
+					var index = elem.selectedIndex,
+						values = [],
+						options = elem.options,
+						one = elem.type == "select-one";
+
+					// Nothing was selected
+					if ( index < 0 )
+						return null;
+
+					// Loop through all the selected options
+					for ( var i = one ? index : 0, max = one ? index + 1 : options.length; i < max; i++ ) {
+						var option = options[ i ];
+
+						if ( option.selected ) {
+							// Get the specifc value for the option
+							value = jQuery.browser.msie && !option.attributes.value.specified ? option.text : option.value;
+
+							// We don't need an array for one selects
+							if ( one )
+								return value;
+
+							// Multi-Selects return an array
+							values.push( value );
+						}
+					}
+
+					return values;
+
+				// Everything else, we just grab the value
+				} else
+					return (this[0].value || "").replace(/\r/g, "");
+
+			}
+
+			return undefined;
+		}
+
+		if( value.constructor == Number )
+			value += '';
 
 		return this.each(function(){
-			if ( !a ) {
-				a = jQuery.clean(args, this.ownerDocument);
-				if ( dir < 0 )
-					a.reverse();
+			if ( this.nodeType != 1 )
+				return;
+
+			if ( value.constructor == Array && /radio|checkbox/.test( this.type ) )
+				this.checked = (jQuery.inArray(this.value, value) >= 0 ||
+					jQuery.inArray(this.name, value) >= 0);
+
+			else if ( jQuery.nodeName( this, "select" ) ) {
+				var values = jQuery.makeArray(value);
+
+				jQuery( "option", this ).each(function(){
+					this.selected = (jQuery.inArray( this.value, values ) >= 0 ||
+						jQuery.inArray( this.text, values ) >= 0);
+				});
+
+				if ( !values.length )
+					this.selectedIndex = -1;
+
+			} else
+				this.value = value;
+		});
+	},
+
+	html: function( value ) {
+		return value == undefined ?
+			(this[0] ?
+				this[0].innerHTML :
+				null) :
+			this.empty().append( value );
+	},
+
+	replaceWith: function( value ) {
+		return this.after( value ).remove();
+	},
+
+	eq: function( i ) {
+		return this.slice( i, i + 1 );
+	},
+
+	slice: function() {
+		return this.pushStack( Array.prototype.slice.apply( this, arguments ) );
+	},
+
+	map: function( callback ) {
+		return this.pushStack( jQuery.map(this, function(elem, i){
+			return callback.call( elem, i, elem );
+		}));
+	},
+
+	andSelf: function() {
+		return this.add( this.prevObject );
+	},
+
+	data: function( key, value ){
+		var parts = key.split(".");
+		parts[1] = parts[1] ? "." + parts[1] : "";
+
+		if ( value === undefined ) {
+			var data = this.triggerHandler("getData" + parts[1] + "!", [parts[0]]);
+
+			if ( data === undefined && this.length )
+				data = jQuery.data( this[0], key );
+
+			return data === undefined && parts[1] ?
+				this.data( parts[0] ) :
+				data;
+		} else
+			return this.trigger("setData" + parts[1] + "!", [parts[0], value]).each(function(){
+				jQuery.data( this, key, value );
+			});
+	},
+
+	removeData: function( key ){
+		return this.each(function(){
+			jQuery.removeData( this, key );
+		});
+	},
+
+	domManip: function( args, table, reverse, callback ) {
+		var clone = this.length > 1, elems;
+
+		return this.each(function(){
+			if ( !elems ) {
+				elems = jQuery.clean( args, this.ownerDocument );
+
+				if ( reverse )
+					elems.reverse();
 			}
 
 			var obj = this;
 
-			if ( table && jQuery.nodeName(this, "table") && jQuery.nodeName(a[0], "tr") )
-				obj = this.getElementsByTagName("tbody")[0] || this.appendChild(document.createElement("tbody"));
+			if ( table && jQuery.nodeName( this, "table" ) && jQuery.nodeName( elems[0], "tr" ) )
+				obj = this.getElementsByTagName("tbody")[0] || this.appendChild( this.ownerDocument.createElement("tbody") );
 
-			jQuery.each( a, function(){
-				fn.apply( obj, [ clone ? this.cloneNode(true) : this ] );
+			var scripts = jQuery( [] );
+
+			jQuery.each(elems, function(){
+				var elem = clone ?
+					jQuery( this ).clone( true )[0] :
+					this;
+
+				// execute all scripts after the elements have been injected
+				if ( jQuery.nodeName( elem, "script" ) )
+					scripts = scripts.add( elem );
+				else {
+					// Remove any inner scripts for later evaluation
+					if ( elem.nodeType == 1 )
+						scripts = scripts.add( jQuery( "script", elem ).remove() );
+
+					// Inject the elements into the document
+					callback.call( obj, elem );
+				}
 			});
 
+			scripts.each( evalScript );
 		});
 	}
 };
 
-/**
- * Extends the jQuery object itself. Can be used to add functions into
- * the jQuery namespace and to [[Plugins/Authoring|add plugin methods]] (plugins).
- * 
- * @example jQuery.fn.extend({
- *   check: function() {
- *     return this.each(function() { this.checked = true; });
- *   },
- *   uncheck: function() {
- *     return this.each(function() { this.checked = false; });
- *   }
- * });
- * $("input[@type=checkbox]").check();
- * $("input[@type=radio]").uncheck();
- * @desc Adds two plugin methods.
- *
- * @example jQuery.extend({
- *   min: function(a, b) { return a < b ? a : b; },
- *   max: function(a, b) { return a > b ? a : b; }
- * });
- * @desc Adds two functions into the jQuery namespace
- *
- * @name $.extend
- * @param Object prop The object that will be merged into the jQuery object
- * @type Object
- * @cat Core
- */
+// Give the init function the jQuery prototype for later instantiation
+jQuery.fn.init.prototype = jQuery.fn;
 
-/**
- * Extend one object with one or more others, returning the original,
- * modified, object. This is a great utility for simple inheritance.
- * 
- * @example var settings = { validate: false, limit: 5, name: "foo" };
- * var options = { validate: true, name: "bar" };
- * jQuery.extend(settings, options);
- * @result settings == { validate: true, limit: 5, name: "bar" }
- * @desc Merge settings and options, modifying settings
- *
- * @example var defaults = { validate: false, limit: 5, name: "foo" };
- * var options = { validate: true, name: "bar" };
- * var settings = jQuery.extend({}, defaults, options);
- * @result settings == { validate: true, limit: 5, name: "bar" }
- * @desc Merge defaults and options, without modifying the defaults
- *
- * @name $.extend
- * @param Object target The object to extend
- * @param Object prop1 The object that will be merged into the first.
- * @param Object propN (optional) More objects to merge into the first
- * @type Object
- * @cat JavaScript
- */
+function evalScript( i, elem ) {
+	if ( elem.src )
+		jQuery.ajax({
+			url: elem.src,
+			async: false,
+			dataType: "script"
+		});
+
+	else
+		jQuery.globalEval( elem.text || elem.textContent || elem.innerHTML || "" );
+
+	if ( elem.parentNode )
+		elem.parentNode.removeChild( elem );
+}
+
+function now(){
+	return +new Date;
+}
+
 jQuery.extend = jQuery.fn.extend = function() {
 	// copy reference to target object
-	var target = arguments[0], a = 1;
+	var target = arguments[0] || {}, i = 1, length = arguments.length, deep = false, options;
+
+	// Handle a deep copy situation
+	if ( target.constructor == Boolean ) {
+		deep = target;
+		target = arguments[1] || {};
+		// skip the boolean and the target
+		i = 2;
+	}
+
+	// Handle case when target is a string or something (possible in deep copy)
+	if ( typeof target != "object" && typeof target != "function" )
+		target = {};
 
 	// extend jQuery itself if only one argument is passed
-	if ( arguments.length == 1 ) {
+	if ( length == i ) {
 		target = this;
-		a = 0;
+		--i;
 	}
-	var prop;
-	while ( (prop = arguments[a++]) != null )
-		// Extend the base object
-		for ( var i in prop ) target[i] = prop[i];
+
+	for ( ; i < length; i++ )
+		// Only deal with non-null/undefined values
+		if ( (options = arguments[ i ]) != null )
+			// Extend the base object
+			for ( var name in options ) {
+				var src = target[ name ], copy = options[ name ];
+
+				// Prevent never-ending loop
+				if ( target === copy )
+					continue;
+
+				// Recurse if we're merging object values
+				if ( deep && copy && typeof copy == "object" && !copy.nodeType )
+					target[ name ] = jQuery.extend( deep, 
+						// Never move original objects, clone them
+						src || ( copy.length != null ? [ ] : { } )
+					, copy );
+
+				// Don't bring in undefined values
+				else if ( copy !== undefined )
+					target[ name ] = copy;
+
+			}
 
 	// Return the modified object
 	return target;
 };
 
+var expando = "jQuery" + now(), uuid = 0, windowData = {},
+	// exclude the following css properties to add px
+	exclude = /z-?index|font-?weight|opacity|zoom|line-?height/i,
+	// cache defaultView
+	defaultView = document.defaultView || {};
+
 jQuery.extend({
-	/**
-	 * Run this function to give control of the $ variable back
-	 * to whichever library first implemented it. This helps to make 
-	 * sure that jQuery doesn't conflict with the $ object
-	 * of other libraries.
-	 *
-	 * By using this function, you will only be able to access jQuery
-	 * using the 'jQuery' variable. For example, where you used to do
-	 * $("div p"), you now must do jQuery("div p").
-	 *
-	 * @example jQuery.noConflict();
-	 * // Do something with jQuery
-	 * jQuery("div p").hide();
-	 * // Do something with another library's $()
-	 * $("content").style.display = 'none';
-	 * @desc Maps the original object that was referenced by $ back to $
-	 *
-	 * @example jQuery.noConflict();
-	 * (function($) { 
-	 *   $(function() {
-	 *     // more code using $ as alias to jQuery
-	 *   });
-	 * })(jQuery);
-	 * // other code using $ as an alias to the other library
-	 * @desc Reverts the $ alias and then creates and executes a
-	 * function to provide the $ as a jQuery alias inside the functions
-	 * scope. Inside the function the original $ object is not available.
-	 * This works well for most plugins that don't rely on any other library.
-	 * 
-	 *
-	 * @name $.noConflict
-	 * @type undefined
-	 * @cat Core 
-	 */
-	noConflict: function() {
-		if ( jQuery._$ )
-			$ = jQuery._$;
+	noConflict: function( deep ) {
+		window.$ = _$;
+
+		if ( deep )
+			window.jQuery = _jQuery;
+
 		return jQuery;
 	},
 
-	// This may seem like some crazy code, but trust me when I say that this
-	// is the only cross-browser way to do this. --John
+	// See test/unit/core.js for details concerning this function.
 	isFunction: function( fn ) {
-		return !!fn && typeof fn != "string" && !fn.nodeName && 
-			fn.constructor != Array && /function/i.test( fn + "" );
+		return !!fn && typeof fn != "string" && !fn.nodeName &&
+			fn.constructor != Array && /^[\s[]?function/.test( fn + "" );
 	},
-	
-	// check if an element is in a XML document
-	isXMLDoc: function(elem) {
-		return elem.tagName && elem.ownerDocument && !elem.ownerDocument.body;
+
+	// check if an element is in a (or is an) XML document
+	isXMLDoc: function( elem ) {
+		return elem.documentElement && !elem.body ||
+			elem.tagName && elem.ownerDocument && !elem.ownerDocument.body;
+	},
+
+	// Evalulates a script in a global context
+	globalEval: function( data ) {
+		data = jQuery.trim( data );
+
+		if ( data ) {
+			// Inspired by code by Andrea Giammarchi
+			// http://webreflection.blogspot.com/2007/08/global-scope-evaluation-and-dom.html
+			var head = document.getElementsByTagName("head")[0] || document.documentElement,
+				script = document.createElement("script");
+
+			script.type = "text/javascript";
+			if ( jQuery.browser.msie )
+				script.text = data;
+			else
+				script.appendChild( document.createTextNode( data ) );
+
+			// Use insertBefore instead of appendChild  to circumvent an IE6 bug.
+			// This arises when a base node is used (#2709).
+			head.insertBefore( script, head.firstChild );
+			head.removeChild( script );
+		}
 	},
 
 	nodeName: function( elem, name ) {
 		return elem.nodeName && elem.nodeName.toUpperCase() == name.toUpperCase();
 	},
 
-	/**
-	 * A generic iterator function, which can be used to seamlessly
-	 * iterate over both objects and arrays. This function is not the same
-	 * as $().each() - which is used to iterate, exclusively, over a jQuery
-	 * object. This function can be used to iterate over anything.
-	 *
-	 * The callback has two arguments:the key (objects) or index (arrays) as first
-	 * the first, and the value as the second.
-	 *
-	 * @example $.each( [0,1,2], function(i, n){
-	 *   alert( "Item #" + i + ": " + n );
-	 * });
-	 * @desc This is an example of iterating over the items in an array,
-	 * accessing both the current item and its index.
-	 *
-	 * @example $.each( { name: "John", lang: "JS" }, function(i, n){
-	 *   alert( "Name: " + i + ", Value: " + n );
-	 * });
-	 *
-	 * @desc This is an example of iterating over the properties in an
-	 * Object, accessing both the current item and its key.
-	 *
-	 * @name $.each
-	 * @param Object obj The object, or array, to iterate over.
-	 * @param Function fn The function that will be executed on every object.
-	 * @type Object
-	 * @cat JavaScript
-	 */
+	cache: {},
+
+	data: function( elem, name, data ) {
+		elem = elem == window ?
+			windowData :
+			elem;
+
+		var id = elem[ expando ];
+
+		// Compute a unique ID for the element
+		if ( !id )
+			id = elem[ expando ] = ++uuid;
+
+		// Only generate the data cache if we're
+		// trying to access or manipulate it
+		if ( name && !jQuery.cache[ id ] )
+			jQuery.cache[ id ] = {};
+
+		// Prevent overriding the named cache with undefined values
+		if ( data !== undefined )
+			jQuery.cache[ id ][ name ] = data;
+
+		// Return the named cache data, or the ID for the element
+		return name ?
+			jQuery.cache[ id ][ name ] :
+			id;
+	},
+
+	removeData: function( elem, name ) {
+		elem = elem == window ?
+			windowData :
+			elem;
+
+		var id = elem[ expando ];
+
+		// If we want to remove a specific section of the element's data
+		if ( name ) {
+			if ( jQuery.cache[ id ] ) {
+				// Remove the section of cache data
+				delete jQuery.cache[ id ][ name ];
+
+				// If we've removed all the data, remove the element's cache
+				name = "";
+
+				for ( name in jQuery.cache[ id ] )
+					break;
+
+				if ( !name )
+					jQuery.removeData( elem );
+			}
+
+		// Otherwise, we want to remove all of the element's data
+		} else {
+			// Clean up the element expando
+			try {
+				delete elem[ expando ];
+			} catch(e){
+				// IE has trouble directly removing the expando
+				// but it's ok with using removeAttribute
+				if ( elem.removeAttribute )
+					elem.removeAttribute( expando );
+			}
+
+			// Completely remove the data cache
+			delete jQuery.cache[ id ];
+		}
+	},
+
 	// args is for internal usage only
-	each: function( obj, fn, args ) {
-		if ( obj.length == undefined )
-			for ( var i in obj )
-				fn.apply( obj[i], args || [i, obj[i]] );
-		else
-			for ( var i = 0, ol = obj.length; i < ol; i++ )
-				if ( fn.apply( obj[i], args || [i, obj[i]] ) === false ) break;
-		return obj;
+	each: function( object, callback, args ) {
+		var name, i = 0, length = object.length;
+
+		if ( args ) {
+			if ( length == undefined ) {
+				for ( name in object )
+					if ( callback.apply( object[ name ], args ) === false )
+						break;
+			} else
+				for ( ; i < length; )
+					if ( callback.apply( object[ i++ ], args ) === false )
+						break;
+
+		// A special, fast, case for the most common use of each
+		} else {
+			if ( length == undefined ) {
+				for ( name in object )
+					if ( callback.call( object[ name ], name, object[ name ] ) === false )
+						break;
+			} else
+				for ( var value = object[0];
+					i < length && callback.call( value, i, value ) !== false; value = object[++i] ){}
+		}
+
+		return object;
 	},
-	
-	prop: function(elem, value, type, index, prop){
-			// Handle executable functions
-			if ( jQuery.isFunction( value ) )
-				value = value.call( elem, [index] );
-				
-			// exclude the following css properties to add px
-			var exclude = /z-?index|font-?weight|opacity|zoom|line-?height/i;
 
-			// Handle passing in a number to a CSS property
-			return value && value.constructor == Number && type == "curCSS" && !exclude.test(prop) ?
-				value + "px" :
-				value;
+	prop: function( elem, value, type, i, name ) {
+		// Handle executable functions
+		if ( jQuery.isFunction( value ) )
+			value = value.call( elem, i );
+
+		// Handle passing in a number to a CSS property
+		return value && value.constructor == Number && type == "curCSS" && !exclude.test( name ) ?
+			value + "px" :
+			value;
 	},
 
 	className: {
 		// internal only, use addClass("class")
-		add: function( elem, c ){
-			jQuery.each( c.split(/\s+/), function(i, cur){
-				if ( !jQuery.className.has( elem.className, cur ) )
-					elem.className += ( elem.className ? " " : "" ) + cur;
+		add: function( elem, classNames ) {
+			jQuery.each((classNames || "").split(/\s+/), function(i, className){
+				if ( elem.nodeType == 1 && !jQuery.className.has( elem.className, className ) )
+					elem.className += (elem.className ? " " : "") + className;
 			});
 		},
 
 		// internal only, use removeClass("class")
-		remove: function( elem, c ){
-			elem.className = c != undefined ?
-				jQuery.grep( elem.className.split(/\s+/), function(cur){
-					return !jQuery.className.has( c, cur );	
-				}).join(" ") : "";
+		remove: function( elem, classNames ) {
+			if (elem.nodeType == 1)
+				elem.className = classNames != undefined ?
+					jQuery.grep(elem.className.split(/\s+/), function(className){
+						return !jQuery.className.has( classNames, className );
+					}).join(" ") :
+					"";
 		},
 
-		// internal only, use is(".class")
-		has: function( t, c ) {
-			return jQuery.inArray( c, (t.className || t).toString().split(/\s+/) ) > -1;
+		// internal only, use hasClass("class")
+		has: function( elem, className ) {
+			return jQuery.inArray( className, (elem.className || elem).toString().split(/\s+/) ) > -1;
 		}
 	},
 
-	/**
-	 * Swap in/out style options.
-	 * @private
-	 */
-	swap: function(e,o,f) {
-		for ( var i in o ) {
-			e.style["old"+i] = e.style[i];
-			e.style[i] = o[i];
+	// A method for quickly swapping in/out CSS properties to get correct calculations
+	swap: function( elem, options, callback ) {
+		var old = {};
+		// Remember the old values, and insert the new ones
+		for ( var name in options ) {
+			old[ name ] = elem.style[ name ];
+			elem.style[ name ] = options[ name ];
 		}
-		f.apply( e, [] );
-		for ( var i in o )
-			e.style[i] = e.style["old"+i];
+
+		callback.call( elem );
+
+		// Revert the old values
+		for ( var name in options )
+			elem.style[ name ] = old[ name ];
 	},
 
-	css: function(e,p) {
-		if ( p == "height" || p == "width" ) {
-			var old = {}, oHeight, oWidth, d = ["Top","Bottom","Right","Left"];
+	css: function( elem, name, force ) {
+		if ( name == "width" || name == "height" ) {
+			var val, props = { position: "absolute", visibility: "hidden", display:"block" }, which = name == "width" ? [ "Left", "Right" ] : [ "Top", "Bottom" ];
 
-			jQuery.each( d, function(){
-				old["padding" + this] = 0;
-				old["border" + this + "Width"] = 0;
+			function getWH() {
+				val = name == "width" ? elem.offsetWidth : elem.offsetHeight;
+				var padding = 0, border = 0;
+				jQuery.each( which, function() {
+					padding += parseFloat(jQuery.curCSS( elem, "padding" + this, true)) || 0;
+					border += parseFloat(jQuery.curCSS( elem, "border" + this + "Width", true)) || 0;
+				});
+				val -= Math.round(padding + border);
+			}
+
+			if ( jQuery(elem).is(":visible") )
+				getWH();
+			else
+				jQuery.swap( elem, props, getWH );
+
+			return Math.max(0, val);
+		}
+
+		return jQuery.curCSS( elem, name, force );
+	},
+
+	curCSS: function( elem, name, force ) {
+		var ret, style = elem.style;
+
+		// A helper method for determining if an element's values are broken
+		function color( elem ) {
+			if ( !jQuery.browser.safari )
+				return false;
+
+			// defaultView is cached
+			var ret = defaultView.getComputedStyle( elem, null );
+			return !ret || ret.getPropertyValue("color") == "";
+		}
+
+		// We need to handle opacity special in IE
+		if ( name == "opacity" && jQuery.browser.msie ) {
+			ret = jQuery.attr( style, "opacity" );
+
+			return ret == "" ?
+				"1" :
+				ret;
+		}
+		// Opera sometimes will give the wrong display answer, this fixes it, see #2037
+		if ( jQuery.browser.opera && name == "display" ) {
+			var save = style.outline;
+			style.outline = "0 solid black";
+			style.outline = save;
+		}
+
+		// Make sure we're using the right name for getting the float value
+		if ( name.match( /float/i ) )
+			name = styleFloat;
+
+		if ( !force && style && style[ name ] )
+			ret = style[ name ];
+
+		else if ( defaultView.getComputedStyle ) {
+
+			// Only "float" is needed here
+			if ( name.match( /float/i ) )
+				name = "float";
+
+			name = name.replace( /([A-Z])/g, "-$1" ).toLowerCase();
+
+			var computedStyle = defaultView.getComputedStyle( elem, null );
+
+			if ( computedStyle && !color( elem ) )
+				ret = computedStyle.getPropertyValue( name );
+
+			// If the element isn't reporting its values properly in Safari
+			// then some display: none elements are involved
+			else {
+				var swap = [], stack = [], a = elem, i = 0;
+
+				// Locate all of the parent display: none elements
+				for ( ; a && color(a); a = a.parentNode )
+					stack.unshift(a);
+
+				// Go through and make them visible, but in reverse
+				// (It would be better if we knew the exact display type that they had)
+				for ( ; i < stack.length; i++ )
+					if ( color( stack[ i ] ) ) {
+						swap[ i ] = stack[ i ].style.display;
+						stack[ i ].style.display = "block";
+					}
+
+				// Since we flip the display style, we have to handle that
+				// one special, otherwise get the value
+				ret = name == "display" && swap[ stack.length - 1 ] != null ?
+					"none" :
+					( computedStyle && computedStyle.getPropertyValue( name ) ) || "";
+
+				// Finally, revert the display styles back
+				for ( i = 0; i < swap.length; i++ )
+					if ( swap[ i ] != null )
+						stack[ i ].style.display = swap[ i ];
+			}
+
+			// We should always get a number back from opacity
+			if ( name == "opacity" && ret == "" )
+				ret = "1";
+
+		} else if ( elem.currentStyle ) {
+			var camelCase = name.replace(/\-(\w)/g, function(all, letter){
+				return letter.toUpperCase();
 			});
 
-			jQuery.swap( e, old, function() {
-				if ( jQuery(e).is(':visible') ) {
-					oHeight = e.offsetHeight;
-					oWidth = e.offsetWidth;
-				} else {
-					e = jQuery(e.cloneNode(true))
-						.find(":radio").removeAttr("checked").end()
-						.css({
-							visibility: "hidden", position: "absolute", display: "block", right: "0", left: "0"
-						}).appendTo(e.parentNode)[0];
+			ret = elem.currentStyle[ name ] || elem.currentStyle[ camelCase ];
 
-					var parPos = jQuery.css(e.parentNode,"position") || "static";
-					if ( parPos == "static" )
-						e.parentNode.style.position = "relative";
+			// From the awesome hack by Dean Edwards
+			// http://erik.eae.net/archives/2007/07/27/18.54.15/#comment-102291
 
-					oHeight = e.clientHeight;
-					oWidth = e.clientWidth;
+			// If we're not dealing with a regular pixel number
+			// but a number that has a weird ending, we need to convert it to pixels
+			if ( !/^\d+(px)?$/i.test( ret ) && /^\d/.test( ret ) ) {
+				// Remember the original values
+				var left = style.left, rsLeft = elem.runtimeStyle.left;
 
-					if ( parPos == "static" )
-						e.parentNode.style.position = "static";
+				// Put in the new values to get a computed value out
+				elem.runtimeStyle.left = elem.currentStyle.left;
+				style.left = ret || 0;
+				ret = style.pixelLeft + "px";
 
-					e.parentNode.removeChild(e);
-				}
-			});
-
-			return p == "height" ? oHeight : oWidth;
-		}
-
-		return jQuery.curCSS( e, p );
-	},
-
-	curCSS: function(elem, prop, force) {
-		var ret;
-
-		if (prop == "opacity" && jQuery.browser.msie) {
-			ret = jQuery.attr(elem.style, "opacity");
-			return ret == "" ? "1" : ret;
-		}
-		
-		if (prop.match(/float/i))
-			prop = jQuery.browser.msie ? "styleFloat" : "cssFloat";
-
-		if (!force && elem.style[prop])
-			ret = elem.style[prop];
-
-		else if (document.defaultView && document.defaultView.getComputedStyle) {
-
-			if (prop.match(/float/i))
-				prop = "float";
-
-			prop = prop.replace(/([A-Z])/g,"-$1").toLowerCase();
-			var cur = document.defaultView.getComputedStyle(elem, null);
-
-			if ( cur )
-				ret = cur.getPropertyValue(prop);
-			else if ( prop == "display" )
-				ret = "none";
-			else
-				jQuery.swap(elem, { display: "block" }, function() {
-				    var c = document.defaultView.getComputedStyle(this, "");
-				    ret = c && c.getPropertyValue(prop) || "";
-				});
-
-		} else if (elem.currentStyle) {
-			var newProp = prop.replace(/\-(\w)/g,function(m,c){return c.toUpperCase();});
-			ret = elem.currentStyle[prop] || elem.currentStyle[newProp];
+				// Revert the changed values
+				style.left = left;
+				elem.runtimeStyle.left = rsLeft;
+			}
 		}
 
 		return ret;
 	},
-	
-	clean: function(a, doc) {
-		var r = [];
-		doc = doc || document;
 
-		jQuery.each( a, function(i,arg){
-			if ( !arg ) return;
+	clean: function( elems, context ) {
+		var ret = [];
+		context = context || document;
+		// !context.createElement fails in IE with an error but returns typeof 'object'
+		if (typeof context.createElement == 'undefined')
+			context = context.ownerDocument || context[0] && context[0].ownerDocument || document;
 
-			if ( arg.constructor == Number )
-				arg = arg.toString();
-			
+		jQuery.each(elems, function(i, elem){
+			if ( !elem )
+				return;
+
+			if ( elem.constructor == Number )
+				elem += '';
+
 			// Convert html string into DOM nodes
-			if ( typeof arg == "string" ) {
+			if ( typeof elem == "string" ) {
+				// Fix "XHTML"-style tags in all browsers
+				elem = elem.replace(/(<(\w+)[^>]*?)\/>/g, function(all, front, tag){
+					return tag.match(/^(abbr|br|col|img|input|link|meta|param|hr|area|embed)$/i) ?
+						all :
+						front + "></" + tag + ">";
+				});
+
 				// Trim whitespace, otherwise indexOf won't work as expected
-				var s = jQuery.trim(arg).toLowerCase(), div = doc.createElement("div"), tb = [];
+				var tags = jQuery.trim( elem ).toLowerCase(), div = context.createElement("div");
 
 				var wrap =
 					// option or optgroup
-					!s.indexOf("<opt") &&
-					[1, "<select>", "</select>"] ||
-					
-					!s.indexOf("<leg") &&
-					[1, "<fieldset>", "</fieldset>"] ||
-					
-					(!s.indexOf("<thead") || !s.indexOf("<tbody") || !s.indexOf("<tfoot") || !s.indexOf("<colg")) &&
-					[1, "<table>", "</table>"] ||
-					
-					!s.indexOf("<tr") &&
-					[2, "<table><tbody>", "</tbody></table>"] ||
-					
+					!tags.indexOf("<opt") &&
+					[ 1, "<select multiple='multiple'>", "</select>" ] ||
+
+					!tags.indexOf("<leg") &&
+					[ 1, "<fieldset>", "</fieldset>" ] ||
+
+					tags.match(/^<(thead|tbody|tfoot|colg|cap)/) &&
+					[ 1, "<table>", "</table>" ] ||
+
+					!tags.indexOf("<tr") &&
+					[ 2, "<table><tbody>", "</tbody></table>" ] ||
+
 				 	// <thead> matched above
-					(!s.indexOf("<td") || !s.indexOf("<th")) &&
-					[3, "<table><tbody><tr>", "</tr></tbody></table>"] ||
-					
-					!s.indexOf("<col") &&
-					[2, "<table><colgroup>", "</colgroup></table>"] ||
-					
-					[0,"",""];
+					(!tags.indexOf("<td") || !tags.indexOf("<th")) &&
+					[ 3, "<table><tbody><tr>", "</tr></tbody></table>" ] ||
+
+					!tags.indexOf("<col") &&
+					[ 2, "<table><tbody></tbody><colgroup>", "</colgroup></table>" ] ||
+
+					// IE can't serialize <link> and <script> tags normally
+					jQuery.browser.msie &&
+					[ 1, "div<div>", "</div>" ] ||
+
+					[ 0, "", "" ];
 
 				// Go to html and back, then peel off extra wrappers
-				div.innerHTML = wrap[1] + arg + wrap[2];
-				
+				div.innerHTML = wrap[1] + elem + wrap[2];
+
 				// Move to the right depth
 				while ( wrap[0]-- )
-					div = div.firstChild;
-				
+					div = div.lastChild;
+
 				// Remove IE's autoinserted <tbody> from table fragments
 				if ( jQuery.browser.msie ) {
-					
+
 					// String was a <table>, *may* have spurious <tbody>
-					if ( !s.indexOf("<table") && s.indexOf("<tbody") < 0 ) 
-						tb = div.firstChild && div.firstChild.childNodes;
-						
-					// String was a bare <thead> or <tfoot>
-					else if ( wrap[1] == "<table>" && s.indexOf("<tbody") < 0 )
-						tb = div.childNodes;
+					var tbody = !tags.indexOf("<table") && tags.indexOf("<tbody") < 0 ?
+						div.firstChild && div.firstChild.childNodes :
 
-					for ( var n = tb.length-1; n >= 0 ; --n )
-						if ( jQuery.nodeName(tb[n], "tbody") && !tb[n].childNodes.length )
-							tb[n].parentNode.removeChild(tb[n]);
-					
+						// String was a bare <thead> or <tfoot>
+						wrap[1] == "<table>" && tags.indexOf("<tbody") < 0 ?
+							div.childNodes :
+							[];
+
+					for ( var j = tbody.length - 1; j >= 0 ; --j )
+						if ( jQuery.nodeName( tbody[ j ], "tbody" ) && !tbody[ j ].childNodes.length )
+							tbody[ j ].parentNode.removeChild( tbody[ j ] );
+
+					// IE completely kills leading whitespace when innerHTML is used
+					if ( /^\s/.test( elem ) )
+						div.insertBefore( context.createTextNode( elem.match(/^\s*/)[0] ), div.firstChild );
+
 				}
-				
-				arg = jQuery.makeArray( div.childNodes );
+
+				elem = jQuery.makeArray( div.childNodes );
 			}
 
-			if ( 0 === arg.length && !jQuery(arg).is("form, select") )
+			if ( elem.length === 0 && (!jQuery.nodeName( elem, "form" ) && !jQuery.nodeName( elem, "select" )) )
 				return;
 
-			if ( arg[0] == undefined || jQuery.nodeName(arg, "form") || arg.options )
-				r.push( arg );
+			if ( elem[0] == undefined || jQuery.nodeName( elem, "form" ) || elem.options )
+				ret.push( elem );
+
 			else
-				r = jQuery.merge( r, arg );
+				ret = jQuery.merge( ret, elem );
 
 		});
 
-		return r;
+		return ret;
 	},
-	
-	attr: function(elem, name, value){
-		var fix = jQuery.isXMLDoc(elem) ? {} : {
-			"for": "htmlFor",
-			"class": "className",
-			"float": jQuery.browser.msie ? "styleFloat" : "cssFloat",
-			cssFloat: jQuery.browser.msie ? "styleFloat" : "cssFloat",
-			styleFloat: jQuery.browser.msie ? "styleFloat" : "cssFloat",
-			innerHTML: "innerHTML",
-			className: "className",
-			value: "value",
-			disabled: "disabled",
-			checked: "checked",
-			readonly: "readOnly",
-			selected: "selected",
-			maxlength: "maxLength"
-		};
-		
-		// IE actually uses filters for opacity ... elem is actually elem.style
-		if ( name == "opacity" && jQuery.browser.msie ) {
-			if ( value != undefined ) {
+
+	attr: function( elem, name, value ) {
+		// don't set attributes on text and comment nodes
+		if (!elem || elem.nodeType == 3 || elem.nodeType == 8)
+			return undefined;
+
+		var notxml = !jQuery.isXMLDoc( elem ),
+			// Whether we are setting (or getting)
+			set = value !== undefined,
+			msie = jQuery.browser.msie;
+
+		// Try to normalize/fix the name
+		name = notxml && jQuery.props[ name ] || name;
+
+		// Only do all the following if this is a node (faster for style)
+		// IE elem.getAttribute passes even for style
+		if ( elem.tagName ) {
+
+			// These attributes require special treatment
+			var special = /href|src|style/.test( name );
+
+			// Safari mis-reports the default selected property of a hidden option
+			// Accessing the parent's selectedIndex property fixes it
+			if ( name == "selected" && jQuery.browser.safari )
+				elem.parentNode.selectedIndex;
+
+			// If applicable, access the attribute via the DOM 0 way
+			if ( name in elem && notxml && !special ) {
+				if ( set ){
+					// We can't allow the type property to be changed (since it causes problems in IE)
+					if ( name == "type" && jQuery.nodeName( elem, "input" ) && elem.parentNode )
+						throw "type property can't be changed";
+
+					elem[ name ] = value;
+				}
+
+				// browsers index elements by id/name on forms, give priority to attributes.
+				if( jQuery.nodeName( elem, "form" ) && elem.getAttributeNode(name) )
+					return elem.getAttributeNode( name ).nodeValue;
+
+				return elem[ name ];
+			}
+
+			if ( msie && notxml &&  name == "style" )
+				return jQuery.attr( elem.style, "cssText", value );
+
+			if ( set )
+				// convert the value to a string (all browsers do this but IE) see #1070
+				elem.setAttribute( name, "" + value );
+
+			var attr = msie && notxml && special
+					// Some attributes require a special call on IE
+					? elem.getAttribute( name, 2 )
+					: elem.getAttribute( name );
+
+			// Non-existent attributes return null, we normalize to undefined
+			return attr === null ? undefined : attr;
+		}
+
+		// elem is actually elem.style ... set the style
+
+		// IE uses filters for opacity
+		if ( msie && name == "opacity" ) {
+			if ( set ) {
 				// IE has trouble with opacity if it does not have layout
 				// Force it by setting the zoom level
-				elem.zoom = 1; 
+				elem.zoom = 1;
 
 				// Set the alpha filter to set the opacity
-				elem.filter = (elem.filter || "").replace(/alpha\([^)]*\)/,"") +
-					(parseFloat(value).toString() == "NaN" ? "" : "alpha(opacity=" + value * 100 + ")");
+				elem.filter = (elem.filter || "").replace( /alpha\([^)]*\)/, "" ) +
+					(parseInt( value ) + '' == "NaN" ? "" : "alpha(opacity=" + value * 100 + ")");
 			}
 
-			return elem.filter ? 
-				(parseFloat( elem.filter.match(/opacity=([^)]*)/)[1] ) / 100).toString() : "";
+			return elem.filter && elem.filter.indexOf("opacity=") >= 0 ?
+				(parseFloat( elem.filter.match(/opacity=([^)]*)/)[1] ) / 100) + '':
+				"";
 		}
-		
-		// Certain attributes only work when accessed via the old DOM 0 way
-		if ( fix[name] ) {
-			if ( value != undefined ) elem[fix[name]] = value;
-			return elem[fix[name]];
 
-		} else if ( value == undefined && jQuery.browser.msie && jQuery.nodeName(elem, "form") && (name == "action" || name == "method") )
-			return elem.getAttributeNode(name).nodeValue;
+		name = name.replace(/-([a-z])/ig, function(all, letter){
+			return letter.toUpperCase();
+		});
 
-		// IE elem.getAttribute passes even for style
-		else if ( elem.tagName ) {
-			if ( value != undefined ) elem.setAttribute( name, value );
-			if ( jQuery.browser.msie && /href|src/.test(name) && !jQuery.isXMLDoc(elem) ) 
-				return elem.getAttribute( name, 2 );
-			return elem.getAttribute( name );
+		if ( set )
+			elem[ name ] = value;
 
-		// elem is actually elem.style ... set the style
-		} else {
-			name = name.replace(/-([a-z])/ig,function(z,b){return b.toUpperCase();});
-			if ( value != undefined ) elem[name] = value;
-			return elem[name];
-		}
-	},
-	
-	/**
-	 * Remove the whitespace from the beginning and end of a string.
-	 *
-	 * @example $.trim("  hello, how are you?  ");
-	 * @result "hello, how are you?"
-	 *
-	 * @name $.trim
-	 * @type String
-	 * @param String str The string to trim.
-	 * @cat JavaScript
-	 */
-	trim: function(t){
-		return t.replace(/^\s+|\s+$/g, "");
+		return elem[ name ];
 	},
 
-	makeArray: function( a ) {
-		var r = [];
-
-		// Need to use typeof to fight Safari childNodes crashes
-		if ( typeof a != "array" )
-			for ( var i = 0, al = a.length; i < al; i++ )
-				r.push( a[i] );
-		else
-			r = a.slice( 0 );
-
-		return r;
+	trim: function( text ) {
+		return (text || "").replace( /^\s+|\s+$/g, "" );
 	},
 
-	inArray: function( b, a ) {
-		for ( var i = 0, al = a.length; i < al; i++ )
-			if ( a[i] == b )
+	makeArray: function( array ) {
+		var ret = [];
+
+		if( array != null ){
+			var i = array.length;
+			//the window, strings and functions also have 'length'
+			if( i == null || array.split || array.setInterval || array.call )
+				ret[0] = array;
+			else
+				while( i )
+					ret[--i] = array[i];
+		}
+
+		return ret;
+	},
+
+	inArray: function( elem, array ) {
+		for ( var i = 0, length = array.length; i < length; i++ )
+		// Use === because on IE, window == document
+			if ( array[ i ] === elem )
 				return i;
+
 		return -1;
 	},
 
-	/**
-	 * Merge two arrays together by concatenating them.
-	 *
-	 * @example $.merge( [0,1,2], [2,3,4] )
-	 * @result [0,1,2,2,3,4]
-	 * @desc Merges two arrays.
-	 *
-	 * @name $.merge
-	 * @type Array
-	 * @param Array first The first array to merge, the elements of second are added.
-	 * @param Array second The second array to append to the first, unaltered.
-	 * @cat JavaScript
-	 */
-	merge: function(first, second) {
+	merge: function( first, second ) {
 		// We have to loop this way because IE & Opera overwrite the length
 		// expando of getElementsByTagName
-		for ( var i = 0; second[i]; i++ )
-			first.push(second[i]);
+		var i = 0, elem, pos = first.length;
+		// Also, we need to make sure that the correct elements are being returned
+		// (IE returns comment nodes in a '*' query)
+		if ( jQuery.browser.msie ) {
+			while ( elem = second[ i++ ] )
+				if ( elem.nodeType != 8 )
+					first[ pos++ ] = elem;
+
+		} else
+			while ( elem = second[ i++ ] )
+				first[ pos++ ] = elem;
+
 		return first;
 	},
 
-	/**
-	 * Reduce an array (of jQuery objects only) to its unique elements.
-	 *
-	 * @example $.unique( [x1, x2, x3, x2, x3] )
-	 * @result [x1, x2, x3]
-	 * @desc Reduces the arrays of jQuery objects to unique elements by removing the duplicates of x2 and x3
-	 *
-	 * @name $.unique
-	 * @type Array
-	 * @param Array array The array to reduce to its unique jQuery objects.
-	 * @cat JavaScript
-	 */
-	unique: function(first) {
-		var r = [], num = jQuery.mergeNum++;
+	unique: function( array ) {
+		var ret = [], done = {};
 
-		for ( var i = 0, fl = first.length; i < fl; i++ )
-			if ( num != first[i].mergeNum ) {
-				first[i].mergeNum = num;
-				r.push(first[i]);
+		try {
+
+			for ( var i = 0, length = array.length; i < length; i++ ) {
+				var id = jQuery.data( array[ i ] );
+
+				if ( !done[ id ] ) {
+					done[ id ] = true;
+					ret.push( array[ i ] );
+				}
 			}
 
-		return r;
+		} catch( e ) {
+			ret = array;
+		}
+
+		return ret;
 	},
 
-	mergeNum: 0,
-
-	/**
-	 * Filter items out of an array, by using a filter function.
-	 *
-	 * The specified function will be passed two arguments: The
-	 * current array item and the index of the item in the array. The
-	 * function must return 'true' to keep the item in the array, 
-	 * false to remove it.
-	 *
-	 * @example $.grep( [0,1,2], function(i){
-	 *   return i > 0;
-	 * });
-	 * @result [1, 2]
-	 *
-	 * @name $.grep
-	 * @type Array
-	 * @param Array array The Array to find items in.
-	 * @param Function fn The function to process each item against.
-	 * @param Boolean inv Invert the selection - select the opposite of the function.
-	 * @cat JavaScript
-	 */
-	grep: function(elems, fn, inv) {
-		// If a string is passed in for the function, make a function
-		// for it (a handy shortcut)
-		if ( typeof fn == "string" )
-			fn = new Function("a","i","return " + fn);
-
-		var result = [];
+	grep: function( elems, callback, inv ) {
+		var ret = [];
 
 		// Go through the array, only saving the items
 		// that pass the validator function
-		for ( var i = 0, el = elems.length; i < el; i++ )
-			if ( !inv && fn(elems[i],i) || inv && !fn(elems[i],i) )
-				result.push( elems[i] );
+		for ( var i = 0, length = elems.length; i < length; i++ )
+			if ( !inv != !callback( elems[ i ], i ) )
+				ret.push( elems[ i ] );
 
-		return result;
+		return ret;
 	},
 
-	/**
-	 * Translate all items in an array to another array of items.
-	 *
-	 * The translation function that is provided to this method is 
-	 * called for each item in the array and is passed one argument: 
-	 * The item to be translated.
-	 *
-	 * The function can then return the translated value, 'null'
-	 * (to remove the item), or  an array of values - which will
-	 * be flattened into the full array.
-	 *
-	 * @example $.map( [0,1,2], function(i){
-	 *   return i + 4;
-	 * });
-	 * @result [4, 5, 6]
-	 * @desc Maps the original array to a new one and adds 4 to each value.
-	 *
-	 * @example $.map( [0,1,2], function(i){
-	 *   return i > 0 ? i + 1 : null;
-	 * });
-	 * @result [2, 3]
-	 * @desc Maps the original array to a new one and adds 1 to each
-	 * value if it is bigger then zero, otherwise it's removed-
-	 * 
-	 * @example $.map( [0,1,2], function(i){
-	 *   return [ i, i + 1 ];
-	 * });
-	 * @result [0, 1, 1, 2, 2, 3]
-	 * @desc Maps the original array to a new one, each element is added
-	 * with it's original value and the value plus one.
-	 *
-	 * @name $.map
-	 * @type Array
-	 * @param Array array The Array to translate.
-	 * @param Function fn The function to process each item against.
-	 * @cat JavaScript
-	 */
-	map: function(elems, fn) {
-		// If a string is passed in for the function, make a function
-		// for it (a handy shortcut)
-		if ( typeof fn == "string" )
-			fn = new Function("a","return " + fn);
-
-		var result = [];
+	map: function( elems, callback ) {
+		var ret = [];
 
 		// Go through the array, translating each of the items to their
 		// new value (or values).
-		for ( var i = 0, el = elems.length; i < el; i++ ) {
-			var val = fn(elems[i],i);
+		for ( var i = 0, length = elems.length; i < length; i++ ) {
+			var value = callback( elems[ i ], i );
 
-			if ( val !== null && val != undefined ) {
-				if ( val.constructor != Array ) val = [val];
-				result = result.concat( val );
-			}
+			if ( value != null )
+				ret[ ret.length ] = value;
 		}
 
-		return result;
+		return ret.concat.apply( [], ret );
 	}
 });
 
-/**
- * Contains flags for the useragent, read from navigator.userAgent.
- * Available flags are: safari, opera, msie, mozilla
- *
- * This property is available before the DOM is ready, therefore you can
- * use it to add ready events only for certain browsers.
- *
- * There are situations where object detections is not reliable enough, in that
- * cases it makes sense to use browser detection. Simply try to avoid both!
- *
- * A combination of browser and object detection yields quite reliable results.
- *
- * @example $.browser.msie
- * @desc Returns true if the current useragent is some version of microsoft's internet explorer
- *
- * @example if($.browser.safari) { $( function() { alert("this is safari!"); } ); }
- * @desc Alerts "this is safari!" only for safari browsers
- *
- * @property
- * @name $.browser
- * @type Boolean
- * @cat JavaScript
- */
- 
-/*
- * Whether the W3C compliant box model is being used.
- *
- * @property
- * @name $.boxModel
- * @type Boolean
- * @cat JavaScript
- */
-new function() {
-	var b = navigator.userAgent.toLowerCase();
+var userAgent = navigator.userAgent.toLowerCase();
 
-	// Figure out what browser is being used
-	jQuery.browser = {
-		version: b.match(/.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/)[1],
-		safari: /webkit/.test(b),
-		opera: /opera/.test(b),
-		msie: /msie/.test(b) && !/opera/.test(b),
-		mozilla: /mozilla/.test(b) && !/(compatible|webkit)/.test(b)
-	};
-
-	// Check to see if the W3C box model is being used
-	jQuery.boxModel = !jQuery.browser.msie || document.compatMode == "CSS1Compat";
+// Figure out what browser is being used
+jQuery.browser = {
+	version: (userAgent.match( /.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/ ) || [])[1],
+	safari: /webkit/.test( userAgent ),
+	opera: /opera/.test( userAgent ),
+	msie: /msie/.test( userAgent ) && !/opera/.test( userAgent ),
+	mozilla: /mozilla/.test( userAgent ) && !/(compatible|webkit)/.test( userAgent )
 };
 
-/**
- * Get a set of elements containing the unique parents of the matched
- * set of elements.
- *
- * You may use an optional expression to filter the set of parent elements that will match.
- *
- * @example $("p").parent()
- * @before <div><p>Hello</p><p>Hello</p></div>
- * @result [ <div><p>Hello</p><p>Hello</p></div> ]
- * @desc Find the parent element of each paragraph.
- *
- * @example $("p").parent(".selected")
- * @before <div><p>Hello</p></div><div class="selected"><p>Hello Again</p></div>
- * @result [ <div class="selected"><p>Hello Again</p></div> ]
- * @desc Find the parent element of each paragraph with a class "selected".
- *
- * @name parent
- * @type jQuery
- * @param String expr (optional) An expression to filter the parents with
- * @cat DOM/Traversing
- */
+var styleFloat = jQuery.browser.msie ?
+	"styleFloat" :
+	"cssFloat";
 
-/**
- * Get a set of elements containing the unique ancestors of the matched
- * set of elements (except for the root element).
- *
- * The matched elements can be filtered with an optional expression.
- *
- * @example $("span").parents()
- * @before <html><body><div><p><span>Hello</span></p><span>Hello Again</span></div></body></html>
- * @result [ <body>...</body>, <div>...</div>, <p><span>Hello</span></p> ]
- * @desc Find all parent elements of each span.
- *
- * @example $("span").parents("p")
- * @before <html><body><div><p><span>Hello</span></p><span>Hello Again</span></div></body></html>
- * @result [ <p><span>Hello</span></p> ]
- * @desc Find all parent elements of each span that is a paragraph.
- *
- * @name parents
- * @type jQuery
- * @param String expr (optional) An expression to filter the ancestors with
- * @cat DOM/Traversing
- */
+jQuery.extend({
+	// Check to see if the W3C box model is being used
+	boxModel: !jQuery.browser.msie || document.compatMode == "CSS1Compat",
 
-/**
- * Get a set of elements containing the unique next siblings of each of the
- * matched set of elements.
- *
- * It only returns the very next sibling for each element, not all
- * next siblings.
- *
- * You may provide an optional expression to filter the match.
- *
- * @example $("p").next()
- * @before <p>Hello</p><p>Hello Again</p><div><span>And Again</span></div>
- * @result [ <p>Hello Again</p>, <div><span>And Again</span></div> ]
- * @desc Find the very next sibling of each paragraph.
- *
- * @example $("p").next(".selected")
- * @before <p>Hello</p><p class="selected">Hello Again</p><div><span>And Again</span></div>
- * @result [ <p class="selected">Hello Again</p> ]
- * @desc Find the very next sibling of each paragraph that has a class "selected".
- *
- * @name next
- * @type jQuery
- * @param String expr (optional) An expression to filter the next Elements with
- * @cat DOM/Traversing
- */
+	props: {
+		"for": "htmlFor",
+		"class": "className",
+		"float": styleFloat,
+		cssFloat: styleFloat,
+		styleFloat: styleFloat,
+		readonly: "readOnly",
+		maxlength: "maxLength",
+		cellspacing: "cellSpacing"
+	}
+});
 
-/**
- * Get a set of elements containing the unique previous siblings of each of the
- * matched set of elements.
- *
- * Use an optional expression to filter the matched set.
- *
- * 	Only the immediately previous sibling is returned, not all previous siblings.
- *
- * @example $("p").prev()
- * @before <p>Hello</p><div><span>Hello Again</span></div><p>And Again</p>
- * @result [ <div><span>Hello Again</span></div> ]
- * @desc Find the very previous sibling of each paragraph.
- *
- * @example $("p").prev(".selected")
- * @before <div><span>Hello</span></div><p class="selected">Hello Again</p><p>And Again</p>
- * @result [ <div><span>Hello</span></div> ]
- * @desc Find the very previous sibling of each paragraph that has a class "selected".
- *
- * @name prev
- * @type jQuery
- * @param String expr (optional) An expression to filter the previous Elements with
- * @cat DOM/Traversing
- */
+jQuery.each({
+	parent: function(elem){return elem.parentNode;},
+	parents: function(elem){return jQuery.dir(elem,"parentNode");},
+	next: function(elem){return jQuery.nth(elem,2,"nextSibling");},
+	prev: function(elem){return jQuery.nth(elem,2,"previousSibling");},
+	nextAll: function(elem){return jQuery.dir(elem,"nextSibling");},
+	prevAll: function(elem){return jQuery.dir(elem,"previousSibling");},
+	siblings: function(elem){return jQuery.sibling(elem.parentNode.firstChild,elem);},
+	children: function(elem){return jQuery.sibling(elem.firstChild);},
+	contents: function(elem){return jQuery.nodeName(elem,"iframe")?elem.contentDocument||elem.contentWindow.document:jQuery.makeArray(elem.childNodes);}
+}, function(name, fn){
+	jQuery.fn[ name ] = function( selector ) {
+		var ret = jQuery.map( this, fn );
 
-/**
- * Get a set of elements containing all of the unique siblings of each of the
- * matched set of elements.
- *
- * Can be filtered with an optional expressions.
- *
- * @example $("div").siblings()
- * @before <p>Hello</p><div><span>Hello Again</span></div><p>And Again</p>
- * @result [ <p>Hello</p>, <p>And Again</p> ]
- * @desc Find all siblings of each div.
- *
- * @example $("div").siblings(".selected")
- * @before <div><span>Hello</span></div><p class="selected">Hello Again</p><p>And Again</p>
- * @result [ <p class="selected">Hello Again</p> ]
- * @desc Find all siblings with a class "selected" of each div.
- *
- * @name siblings
- * @type jQuery
- * @param String expr (optional) An expression to filter the sibling Elements with
- * @cat DOM/Traversing
- */
+		if ( selector && typeof selector == "string" )
+			ret = jQuery.multiFilter( selector, ret );
 
-/**
- * Get a set of elements containing all of the unique children of each of the
- * matched set of elements.
- *
- * This set can be filtered with an optional expression that will cause
- * only elements matching the selector to be collected.
- *
- * @example $("div").children()
- * @before <p>Hello</p><div><span>Hello Again</span></div><p>And Again</p>
- * @result [ <span>Hello Again</span> ]
- * @desc Find all children of each div.
- *
- * @example $("div").children(".selected")
- * @before <div><span>Hello</span><p class="selected">Hello Again</p><p>And Again</p></div>
- * @result [ <p class="selected">Hello Again</p> ]
- * @desc Find all children with a class "selected" of each div.
- *
- * @name children
- * @type jQuery
- * @param String expr (optional) An expression to filter the child Elements with
- * @cat DOM/Traversing
- */
-jQuery.each({
-	parent: "a.parentNode",
-	parents: "jQuery.parents(a)",
-	next: "jQuery.nth(a,2,'nextSibling')",
-	prev: "jQuery.nth(a,2,'previousSibling')",
-	siblings: "jQuery.sibling(a.parentNode.firstChild,a)",
-	children: "jQuery.sibling(a.firstChild)"
-}, function(i,n){
-	jQuery.fn[ i ] = function(a) {
-		var ret = jQuery.map(this,n);
-		if ( a && typeof a == "string" )
-			ret = jQuery.multiFilter(a,ret);
-		return this.pushStack( ret );
+		return this.pushStack( jQuery.unique( ret ) );
 	};
 });
-
-/**
- * Append all of the matched elements to another, specified, set of elements.
- * This operation is, essentially, the reverse of doing a regular
- * $(A).append(B), in that instead of appending B to A, you're appending
- * A to B.
- *
- * @example $("p").appendTo("#foo");
- * @before <p>I would like to say: </p><div id="foo"></div>
- * @result <div id="foo"><p>I would like to say: </p></div>
- * @desc Appends all paragraphs to the element with the ID "foo"
- *
- * @name appendTo
- * @type jQuery
- * @param <Content> content Content to append to the selected element to.
- * @cat DOM/Manipulation
- * @see append(<Content>)
- */
-
-/**
- * Prepend all of the matched elements to another, specified, set of elements.
- * This operation is, essentially, the reverse of doing a regular
- * $(A).prepend(B), in that instead of prepending B to A, you're prepending
- * A to B.
- *
- * @example $("p").prependTo("#foo");
- * @before <p>I would like to say: </p><div id="foo"><b>Hello</b></div>
- * @result <div id="foo"><p>I would like to say: </p><b>Hello</b></div>
- * @desc Prepends all paragraphs to the element with the ID "foo"
- *
- * @name prependTo
- * @type jQuery
- * @param <Content> content Content to prepend to the selected element to.
- * @cat DOM/Manipulation
- * @see prepend(<Content>)
- */
-
-/**
- * Insert all of the matched elements before another, specified, set of elements.
- * This operation is, essentially, the reverse of doing a regular
- * $(A).before(B), in that instead of inserting B before A, you're inserting
- * A before B.
- *
- * @example $("p").insertBefore("#foo");
- * @before <div id="foo">Hello</div><p>I would like to say: </p>
- * @result <p>I would like to say: </p><div id="foo">Hello</div>
- * @desc Same as $("#foo").before("p")
- *
- * @name insertBefore
- * @type jQuery
- * @param <Content> content Content to insert the selected element before.
- * @cat DOM/Manipulation
- * @see before(<Content>)
- */
-
-/**
- * Insert all of the matched elements after another, specified, set of elements.
- * This operation is, essentially, the reverse of doing a regular
- * $(A).after(B), in that instead of inserting B after A, you're inserting
- * A after B.
- *
- * @example $("p").insertAfter("#foo");
- * @before <p>I would like to say: </p><div id="foo">Hello</div>
- * @result <div id="foo">Hello</div><p>I would like to say: </p>
- * @desc Same as $("#foo").after("p")
- *
- * @name insertAfter
- * @type jQuery
- * @param <Content> content Content to insert the selected element after.
- * @cat DOM/Manipulation
- * @see after(<Content>)
- */
 
 jQuery.each({
 	appendTo: "append",
 	prependTo: "prepend",
 	insertBefore: "before",
-	insertAfter: "after"
-}, function(i,n){
-	jQuery.fn[ i ] = function(){
-		var a = arguments;
+	insertAfter: "after",
+	replaceAll: "replaceWith"
+}, function(name, original){
+	jQuery.fn[ name ] = function() {
+		var args = arguments;
+
 		return this.each(function(){
-			for ( var j = 0, al = a.length; j < al; j++ )
-				jQuery(a[j])[n]( this );
+			for ( var i = 0, length = args.length; i < length; i++ )
+				jQuery( args[ i ] )[ original ]( this );
 		});
 	};
 });
 
-/**
- * Remove an attribute from each of the matched elements.
- *
- * @example $("input").removeAttr("disabled")
- * @before <input disabled="disabled"/>
- * @result <input/>
- *
- * @name removeAttr
- * @type jQuery
- * @param String name The name of the attribute to remove.
- * @cat DOM/Attributes
- */
+jQuery.each({
+	removeAttr: function( name ) {
+		jQuery.attr( this, name, "" );
+		if (this.nodeType == 1)
+			this.removeAttribute( name );
+	},
 
-/**
- * Adds the specified class(es) to each of the set of matched elements.
- *
- * @example $("p").addClass("selected")
- * @before <p>Hello</p>
- * @result [ <p class="selected">Hello</p> ]
- *
- * @example $("p").addClass("selected highlight")
- * @before <p>Hello</p>
- * @result [ <p class="selected highlight">Hello</p> ]
- *
- * @name addClass
- * @type jQuery
- * @param String class One or more CSS classes to add to the elements
- * @cat DOM/Attributes
- * @see removeClass(String)
- */
+	addClass: function( classNames ) {
+		jQuery.className.add( this, classNames );
+	},
 
-/**
- * Removes all or the specified class(es) from the set of matched elements.
- *
- * @example $("p").removeClass()
- * @before <p class="selected">Hello</p>
- * @result [ <p>Hello</p> ]
- *
- * @example $("p").removeClass("selected")
- * @before <p class="selected first">Hello</p>
- * @result [ <p class="first">Hello</p> ]
- *
- * @example $("p").removeClass("selected highlight")
- * @before <p class="highlight selected first">Hello</p>
- * @result [ <p class="first">Hello</p> ]
- *
- * @name removeClass
- * @type jQuery
- * @param String class (optional) One or more CSS classes to remove from the elements
- * @cat DOM/Attributes
- * @see addClass(String)
- */
+	removeClass: function( classNames ) {
+		jQuery.className.remove( this, classNames );
+	},
 
-/**
- * Adds the specified class if it is not present, removes it if it is
- * present.
- *
- * @example $("p").toggleClass("selected")
- * @before <p>Hello</p><p class="selected">Hello Again</p>
- * @result [ <p class="selected">Hello</p>, <p>Hello Again</p> ]
- *
- * @name toggleClass
- * @type jQuery
- * @param String class A CSS class with which to toggle the elements
- * @cat DOM/Attributes
- */
+	toggleClass: function( classNames ) {
+		jQuery.className[ jQuery.className.has( this, classNames ) ? "remove" : "add" ]( this, classNames );
+	},
 
-/**
- * Removes all matched elements from the DOM. This does NOT remove them from the
- * jQuery object, allowing you to use the matched elements further.
- *
- * Can be filtered with an optional expressions.
- *
- * @example $("p").remove();
- * @before <p>Hello</p> how are <p>you?</p>
- * @result how are
- *
- * @example $("p").remove(".hello");
- * @before <p class="hello">Hello</p> how are <p>you?</p>
- * @result how are <p>you?</p>
- *
- * @name remove
- * @type jQuery
- * @param String expr (optional) A jQuery expression to filter elements by.
- * @cat DOM/Manipulation
- */
+	remove: function( selector ) {
+		if ( !selector || jQuery.filter( selector, [ this ] ).r.length ) {
+			// Prevent memory leaks
+			jQuery( "*", this ).add(this).each(function(){
+				jQuery.event.remove(this);
+				jQuery.removeData(this);
+			});
+			if (this.parentNode)
+				this.parentNode.removeChild( this );
+		}
+	},
 
-/**
- * Removes all child nodes from the set of matched elements.
- *
- * @example $("p").empty()
- * @before <p>Hello, <span>Person</span> <a href="#">and person</a></p>
- * @result [ <p></p> ]
- *
- * @name empty
- * @type jQuery
- * @cat DOM/Manipulation
- */
+	empty: function() {
+		// Remove element nodes and prevent memory leaks
+		jQuery( ">*", this ).remove();
 
-jQuery.each( {
-	removeAttr: function( key ) {
-		jQuery.attr( this, key, "" );
-		this.removeAttribute( key );
-	},
-	addClass: function(c){
-		jQuery.className.add(this,c);
-	},
-	removeClass: function(c){
-		jQuery.className.remove(this,c);
-	},
-	toggleClass: function( c ){
-		jQuery.className[ jQuery.className.has(this,c) ? "remove" : "add" ](this, c);
-	},
-	remove: function(a){
-		if ( !a || jQuery.filter( a, [this] ).r.length )
-			this.parentNode.removeChild( this );
-	},
-	empty: function() {
+		// Remove any remaining nodes
 		while ( this.firstChild )
 			this.removeChild( this.firstChild );
 	}
-}, function(i,n){
-	jQuery.fn[ i ] = function() {
-		return this.each( n, arguments );
+}, function(name, fn){
+	jQuery.fn[ name ] = function(){
+		return this.each( fn, arguments );
 	};
 });
 
-/**
- * Reduce the set of matched elements to a single element.
- * The position of the element in the set of matched elements
- * starts at 0 and goes to length - 1.
- *
- * @example $("p").eq(1)
- * @before <p>This is just a test.</p><p>So is this</p>
- * @result [ <p>So is this</p> ]
- *
- * @name eq
- * @type jQuery
- * @param Number pos The index of the element that you wish to limit to.
- * @cat Core
- */
+jQuery.each([ "Height", "Width" ], function(i, name){
+	var type = name.toLowerCase();
 
-/**
- * Reduce the set of matched elements to all elements before a given position.
- * The position of the element in the set of matched elements
- * starts at 0 and goes to length - 1.
- *
- * @example $("p").lt(1)
- * @before <p>This is just a test.</p><p>So is this</p>
- * @result [ <p>This is just a test.</p> ]
- *
- * @name lt
- * @type jQuery
- * @param Number pos Reduce the set to all elements below this position.
- * @cat Core
- */
+	jQuery.fn[ type ] = function( size ) {
+		// Get window width or height
+		return this[0] == window ?
+			// Opera reports document.body.client[Width/Height] properly in both quirks and standards
+			jQuery.browser.opera && document.body[ "client" + name ] ||
 
-/**
- * Reduce the set of matched elements to all elements after a given position.
- * The position of the element in the set of matched elements
- * starts at 0 and goes to length - 1.
- *
- * @example $("p").gt(0)
- * @before <p>This is just a test.</p><p>So is this</p>
- * @result [ <p>So is this</p> ]
- *
- * @name gt
- * @type jQuery
- * @param Number pos Reduce the set to all elements after this position.
- * @cat Core
- */
+			// Safari reports inner[Width/Height] just fine (Mozilla and Opera include scroll bar widths)
+			jQuery.browser.safari && window[ "inner" + name ] ||
 
-/**
- * Filter the set of elements to those that contain the specified text.
- *
- * @example $("p").contains("test")
- * @before <p>This is just a test.</p><p>So is this</p>
- * @result [ <p>This is just a test.</p> ]
- *
- * @name contains
- * @type jQuery
- * @param String str The string that will be contained within the text of an element.
- * @cat DOM/Traversing
- */
-jQuery.each( [ "eq", "lt", "gt", "contains" ], function(i,n){
-	jQuery.fn[ n ] = function(num,fn) {
-		return this.filter( ":" + n + "(" + num + ")", fn );
+			// Everyone else use document.documentElement or document.body depending on Quirks vs Standards mode
+			document.compatMode == "CSS1Compat" && document.documentElement[ "client" + name ] || document.body[ "client" + name ] :
+
+			// Get document width or height
+			this[0] == document ?
+				// Either scroll[Width/Height] or offset[Width/Height], whichever is greater
+				Math.max(
+					Math.max(document.body["scroll" + name], document.documentElement["scroll" + name]),
+					Math.max(document.body["offset" + name], document.documentElement["offset" + name])
+				) :
+
+				// Get or set width or height on the element
+				size == undefined ?
+					// Get width or height on the element
+					(this.length ? jQuery.css( this[0], type ) : null) :
+
+					// Set the width or height on the element (default to pixels if value is unitless)
+					this.css( type, size.constructor == String ? size : size + "px" );
 	};
 });
 
-/**
- * Get the current computed, pixel, width of the first matched element.
- *
- * @example $("p").width();
- * @before <p>This is just a test.</p>
- * @result 300
- *
- * @name width
- * @type String
- * @cat CSS
- */
+// Helper function used by the dimensions and offset modules
+function num(elem, prop) {
+	return elem[0] && parseInt( jQuery.curCSS(elem[0], prop, true), 10 ) || 0;
+}var chars = jQuery.browser.safari && parseInt(jQuery.browser.version) < 417 ?
+		"(?:[\\w*_-]|\\\\.)" :
+		"(?:[\\w\u0128-\uFFFF*_-]|\\\\.)",
+	quickChild = new RegExp("^>\\s*(" + chars + "+)"),
+	quickID = new RegExp("^(" + chars + "+)(#)(" + chars + "+)"),
+	quickClass = new RegExp("^([#.]?)(" + chars + "*)");
 
-/**
- * Set the CSS width of every matched element. If no explicit unit
- * was specified (like 'em' or '%') then "px" is added to the width.
- *
- * @example $("p").width(20);
- * @before <p>This is just a test.</p>
- * @result <p style="width:20px;">This is just a test.</p>
- *
- * @example $("p").width("20em");
- * @before <p>This is just a test.</p>
- * @result <p style="width:20em;">This is just a test.</p>
- *
- * @name width
- * @type jQuery
- * @param String|Number val Set the CSS property to the specified value.
- * @cat CSS
- */
- 
-/**
- * Get the current computed, pixel, height of the first matched element.
- *
- * @example $("p").height();
- * @before <p>This is just a test.</p>
- * @result 300
- *
- * @name height
- * @type String
- * @cat CSS
- */
-
-/**
- * Set the CSS height of every matched element. If no explicit unit
- * was specified (like 'em' or '%') then "px" is added to the width.
- *
- * @example $("p").height(20);
- * @before <p>This is just a test.</p>
- * @result <p style="height:20px;">This is just a test.</p>
- *
- * @example $("p").height("20em");
- * @before <p>This is just a test.</p>
- * @result <p style="height:20em;">This is just a test.</p>
- *
- * @name height
- * @type jQuery
- * @param String|Number val Set the CSS property to the specified value.
- * @cat CSS
- */
-
-jQuery.each( [ "height", "width" ], function(i,n){
-	jQuery.fn[ n ] = function(h) {
-		return h == undefined ?
-			( this.length ? jQuery.css( this[0], n ) : null ) :
-			this.css( n, h.constructor == String ? h : h + "px" );
-	};
-});
 jQuery.extend({
 	expr: {
-		"": "m[2]=='*'||jQuery.nodeName(a,m[2])",
-		"#": "a.getAttribute('id')==m[2]",
+		"": function(a,i,m){return m[2]=="*"||jQuery.nodeName(a,m[2]);},
+		"#": function(a,i,m){return a.getAttribute("id")==m[2];},
 		":": {
 			// Position Checks
-			lt: "i<m[3]-0",
-			gt: "i>m[3]-0",
-			nth: "m[3]-0==i",
-			eq: "m[3]-0==i",
-			first: "i==0",
-			last: "i==r.length-1",
-			even: "i%2==0",
-			odd: "i%2",
+			lt: function(a,i,m){return i<m[3]-0;},
+			gt: function(a,i,m){return i>m[3]-0;},
+			nth: function(a,i,m){return m[3]-0==i;},
+			eq: function(a,i,m){return m[3]-0==i;},
+			first: function(a,i){return i==0;},
+			last: function(a,i,m,r){return i==r.length-1;},
+			even: function(a,i){return i%2==0;},
+			odd: function(a,i){return i%2;},
 
 			// Child Checks
-			"nth-child": "jQuery.nth(a.parentNode.firstChild,m[3],'nextSibling',a)==a",
-			"first-child": "jQuery.nth(a.parentNode.firstChild,1,'nextSibling')==a",
-			"last-child": "jQuery.nth(a.parentNode.lastChild,1,'previousSibling')==a",
-			"only-child": "jQuery.sibling(a.parentNode.firstChild).length==1",
+			"first-child": function(a){return a.parentNode.getElementsByTagName("*")[0]==a;},
+			"last-child": function(a){return jQuery.nth(a.parentNode.lastChild,1,"previousSibling")==a;},
+			"only-child": function(a){return !jQuery.nth(a.parentNode.lastChild,2,"previousSibling");},
 
 			// Parent Checks
-			parent: "a.firstChild",
-			empty: "!a.firstChild",
+			parent: function(a){return a.firstChild;},
+			empty: function(a){return !a.firstChild;},
 
 			// Text Check
-			contains: "jQuery.fn.text.apply([a]).indexOf(m[3])>=0",
+			contains: function(a,i,m){return (a.textContent||a.innerText||jQuery(a).text()||"").indexOf(m[3])>=0;},
 
 			// Visibility
-			visible: '"hidden"!=a.type&&jQuery.css(a,"display")!="none"&&jQuery.css(a,"visibility")!="hidden"',
-			hidden: '"hidden"==a.type||jQuery.css(a,"display")=="none"||jQuery.css(a,"visibility")=="hidden"',
+			visible: function(a){return "hidden"!=a.type&&jQuery.css(a,"display")!="none"&&jQuery.css(a,"visibility")!="hidden";},
+			hidden: function(a){return "hidden"==a.type||jQuery.css(a,"display")=="none"||jQuery.css(a,"visibility")=="hidden";},
 
 			// Form attributes
-			enabled: "!a.disabled",
-			disabled: "a.disabled",
-			checked: "a.checked",
-			selected: "a.selected||jQuery.attr(a,'selected')",
+			enabled: function(a){return !a.disabled;},
+			disabled: function(a){return a.disabled;},
+			checked: function(a){return a.checked;},
+			selected: function(a){return a.selected||jQuery.attr(a,"selected");},
 
 			// Form elements
-			text: "'text'==a.type",
-			radio: "'radio'==a.type",
-			checkbox: "'checkbox'==a.type",
-			file: "'file'==a.type",
-			password: "'password'==a.type",
-			submit: "'submit'==a.type",
-			image: "'image'==a.type",
-			reset: "'reset'==a.type",
-			button: '"button"==a.type||jQuery.nodeName(a,"button")',
-			input: "/input|select|textarea|button/i.test(a.nodeName)"
-		},
-		".": "jQuery.className.has(a,m[2])",
-		"@": {
-			"=": "z==m[4]",
-			"!=": "z!=m[4]",
-			"^=": "z&&!z.indexOf(m[4])",
-			"$=": "z&&z.substr(z.length - m[4].length,m[4].length)==m[4]",
-			"*=": "z&&z.indexOf(m[4])>=0",
-			"": "z",
-			_resort: function(m){
-				return ["", m[1], m[3], m[2], m[5]];
-			},
-			_prefix: "var z=a[m[3]];if(!z||/href|src/.test(m[3]))z=jQuery.attr(a,m[3]);"
-		},
-		"[": "jQuery.find(m[2],a).length"
+			text: function(a){return "text"==a.type;},
+			radio: function(a){return "radio"==a.type;},
+			checkbox: function(a){return "checkbox"==a.type;},
+			file: function(a){return "file"==a.type;},
+			password: function(a){return "password"==a.type;},
+			submit: function(a){return "submit"==a.type;},
+			image: function(a){return "image"==a.type;},
+			reset: function(a){return "reset"==a.type;},
+			button: function(a){return "button"==a.type||jQuery.nodeName(a,"button");},
+			input: function(a){return /input|select|textarea|button/i.test(a.nodeName);},
+
+			// :has()
+			has: function(a,i,m){return jQuery.find(m[3],a).length;},
+
+			// :header
+			header: function(a){return /h\d/i.test(a.nodeName);},
+
+			// :animated
+			animated: function(a){return jQuery.grep(jQuery.timers,function(fn){return a==fn.elem;}).length;}
+		}
 	},
-	
+
 	// The regular expressions that power the parsing engine
 	parse: [
 		// Match: [@value='test'], [@foo]
-		/^\[ *(@)([\w-]+) *([!*$^=]*) *('?"?)(.*?)\4 *\]/,
-
-		// Match: [div], [div p]
-		/^(\[)\s*(.*?(\[.*?\])?[^[]*?)\s*\]/,
+		/^(\[) *@?([\w-]+) *([!*$^~=]*) *('?"?)(.*?)\4 *\]/,
 
 		// Match: :contains('foo')
 		/^(:)([\w-]+)\("?'?(.*?(\(.*?\))?[^(]*?)"?'?\)/,
 
-		// Match: :even, :last-chlid, #id, .class
-		new RegExp("^([:.#]*)(" + 
-			( jQuery.chars = "(?:[\\w\u0128-\uFFFF*_-]|\\\\.)" ) + "+)")
-	],
-
-	token: [
-		/^(\/?\.\.)/, "a.parentNode",
-		/^(>|\/)/, "jQuery.sibling(a.firstChild)",
-		/^(\+)/, "jQuery.nth(a,2,'nextSibling')",
-		/^(~)/, function(a){
-			var s = jQuery.sibling(a.parentNode.firstChild);
-			return s.slice(jQuery.inArray(a,s) + 1);
-		}
+		// Match: :even, :last-child, #id, .class
+		new RegExp("^([:.#]*)(" + chars + "+)")
 	],
 
 	multiFilter: function( expr, elems, not ) {
 		var old, cur = [];
 
@@ -2437,89 +1458,86 @@ jQuery.extend({
 		}
 
 		return cur;
 	},
 
-	/**
-	 * @name $.find
-	 * @type Array<Element>
-	 * @private
-	 * @cat Core
-	 */
 	find: function( t, context ) {
 		// Quickly handle non-string expressions
 		if ( typeof t != "string" )
 			return [ t ];
 
-		// Make sure that the context is a DOM Element
-		if ( context && !context.nodeType )
-			context = null;
+		// check to make sure context is a DOM element or a document
+		if ( context && context.nodeType != 1 && context.nodeType != 9)
+			return [ ];
 
 		// Set the correct context (if none is provided)
 		context = context || document;
 
-		// Handle the common XPath // expression
-		if ( !t.indexOf("//") ) {
-			context = context.documentElement;
-			t = t.substr(2,t.length);
-
-		// And the / root expression
-		} else if ( !t.indexOf("/") && !context.ownerDocument ) {
-			context = context.documentElement;
-			t = t.substr(1,t.length);
-			if ( t.indexOf("/") >= 1 )
-				t = t.substr(t.indexOf("/"),t.length);
-		}
-
 		// Initialize the search
-		var ret = [context], done = [], last;
+		var ret = [context], done = [], last, nodeName;
 
 		// Continue while a selector expression exists, and while
 		// we're no longer looping upon ourselves
 		while ( t && last != t ) {
 			var r = [];
 			last = t;
 
-			t = jQuery.trim(t).replace( /^\/\//, "" );
+			t = jQuery.trim(t);
 
-			var foundToken = false;
+			var foundToken = false,
 
 			// An attempt at speeding up child selectors that
 			// point to a specific element tag
-			var re = new RegExp("^[/>]\\s*(" + jQuery.chars + "+)");
-			var m = re.exec(t);
+				re = quickChild,
+
+				m = re.exec(t);
 
 			if ( m ) {
+				nodeName = m[1].toUpperCase();
+
 				// Perform our own iteration and filter
 				for ( var i = 0; ret[i]; i++ )
 					for ( var c = ret[i].firstChild; c; c = c.nextSibling )
-						if ( c.nodeType == 1 && ( m[1] == "*" || jQuery.nodeName(c, m[1]) ) )
+						if ( c.nodeType == 1 && (nodeName == "*" || c.nodeName.toUpperCase() == nodeName) )
 							r.push( c );
 
 				ret = r;
 				t = t.replace( re, "" );
 				if ( t.indexOf(" ") == 0 ) continue;
 				foundToken = true;
 			} else {
-				// Look for pre-defined expression tokens
-				for ( var i = 0, tl = jQuery.token.length; i < tl; i += 2 ) {
-					// Attempt to match each, individual, token in
-					// the specified order
-					var re = jQuery.token[i], fn = jQuery.token[i+1];
-					var m = re.exec(t);
+				re = /^([>+~])\s*(\w*)/i;
 
-					// If the token match was found
-					if ( m ) {
-						// Map it against the token's handler
-						r = ret = jQuery.map( ret, jQuery.isFunction( fn ) ?
-							fn : new Function( "a", "return " + fn ) );
+				if ( (m = re.exec(t)) != null ) {
+					r = [];
 
-						// And remove the token
-						t = jQuery.trim( t.replace( re, "" ) );
-						foundToken = true;
-						break;
+					var merge = {};
+					nodeName = m[2].toUpperCase();
+					m = m[1];
+
+					for ( var j = 0, rl = ret.length; j < rl; j++ ) {
+						var n = m == "~" || m == "+" ? ret[j].nextSibling : ret[j].firstChild;
+						for ( ; n; n = n.nextSibling )
+							if ( n.nodeType == 1 ) {
+								var id = jQuery.data(n);
+
+								if ( m == "~" && merge[id] ) break;
+
+								if (!nodeName || n.nodeName.toUpperCase() == nodeName ) {
+									if ( m == "~" ) merge[id] = true;
+									r.push( n );
+								}
+
+								if ( m == "+" ) break;
+							}
 					}
+
+					ret = r;
+
+					// And remove the token
+					t = jQuery.trim( t.replace( re, "" ) );
+					foundToken = true;
 				}
 			}
 
 			// See if there's still an expression, and that we haven't already
 			// matched a token
@@ -2537,34 +1555,34 @@ jQuery.extend({
 
 					// Touch up the selector string
 					t = " " + t.substr(1,t.length);
 
 				} else {
-					// Optomize for the case nodeName#idName
-					var re2 = new RegExp("^(" + jQuery.chars + "+)(#)(" + jQuery.chars + "+)");
+					// Optimize for the case nodeName#idName
+					var re2 = quickID;
 					var m = re2.exec(t);
-					
+
 					// Re-organize the results, so that they're consistent
 					if ( m ) {
-					   m = [ 0, m[2], m[3], m[1] ];
+						m = [ 0, m[2], m[3], m[1] ];
 
 					} else {
 						// Otherwise, do a traditional filter check for
 						// ID, class, and element selectors
-						re2 = new RegExp("^([#.]?)(" + jQuery.chars + "*)");
+						re2 = quickClass;
 						m = re2.exec(t);
 					}
 
 					m[2] = m[2].replace(/\\/g, "");
 
 					var elem = ret[ret.length-1];
 
 					// Try to do a global search by ID, where we can
-					if ( m[1] == "#" && elem && elem.getElementById ) {
+					if ( m[1] == "#" && elem && elem.getElementById && !jQuery.isXMLDoc(elem) ) {
 						// Optimization for HTML document case
 						var oid = elem.getElementById(m[2]);
-						
+
 						// Do a quick check for the existence of the actual ID attribute
 						// to avoid selecting by the name attribute in IE
 						// also check to insure id is a string to avoid selecting an element with the name of 'id' inside a form
 						if ( (jQuery.browser.msie||jQuery.browser.opera) && oid && typeof oid.id == "string" && oid.id != m[2] )
 							oid = jQuery('[@id="'+m[2]+'"]', elem)[0];
@@ -2574,11 +1592,11 @@ jQuery.extend({
 						ret = r = oid && (!m[3] || jQuery.nodeName(oid, m[3])) ? [oid] : [];
 					} else {
 						// We need to find all descendant elements
 						for ( var i = 0; ret[i]; i++ ) {
 							// Grab the tag name being searched for
-							var tag = m[1] != "" || m[0] == "" ? "*" : m[2];
+							var tag = m[1] == "#" && m[3] ? m[3] : m[1] != "" || m[0] == "" ? "*" : m[2];
 
 							// Handle IE7 being really dumb about <object>s
 							if ( tag == "*" && ret[i].nodeName.toLowerCase() == "object" )
 								tag = "param";
 
@@ -2648,11 +1666,11 @@ jQuery.extend({
 
 	filter: function(t,r,not) {
 		var last;
 
 		// Look for common filter expressions
-		while ( t  && t != last ) {
+		while ( t && t != last ) {
 			last = t;
 
 			var p = jQuery.parse, m;
 
 			for ( var i = 0; p[i]; i++ ) {
@@ -2660,1161 +1678,756 @@ jQuery.extend({
 
 				if ( m ) {
 					// Remove what we just matched
 					t = t.substring( m[0].length );
 
-					// Re-organize the first match
-					if ( jQuery.expr[ m[1] ]._resort )
-						m = jQuery.expr[ m[1] ]._resort( m );
-
 					m[2] = m[2].replace(/\\/g, "");
-
 					break;
 				}
 			}
 
 			if ( !m )
 				break;
 
 			// :not() is a special case that can be optimized by
 			// keeping it out of the expression list
 			if ( m[1] == ":" && m[2] == "not" )
-				r = jQuery.filter(m[3], r, true).r;
+				// optimize if only one selector found (most common case)
+				r = isSimple.test( m[3] ) ?
+					jQuery.filter(m[3], r, true).r :
+					jQuery( r ).not( m[3] );
 
 			// We can get a big speed boost by filtering by class here
 			else if ( m[1] == "." )
 				r = jQuery.classFilter(r, m[2], not);
 
+			else if ( m[1] == "[" ) {
+				var tmp = [], type = m[3];
+
+				for ( var i = 0, rl = r.length; i < rl; i++ ) {
+					var a = r[i], z = a[ jQuery.props[m[2]] || m[2] ];
+
+					if ( z == null || /href|src|selected/.test(m[2]) )
+						z = jQuery.attr(a,m[2]) || '';
+
+					if ( (type == "" && !!z ||
+						 type == "=" && z == m[5] ||
+						 type == "!=" && z != m[5] ||
+						 type == "^=" && z && !z.indexOf(m[5]) ||
+						 type == "$=" && z.substr(z.length - m[5].length) == m[5] ||
+						 (type == "*=" || type == "~=") && z.indexOf(m[5]) >= 0) ^ not )
+							tmp.push( a );
+				}
+
+				r = tmp;
+
+			// We can get a speed boost by handling nth-child here
+			} else if ( m[1] == ":" && m[2] == "nth-child" ) {
+				var merge = {}, tmp = [],
+					// parse equations like 'even', 'odd', '5', '2n', '3n+2', '4n-1', '-n+6'
+					test = /(-?)(\d*)n((?:\+|-)?\d*)/.exec(
+						m[3] == "even" && "2n" || m[3] == "odd" && "2n+1" ||
+						!/\D/.test(m[3]) && "0n+" + m[3] || m[3]),
+					// calculate the numbers (first)n+(last) including if they are negative
+					first = (test[1] + (test[2] || 1)) - 0, last = test[3] - 0;
+
+				// loop through all the elements left in the jQuery object
+				for ( var i = 0, rl = r.length; i < rl; i++ ) {
+					var node = r[i], parentNode = node.parentNode, id = jQuery.data(parentNode);
+
+					if ( !merge[id] ) {
+						var c = 1;
+
+						for ( var n = parentNode.firstChild; n; n = n.nextSibling )
+							if ( n.nodeType == 1 )
+								n.nodeIndex = c++;
+
+						merge[id] = true;
+					}
+
+					var add = false;
+
+					if ( first == 0 ) {
+						if ( node.nodeIndex == last )
+							add = true;
+					} else if ( (node.nodeIndex - last) % first == 0 && (node.nodeIndex - last) / first >= 0 )
+						add = true;
+
+					if ( add ^ not )
+						tmp.push( node );
+				}
+
+				r = tmp;
+
 			// Otherwise, find the expression to execute
-			else {
-				var f = jQuery.expr[m[1]];
-				if ( typeof f != "string" )
-					f = jQuery.expr[m[1]][m[2]];
+			} else {
+				var fn = jQuery.expr[ m[1] ];
+				if ( typeof fn == "object" )
+					fn = fn[ m[2] ];
 
-				// Build a custom macro to enclose it
-				eval("f = function(a,i){" +
-					( jQuery.expr[ m[1] ]._prefix || "" ) +
-					"return " + f + "}");
+				if ( typeof fn == "string" )
+					fn = eval("false||function(a,i){return " + fn + ";}");
 
 				// Execute it against the current filter
-				r = jQuery.grep( r, f, not );
+				r = jQuery.grep( r, function(elem, i){
+					return fn(elem, i, m, r);
+				}, not );
 			}
 		}
 
 		// Return an array of filtered elements (r)
 		// and the modified expression string (t)
 		return { r: r, t: t };
 	},
 
-	/**
-	 * All ancestors of a given element.
-	 *
-	 * @private
-	 * @name $.parents
-	 * @type Array<Element>
-	 * @param Element elem The element to find the ancestors of.
-	 * @cat DOM/Traversing
-	 */
-	parents: function( elem ){
-		var matched = [];
-		var cur = elem.parentNode;
+	dir: function( elem, dir ){
+		var matched = [],
+			cur = elem[dir];
 		while ( cur && cur != document ) {
-			matched.push( cur );
-			cur = cur.parentNode;
+			if ( cur.nodeType == 1 )
+				matched.push( cur );
+			cur = cur[dir];
 		}
 		return matched;
 	},
-	
-	/**
-	 * A handy, and fast, way to traverse in a particular direction and find
-	 * a specific element.
-	 *
-	 * @private
-	 * @name $.nth
-	 * @type DOMElement
-	 * @param DOMElement cur The element to search from.
-	 * @param String|Number num The Nth result to match. Can be a number or a string (like 'even' or 'odd').
-	 * @param String dir The direction to move in (pass in something like 'previousSibling' or 'nextSibling').
-	 * @cat DOM/Traversing
-	 */
+
 	nth: function(cur,result,dir,elem){
 		result = result || 1;
 		var num = 0;
-		for ( ; cur; cur = cur[dir] ) {
-			if ( cur.nodeType == 1 ) num++;
-			if ( num == result || result == "even" && num % 2 == 0 && num > 1 && cur == elem ||
-				result == "odd" && num % 2 == 1 && cur == elem ) break;
-		}
+
+		for ( ; cur; cur = cur[dir] )
+			if ( cur.nodeType == 1 && ++num == result )
+				break;
+
 		return cur;
 	},
-	
-	/**
-	 * All elements on a specified axis.
-	 *
-	 * @private
-	 * @name $.sibling
-	 * @type Array
-	 * @param Element elem The element to find all the siblings of (including itself).
-	 * @cat DOM/Traversing
-	 */
+
 	sibling: function( n, elem ) {
 		var r = [];
 
 		for ( ; n; n = n.nextSibling ) {
-			if ( n.nodeType == 1 && (!elem || n != elem) )
+			if ( n.nodeType == 1 && n != elem )
 				r.push( n );
 		}
 
 		return r;
 	}
 });
 /*
  * A number of helper functions used for managing events.
- * Many of the ideas behind this code orignated from 
+ * Many of the ideas behind this code orignated from
  * Dean Edwards' addEvent library.
  */
 jQuery.event = {
 
 	// Bind an event to an element
 	// Original by Dean Edwards
-	add: function(element, type, handler, data) {
+	add: function(elem, types, handler, data) {
+		if ( elem.nodeType == 3 || elem.nodeType == 8 )
+			return;
+
 		// For whatever reason, IE has trouble passing the window object
 		// around, causing it to be cloned in the process
-		if ( jQuery.browser.msie && element.setInterval != undefined )
-			element = window;
-		
+		if ( jQuery.browser.msie && elem.setInterval )
+			elem = window;
+
 		// Make sure that the function being executed has a unique ID
 		if ( !handler.guid )
 			handler.guid = this.guid++;
-			
-		// if data is passed, bind to handler 
-		if( data != undefined ) { 
-        	// Create temporary function pointer to original handler 
-			var fn = handler; 
 
-			// Create unique handler function, wrapped around original handler 
-			handler = function() { 
-				// Pass arguments and context to original handler 
-				return fn.apply(this, arguments); 
-			};
+		// if data is passed, bind to handler
+		if( data != undefined ) {
+			// Create temporary function pointer to original handler
+			var fn = handler;
 
-			// Store data in unique handler 
+			// Create unique handler function, wrapped around original handler
+			handler = this.proxy( fn, function() {
+				// Pass arguments and context to original handler
+				return fn.apply(this, arguments);
+			});
+
+			// Store data in unique handler
 			handler.data = data;
-
-			// Set the guid of unique handler to the same of original handler, so it can be removed 
-			handler.guid = fn.guid;
 		}
 
 		// Init the element's event structure
-		if (!element.$events)
-			element.$events = {};
-		
-		if (!element.$handle)
-			element.$handle = function() {
-				// returned undefined or false
-				var val;
-
+		var events = jQuery.data(elem, "events") || jQuery.data(elem, "events", {}),
+			handle = jQuery.data(elem, "handle") || jQuery.data(elem, "handle", function(){
 				// Handle the second event of a trigger and when
 				// an event is called after a page has unloaded
-				if ( typeof jQuery == "undefined" || jQuery.event.triggered )
-				  return val;
-				
-				val = jQuery.event.handle.apply(element, arguments);
-				
-				return val;
-			};
+				if ( typeof jQuery != "undefined" && !jQuery.event.triggered )
+					return jQuery.event.handle.apply(arguments.callee.elem, arguments);
+			});
+		// Add elem as a property of the handle function
+		// This is to prevent a memory leak with non-native
+		// event in IE.
+		handle.elem = elem;
 
-		// Get the current list of functions bound to this event
-		var handlers = element.$events[type];
+		// Handle multiple events separated by a space
+		// jQuery(...).bind("mouseover mouseout", fn);
+		jQuery.each(types.split(/\s+/), function(index, type) {
+			// Namespaced event handlers
+			var parts = type.split(".");
+			type = parts[0];
+			handler.type = parts[1];
 
-		// Init the event handler queue
-		if (!handlers) {
-			handlers = element.$events[type] = {};	
-			
-			// And bind the global event handler to the element
-			if (element.addEventListener)
-				element.addEventListener(type, element.$handle, false);
-			else if (element.attachEvent)
-				element.attachEvent("on" + type, element.$handle);
-		}
+			// Get the current list of functions bound to this event
+			var handlers = events[type];
 
-		// Add the function to the element's handler list
-		handlers[handler.guid] = handler;
+			// Init the event handler queue
+			if (!handlers) {
+				handlers = events[type] = {};
 
-		// Remember the function in a global list (for triggering)
-		if (!this.global[type])
-			this.global[type] = [];
-		// Only add the element to the global list once
-		if (jQuery.inArray(element, this.global[type]) == -1)
-			this.global[type].push( element );
+				// Check for a special event handler
+				// Only use addEventListener/attachEvent if the special
+				// events handler returns false
+				if ( !jQuery.event.special[type] || jQuery.event.special[type].setup.call(elem) === false ) {
+					// Bind the global event handler to the element
+					if (elem.addEventListener)
+						elem.addEventListener(type, handle, false);
+					else if (elem.attachEvent)
+						elem.attachEvent("on" + type, handle);
+				}
+			}
+
+			// Add the function to the element's handler list
+			handlers[handler.guid] = handler;
+
+			// Keep track of which events have been used, for global triggering
+			jQuery.event.global[type] = true;
+		});
+
+		// Nullify elem to prevent memory leaks in IE
+		elem = null;
 	},
 
 	guid: 1,
 	global: {},
 
 	// Detach an event or set of events from an element
-	remove: function(element, type, handler) {
-		var events = element.$events, ret, index;
+	remove: function(elem, types, handler) {
+		// don't do events on text and comment nodes
+		if ( elem.nodeType == 3 || elem.nodeType == 8 )
+			return;
+
+		var events = jQuery.data(elem, "events"), ret, index;
 
 		if ( events ) {
-			// type is actually an event object here
-			if ( type && type.type ) {
-				handler = type.handler;
-				type = type.type;
-			}
-			
-			if ( !type ) {
-				for ( type in events )
-					this.remove( element, type );
+			// Unbind all events for the element
+			if ( types == undefined || (typeof types == "string" && types.charAt(0) == ".") )
+				for ( var type in events )
+					this.remove( elem, type + (types || "") );
+			else {
+				// types is actually an event object here
+				if ( types.type ) {
+					handler = types.handler;
+					types = types.type;
+				}
 
-			} else if ( events[type] ) {
-				// remove the given handler for the given type
-				if ( handler )
-					delete events[type][handler.guid];
-				
-				// remove all handlers for the given type
-				else
-					for ( handler in element.$events[type] )
-						delete events[type][handler];
+				// Handle multiple events seperated by a space
+				// jQuery(...).unbind("mouseover mouseout", fn);
+				jQuery.each(types.split(/\s+/), function(index, type){
+					// Namespaced event handlers
+					var parts = type.split(".");
+					type = parts[0];
 
-				// remove generic event handler if no more handlers exist
-				for ( ret in events[type] ) break;
-				if ( !ret ) {
-					if (element.removeEventListener)
-						element.removeEventListener(type, element.$handle, false);
-					else if (element.detachEvent)
-						element.detachEvent("on" + type, element.$handle);
-					ret = null;
-					delete events[type];
-					
-					// Remove element from the global event type cache
-					while ( this.global[type] && ( (index = jQuery.inArray(element, this.global[type])) >= 0 ) )
-						delete this.global[type][index];
-				}
+					if ( events[type] ) {
+						// remove the given handler for the given type
+						if ( handler )
+							delete events[type][handler.guid];
+
+						// remove all handlers for the given type
+						else
+							for ( handler in events[type] )
+								// Handle the removal of namespaced events
+								if ( !parts[1] || events[type][handler].type == parts[1] )
+									delete events[type][handler];
+
+						// remove generic event handler if no more handlers exist
+						for ( ret in events[type] ) break;
+						if ( !ret ) {
+							if ( !jQuery.event.special[type] || jQuery.event.special[type].teardown.call(elem) === false ) {
+								if (elem.removeEventListener)
+									elem.removeEventListener(type, jQuery.data(elem, "handle"), false);
+								else if (elem.detachEvent)
+									elem.detachEvent("on" + type, jQuery.data(elem, "handle"));
+							}
+							ret = null;
+							delete events[type];
+						}
+					}
+				});
 			}
 
 			// Remove the expando if it's no longer used
 			for ( ret in events ) break;
-			if ( !ret )
-				element.$handle = element.$events = null;
+			if ( !ret ) {
+				var handle = jQuery.data( elem, "handle" );
+				if ( handle ) handle.elem = null;
+				jQuery.removeData( elem, "events" );
+				jQuery.removeData( elem, "handle" );
+			}
 		}
 	},
 
-	trigger: function(type, data, element) {
+	trigger: function(type, data, elem, donative, extra) {
 		// Clone the incoming data, if any
-		data = jQuery.makeArray(data || []);
+		data = jQuery.makeArray(data);
+
+		if ( type.indexOf("!") >= 0 ) {
+			type = type.slice(0, -1);
+			var exclusive = true;
+		}
 
 		// Handle a global trigger
-		if ( !element )
-			jQuery.each( this.global[type] || [], function(){
-				jQuery.event.trigger( type, data, this );
-			});
+		if ( !elem ) {
+			// Only trigger if we've ever bound an event for it
+			if ( this.global[type] )
+				jQuery("*").add([window, document]).trigger(type, data);
 
 		// Handle triggering a single element
-		else {
-			var val, ret, fn = jQuery.isFunction( element[ type ] || null );
-			
+		} else {
+			// don't do events on text and comment nodes
+			if ( elem.nodeType == 3 || elem.nodeType == 8 )
+				return undefined;
+
+			var val, ret, fn = jQuery.isFunction( elem[ type ] || null ),
+				// Check to see if we need to provide a fake event, or not
+				event = !data[0] || !data[0].preventDefault;
+
 			// Pass along a fake event
-			data.unshift( this.fix({ type: type, target: element }) );
+			if ( event ) {
+				data.unshift({
+					type: type,
+					target: elem,
+					preventDefault: function(){},
+					stopPropagation: function(){},
+					timeStamp: now()
+				});
+				data[0][expando] = true; // no need to fix fake event
+			}
 
-			// Trigger the event
-			if ( jQuery.isFunction(element.$handle) && (val = element.$handle.apply( element, data )) !== false )
+			// Enforce the right trigger type
+			data[0].type = type;
+			if ( exclusive )
+				data[0].exclusive = true;
+
+			// Trigger the event, it is assumed that "handle" is a function
+			var handle = jQuery.data(elem, "handle");
+			if ( handle )
+				val = handle.apply( elem, data );
+
+			// Handle triggering native .onfoo handlers (and on links since we don't call .click() for links)
+			if ( (!fn || (jQuery.nodeName(elem, 'a') && type == "click")) && elem["on"+type] && elem["on"+type].apply( elem, data ) === false )
+				val = false;
+
+			// Extra functions don't get the custom event object
+			if ( event )
+				data.shift();
+
+			// Handle triggering of extra function
+			if ( extra && jQuery.isFunction( extra ) ) {
+				// call the extra function and tack the current return value on the end for possible inspection
+				ret = extra.apply( elem, val == null ? data : data.concat( val ) );
+				// if anything is returned, give it precedence and have it overwrite the previous value
+				if (ret !== undefined)
+					val = ret;
+			}
+
+			// Trigger the native events (except for clicks on links)
+			if ( fn && donative !== false && val !== false && !(jQuery.nodeName(elem, 'a') && type == "click") ) {
 				this.triggered = true;
-
-			if ( fn && val !== false && !jQuery.nodeName(element, 'a') )
-				element[ type ]();
+				try {
+					elem[ type ]();
+				// prevent IE from throwing an error for some hidden elements
+				} catch (e) {}
+			}
 
 			this.triggered = false;
 		}
+
+		return val;
 	},
 
 	handle: function(event) {
 		// returned undefined or false
-		var val;
+		var val, ret, namespace, all, handlers;
 
-		// Empty object is for triggered events with no data
-		event = jQuery.event.fix( event || window.event || {} ); 
+		event = arguments[0] = jQuery.event.fix( event || window.event );
 
-		var c = this.$events && this.$events[event.type], args = [].slice.call( arguments, 1 );
-		args.unshift( event );
+		// Namespaced event handlers
+		namespace = event.type.split(".");
+		event.type = namespace[0];
+		namespace = namespace[1];
+		// Cache this now, all = true means, any handler
+		all = !namespace && !event.exclusive;
 
-		for ( var j in c ) {
-			// Pass in a reference to the handler function itself
-			// So that we can later remove it
-			args[0].handler = c[j];
-			args[0].data = c[j].data;
+		handlers = ( jQuery.data(this, "events") || {} )[event.type];
 
-			if ( c[j].apply( this, args ) === false ) {
-				event.preventDefault();
-				event.stopPropagation();
-				val = false;
+		for ( var j in handlers ) {
+			var handler = handlers[j];
+
+			// Filter the functions by class
+			if ( all || handler.type == namespace ) {
+				// Pass in a reference to the handler function itself
+				// So that we can later remove it
+				event.handler = handler;
+				event.data = handler.data;
+
+				ret = handler.apply( this, arguments );
+
+				if ( val !== false )
+					val = ret;
+
+				if ( ret === false ) {
+					event.preventDefault();
+					event.stopPropagation();
+				}
 			}
 		}
-
-		// Clean up added properties in IE to prevent memory leak
-		if (jQuery.browser.msie)
-			event.target = event.preventDefault = event.stopPropagation =
-				event.handler = event.data = null;
 
 		return val;
 	},
 
 	fix: function(event) {
-		// store a copy of the original event object 
-		// and clone to set read-only properties
+		if ( event[expando] == true )
+			return event;
+
+		// store a copy of the original event object
+		// and "clone" to set read-only properties
 		var originalEvent = event;
-		event = jQuery.extend({}, originalEvent);
-		
-		// add preventDefault and stopPropagation since 
+		event = { originalEvent: originalEvent };
+		var props = "altKey attrChange attrName bubbles button cancelable charCode clientX clientY ctrlKey currentTarget data detail eventPhase fromElement handler keyCode metaKey newValue originalTarget pageX pageY prevValue relatedNode relatedTarget screenX screenY shiftKey srcElement target timeStamp toElement type view wheelDelta which".split(" ");
+		for ( var i=props.length; i; i-- )
+			event[ props[i] ] = originalEvent[ props[i] ];
+
+		// Mark it as fixed
+		event[expando] = true;
+
+		// add preventDefault and stopPropagation since
 		// they will not work on the clone
 		event.preventDefault = function() {
 			// if preventDefault exists run it on the original event
 			if (originalEvent.preventDefault)
-				return originalEvent.preventDefault();
+				originalEvent.preventDefault();
 			// otherwise set the returnValue property of the original event to false (IE)
 			originalEvent.returnValue = false;
 		};
 		event.stopPropagation = function() {
 			// if stopPropagation exists run it on the original event
 			if (originalEvent.stopPropagation)
-				return originalEvent.stopPropagation();
+				originalEvent.stopPropagation();
 			// otherwise set the cancelBubble property of the original event to true (IE)
 			originalEvent.cancelBubble = true;
 		};
-		
+
+		// Fix timeStamp
+		event.timeStamp = event.timeStamp || now();
+
 		// Fix target property, if necessary
-		if ( !event.target && event.srcElement )
-			event.target = event.srcElement;
-				
+		if ( !event.target )
+			event.target = event.srcElement || document; // Fixes #1925 where srcElement might not be defined either
+
 		// check if target is a textnode (safari)
-		if (jQuery.browser.safari && event.target.nodeType == 3)
-			event.target = originalEvent.target.parentNode;
+		if ( event.target.nodeType == 3 )
+			event.target = event.target.parentNode;
 
 		// Add relatedTarget, if necessary
 		if ( !event.relatedTarget && event.fromElement )
 			event.relatedTarget = event.fromElement == event.target ? event.toElement : event.fromElement;
 
 		// Calculate pageX/Y if missing and clientX/Y available
 		if ( event.pageX == null && event.clientX != null ) {
-			var e = document.documentElement || document.body;
-			event.pageX = event.clientX + e.scrollLeft;
-			event.pageY = event.clientY + e.scrollTop;
+			var doc = document.documentElement, body = document.body;
+			event.pageX = event.clientX + (doc && doc.scrollLeft || body && body.scrollLeft || 0) - (doc.clientLeft || 0);
+			event.pageY = event.clientY + (doc && doc.scrollTop || body && body.scrollTop || 0) - (doc.clientTop || 0);
 		}
-			
+
 		// Add which for key events
-		if ( !event.which && (event.charCode || event.keyCode) )
+		if ( !event.which && ((event.charCode || event.charCode === 0) ? event.charCode : event.keyCode) )
 			event.which = event.charCode || event.keyCode;
-		
+
 		// Add metaKey to non-Mac browsers (use ctrl for PC's and Meta for Macs)
 		if ( !event.metaKey && event.ctrlKey )
 			event.metaKey = event.ctrlKey;
 
 		// Add which for click: 1 == left; 2 == middle; 3 == right
 		// Note: button is not normalized, so don't use it
 		if ( !event.which && event.button )
 			event.which = (event.button & 1 ? 1 : ( event.button & 2 ? 3 : ( event.button & 4 ? 2 : 0 ) ));
-			
+
 		return event;
+	},
+
+	proxy: function( fn, proxy ){
+		// Set the guid of unique handler to the same of original handler, so it can be removed
+		proxy.guid = fn.guid = fn.guid || proxy.guid || this.guid++;
+		// So proxy can be declared as an argument
+		return proxy;
+	},
+
+	special: {
+		ready: {
+			setup: function() {
+				// Make sure the ready event is setup
+				bindReady();
+				return;
+			},
+
+			teardown: function() { return; }
+		},
+
+		mouseenter: {
+			setup: function() {
+				if ( jQuery.browser.msie ) return false;
+				jQuery(this).bind("mouseover", jQuery.event.special.mouseenter.handler);
+				return true;
+			},
+
+			teardown: function() {
+				if ( jQuery.browser.msie ) return false;
+				jQuery(this).unbind("mouseover", jQuery.event.special.mouseenter.handler);
+				return true;
+			},
+
+			handler: function(event) {
+				// If we actually just moused on to a sub-element, ignore it
+				if ( withinElement(event, this) ) return true;
+				// Execute the right handlers by setting the event type to mouseenter
+				event.type = "mouseenter";
+				return jQuery.event.handle.apply(this, arguments);
+			}
+		},
+
+		mouseleave: {
+			setup: function() {
+				if ( jQuery.browser.msie ) return false;
+				jQuery(this).bind("mouseout", jQuery.event.special.mouseleave.handler);
+				return true;
+			},
+
+			teardown: function() {
+				if ( jQuery.browser.msie ) return false;
+				jQuery(this).unbind("mouseout", jQuery.event.special.mouseleave.handler);
+				return true;
+			},
+
+			handler: function(event) {
+				// If we actually just moused on to a sub-element, ignore it
+				if ( withinElement(event, this) ) return true;
+				// Execute the right handlers by setting the event type to mouseleave
+				event.type = "mouseleave";
+				return jQuery.event.handle.apply(this, arguments);
+			}
+		}
 	}
 };
 
 jQuery.fn.extend({
-
-	/**
-	 * Binds a handler to a particular event (like click) for each matched element.
-	 * The event handler is passed an event object that you can use to prevent
-	 * default behaviour. To stop both default action and event bubbling, your handler
-	 * has to return false.
-	 *
-	 * In most cases, you can define your event handlers as anonymous functions
-	 * (see first example). In cases where that is not possible, you can pass additional
-	 * data as the second parameter (and the handler function as the third), see 
-	 * second example.
-	 *
-	 * Calling bind with an event type of "unload" will automatically
-	 * use the one method instead of bind to prevent memory leaks.
-	 *
-	 * @example $("p").bind("click", function(){
-	 *   alert( $(this).text() );
-	 * });
-	 * @before <p>Hello</p>
-	 * @result alert("Hello")
-	 *
-	 * @example function handler(event) {
-	 *   alert(event.data.foo);
-	 * }
-	 * $("p").bind("click", {foo: "bar"}, handler)
-	 * @result alert("bar")
-	 * @desc Pass some additional data to the event handler.
-	 *
-	 * @example $("form").bind("submit", function() { return false; })
-	 * @desc Cancel a default action and prevent it from bubbling by returning false
-	 * from your function.
-	 *
-	 * @example $("form").bind("submit", function(event){
-	 *   event.preventDefault();
-	 * });
-	 * @desc Cancel only the default action by using the preventDefault method.
-	 *
-	 *
-	 * @example $("form").bind("submit", function(event){
-	 *   event.stopPropagation();
-	 * });
-	 * @desc Stop only an event from bubbling by using the stopPropagation method.
-	 *
-	 * @name bind
-	 * @type jQuery
-	 * @param String type An event type
-	 * @param Object data (optional) Additional data passed to the event handler as event.data
-	 * @param Function fn A function to bind to the event on each of the set of matched elements
-	 * @cat Events
-	 */
 	bind: function( type, data, fn ) {
 		return type == "unload" ? this.one(type, data, fn) : this.each(function(){
 			jQuery.event.add( this, type, fn || data, fn && data );
 		});
 	},
-	
-	/**
-	 * Binds a handler to a particular event (like click) for each matched element.
-	 * The handler is executed only once for each element. Otherwise, the same rules
-	 * as described in bind() apply.
-	 * The event handler is passed an event object that you can use to prevent
-	 * default behaviour. To stop both default action and event bubbling, your handler
-	 * has to return false.
-	 *
-	 * In most cases, you can define your event handlers as anonymous functions
-	 * (see first example). In cases where that is not possible, you can pass additional
-	 * data as the second paramter (and the handler function as the third), see 
-	 * second example.
-	 *
-	 * @example $("p").one("click", function(){
-	 *   alert( $(this).text() );
-	 * });
-	 * @before <p>Hello</p>
-	 * @result alert("Hello")
-	 *
-	 * @name one
-	 * @type jQuery
-	 * @param String type An event type
-	 * @param Object data (optional) Additional data passed to the event handler as event.data
-	 * @param Function fn A function to bind to the event on each of the set of matched elements
-	 * @cat Events
-	 */
+
 	one: function( type, data, fn ) {
+		var one = jQuery.event.proxy( fn || data, function(event) {
+			jQuery(this).unbind(event, one);
+			return (fn || data).apply( this, arguments );
+		});
 		return this.each(function(){
-			jQuery.event.add( this, type, function(event) {
-				jQuery(this).unbind(event);
-				return (fn || data).apply( this, arguments);
-			}, fn && data);
+			jQuery.event.add( this, type, one, fn && data);
 		});
 	},
 
-	/**
-	 * The opposite of bind, removes a bound event from each of the matched
-	 * elements.
-	 *
-	 * Without any arguments, all bound events are removed.
-	 *
-	 * If the type is provided, all bound events of that type are removed.
-	 *
-	 * If the function that was passed to bind is provided as the second argument,
-	 * only that specific event handler is removed.
-	 *
-	 * @example $("p").unbind()
-	 * @before <p onclick="alert('Hello');">Hello</p>
-	 * @result [ <p>Hello</p> ]
-	 *
-	 * @example $("p").unbind( "click" )
-	 * @before <p onclick="alert('Hello');">Hello</p>
-	 * @result [ <p>Hello</p> ]
-	 *
-	 * @example $("p").unbind( "click", function() { alert("Hello"); } )
-	 * @before <p onclick="alert('Hello');">Hello</p>
-	 * @result [ <p>Hello</p> ]
-	 *
-	 * @name unbind
-	 * @type jQuery
-	 * @param String type (optional) An event type
-	 * @param Function fn (optional) A function to unbind from the event on each of the set of matched elements
-	 * @cat Events
-	 */
 	unbind: function( type, fn ) {
 		return this.each(function(){
 			jQuery.event.remove( this, type, fn );
 		});
 	},
 
-	/**
-	 * Trigger a type of event on every matched element. This will also cause
-	 * the default action of the browser with the same name (if one exists)
-	 * to be executed. For example, passing 'submit' to the trigger()
-	 * function will also cause the browser to submit the form. This
-	 * default action can be prevented by returning false from one of
-	 * the functions bound to the event.
-	 *
-	 * You can also trigger custom events registered with bind.
-	 *
-	 * @example $("p").trigger("click")
-	 * @before <p click="alert('hello')">Hello</p>
-	 * @result alert('hello')
-	 *
-	 * @example $("p").click(function(event, a, b) {
-	 *   // when a normal click fires, a and b are undefined
-	 *   // for a trigger like below a refers too "foo" and b refers to "bar"
-	 * }).trigger("click", ["foo", "bar"]);
-	 * @desc Example of how to pass arbitrary data to an event
-	 * 
-	 * @example $("p").bind("myEvent",function(event,message1,message2) {
-	 * 	alert(message1 + ' ' + message2);
-	 * });
-	 * $("p").trigger("myEvent",["Hello","World"]);
-	 * @result alert('Hello World') // One for each paragraph
-	 *
-	 * @name trigger
-	 * @type jQuery
-	 * @param String type An event type to trigger.
-	 * @param Array data (optional) Additional data to pass as arguments (after the event object) to the event handler
-	 * @cat Events
-	 */
-	trigger: function( type, data ) {
+	trigger: function( type, data, fn ) {
 		return this.each(function(){
-			jQuery.event.trigger( type, data, this );
+			jQuery.event.trigger( type, data, this, true, fn );
 		});
 	},
 
-	/**
-	 * Toggle between two function calls every other click.
-	 * Whenever a matched element is clicked, the first specified function 
-	 * is fired, when clicked again, the second is fired. All subsequent 
-	 * clicks continue to rotate through the two functions.
-	 *
-	 * Use unbind("click") to remove.
-	 *
-	 * @example $("p").toggle(function(){
-	 *   $(this).addClass("selected");
-	 * },function(){
-	 *   $(this).removeClass("selected");
-	 * });
-	 * 
-	 * @name toggle
-	 * @type jQuery
-	 * @param Function even The function to execute on every even click.
-	 * @param Function odd The function to execute on every odd click.
-	 * @cat Events
-	 */
-	toggle: function() {
+	triggerHandler: function( type, data, fn ) {
+		return this[0] && jQuery.event.trigger( type, data, this[0], false, fn );
+	},
+
+	toggle: function( fn ) {
 		// Save reference to arguments for access in closure
-		var a = arguments;
+		var args = arguments, i = 1;
 
-		return this.click(function(e) {
+		// link all the functions, so any of them can unbind this click handler
+		while( i < args.length )
+			jQuery.event.proxy( fn, args[i++] );
+
+		return this.click( jQuery.event.proxy( fn, function(event) {
 			// Figure out which function to execute
-			this.lastToggle = 0 == this.lastToggle ? 1 : 0;
-			
+			this.lastToggle = ( this.lastToggle || 0 ) % i;
+
 			// Make sure that clicks stop
-			e.preventDefault();
-			
+			event.preventDefault();
+
 			// and execute the function
-			return a[this.lastToggle].apply( this, [e] ) || false;
-		});
+			return args[ this.lastToggle++ ].apply( this, arguments ) || false;
+		}));
 	},
-	
-	/**
-	 * A method for simulating hovering (moving the mouse on, and off,
-	 * an object). This is a custom method which provides an 'in' to a 
-	 * frequent task.
-	 *
-	 * Whenever the mouse cursor is moved over a matched 
-	 * element, the first specified function is fired. Whenever the mouse 
-	 * moves off of the element, the second specified function fires. 
-	 * Additionally, checks are in place to see if the mouse is still within 
-	 * the specified element itself (for example, an image inside of a div), 
-	 * and if it is, it will continue to 'hover', and not move out 
-	 * (a common error in using a mouseout event handler).
-	 *
-	 * @example $("p").hover(function(){
-	 *   $(this).addClass("hover");
-	 * },function(){
-	 *   $(this).removeClass("hover");
-	 * });
-	 *
-	 * @name hover
-	 * @type jQuery
-	 * @param Function over The function to fire whenever the mouse is moved over a matched element.
-	 * @param Function out The function to fire whenever the mouse is moved off of a matched element.
-	 * @cat Events
-	 */
-	hover: function(f,g) {
-		
-		// A private function for handling mouse 'hovering'
-		function handleHover(e) {
-			// Check if mouse(over|out) are still within the same parent element
-			var p = e.relatedTarget;
-	
-			// Traverse up the tree
-			while ( p && p != this ) try { p = p.parentNode } catch(e) { p = this; };
-			
-			// If we actually just moused on to a sub-element, ignore it
-			if ( p == this ) return false;
-			
-			// Execute the right function
-			return (e.type == "mouseover" ? f : g).apply(this, [e]);
-		}
-		
-		// Bind the function to the two event listeners
-		return this.mouseover(handleHover).mouseout(handleHover);
+
+	hover: function(fnOver, fnOut) {
+		return this.bind('mouseenter', fnOver).bind('mouseleave', fnOut);
 	},
-	
-	/**
-	 * Bind a function to be executed whenever the DOM is ready to be
-	 * traversed and manipulated. This is probably the most important 
-	 * function included in the event module, as it can greatly improve
-	 * the response times of your web applications.
-	 *
-	 * In a nutshell, this is a solid replacement for using window.onload, 
-	 * and attaching a function to that. By using this method, your bound function 
-	 * will be called the instant the DOM is ready to be read and manipulated, 
-	 * which is when what 99.99% of all JavaScript code needs to run.
-	 *
-	 * There is one argument passed to the ready event handler: A reference to
-	 * the jQuery function. You can name that argument whatever you like, and
-	 * can therefore stick with the $ alias without risk of naming collisions.
-	 * 
-	 * Please ensure you have no code in your &lt;body&gt; onload event handler, 
-	 * otherwise $(document).ready() may not fire.
-	 *
-	 * You can have as many $(document).ready events on your page as you like.
-	 * The functions are then executed in the order they were added.
-	 *
-	 * @example $(document).ready(function(){ Your code here... });
-	 *
-	 * @example jQuery(function($) {
-	 *   // Your code using failsafe $ alias here...
-	 * });
-	 * @desc Uses both the [[Core#.24.28_fn_.29|shortcut]] for $(document).ready() and the argument
-	 * to write failsafe jQuery code using the $ alias, without relying on the
-	 * global alias.
-	 *
-	 * @name ready
-	 * @type jQuery
-	 * @param Function fn The function to be executed when the DOM is ready.
-	 * @cat Events
-	 * @see $.noConflict()
-	 * @see $(Function)
-	 */
-	ready: function(f) {
+
+	ready: function(fn) {
+		// Attach the listeners
+		bindReady();
+
 		// If the DOM is already ready
 		if ( jQuery.isReady )
 			// Execute the function immediately
-			f.apply( document, [jQuery] );
-			
+			fn.call( document, jQuery );
+
 		// Otherwise, remember the function for later
-		else {
+		else
 			// Add the function to the wait list
-			jQuery.readyList.push( function() { return f.apply(this, [jQuery]) } );
-		}
-	
+			jQuery.readyList.push( function() { return fn.call(this, jQuery); } );
+
 		return this;
 	}
 });
 
 jQuery.extend({
-	/*
-	 * All the code that makes DOM Ready work nicely.
-	 */
 	isReady: false,
 	readyList: [],
-	
 	// Handle when the DOM is ready
 	ready: function() {
 		// Make sure that the DOM is not already loaded
 		if ( !jQuery.isReady ) {
 			// Remember that the DOM is ready
 			jQuery.isReady = true;
-			
+
 			// If there are functions bound, to execute
 			if ( jQuery.readyList ) {
 				// Execute all of them
 				jQuery.each( jQuery.readyList, function(){
-					this.apply( document );
+					this.call( document );
 				});
-				
+
 				// Reset the list of functions
 				jQuery.readyList = null;
 			}
-			// Remove event listener to avoid memory leak
-			if ( jQuery.browser.mozilla || jQuery.browser.opera )
-				document.removeEventListener( "DOMContentLoaded", jQuery.ready, false );
-			
-			// Remove script element used by IE hack
-			if( !window.frames.length ) // don't remove if frames are present (#1187)
-				jQuery(window).load(function(){ jQuery("#__ie_init").remove(); });
+
+			// Trigger any bound ready events
+			jQuery(document).triggerHandler("ready");
 		}
 	}
 });
 
-new function(){
+var readyBound = false;
 
-	/**
-	 * Bind a function to the scroll event of each matched element.
-	 *
-	 * @example $("p").scroll( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onscroll="alert('Hello');">Hello</p>
-	 *
-	 * @name scroll
-	 * @type jQuery
-	 * @param Function fn A function to bind to the scroll event on each of the matched elements.
-	 * @cat Events
-	 */
+function bindReady(){
+	if ( readyBound ) return;
+	readyBound = true;
 
-	/**
-	 * Bind a function to the submit event of each matched element.
-	 *
-	 * @example $("#myform").submit( function() {
-	 *   return $("input", this).val().length > 0;
-	 * } );
-	 * @before <form id="myform"><input /></form>
-	 * @desc Prevents the form submission when the input has no value entered.
-	 *
-	 * @name submit
-	 * @type jQuery
-	 * @param Function fn A function to bind to the submit event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Trigger the submit event of each matched element. This causes all of the functions
-	 * that have been bound to that submit event to be executed, and calls the browser's
-	 * default submit action on the matching element(s). This default action can be prevented
-	 * by returning false from one of the functions bound to the submit event.
-	 *
-	 * Note: This does not execute the submit method of the form element! If you need to
-	 * submit the form via code, you have to use the DOM method, eg. $("form")[0].submit();
-	 *
-	 * @example $("form").submit();
-	 * @desc Triggers all submit events registered to the matched form(s), and submits them.
-	 *
-	 * @name submit
-	 * @type jQuery
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the focus event of each matched element.
-	 *
-	 * @example $("p").focus( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onfocus="alert('Hello');">Hello</p>
-	 *
-	 * @name focus
-	 * @type jQuery
-	 * @param Function fn A function to bind to the focus event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Trigger the focus event of each matched element. This causes all of the functions
-	 * that have been bound to thet focus event to be executed.
-	 *
-	 * Note: This does not execute the focus method of the underlying elements! If you need to
-	 * focus an element via code, you have to use the DOM method, eg. $("#myinput")[0].focus();
-	 *
-	 * @example $("p").focus();
-	 * @before <p onfocus="alert('Hello');">Hello</p>
-	 * @result alert('Hello');
-	 *
-	 * @name focus
-	 * @type jQuery
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the keydown event of each matched element.
-	 *
-	 * @example $("p").keydown( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onkeydown="alert('Hello');">Hello</p>
-	 *
-	 * @name keydown
-	 * @type jQuery
-	 * @param Function fn A function to bind to the keydown event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the dblclick event of each matched element.
-	 *
-	 * @example $("p").dblclick( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p ondblclick="alert('Hello');">Hello</p>
-	 *
-	 * @name dblclick
-	 * @type jQuery
-	 * @param Function fn A function to bind to the dblclick event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the keypress event of each matched element.
-	 *
-	 * @example $("p").keypress( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onkeypress="alert('Hello');">Hello</p>
-	 *
-	 * @name keypress
-	 * @type jQuery
-	 * @param Function fn A function to bind to the keypress event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the error event of each matched element.
-	 *
-	 * @example $("p").error( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onerror="alert('Hello');">Hello</p>
-	 *
-	 * @name error
-	 * @type jQuery
-	 * @param Function fn A function to bind to the error event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the blur event of each matched element.
-	 *
-	 * @example $("p").blur( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onblur="alert('Hello');">Hello</p>
-	 *
-	 * @name blur
-	 * @type jQuery
-	 * @param Function fn A function to bind to the blur event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Trigger the blur event of each matched element. This causes all of the functions
-	 * that have been bound to that blur event to be executed, and calls the browser's
-	 * default blur action on the matching element(s). This default action can be prevented
-	 * by returning false from one of the functions bound to the blur event.
-	 *
-	 * Note: This does not execute the blur method of the underlying elements! If you need to
-	 * blur an element via code, you have to use the DOM method, eg. $("#myinput")[0].blur();
-	 *
-	 * @example $("p").blur();
-	 * @before <p onblur="alert('Hello');">Hello</p>
-	 * @result alert('Hello');
-	 *
-	 * @name blur
-	 * @type jQuery
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the load event of each matched element.
-	 *
-	 * @example $("p").load( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onload="alert('Hello');">Hello</p>
-	 *
-	 * @name load
-	 * @type jQuery
-	 * @param Function fn A function to bind to the load event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the select event of each matched element.
-	 *
-	 * @example $("p").select( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onselect="alert('Hello');">Hello</p>
-	 *
-	 * @name select
-	 * @type jQuery
-	 * @param Function fn A function to bind to the select event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Trigger the select event of each matched element. This causes all of the functions
-	 * that have been bound to that select event to be executed, and calls the browser's
-	 * default select action on the matching element(s). This default action can be prevented
-	 * by returning false from one of the functions bound to the select event.
-	 *
-	 * @example $("p").select();
-	 * @before <p onselect="alert('Hello');">Hello</p>
-	 * @result alert('Hello');
-	 *
-	 * @name select
-	 * @type jQuery
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the mouseup event of each matched element.
-	 *
-	 * @example $("p").mouseup( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onmouseup="alert('Hello');">Hello</p>
-	 *
-	 * @name mouseup
-	 * @type jQuery
-	 * @param Function fn A function to bind to the mouseup event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the unload event of each matched element.
-	 *
-	 * @example $("p").unload( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onunload="alert('Hello');">Hello</p>
-	 *
-	 * @name unload
-	 * @type jQuery
-	 * @param Function fn A function to bind to the unload event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the change event of each matched element.
-	 *
-	 * @example $("p").change( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onchange="alert('Hello');">Hello</p>
-	 *
-	 * @name change
-	 * @type jQuery
-	 * @param Function fn A function to bind to the change event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the mouseout event of each matched element.
-	 *
-	 * @example $("p").mouseout( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onmouseout="alert('Hello');">Hello</p>
-	 *
-	 * @name mouseout
-	 * @type jQuery
-	 * @param Function fn A function to bind to the mouseout event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the keyup event of each matched element.
-	 *
-	 * @example $("p").keyup( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onkeyup="alert('Hello');">Hello</p>
-	 *
-	 * @name keyup
-	 * @type jQuery
-	 * @param Function fn A function to bind to the keyup event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the click event of each matched element.
-	 *
-	 * @example $("p").click( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onclick="alert('Hello');">Hello</p>
-	 *
-	 * @name click
-	 * @type jQuery
-	 * @param Function fn A function to bind to the click event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Trigger the click event of each matched element. This causes all of the functions
-	 * that have been bound to thet click event to be executed.
-	 *
-	 * @example $("p").click();
-	 * @before <p onclick="alert('Hello');">Hello</p>
-	 * @result alert('Hello');
-	 *
-	 * @name click
-	 * @type jQuery
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the resize event of each matched element.
-	 *
-	 * @example $("p").resize( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onresize="alert('Hello');">Hello</p>
-	 *
-	 * @name resize
-	 * @type jQuery
-	 * @param Function fn A function to bind to the resize event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the mousemove event of each matched element.
-	 *
-	 * @example $("p").mousemove( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onmousemove="alert('Hello');">Hello</p>
-	 *
-	 * @name mousemove
-	 * @type jQuery
-	 * @param Function fn A function to bind to the mousemove event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the mousedown event of each matched element.
-	 *
-	 * @example $("p").mousedown( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onmousedown="alert('Hello');">Hello</p>
-	 *
-	 * @name mousedown
-	 * @type jQuery
-	 * @param Function fn A function to bind to the mousedown event on each of the matched elements.
-	 * @cat Events
-	 */
-	 
-	/**
-	 * Bind a function to the mouseover event of each matched element.
-	 *
-	 * @example $("p").mouseover( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onmouseover="alert('Hello');">Hello</p>
-	 *
-	 * @name mouseover
-	 * @type jQuery
-	 * @param Function fn A function to bind to the mousedown event on each of the matched elements.
-	 * @cat Events
-	 */
-	jQuery.each( ("blur,focus,load,resize,scroll,unload,click,dblclick," +
-		"mousedown,mouseup,mousemove,mouseover,mouseout,change,select," + 
-		"submit,keydown,keypress,keyup,error").split(","), function(i,o){
-		
-		// Handle event binding
-		jQuery.fn[o] = function(f){
-			return f ? this.bind(o, f) : this.trigger(o);
-		};
-			
-	});
-	
-	// If Mozilla is used
-	if ( jQuery.browser.mozilla || jQuery.browser.opera )
+	// Mozilla, Opera (see further below for it) and webkit nightlies currently support this event
+	if ( document.addEventListener && !jQuery.browser.opera)
 		// Use the handy event callback
 		document.addEventListener( "DOMContentLoaded", jQuery.ready, false );
-	
-	// If IE is used, use the excellent hack by Matthias Miller
-	// http://www.outofhanwell.com/blog/index.php?title=the_window_onload_problem_revisited
-	else if ( jQuery.browser.msie ) {
-	
-		// Only works if you document.write() it
-		document.write("<scr" + "ipt id=__ie_init defer=true " + 
-			"src=//:><\/script>");
-	
-		// Use the defer script hack
-		var script = document.getElementById("__ie_init");
-		
-		// script does not exist if jQuery is loaded dynamically
-		if ( script ) 
-			script.onreadystatechange = function() {
-				if ( this.readyState != "complete" ) return;
-				jQuery.ready();
-			};
-	
-		// Clear from memory
-		script = null;
-	
-	// If Safari  is used
-	} else if ( jQuery.browser.safari )
-		// Continually check to see if the document.readyState is valid
-		jQuery.safariTimer = setInterval(function(){
-			// loaded and complete are both valid states
-			if ( document.readyState == "loaded" || 
-				document.readyState == "complete" ) {
-	
-				// If either one are found, remove the timer
-				clearInterval( jQuery.safariTimer );
-				jQuery.safariTimer = null;
-	
-				// and execute any waiting functions
-				jQuery.ready();
+
+	// If IE is used and is not in a frame
+	// Continually check to see if the document is ready
+	if ( jQuery.browser.msie && window == top ) (function(){
+		if (jQuery.isReady) return;
+		try {
+			// If IE is used, use the trick by Diego Perini
+			// http://javascript.nwbox.com/IEContentLoaded/
+			document.documentElement.doScroll("left");
+		} catch( error ) {
+			setTimeout( arguments.callee, 0 );
+			return;
+		}
+		// and execute any waiting functions
+		jQuery.ready();
+	})();
+
+	if ( jQuery.browser.opera )
+		document.addEventListener( "DOMContentLoaded", function () {
+			if (jQuery.isReady) return;
+			for (var i = 0; i < document.styleSheets.length; i++)
+				if (document.styleSheets[i].disabled) {
+					setTimeout( arguments.callee, 0 );
+					return;
+				}
+			// and execute any waiting functions
+			jQuery.ready();
+		}, false);
+
+	if ( jQuery.browser.safari ) {
+		var numStyles;
+		(function(){
+			if (jQuery.isReady) return;
+			if ( document.readyState != "loaded" && document.readyState != "complete" ) {
+				setTimeout( arguments.callee, 0 );
+				return;
 			}
-		}, 10); 
+			if ( numStyles === undefined )
+				numStyles = jQuery("style, link[rel=stylesheet]").length;
+			if ( document.styleSheets.length != numStyles ) {
+				setTimeout( arguments.callee, 0 );
+				return;
+			}
+			// and execute any waiting functions
+			jQuery.ready();
+		})();
+	}
 
 	// A fallback to window.onload, that will always work
 	jQuery.event.add( window, "load", jQuery.ready );
-	
+}
+
+jQuery.each( ("blur,focus,load,resize,scroll,unload,click,dblclick," +
+	"mousedown,mouseup,mousemove,mouseover,mouseout,change,select," +
+	"submit,keydown,keypress,keyup,error").split(","), function(i, name){
+
+	// Handle event binding
+	jQuery.fn[name] = function(fn){
+		return fn ? this.bind(name, fn) : this.trigger(name);
+	};
+});
+
+// Checks if an event happened on an element within another element
+// Used in jQuery.event.special.mouseenter and mouseleave handlers
+var withinElement = function(event, elem) {
+	// Check if mouse(over|out) are still within the same parent element
+	var parent = event.relatedTarget;
+	// Traverse up the tree
+	while ( parent && parent != elem ) try { parent = parent.parentNode; } catch(error) { parent = elem; }
+	// Return true if we actually just moused on to a sub-element
+	return parent == elem;
 };
 
-// Clean up after IE to avoid memory leaks
-if (jQuery.browser.msie)
-	jQuery(window).one("unload", function() {
-		var global = jQuery.event.global;
-		for ( var type in global ) {
-			var els = global[type], i = els.length;
-			if ( i && type != 'unload' )
-				do
-					els[i-1] && jQuery.event.remove(els[i-1], type);
-				while (--i);
+// Prevent memory leaks in IE
+// And prevent errors on refresh with events like mouseover in other browsers
+// Window isn't included so as not to unbind existing unload events
+jQuery(window).bind("unload", function() {
+	jQuery("*").add(document).unbind();
+});
+jQuery.fn.extend({
+	// Keep a copy of the old load
+	_load: jQuery.fn.load,
+
+	load: function( url, params, callback ) {
+		if ( typeof url != 'string' )
+			return this._load( url );
+
+		var off = url.indexOf(" ");
+		if ( off >= 0 ) {
+			var selector = url.slice(off, url.length);
+			url = url.slice(0, off);
 		}
-	});
-jQuery.fn.extend({
-
-	/**
-	 * Load HTML from a remote file and inject it into the DOM, only if it's
-	 * been modified by the server.
-	 *
-	 * @example $("#feeds").loadIfModified("feeds.html");
-	 * @before <div id="feeds"></div>
-	 * @result <div id="feeds"><b>45</b> feeds found.</div>
-	 *
-	 * @name loadIfModified
-	 * @type jQuery
-	 * @param String url The URL of the HTML file to load.
-	 * @param Map params (optional) Key/value pairs that will be sent to the server.
-	 * @param Function callback (optional) A function to be executed whenever the data is loaded (parameters: responseText, status and response itself).
-	 * @cat Ajax
-	 */
-	loadIfModified: function( url, params, callback ) {
-		this.load( url, params, callback, 1 );
-	},
-
-	/**
-	 * Load HTML from a remote file and inject it into the DOM.
-	 *
-	 * Note: Avoid to use this to load scripts, instead use $.getScript.
-	 * IE strips script tags when there aren't any other characters in front of it.
-	 *
-	 * @example $("#feeds").load("feeds.html");
-	 * @before <div id="feeds"></div>
-	 * @result <div id="feeds"><b>45</b> feeds found.</div>
-	 *
- 	 * @example $("#feeds").load("feeds.html",
- 	 *   {limit: 25},
- 	 *   function() { alert("The last 25 entries in the feed have been loaded"); }
- 	 * );
-	 * @desc Same as above, but with an additional parameter
-	 * and a callback that is executed when the data was loaded.
-	 *
-	 * @name load
-	 * @type jQuery
-	 * @param String url The URL of the HTML file to load.
-	 * @param Object params (optional) A set of key/value pairs that will be sent as data to the server.
-	 * @param Function callback (optional) A function to be executed whenever the data is loaded (parameters: responseText, status and response itself).
-	 * @cat Ajax
-	 */
-	load: function( url, params, callback, ifModified ) {
-		if ( jQuery.isFunction( url ) )
-			return this.bind("load", url);
 
 		callback = callback || function(){};
 
 		// Default to a GET request
 		var type = "GET";
@@ -3837,331 +2450,94 @@ jQuery.fn.extend({
 
 		// Request the remote document
 		jQuery.ajax({
 			url: url,
 			type: type,
+			dataType: "html",
 			data: params,
-			ifModified: ifModified,
 			complete: function(res, status){
-				if ( status == "success" || !ifModified && status == "notmodified" )
-					// Inject the HTML into all the matched elements
-					self.attr("innerHTML", res.responseText)
-					  // Execute all the scripts inside of the newly-injected HTML
-					  .evalScripts()
-					  // Execute callback
-					  .each( callback, [res.responseText, status, res] );
-				else
-					callback.apply( self, [res.responseText, status, res] );
+				// If successful, inject the HTML into all the matched elements
+				if ( status == "success" || status == "notmodified" )
+					// See if a selector was specified
+					self.html( selector ?
+						// Create a dummy div to hold the results
+						jQuery("<div/>")
+							// inject the contents of the document in, removing the scripts
+							// to avoid any 'Permission Denied' errors in IE
+							.append(res.responseText.replace(/<script(.|\s)*?\/script>/g, ""))
+
+							// Locate the specified elements
+							.find(selector) :
+
+						// If not, just inject the full result
+						res.responseText );
+
+				self.each( callback, [res.responseText, status, res] );
 			}
 		});
 		return this;
 	},
 
-	/**
-	 * Serializes a set of input elements into a string of data.
-	 * This will serialize all given elements.
-	 *
-	 * A serialization similar to the form submit of a browser is
-	 * provided by the [http://www.malsup.com/jquery/form/ Form Plugin].
-	 * It also takes multiple-selects 
-	 * into account, while this method recognizes only a single option.
-	 *
-	 * @example $("input[@type=text]").serialize();
-	 * @before <input type='text' name='name' value='John'/>
-	 * <input type='text' name='location' value='Boston'/>
-	 * @after name=John&amp;location=Boston
-	 * @desc Serialize a selection of input elements to a string
-	 *
-	 * @name serialize
-	 * @type String
-	 * @cat Ajax
-	 */
 	serialize: function() {
-		return jQuery.param( this );
+		return jQuery.param(this.serializeArray());
 	},
-
-	/**
-	 * Evaluate all script tags inside this jQuery. If they have a src attribute,
-	 * the script is loaded, otherwise it's content is evaluated.
-	 *
-	 * @name evalScripts
-	 * @type jQuery
-	 * @private
-	 * @cat Ajax
-	 */
-	evalScripts: function() {
-		return this.find("script").each(function(){
-			if ( this.src )
-				jQuery.getScript( this.src );
-			else
-				jQuery.globalEval( this.text || this.textContent || this.innerHTML || "" );
-		}).end();
+	serializeArray: function() {
+		return this.map(function(){
+			return jQuery.nodeName(this, "form") ?
+				jQuery.makeArray(this.elements) : this;
+		})
+		.filter(function(){
+			return this.name && !this.disabled &&
+				(this.checked || /select|textarea/i.test(this.nodeName) ||
+					/text|hidden|password/i.test(this.type));
+		})
+		.map(function(i, elem){
+			var val = jQuery(this).val();
+			return val == null ? null :
+				val.constructor == Array ?
+					jQuery.map( val, function(val, i){
+						return {name: elem.name, value: val};
+					}) :
+					{name: elem.name, value: val};
+		}).get();
 	}
-
 });
 
 // Attach a bunch of functions for handling common AJAX events
-
-/**
- * Attach a function to be executed whenever an AJAX request begins
- * and there is none already active.
- *
- * @example $("#loading").ajaxStart(function(){
- *   $(this).show();
- * });
- * @desc Show a loading message whenever an AJAX request starts
- * (and none is already active).
- *
- * @name ajaxStart
- * @type jQuery
- * @param Function callback The function to execute.
- * @cat Ajax
- */
-
-/**
- * Attach a function to be executed whenever all AJAX requests have ended.
- *
- * @example $("#loading").ajaxStop(function(){
- *   $(this).hide();
- * });
- * @desc Hide a loading message after all the AJAX requests have stopped.
- *
- * @name ajaxStop
- * @type jQuery
- * @param Function callback The function to execute.
- * @cat Ajax
- */
-
-/**
- * Attach a function to be executed whenever an AJAX request completes.
- *
- * The XMLHttpRequest and settings used for that request are passed
- * as arguments to the callback.
- *
- * @example $("#msg").ajaxComplete(function(request, settings){
- *   $(this).append("<li>Request Complete.</li>");
- * });
- * @desc Show a message when an AJAX request completes.
- *
- * @name ajaxComplete
- * @type jQuery
- * @param Function callback The function to execute.
- * @cat Ajax
- */
-
-/**
- * Attach a function to be executed whenever an AJAX request completes
- * successfully.
- *
- * The XMLHttpRequest and settings used for that request are passed
- * as arguments to the callback.
- *
- * @example $("#msg").ajaxSuccess(function(request, settings){
- *   $(this).append("<li>Successful Request!</li>");
- * });
- * @desc Show a message when an AJAX request completes successfully.
- *
- * @name ajaxSuccess
- * @type jQuery
- * @param Function callback The function to execute.
- * @cat Ajax
- */
-
-/**
- * Attach a function to be executed whenever an AJAX request fails.
- *
- * The XMLHttpRequest and settings used for that request are passed
- * as arguments to the callback. A third argument, an exception object,
- * is passed if an exception occured while processing the request.
- *
- * @example $("#msg").ajaxError(function(request, settings){
- *   $(this).append("<li>Error requesting page " + settings.url + "</li>");
- * });
- * @desc Show a message when an AJAX request fails.
- *
- * @name ajaxError
- * @type jQuery
- * @param Function callback The function to execute.
- * @cat Ajax
- */
- 
-/**
- * Attach a function to be executed before an AJAX request is sent.
- *
- * The XMLHttpRequest and settings used for that request are passed
- * as arguments to the callback.
- *
- * @example $("#msg").ajaxSend(function(request, settings){
- *   $(this).append("<li>Starting request at " + settings.url + "</li>");
- * });
- * @desc Show a message before an AJAX request is sent.
- *
- * @name ajaxSend
- * @type jQuery
- * @param Function callback The function to execute.
- * @cat Ajax
- */
 jQuery.each( "ajaxStart,ajaxStop,ajaxComplete,ajaxError,ajaxSuccess,ajaxSend".split(","), function(i,o){
 	jQuery.fn[o] = function(f){
 		return this.bind(o, f);
 	};
 });
 
+var jsc = now();
+
 jQuery.extend({
-
-	/**
-	 * Load a remote page using an HTTP GET request.
-	 *
-	 * This is an easy way to send a simple GET request to a server
-	 * without having to use the more complex $.ajax function. It
-	 * allows a single callback function to be specified that will
-	 * be executed when the request is complete (and only if the response
-	 * has a successful response code). If you need to have both error
-	 * and success callbacks, you may want to use $.ajax.
-	 *
-	 * @example $.get("test.cgi");
-	 *
-	 * @example $.get("test.cgi", { name: "John", time: "2pm" } );
-	 *
-	 * @example $.get("test.cgi", function(data){
-	 *   alert("Data Loaded: " + data);
-	 * });
-	 *
-	 * @example $.get("test.cgi",
-	 *   { name: "John", time: "2pm" },
-	 *   function(data){
-	 *     alert("Data Loaded: " + data);
-	 *   }
-	 * );
-	 *
-	 * @name $.get
-	 * @type XMLHttpRequest
-	 * @param String url The URL of the page to load.
-	 * @param Map params (optional) Key/value pairs that will be sent to the server.
-	 * @param Function callback (optional) A function to be executed whenever the data is loaded successfully.
-	 * @cat Ajax
-	 */
-	get: function( url, data, callback, type, ifModified ) {
+	get: function( url, data, callback, type ) {
 		// shift arguments if data argument was ommited
 		if ( jQuery.isFunction( data ) ) {
 			callback = data;
 			data = null;
 		}
-		
+
 		return jQuery.ajax({
 			type: "GET",
 			url: url,
 			data: data,
 			success: callback,
-			dataType: type,
-			ifModified: ifModified
+			dataType: type
 		});
 	},
 
-	/**
-	 * Load a remote page using an HTTP GET request, only if it hasn't
-	 * been modified since it was last retrieved.
-	 *
-	 * @example $.getIfModified("test.html");
-	 *
-	 * @example $.getIfModified("test.html", { name: "John", time: "2pm" } );
-	 *
-	 * @example $.getIfModified("test.cgi", function(data){
-	 *   alert("Data Loaded: " + data);
-	 * });
-	 *
-	 * @example $.getifModified("test.cgi",
-	 *   { name: "John", time: "2pm" },
-	 *   function(data){
-	 *     alert("Data Loaded: " + data);
-	 *   }
-	 * );
-	 *
-	 * @name $.getIfModified
-	 * @type XMLHttpRequest
-	 * @param String url The URL of the page to load.
-	 * @param Map params (optional) Key/value pairs that will be sent to the server.
-	 * @param Function callback (optional) A function to be executed whenever the data is loaded successfully.
-	 * @cat Ajax
-	 */
-	getIfModified: function( url, data, callback, type ) {
-		return jQuery.get(url, data, callback, type, 1);
-	},
-
-	/**
-	 * Loads, and executes, a remote JavaScript file using an HTTP GET request.
-	 *
-	 * Warning: Safari <= 2.0.x is unable to evaluate scripts in a global
-	 * context synchronously. If you load functions via getScript, make sure
-	 * to call them after a delay.
-	 *
-	 * @example $.getScript("test.js");
-	 *
-	 * @example $.getScript("test.js", function(){
-	 *   alert("Script loaded and executed.");
-	 * });
-	 *
-	 * @name $.getScript
-	 * @type XMLHttpRequest
-	 * @param String url The URL of the page to load.
-	 * @param Function callback (optional) A function to be executed whenever the data is loaded successfully.
-	 * @cat Ajax
-	 */
 	getScript: function( url, callback ) {
 		return jQuery.get(url, null, callback, "script");
 	},
 
-	/**
-	 * Load JSON data using an HTTP GET request.
-	 *
-	 * @example $.getJSON("test.js", function(json){
-	 *   alert("JSON Data: " + json.users[3].name);
-	 * });
-	 *
-	 * @example $.getJSON("test.js",
-	 *   { name: "John", time: "2pm" },
-	 *   function(json){
-	 *     alert("JSON Data: " + json.users[3].name);
-	 *   }
-	 * );
-	 *
-	 * @name $.getJSON
-	 * @type XMLHttpRequest
-	 * @param String url The URL of the page to load.
-	 * @param Map params (optional) Key/value pairs that will be sent to the server.
-	 * @param Function callback A function to be executed whenever the data is loaded successfully.
-	 * @cat Ajax
-	 */
 	getJSON: function( url, data, callback ) {
 		return jQuery.get(url, data, callback, "json");
 	},
 
-	/**
-	 * Load a remote page using an HTTP POST request.
-	 *
-	 * @example $.post("test.cgi");
-	 *
-	 * @example $.post("test.cgi", { name: "John", time: "2pm" } );
-	 *
-	 * @example $.post("test.cgi", function(data){
-	 *   alert("Data Loaded: " + data);
-	 * });
-	 *
-	 * @example $.post("test.cgi",
-	 *   { name: "John", time: "2pm" },
-	 *   function(data){
-	 *     alert("Data Loaded: " + data);
-	 *   }
-	 * );
-	 *
-	 * @name $.post
-	 * @type XMLHttpRequest
-	 * @param String url The URL of the page to load.
-	 * @param Map params (optional) Key/value pairs that will be sent to the server.
-	 * @param Function callback (optional) A function to be executed whenever the data is loaded successfully.
-	 * @cat Ajax
-	 */
 	post: function( url, data, callback, type ) {
 		if ( jQuery.isFunction( data ) ) {
 			callback = data;
 			data = {};
 		}
@@ -4173,392 +2549,353 @@ jQuery.extend({
 			success: callback,
 			dataType: type
 		});
 	},
 
-	/**
-	 * Set the timeout in milliseconds of all AJAX requests to a specific amount of time.
-	 * This will make all future AJAX requests timeout after a specified amount
-	 * of time.
-	 *
-	 * Set to null or 0 to disable timeouts (default).
-	 *
-	 * You can manually abort requests with the XMLHttpRequest's (returned by
-	 * all ajax functions) abort() method.
-	 *
-	 * Deprecated. Use $.ajaxSetup instead.
-	 *
-	 * @example $.ajaxTimeout( 5000 );
-	 * @desc Make all AJAX requests timeout after 5 seconds.
-	 *
-	 * @name $.ajaxTimeout
-	 * @type undefined
-	 * @param Number time How long before an AJAX request times out, in milliseconds.
-	 * @cat Ajax
-	 */
-	ajaxTimeout: function( timeout ) {
-		jQuery.ajaxSettings.timeout = timeout;
-	},
-	
-	/**
-	 * Setup global settings for AJAX requests.
-	 *
-	 * See $.ajax for a description of all available options.
-	 *
-	 * @example $.ajaxSetup( {
-	 *   url: "/xmlhttp/",
-	 *   global: false,
-	 *   type: "POST"
-	 * } );
-	 * $.ajax({ data: myData });
-	 * @desc Sets the defaults for AJAX requests to the url "/xmlhttp/",
-	 * disables global handlers and uses POST instead of GET. The following
-	 * AJAX requests then sends some data without having to set anything else.
-	 *
-	 * @name $.ajaxSetup
-	 * @type undefined
-	 * @param Map settings Key/value pairs to use for all AJAX requests
-	 * @cat Ajax
-	 */
 	ajaxSetup: function( settings ) {
 		jQuery.extend( jQuery.ajaxSettings, settings );
 	},
 
 	ajaxSettings: {
+		url: location.href,
 		global: true,
 		type: "GET",
 		timeout: 0,
 		contentType: "application/x-www-form-urlencoded",
 		processData: true,
 		async: true,
-		data: null
+		data: null,
+		username: null,
+		password: null,
+		accepts: {
+			xml: "application/xml, text/xml",
+			html: "text/html",
+			script: "text/javascript, application/javascript",
+			json: "application/json, text/javascript",
+			text: "text/plain",
+			_default: "*/*"
+		}
 	},
-	
+
 	// Last-Modified header cache for next request
 	lastModified: {},
 
-	/**
-	 * Load a remote page using an HTTP request.
-	 *
-	 * This is jQuery's low-level AJAX implementation. See $.get, $.post etc. for
-	 * higher-level abstractions that are often easier to understand and use,
-	 * but don't offer as much functionality (such as error callbacks).
-	 *
-	 * $.ajax() returns the XMLHttpRequest that it creates. In most cases you won't
-	 * need that object to manipulate directly, but it is available if you need to
-	 * abort the request manually.
-	 *
-	 * '''Note:''' If you specify the dataType option described below, make sure
-	 * the server sends the correct MIME type in the response (eg. xml as "text/xml").
-	 * Sending the wrong MIME type can lead to unexpected problems in your script.
-	 * See [[Specifying the Data Type for AJAX Requests]] for more information.
-	 *
-	 * Supported datatypes are (see dataType option):
-	 *
-	 * "xml": Returns a XML document that can be processed via jQuery.
-	 *
-	 * "html": Returns HTML as plain text, included script tags are evaluated.
-	 *
-	 * "script": Evaluates the response as Javascript and returns it as plain text.
-	 *
-	 * "json": Evaluates the response as JSON and returns a Javascript Object
-	 *
-	 * $.ajax() takes one argument, an object of key/value pairs, that are
-	 * used to initalize and handle the request. These are all the key/values that can
-	 * be used:
-	 *
-	 * (String) url - The URL to request.
-	 *
-	 * (String) type - The type of request to make ("POST" or "GET"), default is "GET".
-	 *
-	 * (String) dataType - The type of data that you're expecting back from
-	 * the server. No default: If the server sends xml, the responseXML, otherwise
-	 * the responseText is passed to the success callback.
-	 *
-	 * (Boolean) ifModified - Allow the request to be successful only if the
-	 * response has changed since the last request. This is done by checking the
-	 * Last-Modified header. Default value is false, ignoring the header.
-	 *
-	 * (Number) timeout - Local timeout in milliseconds to override global timeout, eg. to give a
-	 * single request a longer timeout while all others timeout after 1 second.
-	 * See $.ajaxTimeout() for global timeouts.
-	 *
-	 * (Boolean) global - Whether to trigger global AJAX event handlers for
-	 * this request, default is true. Set to false to prevent that global handlers
-	 * like ajaxStart or ajaxStop are triggered.
-	 *
-	 * (Function) error - A function to be called if the request fails. The
-	 * function gets passed tree arguments: The XMLHttpRequest object, a
-	 * string describing the type of error that occurred and an optional
-	 * exception object, if one occured.
-	 *
-	 * (Function) success - A function to be called if the request succeeds. The
-	 * function gets passed one argument: The data returned from the server,
-	 * formatted according to the 'dataType' parameter.
-	 *
-	 * (Function) complete - A function to be called when the request finishes. The
-	 * function gets passed two arguments: The XMLHttpRequest object and a
-	 * string describing the type of success of the request.
-	 *
- 	 * (Object|String) data - Data to be sent to the server. Converted to a query
-	 * string, if not already a string. Is appended to the url for GET-requests.
-	 * See processData option to prevent this automatic processing.
-	 *
-	 * (String) contentType - When sending data to the server, use this content-type.
-	 * Default is "application/x-www-form-urlencoded", which is fine for most cases.
-	 *
-	 * (Boolean) processData - By default, data passed in to the data option as an object
-	 * other as string will be processed and transformed into a query string, fitting to
-	 * the default content-type "application/x-www-form-urlencoded". If you want to send
-	 * DOMDocuments, set this option to false.
-	 *
-	 * (Boolean) async - By default, all requests are sent asynchronous (set to true).
-	 * If you need synchronous requests, set this option to false.
-	 *
-	 * (Function) beforeSend - A pre-callback to set custom headers etc., the
-	 * XMLHttpRequest is passed as the only argument.
-	 *
-	 * @example $.ajax({
-	 *   type: "GET",
-	 *   url: "test.js",
-	 *   dataType: "script"
-	 * })
-	 * @desc Load and execute a JavaScript file.
-	 *
-	 * @example $.ajax({
-	 *   type: "POST",
-	 *   url: "some.php",
-	 *   data: "name=John&location=Boston",
-	 *   success: function(msg){
-	 *     alert( "Data Saved: " + msg );
-	 *   }
-	 * });
-	 * @desc Save some data to the server and notify the user once its complete.
-	 *
-	 * @example var html = $.ajax({
-	 *  url: "some.php",
-	 *  async: false
-	 * }).responseText;
-	 * @desc Loads data synchronously. Blocks the browser while the requests is active.
-	 * It is better to block user interaction by other means when synchronization is
-	 * necessary.
-	 *
-	 * @example var xmlDocument = [create xml document];
-	 * $.ajax({
-	 *   url: "page.php",
-	 *   processData: false,
-	 *   data: xmlDocument,
-	 *   success: handleResponse
-	 * });
-	 * @desc Sends an xml document as data to the server. By setting the processData
-	 * option to false, the automatic conversion of data to strings is prevented.
-	 * 
-	 * @name $.ajax
-	 * @type XMLHttpRequest
-	 * @param Map properties Key/value pairs to initialize the request with.
-	 * @cat Ajax
-	 * @see ajaxSetup(Map)
-	 */
 	ajax: function( s ) {
-		// TODO introduce global settings, allowing the client to modify them for all requests, not only timeout
-		s = jQuery.extend({}, jQuery.ajaxSettings, s);
+		// Extend the settings, but re-extend 's' so that it can be
+		// checked again later (in the test suite, specifically)
+		s = jQuery.extend(true, s, jQuery.extend(true, {}, jQuery.ajaxSettings, s));
 
-		// if data available
-		if ( s.data ) {
-			// convert data if not already a string
-			if (s.processData && typeof s.data != "string")
-    			s.data = jQuery.param(s.data);
-			// append data to url for get requests
-			if( s.type.toLowerCase() == "get" ) {
-				// "?" + data or "&" + data (in case there are already params)
-				s.url += ((s.url.indexOf("?") > -1) ? "&" : "?") + s.data;
-				// IE likes to send both get and post data, prevent this
-				s.data = null;
-			}
+		var jsonp, jsre = /=\?(&|$)/g, status, data,
+			type = s.type.toUpperCase();
+
+		// convert data if not already a string
+		if ( s.data && s.processData && typeof s.data != "string" )
+			s.data = jQuery.param(s.data);
+
+		// Handle JSONP Parameter Callbacks
+		if ( s.dataType == "jsonp" ) {
+			if ( type == "GET" ) {
+				if ( !s.url.match(jsre) )
+					s.url += (s.url.match(/\?/) ? "&" : "?") + (s.jsonp || "callback") + "=?";
+			} else if ( !s.data || !s.data.match(jsre) )
+				s.data = (s.data ? s.data + "&" : "") + (s.jsonp || "callback") + "=?";
+			s.dataType = "json";
+		}
+
+		// Build temporary JSONP function
+		if ( s.dataType == "json" && (s.data && s.data.match(jsre) || s.url.match(jsre)) ) {
+			jsonp = "jsonp" + jsc++;
+
+			// Replace the =? sequence both in the query string and the data
+			if ( s.data )
+				s.data = (s.data + "").replace(jsre, "=" + jsonp + "$1");
+			s.url = s.url.replace(jsre, "=" + jsonp + "$1");
+
+			// We need to make sure
+			// that a JSONP style response is executed properly
+			s.dataType = "script";
+
+			// Handle JSONP-style loading
+			window[ jsonp ] = function(tmp){
+				data = tmp;
+				success();
+				complete();
+				// Garbage collect
+				window[ jsonp ] = undefined;
+				try{ delete window[ jsonp ]; } catch(e){}
+				if ( head )
+					head.removeChild( script );
+			};
+		}
+
+		if ( s.dataType == "script" && s.cache == null )
+			s.cache = false;
+
+		if ( s.cache === false && type == "GET" ) {
+			var ts = now();
+			// try replacing _= if it is there
+			var ret = s.url.replace(/(\?|&)_=.*?(&|$)/, "$1_=" + ts + "$2");
+			// if nothing was replaced, add timestamp to the end
+			s.url = ret + ((ret == s.url) ? (s.url.match(/\?/) ? "&" : "?") + "_=" + ts : "");
+		}
+
+		// If data is available, append data to url for get requests
+		if ( s.data && type == "GET" ) {
+			s.url += (s.url.match(/\?/) ? "&" : "?") + s.data;
+
+			// IE likes to send both get and post data, prevent this
+			s.data = null;
 		}
 
 		// Watch for a new set of requests
 		if ( s.global && ! jQuery.active++ )
 			jQuery.event.trigger( "ajaxStart" );
 
+		// Matches an absolute URL, and saves the domain
+		var remote = /^(?:\w+:)?\/\/([^\/?#]+)/;
+
+		// If we're requesting a remote document
+		// and trying to load JSON or Script with a GET
+		if ( s.dataType == "script" && type == "GET"
+				&& remote.test(s.url) && remote.exec(s.url)[1] != location.host ){
+			var head = document.getElementsByTagName("head")[0];
+			var script = document.createElement("script");
+			script.src = s.url;
+			if (s.scriptCharset)
+				script.charset = s.scriptCharset;
+
+			// Handle Script loading
+			if ( !jsonp ) {
+				var done = false;
+
+				// Attach handlers for all browsers
+				script.onload = script.onreadystatechange = function(){
+					if ( !done && (!this.readyState ||
+							this.readyState == "loaded" || this.readyState == "complete") ) {
+						done = true;
+						success();
+						complete();
+						head.removeChild( script );
+					}
+				};
+			}
+
+			head.appendChild(script);
+
+			// We handle everything using the script element injection
+			return undefined;
+		}
+
 		var requestDone = false;
 
 		// Create the request object; Microsoft failed to properly
 		// implement the XMLHttpRequest in IE7, so we use the ActiveXObject when it is available
-		var xml = window.ActiveXObject ? new ActiveXObject("Microsoft.XMLHTTP") : new XMLHttpRequest();
+		var xhr = window.ActiveXObject ? new ActiveXObject("Microsoft.XMLHTTP") : new XMLHttpRequest();
 
 		// Open the socket
-		xml.open(s.type, s.url, s.async);
+		// Passing null username, generates a login popup on Opera (#2865)
+		if( s.username )
+			xhr.open(type, s.url, s.async, s.username, s.password);
+		else
+			xhr.open(type, s.url, s.async);
 
-		// Set the correct header, if data is being sent
-		if ( s.data )
-			xml.setRequestHeader("Content-Type", s.contentType);
+		// Need an extra try/catch for cross domain requests in Firefox 3
+		try {
+			// Set the correct header, if data is being sent
+			if ( s.data )
+				xhr.setRequestHeader("Content-Type", s.contentType);
 
-		// Set the If-Modified-Since header, if ifModified mode.
-		if ( s.ifModified )
-			xml.setRequestHeader("If-Modified-Since",
-				jQuery.lastModified[s.url] || "Thu, 01 Jan 1970 00:00:00 GMT" );
+			// Set the If-Modified-Since header, if ifModified mode.
+			if ( s.ifModified )
+				xhr.setRequestHeader("If-Modified-Since",
+					jQuery.lastModified[s.url] || "Thu, 01 Jan 1970 00:00:00 GMT" );
 
-		// Set header so the called script knows that it's an XMLHttpRequest
-		xml.setRequestHeader("X-Requested-With", "XMLHttpRequest");
+			// Set header so the called script knows that it's an XMLHttpRequest
+			xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
+
+			// Set the Accepts header for the server, depending on the dataType
+			xhr.setRequestHeader("Accept", s.dataType && s.accepts[ s.dataType ] ?
+				s.accepts[ s.dataType ] + ", */*" :
+				s.accepts._default );
+		} catch(e){}
 
 		// Allow custom headers/mimetypes
-		if( s.beforeSend )
-			s.beforeSend(xml);
-			
+		if ( s.beforeSend && s.beforeSend(xhr, s) === false ) {
+			// cleanup active request counter
+			s.global && jQuery.active--;
+			// close opended socket
+			xhr.abort();
+			return false;
+		}
+
 		if ( s.global )
-		    jQuery.event.trigger("ajaxSend", [xml, s]);
+			jQuery.event.trigger("ajaxSend", [xhr, s]);
 
 		// Wait for a response to come back
 		var onreadystatechange = function(isTimeout){
 			// The transfer is complete and the data is available, or the request timed out
-			if ( xml && (xml.readyState == 4 || isTimeout == "timeout") ) {
+			if ( !requestDone && xhr && (xhr.readyState == 4 || isTimeout == "timeout") ) {
 				requestDone = true;
-				
+
 				// clear poll interval
 				if (ival) {
 					clearInterval(ival);
 					ival = null;
 				}
-				
-				var status;
-				try {
-					status = jQuery.httpSuccess( xml ) && isTimeout != "timeout" ?
-						s.ifModified && jQuery.httpNotModified( xml, s.url ) ? "notmodified" : "success" : "error";
-					// Make sure that the request was successful or notmodified
-					if ( status != "error" ) {
-						// Cache Last-Modified header, if ifModified mode.
-						var modRes;
-						try {
-							modRes = xml.getResponseHeader("Last-Modified");
-						} catch(e) {} // swallow exception thrown by FF if header is not available
-	
-						if ( s.ifModified && modRes )
-							jQuery.lastModified[s.url] = modRes;
-	
+
+				status = isTimeout == "timeout" && "timeout" ||
+					!jQuery.httpSuccess( xhr ) && "error" ||
+					s.ifModified && jQuery.httpNotModified( xhr, s.url ) && "notmodified" ||
+					"success";
+
+				if ( status == "success" ) {
+					// Watch for, and catch, XML document parse errors
+					try {
 						// process the data (runs the xml through httpData regardless of callback)
-						var data = jQuery.httpData( xml, s.dataType );
-	
-						// If a local callback was specified, fire it and pass it the data
-						if ( s.success )
-							s.success( data, status );
-	
-						// Fire the global callback
-						if( s.global )
-							jQuery.event.trigger( "ajaxSuccess", [xml, s] );
-					} else
-						jQuery.handleError(s, xml, status);
-				} catch(e) {
-					status = "error";
-					jQuery.handleError(s, xml, status, e);
+						data = jQuery.httpData( xhr, s.dataType, s.dataFilter );
+					} catch(e) {
+						status = "parsererror";
+					}
 				}
 
-				// The request was completed
-				if( s.global )
-					jQuery.event.trigger( "ajaxComplete", [xml, s] );
+				// Make sure that the request was successful or notmodified
+				if ( status == "success" ) {
+					// Cache Last-Modified header, if ifModified mode.
+					var modRes;
+					try {
+						modRes = xhr.getResponseHeader("Last-Modified");
+					} catch(e) {} // swallow exception thrown by FF if header is not available
 
-				// Handle the global AJAX counter
-				if ( s.global && ! --jQuery.active )
-					jQuery.event.trigger( "ajaxStop" );
+					if ( s.ifModified && modRes )
+						jQuery.lastModified[s.url] = modRes;
 
-				// Process result
-				if ( s.complete )
-					s.complete(xml, status);
+					// JSONP handles its own success callback
+					if ( !jsonp )
+						success();
+				} else
+					jQuery.handleError(s, xhr, status);
+
+				// Fire the complete handlers
+				complete();
 
 				// Stop memory leaks
-				if(s.async)
-					xml = null;
+				if ( s.async )
+					xhr = null;
 			}
 		};
-		
-		// don't attach the handler to the request, just poll it instead
-		var ival = setInterval(onreadystatechange, 13); 
 
-		// Timeout checker
-		if ( s.timeout > 0 )
-			setTimeout(function(){
-				// Check to see if the request is still happening
-				if ( xml ) {
-					// Cancel the request
-					xml.abort();
+		if ( s.async ) {
+			// don't attach the handler to the request, just poll it instead
+			var ival = setInterval(onreadystatechange, 13);
 
-					if( !requestDone )
-						onreadystatechange( "timeout" );
-				}
-			}, s.timeout);
-			
+			// Timeout checker
+			if ( s.timeout > 0 )
+				setTimeout(function(){
+					// Check to see if the request is still happening
+					if ( xhr ) {
+						// Cancel the request
+						xhr.abort();
+
+						if( !requestDone )
+							onreadystatechange( "timeout" );
+					}
+				}, s.timeout);
+		}
+
 		// Send the data
 		try {
-			xml.send(s.data);
+			xhr.send(s.data);
 		} catch(e) {
-			jQuery.handleError(s, xml, null, e);
+			jQuery.handleError(s, xhr, null, e);
 		}
-		
+
 		// firefox 1.5 doesn't fire statechange for sync requests
 		if ( !s.async )
 			onreadystatechange();
-		
+
+		function success(){
+			// If a local callback was specified, fire it and pass it the data
+			if ( s.success )
+				s.success( data, status );
+
+			// Fire the global callback
+			if ( s.global )
+				jQuery.event.trigger( "ajaxSuccess", [xhr, s] );
+		}
+
+		function complete(){
+			// Process result
+			if ( s.complete )
+				s.complete(xhr, status);
+
+			// The request was completed
+			if ( s.global )
+				jQuery.event.trigger( "ajaxComplete", [xhr, s] );
+
+			// Handle the global AJAX counter
+			if ( s.global && ! --jQuery.active )
+				jQuery.event.trigger( "ajaxStop" );
+		}
+
 		// return XMLHttpRequest to allow aborting the request etc.
-		return xml;
+		return xhr;
 	},
 
-	handleError: function( s, xml, status, e ) {
+	handleError: function( s, xhr, status, e ) {
 		// If a local callback was specified, fire it
-		if ( s.error ) s.error( xml, status, e );
+		if ( s.error ) s.error( xhr, status, e );
 
 		// Fire the global callback
 		if ( s.global )
-			jQuery.event.trigger( "ajaxError", [xml, s, e] );
+			jQuery.event.trigger( "ajaxError", [xhr, s, e] );
 	},
 
 	// Counter for holding the number of active queries
 	active: 0,
 
 	// Determines if an XMLHttpRequest was successful or not
-	httpSuccess: function( r ) {
+	httpSuccess: function( xhr ) {
 		try {
-			return !r.status && location.protocol == "file:" ||
-				( r.status >= 200 && r.status < 300 ) || r.status == 304 ||
-				jQuery.browser.safari && r.status == undefined;
+			// IE error sometimes returns 1223 when it should be 204 so treat it as success, see #1450
+			return !xhr.status && location.protocol == "file:" ||
+				( xhr.status >= 200 && xhr.status < 300 ) || xhr.status == 304 || xhr.status == 1223 ||
+				jQuery.browser.safari && xhr.status == undefined;
 		} catch(e){}
 		return false;
 	},
 
 	// Determines if an XMLHttpRequest returns NotModified
-	httpNotModified: function( xml, url ) {
+	httpNotModified: function( xhr, url ) {
 		try {
-			var xmlRes = xml.getResponseHeader("Last-Modified");
+			var xhrRes = xhr.getResponseHeader("Last-Modified");
 
 			// Firefox always returns 200. check Last-Modified date
-			return xml.status == 304 || xmlRes == jQuery.lastModified[url] ||
-				jQuery.browser.safari && xml.status == undefined;
+			return xhr.status == 304 || xhrRes == jQuery.lastModified[url] ||
+				jQuery.browser.safari && xhr.status == undefined;
 		} catch(e){}
 		return false;
 	},
 
-	/* Get the data out of an XMLHttpRequest.
-	 * Return parsed XML if content-type header is "xml" and type is "xml" or omitted,
-	 * otherwise return plain text.
-	 * (String) data - The type of data that you're expecting back,
-	 * (e.g. "xml", "html", "script")
-	 */
-	httpData: function( r, type ) {
-		var ct = r.getResponseHeader("content-type");
-		var data = !type && ct && ct.indexOf("xml") >= 0;
-		data = type == "xml" || data ? r.responseXML : r.responseText;
+	httpData: function( xhr, type, filter ) {
+		var ct = xhr.getResponseHeader("content-type"),
+			xml = type == "xml" || !type && ct && ct.indexOf("xml") >= 0,
+			data = xml ? xhr.responseXML : xhr.responseText;
+
+		if ( xml && data.documentElement.tagName == "parsererror" )
+			throw "parsererror";
+			
+		// Allow a pre-filtering function to sanitize the response
+		if( filter )
+			data = filter( data, type );
 
 		// If the type is "script", eval it in global context
 		if ( type == "script" )
 			jQuery.globalEval( data );
 
 		// Get the JavaScript object, if JSON is used.
 		if ( type == "json" )
 			data = eval("(" + data + ")");
-
-		// evaluate scripts within html
-		if ( type == "html" )
-			jQuery("<div>").html(data).evalScripts();
 
 		return data;
 	},
 
 	// Serialize an array of form elements or a set of
@@ -4582,599 +2919,631 @@ jQuery.extend({
 				if ( a[j] && a[j].constructor == Array )
 					jQuery.each( a[j], function(){
 						s.push( encodeURIComponent(j) + "=" + encodeURIComponent( this ) );
 					});
 				else
-					s.push( encodeURIComponent(j) + "=" + encodeURIComponent( a[j] ) );
+					s.push( encodeURIComponent(j) + "=" + encodeURIComponent( jQuery.isFunction(a[j]) ? a[j]() : a[j] ) );
 
 		// Return the resulting serialization
-		return s.join("&");
-	},
-	
-	// evalulates a script in global context
-	// not reliable for safari
-	globalEval: function( data ) {
-		if ( window.execScript )
-			window.execScript( data );
-		else if ( jQuery.browser.safari )
-			// safari doesn't provide a synchronous global eval
-			window.setTimeout( data, 0 );
-		else
-			eval.call( window, data );
+		return s.join("&").replace(/%20/g, "+");
 	}
 
 });
 jQuery.fn.extend({
-
-	/**
-	 * Displays each of the set of matched elements if they are hidden.
-	 *
-	 * @example $("p").show()
-	 * @before <p style="display: none">Hello</p>
-	 * @result [ <p style="display: block">Hello</p> ]
-	 *
-	 * @name show
-	 * @type jQuery
-	 * @cat Effects
-	 */
-	
-	/**
-	 * Show all matched elements using a graceful animation and firing an
-	 * optional callback after completion.
-	 *
-	 * The height, width, and opacity of each of the matched elements 
-	 * are changed dynamically according to the specified speed.
-	 *
-	 * @example $("p").show("slow");
-	 *
-	 * @example $("p").show("slow",function(){
-	 *   alert("Animation Done.");
-	 * });
-	 *
-	 * @name show
-	 * @type jQuery
-	 * @param String|Number speed A string representing one of the three predefined speeds ("slow", "normal", or "fast") or the number of milliseconds to run the animation (e.g. 1000).
-	 * @param Function callback (optional) A function to be executed whenever the animation completes.
-	 * @cat Effects
-	 * @see hide(String|Number,Function)
-	 */
 	show: function(speed,callback){
 		return speed ?
 			this.animate({
 				height: "show", width: "show", opacity: "show"
 			}, speed, callback) :
-			
+
 			this.filter(":hidden").each(function(){
-				this.style.display = this.oldblock ? this.oldblock : "";
-				if ( jQuery.css(this,"display") == "none" )
-					this.style.display = "block";
+				this.style.display = this.oldblock || "";
+				if ( jQuery.css(this,"display") == "none" ) {
+					var elem = jQuery("<" + this.tagName + " />").appendTo("body");
+					this.style.display = elem.css("display");
+					// handle an edge condition where css is - div { display:none; } or similar
+					if (this.style.display == "none")
+						this.style.display = "block";
+					elem.remove();
+				}
 			}).end();
 	},
-	
-	/**
-	 * Hides each of the set of matched elements if they are shown.
-	 *
-	 * @example $("p").hide()
-	 * @before <p>Hello</p>
-	 * @result [ <p style="display: none">Hello</p> ]
-	 *
-	 * @name hide
-	 * @type jQuery
-	 * @cat Effects
-	 */
-	
-	/**
-	 * Hide all matched elements using a graceful animation and firing an
-	 * optional callback after completion.
-	 *
-	 * The height, width, and opacity of each of the matched elements 
-	 * are changed dynamically according to the specified speed.
-	 *
-	 * @example $("p").hide("slow");
-	 *
-	 * @example $("p").hide("slow",function(){
-	 *   alert("Animation Done.");
-	 * });
-	 *
-	 * @name hide
-	 * @type jQuery
-	 * @param String|Number speed A string representing one of the three predefined speeds ("slow", "normal", or "fast") or the number of milliseconds to run the animation (e.g. 1000).
-	 * @param Function callback (optional) A function to be executed whenever the animation completes.
-	 * @cat Effects
-	 * @see show(String|Number,Function)
-	 */
+
 	hide: function(speed,callback){
 		return speed ?
 			this.animate({
 				height: "hide", width: "hide", opacity: "hide"
 			}, speed, callback) :
-			
+
 			this.filter(":visible").each(function(){
 				this.oldblock = this.oldblock || jQuery.css(this,"display");
-				if ( this.oldblock == "none" )
-					this.oldblock = "block";
 				this.style.display = "none";
 			}).end();
 	},
 
 	// Save the old toggle function
 	_toggle: jQuery.fn.toggle,
-	
-	/**
-	 * Toggles each of the set of matched elements. If they are shown,
-	 * toggle makes them hidden. If they are hidden, toggle
-	 * makes them shown.
-	 *
-	 * @example $("p").toggle()
-	 * @before <p>Hello</p><p style="display: none">Hello Again</p>
-	 * @result [ <p style="display: none">Hello</p>, <p style="display: block">Hello Again</p> ]
-	 *
-	 * @name toggle
-	 * @type jQuery
-	 * @cat Effects
-	 */
+
 	toggle: function( fn, fn2 ){
 		return jQuery.isFunction(fn) && jQuery.isFunction(fn2) ?
-			this._toggle( fn, fn2 ) :
+			this._toggle.apply( this, arguments ) :
 			fn ?
 				this.animate({
 					height: "toggle", width: "toggle", opacity: "toggle"
 				}, fn, fn2) :
 				this.each(function(){
 					jQuery(this)[ jQuery(this).is(":hidden") ? "show" : "hide" ]();
 				});
 	},
-	
-	/**
-	 * Reveal all matched elements by adjusting their height and firing an
-	 * optional callback after completion.
-	 *
-	 * Only the height is adjusted for this animation, causing all matched
-	 * elements to be revealed in a "sliding" manner.
-	 *
-	 * @example $("p").slideDown("slow");
-	 *
-	 * @example $("p").slideDown("slow",function(){
-	 *   alert("Animation Done.");
-	 * });
-	 *
-	 * @name slideDown
-	 * @type jQuery
-	 * @param String|Number speed (optional) A string representing one of the three predefined speeds ("slow", "normal", or "fast") or the number of milliseconds to run the animation (e.g. 1000).
-	 * @param Function callback (optional) A function to be executed whenever the animation completes.
-	 * @cat Effects
-	 * @see slideUp(String|Number,Function)
-	 * @see slideToggle(String|Number,Function)
-	 */
+
 	slideDown: function(speed,callback){
 		return this.animate({height: "show"}, speed, callback);
 	},
-	
-	/**
-	 * Hide all matched elements by adjusting their height and firing an
-	 * optional callback after completion.
-	 *
-	 * Only the height is adjusted for this animation, causing all matched
-	 * elements to be hidden in a "sliding" manner.
-	 *
-	 * @example $("p").slideUp("slow");
-	 *
-	 * @example $("p").slideUp("slow",function(){
-	 *   alert("Animation Done.");
-	 * });
-	 *
-	 * @name slideUp
-	 * @type jQuery
-	 * @param String|Number speed (optional) A string representing one of the three predefined speeds ("slow", "normal", or "fast") or the number of milliseconds to run the animation (e.g. 1000).
-	 * @param Function callback (optional) A function to be executed whenever the animation completes.
-	 * @cat Effects
-	 * @see slideDown(String|Number,Function)
-	 * @see slideToggle(String|Number,Function)
-	 */
+
 	slideUp: function(speed,callback){
 		return this.animate({height: "hide"}, speed, callback);
 	},
 
-	/**
-	 * Toggle the visibility of all matched elements by adjusting their height and firing an
-	 * optional callback after completion.
-	 *
-	 * Only the height is adjusted for this animation, causing all matched
-	 * elements to be hidden in a "sliding" manner.
-	 *
-	 * @example $("p").slideToggle("slow");
-	 *
-	 * @example $("p").slideToggle("slow",function(){
-	 *   alert("Animation Done.");
-	 * });
-	 *
-	 * @name slideToggle
-	 * @type jQuery
-	 * @param String|Number speed (optional) A string representing one of the three predefined speeds ("slow", "normal", or "fast") or the number of milliseconds to run the animation (e.g. 1000).
-	 * @param Function callback (optional) A function to be executed whenever the animation completes.
-	 * @cat Effects
-	 * @see slideDown(String|Number,Function)
-	 * @see slideUp(String|Number,Function)
-	 */
 	slideToggle: function(speed, callback){
 		return this.animate({height: "toggle"}, speed, callback);
 	},
-	
-	/**
-	 * Fade in all matched elements by adjusting their opacity and firing an
-	 * optional callback after completion.
-	 *
-	 * Only the opacity is adjusted for this animation, meaning that
-	 * all of the matched elements should already have some form of height
-	 * and width associated with them.
-	 *
-	 * @example $("p").fadeIn("slow");
-	 *
-	 * @example $("p").fadeIn("slow",function(){
-	 *   alert("Animation Done.");
-	 * });
-	 *
-	 * @name fadeIn
-	 * @type jQuery
-	 * @param String|Number speed (optional) A string representing one of the three predefined speeds ("slow", "normal", or "fast") or the number of milliseconds to run the animation (e.g. 1000).
-	 * @param Function callback (optional) A function to be executed whenever the animation completes.
-	 * @cat Effects
-	 * @see fadeOut(String|Number,Function)
-	 * @see fadeTo(String|Number,Number,Function)
-	 */
+
 	fadeIn: function(speed, callback){
 		return this.animate({opacity: "show"}, speed, callback);
 	},
-	
-	/**
-	 * Fade out all matched elements by adjusting their opacity and firing an
-	 * optional callback after completion.
-	 *
-	 * Only the opacity is adjusted for this animation, meaning that
-	 * all of the matched elements should already have some form of height
-	 * and width associated with them.
-	 *
-	 * @example $("p").fadeOut("slow");
-	 *
-	 * @example $("p").fadeOut("slow",function(){
-	 *   alert("Animation Done.");
-	 * });
-	 *
-	 * @name fadeOut
-	 * @type jQuery
-	 * @param String|Number speed (optional) A string representing one of the three predefined speeds ("slow", "normal", or "fast") or the number of milliseconds to run the animation (e.g. 1000).
-	 * @param Function callback (optional) A function to be executed whenever the animation completes.
-	 * @cat Effects
-	 * @see fadeIn(String|Number,Function)
-	 * @see fadeTo(String|Number,Number,Function)
-	 */
+
 	fadeOut: function(speed, callback){
 		return this.animate({opacity: "hide"}, speed, callback);
 	},
-	
-	/**
-	 * Fade the opacity of all matched elements to a specified opacity and firing an
-	 * optional callback after completion.
-	 *
-	 * Only the opacity is adjusted for this animation, meaning that
-	 * all of the matched elements should already have some form of height
-	 * and width associated with them.
-	 *
-	 * @example $("p").fadeTo("slow", 0.5);
-	 *
-	 * @example $("p").fadeTo("slow", 0.5, function(){
-	 *   alert("Animation Done.");
-	 * });
-	 *
-	 * @name fadeTo
-	 * @type jQuery
-	 * @param String|Number speed A string representing one of the three predefined speeds ("slow", "normal", or "fast") or the number of milliseconds to run the animation (e.g. 1000).
-	 * @param Number opacity The opacity to fade to (a number from 0 to 1).
-	 * @param Function callback (optional) A function to be executed whenever the animation completes.
-	 * @cat Effects
-	 * @see fadeIn(String|Number,Function)
-	 * @see fadeOut(String|Number,Function)
-	 */
+
 	fadeTo: function(speed,to,callback){
 		return this.animate({opacity: to}, speed, callback);
 	},
-	
-	/**
-	 * A function for making your own, custom animations. The key aspect of
-	 * this function is the object of style properties that will be animated,
-	 * and to what end. Each key within the object represents a style property
-	 * that will also be animated (for example: "height", "top", or "opacity").
-	 *
-	 * Note that properties should be specified using camel case
-	 * eg. marginLeft instead of margin-left.
-	 *
-	 * The value associated with the key represents to what end the property
-	 * will be animated. If a number is provided as the value, then the style
-	 * property will be transitioned from its current state to that new number.
-	 * Otherwise if the string "hide", "show", or "toggle" is provided, a default
-	 * animation will be constructed for that property.
-	 *
-	 * @example $("p").animate({
-	 *   height: 'toggle', opacity: 'toggle'
-	 * }, "slow");
-	 *
-	 * @example $("p").animate({
-	 *   left: 50, opacity: 'show'
-	 * }, 500);
-	 *
-	 * @example $("p").animate({
-	 *   opacity: 'show'
-	 * }, "slow", "easein");
-	 * @desc An example of using an 'easing' function to provide a different style of animation. This will only work if you have a plugin that provides this easing function (Only "swing" and "linear" are provided by default, with jQuery).
-	 *
-	 * @name animate
-	 * @type jQuery
-	 * @param Hash params A set of style attributes that you wish to animate, and to what end.
-	 * @param String|Number speed (optional) A string representing one of the three predefined speeds ("slow", "normal", or "fast") or the number of milliseconds to run the animation (e.g. 1000).
-	 * @param String easing (optional) The name of the easing effect that you want to use (e.g. "swing" or "linear"). Defaults to "swing".
-	 * @param Function callback (optional) A function to be executed whenever the animation completes.
-	 * @cat Effects
-	 */
+
 	animate: function( prop, speed, easing, callback ) {
-		return this.queue(function(){
-			var hidden = jQuery(this).is(":hidden"),
-				opt = jQuery.speed(speed, easing, callback),
-				self = this;
-			
-			for ( var p in prop )
+		var optall = jQuery.speed(speed, easing, callback);
+
+		return this[ optall.queue === false ? "each" : "queue" ](function(){
+			if ( this.nodeType != 1)
+				return false;
+
+			var opt = jQuery.extend({}, optall), p,
+				hidden = jQuery(this).is(":hidden"), self = this;
+
+			for ( p in prop ) {
 				if ( prop[p] == "hide" && hidden || prop[p] == "show" && !hidden )
-					return jQuery.isFunction(opt.complete) && opt.complete.apply(this);
+					return opt.complete.call(this);
 
-			this.curAnim = jQuery.extend({}, prop);
-			
+				if ( p == "height" || p == "width" ) {
+					// Store display property
+					opt.display = jQuery.css(this, "display");
+
+					// Make sure that nothing sneaks out
+					opt.overflow = this.style.overflow;
+				}
+			}
+
+			if ( opt.overflow != null )
+				this.style.overflow = "hidden";
+
+			opt.curAnim = jQuery.extend({}, prop);
+
 			jQuery.each( prop, function(name, val){
 				var e = new jQuery.fx( self, opt, name );
-				if ( val.constructor == Number )
-					e.custom( e.cur(), val );
-				else
+
+				if ( /toggle|show|hide/.test(val) )
 					e[ val == "toggle" ? hidden ? "show" : "hide" : val ]( prop );
+				else {
+					var parts = val.toString().match(/^([+-]=)?([\d+-.]+)(.*)$/),
+						start = e.cur(true) || 0;
+
+					if ( parts ) {
+						var end = parseFloat(parts[2]),
+							unit = parts[3] || "px";
+
+						// We need to compute starting value
+						if ( unit != "px" ) {
+							self.style[ name ] = (end || 1) + unit;
+							start = ((end || 1) / e.cur(true)) * start;
+							self.style[ name ] = start + unit;
+						}
+
+						// If a +=/-= token was provided, we're doing a relative animation
+						if ( parts[1] )
+							end = ((parts[1] == "-=" ? -1 : 1) * end) + start;
+
+						e.custom( start, end, unit );
+					} else
+						e.custom( start, val, "" );
+				}
 			});
+
+			// For JS strict compliance
+			return true;
 		});
 	},
-	
-	/**
-	 *
-	 * @private
-	 */
-	queue: function(type,fn){
-		if ( !fn ) {
+
+	queue: function(type, fn){
+		if ( jQuery.isFunction(type) || ( type && type.constructor == Array )) {
 			fn = type;
 			type = "fx";
 		}
-	
+
+		if ( !type || (typeof type == "string" && !fn) )
+			return queue( this[0], type );
+
 		return this.each(function(){
-			if ( !this.queue )
-				this.queue = {};
-	
-			if ( !this.queue[type] )
-				this.queue[type] = [];
-	
-			this.queue[type].push( fn );
-		
-			if ( this.queue[type].length == 1 )
-				fn.apply(this);
+			if ( fn.constructor == Array )
+				queue(this, type, fn);
+			else {
+				queue(this, type).push( fn );
+
+				if ( queue(this, type).length == 1 )
+					fn.call(this);
+			}
 		});
+	},
+
+	stop: function(clearQueue, gotoEnd){
+		var timers = jQuery.timers;
+
+		if (clearQueue)
+			this.queue([]);
+
+		this.each(function(){
+			// go in reverse order so anything added to the queue during the loop is ignored
+			for ( var i = timers.length - 1; i >= 0; i-- )
+				if ( timers[i].elem == this ) {
+					if (gotoEnd)
+						// force the next step to be the last
+						timers[i](true);
+					timers.splice(i, 1);
+				}
+		});
+
+		// start the next in the queue if the last step wasn't forced
+		if (!gotoEnd)
+			this.dequeue();
+
+		return this;
 	}
 
 });
 
+var queue = function( elem, type, array ) {
+	if ( elem ){
+
+		type = type || "fx";
+
+		var q = jQuery.data( elem, type + "queue" );
+
+		if ( !q || array )
+			q = jQuery.data( elem, type + "queue", jQuery.makeArray(array) );
+
+	}
+	return q;
+};
+
+jQuery.fn.dequeue = function(type){
+	type = type || "fx";
+
+	return this.each(function(){
+		var q = queue(this, type);
+
+		q.shift();
+
+		if ( q.length )
+			q[0].call( this );
+	});
+};
+
 jQuery.extend({
-	
+
 	speed: function(speed, easing, fn) {
 		var opt = speed && speed.constructor == Object ? speed : {
-			complete: fn || !fn && easing || 
+			complete: fn || !fn && easing ||
 				jQuery.isFunction( speed ) && speed,
 			duration: speed,
-			easing: fn && easing || easing && easing.constructor != Function && easing || (jQuery.easing.swing ? "swing" : "linear")
+			easing: fn && easing || easing && easing.constructor != Function && easing
 		};
 
-		opt.duration = (opt.duration && opt.duration.constructor == Number ? 
-			opt.duration : 
-			{ slow: 600, fast: 200 }[opt.duration]) || 400;
-	
+		opt.duration = (opt.duration && opt.duration.constructor == Number ?
+			opt.duration :
+			jQuery.fx.speeds[opt.duration]) || jQuery.fx.speeds.def;
+
 		// Queueing
 		opt.old = opt.complete;
 		opt.complete = function(){
-			jQuery.dequeue(this, "fx");
+			if ( opt.queue !== false )
+				jQuery(this).dequeue();
 			if ( jQuery.isFunction( opt.old ) )
-				opt.old.apply( this );
+				opt.old.call( this );
 		};
-	
+
 		return opt;
 	},
-	
+
 	easing: {
 		linear: function( p, n, firstNum, diff ) {
 			return firstNum + diff * p;
 		},
 		swing: function( p, n, firstNum, diff ) {
 			return ((-Math.cos(p*Math.PI)/2) + 0.5) * diff + firstNum;
 		}
 	},
-	
-	queue: {},
-	
-	dequeue: function(elem,type){
-		type = type || "fx";
-	
-		if ( elem.queue && elem.queue[type] ) {
-			// Remove self
-			elem.queue[type].shift();
-	
-			// Get next function
-			var f = elem.queue[type][0];
-		
-			if ( f ) f.apply( elem );
+
+	timers: [],
+	timerId: null,
+
+	fx: function( elem, options, prop ){
+		this.options = options;
+		this.elem = elem;
+		this.prop = prop;
+
+		if ( !options.orig )
+			options.orig = {};
+	}
+
+});
+
+jQuery.fx.prototype = {
+
+	// Simple function for setting a style value
+	update: function(){
+		if ( this.options.step )
+			this.options.step.call( this.elem, this.now, this );
+
+		(jQuery.fx.step[this.prop] || jQuery.fx.step._default)( this );
+
+		// Set display property to block for height/width animations
+		if ( this.prop == "height" || this.prop == "width" )
+			this.elem.style.display = "block";
+	},
+
+	// Get the current size
+	cur: function(force){
+		if ( this.elem[this.prop] != null && this.elem.style[this.prop] == null )
+			return this.elem[ this.prop ];
+
+		var r = parseFloat(jQuery.css(this.elem, this.prop, force));
+		return r && r > -10000 ? r : parseFloat(jQuery.curCSS(this.elem, this.prop)) || 0;
+	},
+
+	// Start an animation from one number to another
+	custom: function(from, to, unit){
+		this.startTime = now();
+		this.start = from;
+		this.end = to;
+		this.unit = unit || this.unit || "px";
+		this.now = this.start;
+		this.pos = this.state = 0;
+		this.update();
+
+		var self = this;
+		function t(gotoEnd){
+			return self.step(gotoEnd);
+		}
+
+		t.elem = this.elem;
+
+		jQuery.timers.push(t);
+
+		if ( jQuery.timerId == null ) {
+			jQuery.timerId = setInterval(function(){
+				var timers = jQuery.timers;
+
+				for ( var i = 0; i < timers.length; i++ )
+					if ( !timers[i]() )
+						timers.splice(i--, 1);
+
+				if ( !timers.length ) {
+					clearInterval( jQuery.timerId );
+					jQuery.timerId = null;
+				}
+			}, 13);
 		}
 	},
 
-	timers: [],
+	// Simple 'show' function
+	show: function(){
+		// Remember where we started, so that we can go back to it later
+		this.options.orig[this.prop] = jQuery.attr( this.elem.style, this.prop );
+		this.options.show = true;
 
-	/*
-	 * I originally wrote fx() as a clone of moo.fx and in the process
-	 * of making it small in size the code became illegible to sane
-	 * people. You've been warned.
-	 */
-	
-	fx: function( elem, options, prop ){
+		// Begin the animation
+		this.custom(0, this.cur());
 
-		var z = this;
+		// Make sure that we start at a small width/height to avoid any
+		// flash of content
+		if ( this.prop == "width" || this.prop == "height" )
+			this.elem.style[this.prop] = "1px";
 
-		// The styles
-		var y = elem.style;
-		
-		if ( prop == "height" || prop == "width" ) {
-			// Store display property
-			var oldDisplay = jQuery.css(elem, "display");
+		// Start by showing the element
+		jQuery(this.elem).show();
+	},
 
-			// Make sure that nothing sneaks out
-			var oldOverflow = y.overflow;
-			y.overflow = "hidden";
+	// Simple 'hide' function
+	hide: function(){
+		// Remember where we started, so that we can go back to it later
+		this.options.orig[this.prop] = jQuery.attr( this.elem.style, this.prop );
+		this.options.hide = true;
+
+		// Begin the animation
+		this.custom(this.cur(), 0);
+	},
+
+	// Each step of an animation
+	step: function(gotoEnd){
+		var t = now();
+
+		if ( gotoEnd || t > this.options.duration + this.startTime ) {
+			this.now = this.end;
+			this.pos = this.state = 1;
+			this.update();
+
+			this.options.curAnim[ this.prop ] = true;
+
+			var done = true;
+			for ( var i in this.options.curAnim )
+				if ( this.options.curAnim[i] !== true )
+					done = false;
+
+			if ( done ) {
+				if ( this.options.display != null ) {
+					// Reset the overflow
+					this.elem.style.overflow = this.options.overflow;
+
+					// Reset the display
+					this.elem.style.display = this.options.display;
+					if ( jQuery.css(this.elem, "display") == "none" )
+						this.elem.style.display = "block";
+				}
+
+				// Hide the element if the "hide" operation was done
+				if ( this.options.hide )
+					this.elem.style.display = "none";
+
+				// Reset the properties, if the item has been hidden or shown
+				if ( this.options.hide || this.options.show )
+					for ( var p in this.options.curAnim )
+						jQuery.attr(this.elem.style, p, this.options.orig[p]);
+			}
+
+			if ( done )
+				// Execute the complete function
+				this.options.complete.call( this.elem );
+
+			return false;
+		} else {
+			var n = t - this.startTime;
+			this.state = n / this.options.duration;
+
+			// Perform the easing function, defaults to swing
+			this.pos = jQuery.easing[this.options.easing || (jQuery.easing.swing ? "swing" : "linear")](this.state, n, 0, 1, this.options.duration);
+			this.now = this.start + ((this.end - this.start) * this.pos);
+
+			// Perform the next step of the animation
+			this.update();
 		}
 
-		// Simple function for setting a style value
-		z.a = function(){
-			if ( options.step )
-				options.step.apply( elem, [ z.now ] );
+		return true;
+	}
 
-			if ( prop == "opacity" )
-				jQuery.attr(y, "opacity", z.now); // Let attr handle opacity
-			else {
-				y[prop] = parseInt(z.now) + "px";
-				y.display = "block"; // Set display property to block for animation
-			}
-		};
+};
 
-		// Figure out the maximum number to run to
-		z.max = function(){
-			return parseFloat( jQuery.css(elem,prop) );
-		};
+jQuery.extend( jQuery.fx, {
+	speeds:{
+		slow: 600,
+ 		fast: 200,
+ 		// Default speed
+ 		def: 400
+	},
+	step: {
+		scrollLeft: function(fx){
+			fx.elem.scrollLeft = fx.now;
+		},
 
-		// Get the current size
-		z.cur = function(){
-			var r = parseFloat( jQuery.curCSS(elem, prop) );
-			return r && r > -10000 ? r : z.max();
-		};
+		scrollTop: function(fx){
+			fx.elem.scrollTop = fx.now;
+		},
 
-		// Start an animation from one number to another
-		z.custom = function(from,to){
-			z.startTime = (new Date()).getTime();
-			z.now = from;
-			z.a();
+		opacity: function(fx){
+			jQuery.attr(fx.elem.style, "opacity", fx.now);
+		},
 
-			jQuery.timers.push(function(){
-				return z.step(from, to);
-			});
+		_default: function(fx){
+			fx.elem.style[ fx.prop ] = fx.now + fx.unit;
+		}
+	}
+});
+// The Offset Method
+// Originally By Brandon Aaron, part of the Dimension Plugin
+// http://jquery.com/plugins/project/dimensions
+jQuery.fn.offset = function() {
+	var left = 0, top = 0, elem = this[0], results;
 
-			if ( jQuery.timers.length == 1 ) {
-				var timer = setInterval(function(){
-					var timers = jQuery.timers;
-					
-					for ( var i = 0; i < timers.length; i++ )
-						if ( !timers[i]() )
-							timers.splice(i--, 1);
+	if ( elem ) with ( jQuery.browser ) {
+		var parent       = elem.parentNode,
+		    offsetChild  = elem,
+		    offsetParent = elem.offsetParent,
+		    doc          = elem.ownerDocument,
+		    safari2      = safari && parseInt(version) < 522 && !/adobeair/i.test(userAgent),
+		    css          = jQuery.curCSS,
+		    fixed        = css(elem, "position") == "fixed";
 
-					if ( !timers.length )
-						clearInterval( timer );
-				}, 13);
-			}
-		};
+		// Use getBoundingClientRect if available
+		if ( elem.getBoundingClientRect ) {
+			var box = elem.getBoundingClientRect();
 
-		// Simple 'show' function
-		z.show = function(){
-			if ( !elem.orig ) elem.orig = {};
+			// Add the document scroll offsets
+			add(box.left + Math.max(doc.documentElement.scrollLeft, doc.body.scrollLeft),
+				box.top  + Math.max(doc.documentElement.scrollTop,  doc.body.scrollTop));
 
-			// Remember where we started, so that we can go back to it later
-			elem.orig[prop] = jQuery.attr( elem.style, prop );
+			// IE adds the HTML element's border, by default it is medium which is 2px
+			// IE 6 and 7 quirks mode the border width is overwritable by the following css html { border: 0; }
+			// IE 7 standards mode, the border is always 2px
+			// This border/offset is typically represented by the clientLeft and clientTop properties
+			// However, in IE6 and 7 quirks mode the clientLeft and clientTop properties are not updated when overwriting it via CSS
+			// Therefore this method will be off by 2px in IE while in quirksmode
+			add( -doc.documentElement.clientLeft, -doc.documentElement.clientTop );
 
-			options.show = true;
+		// Otherwise loop through the offsetParents and parentNodes
+		} else {
 
-			// Begin the animation
-			z.custom(0, this.cur());
+			// Initial element offsets
+			add( elem.offsetLeft, elem.offsetTop );
 
-			// Make sure that we start at a small width/height to avoid any
-			// flash of content
-			if ( prop != "opacity" )
-				y[prop] = "1px";
-			
-			// Start by showing the element
-			jQuery(elem).show();
-		};
+			// Get parent offsets
+			while ( offsetParent ) {
+				// Add offsetParent offsets
+				add( offsetParent.offsetLeft, offsetParent.offsetTop );
 
-		// Simple 'hide' function
-		z.hide = function(){
-			if ( !elem.orig ) elem.orig = {};
+				// Mozilla and Safari > 2 does not include the border on offset parents
+				// However Mozilla adds the border for table or table cells
+				if ( mozilla && !/^t(able|d|h)$/i.test(offsetParent.tagName) || safari && !safari2 )
+					border( offsetParent );
 
-			// Remember where we started, so that we can go back to it later
-			elem.orig[prop] = jQuery.attr( elem.style, prop );
+				// Add the document scroll offsets if position is fixed on any offsetParent
+				if ( !fixed && css(offsetParent, "position") == "fixed" )
+					fixed = true;
 
-			options.hide = true;
-
-			// Begin the animation
-			z.custom(this.cur(), 0);
-		};
-
-		// Each step of an animation
-		z.step = function(firstNum, lastNum){
-			var t = (new Date()).getTime();
-
-			if (t > options.duration + z.startTime) {
-				z.now = lastNum;
-				z.a();
-
-				if (elem.curAnim) elem.curAnim[ prop ] = true;
-
-				var done = true;
-				for ( var i in elem.curAnim )
-					if ( elem.curAnim[i] !== true )
-						done = false;
-
-				if ( done ) {
-					if ( oldDisplay != null ) {
-						// Reset the overflow
-						y.overflow = oldOverflow;
-					
-						// Reset the display
-						y.display = oldDisplay;
-						if ( jQuery.css(elem, "display") == "none" )
-							y.display = "block";
-					}
-
-					// Hide the element if the "hide" operation was done
-					if ( options.hide )
-						y.display = "none";
-
-					// Reset the properties, if the item has been hidden or shown
-					if ( options.hide || options.show )
-						for ( var p in elem.curAnim )
-							jQuery.attr(y, p, elem.orig[p]);
-				}
-
-				// If a callback was provided, execute it
-				if ( done && jQuery.isFunction( options.complete ) )
-					// Execute the complete function
-					options.complete.apply( elem );
-
-				return false;
-			} else {
-				var n = t - this.startTime;
-				// Figure out where in the animation we are and set the number
-				var p = n / options.duration;
-				
-				// Perform the easing function, defaults to swing
-				z.now = jQuery.easing[options.easing](p, n, firstNum, (lastNum-firstNum), options.duration);
-
-				// Perform the next step of the animation
-				z.a();
+				// Set offsetChild to previous offsetParent unless it is the body element
+				offsetChild  = /^body$/i.test(offsetParent.tagName) ? offsetChild : offsetParent;
+				// Get next offsetParent
+				offsetParent = offsetParent.offsetParent;
 			}
 
-			return true;
-		};
-	
+			// Get parent scroll offsets
+			while ( parent && parent.tagName && !/^body|html$/i.test(parent.tagName) ) {
+				// Remove parent scroll UNLESS that parent is inline or a table to work around Opera inline/table scrollLeft/Top bug
+				if ( !/^inline|table.*$/i.test(css(parent, "display")) )
+					// Subtract parent scroll offsets
+					add( -parent.scrollLeft, -parent.scrollTop );
+
+				// Mozilla does not add the border for a parent that has overflow != visible
+				if ( mozilla && css(parent, "overflow") != "visible" )
+					border( parent );
+
+				// Get next parent
+				parent = parent.parentNode;
+			}
+
+			// Safari <= 2 doubles body offsets with a fixed position element/offsetParent or absolutely positioned offsetChild
+			// Mozilla doubles body offsets with a non-absolutely positioned offsetChild
+			if ( (safari2 && (fixed || css(offsetChild, "position") == "absolute")) ||
+				(mozilla && css(offsetChild, "position") != "absolute") )
+					add( -doc.body.offsetLeft, -doc.body.offsetTop );
+
+			// Add the document scroll offsets if position is fixed
+			if ( fixed )
+				add(Math.max(doc.documentElement.scrollLeft, doc.body.scrollLeft),
+					Math.max(doc.documentElement.scrollTop,  doc.body.scrollTop));
+		}
+
+		// Return an object with top and left properties
+		results = { top: top, left: left };
+	}
+
+	function border(elem) {
+		add( jQuery.curCSS(elem, "borderLeftWidth", true), jQuery.curCSS(elem, "borderTopWidth", true) );
+	}
+
+	function add(l, t) {
+		left += parseInt(l, 10) || 0;
+		top += parseInt(t, 10) || 0;
+	}
+
+	return results;
+};
+
+
+jQuery.fn.extend({
+	position: function() {
+		var left = 0, top = 0, results;
+
+		if ( this[0] ) {
+			// Get *real* offsetParent
+			var offsetParent = this.offsetParent(),
+
+			// Get correct offsets
+			offset       = this.offset(),
+			parentOffset = /^body|html$/i.test(offsetParent[0].tagName) ? { top: 0, left: 0 } : offsetParent.offset();
+
+			// Subtract element margins
+			// note: when an element has margin: auto the offsetLeft and marginLeft 
+			// are the same in Safari causing offset.left to incorrectly be 0
+			offset.top  -= num( this, 'marginTop' );
+			offset.left -= num( this, 'marginLeft' );
+
+			// Add offsetParent borders
+			parentOffset.top  += num( offsetParent, 'borderTopWidth' );
+			parentOffset.left += num( offsetParent, 'borderLeftWidth' );
+
+			// Subtract the two offsets
+			results = {
+				top:  offset.top  - parentOffset.top,
+				left: offset.left - parentOffset.left
+			};
+		}
+
+		return results;
+	},
+
+	offsetParent: function() {
+		var offsetParent = this[0].offsetParent;
+		while ( offsetParent && (!/^body|html$/i.test(offsetParent.tagName) && jQuery.css(offsetParent, 'position') == 'static') )
+			offsetParent = offsetParent.offsetParent;
+		return jQuery(offsetParent);
 	}
 });
-}
+
+
+// Create scrollLeft and scrollTop methods
+jQuery.each( ['Left', 'Top'], function(i, name) {
+	var method = 'scroll' + name;
+	
+	jQuery.fn[ method ] = function(val) {
+		if (!this[0]) return;
+
+		return val != undefined ?
+
+			// Set the scroll offset
+			this.each(function() {
+				this == window || this == document ?
+					window.scrollTo(
+						!i ? val : jQuery(window).scrollLeft(),
+						 i ? val : jQuery(window).scrollTop()
+					) :
+					this[ method ] = val;
+			}) :
+
+			// Return the scroll offset
+			this[0] == window || this[0] == document ?
+				self[ i ? 'pageYOffset' : 'pageXOffset' ] ||
+					jQuery.boxModel && document.documentElement[ method ] ||
+					document.body[ method ] :
+				this[0][ method ];
+	};
+});
+// Create innerHeight, innerWidth, outerHeight and outerWidth methods
+jQuery.each([ "Height", "Width" ], function(i, name){
+
+	var tl = i ? "Left"  : "Top",  // top or left
+		br = i ? "Right" : "Bottom"; // bottom or right
+
+	// innerHeight and innerWidth
+	jQuery.fn["inner" + name] = function(){
+		return this[ name.toLowerCase() ]() +
+			num(this, "padding" + tl) +
+			num(this, "padding" + br);
+	};
+
+	// outerHeight and outerWidth
+	jQuery.fn["outer" + name] = function(margin) {
+		return this["inner" + name]() +
+			num(this, "border" + tl + "Width") +
+			num(this, "border" + br + "Width") +
+			(margin ?
+				num(this, "margin" + tl) + num(this, "margin" + br) : 0);
+	};
+
+});})();
diff --git a/dom/tests/mochitest/ajax/jquery/src/Makefile.in b/dom/tests/mochitest/ajax/jquery/src/Makefile.in
deleted file mode 100644
--- a/dom/tests/mochitest/ajax/jquery/src/Makefile.in
+++ /dev/null
@@ -1,62 +0,0 @@
-#
-# ***** BEGIN LICENSE BLOCK *****
-# Version: MPL 1.1/GPL 2.0/LGPL 2.1
-#
-# The contents of this file are subject to the Mozilla Public License Version
-# 1.1 (the "License"); you may not use this file except in compliance with
-# the License. You may obtain a copy of the License at
-# http://www.mozilla.org/MPL/
-#
-# Software distributed under the License is distributed on an "AS IS" basis,
-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
-# for the specific language governing rights and limitations under the
-# License.
-#
-# The Original Code is mozilla.org code.
-#
-# The Initial Developer of the Original Code is
-# Mozilla Foundation.
-# Portions created by the Initial Developer are Copyright (C) 2007
-# the Initial Developer. All Rights Reserved.
-#
-# Contributor(s):
-#
-# Alternatively, the contents of this file may be used under the terms of
-# either of the GNU General Public License Version 2 or later (the "GPL"),
-# or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
-# in which case the provisions of the GPL or the LGPL are applicable instead
-# of those above. If you wish to allow use of your version of this file only
-# under the terms of either the GPL or the LGPL, and not to allow others to
-# use your version of this file under the terms of the MPL, indicate your
-# decision by deleting the provisions above and replace them with the notice
-# and other provisions required by the GPL or the LGPL. If you do not delete
-# the provisions above, a recipient may use your version of this file under
-# the terms of any one of the MPL, the GPL or the LGPL.
-#
-# ***** END LICENSE BLOCK *****
-
-DEPTH		= ../../../../../..
-topsrcdir	= @top_srcdir@
-srcdir		= @srcdir@
-VPATH		= @srcdir@
-relativesrcdir	= dom/tests/mochitest/ajax/jquery/src
-
-include $(DEPTH)/config/autoconf.mk
-
-DIRS	= \
-	ajax \
-	event \
-	fx \
-	jquery \
-	selector \
-	$(NULL)
-
-include $(topsrcdir)/config/rules.mk
-
-_TEST_FILES	= \
-	intro.js \
-	outro.js \
-	$(NULL)
-
-libs::	$(_TEST_FILES)
-	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
diff --git a/dom/tests/mochitest/ajax/jquery/src/ajax/Makefile.in b/dom/tests/mochitest/ajax/jquery/src/ajax/Makefile.in
deleted file mode 100644
--- a/dom/tests/mochitest/ajax/jquery/src/ajax/Makefile.in
+++ /dev/null
@@ -1,57 +0,0 @@
-#
-# ***** BEGIN LICENSE BLOCK *****
-# Version: MPL 1.1/GPL 2.0/LGPL 2.1
-#
-# The contents of this file are subject to the Mozilla Public License Version
-# 1.1 (the "License"); you may not use this file except in compliance with
-# the License. You may obtain a copy of the License at
-# http://www.mozilla.org/MPL/
-#
-# Software distributed under the License is distributed on an "AS IS" basis,
-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
-# for the specific language governing rights and limitations under the
-# License.
-#
-# The Original Code is mozilla.org code.
-#
-# The Initial Developer of the Original Code is
-# Mozilla Foundation.
-# Portions created by the Initial Developer are Copyright (C) 2007
-# the Initial Developer. All Rights Reserved.
-#
-# Contributor(s):
-#
-# Alternatively, the contents of this file may be used under the terms of
-# either of the GNU General Public License Version 2 or later (the "GPL"),
-# or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
-# in which case the provisions of the GPL or the LGPL are applicable instead
-# of those above. If you wish to allow use of your version of this file only
-# under the terms of either the GPL or the LGPL, and not to allow others to
-# use your version of this file under the terms of the MPL, indicate your
-# decision by deleting the provisions above and replace them with the notice
-# and other provisions required by the GPL or the LGPL. If you do not delete
-# the provisions above, a recipient may use your version of this file under
-# the terms of any one of the MPL, the GPL or the LGPL.
-#
-# ***** END LICENSE BLOCK *****
-
-DEPTH		= ../../../../../../..
-topsrcdir	= @top_srcdir@
-srcdir		= @srcdir@
-VPATH		= @srcdir@
-relativesrcdir	= dom/tests/mochitest/ajax/jquery/src/ajax
-
-include $(DEPTH)/config/autoconf.mk
-
-DIRS	= \
-	$(NULL)
-
-include $(topsrcdir)/config/rules.mk
-
-_TEST_FILES	= \
-	ajax.js \
-	ajaxTest.js \
-	$(NULL)
-
-libs::	$(_TEST_FILES)
-	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
diff --git a/dom/tests/mochitest/ajax/jquery/src/ajax/ajax.js b/dom/tests/mochitest/ajax/jquery/src/ajax/ajax.js
deleted file mode 100644
--- a/dom/tests/mochitest/ajax/jquery/src/ajax/ajax.js
+++ /dev/null
@@ -1,838 +0,0 @@
-jQuery.fn.extend({
-
-	/**
-	 * Load HTML from a remote file and inject it into the DOM, only if it's
-	 * been modified by the server.
-	 *
-	 * @example $("#feeds").loadIfModified("feeds.html");
-	 * @before <div id="feeds"></div>
-	 * @result <div id="feeds"><b>45</b> feeds found.</div>
-	 *
-	 * @name loadIfModified
-	 * @type jQuery
-	 * @param String url The URL of the HTML file to load.
-	 * @param Map params (optional) Key/value pairs that will be sent to the server.
-	 * @param Function callback (optional) A function to be executed whenever the data is loaded (parameters: responseText, status and response itself).
-	 * @cat Ajax
-	 */
-	loadIfModified: function( url, params, callback ) {
-		this.load( url, params, callback, 1 );
-	},
-
-	/**
-	 * Load HTML from a remote file and inject it into the DOM.
-	 *
-	 * Note: Avoid to use this to load scripts, instead use $.getScript.
-	 * IE strips script tags when there aren't any other characters in front of it.
-	 *
-	 * @example $("#feeds").load("feeds.html");
-	 * @before <div id="feeds"></div>
-	 * @result <div id="feeds"><b>45</b> feeds found.</div>
-	 *
- 	 * @example $("#feeds").load("feeds.html",
- 	 *   {limit: 25},
- 	 *   function() { alert("The last 25 entries in the feed have been loaded"); }
- 	 * );
-	 * @desc Same as above, but with an additional parameter
-	 * and a callback that is executed when the data was loaded.
-	 *
-	 * @name load
-	 * @type jQuery
-	 * @param String url The URL of the HTML file to load.
-	 * @param Object params (optional) A set of key/value pairs that will be sent as data to the server.
-	 * @param Function callback (optional) A function to be executed whenever the data is loaded (parameters: responseText, status and response itself).
-	 * @cat Ajax
-	 */
-	load: function( url, params, callback, ifModified ) {
-		if ( jQuery.isFunction( url ) )
-			return this.bind("load", url);
-
-		callback = callback || function(){};
-
-		// Default to a GET request
-		var type = "GET";
-
-		// If the second parameter was provided
-		if ( params )
-			// If it's a function
-			if ( jQuery.isFunction( params ) ) {
-				// We assume that it's the callback
-				callback = params;
-				params = null;
-
-			// Otherwise, build a param string
-			} else {
-				params = jQuery.param( params );
-				type = "POST";
-			}
-
-		var self = this;
-
-		// Request the remote document
-		jQuery.ajax({
-			url: url,
-			type: type,
-			data: params,
-			ifModified: ifModified,
-			complete: function(res, status){
-				if ( status == "success" || !ifModified && status == "notmodified" )
-					// Inject the HTML into all the matched elements
-					self.attr("innerHTML", res.responseText)
-					  // Execute all the scripts inside of the newly-injected HTML
-					  .evalScripts()
-					  // Execute callback
-					  .each( callback, [res.responseText, status, res] );
-				else
-					callback.apply( self, [res.responseText, status, res] );
-			}
-		});
-		return this;
-	},
-
-	/**
-	 * Serializes a set of input elements into a string of data.
-	 * This will serialize all given elements.
-	 *
-	 * A serialization similar to the form submit of a browser is
-	 * provided by the [http://www.malsup.com/jquery/form/ Form Plugin].
-	 * It also takes multiple-selects 
-	 * into account, while this method recognizes only a single option.
-	 *
-	 * @example $("input[@type=text]").serialize();
-	 * @before <input type='text' name='name' value='John'/>
-	 * <input type='text' name='location' value='Boston'/>
-	 * @after name=John&amp;location=Boston
-	 * @desc Serialize a selection of input elements to a string
-	 *
-	 * @name serialize
-	 * @type String
-	 * @cat Ajax
-	 */
-	serialize: function() {
-		return jQuery.param( this );
-	},
-
-	/**
-	 * Evaluate all script tags inside this jQuery. If they have a src attribute,
-	 * the script is loaded, otherwise it's content is evaluated.
-	 *
-	 * @name evalScripts
-	 * @type jQuery
-	 * @private
-	 * @cat Ajax
-	 */
-	evalScripts: function() {
-		return this.find("script").each(function(){
-			if ( this.src )
-				jQuery.getScript( this.src );
-			else
-				jQuery.globalEval( this.text || this.textContent || this.innerHTML || "" );
-		}).end();
-	}
-
-});
-
-// Attach a bunch of functions for handling common AJAX events
-
-/**
- * Attach a function to be executed whenever an AJAX request begins
- * and there is none already active.
- *
- * @example $("#loading").ajaxStart(function(){
- *   $(this).show();
- * });
- * @desc Show a loading message whenever an AJAX request starts
- * (and none is already active).
- *
- * @name ajaxStart
- * @type jQuery
- * @param Function callback The function to execute.
- * @cat Ajax
- */
-
-/**
- * Attach a function to be executed whenever all AJAX requests have ended.
- *
- * @example $("#loading").ajaxStop(function(){
- *   $(this).hide();
- * });
- * @desc Hide a loading message after all the AJAX requests have stopped.
- *
- * @name ajaxStop
- * @type jQuery
- * @param Function callback The function to execute.
- * @cat Ajax
- */
-
-/**
- * Attach a function to be executed whenever an AJAX request completes.
- *
- * The XMLHttpRequest and settings used for that request are passed
- * as arguments to the callback.
- *
- * @example $("#msg").ajaxComplete(function(request, settings){
- *   $(this).append("<li>Request Complete.</li>");
- * });
- * @desc Show a message when an AJAX request completes.
- *
- * @name ajaxComplete
- * @type jQuery
- * @param Function callback The function to execute.
- * @cat Ajax
- */
-
-/**
- * Attach a function to be executed whenever an AJAX request completes
- * successfully.
- *
- * The XMLHttpRequest and settings used for that request are passed
- * as arguments to the callback.
- *
- * @example $("#msg").ajaxSuccess(function(request, settings){
- *   $(this).append("<li>Successful Request!</li>");
- * });
- * @desc Show a message when an AJAX request completes successfully.
- *
- * @name ajaxSuccess
- * @type jQuery
- * @param Function callback The function to execute.
- * @cat Ajax
- */
-
-/**
- * Attach a function to be executed whenever an AJAX request fails.
- *
- * The XMLHttpRequest and settings used for that request are passed
- * as arguments to the callback. A third argument, an exception object,
- * is passed if an exception occured while processing the request.
- *
- * @example $("#msg").ajaxError(function(request, settings){
- *   $(this).append("<li>Error requesting page " + settings.url + "</li>");
- * });
- * @desc Show a message when an AJAX request fails.
- *
- * @name ajaxError
- * @type jQuery
- * @param Function callback The function to execute.
- * @cat Ajax
- */
- 
-/**
- * Attach a function to be executed before an AJAX request is sent.
- *
- * The XMLHttpRequest and settings used for that request are passed
- * as arguments to the callback.
- *
- * @example $("#msg").ajaxSend(function(request, settings){
- *   $(this).append("<li>Starting request at " + settings.url + "</li>");
- * });
- * @desc Show a message before an AJAX request is sent.
- *
- * @name ajaxSend
- * @type jQuery
- * @param Function callback The function to execute.
- * @cat Ajax
- */
-jQuery.each( "ajaxStart,ajaxStop,ajaxComplete,ajaxError,ajaxSuccess,ajaxSend".split(","), function(i,o){
-	jQuery.fn[o] = function(f){
-		return this.bind(o, f);
-	};
-});
-
-jQuery.extend({
-
-	/**
-	 * Load a remote page using an HTTP GET request.
-	 *
-	 * This is an easy way to send a simple GET request to a server
-	 * without having to use the more complex $.ajax function. It
-	 * allows a single callback function to be specified that will
-	 * be executed when the request is complete (and only if the response
-	 * has a successful response code). If you need to have both error
-	 * and success callbacks, you may want to use $.ajax.
-	 *
-	 * @example $.get("test.cgi");
-	 *
-	 * @example $.get("test.cgi", { name: "John", time: "2pm" } );
-	 *
-	 * @example $.get("test.cgi", function(data){
-	 *   alert("Data Loaded: " + data);
-	 * });
-	 *
-	 * @example $.get("test.cgi",
-	 *   { name: "John", time: "2pm" },
-	 *   function(data){
-	 *     alert("Data Loaded: " + data);
-	 *   }
-	 * );
-	 *
-	 * @name $.get
-	 * @type XMLHttpRequest
-	 * @param String url The URL of the page to load.
-	 * @param Map params (optional) Key/value pairs that will be sent to the server.
-	 * @param Function callback (optional) A function to be executed whenever the data is loaded successfully.
-	 * @cat Ajax
-	 */
-	get: function( url, data, callback, type, ifModified ) {
-		// shift arguments if data argument was ommited
-		if ( jQuery.isFunction( data ) ) {
-			callback = data;
-			data = null;
-		}
-		
-		return jQuery.ajax({
-			type: "GET",
-			url: url,
-			data: data,
-			success: callback,
-			dataType: type,
-			ifModified: ifModified
-		});
-	},
-
-	/**
-	 * Load a remote page using an HTTP GET request, only if it hasn't
-	 * been modified since it was last retrieved.
-	 *
-	 * @example $.getIfModified("test.html");
-	 *
-	 * @example $.getIfModified("test.html", { name: "John", time: "2pm" } );
-	 *
-	 * @example $.getIfModified("test.cgi", function(data){
-	 *   alert("Data Loaded: " + data);
-	 * });
-	 *
-	 * @example $.getifModified("test.cgi",
-	 *   { name: "John", time: "2pm" },
-	 *   function(data){
-	 *     alert("Data Loaded: " + data);
-	 *   }
-	 * );
-	 *
-	 * @name $.getIfModified
-	 * @type XMLHttpRequest
-	 * @param String url The URL of the page to load.
-	 * @param Map params (optional) Key/value pairs that will be sent to the server.
-	 * @param Function callback (optional) A function to be executed whenever the data is loaded successfully.
-	 * @cat Ajax
-	 */
-	getIfModified: function( url, data, callback, type ) {
-		return jQuery.get(url, data, callback, type, 1);
-	},
-
-	/**
-	 * Loads, and executes, a remote JavaScript file using an HTTP GET request.
-	 *
-	 * Warning: Safari <= 2.0.x is unable to evaluate scripts in a global
-	 * context synchronously. If you load functions via getScript, make sure
-	 * to call them after a delay.
-	 *
-	 * @example $.getScript("test.js");
-	 *
-	 * @example $.getScript("test.js", function(){
-	 *   alert("Script loaded and executed.");
-	 * });
-	 *
-	 * @name $.getScript
-	 * @type XMLHttpRequest
-	 * @param String url The URL of the page to load.
-	 * @param Function callback (optional) A function to be executed whenever the data is loaded successfully.
-	 * @cat Ajax
-	 */
-	getScript: function( url, callback ) {
-		return jQuery.get(url, null, callback, "script");
-	},
-
-	/**
-	 * Load JSON data using an HTTP GET request.
-	 *
-	 * @example $.getJSON("test.js", function(json){
-	 *   alert("JSON Data: " + json.users[3].name);
-	 * });
-	 *
-	 * @example $.getJSON("test.js",
-	 *   { name: "John", time: "2pm" },
-	 *   function(json){
-	 *     alert("JSON Data: " + json.users[3].name);
-	 *   }
-	 * );
-	 *
-	 * @name $.getJSON
-	 * @type XMLHttpRequest
-	 * @param String url The URL of the page to load.
-	 * @param Map params (optional) Key/value pairs that will be sent to the server.
-	 * @param Function callback A function to be executed whenever the data is loaded successfully.
-	 * @cat Ajax
-	 */
-	getJSON: function( url, data, callback ) {
-		return jQuery.get(url, data, callback, "json");
-	},
-
-	/**
-	 * Load a remote page using an HTTP POST request.
-	 *
-	 * @example $.post("test.cgi");
-	 *
-	 * @example $.post("test.cgi", { name: "John", time: "2pm" } );
-	 *
-	 * @example $.post("test.cgi", function(data){
-	 *   alert("Data Loaded: " + data);
-	 * });
-	 *
-	 * @example $.post("test.cgi",
-	 *   { name: "John", time: "2pm" },
-	 *   function(data){
-	 *     alert("Data Loaded: " + data);
-	 *   }
-	 * );
-	 *
-	 * @name $.post
-	 * @type XMLHttpRequest
-	 * @param String url The URL of the page to load.
-	 * @param Map params (optional) Key/value pairs that will be sent to the server.
-	 * @param Function callback (optional) A function to be executed whenever the data is loaded successfully.
-	 * @cat Ajax
-	 */
-	post: function( url, data, callback, type ) {
-		if ( jQuery.isFunction( data ) ) {
-			callback = data;
-			data = {};
-		}
-
-		return jQuery.ajax({
-			type: "POST",
-			url: url,
-			data: data,
-			success: callback,
-			dataType: type
-		});
-	},
-
-	/**
-	 * Set the timeout in milliseconds of all AJAX requests to a specific amount of time.
-	 * This will make all future AJAX requests timeout after a specified amount
-	 * of time.
-	 *
-	 * Set to null or 0 to disable timeouts (default).
-	 *
-	 * You can manually abort requests with the XMLHttpRequest's (returned by
-	 * all ajax functions) abort() method.
-	 *
-	 * Deprecated. Use $.ajaxSetup instead.
-	 *
-	 * @example $.ajaxTimeout( 5000 );
-	 * @desc Make all AJAX requests timeout after 5 seconds.
-	 *
-	 * @name $.ajaxTimeout
-	 * @type undefined
-	 * @param Number time How long before an AJAX request times out, in milliseconds.
-	 * @cat Ajax
-	 */
-	ajaxTimeout: function( timeout ) {
-		jQuery.ajaxSettings.timeout = timeout;
-	},
-	
-	/**
-	 * Setup global settings for AJAX requests.
-	 *
-	 * See $.ajax for a description of all available options.
-	 *
-	 * @example $.ajaxSetup( {
-	 *   url: "/xmlhttp/",
-	 *   global: false,
-	 *   type: "POST"
-	 * } );
-	 * $.ajax({ data: myData });
-	 * @desc Sets the defaults for AJAX requests to the url "/xmlhttp/",
-	 * disables global handlers and uses POST instead of GET. The following
-	 * AJAX requests then sends some data without having to set anything else.
-	 *
-	 * @name $.ajaxSetup
-	 * @type undefined
-	 * @param Map settings Key/value pairs to use for all AJAX requests
-	 * @cat Ajax
-	 */
-	ajaxSetup: function( settings ) {
-		jQuery.extend( jQuery.ajaxSettings, settings );
-	},
-
-	ajaxSettings: {
-		global: true,
-		type: "GET",
-		timeout: 0,
-		contentType: "application/x-www-form-urlencoded",
-		processData: true,
-		async: true,
-		data: null
-	},
-	
-	// Last-Modified header cache for next request
-	lastModified: {},
-
-	/**
-	 * Load a remote page using an HTTP request.
-	 *
-	 * This is jQuery's low-level AJAX implementation. See $.get, $.post etc. for
-	 * higher-level abstractions that are often easier to understand and use,
-	 * but don't offer as much functionality (such as error callbacks).
-	 *
-	 * $.ajax() returns the XMLHttpRequest that it creates. In most cases you won't
-	 * need that object to manipulate directly, but it is available if you need to
-	 * abort the request manually.
-	 *
-	 * '''Note:''' If you specify the dataType option described below, make sure
-	 * the server sends the correct MIME type in the response (eg. xml as "text/xml").
-	 * Sending the wrong MIME type can lead to unexpected problems in your script.
-	 * See [[Specifying the Data Type for AJAX Requests]] for more information.
-	 *
-	 * Supported datatypes are (see dataType option):
-	 *
-	 * "xml": Returns a XML document that can be processed via jQuery.
-	 *
-	 * "html": Returns HTML as plain text, included script tags are evaluated.
-	 *
-	 * "script": Evaluates the response as Javascript and returns it as plain text.
-	 *
-	 * "json": Evaluates the response as JSON and returns a Javascript Object
-	 *
-	 * $.ajax() takes one argument, an object of key/value pairs, that are
-	 * used to initalize and handle the request. These are all the key/values that can
-	 * be used:
-	 *
-	 * (String) url - The URL to request.
-	 *
-	 * (String) type - The type of request to make ("POST" or "GET"), default is "GET".
-	 *
-	 * (String) dataType - The type of data that you're expecting back from
-	 * the server. No default: If the server sends xml, the responseXML, otherwise
-	 * the responseText is passed to the success callback.
-	 *
-	 * (Boolean) ifModified - Allow the request to be successful only if the
-	 * response has changed since the last request. This is done by checking the
-	 * Last-Modified header. Default value is false, ignoring the header.
-	 *
-	 * (Number) timeout - Local timeout in milliseconds to override global timeout, eg. to give a
-	 * single request a longer timeout while all others timeout after 1 second.
-	 * See $.ajaxTimeout() for global timeouts.
-	 *
-	 * (Boolean) global - Whether to trigger global AJAX event handlers for
-	 * this request, default is true. Set to false to prevent that global handlers
-	 * like ajaxStart or ajaxStop are triggered.
-	 *
-	 * (Function) error - A function to be called if the request fails. The
-	 * function gets passed tree arguments: The XMLHttpRequest object, a
-	 * string describing the type of error that occurred and an optional
-	 * exception object, if one occured.
-	 *
-	 * (Function) success - A function to be called if the request succeeds. The
-	 * function gets passed one argument: The data returned from the server,
-	 * formatted according to the 'dataType' parameter.
-	 *
-	 * (Function) complete - A function to be called when the request finishes. The
-	 * function gets passed two arguments: The XMLHttpRequest object and a
-	 * string describing the type of success of the request.
-	 *
- 	 * (Object|String) data - Data to be sent to the server. Converted to a query
-	 * string, if not already a string. Is appended to the url for GET-requests.
-	 * See processData option to prevent this automatic processing.
-	 *
-	 * (String) contentType - When sending data to the server, use this content-type.
-	 * Default is "application/x-www-form-urlencoded", which is fine for most cases.
-	 *
-	 * (Boolean) processData - By default, data passed in to the data option as an object
-	 * other as string will be processed and transformed into a query string, fitting to
-	 * the default content-type "application/x-www-form-urlencoded". If you want to send
-	 * DOMDocuments, set this option to false.
-	 *
-	 * (Boolean) async - By default, all requests are sent asynchronous (set to true).
-	 * If you need synchronous requests, set this option to false.
-	 *
-	 * (Function) beforeSend - A pre-callback to set custom headers etc., the
-	 * XMLHttpRequest is passed as the only argument.
-	 *
-	 * @example $.ajax({
-	 *   type: "GET",
-	 *   url: "test.js",
-	 *   dataType: "script"
-	 * })
-	 * @desc Load and execute a JavaScript file.
-	 *
-	 * @example $.ajax({
-	 *   type: "POST",
-	 *   url: "some.php",
-	 *   data: "name=John&location=Boston",
-	 *   success: function(msg){
-	 *     alert( "Data Saved: " + msg );
-	 *   }
-	 * });
-	 * @desc Save some data to the server and notify the user once its complete.
-	 *
-	 * @example var html = $.ajax({
-	 *  url: "some.php",
-	 *  async: false
-	 * }).responseText;
-	 * @desc Loads data synchronously. Blocks the browser while the requests is active.
-	 * It is better to block user interaction by other means when synchronization is
-	 * necessary.
-	 *
-	 * @example var xmlDocument = [create xml document];
-	 * $.ajax({
-	 *   url: "page.php",
-	 *   processData: false,
-	 *   data: xmlDocument,
-	 *   success: handleResponse
-	 * });
-	 * @desc Sends an xml document as data to the server. By setting the processData
-	 * option to false, the automatic conversion of data to strings is prevented.
-	 * 
-	 * @name $.ajax
-	 * @type XMLHttpRequest
-	 * @param Map properties Key/value pairs to initialize the request with.
-	 * @cat Ajax
-	 * @see ajaxSetup(Map)
-	 */
-	ajax: function( s ) {
-		// TODO introduce global settings, allowing the client to modify them for all requests, not only timeout
-		s = jQuery.extend({}, jQuery.ajaxSettings, s);
-
-		// if data available
-		if ( s.data ) {
-			// convert data if not already a string
-			if (s.processData && typeof s.data != "string")
-    			s.data = jQuery.param(s.data);
-			// append data to url for get requests
-			if( s.type.toLowerCase() == "get" ) {
-				// "?" + data or "&" + data (in case there are already params)
-				s.url += ((s.url.indexOf("?") > -1) ? "&" : "?") + s.data;
-				// IE likes to send both get and post data, prevent this
-				s.data = null;
-			}
-		}
-
-		// Watch for a new set of requests
-		if ( s.global && ! jQuery.active++ )
-			jQuery.event.trigger( "ajaxStart" );
-
-		var requestDone = false;
-
-		// Create the request object; Microsoft failed to properly
-		// implement the XMLHttpRequest in IE7, so we use the ActiveXObject when it is available
-		var xml = window.ActiveXObject ? new ActiveXObject("Microsoft.XMLHTTP") : new XMLHttpRequest();
-
-		// Open the socket
-		xml.open(s.type, s.url, s.async);
-
-		// Set the correct header, if data is being sent
-		if ( s.data )
-			xml.setRequestHeader("Content-Type", s.contentType);
-
-		// Set the If-Modified-Since header, if ifModified mode.
-		if ( s.ifModified )
-			xml.setRequestHeader("If-Modified-Since",
-				jQuery.lastModified[s.url] || "Thu, 01 Jan 1970 00:00:00 GMT" );
-
-		// Set header so the called script knows that it's an XMLHttpRequest
-		xml.setRequestHeader("X-Requested-With", "XMLHttpRequest");
-
-		// Allow custom headers/mimetypes
-		if( s.beforeSend )
-			s.beforeSend(xml);
-			
-		if ( s.global )
-		    jQuery.event.trigger("ajaxSend", [xml, s]);
-
-		// Wait for a response to come back
-		var onreadystatechange = function(isTimeout){
-			// The transfer is complete and the data is available, or the request timed out
-			if ( xml && (xml.readyState == 4 || isTimeout == "timeout") ) {
-				requestDone = true;
-				
-				// clear poll interval
-				if (ival) {
-					clearInterval(ival);
-					ival = null;
-				}
-				
-				var status;
-				try {
-					status = jQuery.httpSuccess( xml ) && isTimeout != "timeout" ?
-						s.ifModified && jQuery.httpNotModified( xml, s.url ) ? "notmodified" : "success" : "error";
-					// Make sure that the request was successful or notmodified
-					if ( status != "error" ) {
-						// Cache Last-Modified header, if ifModified mode.
-						var modRes;
-						try {
-							modRes = xml.getResponseHeader("Last-Modified");
-						} catch(e) {} // swallow exception thrown by FF if header is not available
-	
-						if ( s.ifModified && modRes )
-							jQuery.lastModified[s.url] = modRes;
-	
-						// process the data (runs the xml through httpData regardless of callback)
-						var data = jQuery.httpData( xml, s.dataType );
-	
-						// If a local callback was specified, fire it and pass it the data
-						if ( s.success )
-							s.success( data, status );
-	
-						// Fire the global callback
-						if( s.global )
-							jQuery.event.trigger( "ajaxSuccess", [xml, s] );
-					} else
-						jQuery.handleError(s, xml, status);
-				} catch(e) {
-					status = "error";
-					jQuery.handleError(s, xml, status, e);
-				}
-
-				// The request was completed
-				if( s.global )
-					jQuery.event.trigger( "ajaxComplete", [xml, s] );
-
-				// Handle the global AJAX counter
-				if ( s.global && ! --jQuery.active )
-					jQuery.event.trigger( "ajaxStop" );
-
-				// Process result
-				if ( s.complete )
-					s.complete(xml, status);
-
-				// Stop memory leaks
-				if(s.async)
-					xml = null;
-			}
-		};
-		
-		// don't attach the handler to the request, just poll it instead
-		var ival = setInterval(onreadystatechange, 13); 
-
-		// Timeout checker
-		if ( s.timeout > 0 )
-			setTimeout(function(){
-				// Check to see if the request is still happening
-				if ( xml ) {
-					// Cancel the request
-					xml.abort();
-
-					if( !requestDone )
-						onreadystatechange( "timeout" );
-				}
-			}, s.timeout);
-			
-		// Send the data
-		try {
-			xml.send(s.data);
-		} catch(e) {
-			jQuery.handleError(s, xml, null, e);
-		}
-		
-		// firefox 1.5 doesn't fire statechange for sync requests
-		if ( !s.async )
-			onreadystatechange();
-		
-		// return XMLHttpRequest to allow aborting the request etc.
-		return xml;
-	},
-
-	handleError: function( s, xml, status, e ) {
-		// If a local callback was specified, fire it
-		if ( s.error ) s.error( xml, status, e );
-
-		// Fire the global callback
-		if ( s.global )
-			jQuery.event.trigger( "ajaxError", [xml, s, e] );
-	},
-
-	// Counter for holding the number of active queries
-	active: 0,
-
-	// Determines if an XMLHttpRequest was successful or not
-	httpSuccess: function( r ) {
-		try {
-			return !r.status && location.protocol == "file:" ||
-				( r.status >= 200 && r.status < 300 ) || r.status == 304 ||
-				jQuery.browser.safari && r.status == undefined;
-		} catch(e){}
-		return false;
-	},
-
-	// Determines if an XMLHttpRequest returns NotModified
-	httpNotModified: function( xml, url ) {
-		try {
-			var xmlRes = xml.getResponseHeader("Last-Modified");
-
-			// Firefox always returns 200. check Last-Modified date
-			return xml.status == 304 || xmlRes == jQuery.lastModified[url] ||
-				jQuery.browser.safari && xml.status == undefined;
-		} catch(e){}
-		return false;
-	},
-
-	/* Get the data out of an XMLHttpRequest.
-	 * Return parsed XML if content-type header is "xml" and type is "xml" or omitted,
-	 * otherwise return plain text.
-	 * (String) data - The type of data that you're expecting back,
-	 * (e.g. "xml", "html", "script")
-	 */
-	httpData: function( r, type ) {
-		var ct = r.getResponseHeader("content-type");
-		var data = !type && ct && ct.indexOf("xml") >= 0;
-		data = type == "xml" || data ? r.responseXML : r.responseText;
-
-		// If the type is "script", eval it in global context
-		if ( type == "script" )
-			jQuery.globalEval( data );
-
-		// Get the JavaScript object, if JSON is used.
-		if ( type == "json" )
-			data = eval("(" + data + ")");
-
-		// evaluate scripts within html
-		if ( type == "html" )
-			jQuery("<div>").html(data).evalScripts();
-
-		return data;
-	},
-
-	// Serialize an array of form elements or a set of
-	// key/values into a query string
-	param: function( a ) {
-		var s = [];
-
-		// If an array was passed in, assume that it is an array
-		// of form elements
-		if ( a.constructor == Array || a.jquery )
-			// Serialize the form elements
-			jQuery.each( a, function(){
-				s.push( encodeURIComponent(this.name) + "=" + encodeURIComponent( this.value ) );
-			});
-
-		// Otherwise, assume that it's an object of key/value pairs
-		else
-			// Serialize the key/values
-			for ( var j in a )
-				// If the value is an array then the key names need to be repeated
-				if ( a[j] && a[j].constructor == Array )
-					jQuery.each( a[j], function(){
-						s.push( encodeURIComponent(j) + "=" + encodeURIComponent( this ) );
-					});
-				else
-					s.push( encodeURIComponent(j) + "=" + encodeURIComponent( a[j] ) );
-
-		// Return the resulting serialization
-		return s.join("&");
-	},
-	
-	// evalulates a script in global context
-	// not reliable for safari
-	globalEval: function( data ) {
-		if ( window.execScript )
-			window.execScript( data );
-		else if ( jQuery.browser.safari )
-			// safari doesn't provide a synchronous global eval
-			window.setTimeout( data, 0 );
-		else
-			eval.call( window, data );
-	}
-
-});
diff --git a/dom/tests/mochitest/ajax/jquery/src/ajax/ajaxTest.js b/dom/tests/mochitest/ajax/jquery/src/ajax/ajaxTest.js
deleted file mode 100644
--- a/dom/tests/mochitest/ajax/jquery/src/ajax/ajaxTest.js
+++ /dev/null
@@ -1,395 +0,0 @@
-module("ajax");
-
-if ( location.protocol != "file:" ) {
-
-test("serialize()", function() {
-	expect(1);
-	var data = $(':input').not('button').serialize();
-	// ignore button, IE takes text content as value, not relevant for this test
-	ok( data == 'action=Test&text2=Test&radio1=on&radio2=on&check=on&=on&hidden=&foo%5Bbar%5D=&name=name&=foobar&select1=&select2=3&select3=1', 'Check form serialization as query string' );
-});
-
-test("param", function() {
-	expect(4);
-	var params = {foo:"bar", baz:42, quux:"All your base are belong to us"};
-	ok( $.param(params) == "foo=bar&baz=42&quux=All%20your%20base%20are%20belong%20to%20us", "simple" );
-	
-	params = {someName: [1, 2, 3], regularThing: "blah" };
-	ok( $.param(params) == "someName=1&someName=2&someName=3&regularThing=blah", "with array" );
-	
-	params = {"foo[]":["baz", 42, "All your base are belong to us"]};
-	ok( $.param(params) == "foo%5B%5D=baz&foo%5B%5D=42&foo%5B%5D=All%20your%20base%20are%20belong%20to%20us", "more array" );
-	
-	params = {"foo[bar]":"baz", "foo[beep]":42, "foo[quux]":"All your base are belong to us"};
-	ok( $.param(params) == "foo%5Bbar%5D=baz&foo%5Bbeep%5D=42&foo%5Bquux%5D=All%20your%20base%20are%20belong%20to%20us", "even more arrays" );
-});
-
-test("pass-through request object", function() {
-	expect(7);
-	stop(true);
-	var count = 0;
-	var success = function() {
-		if(count++ == 6)
-			start();
-	}
-	var target = "data/name.php";
-	ok( $.get(url(target), success), "get" );
-	ok( $.getIfModified(url(target), success), "getIfModified" );
-	ok( $.post(url(target), success), "post" );
-	ok( $.getScript(url("data/test.js"), success), "script" );
-	ok( $.getJSON(url("data/json.php"), success), "json" );
-	ok( $.ajax({url: url(target), success: success}), "generic" );
-});
-
-test("synchronous request", function() {
-	ok( /^{ "data"/.test( $.ajax({url: url("data/json.php"), async: false}).responseText ), "check returned text" );
-});
-
-test("synchronous request with callbacks", function() {
-	expect(2);
-	var result;
-	$.ajax({url: url("data/json.php"), async: false, success: function(data) { ok(true, "sucess callback executed"); result = data; } });
-	ok( /^{ "data"/.test( result ), "check returned text" );
-});
-
-test("load(String, Object, Function) - simple: inject text into DOM", function() {
-	expect(2);
-	stop();
-	$('#first').load(url("data/name.php"), function() {
-		ok( /^ERROR/.test($('#first').text()), 'Check if content was injected into the DOM' );
-		start();
-	});
-});
-
-test("load(String, Object, Function) - inject without callback", function() {
-	expect(1);
-	stop(true); // check if load can be called with only url
-	$('#first').load("data/name.php");
-});
-
-test("load(String, Object, Function) - check scripts", function() {
-	expect(7);
-	stop();
-	window.testFoo = undefined;
-	window.foobar = null;
-	var verifyEvaluation = function() {
-	  ok( foobar == "bar", 'Check if script src was evaluated after load' );
-	  ok( $('#ap').html() == 'bar', 'Check if script evaluation has modified DOM');
-	  start();
-	};
-	$('#first').load(url('data/test.php'), function() {
-	  ok( $('#first').html().match(/^html text/), 'Check content after loading html' );
-	  ok( $('#foo').html() == 'foo', 'Check if script evaluation has modified DOM');
-	  ok( testFoo == "foo", 'Check if script was evaluated after load' );
-	  setTimeout(verifyEvaluation, 600);
-	});
-});
-
-test("load(String, Object, Function) - check file with only a script tag", function() {
-	expect(3);
-	stop();
-	testFoo = undefined;
-	$('#first').load(url('data/test2.php'), function() {
-	  ok( $('#foo').html() == 'foo', 'Check if script evaluation has modified DOM');
-	  ok( testFoo == "foo", 'Check if script was evaluated after load' );
-	  start();
-	});
-});
-
-test("test global handlers - success", function() {
-	expect(8);
-	stop();
-	var counter = { complete: 0, success: 0, error: 0, send: 0 },
-		success = function() { counter.success++ },
-		error = function() { counter.error++ },
-		complete = function() { counter.complete++ },
-		send = function() { counter.send++ };
-
-	$('#foo').ajaxStart(complete).ajaxStop(complete).ajaxSend(send).ajaxComplete(complete).ajaxError(error).ajaxSuccess(success);
-	// start with successful test
-	$.ajax({url: url("data/name.php"), beforeSend: send, success: success, error: error, complete: function() {
-	  ok( counter.error == 0, 'Check succesful request' );
-	  ok( counter.success == 2, 'Check succesful request' );
-	  ok( counter.complete == 3, 'Check succesful request' );
-	  ok( counter.send == 2, 'Check succesful request' );
-	  counter.error = counter.success = counter.complete = counter.send = 0;
-	  $.ajaxTimeout(500);
-	  $.ajax({url: url("data/name.php?wait=5"), beforeSend: send, success: success, error: error, complete: function() {
-	    ok( counter.error == 2, 'Check failed request' );
-	    ok( counter.success == 0, 'Check failed request' );
-	    ok( counter.complete == 3, 'Check failed request' );
-	    ok( counter.send == 2, 'Check failed request' );
-	    start();
-	  }});
-	}});
-});
-
-test("test global handlers - failure", function() {
-	expect(8);
-	stop();
-	var counter = { complete: 0, success: 0, error: 0, send: 0 },
-		success = function() { counter.success++ },
-		error = function() { counter.error++ },
-		complete = function() { counter.complete++ },
-		send = function() { counter.send++ };
-	$.ajaxTimeout(0);
-	$('#foo').ajaxStart(complete).ajaxStop(complete).ajaxSend(send).ajaxComplete(complete).ajaxError(error).ajaxSuccess(success);
-	$.ajax({url: url("data/name.php"), global: false, beforeSend: send, success: success, error: error, complete: function() {
-	  ok( counter.error == 0, 'Check sucesful request without globals' );
-	  ok( counter.success == 1, 'Check sucesful request without globals' );
-	  ok( counter.complete == 0, 'Check sucesful request without globals' );
-	  ok( counter.send == 1, 'Check sucesful request without globals' );
-	  counter.error = counter.success = counter.complete = counter.send = 0;
-	  $.ajaxTimeout(500);
-	  $.ajax({url: url("data/name.php?wait=5"), global: false, beforeSend: send, success: success, error: error, complete: function() {
-	  	 var x = counter;
-	     ok( counter.error == 1, 'Check failed request without globals' );
-	     ok( counter.success == 0, 'Check failed request without globals' );
-	     ok( counter.complete == 0, 'Check failed request without globals' );
-	     ok( counter.send == 1, 'Check failed request without globals' );
-	     start();
-	  }});
-	}});
-});
-
-test("$.get(String, Hash, Function) - parse xml and use text() on nodes", function() {
-	expect(2);
-	stop();
-	$.get(url('data/dashboard.xml'), function(xml) {
-		var content = [];
-		$('tab', xml).each(function() {
-			content.push($(this).text());
-		});
-		ok( content[0] == 'blabla', 'Check first tab');
-		ok( content[1] == 'blublu', 'Check second tab');
-		start();
-	});
-});
-
-test("$.getIfModified(String, Hash, Function)", function() {
-	expect(1);
-	stop();
-	$.getIfModified(url("data/name.php"), function(msg) {
-	    ok( /^ERROR/.test(msg), 'Check ifModified' );
-	    start();
-	});
-});
-
-test("$.getScript(String, Function) - with callback", function() {
-	expect(2);
-	stop();
-	$.getScript(url("data/test.js"), function() {
-		ok( foobar == "bar", 'Check if script was evaluated' );
-		setTimeout(start, 100);
-	});
-});
-
-test("$.getScript(String, Function) - no callback", function() {
-	expect(1);
-	stop(true);
-	$.getScript(url("data/test.js"));
-});
-
-test("$.getJSON(String, Hash, Function) - JSON array", function() {
-	expect(4);
-	stop();
-	$.getJSON(url("data/json.php"), {json: "array"}, function(json) {
-	  ok( json[0].name == 'John', 'Check JSON: first, name' );
-	  ok( json[0].age == 21, 'Check JSON: first, age' );
-	  ok( json[1].name == 'Peter', 'Check JSON: second, name' );
-	  ok( json[1].age == 25, 'Check JSON: second, age' );
-	  start();
-	});
-});
-
-test("$.getJSON(String, Hash, Function) - JSON object", function() {
-	expect(2);
-	stop();
-	$.getJSON(url("data/json.php"), function(json) {
-	  ok( json.data.lang == 'en', 'Check JSON: lang' );
-	  ok( json.data.length == 25, 'Check JSON: length' );
-	  start();
-	});
-});
-
-test("$.post(String, Hash, Function) - simple with xml", function() {
-	expect(2);
-	stop();
-	$.post(url("data/name.php"), {xml: "5-2"}, function(xml){
-	  $('math', xml).each(function() {
-		    ok( $('calculation', this).text() == '5-2', 'Check for XML' );
-		    ok( $('result', this).text() == '3', 'Check for XML' );
-		 });
-	  start();
-	});
-});
-
-test("$.ajaxTimeout(Number) - with global timeout", function() {
-	stop();
-	var passed = 0;
-	var timeout;
-	$.ajaxTimeout(1000);
-	var pass = function() {
-		passed++;
-		if(passed == 2) {
-			ok( true, 'Check local and global callbacks after timeout' );
-			clearTimeout(timeout);
-	     $('#main').unbind("ajaxError");
-			start();
-		}
-	};
-	var fail = function() {
-		ok( false, 'Check for timeout failed' );
-		start();
-	};
-	timeout = setTimeout(fail, 1500);
-	$('#main').ajaxError(pass);
-	$.ajax({
-	  type: "GET",
-	  url: url("data/name.php?wait=5"),
-	  error: pass,
-	  success: fail
-	});
-	// reset timeout
-	$.ajaxTimeout(0);
-});
-
-test("$.ajaxTimeout(Number) with localtimeout", function() {
-	stop(); $.ajaxTimeout(50);
-	$.ajax({
-	  type: "GET",
-	  timeout: 5000,
-	  url: url("data/name.php?wait=1"),
-	  error: function() {
-		   ok( false, 'Check for local timeout failed' );
-		   start();
-	  },
-	  success: function() {
-	    ok( true, 'Check for local timeout' );
-	    start();
-	  }
-	});
-	// reset timeout
-	$.ajaxTimeout(0);
-});
-
-test("$.ajax - simple get", function() {
-	expect(1);
-	stop();
-	$.ajax({
-	  type: "GET",
-	  url: url("data/name.php?name=foo"),
-	  success: function(msg){
-	    ok( msg == 'bar', 'Check for GET' );
-	    start();
-	  }
-	});
-});
-
-test("$.ajax - simple post", function() {
-	expect(1);
-	stop();
-	$.ajax({
-	  type: "POST",
-	  url: url("data/name.php"),
-	  data: "name=peter",
-	  success: function(msg){
-	    ok( msg == 'pan', 'Check for POST' );
-	    start();
-	  }
-	});
-});
-	
-test("$.ajax - dataType html", function() {
-	expect(5);
-	stop();
-	foobar = null;
-	testFoo = undefined;
-	var verifyEvaluation = function() {
-	  ok( foobar == "bar", 'Check if script src was evaluated for datatype html' );
-	  start();
-	};
-	$.ajax({
-	  dataType: "html",
-	  url: url("data/test.php"),
-	  success: function(data) {
-	    ok( data.match(/^html text/), 'Check content for datatype html' );
-	    ok( testFoo == "foo", 'Check if script was evaluated for datatype html' );
-	    setTimeout(verifyEvaluation, 600);
-	  }
-	});
-});
-	
-test("$.ajax - xml: non-namespace elements inside namespaced elements", function() {
-	expect(3);
-	stop();
-	$.ajax({
-	  url: url("data/with_fries.xml"),
-	  dataType: "xml",
-	  success: function(resp) {
-	    ok( $("properties", resp).length == 1, 'properties in responseXML' );
-	    ok( $("jsconf", resp).length == 1, 'jsconf in responseXML' );
-	    ok( $("thing", resp).length == 2, 'things in responseXML' );
-	    start();
-	  }
-	});
-});
-
-test("$.ajax - beforeSend", function() {
-	expect(1);
-	stop();
-	var check = false;
-	$.ajax({
-		url: url("data/name.php"), 
-		data: {'req': true},
-		beforeSend: function(xml) {
-			check = true
-		},
-		success: function(data) {
-			ok( check, "check beforeSend was executed" );
-			start();
-		}
-	});
-});
-
-test("ajaxSetup()", function() {
-	expect(1);
-	stop();
-	$.ajaxSetup({
-		url: url("data/name.php?name=foo"),
-		success: function(msg){
-	    	ok( msg == 'bar', 'Check for GET' );
-			start();
-		}
-	});
-	$.ajax();
-});
-
-test("evalScripts() with no script elements", function() {
-    expect(2);
-
-    var data = "this is just some bogus text";
-    $('#foo').html(data);
-    ok ( true, 'before evalScripts()');
-    try {
-        $('#foo').evalScripts();
-    } catch(e) {
-        ok (false, 'exception evaluating scripts: ' + e.message);
-    }
-    ok ( true, 'after evalScripts()');
-});
-
-test("custom timeout does not set error message when timeout occurs, see #970", function() {
-	stop();
-	$.ajax({
-		url: "data/name.php?wait=10",
-		timeout: 500,
-		error: function(request, status) {
-			ok( status != null, "status shouldn't be null in error handler" );
-			equals( "timeout", status );
-			start();
-		}
-	});
-});
-
-}
diff --git a/dom/tests/mochitest/ajax/jquery/src/event/Makefile.in b/dom/tests/mochitest/ajax/jquery/src/event/Makefile.in
deleted file mode 100644
--- a/dom/tests/mochitest/ajax/jquery/src/event/Makefile.in
+++ /dev/null
@@ -1,57 +0,0 @@
-#
-# ***** BEGIN LICENSE BLOCK *****
-# Version: MPL 1.1/GPL 2.0/LGPL 2.1
-#
-# The contents of this file are subject to the Mozilla Public License Version
-# 1.1 (the "License"); you may not use this file except in compliance with
-# the License. You may obtain a copy of the License at
-# http://www.mozilla.org/MPL/
-#
-# Software distributed under the License is distributed on an "AS IS" basis,
-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
-# for the specific language governing rights and limitations under the
-# License.
-#
-# The Original Code is mozilla.org code.
-#
-# The Initial Developer of the Original Code is
-# Mozilla Foundation.
-# Portions created by the Initial Developer are Copyright (C) 2007
-# the Initial Developer. All Rights Reserved.
-#
-# Contributor(s):
-#
-# Alternatively, the contents of this file may be used under the terms of
-# either of the GNU General Public License Version 2 or later (the "GPL"),
-# or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
-# in which case the provisions of the GPL or the LGPL are applicable instead
-# of those above. If you wish to allow use of your version of this file only
-# under the terms of either the GPL or the LGPL, and not to allow others to
-# use your version of this file under the terms of the MPL, indicate your
-# decision by deleting the provisions above and replace them with the notice
-# and other provisions required by the GPL or the LGPL. If you do not delete
-# the provisions above, a recipient may use your version of this file under
-# the terms of any one of the MPL, the GPL or the LGPL.
-#
-# ***** END LICENSE BLOCK *****
-
-DEPTH		= ../../../../../../..
-topsrcdir	= @top_srcdir@
-srcdir		= @srcdir@
-VPATH		= @srcdir@
-relativesrcdir	= dom/tests/mochitest/ajax/jquery/src/event
-
-include $(DEPTH)/config/autoconf.mk
-
-DIRS	= \
-	$(NULL)
-
-include $(topsrcdir)/config/rules.mk
-
-_TEST_FILES	= \
-	event.js \
-	eventTest.js \
-	$(NULL)
-
-libs::	$(_TEST_FILES)
-	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
diff --git a/dom/tests/mochitest/ajax/jquery/src/event/event.js b/dom/tests/mochitest/ajax/jquery/src/event/event.js
deleted file mode 100644
--- a/dom/tests/mochitest/ajax/jquery/src/event/event.js
+++ /dev/null
@@ -1,998 +0,0 @@
-/*
- * A number of helper functions used for managing events.
- * Many of the ideas behind this code orignated from 
- * Dean Edwards' addEvent library.
- */
-jQuery.event = {
-
-	// Bind an event to an element
-	// Original by Dean Edwards
-	add: function(element, type, handler, data) {
-		// For whatever reason, IE has trouble passing the window object
-		// around, causing it to be cloned in the process
-		if ( jQuery.browser.msie && element.setInterval != undefined )
-			element = window;
-		
-		// Make sure that the function being executed has a unique ID
-		if ( !handler.guid )
-			handler.guid = this.guid++;
-			
-		// if data is passed, bind to handler 
-		if( data != undefined ) { 
-        	// Create temporary function pointer to original handler 
-			var fn = handler; 
-
-			// Create unique handler function, wrapped around original handler 
-			handler = function() { 
-				// Pass arguments and context to original handler 
-				return fn.apply(this, arguments); 
-			};
-
-			// Store data in unique handler 
-			handler.data = data;
-
-			// Set the guid of unique handler to the same of original handler, so it can be removed 
-			handler.guid = fn.guid;
-		}
-
-		// Init the element's event structure
-		if (!element.$events)
-			element.$events = {};
-		
-		if (!element.$handle)
-			element.$handle = function() {
-				// returned undefined or false
-				var val;
-
-				// Handle the second event of a trigger and when
-				// an event is called after a page has unloaded
-				if ( typeof jQuery == "undefined" || jQuery.event.triggered )
-				  return val;
-				
-				val = jQuery.event.handle.apply(element, arguments);
-				
-				return val;
-			};
-
-		// Get the current list of functions bound to this event
-		var handlers = element.$events[type];
-
-		// Init the event handler queue
-		if (!handlers) {
-			handlers = element.$events[type] = {};	
-			
-			// And bind the global event handler to the element
-			if (element.addEventListener)
-				element.addEventListener(type, element.$handle, false);
-			else if (element.attachEvent)
-				element.attachEvent("on" + type, element.$handle);
-		}
-
-		// Add the function to the element's handler list
-		handlers[handler.guid] = handler;
-
-		// Remember the function in a global list (for triggering)
-		if (!this.global[type])
-			this.global[type] = [];
-		// Only add the element to the global list once
-		if (jQuery.inArray(element, this.global[type]) == -1)
-			this.global[type].push( element );
-	},
-
-	guid: 1,
-	global: {},
-
-	// Detach an event or set of events from an element
-	remove: function(element, type, handler) {
-		var events = element.$events, ret, index;
-
-		if ( events ) {
-			// type is actually an event object here
-			if ( type && type.type ) {
-				handler = type.handler;
-				type = type.type;
-			}
-			
-			if ( !type ) {
-				for ( type in events )
-					this.remove( element, type );
-
-			} else if ( events[type] ) {
-				// remove the given handler for the given type
-				if ( handler )
-					delete events[type][handler.guid];
-				
-				// remove all handlers for the given type
-				else
-					for ( handler in element.$events[type] )
-						delete events[type][handler];
-
-				// remove generic event handler if no more handlers exist
-				for ( ret in events[type] ) break;
-				if ( !ret ) {
-					if (element.removeEventListener)
-						element.removeEventListener(type, element.$handle, false);
-					else if (element.detachEvent)
-						element.detachEvent("on" + type, element.$handle);
-					ret = null;
-					delete events[type];
-					
-					// Remove element from the global event type cache
-					while ( this.global[type] && ( (index = jQuery.inArray(element, this.global[type])) >= 0 ) )
-						delete this.global[type][index];
-				}
-			}
-
-			// Remove the expando if it's no longer used
-			for ( ret in events ) break;
-			if ( !ret )
-				element.$handle = element.$events = null;
-		}
-	},
-
-	trigger: function(type, data, element) {
-		// Clone the incoming data, if any
-		data = jQuery.makeArray(data || []);
-
-		// Handle a global trigger
-		if ( !element )
-			jQuery.each( this.global[type] || [], function(){
-				jQuery.event.trigger( type, data, this );
-			});
-
-		// Handle triggering a single element
-		else {
-			var val, ret, fn = jQuery.isFunction( element[ type ] || null );
-			
-			// Pass along a fake event
-			data.unshift( this.fix({ type: type, target: element }) );
-
-			// Trigger the event
-			if ( jQuery.isFunction(element.$handle) && (val = element.$handle.apply( element, data )) !== false )
-				this.triggered = true;
-
-			if ( fn && val !== false && !jQuery.nodeName(element, 'a') )
-				element[ type ]();
-
-			this.triggered = false;
-		}
-	},
-
-	handle: function(event) {
-		// returned undefined or false
-		var val;
-
-		// Empty object is for triggered events with no data
-		event = jQuery.event.fix( event || window.event || {} ); 
-
-		var c = this.$events && this.$events[event.type], args = [].slice.call( arguments, 1 );
-		args.unshift( event );
-
-		for ( var j in c ) {
-			// Pass in a reference to the handler function itself
-			// So that we can later remove it
-			args[0].handler = c[j];
-			args[0].data = c[j].data;
-
-			if ( c[j].apply( this, args ) === false ) {
-				event.preventDefault();
-				event.stopPropagation();
-				val = false;
-			}
-		}
-
-		// Clean up added properties in IE to prevent memory leak
-		if (jQuery.browser.msie)
-			event.target = event.preventDefault = event.stopPropagation =
-				event.handler = event.data = null;
-
-		return val;
-	},
-
-	fix: function(event) {
-		// store a copy of the original event object 
-		// and clone to set read-only properties
-		var originalEvent = event;
-		event = jQuery.extend({}, originalEvent);
-		
-		// add preventDefault and stopPropagation since 
-		// they will not work on the clone
-		event.preventDefault = function() {
-			// if preventDefault exists run it on the original event
-			if (originalEvent.preventDefault)
-				return originalEvent.preventDefault();
-			// otherwise set the returnValue property of the original event to false (IE)
-			originalEvent.returnValue = false;
-		};
-		event.stopPropagation = function() {
-			// if stopPropagation exists run it on the original event
-			if (originalEvent.stopPropagation)
-				return originalEvent.stopPropagation();
-			// otherwise set the cancelBubble property of the original event to true (IE)
-			originalEvent.cancelBubble = true;
-		};
-		
-		// Fix target property, if necessary
-		if ( !event.target && event.srcElement )
-			event.target = event.srcElement;
-				
-		// check if target is a textnode (safari)
-		if (jQuery.browser.safari && event.target.nodeType == 3)
-			event.target = originalEvent.target.parentNode;
-
-		// Add relatedTarget, if necessary
-		if ( !event.relatedTarget && event.fromElement )
-			event.relatedTarget = event.fromElement == event.target ? event.toElement : event.fromElement;
-
-		// Calculate pageX/Y if missing and clientX/Y available
-		if ( event.pageX == null && event.clientX != null ) {
-			var e = document.documentElement || document.body;
-			event.pageX = event.clientX + e.scrollLeft;
-			event.pageY = event.clientY + e.scrollTop;
-		}
-			
-		// Add which for key events
-		if ( !event.which && (event.charCode || event.keyCode) )
-			event.which = event.charCode || event.keyCode;
-		
-		// Add metaKey to non-Mac browsers (use ctrl for PC's and Meta for Macs)
-		if ( !event.metaKey && event.ctrlKey )
-			event.metaKey = event.ctrlKey;
-
-		// Add which for click: 1 == left; 2 == middle; 3 == right
-		// Note: button is not normalized, so don't use it
-		if ( !event.which && event.button )
-			event.which = (event.button & 1 ? 1 : ( event.button & 2 ? 3 : ( event.button & 4 ? 2 : 0 ) ));
-			
-		return event;
-	}
-};
-
-jQuery.fn.extend({
-
-	/**
-	 * Binds a handler to a particular event (like click) for each matched element.
-	 * The event handler is passed an event object that you can use to prevent
-	 * default behaviour. To stop both default action and event bubbling, your handler
-	 * has to return false.
-	 *
-	 * In most cases, you can define your event handlers as anonymous functions
-	 * (see first example). In cases where that is not possible, you can pass additional
-	 * data as the second parameter (and the handler function as the third), see 
-	 * second example.
-	 *
-	 * Calling bind with an event type of "unload" will automatically
-	 * use the one method instead of bind to prevent memory leaks.
-	 *
-	 * @example $("p").bind("click", function(){
-	 *   alert( $(this).text() );
-	 * });
-	 * @before <p>Hello</p>
-	 * @result alert("Hello")
-	 *
-	 * @example function handler(event) {
-	 *   alert(event.data.foo);
-	 * }
-	 * $("p").bind("click", {foo: "bar"}, handler)
-	 * @result alert("bar")
-	 * @desc Pass some additional data to the event handler.
-	 *
-	 * @example $("form").bind("submit", function() { return false; })
-	 * @desc Cancel a default action and prevent it from bubbling by returning false
-	 * from your function.
-	 *
-	 * @example $("form").bind("submit", function(event){
-	 *   event.preventDefault();
-	 * });
-	 * @desc Cancel only the default action by using the preventDefault method.
-	 *
-	 *
-	 * @example $("form").bind("submit", function(event){
-	 *   event.stopPropagation();
-	 * });
-	 * @desc Stop only an event from bubbling by using the stopPropagation method.
-	 *
-	 * @name bind
-	 * @type jQuery
-	 * @param String type An event type
-	 * @param Object data (optional) Additional data passed to the event handler as event.data
-	 * @param Function fn A function to bind to the event on each of the set of matched elements
-	 * @cat Events
-	 */
-	bind: function( type, data, fn ) {
-		return type == "unload" ? this.one(type, data, fn) : this.each(function(){
-			jQuery.event.add( this, type, fn || data, fn && data );
-		});
-	},
-	
-	/**
-	 * Binds a handler to a particular event (like click) for each matched element.
-	 * The handler is executed only once for each element. Otherwise, the same rules
-	 * as described in bind() apply.
-	 * The event handler is passed an event object that you can use to prevent
-	 * default behaviour. To stop both default action and event bubbling, your handler
-	 * has to return false.
-	 *
-	 * In most cases, you can define your event handlers as anonymous functions
-	 * (see first example). In cases where that is not possible, you can pass additional
-	 * data as the second paramter (and the handler function as the third), see 
-	 * second example.
-	 *
-	 * @example $("p").one("click", function(){
-	 *   alert( $(this).text() );
-	 * });
-	 * @before <p>Hello</p>
-	 * @result alert("Hello")
-	 *
-	 * @name one
-	 * @type jQuery
-	 * @param String type An event type
-	 * @param Object data (optional) Additional data passed to the event handler as event.data
-	 * @param Function fn A function to bind to the event on each of the set of matched elements
-	 * @cat Events
-	 */
-	one: function( type, data, fn ) {
-		return this.each(function(){
-			jQuery.event.add( this, type, function(event) {
-				jQuery(this).unbind(event);
-				return (fn || data).apply( this, arguments);
-			}, fn && data);
-		});
-	},
-
-	/**
-	 * The opposite of bind, removes a bound event from each of the matched
-	 * elements.
-	 *
-	 * Without any arguments, all bound events are removed.
-	 *
-	 * If the type is provided, all bound events of that type are removed.
-	 *
-	 * If the function that was passed to bind is provided as the second argument,
-	 * only that specific event handler is removed.
-	 *
-	 * @example $("p").unbind()
-	 * @before <p onclick="alert('Hello');">Hello</p>
-	 * @result [ <p>Hello</p> ]
-	 *
-	 * @example $("p").unbind( "click" )
-	 * @before <p onclick="alert('Hello');">Hello</p>
-	 * @result [ <p>Hello</p> ]
-	 *
-	 * @example $("p").unbind( "click", function() { alert("Hello"); } )
-	 * @before <p onclick="alert('Hello');">Hello</p>
-	 * @result [ <p>Hello</p> ]
-	 *
-	 * @name unbind
-	 * @type jQuery
-	 * @param String type (optional) An event type
-	 * @param Function fn (optional) A function to unbind from the event on each of the set of matched elements
-	 * @cat Events
-	 */
-	unbind: function( type, fn ) {
-		return this.each(function(){
-			jQuery.event.remove( this, type, fn );
-		});
-	},
-
-	/**
-	 * Trigger a type of event on every matched element. This will also cause
-	 * the default action of the browser with the same name (if one exists)
-	 * to be executed. For example, passing 'submit' to the trigger()
-	 * function will also cause the browser to submit the form. This
-	 * default action can be prevented by returning false from one of
-	 * the functions bound to the event.
-	 *
-	 * You can also trigger custom events registered with bind.
-	 *
-	 * @example $("p").trigger("click")
-	 * @before <p click="alert('hello')">Hello</p>
-	 * @result alert('hello')
-	 *
-	 * @example $("p").click(function(event, a, b) {
-	 *   // when a normal click fires, a and b are undefined
-	 *   // for a trigger like below a refers too "foo" and b refers to "bar"
-	 * }).trigger("click", ["foo", "bar"]);
-	 * @desc Example of how to pass arbitrary data to an event
-	 * 
-	 * @example $("p").bind("myEvent",function(event,message1,message2) {
-	 * 	alert(message1 + ' ' + message2);
-	 * });
-	 * $("p").trigger("myEvent",["Hello","World"]);
-	 * @result alert('Hello World') // One for each paragraph
-	 *
-	 * @name trigger
-	 * @type jQuery
-	 * @param String type An event type to trigger.
-	 * @param Array data (optional) Additional data to pass as arguments (after the event object) to the event handler
-	 * @cat Events
-	 */
-	trigger: function( type, data ) {
-		return this.each(function(){
-			jQuery.event.trigger( type, data, this );
-		});
-	},
-
-	/**
-	 * Toggle between two function calls every other click.
-	 * Whenever a matched element is clicked, the first specified function 
-	 * is fired, when clicked again, the second is fired. All subsequent 
-	 * clicks continue to rotate through the two functions.
-	 *
-	 * Use unbind("click") to remove.
-	 *
-	 * @example $("p").toggle(function(){
-	 *   $(this).addClass("selected");
-	 * },function(){
-	 *   $(this).removeClass("selected");
-	 * });
-	 * 
-	 * @name toggle
-	 * @type jQuery
-	 * @param Function even The function to execute on every even click.
-	 * @param Function odd The function to execute on every odd click.
-	 * @cat Events
-	 */
-	toggle: function() {
-		// Save reference to arguments for access in closure
-		var a = arguments;
-
-		return this.click(function(e) {
-			// Figure out which function to execute
-			this.lastToggle = 0 == this.lastToggle ? 1 : 0;
-			
-			// Make sure that clicks stop
-			e.preventDefault();
-			
-			// and execute the function
-			return a[this.lastToggle].apply( this, [e] ) || false;
-		});
-	},
-	
-	/**
-	 * A method for simulating hovering (moving the mouse on, and off,
-	 * an object). This is a custom method which provides an 'in' to a 
-	 * frequent task.
-	 *
-	 * Whenever the mouse cursor is moved over a matched 
-	 * element, the first specified function is fired. Whenever the mouse 
-	 * moves off of the element, the second specified function fires. 
-	 * Additionally, checks are in place to see if the mouse is still within 
-	 * the specified element itself (for example, an image inside of a div), 
-	 * and if it is, it will continue to 'hover', and not move out 
-	 * (a common error in using a mouseout event handler).
-	 *
-	 * @example $("p").hover(function(){
-	 *   $(this).addClass("hover");
-	 * },function(){
-	 *   $(this).removeClass("hover");
-	 * });
-	 *
-	 * @name hover
-	 * @type jQuery
-	 * @param Function over The function to fire whenever the mouse is moved over a matched element.
-	 * @param Function out The function to fire whenever the mouse is moved off of a matched element.
-	 * @cat Events
-	 */
-	hover: function(f,g) {
-		
-		// A private function for handling mouse 'hovering'
-		function handleHover(e) {
-			// Check if mouse(over|out) are still within the same parent element
-			var p = e.relatedTarget;
-	
-			// Traverse up the tree
-			while ( p && p != this ) try { p = p.parentNode } catch(e) { p = this; };
-			
-			// If we actually just moused on to a sub-element, ignore it
-			if ( p == this ) return false;
-			
-			// Execute the right function
-			return (e.type == "mouseover" ? f : g).apply(this, [e]);
-		}
-		
-		// Bind the function to the two event listeners
-		return this.mouseover(handleHover).mouseout(handleHover);
-	},
-	
-	/**
-	 * Bind a function to be executed whenever the DOM is ready to be
-	 * traversed and manipulated. This is probably the most important 
-	 * function included in the event module, as it can greatly improve
-	 * the response times of your web applications.
-	 *
-	 * In a nutshell, this is a solid replacement for using window.onload, 
-	 * and attaching a function to that. By using this method, your bound function 
-	 * will be called the instant the DOM is ready to be read and manipulated, 
-	 * which is when what 99.99% of all JavaScript code needs to run.
-	 *
-	 * There is one argument passed to the ready event handler: A reference to
-	 * the jQuery function. You can name that argument whatever you like, and
-	 * can therefore stick with the $ alias without risk of naming collisions.
-	 * 
-	 * Please ensure you have no code in your &lt;body&gt; onload event handler, 
-	 * otherwise $(document).ready() may not fire.
-	 *
-	 * You can have as many $(document).ready events on your page as you like.
-	 * The functions are then executed in the order they were added.
-	 *
-	 * @example $(document).ready(function(){ Your code here... });
-	 *
-	 * @example jQuery(function($) {
-	 *   // Your code using failsafe $ alias here...
-	 * });
-	 * @desc Uses both the [[Core#.24.28_fn_.29|shortcut]] for $(document).ready() and the argument
-	 * to write failsafe jQuery code using the $ alias, without relying on the
-	 * global alias.
-	 *
-	 * @name ready
-	 * @type jQuery
-	 * @param Function fn The function to be executed when the DOM is ready.
-	 * @cat Events
-	 * @see $.noConflict()
-	 * @see $(Function)
-	 */
-	ready: function(f) {
-		// If the DOM is already ready
-		if ( jQuery.isReady )
-			// Execute the function immediately
-			f.apply( document, [jQuery] );
-			
-		// Otherwise, remember the function for later
-		else {
-			// Add the function to the wait list
-			jQuery.readyList.push( function() { return f.apply(this, [jQuery]) } );
-		}
-	
-		return this;
-	}
-});
-
-jQuery.extend({
-	/*
-	 * All the code that makes DOM Ready work nicely.
-	 */
-	isReady: false,
-	readyList: [],
-	
-	// Handle when the DOM is ready
-	ready: function() {
-		// Make sure that the DOM is not already loaded
-		if ( !jQuery.isReady ) {
-			// Remember that the DOM is ready
-			jQuery.isReady = true;
-			
-			// If there are functions bound, to execute
-			if ( jQuery.readyList ) {
-				// Execute all of them
-				jQuery.each( jQuery.readyList, function(){
-					this.apply( document );
-				});
-				
-				// Reset the list of functions
-				jQuery.readyList = null;
-			}
-			// Remove event listener to avoid memory leak
-			if ( jQuery.browser.mozilla || jQuery.browser.opera )
-				document.removeEventListener( "DOMContentLoaded", jQuery.ready, false );
-			
-			// Remove script element used by IE hack
-			if( !window.frames.length ) // don't remove if frames are present (#1187)
-				jQuery(window).load(function(){ jQuery("#__ie_init").remove(); });
-		}
-	}
-});
-
-new function(){
-
-	/**
-	 * Bind a function to the scroll event of each matched element.
-	 *
-	 * @example $("p").scroll( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onscroll="alert('Hello');">Hello</p>
-	 *
-	 * @name scroll
-	 * @type jQuery
-	 * @param Function fn A function to bind to the scroll event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the submit event of each matched element.
-	 *
-	 * @example $("#myform").submit( function() {
-	 *   return $("input", this).val().length > 0;
-	 * } );
-	 * @before <form id="myform"><input /></form>
-	 * @desc Prevents the form submission when the input has no value entered.
-	 *
-	 * @name submit
-	 * @type jQuery
-	 * @param Function fn A function to bind to the submit event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Trigger the submit event of each matched element. This causes all of the functions
-	 * that have been bound to that submit event to be executed, and calls the browser's
-	 * default submit action on the matching element(s). This default action can be prevented
-	 * by returning false from one of the functions bound to the submit event.
-	 *
-	 * Note: This does not execute the submit method of the form element! If you need to
-	 * submit the form via code, you have to use the DOM method, eg. $("form")[0].submit();
-	 *
-	 * @example $("form").submit();
-	 * @desc Triggers all submit events registered to the matched form(s), and submits them.
-	 *
-	 * @name submit
-	 * @type jQuery
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the focus event of each matched element.
-	 *
-	 * @example $("p").focus( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onfocus="alert('Hello');">Hello</p>
-	 *
-	 * @name focus
-	 * @type jQuery
-	 * @param Function fn A function to bind to the focus event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Trigger the focus event of each matched element. This causes all of the functions
-	 * that have been bound to thet focus event to be executed.
-	 *
-	 * Note: This does not execute the focus method of the underlying elements! If you need to
-	 * focus an element via code, you have to use the DOM method, eg. $("#myinput")[0].focus();
-	 *
-	 * @example $("p").focus();
-	 * @before <p onfocus="alert('Hello');">Hello</p>
-	 * @result alert('Hello');
-	 *
-	 * @name focus
-	 * @type jQuery
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the keydown event of each matched element.
-	 *
-	 * @example $("p").keydown( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onkeydown="alert('Hello');">Hello</p>
-	 *
-	 * @name keydown
-	 * @type jQuery
-	 * @param Function fn A function to bind to the keydown event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the dblclick event of each matched element.
-	 *
-	 * @example $("p").dblclick( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p ondblclick="alert('Hello');">Hello</p>
-	 *
-	 * @name dblclick
-	 * @type jQuery
-	 * @param Function fn A function to bind to the dblclick event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the keypress event of each matched element.
-	 *
-	 * @example $("p").keypress( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onkeypress="alert('Hello');">Hello</p>
-	 *
-	 * @name keypress
-	 * @type jQuery
-	 * @param Function fn A function to bind to the keypress event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the error event of each matched element.
-	 *
-	 * @example $("p").error( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onerror="alert('Hello');">Hello</p>
-	 *
-	 * @name error
-	 * @type jQuery
-	 * @param Function fn A function to bind to the error event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the blur event of each matched element.
-	 *
-	 * @example $("p").blur( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onblur="alert('Hello');">Hello</p>
-	 *
-	 * @name blur
-	 * @type jQuery
-	 * @param Function fn A function to bind to the blur event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Trigger the blur event of each matched element. This causes all of the functions
-	 * that have been bound to that blur event to be executed, and calls the browser's
-	 * default blur action on the matching element(s). This default action can be prevented
-	 * by returning false from one of the functions bound to the blur event.
-	 *
-	 * Note: This does not execute the blur method of the underlying elements! If you need to
-	 * blur an element via code, you have to use the DOM method, eg. $("#myinput")[0].blur();
-	 *
-	 * @example $("p").blur();
-	 * @before <p onblur="alert('Hello');">Hello</p>
-	 * @result alert('Hello');
-	 *
-	 * @name blur
-	 * @type jQuery
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the load event of each matched element.
-	 *
-	 * @example $("p").load( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onload="alert('Hello');">Hello</p>
-	 *
-	 * @name load
-	 * @type jQuery
-	 * @param Function fn A function to bind to the load event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the select event of each matched element.
-	 *
-	 * @example $("p").select( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onselect="alert('Hello');">Hello</p>
-	 *
-	 * @name select
-	 * @type jQuery
-	 * @param Function fn A function to bind to the select event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Trigger the select event of each matched element. This causes all of the functions
-	 * that have been bound to that select event to be executed, and calls the browser's
-	 * default select action on the matching element(s). This default action can be prevented
-	 * by returning false from one of the functions bound to the select event.
-	 *
-	 * @example $("p").select();
-	 * @before <p onselect="alert('Hello');">Hello</p>
-	 * @result alert('Hello');
-	 *
-	 * @name select
-	 * @type jQuery
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the mouseup event of each matched element.
-	 *
-	 * @example $("p").mouseup( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onmouseup="alert('Hello');">Hello</p>
-	 *
-	 * @name mouseup
-	 * @type jQuery
-	 * @param Function fn A function to bind to the mouseup event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the unload event of each matched element.
-	 *
-	 * @example $("p").unload( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onunload="alert('Hello');">Hello</p>
-	 *
-	 * @name unload
-	 * @type jQuery
-	 * @param Function fn A function to bind to the unload event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the change event of each matched element.
-	 *
-	 * @example $("p").change( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onchange="alert('Hello');">Hello</p>
-	 *
-	 * @name change
-	 * @type jQuery
-	 * @param Function fn A function to bind to the change event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the mouseout event of each matched element.
-	 *
-	 * @example $("p").mouseout( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onmouseout="alert('Hello');">Hello</p>
-	 *
-	 * @name mouseout
-	 * @type jQuery
-	 * @param Function fn A function to bind to the mouseout event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the keyup event of each matched element.
-	 *
-	 * @example $("p").keyup( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onkeyup="alert('Hello');">Hello</p>
-	 *
-	 * @name keyup
-	 * @type jQuery
-	 * @param Function fn A function to bind to the keyup event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the click event of each matched element.
-	 *
-	 * @example $("p").click( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onclick="alert('Hello');">Hello</p>
-	 *
-	 * @name click
-	 * @type jQuery
-	 * @param Function fn A function to bind to the click event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Trigger the click event of each matched element. This causes all of the functions
-	 * that have been bound to thet click event to be executed.
-	 *
-	 * @example $("p").click();
-	 * @before <p onclick="alert('Hello');">Hello</p>
-	 * @result alert('Hello');
-	 *
-	 * @name click
-	 * @type jQuery
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the resize event of each matched element.
-	 *
-	 * @example $("p").resize( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onresize="alert('Hello');">Hello</p>
-	 *
-	 * @name resize
-	 * @type jQuery
-	 * @param Function fn A function to bind to the resize event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the mousemove event of each matched element.
-	 *
-	 * @example $("p").mousemove( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onmousemove="alert('Hello');">Hello</p>
-	 *
-	 * @name mousemove
-	 * @type jQuery
-	 * @param Function fn A function to bind to the mousemove event on each of the matched elements.
-	 * @cat Events
-	 */
-
-	/**
-	 * Bind a function to the mousedown event of each matched element.
-	 *
-	 * @example $("p").mousedown( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onmousedown="alert('Hello');">Hello</p>
-	 *
-	 * @name mousedown
-	 * @type jQuery
-	 * @param Function fn A function to bind to the mousedown event on each of the matched elements.
-	 * @cat Events
-	 */
-	 
-	/**
-	 * Bind a function to the mouseover event of each matched element.
-	 *
-	 * @example $("p").mouseover( function() { alert("Hello"); } );
-	 * @before <p>Hello</p>
-	 * @result <p onmouseover="alert('Hello');">Hello</p>
-	 *
-	 * @name mouseover
-	 * @type jQuery
-	 * @param Function fn A function to bind to the mousedown event on each of the matched elements.
-	 * @cat Events
-	 */
-	jQuery.each( ("blur,focus,load,resize,scroll,unload,click,dblclick," +
-		"mousedown,mouseup,mousemove,mouseover,mouseout,change,select," + 
-		"submit,keydown,keypress,keyup,error").split(","), function(i,o){
-		
-		// Handle event binding
-		jQuery.fn[o] = function(f){
-			return f ? this.bind(o, f) : this.trigger(o);
-		};
-			
-	});
-	
-	// If Mozilla is used
-	if ( jQuery.browser.mozilla || jQuery.browser.opera )
-		// Use the handy event callback
-		document.addEventListener( "DOMContentLoaded", jQuery.ready, false );
-	
-	// If IE is used, use the excellent hack by Matthias Miller
-	// http://www.outofhanwell.com/blog/index.php?title=the_window_onload_problem_revisited
-	else if ( jQuery.browser.msie ) {
-	
-		// Only works if you document.write() it
-		document.write("<scr" + "ipt id=__ie_init defer=true " + 
-			"src=//:><\/script>");
-	
-		// Use the defer script hack
-		var script = document.getElementById("__ie_init");
-		
-		// script does not exist if jQuery is loaded dynamically
-		if ( script ) 
-			script.onreadystatechange = function() {
-				if ( this.readyState != "complete" ) return;
-				jQuery.ready();
-			};
-	
-		// Clear from memory
-		script = null;
-	
-	// If Safari  is used
-	} else if ( jQuery.browser.safari )
-		// Continually check to see if the document.readyState is valid
-		jQuery.safariTimer = setInterval(function(){
-			// loaded and complete are both valid states
-			if ( document.readyState == "loaded" || 
-				document.readyState == "complete" ) {
-	
-				// If either one are found, remove the timer
-				clearInterval( jQuery.safariTimer );
-				jQuery.safariTimer = null;
-	
-				// and execute any waiting functions
-				jQuery.ready();
-			}
-		}, 10); 
-
-	// A fallback to window.onload, that will always work
-	jQuery.event.add( window, "load", jQuery.ready );
-	
-};
-
-// Clean up after IE to avoid memory leaks
-if (jQuery.browser.msie)
-	jQuery(window).one("unload", function() {
-		var global = jQuery.event.global;
-		for ( var type in global ) {
-			var els = global[type], i = els.length;
-			if ( i && type != 'unload' )
-				do
-					els[i-1] && jQuery.event.remove(els[i-1], type);
-				while (--i);
-		}
-	});
diff --git a/dom/tests/mochitest/ajax/jquery/src/event/eventTest.js b/dom/tests/mochitest/ajax/jquery/src/event/eventTest.js
deleted file mode 100644
--- a/dom/tests/mochitest/ajax/jquery/src/event/eventTest.js
+++ /dev/null
@@ -1,126 +0,0 @@
-module("event");
-
-test("bind()", function() {
-	expect(12);
-
-	var handler = function(event) {
-		ok( event.data, "bind() with data, check passed data exists" );
-		ok( event.data.foo == "bar", "bind() with data, Check value of passed data" );
-	};
-	$("#firstp").bind("click", {foo: "bar"}, handler).click().unbind("click", handler);
-	
-	ok( !$("#firstp").get(0).$events, "Event handler unbound when using data." );
-	
-	reset();
-	var handler = function(event, data) {
-		ok( event.data, "check passed data exists" );
-		ok( event.data.foo == "bar", "Check value of passed data" );
-		ok( data, "Check trigger data" );
-		ok( data.bar == "foo", "Check value of trigger data" );
-	};
-	$("#firstp").bind("click", {foo: "bar"}, handler).trigger("click", [{bar: "foo"}]).unbind(handler);
-	
-	reset();
-	var handler = function(event) {
-		ok ( !event.data, "Check that no data is added to the event object" );
-	};
-	$("#firstp").bind("click", handler).trigger("click");
-	
-	
-	// events don't work with iframes, see #939
-	var tmp = document.createElement('iframe');
-	document.body.appendChild( tmp );
-	var doc = tmp.contentWindow.document;
-	doc.open();
-	doc.write("<html><body><input type='text'/></body></html>");
-	doc.close();
-	 
-	var input = doc.getElementsByTagName("input")[0];
-	 
-	$(input).bind("click",function() {
-		ok( true, "Binding to element inside iframe" );
-	});
-	 
-	triggerEvent( input, "click" );
-	 
-	document.body.removeChild( tmp );
-	
-	var counter = 0;
-	function selectOnChange(event) {
-		equals( event.data, counter++, "Event.data is not a global event object" );
-	};
-	$("select").each(function(i){
-		$(this).bind('change', i, selectOnChange);
-	}).trigger('change');
-});
-
-test("click()", function() {
-	expect(3);
-	$('<li><a href="#">Change location</a></li>').prependTo('#firstUL').find('a').bind('click', function() {
-	    var close = $('spanx', this); // same with $(this).find('span');
-	    ok( close.length == 0, "Context element does not exist, length must be zero" );
-	    ok( !close[0], "Context element does not exist, direct access to element must return undefined" );
-	    return false;
-	}).click();
-	
-	$("#check1").click(function() {
-		ok( true, "click event handler for checkbox gets fired twice, see #815" );
-	}).click();
-});
-
-test("unbind(event)", function() {
-	expect(6);
-	var el = $("#firstp");
-	el.click(function() {
-		ok( true, "Fake normal bind" );
-	});
-	el.click(function(event) {
-		el.unbind(event);
-		ok( true, "Fake onebind" );
-	});
-	el.click().click();
-	
-	el.click(function() { return; });
-	el.unbind('click');
-	ok( !el[0].onclick, "Handler is removed" ); // Bug #964
-
-	el.click(function() { return; });
-	el.unbind('change',function(){ return; });
-	for (var ret in el[0].$events['click']) break;
-	ok( ret, "Extra handlers weren't accidentally removed." );
-
-	el.unbind('click');
-	ok( !el[0].$events, "Removed the events expando after all handlers are unbound." );
-});
-
-test("trigger(event, [data]", function() {
-	expect(3);
-	var handler = function(event, a, b, c) {
-		ok( a == 1, "check passed data" );
-		ok( b == "2", "check passed data" );
-		ok( c == "abc", "check passed data" );
-	};
-	$("#firstp").bind("click", handler).trigger("click", [1, "2", "abc"]);
-});
-
-test("toggle(Function, Function)", function() {
-	expect(4);
-	var count = 0,
-		fn1 = function(e) { count++; },
-		fn2 = function(e) { count--; },
-		preventDefault = function(e) { e.preventDefault() },
-		link = $('#mark');
-	link.click(preventDefault).click().toggle(fn1, fn2).click().click().click().click().click();
-	ok( count == 1, "Check for toggle(fn, fn)" );
-	
-	var first = 0;
-	$("#simon1").one("click", function() {
-		ok( true, "Execute event only once" );
-		$(this).toggle(function() {
-			ok( first++ == 0, "toggle(Function,Function) assigned from within one('xxx'), see #1054" );
-		}, function() {
-			ok( first == 1, "toggle(Function,Function) assigned from within one('xxx'), see #1054" );
-		});
-		return false;
-	}).click().click().click();
-});
\ No newline at end of file
diff --git a/dom/tests/mochitest/ajax/jquery/src/fx/Makefile.in b/dom/tests/mochitest/ajax/jquery/src/fx/Makefile.in
deleted file mode 100644
--- a/dom/tests/mochitest/ajax/jquery/src/fx/Makefile.in
+++ /dev/null
@@ -1,57 +0,0 @@
-#
-# ***** BEGIN LICENSE BLOCK *****
-# Version: MPL 1.1/GPL 2.0/LGPL 2.1
-#
-# The contents of this file are subject to the Mozilla Public License Version
-# 1.1 (the "License"); you may not use this file except in compliance with
-# the License. You may obtain a copy of the License at
-# http://www.mozilla.org/MPL/
-#
-# Software distributed under the License is distributed on an "AS IS" basis,
-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
-# for the specific language governing rights and limitations under the
-# License.
-#
-# The Original Code is mozilla.org code.
-#
-# The Initial Developer of the Original Code is
-# Mozilla Foundation.
-# Portions created by the Initial Developer are Copyright (C) 2007
-# the Initial Developer. All Rights Reserved.
-#
-# Contributor(s):
-#
-# Alternatively, the contents of this file may be used under the terms of
-# either of the GNU General Public License Version 2 or later (the "GPL"),
-# or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
-# in which case the provisions of the GPL or the LGPL are applicable instead
-# of those above. If you wish to allow use of your version of this file only
-# under the terms of either the GPL or the LGPL, and not to allow others to
-# use your version of this file under the terms of the MPL, indicate your
-# decision by deleting the provisions above and replace them with the notice
-# and other provisions required by the GPL or the LGPL. If you do not delete
-# the provisions above, a recipient may use your version of this file under
-# the terms of any one of the MPL, the GPL or the LGPL.
-#
-# ***** END LICENSE BLOCK *****
-
-DEPTH		= ../../../../../../..
-topsrcdir	= @top_srcdir@
-srcdir		= @srcdir@
-VPATH		= @srcdir@
-relativesrcdir	= dom/tests/mochitest/ajax/jquery/src/fx
-
-include $(DEPTH)/config/autoconf.mk
-
-DIRS	= \
-	$(NULL)
-
-include $(topsrcdir)/config/rules.mk
-
-_TEST_FILES	= \
-	fx.js \
-	fxTest.js \
-	$(NULL)
-
-libs::	$(_TEST_FILES)
-	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
diff --git a/dom/tests/mochitest/ajax/jquery/src/fx/fx.js b/dom/tests/mochitest/ajax/jquery/src/fx/fx.js
deleted file mode 100644
--- a/dom/tests/mochitest/ajax/jquery/src/fx/fx.js
+++ /dev/null
@@ -1,574 +0,0 @@
-jQuery.fn.extend({
-
-	/**
-	 * Displays each of the set of matched elements if they are hidden.
-	 *
-	 * @example $("p").show()
-	 * @before <p style="display: none">Hello</p>
-	 * @result [ <p style="display: block">Hello</p> ]
-	 *
-	 * @name show
-	 * @type jQuery
-	 * @cat Effects
-	 */
-	
-	/**
-	 * Show all matched elements using a graceful animation and firing an
-	 * optional callback after completion.
-	 *
-	 * The height, width, and opacity of each of the matched elements 
-	 * are changed dynamically according to the specified speed.
-	 *
-	 * @example $("p").show("slow");
-	 *
-	 * @example $("p").show("slow",function(){
-	 *   alert("Animation Done.");
-	 * });
-	 *
-	 * @name show
-	 * @type jQuery
-	 * @param String|Number speed A string representing one of the three predefined speeds ("slow", "normal", or "fast") or the number of milliseconds to run the animation (e.g. 1000).
-	 * @param Function callback (optional) A function to be executed whenever the animation completes.
-	 * @cat Effects
-	 * @see hide(String|Number,Function)
-	 */
-	show: function(speed,callback){
-		return speed ?
-			this.animate({
-				height: "show", width: "show", opacity: "show"
-			}, speed, callback) :
-			
-			this.filter(":hidden").each(function(){
-				this.style.display = this.oldblock ? this.oldblock : "";
-				if ( jQuery.css(this,"display") == "none" )
-					this.style.display = "block";
-			}).end();
-	},
-	
-	/**
-	 * Hides each of the set of matched elements if they are shown.
-	 *
-	 * @example $("p").hide()
-	 * @before <p>Hello</p>
-	 * @result [ <p style="display: none">Hello</p> ]
-	 *
-	 * @name hide
-	 * @type jQuery
-	 * @cat Effects
-	 */
-	
-	/**
-	 * Hide all matched elements using a graceful animation and firing an
-	 * optional callback after completion.
-	 *
-	 * The height, width, and opacity of each of the matched elements 
-	 * are changed dynamically according to the specified speed.
-	 *
-	 * @example $("p").hide("slow");
-	 *
-	 * @example $("p").hide("slow",function(){
-	 *   alert("Animation Done.");
-	 * });
-	 *
-	 * @name hide
-	 * @type jQuery
-	 * @param String|Number speed A string representing one of the three predefined speeds ("slow", "normal", or "fast") or the number of milliseconds to run the animation (e.g. 1000).
-	 * @param Function callback (optional) A function to be executed whenever the animation completes.
-	 * @cat Effects
-	 * @see show(String|Number,Function)
-	 */
-	hide: function(speed,callback){
-		return speed ?
-			this.animate({
-				height: "hide", width: "hide", opacity: "hide"
-			}, speed, callback) :
-			
-			this.filter(":visible").each(function(){
-				this.oldblock = this.oldblock || jQuery.css(this,"display");
-				if ( this.oldblock == "none" )
-					this.oldblock = "block";
-				this.style.display = "none";
-			}).end();
-	},
-
-	// Save the old toggle function
-	_toggle: jQuery.fn.toggle,
-	
-	/**
-	 * Toggles each of the set of matched elements. If they are shown,
-	 * toggle makes them hidden. If they are hidden, toggle
-	 * makes them shown.
-	 *
-	 * @example $("p").toggle()
-	 * @before <p>Hello</p><p style="display: none">Hello Again</p>
-	 * @result [ <p style="display: none">Hello</p>, <p style="display: block">Hello Again</p> ]
-	 *
-	 * @name toggle
-	 * @type jQuery
-	 * @cat Effects
-	 */
-	toggle: function( fn, fn2 ){
-		return jQuery.isFunction(fn) && jQuery.isFunction(fn2) ?
-			this._toggle( fn, fn2 ) :
-			fn ?
-				this.animate({
-					height: "toggle", width: "toggle", opacity: "toggle"
-				}, fn, fn2) :
-				this.each(function(){
-					jQuery(this)[ jQuery(this).is(":hidden") ? "show" : "hide" ]();
-				});
-	},
-	
-	/**
-	 * Reveal all matched elements by adjusting their height and firing an
-	 * optional callback after completion.
-	 *
-	 * Only the height is adjusted for this animation, causing all matched
-	 * elements to be revealed in a "sliding" manner.
-	 *
-	 * @example $("p").slideDown("slow");
-	 *
-	 * @example $("p").slideDown("slow",function(){
-	 *   alert("Animation Done.");
-	 * });
-	 *
-	 * @name slideDown
-	 * @type jQuery
-	 * @param String|Number speed (optional) A string representing one of the three predefined speeds ("slow", "normal", or "fast") or the number of milliseconds to run the animation (e.g. 1000).
-	 * @param Function callback (optional) A function to be executed whenever the animation completes.
-	 * @cat Effects
-	 * @see slideUp(String|Number,Function)
-	 * @see slideToggle(String|Number,Function)
-	 */
-	slideDown: function(speed,callback){
-		return this.animate({height: "show"}, speed, callback);
-	},
-	
-	/**
-	 * Hide all matched elements by adjusting their height and firing an
-	 * optional callback after completion.
-	 *
-	 * Only the height is adjusted for this animation, causing all matched
-	 * elements to be hidden in a "sliding" manner.
-	 *
-	 * @example $("p").slideUp("slow");
-	 *
-	 * @example $("p").slideUp("slow",function(){
-	 *   alert("Animation Done.");
-	 * });
-	 *
-	 * @name slideUp
-	 * @type jQuery
-	 * @param String|Number speed (optional) A string representing one of the three predefined speeds ("slow", "normal", or "fast") or the number of milliseconds to run the animation (e.g. 1000).
-	 * @param Function callback (optional) A function to be executed whenever the animation completes.
-	 * @cat Effects
-	 * @see slideDown(String|Number,Function)
-	 * @see slideToggle(String|Number,Function)
-	 */
-	slideUp: function(speed,callback){
-		return this.animate({height: "hide"}, speed, callback);
-	},
-
-	/**
-	 * Toggle the visibility of all matched elements by adjusting their height and firing an
-	 * optional callback after completion.
-	 *
-	 * Only the height is adjusted for this animation, causing all matched
-	 * elements to be hidden in a "sliding" manner.
-	 *
-	 * @example $("p").slideToggle("slow");
-	 *
-	 * @example $("p").slideToggle("slow",function(){
-	 *   alert("Animation Done.");
-	 * });
-	 *
-	 * @name slideToggle
-	 * @type jQuery
-	 * @param String|Number speed (optional) A string representing one of the three predefined speeds ("slow", "normal", or "fast") or the number of milliseconds to run the animation (e.g. 1000).
-	 * @param Function callback (optional) A function to be executed whenever the animation completes.
-	 * @cat Effects
-	 * @see slideDown(String|Number,Function)
-	 * @see slideUp(String|Number,Function)
-	 */
-	slideToggle: function(speed, callback){
-		return this.animate({height: "toggle"}, speed, callback);
-	},
-	
-	/**
-	 * Fade in all matched elements by adjusting their opacity and firing an
-	 * optional callback after completion.
-	 *
-	 * Only the opacity is adjusted for this animation, meaning that
-	 * all of the matched elements should already have some form of height
-	 * and width associated with them.
-	 *
-	 * @example $("p").fadeIn("slow");
-	 *
-	 * @example $("p").fadeIn("slow",function(){
-	 *   alert("Animation Done.");
-	 * });
-	 *
-	 * @name fadeIn
-	 * @type jQuery
-	 * @param String|Number speed (optional) A string representing one of the three predefined speeds ("slow", "normal", or "fast") or the number of milliseconds to run the animation (e.g. 1000).
-	 * @param Function callback (optional) A function to be executed whenever the animation completes.
-	 * @cat Effects
-	 * @see fadeOut(String|Number,Function)
-	 * @see fadeTo(String|Number,Number,Function)
-	 */
-	fadeIn: function(speed, callback){
-		return this.animate({opacity: "show"}, speed, callback);
-	},
-	
-	/**
-	 * Fade out all matched elements by adjusting their opacity and firing an
-	 * optional callback after completion.
-	 *
-	 * Only the opacity is adjusted for this animation, meaning that
-	 * all of the matched elements should already have some form of height
-	 * and width associated with them.
-	 *
-	 * @example $("p").fadeOut("slow");
-	 *
-	 * @example $("p").fadeOut("slow",function(){
-	 *   alert("Animation Done.");
-	 * });
-	 *
-	 * @name fadeOut
-	 * @type jQuery
-	 * @param String|Number speed (optional) A string representing one of the three predefined speeds ("slow", "normal", or "fast") or the number of milliseconds to run the animation (e.g. 1000).
-	 * @param Function callback (optional) A function to be executed whenever the animation completes.
-	 * @cat Effects
-	 * @see fadeIn(String|Number,Function)
-	 * @see fadeTo(String|Number,Number,Function)
-	 */
-	fadeOut: function(speed, callback){
-		return this.animate({opacity: "hide"}, speed, callback);
-	},
-	
-	/**
-	 * Fade the opacity of all matched elements to a specified opacity and firing an
-	 * optional callback after completion.
-	 *
-	 * Only the opacity is adjusted for this animation, meaning that
-	 * all of the matched elements should already have some form of height
-	 * and width associated with them.
-	 *
-	 * @example $("p").fadeTo("slow", 0.5);
-	 *
-	 * @example $("p").fadeTo("slow", 0.5, function(){
-	 *   alert("Animation Done.");
-	 * });
-	 *
-	 * @name fadeTo
-	 * @type jQuery
-	 * @param String|Number speed A string representing one of the three predefined speeds ("slow", "normal", or "fast") or the number of milliseconds to run the animation (e.g. 1000).
-	 * @param Number opacity The opacity to fade to (a number from 0 to 1).
-	 * @param Function callback (optional) A function to be executed whenever the animation completes.
-	 * @cat Effects
-	 * @see fadeIn(String|Number,Function)
-	 * @see fadeOut(String|Number,Function)
-	 */
-	fadeTo: function(speed,to,callback){
-		return this.animate({opacity: to}, speed, callback);
-	},
-	
-	/**
-	 * A function for making your own, custom animations. The key aspect of
-	 * this function is the object of style properties that will be animated,
-	 * and to what end. Each key within the object represents a style property
-	 * that will also be animated (for example: "height", "top", or "opacity").
-	 *
-	 * Note that properties should be specified using camel case
-	 * eg. marginLeft instead of margin-left.
-	 *
-	 * The value associated with the key represents to what end the property
-	 * will be animated. If a number is provided as the value, then the style
-	 * property will be transitioned from its current state to that new number.
-	 * Otherwise if the string "hide", "show", or "toggle" is provided, a default
-	 * animation will be constructed for that property.
-	 *
-	 * @example $("p").animate({
-	 *   height: 'toggle', opacity: 'toggle'
-	 * }, "slow");
-	 *
-	 * @example $("p").animate({
-	 *   left: 50, opacity: 'show'
-	 * }, 500);
-	 *
-	 * @example $("p").animate({
-	 *   opacity: 'show'
-	 * }, "slow", "easein");
-	 * @desc An example of using an 'easing' function to provide a different style of animation. This will only work if you have a plugin that provides this easing function (Only "swing" and "linear" are provided by default, with jQuery).
-	 *
-	 * @name animate
-	 * @type jQuery
-	 * @param Hash params A set of style attributes that you wish to animate, and to what end.
-	 * @param String|Number speed (optional) A string representing one of the three predefined speeds ("slow", "normal", or "fast") or the number of milliseconds to run the animation (e.g. 1000).
-	 * @param String easing (optional) The name of the easing effect that you want to use (e.g. "swing" or "linear"). Defaults to "swing".
-	 * @param Function callback (optional) A function to be executed whenever the animation completes.
-	 * @cat Effects
-	 */
-	animate: function( prop, speed, easing, callback ) {
-		return this.queue(function(){
-			var hidden = jQuery(this).is(":hidden"),
-				opt = jQuery.speed(speed, easing, callback),
-				self = this;
-			
-			for ( var p in prop )
-				if ( prop[p] == "hide" && hidden || prop[p] == "show" && !hidden )
-					return jQuery.isFunction(opt.complete) && opt.complete.apply(this);
-
-			this.curAnim = jQuery.extend({}, prop);
-			
-			jQuery.each( prop, function(name, val){
-				var e = new jQuery.fx( self, opt, name );
-				if ( val.constructor == Number )
-					e.custom( e.cur(), val );
-				else
-					e[ val == "toggle" ? hidden ? "show" : "hide" : val ]( prop );
-			});
-		});
-	},
-	
-	/**
-	 *
-	 * @private
-	 */
-	queue: function(type,fn){
-		if ( !fn ) {
-			fn = type;
-			type = "fx";
-		}
-	
-		return this.each(function(){
-			if ( !this.queue )
-				this.queue = {};
-	
-			if ( !this.queue[type] )
-				this.queue[type] = [];
-	
-			this.queue[type].push( fn );
-		
-			if ( this.queue[type].length == 1 )
-				fn.apply(this);
-		});
-	}
-
-});
-
-jQuery.extend({
-	
-	speed: function(speed, easing, fn) {
-		var opt = speed && speed.constructor == Object ? speed : {
-			complete: fn || !fn && easing || 
-				jQuery.isFunction( speed ) && speed,
-			duration: speed,
-			easing: fn && easing || easing && easing.constructor != Function && easing || (jQuery.easing.swing ? "swing" : "linear")
-		};
-
-		opt.duration = (opt.duration && opt.duration.constructor == Number ? 
-			opt.duration : 
-			{ slow: 600, fast: 200 }[opt.duration]) || 400;
-	
-		// Queueing
-		opt.old = opt.complete;
-		opt.complete = function(){
-			jQuery.dequeue(this, "fx");
-			if ( jQuery.isFunction( opt.old ) )
-				opt.old.apply( this );
-		};
-	
-		return opt;
-	},
-	
-	easing: {
-		linear: function( p, n, firstNum, diff ) {
-			return firstNum + diff * p;
-		},
-		swing: function( p, n, firstNum, diff ) {
-			return ((-Math.cos(p*Math.PI)/2) + 0.5) * diff + firstNum;
-		}
-	},
-	
-	queue: {},
-	
-	dequeue: function(elem,type){
-		type = type || "fx";
-	
-		if ( elem.queue && elem.queue[type] ) {
-			// Remove self
-			elem.queue[type].shift();
-	
-			// Get next function
-			var f = elem.queue[type][0];
-		
-			if ( f ) f.apply( elem );
-		}
-	},
-
-	timers: [],
-
-	/*
-	 * I originally wrote fx() as a clone of moo.fx and in the process
-	 * of making it small in size the code became illegible to sane
-	 * people. You've been warned.
-	 */
-	
-	fx: function( elem, options, prop ){
-
-		var z = this;
-
-		// The styles
-		var y = elem.style;
-		
-		if ( prop == "height" || prop == "width" ) {
-			// Store display property
-			var oldDisplay = jQuery.css(elem, "display");
-
-			// Make sure that nothing sneaks out
-			var oldOverflow = y.overflow;
-			y.overflow = "hidden";
-		}
-
-		// Simple function for setting a style value
-		z.a = function(){
-			if ( options.step )
-				options.step.apply( elem, [ z.now ] );
-
-			if ( prop == "opacity" )
-				jQuery.attr(y, "opacity", z.now); // Let attr handle opacity
-			else {
-				y[prop] = parseInt(z.now) + "px";
-				y.display = "block"; // Set display property to block for animation
-			}
-		};
-
-		// Figure out the maximum number to run to
-		z.max = function(){
-			return parseFloat( jQuery.css(elem,prop) );
-		};
-
-		// Get the current size
-		z.cur = function(){
-			var r = parseFloat( jQuery.curCSS(elem, prop) );
-			return r && r > -10000 ? r : z.max();
-		};
-
-		// Start an animation from one number to another
-		z.custom = function(from,to){
-			z.startTime = (new Date()).getTime();
-			z.now = from;
-			z.a();
-
-			jQuery.timers.push(function(){
-				return z.step(from, to);
-			});
-
-			if ( jQuery.timers.length == 1 ) {
-				var timer = setInterval(function(){
-					var timers = jQuery.timers;
-					
-					for ( var i = 0; i < timers.length; i++ )
-						if ( !timers[i]() )
-							timers.splice(i--, 1);
-
-					if ( !timers.length )
-						clearInterval( timer );
-				}, 13);
-			}
-		};
-
-		// Simple 'show' function
-		z.show = function(){
-			if ( !elem.orig ) elem.orig = {};
-
-			// Remember where we started, so that we can go back to it later
-			elem.orig[prop] = jQuery.attr( elem.style, prop );
-
-			options.show = true;
-
-			// Begin the animation
-			z.custom(0, this.cur());
-
-			// Make sure that we start at a small width/height to avoid any
-			// flash of content
-			if ( prop != "opacity" )
-				y[prop] = "1px";
-			
-			// Start by showing the element
-			jQuery(elem).show();
-		};
-
-		// Simple 'hide' function
-		z.hide = function(){
-			if ( !elem.orig ) elem.orig = {};
-
-			// Remember where we started, so that we can go back to it later
-			elem.orig[prop] = jQuery.attr( elem.style, prop );
-
-			options.hide = true;
-
-			// Begin the animation
-			z.custom(this.cur(), 0);
-		};
-
-		// Each step of an animation
-		z.step = function(firstNum, lastNum){
-			var t = (new Date()).getTime();
-
-			if (t > options.duration + z.startTime) {
-				z.now = lastNum;
-				z.a();
-
-				if (elem.curAnim) elem.curAnim[ prop ] = true;
-
-				var done = true;
-				for ( var i in elem.curAnim )
-					if ( elem.curAnim[i] !== true )
-						done = false;
-
-				if ( done ) {
-					if ( oldDisplay != null ) {
-						// Reset the overflow
-						y.overflow = oldOverflow;
-					
-						// Reset the display
-						y.display = oldDisplay;
-						if ( jQuery.css(elem, "display") == "none" )
-							y.display = "block";
-					}
-
-					// Hide the element if the "hide" operation was done
-					if ( options.hide )
-						y.display = "none";
-
-					// Reset the properties, if the item has been hidden or shown
-					if ( options.hide || options.show )
-						for ( var p in elem.curAnim )
-							jQuery.attr(y, p, elem.orig[p]);
-				}
-
-				// If a callback was provided, execute it
-				if ( done && jQuery.isFunction( options.complete ) )
-					// Execute the complete function
-					options.complete.apply( elem );
-
-				return false;
-			} else {
-				var n = t - this.startTime;
-				// Figure out where in the animation we are and set the number
-				var p = n / options.duration;
-				
-				// Perform the easing function, defaults to swing
-				z.now = jQuery.easing[options.easing](p, n, firstNum, (lastNum-firstNum), options.duration);
-
-				// Perform the next step of the animation
-				z.a();
-			}
-
-			return true;
-		};
-	
-	}
-});
diff --git a/dom/tests/mochitest/ajax/jquery/src/fx/fxTest.js b/dom/tests/mochitest/ajax/jquery/src/fx/fxTest.js
deleted file mode 100644
--- a/dom/tests/mochitest/ajax/jquery/src/fx/fxTest.js
+++ /dev/null
@@ -1,22 +0,0 @@
-module("fx");
-
-test("animate(Hash, Object, Function)", function() {
-	expect(1);
-	stop();
-	var hash = {opacity: 'show'};
-	var hashCopy = $.extend({}, hash);
-	$('#foo').animate(hash, 0, function() {
-		ok( hash.opacity == hashCopy.opacity, 'Check if animate changed the hash parameter' );
-		start();
-	});
-});
-
-test("toggle()", function() {
-	expect(3);
-	var x = $("#foo");
-	ok( x.is(":visible") );
-	x.toggle();
-	ok( x.is(":hidden") );
-	x.toggle();
-	ok( x.is(":visible") );
-});
\ No newline at end of file
diff --git a/dom/tests/mochitest/ajax/jquery/src/intro.js b/dom/tests/mochitest/ajax/jquery/src/intro.js
deleted file mode 100644
--- a/dom/tests/mochitest/ajax/jquery/src/intro.js
+++ /dev/null
@@ -1,2 +0,0 @@
-// prevent execution of jQuery if included more than once
-if(typeof window.jQuery == "undefined") {
diff --git a/dom/tests/mochitest/ajax/jquery/src/jquery/Makefile.in b/dom/tests/mochitest/ajax/jquery/src/jquery/Makefile.in
deleted file mode 100644
--- a/dom/tests/mochitest/ajax/jquery/src/jquery/Makefile.in
+++ /dev/null
@@ -1,57 +0,0 @@
-#
-# ***** BEGIN LICENSE BLOCK *****
-# Version: MPL 1.1/GPL 2.0/LGPL 2.1
-#
-# The contents of this file are subject to the Mozilla Public License Version
-# 1.1 (the "License"); you may not use this file except in compliance with
-# the License. You may obtain a copy of the License at
-# http://www.mozilla.org/MPL/
-#
-# Software distributed under the License is distributed on an "AS IS" basis,
-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
-# for the specific language governing rights and limitations under the
-# License.
-#
-# The Original Code is mozilla.org code.
-#
-# The Initial Developer of the Original Code is
-# Mozilla Foundation.
-# Portions created by the Initial Developer are Copyright (C) 2007
-# the Initial Developer. All Rights Reserved.
-#
-# Contributor(s):
-#
-# Alternatively, the contents of this file may be used under the terms of
-# either of the GNU General Public License Version 2 or later (the "GPL"),
-# or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
-# in which case the provisions of the GPL or the LGPL are applicable instead
-# of those above. If you wish to allow use of your version of this file only
-# under the terms of either the GPL or the LGPL, and not to allow others to
-# use your version of this file under the terms of the MPL, indicate your
-# decision by deleting the provisions above and replace them with the notice
-# and other provisions required by the GPL or the LGPL. If you do not delete
-# the provisions above, a recipient may use your version of this file under
-# the terms of any one of the MPL, the GPL or the LGPL.
-#
-# ***** END LICENSE BLOCK *****
-
-DEPTH		= ../../../../../../..
-topsrcdir	= @top_srcdir@
-srcdir		= @srcdir@
-VPATH		= @srcdir@
-relativesrcdir	= dom/tests/mochitest/ajax/jquery/src/jquery
-
-include $(DEPTH)/config/autoconf.mk
-
-DIRS	= \
-	$(NULL)
-
-include $(topsrcdir)/config/rules.mk
-
-_TEST_FILES	= \
-	coreTest.js \
-	jquery.js \
-	$(NULL)
-
-libs::	$(_TEST_FILES)
-	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
diff --git a/dom/tests/mochitest/ajax/jquery/src/jquery/coreTest.js b/dom/tests/mochitest/ajax/jquery/src/jquery/coreTest.js
deleted file mode 100644
--- a/dom/tests/mochitest/ajax/jquery/src/jquery/coreTest.js
+++ /dev/null
@@ -1,893 +0,0 @@
-module("core");
-
-test("Basic requirements", function() {
-	expect(7);
-	ok( Array.prototype.push, "Array.push()" );
-	ok( Function.prototype.apply, "Function.apply()" );
-	ok( document.getElementById, "getElementById" );
-	ok( document.getElementsByTagName, "getElementsByTagName" );
-	ok( RegExp, "RegExp" );
-	ok( jQuery, "jQuery" );
-	ok( $, "$()" );
-});
-
-test("$()", function() {
-	expect(2);
-	
-	var main = $("#main");
-	isSet( $("div p", main).get(), q("sndp", "en", "sap"), "Basic selector with jQuery object as context" );
-	
-	// make sure this is handled
-	$('<p>\r\n</p>');
-	ok( true, "Check for \\r and \\n in jQuery()" );
-
-/*	
-	var pass = true;
-	try {
-		var f = document.getElementById("iframe").contentDocument;
-		f.open();
-		f.write("<html><body></body></html>");
-		f.close();
-		$("<div>Testing</div>").appendTo(f.body);
-	} catch(e){
-		pass = false;
-	}
-	ok( pass, "$('&lt;tag&gt;') needs optional document parameter to ease cross-frame DOM wrangling, see #968" );
-*/
-});
-
-test("isFunction", function() {
-	expect(21);
-
-	// Make sure that false values return false
-	ok( !jQuery.isFunction(), "No Value" );
-	ok( !jQuery.isFunction( null ), "null Value" );
-	ok( !jQuery.isFunction( undefined ), "undefined Value" );
-	ok( !jQuery.isFunction( "" ), "Empty String Value" );
-	ok( !jQuery.isFunction( 0 ), "0 Value" );
-
-	// Check built-ins
-	// Safari uses "(Internal Function)"
-	ok( jQuery.isFunction(String), "String Function" );
-	ok( jQuery.isFunction(Array), "Array Function" );
-	ok( jQuery.isFunction(Object), "Object Function" );
-	ok( jQuery.isFunction(Function), "Function Function" );
-
-	// When stringified, this could be misinterpreted
-	var mystr = "function";
-	ok( !jQuery.isFunction(mystr), "Function String" );
-
-	// When stringified, this could be misinterpreted
-	var myarr = [ "function" ];
-	ok( !jQuery.isFunction(myarr), "Function Array" );
-
-	// When stringified, this could be misinterpreted
-	var myfunction = { "function": "test" };
-	ok( !jQuery.isFunction(myfunction), "Function Object" );
-
-	// Make sure normal functions still work
-	var fn = function(){};
-	ok( jQuery.isFunction(fn), "Normal Function" );
-
-	var obj = document.createElement("object");
-
-	// Firefox says this is a function
-	ok( !jQuery.isFunction(obj), "Object Element" );
-
-	// IE says this is an object
-	ok( jQuery.isFunction(obj.getAttribute), "getAttribute Function" );
-
-	var nodes = document.body.childNodes;
-
-	// Safari says this is a function
-	ok( !jQuery.isFunction(nodes), "childNodes Property" );
-
-	var first = document.body.firstChild;
-	
-	// Normal elements are reported ok everywhere
-	ok( !jQuery.isFunction(first), "A normal DOM Element" );
-
-	var input = document.createElement("input");
-	input.type = "text";
-	document.body.appendChild( input );
-
-	// IE says this is an object
-	ok( jQuery.isFunction(input.focus), "A default function property" );
-
-	document.body.removeChild( input );
-
-	var a = document.createElement("a");
-	a.href = "some-function";
-	document.body.appendChild( a );
-
-	// This serializes with the word 'function' in it
-	ok( !jQuery.isFunction(a), "Anchor Element" );
-
-	document.body.removeChild( a );
-
-	// Recursive function calls have lengths and array-like properties
-	function callme(callback){
-		function fn(response){
-			callback(response);
-		}
-
-		ok( jQuery.isFunction(fn), "Recursive Function Call" );
-
-    	fn({ some: "data" });
-	};
-
-	callme(function(){
-    	callme(function(){});
-	});
-});
-
-test("length", function() {
-	expect(1);
-	ok( $("div").length == 2, "Get Number of Elements Found" );
-});
-
-test("size()", function() {
-	expect(1);
-	ok( $("div").size() == 2, "Get Number of Elements Found" );
-});
-
-test("get()", function() {
-	expect(1);
-	isSet( $("div").get(), q("main","foo"), "Get All Elements" );
-});
-
-test("get(Number)", function() {
-	expect(1);
-	ok( $("div").get(0) == document.getElementById("main"), "Get A Single Element" );
-});
-
-test("add(String|Element|Array)", function() {
-	expect(7);
-	isSet( $("#sndp").add("#en").add("#sap").get(), q("sndp", "en", "sap"), "Check elements from document" );
-	isSet( $("#sndp").add( $("#en")[0] ).add( $("#sap") ).get(), q("sndp", "en", "sap"), "Check elements from document" );
-	ok( $([]).add($("#form")[0].elements).length > 13, "Check elements from array" );
-	
-	var x = $([]).add($("<p id='x1'>xxx</p>")).add($("<p id='x2'>xxx</p>"));
-	ok( x[0].id == "x1", "Check on-the-fly element1" );
-	ok( x[1].id == "x2", "Check on-the-fly element2" );
-	
-	var x = $([]).add("<p id='x1'>xxx</p>").add("<p id='x2'>xxx</p>");
-	ok( x[0].id == "x1", "Check on-the-fly element1" );
-	ok( x[1].id == "x2", "Check on-the-fly element2" );
-});
-
-test("each(Function)", function() {
-	expect(1);
-	var div = $("div");
-	div.each(function(){this.foo = 'zoo';});
-	var pass = true;
-	for ( var i = 0; i < div.size(); i++ ) {
-	  if ( div.get(i).foo != "zoo" ) pass = false;
-	}
-	ok( pass, "Execute a function, Relative" );
-});
-
-test("index(Object)", function() {
-	expect(8);
-	ok( $([window, document]).index(window) == 0, "Check for index of elements" );
-	ok( $([window, document]).index(document) == 1, "Check for index of elements" );
-	var inputElements = $('#radio1,#radio2,#check1,#check2');
-	ok( inputElements.index(document.getElementById('radio1')) == 0, "Check for index of elements" );
-	ok( inputElements.index(document.getElementById('radio2')) == 1, "Check for index of elements" );
-	ok( inputElements.index(document.getElementById('check1')) == 2, "Check for index of elements" );
-	ok( inputElements.index(document.getElementById('check2')) == 3, "Check for index of elements" );
-	ok( inputElements.index(window) == -1, "Check for not found index" );
-	ok( inputElements.index(document) == -1, "Check for not found index" );
-});
-
-test("attr(String)", function() {
-	expect(13);
-	ok( $('#text1').attr('value') == "Test", 'Check for value attribute' );
-	ok( $('#text1').attr('type') == "text", 'Check for type attribute' );
-	ok( $('#radio1').attr('type') == "radio", 'Check for type attribute' );
-	ok( $('#check1').attr('type') == "checkbox", 'Check for type attribute' );
-	ok( $('#simon1').attr('rel') == "bookmark", 'Check for rel attribute' );
-	ok( $('#google').attr('title') == "Google!", 'Check for title attribute' );
-	ok( $('#mark').attr('hreflang') == "en", 'Check for hreflang attribute' );
-	ok( $('#en').attr('lang') == "en", 'Check for lang attribute' );
-	ok( $('#simon').attr('class') == "blog link", 'Check for class attribute' );
-	ok( $('#name').attr('name') == "name", 'Check for name attribute' );
-	ok( $('#text1').attr('name') == "action", 'Check for name attribute' );
-	ok( $('#form').attr('action').indexOf("formaction") >= 0, 'Check for action attribute' );
-	
-	$('<a id="tAnchor5"></a>').attr('href', '#5').appendTo('#main'); // using innerHTML in IE causes href attribute to be serialized to the full path
-	ok( $('#tAnchor5').attr('href') == "#5", 'Check for non-absolute href (an anchor)' );
-});
-
-/*if ( location.protocol != "file:" ) {
-	test("attr(String) in XML Files", function() {
-		expect(2);
-		stop();
-		$.get("data/dashboard.xml", function(xml) {
-			ok( $("locations", xml).attr("class") == "foo", "Check class attribute in XML document" );
-			ok( $("location", xml).attr("for") == "bar", "Check for attribute in XML document" );
-			start();
-		});
-	});
-}*/
-
-test("attr(String, Function)", function() {
-	expect(2);
-	ok( $('#text1').attr('value', function() { return this.id })[0].value == "text1", "Set value from id" );
-	ok( $('#text1').attr('title', function(i) { return i }).attr('title') == "0", "Set value with an index");
-});
-
-test("attr(Hash)", function() {
-	expect(1);
-	var pass = true;
-	$("div").attr({foo: 'baz', zoo: 'ping'}).each(function(){
-	  if ( this.getAttribute('foo') != "baz" && this.getAttribute('zoo') != "ping" ) pass = false;
-	});
-	ok( pass, "Set Multiple Attributes" );
-});
-
-test("attr(String, Object)", function() {
-	expect(8);
-	var div = $("div");
-	div.attr("foo", "bar");
-	var pass = true;
-	for ( var i = 0; i < div.size(); i++ ) {
-	  if ( div.get(i).getAttribute('foo') != "bar" ) pass = false;
-	}
-	ok( pass, "Set Attribute" );
-
-	ok( $("#foo").attr({"width": null}), "Try to set an attribute to nothing" );	
-	
-	$("#name").attr('name', 'something');
-	ok( $("#name").attr('name') == 'something', 'Set name attribute' );
-	$("#check2").attr('checked', true);
-	ok( document.getElementById('check2').checked == true, 'Set checked attribute' );
-	$("#check2").attr('checked', false);
-	ok( document.getElementById('check2').checked == false, 'Set checked attribute' );
-	$("#text1").attr('readonly', true);
-	ok( document.getElementById('text1').readOnly == true, 'Set readonly attribute' );
-	$("#text1").attr('readonly', false);
-	ok( document.getElementById('text1').readOnly == false, 'Set readonly attribute' );
-	$("#name").attr('maxlength', '5');
-	ok( document.getElementById('name').maxLength == '5', 'Set maxlength attribute' );
-});
-
-/*if ( location.protocol != "file:" ) {
-	test("attr(String, Object)x", function() {
-		expect(2);
-		stop();
-		$.get('data/dashboard.xml', function(xml) { 
-	  	var titles = [];
-	  	$('tab', xml).each(function() {
-	    	titles.push($(this).attr('title'));
-	  	});
-	  	ok( titles[0] == 'Location', 'attr() in XML context: Check first title' );
-	  	ok( titles[1] == 'Users', 'attr() in XML context: Check second title' );
-	  	start();
-		});
-	});
-}*/
-
-test("css(String|Hash)", function() {
-	expect(19);
-	
-	ok( $('#main').css("display") == 'none', 'Check for css property "display"');
-	
-	ok( $('#foo').is(':visible'), 'Modifying CSS display: Assert element is visible');
-	$('#foo').css({display: 'none'});
-	ok( !$('#foo').is(':visible'), 'Modified CSS display: Assert element is hidden');
-	$('#foo').css({display: 'block'});
-	ok( $('#foo').is(':visible'), 'Modified CSS display: Assert element is visible');
-	
-	$('#floatTest').css({styleFloat: 'right'});
-	ok( $('#floatTest').css('styleFloat') == 'right', 'Modified CSS float using "styleFloat": Assert float is right');
-	$('#floatTest').css({cssFloat: 'left'});
-	ok( $('#floatTest').css('cssFloat') == 'left', 'Modified CSS float using "cssFloat": Assert float is left');
-	$('#floatTest').css({'float': 'right'});
-	ok( $('#floatTest').css('float') == 'right', 'Modified CSS float using "float": Assert float is right');
-	$('#floatTest').css({'font-size': '30px'});
-	ok( $('#floatTest').css('font-size') == '30px', 'Modified CSS font-size: Assert font-size is 30px');
-	
-	$.each("0,0.25,0.5,0.75,1".split(','), function(i, n) {
-		$('#foo').css({opacity: n});
-		ok( $('#foo').css('opacity') == parseFloat(n), "Assert opacity is " + parseFloat(n) + " as a String" );
-		$('#foo').css({opacity: parseFloat(n)});
-		ok( $('#foo').css('opacity') == parseFloat(n), "Assert opacity is " + parseFloat(n) + " as a Number" );
-	});	
-	$('#foo').css({opacity: ''});
-	ok( $('#foo').css('opacity') == '1', "Assert opacity is 1 when set to an empty String" );
-});
-
-test("css(String, Object)", function() {
-	expect(18);
-	ok( $('#foo').is(':visible'), 'Modifying CSS display: Assert element is visible');
-	$('#foo').css('display', 'none');
-	ok( !$('#foo').is(':visible'), 'Modified CSS display: Assert element is hidden');
-	$('#foo').css('display', 'block');
-	ok( $('#foo').is(':visible'), 'Modified CSS display: Assert element is visible');
-	
-	$('#floatTest').css('styleFloat', 'left');
-	ok( $('#floatTest').css('styleFloat') == 'left', 'Modified CSS float using "styleFloat": Assert float is left');
-	$('#floatTest').css('cssFloat', 'right');
-	ok( $('#floatTest').css('cssFloat') == 'right', 'Modified CSS float using "cssFloat": Assert float is right');
-	$('#floatTest').css('float', 'left');
-	ok( $('#floatTest').css('float') == 'left', 'Modified CSS float using "float": Assert float is left');
-	$('#floatTest').css('font-size', '20px');
-	ok( $('#floatTest').css('font-size') == '20px', 'Modified CSS font-size: Assert font-size is 20px');
-	
-	$.each("0,0.25,0.5,0.75,1".split(','), function(i, n) {
-		$('#foo').css('opacity', n);
-		ok( $('#foo').css('opacity') == parseFloat(n), "Assert opacity is " + parseFloat(n) + " as a String" );
-		$('#foo').css('opacity', parseFloat(n));
-		ok( $('#foo').css('opacity') == parseFloat(n), "Assert opacity is " + parseFloat(n) + " as a Number" );
-	});
-	$('#foo').css('opacity', '');
-	ok( $('#foo').css('opacity') == '1', "Assert opacity is 1 when set to an empty String" );
-});
-
-test("text()", function() {
-	expect(1);
-	var expected = "This link has class=\"blog\": Simon Willison's Weblog";
-	ok( $('#sap').text() == expected, 'Check for merged text of more then one element.' );
-});
-
-test("wrap(String|Element)", function() {
-	expect(7);
-	var defaultText = 'Try them out:'
-	var result = $('#first').wrap('<div class="red"><span></span></div>').text();
-	ok( defaultText == result, 'Check for wrapping of on-the-fly html' );
-	ok( $('#first').parent().parent().is('.red'), 'Check if wrapper has class "red"' );
-
-	reset();
-	var defaultText = 'Try them out:'
-	var result = $('#first').wrap(document.getElementById('empty')).parent();
-	ok( result.is('ol'), 'Check for element wrapping' );
-	ok( result.text() == defaultText, 'Check for element wrapping' );
-	
-	reset();
-	stop();
-	$('#check1').click(function() {		
-		var checkbox = this;		
-		ok( checkbox.checked, "Checkbox's state is erased after wrap() action, see #769" );
-		$(checkbox).wrap( '<div id="c1" style="display:none;"></div>' );
-		ok( checkbox.checked, "Checkbox's state is erased after wrap() action, see #769" );
-		// use a fade in to check state after this event handler has finished
-		setTimeout(function() {
-			ok( !checkbox.checked, "Checkbox's state is erased after wrap() action, see #769" );
-			start();
-		}, 100);
-	}).click();
-});
-
-test("append(String|Element|Array&lt;Element&gt;|jQuery)", function() {
-	expect(17);
-	var defaultText = 'Try them out:'
-	var result = $('#first').append('<b>buga</b>');
-	ok( result.text() == defaultText + 'buga', 'Check if text appending works' );
-	ok( $('#select3').append('<option value="appendTest">Append Test</option>').find('option:last-child').attr('value') == 'appendTest', 'Appending html options to select element');
-	
-	reset();
-	var expected = "This link has class=\"blog\": Simon Willison's WeblogTry them out:";
-	$('#sap').append(document.getElementById('first'));
-	ok( expected == $('#sap').text(), "Check for appending of element" );
-	
-	reset();
-	expected = "This link has class=\"blog\": Simon Willison's WeblogTry them out:Yahoo";
-	$('#sap').append([document.getElementById('first'), document.getElementById('yahoo')]);
-	ok( expected == $('#sap').text(), "Check for appending of array of elements" );
-	
-	reset();
-	expected = "This link has class=\"blog\": Simon Willison's WeblogTry them out:Yahoo";
-	$('#sap').append($("#first, #yahoo"));
-	ok( expected == $('#sap').text(), "Check for appending of jQuery object" );
-
-	reset();
-	$("#sap").append( 5 );
-	ok( $("#sap")[0].innerHTML.match( /5$/ ), "Check for appending a number" );
-
-	reset();
-	$("#sap").append( " text with spaces " );
-	ok( $("#sap")[0].innerHTML.match(/ text with spaces $/), "Check for appending text with spaces" );
-
-	reset();
-	ok( $("#sap").append([]), "Check for appending an empty array." );
-	ok( $("#sap").append(""), "Check for appending an empty string." );
-	ok( $("#sap").append(document.getElementsByTagName("foo")), "Check for appending an empty nodelist." );
-	
-	reset();
-	$("#sap").append(document.getElementById('form'));
-	ok( $("#sap>form").size() == 1, "Check for appending a form" );  // Bug #910
-
-	reset();
-	var pass = true;
-	try {
-		$( $("iframe")[0].contentWindow.document.body ).append("<div>test</div>");
-	} catch(e) {
-		pass = false;
-	}
-
-	ok( pass, "Test for appending a DOM node to the contents of an IFrame" );
-	
-	reset();
-	$('<fieldset>').appendTo('#form').append('<legend id="legend">test</legend>');
-	t( 'Append legend', '#legend', ['legend'] );
-	
-	reset();
-	$('#select1').append('<OPTION>Test</OPTION>');
-	ok( $('#select1 option:last').text() == "Test", "Appending &lt;OPTION&gt; (all caps)" );
-	
-	$('#table').append('<colgroup></colgroup>');
-	ok( $('#table colgroup').length, "Append colgroup" );
-	
-	$('#table colgroup').append('<col>');
-	ok( $('#table colgroup col').length, "Append col" );
-	
-	reset();
-	$('form:last')
-		.append('<select id="appendSelect1"></select>')
-		.append('<select id="appendSelect2"><option>Test</option></select>');
-	
-	t( "Append Select", "#appendSelect1, #appendSelect2", ["appendSelect1", "appendSelect2"] );
-});
-
-test("appendTo(String|Element|Array&lt;Element&gt;|jQuery)", function() {
-	expect(6);
-	var defaultText = 'Try them out:'
-	$('<b>buga</b>').appendTo('#first');
-	ok( $("#first").text() == defaultText + 'buga', 'Check if text appending works' );
-	ok( $('<option value="appendTest">Append Test</option>').appendTo('#select3').parent().find('option:last-child').attr('value') == 'appendTest', 'Appending html options to select element');
-	
-	reset();
-	var expected = "This link has class=\"blog\": Simon Willison's WeblogTry them out:";
-	$(document.getElementById('first')).appendTo('#sap');
-	ok( expected == $('#sap').text(), "Check for appending of element" );
-	
-	reset();
-	expected = "This link has class=\"blog\": Simon Willison's WeblogTry them out:Yahoo";
-	$([document.getElementById('first'), document.getElementById('yahoo')]).appendTo('#sap');
-	ok( expected == $('#sap').text(), "Check for appending of array of elements" );
-	
-	reset();
-	expected = "This link has class=\"blog\": Simon Willison's WeblogTry them out:Yahoo";
-	$("#first, #yahoo").appendTo('#sap');
-	ok( expected == $('#sap').text(), "Check for appending of jQuery object" );
-	
-	reset();
-	$('#select1').appendTo('#foo');
-	t( 'Append select', '#foo select', ['select1'] );
-});
-
-test("prepend(String|Element|Array&lt;Element&gt;|jQuery)", function() {
-	expect(5);
-	var defaultText = 'Try them out:'
-	var result = $('#first').prepend('<b>buga</b>');
-	ok( result.text() == 'buga' + defaultText, 'Check if text prepending works' );
-	ok( $('#select3').prepend('<option value="prependTest">Prepend Test</option>').find('option:first-child').attr('value') == 'prependTest', 'Prepending html options to select element');
-	
-	reset();
-	var expected = "Try them out:This link has class=\"blog\": Simon Willison's Weblog";
-	$('#sap').prepend(document.getElementById('first'));
-	ok( expected == $('#sap').text(), "Check for prepending of element" );
-
-	reset();
-	expected = "Try them out:YahooThis link has class=\"blog\": Simon Willison's Weblog";
-	$('#sap').prepend([document.getElementById('first'), document.getElementById('yahoo')]);
-	ok( expected == $('#sap').text(), "Check for prepending of array of elements" );
-	
-	reset();
-	expected = "Try them out:YahooThis link has class=\"blog\": Simon Willison's Weblog";
-	$('#sap').prepend($("#first, #yahoo"));
-	ok( expected == $('#sap').text(), "Check for prepending of jQuery object" );
-});
-
-test("prependTo(String|Element|Array&lt;Element&gt;|jQuery)", function() {
-	expect(6);
-	var defaultText = 'Try them out:'
-	$('<b>buga</b>').prependTo('#first');
-	ok( $('#first').text() == 'buga' + defaultText, 'Check if text prepending works' );
-	ok( $('<option value="prependTest">Prepend Test</option>').prependTo('#select3').parent().find('option:first-child').attr('value') == 'prependTest', 'Prepending html options to select element');
-	
-	reset();
-	var expected = "Try them out:This link has class=\"blog\": Simon Willison's Weblog";
-	$(document.getElementById('first')).prependTo('#sap');
-	ok( expected == $('#sap').text(), "Check for prepending of element" );
-
-	reset();
-	expected = "Try them out:YahooThis link has class=\"blog\": Simon Willison's Weblog";
-	$([document.getElementById('yahoo'), document.getElementById('first')]).prependTo('#sap');
-	ok( expected == $('#sap').text(), "Check for prepending of array of elements" );
-	
-	reset();
-	expected = "Try them out:YahooThis link has class=\"blog\": Simon Willison's Weblog";
-	$("#yahoo, #first").prependTo('#sap');
-	ok( expected == $('#sap').text(), "Check for prepending of jQuery object" );
-	
-	reset();
-	$('<select id="prependSelect1"></select>').prependTo('form:last');
-	$('<select id="prependSelect2"><option>Test</option></select>').prependTo('form:last');
-	
-	t( "Prepend Select", "#prependSelect1, #prependSelect2", ["prependSelect1", "prependSelect2"] );
-});
-
-test("before(String|Element|Array&lt;Element&gt;|jQuery)", function() {
-	expect(4);
-	var expected = 'This is a normal link: bugaYahoo';
-	$('#yahoo').before('<b>buga</b>');
-	ok( expected == $('#en').text(), 'Insert String before' );
-	
-	reset();
-	expected = "This is a normal link: Try them out:Yahoo";
-	$('#yahoo').before(document.getElementById('first'));
-	ok( expected == $('#en').text(), "Insert element before" );
-	
-	reset();
-	expected = "This is a normal link: Try them out:diveintomarkYahoo";
-	$('#yahoo').before([document.getElementById('first'), document.getElementById('mark')]);
-	ok( expected == $('#en').text(), "Insert array of elements before" );
-	
-	reset();
-	expected = "This is a normal link: Try them out:diveintomarkYahoo";
-	$('#yahoo').before($("#first, #mark"));
-	ok( expected == $('#en').text(), "Insert jQuery before" );
-});
-
-test("insertBefore(String|Element|Array&lt;Element&gt;|jQuery)", function() {
-	expect(4);
-	var expected = 'This is a normal link: bugaYahoo';
-	$('<b>buga</b>').insertBefore('#yahoo');
-	ok( expected == $('#en').text(), 'Insert String before' );
-	
-	reset();
-	expected = "This is a normal link: Try them out:Yahoo";
-	$(document.getElementById('first')).insertBefore('#yahoo');
-	ok( expected == $('#en').text(), "Insert element before" );
-	
-	reset();
-	expected = "This is a normal link: Try them out:diveintomarkYahoo";
-	$([document.getElementById('first'), document.getElementById('mark')]).insertBefore('#yahoo');
-	ok( expected == $('#en').text(), "Insert array of elements before" );
-	
-	reset();
-	expected = "This is a normal link: Try them out:diveintomarkYahoo";
-	$("#first, #mark").insertBefore('#yahoo');
-	ok( expected == $('#en').text(), "Insert jQuery before" );
-});
-
-test("after(String|Element|Array&lt;Element&gt;|jQuery)", function() {
-	expect(4);
-	var expected = 'This is a normal link: Yahoobuga';
-	$('#yahoo').after('<b>buga</b>');
-	ok( expected == $('#en').text(), 'Insert String after' );
-	
-	reset();
-	expected = "This is a normal link: YahooTry them out:";
-	$('#yahoo').after(document.getElementById('first'));
-	ok( expected == $('#en').text(), "Insert element after" );
-
-	reset();
-	expected = "This is a normal link: YahooTry them out:diveintomark";
-	$('#yahoo').after([document.getElementById('first'), document.getElementById('mark')]);
-	ok( expected == $('#en').text(), "Insert array of elements after" );
-	
-	reset();
-	expected = "This is a normal link: YahooTry them out:diveintomark";
-	$('#yahoo').after($("#first, #mark"));
-	ok( expected == $('#en').text(), "Insert jQuery after" );
-});
-
-test("insertAfter(String|Element|Array&lt;Element&gt;|jQuery)", function() {
-	expect(4);
-	var expected = 'This is a normal link: Yahoobuga';
-	$('<b>buga</b>').insertAfter('#yahoo');
-	ok( expected == $('#en').text(), 'Insert String after' );
-	
-	reset();
-	expected = "This is a normal link: YahooTry them out:";
-	$(document.getElementById('first')).insertAfter('#yahoo');
-	ok( expected == $('#en').text(), "Insert element after" );
-
-	reset();
-	expected = "This is a normal link: YahooTry them out:diveintomark";
-	$([document.getElementById('mark'), document.getElementById('first')]).insertAfter('#yahoo');
-	ok( expected == $('#en').text(), "Insert array of elements after" );
-	
-	reset();
-	expected = "This is a normal link: YahooTry them out:diveintomark";
-	$("#mark, #first").insertAfter('#yahoo');
-	ok( expected == $('#en').text(), "Insert jQuery after" );
-});
-
-test("end()", function() {
-	expect(3);
-	ok( 'Yahoo' == $('#yahoo').parent().end().text(), 'Check for end' );
-	ok( $('#yahoo').end(), 'Check for end with nothing to end' );
-	
-	var x = $('#yahoo');
-	x.parent();
-	ok( 'Yahoo' == $('#yahoo').text(), 'Check for non-destructive behaviour' );
-});
-
-test("find(String)", function() {
-	expect(1);
-	ok( 'Yahoo' == $('#foo').find('.blogTest').text(), 'Check for find' );
-});
-
-test("clone()", function() {
-	expect(3);
-	ok( 'This is a normal link: Yahoo' == $('#en').text(), 'Assert text for #en' );
-	var clone = $('#yahoo').clone();
-	ok( 'Try them out:Yahoo' == $('#first').append(clone).text(), 'Check for clone' );
-	ok( 'This is a normal link: Yahoo' == $('#en').text(), 'Reassert text for #en' );
-});
-
-test("is(String)", function() {
-	expect(26);
-	ok( $('#form').is('form'), 'Check for element: A form must be a form' );
-	ok( !$('#form').is('div'), 'Check for element: A form is not a div' );
-	ok( $('#mark').is('.blog'), 'Check for class: Expected class "blog"' );
-	ok( !$('#mark').is('.link'), 'Check for class: Did not expect class "link"' );
-	ok( $('#simon').is('.blog.link'), 'Check for multiple classes: Expected classes "blog" and "link"' );
-	ok( !$('#simon').is('.blogTest'), 'Check for multiple classes: Expected classes "blog" and "link", but not "blogTest"' );
-	ok( $('#en').is('[@lang="en"]'), 'Check for attribute: Expected attribute lang to be "en"' );
-	ok( !$('#en').is('[@lang="de"]'), 'Check for attribute: Expected attribute lang to be "en", not "de"' );
-	ok( $('#text1').is('[@type="text"]'), 'Check for attribute: Expected attribute type to be "text"' );
-	ok( !$('#text1').is('[@type="radio"]'), 'Check for attribute: Expected attribute type to be "text", not "radio"' );
-	ok( $('#text2').is(':disabled'), 'Check for pseudoclass: Expected to be disabled' );
-	ok( !$('#text1').is(':disabled'), 'Check for pseudoclass: Expected not disabled' );
-	ok( $('#radio2').is(':checked'), 'Check for pseudoclass: Expected to be checked' );
-	ok( !$('#radio1').is(':checked'), 'Check for pseudoclass: Expected not checked' );
-	ok( $('#foo').is('[p]'), 'Check for child: Expected a child "p" element' );
-	ok( !$('#foo').is('[ul]'), 'Check for child: Did not expect "ul" element' );
-	ok( $('#foo').is('[p][a][code]'), 'Check for childs: Expected "p", "a" and "code" child elements' );
-	ok( !$('#foo').is('[p][a][code][ol]'), 'Check for childs: Expected "p", "a" and "code" child elements, but no "ol"' );
-	ok( !$('#foo').is(0), 'Expected false for an invalid expression - 0' );
-	ok( !$('#foo').is(null), 'Expected false for an invalid expression - null' );
-	ok( !$('#foo').is(''), 'Expected false for an invalid expression - ""' );
-	ok( !$('#foo').is(undefined), 'Expected false for an invalid expression - undefined' );
-	
-	// test is() with comma-seperated expressions
-	ok( $('#en').is('[@lang="en"],[@lang="de"]'), 'Comma-seperated; Check for lang attribute: Expect en or de' );
-	ok( $('#en').is('[@lang="de"],[@lang="en"]'), 'Comma-seperated; Check for lang attribute: Expect en or de' );
-	ok( $('#en').is('[@lang="en"] , [@lang="de"]'), 'Comma-seperated; Check for lang attribute: Expect en or de' );
-	ok( $('#en').is('[@lang="de"] , [@lang="en"]'), 'Comma-seperated; Check for lang attribute: Expect en or de' );
-});
-
-test("$.extend(Object, Object)", function() {
-	expect(2);
-	var settings = { xnumber1: 5, xnumber2: 7, xstring1: "peter", xstring2: "pan" },
-		options =     { xnumber2: 1, xstring2: "x", xxx: "newstring" },
-		optionsCopy = { xnumber2: 1, xstring2: "x", xxx: "newstring" },
-		merged = { xnumber1: 5, xnumber2: 1, xstring1: "peter", xstring2: "x", xxx: "newstring" };
-	jQuery.extend(settings, options);
-	isObj( settings, merged, "Check if extended: settings must be extended" );
-	isObj( options, optionsCopy, "Check if not modified: options must not be modified" );
-});
-
-test("$.extend(Object, Object, Object, Object)", function() {
-	expect(4);
-	var defaults = { xnumber1: 5, xnumber2: 7, xstring1: "peter", xstring2: "pan" },
-		defaultsCopy = { xnumber1: 5, xnumber2: 7, xstring1: "peter", xstring2: "pan" },
-		options1 =     { xnumber2: 1, xstring2: "x" },
-		options1Copy = { xnumber2: 1, xstring2: "x" },
-		options2 =     { xstring2: "xx", xxx: "newstringx" },
-		options2Copy = { xstring2: "xx", xxx: "newstringx" },
-		merged = { xnumber1: 5, xnumber2: 1, xstring1: "peter", xstring2: "xx", xxx: "newstringx" };
-	var settings = jQuery.extend({}, defaults, options1, options2);
-	isObj( settings, merged, "Check if extended: settings must be extended" );
-	isObj( defaults, defaultsCopy, "Check if not modified: options1 must not be modified" );
-	isObj( options1, options1Copy, "Check if not modified: options1 must not be modified" );
-	isObj( options2, options2Copy, "Check if not modified: options2 must not be modified" );
-});
-
-test("val()", function() {
-	expect(2);
-	ok( $("#text1").val() == "Test", "Check for value of input element" );
-	ok( !$("#text1").val() == "", "Check for value of input element" );
-});
-
-test("val(String)", function() {
-	expect(2);
-	document.getElementById('text1').value = "bla";
-	ok( $("#text1").val() == "bla", "Check for modified value of input element" );
-	$("#text1").val('test');
-	ok ( document.getElementById('text1').value == "test", "Check for modified (via val(String)) value of input element" );
-});
-
-test("html(String)", function() {
-	expect(1);
-	var div = $("div");
-	div.html("<b>test</b>");
-	var pass = true;
-	for ( var i = 0; i < div.size(); i++ ) {
-	  if ( div.get(i).childNodes.length == 0 ) pass = false;
-	}
-	ok( pass, "Set HTML" );
-
-	// Ccommented out until we can resolve it	
-	// $("#main").html('<script type="text/javascript">ok( true, "$().html().evalScripts() Evals Scripts Twice in Firefox, see #975" );</script>').evalScripts();
-});
-
-test("filter()", function() {
-	expect(4);
-	isSet( $("input").filter(":checked").get(), q("radio2", "check1"), "filter(String)" );
-	isSet( $("p").filter("#ap, #sndp").get(), q("ap", "sndp"), "filter('String, String')" );
-	isSet( $("p").filter("#ap,#sndp").get(), q("ap", "sndp"), "filter('String,String')" );
-	isSet( $("p").filter(function() { return !$("a", this).length }).get(), q("sndp", "first"), "filter(Function)" );
-});
-
-test("not()", function() {
-	expect(3);
-	ok( $("#main > p#ap > a").not("#google").length == 2, "not('selector')" );
-	isSet( $("p").not("#ap, #sndp, .result").get(), q("firstp", "en", "sap", "first"), "not('selector, selector')" );
-	isSet( $("p").not($("#ap, #sndp, .result")).get(), q("firstp", "en", "sap", "first"), "not(jQuery)" );
-});
-
-test("siblings([String])", function() {
-	expect(4);
-	isSet( $("#en").siblings().get(), q("sndp", "sap"), "Check for siblings" );
-	isSet( $("#sndp").siblings("[code]").get(), q("sap"), "Check for filtered siblings (has code child element)" ); 
-	isSet( $("#sndp").siblings("[a]").get(), q("en", "sap"), "Check for filtered siblings (has anchor child element)" );
-	isSet( $("#foo").siblings("form, b").get(), q("form", "lengthtest", "floatTest"), "Check for multiple filters" );
-});
-
-test("children([String])", function() {
-	expect(3);
-	isSet( $("#foo").children().get(), q("sndp", "en", "sap"), "Check for children" );
-	isSet( $("#foo").children("[code]").get(), q("sndp", "sap"), "Check for filtered children" );
-	isSet( $("#foo").children("#en, #sap").get(), q("en", "sap"), "Check for multiple filters" );
-});
-
-test("parent[s]([String])", function() {
-	expect(8);
-	ok( $("#groups").parent()[0].id == "ap", "Simple parent check" );
-	ok( $("#groups").parent("p")[0].id == "ap", "Filtered parent check" );
-	ok( $("#groups").parent("div").length == 0, "Filtered parent check, no match" );
-	ok( $("#groups").parent("div, p")[0].id == "ap", "Check for multiple filters" );
-	
-	ok( $("#groups").parents()[0].id == "ap", "Simple parents check" );
-	ok( $("#groups").parents("p")[0].id == "ap", "Filtered parents check" );
-	ok( $("#groups").parents("div")[0].id == "main", "Filtered parents check2" );
-	isSet( $("#groups").parents("p, div").get(), q("ap", "main"), "Check for multiple filters" );
-});
-
-test("next/prev([String])", function() {
-	expect(8);
-	ok( $("#ap").next()[0].id == "foo", "Simple next check" );
-	ok( $("#ap").next("div")[0].id == "foo", "Filtered next check" );
-	ok( $("#ap").next("p").length == 0, "Filtered next check, no match" );
-	ok( $("#ap").next("div, p")[0].id == "foo", "Multiple filters" );
-	
-	ok( $("#foo").prev()[0].id == "ap", "Simple prev check" );
-	ok( $("#foo").prev("p")[0].id == "ap", "Filtered prev check" );
-	ok( $("#foo").prev("div").length == 0, "Filtered prev check, no match" );
-	ok( $("#foo").prev("p, div")[0].id == "ap", "Multiple filters" );
-});
-
-test("show()", function() {
-	expect(1);
-	var pass = true, div = $("div");
-	div.show().each(function(){
-	  if ( this.style.display == "none" ) pass = false;
-	});
-	ok( pass, "Show" );
-});
-
-test("addClass(String)", function() {
-	expect(1);
-	var div = $("div");
-	div.addClass("test");
-	var pass = true;
-	for ( var i = 0; i < div.size(); i++ ) {
-	 if ( div.get(i).className.indexOf("test") == -1 ) pass = false;
-	}
-	ok( pass, "Add Class" );
-});
-
-test("removeClass(String) - simple", function() {
-	expect(3);
-	var div = $("div").addClass("test").removeClass("test"),
-		pass = true;
-	for ( var i = 0; i < div.size(); i++ ) {
-		if ( div.get(i).className.indexOf("test") != -1 ) pass = false;
-	}
-	ok( pass, "Remove Class" );
-	
-	reset();
-	var div = $("div").addClass("test").addClass("foo").addClass("bar");
-	div.removeClass("test").removeClass("bar").removeClass("foo");
-	var pass = true;
-	for ( var i = 0; i < div.size(); i++ ) {
-	 if ( div.get(i).className.match(/test|bar|foo/) ) pass = false;
-	}
-	ok( pass, "Remove multiple classes" );
-	
-	reset();
-	var div = $("div:eq(0)").addClass("test").removeClass("");
-	ok( div.is('.test'), "Empty string passed to removeClass" );
-	
-});
-
-test("toggleClass(String)", function() {
-	expect(3);
-	var e = $("#firstp");
-	ok( !e.is(".test"), "Assert class not present" );
-	e.toggleClass("test");
-	ok( e.is(".test"), "Assert class present" ); 
-	e.toggleClass("test");
-	ok( !e.is(".test"), "Assert class not present" );
-});
-
-test("removeAttr(String", function() {
-	expect(1);
-	ok( $('#mark').removeAttr("class")[0].className == "", "remove class" );
-});
-
-test("text(String)", function() {
-	expect(1);
-	ok( $("#foo").text("<div><b>Hello</b> cruel world!</div>")[0].innerHTML == "&lt;div&gt;&lt;b&gt;Hello&lt;/b&gt; cruel world!&lt;/div&gt;", "Check escaped text" );
-});
-
-test("$.each(Object,Function)", function() {
-	expect(8);
-	$.each( [0,1,2], function(i, n){
-		ok( i == n, "Check array iteration" );
-	});
-	
-	$.each( [5,6,7], function(i, n){
-		ok( i == n - 5, "Check array iteration" );
-	});
-	 
-	$.each( { name: "name", lang: "lang" }, function(i, n){
-		ok( i == n, "Check object iteration" );
-	});
-});
-
-test("$.prop", function() {
-	expect(2);
-	var handle = function() { return this.id };
-	ok( $.prop($("#ap")[0], handle) == "ap", "Check with Function argument" );
-	ok( $.prop($("#ap")[0], "value") == "value", "Check with value argument" );
-});
-
-test("$.className", function() {
-	expect(6);
-	var x = $("<p>Hi</p>")[0];
-	var c = $.className;
-	c.add(x, "hi");
-	ok( x.className == "hi", "Check single added class" );
-	c.add(x, "foo bar");
-	ok( x.className == "hi foo bar", "Check more added classes" );
-	c.remove(x);
-	ok( x.className == "", "Remove all classes" );
-	c.add(x, "hi foo bar");
-	c.remove(x, "foo");
-	ok( x.className == "hi bar", "Check removal of one class" );
-	ok( c.has(x, "hi"), "Check has1" );
-	ok( c.has(x, "bar"), "Check has2" );
-});
-
-test("remove()", function() {
-	expect(4);
-	$("#ap").children().remove();
-	ok( $("#ap").text().length > 10, "Check text is not removed" );
-	ok( $("#ap").children().length == 0, "Check remove" );
-	
-	reset();
-	$("#ap").children().remove("a");
-	ok( $("#ap").text().length > 10, "Check text is not removed" );
-	ok( $("#ap").children().length == 1, "Check filtered remove" );
-});
-
-test("empty()", function() {
-	expect(2);
-	ok( $("#ap").children().empty().text().length == 0, "Check text is removed" );
-	ok( $("#ap").children().length == 4, "Check elements are not removed" );
-});
-
-test("eq(), gt(), lt(), contains()", function() {
-	expect(4);
-	ok( $("#ap a").eq(1)[0].id == "groups", "eq()" );
-	isSet( $("#ap a").gt(0).get(), q("groups", "anchor1", "mark"), "gt()" );
-	isSet( $("#ap a").lt(3).get(), q("google", "groups", "anchor1"), "lt()" );
-	isSet( $("#foo a").contains("log").get(), q("anchor2", "simon"), "contains()" );
-});
diff --git a/dom/tests/mochitest/ajax/jquery/src/jquery/jquery.js b/dom/tests/mochitest/ajax/jquery/src/jquery/jquery.js
deleted file mode 100644
--- a/dom/tests/mochitest/ajax/jquery/src/jquery/jquery.js
+++ /dev/null
@@ -1,2334 +0,0 @@
-/*
- * jQuery @VERSION - New Wave Javascript
- *
- * Copyright (c) 2007 John Resig (jquery.com)
- * Dual licensed under the MIT (MIT-LICENSE.txt)
- * and GPL (GPL-LICENSE.txt) licenses.
- *
- * $Date: 2007/06/29 15:10:43 $
- * $Rev: 1961 $
- */
-
-// Global undefined variable
-window.undefined = window.undefined;
-
-/**
- * Create a new jQuery Object
- *
- * @constructor
- * @private
- * @name jQuery
- * @param String|Function|Element|Array<Element>|jQuery a selector
- * @param jQuery|Element|Array<Element> c context
- * @cat Core
- */
-var jQuery = function(a,c) {
-	// If the context is global, return a new object
-	if ( window == this )
-		return new jQuery(a,c);
-	
-	return this.init(a,c);
-};
-
-// Map over the $ in case of overwrite
-if ( typeof $ != "undefined" )
-	jQuery._$ = $;
-	
-// Map the jQuery namespace to the '$' one
-var $ = jQuery;
-
-/**
- * This function accepts a string containing a CSS or
- * basic XPath selector which is then used to match a set of elements.
- *
- * The core functionality of jQuery centers around this function.
- * Everything in jQuery is based upon this, or uses this in some way.
- * The most basic use of this function is to pass in an expression
- * (usually consisting of CSS or XPath), which then finds all matching
- * elements.
- *
- * By default, if no context is specified, $() looks for DOM elements within the context of the
- * current HTML document. If you do specify a context, such as a DOM
- * element or jQuery object, the expression will be matched against
- * the contents of that context.
- *
- * See [[DOM/Traversing/Selectors]] for the allowed CSS/XPath syntax for expressions.
- *
- * @example $("div > p")
- * @desc Finds all p elements that are children of a div element.
- * @before <p>one</p> <div><p>two</p></div> <p>three</p>
- * @result [ <p>two</p> ]
- *
- * @example $("input:radio", document.forms[0])
- * @desc Searches for all inputs of type radio within the first form in the document
- *
- * @example $("div", xml.responseXML)
- * @desc This finds all div elements within the specified XML document.
- *
- * @name $
- * @param String expr An expression to search with
- * @param Element|jQuery context (optional) A DOM Element, Document or jQuery to use as context
- * @cat Core
- * @type jQuery
- * @see $(Element)
- * @see $(Element<Array>)
- */
- 
-/**
- * Create DOM elements on-the-fly from the provided String of raw HTML.
- *
- * @example $("<div><p>Hello</p></div>").appendTo("body")
- * @desc Creates a div element (and all of its contents) dynamically, 
- * and appends it to the body element. Internally, an
- * element is created and its innerHTML property set to the given markup.
- * It is therefore both quite flexible and limited. 
- *
- * @name $
- * @param String html A string of HTML to create on the fly.
- * @cat Core
- * @type jQuery
- * @see appendTo(String)
- */
-
-/**
- * Wrap jQuery functionality around a single or multiple DOM Element(s).
- *
- * This function also accepts XML Documents and Window objects
- * as valid arguments (even though they are not DOM Elements).
- *
- * @example $(document.body).css( "background", "black" );
- * @desc Sets the background color of the page to black.
- *
- * @example $( myForm.elements ).hide()
- * @desc Hides all the input elements within a form
- *
- * @name $
- * @param Element|Array<Element> elems DOM element(s) to be encapsulated by a jQuery object.
- * @cat Core
- * @type jQuery
- */
-
-/**
- * A shorthand for $(document).ready(), allowing you to bind a function
- * to be executed when the DOM document has finished loading. This function
- * behaves just like $(document).ready(), in that it should be used to wrap
- * other $() operations on your page that depend on the DOM being ready to be
- * operated on. While this function is, technically, chainable - there really
- * isn't much use for chaining against it.
- *
- * You can have as many $(document).ready events on your page as you like.
- *
- * See ready(Function) for details about the ready event. 
- * 
- * @example $(function(){
- *   // Document is ready
- * });
- * @desc Executes the function when the DOM is ready to be used.
- *
- * @example jQuery(function($) {
- *   // Your code using failsafe $ alias here...
- * });
- * @desc Uses both the shortcut for $(document).ready() and the argument
- * to write failsafe jQuery code using the $ alias, without relying on the
- * global alias.
- *
- * @name $
- * @param Function fn The function to execute when the DOM is ready.
- * @cat Core
- * @type jQuery
- * @see ready(Function)
- */
-
-jQuery.fn = jQuery.prototype = {
-	/**
-	 * Initialize a new jQuery object
-	 *
-	 * @private
-	 * @name init
-	 * @param String|Function|Element|Array<Element>|jQuery a selector
-	 * @param jQuery|Element|Array<Element> c context
-	 * @cat Core
-	 */
-	init: function(a,c) {
-		// Make sure that a selection was provided
-		a = a || document;
-
-		// HANDLE: $(function)
-		// Shortcut for document ready
-		if ( jQuery.isFunction(a) )
-			return new jQuery(document)[ jQuery.fn.ready ? "ready" : "load" ]( a );
-
-		// Handle HTML strings
-		if ( typeof a  == "string" ) {
-			// HANDLE: $(html) -> $(array)
-			var m = /^[^<]*(<(.|\s)+>)[^>]*$/.exec(a);
-			if ( m )
-				a = jQuery.clean( [ m[1] ] );
-
-			// HANDLE: $(expr)
-			else
-				return new jQuery( c ).find( a );
-		}
-
-		return this.setArray(
-			// HANDLE: $(array)
-			a.constructor == Array && a ||
-
-			// HANDLE: $(arraylike)
-			// Watch for when an array-like object is passed as the selector
-			(a.jquery || a.length && a != window && !a.nodeType && a[0] != undefined && a[0].nodeType) && jQuery.makeArray( a ) ||
-
-			// HANDLE: $(*)
-			[ a ] );
-	},
-	
-	/**
-	 * The current version of jQuery.
-	 *
-	 * @private
-	 * @property
-	 * @name jquery
-	 * @type String
-	 * @cat Core
-	 */
-	jquery: "@VERSION",
-
-	/**
-	 * The number of elements currently matched. The size function will return the same value.
-	 *
-	 * @example $("img").length;
-	 * @before <img src="test1.jpg"/> <img src="test2.jpg"/>
-	 * @result 2
-	 *
-	 * @property
-	 * @name length
-	 * @type Number
-	 * @cat Core
-	 */
-
-	/**
-	 * Get the number of elements currently matched. This returns the same
-	 * number as the 'length' property of the jQuery object.
-	 *
-	 * @example $("img").size();
-	 * @before <img src="test1.jpg"/> <img src="test2.jpg"/>
-	 * @result 2
-	 *
-	 * @name size
-	 * @type Number
-	 * @cat Core
-	 */
-	size: function() {
-		return this.length;
-	},
-	
-	length: 0,
-
-	/**
-	 * Access all matched DOM elements. This serves as a backwards-compatible
-	 * way of accessing all matched elements (other than the jQuery object
-	 * itself, which is, in fact, an array of elements).
-	 *
-	 * It is useful if you need to operate on the DOM elements themselves instead of using built-in jQuery functions.
-	 *
-	 * @example $("img").get();
-	 * @before <img src="test1.jpg"/> <img src="test2.jpg"/>
-	 * @result [ <img src="test1.jpg"/> <img src="test2.jpg"/> ]
-	 * @desc Selects all images in the document and returns the DOM Elements as an Array
-	 *
-	 * @name get
-	 * @type Array<Element>
-	 * @cat Core
-	 */
-
-	/**
-	 * Access a single matched DOM element at a specified index in the matched set.
-	 * This allows you to extract the actual DOM element and operate on it
-	 * directly without necessarily using jQuery functionality on it.
-	 *
-	 * @example $("img").get(0);
-	 * @before <img src="test1.jpg"/> <img src="test2.jpg"/>
-	 * @result <img src="test1.jpg"/>
-	 * @desc Selects all images in the document and returns the first one
-	 *
-	 * @name get
-	 * @type Element
-	 * @param Number num Access the element in the Nth position.
-	 * @cat Core
-	 */
-	get: function( num ) {
-		return num == undefined ?
-
-			// Return a 'clean' array
-			jQuery.makeArray( this ) :
-
-			// Return just the object
-			this[num];
-	},
-	
-	/**
-	 * Set the jQuery object to an array of elements, while maintaining
-	 * the stack.
-	 *
-	 * @example $("img").pushStack([ document.body ]);
-	 * @result $("img").pushStack() == [ document.body ]
-	 *
-	 * @private
-	 * @name pushStack
-	 * @type jQuery
-	 * @param Elements elems An array of elements
-	 * @cat Core
-	 */
-	pushStack: function( a ) {
-		var ret = jQuery(a);
-		ret.prevObject = this;
-		return ret;
-	},
-	
-	/**
-	 * Set the jQuery object to an array of elements. This operation is
-	 * completely destructive - be sure to use .pushStack() if you wish to maintain
-	 * the jQuery stack.
-	 *
-	 * @example $("img").setArray([ document.body ]);
-	 * @result $("img").setArray() == [ document.body ]
-	 *
-	 * @private
-	 * @name setArray
-	 * @type jQuery
-	 * @param Elements elems An array of elements
-	 * @cat Core
-	 */
-	setArray: function( a ) {
-		this.length = 0;
-		[].push.apply( this, a );
-		return this;
-	},
-
-	/**
-	 * Execute a function within the context of every matched element.
-	 * This means that every time the passed-in function is executed
-	 * (which is once for every element matched) the 'this' keyword
-	 * points to the specific DOM element.
-	 *
-	 * Additionally, the function, when executed, is passed a single
-	 * argument representing the position of the element in the matched
-	 * set (integer, zero-index).
-	 *
-	 * @example $("img").each(function(i){
-	 *   this.src = "test" + i + ".jpg";
-	 * });
-	 * @before <img/><img/>
-	 * @result <img src="test0.jpg"/><img src="test1.jpg"/>
-	 * @desc Iterates over two images and sets their src property
-	 *
-	 * @name each
-	 * @type jQuery
-	 * @param Function fn A function to execute
-	 * @cat Core
-	 */
-	each: function( fn, args ) {
-		return jQuery.each( this, fn, args );
-	},
-
-	/**
-	 * Searches every matched element for the object and returns
-	 * the index of the element, if found, starting with zero. 
-	 * Returns -1 if the object wasn't found.
-	 *
-	 * @example $("*").index( $('#foobar')[0] ) 
-	 * @before <div id="foobar"><b></b><span id="foo"></span></div>
-	 * @result 0
-	 * @desc Returns the index for the element with ID foobar
-	 *
-	 * @example $("*").index( $('#foo')[0] ) 
-	 * @before <div id="foobar"><b></b><span id="foo"></span></div>
-	 * @result 2
-	 * @desc Returns the index for the element with ID foo within another element
-	 *
-	 * @example $("*").index( $('#bar')[0] ) 
-	 * @before <div id="foobar"><b></b><span id="foo"></span></div>
-	 * @result -1
-	 * @desc Returns -1, as there is no element with ID bar
-	 *
-	 * @name index
-	 * @type Number
-	 * @param Element subject Object to search for
-	 * @cat Core
-	 */
-	index: function( obj ) {
-		var pos = -1;
-		this.each(function(i){
-			if ( this == obj ) pos = i;
-		});
-		return pos;
-	},
-
-	/**
-	 * Access a property on the first matched element.
-	 * This method makes it easy to retrieve a property value
-	 * from the first matched element.
-	 *
-	 * If the element does not have an attribute with such a
- 	 * name, undefined is returned.
-	 *
-	 * @example $("img").attr("src");
-	 * @before <img src="test.jpg"/>
-	 * @result test.jpg
-	 * @desc Returns the src attribute from the first image in the document.
-	 *
-	 * @name attr
-	 * @type Object
-	 * @param String name The name of the property to access.
-	 * @cat DOM/Attributes
-	 */
-
-	/**
-	 * Set a key/value object as properties to all matched elements.
-	 *
-	 * This serves as the best way to set a large number of properties
-	 * on all matched elements.
-	 *
-	 * @example $("img").attr({ src: "test.jpg", alt: "Test Image" });
-	 * @before <img/>
-	 * @result <img src="test.jpg" alt="Test Image"/>
-	 * @desc Sets src and alt attributes to all images.
-	 *
-	 * @name attr
-	 * @type jQuery
-	 * @param Map properties Key/value pairs to set as object properties.
-	 * @cat DOM/Attributes
-	 */
-
-	/**
-	 * Set a single property to a value, on all matched elements.
-	 *
-	 * Note that you can't set the name property of input elements in IE.
-	 * Use $(html) or .append(html) or .html(html) to create elements
-	 * on the fly including the name property.
-	 *
-	 * @example $("img").attr("src","test.jpg");
-	 * @before <img/>
-	 * @result <img src="test.jpg"/>
-	 * @desc Sets src attribute to all images.
-	 *
-	 * @name attr
-	 * @type jQuery
-	 * @param String key The name of the property to set.
-	 * @param Object value The value to set the property to.
-	 * @cat DOM/Attributes
-	 */
-	 
-	/**
-	 * Set a single property to a computed value, on all matched elements.
-	 *
-	 * Instead of supplying a string value as described
-	 * [[DOM/Attributes#attr.28_key.2C_value_.29|above]],
-	 * a function is provided that computes the value.
-	 *
-	 * @example $("img").attr("title", function() { return this.src });
-	 * @before <img src="test.jpg" />
-	 * @result <img src="test.jpg" title="test.jpg" />
-	 * @desc Sets title attribute from src attribute.
-	 *
-	 * @example $("img").attr("title", function(index) { return this.title + (i + 1); });
-	 * @before <img title="pic" /><img title="pic" /><img title="pic" />
-	 * @result <img title="pic1" /><img title="pic2" /><img title="pic3" />
-	 * @desc Enumerate title attribute.
-	 *
-	 * @name attr
-	 * @type jQuery
-	 * @param String key The name of the property to set.
-	 * @param Function value A function returning the value to set.
-	 * 	 	  Scope: Current element, argument: Index of current element
-	 * @cat DOM/Attributes
-	 */
-	attr: function( key, value, type ) {
-		var obj = key;
-		
-		// Look for the case where we're accessing a style value
-		if ( key.constructor == String )
-			if ( value == undefined )
-				return this.length && jQuery[ type || "attr" ]( this[0], key ) || undefined;
-			else {
-				obj = {};
-				obj[ key ] = value;
-			}
-		
-		// Check to see if we're setting style values
-		return this.each(function(index){
-			// Set all the styles
-			for ( var prop in obj )
-				jQuery.attr(
-					type ? this.style : this,
-					prop, jQuery.prop(this, obj[prop], type, index, prop)
-				);
-		});
-	},
-
-	/**
-	 * Access a style property on the first matched element.
-	 * This method makes it easy to retrieve a style property value
-	 * from the first matched element.
-	 *
-	 * @example $("p").css("color");
-	 * @before <p style="color:red;">Test Paragraph.</p>
-	 * @result "red"
-	 * @desc Retrieves the color style of the first paragraph
-	 *
-	 * @example $("p").css("font-weight");
-	 * @before <p style="font-weight: bold;">Test Paragraph.</p>
-	 * @result "bold"
-	 * @desc Retrieves the font-weight style of the first paragraph.
-	 *
-	 * @name css
-	 * @type String
-	 * @param String name The name of the property to access.
-	 * @cat CSS
-	 */
-
-	/**
-	 * Set a key/value object as style properties to all matched elements.
-	 *
-	 * This serves as the best way to set a large number of style properties
-	 * on all matched elements.
-	 *
-	 * @example $("p").css({ color: "red", background: "blue" });
-	 * @before <p>Test Paragraph.</p>
-	 * @result <p style="color:red; background:blue;">Test Paragraph.</p>
-	 * @desc Sets color and background styles to all p elements.
-	 *
-	 * @name css
-	 * @type jQuery
-	 * @param Map properties Key/value pairs to set as style properties.
-	 * @cat CSS
-	 */
-
-	/**
-	 * Set a single style property to a value, on all matched elements.
-	 * If a number is provided, it is automatically converted into a pixel value.
-	 *
-	 * @example $("p").css("color","red");
-	 * @before <p>Test Paragraph.</p>
-	 * @result <p style="color:red;">Test Paragraph.</p>
-	 * @desc Changes the color of all paragraphs to red
-	 *
-	 * @example $("p").css("left",30);
-	 * @before <p>Test Paragraph.</p>
-	 * @result <p style="left:30px;">Test Paragraph.</p>
-	 * @desc Changes the left of all paragraphs to "30px"
-	 *
-	 * @name css
-	 * @type jQuery
-	 * @param String key The name of the property to set.
-	 * @param String|Number value The value to set the property to.
-	 * @cat CSS
-	 */
-	css: function( key, value ) {
-		return this.attr( key, value, "curCSS" );
-	},
-
-	/**
-	 * Get the text contents of all matched elements. The result is
-	 * a string that contains the combined text contents of all matched
-	 * elements. This method works on both HTML and XML documents.
-	 *
-	 * @example $("p").text();
-	 * @before <p><b>Test</b> Paragraph.</p><p>Paraparagraph</p>
-	 * @result Test Paragraph.Paraparagraph
-	 * @desc Gets the concatenated text of all paragraphs
-	 *
-	 * @name text
-	 * @type String
-	 * @cat DOM/Attributes
-	 */
-
-	/**
-	 * Set the text contents of all matched elements.
-	 *
-	 * Similar to html(), but escapes HTML (replace "<" and ">" with their
-	 * HTML entities).
-	 *
-	 * @example $("p").text("<b>Some</b> new text.");
-	 * @before <p>Test Paragraph.</p>
-	 * @result <p>&lt;b&gt;Some&lt;/b&gt; new text.</p>
-	 * @desc Sets the text of all paragraphs.
-	 *
-	 * @example $("p").text("<b>Some</b> new text.", true);
-	 * @before <p>Test Paragraph.</p>
-	 * @result <p>Some new text.</p>
-	 * @desc Sets the text of all paragraphs.
-	 *
-	 * @name text
-	 * @type String
-	 * @param String val The text value to set the contents of the element to.
-	 * @cat DOM/Attributes
-	 */
-	text: function(e) {
-		if ( typeof e == "string" )
-			return this.empty().append( document.createTextNode( e ) );
-
-		var t = "";
-		jQuery.each( e || this, function(){
-			jQuery.each( this.childNodes, function(){
-				if ( this.nodeType != 8 )
-					t += this.nodeType != 1 ?
-						this.nodeValue : jQuery.fn.text([ this ]);
-			});
-		});
-		return t;
-	},
-
-	/**
-	 * Wrap all matched elements with a structure of other elements.
-	 * This wrapping process is most useful for injecting additional
-	 * stucture into a document, without ruining the original semantic
-	 * qualities of a document.
-	 *
-	 * This works by going through the first element
-	 * provided (which is generated, on the fly, from the provided HTML)
-	 * and finds the deepest ancestor element within its
-	 * structure - it is that element that will en-wrap everything else.
-	 *
-	 * This does not work with elements that contain text. Any necessary text
-	 * must be added after the wrapping is done.
-	 *
-	 * @example $("p").wrap("<div class='wrap'></div>");
-	 * @before <p>Test Paragraph.</p>
-	 * @result <div class='wrap'><p>Test Paragraph.</p></div>
-	 * 
-	 * @name wrap
-	 * @type jQuery
-	 * @param String html A string of HTML, that will be created on the fly and wrapped around the target.
-	 * @cat DOM/Manipulation
-	 */
-
-	/**
-	 * Wrap all matched elements with a structure of other elements.
-	 * This wrapping process is most useful for injecting additional
-	 * stucture into a document, without ruining the original semantic
-	 * qualities of a document.
-	 *
-	 * This works by going through the first element
-	 * provided and finding the deepest ancestor element within its
-	 * structure - it is that element that will en-wrap everything else.
-	 *
- 	 * This does not work with elements that contain text. Any necessary text
-	 * must be added after the wrapping is done.
-	 *
-	 * @example $("p").wrap( document.getElementById('content') );
-	 * @before <p>Test Paragraph.</p><div id="content"></div>
-	 * @result <div id="content"><p>Test Paragraph.</p></div>
-	 *
-	 * @name wrap
-	 * @type jQuery
-	 * @param Element elem A DOM element that will be wrapped around the target.
-	 * @cat DOM/Manipulation
-	 */
-	wrap: function() {
-		// The elements to wrap the target around
-		var a, args = arguments;
-
-		// Wrap each of the matched elements individually
-		return this.each(function(){
-			if ( !a )
-				a = jQuery.clean(args, this.ownerDocument);
-
-			// Clone the structure that we're using to wrap
-			var b = a[0].cloneNode(true);
-
-			// Insert it before the element to be wrapped
-			this.parentNode.insertBefore( b, this );
-
-			// Find the deepest point in the wrap structure
-			while ( b.firstChild )
-				b = b.firstChild;
-
-			// Move the matched element to within the wrap structure
-			b.appendChild( this );
-		});
-	},
-
-	/**
-	 * Append content to the inside of every matched element.
-	 *
-	 * This operation is similar to doing an appendChild to all the
-	 * specified elements, adding them into the document.
-	 *
-	 * @example $("p").append("<b>Hello</b>");
-	 * @before <p>I would like to say: </p>
-	 * @result <p>I would like to say: <b>Hello</b></p>
-	 * @desc Appends some HTML to all paragraphs.
-	 *
-	 * @example $("p").append( $("#foo")[0] );
-	 * @before <p>I would like to say: </p><b id="foo">Hello</b>
-	 * @result <p>I would like to say: <b id="foo">Hello</b></p>
-	 * @desc Appends an Element to all paragraphs.
-	 *
-	 * @example $("p").append( $("b") );
-	 * @before <p>I would like to say: </p><b>Hello</b>
-	 * @result <p>I would like to say: <b>Hello</b></p>
-	 * @desc Appends a jQuery object (similar to an Array of DOM Elements) to all paragraphs.
-	 *
-	 * @name append
-	 * @type jQuery
-	 * @param <Content> content Content to append to the target
-	 * @cat DOM/Manipulation
-	 * @see prepend(<Content>)
-	 * @see before(<Content>)
-	 * @see after(<Content>)
-	 */
-	append: function() {
-		return this.domManip(arguments, true, 1, function(a){
-			this.appendChild( a );
-		});
-	},
-
-	/**
-	 * Prepend content to the inside of every matched element.
-	 *
-	 * This operation is the best way to insert elements
-	 * inside, at the beginning, of all matched elements.
-	 *
-	 * @example $("p").prepend("<b>Hello</b>");
-	 * @before <p>I would like to say: </p>
-	 * @result <p><b>Hello</b>I would like to say: </p>
-	 * @desc Prepends some HTML to all paragraphs.
-	 *
-	 * @example $("p").prepend( $("#foo")[0] );
-	 * @before <p>I would like to say: </p><b id="foo">Hello</b>
-	 * @result <p><b id="foo">Hello</b>I would like to say: </p>
-	 * @desc Prepends an Element to all paragraphs.
-	 *	
-	 * @example $("p").prepend( $("b") );
-	 * @before <p>I would like to say: </p><b>Hello</b>
-	 * @result <p><b>Hello</b>I would like to say: </p>
-	 * @desc Prepends a jQuery object (similar to an Array of DOM Elements) to all paragraphs.
-	 *
-	 * @name prepend
-	 * @type jQuery
-	 * @param <Content> content Content to prepend to the target.
-	 * @cat DOM/Manipulation
-	 * @see append(<Content>)
-	 * @see before(<Content>)
-	 * @see after(<Content>)
-	 */
-	prepend: function() {
-		return this.domManip(arguments, true, -1, function(a){
-			this.insertBefore( a, this.firstChild );
-		});
-	},
-	
-	/**
-	 * Insert content before each of the matched elements.
-	 *
-	 * @example $("p").before("<b>Hello</b>");
-	 * @before <p>I would like to say: </p>
-	 * @result <b>Hello</b><p>I would like to say: </p>
-	 * @desc Inserts some HTML before all paragraphs.
-	 *
-	 * @example $("p").before( $("#foo")[0] );
-	 * @before <p>I would like to say: </p><b id="foo">Hello</b>
-	 * @result <b id="foo">Hello</b><p>I would like to say: </p>
-	 * @desc Inserts an Element before all paragraphs.
-	 *
-	 * @example $("p").before( $("b") );
-	 * @before <p>I would like to say: </p><b>Hello</b>
-	 * @result <b>Hello</b><p>I would like to say: </p>
-	 * @desc Inserts a jQuery object (similar to an Array of DOM Elements) before all paragraphs.
-	 *
-	 * @name before
-	 * @type jQuery
-	 * @param <Content> content Content to insert before each target.
-	 * @cat DOM/Manipulation
-	 * @see append(<Content>)
-	 * @see prepend(<Content>)
-	 * @see after(<Content>)
-	 */
-	before: function() {
-		return this.domManip(arguments, false, 1, function(a){
-			this.parentNode.insertBefore( a, this );
-		});
-	},
-
-	/**
-	 * Insert content after each of the matched elements.
-	 *
-	 * @example $("p").after("<b>Hello</b>");
-	 * @before <p>I would like to say: </p>
-	 * @result <p>I would like to say: </p><b>Hello</b>
-	 * @desc Inserts some HTML after all paragraphs.
-	 *
-	 * @example $("p").after( $("#foo")[0] );
-	 * @before <b id="foo">Hello</b><p>I would like to say: </p>
-	 * @result <p>I would like to say: </p><b id="foo">Hello</b>
-	 * @desc Inserts an Element after all paragraphs.
-	 *
-	 * @example $("p").after( $("b") );
-	 * @before <b>Hello</b><p>I would like to say: </p>
-	 * @result <p>I would like to say: </p><b>Hello</b>
-	 * @desc Inserts a jQuery object (similar to an Array of DOM Elements) after all paragraphs.
-	 *
-	 * @name after
-	 * @type jQuery
-	 * @param <Content> content Content to insert after each target.
-	 * @cat DOM/Manipulation
-	 * @see append(<Content>)
-	 * @see prepend(<Content>)
-	 * @see before(<Content>)
-	 */
-	after: function() {
-		return this.domManip(arguments, false, -1, function(a){
-			this.parentNode.insertBefore( a, this.nextSibling );
-		});
-	},
-
-	/**
-	 * Revert the most recent 'destructive' operation, changing the set of matched elements
-	 * to its previous state (right before the destructive operation).
-	 *
-	 * If there was no destructive operation before, an empty set is returned.
-	 *
-	 * A 'destructive' operation is any operation that changes the set of
-	 * matched jQuery elements. These functions are: <code>add</code>,
-	 * <code>children</code>, <code>clone</code>, <code>filter</code>,
-	 * <code>find</code>, <code>not</code>, <code>next</code>,
-	 * <code>parent</code>, <code>parents</code>, <code>prev</code> and <code>siblings</code>.
-	 *
-	 * @example $("p").find("span").end();
-	 * @before <p><span>Hello</span>, how are you?</p>
-	 * @result [ <p>...</p> ]
-	 * @desc Selects all paragraphs, finds span elements inside these, and reverts the
-	 * selection back to the paragraphs.
-	 *
-	 * @name end
-	 * @type jQuery
-	 * @cat DOM/Traversing
-	 */
-	end: function() {
-		return this.prevObject || jQuery([]);
-	},
-
-	/**
-	 * Searches for all elements that match the specified expression.
-	 
-	 * This method is a good way to find additional descendant
-	 * elements with which to process.
-	 *
-	 * All searching is done using a jQuery expression. The expression can be
-	 * written using CSS 1-3 Selector syntax, or basic XPath.
-	 *
-	 * @example $("p").find("span");
-	 * @before <p><span>Hello</span>, how are you?</p>
-	 * @result [ <span>Hello</span> ]
-	 * @desc Starts with all paragraphs and searches for descendant span
-	 * elements, same as $("p span")
-	 *
-	 * @name find
-	 * @type jQuery
-	 * @param String expr An expression to search with.
-	 * @cat DOM/Traversing
-	 */
-	find: function(t) {
-		return this.pushStack( jQuery.unique( jQuery.map( this, function(a){
-			return jQuery.find(t,a);
-		}) ), t );
-	},
-
-	/**
-	 * Clone matched DOM Elements and select the clones. 
-	 *
-	 * This is useful for moving copies of the elements to another
-	 * location in the DOM.
-	 *
-	 * @example $("b").clone().prependTo("p");
-	 * @before <b>Hello</b><p>, how are you?</p>
-	 * @result <b>Hello</b><p><b>Hello</b>, how are you?</p>
-	 * @desc Clones all b elements (and selects the clones) and prepends them to all paragraphs.
-	 *
-	 * @name clone
-	 * @type jQuery
-	 * @param Boolean deep (Optional) Set to false if you don't want to clone all descendant nodes, in addition to the element itself.
-	 * @cat DOM/Manipulation
-	 */
-	clone: function(deep) {
-		// Need to remove events on the element and its descendants
-		var $this = this.add(this.find("*"));
-		$this.each(function() {
-			this._$events = {};
-			for (var type in this.$events)
-				this._$events[type] = jQuery.extend({},this.$events[type]);
-		}).unbind();
-
-		// Do the clone
-		var r = this.pushStack( jQuery.map( this, function(a){
-			return a.cloneNode( deep != undefined ? deep : true );
-		}) );
-
-		// Add the events back to the original and its descendants
-		$this.each(function() {
-			var events = this._$events;
-			for (var type in events)
-				for (var handler in events[type])
-					jQuery.event.add(this, type, events[type][handler], events[type][handler].data);
-			this._$events = null;
-		});
-
-		// Return the cloned set
-		return r;
-	},
-
-	/**
-	 * Removes all elements from the set of matched elements that do not
-	 * match the specified expression(s). This method is used to narrow down
-	 * the results of a search.
-	 *
-	 * Provide a comma-separated list of expressions to apply multiple filters at once.
-	 *
-	 * @example $("p").filter(".selected")
-	 * @before <p class="selected">Hello</p><p>How are you?</p>
-	 * @result [ <p class="selected">Hello</p> ]
-	 * @desc Selects all paragraphs and removes those without a class "selected".
-	 *
-	 * @example $("p").filter(".selected, :first")
-	 * @before <p>Hello</p><p>Hello Again</p><p class="selected">And Again</p>
-	 * @result [ <p>Hello</p>, <p class="selected">And Again</p> ]
-	 * @desc Selects all paragraphs and removes those without class "selected" and being the first one.
-	 *
-	 * @name filter
-	 * @type jQuery
-	 * @param String expression Expression(s) to search with.
-	 * @cat DOM/Traversing
-	 */
-	 
-	/**
-	 * Removes all elements from the set of matched elements that do not
-	 * pass the specified filter. This method is used to narrow down
-	 * the results of a search.
-	 *
-	 * @example $("p").filter(function(index) {
-	 *   return $("ol", this).length == 0;
-	 * })
-	 * @before <p><ol><li>Hello</li></ol></p><p>How are you?</p>
-	 * @result [ <p>How are you?</p> ]
-	 * @desc Remove all elements that have a child ol element
-	 *
-	 * @name filter
-	 * @type jQuery
-	 * @param Function filter A function to use for filtering
-	 * @cat DOM/Traversing
-	 */
-	filter: function(t) {
-		return this.pushStack(
-			jQuery.isFunction( t ) &&
-			jQuery.grep(this, function(el, index){
-				return t.apply(el, [index])
-			}) ||
-
-			jQuery.multiFilter(t,this) );
-	},
-
-	/**
-	 * Removes the specified Element from the set of matched elements. This
-	 * method is used to remove a single Element from a jQuery object.
-	 *
-	 * @example $("p").not( $("#selected")[0] )
-	 * @before <p>Hello</p><p id="selected">Hello Again</p>
-	 * @result [ <p>Hello</p> ]
-	 * @desc Removes the element with the ID "selected" from the set of all paragraphs.
-	 *
-	 * @name not
-	 * @type jQuery
-	 * @param Element el An element to remove from the set
-	 * @cat DOM/Traversing
-	 */
-
-	/**
-	 * Removes elements matching the specified expression from the set
-	 * of matched elements. This method is used to remove one or more
-	 * elements from a jQuery object.
-	 *
-	 * @example $("p").not("#selected")
-	 * @before <p>Hello</p><p id="selected">Hello Again</p>
-	 * @result [ <p>Hello</p> ]
-	 * @desc Removes the element with the ID "selected" from the set of all paragraphs.
-	 *
-	 * @name not
-	 * @type jQuery
-	 * @param String expr An expression with which to remove matching elements
-	 * @cat DOM/Traversing
-	 */
-
-	/**
-	 * Removes any elements inside the array of elements from the set
-	 * of matched elements. This method is used to remove one or more
-	 * elements from a jQuery object.
-	 *
-	 * Please note: the expression cannot use a reference to the
-	 * element name. See the two examples below.
-	 *
-	 * @example $("p").not( $("div p.selected") )
-	 * @before <div><p>Hello</p><p class="selected">Hello Again</p></div>
-	 * @result [ <p>Hello</p> ]
-	 * @desc Removes all elements that match "div p.selected" from the total set of all paragraphs.
-	 *
-	 * @name not
-	 * @type jQuery
-	 * @param jQuery elems A set of elements to remove from the jQuery set of matched elements.
-	 * @cat DOM/Traversing
-	 */
-	not: function(t) {
-		return this.pushStack(
-			t.constructor == String &&
-			jQuery.multiFilter(t, this, true) ||
-
-			jQuery.grep(this, function(a) {
-				return ( t.constructor == Array || t.jquery )
-					? jQuery.inArray( a, t ) < 0
-					: a != t;
-			})
-		);
-	},
-
-	/**
-	 * Adds more elements, matched by the given expression,
-	 * to the set of matched elements.
-	 *
-	 * @example $("p").add("span")
-	 * @before (HTML) <p>Hello</p><span>Hello Again</span>
-	 * @result (jQuery object matching 2 elements) [ <p>Hello</p>, <span>Hello Again</span> ]
-	 * @desc Compare the above result to the result of <code>$('p')</code>,
-	 * which would just result in <code><nowiki>[ <p>Hello</p> ]</nowiki></code>.
-	 * Using add(), matched elements of <code>$('span')</code> are simply
-	 * added to the returned jQuery-object.
-	 *
-	 * @name add
-	 * @type jQuery
-	 * @param String expr An expression whose matched elements are added
-	 * @cat DOM/Traversing
-	 */
-	 
-	/**
-	 * Adds more elements, created on the fly, to the set of
-	 * matched elements.
-	 *
-	 * @example $("p").add("<span>Again</span>")
-	 * @before <p>Hello</p>
-	 * @result [ <p>Hello</p>, <span>Again</span> ]
-	 *
-	 * @name add
-	 * @type jQuery
-	 * @param String html A string of HTML to create on the fly.
-	 * @cat DOM/Traversing
-	 */
-
-	/**
-	 * Adds one or more Elements to the set of matched elements.
-	 *
-	 * @example $("p").add( document.getElementById("a") )
-	 * @before <p>Hello</p><p><span id="a">Hello Again</span></p>
-	 * @result [ <p>Hello</p>, <span id="a">Hello Again</span> ]
-	 *
-	 * @example $("p").add( document.forms[0].elements )
-	 * @before <p>Hello</p><p><form><input/><button/></form>
-	 * @result [ <p>Hello</p>, <input/>, <button/> ]
-	 *
-	 * @name add
-	 * @type jQuery
-	 * @param Element|Array<Element> elements One or more Elements to add
-	 * @cat DOM/Traversing
-	 */
-	add: function(t) {
-		return this.pushStack( jQuery.merge(
-			this.get(),
-			t.constructor == String ?
-				jQuery(t).get() :
-				t.length != undefined && (!t.nodeName || t.nodeName == "FORM") ?
-					t : [t] )
-		);
-	},
-
-	/**
-	 * Checks the current selection against an expression and returns true,
-	 * if at least one element of the selection fits the given expression.
-	 *
-	 * Does return false, if no element fits or the expression is not valid.
-	 *
-	 * filter(String) is used internally, therefore all rules that apply there
-	 * apply here, too.
-	 *
-	 * @example $("input[@type='checkbox']").parent().is("form")
-	 * @before <form><input type="checkbox" /></form>
-	 * @result true
-	 * @desc Returns true, because the parent of the input is a form element
-	 * 
-	 * @example $("input[@type='checkbox']").parent().is("form")
-	 * @before <form><p><input type="checkbox" /></p></form>
-	 * @result false
-	 * @desc Returns false, because the parent of the input is a p element
-	 *
-	 * @name is
-	 * @type Boolean
-	 * @param String expr The expression with which to filter
-	 * @cat DOM/Traversing
-	 */
-	is: function(expr) {
-		return expr ? jQuery.multiFilter(expr,this).length > 0 : false;
-	},
-	
-	/**
-	 * Get the content of the value attribute of the first matched element.
-	 *
-	 * Use caution when relying on this function to check the value of
-	 * multiple-select elements and checkboxes in a form. While it will
-	 * still work as intended, it may not accurately represent the value
-	 * the server will receive because these elements may send an array
-	 * of values. For more robust handling of field values, see the
-	 * [http://www.malsup.com/jquery/form/#fields fieldValue function of the Form Plugin].
-	 *
-	 * @example $("input").val();
-	 * @before <input type="text" value="some text"/>
-	 * @result "some text"
-	 *
-	 * @name val
-	 * @type String
-	 * @cat DOM/Attributes
-	 */
-	
-	/**
-	 * 	Set the value attribute of every matched element.
-	 *
-	 * @example $("input").val("test");
-	 * @before <input type="text" value="some text"/>
-	 * @result <input type="text" value="test"/>
-	 *
-	 * @name val
-	 * @type jQuery
-	 * @param String val Set the property to the specified value.
-	 * @cat DOM/Attributes
-	 */
-	val: function( val ) {
-		return val == undefined ?
-			( this.length ? this[0].value : null ) :
-			this.attr( "value", val );
-	},
-	
-	/**
-	 * Get the html contents of the first matched element.
-	 * This property is not available on XML documents.
-	 *
-	 * @example $("div").html();
-	 * @before <div><input/></div>
-	 * @result <input/>
-	 *
-	 * @name html
-	 * @type String
-	 * @cat DOM/Attributes
-	 */
-	
-	/**
-	 * Set the html contents of every matched element.
-	 * This property is not available on XML documents.
-	 *
-	 * @example $("div").html("<b>new stuff</b>");
-	 * @before <div><input/></div>
-	 * @result <div><b>new stuff</b></div>
-	 *
-	 * @name html
-	 * @type jQuery
-	 * @param String val Set the html contents to the specified value.
-	 * @cat DOM/Attributes
-	 */
-	html: function( val ) {
-		return val == undefined ?
-			( this.length ? this[0].innerHTML : null ) :
-			this.empty().append( val );
-	},
-	
-	/**
-	 * @private
-	 * @name domManip
-	 * @param Array args
-	 * @param Boolean table Insert TBODY in TABLEs if one is not found.
-	 * @param Number dir If dir<0, process args in reverse order.
-	 * @param Function fn The function doing the DOM manipulation.
-	 * @type jQuery
-	 * @cat Core
-	 */
-	domManip: function(args, table, dir, fn){
-		var clone = this.length > 1, a; 
-
-		return this.each(function(){
-			if ( !a ) {
-				a = jQuery.clean(args, this.ownerDocument);
-				if ( dir < 0 )
-					a.reverse();
-			}
-
-			var obj = this;
-
-			if ( table && jQuery.nodeName(this, "table") && jQuery.nodeName(a[0], "tr") )
-				obj = this.getElementsByTagName("tbody")[0] || this.appendChild(document.createElement("tbody"));
-
-			jQuery.each( a, function(){
-				fn.apply( obj, [ clone ? this.cloneNode(true) : this ] );
-			});
-
-		});
-	}
-};
-
-/**
- * Extends the jQuery object itself. Can be used to add functions into
- * the jQuery namespace and to [[Plugins/Authoring|add plugin methods]] (plugins).
- * 
- * @example jQuery.fn.extend({
- *   check: function() {
- *     return this.each(function() { this.checked = true; });
- *   },
- *   uncheck: function() {
- *     return this.each(function() { this.checked = false; });
- *   }
- * });
- * $("input[@type=checkbox]").check();
- * $("input[@type=radio]").uncheck();
- * @desc Adds two plugin methods.
- *
- * @example jQuery.extend({
- *   min: function(a, b) { return a < b ? a : b; },
- *   max: function(a, b) { return a > b ? a : b; }
- * });
- * @desc Adds two functions into the jQuery namespace
- *
- * @name $.extend
- * @param Object prop The object that will be merged into the jQuery object
- * @type Object
- * @cat Core
- */
-
-/**
- * Extend one object with one or more others, returning the original,
- * modified, object. This is a great utility for simple inheritance.
- * 
- * @example var settings = { validate: false, limit: 5, name: "foo" };
- * var options = { validate: true, name: "bar" };
- * jQuery.extend(settings, options);
- * @result settings == { validate: true, limit: 5, name: "bar" }
- * @desc Merge settings and options, modifying settings
- *
- * @example var defaults = { validate: false, limit: 5, name: "foo" };
- * var options = { validate: true, name: "bar" };
- * var settings = jQuery.extend({}, defaults, options);
- * @result settings == { validate: true, limit: 5, name: "bar" }
- * @desc Merge defaults and options, without modifying the defaults
- *
- * @name $.extend
- * @param Object target The object to extend
- * @param Object prop1 The object that will be merged into the first.
- * @param Object propN (optional) More objects to merge into the first
- * @type Object
- * @cat JavaScript
- */
-jQuery.extend = jQuery.fn.extend = function() {
-	// copy reference to target object
-	var target = arguments[0], a = 1;
-
-	// extend jQuery itself if only one argument is passed
-	if ( arguments.length == 1 ) {
-		target = this;
-		a = 0;
-	}
-	var prop;
-	while ( (prop = arguments[a++]) != null )
-		// Extend the base object
-		for ( var i in prop ) target[i] = prop[i];
-
-	// Return the modified object
-	return target;
-};
-
-jQuery.extend({
-	/**
-	 * Run this function to give control of the $ variable back
-	 * to whichever library first implemented it. This helps to make 
-	 * sure that jQuery doesn't conflict with the $ object
-	 * of other libraries.
-	 *
-	 * By using this function, you will only be able to access jQuery
-	 * using the 'jQuery' variable. For example, where you used to do
-	 * $("div p"), you now must do jQuery("div p").
-	 *
-	 * @example jQuery.noConflict();
-	 * // Do something with jQuery
-	 * jQuery("div p").hide();
-	 * // Do something with another library's $()
-	 * $("content").style.display = 'none';
-	 * @desc Maps the original object that was referenced by $ back to $
-	 *
-	 * @example jQuery.noConflict();
-	 * (function($) { 
-	 *   $(function() {
-	 *     // more code using $ as alias to jQuery
-	 *   });
-	 * })(jQuery);
-	 * // other code using $ as an alias to the other library
-	 * @desc Reverts the $ alias and then creates and executes a
-	 * function to provide the $ as a jQuery alias inside the functions
-	 * scope. Inside the function the original $ object is not available.
-	 * This works well for most plugins that don't rely on any other library.
-	 * 
-	 *
-	 * @name $.noConflict
-	 * @type undefined
-	 * @cat Core 
-	 */
-	noConflict: function() {
-		if ( jQuery._$ )
-			$ = jQuery._$;
-		return jQuery;
-	},
-
-	// This may seem like some crazy code, but trust me when I say that this
-	// is the only cross-browser way to do this. --John
-	isFunction: function( fn ) {
-		return !!fn && typeof fn != "string" && !fn.nodeName && 
-			fn.constructor != Array && /function/i.test( fn + "" );
-	},
-	
-	// check if an element is in a XML document
-	isXMLDoc: function(elem) {
-		return elem.tagName && elem.ownerDocument && !elem.ownerDocument.body;
-	},
-
-	nodeName: function( elem, name ) {
-		return elem.nodeName && elem.nodeName.toUpperCase() == name.toUpperCase();
-	},
-
-	/**
-	 * A generic iterator function, which can be used to seamlessly
-	 * iterate over both objects and arrays. This function is not the same
-	 * as $().each() - which is used to iterate, exclusively, over a jQuery
-	 * object. This function can be used to iterate over anything.
-	 *
-	 * The callback has two arguments:the key (objects) or index (arrays) as first
-	 * the first, and the value as the second.
-	 *
-	 * @example $.each( [0,1,2], function(i, n){
-	 *   alert( "Item #" + i + ": " + n );
-	 * });
-	 * @desc This is an example of iterating over the items in an array,
-	 * accessing both the current item and its index.
-	 *
-	 * @example $.each( { name: "John", lang: "JS" }, function(i, n){
-	 *   alert( "Name: " + i + ", Value: " + n );
-	 * });
-	 *
-	 * @desc This is an example of iterating over the properties in an
-	 * Object, accessing both the current item and its key.
-	 *
-	 * @name $.each
-	 * @param Object obj The object, or array, to iterate over.
-	 * @param Function fn The function that will be executed on every object.
-	 * @type Object
-	 * @cat JavaScript
-	 */
-	// args is for internal usage only
-	each: function( obj, fn, args ) {
-		if ( obj.length == undefined )
-			for ( var i in obj )
-				fn.apply( obj[i], args || [i, obj[i]] );
-		else
-			for ( var i = 0, ol = obj.length; i < ol; i++ )
-				if ( fn.apply( obj[i], args || [i, obj[i]] ) === false ) break;
-		return obj;
-	},
-	
-	prop: function(elem, value, type, index, prop){
-			// Handle executable functions
-			if ( jQuery.isFunction( value ) )
-				value = value.call( elem, [index] );
-				
-			// exclude the following css properties to add px
-			var exclude = /z-?index|font-?weight|opacity|zoom|line-?height/i;
-
-			// Handle passing in a number to a CSS property
-			return value && value.constructor == Number && type == "curCSS" && !exclude.test(prop) ?
-				value + "px" :
-				value;
-	},
-
-	className: {
-		// internal only, use addClass("class")
-		add: function( elem, c ){
-			jQuery.each( c.split(/\s+/), function(i, cur){
-				if ( !jQuery.className.has( elem.className, cur ) )
-					elem.className += ( elem.className ? " " : "" ) + cur;
-			});
-		},
-
-		// internal only, use removeClass("class")
-		remove: function( elem, c ){
-			elem.className = c != undefined ?
-				jQuery.grep( elem.className.split(/\s+/), function(cur){
-					return !jQuery.className.has( c, cur );	
-				}).join(" ") : "";
-		},
-
-		// internal only, use is(".class")
-		has: function( t, c ) {
-			return jQuery.inArray( c, (t.className || t).toString().split(/\s+/) ) > -1;
-		}
-	},
-
-	/**
-	 * Swap in/out style options.
-	 * @private
-	 */
-	swap: function(e,o,f) {
-		for ( var i in o ) {
-			e.style["old"+i] = e.style[i];
-			e.style[i] = o[i];
-		}
-		f.apply( e, [] );
-		for ( var i in o )
-			e.style[i] = e.style["old"+i];
-	},
-
-	css: function(e,p) {
-		if ( p == "height" || p == "width" ) {
-			var old = {}, oHeight, oWidth, d = ["Top","Bottom","Right","Left"];
-
-			jQuery.each( d, function(){
-				old["padding" + this] = 0;
-				old["border" + this + "Width"] = 0;
-			});
-
-			jQuery.swap( e, old, function() {
-				if ( jQuery(e).is(':visible') ) {
-					oHeight = e.offsetHeight;
-					oWidth = e.offsetWidth;
-				} else {
-					e = jQuery(e.cloneNode(true))
-						.find(":radio").removeAttr("checked").end()
-						.css({
-							visibility: "hidden", position: "absolute", display: "block", right: "0", left: "0"
-						}).appendTo(e.parentNode)[0];
-
-					var parPos = jQuery.css(e.parentNode,"position") || "static";
-					if ( parPos == "static" )
-						e.parentNode.style.position = "relative";
-
-					oHeight = e.clientHeight;
-					oWidth = e.clientWidth;
-
-					if ( parPos == "static" )
-						e.parentNode.style.position = "static";
-
-					e.parentNode.removeChild(e);
-				}
-			});
-
-			return p == "height" ? oHeight : oWidth;
-		}
-
-		return jQuery.curCSS( e, p );
-	},
-
-	curCSS: function(elem, prop, force) {
-		var ret;
-
-		if (prop == "opacity" && jQuery.browser.msie) {
-			ret = jQuery.attr(elem.style, "opacity");
-			return ret == "" ? "1" : ret;
-		}
-		
-		if (prop.match(/float/i))
-			prop = jQuery.browser.msie ? "styleFloat" : "cssFloat";
-
-		if (!force && elem.style[prop])
-			ret = elem.style[prop];
-
-		else if (document.defaultView && document.defaultView.getComputedStyle) {
-
-			if (prop.match(/float/i))
-				prop = "float";
-
-			prop = prop.replace(/([A-Z])/g,"-$1").toLowerCase();
-			var cur = document.defaultView.getComputedStyle(elem, null);
-
-			if ( cur )
-				ret = cur.getPropertyValue(prop);
-			else if ( prop == "display" )
-				ret = "none";
-			else
-				jQuery.swap(elem, { display: "block" }, function() {
-				    var c = document.defaultView.getComputedStyle(this, "");
-				    ret = c && c.getPropertyValue(prop) || "";
-				});
-
-		} else if (elem.currentStyle) {
-			var newProp = prop.replace(/\-(\w)/g,function(m,c){return c.toUpperCase();});
-			ret = elem.currentStyle[prop] || elem.currentStyle[newProp];
-		}
-
-		return ret;
-	},
-	
-	clean: function(a, doc) {
-		var r = [];
-		doc = doc || document;
-
-		jQuery.each( a, function(i,arg){
-			if ( !arg ) return;
-
-			if ( arg.constructor == Number )
-				arg = arg.toString();
-			
-			// Convert html string into DOM nodes
-			if ( typeof arg == "string" ) {
-				// Trim whitespace, otherwise indexOf won't work as expected
-				var s = jQuery.trim(arg).toLowerCase(), div = doc.createElement("div"), tb = [];
-
-				var wrap =
-					// option or optgroup
-					!s.indexOf("<opt") &&
-					[1, "<select>", "</select>"] ||
-					
-					!s.indexOf("<leg") &&
-					[1, "<fieldset>", "</fieldset>"] ||
-					
-					(!s.indexOf("<thead") || !s.indexOf("<tbody") || !s.indexOf("<tfoot") || !s.indexOf("<colg")) &&
-					[1, "<table>", "</table>"] ||
-					
-					!s.indexOf("<tr") &&
-					[2, "<table><tbody>", "</tbody></table>"] ||
-					
-				 	// <thead> matched above
-					(!s.indexOf("<td") || !s.indexOf("<th")) &&
-					[3, "<table><tbody><tr>", "</tr></tbody></table>"] ||
-					
-					!s.indexOf("<col") &&
-					[2, "<table><colgroup>", "</colgroup></table>"] ||
-					
-					[0,"",""];
-
-				// Go to html and back, then peel off extra wrappers
-				div.innerHTML = wrap[1] + arg + wrap[2];
-				
-				// Move to the right depth
-				while ( wrap[0]-- )
-					div = div.firstChild;
-				
-				// Remove IE's autoinserted <tbody> from table fragments
-				if ( jQuery.browser.msie ) {
-					
-					// String was a <table>, *may* have spurious <tbody>
-					if ( !s.indexOf("<table") && s.indexOf("<tbody") < 0 ) 
-						tb = div.firstChild && div.firstChild.childNodes;
-						
-					// String was a bare <thead> or <tfoot>
-					else if ( wrap[1] == "<table>" && s.indexOf("<tbody") < 0 )
-						tb = div.childNodes;
-
-					for ( var n = tb.length-1; n >= 0 ; --n )
-						if ( jQuery.nodeName(tb[n], "tbody") && !tb[n].childNodes.length )
-							tb[n].parentNode.removeChild(tb[n]);
-					
-				}
-				
-				arg = jQuery.makeArray( div.childNodes );
-			}
-
-			if ( 0 === arg.length && !jQuery(arg).is("form, select") )
-				return;
-
-			if ( arg[0] == undefined || jQuery.nodeName(arg, "form") || arg.options )
-				r.push( arg );
-			else
-				r = jQuery.merge( r, arg );
-
-		});
-
-		return r;
-	},
-	
-	attr: function(elem, name, value){
-		var fix = jQuery.isXMLDoc(elem) ? {} : {
-			"for": "htmlFor",
-			"class": "className",
-			"float": jQuery.browser.msie ? "styleFloat" : "cssFloat",
-			cssFloat: jQuery.browser.msie ? "styleFloat" : "cssFloat",
-			styleFloat: jQuery.browser.msie ? "styleFloat" : "cssFloat",
-			innerHTML: "innerHTML",
-			className: "className",
-			value: "value",
-			disabled: "disabled",
-			checked: "checked",
-			readonly: "readOnly",
-			selected: "selected",
-			maxlength: "maxLength"
-		};
-		
-		// IE actually uses filters for opacity ... elem is actually elem.style
-		if ( name == "opacity" && jQuery.browser.msie ) {
-			if ( value != undefined ) {
-				// IE has trouble with opacity if it does not have layout
-				// Force it by setting the zoom level
-				elem.zoom = 1; 
-
-				// Set the alpha filter to set the opacity
-				elem.filter = (elem.filter || "").replace(/alpha\([^)]*\)/,"") +
-					(parseFloat(value).toString() == "NaN" ? "" : "alpha(opacity=" + value * 100 + ")");
-			}
-
-			return elem.filter ? 
-				(parseFloat( elem.filter.match(/opacity=([^)]*)/)[1] ) / 100).toString() : "";
-		}
-		
-		// Certain attributes only work when accessed via the old DOM 0 way
-		if ( fix[name] ) {
-			if ( value != undefined ) elem[fix[name]] = value;
-			return elem[fix[name]];
-
-		} else if ( value == undefined && jQuery.browser.msie && jQuery.nodeName(elem, "form") && (name == "action" || name == "method") )
-			return elem.getAttributeNode(name).nodeValue;
-
-		// IE elem.getAttribute passes even for style
-		else if ( elem.tagName ) {
-			if ( value != undefined ) elem.setAttribute( name, value );
-			if ( jQuery.browser.msie && /href|src/.test(name) && !jQuery.isXMLDoc(elem) ) 
-				return elem.getAttribute( name, 2 );
-			return elem.getAttribute( name );
-
-		// elem is actually elem.style ... set the style
-		} else {
-			name = name.replace(/-([a-z])/ig,function(z,b){return b.toUpperCase();});
-			if ( value != undefined ) elem[name] = value;
-			return elem[name];
-		}
-	},
-	
-	/**
-	 * Remove the whitespace from the beginning and end of a string.
-	 *
-	 * @example $.trim("  hello, how are you?  ");
-	 * @result "hello, how are you?"
-	 *
-	 * @name $.trim
-	 * @type String
-	 * @param String str The string to trim.
-	 * @cat JavaScript
-	 */
-	trim: function(t){
-		return t.replace(/^\s+|\s+$/g, "");
-	},
-
-	makeArray: function( a ) {
-		var r = [];
-
-		// Need to use typeof to fight Safari childNodes crashes
-		if ( typeof a != "array" )
-			for ( var i = 0, al = a.length; i < al; i++ )
-				r.push( a[i] );
-		else
-			r = a.slice( 0 );
-
-		return r;
-	},
-
-	inArray: function( b, a ) {
-		for ( var i = 0, al = a.length; i < al; i++ )
-			if ( a[i] == b )
-				return i;
-		return -1;
-	},
-
-	/**
-	 * Merge two arrays together by concatenating them.
-	 *
-	 * @example $.merge( [0,1,2], [2,3,4] )
-	 * @result [0,1,2,2,3,4]
-	 * @desc Merges two arrays.
-	 *
-	 * @name $.merge
-	 * @type Array
-	 * @param Array first The first array to merge, the elements of second are added.
-	 * @param Array second The second array to append to the first, unaltered.
-	 * @cat JavaScript
-	 */
-	merge: function(first, second) {
-		// We have to loop this way because IE & Opera overwrite the length
-		// expando of getElementsByTagName
-		for ( var i = 0; second[i]; i++ )
-			first.push(second[i]);
-		return first;
-	},
-
-	/**
-	 * Reduce an array (of jQuery objects only) to its unique elements.
-	 *
-	 * @example $.unique( [x1, x2, x3, x2, x3] )
-	 * @result [x1, x2, x3]
-	 * @desc Reduces the arrays of jQuery objects to unique elements by removing the duplicates of x2 and x3
-	 *
-	 * @name $.unique
-	 * @type Array
-	 * @param Array array The array to reduce to its unique jQuery objects.
-	 * @cat JavaScript
-	 */
-	unique: function(first) {
-		var r = [], num = jQuery.mergeNum++;
-
-		for ( var i = 0, fl = first.length; i < fl; i++ )
-			if ( num != first[i].mergeNum ) {
-				first[i].mergeNum = num;
-				r.push(first[i]);
-			}
-
-		return r;
-	},
-
-	mergeNum: 0,
-
-	/**
-	 * Filter items out of an array, by using a filter function.
-	 *
-	 * The specified function will be passed two arguments: The
-	 * current array item and the index of the item in the array. The
-	 * function must return 'true' to keep the item in the array, 
-	 * false to remove it.
-	 *
-	 * @example $.grep( [0,1,2], function(i){
-	 *   return i > 0;
-	 * });
-	 * @result [1, 2]
-	 *
-	 * @name $.grep
-	 * @type Array
-	 * @param Array array The Array to find items in.
-	 * @param Function fn The function to process each item against.
-	 * @param Boolean inv Invert the selection - select the opposite of the function.
-	 * @cat JavaScript
-	 */
-	grep: function(elems, fn, inv) {
-		// If a string is passed in for the function, make a function
-		// for it (a handy shortcut)
-		if ( typeof fn == "string" )
-			fn = new Function("a","i","return " + fn);
-
-		var result = [];
-
-		// Go through the array, only saving the items
-		// that pass the validator function
-		for ( var i = 0, el = elems.length; i < el; i++ )
-			if ( !inv && fn(elems[i],i) || inv && !fn(elems[i],i) )
-				result.push( elems[i] );
-
-		return result;
-	},
-
-	/**
-	 * Translate all items in an array to another array of items.
-	 *
-	 * The translation function that is provided to this method is 
-	 * called for each item in the array and is passed one argument: 
-	 * The item to be translated.
-	 *
-	 * The function can then return the translated value, 'null'
-	 * (to remove the item), or  an array of values - which will
-	 * be flattened into the full array.
-	 *
-	 * @example $.map( [0,1,2], function(i){
-	 *   return i + 4;
-	 * });
-	 * @result [4, 5, 6]
-	 * @desc Maps the original array to a new one and adds 4 to each value.
-	 *
-	 * @example $.map( [0,1,2], function(i){
-	 *   return i > 0 ? i + 1 : null;
-	 * });
-	 * @result [2, 3]
-	 * @desc Maps the original array to a new one and adds 1 to each
-	 * value if it is bigger then zero, otherwise it's removed-
-	 * 
-	 * @example $.map( [0,1,2], function(i){
-	 *   return [ i, i + 1 ];
-	 * });
-	 * @result [0, 1, 1, 2, 2, 3]
-	 * @desc Maps the original array to a new one, each element is added
-	 * with it's original value and the value plus one.
-	 *
-	 * @name $.map
-	 * @type Array
-	 * @param Array array The Array to translate.
-	 * @param Function fn The function to process each item against.
-	 * @cat JavaScript
-	 */
-	map: function(elems, fn) {
-		// If a string is passed in for the function, make a function
-		// for it (a handy shortcut)
-		if ( typeof fn == "string" )
-			fn = new Function("a","return " + fn);
-
-		var result = [];
-
-		// Go through the array, translating each of the items to their
-		// new value (or values).
-		for ( var i = 0, el = elems.length; i < el; i++ ) {
-			var val = fn(elems[i],i);
-
-			if ( val !== null && val != undefined ) {
-				if ( val.constructor != Array ) val = [val];
-				result = result.concat( val );
-			}
-		}
-
-		return result;
-	}
-});
-
-/**
- * Contains flags for the useragent, read from navigator.userAgent.
- * Available flags are: safari, opera, msie, mozilla
- *
- * This property is available before the DOM is ready, therefore you can
- * use it to add ready events only for certain browsers.
- *
- * There are situations where object detections is not reliable enough, in that
- * cases it makes sense to use browser detection. Simply try to avoid both!
- *
- * A combination of browser and object detection yields quite reliable results.
- *
- * @example $.browser.msie
- * @desc Returns true if the current useragent is some version of microsoft's internet explorer
- *
- * @example if($.browser.safari) { $( function() { alert("this is safari!"); } ); }
- * @desc Alerts "this is safari!" only for safari browsers
- *
- * @property
- * @name $.browser
- * @type Boolean
- * @cat JavaScript
- */
- 
-/*
- * Whether the W3C compliant box model is being used.
- *
- * @property
- * @name $.boxModel
- * @type Boolean
- * @cat JavaScript
- */
-new function() {
-	var b = navigator.userAgent.toLowerCase();
-
-	// Figure out what browser is being used
-	jQuery.browser = {
-		version: b.match(/.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/)[1],
-		safari: /webkit/.test(b),
-		opera: /opera/.test(b),
-		msie: /msie/.test(b) && !/opera/.test(b),
-		mozilla: /mozilla/.test(b) && !/(compatible|webkit)/.test(b)
-	};
-
-	// Check to see if the W3C box model is being used
-	jQuery.boxModel = !jQuery.browser.msie || document.compatMode == "CSS1Compat";
-};
-
-/**
- * Get a set of elements containing the unique parents of the matched
- * set of elements.
- *
- * You may use an optional expression to filter the set of parent elements that will match.
- *
- * @example $("p").parent()
- * @before <div><p>Hello</p><p>Hello</p></div>
- * @result [ <div><p>Hello</p><p>Hello</p></div> ]
- * @desc Find the parent element of each paragraph.
- *
- * @example $("p").parent(".selected")
- * @before <div><p>Hello</p></div><div class="selected"><p>Hello Again</p></div>
- * @result [ <div class="selected"><p>Hello Again</p></div> ]
- * @desc Find the parent element of each paragraph with a class "selected".
- *
- * @name parent
- * @type jQuery
- * @param String expr (optional) An expression to filter the parents with
- * @cat DOM/Traversing
- */
-
-/**
- * Get a set of elements containing the unique ancestors of the matched
- * set of elements (except for the root element).
- *
- * The matched elements can be filtered with an optional expression.
- *
- * @example $("span").parents()
- * @before <html><body><div><p><span>Hello</span></p><span>Hello Again</span></div></body></html>
- * @result [ <body>...</body>, <div>...</div>, <p><span>Hello</span></p> ]
- * @desc Find all parent elements of each span.
- *
- * @example $("span").parents("p")
- * @before <html><body><div><p><span>Hello</span></p><span>Hello Again</span></div></body></html>
- * @result [ <p><span>Hello</span></p> ]
- * @desc Find all parent elements of each span that is a paragraph.
- *
- * @name parents
- * @type jQuery
- * @param String expr (optional) An expression to filter the ancestors with
- * @cat DOM/Traversing
- */
-
-/**
- * Get a set of elements containing the unique next siblings of each of the
- * matched set of elements.
- *
- * It only returns the very next sibling for each element, not all
- * next siblings.
- *
- * You may provide an optional expression to filter the match.
- *
- * @example $("p").next()
- * @before <p>Hello</p><p>Hello Again</p><div><span>And Again</span></div>
- * @result [ <p>Hello Again</p>, <div><span>And Again</span></div> ]
- * @desc Find the very next sibling of each paragraph.
- *
- * @example $("p").next(".selected")
- * @before <p>Hello</p><p class="selected">Hello Again</p><div><span>And Again</span></div>
- * @result [ <p class="selected">Hello Again</p> ]
- * @desc Find the very next sibling of each paragraph that has a class "selected".
- *
- * @name next
- * @type jQuery
- * @param String expr (optional) An expression to filter the next Elements with
- * @cat DOM/Traversing
- */
-
-/**
- * Get a set of elements containing the unique previous siblings of each of the
- * matched set of elements.
- *
- * Use an optional expression to filter the matched set.
- *
- * 	Only the immediately previous sibling is returned, not all previous siblings.
- *
- * @example $("p").prev()
- * @before <p>Hello</p><div><span>Hello Again</span></div><p>And Again</p>
- * @result [ <div><span>Hello Again</span></div> ]
- * @desc Find the very previous sibling of each paragraph.
- *
- * @example $("p").prev(".selected")
- * @before <div><span>Hello</span></div><p class="selected">Hello Again</p><p>And Again</p>
- * @result [ <div><span>Hello</span></div> ]
- * @desc Find the very previous sibling of each paragraph that has a class "selected".
- *
- * @name prev
- * @type jQuery
- * @param String expr (optional) An expression to filter the previous Elements with
- * @cat DOM/Traversing
- */
-
-/**
- * Get a set of elements containing all of the unique siblings of each of the
- * matched set of elements.
- *
- * Can be filtered with an optional expressions.
- *
- * @example $("div").siblings()
- * @before <p>Hello</p><div><span>Hello Again</span></div><p>And Again</p>
- * @result [ <p>Hello</p>, <p>And Again</p> ]
- * @desc Find all siblings of each div.
- *
- * @example $("div").siblings(".selected")
- * @before <div><span>Hello</span></div><p class="selected">Hello Again</p><p>And Again</p>
- * @result [ <p class="selected">Hello Again</p> ]
- * @desc Find all siblings with a class "selected" of each div.
- *
- * @name siblings
- * @type jQuery
- * @param String expr (optional) An expression to filter the sibling Elements with
- * @cat DOM/Traversing
- */
-
-/**
- * Get a set of elements containing all of the unique children of each of the
- * matched set of elements.
- *
- * This set can be filtered with an optional expression that will cause
- * only elements matching the selector to be collected.
- *
- * @example $("div").children()
- * @before <p>Hello</p><div><span>Hello Again</span></div><p>And Again</p>
- * @result [ <span>Hello Again</span> ]
- * @desc Find all children of each div.
- *
- * @example $("div").children(".selected")
- * @before <div><span>Hello</span><p class="selected">Hello Again</p><p>And Again</p></div>
- * @result [ <p class="selected">Hello Again</p> ]
- * @desc Find all children with a class "selected" of each div.
- *
- * @name children
- * @type jQuery
- * @param String expr (optional) An expression to filter the child Elements with
- * @cat DOM/Traversing
- */
-jQuery.each({
-	parent: "a.parentNode",
-	parents: "jQuery.parents(a)",
-	next: "jQuery.nth(a,2,'nextSibling')",
-	prev: "jQuery.nth(a,2,'previousSibling')",
-	siblings: "jQuery.sibling(a.parentNode.firstChild,a)",
-	children: "jQuery.sibling(a.firstChild)"
-}, function(i,n){
-	jQuery.fn[ i ] = function(a) {
-		var ret = jQuery.map(this,n);
-		if ( a && typeof a == "string" )
-			ret = jQuery.multiFilter(a,ret);
-		return this.pushStack( ret );
-	};
-});
-
-/**
- * Append all of the matched elements to another, specified, set of elements.
- * This operation is, essentially, the reverse of doing a regular
- * $(A).append(B), in that instead of appending B to A, you're appending
- * A to B.
- *
- * @example $("p").appendTo("#foo");
- * @before <p>I would like to say: </p><div id="foo"></div>
- * @result <div id="foo"><p>I would like to say: </p></div>
- * @desc Appends all paragraphs to the element with the ID "foo"
- *
- * @name appendTo
- * @type jQuery
- * @param <Content> content Content to append to the selected element to.
- * @cat DOM/Manipulation
- * @see append(<Content>)
- */
-
-/**
- * Prepend all of the matched elements to another, specified, set of elements.
- * This operation is, essentially, the reverse of doing a regular
- * $(A).prepend(B), in that instead of prepending B to A, you're prepending
- * A to B.
- *
- * @example $("p").prependTo("#foo");
- * @before <p>I would like to say: </p><div id="foo"><b>Hello</b></div>
- * @result <div id="foo"><p>I would like to say: </p><b>Hello</b></div>
- * @desc Prepends all paragraphs to the element with the ID "foo"
- *
- * @name prependTo
- * @type jQuery
- * @param <Content> content Content to prepend to the selected element to.
- * @cat DOM/Manipulation
- * @see prepend(<Content>)
- */
-
-/**
- * Insert all of the matched elements before another, specified, set of elements.
- * This operation is, essentially, the reverse of doing a regular
- * $(A).before(B), in that instead of inserting B before A, you're inserting
- * A before B.
- *
- * @example $("p").insertBefore("#foo");
- * @before <div id="foo">Hello</div><p>I would like to say: </p>
- * @result <p>I would like to say: </p><div id="foo">Hello</div>
- * @desc Same as $("#foo").before("p")
- *
- * @name insertBefore
- * @type jQuery
- * @param <Content> content Content to insert the selected element before.
- * @cat DOM/Manipulation
- * @see before(<Content>)
- */
-
-/**
- * Insert all of the matched elements after another, specified, set of elements.
- * This operation is, essentially, the reverse of doing a regular
- * $(A).after(B), in that instead of inserting B after A, you're inserting
- * A after B.
- *
- * @example $("p").insertAfter("#foo");
- * @before <p>I would like to say: </p><div id="foo">Hello</div>
- * @result <div id="foo">Hello</div><p>I would like to say: </p>
- * @desc Same as $("#foo").after("p")
- *
- * @name insertAfter
- * @type jQuery
- * @param <Content> content Content to insert the selected element after.
- * @cat DOM/Manipulation
- * @see after(<Content>)
- */
-
-jQuery.each({
-	appendTo: "append",
-	prependTo: "prepend",
-	insertBefore: "before",
-	insertAfter: "after"
-}, function(i,n){
-	jQuery.fn[ i ] = function(){
-		var a = arguments;
-		return this.each(function(){
-			for ( var j = 0, al = a.length; j < al; j++ )
-				jQuery(a[j])[n]( this );
-		});
-	};
-});
-
-/**
- * Remove an attribute from each of the matched elements.
- *
- * @example $("input").removeAttr("disabled")
- * @before <input disabled="disabled"/>
- * @result <input/>
- *
- * @name removeAttr
- * @type jQuery
- * @param String name The name of the attribute to remove.
- * @cat DOM/Attributes
- */
-
-/**
- * Adds the specified class(es) to each of the set of matched elements.
- *
- * @example $("p").addClass("selected")
- * @before <p>Hello</p>
- * @result [ <p class="selected">Hello</p> ]
- *
- * @example $("p").addClass("selected highlight")
- * @before <p>Hello</p>
- * @result [ <p class="selected highlight">Hello</p> ]
- *
- * @name addClass
- * @type jQuery
- * @param String class One or more CSS classes to add to the elements
- * @cat DOM/Attributes
- * @see removeClass(String)
- */
-
-/**
- * Removes all or the specified class(es) from the set of matched elements.
- *
- * @example $("p").removeClass()
- * @before <p class="selected">Hello</p>
- * @result [ <p>Hello</p> ]
- *
- * @example $("p").removeClass("selected")
- * @before <p class="selected first">Hello</p>
- * @result [ <p class="first">Hello</p> ]
- *
- * @example $("p").removeClass("selected highlight")
- * @before <p class="highlight selected first">Hello</p>
- * @result [ <p class="first">Hello</p> ]
- *
- * @name removeClass
- * @type jQuery
- * @param String class (optional) One or more CSS classes to remove from the elements
- * @cat DOM/Attributes
- * @see addClass(String)
- */
-
-/**
- * Adds the specified class if it is not present, removes it if it is
- * present.
- *
- * @example $("p").toggleClass("selected")
- * @before <p>Hello</p><p class="selected">Hello Again</p>
- * @result [ <p class="selected">Hello</p>, <p>Hello Again</p> ]
- *
- * @name toggleClass
- * @type jQuery
- * @param String class A CSS class with which to toggle the elements
- * @cat DOM/Attributes
- */
-
-/**
- * Removes all matched elements from the DOM. This does NOT remove them from the
- * jQuery object, allowing you to use the matched elements further.
- *
- * Can be filtered with an optional expressions.
- *
- * @example $("p").remove();
- * @before <p>Hello</p> how are <p>you?</p>
- * @result how are
- *
- * @example $("p").remove(".hello");
- * @before <p class="hello">Hello</p> how are <p>you?</p>
- * @result how are <p>you?</p>
- *
- * @name remove
- * @type jQuery
- * @param String expr (optional) A jQuery expression to filter elements by.
- * @cat DOM/Manipulation
- */
-
-/**
- * Removes all child nodes from the set of matched elements.
- *
- * @example $("p").empty()
- * @before <p>Hello, <span>Person</span> <a href="#">and person</a></p>
- * @result [ <p></p> ]
- *
- * @name empty
- * @type jQuery
- * @cat DOM/Manipulation
- */
-
-jQuery.each( {
-	removeAttr: function( key ) {
-		jQuery.attr( this, key, "" );
-		this.removeAttribute( key );
-	},
-	addClass: function(c){
-		jQuery.className.add(this,c);
-	},
-	removeClass: function(c){
-		jQuery.className.remove(this,c);
-	},
-	toggleClass: function( c ){
-		jQuery.className[ jQuery.className.has(this,c) ? "remove" : "add" ](this, c);
-	},
-	remove: function(a){
-		if ( !a || jQuery.filter( a, [this] ).r.length )
-			this.parentNode.removeChild( this );
-	},
-	empty: function() {
-		while ( this.firstChild )
-			this.removeChild( this.firstChild );
-	}
-}, function(i,n){
-	jQuery.fn[ i ] = function() {
-		return this.each( n, arguments );
-	};
-});
-
-/**
- * Reduce the set of matched elements to a single element.
- * The position of the element in the set of matched elements
- * starts at 0 and goes to length - 1.
- *
- * @example $("p").eq(1)
- * @before <p>This is just a test.</p><p>So is this</p>
- * @result [ <p>So is this</p> ]
- *
- * @name eq
- * @type jQuery
- * @param Number pos The index of the element that you wish to limit to.
- * @cat Core
- */
-
-/**
- * Reduce the set of matched elements to all elements before a given position.
- * The position of the element in the set of matched elements
- * starts at 0 and goes to length - 1.
- *
- * @example $("p").lt(1)
- * @before <p>This is just a test.</p><p>So is this</p>
- * @result [ <p>This is just a test.</p> ]
- *
- * @name lt
- * @type jQuery
- * @param Number pos Reduce the set to all elements below this position.
- * @cat Core
- */
-
-/**
- * Reduce the set of matched elements to all elements after a given position.
- * The position of the element in the set of matched elements
- * starts at 0 and goes to length - 1.
- *
- * @example $("p").gt(0)
- * @before <p>This is just a test.</p><p>So is this</p>
- * @result [ <p>So is this</p> ]
- *
- * @name gt
- * @type jQuery
- * @param Number pos Reduce the set to all elements after this position.
- * @cat Core
- */
-
-/**
- * Filter the set of elements to those that contain the specified text.
- *
- * @example $("p").contains("test")
- * @before <p>This is just a test.</p><p>So is this</p>
- * @result [ <p>This is just a test.</p> ]
- *
- * @name contains
- * @type jQuery
- * @param String str The string that will be contained within the text of an element.
- * @cat DOM/Traversing
- */
-jQuery.each( [ "eq", "lt", "gt", "contains" ], function(i,n){
-	jQuery.fn[ n ] = function(num,fn) {
-		return this.filter( ":" + n + "(" + num + ")", fn );
-	};
-});
-
-/**
- * Get the current computed, pixel, width of the first matched element.
- *
- * @example $("p").width();
- * @before <p>This is just a test.</p>
- * @result 300
- *
- * @name width
- * @type String
- * @cat CSS
- */
-
-/**
- * Set the CSS width of every matched element. If no explicit unit
- * was specified (like 'em' or '%') then "px" is added to the width.
- *
- * @example $("p").width(20);
- * @before <p>This is just a test.</p>
- * @result <p style="width:20px;">This is just a test.</p>
- *
- * @example $("p").width("20em");
- * @before <p>This is just a test.</p>
- * @result <p style="width:20em;">This is just a test.</p>
- *
- * @name width
- * @type jQuery
- * @param String|Number val Set the CSS property to the specified value.
- * @cat CSS
- */
- 
-/**
- * Get the current computed, pixel, height of the first matched element.
- *
- * @example $("p").height();
- * @before <p>This is just a test.</p>
- * @result 300
- *
- * @name height
- * @type String
- * @cat CSS
- */
-
-/**
- * Set the CSS height of every matched element. If no explicit unit
- * was specified (like 'em' or '%') then "px" is added to the width.
- *
- * @example $("p").height(20);
- * @before <p>This is just a test.</p>
- * @result <p style="height:20px;">This is just a test.</p>
- *
- * @example $("p").height("20em");
- * @before <p>This is just a test.</p>
- * @result <p style="height:20em;">This is just a test.</p>
- *
- * @name height
- * @type jQuery
- * @param String|Number val Set the CSS property to the specified value.
- * @cat CSS
- */
-
-jQuery.each( [ "height", "width" ], function(i,n){
-	jQuery.fn[ n ] = function(h) {
-		return h == undefined ?
-			( this.length ? jQuery.css( this[0], n ) : null ) :
-			this.css( n, h.constructor == String ? h : h + "px" );
-	};
-});
diff --git a/dom/tests/mochitest/ajax/jquery/src/outro.js b/dom/tests/mochitest/ajax/jquery/src/outro.js
deleted file mode 100644
--- a/dom/tests/mochitest/ajax/jquery/src/outro.js
+++ /dev/null
@@ -1,1 +0,0 @@
-}
diff --git a/dom/tests/mochitest/ajax/jquery/src/selector/Makefile.in b/dom/tests/mochitest/ajax/jquery/src/selector/Makefile.in
deleted file mode 100644
--- a/dom/tests/mochitest/ajax/jquery/src/selector/Makefile.in
+++ /dev/null
@@ -1,57 +0,0 @@
-#
-# ***** BEGIN LICENSE BLOCK *****
-# Version: MPL 1.1/GPL 2.0/LGPL 2.1
-#
-# The contents of this file are subject to the Mozilla Public License Version
-# 1.1 (the "License"); you may not use this file except in compliance with
-# the License. You may obtain a copy of the License at
-# http://www.mozilla.org/MPL/
-#
-# Software distributed under the License is distributed on an "AS IS" basis,
-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
-# for the specific language governing rights and limitations under the
-# License.
-#
-# The Original Code is mozilla.org code.
-#
-# The Initial Developer of the Original Code is
-# Mozilla Foundation.
-# Portions created by the Initial Developer are Copyright (C) 2007
-# the Initial Developer. All Rights Reserved.
-#
-# Contributor(s):
-#
-# Alternatively, the contents of this file may be used under the terms of
-# either of the GNU General Public License Version 2 or later (the "GPL"),
-# or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
-# in which case the provisions of the GPL or the LGPL are applicable instead
-# of those above. If you wish to allow use of your version of this file only
-# under the terms of either the GPL or the LGPL, and not to allow others to
-# use your version of this file under the terms of the MPL, indicate your
-# decision by deleting the provisions above and replace them with the notice
-# and other provisions required by the GPL or the LGPL. If you do not delete
-# the provisions above, a recipient may use your version of this file under
-# the terms of any one of the MPL, the GPL or the LGPL.
-#
-# ***** END LICENSE BLOCK *****
-
-DEPTH		= ../../../../../../..
-topsrcdir	= @top_srcdir@
-srcdir		= @srcdir@
-VPATH		= @srcdir@
-relativesrcdir	= dom/tests/mochitest/ajax/jquery/src/selector
-
-include $(DEPTH)/config/autoconf.mk
-
-DIRS	= \
-	$(NULL)
-
-include $(topsrcdir)/config/rules.mk
-
-_TEST_FILES	= \
-	selector.js \
-	selectorTest.js \
-	$(NULL)
-
-libs::	$(_TEST_FILES)
-	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
diff --git a/dom/tests/mochitest/ajax/jquery/src/selector/selector.js b/dom/tests/mochitest/ajax/jquery/src/selector/selector.js
deleted file mode 100644
--- a/dom/tests/mochitest/ajax/jquery/src/selector/selector.js
+++ /dev/null
@@ -1,433 +0,0 @@
-jQuery.extend({
-	expr: {
-		"": "m[2]=='*'||jQuery.nodeName(a,m[2])",
-		"#": "a.getAttribute('id')==m[2]",
-		":": {
-			// Position Checks
-			lt: "i<m[3]-0",
-			gt: "i>m[3]-0",
-			nth: "m[3]-0==i",
-			eq: "m[3]-0==i",
-			first: "i==0",
-			last: "i==r.length-1",
-			even: "i%2==0",
-			odd: "i%2",
-
-			// Child Checks
-			"nth-child": "jQuery.nth(a.parentNode.firstChild,m[3],'nextSibling',a)==a",
-			"first-child": "jQuery.nth(a.parentNode.firstChild,1,'nextSibling')==a",
-			"last-child": "jQuery.nth(a.parentNode.lastChild,1,'previousSibling')==a",
-			"only-child": "jQuery.sibling(a.parentNode.firstChild).length==1",
-
-			// Parent Checks
-			parent: "a.firstChild",
-			empty: "!a.firstChild",
-
-			// Text Check
-			contains: "jQuery.fn.text.apply([a]).indexOf(m[3])>=0",
-
-			// Visibility
-			visible: '"hidden"!=a.type&&jQuery.css(a,"display")!="none"&&jQuery.css(a,"visibility")!="hidden"',
-			hidden: '"hidden"==a.type||jQuery.css(a,"display")=="none"||jQuery.css(a,"visibility")=="hidden"',
-
-			// Form attributes
-			enabled: "!a.disabled",
-			disabled: "a.disabled",
-			checked: "a.checked",
-			selected: "a.selected||jQuery.attr(a,'selected')",
-
-			// Form elements
-			text: "'text'==a.type",
-			radio: "'radio'==a.type",
-			checkbox: "'checkbox'==a.type",
-			file: "'file'==a.type",
-			password: "'password'==a.type",
-			submit: "'submit'==a.type",
-			image: "'image'==a.type",
-			reset: "'reset'==a.type",
-			button: '"button"==a.type||jQuery.nodeName(a,"button")',
-			input: "/input|select|textarea|button/i.test(a.nodeName)"
-		},
-		".": "jQuery.className.has(a,m[2])",
-		"@": {
-			"=": "z==m[4]",
-			"!=": "z!=m[4]",
-			"^=": "z&&!z.indexOf(m[4])",
-			"$=": "z&&z.substr(z.length - m[4].length,m[4].length)==m[4]",
-			"*=": "z&&z.indexOf(m[4])>=0",
-			"": "z",
-			_resort: function(m){
-				return ["", m[1], m[3], m[2], m[5]];
-			},
-			_prefix: "var z=a[m[3]];if(!z||/href|src/.test(m[3]))z=jQuery.attr(a,m[3]);"
-		},
-		"[": "jQuery.find(m[2],a).length"
-	},
-	
-	// The regular expressions that power the parsing engine
-	parse: [
-		// Match: [@value='test'], [@foo]
-		/^\[ *(@)([\w-]+) *([!*$^=]*) *('?"?)(.*?)\4 *\]/,
-
-		// Match: [div], [div p]
-		/^(\[)\s*(.*?(\[.*?\])?[^[]*?)\s*\]/,
-
-		// Match: :contains('foo')
-		/^(:)([\w-]+)\("?'?(.*?(\(.*?\))?[^(]*?)"?'?\)/,
-
-		// Match: :even, :last-chlid, #id, .class
-		new RegExp("^([:.#]*)(" + 
-			( jQuery.chars = "(?:[\\w\u0128-\uFFFF*_-]|\\\\.)" ) + "+)")
-	],
-
-	token: [
-		/^(\/?\.\.)/, "a.parentNode",
-		/^(>|\/)/, "jQuery.sibling(a.firstChild)",
-		/^(\+)/, "jQuery.nth(a,2,'nextSibling')",
-		/^(~)/, function(a){
-			var s = jQuery.sibling(a.parentNode.firstChild);
-			return s.slice(jQuery.inArray(a,s) + 1);
-		}
-	],
-
-	multiFilter: function( expr, elems, not ) {
-		var old, cur = [];
-
-		while ( expr && expr != old ) {
-			old = expr;
-			var f = jQuery.filter( expr, elems, not );
-			expr = f.t.replace(/^\s*,\s*/, "" );
-			cur = not ? elems = f.r : jQuery.merge( cur, f.r );
-		}
-
-		return cur;
-	},
-
-	/**
-	 * @name $.find
-	 * @type Array<Element>
-	 * @private
-	 * @cat Core
-	 */
-	find: function( t, context ) {
-		// Quickly handle non-string expressions
-		if ( typeof t != "string" )
-			return [ t ];
-
-		// Make sure that the context is a DOM Element
-		if ( context && !context.nodeType )
-			context = null;
-
-		// Set the correct context (if none is provided)
-		context = context || document;
-
-		// Handle the common XPath // expression
-		if ( !t.indexOf("//") ) {
-			context = context.documentElement;
-			t = t.substr(2,t.length);
-
-		// And the / root expression
-		} else if ( !t.indexOf("/") && !context.ownerDocument ) {
-			context = context.documentElement;
-			t = t.substr(1,t.length);
-			if ( t.indexOf("/") >= 1 )
-				t = t.substr(t.indexOf("/"),t.length);
-		}
-
-		// Initialize the search
-		var ret = [context], done = [], last;
-
-		// Continue while a selector expression exists, and while
-		// we're no longer looping upon ourselves
-		while ( t && last != t ) {
-			var r = [];
-			last = t;
-
-			t = jQuery.trim(t).replace( /^\/\//, "" );
-
-			var foundToken = false;
-
-			// An attempt at speeding up child selectors that
-			// point to a specific element tag
-			var re = new RegExp("^[/>]\\s*(" + jQuery.chars + "+)");
-			var m = re.exec(t);
-
-			if ( m ) {
-				// Perform our own iteration and filter
-				for ( var i = 0; ret[i]; i++ )
-					for ( var c = ret[i].firstChild; c; c = c.nextSibling )
-						if ( c.nodeType == 1 && ( m[1] == "*" || jQuery.nodeName(c, m[1]) ) )
-							r.push( c );
-
-				ret = r;
-				t = t.replace( re, "" );
-				if ( t.indexOf(" ") == 0 ) continue;
-				foundToken = true;
-			} else {
-				// Look for pre-defined expression tokens
-				for ( var i = 0, tl = jQuery.token.length; i < tl; i += 2 ) {
-					// Attempt to match each, individual, token in
-					// the specified order
-					var re = jQuery.token[i], fn = jQuery.token[i+1];
-					var m = re.exec(t);
-
-					// If the token match was found
-					if ( m ) {
-						// Map it against the token's handler
-						r = ret = jQuery.map( ret, jQuery.isFunction( fn ) ?
-							fn : new Function( "a", "return " + fn ) );
-
-						// And remove the token
-						t = jQuery.trim( t.replace( re, "" ) );
-						foundToken = true;
-						break;
-					}
-				}
-			}
-
-			// See if there's still an expression, and that we haven't already
-			// matched a token
-			if ( t && !foundToken ) {
-				// Handle multiple expressions
-				if ( !t.indexOf(",") ) {
-					// Clean the result set
-					if ( context == ret[0] ) ret.shift();
-
-					// Merge the result sets
-					done = jQuery.merge( done, ret );
-
-					// Reset the context
-					r = ret = [context];
-
-					// Touch up the selector string
-					t = " " + t.substr(1,t.length);
-
-				} else {
-					// Optomize for the case nodeName#idName
-					var re2 = new RegExp("^(" + jQuery.chars + "+)(#)(" + jQuery.chars + "+)");
-					var m = re2.exec(t);
-					
-					// Re-organize the results, so that they're consistent
-					if ( m ) {
-					   m = [ 0, m[2], m[3], m[1] ];
-
-					} else {
-						// Otherwise, do a traditional filter check for
-						// ID, class, and element selectors
-						re2 = new RegExp("^([#.]?)(" + jQuery.chars + "*)");
-						m = re2.exec(t);
-					}
-
-					m[2] = m[2].replace(/\\/g, "");
-
-					var elem = ret[ret.length-1];
-
-					// Try to do a global search by ID, where we can
-					if ( m[1] == "#" && elem && elem.getElementById ) {
-						// Optimization for HTML document case
-						var oid = elem.getElementById(m[2]);
-						
-						// Do a quick check for the existence of the actual ID attribute
-						// to avoid selecting by the name attribute in IE
-						// also check to insure id is a string to avoid selecting an element with the name of 'id' inside a form
-						if ( (jQuery.browser.msie||jQuery.browser.opera) && oid && typeof oid.id == "string" && oid.id != m[2] )
-							oid = jQuery('[@id="'+m[2]+'"]', elem)[0];
-
-						// Do a quick check for node name (where applicable) so
-						// that div#foo searches will be really fast
-						ret = r = oid && (!m[3] || jQuery.nodeName(oid, m[3])) ? [oid] : [];
-					} else {
-						// We need to find all descendant elements
-						for ( var i = 0; ret[i]; i++ ) {
-							// Grab the tag name being searched for
-							var tag = m[1] != "" || m[0] == "" ? "*" : m[2];
-
-							// Handle IE7 being really dumb about <object>s
-							if ( tag == "*" && ret[i].nodeName.toLowerCase() == "object" )
-								tag = "param";
-
-							r = jQuery.merge( r, ret[i].getElementsByTagName( tag ));
-						}
-
-						// It's faster to filter by class and be done with it
-						if ( m[1] == "." )
-							r = jQuery.classFilter( r, m[2] );
-
-						// Same with ID filtering
-						if ( m[1] == "#" ) {
-							var tmp = [];
-
-							// Try to find the element with the ID
-							for ( var i = 0; r[i]; i++ )
-								if ( r[i].getAttribute("id") == m[2] ) {
-									tmp = [ r[i] ];
-									break;
-								}
-
-							r = tmp;
-						}
-
-						ret = r;
-					}
-
-					t = t.replace( re2, "" );
-				}
-
-			}
-
-			// If a selector string still exists
-			if ( t ) {
-				// Attempt to filter it
-				var val = jQuery.filter(t,r);
-				ret = r = val.r;
-				t = jQuery.trim(val.t);
-			}
-		}
-
-		// An error occurred with the selector;
-		// just return an empty set instead
-		if ( t )
-			ret = [];
-
-		// Remove the root context
-		if ( ret && context == ret[0] )
-			ret.shift();
-
-		// And combine the results
-		done = jQuery.merge( done, ret );
-
-		return done;
-	},
-
-	classFilter: function(r,m,not){
-		m = " " + m + " ";
-		var tmp = [];
-		for ( var i = 0; r[i]; i++ ) {
-			var pass = (" " + r[i].className + " ").indexOf( m ) >= 0;
-			if ( !not && pass || not && !pass )
-				tmp.push( r[i] );
-		}
-		return tmp;
-	},
-
-	filter: function(t,r,not) {
-		var last;
-
-		// Look for common filter expressions
-		while ( t  && t != last ) {
-			last = t;
-
-			var p = jQuery.parse, m;
-
-			for ( var i = 0; p[i]; i++ ) {
-				m = p[i].exec( t );
-
-				if ( m ) {
-					// Remove what we just matched
-					t = t.substring( m[0].length );
-
-					// Re-organize the first match
-					if ( jQuery.expr[ m[1] ]._resort )
-						m = jQuery.expr[ m[1] ]._resort( m );
-
-					m[2] = m[2].replace(/\\/g, "");
-
-					break;
-				}
-			}
-
-			if ( !m )
-				break;
-
-			// :not() is a special case that can be optimized by
-			// keeping it out of the expression list
-			if ( m[1] == ":" && m[2] == "not" )
-				r = jQuery.filter(m[3], r, true).r;
-
-			// We can get a big speed boost by filtering by class here
-			else if ( m[1] == "." )
-				r = jQuery.classFilter(r, m[2], not);
-
-			// Otherwise, find the expression to execute
-			else {
-				var f = jQuery.expr[m[1]];
-				if ( typeof f != "string" )
-					f = jQuery.expr[m[1]][m[2]];
-
-				// Build a custom macro to enclose it
-				eval("f = function(a,i){" +
-					( jQuery.expr[ m[1] ]._prefix || "" ) +
-					"return " + f + "}");
-
-				// Execute it against the current filter
-				r = jQuery.grep( r, f, not );
-			}
-		}
-
-		// Return an array of filtered elements (r)
-		// and the modified expression string (t)
-		return { r: r, t: t };
-	},
-
-	/**
-	 * All ancestors of a given element.
-	 *
-	 * @private
-	 * @name $.parents
-	 * @type Array<Element>
-	 * @param Element elem The element to find the ancestors of.
-	 * @cat DOM/Traversing
-	 */
-	parents: function( elem ){
-		var matched = [];
-		var cur = elem.parentNode;
-		while ( cur && cur != document ) {
-			matched.push( cur );
-			cur = cur.parentNode;
-		}
-		return matched;
-	},
-	
-	/**
-	 * A handy, and fast, way to traverse in a particular direction and find
-	 * a specific element.
-	 *
-	 * @private
-	 * @name $.nth
-	 * @type DOMElement
-	 * @param DOMElement cur The element to search from.
-	 * @param String|Number num The Nth result to match. Can be a number or a string (like 'even' or 'odd').
-	 * @param String dir The direction to move in (pass in something like 'previousSibling' or 'nextSibling').
-	 * @cat DOM/Traversing
-	 */
-	nth: function(cur,result,dir,elem){
-		result = result || 1;
-		var num = 0;
-		for ( ; cur; cur = cur[dir] ) {
-			if ( cur.nodeType == 1 ) num++;
-			if ( num == result || result == "even" && num % 2 == 0 && num > 1 && cur == elem ||
-				result == "odd" && num % 2 == 1 && cur == elem ) break;
-		}
-		return cur;
-	},
-	
-	/**
-	 * All elements on a specified axis.
-	 *
-	 * @private
-	 * @name $.sibling
-	 * @type Array
-	 * @param Element elem The element to find all the siblings of (including itself).
-	 * @cat DOM/Traversing
-	 */
-	sibling: function( n, elem ) {
-		var r = [];
-
-		for ( ; n; n = n.nextSibling ) {
-			if ( n.nodeType == 1 && (!elem || n != elem) )
-				r.push( n );
-		}
-
-		return r;
-	}
-});
diff --git a/dom/tests/mochitest/ajax/jquery/src/selector/selectorTest.js b/dom/tests/mochitest/ajax/jquery/src/selector/selectorTest.js
deleted file mode 100644
--- a/dom/tests/mochitest/ajax/jquery/src/selector/selectorTest.js
+++ /dev/null
@@ -1,204 +0,0 @@
-module("selector");
-
-test("element", function() {
-	expect(9);
-	ok( $("*").size() >= 30, "Select all" );
-	t( "Element Selector", "div", ["main","foo"] );
-	t( "Element Selector", "body", ["body"] );
-	t( "Element Selector", "html", ["html"] );
-	t( "Parent Element", "div div", ["foo"] );
-	ok( $("param", "#object1").length == 2, "Object/param as context" );
-	
-	ok( $("#length").length, '&lt;input name="length"&gt; cannot be found under IE, see #945' );
-	ok( $("#lengthtest input").length, '&lt;input name="length"&gt; cannot be found under IE, see #945' );
-
-	t( "Element Selector with underscore", "foo_bar", ["foobar"] );
-});
-
-test("broken", function() {
-	expect(7);
-	t( "Broken Selector", "[", [] );
-	t( "Broken Selector", "(", [] );
-	t( "Broken Selector", "{", [] );
-	t( "Broken Selector", "<", [] );
-	t( "Broken Selector", "()", [] );
-	t( "Broken Selector", "<>", [] );
-	t( "Broken Selector", "{}", [] );
-});
-
-test("id", function() {
-	expect(24);
-	t( "ID Selector", "#body", ["body"] );
-	t( "ID Selector w/ Element", "body#body", ["body"] );
-	t( "ID Selector w/ Element", "ul#first", [] );
-	t( "ID selector with existing ID descendant", "#firstp #simon1", ["simon1"] );
-	t( "ID selector with non-existant descendant", "#firstp #foobar", [] );
-	t( "ID selector using UTF8", "#Taibei", ["Taibei"] );
-	t( "Multiple ID selectors using UTF8", "#Taibei, #", ["Taibei",""] );
-	t( "Descendant ID selector using UTF8", "div #", [""] );
-	t( "Child ID selector using UTF8", "form > #", [""] );
-	
-	t( "Escaped ID", "#foo\\:bar", ["foo:bar"] );
-	t( "Escaped ID", "#test\\.foo\\[5\\]bar", ["test.foo[5]bar"] );
-	t( "Descendant escaped ID", "div #foo\\:bar", ["foo:bar"] );
-	t( "Descendant escaped ID", "div #test\\.foo\\[5\\]bar", ["test.foo[5]bar"] );
-	t( "Child escaped ID", "form > #foo\\:bar", ["foo:bar"] );
-	t( "Child escaped ID", "form > #test\\.foo\\[5\\]bar", ["test.foo[5]bar"] );
-	
-	t( "ID Selector, child ID present", "#form > #radio1", ["radio1"] );  // bug #267
-	t( "ID Selector, not an ancestor ID", "#form  #first", [] );
-	t( "ID Selector, not a child ID", "#form > #option1a", [] );
-	
-	t( "All Children of ID", "#foo/*", ["sndp", "en", "sap"] );
-	t( "All Children of ID with no children", "#firstUL/*", [] );
-	
-	$('<a name="tName1">tName1 A</a><a name="tName2">tName2 A</a><div id="tName1">tName1 Div</div>').appendTo('#main');
-	ok( $("#tName1")[0].id == 'tName1', "ID selector with same value for a name attribute" );
-	ok( $("#tName2").length == 0, "ID selector non-existing but name attribute on an A tag" );
-	t( "ID Selector on Form with an input that has a name of 'id'", "#lengthtest", ["lengthtest"] );
-	
-	t( "ID selector with non-existant ancestor", "#asdfasdf #foobar", [] ); // bug #986
-});
-
-test("class", function() {
-	expect(16);
-	t( "Class Selector", ".blog", ["mark","simon"] );
-	t( "Class Selector", ".blog.link", ["simon"] );
-	t( "Class Selector w/ Element", "a.blog", ["mark","simon"] );
-	t( "Parent Class Selector", "p .blog", ["mark","simon"] );
-	
-	t( "Class selector using UTF8", ".Taibei", ["utf8class1"] );
-	t( "Class selector using UTF8", ".", ["utf8class1","utf8class2"] );
-	t( "Class selector using UTF8", ".Taibei.", ["utf8class1"] );
-	t( "Class selector using UTF8", ".Taibei, .", ["utf8class1","utf8class2"] );
-	t( "Descendant class selector using UTF8", "div .Taibei", ["utf8class1"] );
-	t( "Child class selector using UTF8", "form > .Taibei", ["utf8class1"] );
-	
-	t( "Escaped Class", ".foo\\:bar", ["foo:bar"] );
-	t( "Escaped Class", ".test\\.foo\\[5\\]bar", ["test.foo[5]bar"] );
-	t( "Descendant scaped Class", "div .foo\\:bar", ["foo:bar"] );
-	t( "Descendant scaped Class", "div .test\\.foo\\[5\\]bar", ["test.foo[5]bar"] );
-	t( "Child escaped Class", "form > .foo\\:bar", ["foo:bar"] );
-	t( "Child escaped Class", "form > .test\\.foo\\[5\\]bar", ["test.foo[5]bar"] );
-});
-
-test("multiple", function() {
-	expect(4);
-	t( "Comma Support", "a.blog, div", ["mark","simon","main","foo"] );
-	t( "Comma Support", "a.blog , div", ["mark","simon","main","foo"] );
-	t( "Comma Support", "a.blog ,div", ["mark","simon","main","foo"] );
-	t( "Comma Support", "a.blog,div", ["mark","simon","main","foo"] );
-});
-
-test("child and adjacent", function() {
-	expect(18);
-	t( "Child", "p > a", ["simon1","google","groups","mark","yahoo","simon"] );
-	t( "Child", "p> a", ["simon1","google","groups","mark","yahoo","simon"] );
-	t( "Child", "p >a", ["simon1","google","groups","mark","yahoo","simon"] );
-	t( "Child", "p>a", ["simon1","google","groups","mark","yahoo","simon"] );
-	t( "Child w/ Class", "p > a.blog", ["mark","simon"] );
-	t( "All Children", "code > *", ["anchor1","anchor2"] );
-	t( "All Grandchildren", "p > * > *", ["anchor1","anchor2"] );
-	t( "Adjacent", "a + a", ["groups"] );
-	t( "Adjacent", "a +a", ["groups"] );
-	t( "Adjacent", "a+ a", ["groups"] );
-	t( "Adjacent", "a+a", ["groups"] );
-	t( "Adjacent", "p + p", ["ap","en","sap"] );
-	t( "Comma, Child, and Adjacent", "a + a, code > a", ["groups","anchor1","anchor2"] );
-	
-	t( "First Child", "p:first-child", ["firstp","sndp"] );
-	t( "Nth Child", "p:nth-child(1)", ["firstp","sndp"] );
-	
-	t( "Last Child", "p:last-child", ["sap"] );
-	
-	t( "Nth-child", "#main form > *:nth-child(2)", ["text2","idTest"] );
-	t( "Nth-child", "#main form > :nth-child(2)", ["text2","idTest"] );
-});
-
-test("attributes", function() {
-	expect(20);
-	t( "Attribute Exists", "a[@title]", ["google"] );
-	t( "Attribute Exists", "*[@title]", ["google"] );
-	t( "Attribute Exists", "[@title]", ["google"] );
-	
-	t( "Attribute Equals", "a[@rel='bookmark']", ["simon1"] );
-	t( "Attribute Equals", 'a[@rel="bookmark"]', ["simon1"] );
-	t( "Attribute Equals", "a[@rel=bookmark]", ["simon1"] );
-	t( "Multiple Attribute Equals", "input[@type='hidden'],input[@type='radio']", ["hidden1","radio1","radio2"] );
-	t( "Multiple Attribute Equals", "input[@type=\"hidden\"],input[@type='radio']", ["hidden1","radio1","radio2"] );
-	t( "Multiple Attribute Equals", "input[@type=hidden],input[@type=radio]", ["hidden1","radio1","radio2"] );
-	
-	t( "Attribute selector using UTF8", "span[@lang=]", [""] );
-	
-	t( "Attribute Begins With", "a[@href ^= 'http://www']", ["google","yahoo"] );
-	t( "Attribute Ends With", "a[@href $= 'org/']", ["mark"] );
-	t( "Attribute Contains", "a[@href *= 'google']", ["google","groups"] );
-	
-	t("Select options via [@selected]", "#select1 option[@selected]", ["option1a"] );
-	t("Select options via [@selected]", "#select2 option[@selected]", ["option2d"] );
-	t("Select options via [@selected]", "#select3 option[@selected]", ["option3b", "option3c"] );
-	
-	t( "Grouped Form Elements", "input[@name='foo[bar]']", ["hidden2"] );
-	
-	t( ":not() Existing attribute", "select:not([@multiple])", ["select1", "select2"]);
-	t( ":not() Equals attribute", "select:not([@name=select1])", ["select2", "select3"]);
-	t( ":not() Equals quoted attribute", "select:not([@name='select1'])", ["select2", "select3"]);
-});
-
-test("pseudo (:) selectors", function() {
-	expect(30);
-	t( "First Child", "p:first-child", ["firstp","sndp"] );
-	t( "Last Child", "p:last-child", ["sap"] );
-	t( "Only Child", "a:only-child", ["simon1","anchor1","yahoo","anchor2"] );
-	t( "Empty", "ul:empty", ["firstUL"] );
-	t( "Enabled UI Element", "input:enabled", ["text1","radio1","radio2","check1","check2","hidden1","hidden2","name","length","idTest"] );
-	t( "Disabled UI Element", "input:disabled", ["text2"] );
-	t( "Checked UI Element", "input:checked", ["radio2","check1"] );
-	t( "Selected Option Element", "option:selected", ["option1a","option2d","option3b","option3c"] );
-	t( "Text Contains", "a:contains('Google')", ["google","groups"] );
-	t( "Text Contains", "a:contains('Google Groups')", ["groups"] );
-	t( "Element Preceded By", "p ~ div", ["foo"] );
-	t( "Not", "a.blog:not(.link)", ["mark"] );
-	
-	t( "nth Element", "p:nth(1)", ["ap"] );
-	t( "First Element", "p:first", ["firstp"] );
-	t( "Last Element", "p:last", ["first"] );
-	t( "Even Elements", "p:even", ["firstp","sndp","sap"] );
-	t( "Odd Elements", "p:odd", ["ap","en","first"] );
-	t( "Position Equals", "p:eq(1)", ["ap"] );
-	t( "Position Greater Than", "p:gt(0)", ["ap","sndp","en","sap","first"] );
-	t( "Position Less Than", "p:lt(3)", ["firstp","ap","sndp"] );
-	t( "Is A Parent", "p:parent", ["firstp","ap","sndp","en","sap","first"] );
-	t( "Is Visible", "input:visible", ["text1","text2","radio1","radio2","check1","check2","name","length","idTest"] );
-	t( "Is Hidden", "input:hidden", ["hidden1","hidden2"] );
-	
-	t( "Form element :input", ":input", ["text1", "text2", "radio1", "radio2", "check1", "check2", "hidden1", "hidden2", "name", "button", "area1", "select1", "select2", "select3", "length", "idTest"] );
-	t( "Form element :radio", ":radio", ["radio1", "radio2"] );
-	t( "Form element :checkbox", ":checkbox", ["check1", "check2"] );
-	t( "Form element :text", ":text", ["text1", "text2", "hidden2", "name", "length", "idTest"] );
-	t( "Form element :radio:checked", ":radio:checked", ["radio2"] );
-	t( "Form element :checkbox:checked", ":checkbox:checked", ["check1"] );
-	t( "Form element :checkbox:checked, :radio:checked", ":checkbox:checked, :radio:checked", ["check1", "radio2"] );
-});
-
-test("basic xpath", function() {
-	expect(15);
-	ok( jQuery.find("//*").length >= 30, "All Elements (//*)" );
-	t( "All Div Elements", "//div", ["main","foo"] );
-	t( "Absolute Path", "/html/body", ["body"] );
-	t( "Absolute Path w/ *", "/* /body", ["body"] );
-	t( "Long Absolute Path", "/html/body/dl/div/div/p", ["sndp","en","sap"] );
-	t( "Absolute and Relative Paths", "/html//div", ["main","foo"] );
-	t( "All Children, Explicit", "//code/*", ["anchor1","anchor2"] );
-	t( "All Children, Implicit", "//code/", ["anchor1","anchor2"] );
-	t( "Attribute Exists", "//a[@title]", ["google"] );
-	t( "Attribute Equals", "//a[@rel='bookmark']", ["simon1"] );
-	t( "Parent Axis", "//p/..", ["main","foo"] );
-	t( "Sibling Axis", "//p/../", ["firstp","ap","foo","first","firstUL","empty","form","floatTest","iframe","lengthtest","table","sndp","en","sap"] );
-	t( "Sibling Axis", "//p/../*", ["firstp","ap","foo","first","firstUL","empty","form","floatTest","iframe","lengthtest","table","sndp","en","sap"] );
-	t( "Has Children", "//p[a]", ["firstp","ap","en","sap"] );
-	
-	$("#foo").each(function() {
-		isSet( $("/p", this).get(), q("sndp", "en", "sap"), "Check XPath context" );
-	});
-});
diff --git a/dom/tests/mochitest/ajax/jquery/test/Makefile.in b/dom/tests/mochitest/ajax/jquery/test/Makefile.in
--- a/dom/tests/mochitest/ajax/jquery/test/Makefile.in
+++ b/dom/tests/mochitest/ajax/jquery/test/Makefile.in
@@ -43,15 +43,19 @@ relativesrcdir	= dom/tests/mochitest/aja
 
 include $(DEPTH)/config/autoconf.mk
 
 DIRS	= \
 	data \
+	unit \
 	$(NULL)
 
 include $(topsrcdir)/config/rules.mk
 
 _TEST_FILES	= \
 	index.html \
+	offset.html \
+	test.js \
+	fix.html \
 	$(NULL)
 
 libs::	$(_TEST_FILES)
 	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/Makefile.in b/dom/tests/mochitest/ajax/jquery/test/data/Makefile.in
--- a/dom/tests/mochitest/ajax/jquery/test/data/Makefile.in
+++ b/dom/tests/mochitest/ajax/jquery/test/data/Makefile.in
@@ -42,16 +42,28 @@ relativesrcdir	= dom/tests/mochitest/aja
 relativesrcdir	= dom/tests/mochitest/ajax/jquery/test/data
 
 include $(DEPTH)/config/autoconf.mk
 
 DIRS	= \
+	offset \
 	$(NULL)
 
 include $(topsrcdir)/config/rules.mk
 
 _TEST_FILES	= \
+	cow.jpg \
+	dashboard.xml \
+	iframe.html \
+	json_assigned_obj.js \
+	json_obj.js \
+	name.html \
+	test.html \
+	test.js \
+	test2.html \
+	test3.html \
 	testrunner.js \
 	testsuite.css \
+	with_fries.xml \
 	$(NULL)
 
 libs::	$(_TEST_FILES)
 	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/cow.jpg b/dom/tests/mochitest/ajax/jquery/test/data/cow.jpg
new file mode 100644
index 0000000000000000000000000000000000000000..2c5b67225995af90e8bf5a6dc065428bc3bbbb65
GIT binary patch
literal 1635
zc$}S*c{tR09LK*ubD6<1t{BNRuEw3&LMYcbR$FqESPw>$2;-I&N@$S#<{?s|T}@Mt
zr=&1w8tHO{nB0;nN2GqMp52~(p8aQcU!Q+I&-4E0^LjrYcmRG4L~N~WtN_FZ0qd;+
z@O^;i2YNsc0pS539zx(Dco>`mXe0`aLZZ<qGzNp_$KeHVSS(ILSVRynElD6qNlI;#
zkyBHUkyYNYO-fN)Nm+fThNgy$g08*}NneemL4q(C3=WGE7Z4C9ZI{}<o%COU+o4JT
zAQbcs@Fx%-V(TyrKNcq-0{9>Vf)9y6p^(U}Bz7wUNIXhZL3ck|?2so$F<4wLKC^;f
z$*iGG!l7@8xXUXf0gIE|CM8W!R#8<`->FajarYhrLvssDD~h#^?O{hJXO|;KUA?J3
z$9+%uouq|^g-1k2MJJv+pL8KPB{eHMCpRy@ps=X&a#i(}nyc4pZ!&H%Z{KNbYJTvr
zy`z)W)!p;-+4C1K`v(Sx#wWOMCa0!nX6JbCKP<1Tu6<nJfB*vei+}iR)erF@kq9K_
zs}IB%@ioLFQ3|?f(fx-op21>@dhz_?W|<WYZCIsU4oebVA$>SWqW-ut@2k=`qkkuq
z@V|_{3w`&2hkzgg+IkxV9+-kRp*B9TDt$$MHoCv@%57gw`nmPpIeI)t@sX<8&zxu|
z+opw-kT#&m9`DL>Q(QdNG?BD`BQ}TCk5-c?Uev<=cc}cDdGq{&=h{zZ6qZWoX7lrR
zGu$lo?Fz=t+?qCpv|?>nqumSaJg<_g^39AgPs@#lv_noI24^mY(|Q8rRa`h7UzBF;
zcS#4*2*R83bugGO_~MvWHXS>DY&e3M&^}n`E7*IFxX#!#?Om>`jwv>KsX2d7mhgD;
zV{2<sXS>?IC%J+@7zNQrYuGIkUv_LtFqg(s0#;_2vp2jlG_HDqMtQpANZ0h!0uDX$
znSCGG?^cG$$)PhF#joTTEK&S9(=ZP@dNWoHae)`!5?1HYrOXbpY9}h4HJ-Pw*YY&*
z_hOcBMzz7ft$*D~Gu<zcEi7b7-0-0vtcW6zA<D06ft{-XGof-qTwYphGPAqpmSK3w
z?ex5<$cK=&g(p3`yZdcwM++m8l`HF<7#yv?lHpP&Q)(#_(3TdoJ3=WvCn;L9<l+yP
zsPEr+5+nx+i{4`(LcjCOAP+NMldQs{ei#^fWPEpFirS>Q<A`^8@!o6FpVgs;+FSP5
z-0SqP$PjTaBc0b79A-Le@0#Wy3|J*{E05!H9R{ZJ79K5GbW7x3;WFuViA4`uA}IBV
zcE?H?bG&06ljed|@p+|@jwXdGH)u}+$X?pmUs4tqm5-0Qn%Nl7hsEr0x5z1?khpQF
zMPKqK{I6>oIx=oEW8;6a?L1(ZMKOOnREVz0IL#cB`l$LaqS<H2ub*Z@P3CxxvKBAJ
zEE9#z_pz;764oahnLeSu3Z*V5!ZCtlDae-%1Jh+w)qgKGDv;xAX}>`(!#d;X_~Fz-
zOY6Dw6s)_Xa{8*%KtGkTKq6a=OccAy5M)`aRG-Vp%1ezK)8$X=S(Q5UwNs1<o8`4u
z-{+yjcGr`wJ#@Lq&&G3vn@zQTEsE6~hDnX67>*cZz4zupp98|AS(aQH-o?{2Ok6Qd
zfleWu-?s-ivvx(07hu5U2yaZa_MC5^-|;o5z<<v0?Sg@`X)d}q<kciwOP(sqoz#3n
z0Fy(p;T&!@vEqJ@Hk<y6Ym!@jm*zOpNAqZSK`zXDACr?FzFsC}BhX^p+F4HeJ?E)U
zDdv-d8rvnS)>V7t+}ZXLZ=+_O#bNQP!urg_uIutI7%<4#V>(|1gPoF{dLw1(LL*&C
zI$A0~jm7adDm@i9tQ9vsar)CjUohtT8YFz%4F<jKV{3zzujNiP!Js^)^&P|VzR4gB
k2Bu<hW5+MX_YaJY#HNmYR*75jhk>SWwG(^D#S|X=1CqqrdH?_b

diff --git a/dom/tests/mochitest/ajax/jquery/test/data/dashboard.xml b/dom/tests/mochitest/ajax/jquery/test/data/dashboard.xml
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/data/dashboard.xml
@@ -0,0 +1,11 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<dashboard>
+	<locations class="foo">
+		<location for="bar">
+			<infowindowtab>
+				<tab title="Location"><![CDATA[blabla]]></tab>
+				<tab title="Users"><![CDATA[blublu]]></tab>
+			</infowindowtab>
+		</location>
+	</locations>
+</dashboard>
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/iframe.html b/dom/tests/mochitest/ajax/jquery/test/data/iframe.html
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/data/iframe.html
@@ -0,0 +1,8 @@
+<html>
+  <head>
+    <title>iframe</title>
+  </head>
+  <body>
+    <div><span>span text</span></div>
+  </body>
+</html>
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/json_assigned_obj.js b/dom/tests/mochitest/ajax/jquery/test/data/json_assigned_obj.js
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/data/json_assigned_obj.js
@@ -0,0 +1,1 @@
+json_assigned_obj = { "test" : "worked" };
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/json_obj.js b/dom/tests/mochitest/ajax/jquery/test/data/json_obj.js
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/data/json_obj.js
@@ -0,0 +1,1 @@
+{ "data": {"lang": "en", "length": 25} }
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/name.html b/dom/tests/mochitest/ajax/jquery/test/data/name.html
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/data/name.html
@@ -0,0 +1,1 @@
+ERROR <script type="text/javascript">ok( true, "name.html retrieved" );</script>
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/offset/Makefile.in b/dom/tests/mochitest/ajax/jquery/test/data/offset/Makefile.in
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/data/offset/Makefile.in
@@ -0,0 +1,61 @@
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is mozilla.org code.
+#
+# The Initial Developer of the Original Code is
+# Mozilla Foundation.
+# Portions created by the Initial Developer are Copyright (C) 2007
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either of the GNU General Public License Version 2 or later (the "GPL"),
+# or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+DEPTH		= ../../../../../../../..
+topsrcdir	= @top_srcdir@
+srcdir		= @srcdir@
+VPATH		= @srcdir@
+relativesrcdir	= dom/tests/mochitest/ajax/jquery/test/data/offset
+
+include $(DEPTH)/config/autoconf.mk
+
+DIRS	= \
+	$(NULL)
+
+include $(topsrcdir)/config/rules.mk
+
+_TEST_FILES	= \
+	absolute.html \
+	fixed.html \
+	relative.html \
+	scroll.html \
+	static.html \
+	table.html \
+	$(NULL)
+
+libs::	$(_TEST_FILES)
+	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/offset/absolute.html b/dom/tests/mochitest/ajax/jquery/test/data/offset/absolute.html
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/data/offset/absolute.html
@@ -0,0 +1,39 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
+	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html>
+	<head>
+		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
+		<title>absolute</title>
+		<style type="text/css" media="screen">
+			body { margin: 1px; padding: 5px; }
+			div.absolute { position: absolute; margin: 1px; border: 2px solid #000; padding: 5px; width: 100px; height: 100px; background: #fff; }
+			#absolute-1 { top: 0; left: 0; }
+				#absolute-1-1 { top: 1px; left: 1px; }
+					#absolute-1-1-1 { top: 1px; left: 1px; }
+			#absolute-2 { top: 19px; left: 19px; }
+			#marker { position: absolute; border: 2px solid #000; width: 50px; height: 50px; background: #ccc; }
+			p.instructions { position: absolute; bottom: 0; }
+		</style>
+		<script type="text/javascript" src="../../../dist/jquery.js"></script>
+		<script type="text/javascript" charset="utf-8">
+			$(function() {
+				$('.absolute').click(function() {
+					$('#marker').css( $(this).offset() );
+					var pos = $(this).position();
+					$(this).css({ top: pos.top, left: pos.left });
+					return false;
+				});
+			});
+		</script>
+	</head>
+	<body>
+		<div id="absolute-1" class="absolute">absolute-1
+			<div id="absolute-1-1" class="absolute">absolute-1-1
+				<div id="absolute-1-1-1" class="absolute">absolute-1-1-1</div>
+			</div>
+		</div>
+		<div id="absolute-2" class="absolute">absolute-2</div>
+		<div id="marker"></div>
+		<p class="instructions">Click the white box to move the marker to it. Clicking the box also changes the position to absolute (if not already) and sets the position according to the position method.</p>
+	</body>
+</html>
\ No newline at end of file
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/offset/fixed.html b/dom/tests/mochitest/ajax/jquery/test/data/offset/fixed.html
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/data/offset/fixed.html
@@ -0,0 +1,33 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
+	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html>
+	<head>
+		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
+		<title>fixed</title>
+		<style type="text/css" media="screen">
+			body { margin: 1px; padding: 5px; }
+			div.fixed { position: fixed; margin: 1px; border: 2px solid #000; padding: 5px; width: 100px; height: 100px; background: #fff; overflow: hidden; }
+			#fixed-1 { top: 0; left: 0; }
+			#fixed-2 { top: 20px; left: 20px; }
+			#forceScroll { width: 5000px; height: 5000px; }
+			#marker { position: absolute; border: 2px solid #000; width: 50px; height: 50px; background: #ccc; }
+		</style>
+		<script type="text/javascript" src="../../../dist/jquery.js"></script>
+		<script type="text/javascript" charset="utf-8">
+			$(function() {
+				window.scrollTo(1000,1000);
+				$('.fixed').click(function() {
+					$('#marker').css( $(this).offset() );
+					return false;
+				});
+			});
+		</script>
+	</head>
+	<body>
+		<div id="fixed-1" class="fixed"></div>
+		<div id="fixed-2" class="fixed"></div>
+		<div id="forceScroll"></div>
+		<div id="marker"></div>
+		<p class="instructions">Click the white box to move the marker to it.</p>
+	</body>
+</html>
\ No newline at end of file
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/offset/relative.html b/dom/tests/mochitest/ajax/jquery/test/data/offset/relative.html
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/data/offset/relative.html
@@ -0,0 +1,31 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
+	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html>
+	<head>
+		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
+		<title>relative</title>
+		<style type="text/css" media="screen">
+			body { margin: 1px; padding: 5px; }
+			div.relative { position: relative; margin: 1px; border: 2px solid #000; padding: 5px; width: 100px; height: 100px; background: #fff; overflow: hidden; }
+			#relative-2 { top: 20px; left: 20px; }
+			#marker { position: absolute; border: 2px solid #000; width: 50px; height: 50px; background: #ccc; }
+		</style>
+		<script type="text/javascript" src="../../../dist/jquery.js"></script>
+		<script type="text/javascript" charset="utf-8">
+			$(function() {
+				$('.relative').click(function() {
+					$('#marker').css( $(this).offset() );
+					var pos = $(this).position();
+					$(this).css({ position: 'absolute', top: pos.top, left: pos.left });
+					return false;
+				});
+			});
+		</script>
+	</head>
+	<body>
+		<div id="relative-1" class="relative"><div id="relative-1-1" class="relative"><div id="relative-1-1-1" class="relative"></div></div></div>
+		<div id="relative-2" class="relative"></div>
+		<div id="marker"></div>
+		<p class="instructions">Click the white box to move the marker to it. Clicking the box also changes the position to absolute (if not already) and sets the position according to the position method.</p>
+	</body>
+</html>
\ No newline at end of file
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/offset/scroll.html b/dom/tests/mochitest/ajax/jquery/test/data/offset/scroll.html
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/data/offset/scroll.html
@@ -0,0 +1,39 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
+	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html>
+	<head>
+		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
+		<title>scroll</title>
+		<style type="text/css" media="screen">
+			body { margin: 1px; padding: 5px; }
+			div.scroll { position: relative; margin: 1px; border: 2px solid #000; padding: 5px; width: 100px; height: 100px; background: #fff; overflow: auto; }
+			#scroll-1 { top: 0; left: 0; }
+				#scroll-1-1 { top: 1px; left: 1px; }
+					#scroll-1-1-1 { top: 1px; left: 1px; }
+			#forceScroll { width: 5000px; height: 5000px; }
+			#marker { position: absolute; border: 2px solid #000; width: 50px; height: 50px; background: #ccc; }
+		</style>
+		<script type="text/javascript" src="../../../dist/jquery.js"></script>
+		<script type="text/javascript" charset="utf-8">
+			$(function() {
+				window.scrollTo(1000,1000);
+				$('#scroll-1')[0].scrollLeft = 5;
+				$('#scroll-1')[0].scrollTop = 5;
+				$('.scroll').click(function() {
+					$('#marker').css( $(this).offset() );
+					return false;
+				});
+			});
+		</script>
+	</head>
+	<body>
+		<div id="scroll-1" class="scroll">
+			<div id="scroll-1-1" class="scroll">
+				<div id="scroll-1-1-1" class="scroll"></div>
+			</div>
+		</div>
+		<div id="forceScroll"></div>
+		<div id="marker"></div>
+		<p class="instructions">Click the white box to move the marker to it.</p>
+	</body>
+</html>
\ No newline at end of file
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/offset/static.html b/dom/tests/mochitest/ajax/jquery/test/data/offset/static.html
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/data/offset/static.html
@@ -0,0 +1,31 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
+	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html>
+	<head>
+		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
+		<title>static</title>
+		<style type="text/css" media="screen">
+			body { margin: 1px; padding: 5px; }
+			div.static { position: static; margin: 1px; border: 2px solid #000; padding: 5px; width: 100px; height: 100px; background: #fff; overflow: hidden; }
+			#static-2 { top: 20px; left: 20px; }
+			#marker { position: absolute; border: 2px solid #000; width: 50px; height: 50px; background: #ccc; }
+		</style>
+		<script type="text/javascript" src="../../../dist/jquery.js"></script>
+		<script type="text/javascript" charset="utf-8">
+			$(function() {
+				$('.static').click(function() {
+					$('#marker').css( $(this).offset() );
+					var pos = $(this).position();
+					$(this).css({ position: 'absolute', top: pos.top, left: pos.left });
+					return false;
+				});
+			});
+		</script>
+	</head>
+	<body>
+		<div id="static-1" class="static"><div id="static-1-1" class="static"><div id="static-1-1-1" class="static"></div></div></div>
+		<div id="static-2" class="static"></div>
+		<div id="marker"></div>
+		<p class="instructions">Click the white box to move the marker to it. Clicking the box also changes the position to absolute (if not already) and sets the position according to the position method.</p>
+	</body>
+</html>
\ No newline at end of file
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/offset/table.html b/dom/tests/mochitest/ajax/jquery/test/data/offset/table.html
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/data/offset/table.html
@@ -0,0 +1,43 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
+	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html>
+	<head>
+		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
+		<title>table</title>
+		<style type="text/css" media="screen">
+			body { margin: 1px; padding: 5px; }
+			table { border: 2px solid #000; }
+			th, td { border: 1px solid #000; width: 100px; height: 100px; }
+			#marker { position: absolute; border: 2px solid #000; width: 50px; height: 50px; background: #ccc; }
+		</style>
+		<script type="text/javascript" src="../../../dist/jquery.js"></script>
+		<script type="text/javascript" charset="utf-8">
+			$(function() {
+				$('table, th, td').click(function() {
+					$('#marker').css( $(this).offset() );
+					return false;
+				});
+			});
+		</script>
+	</head>
+	<body>
+		<table id="table-1">
+			<thead>
+				<tr valign="top">
+					<th id="th-1">th-1</th>
+					<th id="th-2">th-2</th>
+					<th id="th-3">th-3</th>
+				</tr>
+			</thead>
+			<tbody>
+				<tr valign="top">
+					<td id="td-1">td-1</td>
+					<td id="td-2">td-2</td>
+					<td id="td-3">td-3</td>
+				</tr>
+			</tbody>
+		</table>
+		<div id="marker"></div>
+		<p class="instructions">Click the white box to move the marker to it.</p>
+	</body>
+</html>
\ No newline at end of file
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/test.html b/dom/tests/mochitest/ajax/jquery/test/data/test.html
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/data/test.html
@@ -0,0 +1,7 @@
+html text<br/>
+<script type="text/javascript">/* <![CDATA[ */
+testFoo = "foo"; $('#foo').html('foo');
+ok( true, "test.html executed" );
+/* ]]> */</script>
+<script src="data/test.js"></script>
+blabla
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/test.js b/dom/tests/mochitest/ajax/jquery/test/data/test.js
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/data/test.js
@@ -0,0 +1,3 @@
+var foobar = "bar";
+$('#ap').html('bar');
+ok( true, "test.js executed");
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/test2.html b/dom/tests/mochitest/ajax/jquery/test/data/test2.html
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/data/test2.html
@@ -0,0 +1,5 @@
+<script type="text/javascript">
+var testFoo = "foo";
+$('#foo').html('foo');
+ok( true, "test2.html executed" );
+</script>
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/test3.html b/dom/tests/mochitest/ajax/jquery/test/data/test3.html
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/data/test3.html
@@ -0,0 +1,3 @@
+<div class="user">This is a user</div>
+<div class="user">This is a user</div>
+<div class="teacher">This is a teacher</div>
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/testrunner.js b/dom/tests/mochitest/ajax/jquery/test/data/testrunner.js
--- a/dom/tests/mochitest/ajax/jquery/test/data/testrunner.js
+++ b/dom/tests/mochitest/ajax/jquery/test/data/testrunner.js
@@ -10,10 +10,15 @@ var _config = {
 	timeout: null,
 	expected: null,
 	currentModule: null,
 	asyncTimeout: 2 // seconds for async timeout
 };
+
+_config.filters = location.search.length > 1 && //restrict modules/tests by get parameters
+		$.map( location.search.slice(1).split('&'), decodeURIComponent );
+
+var isLocal = !!(window.location.protocol == 'file:');
 
 $(function() {
 	$('#userAgent').html(navigator.userAgent);
 	runTest();	
 });
@@ -37,42 +42,67 @@ function stop(allowFailure) {
 	_config.blocking = true;
 	var handler = allowFailure ? start : function() {
 		ok( false, "Test timed out" );
 		start();
 	};
-	_config.timeout = setTimeout(handler, _config.asyncTimeout * 1000);
+	// Disabled, caused too many random errors
+	//_config.timeout = setTimeout(handler, _config.asyncTimeout * 1000);
 }
 function start() {
-	if(_config.timeout)
-		clearTimeout(_config.timeout);
-	_config.blocking = false;
-	process();
+	// A slight delay, to avoid any current callbacks
+	setTimeout(function(){
+		if(_config.timeout)
+			clearTimeout(_config.timeout);
+		_config.blocking = false;
+		process();
+	}, 13);
+}
+
+function validTest( name ) {
+	var filters = _config.filters;
+	if( !filters )
+		return true;
+
+	var i = filters.length,
+		run = false;
+	while( i-- ){
+		var filter = filters[i],
+			not = filter.charAt(0) == '!';
+		if( not ) 
+			filter = filter.slice(1);
+		if( name.indexOf(filter) != -1 )
+			return !not;
+		if( not )
+			run = true;
+	}
+	return run;
 }
 
 function runTest() {
 	_config.blocking = false;
 	var time = new Date();
 	_config.fixture = document.getElementById('main').innerHTML;
+	_config.ajaxSettings = $.ajaxSettings;
 	synchronize(function() {
 		time = new Date() - time;
 		$("<div>").html(['<p class="result">Tests completed in ',
 			time, ' milliseconds.<br/>',
 			_config.stats.bad, ' tests of ', _config.stats.all, ' failed.</p>']
 			.join(''))
 			.appendTo("body");
 		$("#banner").addClass(_config.stats.bad ? "fail" : "pass");
 		if ( parent.runAJAXTest )
 			parent.runAJAXTest();
+
 	});
 }
 
 function test(name, callback, nowait) {
 	if(_config.currentModule)
 		name = _config.currentModule + " module: " + name;
 		
-	var filter = location.search.slice(1);
-	if ( filter && encodeURIComponent(name) != filter )
+	if ( !validTest(name) )
 		return;
 		
 	synchronize(function() {
 		_config.Test = [];
 		try {
@@ -81,11 +111,11 @@ function test(name, callback, nowait) {
 			if( typeof console != "undefined" && console.error && console.warn ) {
 				console.error("Test " + name + " died, exception and test follows");
 				console.error(e);
 				console.warn(callback.toString());
 			}
-			_config.Test.push( [ false, "Died on test #" + (_config.Test.length+1) + ": " + e ] );
+			_config.Test.push( [ false, "Died on test #" + (_config.Test.length+1) + ": " + e.message ] );
 		}
 	});
 	synchronize(function() {
 		reset();
 		
@@ -111,13 +141,13 @@ function test(name, callback, nowait) {
 			if ( !_config.Test[i][0] ) {
 				state = "fail";
 				bad++;
 				_config.stats.bad++;
 			} else good++;
-
-			if ( parent.SimpleTest )
-				parent.SimpleTest.ok( _config.Test[i][0], name, _config.Test[i][1] );
+			
+			if ( parent.SimpleTest ){
+				parent.SimpleTest.ok( _config.Test[i][0], name, _config.Test[i][1] );}
 		}
 	
 		var li = document.createElement("li");
 		li.className = state;
 	
@@ -158,11 +188,13 @@ function expect(asserts) {
 
 /**
  * Resets the test setup. Useful for tests that modify the DOM.
  */
 function reset() {
-	document.getElementById('main').innerHTML = _config.fixture;
+	$("#main").html( _config.fixture );
+	$.event.global = {};
+	$.ajaxSettings = $.extend({}, _config.ajaxSettings);
 }
 
 /**
  * Asserts true.
  * @example ok( $("a").size() > 5, "There must be at least 5 anchors" );
@@ -221,11 +253,11 @@ function serialArray( a ) {
             } else
                 str = a[i];
             r.push( str );
         }
 
-	return "[ " + r.join(", ") + " ]"
+	return "[ " + r.join(", ") + " ]";
 }
 
 /**
  * Returns an array of elements with the given IDs, eg.
  * @example q("main", "foo", "bar")
@@ -270,15 +302,15 @@ function url(value) {
  *
  * Prefered to ok( expected == actual, message )
  *
  * @example equals( "Expected 2 characters.", v.formatMessage("Expected {0} characters.", 2) );
  *
+ * @param Object actual
  * @param Object expected
- * @param Object actual
  * @param String message (optional)
  */
-function equals(expected, actual, message) {
+function equals(actual, expected, message) {
 	var result = expected == actual;
 	message = message || (result ? "okay" : "failed");
 	_config.Test.push( [ result, result ? message + ": " + expected : message + " expected: " + expected + " actual: " + actual ] );
 }
 
@@ -297,6 +329,6 @@ function triggerEvent( elem, type, event
 			0, 0, 0, 0, 0, false, false, false, false, 0, null);
 		elem.dispatchEvent( event );
 	} else if ( jQuery.browser.msie ) {
 		elem.fireEvent("on"+type);
 	}
-}
+}
\ No newline at end of file
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/testsuite.css b/dom/tests/mochitest/ajax/jquery/test/data/testsuite.css
--- a/dom/tests/mochitest/ajax/jquery/test/data/testsuite.css
+++ b/dom/tests/mochitest/ajax/jquery/test/data/testsuite.css
@@ -7,6 +7,111 @@ h2 { padding: 10px; background-color: #e
 .fail { color: red; } 
 p.result { margin-left: 1em; }
 
 #banner { height: 2em; border-bottom: 1px solid white; }
 h2.pass { background-color: green; }
-h2.fail { background-color: red; }
\ No newline at end of file
+h2.fail { background-color: red; }
+
+ol#tests > li > strong { cursor:pointer; }
+
+div#fx-tests h4 {
+	background: red;
+}
+
+div#fx-tests h4.pass {
+	background: green;
+}
+
+div#fx-tests div.box {
+	background: red url(data/cow.jpg) no-repeat;
+	overflow: hidden;
+	border: 2px solid #000;
+}
+
+div#fx-tests div.overflow {
+	overflow: visible;
+}
+
+div.inline {
+	display: inline;
+}
+
+div.autoheight {
+	height: auto;
+}
+
+div.autowidth {
+	width: auto;
+}
+
+div.autoopacity {
+	opacity: auto;
+}
+
+div.largewidth {
+	width: 100px;
+}
+
+div.largeheight {
+	height: 100px;
+}
+
+div.largeopacity {
+	filter: progid:DXImageTransform.Microsoft.Alpha(opacity=100);
+}
+
+div.medwidth {
+	width: 50px;
+}
+
+div.medheight {
+	height: 50px;
+}
+
+div.medopacity {
+	opacity: 0.5;
+	filter: progid:DXImageTransform.Microsoft.Alpha(opacity=50);
+}
+
+div.nowidth {
+	width: 0px;
+}
+
+div.noheight {
+	height: 0px;
+}
+
+div.noopacity {
+	opacity: 0;
+	filter: progid:DXImageTransform.Microsoft.Alpha(opacity=0);
+}
+
+div.hidden {
+	display: none;
+}
+
+div#fx-tests div.widewidth {
+	background-repeat: repeat-x;
+}
+
+div#fx-tests div.wideheight {
+	background-repeat: repeat-y;
+}
+
+div#fx-tests div.widewidth.wideheight {
+	background-repeat: repeat;
+}
+
+div#fx-tests div.noback {
+	background-image: none;
+}
+
+div.chain, div.chain div { width: 100px; height: 20px; position: relative; float: left; }
+div.chain div { position: absolute; top: 0px; left: 0px; }
+
+div.chain.test { background: red; }
+div.chain.test div { background: green; }
+
+div.chain.out { background: green; }
+div.chain.out div { background: red; display: none; }
+
+div#show-tests * { display: none; }
\ No newline at end of file
diff --git a/dom/tests/mochitest/ajax/jquery/test/data/with_fries.xml b/dom/tests/mochitest/ajax/jquery/test/data/with_fries.xml
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/data/with_fries.xml
@@ -0,0 +1,25 @@
+<?xml version='1.0' encoding='UTF-8'?>
+<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"
+	xmlns:xsd="http://www.w3.org/2001/XMLSchema"
+	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
+	<soap:Body>
+		<jsconf xmlns="http://www.example.com/ns1">
+			<response xmlns:ab="http://www.example.com/ns2">
+				<meta>
+					<component id="seite1">
+						<properties xmlns:cd="http://www.example.com/ns3">
+							<property name="prop1">
+								<thing />
+								<value>1</value>
+							</property>
+							<property name="prop2">
+								<thing att="something" />
+							</property>
+							<foo_bar>foo</foo_bar>
+						</properties>
+					</component>
+				</meta>
+			</response>
+		</jsconf>
+	</soap:Body>
+</soap:Envelope>
diff --git a/dom/tests/mochitest/ajax/jquery/test/fix.html b/dom/tests/mochitest/ajax/jquery/test/fix.html
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/fix.html
@@ -0,0 +1,48 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
+    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+
+<html xmlns="http://www.w3.org/1999/xhtml">
+    <head>
+        <meta name="generator"
+        content="HTML Tidy, see www.w3.org" />
+
+        <title>Tester</title>
+<style type="text/css">
+      #container { background:yellow; width:400px; height:400px; }
+    
+</style>
+<script type="text/javascript" src="../dist/jquery.js">
+</script>
+<script type="text/javascript">
+      function doIt() {
+        $("#adiv").text("click!");
+        $("#adiv").trigger("acustom.atype");
+      }
+
+      function showMouse(e) {
+        $("#adiv").text("( " + e.pageX + ", " + e.pageY + " )");
+      }
+
+      $(function () {
+        $("#doit").bind('click.mine', doIt);
+        $("#container").mousemove(showMouse);
+        $("#adiv").bind("acustom.atype", function () {
+          //console.log("custom");
+        });
+      });
+    
+</script>
+    </head>
+
+    <body>
+        <button id="doit">Do It</button> 
+
+        <div id="container">
+            Hi
+        </div>
+
+        <div id="adiv">
+        </div>
+    </body>
+</html>
+
diff --git a/dom/tests/mochitest/ajax/jquery/test/index.html b/dom/tests/mochitest/ajax/jquery/test/index.html
--- a/dom/tests/mochitest/ajax/jquery/test/index.html
+++ b/dom/tests/mochitest/ajax/jquery/test/index.html
@@ -1,25 +1,34 @@
-<html id="html">
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr" id="html">
 <head>
-	<meta http-equiv="Content-Type" content="text/css; charset=utf-8" />
+	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
 	<title>jQuery Test Suite</title>
 	<link rel="Stylesheet" media="screen" href="data/testsuite.css" />
+	<script>var jQuery = "jQuery", $ = "$"; // For testing .noConflict()</script>
 	<script type="text/javascript" src="../dist/jquery.js"></script>
 	<script type="text/javascript" src="data/testrunner.js"></script>
-	<script type="text/javascript" src="../src/jquery/coreTest.js"></script>
-	<script type="text/javascript" src="../src/selector/selectorTest.js"></script>
-	<script type="text/javascript" src="../src/event/eventTest.js"></script>
-	<script type="text/javascript" src="../src/fx/fxTest.js"></script>
+	<script type="text/javascript" src="unit/core.js"></script>
+	<script type="text/javascript" src="unit/dimensions.js"></script>
+	<script type="text/javascript" src="unit/selector.js"></script>
+	<script type="text/javascript" src="unit/event.js"></script>
+	<script type="text/javascript" src="unit/ajax.js"></script>
+	<script type="text/javascript" src="unit/fx.js"></script>
 </head>
 
 <body id="body">
-	<h1>jQuery Test Suite</h1>
+	<h1 id="header">jQuery Test Suite</h1>
 	<h2 id="banner"></h2>
 	<h2 id="userAgent"></h2>
 	
 	<!-- Test HTML -->
-	<dl style="display:none;">
+	<div id="nothiddendiv" style="height:1px;background:white;">
+		<div id="nothiddendivchild"></div>
+	</div>
+	<!-- this iframe is outside the #main so it won't reload constantly wasting time, but it means the tests must be "safe" and clean up after themselves -->
+	<iframe id="loadediframe" name="loadediframe" style="display:none;" src="data/iframe.html"></iframe>
+	<dl id="dl" style="display:none;">
 	<div id="main" style="display: none;">
 		<p id="firstp">See <a id="simon1" href="http://simon.incutio.com/archive/2003/03/25/#getElementsBySelector" rel="bookmark">this blog entry</a> for more information.</p>
 		<p id="ap">
 			Here are some links in a normal paragraph: <a id="google" href="http://www.google.com/" title="Google!">Google</a>, 
 			<a id="groups" href="http://groups.google.com/">Google Groups</a>. 
@@ -35,41 +44,41 @@
 		</div>
 		<p id="first">Try them out:</p>
 		<ul id="firstUL"></ul>
 		<ol id="empty"></ol>
 		<form id="form" action="formaction">
-			<input type="text" name="action" value="Test" id="text1"/>
+			<input type="text" name="action" value="Test" id="text1" maxlength="30"/>
 			<input type="text" name="text2" value="Test" id="text2" disabled="disabled"/>
-			<input type="radio" name="radio1" id="radio1"/>
+			<input type="radio" name="radio1" id="radio1" value="on"/>
 
 			<input type="radio" name="radio2" id="radio2" checked="checked"/>
 			<input type="checkbox" name="check" id="check1" checked="checked"/>
-			<input type="checkbox" id="check2"/>
+			<input type="checkbox" id="check2" value="on"/>
 
 			<input type="hidden" name="hidden" id="hidden1"/>
 			<input type="text" style="display:none;" name="foo[bar]" id="hidden2"/>
 			
 			<input type="text" id="name" name="name" value="name" />
 			
 			<button id="button" name="button">Button</button>
 			
-			<textarea id="area1">foobar</textarea>
+			<textarea id="area1" maxlength="30">foobar</textarea>
 			
 			<select name="select1" id="select1">
-				<option id="option1a" value="">Nothing</option>
+				<option id="option1a" class="emptyopt" value="">Nothing</option>
 				<option id="option1b" value="1">1</option>
 				<option id="option1c" value="2">2</option>
 				<option id="option1d" value="3">3</option>
 			</select>
 			<select name="select2" id="select2">
-				<option id="option2a" value="">Nothing</option>
+				<option id="option2a" class="emptyopt" value="">Nothing</option>
 				<option id="option2b" value="1">1</option>
 				<option id="option2c" value="2">2</option>
 				<option id="option2d" selected="selected" value="3">3</option>
 			</select>
 			<select name="select3" id="select3" multiple="multiple">
-				<option id="option3a" value="">Nothing</option>
+				<option id="option3a" class="emptyopt" value="">Nothing</option>
 				<option id="option3b" selected="selected" value="1">1</option>
 				<option id="option3c" selected="selected" value="2">2</option>
 				<option id="option3d" value="3">3</option>
 			</select>
 			
@@ -88,14 +97,90 @@
 			<foo_bar id="foobar">test element</foo_bar>
 		</form>
 		<b id="floatTest">Float test.</b>
 		<iframe id="iframe" name="iframe"></iframe>
 		<form id="lengthtest">
-			<input type="text" id="length" name="test">
-			<input type="text" id="idTest" name="id">
+			<input type="text" id="length" name="test"/>
+			<input type="text" id="idTest" name="id"/>
 		</form>
 		<table id="table"></table>
+		
+		<div id="fx-queue">
+			<div id="fadein" class='chain test'>fadeIn<div>fadeIn</div></div>
+			<div id="fadeout" class='chain test out'>fadeOut<div>fadeOut</div></div>
+			
+			<div id="show" class='chain test'>show<div>show</div></div>
+			<div id="hide" class='chain test out'>hide<div>hide</div></div>
+			
+			<div id="togglein" class='chain test'>togglein<div>togglein</div></div>
+			<div id="toggleout" class='chain test out'>toggleout<div>toggleout</div></div>
+		
+			
+			<div id="slideup" class='chain test'>slideUp<div>slideUp</div></div>
+			<div id="slidedown" class='chain test out'>slideDown<div>slideDown</div></div>
+			
+			<div id="slidetogglein" class='chain test'>slideToggleIn<div>slideToggleIn</div></div>
+			<div id="slidetoggleout" class='chain test out'>slideToggleOut<div>slideToggleOut</div></div>
+		</div>
+		
+		<div id="fx-tests"></div>
+
+		<form id="testForm" action="#" method="get">
+			<textarea name="T3" rows="2" cols="15">?
+Z</textarea>
+			<input type="hidden" name="H1" value="x" />
+			<input type="hidden" name="H2" />
+			<input name="PWD" type="password" value="" />
+			<input name="T1" type="text" />
+			<input name="T2" type="text" value="YES" readonly="readonly" />
+			<input type="checkbox" name="C1" value="1" />
+			<input type="checkbox" name="C2" />
+			<input type="radio" name="R1" value="1" />
+			<input type="radio" name="R1" value="2" />
+			<input type="text" name="My Name" value="me" />
+			<input type="reset" name="reset" value="NO" />
+			<select name="S1">
+				<option value="abc">ABC</option>
+				<option value="abc">ABC</option>
+				<option value="abc">ABC</option>
+			</select>
+			<select name="S2" multiple="multiple" size="3">
+				<option value="abc">ABC</option>
+				<option value="abc">ABC</option>
+				<option value="abc">ABC</option>
+			</select>
+			<select name="S3">
+				<option selected="selected">YES</option>
+			</select>
+			<select name="S4">
+				<option value="" selected="selected">NO</option>
+			</select>
+			<input type="submit" name="sub1" value="NO" />
+			<input type="submit" name="sub2" value="NO" />
+			<input type="image" name="sub3" value="NO" />
+			<button name="sub4" type="submit" value="NO">NO</button>
+			<input name="D1" type="text" value="NO" disabled="disabled" />
+			<input type="checkbox" checked="checked" disabled="disabled" name="D2" value="NO" />
+			<input type="radio" name="D3" value="NO" checked="checked" disabled="disabled" />
+			<select name="D4" disabled="disabled">
+				<option selected="selected" value="NO">NO</option>
+			</select>
+		</form>
+		<div id="moretests">
+			<form>
+				<div id="checkedtest" style="display:none;">
+					<input type="radio" name="checkedtestradios" checked="checked"/>
+					<input type="radio" name="checkedtestradios" value="on"/>
+					<input type="checkbox" name="checkedtestcheckboxes" checked="checked"/>
+					<input type="checkbox" name="checkedtestcheckboxes" />
+				</div>
+			</form>
+			<div id="nonnodes"><span>hi</span> there <!-- mon ami --></div>
+			<div id="t2037">
+				<div><div class="hidden">hidden</div></div>
+			</div>
+		</div>
 	</div>
 	</dl>
 	
 	<ol id="tests"></ol>
 </body>
diff --git a/dom/tests/mochitest/ajax/jquery/test/offset.html b/dom/tests/mochitest/ajax/jquery/test/offset.html
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/offset.html
@@ -0,0 +1,27 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr" id="html">
+<head>
+	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
+	<title>jQuery Offset Test Suite</title>
+	<link rel="Stylesheet" media="screen" href="data/testsuite.css" />
+	<script type="text/javascript" src="../dist/jquery.js"></script>
+	<script type="text/javascript" src="data/testrunner.js"></script>
+	<script type="text/javascript" src="unit/offset.js"></script>
+</head>
+
+<body id="body">
+	<h1 id="header">jQuery Offset Test Suite</h1>
+	<h2 id="banner"></h2>
+	<h2 id="userAgent"></h2>
+	
+	<!-- Test HTML -->
+	<div id="nothiddendiv" style="height:1px;background:white;"></div>
+	<dl id="dl" style="display:none;">
+	<div id="main" style="display: none;">
+		
+	</div>
+	</dl>
+	
+	<ol id="tests"></ol>
+</body>
+</html>
diff --git a/dom/tests/mochitest/ajax/jquery/test/test.js b/dom/tests/mochitest/ajax/jquery/test/test.js
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/test.js
@@ -0,0 +1,41 @@
+load( "build/js/writeFile.js", "build/js/parse.js" );
+
+function addParams(name, params) {
+	if(params.length > 0) {
+		name += "(";
+		for ( var i = 0; i < params.length; i++) {
+			name += params[i].type + ", ";
+		}
+		return name.substring(0, name.length - 2) + ")";
+	} else {
+		return name + "()";
+	}
+}
+function addTestWrapper(name, test) {
+	return 'test("' + name + '", function() {\n' + test + '\n});';
+}
+
+var dir = arguments[1];
+var jq = parse( read(arguments[0]) );
+
+var testFile = [];
+
+String.prototype.decode = function() {
+	return this.replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&amp;/g, "&");
+};
+
+for ( var i = 0; i < jq.length; i++ ) {
+	if ( jq[i].tests.length > 0 ) {
+		var method = jq[i];
+		var name = addParams(method.name, method.params);
+		for(var j = 0; j < method.tests.length; j++) {
+			if(j > 0) {
+				name += "x";
+			}
+			testFile[testFile.length] = addTestWrapper(name, method.tests[j].decode()) + "\n";
+		}
+	}
+}
+
+var indexFile = readFile( "build/test/index.html" );
+writeFile( dir + "/index.html", indexFile.replace( /{TESTS}/g, testFile.join("\n") ) );
diff --git a/dom/tests/mochitest/ajax/jquery/test/unit/Makefile.in b/dom/tests/mochitest/ajax/jquery/test/unit/Makefile.in
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/unit/Makefile.in
@@ -0,0 +1,62 @@
+#
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is mozilla.org code.
+#
+# The Initial Developer of the Original Code is
+# Mozilla Foundation.
+# Portions created by the Initial Developer are Copyright (C) 2007
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either of the GNU General Public License Version 2 or later (the "GPL"),
+# or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+DEPTH		= ../../../../../../..
+topsrcdir	= @top_srcdir@
+srcdir		= @srcdir@
+VPATH		= @srcdir@
+relativesrcdir	= dom/tests/mochitest/ajax/jquery/test/unit
+
+include $(DEPTH)/config/autoconf.mk
+
+DIRS	= \
+	$(NULL)
+
+include $(topsrcdir)/config/rules.mk
+
+_TEST_FILES	= \
+	ajax.js \
+	core.js \
+	dimensions.js \
+	event.js \
+	fx.js \
+	offset.js \
+	selector.js \
+	$(NULL)
+
+libs::	$(_TEST_FILES)
+	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
diff --git a/dom/tests/mochitest/ajax/jquery/test/unit/ajax.js b/dom/tests/mochitest/ajax/jquery/test/unit/ajax.js
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/unit/ajax.js
@@ -0,0 +1,837 @@
+module("ajax");
+
+// Safari 3 randomly crashes when running these tests,
+// but only in the full suite - you can run just the Ajax
+// tests and they'll pass
+//if ( !jQuery.browser.safari ) {
+
+if ( !isLocal ) {
+
+test("$.ajax() - success callbacks", function() {
+	expect( 8 );
+	
+	$.ajaxSetup({ timeout: 0 });
+	
+	stop();
+	
+	setTimeout(function(){	
+        $('#foo').ajaxStart(function(){
+            ok( true, "ajaxStart" );
+        }).ajaxStop(function(){
+            ok( true, "ajaxStop" );
+            start();
+        }).ajaxSend(function(){
+            ok( true, "ajaxSend" );
+        }).ajaxComplete(function(){
+            ok( true, "ajaxComplete" );
+        }).ajaxError(function(){
+            ok( false, "ajaxError" );
+        }).ajaxSuccess(function(){
+            ok( true, "ajaxSuccess" );
+        });
+        
+        $.ajax({
+            url: url("data/name.html"),
+            beforeSend: function(){ ok(true, "beforeSend"); },
+            success: function(){ ok(true, "success"); },
+            error: function(){ ok(false, "error"); },
+            complete: function(){ ok(true, "complete"); }
+        });
+    }, 13);
+});
+
+/* mozilla: the ajaxSuccess part fails intermittently on MacOSX
+
+test("$.ajax() - error callbacks", function() {
+    expect( 7 );
+    stop();
+    
+    $('#foo').ajaxStart(function(){
+        ok( true, "ajaxStart" );
+    }).ajaxStop(function(){
+        ok( true, "ajaxStop" );
+        start();
+    }).ajaxSend(function(){
+        ok( true, "ajaxSend" );
+    }).ajaxComplete(function(){
+        ok( true, "ajaxComplete" );
+    }).ajaxError(function(){
+        ok( true, "ajaxError" );
+    }).ajaxSuccess(function(){
+        ok( false, "ajaxSuccess" );
+    })
+	;
+    
+    $.ajaxSetup({ timeout: 500 });
+    
+    $.ajax({
+        url: url("data/name.php?wait=5"),
+        beforeSend: function(){ ok(true, "beforeSend"); },
+        success: function(){ ok(false, "success"); },
+        error: function(){ ok(true, "error"); },
+        complete: function(){ ok(true, "complete"); }
+    });
+});
+
+*/
+
+test("$.ajax() - disabled globals", function() {
+	expect( 3 );
+	stop();
+	
+	$('#foo').ajaxStart(function(){
+		ok( false, "ajaxStart" );
+	}).ajaxStop(function(){
+		ok( false, "ajaxStop" );
+	}).ajaxSend(function(){
+		ok( false, "ajaxSend" );
+	}).ajaxComplete(function(){
+		ok( false, "ajaxComplete" );
+	}).ajaxError(function(){
+		ok( false, "ajaxError" );
+	}).ajaxSuccess(function(){
+		ok( false, "ajaxSuccess" );
+	});
+	
+	$.ajax({
+		global: false,
+		url: url("data/name.html"),
+		beforeSend: function(){ ok(true, "beforeSend"); },
+		success: function(){ ok(true, "success"); },
+		error: function(){ ok(false, "error"); },
+		complete: function(){
+		  ok(true, "complete");
+		  setTimeout(function(){ start(); }, 13);
+        }
+	});
+});
+
+test("$.ajax - xml: non-namespace elements inside namespaced elements", function() {
+	expect(3);
+	stop();
+	$.ajax({
+	  url: url("data/with_fries.xml"),
+	  dataType: "xml",
+	  success: function(resp) {
+	    equals( $("properties", resp).length, 1, 'properties in responseXML' );
+	    equals( $("jsconf", resp).length, 1, 'jsconf in responseXML' );
+	    equals( $("thing", resp).length, 2, 'things in responseXML' );
+	    start();
+	  }
+	});
+});
+
+test("$.ajax - beforeSend", function() {
+	expect(1);
+	stop();
+	
+	var check = false;
+	
+	$.ajaxSetup({ timeout: 0 });
+	
+	$.ajax({
+		url: url("data/name.html"), 
+		beforeSend: function(xml) {
+			check = true;
+		},
+		success: function(data) {
+			ok( check, "check beforeSend was executed" );
+			start();
+		}
+	});
+});
+
+test("$.ajax - beforeSend, cancel request (#2688)", function() {
+	expect(2);
+	var request = $.ajax({
+		url: url("data/name.html"), 
+		beforeSend: function() {
+			ok( true, "beforeSend got called, canceling" );
+			return false;
+		},
+		success: function() {
+			ok( false, "request didn't get canceled" );
+		},
+		complete: function() {
+			ok( false, "request didn't get canceled" );
+		},
+		error: function() {
+			ok( false, "request didn't get canceled" );
+		}
+	});
+	ok( request === false, "canceled request must return false instead of XMLHttpRequest instance" );
+});
+
+var foobar;
+
+test("$.ajax - dataType html", function() {
+	expect(5);
+	stop();
+	
+	foobar = null;
+	testFoo = undefined;
+
+	var verifyEvaluation = function() {
+	  equals( testFoo, "foo", 'Check if script was evaluated for datatype html' );
+	  equals( foobar, "bar", 'Check if script src was evaluated for datatype html' );
+	  start();
+	};
+
+	$.ajax({
+	  dataType: "html",
+	  url: url("data/test.html"),
+	  success: function(data) {
+	  	$("#ap").html(data);
+	    ok( data.match(/^html text/), 'Check content for datatype html' );
+	    setTimeout(verifyEvaluation, 600);
+	  }
+	});
+});
+
+test("serialize()", function() {
+	expect(6);
+	
+	equals( $('#form').serialize(),
+		"action=Test&radio2=on&check=on&hidden=&foo%5Bbar%5D=&name=name&select1=&select2=3&select3=1&select3=2",
+		'Check form serialization as query string');
+		
+	equals( $('#form :input').serialize(),
+		"action=Test&radio2=on&check=on&hidden=&foo%5Bbar%5D=&name=name&select1=&select2=3&select3=1&select3=2",
+		'Check input serialization as query string');
+	
+	equals( $('#testForm').serialize(), 
+		'T3=%3F%0AZ&H1=x&H2=&PWD=&T1=&T2=YES&My+Name=me&S1=abc&S3=YES&S4=', 
+		'Check form serialization as query string');
+		
+	equals( $('#testForm :input').serialize(), 
+		'T3=%3F%0AZ&H1=x&H2=&PWD=&T1=&T2=YES&My+Name=me&S1=abc&S3=YES&S4=', 
+		'Check input serialization as query string');
+		
+	equals( $('#form, #testForm').serialize(),
+		"action=Test&radio2=on&check=on&hidden=&foo%5Bbar%5D=&name=name&select1=&select2=3&select3=1&select3=2&T3=%3F%0AZ&H1=x&H2=&PWD=&T1=&T2=YES&My+Name=me&S1=abc&S3=YES&S4=",
+		'Multiple form serialization as query string');
+		
+	equals( $('#form, #testForm :input').serialize(),
+		"action=Test&radio2=on&check=on&hidden=&foo%5Bbar%5D=&name=name&select1=&select2=3&select3=1&select3=2&T3=%3F%0AZ&H1=x&H2=&PWD=&T1=&T2=YES&My+Name=me&S1=abc&S3=YES&S4=",
+		'Mixed form/input serialization as query string');
+});
+
+test("$.param()", function() {
+	expect(4);
+	var params = {foo:"bar", baz:42, quux:"All your base are belong to us"};
+	equals( $.param(params), "foo=bar&baz=42&quux=All+your+base+are+belong+to+us", "simple" );
+	
+	params = {someName: [1, 2, 3], regularThing: "blah" };
+	equals( $.param(params), "someName=1&someName=2&someName=3&regularThing=blah", "with array" );
+	
+	params = {"foo[]":["baz", 42, "All your base are belong to us"]};
+	equals( $.param(params), "foo%5B%5D=baz&foo%5B%5D=42&foo%5B%5D=All+your+base+are+belong+to+us", "more array" );
+	
+	params = {"foo[bar]":"baz", "foo[beep]":42, "foo[quux]":"All your base are belong to us"};
+	equals( $.param(params), "foo%5Bbar%5D=baz&foo%5Bbeep%5D=42&foo%5Bquux%5D=All+your+base+are+belong+to+us", "even more arrays" );
+});
+
+test("synchronous request", function() {
+	expect(1);
+	ok( /^{ "data"/.test( $.ajax({url: url("data/json_obj.js"), async: false}).responseText ), "check returned text" );
+});
+
+test("synchronous request with callbacks", function() {
+	expect(2);
+	var result;
+	$.ajax({url: url("data/json_obj.js"), async: false, success: function(data) { ok(true, "sucess callback executed"); result = data; } });
+	ok( /^{ "data"/.test( result ), "check returned text" );
+});
+
+test("pass-through request object", function() {
+	expect(8);
+	stop(true);
+	
+	var target = "data/name.html";
+	var successCount = 0;
+	var errorCount = 0;
+  var errorEx = "";
+	var success = function() {
+		successCount++;
+	};
+	$("#foo").ajaxError(function (e, xml, s, ex) {
+		errorCount++;
+    errorEx += ": " + xml.status;
+	});
+	$("#foo").one('ajaxStop', function () {
+		equals(successCount, 5, "Check all ajax calls successful");
+		equals(errorCount, 0, "Check no ajax errors (status" + errorEx + ")");
+		$("#foo").unbind('ajaxError');
+		start();
+	});
+	
+	ok( $.get(url(target), success), "get" );
+	ok( $.post(url(target), success), "post" );
+	ok( $.getScript(url("data/test.js"), success), "script" );
+	ok( $.getJSON(url("data/json_obj.js"), success), "json" );
+	ok( $.ajax({url: url(target), success: success}), "generic" );
+});
+
+/* mozilla: php not currently supported in mochitest (08/08/2008)
+test("ajax cache", function () {
+	expect(18);
+	stop();
+	
+	var count = 0;
+
+	$("#firstp").bind("ajaxSuccess", function (e, xml, s) {
+		var re = /_=(.*?)(&|$)/g;
+    var oldOne = null;
+		for (var i = 0; i < 6; i++) {
+      var ret = re.exec(s.url);
+			if (!ret) {
+				break;
+			}
+      oldOne = ret[1];
+		}
+		equals(i, 1, "Test to make sure only one 'no-cache' parameter is there");
+		ok(oldOne != "tobereplaced555", "Test to be sure parameter (if it was there) was replaced");
+		if(++count == 6)
+			start();
+	});
+
+	ok( $.ajax({url: "data/text.php", cache:false}), "test with no parameters" );
+	ok( $.ajax({url: "data/text.php?pizza=true", cache:false}), "test with 1 parameter" );
+	ok( $.ajax({url: "data/text.php?_=tobereplaced555", cache:false}), "test with _= parameter" );
+	ok( $.ajax({url: "data/text.php?pizza=true&_=tobereplaced555", cache:false}), "test with 1 parameter plus _= one" );
+	ok( $.ajax({url: "data/text.php?_=tobereplaced555&tv=false", cache:false}), "test with 1 parameter plus _= one before it" );
+	ok( $.ajax({url: "data/text.php?name=David&_=tobereplaced555&washere=true", cache:false}), "test with 2 parameters surrounding _= one" );
+}); 
+*/
+
+test("global ajaxSettings", function() {
+	expect(2);
+
+	var tmp = jQuery.extend({}, jQuery.ajaxSettings);
+    var orig = { url: "data/with_fries.xml" };
+	var t;
+
+	$.ajaxSetup({ data: {foo: 'bar', bar: 'BAR'} });
+
+    t = jQuery.extend({}, orig);
+	t.data = {};
+    $.ajax(t);
+	ok( t.url.indexOf('foo') > -1 && t.url.indexOf('bar') > -1, "Check extending {}" );
+
+    t = jQuery.extend({}, orig);
+	t.data = { zoo: 'a', ping: 'b' };
+    $.ajax(t);
+	ok( t.url.indexOf('ping') > -1 && t.url.indexOf('zoo') > -1 && t.url.indexOf('foo') > -1 && t.url.indexOf('bar') > -1, "Check extending { zoo: 'a', ping: 'b' }" );
+	
+	jQuery.ajaxSettings = tmp;
+});
+
+test("load(String)", function() {
+	expect(1);
+	stop(true); // check if load can be called with only url
+	$('#first').load("data/name.html", start);
+});
+
+test("load('url selector')", function() {
+	expect(1);
+	stop(true); // check if load can be called with only url
+	$('#first').load("data/test3.html div.user", function(){
+		equals( $(this).children("div").length, 2, "Verify that specific elements were injected" );
+		start();
+	});
+});
+
+test("load(String, Function) with ajaxSetup on dataType json, see #2046", function() {
+	expect(1);
+	stop();
+	$.ajaxSetup({ dataType: "json" });
+	$("#first").ajaxComplete(function (e, xml, s) {
+		equals( s.dataType, "html", "Verify the load() dataType was html" );
+		$("#first").unbind("ajaxComplete");
+		$.ajaxSetup({ dataType: "" });
+		start();
+	});
+	$('#first').load("data/test3.html");
+});
+
+test("load(String, Function) - simple: inject text into DOM", function() {
+	expect(2);
+	stop();
+	$('#first').load(url("data/name.html"), function() {
+		ok( /^ERROR/.test($('#first').text()), 'Check if content was injected into the DOM' );
+		start();
+	});
+});
+
+test("load(String, Function) - check scripts", function() {
+	expect(7);
+	stop();
+	window.testFoo = undefined;
+	window.foobar = null;
+	var verifyEvaluation = function() {
+		equals( foobar, "bar", 'Check if script src was evaluated after load' );
+		equals( $('#ap').html(), 'bar', 'Check if script evaluation has modified DOM');
+		 start();
+	};
+	$('#first').load(url('data/test.html'), function() {
+		ok( $('#first').html().match(/^html text/), 'Check content after loading html' );
+		equals( $('#foo').html(), 'foo', 'Check if script evaluation has modified DOM');
+		equals( testFoo, "foo", 'Check if script was evaluated after load' );
+		setTimeout(verifyEvaluation, 600);
+	});
+});
+
+test("load(String, Function) - check file with only a script tag", function() {
+	expect(3);
+	stop();
+	testFoo = undefined;
+	$('#first').load(url('data/test2.html'), function() {
+		equals( $('#foo').html(), 'foo', 'Check if script evaluation has modified DOM');
+		equals( testFoo, "foo", 'Check if script was evaluated after load' );
+		start();
+	});
+});
+
+test("$.get(String, Hash, Function) - parse xml and use text() on nodes", function() {
+	expect(2);
+	stop();
+	$.get(url('data/dashboard.xml'), function(xml) {
+		var content = [];
+		$('tab', xml).each(function() {
+			content.push($(this).text());
+		});
+		equals( content[0], 'blabla', 'Check first tab');
+		equals( content[1], 'blublu', 'Check second tab');
+		start();
+	});
+});
+
+test("$.getScript(String, Function) - with callback", function() {
+	expect(2);
+	stop();
+	window.foobar = null;
+	$.getScript(url("data/test.js"), function() {
+		equals( foobar, "bar", 'Check if script was evaluated' );
+		setTimeout(start, 100);
+	});
+});
+
+test("$.getScript(String, Function) - no callback", function() {
+	expect(1);
+	stop(true);
+	$.getScript(url("data/test.js"), start);
+});
+
+/* mozilla: Tests using php scripts not currently supported (06/26/2008)
+
+test("$.ajax() - JSONP, Local", function() {
+	expect(7);
+
+	var count = 0;
+	function plus(){ if ( ++count == 7 ) start(); }
+
+	stop();
+
+	$.ajax({
+		url: "data/jsonp.php",
+		dataType: "jsonp",
+		success: function(data){
+			ok( data.data, "JSON results returned (GET, no callback)" );
+			plus();
+		},
+		error: function(data){
+			ok( false, "Ajax error JSON (GET, no callback)" );
+			plus();
+		}
+	});
+
+	$.ajax({
+		url: "data/jsonp.php?callback=?",
+		dataType: "jsonp",
+		success: function(data){
+			ok( data.data, "JSON results returned (GET, url callback)" );
+			plus();
+		},
+		error: function(data){
+			ok( false, "Ajax error JSON (GET, url callback)" );
+			plus();
+		}
+	});
+
+	$.ajax({
+		url: "data/jsonp.php",
+		dataType: "jsonp",
+		data: "callback=?",
+		success: function(data){
+			ok( data.data, "JSON results returned (GET, data callback)" );
+			plus();
+		},
+		error: function(data){
+			ok( false, "Ajax error JSON (GET, data callback)" );
+			plus();
+		}
+	});
+
+	$.ajax({
+		url: "data/jsonp.php",
+		dataType: "jsonp",
+		jsonp: "callback",
+		success: function(data){
+			ok( data.data, "JSON results returned (GET, data obj callback)" );
+			plus();
+		},
+		error: function(data){
+			ok( false, "Ajax error JSON (GET, data obj callback)" );
+			plus();
+		}
+	});
+
+	$.ajax({
+		type: "POST",
+		url: "data/jsonp.php",
+		dataType: "jsonp",
+		success: function(data){
+			ok( data.data, "JSON results returned (POST, no callback)" );
+			plus();
+		},
+		error: function(data){
+			ok( false, "Ajax error JSON (GET, data obj callback)" );
+			plus();
+		}
+	});
+
+	$.ajax({
+		type: "POST",
+		url: "data/jsonp.php",
+		data: "callback=?",
+		dataType: "jsonp",
+		success: function(data){
+			ok( data.data, "JSON results returned (POST, data callback)" );
+			plus();
+		},
+		error: function(data){
+			ok( false, "Ajax error JSON (POST, data callback)" );
+			plus();
+		}
+	});
+
+	$.ajax({
+		type: "POST",
+		url: "data/jsonp.php",
+		jsonp: "callback",
+		dataType: "jsonp",
+		success: function(data){
+			ok( data.data, "JSON results returned (POST, data obj callback)" );
+			plus();
+		},
+		error: function(data){
+			ok( false, "Ajax error JSON (POST, data obj callback)" );
+			plus();
+		}
+	});
+});
+
+test("$.ajax() - JSONP, Remote", function() {
+	expect(4);
+
+	var count = 0;
+	function plus(){ if ( ++count == 4 ) start(); }
+
+	var base = window.location.href.replace(/\?.*$/, "");
+
+	stop();
+
+	$.ajax({
+		url: base + "data/jsonp.php",
+		dataType: "jsonp",
+		success: function(data){
+			ok( data.data, "JSON results returned (GET, no callback)" );
+			plus();
+		},
+		error: function(data){
+			ok( false, "Ajax error JSON (GET, no callback)" );
+			plus();
+		}
+	});
+
+	$.ajax({
+		url: base + "data/jsonp.php?callback=?",
+		dataType: "jsonp",
+		success: function(data){
+			ok( data.data, "JSON results returned (GET, url callback)" );
+			plus();
+		},
+		error: function(data){
+			ok( false, "Ajax error JSON (GET, url callback)" );
+			plus();
+		}
+	});
+
+	$.ajax({
+		url: base + "data/jsonp.php",
+		dataType: "jsonp",
+		data: "callback=?",
+		success: function(data){
+			ok( data.data, "JSON results returned (GET, data callback)" );
+			plus();
+		},
+		error: function(data){
+			ok( false, "Ajax error JSON (GET, data callback)" );
+			plus();
+		}
+	});
+
+	$.ajax({
+		url: base + "data/jsonp.php",
+		dataType: "jsonp",
+		jsonp: "callback",
+		success: function(data){
+			ok( data.data, "JSON results returned (GET, data obj callback)" );
+			plus();
+		},
+		error: function(data){
+			ok( false, "Ajax error JSON (GET, data obj callback)" );
+			plus();
+		}
+	});
+});
+
+test("$.ajax() - script, Remote", function() {
+	expect(2);
+
+	var base = window.location.href.replace(/\?.*$/, "");
+
+	stop();
+
+	window.foobar = null;
+	$.ajax({
+		url: base + "data/test.js",
+		dataType: "script",
+		success: function(data){
+			ok( foobar, "Script results returned (GET, no callback)" );
+			start();
+		}
+	});
+});
+
+test("$.ajax() - script, Remote with POST", function() {
+	expect(3);
+
+	var base = window.location.href.replace(/\?.*$/, "");
+
+	stop();
+
+	window.foobar = null;
+	$.ajax({
+		url: base + "data/test.js",
+		type: "POST",
+		dataType: "script",
+		success: function(data, status){
+			ok( foobar, "Script results returned (GET, no callback)" );
+			equals( status, "success", "Script results returned (GET, no callback)" );
+			start();
+		}
+	});
+});
+
+test("$.ajax() - script, Remote with scheme-less URL", function() {
+	expect(2);
+
+	var base = window.location.href.replace(/\?.*$/, "");
+	base = base.replace(/^.*?\/\//, "//");
+
+	stop();
+
+	window.foobar = null;
+	$.ajax({
+		url: base + "data/test.js",
+		dataType: "script",
+		success: function(data){
+			ok( foobar, "Script results returned (GET, no callback)" );
+			start();
+		}
+	});
+});
+
+test("$.getJSON(String, Hash, Function) - JSON array", function() {
+	expect(4);
+	stop();
+	$.getJSON(url("data/json.php"), {json: "array"}, function(json) {
+	  equals( json[0].name, 'John', 'Check JSON: first, name' );
+	  equals( json[0].age, 21, 'Check JSON: first, age' );
+	  equals( json[1].name, 'Peter', 'Check JSON: second, name' );
+	  equals( json[1].age, 25, 'Check JSON: second, age' );
+	  start();
+	});
+});
+
+test("$.getJSON(String, Function) - JSON object", function() {
+	expect(2);
+	stop();
+	$.getJSON(url("data/json.php"), function(json) {
+	  equals( json.data.lang, 'en', 'Check JSON: lang' );
+	  equals( json.data.length, 25, 'Check JSON: length' );
+	  start();
+	});
+});
+
+test("$.getJSON(String, Function) - JSON object with absolute url to local content", function() {
+	expect(2);
+
+	var base = window.location.href.replace(/\?.*$/, "");
+
+	stop();
+	$.getJSON(url(base + "data/json.php"), function(json) {
+	  equals( json.data.lang, 'en', 'Check JSON: lang' );
+	  equals( json.data.length, 25, 'Check JSON: length' );
+	  start();
+	});
+});
+
+test("$.post(String, Hash, Function) - simple with xml", function() {
+	expect(4);
+	stop();
+	$.post(url("data/name.php"), {xml: "5-2"}, function(xml){
+	  $('math', xml).each(function() {
+		    equals( $('calculation', this).text(), '5-2', 'Check for XML' );
+		    equals( $('result', this).text(), '3', 'Check for XML' );
+		 });
+	});
+
+	$.post(url("data/name.php?xml=5-2"), {}, function(xml){
+	  $('math', xml).each(function() {
+		    equals( $('calculation', this).text(), '5-2', 'Check for XML' );
+		    equals( $('result', this).text(), '3', 'Check for XML' );
+		 });
+	  start();
+	});
+});
+
+test("$.ajaxSetup({timeout: Number}) - with global timeout", function() {
+	stop();
+	
+	var passed = 0;
+
+	$.ajaxSetup({timeout: 1000});
+	
+	var pass = function() {
+		passed++;
+		if ( passed == 2 ) {
+			ok( true, 'Check local and global callbacks after timeout' );
+	     	$('#main').unbind("ajaxError");
+			start();
+		}
+	};
+	
+	var fail = function(a,b,c) {
+		ok( false, 'Check for timeout failed ' + a + ' ' + b );
+		start();
+	};
+	
+	$('#main').ajaxError(pass);
+	
+	$.ajax({
+	  type: "GET",
+	  url: url("data/name.php?wait=5"),
+	  error: pass,
+	  success: fail
+	});
+	
+	// reset timeout
+	$.ajaxSetup({timeout: 0});
+});
+
+test("$.ajaxSetup({timeout: Number}) with localtimeout", function() {
+	stop();
+	$.ajaxSetup({timeout: 50});
+
+	$.ajax({
+	  type: "GET",
+	  timeout: 5000,
+	  url: url("data/name.php?wait=1"),
+	  error: function() {
+		   ok( false, 'Check for local timeout failed' );
+		   start();
+	  },
+	  success: function() {
+	    ok( true, 'Check for local timeout' );
+	    start();
+	  }
+	});
+
+	// reset timeout
+	$.ajaxSetup({timeout: 0});
+});
+
+test("$.ajax - simple get", function() {
+	expect(1);
+	stop();
+	$.ajax({
+	  type: "GET",
+	  url: url("data/name.php?name=foo"),
+	  success: function(msg){
+	    equals( msg, 'bar', 'Check for GET' );
+	    start();
+	  }
+	});
+});
+
+test("$.ajax - simple post", function() {
+	expect(1);
+	stop();
+	$.ajax({
+	  type: "POST",
+	  url: url("data/name.php"),
+	  data: "name=peter",
+	  success: function(msg){
+	    equals( msg, 'pan', 'Check for POST' );
+	    start();
+	  }
+	});
+});
+
+test("ajaxSetup()", function() {
+	expect(1);
+	stop();
+	$.ajaxSetup({
+		url: url("data/name.php?name=foo"),
+		success: function(msg){
+	    	equals( msg, 'bar', 'Check for GET' );
+			start();
+		}
+	});
+	$.ajax();
+});
+
+test("custom timeout does not set error message when timeout occurs, see #970", function() {
+	stop();
+	$.ajax({
+		url: "data/name.php?wait=10",
+		timeout: 500,
+		error: function(request, status) {
+			ok( status != null, "status shouldn't be null in error handler" );
+			equals( "timeout", status );
+			start();
+		}
+	});
+});
+
+test("data option: evaluate function values (#2806)", function() {
+	stop();
+	$.ajax({
+		url: "data/echoQuery.php",
+		data: {
+			key: function() {
+				return "value";
+			}
+		},
+		success: function(result) {
+			equals( result, "key=value" );
+			start();
+		}
+	})
+});
+*/
+}
+
+//}
diff --git a/dom/tests/mochitest/ajax/jquery/test/unit/core.js b/dom/tests/mochitest/ajax/jquery/test/unit/core.js
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/unit/core.js
@@ -0,0 +1,1693 @@
+module("core");
+
+test("Basic requirements", function() {
+	expect(7);
+	ok( Array.prototype.push, "Array.push()" );
+	ok( Function.prototype.apply, "Function.apply()" );
+	ok( document.getElementById, "getElementById" );
+	ok( document.getElementsByTagName, "getElementsByTagName" );
+	ok( RegExp, "RegExp" );
+	ok( jQuery, "jQuery" );
+	ok( $, "$()" );
+});
+
+test("$()", function() {
+	expect(8);
+
+	var main = $("#main");
+	isSet( $("div p", main).get(), q("sndp", "en", "sap"), "Basic selector with jQuery object as context" );
+
+/*
+	// disabled since this test was doing nothing. i tried to fix it but i'm not sure
+	// what the expected behavior should even be. FF returns "\n" for the text node
+	// make sure this is handled
+	var crlfContainer = $('<p>\r\n</p>');
+	var x = crlfContainer.contents().get(0).nodeValue;
+	equals( x, what???, "Check for \\r and \\n in jQuery()" );
+*/
+
+	/* // Disabled until we add this functionality in
+	var pass = true;
+	try {
+		$("<div>Testing</div>").appendTo(document.getElementById("iframe").contentDocument.body);
+	} catch(e){
+		pass = false;
+	}
+	ok( pass, "$('&lt;tag&gt;') needs optional document parameter to ease cross-frame DOM wrangling, see #968" );*/
+
+	var code = $("<code/>");
+	equals( code.length, 1, "Correct number of elements generated for code" );
+	var img = $("<img/>");
+	equals( img.length, 1, "Correct number of elements generated for img" );
+	var div = $("<div/><hr/><code/><b/>");
+	equals( div.length, 4, "Correct number of elements generated for div hr code b" );
+
+	// can actually yield more than one, when iframes are included, the window is an array as well
+	equals( $(window).length, 1, "Correct number of elements generated for window" );
+
+	equals( $(document).length, 1, "Correct number of elements generated for document" );
+
+	equals( $([1,2,3]).get(1), 2, "Test passing an array to the factory" );
+
+	equals( $(document.body).get(0), $('body').get(0), "Test passing an html node to the factory" );
+});
+
+test("browser", function() {
+	expect(13);
+	var browsers = {
+		//Internet Explorer
+		"Mozilla/5.0 (Windows; U; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727)": "6.0",
+		"Mozilla/4.0 (compatible; MSIE 7.0b; Windows NT 5.1; .NET CLR 1.1.4322; InfoPath.1; .NET CLR 2.0.50727)": "7.0",
+		/** Failing #1876
+		 * "Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1) ; .NET CLR 2.0.50727; .NET CLR 1.1.4322; .NET CLR 3.0.04506.30)": "7.0",
+		 */
+		//Browsers with Gecko engine
+		//Mozilla
+		"Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.12) Gecko/20050915" : "1.7.12",
+		//Firefox
+		"Mozilla/5.0 (Macintosh; U; Intel Mac OS X; en-US; rv:1.8.1.3) Gecko/20070309 Firefox/2.0.0.3": "1.8.1.3",
+		//Netscape
+		"Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20070321 Netscape/8.1.3" : "1.7.5",
+		//Flock
+		"Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.11) Gecko/20070321 Firefox/1.5.0.11 Flock/0.7.12" : "1.8.0.11",
+		//Opera browser
+		"Opera/9.20 (X11; Linux x86_64; U; en)": "9.20",
+		"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; en) Opera 9.20" : "9.20",
+		"Mozilla/5.0 (Windows NT 5.1; U; pl; rv:1.8.0) Gecko/20060728 Firefox/1.5.0 Opera 9.20": "9.20",
+		//WebKit engine
+		"Mozilla/5.0 (Macintosh; U; PPC Mac OS X; sv-se) AppleWebKit/418.9 (KHTML, like Gecko) Safari/419.3": "418.9",
+		"Mozilla/5.0 (Macintosh; U; PPC Mac OS X; en) AppleWebKit/418.8 (KHTML, like Gecko) Safari/419.3" : "418.8",
+		"Mozilla/5.0 (Macintosh; U; PPC Mac OS X; sv-se) AppleWebKit/312.8 (KHTML, like Gecko) Safari/312.5": "312.8",
+		//Other user agent string
+		"Other browser's user agent 1.0":null
+	};
+	for (var i in browsers) {
+		var v = i.toLowerCase().match( /.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/ ); // RegEx from Core jQuery.browser.version check
+		version = v ? v[1] : null;
+		equals( version, browsers[i], "Checking UA string" );
+	}
+});
+
+test("noConflict", function() {
+	expect(6);
+
+	var old = jQuery;
+	var newjQuery = jQuery.noConflict();
+
+	equals( newjQuery, old, "noConflict returned the jQuery object" );
+	equals( jQuery, old, "Make sure jQuery wasn't touched." );
+	equals( $, "$", "Make sure $ was reverted." );
+
+	jQuery = $ = old;
+
+	newjQuery = jQuery.noConflict(true);
+
+	equals( newjQuery, old, "noConflict returned the jQuery object" );
+	equals( jQuery, "jQuery", "Make sure jQuery was reverted." );
+	equals( $, "$", "Make sure $ was reverted." );
+
+	jQuery = $ = old;
+});
+
+test("isFunction", function() {
+	expect(21);
+
+	// Make sure that false values return false
+	ok( !jQuery.isFunction(), "No Value" );
+	ok( !jQuery.isFunction( null ), "null Value" );
+	ok( !jQuery.isFunction( undefined ), "undefined Value" );
+	ok( !jQuery.isFunction( "" ), "Empty String Value" );
+	ok( !jQuery.isFunction( 0 ), "0 Value" );
+
+	// Check built-ins
+	// Safari uses "(Internal Function)"
+	ok( jQuery.isFunction(String), "String Function("+String+")" );
+	ok( jQuery.isFunction(Array), "Array Function("+Array+")" );
+	ok( jQuery.isFunction(Object), "Object Function("+Object+")" );
+	ok( jQuery.isFunction(Function), "Function Function("+Function+")" );
+
+	// When stringified, this could be misinterpreted
+	var mystr = "function";
+	ok( !jQuery.isFunction(mystr), "Function String" );
+
+	// When stringified, this could be misinterpreted
+	var myarr = [ "function" ];
+	ok( !jQuery.isFunction(myarr), "Function Array" );
+
+	// When stringified, this could be misinterpreted
+	var myfunction = { "function": "test" };
+	ok( !jQuery.isFunction(myfunction), "Function Object" );
+
+	// Make sure normal functions still work
+	var fn = function(){};
+	ok( jQuery.isFunction(fn), "Normal Function" );
+
+	var obj = document.createElement("object");
+
+	// Firefox says this is a function
+	ok( !jQuery.isFunction(obj), "Object Element" );
+
+	// IE says this is an object
+	ok( jQuery.isFunction(obj.getAttribute), "getAttribute Function" );
+
+	var nodes = document.body.childNodes;
+
+	// Safari says this is a function
+	ok( !jQuery.isFunction(nodes), "childNodes Property" );
+
+	var first = document.body.firstChild;
+
+	// Normal elements are reported ok everywhere
+	ok( !jQuery.isFunction(first), "A normal DOM Element" );
+
+	var input = document.createElement("input");
+	input.type = "text";
+	document.body.appendChild( input );
+
+	// IE says this is an object
+	ok( jQuery.isFunction(input.focus), "A default function property" );
+
+	document.body.removeChild( input );
+
+	var a = document.createElement("a");
+	a.href = "some-function";
+	document.body.appendChild( a );
+
+	// This serializes with the word 'function' in it
+	ok( !jQuery.isFunction(a), "Anchor Element" );
+
+	document.body.removeChild( a );
+
+	// Recursive function calls have lengths and array-like properties
+	function callme(callback){
+		function fn(response){
+			callback(response);
+		}
+
+		ok( jQuery.isFunction(fn), "Recursive Function Call" );
+
+		fn({ some: "data" });
+	};
+
+	callme(function(){
+		callme(function(){});
+	});
+});
+
+var foo = false;
+
+test("$('html')", function() {
+	expect(6);
+
+	reset();
+	foo = false;
+	var s = $("<script>var foo='test';</script>")[0];
+	ok( s, "Creating a script" );
+	ok( !foo, "Make sure the script wasn't executed prematurely" );
+	$("body").append(s);
+	ok( foo, "Executing a scripts contents in the right context" );
+
+	reset();
+	ok( $("<link rel='stylesheet'/>")[0], "Creating a link" );
+
+	reset();
+
+	var j = $("<span>hi</span> there <!-- mon ami -->");
+	ok( j.length >= 2, "Check node,textnode,comment creation (some browsers delete comments)" );
+
+	ok( !$("<option>test</option>")[0].selected, "Make sure that options are auto-selected #2050" );
+});
+
+test("$('html', context)", function() {
+	expect(1);
+
+	var $div = $("<div/>");
+	var $span = $("<span/>", $div);
+	equals($span.length, 1, "Verify a span created with a div context works, #1763");
+});
+
+if ( !isLocal ) {
+test("$(selector, xml).text(str) - Loaded via XML document", function() {
+	expect(2);
+	stop();
+	$.get('data/dashboard.xml', function(xml) {
+		// tests for #1419 where IE was a problem
+		equals( $("tab:first", xml).text(), "blabla", "Verify initial text correct" );
+		$("tab:first", xml).text("newtext");
+		equals( $("tab:first", xml).text(), "newtext", "Verify new text correct" );
+		start();
+	});
+});
+}
+
+test("length", function() {
+	expect(1);
+	equals( $("p").length, 6, "Get Number of Elements Found" );
+});
+
+test("size()", function() {
+	expect(1);
+	equals( $("p").size(), 6, "Get Number of Elements Found" );
+});
+
+test("get()", function() {
+	expect(1);
+	isSet( $("p").get(), q("firstp","ap","sndp","en","sap","first"), "Get All Elements" );
+});
+
+test("get(Number)", function() {
+	expect(1);
+	equals( $("p").get(0), document.getElementById("firstp"), "Get A Single Element" );
+});
+
+test("add(String|Element|Array|undefined)", function() {
+	expect(12);
+	isSet( $("#sndp").add("#en").add("#sap").get(), q("sndp", "en", "sap"), "Check elements from document" );
+	isSet( $("#sndp").add( $("#en")[0] ).add( $("#sap") ).get(), q("sndp", "en", "sap"), "Check elements from document" );
+	ok( $([]).add($("#form")[0].elements).length >= 13, "Check elements from array" );
+
+	// For the time being, we're discontinuing support for $(form.elements) since it's ambiguous in IE
+	// use $([]).add(form.elements) instead.
+	//equals( $([]).add($("#form")[0].elements).length, $($("#form")[0].elements).length, "Array in constructor must equals array in add()" );
+
+	var x = $([]).add($("<p id='x1'>xxx</p>")).add($("<p id='x2'>xxx</p>"));
+	equals( x[0].id, "x1", "Check on-the-fly element1" );
+	equals( x[1].id, "x2", "Check on-the-fly element2" );
+
+	var x = $([]).add("<p id='x1'>xxx</p>").add("<p id='x2'>xxx</p>");
+	equals( x[0].id, "x1", "Check on-the-fly element1" );
+	equals( x[1].id, "x2", "Check on-the-fly element2" );
+
+	var notDefined;
+	equals( $([]).add(notDefined).length, 0, "Check that undefined adds nothing" );
+
+	// Added after #2811
+	equals( $([]).add([window,document,document.body,document]).length, 3, "Pass an array" );
+	equals( $(document).add(document).length, 1, "Check duplicated elements" );
+	equals( $(window).add(window).length, 1, "Check duplicated elements using the window" );
+	ok( $([]).add( document.getElementById('form') ).length >= 13, "Add a form (adds the elements)" );
+});
+
+test("each(Function)", function() {
+	expect(1);
+	var div = $("div");
+	div.each(function(){this.foo = 'zoo';});
+	var pass = true;
+	for ( var i = 0; i < div.size(); i++ ) {
+		if ( div.get(i).foo != "zoo" ) pass = false;
+	}
+	ok( pass, "Execute a function, Relative" );
+});
+
+test("index(Object)", function() {
+	expect(10);
+
+	var elements = $([window, document]),
+		inputElements = $('#radio1,#radio2,#check1,#check2');
+
+	equals( elements.index(window), 0, "Check for index of elements" );
+	equals( elements.index(document), 1, "Check for index of elements" );
+	equals( inputElements.index(document.getElementById('radio1')), 0, "Check for index of elements" );
+	equals( inputElements.index(document.getElementById('radio2')), 1, "Check for index of elements" );
+	equals( inputElements.index(document.getElementById('check1')), 2, "Check for index of elements" );
+	equals( inputElements.index(document.getElementById('check2')), 3, "Check for index of elements" );
+	equals( inputElements.index(window), -1, "Check for not found index" );
+	equals( inputElements.index(document), -1, "Check for not found index" );
+
+	// enabled since [5500]
+	equals( elements.index( elements ), 0, "Pass in a jQuery object" );
+	equals( elements.index( elements.eq(1) ), 1, "Pass in a jQuery object" );
+});
+
+test("attr(String)", function() {
+	expect(26);
+	equals( $('#text1').attr('value'), "Test", 'Check for value attribute' );
+	equals( $('#text1').attr('value', "Test2").attr('defaultValue'), "Test", 'Check for defaultValue attribute' );
+	equals( $('#text1').attr('type'), "text", 'Check for type attribute' );
+	equals( $('#radio1').attr('type'), "radio", 'Check for type attribute' );
+	equals( $('#check1').attr('type'), "checkbox", 'Check for type attribute' );
+	equals( $('#simon1').attr('rel'), "bookmark", 'Check for rel attribute' );
+	equals( $('#google').attr('title'), "Google!", 'Check for title attribute' );
+	equals( $('#mark').attr('hreflang'), "en", 'Check for hreflang attribute' );
+	equals( $('#en').attr('lang'), "en", 'Check for lang attribute' );
+	equals( $('#simon').attr('class'), "blog link", 'Check for class attribute' );
+	equals( $('#name').attr('name'), "name", 'Check for name attribute' );
+	equals( $('#text1').attr('name'), "action", 'Check for name attribute' );
+	ok( $('#form').attr('action').indexOf("formaction") >= 0, 'Check for action attribute' );
+	equals( $('#text1').attr('maxlength'), '30', 'Check for maxlength attribute' );
+	equals( $('#text1').attr('maxLength'), '30', 'Check for maxLength attribute' );
+	equals( $('#area1').attr('maxLength'), '30', 'Check for maxLength attribute' );
+	equals( $('#select2').attr('selectedIndex'), 3, 'Check for selectedIndex attribute' );
+	equals( $('#foo').attr('nodeName'), 'DIV', 'Check for nodeName attribute' );
+	equals( $('#foo').attr('tagName'), 'DIV', 'Check for tagName attribute' );
+
+	$('<a id="tAnchor5"></a>').attr('href', '#5').appendTo('#main'); // using innerHTML in IE causes href attribute to be serialized to the full path
+	equals( $('#tAnchor5').attr('href'), "#5", 'Check for non-absolute href (an anchor)' );
+
+
+	// Related to [5574] and [5683]
+	var body = document.body, $body = $(body);
+
+	ok( $body.attr('foo') === undefined, 'Make sure that a non existent attribute returns undefined' );
+	ok( $body.attr('nextSibling') === null, 'Make sure a null expando returns null' );
+	
+	body.setAttribute('foo', 'baz');
+	equals( $body.attr('foo'), 'baz', 'Make sure the dom attribute is retrieved when no expando is found' );
+	
+	body.foo = 'bar';
+	equals( $body.attr('foo'), 'bar', 'Make sure the expando is preferred over the dom attribute' );
+	
+	$body.attr('foo','cool');
+	equals( $body.attr('foo'), 'cool', 'Make sure that setting works well when both expando and dom attribute are available' );
+	
+	body.foo = undefined;
+	ok( $body.attr('foo') === undefined, 'Make sure the expando is preferred over the dom attribute, even if undefined' );
+	
+	body.removeAttribute('foo'); // Cleanup
+});
+
+if ( !isLocal ) {
+	test("attr(String) in XML Files", function() {
+		expect(2);
+		stop();
+		$.get("data/dashboard.xml", function(xml) {
+			equals( $("locations", xml).attr("class"), "foo", "Check class attribute in XML document" );
+			equals( $("location", xml).attr("for"), "bar", "Check for attribute in XML document" );
+			start();
+		});
+	});
+}
+
+test("attr(String, Function)", function() {
+	expect(2);
+	equals( $('#text1').attr('value', function() { return this.id })[0].value, "text1", "Set value from id" );
+	equals( $('#text1').attr('title', function(i) { return i }).attr('title'), "0", "Set value with an index");
+});
+
+test("attr(Hash)", function() {
+	expect(1);
+	var pass = true;
+	$("div").attr({foo: 'baz', zoo: 'ping'}).each(function(){
+		if ( this.getAttribute('foo') != "baz" && this.getAttribute('zoo') != "ping" ) pass = false;
+	});
+	ok( pass, "Set Multiple Attributes" );
+});
+
+test("attr(String, Object)", function() {
+	expect(17);
+	var div = $("div").attr("foo", "bar");
+		fail = false;
+	for ( var i = 0; i < div.size(); i++ ) {
+		if ( div.get(i).getAttribute('foo') != "bar" ){
+			fail = i;
+			break;
+		}
+	}
+	equals( fail, false, "Set Attribute, the #"+fail+" element didn't get the attribute 'foo'" );
+
+	ok( $("#foo").attr({"width": null}), "Try to set an attribute to nothing" );
+
+	$("#name").attr('name', 'something');
+	equals( $("#name").attr('name'), 'something', 'Set name attribute' );
+	$("#check2").attr('checked', true);
+	equals( document.getElementById('check2').checked, true, 'Set checked attribute' );
+	$("#check2").attr('checked', false);
+	equals( document.getElementById('check2').checked, false, 'Set checked attribute' );
+	$("#text1").attr('readonly', true);
+	equals( document.getElementById('text1').readOnly, true, 'Set readonly attribute' );
+	$("#text1").attr('readonly', false);
+	equals( document.getElementById('text1').readOnly, false, 'Set readonly attribute' );
+	$("#name").attr('maxlength', '5');
+	equals( document.getElementById('name').maxLength, '5', 'Set maxlength attribute' );
+	$("#name").attr('maxLength', '10');
+	equals( document.getElementById('name').maxLength, '10', 'Set maxlength attribute' );
+
+	// for #1070
+	$("#name").attr('someAttr', '0');
+	equals( $("#name").attr('someAttr'), '0', 'Set attribute to a string of "0"' );
+	$("#name").attr('someAttr', 0);
+	equals( $("#name").attr('someAttr'), 0, 'Set attribute to the number 0' );
+	$("#name").attr('someAttr', 1);
+	equals( $("#name").attr('someAttr'), 1, 'Set attribute to the number 1' );
+
+	// using contents will get comments regular, text, and comment nodes
+	var j = $("#nonnodes").contents();
+
+	j.attr("name", "attrvalue");
+	equals( j.attr("name"), "attrvalue", "Check node,textnode,comment for attr" );
+	j.removeAttr("name");
+
+	reset();
+
+	var type = $("#check2").attr('type');
+	var thrown = false;
+	try {
+		$("#check2").attr('type','hidden');
+	} catch(e) {
+		thrown = true;
+	}
+	ok( thrown, "Exception thrown when trying to change type property" );
+	equals( type, $("#check2").attr('type'), "Verify that you can't change the type of an input element" );
+
+	var check = document.createElement("input");
+	var thrown = true;
+	try {
+		$(check).attr('type','checkbox');
+	} catch(e) {
+		thrown = false;
+	}
+	ok( thrown, "Exception thrown when trying to change type property" );
+	equals( "checkbox", $(check).attr('type'), "Verify that you can change the type of an input element that isn't in the DOM" );
+});
+
+if ( !isLocal ) {
+	test("attr(String, Object) - Loaded via XML document", function() {
+		expect(2);
+		stop();
+		$.get('data/dashboard.xml', function(xml) {
+			var titles = [];
+			$('tab', xml).each(function() {
+				titles.push($(this).attr('title'));
+			});
+			equals( titles[0], 'Location', 'attr() in XML context: Check first title' );
+			equals( titles[1], 'Users', 'attr() in XML context: Check second title' );
+			start();
+		});
+	});
+}
+
+test("css(String|Hash)", function() {
+	expect(19);
+
+	equals( $('#main').css("display"), 'none', 'Check for css property "display"');
+
+	ok( $('#foo').is(':visible'), 'Modifying CSS display: Assert element is visible');
+	$('#foo').css({display: 'none'});
+	ok( !$('#foo').is(':visible'), 'Modified CSS display: Assert element is hidden');
+	$('#foo').css({display: 'block'});
+	ok( $('#foo').is(':visible'), 'Modified CSS display: Assert element is visible');
+
+	$('#floatTest').css({styleFloat: 'right'});
+	equals( $('#floatTest').css('styleFloat'), 'right', 'Modified CSS float using "styleFloat": Assert float is right');
+	$('#floatTest').css({cssFloat: 'left'});
+	equals( $('#floatTest').css('cssFloat'), 'left', 'Modified CSS float using "cssFloat": Assert float is left');
+	$('#floatTest').css({'float': 'right'});
+	equals( $('#floatTest').css('float'), 'right', 'Modified CSS float using "float": Assert float is right');
+	$('#floatTest').css({'font-size': '30px'});
+	equals( $('#floatTest').css('font-size'), '30px', 'Modified CSS font-size: Assert font-size is 30px');
+
+	$.each("0,0.25,0.5,0.75,1".split(','), function(i, n) {
+		$('#foo').css({opacity: n});
+		equals( $('#foo').css('opacity'), parseFloat(n), "Assert opacity is " + parseFloat(n) + " as a String" );
+		$('#foo').css({opacity: parseFloat(n)});
+		equals( $('#foo').css('opacity'), parseFloat(n), "Assert opacity is " + parseFloat(n) + " as a Number" );
+	});
+	$('#foo').css({opacity: ''});
+	equals( $('#foo').css('opacity'), '1', "Assert opacity is 1 when set to an empty String" );
+});
+
+test("css(String, Object)", function() {
+	expect(21);
+	ok( $('#foo').is(':visible'), 'Modifying CSS display: Assert element is visible');
+	$('#foo').css('display', 'none');
+	ok( !$('#foo').is(':visible'), 'Modified CSS display: Assert element is hidden');
+	$('#foo').css('display', 'block');
+	ok( $('#foo').is(':visible'), 'Modified CSS display: Assert element is visible');
+
+	$('#floatTest').css('styleFloat', 'left');
+	equals( $('#floatTest').css('styleFloat'), 'left', 'Modified CSS float using "styleFloat": Assert float is left');
+	$('#floatTest').css('cssFloat', 'right');
+	equals( $('#floatTest').css('cssFloat'), 'right', 'Modified CSS float using "cssFloat": Assert float is right');
+	$('#floatTest').css('float', 'left');
+	equals( $('#floatTest').css('float'), 'left', 'Modified CSS float using "float": Assert float is left');
+	$('#floatTest').css('font-size', '20px');
+	equals( $('#floatTest').css('font-size'), '20px', 'Modified CSS font-size: Assert font-size is 20px');
+
+	$.each("0,0.25,0.5,0.75,1".split(','), function(i, n) {
+		$('#foo').css('opacity', n);
+		equals( $('#foo').css('opacity'), parseFloat(n), "Assert opacity is " + parseFloat(n) + " as a String" );
+		$('#foo').css('opacity', parseFloat(n));
+		equals( $('#foo').css('opacity'), parseFloat(n), "Assert opacity is " + parseFloat(n) + " as a Number" );
+	});
+	$('#foo').css('opacity', '');
+	equals( $('#foo').css('opacity'), '1', "Assert opacity is 1 when set to an empty String" );
+	// for #1438, IE throws JS error when filter exists but doesn't have opacity in it
+	if (jQuery.browser.msie) {
+		$('#foo').css("filter", "progid:DXImageTransform.Microsoft.Chroma(color='red');");
+	}
+	equals( $('#foo').css('opacity'), '1', "Assert opacity is 1 when a different filter is set in IE, #1438" );
+
+	// using contents will get comments regular, text, and comment nodes
+	var j = $("#nonnodes").contents();
+	j.css("padding-left", "1px");
+	equals( j.css("padding-left"), "1px", "Check node,textnode,comment css works" );
+
+	// opera sometimes doesn't update 'display' correctly, see #2037
+	$("#t2037")[0].innerHTML = $("#t2037")[0].innerHTML
+	equals( $("#t2037 .hidden").css("display"), "none", "Make sure browser thinks it is hidden" );
+});
+
+test("jQuery.css(elem, 'height') doesn't clear radio buttons (bug #1095)", function () {
+	expect(4);
+
+	var $checkedtest = $("#checkedtest");
+	// IE6 was clearing "checked" in jQuery.css(elem, "height");
+	jQuery.css($checkedtest[0], "height");
+	ok( !! $(":radio:first", $checkedtest).attr("checked"), "Check first radio still checked." );
+	ok( ! $(":radio:last", $checkedtest).attr("checked"), "Check last radio still NOT checked." );
+	ok( !! $(":checkbox:first", $checkedtest).attr("checked"), "Check first checkbox still checked." );
+	ok( ! $(":checkbox:last", $checkedtest).attr("checked"), "Check last checkbox still NOT checked." );
+});
+
+test("width()", function() {
+	expect(9);
+
+	var $div = $("#nothiddendiv");
+	$div.width(30);
+	equals($div.width(), 30, "Test set to 30 correctly");
+	$div.width(-1); // handle negative numbers by ignoring #1599
+	equals($div.width(), 30, "Test negative width ignored");
+	$div.css("padding", "20px");
+	equals($div.width(), 30, "Test padding specified with pixels");
+	$div.css("border", "2px solid #fff");
+	equals($div.width(), 30, "Test border specified with pixels");
+	$div.css("padding", "2em");
+	equals($div.width(), 30, "Test padding specified with ems");
+	$div.css("border", "1em solid #fff");
+	equals($div.width(), 30, "Test border specified with ems");
+	$div.css("padding", "2%");
+	equals($div.width(), 30, "Test padding specified with percent");
+	$div.hide();
+	equals($div.width(), 30, "Test hidden div");
+
+	$div.css({ display: "", border: "", padding: "" });
+
+	$("#nothiddendivchild").css({ padding: "3px", border: "2px solid #fff" });
+	equals($("#nothiddendivchild").width(), 20, "Test child width with border and padding");
+	$("#nothiddendiv, #nothiddendivchild").css({ border: "", padding: "", width: "" });
+});
+
+test("height()", function() {
+	expect(8);
+
+	var $div = $("#nothiddendiv");
+	$div.height(30);
+	equals($div.height(), 30, "Test set to 30 correctly");
+	$div.height(-1); // handle negative numbers by ignoring #1599
+	equals($div.height(), 30, "Test negative height ignored");
+	$div.css("padding", "20px");
+	equals($div.height(), 30, "Test padding specified with pixels");
+	$div.css("border", "2px solid #fff");
+	equals($div.height(), 30, "Test border specified with pixels");
+	$div.css("padding", "2em");
+	equals($div.height(), 30, "Test padding specified with ems");
+	$div.css("border", "1em solid #fff");
+	equals($div.height(), 30, "Test border specified with ems");
+	$div.css("padding", "2%");
+	equals($div.height(), 30, "Test padding specified with percent");
+	$div.hide();
+	equals($div.height(), 30, "Test hidden div");
+
+	$div.css({ display: "", border: "", padding: "", height: "1px" });
+});
+
+test("text()", function() {
+	expect(1);
+	var expected = "This link has class=\"blog\": Simon Willison's Weblog";
+	equals( $('#sap').text(), expected, 'Check for merged text of more then one element.' );
+});
+
+test("wrap(String|Element)", function() {
+	expect(8);
+	var defaultText = 'Try them out:'
+	var result = $('#first').wrap('<div class="red"><span></span></div>').text();
+	equals( defaultText, result, 'Check for wrapping of on-the-fly html' );
+	ok( $('#first').parent().parent().is('.red'), 'Check if wrapper has class "red"' );
+
+	reset();
+	var defaultText = 'Try them out:'
+	var result = $('#first').wrap(document.getElementById('empty')).parent();
+	ok( result.is('ol'), 'Check for element wrapping' );
+	equals( result.text(), defaultText, 'Check for element wrapping' );
+
+	reset();
+	$('#check1').click(function() {
+		var checkbox = this;
+		ok( checkbox.checked, "Checkbox's state is erased after wrap() action, see #769" );
+		$(checkbox).wrap( '<div id="c1" style="display:none;"></div>' );
+		ok( checkbox.checked, "Checkbox's state is erased after wrap() action, see #769" );
+	}).click();
+
+	// using contents will get comments regular, text, and comment nodes
+	var j = $("#nonnodes").contents();
+	j.wrap("<i></i>");
+	equals( $("#nonnodes > i").length, 3, "Check node,textnode,comment wraps ok" );
+	equals( $("#nonnodes > i").text(), j.text() + j[1].nodeValue, "Check node,textnode,comment wraps doesn't hurt text" );
+});
+
+test("wrapAll(String|Element)", function() {
+	expect(8);
+	var prev = $("#first")[0].previousSibling;
+	var p = $("#first")[0].parentNode;
+	var result = $('#first,#firstp').wrapAll('<div class="red"><div id="tmp"></div></div>');
+	equals( result.parent().length, 1, 'Check for wrapping of on-the-fly html' );
+	ok( $('#first').parent().parent().is('.red'), 'Check if wrapper has class "red"' );
+	ok( $('#firstp').parent().parent().is('.red'), 'Check if wrapper has class "red"' );
+	equals( $("#first").parent().parent()[0].previousSibling, prev, "Correct Previous Sibling" );
+	equals( $("#first").parent().parent()[0].parentNode, p, "Correct Parent" );
+
+	reset();
+	var prev = $("#first")[0].previousSibling;
+	var p = $("#first")[0].parentNode;
+	var result = $('#first,#firstp').wrapAll(document.getElementById('empty'));
+	equals( $("#first").parent()[0], $("#firstp").parent()[0], "Same Parent" );
+	equals( $("#first").parent()[0].previousSibling, prev, "Correct Previous Sibling" );
+	equals( $("#first").parent()[0].parentNode, p, "Correct Parent" );
+});
+
+test("wrapInner(String|Element)", function() {
+	expect(6);
+	var num = $("#first").children().length;
+	var result = $('#first').wrapInner('<div class="red"><div id="tmp"></div></div>');
+	equals( $("#first").children().length, 1, "Only one child" );
+	ok( $("#first").children().is(".red"), "Verify Right Element" );
+	equals( $("#first").children().children().children().length, num, "Verify Elements Intact" );
+
+	reset();
+	var num = $("#first").children().length;
+	var result = $('#first').wrapInner(document.getElementById('empty'));
+	equals( $("#first").children().length, 1, "Only one child" );
+	ok( $("#first").children().is("#empty"), "Verify Right Element" );
+	equals( $("#first").children().children().length, num, "Verify Elements Intact" );
+});
+
+test("append(String|Element|Array&lt;Element&gt;|jQuery)", function() {
+	expect(21);
+	var defaultText = 'Try them out:'
+	var result = $('#first').append('<b>buga</b>');
+	equals( result.text(), defaultText + 'buga', 'Check if text appending works' );
+	equals( $('#select3').append('<option value="appendTest">Append Test</option>').find('option:last-child').attr('value'), 'appendTest', 'Appending html options to select element');
+
+	reset();
+	var expected = "This link has class=\"blog\": Simon Willison's WeblogTry them out:";
+	$('#sap').append(document.getElementById('first'));
+	equals( expected, $('#sap').text(), "Check for appending of element" );
+
+	reset();
+	expected = "This link has class=\"blog\": Simon Willison's WeblogTry them out:Yahoo";
+	$('#sap').append([document.getElementById('first'), document.getElementById('yahoo')]);
+	equals( expected, $('#sap').text(), "Check for appending of array of elements" );
+
+	reset();
+	expected = "This link has class=\"blog\": Simon Willison's WeblogTry them out:Yahoo";
+	$('#sap').append($("#first, #yahoo"));
+	equals( expected, $('#sap').text(), "Check for appending of jQuery object" );
+
+	reset();
+	$("#sap").append( 5 );
+	ok( $("#sap")[0].innerHTML.match( /5$/ ), "Check for appending a number" );
+
+	reset();
+	$("#sap").append( " text with spaces " );
+	ok( $("#sap")[0].innerHTML.match(/ text with spaces $/), "Check for appending text with spaces" );
+
+	reset();
+	ok( $("#sap").append([]), "Check for appending an empty array." );
+	ok( $("#sap").append(""), "Check for appending an empty string." );
+	ok( $("#sap").append(document.getElementsByTagName("foo")), "Check for appending an empty nodelist." );
+
+	reset();
+	$("#sap").append(document.getElementById('form'));
+	equals( $("#sap>form").size(), 1, "Check for appending a form" ); // Bug #910
+
+	reset();
+	var pass = true;
+	try {
+		$( $("#iframe")[0].contentWindow.document.body ).append("<div>test</div>");
+	} catch(e) {
+		pass = false;
+	}
+
+	ok( pass, "Test for appending a DOM node to the contents of an IFrame" );
+
+	reset();
+	$('<fieldset/>').appendTo('#form').append('<legend id="legend">test</legend>');
+	t( 'Append legend', '#legend', ['legend'] );
+
+	reset();
+	$('#select1').append('<OPTION>Test</OPTION>');
+	equals( $('#select1 option:last').text(), "Test", "Appending &lt;OPTION&gt; (all caps)" );
+
+	$('#table').append('<colgroup></colgroup>');
+	ok( $('#table colgroup').length, "Append colgroup" );
+
+	$('#table colgroup').append('<col/>');
+	ok( $('#table colgroup col').length, "Append col" );
+
+	reset();
+	$('#table').append('<caption></caption>');
+	ok( $('#table caption').length, "Append caption" );
+
+	reset();
+	$('form:last')
+		.append('<select id="appendSelect1"></select>')
+		.append('<select id="appendSelect2"><option>Test</option></select>');
+
+	t( "Append Select", "#appendSelect1, #appendSelect2", ["appendSelect1", "appendSelect2"] );
+
+	// using contents will get comments regular, text, and comment nodes
+	var j = $("#nonnodes").contents();
+	var d = $("<div/>").appendTo("#nonnodes").append(j);
+	equals( $("#nonnodes").length, 1, "Check node,textnode,comment append moved leaving just the div" );
+	ok( d.contents().length >= 2, "Check node,textnode,comment append works" );
+	d.contents().appendTo("#nonnodes");
+	d.remove();
+	ok( $("#nonnodes").contents().length >= 2, "Check node,textnode,comment append cleanup worked" );
+});
+
+test("appendTo(String|Element|Array&lt;Element&gt;|jQuery)", function() {
+	expect(6);
+	var defaultText = 'Try them out:'
+	$('<b>buga</b>').appendTo('#first');
+	equals( $("#first").text(), defaultText + 'buga', 'Check if text appending works' );
+	equals( $('<option value="appendTest">Append Test</option>').appendTo('#select3').parent().find('option:last-child').attr('value'), 'appendTest', 'Appending html options to select element');
+
+	reset();
+	var expected = "This link has class=\"blog\": Simon Willison's WeblogTry them out:";
+	$(document.getElementById('first')).appendTo('#sap');
+	equals( expected, $('#sap').text(), "Check for appending of element" );
+
+	reset();
+	expected = "This link has class=\"blog\": Simon Willison's WeblogTry them out:Yahoo";
+	$([document.getElementById('first'), document.getElementById('yahoo')]).appendTo('#sap');
+	equals( expected, $('#sap').text(), "Check for appending of array of elements" );
+
+	reset();
+	expected = "This link has class=\"blog\": Simon Willison's WeblogTry them out:Yahoo";
+	$("#first, #yahoo").appendTo('#sap');
+	equals( expected, $('#sap').text(), "Check for appending of jQuery object" );
+
+	reset();
+	$('#select1').appendTo('#foo');
+	t( 'Append select', '#foo select', ['select1'] );
+});
+
+test("prepend(String|Element|Array&lt;Element&gt;|jQuery)", function() {
+	expect(5);
+	var defaultText = 'Try them out:'
+	var result = $('#first').prepend('<b>buga</b>');
+	equals( result.text(), 'buga' + defaultText, 'Check if text prepending works' );
+	equals( $('#select3').prepend('<option value="prependTest">Prepend Test</option>').find('option:first-child').attr('value'), 'prependTest', 'Prepending html options to select element');
+
+	reset();
+	var expected = "Try them out:This link has class=\"blog\": Simon Willison's Weblog";
+	$('#sap').prepend(document.getElementById('first'));
+	equals( expected, $('#sap').text(), "Check for prepending of element" );
+
+	reset();
+	expected = "Try them out:YahooThis link has class=\"blog\": Simon Willison's Weblog";
+	$('#sap').prepend([document.getElementById('first'), document.getElementById('yahoo')]);
+	equals( expected, $('#sap').text(), "Check for prepending of array of elements" );
+
+	reset();
+	expected = "Try them out:YahooThis link has class=\"blog\": Simon Willison's Weblog";
+	$('#sap').prepend($("#first, #yahoo"));
+	equals( expected, $('#sap').text(), "Check for prepending of jQuery object" );
+});
+
+test("prependTo(String|Element|Array&lt;Element&gt;|jQuery)", function() {
+	expect(6);
+	var defaultText = 'Try them out:'
+	$('<b>buga</b>').prependTo('#first');
+	equals( $('#first').text(), 'buga' + defaultText, 'Check if text prepending works' );
+	equals( $('<option value="prependTest">Prepend Test</option>').prependTo('#select3').parent().find('option:first-child').attr('value'), 'prependTest', 'Prepending html options to select element');
+
+	reset();
+	var expected = "Try them out:This link has class=\"blog\": Simon Willison's Weblog";
+	$(document.getElementById('first')).prependTo('#sap');
+	equals( expected, $('#sap').text(), "Check for prepending of element" );
+
+	reset();
+	expected = "Try them out:YahooThis link has class=\"blog\": Simon Willison's Weblog";
+	$([document.getElementById('yahoo'), document.getElementById('first')]).prependTo('#sap');
+	equals( expected, $('#sap').text(), "Check for prepending of array of elements" );
+
+	reset();
+	expected = "Try them out:YahooThis link has class=\"blog\": Simon Willison's Weblog";
+	$("#yahoo, #first").prependTo('#sap');
+	equals( expected, $('#sap').text(), "Check for prepending of jQuery object" );
+
+	reset();
+	$('<select id="prependSelect1"></select>').prependTo('form:last');
+	$('<select id="prependSelect2"><option>Test</option></select>').prependTo('form:last');
+
+	t( "Prepend Select", "#prependSelect1, #prependSelect2", ["prependSelect1", "prependSelect2"] );
+});
+
+test("before(String|Element|Array&lt;Element&gt;|jQuery)", function() {
+	expect(4);
+	var expected = 'This is a normal link: bugaYahoo';
+	$('#yahoo').before('<b>buga</b>');
+	equals( expected, $('#en').text(), 'Insert String before' );
+
+	reset();
+	expected = "This is a normal link: Try them out:Yahoo";
+	$('#yahoo').before(document.getElementById('first'));
+	equals( expected, $('#en').text(), "Insert element before" );
+
+	reset();
+	expected = "This is a normal link: Try them out:diveintomarkYahoo";
+	$('#yahoo').before([document.getElementById('first'), document.getElementById('mark')]);
+	equals( expected, $('#en').text(), "Insert array of elements before" );
+
+	reset();
+	expected = "This is a normal link: Try them out:diveintomarkYahoo";
+	$('#yahoo').before($("#first, #mark"));
+	equals( expected, $('#en').text(), "Insert jQuery before" );
+});
+
+test("insertBefore(String|Element|Array&lt;Element&gt;|jQuery)", function() {
+	expect(4);
+	var expected = 'This is a normal link: bugaYahoo';
+	$('<b>buga</b>').insertBefore('#yahoo');
+	equals( expected, $('#en').text(), 'Insert String before' );
+
+	reset();
+	expected = "This is a normal link: Try them out:Yahoo";
+	$(document.getElementById('first')).insertBefore('#yahoo');
+	equals( expected, $('#en').text(), "Insert element before" );
+
+	reset();
+	expected = "This is a normal link: Try them out:diveintomarkYahoo";
+	$([document.getElementById('first'), document.getElementById('mark')]).insertBefore('#yahoo');
+	equals( expected, $('#en').text(), "Insert array of elements before" );
+
+	reset();
+	expected = "This is a normal link: Try them out:diveintomarkYahoo";
+	$("#first, #mark").insertBefore('#yahoo');
+	equals( expected, $('#en').text(), "Insert jQuery before" );
+});
+
+test("after(String|Element|Array&lt;Element&gt;|jQuery)", function() {
+	expect(4);
+	var expected = 'This is a normal link: Yahoobuga';
+	$('#yahoo').after('<b>buga</b>');
+	equals( expected, $('#en').text(), 'Insert String after' );
+
+	reset();
+	expected = "This is a normal link: YahooTry them out:";
+	$('#yahoo').after(document.getElementById('first'));
+	equals( expected, $('#en').text(), "Insert element after" );
+
+	reset();
+	expected = "This is a normal link: YahooTry them out:diveintomark";
+	$('#yahoo').after([document.getElementById('first'), document.getElementById('mark')]);
+	equals( expected, $('#en').text(), "Insert array of elements after" );
+
+	reset();
+	expected = "This is a normal link: YahooTry them out:diveintomark";
+	$('#yahoo').after($("#first, #mark"));
+	equals( expected, $('#en').text(), "Insert jQuery after" );
+});
+
+test("insertAfter(String|Element|Array&lt;Element&gt;|jQuery)", function() {
+	expect(4);
+	var expected = 'This is a normal link: Yahoobuga';
+	$('<b>buga</b>').insertAfter('#yahoo');
+	equals( expected, $('#en').text(), 'Insert String after' );
+
+	reset();
+	expected = "This is a normal link: YahooTry them out:";
+	$(document.getElementById('first')).insertAfter('#yahoo');
+	equals( expected, $('#en').text(), "Insert element after" );
+
+	reset();
+	expected = "This is a normal link: YahooTry them out:diveintomark";
+	$([document.getElementById('mark'), document.getElementById('first')]).insertAfter('#yahoo');
+	equals( expected, $('#en').text(), "Insert array of elements after" );
+
+	reset();
+	expected = "This is a normal link: YahooTry them out:diveintomark";
+	$("#mark, #first").insertAfter('#yahoo');
+	equals( expected, $('#en').text(), "Insert jQuery after" );
+});
+
+test("replaceWith(String|Element|Array&lt;Element&gt;|jQuery)", function() {
+	expect(10);
+	$('#yahoo').replaceWith('<b id="replace">buga</b>');
+	ok( $("#replace")[0], 'Replace element with string' );
+	ok( !$("#yahoo")[0], 'Verify that original element is gone, after string' );
+
+	reset();
+	$('#yahoo').replaceWith(document.getElementById('first'));
+	ok( $("#first")[0], 'Replace element with element' );
+	ok( !$("#yahoo")[0], 'Verify that original element is gone, after element' );
+
+	reset();
+	$('#yahoo').replaceWith([document.getElementById('first'), document.getElementById('mark')]);
+	ok( $("#first")[0], 'Replace element with array of elements' );
+	ok( $("#mark")[0], 'Replace element with array of elements' );
+	ok( !$("#yahoo")[0], 'Verify that original element is gone, after array of elements' );
+
+	reset();
+	$('#yahoo').replaceWith($("#first, #mark"));
+	ok( $("#first")[0], 'Replace element with set of elements' );
+	ok( $("#mark")[0], 'Replace element with set of elements' );
+	ok( !$("#yahoo")[0], 'Verify that original element is gone, after set of elements' );
+});
+
+test("replaceAll(String|Element|Array&lt;Element&gt;|jQuery)", function() {
+	expect(10);
+	$('<b id="replace">buga</b>').replaceAll("#yahoo");
+	ok( $("#replace")[0], 'Replace element with string' );
+	ok( !$("#yahoo")[0], 'Verify that original element is gone, after string' );
+
+	reset();
+	$(document.getElementById('first')).replaceAll("#yahoo");
+	ok( $("#first")[0], 'Replace element with element' );
+	ok( !$("#yahoo")[0], 'Verify that original element is gone, after element' );
+
+	reset();
+	$([document.getElementById('first'), document.getElementById('mark')]).replaceAll("#yahoo");
+	ok( $("#first")[0], 'Replace element with array of elements' );
+	ok( $("#mark")[0], 'Replace element with array of elements' );
+	ok( !$("#yahoo")[0], 'Verify that original element is gone, after array of elements' );
+
+	reset();
+	$("#first, #mark").replaceAll("#yahoo");
+	ok( $("#first")[0], 'Replace element with set of elements' );
+	ok( $("#mark")[0], 'Replace element with set of elements' );
+	ok( !$("#yahoo")[0], 'Verify that original element is gone, after set of elements' );
+});
+
+test("end()", function() {
+	expect(3);
+	equals( 'Yahoo', $('#yahoo').parent().end().text(), 'Check for end' );
+	ok( $('#yahoo').end(), 'Check for end with nothing to end' );
+
+	var x = $('#yahoo');
+	x.parent();
+	equals( 'Yahoo', $('#yahoo').text(), 'Check for non-destructive behaviour' );
+});
+
+test("find(String)", function() {
+	expect(2);
+	equals( 'Yahoo', $('#foo').find('.blogTest').text(), 'Check for find' );
+
+	// using contents will get comments regular, text, and comment nodes
+	var j = $("#nonnodes").contents();
+	equals( j.find("div").length, 0, "Check node,textnode,comment to find zero divs" );
+});
+
+test("clone()", function() {
+	expect(20);
+	equals( 'This is a normal link: Yahoo', $('#en').text(), 'Assert text for #en' );
+	var clone = $('#yahoo').clone();
+	equals( 'Try them out:Yahoo', $('#first').append(clone).text(), 'Check for clone' );
+	equals( 'This is a normal link: Yahoo', $('#en').text(), 'Reassert text for #en' );
+
+	var cloneTags = [
+		"<table/>", "<tr/>", "<td/>", "<div/>",
+		"<button/>", "<ul/>", "<ol/>", "<li/>",
+		"<input type='checkbox' />", "<select/>", "<option/>", "<textarea/>",
+		"<tbody/>", "<thead/>", "<tfoot/>", "<iframe/>"
+	];
+	for (var i = 0; i < cloneTags.length; i++) {
+		var j = $(cloneTags[i]);
+		equals( j[0].tagName, j.clone()[0].tagName, 'Clone a &lt;' + cloneTags[i].substring(1));
+	}
+
+	// using contents will get comments regular, text, and comment nodes
+	var cl = $("#nonnodes").contents().clone();
+	ok( cl.length >= 2, "Check node,textnode,comment clone works (some browsers delete comments on clone)" );
+});
+
+if (!isLocal) {
+test("clone() on XML nodes", function() {
+	expect(2);
+	stop();
+	$.get("data/dashboard.xml", function (xml) {
+		var root = $(xml.documentElement).clone();
+		$("tab:first", xml).text("origval");
+		$("tab:first", root).text("cloneval");
+		equals($("tab:first", xml).text(), "origval", "Check original XML node was correctly set");
+		equals($("tab:first", root).text(), "cloneval", "Check cloned XML node was correctly set");
+		start();
+	});
+});
+}
+
+test("is(String)", function() {
+	expect(26);
+	ok( $('#form').is('form'), 'Check for element: A form must be a form' );
+	ok( !$('#form').is('div'), 'Check for element: A form is not a div' );
+	ok( $('#mark').is('.blog'), 'Check for class: Expected class "blog"' );
+	ok( !$('#mark').is('.link'), 'Check for class: Did not expect class "link"' );
+	ok( $('#simon').is('.blog.link'), 'Check for multiple classes: Expected classes "blog" and "link"' );
+	ok( !$('#simon').is('.blogTest'), 'Check for multiple classes: Expected classes "blog" and "link", but not "blogTest"' );
+	ok( $('#en').is('[lang="en"]'), 'Check for attribute: Expected attribute lang to be "en"' );
+	ok( !$('#en').is('[lang="de"]'), 'Check for attribute: Expected attribute lang to be "en", not "de"' );
+	ok( $('#text1').is('[type="text"]'), 'Check for attribute: Expected attribute type to be "text"' );
+	ok( !$('#text1').is('[type="radio"]'), 'Check for attribute: Expected attribute type to be "text", not "radio"' );
+	ok( $('#text2').is(':disabled'), 'Check for pseudoclass: Expected to be disabled' );
+	ok( !$('#text1').is(':disabled'), 'Check for pseudoclass: Expected not disabled' );
+	ok( $('#radio2').is(':checked'), 'Check for pseudoclass: Expected to be checked' );
+	ok( !$('#radio1').is(':checked'), 'Check for pseudoclass: Expected not checked' );
+	ok( $('#foo').is(':has(p)'), 'Check for child: Expected a child "p" element' );
+	ok( !$('#foo').is(':has(ul)'), 'Check for child: Did not expect "ul" element' );
+	ok( $('#foo').is(':has(p):has(a):has(code)'), 'Check for childs: Expected "p", "a" and "code" child elements' );
+	ok( !$('#foo').is(':has(p):has(a):has(code):has(ol)'), 'Check for childs: Expected "p", "a" and "code" child elements, but no "ol"' );
+	ok( !$('#foo').is(0), 'Expected false for an invalid expression - 0' );
+	ok( !$('#foo').is(null), 'Expected false for an invalid expression - null' );
+	ok( !$('#foo').is(''), 'Expected false for an invalid expression - ""' );
+	ok( !$('#foo').is(undefined), 'Expected false for an invalid expression - undefined' );
+
+	// test is() with comma-seperated expressions
+	ok( $('#en').is('[lang="en"],[lang="de"]'), 'Comma-seperated; Check for lang attribute: Expect en or de' );
+	ok( $('#en').is('[lang="de"],[lang="en"]'), 'Comma-seperated; Check for lang attribute: Expect en or de' );
+	ok( $('#en').is('[lang="en"] , [lang="de"]'), 'Comma-seperated; Check for lang attribute: Expect en or de' );
+	ok( $('#en').is('[lang="de"] , [lang="en"]'), 'Comma-seperated; Check for lang attribute: Expect en or de' );
+});
+
+test("$.extend(Object, Object)", function() {
+	expect(20);
+
+	var settings = { xnumber1: 5, xnumber2: 7, xstring1: "peter", xstring2: "pan" },
+		options = { xnumber2: 1, xstring2: "x", xxx: "newstring" },
+		optionsCopy = { xnumber2: 1, xstring2: "x", xxx: "newstring" },
+		merged = { xnumber1: 5, xnumber2: 1, xstring1: "peter", xstring2: "x", xxx: "newstring" },
+		deep1 = { foo: { bar: true } },
+		deep1copy = { foo: { bar: true } },
+		deep2 = { foo: { baz: true }, foo2: document },
+		deep2copy = { foo: { baz: true }, foo2: document },
+		deepmerged = { foo: { bar: true, baz: true }, foo2: document };
+
+	jQuery.extend(settings, options);
+	isObj( settings, merged, "Check if extended: settings must be extended" );
+	isObj( options, optionsCopy, "Check if not modified: options must not be modified" );
+
+	jQuery.extend(settings, null, options);
+	isObj( settings, merged, "Check if extended: settings must be extended" );
+	isObj( options, optionsCopy, "Check if not modified: options must not be modified" );
+
+	jQuery.extend(true, deep1, deep2);
+	isObj( deep1.foo, deepmerged.foo, "Check if foo: settings must be extended" );
+	isObj( deep2.foo, deep2copy.foo, "Check if not deep2: options must not be modified" );
+	equals( deep1.foo2, document, "Make sure that a deep clone was not attempted on the document" );
+
+	var nullUndef;
+	nullUndef = jQuery.extend({}, options, { xnumber2: null });
+	ok( nullUndef.xnumber2 === null, "Check to make sure null values are copied");
+
+	nullUndef = jQuery.extend({}, options, { xnumber2: undefined });
+	ok( nullUndef.xnumber2 === options.xnumber2, "Check to make sure undefined values are not copied");
+
+	nullUndef = jQuery.extend({}, options, { xnumber0: null });
+	ok( nullUndef.xnumber0 === null, "Check to make sure null values are inserted");
+
+	var target = {};
+	var recursive = { foo:target, bar:5 };
+	jQuery.extend(true, target, recursive);
+	isObj( target, { bar:5 }, "Check to make sure a recursive obj doesn't go never-ending loop by not copying it over" );
+
+	var ret = jQuery.extend(true, { foo: [] }, { foo: [0] } ); // 1907
+	equals( ret.foo.length, 1, "Check to make sure a value with coersion 'false' copies over when necessary to fix #1907" );
+
+	var ret = jQuery.extend(true, { foo: "1,2,3" }, { foo: [1, 2, 3] } );
+	ok( typeof ret.foo != "string", "Check to make sure values equal with coersion (but not actually equal) overwrite correctly" );
+
+	var ret = jQuery.extend(true, { foo:"bar" }, { foo:null } );
+	ok( typeof ret.foo !== 'undefined', "Make sure a null value doesn't crash with deep extend, for #1908" );
+
+	var obj = { foo:null };
+	jQuery.extend(true, obj, { foo:"notnull" } );
+	equals( obj.foo, "notnull", "Make sure a null value can be overwritten" );
+
+	function func() {}
+	jQuery.extend(func, { key: "value" } );
+	equals( func.key, "value", "Verify a function can be extended" );
+
+	var defaults = { xnumber1: 5, xnumber2: 7, xstring1: "peter", xstring2: "pan" },
+		defaultsCopy = { xnumber1: 5, xnumber2: 7, xstring1: "peter", xstring2: "pan" },
+		options1 = { xnumber2: 1, xstring2: "x" },
+		options1Copy = { xnumber2: 1, xstring2: "x" },
+		options2 = { xstring2: "xx", xxx: "newstringx" },
+		options2Copy = { xstring2: "xx", xxx: "newstringx" },
+		merged2 = { xnumber1: 5, xnumber2: 1, xstring1: "peter", xstring2: "xx", xxx: "newstringx" };
+
+	var settings = jQuery.extend({}, defaults, options1, options2);
+	isObj( settings, merged2, "Check if extended: settings must be extended" );
+	isObj( defaults, defaultsCopy, "Check if not modified: options1 must not be modified" );
+	isObj( options1, options1Copy, "Check if not modified: options1 must not be modified" );
+	isObj( options2, options2Copy, "Check if not modified: options2 must not be modified" );
+});
+
+test("val()", function() {
+	expect(4);
+	equals( $("#text1").val(), "Test", "Check for value of input element" );
+	equals( !$("#text1").val(), "", "Check for value of input element" );
+	// ticket #1714 this caused a JS error in IE
+	equals( $("#first").val(), "", "Check a paragraph element to see if it has a value" );
+	ok( $([]).val() === undefined, "Check an empty jQuery object will return undefined from val" );
+});
+
+test("val(String)", function() {
+	expect(4);
+	document.getElementById('text1').value = "bla";
+	equals( $("#text1").val(), "bla", "Check for modified value of input element" );
+	$("#text1").val('test');
+	ok ( document.getElementById('text1').value == "test", "Check for modified (via val(String)) value of input element" );
+
+	$("#select1").val("3");
+	equals( $("#select1").val(), "3", "Check for modified (via val(String)) value of select element" );
+
+	// using contents will get comments regular, text, and comment nodes
+	var j = $("#nonnodes").contents();
+	j.val("asdf");
+	equals( j.val(), "asdf", "Check node,textnode,comment with val()" );
+	j.removeAttr("value");
+});
+
+var scriptorder = 0;
+
+test("html(String)", function() {
+	expect(11);
+	var div = $("#main > div");
+	div.html("<b>test</b>");
+	var pass = true;
+	for ( var i = 0; i < div.size(); i++ ) {
+		if ( div.get(i).childNodes.length != 1 ) pass = false;
+	}
+	ok( pass, "Set HTML" );
+
+	reset();
+	// using contents will get comments regular, text, and comment nodes
+	var j = $("#nonnodes").contents();
+	j.html("<b>bold</b>");
+
+	// this is needed, or the expando added by jQuery unique will yield a different html
+	j.find('b').removeData();
+	equals( j.html().toLowerCase(), "<b>bold</b>", "Check node,textnode,comment with html()" );
+
+	$("#main").html("<select/>");
+	$("#main select").html("<option>O1</option><option selected='selected'>O2</option><option>O3</option>");
+	equals( $("#main select").val(), "O2", "Selected option correct" );
+
+	stop();
+
+	$("#main").html('<script type="text/javascript">ok( true, "$().html().evalScripts() Evals Scripts Twice in Firefox, see #975" );</script>');
+
+	$("#main").html('foo <form><script type="text/javascript">ok( true, "$().html().evalScripts() Evals Scripts Twice in Firefox, see #975" );</script></form>');
+
+	// it was decided that waiting to execute ALL scripts makes sense since nested ones have to wait anyway so this test case is changed, see #1959
+	$("#main").html("<script>equals(scriptorder++, 0, 'Script is executed in order');equals($('#scriptorder').length, 1,'Execute after html (even though appears before)')<\/script><span id='scriptorder'><script>equals(scriptorder++, 1, 'Script (nested) is executed in order');equals($('#scriptorder').length, 1,'Execute after html')<\/script></span><script>equals(scriptorder++, 2, 'Script (unnested) is executed in order');equals($('#scriptorder').length, 1,'Execute after html')<\/script>");
+
+	setTimeout( start, 100 );
+});
+
+test("filter()", function() {
+	expect(6);
+	isSet( $("#form input").filter(":checked").get(), q("radio2", "check1"), "filter(String)" );
+	isSet( $("p").filter("#ap, #sndp").get(), q("ap", "sndp"), "filter('String, String')" );
+	isSet( $("p").filter("#ap,#sndp").get(), q("ap", "sndp"), "filter('String,String')" );
+	isSet( $("p").filter(function() { return !$("a", this).length }).get(), q("sndp", "first"), "filter(Function)" );
+
+	// using contents will get comments regular, text, and comment nodes
+	var j = $("#nonnodes").contents();
+	equals( j.filter("span").length, 1, "Check node,textnode,comment to filter the one span" );
+	equals( j.filter("[name]").length, 0, "Check node,textnode,comment to filter the one span" );
+});
+
+test("not()", function() {
+	expect(8);
+	equals( $("#main > p#ap > a").not("#google").length, 2, "not('selector')" );
+	equals( $("#main > p#ap > a").not(document.getElementById("google")).length, 2, "not(DOMElement)" );
+	isSet( $("p").not(".result").get(), q("firstp", "ap", "sndp", "en", "sap", "first"), "not('.class')" );
+	isSet( $("p").not("#ap, #sndp, .result").get(), q("firstp", "en", "sap", "first"), "not('selector, selector')" );
+	isSet( $("p").not($("#ap, #sndp, .result")).get(), q("firstp", "en", "sap", "first"), "not(jQuery)" );
+	equals( $("p").not(document.getElementsByTagName("p")).length, 0, "not(Array-like DOM collection)" );
+	isSet( $("#form option").not("option.emptyopt:contains('Nothing'),[selected],[value='1']").get(), q("option1c", "option1d", "option2c", "option3d" ), "not('complex selector')");
+
+	var selects = $("#form select");
+	isSet( selects.not( selects[1] ), q("select1", "select3"), "filter out DOM element");
+});
+
+test("andSelf()", function() {
+	expect(4);
+	isSet( $("#en").siblings().andSelf().get(), q("sndp", "sap","en"), "Check for siblings and self" );
+	isSet( $("#foo").children().andSelf().get(), q("sndp", "en", "sap", "foo"), "Check for children and self" );
+	isSet( $("#en, #sndp").parent().andSelf().get(), q("foo","en","sndp"), "Check for parent and self" );
+	isSet( $("#groups").parents("p, div").andSelf().get(), q("ap", "main", "groups"), "Check for parents and self" );
+});
+
+test("siblings([String])", function() {
+	expect(5);
+	isSet( $("#en").siblings().get(), q("sndp", "sap"), "Check for siblings" );
+	isSet( $("#sndp").siblings(":has(code)").get(), q("sap"), "Check for filtered siblings (has code child element)" );
+	isSet( $("#sndp").siblings(":has(a)").get(), q("en", "sap"), "Check for filtered siblings (has anchor child element)" );
+	isSet( $("#foo").siblings("form, b").get(), q("form", "lengthtest", "testForm", "floatTest"), "Check for multiple filters" );
+	isSet( $("#en, #sndp").siblings().get(), q("sndp", "sap", "en"), "Check for unique results from siblings" );
+});
+
+test("children([String])", function() {
+	expect(3);
+	isSet( $("#foo").children().get(), q("sndp", "en", "sap"), "Check for children" );
+	isSet( $("#foo").children(":has(code)").get(), q("sndp", "sap"), "Check for filtered children" );
+	isSet( $("#foo").children("#en, #sap").get(), q("en", "sap"), "Check for multiple filters" );
+});
+
+test("parent([String])", function() {
+	expect(5);
+	equals( $("#groups").parent()[0].id, "ap", "Simple parent check" );
+	equals( $("#groups").parent("p")[0].id, "ap", "Filtered parent check" );
+	equals( $("#groups").parent("div").length, 0, "Filtered parent check, no match" );
+	equals( $("#groups").parent("div, p")[0].id, "ap", "Check for multiple filters" );
+	isSet( $("#en, #sndp").parent().get(), q("foo"), "Check for unique results from parent" );
+});
+
+test("parents([String])", function() {
+	expect(5);
+	equals( $("#groups").parents()[0].id, "ap", "Simple parents check" );
+	equals( $("#groups").parents("p")[0].id, "ap", "Filtered parents check" );
+	equals( $("#groups").parents("div")[0].id, "main", "Filtered parents check2" );
+	isSet( $("#groups").parents("p, div").get(), q("ap", "main"), "Check for multiple filters" );
+	isSet( $("#en, #sndp").parents().get(), q("foo", "main", "dl", "body", "html"), "Check for unique results from parents" );
+});
+
+test("next([String])", function() {
+	expect(4);
+	equals( $("#ap").next()[0].id, "foo", "Simple next check" );
+	equals( $("#ap").next("div")[0].id, "foo", "Filtered next check" );
+	equals( $("#ap").next("p").length, 0, "Filtered next check, no match" );
+	equals( $("#ap").next("div, p")[0].id, "foo", "Multiple filters" );
+});
+
+test("prev([String])", function() {
+	expect(4);
+	equals( $("#foo").prev()[0].id, "ap", "Simple prev check" );
+	equals( $("#foo").prev("p")[0].id, "ap", "Filtered prev check" );
+	equals( $("#foo").prev("div").length, 0, "Filtered prev check, no match" );
+	equals( $("#foo").prev("p, div")[0].id, "ap", "Multiple filters" );
+});
+
+test("show()", function() {
+	expect(15);
+	var pass = true, div = $("div");
+	div.show().each(function(){
+		if ( this.style.display == "none" ) pass = false;
+	});
+	ok( pass, "Show" );
+
+	$("#main").append('<div id="show-tests"><div><p><a href="#"></a></p><code></code><pre></pre><span></span></div><table><thead><tr><th></th></tr></thead><tbody><tr><td></td></tr></tbody></table><ul><li></li></ul></div>');
+	var test = {
+		"div"      : "block",
+		"p"        : "block",
+		"a"        : "inline",
+		"code"     : "inline",
+		"pre"      : "block",
+		"span"     : "inline",
+		"table"    : $.browser.msie ? "block" : "table",
+		"thead"    : $.browser.msie ? "block" : "table-header-group",
+		"tbody"    : $.browser.msie ? "block" : "table-row-group",
+		"tr"       : $.browser.msie ? "block" : "table-row",
+		"th"       : $.browser.msie ? "block" : "table-cell",
+		"td"       : $.browser.msie ? "block" : "table-cell",
+		"ul"       : "block",
+		"li"       : $.browser.msie ? "block" : "list-item"
+	};
+
+	$.each(test, function(selector, expected) {
+		var elem = $(selector, "#show-tests").show();
+		equals( elem.css("display"), expected, "Show using correct display type for " + selector );
+	});
+});
+
+test("addClass(String)", function() {
+	expect(2);
+	var div = $("div");
+	div.addClass("test");
+	var pass = true;
+	for ( var i = 0; i < div.size(); i++ ) {
+	 if ( div.get(i).className.indexOf("test") == -1 ) pass = false;
+	}
+	ok( pass, "Add Class" );
+
+	// using contents will get regular, text, and comment nodes
+	var j = $("#nonnodes").contents();
+	j.addClass("asdf");
+	ok( j.hasClass("asdf"), "Check node,textnode,comment for addClass" );
+});
+
+test("removeClass(String) - simple", function() {
+	expect(4);
+	var div = $("div").addClass("test").removeClass("test"),
+		pass = true;
+	for ( var i = 0; i < div.size(); i++ ) {
+		if ( div.get(i).className.indexOf("test") != -1 ) pass = false;
+	}
+	ok( pass, "Remove Class" );
+
+	reset();
+	var div = $("div").addClass("test").addClass("foo").addClass("bar");
+	div.removeClass("test").removeClass("bar").removeClass("foo");
+	var pass = true;
+	for ( var i = 0; i < div.size(); i++ ) {
+	 if ( div.get(i).className.match(/test|bar|foo/) ) pass = false;
+	}
+	ok( pass, "Remove multiple classes" );
+
+	reset();
+	var div = $("div:eq(0)").addClass("test").removeClass("");
+	ok( div.is('.test'), "Empty string passed to removeClass" );
+
+	// using contents will get regular, text, and comment nodes
+	var j = $("#nonnodes").contents();
+	j.removeClass("asdf");
+	ok( !j.hasClass("asdf"), "Check node,textnode,comment for removeClass" );
+});
+
+test("toggleClass(String)", function() {
+	expect(3);
+	var e = $("#firstp");
+	ok( !e.is(".test"), "Assert class not present" );
+	e.toggleClass("test");
+	ok( e.is(".test"), "Assert class present" );
+	e.toggleClass("test");
+	ok( !e.is(".test"), "Assert class not present" );
+});
+
+test("removeAttr(String", function() {
+	expect(1);
+	equals( $('#mark').removeAttr("class")[0].className, "", "remove class" );
+});
+
+test("text(String)", function() {
+	expect(4);
+	equals( $("#foo").text("<div><b>Hello</b> cruel world!</div>")[0].innerHTML, "&lt;div&gt;&lt;b&gt;Hello&lt;/b&gt; cruel world!&lt;/div&gt;", "Check escaped text" );
+
+	// using contents will get comments regular, text, and comment nodes
+	var j = $("#nonnodes").contents();
+	j.text("hi!");
+	equals( $(j[0]).text(), "hi!", "Check node,textnode,comment with text()" );
+	equals( j[1].nodeValue, " there ", "Check node,textnode,comment with text()" );
+	equals( j[2].nodeType, 8, "Check node,textnode,comment with text()" );
+});
+
+test("$.each(Object,Function)", function() {
+	expect(12);
+	$.each( [0,1,2], function(i, n){
+		equals( i, n, "Check array iteration" );
+	});
+
+	$.each( [5,6,7], function(i, n){
+		equals( i, n - 5, "Check array iteration" );
+	});
+
+	$.each( { name: "name", lang: "lang" }, function(i, n){
+		equals( i, n, "Check object iteration" );
+	});
+
+        var total = 0;
+        jQuery.each([1,2,3], function(i,v){ total += v; });
+        equals( total, 6, "Looping over an array" );
+        total = 0;
+        jQuery.each([1,2,3], function(i,v){ total += v; if ( i == 1 ) return false; });
+        equals( total, 3, "Looping over an array, with break" );
+        total = 0;
+        jQuery.each({"a":1,"b":2,"c":3}, function(i,v){ total += v; });
+        equals( total, 6, "Looping over an object" );
+        total = 0;
+        jQuery.each({"a":3,"b":3,"c":3}, function(i,v){ total += v; return false; });
+        equals( total, 3, "Looping over an object, with break" );
+});
+
+test("$.prop", function() {
+	expect(2);
+	var handle = function() { return this.id };
+	equals( $.prop($("#ap")[0], handle), "ap", "Check with Function argument" );
+	equals( $.prop($("#ap")[0], "value"), "value", "Check with value argument" );
+});
+
+test("$.className", function() {
+	expect(6);
+	var x = $("<p>Hi</p>")[0];
+	var c = $.className;
+	c.add(x, "hi");
+	equals( x.className, "hi", "Check single added class" );
+	c.add(x, "foo bar");
+	equals( x.className, "hi foo bar", "Check more added classes" );
+	c.remove(x);
+	equals( x.className, "", "Remove all classes" );
+	c.add(x, "hi foo bar");
+	c.remove(x, "foo");
+	equals( x.className, "hi bar", "Check removal of one class" );
+	ok( c.has(x, "hi"), "Check has1" );
+	ok( c.has(x, "bar"), "Check has2" );
+});
+
+test("$.data", function() {
+	expect(5);
+	var div = $("#foo")[0];
+	equals( jQuery.data(div, "test"), undefined, "Check for no data exists" );
+	jQuery.data(div, "test", "success");
+	equals( jQuery.data(div, "test"), "success", "Check for added data" );
+	jQuery.data(div, "test", "overwritten");
+	equals( jQuery.data(div, "test"), "overwritten", "Check for overwritten data" );
+	jQuery.data(div, "test", undefined);
+	equals( jQuery.data(div, "test"), "overwritten", "Check that data wasn't removed");
+	jQuery.data(div, "test", null);
+	ok( jQuery.data(div, "test") === null, "Check for null data");
+});
+
+test(".data()", function() {
+	expect(18);
+	var div = $("#foo");
+	equals( div.data("test"), undefined, "Check for no data exists" );
+	div.data("test", "success");
+	equals( div.data("test"), "success", "Check for added data" );
+	div.data("test", "overwritten");
+	equals( div.data("test"), "overwritten", "Check for overwritten data" );
+	div.data("test", undefined);
+	equals( div.data("test"), "overwritten", "Check that data wasn't removed");
+	div.data("test", null);
+	ok( div.data("test") === null, "Check for null data");
+
+	div.data("test", "overwritten");
+	var hits = {test:0}, gets = {test:0};
+
+	div
+		.bind("setData",function(e,key,value){ hits[key] += value; })
+		.bind("setData.foo",function(e,key,value){ hits[key] += value; })
+		.bind("getData",function(e,key){ gets[key] += 1; })
+		.bind("getData.foo",function(e,key){ gets[key] += 3; });
+
+	div.data("test.foo", 2);
+	equals( div.data("test"), "overwritten", "Check for original data" );
+	equals( div.data("test.foo"), 2, "Check for namespaced data" );
+	equals( div.data("test.bar"), "overwritten", "Check for unmatched namespace" );
+	equals( hits.test, 2, "Check triggered setter functions" );
+	equals( gets.test, 5, "Check triggered getter functions" );
+
+	hits.test = 0;
+	gets.test = 0;
+
+	div.data("test", 1);
+	equals( div.data("test"), 1, "Check for original data" );
+	equals( div.data("test.foo"), 2, "Check for namespaced data" );
+	equals( div.data("test.bar"), 1, "Check for unmatched namespace" );
+	equals( hits.test, 1, "Check triggered setter functions" );
+	equals( gets.test, 5, "Check triggered getter functions" );
+
+	hits.test = 0;
+	gets.test = 0;
+
+	div
+		.bind("getData",function(e,key){ return key + "root"; })
+		.bind("getData.foo",function(e,key){ return key + "foo"; });
+
+	equals( div.data("test"), "testroot", "Check for original data" );
+	equals( div.data("test.foo"), "testfoo", "Check for namespaced data" );
+	equals( div.data("test.bar"), "testroot", "Check for unmatched namespace" );
+});
+
+test("$.removeData", function() {
+	expect(1);
+	var div = $("#foo")[0];
+	jQuery.data(div, "test", "testing");
+	jQuery.removeData(div, "test");
+	equals( jQuery.data(div, "test"), undefined, "Check removal of data" );
+});
+
+test(".removeData()", function() {
+	expect(6);
+	var div = $("#foo");
+	div.data("test", "testing");
+	div.removeData("test");
+	equals( div.data("test"), undefined, "Check removal of data" );
+
+	div.data("test", "testing");
+	div.data("test.foo", "testing2");
+	div.removeData("test.bar");
+	equals( div.data("test.foo"), "testing2", "Make sure data is intact" );
+	equals( div.data("test"), "testing", "Make sure data is intact" );
+
+	div.removeData("test");
+	equals( div.data("test.foo"), "testing2", "Make sure data is intact" );
+	equals( div.data("test"), undefined, "Make sure data is intact" );
+
+	div.removeData("test.foo");
+	equals( div.data("test.foo"), undefined, "Make sure data is intact" );
+});
+
+test("remove()", function() {
+	expect(6);
+	$("#ap").children().remove();
+	ok( $("#ap").text().length > 10, "Check text is not removed" );
+	equals( $("#ap").children().length, 0, "Check remove" );
+
+	reset();
+	$("#ap").children().remove("a");
+	ok( $("#ap").text().length > 10, "Check text is not removed" );
+	equals( $("#ap").children().length, 1, "Check filtered remove" );
+
+	// using contents will get comments regular, text, and comment nodes
+	equals( $("#nonnodes").contents().length, 3, "Check node,textnode,comment remove works" );
+	$("#nonnodes").contents().remove();
+	equals( $("#nonnodes").contents().length, 0, "Check node,textnode,comment remove works" );
+});
+
+test("empty()", function() {
+	expect(3);
+	equals( $("#ap").children().empty().text().length, 0, "Check text is removed" );
+	equals( $("#ap").children().length, 4, "Check elements are not removed" );
+
+	// using contents will get comments regular, text, and comment nodes
+	var j = $("#nonnodes").contents();
+	j.empty();
+	equals( j.html(), "", "Check node,textnode,comment empty works" );
+});
+
+test("slice()", function() {
+	expect(5);
+	isSet( $("#ap a").slice(1,2), q("groups"), "slice(1,2)" );
+	isSet( $("#ap a").slice(1), q("groups", "anchor1", "mark"), "slice(1)" );
+	isSet( $("#ap a").slice(0,3), q("google", "groups", "anchor1"), "slice(0,3)" );
+	isSet( $("#ap a").slice(-1), q("mark"), "slice(-1)" );
+
+	isSet( $("#ap a").eq(1), q("groups"), "eq(1)" );
+});
+
+test("map()", function() {
+	expect(2);//expect(6);
+
+	isSet(
+		$("#ap").map(function(){
+			return $(this).find("a").get();
+		}),
+		q("google", "groups", "anchor1", "mark"),
+		"Array Map"
+	);
+
+	isSet(
+		$("#ap > a").map(function(){
+			return this.parentNode;
+		}),
+		q("ap","ap","ap"),
+		"Single Map"
+	);
+
+	return;//these haven't been accepted yet
+
+	//for #2616
+	var keys = $.map( {a:1,b:2}, function( v, k ){
+		return k;
+	}, [ ] );
+
+	equals( keys.join(""), "ab", "Map the keys from a hash to an array" );
+
+	var values = $.map( {a:1,b:2}, function( v, k ){
+		return v;
+	}, [ ] );
+
+	equals( values.join(""), "12", "Map the values from a hash to an array" );
+
+	var scripts = document.getElementsByTagName("script");
+	var mapped = $.map( scripts, function( v, k ){
+		return v;
+	}, {length:0} );
+
+	equals( mapped.length, scripts.length, "Map an array(-like) to a hash" );
+
+	var flat = $.map( Array(4), function( v, k ){
+		return k % 2 ? k : [k,k,k];//try mixing array and regular returns
+	});
+
+	equals( flat.join(""), "00012223", "try the new flatten technique(#2616)" );
+});
+
+test("contents()", function() {
+	expect(12);
+	equals( $("#ap").contents().length, 9, "Check element contents" );
+	ok( $("#iframe").contents()[0], "Check existance of IFrame document" );
+	var ibody = $("#loadediframe").contents()[0].body;
+	ok( ibody, "Check existance of IFrame body" );
+
+	equals( $("span", ibody).text(), "span text", "Find span in IFrame and check its text" );
+
+	$(ibody).append("<div>init text</div>");
+	equals( $("div", ibody).length, 2, "Check the original div and the new div are in IFrame" );
+
+	equals( $("div:last", ibody).text(), "init text", "Add text to div in IFrame" );
+
+	$("div:last", ibody).text("div text");
+	equals( $("div:last", ibody).text(), "div text", "Add text to div in IFrame" );
+
+	$("div:last", ibody).remove();
+	equals( $("div", ibody).length, 1, "Delete the div and check only one div left in IFrame" );
+
+	equals( $("div", ibody).text(), "span text", "Make sure the correct div is still left after deletion in IFrame" );
+
+	$("<table/>", ibody).append("<tr><td>cell</td></tr>").appendTo(ibody);
+	$("table", ibody).remove();
+	equals( $("div", ibody).length, 1, "Check for JS error on add and delete of a table in IFrame" );
+
+	// using contents will get comments regular, text, and comment nodes
+	var c = $("#nonnodes").contents().contents();
+	equals( c.length, 1, "Check node,textnode,comment contents is just one" );
+	equals( c[0].nodeValue, "hi", "Check node,textnode,comment contents is just the one from span" );
+});
+
+test("$.makeArray", function(){
+	expect(15);
+
+	equals( $.makeArray($('html>*'))[0].nodeName, "HEAD", "Pass makeArray a jQuery object" );
+
+	equals( $.makeArray(document.getElementsByName("PWD")).slice(0,1)[0].name, "PWD", "Pass makeArray a nodelist" );
+
+	equals( (function(){ return $.makeArray(arguments); })(1,2).join(""), "12", "Pass makeArray an arguments array" );
+
+	equals( $.makeArray([1,2,3]).join(""), "123", "Pass makeArray a real array" );
+
+	equals( $.makeArray().length, 0, "Pass nothing to makeArray and expect an empty array" );
+
+	equals( $.makeArray( 0 )[0], 0 , "Pass makeArray a number" );
+
+	equals( $.makeArray( "foo" )[0], "foo", "Pass makeArray a string" );
+
+	equals( $.makeArray( true )[0].constructor, Boolean, "Pass makeArray a boolean" );
+
+	equals( $.makeArray( document.createElement("div") )[0].nodeName, "DIV", "Pass makeArray a single node" );
+
+	equals( $.makeArray( {length:2, 0:"a", 1:"b"} ).join(""), "ab", "Pass makeArray an array like map (with length)" );
+
+	equals( $.makeArray( document.documentElement.childNodes ).slice(0,1)[0].nodeName, "HEAD", "Pass makeArray a childNodes array" );
+
+	//function, is tricky as it has length
+	equals( $.makeArray( function(){ return 1;} )[0](), 1, "Pass makeArray a function" );
+	//window, also has length
+	equals( $.makeArray(window)[0], window, "Pass makeArray the window" );
+
+	equals( $.makeArray(/a/)[0].constructor, RegExp, "Pass makeArray a regex" );
+
+	ok( $.makeArray(document.getElementById('form')).length >= 13, "Pass makeArray a form (treat as elements)" );
+});
diff --git a/dom/tests/mochitest/ajax/jquery/test/unit/dimensions.js b/dom/tests/mochitest/ajax/jquery/test/unit/dimensions.js
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/unit/dimensions.js
@@ -0,0 +1,86 @@
+module("dimensions");
+
+test("innerWidth()", function() {
+	expect(3);
+
+	var $div = $("#nothiddendiv");
+	// set styles
+	$div.css({
+		margin: 10,
+		border: "2px solid #fff",
+		width: 30
+	});
+	
+	equals($div.innerWidth(), 30, "Test with margin and border");
+	$div.css("padding", "20px");
+	equals($div.innerWidth(), 70, "Test with margin, border and padding");
+	$div.hide();
+	equals($div.innerWidth(), 70, "Test hidden div");
+	
+	// reset styles
+	$div.css({ display: "", border: "", padding: "", width: "", height: "" });
+});
+
+test("innerHeight()", function() {
+	expect(3);
+	
+	var $div = $("#nothiddendiv");
+	// set styles
+	$div.css({
+		margin: 10,
+		border: "2px solid #fff",
+		height: 30
+	});
+	
+	equals($div.innerHeight(), 30, "Test with margin and border");
+	$div.css("padding", "20px");
+	equals($div.innerHeight(), 70, "Test with margin, border and padding");
+	$div.hide();
+	equals($div.innerHeight(), 70, "Test hidden div");
+	
+	// reset styles
+	$div.css({ display: "", border: "", padding: "", width: "", height: "" });
+});
+
+test("outerWidth()", function() {
+	expect(6);
+	
+	var $div = $("#nothiddendiv");
+	$div.css("width", 30);
+	
+	equals($div.outerWidth(), 30, "Test with only width set");
+	$div.css("padding", "20px");
+	equals($div.outerWidth(), 70, "Test with padding");
+	$div.css("border", "2px solid #fff");
+	equals($div.outerWidth(), 74, "Test with padding and border");
+	$div.css("margin", "10px");
+	equals($div.outerWidth(), 74, "Test with padding, border and margin without margin option");
+	$div.css("position", "absolute");
+	equals($div.outerWidth(true), 94, "Test with padding, border and margin with margin option");
+	$div.hide();
+	equals($div.outerWidth(true), 94, "Test hidden div with padding, border and margin with margin option");
+	
+	// reset styles
+	$div.css({ position: "", display: "", border: "", padding: "", width: "", height: "" });
+});
+
+test("outerHeight()", function() {
+	expect(6);
+	
+	var $div = $("#nothiddendiv");
+	$div.css("height", 30);
+	
+	equals($div.outerHeight(), 30, "Test with only width set");
+	$div.css("padding", "20px");
+	equals($div.outerHeight(), 70, "Test with padding");
+	$div.css("border", "2px solid #fff");
+	equals($div.outerHeight(), 74, "Test with padding and border");
+	$div.css("margin", "10px");
+	equals($div.outerHeight(), 74, "Test with padding, border and margin without margin option");
+	equals($div.outerHeight(true), 94, "Test with padding, border and margin with margin option");
+	$div.hide();
+	equals($div.outerHeight(true), 94, "Test hidden div with padding, border and margin with margin option");
+	
+	// reset styles
+	$div.css({ display: "", border: "", padding: "", width: "", height: "" });
+});
\ No newline at end of file
diff --git a/dom/tests/mochitest/ajax/jquery/test/unit/event.js b/dom/tests/mochitest/ajax/jquery/test/unit/event.js
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/unit/event.js
@@ -0,0 +1,348 @@
+module("event");
+
+test("bind(), with data", function() {
+	expect(3);
+	var handler = function(event) {
+		ok( event.data, "bind() with data, check passed data exists" );
+		equals( event.data.foo, "bar", "bind() with data, Check value of passed data" );
+	};
+	$("#firstp").bind("click", {foo: "bar"}, handler).click().unbind("click", handler);
+
+	ok( !jQuery.data($("#firstp")[0], "events"), "Event handler unbound when using data." );
+});
+
+test("bind(), with data, trigger with data", function() {
+	expect(4);
+	var handler = function(event, data) {
+		ok( event.data, "check passed data exists" );
+		equals( event.data.foo, "bar", "Check value of passed data" );
+		ok( data, "Check trigger data" );
+		equals( data.bar, "foo", "Check value of trigger data" );
+	};
+	$("#firstp").bind("click", {foo: "bar"}, handler).trigger("click", [{bar: "foo"}]).unbind("click", handler);
+});
+
+test("bind(), multiple events at once", function() {
+	expect(2);
+	var clickCounter = 0,
+		mouseoverCounter = 0;
+	var handler = function(event) {
+		if (event.type == "click")
+			clickCounter += 1;
+		else if (event.type == "mouseover")
+			mouseoverCounter += 1;
+	};
+	$("#firstp").bind("click mouseover", handler).trigger("click").trigger("mouseover");
+	equals( clickCounter, 1, "bind() with multiple events at once" );
+	equals( mouseoverCounter, 1, "bind() with multiple events at once" );
+});
+
+test("bind(), no data", function() {
+	expect(1);
+	var handler = function(event) {
+		ok ( !event.data, "Check that no data is added to the event object" );
+	};
+	$("#firstp").bind("click", handler).trigger("click");
+});
+
+test("bind(), iframes", function() {
+	// events don't work with iframes, see #939 - this test fails in IE because of contentDocument
+	// var doc = document.getElementById("iframe").contentDocument;
+	// 
+	// doc.body.innerHTML = "<input type='text'/>";
+	//
+	// var input = doc.getElementsByTagName("input")[0];
+	//
+	// $(input).bind("click",function() {
+	// 	ok( true, "Binding to element inside iframe" );
+	// }).click();
+});
+
+test("bind(), trigger change on select", function() {
+	expect(3);
+	var counter = 0;
+	function selectOnChange(event) {
+		equals( event.data, counter++, "Event.data is not a global event object" );
+	};
+	$("#form select").each(function(i){
+		$(this).bind('change', i, selectOnChange);
+	}).trigger('change');
+});
+
+test("bind(), namespaced events, cloned events", function() {
+	expect(6);
+
+	$("#firstp").bind("custom.test",function(e){
+		ok(true, "Custom event triggered");
+	});
+
+	$("#firstp").bind("click",function(e){
+		ok(true, "Normal click triggered");
+	});
+
+	$("#firstp").bind("click.test",function(e){
+		ok(true, "Namespaced click triggered");
+	});
+
+	// Trigger both bound fn (2)
+	$("#firstp").trigger("click");
+
+	// Trigger one bound fn (1)
+	$("#firstp").trigger("click.test");
+
+	// Remove only the one fn
+	$("#firstp").unbind("click.test");
+
+	// Trigger the remaining fn (1)
+	$("#firstp").trigger("click");
+
+	// Remove the remaining fn
+	$("#firstp").unbind(".test");
+
+	// Trigger the remaining fn (0)
+	$("#firstp").trigger("custom");
+
+	// using contents will get comments regular, text, and comment nodes
+	$("#nonnodes").contents().bind("tester", function () {
+		equals(this.nodeType, 1, "Check node,textnode,comment bind just does real nodes" );
+	}).trigger("tester");
+
+	// Make sure events stick with appendTo'd elements (which are cloned) #2027
+	$("<a href='#fail' class='test'>test</a>").click(function(){ return false; }).appendTo("p");
+	ok( $("a.test:first").triggerHandler("click") === false, "Handler is bound to appendTo'd elements" );
+});
+
+test("trigger() shortcuts", function() {
+	expect(6);
+	$('<li><a href="#">Change location</a></li>').prependTo('#firstUL').find('a').bind('click', function() {
+		var close = $('spanx', this); // same with $(this).find('span');
+		equals( close.length, 0, "Context element does not exist, length must be zero" );
+		ok( !close[0], "Context element does not exist, direct access to element must return undefined" );
+		return false;
+	}).click();
+	
+	$("#check1").click(function() {
+		ok( true, "click event handler for checkbox gets fired twice, see #815" );
+	}).click();
+	
+	var counter = 0;
+	$('#firstp')[0].onclick = function(event) {
+		counter++;
+	};
+	$('#firstp').click();
+	equals( counter, 1, "Check that click, triggers onclick event handler also" );
+	
+	var clickCounter = 0;
+	$('#simon1')[0].onclick = function(event) {
+		clickCounter++;
+	};
+	$('#simon1').click();
+	equals( clickCounter, 1, "Check that click, triggers onclick event handler on an a tag also" );
+	
+	$('<img />').load(function(){
+		ok( true, "Trigger the load event, using the shortcut .load() (#2819)");
+	}).load();
+});
+
+test("unbind(event)", function() {
+	expect(8);
+	var el = $("#firstp");
+	el.click(function() {
+		ok( true, "Fake normal bind" );
+	});
+	el.click(function(event) {
+		el.unbind(event);
+		ok( true, "Fake onebind" );
+	});
+	el.click().click();
+	
+	el.click(function() { return; });
+	el.unbind('click');
+	ok( !el[0].onclick, "Handler is removed" ); // Bug #964
+
+	el.click(function() { return; });
+	el.unbind('change',function(){ return; });
+	for (var ret in jQuery.data(el[0], "events")['click']) break;
+	ok( ret, "Extra handlers weren't accidentally removed." );
+
+	el.unbind('click');
+	ok( !jQuery.data(el[0], "events"), "Removed the events expando after all handlers are unbound." );
+	
+	reset();
+	var clickCounter = (mouseoverCounter = 0);
+	var handler = function(event) {
+		if (event.type == "click")
+			clickCounter += 1;
+		else if (event.type == "mouseover")
+			mouseoverCounter += 1;
+	};
+	$("#firstp").bind("click mouseover", handler).unbind("click mouseover", handler).trigger("click").trigger("mouseover");
+	equals( clickCounter, 0, "unbind() with multiple events at once" );
+	equals( mouseoverCounter, 0, "unbind() with multiple events at once" );
+});
+
+test("trigger(event, [data], [fn])", function() {
+	expect(67);
+
+	var handler = function(event, a, b, c) {
+		equals( event.type, "click", "check passed data" );
+		equals( a, 1, "check passed data" );
+		equals( b, "2", "check passed data" );
+		equals( c, "abc", "check passed data" );
+		return "test";
+	};
+
+	var handler2 = function(a, b, c) {
+		equals( a, 1, "check passed data" );
+		equals( b, "2", "check passed data" );
+		equals( c, "abc", "check passed data" );
+		return false;
+	};
+
+	var handler3 = function(a, b, c, v) {
+		equals( a, 1, "check passed data" );
+		equals( b, "2", "check passed data" );
+		equals( c, "abc", "check passed data" );
+		equals( v, "test", "check current value" );
+		return "newVal";
+	};
+
+	var handler4 = function(a, b, c, v) {
+		equals( a, 1, "check passed data" );
+		equals( b, "2", "check passed data" );
+		equals( c, "abc", "check passed data" );
+		equals( v, "test", "check current value" );
+	};
+
+	// Simulate a "native" click
+	$("#firstp")[0].click = function(){
+		ok( true, "Native call was triggered" );
+	};
+
+	// Triggers handlrs and native
+	// Trigger 5
+	$("#firstp").bind("click", handler).trigger("click", [1, "2", "abc"]);
+
+	// Triggers handlers, native, and extra fn
+	// Triggers 9
+	$("#firstp").trigger("click", [1, "2", "abc"], handler4);
+
+	// Simulate a "native" click
+	$("#firstp")[0].click = function(){
+		ok( false, "Native call was triggered" );
+	};
+
+	// Triggers handlers, native, and extra fn
+	// Triggers 7
+	$("#firstp").trigger("click", [1, "2", "abc"], handler2);
+
+	// Trigger only the handlers (no native)
+	// Triggers 5
+	equals( $("#firstp").triggerHandler("click", [1, "2", "abc"]), "test", "Verify handler response" );
+
+	// Trigger only the handlers (no native) and extra fn
+	// Triggers 8
+	equals( $("#firstp").triggerHandler("click", [1, "2", "abc"], handler2), false, "Verify handler response" );
+
+	// Build fake click event to pass in
+	var eventObj = jQuery.event.fix({ type: "foo", target: document.body });
+
+	// Trigger only the handlers (no native), with external event obj
+	// Triggers 5
+	equals( $("#firstp").triggerHandler("click", [eventObj, 1, "2", "abc"]), "test", "Verify handler response" );
+
+	// Trigger only the handlers (no native) and extra fn, with external event obj
+	// Triggers 9
+	eventObj = jQuery.event.fix({ type: "foo", target: document.body });
+	equals( $("#firstp").triggerHandler("click", [eventObj, 1, "2", "abc"], handler), "test", "Verify handler response" );
+	
+	var pass = true;
+	try {
+		$('input:first')
+			.hide()
+			.trigger('focus');
+	} catch(e) {
+		pass = false;
+	}
+	ok( pass, "Trigger focus on hidden element" );
+
+	// have the extra handler override the return
+	// Triggers 9
+	equals( $("#firstp").triggerHandler("click", [1, "2", "abc"], handler3), "newVal", "Verify triggerHandler return is overwritten by extra function" );
+
+	// have the extra handler leave the return value alone
+	// Triggers 9
+	equals( $("#firstp").triggerHandler("click", [1, "2", "abc"], handler4), "test", "Verify triggerHandler return is not overwritten by extra function" );
+});
+
+test("toggle(Function, Function, ...)", function() {
+	expect(11);
+	
+	var count = 0,
+		fn1 = function(e) { count++; },
+		fn2 = function(e) { count--; },
+		preventDefault = function(e) { e.preventDefault() },
+		link = $('#mark');
+	link.click(preventDefault).click().toggle(fn1, fn2).click().click().click().click().click();
+	equals( count, 1, "Check for toggle(fn, fn)" );
+
+	$("#firstp").toggle(function () {
+		equals(arguments.length, 4, "toggle correctly passes through additional triggered arguments, see #1701" )
+	}, function() {}).trigger("click", [ 1, 2, 3 ]);
+
+	var first = 0;
+	$("#simon1").one("click", function() {
+		ok( true, "Execute event only once" );
+		$(this).toggle(function() {
+			equals( first++, 0, "toggle(Function,Function) assigned from within one('xxx'), see #1054" );
+		}, function() {
+			equals( first, 1, "toggle(Function,Function) assigned from within one('xxx'), see #1054" );
+		});
+		return false;
+	}).click().click().click();
+	
+	var turn = 0;
+	var fns = [
+		function(){
+			turn = 1;
+		},
+		function(){
+			turn = 2;
+		},
+		function(){
+			turn = 3;
+		}
+	];
+	
+	var $div = $("<div>&nbsp;</div>").toggle( fns[0], fns[1], fns[2] );
+	$div.click();
+	equals( turn, 1, "Trying toggle with 3 functions, attempt 1 yields 1");
+	$div.click();
+	equals( turn, 2, "Trying toggle with 3 functions, attempt 2 yields 2");
+	$div.click();
+	equals( turn, 3, "Trying toggle with 3 functions, attempt 3 yields 3");
+	$div.click();
+	equals( turn, 1, "Trying toggle with 3 functions, attempt 4 yields 1");
+	$div.click();
+	equals( turn, 2, "Trying toggle with 3 functions, attempt 5 yields 2");
+	
+	$div.unbind('click',fns[0]);
+	var data = $.data( $div[0], 'events' );
+	ok( !data, "Unbinding one function from toggle unbinds them all");
+});
+
+test("jQuery(function($) {})", function() {
+	stop();
+	jQuery(function($) {
+		equals(jQuery, $, "ready doesn't provide an event object, instead it provides a reference to the jQuery function, see http://docs.jquery.com/Events/ready#fn");
+		start();
+	});
+});
+
+test("event properties", function() {
+	stop();
+	$("#simon1").click(function(event) {
+		ok( event.timeStamp, "assert event.timeStamp is present" );
+		start();
+	}).click();
+});
diff --git a/dom/tests/mochitest/ajax/jquery/test/unit/fx.js b/dom/tests/mochitest/ajax/jquery/test/unit/fx.js
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/unit/fx.js
@@ -0,0 +1,427 @@
+module("fx");
+
+test("animate(Hash, Object, Function)", function() {
+	expect(1);
+	stop();
+	var hash = {opacity: 'show'};
+	var hashCopy = $.extend({}, hash);
+	$('#foo').animate(hash, 0, function() {
+		equals( hash.opacity, hashCopy.opacity, 'Check if animate changed the hash parameter' );
+		start();
+	});
+});
+
+test("animate option (queue === false)", function () {
+	expect(1);
+	stop();
+
+	var order = [];
+
+	var $foo = $("#foo");
+	$foo.animate({width:'100px'}, 200, function () {
+		// should finish after unqueued animation so second
+		order.push(2);
+	});
+	$foo.animate({fontSize:'2em'}, {queue:false, duration:10, complete:function () {
+		// short duration and out of queue so should finish first
+		order.push(1);
+	}});
+	$foo.animate({height:'100px'}, 10, function() {
+		// queued behind the first animation so should finish third 
+		order.push(3);
+		isSet( order, [ 1, 2, 3], "Animations finished in the correct order" );
+		start();
+	});
+});
+
+test("queue() defaults to 'fx' type", function () {
+	expect(2);
+	stop();
+
+	var $foo = $("#foo");
+	$foo.queue("fx", [ "sample", "array" ]);
+	var arr = $foo.queue();
+	isSet(arr, [ "sample", "array" ], "queue() got an array set with type 'fx'");
+	$foo.queue([ "another", "one" ]);
+	var arr = $foo.queue("fx");
+	isSet(arr, [ "another", "one" ], "queue('fx') got an array set with no type");
+	// clean up after test
+	$foo.queue([]);
+
+	start();
+});
+
+test("stop()", function() {
+	expect(3);
+	stop();
+
+	var $foo = $("#nothiddendiv");
+	var w = 0;
+	$foo.hide().width(200).width();
+
+	$foo.animate({ width:'show' }, 1000);
+	setTimeout(function(){
+		var nw = $foo.width();
+		ok( nw != w, "An animation occurred " + nw + "px " + w + "px");
+		$foo.stop();
+
+		nw = $foo.width();
+		ok( nw != w, "Stop didn't reset the animation " + nw + "px " + w + "px");
+		setTimeout(function(){
+			equals( nw, $foo.width(), "The animation didn't continue" );
+			start();
+		}, 100);
+	}, 100);
+});
+
+test("stop() - several in queue", function() {
+	expect(4);
+	stop();
+
+	var $foo = $("#nothiddendiv");
+	var w = 0;
+	$foo.hide().width(200).width();
+
+	$foo.animate({ width:'show' }, 1000);
+	$foo.animate({ width:'hide' }, 1000);
+	$foo.animate({ width:'show' }, 1000);
+	setTimeout(function(){
+		equals( $foo.queue().length, 3, "All 3 still in the queue" );
+		var nw = $foo.width();
+		ok( nw != w, "An animation occurred " + nw + "px " + w + "px");
+		$foo.stop();
+
+		nw = $foo.width();
+		ok( nw != w, "Stop didn't reset the animation " + nw + "px " + w + "px");
+		equals( $foo.queue().length, 2, "The next animation continued" );
+		$foo.stop(true);
+		start();
+	}, 100);
+});
+
+test("stop(clearQueue)", function() {
+	expect(4);
+	stop();
+
+	var $foo = $("#nothiddendiv");
+	var w = 0;
+	$foo.hide().width(200).width();
+
+	$foo.animate({ width:'show' }, 1000);
+	$foo.animate({ width:'hide' }, 1000);
+	$foo.animate({ width:'show' }, 1000);
+	setTimeout(function(){
+		var nw = $foo.width();
+		ok( nw != w, "An animation occurred " + nw + "px " + w + "px");
+		$foo.stop(true);
+
+		nw = $foo.width();
+		ok( nw != w, "Stop didn't reset the animation " + nw + "px " + w + "px");
+
+		equals( $foo.queue().length, 0, "The animation queue was cleared" );
+		setTimeout(function(){
+			equals( nw, $foo.width(), "The animation didn't continue" );
+			start();
+		}, 100);
+	}, 100);
+});
+
+test("stop(clearQueue, gotoEnd)", function() {
+	expect(3);
+	stop();
+
+	var $foo = $("#nothiddendiv");
+	var w = 0;
+	$foo.hide().width(200).width();
+
+	$foo.animate({ width:'show' }, 1000);
+	$foo.animate({ width:'hide' }, 1000);
+	$foo.animate({ width:'show' }, 1000);
+	$foo.animate({ width:'hide' }, 1000);
+	setTimeout(function(){
+		var nw = $foo.width();
+		ok( nw != w, "An animation occurred " + nw + "px " + w + "px");
+		$foo.stop(false, true);
+
+		nw = $foo.width();
+		equals( nw, 200, "Stop() reset the animation" );
+
+		setTimeout(function(){
+			equals( $foo.queue().length, 3, "The next animation continued" );
+			$foo.stop(true);
+			start();
+		}, 100);
+	}, 100);
+});
+
+test("toggle()", function() {
+	expect(3);
+	var x = $("#foo");
+	ok( x.is(":visible"), "is visible" );
+	x.toggle();
+	ok( x.is(":hidden"), "is hidden" );
+	x.toggle();
+	ok( x.is(":visible"), "is visible again" );
+});
+
+var visible = {
+	Normal: function(elem){},
+	"CSS Hidden": function(elem){
+		$(this).addClass("hidden");
+	},
+	"JS Hidden": function(elem){
+		$(this).hide();
+	}
+};
+
+var from = {
+	"CSS Auto": function(elem,prop){
+		$(elem).addClass("auto" + prop)
+			.text("This is a long string of text.");
+		return "";
+	},
+	"JS Auto": function(elem,prop){
+		$(elem).css(prop,"auto")
+			.text("This is a long string of text.");
+		return "";
+	},
+	"CSS 100": function(elem,prop){
+		$(elem).addClass("large" + prop);
+		return "";
+	},
+	"JS 100": function(elem,prop){
+		$(elem).css(prop,prop == "opacity" ? 1 : "100px");
+		return prop == "opacity" ? 1 : 100;
+	},
+	"CSS 50": function(elem,prop){
+		$(elem).addClass("med" + prop);
+		return "";
+	},
+	"JS 50": function(elem,prop){
+		$(elem).css(prop,prop == "opacity" ? 0.50 : "50px");
+		return prop == "opacity" ? 0.5 : 50;
+	},
+	"CSS 0": function(elem,prop){
+		$(elem).addClass("no" + prop);
+		return "";
+	},
+	"JS 0": function(elem,prop){
+		$(elem).css(prop,prop == "opacity" ? 0 : "0px");
+		return 0;
+	}
+};
+
+var to = {
+	"show": function(elem,prop){
+		$(elem).hide().addClass("wide"+prop);
+		return "show";
+	},
+	"hide": function(elem,prop){
+		$(elem).addClass("wide"+prop);
+		return "hide";
+	},
+	"100": function(elem,prop){
+		$(elem).addClass("wide"+prop);
+		return prop == "opacity" ? 1 : 100;
+	},
+	"50": function(elem,prop){
+		return prop == "opacity" ? 0.50 : 50;
+	},
+	"0": function(elem,prop){
+		$(elem).addClass("noback");
+		return 0;
+	}
+};
+
+function checkOverflowDisplay(){
+	var o = jQuery.css( this, "overflow" );
+
+	equals(o, "visible", "Overflow should be visible: " + o);
+	equals(jQuery.css( this, "display" ), "inline", "Display shouldn't be tampered with.");
+
+	start();
+}
+
+test("JS Overflow and Display", function() {
+	expect(2);
+	stop();
+	makeTest( "JS Overflow and Display" )
+		.addClass("widewidth")
+		.css({ overflow: "visible", display: "inline" })
+		.addClass("widewidth")
+		.text("Some sample text.")
+		.before("text before")
+		.after("text after")
+		.animate({ opacity: 0.5 }, "slow", checkOverflowDisplay);
+});
+		
+test("CSS Overflow and Display", function() {
+	expect(2);
+	stop();
+	makeTest( "CSS Overflow and Display" )
+		.addClass("overflow inline")
+		.addClass("widewidth")
+		.text("Some sample text.")
+		.before("text before")
+		.after("text after")
+		.animate({ opacity: 0.5 }, "slow", checkOverflowDisplay);
+});
+
+jQuery.each( from, function(fn, f){
+	jQuery.each( to, function(tn, t){
+		test(fn + " to " + tn, function() {
+			var elem = makeTest( fn + " to " + tn );
+	
+			var t_w = t( elem, "width" );
+			var f_w = f( elem, "width" );
+			var t_h = t( elem, "height" );
+			var f_h = f( elem, "height" );
+			var t_o = t( elem, "opacity" );
+			var f_o = f( elem, "opacity" );
+			
+			var num = 0;
+			
+			if ( t_h == "show" ) num++;
+			if ( t_w == "show" ) num++;
+			if ( t_w == "hide"||t_w == "show" ) num++;
+			if ( t_h == "hide"||t_h == "show" ) num++;
+			if ( t_o == "hide"||t_o == "show" ) num++;
+			if ( t_w == "hide" ) num++;
+			if ( t_o.constructor == Number ) num += 2;
+			if ( t_w.constructor == Number ) num += 2;
+			if ( t_h.constructor == Number ) num +=2;
+			
+			expect(num);
+			stop();
+	
+			var anim = { width: t_w, height: t_h, opacity: t_o };
+	
+			elem.animate(anim, 50, function(){
+				if ( t_w == "show" )
+					equals( this.style.display, "block", "Showing, display should block: " + this.style.display);
+					
+				if ( t_w == "hide"||t_w == "show" )
+					equals(this.style.width.indexOf(f_w), 0, "Width must be reset to " + f_w + ": " + this.style.width);
+					
+				if ( t_h == "hide"||t_h == "show" )
+					equals(this.style.height.indexOf(f_h), 0, "Height must be reset to " + f_h + ": " + this.style.height);
+					
+				var cur_o = jQuery.attr(this.style, "opacity");
+				if ( cur_o !== "" ) cur_o = parseFloat( cur_o );
+	
+				if ( t_o == "hide"||t_o == "show" )
+					equals(cur_o, f_o, "Opacity must be reset to " + f_o + ": " + cur_o);
+					
+				if ( t_w == "hide" )
+					equals(this.style.display, "none", "Hiding, display should be none: " + this.style.display);
+					
+				if ( t_o.constructor == Number ) {
+					equals(cur_o, t_o, "Final opacity should be " + t_o + ": " + cur_o);
+					
+					ok(jQuery.curCSS(this, "opacity") != "" || cur_o == t_o, "Opacity should be explicitly set to " + t_o + ", is instead: " + cur_o);
+				}
+					
+				if ( t_w.constructor == Number ) {
+					equals(this.style.width, t_w + "px", "Final width should be " + t_w + ": " + this.style.width);
+					
+					var cur_w = jQuery.css(this,"width");
+
+					ok(this.style.width != "" || cur_w == t_w, "Width should be explicitly set to " + t_w + ", is instead: " + cur_w);
+				}
+					
+				if ( t_h.constructor == Number ) {
+					equals(this.style.height, t_h + "px", "Final height should be " + t_h + ": " + this.style.height);
+					
+					var cur_h = jQuery.css(this,"height");
+
+					ok(this.style.height != "" || cur_h == t_h, "Height should be explicitly set to " + t_h + ", is instead: " + cur_w);
+				}
+				
+				if ( t_h == "show" ) {
+					var old_h = jQuery.curCSS(this, "height");
+					$(elem).append("<br/>Some more text<br/>and some more...");
+					ok(old_h != jQuery.css(this, "height" ), "Make sure height is auto.");
+				}
+	
+				start();
+			});
+		});
+	});
+});
+
+var check = ['opacity','height','width','display','overflow'];
+
+jQuery.fn.saveState = function(){
+	expect(check.length);
+	stop();
+	return this.each(function(){
+		var self = this;
+		self.save = {};
+		jQuery.each(check, function(i,c){
+			self.save[c] = jQuery.css(self,c);
+		});
+	});
+};
+
+function checkState(){
+	var self = this;
+	jQuery.each(this.save, function(c,v){
+		var cur = jQuery.css(self,c);
+		equals( v, cur, "Make sure that " + c + " is reset (Old: " + v + " Cur: " + cur + ")");
+	});
+	start();
+}
+
+// Chaining Tests
+test("Chain fadeOut fadeIn", function() {
+	$('#fadein div').saveState().fadeOut('fast').fadeIn('fast',checkState);
+});
+test("Chain fadeIn fadeOut", function() {
+	$('#fadeout div').saveState().fadeIn('fast').fadeOut('fast',checkState);
+});
+
+test("Chain hide show", function() {
+	$('#show div').saveState().hide('fast').show('fast',checkState);
+});
+test("Chain show hide", function() {
+	$('#hide div').saveState().show('fast').hide('fast',checkState);
+});
+
+test("Chain toggle in", function() {
+	$('#togglein div').saveState().toggle('fast').toggle('fast',checkState);
+});
+test("Chain toggle out", function() {
+	$('#toggleout div').saveState().toggle('fast').toggle('fast',checkState);
+});
+
+test("Chain slideDown slideUp", function() {
+	$('#slidedown div').saveState().slideDown('fast').slideUp('fast',checkState);
+});
+test("Chain slideUp slideDown", function() {
+	$('#slideup div').saveState().slideUp('fast').slideDown('fast',checkState);
+});
+
+test("Chain slideToggle in", function() {
+	$('#slidetogglein div').saveState().slideToggle('fast').slideToggle('fast',checkState);
+});
+test("Chain slideToggle out", function() {
+	$('#slidetoggleout div').saveState().slideToggle('fast').slideToggle('fast',checkState);
+});
+
+function makeTest( text ){
+	var elem = $("<div></div>")
+		.attr("id", "test" + makeTest.id++)
+		.addClass("box");
+
+	$("<h4></h4>")
+		.text( text )
+		.appendTo("#fx-tests")
+		.click(function(){
+			$(this).next().toggle();
+		})
+		.after( elem );
+
+	return elem;
+}
+
+makeTest.id = 1;
diff --git a/dom/tests/mochitest/ajax/jquery/test/unit/offset.js b/dom/tests/mochitest/ajax/jquery/test/unit/offset.js
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/unit/offset.js
@@ -0,0 +1,164 @@
+module("offset");
+
+// opens a new window to run the tests against
+var testwin = function(name, fn) {
+	testwin[name] = load_offset_fixture(name);
+	var interval = setInterval(function() {
+		if (testwin[name] && testwin[name].$ && testwin[name].$.isReady) {
+			clearInterval(interval);
+			test(name, fn);
+		}
+	}, 0);
+	
+	function load_offset_fixture(name) {
+		var win = window.open( "./data/offset/" + name + ".html?num"+parseInt(Math.random()*1000), name, 'left=0,top=0,width=500,height=500,toolbar=1,resizable=0' );
+		if ( !win ) { 
+			alert("Please disable your popup blocker for the offset test suite");
+			throw "Please disable your popup blocker for the offset test suite";
+		}
+		return win;
+	}
+};
+
+testwin("absolute", function() {
+	var $w = testwin["absolute"].$;
+	
+	equals( $w('#absolute-1').offset().top, 1, "$('#absolute-1').offset().top" );
+	equals( $w('#absolute-1').offset().left, 1, "$('#absolute-1').offset().left" );
+	
+	equals( $w('#absolute-1-1').offset().top, 5, "$('#absolute-1-1').offset().top" );
+	equals( $w('#absolute-1-1').offset().left, 5, "$('#absolute-1-1').offset().left" );
+	
+	equals( $w('#absolute-1-1-1').offset().top, 9, "$('#absolute-1-1-1').offset().top" );
+	equals( $w('#absolute-1-1-1').offset().left, 9, "$('#absolute-1-1-1').offset().left" );
+	
+	equals( $w('#absolute-2').offset().top, 20, "$('#absolute-2').offset().top" );
+	equals( $w('#absolute-2').offset().left, 20, "$('#absolute-2').offset().left" );
+	
+	
+	equals( $w('#absolute-1').position().top, 0, "$('#absolute-1').position().top" );
+	equals( $w('#absolute-1').position().left, 0, "$('#absolute-1').position().left" );
+	
+	equals( $w('#absolute-1-1').position().top, 1, "$('#absolute-1-1').position().top" );
+	equals( $w('#absolute-1-1').position().left, 1, "$('#absolute-1-1').position().left" );
+	
+	equals( $w('#absolute-1-1-1').position().top, 1, "$('#absolute-1-1-1').position().top" );
+	equals( $w('#absolute-1-1-1').position().left, 1, "$('#absolute-1-1-1').position().left" );
+	
+	equals( $w('#absolute-2').position().top, 19, "$('#absolute-2').position().top" );
+	equals( $w('#absolute-2').position().left, 19, "$('#absolute-2').position().left" );
+	
+	testwin["absolute"].close();
+});
+
+testwin("relative", function() {
+	var $w = testwin["relative"].$;
+	
+	// IE is collapsing the top margin of 1px
+	equals( $w('#relative-1').offset().top, $.browser.msie ? 6 : 7, "$('#relative-1').offset().top" );
+	equals( $w('#relative-1').offset().left, 7, "$('#relative-1').offset().left" );
+	
+	// IE is collapsing the top margin of 1px
+	equals( $w('#relative-1-1').offset().top, $.browser.msie ? 13 : 15, "$('#relative-1-1').offset().top" );
+	equals( $w('#relative-1-1').offset().left, 15, "$('#relative-1-1').offset().left" );
+	
+	// IE is collapsing the top margin of 1px
+	equals( $w('#relative-2').offset().top, $.browser.msie ? 141 : 142, "$('#relative-2').offset().top" );
+	equals( $w('#relative-2').offset().left, 27, "$('#relative-2').offset().left" );
+	
+	
+	// IE is collapsing the top margin of 1px
+	equals( $w('#relative-1').position().top, $.browser.msie ? 5 : 6, "$('#relative-1').position().top" );
+	equals( $w('#relative-1').position().left, 6, "$('#relative-1').position().left" );
+	
+	// IE is collapsing the top margin of 1px
+	equals( $w('#relative-1-1').position().top, $.browser.msie ? 4 : 5, "$('#relative-1-1').position().top" );
+	equals( $w('#relative-1-1').position().left, 5, "$('#relative-1-1').position().left" );
+	
+	// IE is collapsing the top margin of 1px
+	equals( $w('#relative-2').position().top, $.browser.msie ? 140 : 141, "$('#relative-2').position().top" );
+	equals( $w('#relative-2').position().left, 26, "$('#relative-2').position().left" );
+	
+	testwin["relative"].close();
+});
+
+testwin("static", function() {
+	var $w = testwin["static"].$;
+	
+	// IE is collapsing the top margin of 1px
+	equals( $w('#static-1').offset().top, $.browser.msie ? 6 : 7, "$('#static-1').offset().top" );
+	equals( $w('#static-1').offset().left, 7, "$('#static-1').offset().left" );
+	
+	// IE is collapsing the top margin of 1px
+	equals( $w('#static-1-1').offset().top, $.browser.msie ? 13 : 15, "$('#static-1-1').offset().top" );
+	equals( $w('#static-1-1').offset().left, 15, "$('#static-1-1').offset().left" );
+	
+	// IE is collapsing the top margin of 1px
+	equals( $w('#static-1-1-1').offset().top, $.browser.msie ? 20 : 23, "$('#static-1-1-1').offset().top" );
+	equals( $w('#static-1-1-1').offset().left, 23, "$('#static-1-1-1').offset().left" );
+	
+	// IE is collapsing the top margin of 1px
+	equals( $w('#static-2').offset().top, $.browser.msie ? 121 : 122, "$('#static-2').offset().top" );
+	equals( $w('#static-2').offset().left, 7, "$('#static-2').offset().left" );
+	
+	
+	// IE is collapsing the top margin of 1px
+	equals( $w('#static-1').position().top, $.browser.msie ? 5 : 6, "$('#static-1').position().top" );
+	equals( $w('#static-1').position().left, 6, "$('#static-1').position().left" );
+	
+	// IE is collapsing the top margin of 1px
+	equals( $w('#static-1-1').position().top, $.browser.msie ? 12 : 14, "$('#static-1-1').position().top" );
+	equals( $w('#static-1-1').position().left, 14, "$('#static-1-1').position().left" );
+	
+	// IE is collapsing the top margin of 1px
+	equals( $w('#static-1-1-1').position().top, $.browser.msie ? 19 : 22, "$('#static-1-1-1').position().top" );
+	equals( $w('#static-1-1-1').position().left, 22, "$('#static-1-1-1').position().left" );
+	
+	// IE is collapsing the top margin of 1px
+	equals( $w('#static-2').position().top, $.browser.msie ? 120 : 121, "$('#static-2').position().top" );
+	equals( $w('#static-2').position().left, 6, "$('#static-2').position().left" );
+	
+	testwin["static"].close();
+});
+
+if ( !$.browser.msie || ($.browser.msie && parseInt($.browser.version) > 6) )
+	testwin("fixed", function() {
+		var $w = testwin["fixed"].$;
+	
+		equals( $w('#fixed-1').offset().top, 1001, "$('#fixed-1').offset().top" );
+		equals( $w('#fixed-1').offset().left, $.browser.msie ? 994 : 1001, "$('#fixed-1').offset().left" );
+	
+		equals( $w('#fixed-2').offset().top, 1021, "$('#fixed-2').offset().top" );
+		equals( $w('#fixed-2').offset().left, $.browser.msie ? 1014 : 1021, "$('#fixed-2').offset().left" );
+	
+		testwin["fixed"].close();
+	});
+
+testwin("table", function() {
+	var $w = testwin["table"].$;
+	
+	equals( $w('#table-1').offset().top, 6, "$('#table-1').offset().top" );
+	equals( $w('#table-1').offset().left, 6, "$('#table-1').offset().left" );
+	
+	equals( $w('#th-1').offset().top, 10, "$('#table-1').offset().top" );
+	equals( $w('#th-1').offset().left, 10, "$('#table-1').offset().left" );
+	
+	equals( $w('#th-2').offset().top, 10, "$('#table-1').offset().top" );
+	equals( $w('#th-2').offset().left, 116, "$('#table-1').offset().left" );
+	
+	testwin["table"].close();
+});
+
+testwin("scroll", function() {
+	var $w = testwin["scroll"].$;
+	
+	// IE is collapsing the top margin of 1px
+	equals( $w('#scroll-1').offset().top, $.browser.msie ? 6 : 7, "$('#scroll-1').offset().top" );
+	equals( $w('#scroll-1').offset().left, 7, "$('#scroll-1').offset().left" );
+	
+	// IE is collapsing the top margin of 1px
+	equals( $w('#scroll-1-1').offset().top, $.browser.msie ? 9 : 11, "$('#scroll-1-1').offset().top" );
+	equals( $w('#scroll-1-1').offset().left, 11, "$('#scroll-1-1').offset().left" );
+	
+	testwin["scroll"].close();
+});
\ No newline at end of file
diff --git a/dom/tests/mochitest/ajax/jquery/test/unit/selector.js b/dom/tests/mochitest/ajax/jquery/test/unit/selector.js
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/test/unit/selector.js
@@ -0,0 +1,224 @@
+module("selector");
+
+test("element", function() {
+	expect(9);
+	ok( $("*").size() >= 30, "Select all" );
+	var all = $("*"), good = true;
+	for ( var i = 0; i < all.length; i++ )
+		if ( all[i].nodeType == 8 )
+			good = false;
+	ok( good, "Select all elements, no comment nodes" );
+	t( "Element Selector", "p", ["firstp","ap","sndp","en","sap","first"] );
+	t( "Element Selector", "body", ["body"] );
+	t( "Element Selector", "html", ["html"] );
+	t( "Parent Element", "div p", ["firstp","ap","sndp","en","sap","first"] );
+	equals( $("param", "#object1").length, 2, "Object/param as context" );
+	
+	ok( $("#length").length, '&lt;input name="length"&gt; cannot be found under IE, see #945' );
+	ok( $("#lengthtest input").length, '&lt;input name="length"&gt; cannot be found under IE, see #945' );
+});
+
+if ( location.protocol != "file:" ) {
+	test("Element Selector with underscore", function() {
+		expect(1);
+		stop();
+		$.get("data/with_fries.xml", function(xml) {
+			equals( $("foo_bar", xml).length, 1, "Element Selector with underscore" );
+			start();
+		});
+	});
+}
+
+test("broken", function() {
+	expect(7);
+	t( "Broken Selector", "[", [] );
+	t( "Broken Selector", "(", [] );
+	t( "Broken Selector", "{", [] );
+	t( "Broken Selector", "<", [] );
+	t( "Broken Selector", "()", [] );
+	t( "Broken Selector", "<>", [] );
+	t( "Broken Selector", "{}", [] );
+});
+
+test("id", function() {
+	expect(25);
+	t( "ID Selector", "#body", ["body"] );
+	t( "ID Selector w/ Element", "body#body", ["body"] );
+	t( "ID Selector w/ Element", "ul#first", [] );
+	t( "ID selector with existing ID descendant", "#firstp #simon1", ["simon1"] );
+	t( "ID selector with non-existant descendant", "#firstp #foobar", [] );
+	t( "ID selector using UTF8", "#Taibei", ["Taibei"] );
+	t( "Multiple ID selectors using UTF8", "#Taibei, #", ["Taibei",""] );
+	t( "Descendant ID selector using UTF8", "div #", [""] );
+	t( "Child ID selector using UTF8", "form > #", [""] );
+	
+	t( "Escaped ID", "#foo\\:bar", ["foo:bar"] );
+	t( "Escaped ID", "#test\\.foo\\[5\\]bar", ["test.foo[5]bar"] );
+	t( "Descendant escaped ID", "div #foo\\:bar", ["foo:bar"] );
+	t( "Descendant escaped ID", "div #test\\.foo\\[5\\]bar", ["test.foo[5]bar"] );
+	t( "Child escaped ID", "form > #foo\\:bar", ["foo:bar"] );
+	t( "Child escaped ID", "form > #test\\.foo\\[5\\]bar", ["test.foo[5]bar"] );
+	
+	t( "ID Selector, child ID present", "#form > #radio1", ["radio1"] ); // bug #267
+	t( "ID Selector, not an ancestor ID", "#form #first", [] );
+	t( "ID Selector, not a child ID", "#form > #option1a", [] );
+	
+	t( "All Children of ID", "#foo > *", ["sndp", "en", "sap"] );
+	t( "All Children of ID with no children", "#firstUL/*", [] );
+	
+	$('<a name="tName1">tName1 A</a><a name="tName2">tName2 A</a><div id="tName1">tName1 Div</div>').appendTo('#main');
+	equals( $("#tName1")[0].id, 'tName1', "ID selector with same value for a name attribute" );
+	equals( $("#tName2").length, 0, "ID selector non-existing but name attribute on an A tag" );
+	t( "ID Selector on Form with an input that has a name of 'id'", "#lengthtest", ["lengthtest"] );
+	
+	t( "ID selector with non-existant ancestor", "#asdfasdf #foobar", [] ); // bug #986
+
+	isSet( $("body").find("div#form"), [], "ID selector within the context of another element" );
+});
+
+test("class", function() {
+	expect(16);
+	t( "Class Selector", ".blog", ["mark","simon"] );
+	t( "Class Selector", ".blog.link", ["simon"] );
+	t( "Class Selector w/ Element", "a.blog", ["mark","simon"] );
+	t( "Parent Class Selector", "p .blog", ["mark","simon"] );
+	
+	t( "Class selector using UTF8", ".Taibei", ["utf8class1"] );
+	t( "Class selector using UTF8", ".", ["utf8class1","utf8class2"] );
+	t( "Class selector using UTF8", ".Taibei.", ["utf8class1"] );
+	t( "Class selector using UTF8", ".Taibei, .", ["utf8class1","utf8class2"] );
+	t( "Descendant class selector using UTF8", "div .Taibei", ["utf8class1"] );
+	t( "Child class selector using UTF8", "form > .Taibei", ["utf8class1"] );
+	
+	t( "Escaped Class", ".foo\\:bar", ["foo:bar"] );
+	t( "Escaped Class", ".test\\.foo\\[5\\]bar", ["test.foo[5]bar"] );
+	t( "Descendant scaped Class", "div .foo\\:bar", ["foo:bar"] );
+	t( "Descendant scaped Class", "div .test\\.foo\\[5\\]bar", ["test.foo[5]bar"] );
+	t( "Child escaped Class", "form > .foo\\:bar", ["foo:bar"] );
+	t( "Child escaped Class", "form > .test\\.foo\\[5\\]bar", ["test.foo[5]bar"] );
+});
+
+test("multiple", function() {
+	expect(4);
+	t( "Comma Support", "a.blog, p", ["mark","simon","firstp","ap","sndp","en","sap","first"] );
+	t( "Comma Support", "a.blog , p", ["mark","simon","firstp","ap","sndp","en","sap","first"] );
+	t( "Comma Support", "a.blog ,p", ["mark","simon","firstp","ap","sndp","en","sap","first"] );
+	t( "Comma Support", "a.blog,p", ["mark","simon","firstp","ap","sndp","en","sap","first"] );
+});
+
+test("child and adjacent", function() {
+	expect(37);
+	t( "Child", "p > a", ["simon1","google","groups","mark","yahoo","simon"] );
+	t( "Child", "p> a", ["simon1","google","groups","mark","yahoo","simon"] );
+	t( "Child", "p >a", ["simon1","google","groups","mark","yahoo","simon"] );
+	t( "Child", "p>a", ["simon1","google","groups","mark","yahoo","simon"] );
+	t( "Child w/ Class", "p > a.blog", ["mark","simon"] );
+	t( "All Children", "code > *", ["anchor1","anchor2"] );
+	t( "All Grandchildren", "p > * > *", ["anchor1","anchor2"] );
+	t( "Adjacent", "a + a", ["groups"] );
+	t( "Adjacent", "a +a", ["groups"] );
+	t( "Adjacent", "a+ a", ["groups"] );
+	t( "Adjacent", "a+a", ["groups"] );
+	t( "Adjacent", "p + p", ["ap","en","sap"] );
+	t( "Comma, Child, and Adjacent", "a + a, code > a", ["groups","anchor1","anchor2"] );
+	
+	t( "First Child", "p:first-child", ["firstp","sndp"] );
+	t( "Nth Child", "p:nth-child(1)", ["firstp","sndp"] );
+	
+	t( "Last Child", "p:last-child", ["sap"] );
+	t( "Last Child", "a:last-child", ["simon1","anchor1","mark","yahoo","anchor2","simon"] );
+	
+	t( "Nth-child", "#main form#form > *:nth-child(2)", ["text2"] );
+	t( "Nth-child", "#main form#form > :nth-child(2)", ["text2"] );
+
+	t( "Nth-child", "#form select:first option:nth-child(3)", ["option1c"] );
+	t( "Nth-child", "#form select:first option:nth-child(0n+3)", ["option1c"] );
+	t( "Nth-child", "#form select:first option:nth-child(1n+0)", ["option1a", "option1b", "option1c", "option1d"] );
+	t( "Nth-child", "#form select:first option:nth-child(1n)", ["option1a", "option1b", "option1c", "option1d"] );
+	t( "Nth-child", "#form select:first option:nth-child(n)", ["option1a", "option1b", "option1c", "option1d"] );
+	t( "Nth-child", "#form select:first option:nth-child(even)", ["option1b", "option1d"] );
+	t( "Nth-child", "#form select:first option:nth-child(odd)", ["option1a", "option1c"] );
+	t( "Nth-child", "#form select:first option:nth-child(2n)", ["option1b", "option1d"] );
+	t( "Nth-child", "#form select:first option:nth-child(2n+1)", ["option1a", "option1c"] );
+	t( "Nth-child", "#form select:first option:nth-child(3n)", ["option1c"] );
+	t( "Nth-child", "#form select:first option:nth-child(3n+1)", ["option1a", "option1d"] );
+	t( "Nth-child", "#form select:first option:nth-child(3n+2)", ["option1b"] );
+	t( "Nth-child", "#form select:first option:nth-child(3n+3)", ["option1c"] );
+	t( "Nth-child", "#form select:first option:nth-child(3n-1)", ["option1b"] );
+	t( "Nth-child", "#form select:first option:nth-child(3n-2)", ["option1a", "option1d"] );
+	t( "Nth-child", "#form select:first option:nth-child(3n-3)", ["option1c"] );
+	t( "Nth-child", "#form select:first option:nth-child(3n+0)", ["option1c"] );
+	t( "Nth-child", "#form select:first option:nth-child(-n+3)", ["option1a", "option1b", "option1c"] );
+});
+
+test("attributes", function() {
+	expect(20);
+	t( "Attribute Exists", "a[title]", ["google"] );
+	t( "Attribute Exists", "*[title]", ["google"] );
+	t( "Attribute Exists", "[title]", ["google"] );
+	
+	t( "Attribute Equals", "a[rel='bookmark']", ["simon1"] );
+	t( "Attribute Equals", 'a[rel="bookmark"]', ["simon1"] );
+	t( "Attribute Equals", "a[rel=bookmark]", ["simon1"] );
+	t( "Multiple Attribute Equals", "#form input[type='hidden'],#form input[type='radio']", ["hidden1","radio1","radio2"] );
+	t( "Multiple Attribute Equals", "#form input[type=\"hidden\"],#form input[type='radio']", ["hidden1","radio1","radio2"] );
+	t( "Multiple Attribute Equals", "#form input[type=hidden],#form input[type=radio]", ["hidden1","radio1","radio2"] );
+	
+	t( "Attribute selector using UTF8", "span[lang=]", [""] );
+	
+	t( "Attribute Begins With", "a[href ^= 'http://www']", ["google","yahoo"] );
+	t( "Attribute Ends With", "a[href $= 'org/']", ["mark"] );
+	t( "Attribute Contains", "a[href *= 'google']", ["google","groups"] );
+	
+	t("Select options via [selected]", "#select1 option[selected]", ["option1a"] );
+	t("Select options via [selected]", "#select2 option[selected]", ["option2d"] );
+	t("Select options via [selected]", "#select3 option[selected]", ["option3b", "option3c"] );
+	
+	t( "Grouped Form Elements", "input[name='foo[bar]']", ["hidden2"] );
+	
+	t( ":not() Existing attribute", "#form select:not([multiple])", ["select1", "select2"]);
+	t( ":not() Equals attribute", "#form select:not([name=select1])", ["select2", "select3"]);
+	t( ":not() Equals quoted attribute", "#form select:not([name='select1'])", ["select2", "select3"]);
+});
+
+test("pseudo (:) selectors", function() {
+	expect(35);
+	t( "First Child", "p:first-child", ["firstp","sndp"] );
+	t( "Last Child", "p:last-child", ["sap"] );
+	t( "Only Child", "a:only-child", ["simon1","anchor1","yahoo","anchor2"] );
+	t( "Empty", "ul:empty", ["firstUL"] );
+	t( "Enabled UI Element", "#form input:enabled", ["text1","radio1","radio2","check1","check2","hidden1","hidden2","name"] );
+	t( "Disabled UI Element", "#form input:disabled", ["text2"] );
+	t( "Checked UI Element", "#form input:checked", ["radio2","check1"] );
+	t( "Selected Option Element", "#form option:selected", ["option1a","option2d","option3b","option3c"] );
+	t( "Text Contains", "a:contains('Google')", ["google","groups"] );
+	t( "Text Contains", "a:contains('Google Groups')", ["groups"] );
+	t( "Element Preceded By", "p ~ div", ["foo","fx-queue","fx-tests", "moretests"] );
+	t( "Not", "a.blog:not(.link)", ["mark"] );
+	t( "Not - multiple", "#form option:not(:contains('Nothing'),#option1b,:selected)", ["option1c", "option1d", "option2b", "option2c", "option3d"] );
+	t( "Not - complex", "#form option:not([id^='opt']:gt(0):nth-child(-n+3))", [ "option1a", "option1d", "option2d", "option3d"] );
+	t( "Not - recursive", "#form option:not(:not(:selected))[id^='option3']", [ "option3b", "option3c"] );
+	
+	t( "nth Element", "p:nth(1)", ["ap"] );
+	t( "First Element", "p:first", ["firstp"] );
+	t( "Last Element", "p:last", ["first"] );
+	t( "Even Elements", "p:even", ["firstp","sndp","sap"] );
+	t( "Odd Elements", "p:odd", ["ap","en","first"] );
+	t( "Position Equals", "p:eq(1)", ["ap"] );
+	t( "Position Greater Than", "p:gt(0)", ["ap","sndp","en","sap","first"] );
+	t( "Position Less Than", "p:lt(3)", ["firstp","ap","sndp"] );
+	t( "Is A Parent", "p:parent", ["firstp","ap","sndp","en","sap","first"] );
+	t( "Is Visible", "#form input:visible", ["text1","text2","radio1","radio2","check1","check2","name"] );
+	t( "Is Hidden", "#form input:hidden", ["hidden1","hidden2"] );
+	
+	t( "Form element :input", "#form :input", ["text1", "text2", "radio1", "radio2", "check1", "check2", "hidden1", "hidden2", "name", "button", "area1", "select1", "select2", "select3"] );
+	t( "Form element :radio", "#form :radio", ["radio1", "radio2"] );
+	t( "Form element :checkbox", "#form :checkbox", ["check1", "check2"] );
+	t( "Form element :text", "#form :text", ["text1", "text2", "hidden2", "name"] );
+	t( "Form element :radio:checked", "#form :radio:checked", ["radio2"] );
+	t( "Form element :checkbox:checked", "#form :checkbox:checked", ["check1"] );
+	t( "Form element :checkbox:checked, :radio:checked", "#form :checkbox:checked, #form :radio:checked", ["check1", "radio2"] );
+
+	t( "Headers", ":header", ["header", "banner", "userAgent"] );
+	t( "Has Children - :has()", "p:has(a)", ["firstp","ap","en","sap"] );
+});
diff --git a/dom/tests/mochitest/ajax/jquery/version.txt b/dom/tests/mochitest/ajax/jquery/version.txt
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/ajax/jquery/version.txt
@@ -0,0 +1,1 @@
+1.2.6
diff --git a/editor/idl/nsIEditorIMESupport.idl b/editor/idl/nsIEditorIMESupport.idl
--- a/editor/idl/nsIEditorIMESupport.idl
+++ b/editor/idl/nsIEditorIMESupport.idl
@@ -40,21 +40,17 @@
 #include "domstubs.idl"
 
 %{C++
 class nsIPrivateTextRangeList;
 struct nsTextEventReply;
-struct nsReconversionEventReply;
-struct nsQueryCaretRectEventReply;
 %}
 
 [ptr] native nsIPrivateTextRangeListPtr(nsIPrivateTextRangeList);
 [ptr] native nsTextEventReplyPtr(nsTextEventReply);
-[ptr] native nsReconversionEventReplyPtr(nsReconversionEventReply);
-[ptr] native nsQueryCaretRectEventReplyPtr(nsQueryCaretRectEventReply);
 
 
-[scriptable, uuid(ce1c0424-c3c0-44b0-97d6-df12deb19d45)]
+[scriptable, uuid(57032dcb-e8c7-4eb6-8ec6-a0f8e300809d)]
 
 interface nsIEditorIMESupport : nsISupports
 {
 
 
@@ -88,34 +84,10 @@ interface nsIEditorIMESupport : nsISuppo
    */
 
   void forceCompositionEnd();
 
   /**
-   * getReconversionString()  Get the reconvertion string
-   */
-
-  [noscript] void getReconversionString(in nsReconversionEventReplyPtr aReply);
-
-  /**
-   * Notify for IME when the editor got focus.
-   */
-
-  void notifyIMEOnFocus();
-
-  /**
-   * Notify for IME when the editor lost focus.
-   */
-
-  void notifyIMEOnBlur();
-
-  /**
-   * getQueryCaretRect()  Get the query caret rect
-   */
-
-  [noscript] void getQueryCaretRect(in nsQueryCaretRectEventReplyPtr aReply);
-
-  /**
    * Get preferred IME status of current widget.
    */
 
   [noscript] void getPreferredIMEState(out unsigned long aState);
 
diff --git a/editor/libeditor/base/nsEditor.cpp b/editor/libeditor/base/nsEditor.cpp
--- a/editor/libeditor/base/nsEditor.cpp
+++ b/editor/libeditor/base/nsEditor.cpp
@@ -2146,22 +2146,10 @@ nsEditor::ForceCompositionEnd()
 
   return NS_OK;
 }
 
 NS_IMETHODIMP
-nsEditor::NotifyIMEOnFocus()
-{
-  return NS_OK;
-}
-
-NS_IMETHODIMP
-nsEditor::NotifyIMEOnBlur()
-{
-  return NS_OK;
-}
-
-NS_IMETHODIMP
 nsEditor::GetPreferredIMEState(PRUint32 *aState)
 {
   NS_ENSURE_ARG_POINTER(aState);
   *aState = nsIContent::IME_STATUS_ENABLE;
 
@@ -2209,45 +2197,10 @@ nsEditor::GetComposing(PRBool* aResult)
 nsEditor::GetComposing(PRBool* aResult)
 {
   NS_ENSURE_ARG_POINTER(aResult);
   *aResult = IsIMEComposing();
   return NS_OK;
-}
-
-NS_IMETHODIMP
-nsEditor::GetReconversionString(nsReconversionEventReply* aReply)
-{
-  return NS_ERROR_NOT_IMPLEMENTED;
-}
-
-NS_IMETHODIMP
-nsEditor::GetQueryCaretRect(nsQueryCaretRectEventReply* aReply)
-{
-  nsCOMPtr<nsISelection> selection;
-  nsresult rv = GetSelection(getter_AddRefs(selection));
-  if (NS_FAILED(rv))
-    return rv;
-
-  if (!mPresShellWeak)
-    return NS_ERROR_NOT_INITIALIZED;
-
-  nsCOMPtr<nsIPresShell> ps = do_QueryReferent(mPresShellWeak);
-  if (!ps)
-    return NS_ERROR_NOT_INITIALIZED;
-
-  nsRefPtr<nsCaret> caretP;
-  rv = ps->GetCaret(getter_AddRefs(caretP));
-
-  if (NS_FAILED(rv) || !caretP)
-    return rv;
-
-  PRBool cursorIsCollapsed;
-  rv = caretP->GetCaretCoordinates(nsCaret::eIMECoordinates, selection,
-                                   &aReply->mCaretRect, &cursorIsCollapsed, nsnull);
-  if (NS_SUCCEEDED(rv))
-    aReply->mRectIsValid = PR_TRUE;
-  return rv;
 }
 
 #ifdef XP_MAC
 #pragma mark -
 #pragma mark  public nsEditor methods 
diff --git a/editor/libeditor/text/nsEditorEventListeners.cpp b/editor/libeditor/text/nsEditorEventListeners.cpp
--- a/editor/libeditor/text/nsEditorEventListeners.cpp
+++ b/editor/libeditor/text/nsEditorEventListeners.cpp
@@ -868,47 +868,10 @@ nsTextEditorCompositionListener::HandleE
    printf("nsTextEditorCompositionListener::HandleEndComposition\n");
 #endif
    return mEditor->EndComposition();
 }
 
-
-nsresult
-nsTextEditorCompositionListener::HandleQueryReconversion(nsIDOMEvent* aReconversionEvent)
-{
-#ifdef DEBUG_IME
-  printf("nsTextEditorCompositionListener::HandleQueryReconversion\n");
-#endif
-  nsCOMPtr<nsIPrivateCompositionEvent> pCompositionEvent = do_QueryInterface(aReconversionEvent);
-  if (!pCompositionEvent)
-    return NS_ERROR_FAILURE;
-
-  nsReconversionEventReply* eventReply;
-  nsresult rv = pCompositionEvent->GetReconversionReply(&eventReply);
-  if (NS_FAILED(rv))
-    return rv;
-
-  return mEditor->GetReconversionString(eventReply);
-}
-
-nsresult
-nsTextEditorCompositionListener::HandleQueryCaretRect(nsIDOMEvent* aQueryCaretRectEvent)
-{
-#ifdef DEBUG_IME
-  printf("nsTextEditorCompositionListener::HandleQueryCaretRect\n");
-#endif
-  nsCOMPtr<nsIPrivateCompositionEvent> pCompositionEvent = do_QueryInterface(aQueryCaretRectEvent);
-  if (!pCompositionEvent)
-    return NS_ERROR_FAILURE;
-
-  nsQueryCaretRectEventReply* eventReply;
-  nsresult rv = pCompositionEvent->GetQueryCaretRectReply(&eventReply);
-  if (NS_FAILED(rv))
-    return rv;
-
-  return mEditor->GetQueryCaretRect(eventReply);
-}
-
 /*
  * Factory functions
  */
 
 
@@ -1127,11 +1090,10 @@ nsTextEditorFocusListener::Focus(nsIDOME
   mIsFocused = PR_TRUE;
 
   // turn on selection and caret
   if (mEditor)
   {
-    nsCOMPtr<nsIEditorIMESupport> imeEditor = do_QueryInterface(mEditor);
     PRUint32 flags;
     mEditor->GetFlags(&flags);
     if (! (flags & nsIPlaintextEditor::eEditorDisabledMask))
     { // only enable caret and selection if the editor is not disabled
       nsCOMPtr<nsIContent> content = do_QueryInterface(target);
@@ -1186,13 +1148,10 @@ nsTextEditorFocusListener::Focus(nsIDOME
             mEditor->BeginningOfDocument();
           }
         }
       }
     }
-
-    if (imeEditor)
-      imeEditor->NotifyIMEOnFocus();
   }
   return NS_OK;
 }
 
 nsresult
@@ -1200,17 +1159,10 @@ nsTextEditorFocusListener::Blur(nsIDOMEv
 {
   NS_ENSURE_ARG(aEvent);
   // turn off selection and caret
   if (mEditor && mIsFocused)
   {
-    // when imeEditor exists, call ForceCompositionEnd() to tell
-    // the input focus is leaving first
-    nsCOMPtr<nsIEditorIMESupport> imeEditor = do_QueryInterface(mEditor);
-    if (imeEditor) {
-      imeEditor->NotifyIMEOnBlur();
-    }
-
     nsCOMPtr<nsIEditor>editor = do_QueryInterface(mEditor);
     if (editor)
     {
       nsCOMPtr<nsISelectionController>selCon;
       editor->GetSelectionController(getter_AddRefs(selCon));
diff --git a/editor/libeditor/text/nsEditorEventListeners.h b/editor/libeditor/text/nsEditorEventListeners.h
--- a/editor/libeditor/text/nsEditorEventListeners.h
+++ b/editor/libeditor/text/nsEditorEventListeners.h
@@ -146,12 +146,10 @@ public:
 /*BEGIN implementations of textevent handler interface*/
   NS_IMETHOD HandleEvent(nsIDOMEvent* aEvent);
   NS_IMETHOD HandleStartComposition(nsIDOMEvent* aCompositionEvent);
   NS_IMETHOD HandleEndComposition(nsIDOMEvent* aCompositionEvent);
   NS_IMETHOD HandleQueryComposition(nsIDOMEvent* aCompositionEvent);
-  NS_IMETHOD HandleQueryReconversion(nsIDOMEvent* aReconvertionEvent);
-  NS_IMETHOD HandleQueryCaretRect(nsIDOMEvent* aQueryCaretRectEvent);
 /*END implementations of textevent handler interface*/
 
 protected:
   nsIEditorIMESupport*     mEditor;		// weak reference
 };
diff --git a/editor/libeditor/text/nsPlaintextEditor.cpp b/editor/libeditor/text/nsPlaintextEditor.cpp
--- a/editor/libeditor/text/nsPlaintextEditor.cpp
+++ b/editor/libeditor/text/nsPlaintextEditor.cpp
@@ -1748,44 +1748,10 @@ nsPlaintextEditor::SetCompositionString(
   }
 
   return result;
 }
 
-NS_IMETHODIMP 
-nsPlaintextEditor::GetReconversionString(nsReconversionEventReply* aReply)
-{
-  nsCOMPtr<nsISelection> selection;
-  nsresult res = GetSelection(getter_AddRefs(selection));
-  if (NS_FAILED(res)) return res;
-  if (!selection) return NS_ERROR_FAILURE;
-
-  // XXX get the first range in the selection.  Since it is
-  // unclear what to do if reconversion happens with a 
-  // multirange selection, we will ignore any additional ranges.
-  
-  nsCOMPtr<nsIDOMRange> range;
-  res = selection->GetRangeAt(0, getter_AddRefs(range));
-  if (NS_FAILED(res)) return res;
-  if (!range) return NS_ERROR_FAILURE;
-  
-  nsAutoString textValue;
-  res = range->ToString(textValue);
-  if (NS_FAILED(res))
-    return res;
-  
-  aReply->mReconversionString = (PRUnichar*) nsMemory::Clone(textValue.get(),
-                                                                (textValue.Length() + 1) * sizeof(PRUnichar));
-  if (!aReply->mReconversionString)
-    return NS_ERROR_OUT_OF_MEMORY;
-
-  if (textValue.IsEmpty())
-    return NS_OK;
-
-  // delete the selection
-  return DeleteSelection(eNone);
-}
-
 #ifdef XP_MAC
 #pragma mark -
 #pragma mark  nsEditor overrides 
 #pragma mark -
 #endif
diff --git a/editor/libeditor/text/nsPlaintextEditor.h b/editor/libeditor/text/nsPlaintextEditor.h
--- a/editor/libeditor/text/nsPlaintextEditor.h
+++ b/editor/libeditor/text/nsPlaintextEditor.h
@@ -84,13 +84,13 @@ public:
 
   /* ------------ nsIEditorMailSupport overrides -------------- */
   NS_DECL_NSIEDITORMAILSUPPORT
 
   /* ------------ nsIEditorIMESupport overrides -------------- */
-  
-  NS_IMETHOD SetCompositionString(const nsAString & aCompositionString, nsIPrivateTextRangeList * aTextRange, nsTextEventReply * aReply);
-  NS_IMETHOD GetReconversionString(nsReconversionEventReply* aReply);
+  NS_IMETHOD SetCompositionString(const nsAString &aCompositionString,
+                                  nsIPrivateTextRangeList *aTextRange,
+                                  nsTextEventReply *aReply);
 
   /* ------------ Overrides of nsEditor interface methods -------------- */
   NS_IMETHOD BeginComposition(nsTextEventReply* aReply);
   NS_IMETHOD SetAttributeOrEquivalent(nsIDOMElement * aElement,
                                       const nsAString & aAttribute,
diff --git a/embedding/browser/gtk/tests/Makefile.in b/embedding/browser/gtk/tests/Makefile.in
--- a/embedding/browser/gtk/tests/Makefile.in
+++ b/embedding/browser/gtk/tests/Makefile.in
@@ -48,13 +48,16 @@ REQUIRES	= xpcom \
 		  dom \
 		  $(NULL)
 
 CPPSRCS         = \
 		TestGtkEmbed.cpp \
-		TestGtkEmbedNotebook.cpp \
-		TestGtkEmbedSocket.cpp \
+		TestGtkEmbedNotebook.cpp
+
+ifdef MOZ_X11
+CPPSRCS +=	TestGtkEmbedSocket.cpp \
 		TestGtkEmbedChild.cpp
+endif
 
 SIMPLE_PROGRAMS = $(CPPSRCS:.cpp=)
 
 # ENABLE_GNOME=1
 
diff --git a/gfx/cairo/cairo/src/cairo-os2-surface.c b/gfx/cairo/cairo/src/cairo-os2-surface.c
--- a/gfx/cairo/cairo/src/cairo-os2-surface.c
+++ b/gfx/cairo/cairo/src/cairo-os2-surface.c
@@ -135,11 +135,11 @@ cairo_os2_fini (void)
 
     DisableFPUException ();
 
     /* Free allocated memories! */
     /* (Check cairo_debug_reset_static_data () for an example of this!) */
-    _cairo_font_reset_static_data ();
+    _cairo_font_face_reset_static_data ();
 #if CAIRO_HAS_FT_FONT
     _cairo_ft_font_reset_static_data ();
 #endif
 
     CAIRO_MUTEX_FINALIZE ();
diff --git a/gfx/src/thebes/nsSystemFontsGTK2.cpp b/gfx/src/thebes/nsSystemFontsGTK2.cpp
--- a/gfx/src/thebes/nsSystemFontsGTK2.cpp
+++ b/gfx/src/thebes/nsSystemFontsGTK2.cpp
@@ -43,22 +43,22 @@
 #include "nsIRenderingContext.h"
 #include "prlink.h"
 
 #include <gtk/gtk.h>
 #include <gdk/gdk.h>
-#include <gdk/gdkx.h>
 
+#ifdef MOZ_PANGO
 #include <pango/pango.h>
-#include <pango/pangox.h>
 #include <pango/pango-fontmap.h>
+#endif
 
 #include <fontconfig/fontconfig.h>
 #include "nsSystemFontsGTK2.h"
 #include "gfxPlatformGtk.h"
 
 // Glue to avoid build/runtime dependencies on Pango > 1.6
-#ifndef THEBES_USE_PANGO_CAIRO
+#if defined(MOZ_PANGO) && !defined(THEBES_USE_PANGO_CAIRO)
 static gboolean
 (* PTR_pango_font_description_get_size_is_absolute)(PangoFontDescription*)
     = nsnull;
 
 static void InitPangoLib()
@@ -99,15 +99,17 @@ static inline void InitPangoLib()
 
 static inline void ShutdownPangoLib()
 {
 }
 
+#ifdef MOZ_PANGO
 static inline gboolean
 MOZ_pango_font_description_get_size_is_absolute(PangoFontDescription *desc)
 {
     pango_font_description_get_size_is_absolute(desc);
 }
+#endif
 #endif
 
 nsSystemFontsGTK2::nsSystemFontsGTK2()
   : mDefaultFontName(NS_LITERAL_STRING("sans-serif"))
   , mButtonFontName(NS_LITERAL_STRING("sans-serif"))
@@ -188,10 +190,11 @@ nsSystemFontsGTK2::~nsSystemFontsGTK2()
 
 nsresult
 nsSystemFontsGTK2::GetSystemFontInfo(GtkWidget *aWidget, nsString *aFontName,
                                      gfxFontStyle *aFontStyle) const
 {
+#ifdef MOZ_PANGO
     GtkSettings *settings = gtk_widget_get_settings(aWidget);
 
     aFontStyle->style       = FONT_STYLE_NORMAL;
 
     gchar *fontname;
@@ -222,10 +225,22 @@ nsSystemFontsGTK2::GetSystemFontInfo(Gtk
     // |size| is now pixels
 
     aFontStyle->size = size;
   
     pango_font_description_free(desc);
+
+#else
+    /* FIXME: DFB FT2 Hardcoding the system font info for now.. */
+    aFontStyle->style       = FONT_STYLE_NORMAL;
+    aFontStyle->systemFont = PR_TRUE;
+
+    NS_NAMED_LITERAL_STRING(fontname, "\"Sans\"");
+    *aFontName = fontname;
+    aFontStyle->weight = 400;
+    aFontStyle->size = 40/3;
+
+#endif
 
     return NS_OK;
 }
 
 nsresult
diff --git a/gfx/src/thebes/nsThebesDeviceContext.cpp b/gfx/src/thebes/nsThebesDeviceContext.cpp
--- a/gfx/src/thebes/nsThebesDeviceContext.cpp
+++ b/gfx/src/thebes/nsThebesDeviceContext.cpp
@@ -53,15 +53,18 @@
 // for round
 #include <cmath>
 
 #include <gtk/gtk.h>
 #include <gdk/gdk.h>
-#include <gdk/gdkx.h>
+
 #include "nsFont.h"
 
 #include <pango/pango.h>
+#ifdef MOZ_X11
+#include <gdk/gdkx.h>
 #include <pango/pangox.h>
+#endif /* MOZ_X11 */
 #include <pango/pango-fontmap.h>
 #endif /* GTK2 */
 
 #include "gfxImageSurface.h"
 
@@ -90,11 +93,11 @@ static nsSystemFontsMac *gSystemFonts = 
 static nsSystemFontsMac *gSystemFonts = nsnull;
 #else
 #error Need to declare gSystemFonts!
 #endif
 
-#ifdef MOZ_ENABLE_GTK2
+#if defined(MOZ_ENABLE_GTK2) && defined(MOZ_X11)
 extern "C" {
 static int x11_error_handler (Display *dpy, XErrorEvent *err) {
     NS_ASSERTION(PR_FALSE, "X Error");
     return 0;
 }
@@ -269,11 +272,11 @@ nsThebesDeviceContext::Init(nsNativeWidg
     mWidget = aWidget;
 
     SetDPI();
 
 
-#ifdef MOZ_ENABLE_GTK2
+#if defined(MOZ_ENABLE_GTK2) && defined(MOZ_X11)
     if (getenv ("MOZ_X_SYNC")) {
         PR_LOG (gThebesGFXLog, PR_LOG_DEBUG, ("+++ Enabling XSynchronize\n"));
         XSynchronize (gdk_x11_get_default_xdisplay(), True);
         XSetErrorHandler(x11_error_handler);
     }
diff --git a/gfx/src/thebes/nsThebesRenderingContext.cpp b/gfx/src/thebes/nsThebesRenderingContext.cpp
--- a/gfx/src/thebes/nsThebesRenderingContext.cpp
+++ b/gfx/src/thebes/nsThebesRenderingContext.cpp
@@ -972,11 +972,11 @@ nsThebesRenderingContext::GetTextDimensi
   mFontMetrics->GetMaxAscent(aDimensions.ascent);
   mFontMetrics->GetMaxDescent(aDimensions.descent);
   return GetWidth(aString, aLength, aDimensions.width, aFontID);
 }
 
-#if defined(_WIN32) || defined(XP_OS2) || defined(MOZ_X11) || defined(XP_BEOS) || defined(XP_MACOSX)
+#if defined(_WIN32) || defined(XP_OS2) || defined(MOZ_X11) || defined(XP_BEOS) || defined(XP_MACOSX) || defined (MOZ_DFB)
 NS_IMETHODIMP
 nsThebesRenderingContext::GetTextDimensionsInternal(const char*       aString,
                                                     PRInt32           aLength,
                                                     PRInt32           aAvailWidth,
                                                     PRInt32*          aBreaks,
diff --git a/gfx/thebes/public/Makefile.in b/gfx/thebes/public/Makefile.in
--- a/gfx/thebes/public/Makefile.in
+++ b/gfx/thebes/public/Makefile.in
@@ -51,12 +51,26 @@ REQUIRES += glitzwgl
 REQUIRES += glitzwgl
 endif
 endif
 
 ifeq ($(MOZ_WIDGET_TOOLKIT),gtk2)
-EXPORTS +=      gfxXlibSurface.h gfxPlatformGtk.h gfxXlibNativeRenderer.h
-EXPORTS +=	gfxPangoFonts.h
+
+ifdef MOZ_X11
+EXPORTS += gfxXlibSurface.h
+endif
+
+ifdef MOZ_PANGO 
+EXPORTS += gfxPangoFonts.h
+else
+EXPORTS += gfxFT2Fonts.h
+endif
+
+ifdef MOZ_DFB
+EXPORTS += gfxDirectFBSurface.h
+endif
+
+EXPORTS +=  gfxPlatformGtk.h gfxGdkNativeRenderer.h
 EXPORTS +=	gfxPDFSurface.h gfxPSSurface.h
 
 ifdef MOZ_ENABLE_GLITZ
 REQUIRES += glitzglx
 endif
diff --git a/gfx/thebes/public/gfxAtsuiFonts.h b/gfx/thebes/public/gfxAtsuiFonts.h
--- a/gfx/thebes/public/gfxAtsuiFonts.h
+++ b/gfx/thebes/public/gfxAtsuiFonts.h
@@ -83,20 +83,17 @@ public:
             PRBool aNeedTight, gfxGlyphExtents *aExtents);
 
     PRBool TestCharacterMap(PRUint32 aCh);
 
     MacOSFontEntry* GetFontEntry();
-    PRBool Valid() { return mValid; }
+    PRBool Valid() { return mIsValid; }
 
 protected:
     const gfxFontStyle *mFontStyle;
 
     ATSUStyle mATSUStyle;
 
-    nsRefPtr<MacOSFontEntry> mFontEntry;
-
-    PRBool mValid;
     PRBool mHasMirroring;
     PRBool mHasMirroringLookedUp;
 
     nsString mUniqueName;
 
@@ -149,13 +146,13 @@ public:
         }
         return nsnull;
     }
 
    // search through pref fonts for a character, return nsnull if no matching pref font
-   already_AddRefed<gfxAtsuiFont> WhichPrefFontSupportsChar(PRUint32 aCh);
+   already_AddRefed<gfxFont> WhichPrefFontSupportsChar(PRUint32 aCh);
    
-   already_AddRefed<gfxAtsuiFont> FindFontForChar(PRUint32 aCh, PRUint32 aPrevCh, PRUint32 aNextCh, gfxAtsuiFont* aPrevMatchedFont);
+   already_AddRefed<gfxFont> WhichSystemFontSupportsChar(PRUint32 aCh);
 
 protected:
     static PRBool FindATSUFont(const nsAString& aName,
                                const nsACString& aGenericName,
                                void *closure);
diff --git a/gfx/thebes/public/gfxDirectFBSurface.h b/gfx/thebes/public/gfxDirectFBSurface.h
new file mode 100644
--- /dev/null
+++ b/gfx/thebes/public/gfxDirectFBSurface.h
@@ -0,0 +1,69 @@
+/* -*- Mode: C++; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*-
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is DirectFB Thebes code.
+ *
+ * The Initial Developer of the Original Code is Mozilla Corporation
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Vladimir Vukicevic <vladimir@pobox.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#ifndef GFX_DIRECTFBSURFACE_H
+#define GFX_DIRECTFBSURFACE_H
+
+#include "gfxASurface.h"
+
+extern "C" {
+#include "direct/messages.h"
+
+typedef struct _IDirectFB IDirectFB;
+typedef struct _IDirectFBSurface IDirectFBSurface;
+
+}
+
+class THEBES_API gfxDirectFBSurface : public gfxASurface {
+public:
+    gfxDirectFBSurface(IDirectFB *dfb, IDirectFBSurface *surface);
+    gfxDirectFBSurface(IDirectFBSurface *surface);
+    gfxDirectFBSurface(cairo_surface_t *csurf);
+
+    gfxDirectFBSurface(const gfxIntSize& size, gfxImageFormat format);
+
+    virtual ~gfxDirectFBSurface();
+
+    IDirectFB* DirectFB() { return mDFB; }
+    IDirectFBSurface* DirectFBSurface() { return mDFBSurface; }
+
+protected:
+    IDirectFB *mDFB;
+    IDirectFBSurface *mDFBSurface;
+};
+
+#endif /* GFX_DIRECTFBSURFACE_H */
diff --git a/gfx/thebes/public/gfxFT2Fonts.h b/gfx/thebes/public/gfxFT2Fonts.h
new file mode 100644
--- /dev/null
+++ b/gfx/thebes/public/gfxFT2Fonts.h
@@ -0,0 +1,185 @@
+/* -*- Mode: C++; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*-
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Mozilla Foundation code.
+ *
+ * The Initial Developer of the Original Code is Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2005
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Vladimir Vukicevic <vladimir@mozilla.com>
+ *   Masayuki Nakano <masayuki@d-toybox.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#ifndef GFX_GTKDFBFONTS_H
+#define GFX_GTKDFBFONTS_H
+
+#include "cairo.h"
+#include "gfxTypes.h"
+#include "gfxFont.h"
+#include "gfxContext.h"
+#include "gfxFontUtils.h"
+
+typedef struct FT_FaceRec_* FT_Face;
+
+/**
+ * FontFamily is a class that describes one of the fonts on the users system.  It holds
+ * each FontEntry (maps more directly to a font face) which holds font type, charset info
+ * and character map info.
+ */
+class FontEntry;
+class FontFamily
+{
+public:
+    THEBES_INLINE_DECL_REFCOUNTING(FontFamily)
+
+    FontFamily(const nsAString& aName) :
+        mName(aName) { }
+
+    FontEntry *FindFontEntry(const gfxFontStyle& aFontStyle);
+
+public:
+    nsTArray<nsRefPtr<FontEntry> > mFaces;
+    nsString mName;
+};
+
+class FontEntry
+{
+public:
+    THEBES_INLINE_DECL_REFCOUNTING(FontEntry)
+
+    FontEntry(const nsString& aFaceName) : 
+        mFontFace(nsnull), mFaceName(aFaceName), mFTFontIndex(0), mUnicodeFont(PR_FALSE), mSymbolFont(PR_FALSE)
+    { }
+
+    FontEntry(const FontEntry& aFontEntry);
+    ~FontEntry();
+
+    const nsString& GetName() const {
+        return mFaceName;
+    }
+
+    cairo_font_face_t *CairoFontFace();
+
+    cairo_font_face_t *mFontFace;
+
+    nsString mFaceName;
+    nsCString mFilename;
+    PRUint8 mFTFontIndex;
+
+    PRPackedBool mUnicodeFont : 1;
+    PRPackedBool mSymbolFont  : 1;
+    PRPackedBool mTrueType    : 1;
+    PRPackedBool mIsType1     : 1;
+    PRPackedBool mItalic      : 1;
+    PRUint16 mWeight;
+
+    gfxSparseBitSet mCharacterMap;
+};
+
+
+
+class gfxFT2Font : public gfxFont {
+public: // new functions
+    gfxFT2Font(FontEntry *aFontEntry,
+               const gfxFontStyle *aFontStyle);
+    virtual ~gfxFT2Font ();
+
+    virtual const gfxFont::Metrics& GetMetrics();
+
+    cairo_font_face_t *CairoFontFace();
+    cairo_scaled_font_t *CairoScaledFont();
+
+    virtual PRBool SetupCairoFont(gfxContext *aContext);
+    virtual nsString GetUniqueName();
+    virtual PRUint32 GetSpaceGlyph();
+
+    FontEntry *GetFontEntry() { return mFontEntry; }
+private:
+    cairo_scaled_font_t *mScaledFont;
+
+    PRBool mHasSpaceGlyph;
+    PRUint32 mSpaceGlyph;
+    PRBool mHasMetrics;
+    Metrics mMetrics;
+    gfxFloat mAdjustedSize;
+
+    nsRefPtr<FontEntry> mFontEntry;
+};
+
+class THEBES_API gfxFT2FontGroup : public gfxFontGroup {
+public: // new functions
+    gfxFT2FontGroup (const nsAString& families,
+                    const gfxFontStyle *aStyle);
+    virtual ~gfxFT2FontGroup ();
+
+    inline gfxFT2Font *GetFontAt (PRInt32 i) {
+        return static_cast <gfxFT2Font *>(static_cast <gfxFont *>(mFonts[i]));
+    }
+
+protected: // from gfxFontGroup
+    virtual gfxTextRun *MakeTextRun(const PRUnichar *aString, 
+                                    PRUint32 aLength,
+                                    const Parameters *aParams, 
+                                    PRUint32 aFlags);
+
+    virtual gfxTextRun *MakeTextRun(const PRUint8 *aString, 
+                                    PRUint32 aLength,
+                                    const Parameters *aParams, 
+                                    PRUint32 aFlags);
+
+    virtual gfxFontGroup *Copy(const gfxFontStyle *aStyle);
+
+
+protected: // new functions
+    void InitTextRun(gfxTextRun *aTextRun);
+
+    void CreateGlyphRunsFT(gfxTextRun *aTextRun);
+    void AddRange(gfxTextRun *aTextRun, gfxFT2Font *font, const PRUnichar *str, PRUint32 len);
+
+    static PRBool FontCallback (const nsAString & fontName, 
+                                const nsACString & genericName, 
+                                void *closure);
+    PRBool mEnableKerning;
+
+    gfxFT2Font *FindFontForChar(PRUint32 ch, PRUint32 prevCh, PRUint32 nextCh, gfxFT2Font *aFont);
+    PRUint32 ComputeRanges();
+
+    struct TextRange {
+        TextRange(PRUint32 aStart,  PRUint32 aEnd) : start(aStart), end(aEnd) { }
+        PRUint32 Length() const { return end - start; }
+        nsRefPtr<gfxFT2Font> font;
+        PRUint32 start, end;
+    };
+
+    nsTArray<TextRange> mRanges;
+    nsString mString;
+};
+
+#endif /* GFX_GTKDFBFONTS_H */
+
diff --git a/gfx/thebes/public/gfxFont.h b/gfx/thebes/public/gfxFont.h
--- a/gfx/thebes/public/gfxFont.h
+++ b/gfx/thebes/public/gfxFont.h
@@ -19,10 +19,11 @@
  * the Initial Developer. All Rights Reserved.
  *
  * Contributor(s):
  *   Stuart Parmenter <stuart@mozilla.com>
  *   Masayuki Nakano <masayuki@d-toybox.com>
+ *   John Daggett <jdaggett@mozilla.com>
  *
  * Alternatively, the contents of this file may be used under the terms of
  * either the GNU General Public License Version 2 or later (the "GPL"), or
  * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
  * in which case the provisions of the GPL or the LGPL are applicable instead
@@ -41,10 +42,11 @@
 
 #include "prtypes.h"
 #include "gfxTypes.h"
 #include "nsString.h"
 #include "gfxPoint.h"
+#include "gfxFontUtils.h"
 #include "nsTArray.h"
 #include "nsTHashtable.h"
 #include "nsHashKeys.h"
 #include "gfxSkipChars.h"
 #include "gfxRect.h"
@@ -88,11 +90,11 @@ struct THEBES_API gfxFontStyle {
     PRPackedBool systemFont : 1;
 
     // True if the character set quirks (for treatment of "Symbol",
     // "Wingdings", etc.) should be applied.
     PRPackedBool familyNameQuirks : 1;
-    
+
     // The weight of the font.  100, 200, ... 900 are the weights, and
     // single integer offsets request the next bolder/lighter font
     // available.  For example, for a font available in weights 200,
     // 400, 700, and 900, a weight of 898 should lead to the weight 400
     // font being used, since it is two weights lighter than 900.
@@ -135,10 +137,93 @@ struct THEBES_API gfxFontStyle {
             (weight == other.weight) &&
             (langGroup.Equals(other.langGroup)) &&
             (sizeAdjust == other.sizeAdjust);
     }
 };
+
+
+class gfxFontEntry {
+public:
+    THEBES_INLINE_DECL_REFCOUNTING(gfxFontEntry)
+
+    gfxFontEntry(const nsAString& aName) : 
+        mName(aName), mCmapInitialized(PR_FALSE)
+    { }
+
+    gfxFontEntry(const gfxFontEntry& aEntry) : 
+        mName(aEntry.mName), mItalic(aEntry.mItalic), mFixedPitch(aEntry.mFixedPitch),
+        mUnicodeFont(aEntry.mUnicodeFont), mSymbolFont(aEntry.mSymbolFont), mTrueType(aEntry.mTrueType),
+        mIsType1(aEntry.mIsType1), mWeight(aEntry.mWeight), mCmapInitialized(aEntry.mCmapInitialized),
+        mCharacterMap(aEntry.mCharacterMap)
+    { }
+
+    virtual ~gfxFontEntry();
+
+    // unique name for the face, *not* the family
+    const nsString& Name() const { return mName; }
+
+    PRInt32 Weight() { return mWeight; }
+
+    PRBool IsFixedPitch() { return mFixedPitch; }
+    PRBool IsItalic() { return mItalic; }
+    PRBool IsBold() { return mWeight >= 6; } // bold == weights 600 and above
+
+    inline PRBool HasCharacter(PRUint32 ch) {
+        if (mCharacterMap.test(ch))
+            return PR_TRUE;
+            
+        return TestCharacterMap(ch);
+    }
+
+    virtual PRBool TestCharacterMap(PRUint32 aCh);
+    virtual nsresult ReadCMAP() { return 0; }
+
+    nsString mName;
+
+    PRPackedBool     mItalic      : 1;
+    PRPackedBool     mFixedPitch  : 1;
+
+    PRPackedBool     mUnicodeFont : 1;
+    PRPackedBool     mSymbolFont  : 1;
+    PRPackedBool     mTrueType    : 1;
+    PRPackedBool     mIsType1     : 1;
+
+    PRUint16         mWeight;
+
+    PRPackedBool     mCmapInitialized;
+    gfxSparseBitSet  mCharacterMap;
+};
+
+
+class gfxFontFamily {
+public:
+    THEBES_INLINE_DECL_REFCOUNTING(gfxFontFamily)
+
+    gfxFontFamily(const nsAString& aName) :
+        mName(aName) { }
+
+    virtual ~gfxFontFamily() { }
+
+    const nsString& Name() { return mName; }
+
+    // choose a specific face to match a style using CSS font matching rules (weight matching occurs here)
+    gfxFontEntry *FindFontForStyle(const gfxFontStyle& aFontStyle, PRBool& aNeedsBold);
+
+protected:
+    // fills in an array with weights of faces that match style, returns number of weights in array
+    virtual PRBool FindWeightsForStyle(gfxFontEntry* aFontsForWeights[], const gfxFontStyle& aFontStyle) { return PR_FALSE; }
+
+    nsString mName;
+};
+
+struct gfxTextRange {
+    gfxTextRange(PRUint32 aStart,  PRUint32 aEnd) : start(aStart), end(aEnd) { }
+    PRUint32 Length() const { return end - start; }
+    nsRefPtr<gfxFont> font;
+    PRUint32 start, end;
+};
+
 
 /**
  * Font cache design:
  * 
  * The mFonts hashtable contains most fonts, indexed by (name, style).
@@ -381,14 +466,14 @@ public:
 
 protected:
     nsAutoRefCnt mRefCnt;
 
 public:
-    gfxFont(const nsAString &aName, const gfxFontStyle *aFontGroup);
+    gfxFont(gfxFontEntry *aFontEntry, const gfxFontStyle *aFontStyle);
     virtual ~gfxFont();
 
-    const nsString& GetName() const { return mName; }
+    const nsString& GetName() const { return mFontEntry->Name(); }
     const gfxFontStyle *GetStyle() const { return &mStyle; }
 
     virtual nsString GetUniqueName() = 0;
 
     // Font metrics
@@ -546,20 +631,29 @@ public:
     virtual PRBool SetupCairoFont(gfxContext *aContext) = 0;
 
     PRBool IsSyntheticBold() { return mSyntheticBoldOffset != 0; }
     PRUint32 GetSyntheticBoldOffset() { return mSyntheticBoldOffset; }
     
+    gfxFontEntry *GetFontEntry() { return mFontEntry.get(); }
+    PRBool HasCharacter(PRUint32 ch) {
+        if (!mIsValid)
+            return PR_FALSE;
+        return mFontEntry->HasCharacter(ch); 
+    }
+
 protected:
+    nsRefPtr<gfxFontEntry> mFontEntry;
+
     // The family name of the font
-    nsString                   mName;
+    PRPackedBool               mIsValid;
     nsExpirationState          mExpirationState;
     gfxFontStyle               mStyle;
     nsAutoTArray<gfxGlyphExtents*,1> mGlyphExtentsArray;
 
     // synthetic bolding for environments where this is not supported by the platform
     PRUint32                   mSyntheticBoldOffset;  // number of devunit pixels to offset double-strike, 0 ==> no bolding
-    
+
     // some fonts have bad metrics, this method sanitize them.
     // if this font has bad underline offset, aIsBadUnderlineFont should be true.
     void SanitizeMetrics(gfxFont::Metrics *aMetrics, PRBool aIsBadUnderlineFont);
 };
 
@@ -1485,10 +1579,19 @@ public:
         if (mUnderlineOffset == UNDERLINE_OFFSET_NOT_SET)
             mUnderlineOffset = GetFontAt(0)->GetMetrics().underlineOffset;
         return mUnderlineOffset;
     }
 
+    already_AddRefed<gfxFont> FindFontForChar(PRUint32 ch, PRUint32 prevCh, PRUint32 nextCh, gfxFont *aPrevMatchedFont);
+
+    virtual already_AddRefed<gfxFont> WhichPrefFontSupportsChar(PRUint32 aCh) { return nsnull; }
+
+    virtual already_AddRefed<gfxFont> WhichSystemFontSupportsChar(PRUint32 aCh) { return nsnull; }
+
+    void ComputeRanges(nsTArray<gfxTextRange>& mRanges, const PRUnichar *aString, PRUint32 begin, PRUint32 end);
+
+
 protected:
     nsString mFamilies;
     gfxFontStyle mStyle;
     nsTArray< nsRefPtr<gfxFont> > mFonts;
     gfxFloat mUnderlineOffset;
@@ -1512,7 +1615,18 @@ protected:
                                       PRBool aResolveFontName,
                                       FontCreationCallback fc,
                                       void *closure);
 
     static PRBool FontResolverProc(const nsAString& aName, void *aClosure);
+
+    inline gfxFont* WhichFontSupportsChar(nsTArray< nsRefPtr<gfxFont> >& aFontList, PRUint32 aCh) {
+        PRUint32 len = aFontList.Length();
+        for (PRUint32 i = 0; i < len; i++) {
+            gfxFont* font = aFontList.ElementAt(i).get();
+            if (font && font->HasCharacter(aCh))
+                return font;
+        }
+        return nsnull;
+    }
+
 };
 #endif
diff --git a/gfx/thebes/public/gfxFontUtils.h b/gfx/thebes/public/gfxFontUtils.h
--- a/gfx/thebes/public/gfxFontUtils.h
+++ b/gfx/thebes/public/gfxFontUtils.h
@@ -40,19 +40,21 @@
 #define GFX_FONT_UTILS_H
 
 #include "gfxTypes.h"
 
 #include "prtypes.h"
-#include "gfxFont.h"
 #include "prcpucfg.h"
 
 #include "nsDataHashtable.h"
 
 #include "nsITimer.h"
 #include "nsCOMPtr.h"
 #include "nsIRunnable.h"
 #include "nsThreadUtils.h"
+#include "nsComponentManagerUtils.h"
+#include "nsTArray.h"
+#include "nsAutoPtr.h"
 
 /* Bug 341128 - w32api defines min/max which causes problems with <bitset> */
 #ifdef __MINGW32__
 #undef min
 #undef max
diff --git a/gfx/thebes/public/gfxGdkNativeRenderer.h b/gfx/thebes/public/gfxGdkNativeRenderer.h
new file mode 100644
--- /dev/null
+++ b/gfx/thebes/public/gfxGdkNativeRenderer.h
@@ -0,0 +1,110 @@
+/* -*- Mode: C++; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*-
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Novell code.
+ *
+ * The Initial Developer of the Original Code is Novell.
+ * Portions created by the Initial Developer are Copyright (C) 2006
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   rocallahan@novell.com
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#ifndef GFXGDKNATIVERENDER_H_
+#define GFXGDKNATIVERENDER_H_
+
+#include "gfxColor.h"
+#include <gdk/gdk.h>
+
+class gfxASurface;
+class gfxContext;
+
+/**
+ * This class lets us take code that draws into an GDK drawable and lets us
+ * use it to draw into any Thebes context. The user should subclass this class,
+ * override NativeDraw, and then call Draw(). The drawing will be subjected
+ * to all Thebes transformations, clipping etc.
+ */
+class THEBES_API gfxGdkNativeRenderer {
+public:
+    /**
+     * Perform the native drawing.
+     * @param offsetX draw at this offset into the given drawable
+     * @param offsetY draw at this offset into the given drawable
+     * @param clipRects an array of rects; clip to the union
+     * @param numClipRects the number of rects in the array, or zero if
+     * no clipping is required
+     */
+    virtual nsresult NativeDraw(GdkDrawable * drawable, short offsetX, 
+            short offsetY, GdkRectangle * clipRects, PRUint32 numClipRects) = 0;
+  
+    enum {
+        // If set, then Draw() is opaque, i.e., every pixel in the intersection
+        // of the clipRect and (offset.x,offset.y,bounds.width,bounds.height)
+        // will be set and there is no dependence on what the existing pixels
+        // in the drawable are set to.
+        DRAW_IS_OPAQUE = 0x01,
+        // If set, then offset may be non-zero; if not set, then Draw() can
+        // only be called with offset==(0,0)
+        DRAW_SUPPORTS_OFFSET = 0x02,
+        // If set, then numClipRects can be zero or one
+        DRAW_SUPPORTS_CLIP_RECT = 0x04,
+        // If set, then numClipRects can be any value. If neither this
+        // nor CLIP_RECT are set, then numClipRects will be zero
+        DRAW_SUPPORTS_CLIP_LIST = 0x08,
+        // If set, then the visual passed in can be any visual, otherwise the
+        // visual passed in must be the default visual for dpy's default screen
+        DRAW_SUPPORTS_NONDEFAULT_VISUAL = 0x10,
+        // If set, then the Screen 'screen' in the callback can be different
+        // from the default Screen of the display passed to 'Draw' and can be
+        // on a different display.
+        DRAW_SUPPORTS_ALTERNATE_SCREEN = 0x20
+    };
+
+    struct DrawOutput {
+        nsRefPtr<gfxASurface> mSurface;
+        PRPackedBool mUniformAlpha;
+        PRPackedBool mUniformColor;
+        gfxRGBA      mColor;
+    };
+
+    /**
+     * @param flags see above
+     * @param bounds Draw()'s drawing is guaranteed to be restricted to
+     * the rectangle (offset.x,offset.y,bounds.width,bounds.height)
+     * @param dpy a display to use for the drawing if ctx doesn't have one
+     * @param resultSurface if non-null, we will try to capture a copy of the
+     * rendered image into a surface similar to the surface of ctx; if
+     * successful, a pointer to the new gfxASurface is stored in *resultSurface,
+     * otherwise *resultSurface is set to nsnull.
+     */
+    nsresult Draw(gfxContext* ctx, int width, int height,
+                  PRUint32 flags, DrawOutput* output);
+};
+
+#endif /*GFXGDKNATIVERENDER_H_*/
diff --git a/gfx/thebes/public/gfxOS2Fonts.h b/gfx/thebes/public/gfxOS2Fonts.h
--- a/gfx/thebes/public/gfxOS2Fonts.h
+++ b/gfx/thebes/public/gfxOS2Fonts.h
@@ -49,13 +49,19 @@
 #include "cairo-ft.h" // includes fontconfig.h, too
 #include <freetype/tttables.h>
 
 #include "nsICharsetConverterManager.h"
 
+class gfxOS2FontEntry : public gfxFontEntry {
+public:
+    gfxOS2FontEntry(const nsAString& aName) : gfxFontEntry(aName) {}
+    ~gfxOS2FontEntry() {}
+};
+
 class gfxOS2Font : public gfxFont {
 public:
-    gfxOS2Font(const nsAString &aName, const gfxFontStyle *aFontStyle);
+    gfxOS2Font(gfxOS2FontEntry *aFontEntry, const gfxFontStyle *aFontStyle);
     virtual ~gfxOS2Font();
 
     virtual const gfxFont::Metrics& GetMetrics();
     cairo_font_face_t *CairoFontFace();
     cairo_scaled_font_t *CairoScaledFont();
diff --git a/gfx/thebes/public/gfxPangoFonts.h b/gfx/thebes/public/gfxPangoFonts.h
--- a/gfx/thebes/public/gfxPangoFonts.h
+++ b/gfx/thebes/public/gfxPangoFonts.h
@@ -57,13 +57,24 @@
 #include "nsDataHashtable.h"
 #include "nsClassHashtable.h"
 
 class gfxPangoTextRun;
 
+// stub class until fuller implementation is flushed out
+class gfxPangoFontEntry : public gfxFontEntry {
+public:
+    gfxPangoFontEntry(const nsAString& aName)
+        : gfxFontEntry(aName)
+    { }
+
+    ~gfxPangoFontEntry() {}
+        
+};
+
 class gfxPangoFont : public gfxFont {
 public:
-    gfxPangoFont (const nsAString& aName,
+    gfxPangoFont (gfxPangoFontEntry *aFontEntry,
                   const gfxFontStyle *aFontStyle);
     virtual ~gfxPangoFont ();
     static already_AddRefed<gfxPangoFont> GetOrMakeFont(PangoFont *aPangoFont);
 
     static void Shutdown();
@@ -94,11 +105,11 @@ protected:
     PRBool   mHasMetrics;
     PRUint32 mSpaceGlyph;
     Metrics  mMetrics;
     gfxFloat mAdjustedSize;
 
-    gfxPangoFont(PangoFont *aPangoFont, const nsAString &aName,
+    gfxPangoFont(PangoFont *aPangoFont, gfxPangoFontEntry *aFontEntry,
                  const gfxFontStyle *aFontStyle);
     void RealizePangoFont();
     void GetCharSize(const char aChar, gfxSize& aInkSize, gfxSize& aLogSize,
                      PRUint32 *aGlyphID = nsnull);
 
diff --git a/gfx/thebes/public/gfxPlatform.h b/gfx/thebes/public/gfxPlatform.h
--- a/gfx/thebes/public/gfxPlatform.h
+++ b/gfx/thebes/public/gfxPlatform.h
@@ -51,10 +51,11 @@
 
 typedef void* cmsHPROFILE;
 typedef void* cmsHTRANSFORM;
 
 class gfxImageSurface;
+class gfxFont;
 class gfxFontGroup;
 struct gfxFontStyle;
 
 // pref lang id's for font prefs
 // !!! needs to match the list of pref font.default.xx entries listed in all.js !!!
diff --git a/gfx/thebes/public/gfxPlatformGtk.h b/gfx/thebes/public/gfxPlatformGtk.h
--- a/gfx/thebes/public/gfxPlatformGtk.h
+++ b/gfx/thebes/public/gfxPlatformGtk.h
@@ -37,15 +37,24 @@
  * ***** END LICENSE BLOCK ***** */
 
 #ifndef GFX_PLATFORM_GTK_H
 #define GFX_PLATFORM_GTK_H
 
-#include <gdk/gdkx.h>
-
 #include "gfxPlatform.h"
 
+extern "C" {
+    typedef struct _GdkDrawable GdkDrawable;
+}
+
 class gfxFontconfigUtils;
+#ifndef MOZ_PANGO
+class FontFamily;
+class FontEntry;
+typedef struct FT_LibraryRec_ *FT_Library;
+#endif
+
+
 
 class THEBES_API gfxPlatformGtk : public gfxPlatform {
 public:
     gfxPlatformGtk();
     virtual ~gfxPlatformGtk();
@@ -70,17 +79,30 @@ public:
     nsresult GetStandardFamilyName(const nsAString& aFontName, nsAString& aFamilyName);
 
     gfxFontGroup *CreateFontGroup(const nsAString &aFamilies,
                                   const gfxFontStyle *aStyle);
 
+#ifndef MOZ_PANGO
+    FontFamily *FindFontFamily(const nsAString& aName);
+    FontEntry *FindFontEntry(const nsAString& aFamilyName, const gfxFontStyle& aFontStyle);
+#endif
+
     static PRInt32 DPI() {
         if (sDPI == -1) {
             InitDPI();
         }
         NS_ASSERTION(sDPI > 0, "Something is wrong");
         return sDPI;
     }
+
+#ifndef MOZ_PANGO
+    FT_Library GetFTLibrary();
+#endif
+
+    void SetGdkDrawable(gfxASurface *target,
+                        GdkDrawable *drawable);
+    GdkDrawable *GetGdkDrawable(gfxASurface *target);
 
 protected:
     static void InitDPI();
 
     static PRInt32 sDPI;
diff --git a/gfx/thebes/public/gfxWindowsFonts.h b/gfx/thebes/public/gfxWindowsFonts.h
--- a/gfx/thebes/public/gfxWindowsFonts.h
+++ b/gfx/thebes/public/gfxWindowsFonts.h
@@ -19,10 +19,11 @@
  * the Initial Developer. All Rights Reserved.
  *
  * Contributor(s):
  *   Stuart Parmenter <stuart@mozilla.com>
  *   Masayuki Nakano <masayuki@d-toybox.com>
+ *   John Daggett <jdaggett@mozilla.com>
  *
  * Alternatively, the contents of this file may be used under the terms of
  * either the GNU General Public License Version 2 or later (the "GPL"), or
  * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
  * in which case the provisions of the GPL or the LGPL are applicable instead
@@ -76,17 +77,15 @@ enum gfxWindowsFontType {
  * FontFamily is a class that describes one of the fonts on the users system.  It holds
  * each FontEntry (maps more directly to a font face) which holds font type, charset info
  * and character map info.
  */
 class FontEntry;
-class FontFamily
+class FontFamily : public gfxFontFamily
 {
 public:
-    THEBES_INLINE_DECL_REFCOUNTING(FontFamily)
-
     FontFamily(const nsAString& aName) :
-        mName(aName), mHasStyles(PR_FALSE), mIsBadUnderlineFont(PR_FALSE) { }
+        gfxFontFamily(aName), mHasStyles(PR_FALSE), mIsBadUnderlineFont(PR_FALSE) { }
 
     FontEntry *FindFontEntry(const gfxFontStyle& aFontStyle);
 
 private:
     friend class gfxWindowsPlatform;
@@ -95,52 +94,45 @@ private:
 
     static int CALLBACK FamilyAddStylesProc(const ENUMLOGFONTEXW *lpelfe,
                                             const NEWTEXTMETRICEXW *nmetrics,
                                             DWORD fontType, LPARAM data);
 
+protected:
+    PRBool FindWeightsForStyle(gfxFontEntry* aFontsForWeights[], const gfxFontStyle& aFontStyle);
+
 public:
     nsTArray<nsRefPtr<FontEntry> > mVariations;
-    nsString mName;
     PRPackedBool mIsBadUnderlineFont;
 
 private:
     PRBool mHasStyles;
 };
 
-class FontEntry
+class FontEntry : public gfxFontEntry
 {
 public:
-    THEBES_INLINE_DECL_REFCOUNTING(FontEntry)
-
     FontEntry(const nsString& aFaceName) : 
-        mFaceName(aFaceName), mFontType(GFX_FONT_TYPE_UNKNOWN),
-        mUnicodeFont(PR_FALSE), mSymbolFont(PR_FALSE),
+        gfxFontEntry(aFaceName), mFontType(GFX_FONT_TYPE_UNKNOWN),
         mIsBadUnderlineFont(PR_FALSE), mForceGDI(PR_FALSE), mUnknownCMAP(PR_FALSE),
         mCharset(0), mUnicodeRanges(0)
     {
+        mUnicodeFont = PR_FALSE;
+        mSymbolFont = PR_FALSE;
     }
 
     FontEntry(const FontEntry& aFontEntry) :
-        mFaceName(aFontEntry.mFaceName),
+        gfxFontEntry(aFontEntry),
         mWindowsFamily(aFontEntry.mWindowsFamily),
         mWindowsPitch(aFontEntry.mWindowsPitch),
         mFontType(aFontEntry.mFontType),
-        mUnicodeFont(aFontEntry.mUnicodeFont),
-        mSymbolFont(aFontEntry.mSymbolFont),
         mIsBadUnderlineFont(aFontEntry.mIsBadUnderlineFont),
         mForceGDI(aFontEntry.mForceGDI),
         mUnknownCMAP(aFontEntry.mUnknownCMAP),
-        mItalic(aFontEntry.mItalic),
-        mWeight(aFontEntry.mWeight),
         mCharset(aFontEntry.mCharset),
-        mUnicodeRanges(aFontEntry.mUnicodeRanges),
-        mCharacterMap(aFontEntry.mCharacterMap)
+        mUnicodeRanges(aFontEntry.mUnicodeRanges)
     {
-    }
 
-    const nsString& GetName() const {
-        return mFaceName;
     }
 
     PRBool IsType1() const {
         return (mFontType == GFX_FONT_TYPE_TYPE1);
     }
@@ -241,39 +233,33 @@ public:
     }
 
     // whether this font family is in "bad" underline offset blacklist.
     PRBool IsBadUnderlineFont() { return mIsBadUnderlineFont != 0; }
 
-    nsString mFaceName;
+    PRBool TestCharacterMap(PRUint32 aCh);
 
     PRUint8 mWindowsFamily;
     PRUint8 mWindowsPitch;
 
     gfxWindowsFontType mFontType;
-    PRPackedBool mUnicodeFont : 1;
-    PRPackedBool mSymbolFont  : 1;
     PRPackedBool mIsBadUnderlineFont : 1;
     PRPackedBool mForceGDI    : 1;
     PRPackedBool mUnknownCMAP : 1;
-    PRPackedBool mItalic      : 1;
-    PRUint16 mWeight;
 
     std::bitset<256> mCharset;
     std::bitset<128> mUnicodeRanges;
-
-    gfxSparseBitSet mCharacterMap;
 };
 
 /**********************************************************************
  *
  * class gfxWindowsFont
  *
  **********************************************************************/
 
 class gfxWindowsFont : public gfxFont {
 public:
-    gfxWindowsFont(const nsAString& aName, const gfxFontStyle *aFontStyle, FontEntry *aFontEntry);
+    gfxWindowsFont(FontEntry *aFontEntry, const gfxFontStyle *aFontStyle);
     virtual ~gfxWindowsFont();
 
     virtual const gfxFont::Metrics& GetMetrics();
 
     HFONT GetHFONT() { return mFont; }
@@ -292,11 +278,11 @@ public:
         GetMetrics(); // ensure that the metrics are computed but don't recompute them
         return mSpaceGlyph;
     };
 
     PRBool IsValid() { GetMetrics(); return mIsValid; }
-    FontEntry *GetFontEntry() { return mFontEntry; }
+    FontEntry *GetFontEntry();
 
     static already_AddRefed<gfxWindowsFont>
     GetOrMakeFont(FontEntry *aFontEntry, const gfxFontStyle *aStyle);
 
 protected:
@@ -317,13 +303,10 @@ private:
 
     gfxFont::Metrics *mMetrics;
 
     LOGFONTW mLogFont;
 
-    nsRefPtr<FontEntry> mFontEntry;
-    PRPackedBool mIsValid;
-    
     virtual PRBool SetupCairoFont(gfxContext *aContext);
 };
 
 /**********************************************************************
  *
@@ -364,18 +347,29 @@ public:
     void GroupFamilyListToArrayList(nsTArray<nsRefPtr<FontEntry> > *list);
     void FamilyListToArrayList(const nsString& aFamilies,
                                const nsCString& aLangGroup,
                                nsTArray<nsRefPtr<FontEntry> > *list);
 
+
 protected:
     void InitTextRunGDI(gfxContext *aContext, gfxTextRun *aRun, const char *aString, PRUint32 aLength);
     void InitTextRunGDI(gfxContext *aContext, gfxTextRun *aRun, const PRUnichar *aString, PRUint32 aLength);
 
     void InitTextRunUniscribe(gfxContext *aContext, gfxTextRun *aRun, const PRUnichar *aString, PRUint32 aLength);
 
+    already_AddRefed<gfxFont> WhichPrefFontSupportsChar(PRUint32 aCh);
+    already_AddRefed<gfxFont> WhichSystemFontSupportsChar(PRUint32 aCh);
+
+    already_AddRefed<gfxWindowsFont> WhichFontSupportsChar(const nsTArray<nsRefPtr<FontEntry> >& fonts, PRUint32 ch);
+    void GetPrefFonts(const char *aLangGroup, nsTArray<nsRefPtr<FontEntry> >& array);
+    void GetCJKPrefFonts(nsTArray<nsRefPtr<FontEntry> >& array);
+
 private:
 
     nsCString mGenericFamily;
     nsTArray<nsRefPtr<FontEntry> > mFontEntries;
+
+    const char *mItemLangGroup;  // used by pref-lang handling code
+
 };
 
 #endif /* GFX_WINDOWSFONTS_H */
diff --git a/gfx/thebes/public/gfxXlibNativeRenderer.h b/gfx/thebes/public/gfxXlibNativeRenderer.h
deleted file mode 100644
--- a/gfx/thebes/public/gfxXlibNativeRenderer.h
+++ /dev/null
@@ -1,112 +0,0 @@
-/* -*- Mode: C++; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*-
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is Novell code.
- *
- * The Initial Developer of the Original Code is Novell.
- * Portions created by the Initial Developer are Copyright (C) 2006
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *   rocallahan@novell.com
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#ifndef GFXXLIBNATIVERENDER_H_
-#define GFXXLIBNATIVERENDER_H_
-
-#include "gfxColor.h"
-#include <X11/Xlib.h>
-
-class gfxASurface;
-class gfxContext;
-
-/**
- * This class lets us take code that draws into an X drawable and lets us
- * use it to draw into any Thebes context. The user should subclass this class,
- * override NativeDraw, and then call Draw(). The drawing will be subjected
- * to all Thebes transformations, clipping etc.
- */
-class THEBES_API gfxXlibNativeRenderer {
-public:
-    /**
-     * Perform the native drawing.
-     * @param offsetX draw at this offset into the given drawable
-     * @param offsetY draw at this offset into the given drawable
-     * @param clipRects an array of rects; clip to the union
-     * @param numClipRects the number of rects in the array, or zero if
-     * no clipping is required
-     */
-    virtual nsresult NativeDraw(Screen* screen, Drawable drawable,
-                                Visual* visual, Colormap colormap,
-                                short offsetX, short offsetY,
-                                XRectangle* clipRects, PRUint32 numClipRects) = 0;
-  
-    enum {
-        // If set, then Draw() is opaque, i.e., every pixel in the intersection
-        // of the clipRect and (offset.x,offset.y,bounds.width,bounds.height)
-        // will be set and there is no dependence on what the existing pixels
-        // in the drawable are set to.
-        DRAW_IS_OPAQUE = 0x01,
-        // If set, then offset may be non-zero; if not set, then Draw() can
-        // only be called with offset==(0,0)
-        DRAW_SUPPORTS_OFFSET = 0x02,
-        // If set, then numClipRects can be zero or one
-        DRAW_SUPPORTS_CLIP_RECT = 0x04,
-        // If set, then numClipRects can be any value. If neither this
-        // nor CLIP_RECT are set, then numClipRects will be zero
-        DRAW_SUPPORTS_CLIP_LIST = 0x08,
-        // If set, then the visual passed in can be any visual, otherwise the
-        // visual passed in must be the default visual for 'screen'
-        DRAW_SUPPORTS_NONDEFAULT_VISUAL = 0x10,
-        // If set, then the Screen 'screen' in the callback can be different
-        // from the default Screen of the display passed to 'Draw' and can be
-        // on a different display.
-        DRAW_SUPPORTS_ALTERNATE_SCREEN = 0x20
-    };
-
-    struct DrawOutput {
-        nsRefPtr<gfxASurface> mSurface;
-        PRPackedBool mUniformAlpha;
-        PRPackedBool mUniformColor;
-        gfxRGBA      mColor;
-    };
-
-    /**
-     * @param flags see above
-     * @param bounds Draw()'s drawing is guaranteed to be restricted to
-     * the rectangle (offset.x,offset.y,bounds.width,bounds.height)
-     * @param dpy a display to use for the drawing if ctx doesn't have one
-     * @param resultSurface if non-null, we will try to capture a copy of the
-     * rendered image into a surface similar to the surface of ctx; if
-     * successful, a pointer to the new gfxASurface is stored in *resultSurface,
-     * otherwise *resultSurface is set to nsnull.
-     */
-    nsresult Draw(Display* dpy, gfxContext* ctx, int width, int height,
-                  PRUint32 flags, DrawOutput* output);
-};
-
-#endif /*GFXXLIBNATIVERENDER_H_*/
diff --git a/gfx/thebes/src/Makefile.in b/gfx/thebes/src/Makefile.in
--- a/gfx/thebes/src/Makefile.in
+++ b/gfx/thebes/src/Makefile.in
@@ -78,17 +78,39 @@ EXTRA_DSO_LDOPTS += $(MOZ_CAIRO_LIBS)
 EXTRA_DSO_LDOPTS += $(MOZ_CAIRO_LIBS)
 REQUIRES += uconv
 endif
 
 ifeq ($(MOZ_WIDGET_TOOLKIT),gtk2)
-CPPSRCS +=      gfxXlibSurface.cpp gfxPlatformGtk.cpp gfxXlibNativeRenderer.cpp
-CPPSRCS +=	gfxPangoFonts.cpp 
+
+ifdef MOZ_PANGO
+CPPSRCS += gfxPangoFonts.cpp
+else
+CPPSRCS += gfxFT2Fonts.cpp
+endif
+
+ifdef MOZ_X11
+CPPSRCS += gfxXlibSurface.cpp
+endif
+
+CPPSRCS +=  gfxPlatformGtk.cpp gfxGdkNativeRenderer.cpp
 CPPSRCS +=	gfxPDFSurface.cpp gfxPSSurface.cpp
 CPPSRCS +=	gfxFontconfigUtils.cpp
 CPPSRCS +=	nsUnicodeRange.cpp
+
+ifdef MOZ_X11
 CSRCS = cairo-xlib-utils.c
+endif
+
+ifdef MOZ_DFB
+CSRCS = cairo-gdk-utils.c
+endif
+
 EXTRA_DSO_LDOPTS += $(MOZ_PANGO_LIBS) $(ZLIB_LIBS) $(MOZ_XFT_LIBS) $(XLDFLAGS) $(XLIBS)
+endif
+
+ifdef MOZ_DFB
+CPPSRCS += gfxDirectFBSurface.cpp
 endif
 
 ifeq ($(MOZ_WIDGET_TOOLKIT),beos)
 CPPSRCS	+= 	gfxBeOSSurface.cpp gfxBeOSPlatform.cpp
 CPPSRCS +=	gfxPangoFonts.cpp 
diff --git a/gfx/thebes/src/cairo-gdk-utils.c b/gfx/thebes/src/cairo-gdk-utils.c
new file mode 100644
--- /dev/null
+++ b/gfx/thebes/src/cairo-gdk-utils.c
@@ -0,0 +1,108 @@
+/* -*- Mode: C++; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*-
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Novell code.
+ *
+ * The Initial Developer of the Original Code is Novell.
+ * Portions created by the Initial Developer are Copyright (C) 2006
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   rocallahan@novell.com
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#include "cairo-gdk-utils.h"
+
+#include <stdlib.h>
+
+#if   HAVE_STDINT_H
+#include <stdint.h>
+#elif HAVE_INTTYPES_H
+#include <inttypes.h>
+#elif HAVE_SYS_INT_TYPES_H
+#include <sys/int_types.h>
+#endif
+
+
+/* We have three basic strategies available:
+   1) 'direct': cr targets a native surface, and other conditions are met: we can
+      pass the underlying drawable directly to the callback
+   2) 'opaque': the image is opaque: we can create a temporary cairo native surface,
+      pass its underlying drawable to the callback, and paint the result
+      using cairo
+   3) 'default': create a temporary cairo native surface, fill with black, pass its
+      underlying drawable to the callback, copy the results to a cairo
+      image surface, repeat with a white background, update the on-black
+      image alpha values by comparing the two images, then paint the on-black
+      image using cairo
+   Sure would be nice to have an X extension to do 3 for us on the server...
+*/
+
+static cairo_bool_t
+_convert_coord_to_short (double coord, short *v)
+{
+    *v = (short)coord;
+    /* XXX allow some tolerance here? */
+    return *v == coord;
+}
+
+static cairo_bool_t
+_convert_coord_to_unsigned_short (double coord, unsigned short *v)
+{
+    *v = (unsigned short)coord;
+    /* XXX allow some tolerance here? */
+    return *v == coord;
+}
+
+
+void cairo_draw_with_gdk (cairo_t *cr,
+                           GdkDrawable * drawable,
+                           cairo_gdk_drawing_callback callback,
+                           void * closure,
+                           unsigned int width, unsigned int height,
+                           cairo_gdk_drawing_opacity_t is_opaque,
+                           cairo_gdk_drawing_support_t capabilities,
+                           cairo_gdk_drawing_result_t *result)
+{
+    double device_offset_x, device_offset_y;
+    short offset_x = 0, offset_y = 0;
+    //cairo_surface_t * target = cairo_get_group_target (cr);
+    cairo_surface_t * target = cairo_get_target (cr);
+    cairo_matrix_t matrix;
+
+    cairo_surface_get_device_offset (target, &device_offset_x, &device_offset_y);
+    cairo_get_matrix (cr, &matrix);
+
+    _convert_coord_to_short (matrix.x0 + device_offset_x, &offset_x);
+    _convert_coord_to_short (matrix.y0 + device_offset_y, &offset_y);
+
+    cairo_surface_flush (target);
+    callback (closure, drawable, offset_x, offset_y, NULL, 0);
+    cairo_surface_mark_dirty (target);
+}
+
+
diff --git a/gfx/thebes/src/cairo-gdk-utils.h b/gfx/thebes/src/cairo-gdk-utils.h
new file mode 100644
--- /dev/null
+++ b/gfx/thebes/src/cairo-gdk-utils.h
@@ -0,0 +1,149 @@
+/* -*- Mode: C++; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*-
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Novell code.
+ *
+ * The Initial Developer of the Original Code is Novell.
+ * Portions created by the Initial Developer are Copyright (C) 2006
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   rocallahan@novell.com
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#ifndef CAIROGDKUTILS_H_
+#define CAIROGDKUTILS_H_
+
+#include "cairo.h"
+#include <gdk/gdk.h>
+
+CAIRO_BEGIN_DECLS
+
+/**
+ * This callback encapsulates GDK-based rendering. We assume that the
+ * execution of the callback is equivalent to compositing some RGBA image of
+ * size (bounds_width, bounds_height) onto the drawable at offset (offset_x,
+ * offset_y), clipped to the union of the clip_rects if num_rects is greater
+ * than zero. This includes the assumption that the same RGBA image
+ * is composited if you call the callback multiple times with the same closure,
+ * display and visual during a single cairo_draw_with_gdk call.
+ * 
+ * @return True on success, False on non-recoverable error
+ */
+typedef cairo_bool_t (* cairo_gdk_drawing_callback)
+    (void *closure,
+     GdkDrawable * drawable,
+     short offset_x, short offset_y,
+     GdkRectangle * clip_rects, unsigned int num_rects);
+
+/**
+ * This structure captures the result of the native drawing, in case the
+ * caller may wish to reapply the drawing efficiently later.
+ */
+typedef struct {
+    cairo_surface_t *surface;
+    cairo_bool_t    uniform_alpha;
+    cairo_bool_t    uniform_color;
+    double          alpha; /* valid only if uniform_alpha is TRUE */
+    double          r, g, b; /* valid only if uniform_color is TRUE */
+} cairo_gdk_drawing_result_t;
+
+/**
+ * This type specifies whether the native drawing callback draws all pixels
+ * in its bounds opaquely, independent of the contents of the target drawable,
+ * or whether it leaves pixels transparent/translucent or depends on the
+ * existing contents of the target drawable in some way.
+ */
+typedef enum _cairo_gdk_drawing_opacity {
+    CAIRO_GDK_DRAWING_OPAQUE,
+    CAIRO_GDK_DRAWING_TRANSPARENT
+} cairo_gdk_drawing_opacity_t;
+
+/**
+ * This type encodes the capabilities of the native drawing callback.
+ * 
+ * If CAIRO_GDK_DRAWING_SUPPORTS_OFFSET is set, 'offset_x' and 'offset_y'
+ * can be nonzero in the call to the callback; otherwise they will be zero.
+ * 
+ * If CAIRO_GDK_DRAWING_SUPPORTS_CLIP_RECT is set, then 'num_rects' can be
+ * zero or one in the call to the callback. If
+ * CAIRO_GDK_DRAWING_SUPPORTS_CLIP_LIST is set, then 'num_rects' can be
+ * anything in the call to the callback. Otherwise 'num_rects' will be zero.
+ * Do not set both of these values.
+ * 
+ * If CAIRO_GDK_DRAWING_SUPPORTS_ALTERNATE_DISPLAY is set, then 'dpy' can be
+ * any display, otherwise it will be the display passed into
+ * cairo_draw_with_gdk.
+ * 
+ * If CAIRO_GDK_DRAWING_SUPPORTS_NONDEFAULT_VISUAL is set, then 'visual' can be
+ * any visual, otherwise it will be equal to
+ * DefaultVisual (dpy, DefaultScreen (dpy)).
+ */
+typedef enum {
+    CAIRO_GDK_DRAWING_SUPPORTS_OFFSET = 0x01,
+    CAIRO_GDK_DRAWING_SUPPORTS_CLIP_RECT = 0x02,
+    CAIRO_GDK_DRAWING_SUPPORTS_CLIP_LIST = 0x04,
+    CAIRO_GDK_DRAWING_SUPPORTS_ALTERNATE_SCREEN = 0x08,
+    CAIRO_GDK_DRAWING_SUPPORTS_NONDEFAULT_VISUAL = 0x10
+} cairo_gdk_drawing_support_t;
+
+/**
+ * Draw GDK output into any cairo context. All cairo transforms and effects
+ * are honored, including the current operator. This is equivalent to a
+ * cairo_set_source_surface and then cairo_paint.
+ * @param cr the context to draw into
+ * @param drawable a GDK Drawable that we're targetting
+ * @param callback the code to perform GDK rendering
+ * @param closure associated data
+ * @param width the width of the putative image drawn by the callback
+ * @param height the height of the putative image drawn by the callback
+ * @param is_opaque set to CAIRO_GDK_DRAWING_IS_OPAQUE to indicate
+ * that all alpha values of the putative image will be 1.0; the pixels drawn into
+ * the Drawable must not depend on the prior contents of the Drawable
+ * in any way
+ * @param capabilities the capabilities of the callback as described above.
+ * @param result if non-NULL, we *may* fill in the struct with information about
+ * the rendered image. 'surface' may be filled in with a surface representing
+ * the image, similar to the target of 'cr'. If 'uniform_alpha' is True then
+ * every pixel of the image has the same alpha value 'alpha'. If
+ * 'uniform_color' is True then every pixel of the image has the same RGB
+ * color (r, g, b). If the image has uniform color and alpha (or alpha is zero,
+ * in which case the color is always uniform) then we won't bother returning
+ * a surface for it.
+ */
+void cairo_draw_with_gdk (cairo_t *cr,
+                          GdkDrawable * drawable,
+                          cairo_gdk_drawing_callback callback,
+                          void * closure,
+                          unsigned int width, unsigned int height,
+                          cairo_gdk_drawing_opacity_t is_opaque,
+                          cairo_gdk_drawing_support_t capabilities,
+                          cairo_gdk_drawing_result_t *result);
+
+CAIRO_END_DECLS
+
+#endif /*CAIROGDKUTILS_H_*/
diff --git a/gfx/thebes/src/cairo-xlib-utils.c b/gfx/thebes/src/cairo-xlib-utils.c
--- a/gfx/thebes/src/cairo-xlib-utils.c
+++ b/gfx/thebes/src/cairo-xlib-utils.c
@@ -33,11 +33,11 @@
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
-#include "cairo-xlib-utils.h"
+#include "cairo-gdk-utils.h"
 
 #include "cairo-xlib.h"
 #include <stdlib.h>
 
 #if   HAVE_STDINT_H
@@ -46,29 +46,24 @@
 #include <inttypes.h>
 #elif HAVE_SYS_INT_TYPES_H
 #include <sys/int_types.h>
 #endif
 
+#include <gdk/gdkx.h>
+
 #if 0
 #include <stdio.h>
-#define CAIRO_XLIB_DRAWING_NOTE(m) fprintf(stderr, m)
+#define CAIRO_GDK_DRAWING_NOTE(m) fprintf(stderr, m)
 #else
-#define CAIRO_XLIB_DRAWING_NOTE(m) do {} while (0)
+#define CAIRO_GDK_DRAWING_NOTE(m) do {} while (0)
 #endif
 
 static cairo_user_data_key_t pixmap_free_key;
-
-typedef struct {
-    Display *dpy;
-    Pixmap   pixmap;
-} pixmap_free_struct;
-
 static void pixmap_free_func (void *data)
 {
-    pixmap_free_struct *pfs = (pixmap_free_struct *) data;
-    XFreePixmap (pfs->dpy, pfs->pixmap);
-    free (pfs);
+    GdkPixmap *pixmap = (GdkPixmap *) data;
+    g_object_unref(pixmap);
 }
 
 /* We have three basic strategies available:
    1) 'direct': cr targets an xlib surface, and other conditions are met: we can
       pass the underlying drawable directly to the callback
@@ -82,21 +77,13 @@ static void pixmap_free_func (void *data
       image using cairo
    Sure would be nice to have an X extension to do 3 for us on the server...
 */
 
 static cairo_bool_t
-_convert_coord_to_short (double coord, short *v)
+_convert_coord_to_int (double coord, int *v)
 {
-    *v = (short)coord;
-    /* XXX allow some tolerance here? */
-    return *v == coord;
-}
-
-static cairo_bool_t
-_convert_coord_to_unsigned_short (double coord, unsigned short *v)
-{
-    *v = (unsigned short)coord;
+    *v = (int)coord;
     /* XXX allow some tolerance here? */
     return *v == coord;
 }
 
 static cairo_bool_t
@@ -117,11 +104,11 @@ static cairo_bool_t
 static cairo_bool_t
 _get_rectangular_clip (cairo_t *cr,
                        int bounds_x, int bounds_y,
                        int bounds_width, int bounds_height,
                        cairo_bool_t *need_clip,
-                       XRectangle *rectangles, int max_rectangles,
+                       GdkRectangle *rectangles, int max_rectangles,
                        int *num_rectangles)
 {
     cairo_rectangle_list_t *cliplist;
     cairo_rectangle_t *clips;
     int i;
@@ -159,21 +146,21 @@ _get_rectangular_clip (cairo_t *cr,
         
         if (_intersect_interval (b_x, b_x_most, clips[i].x, clips[i].x + clips[i].width,
                                  &intersect_x, &intersect_x_most) &&
             _intersect_interval (b_y, b_y_most, clips[i].y, clips[i].y + clips[i].height,
                                  &intersect_y, &intersect_y_most)) {
-            XRectangle *rect = &rectangles[rect_count];
+            GdkRectangle *rect = &rectangles[rect_count];
 
             if (rect_count >= max_rectangles) {
                 retval = False;
                 goto FINISH;
             }
 
-            if (!_convert_coord_to_short (intersect_x, &rect->x) ||
-                !_convert_coord_to_short (intersect_y, &rect->y) ||
-                !_convert_coord_to_unsigned_short (intersect_x_most - intersect_x, &rect->width) ||
-                !_convert_coord_to_unsigned_short (intersect_y_most - intersect_y, &rect->height))
+            if (!_convert_coord_to_int (intersect_x, &rect->x) ||
+                !_convert_coord_to_int (intersect_y, &rect->y) ||
+                !_convert_coord_to_int (intersect_x_most - intersect_x, &rect->width) ||
+                !_convert_coord_to_int (intersect_y_most - intersect_y, &rect->height))
             {
                 retval = False;
                 goto FINISH;
             }
 
@@ -198,21 +185,21 @@ FINISH:
  * @return True if we took the direct path
  */
 static cairo_bool_t
 _draw_with_xlib_direct (cairo_t *cr,
                         Display *default_display,
-                        cairo_xlib_drawing_callback callback,
+                        cairo_gdk_drawing_callback callback,
                         void *closure,
                         int bounds_width, int bounds_height,
-                        cairo_xlib_drawing_support_t capabilities)
+                        cairo_gdk_drawing_support_t capabilities)
 {
     cairo_surface_t *target;
     Drawable d;
     cairo_matrix_t matrix;
-    short offset_x, offset_y;
+    int offset_x, offset_y;
     cairo_bool_t needs_clip;
-    XRectangle rectangles[MAX_STATIC_CLIP_RECTANGLES];
+    GdkRectangle rectangles[MAX_STATIC_CLIP_RECTANGLES];
     int rect_count;
     double device_offset_x, device_offset_y;
     int max_rectangles;
     Screen *screen;
     Visual *visual;
@@ -225,26 +212,26 @@ _draw_with_xlib_direct (cairo_t *cr,
     cairo_get_matrix (cr, &matrix);
     
     /* Check that the matrix is a pure translation */
     /* XXX test some approximation to == 1.0 here? */
     if (matrix.xx != 1.0 || matrix.yy != 1.0 || matrix.xy != 0.0 || matrix.yx != 0.0) {
-        CAIRO_XLIB_DRAWING_NOTE("TAKING SLOW PATH: matrix not a pure translation\n");
+        CAIRO_GDK_DRAWING_NOTE("TAKING SLOW PATH: matrix not a pure translation\n");
         return False;
     }
     /* Check that the matrix translation offsets (adjusted for
        device offset) are integers */
-    if (!_convert_coord_to_short (matrix.x0 + device_offset_x, &offset_x) ||
-        !_convert_coord_to_short (matrix.y0 + device_offset_y, &offset_y)) {
-        CAIRO_XLIB_DRAWING_NOTE("TAKING SLOW PATH: non-integer offset\n");
+    if (!_convert_coord_to_int (matrix.x0 + device_offset_x, &offset_x) ||
+        !_convert_coord_to_int (matrix.y0 + device_offset_y, &offset_y)) {
+        CAIRO_GDK_DRAWING_NOTE("TAKING SLOW PATH: non-integer offset\n");
         return False;
     }
     
     max_rectangles = 0;
-    if (capabilities & CAIRO_XLIB_DRAWING_SUPPORTS_CLIP_RECT) {
+    if (capabilities & CAIRO_GDK_DRAWING_SUPPORTS_CLIP_RECT) {
       max_rectangles = 1;
     }
-    if (capabilities & CAIRO_XLIB_DRAWING_SUPPORTS_CLIP_LIST) {
+    if (capabilities & CAIRO_GDK_DRAWING_SUPPORTS_CLIP_LIST) {
       max_rectangles = MAX_STATIC_CLIP_RECTANGLES;
     }
     
     /* Check that the clip is rectangular and aligned on unit boundaries. */
     /* Temporarily set the matrix for _get_rectangular_clip. It's basically
@@ -257,151 +244,143 @@ _draw_with_xlib_direct (cairo_t *cr,
                                offset_x, offset_y, bounds_width, bounds_height,
                                &needs_clip,
                                rectangles, max_rectangles, &rect_count);
     cairo_set_matrix (cr, &matrix);
     if (!have_rectangular_clip) {
-        CAIRO_XLIB_DRAWING_NOTE("TAKING SLOW PATH: unsupported clip\n");
+        CAIRO_GDK_DRAWING_NOTE("TAKING SLOW PATH: unsupported clip\n");
         return False;
     }
 
     /* Stop now if everything is clipped out */
     if (needs_clip && rect_count == 0) {
-        CAIRO_XLIB_DRAWING_NOTE("TAKING FAST PATH: all clipped\n");
+        CAIRO_GDK_DRAWING_NOTE("TAKING FAST PATH: all clipped\n");
         return True;
     }
       
     /* Check that the operator is OVER */
     if (cairo_get_operator (cr) != CAIRO_OPERATOR_OVER) {
-        CAIRO_XLIB_DRAWING_NOTE("TAKING SLOW PATH: non-OVER operator\n");
+        CAIRO_GDK_DRAWING_NOTE("TAKING SLOW PATH: non-OVER operator\n");
         return False;
     }
     
     /* Check that the offset is supported */  
-    if (!(capabilities & CAIRO_XLIB_DRAWING_SUPPORTS_OFFSET) &&
+    if (!(capabilities & CAIRO_GDK_DRAWING_SUPPORTS_OFFSET) &&
         (offset_x != 0 || offset_y != 0)) {
-        CAIRO_XLIB_DRAWING_NOTE("TAKING SLOW PATH: unsupported offset\n");
+        CAIRO_GDK_DRAWING_NOTE("TAKING SLOW PATH: unsupported offset\n");
         return False;
     }
     
     /* Check that the target surface is an xlib surface. Do this late because
        we might complete early above when when the object to be drawn is
        completely clipped out. */
     if (!d) {
-        CAIRO_XLIB_DRAWING_NOTE("TAKING SLOW PATH: non-X surface\n");
+        CAIRO_GDK_DRAWING_NOTE("TAKING SLOW PATH: non-X surface\n");
         return False;
     }
     
     /* Check that the display is supported */  
     screen = cairo_xlib_surface_get_screen (target);
-    if (!(capabilities & CAIRO_XLIB_DRAWING_SUPPORTS_ALTERNATE_SCREEN) &&
+    if (!(capabilities & CAIRO_GDK_DRAWING_SUPPORTS_ALTERNATE_SCREEN) &&
         screen != DefaultScreenOfDisplay (default_display)) {
-        CAIRO_XLIB_DRAWING_NOTE("TAKING SLOW PATH: non-default display\n");
+        CAIRO_GDK_DRAWING_NOTE("TAKING SLOW PATH: non-default display\n");
         return False;
     }
         
     /* Check that there is a visual */
     visual = cairo_xlib_surface_get_visual (target);
     if (!visual) {
-        CAIRO_XLIB_DRAWING_NOTE("TAKING SLOW PATH: no Visual for surface\n");
+        CAIRO_GDK_DRAWING_NOTE("TAKING SLOW PATH: no Visual for surface\n");
         return False;
     }        
     /* Check that the visual is supported */
-    if (!(capabilities & CAIRO_XLIB_DRAWING_SUPPORTS_NONDEFAULT_VISUAL) &&
+    if (!(capabilities & CAIRO_GDK_DRAWING_SUPPORTS_NONDEFAULT_VISUAL) &&
         DefaultVisualOfScreen (screen) != visual) {
-        CAIRO_XLIB_DRAWING_NOTE("TAKING SLOW PATH: non-default visual\n");
+        CAIRO_GDK_DRAWING_NOTE("TAKING SLOW PATH: non-default visual\n");
         return False;
     }
   
     /* we're good to go! */
-    CAIRO_XLIB_DRAWING_NOTE("TAKING FAST PATH\n");
+    CAIRO_GDK_DRAWING_NOTE("TAKING FAST PATH\n");
     cairo_surface_flush (target);
-    callback (closure, screen, d, visual, offset_x, offset_y, rectangles,
+    callback (closure, GDK_DRAWABLE(gdk_xid_table_lookup(d)), 
+              offset_x, offset_y, rectangles,
               needs_clip ? rect_count : 0);
     cairo_surface_mark_dirty (target);
     return True;
 }
 
 static cairo_surface_t *
 _create_temp_xlib_surface (cairo_t *cr, Display *dpy, int width, int height,
-                           cairo_xlib_drawing_support_t capabilities)
+                           cairo_gdk_drawing_support_t capabilities)
 {
+    cairo_surface_t *result = NULL;
+
     /* base the temp surface on the *screen* surface, not any intermediate
      * group surface, because the screen surface is more likely to have
      * characteristics that the xlib-using code is likely to be happy with */
     cairo_surface_t *target = cairo_get_target (cr);
     Drawable target_drawable = cairo_xlib_surface_get_drawable (target);
+    GdkDrawable *gdk_target_drawable = GDK_DRAWABLE(gdk_xid_table_lookup(target_drawable));
 
-    int screen_index = DefaultScreen (dpy);
-    Drawable drawable = RootWindow (dpy, screen_index);
-    Screen *screen = DefaultScreenOfDisplay (dpy);
-    Visual *visual = DefaultVisual (dpy, screen_index);
-    int depth = DefaultDepth (dpy, screen_index);
-
-    Pixmap pixmap;
-    cairo_surface_t *result;
-    pixmap_free_struct *pfs;
-    
-    /* make the temporary surface match target_drawable to the extent supported
-       by the native rendering code */
-    if (target_drawable) {
-        Screen *target_screen = cairo_xlib_surface_get_screen (target);
-        Visual *target_visual = cairo_xlib_surface_get_visual (target);
-        if ((target_screen == screen ||
-             (capabilities & CAIRO_XLIB_DRAWING_SUPPORTS_ALTERNATE_SCREEN)) &&
-            target_visual &&
-            (target_visual == DefaultVisualOfScreen (target_screen) ||
-             (capabilities & CAIRO_XLIB_DRAWING_SUPPORTS_NONDEFAULT_VISUAL))) {
-            drawable = target_drawable;
-            dpy = cairo_xlib_surface_get_display (target);
-            visual = target_visual;
-            depth = cairo_xlib_surface_get_depth (target);
+    GdkPixmap *pixmap = NULL;
+    GdkVisual *gvis = NULL;
+    if (gdk_target_drawable) {
+        gvis = gdk_drawable_get_visual(gdk_target_drawable);
+        if (gvis) {
+            pixmap = gdk_pixmap_new(gdk_target_drawable,
+                                    width, height,
+                                    -1);
         }
     }
-    
-    pfs = malloc (sizeof(pixmap_free_struct));
-    if (pfs == NULL)
-        return NULL;
-        
-    pixmap = XCreatePixmap (dpy, drawable, width, height, depth);
+
     if (!pixmap) {
-        free (pfs);
-        return NULL;
+        int screen_index = DefaultScreen (dpy);
+        int depth = DefaultDepth (dpy, screen_index);
+
+        GdkColormap *rgb = gdk_rgb_get_colormap();
+        gvis = gdk_colormap_get_visual(rgb);
+
+        pixmap = gdk_pixmap_new(NULL,
+                                width, height,
+                                gvis->depth);
+        gdk_drawable_set_colormap(pixmap, rgb);
     }
-    pfs->dpy = dpy;
-    pfs->pixmap = pixmap;
-  
-    result = cairo_xlib_surface_create (dpy, pixmap, visual, width, height);
+
+    result = cairo_xlib_surface_create (gdk_x11_drawable_get_xdisplay(pixmap),
+                                        gdk_x11_drawable_get_xid(pixmap),
+                                        gdk_x11_visual_get_xvisual(gvis),
+                                        width, height);
     if (cairo_surface_status (result) != CAIRO_STATUS_SUCCESS) {
-        pixmap_free_func (pfs);
+        pixmap_free_func (pixmap);
         return NULL;
     }
     
-    cairo_surface_set_user_data (result, &pixmap_free_key, pfs, pixmap_free_func);
+    cairo_surface_set_user_data (result, &pixmap_free_key, pixmap, pixmap_free_func);
     return result;
 }
 
 static cairo_bool_t
 _draw_onto_temp_xlib_surface (cairo_surface_t *temp_xlib_surface,
-                              cairo_xlib_drawing_callback callback,
+                              cairo_gdk_drawing_callback callback,
                               void *closure,
                               double background_gray_value)
 {
     Drawable d = cairo_xlib_surface_get_drawable (temp_xlib_surface);
-    Screen *screen = cairo_xlib_surface_get_screen (temp_xlib_surface);
-    Visual *visual = cairo_xlib_surface_get_visual (temp_xlib_surface);
     cairo_bool_t result;
+
     cairo_t *cr = cairo_create (temp_xlib_surface);
     cairo_set_source_rgb (cr, background_gray_value, background_gray_value,
                           background_gray_value);
     cairo_set_operator (cr, CAIRO_OPERATOR_SOURCE);
     cairo_paint (cr);
     cairo_destroy (cr);
     
     cairo_surface_flush (temp_xlib_surface);
     /* no clipping is needed because the callback can't draw outside the native
        surface anyway */
-    result = callback (closure, screen, d, visual, 0, 0, NULL, 0);
+    result = callback (closure, GDK_DRAWABLE(gdk_xid_table_lookup(d)),
+            0, 0, NULL, 0);
     cairo_surface_mark_dirty (temp_xlib_surface);
     return result;
 }
 
 static cairo_surface_t *
@@ -449,11 +428,11 @@ _copy_xlib_surface_to_image (cairo_surfa
  */
 static void
 _compute_alpha_values (uint32_t *black_data,
                        uint32_t *white_data,
                        int width, int height,
-                       cairo_xlib_drawing_result_t *analysis)
+                       cairo_gdk_drawing_result_t *analysis)
 {
     int num_pixels = width*height;
     int i;
     uint32_t first;
     uint32_t deltas = 0;
@@ -509,25 +488,26 @@ _compute_alpha_values (uint32_t *black_d
             }
         }
     }
 }
 
-void
-cairo_draw_with_xlib (cairo_t *cr,
-                      cairo_xlib_drawing_callback callback,
-                      void *closure,
-                      Display *dpy,
-                      unsigned int width, unsigned int height,
-                      cairo_xlib_drawing_opacity_t is_opaque,
-                      cairo_xlib_drawing_support_t capabilities,
-                      cairo_xlib_drawing_result_t *result)
+void 
+cairo_draw_with_gdk (cairo_t *cr,
+                     GdkDrawable * drawable,
+                     cairo_gdk_drawing_callback callback,
+                     void * closure,
+                     unsigned int width, unsigned int height,
+                     cairo_gdk_drawing_opacity_t is_opaque,
+                     cairo_gdk_drawing_support_t capabilities,
+                     cairo_gdk_drawing_result_t *result)
 {
     cairo_surface_t *temp_xlib_surface;
     cairo_surface_t *black_image_surface;
     cairo_surface_t *white_image_surface;
     unsigned char *black_data;
     unsigned char *white_data;
+    Display *dpy = gdk_x11_drawable_get_xdisplay(drawable);
   
     if (result) {
         result->surface = NULL;
         result->uniform_alpha = False;
         result->uniform_color = False;
@@ -554,11 +534,11 @@ cairo_draw_with_xlib (cairo_t *cr,
     if (!_draw_onto_temp_xlib_surface (temp_xlib_surface, callback, closure, 0.0)) {
         cairo_surface_destroy (temp_xlib_surface);
         return;
     }
   
-    if (is_opaque == CAIRO_XLIB_DRAWING_OPAQUE) {
+    if (is_opaque == CAIRO_GDK_DRAWING_OPAQUE) {
         cairo_set_source_surface (cr, temp_xlib_surface, 0.0, 0.0);
         cairo_paint (cr);
         if (result) {
             result->surface = temp_xlib_surface;
             /* fill in the result with what we know, which is really just what our
diff --git a/gfx/thebes/src/cairo-xlib-utils.h b/gfx/thebes/src/cairo-xlib-utils.h
deleted file mode 100644
--- a/gfx/thebes/src/cairo-xlib-utils.h
+++ /dev/null
@@ -1,151 +0,0 @@
-/* -*- Mode: C++; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*-
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is Novell code.
- *
- * The Initial Developer of the Original Code is Novell.
- * Portions created by the Initial Developer are Copyright (C) 2006
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *   rocallahan@novell.com
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#ifndef CAIROXLIBUTILS_H_
-#define CAIROXLIBUTILS_H_
-
-#include "cairo.h"
-#include <X11/Xlib.h>
-
-CAIRO_BEGIN_DECLS
-
-/**
- * This callback encapsulates Xlib-based rendering. We assume that the
- * execution of the callback is equivalent to compositing some RGBA image of
- * size (bounds_width, bounds_height) onto the drawable at offset (offset_x,
- * offset_y), clipped to the union of the clip_rects if num_rects is greater
- * than zero. This includes the assumption that the same RGBA image
- * is composited if you call the callback multiple times with the same closure,
- * display and visual during a single cairo_draw_with_xlib call.
- * 
- * @return True on success, False on non-recoverable error
- */
-typedef cairo_bool_t (* cairo_xlib_drawing_callback)
-    (void *closure,
-     Screen *screen,
-     Drawable drawable,
-     Visual *visual,
-     short offset_x, short offset_y,
-     XRectangle* clip_rects, unsigned int num_rects);
-
-/**
- * This structure captures the result of the native drawing, in case the
- * caller may wish to reapply the drawing efficiently later.
- */
-typedef struct {
-    cairo_surface_t *surface;
-    cairo_bool_t    uniform_alpha;
-    cairo_bool_t    uniform_color;
-    double          alpha; /* valid only if uniform_alpha is TRUE */
-    double          r, g, b; /* valid only if uniform_color is TRUE */
-} cairo_xlib_drawing_result_t;
-
-/**
- * This type specifies whether the native drawing callback draws all pixels
- * in its bounds opaquely, independent of the contents of the target drawable,
- * or whether it leaves pixels transparent/translucent or depends on the
- * existing contents of the target drawable in some way.
- */
-typedef enum _cairo_xlib_drawing_opacity {
-    CAIRO_XLIB_DRAWING_OPAQUE,
-    CAIRO_XLIB_DRAWING_TRANSPARENT
-} cairo_xlib_drawing_opacity_t;
-
-/**
- * This type encodes the capabilities of the native drawing callback.
- * 
- * If CAIRO_XLIB_DRAWING_SUPPORTS_OFFSET is set, 'offset_x' and 'offset_y'
- * can be nonzero in the call to the callback; otherwise they will be zero.
- * 
- * If CAIRO_XLIB_DRAWING_SUPPORTS_CLIP_RECT is set, then 'num_rects' can be
- * zero or one in the call to the callback. If
- * CAIRO_XLIB_DRAWING_SUPPORTS_CLIP_LIST is set, then 'num_rects' can be
- * anything in the call to the callback. Otherwise 'num_rects' will be zero.
- * Do not set both of these values.
- * 
- * If CAIRO_XLIB_DRAWING_SUPPORTS_ALTERNATE_SCREEN is set, then 'screen' can
- * be any screen on any display, otherwise it will be the default screen of
- * the display passed into cairo_draw_with_xlib.
- * 
- * If CAIRO_XLIB_DRAWING_SUPPORTS_NONDEFAULT_VISUAL is set, then 'visual' can be
- * any visual, otherwise it will be equal to
- * DefaultVisualOfScreen (screen).
- */
-typedef enum {
-    CAIRO_XLIB_DRAWING_SUPPORTS_OFFSET = 0x01,
-    CAIRO_XLIB_DRAWING_SUPPORTS_CLIP_RECT = 0x02,
-    CAIRO_XLIB_DRAWING_SUPPORTS_CLIP_LIST = 0x04,
-    CAIRO_XLIB_DRAWING_SUPPORTS_ALTERNATE_SCREEN = 0x08,
-    CAIRO_XLIB_DRAWING_SUPPORTS_NONDEFAULT_VISUAL = 0x10
-} cairo_xlib_drawing_support_t;
-
-/**
- * Draw Xlib output into any cairo context. All cairo transforms and effects
- * are honored, including the current operator. This is equivalent to a
- * cairo_set_source_surface and then cairo_paint.
- * @param cr the context to draw into
- * @param callback the code to perform Xlib rendering
- * @param closure associated data
- * @param dpy an X display to use in case the cairo context has no associated X display
- * @param width the width of the putative image drawn by the callback
- * @param height the height of the putative image drawn by the callback
- * @param is_opaque set to CAIRO_XLIB_DRAWING_IS_OPAQUE to indicate
- * that all alpha values of the putative image will be 1.0; the pixels drawn into
- * the Drawable must not depend on the prior contents of the Drawable
- * in any way
- * @param capabilities the capabilities of the callback as described above.
- * @param result if non-NULL, we *may* fill in the struct with information about
- * the rendered image. 'surface' may be filled in with a surface representing
- * the image, similar to the target of 'cr'. If 'uniform_alpha' is True then
- * every pixel of the image has the same alpha value 'alpha'. If
- * 'uniform_color' is True then every pixel of the image has the same RGB
- * color (r, g, b). If the image has uniform color and alpha (or alpha is zero,
- * in which case the color is always uniform) then we won't bother returning
- * a surface for it.
- */
-void cairo_draw_with_xlib (cairo_t *cr,
-                           cairo_xlib_drawing_callback callback,
-                           void *closure,
-                           Display *dpy,
-                           unsigned int width, unsigned int height,
-                           cairo_xlib_drawing_opacity_t is_opaque,
-                           cairo_xlib_drawing_support_t capabilities,
-                           cairo_xlib_drawing_result_t *result);
-
-CAIRO_END_DECLS
-
-#endif /*CAIROXLIBUTILS_H_*/
diff --git a/gfx/thebes/src/gfxASurface.cpp b/gfx/thebes/src/gfxASurface.cpp
--- a/gfx/thebes/src/gfxASurface.cpp
+++ b/gfx/thebes/src/gfxASurface.cpp
@@ -51,10 +51,14 @@
 #endif
 
 #ifdef CAIRO_HAS_QUARTZ_SURFACE
 #include "gfxQuartzSurface.h"
 #include "gfxQuartzImageSurface.h"
+#endif
+
+#ifdef CAIRO_HAS_DIRECTFB_SURFACE
+#include "gfxDirectFBSurface.h"
 #endif
 
 #include <stdio.h>
 #include <limits.h>
 
@@ -159,10 +163,15 @@ gfxASurface::Wrap (cairo_surface_t *csur
     else if (stype == CAIRO_SURFACE_TYPE_QUARTZ) {
         result = new gfxQuartzSurface(csurf);
     }
     else if (stype == CAIRO_SURFACE_TYPE_QUARTZ_IMAGE) {
         result = new gfxQuartzImageSurface(csurf);
+    }
+#endif
+#ifdef CAIRO_HAS_DIRECTFB_SURFACE
+    else if (stype == CAIRO_SURFACE_TYPE_DIRECTFB) {
+        result = new gfxDirectFBSurface(csurf);
     }
 #endif
     else {
         result = new gfxUnknownSurface(csurf);
     }
diff --git a/gfx/thebes/src/gfxAtsuiFonts.cpp b/gfx/thebes/src/gfxAtsuiFonts.cpp
--- a/gfx/thebes/src/gfxAtsuiFonts.cpp
+++ b/gfx/thebes/src/gfxAtsuiFonts.cpp
@@ -60,11 +60,11 @@
 #include "gfxQuartzFontCache.h"
 
 #include "nsUnicodeRange.h"
 
 // Uncomment this to dump all text runs created to stdout
-// #define DUMP_TEXT_RUNS
+#define DUMP_TEXT_RUNS
 
 #ifdef DUMP_TEXT_RUNS
 static PRLogModuleInfo *gAtsuiTextRunLog = PR_NewLogModule("atsuiTextRun");
 #endif
 
@@ -90,15 +90,15 @@ OSStatus ATSClearGlyphVector(void *glyph
 
 eFontPrefLang GetFontPrefLangFor(PRUint8 aUnicodeRange);
 
 gfxAtsuiFont::gfxAtsuiFont(MacOSFontEntry *aFontEntry,
                            const gfxFontStyle *fontStyle, PRBool aNeedsBold)
-    : gfxFont(aFontEntry->Name(), fontStyle),
-      mFontStyle(fontStyle), mATSUStyle(nsnull), mFontEntry(aFontEntry),
-      mValid(PR_TRUE), mHasMirroring(PR_FALSE), mHasMirroringLookedUp(PR_FALSE), mAdjustedSize(0.0f)
+    : gfxFont(aFontEntry, fontStyle),
+      mFontStyle(fontStyle), mATSUStyle(nsnull),
+      mHasMirroring(PR_FALSE), mHasMirroringLookedUp(PR_FALSE), mAdjustedSize(0.0f)
 {
-    ATSUFontID fontID = mFontEntry->GetFontID();
+    ATSUFontID fontID = aFontEntry->GetFontID();
     ATSFontRef fontRef = FMGetATSFontRefFromFont(fontID);
 
     // determine whether synthetic bolding is needed
     PRInt8 baseWeight, weightDistance;
     mFontStyle->ComputeWeightAndOffset(&baseWeight, &weightDistance);
@@ -106,11 +106,11 @@ gfxAtsuiFont::gfxAtsuiFont(MacOSFontEntr
 
     // synthetic bolding occurs when font itself is not a bold-face and either the absolute weight 
     // is at least 600 or the relative weight (e.g. 402) implies a darker face than the ones available.
     // note: this means that (1) lighter styles *never* synthetic bold and (2) synthetic bolding always occurs 
     // at the first bolder step beyond available faces, no matter how light the boldest face
-    if (!mFontEntry->IsBold()
+    if (!aFontEntry->IsBold()
         && ((weightDistance == 0 && targetWeight >= 600) || (weightDistance > 0 && aNeedsBold))) 
     {
         mSyntheticBoldOffset = 1;  // devunit offset when double-striking text to fake boldness   
     }
 
@@ -121,11 +121,11 @@ gfxAtsuiFont::gfxAtsuiFont(MacOSFontEntr
     cairo_matrix_t sizeMatrix, ctm;
     cairo_matrix_init_identity(&ctm);
     cairo_matrix_init_scale(&sizeMatrix, mAdjustedSize, mAdjustedSize);
 
     // synthetic oblique by skewing via the font matrix
-    PRBool needsOblique = (!mFontEntry->IsItalicStyle() && (mFontStyle->style & (FONT_STYLE_ITALIC | FONT_STYLE_OBLIQUE)));
+    PRBool needsOblique = (!aFontEntry->IsItalic() && (mFontStyle->style & (FONT_STYLE_ITALIC | FONT_STYLE_OBLIQUE)));
 
     if (needsOblique) {
         double skewfactor = (needsOblique ? Fix2X(kATSItalicQDSkew) : 0);
 
         cairo_matrix_t style;
@@ -138,36 +138,36 @@ gfxAtsuiFont::gfxAtsuiFont(MacOSFontEntr
                           0);               //y0
         cairo_matrix_multiply(&sizeMatrix, &sizeMatrix, &style);
     }
 
     cairo_font_options_t *fontOptions = cairo_font_options_create();
-    
+
     // turn off font anti-aliasing based on user pref setting
     if (mAdjustedSize <= (float) gfxPlatformMac::GetPlatform()->GetAntiAliasingThreshold()) {
         cairo_font_options_set_antialias(fontOptions, CAIRO_ANTIALIAS_NONE); 
-        //printf("font: %s, size: %f, disabling anti-aliasing\n", NS_ConvertUTF16toUTF8(mName).get(), mAdjustedSize);
+        //printf("font: %s, size: %f, disabling anti-aliasing\n", NS_ConvertUTF16toUTF8(GetName()).get(), mAdjustedSize);
     }
-    
+
     mScaledFont = cairo_scaled_font_create(mFontFace, &sizeMatrix, &ctm, fontOptions);
     cairo_font_options_destroy(fontOptions);
 
     cairo_status_t cairoerr = cairo_scaled_font_status(mScaledFont);
     if (cairoerr != CAIRO_STATUS_SUCCESS) {
-        mValid = PR_FALSE;
+        mIsValid = PR_FALSE;
 
 #ifdef DEBUG        
         char warnBuf[1024];
-        sprintf(warnBuf, "Failed to create scaled font: %s status: %d", NS_ConvertUTF16toUTF8(mName).get(), cairoerr);
+        sprintf(warnBuf, "Failed to create scaled font: %s status: %d", NS_ConvertUTF16toUTF8(GetName()).get(), cairoerr);
         NS_WARNING(warnBuf);
 #endif
     }
 }
 
 
 ATSUFontID gfxAtsuiFont::GetATSUFontID()
 {
-    return mFontEntry->GetFontID();
+    return GetFontEntry()->GetFontID();
 }
 
 void
 gfxAtsuiFont::InitMetrics(ATSUFontID aFontID, ATSFontRef aFontRef)
 {
@@ -260,11 +260,11 @@ gfxAtsuiFont::InitMetrics(ATSUFontID aFo
     else
         mMetrics.aveCharWidth = xWidth;
 
     mMetrics.aveCharWidth += mSyntheticBoldOffset;
 
-    if (mFontEntry->IsFixedPitch()) {
+    if (GetFontEntry()->IsFixedPitch()) {
         // Some Quartz fonts are fixed pitch, but there's some glyph with a bigger
         // advance than the average character width... this forces
         // those fonts to be recognized like fixed pitch fonts by layout.
         mMetrics.maxAdvance = mMetrics.aveCharWidth;
     }
@@ -284,11 +284,11 @@ gfxAtsuiFont::InitMetrics(ATSUFontID aFo
 
     mMetrics.zeroOrAveCharWidth = GetCharWidth('0', &glyphID);
     if (glyphID == 0) // no zero in this font
         mMetrics.zeroOrAveCharWidth = mMetrics.aveCharWidth;
 
-    SanitizeMetrics(&mMetrics, mFontEntry->FamilyEntry()->IsBadUnderlineFontFamily());
+    SanitizeMetrics(&mMetrics, GetFontEntry()->FamilyEntry()->IsBadUnderlineFontFamily());
 
 #if 0
     fprintf (stderr, "Font: %p size: %f (fixed: %d)", this, size, gfxQuartzFontCache::SharedFontCache()->IsFixedPitch(aFontID));
     fprintf (stderr, "    emHeight: %f emAscent: %f emDescent: %f\n", mMetrics.emHeight, mMetrics.emAscent, mMetrics.emDescent);
     fprintf (stderr, "    maxAscent: %f maxDescent: %f maxAdvance: %f\n", mMetrics.maxAscent, mMetrics.maxDescent, mMetrics.maxAdvance);
@@ -312,11 +312,11 @@ gfxAtsuiFont::SetupCairoFont(gfxContext 
 }
 
 nsString
 gfxAtsuiFont::GetUniqueName()
 {
-    return mName;
+    return GetName();
 }
 
 float
 gfxAtsuiFont::GetCharWidth(PRUnichar c, PRUint32 *aGlyphID)
 {
@@ -391,11 +391,11 @@ gfxAtsuiFont::SetupGlyphExtents(gfxConte
     OSStatus err = ATSUGlyphGetScreenMetrics(mATSUStyle, 1, &glyph, 0, false, false,
                                              &metrics);
     if (err != noErr)
         return;
     PRUint32 appUnitsPerDevUnit = aExtents->GetAppUnitsPerDevUnit();
-    
+
     if (!aNeedTight && metrics.topLeft.x >= 0 &&
         -metrics.topLeft.y + metrics.height <= mMetrics.maxAscent &&
         metrics.topLeft.y <= mMetrics.maxDescent) {
         PRUint32 appUnitsWidth =
             PRUint32(NS_ceil((metrics.topLeft.x + metrics.width)*appUnitsPerDevUnit));
@@ -421,23 +421,23 @@ gfxAtsuiFont::HasMirroringInfo()
         // 361695 - if the font has a 'prop' table, assume that ATSUI will handle glyph mirroring
         status = ATSFontGetTable(GetATSUFontID(), 'prop', 0, 0, 0, &size);
         mHasMirroring = (status == noErr);
         mHasMirroringLookedUp = PR_TRUE;
     }
-    
+
     return mHasMirroring;
 }
 
 PRBool gfxAtsuiFont::TestCharacterMap(PRUint32 aCh) {
-    if (!mValid) return PR_FALSE;
-    return mFontEntry->TestCharacterMap(aCh);
+    if (!mIsValid) return PR_FALSE;
+    return GetFontEntry()->TestCharacterMap(aCh);
 }
 
 MacOSFontEntry*
 gfxAtsuiFont::GetFontEntry()
 {
-    return mFontEntry.get();
+    return static_cast< MacOSFontEntry*> (mFontEntry.get());
 }
 
 /**
  * Look up the font in the gfxFont cache. If we don't find it, create one.
  * In either case, add a ref and return it ---
@@ -711,11 +711,11 @@ gfxAtsuiFontGroup::MakeTextRun(const PRU
         }
         if (start == aLength)
             break;
         textRun->ResetGlyphRuns();
     }
-    
+
     textRun->FetchGlyphExtents(aParams->mContext);
 
     return textRun;
 }
 
@@ -791,34 +791,37 @@ struct PrefFontCallbackData {
         return PR_TRUE;
     }
 };
 
 
-already_AddRefed<gfxAtsuiFont>
+already_AddRefed<gfxFont>
 gfxAtsuiFontGroup::WhichPrefFontSupportsChar(PRUint32 aCh)
 {
+    gfxFont *font;
+
     // FindCharUnicodeRange only supports BMP character points and there are no non-BMP fonts in prefs
     if (aCh > 0xFFFF)
         return nsnull;
 
     // get the pref font list if it hasn't been set up already
     PRUint32 unicodeRange = FindCharUnicodeRange(aCh);
     eFontPrefLang charLang = GetFontPrefLangFor(unicodeRange);
 
     // if the last pref font was the first family in the pref list, no need to recheck through a list of families
     if (mLastPrefFont && charLang == mLastPrefLang && mLastPrefFirstFont && mLastPrefFont->TestCharacterMap(aCh)) {
-        nsRefPtr<gfxAtsuiFont> prefFont = mLastPrefFont;
-        return prefFont.forget();
+        font = mLastPrefFont;
+        NS_ADDREF(font);
+        return font;
     }
-    
+
     // based on char lang and page lang, set up list of pref lang fonts to check
     eFontPrefLang prefLangs[kMaxLenPrefLangList];
     PRUint32 i, numLangs = 0;
-    
+
     gfxPlatformMac *macPlatform = gfxPlatformMac::GetPlatform();
     macPlatform->GetLangPrefs(prefLangs, numLangs, charLang, mPageLang);
-    
+
     for (i = 0; i < numLangs; i++) {
         nsAutoTArray<nsRefPtr<MacOSFamilyEntry>, 5> families;
         eFontPrefLang currentLang = prefLangs[i];
         
         gfxQuartzFontCache *fc = gfxQuartzFontCache::SharedFontCache();
@@ -829,11 +832,11 @@ gfxAtsuiFontGroup::WhichPrefFontSupports
             PrefFontCallbackData prefFontData(families);
             gfxPlatform::ForEachPrefFont(prefLangsToSearch, 1, PrefFontCallbackData::AddFontFamilyEntry,
                                            &prefFontData);
             fc->SetPrefFontFamilyEntries(currentLang, families);
         }
-    
+
         // find the first pref font that includes the character
         PRUint32  i, numPrefs;
         numPrefs = families.Length();
         for (i = 0; i < numPrefs; i++) {
             // look up the appropriate face
@@ -843,12 +846,13 @@ gfxAtsuiFontGroup::WhichPrefFontSupports
             // if a pref font is used, it's likely to be used again in the same text run.
             // the style doesn't change so the face lookup can be cached rather than calling
             // GetOrMakeFont repeatedly.  speeds up FindFontForChar lookup times for subsequent
             // pref font lookups
             if (family == mLastPrefFamily && mLastPrefFont->TestCharacterMap(aCh)) {
-                nsRefPtr<gfxAtsuiFont> prefFont = mLastPrefFont;
-                return prefFont.forget();
+                font = mLastPrefFont;
+                NS_ADDREF(font);
+                return font;
             }
             
             PRBool needsBold;
             MacOSFontEntry *fe = family->FindFont(&mStyle, needsBold);
             // if ch in cmap, create and return a gfxFont
@@ -857,65 +861,30 @@ gfxAtsuiFontGroup::WhichPrefFontSupports
                 if (!prefFont) continue;
                 mLastPrefFamily = family;
                 mLastPrefFont = prefFont;
                 mLastPrefLang = charLang;
                 mLastPrefFirstFont = (i == 0);
-                return prefFont.forget();
+                nsRefPtr<gfxFont> font2 = (gfxFont*) prefFont;
+                return font2.forget();
             }
 
         }
     }
-    
+
     return nsnull;
 }
 
-already_AddRefed<gfxAtsuiFont>
-gfxAtsuiFontGroup::FindFontForChar(PRUint32 aCh, PRUint32 aPrevCh, PRUint32 aNextCh, gfxAtsuiFont* aPrevMatchedFont)
+already_AddRefed<gfxFont> 
+gfxAtsuiFontGroup::WhichSystemFontSupportsChar(PRUint32 aCh)
 {
-    nsRefPtr<gfxAtsuiFont>    selectedFont;
-    
-    // if this character or the next one is a joiner use the
-    // same font as the previous range if we can
-    if (gfxFontUtils::IsJoiner(aCh) || gfxFontUtils::IsJoiner(aPrevCh) || gfxFontUtils::IsJoiner(aNextCh)) {
-        if (aPrevMatchedFont && aPrevMatchedFont->TestCharacterMap(aCh)) {
-            selectedFont = aPrevMatchedFont;
-            return selectedFont.forget();
-        }
-    }
-    
-    // 1. check fonts in the font group
-    selectedFont = WhichFontSupportsChar(mFonts, aCh);
-    
-    // don't look in other fonts if the character is in a Private Use Area
-    if ((aCh >= 0xE000  && aCh <= 0xF8FF) || 
-        (aCh >= 0xF0000 && aCh <= 0x10FFFD))
-        return selectedFont.forget();
-    if ( selectedFont ) 
-        return selectedFont.forget();
-    
-    // 2. search pref fonts if none of the font group fonts match
-    //    FindCharUnicodeRange only supports BMP character points and there are no non-BMP fonts in prefs
-    if ((selectedFont = WhichPrefFontSupportsChar(aCh))) {
-        return selectedFont.forget();
-    }
+    MacOSFontEntry *fe;
 
-    // 3. use fallback fonts
-    // -- before searching for something else check the font used for the previous character
-    if (!selectedFont && aPrevMatchedFont && aPrevMatchedFont->TestCharacterMap(aCh)) {
-        selectedFont = aPrevMatchedFont;
-        return selectedFont.forget();
-    }
-    
-    // -- otherwise look for other stuff
-    if (!selectedFont) {
-        MacOSFontEntry *fe;
-
-        fe = gfxQuartzFontCache::SharedFontCache()->FindFontForChar(aCh, GetFontAt(0));
-        if (fe) {
-            selectedFont = GetOrMakeFont(fe, &mStyle, PR_FALSE);  // ignore bolder considerations in system fallback case...
-            return selectedFont.forget();
-        }
+    fe = gfxQuartzFontCache::SharedFontCache()->FindFontForChar(aCh, GetFontAt(0));
+    if (fe) {
+        nsRefPtr<gfxAtsuiFont> atsuiFont = GetOrMakeFont(fe, &mStyle, PR_FALSE); // ignore bolder considerations in system fallback case...
+        nsRefPtr<gfxFont> font = (gfxFont*) atsuiFont; 
+        return font.forget();
     }
 
     return nsnull;
 }
 
@@ -1220,11 +1189,11 @@ PostLayoutCallback(ATSULineRef aLine, gf
                 baselineDeltas += glyphCount;
             }
         }
         numGlyphs -= glyphCount;
     }
-    
+
     return (allFlags & ATSUI_OVERRUNNING_GLYPH_FLAG) != 0;
 }
 
 struct PostLayoutCallbackClosure {
     gfxTextRun                  *mTextRun;
@@ -1338,11 +1307,11 @@ static void MirrorSubstring(ATSUTextLayo
 static void MirrorSubstring(ATSUTextLayout layout, nsAutoArrayPtr<PRUnichar>& mirroredStr,
                             const PRUnichar *aString, PRUint32 aLength,
                             UniCharArrayOffset runStart, UniCharCount runLength)
 {
     UniCharArrayOffset  off;
-    
+
     // do the mirroring manually!!
     for (off = runStart; off < runStart + runLength; off++) {
         PRUnichar  mirroredChar;
         
         mirroredChar = (PRUnichar) SymmSwap(aString[off]);
@@ -1361,83 +1330,10 @@ static void MirrorSubstring(ATSUTextLayo
             mirroredStr[off] = mirroredChar;
         }
     }
 }
 
-// match fonts with character sequence based on font cmap tables
-class CmapFontMatcher {
-public:
-    CmapFontMatcher(const PRUnichar *aString, PRUint32 aBeginOffset, PRUint32 aEndOffset, gfxAtsuiFontGroup* aFontGroup) :
-        mString(aString), mOffset(aBeginOffset), mPrevOffset(aBeginOffset), mEndOffset(aEndOffset), mPrevCh(0), mFirstRange(PR_TRUE), mFontGroup(aFontGroup), mMatchedFont(0), mNextMatchedFont(0)
-    {}
-    
-    // match the next substring that uses the same font, returns the length matched
-    PRUint32 MatchNextRange() 
-    { 
-        PRUint32                matchStartOffset, chStartOffset, ch, nextCh;
-        nsRefPtr<gfxAtsuiFont>  font;
-        
-        matchStartOffset = mPrevOffset;
-
-        if ( !mFirstRange ) {
-            mMatchedFont = mNextMatchedFont;
-        }
-        
-        while ( mOffset < mEndOffset ) {
-            chStartOffset = mOffset;
-            
-            // set up current ch
-            ch = mString[mOffset];
-            if ((mOffset+1 < mEndOffset) && NS_IS_HIGH_SURROGATE(ch) && NS_IS_LOW_SURROGATE(mString[mOffset+1])) {
-                mOffset++;
-                ch = SURROGATE_TO_UCS4(ch, mString[mOffset]);
-            }
-            
-            // set up next ch
-            nextCh = 0;
-            if (mOffset+1 < mEndOffset) {
-                nextCh = mString[mOffset+1];
-                if ((mOffset+2 < mEndOffset) && NS_IS_HIGH_SURROGATE(nextCh) && NS_IS_LOW_SURROGATE(mString[mOffset+2]))
-                    nextCh = SURROGATE_TO_UCS4(nextCh, mString[mOffset+2]);
-            }
-
-            // find the font for this char
-            font = mFontGroup->FindFontForChar(ch, mPrevCh, nextCh, mMatchedFont);
-            mOffset++;
-            mPrevCh = ch;
-            
-            // no previous match, set one up
-            if ( mFirstRange ) {
-                mMatchedFont = font;
-                mFirstRange = PR_FALSE;
-            } else if ( font != mMatchedFont ) {
-                mPrevOffset = chStartOffset;
-                mNextMatchedFont = font;
-                return chStartOffset - matchStartOffset;
-            }
-            
-        }
-        
-        // reached the end of the string
-        mPrevOffset = mEndOffset;
-        mNextMatchedFont = nsnull;
-        return mOffset - matchStartOffset;
-    }
-    
-    inline gfxAtsuiFont* MatchedFont() { return mMatchedFont.get(); }
-
-private:
-    const PRUnichar         *mString;
-    PRUint32                mOffset;
-    PRUint32                mPrevOffset;
-    PRUint32                mEndOffset;
-    PRUint32                mPrevCh;
-    PRBool                  mFirstRange;
-    gfxAtsuiFontGroup       *mFontGroup;
-    nsRefPtr<gfxAtsuiFont>  mMatchedFont;
-    nsRefPtr<gfxAtsuiFont>  mNextMatchedFont;
-};
 
 
 static ATSUStyle
 SetLayoutRangeToFont(ATSUTextLayout layout, ATSUStyle mainStyle, UniCharArrayOffset offset,
                       UniCharCount length, ATSUFontID fontID)
@@ -1545,23 +1441,28 @@ gfxAtsuiFontGroup::InitTextRun(gfxTextRu
 
     nsAutoArrayPtr<PRUnichar> mirroredStr;
 
     UniCharArrayOffset runStart = aLayoutStart;
     UniCharCount runLength = aLengthInTextRun;
-    UniCharCount totalLength = aLayoutStart + aLengthInTextRun;
-    
+
     /// ---- match fonts using cmap info instead of ATSUI ----
-    
-    CmapFontMatcher fontMatcher(aString, runStart, runStart + runLength, this);
-    
-    while (runStart < totalLength) {
+
+    nsTArray<gfxTextRange> fontRanges;
+
+    ComputeRanges(fontRanges, aString, runStart, runStart + runLength);
+
+    PRUint32 r, numRanges = fontRanges.Length();
+
+    for (r = 0; r < numRanges; r++) {
+        const gfxTextRange& range = fontRanges[r];
+   
         gfxAtsuiFont *matchedFont;
         UniCharCount  matchedLength;
         
         // match a range of text
-        matchedLength = fontMatcher.MatchNextRange();
-        matchedFont = fontMatcher.MatchedFont();
+        matchedLength = range.Length();
+        matchedFont = static_cast<gfxAtsuiFont*> (range.font ? range.font.get() : nsnull);
 
 #ifdef DUMP_TEXT_RUNS
         PR_LOG(gAtsuiTextRunLog, PR_LOG_DEBUG, ("InitTextRun %p fontgroup %p font %p match %s (%d-%d)", aRun, this, matchedFont, (matchedFont ? NS_ConvertUTF16toUTF8(matchedFont->GetUniqueName()).get() : "<null>"), runStart, matchedLength));
 #endif
         //printf("Matched: %s [%d, %d)\n", (matchedFont ? NS_ConvertUTF16toUTF8(matchedFont->GetUniqueName()).get() : "<null>"), runStart, runStart + matchedLength);
@@ -1581,11 +1482,11 @@ gfxAtsuiFontGroup::InitTextRun(gfxTextRu
                 if (closure.mUnmatchedChars) {
                     //printf("initializing %d\n", aLength);
                     memset(closure.mUnmatchedChars.get(), PR_FALSE, aLength);
                 }
             }
-    
+
             if (closure.mUnmatchedChars) {
                 //printf("setting %d unmatched from %d\n", matchedLength, runStart - headerChars);
                 memset(closure.mUnmatchedChars.get() + runStart - aLayoutStart,
                        PR_TRUE, matchedLength);
             }
@@ -1603,11 +1504,11 @@ gfxAtsuiFontGroup::InitTextRun(gfxTextRu
         }
         
         runStart += matchedLength;
         runLength -= matchedLength;    
     }
-    
+
 
     /// -------------------------------------------------
 
     // xxx - for some reason, this call appears to be needed to avoid assertions about glyph runs not being coalesced properly
     //       this appears to occur when there are unmatched characters in the text run
@@ -1621,13 +1522,14 @@ gfxAtsuiFontGroup::InitTextRun(gfxTextRu
                        kATSUseFractionalOrigins, 1, &trap, &trapCount); 
 
     ATSUDisposeTextLayout(layout);
 
     aRun->AdjustAdvancesForSyntheticBold(aOffsetInTextRun, aLengthInTextRun);
-    
+
     PRUint32 i;
     for (i = 0; i < stylesToDispose.Length(); ++i) {
         ATSUDisposeStyle(stylesToDispose[i]);
     }
     gCallbackClosure = nsnull;
     return !closure.mOverrunningGlyphs;
 }
+
diff --git a/gfx/thebes/src/gfxDirectFBSurface.cpp b/gfx/thebes/src/gfxDirectFBSurface.cpp
new file mode 100644
--- /dev/null
+++ b/gfx/thebes/src/gfxDirectFBSurface.cpp
@@ -0,0 +1,147 @@
+/* -*- Mode: C++; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*-
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Mozilla Corporation code.
+ *
+ * The Initial Developer of the Original Code is Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Vladimir Vukicevic <vladimir@pobox.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#include "gfxDirectFBSurface.h"
+
+#include "cairo-directfb.h"
+
+gfxDirectFBSurface::gfxDirectFBSurface(IDirectFB *dfb, IDirectFBSurface *dfbs)
+    : mDFB(nsnull), mDFBSurface(nsnull)
+{
+    dfb->AddRef( dfb );
+    dfbs->AddRef( dfbs );
+
+    cairo_surface_t *surf = cairo_directfb_surface_create(dfb, dfbs);
+
+    mDFB = dfb;
+    mDFBSurface = dfbs;
+
+    Init(surf);
+}
+
+gfxDirectFBSurface::gfxDirectFBSurface(IDirectFBSurface *dfbs)
+    : mDFB(nsnull), mDFBSurface(nsnull)
+{
+    DFBResult ret;
+
+    dfbs->AddRef( dfbs );
+
+    /* Lightweight, getting singleton */
+    ret = DirectFBCreate( &mDFB );
+    if (ret) {
+         D_DERROR( (DirectResult) ret, "gfxDirectFBSurface: DirectFBCreate() failed!\n" );
+         return;
+    }
+
+    cairo_surface_t *surf = cairo_directfb_surface_create(mDFB, dfbs);
+
+    mDFBSurface = dfbs;
+
+    Init(surf);
+}
+
+gfxDirectFBSurface::gfxDirectFBSurface(cairo_surface_t *csurf)
+{
+    mDFB = nsnull;
+    mDFBSurface = nsnull;
+
+    Init(csurf, PR_TRUE);
+}
+
+gfxDirectFBSurface::gfxDirectFBSurface(const gfxIntSize& size, gfxImageFormat format) :
+    mDFB(nsnull), mDFBSurface(nsnull)
+{
+     DFBResult             ret;
+     DFBSurfaceDescription desc;
+
+     if (!CheckSurfaceSize(size) || size.width <= 0 || size.height <= 0)
+          return;
+
+     /* Lightweight, getting singleton */
+     ret = DirectFBCreate( &mDFB );
+     if (ret) {
+          D_DERROR( (DirectResult) ret, "gfxDirectFBSurface: DirectFBCreate() failed!\n" );
+          return;
+     }
+
+     desc.flags  = (DFBSurfaceDescriptionFlags)( DSDESC_WIDTH | DSDESC_HEIGHT | DSDESC_PIXELFORMAT );
+     desc.width  = size.width;
+     desc.height = size.height;
+
+     switch (format) {
+          case gfxASurface::ImageFormatARGB32:
+               desc.pixelformat = DSPF_ARGB;
+               break;
+
+          case gfxASurface::ImageFormatRGB24:
+               desc.pixelformat = DSPF_RGB32;
+               break;
+
+          case gfxASurface::ImageFormatA8:
+               desc.pixelformat = DSPF_A8;
+               break;
+
+          case gfxASurface::ImageFormatA1:
+               desc.pixelformat = DSPF_A1;
+               break;
+
+          default:
+               D_BUG( "unknown format" );
+               return;
+     }
+
+     ret = mDFB->CreateSurface( mDFB, &desc, &mDFBSurface );
+     if (ret) {
+          D_DERROR( (DirectResult) ret, "gfxDirectFBSurface: "
+                                        "IDirectFB::CreateSurface( %dx%d ) failed!\n", desc.width, desc.height );
+          return;
+     }
+
+     cairo_surface_t *surface = cairo_directfb_surface_create(mDFB, mDFBSurface);
+
+     Init(surface);
+}
+
+gfxDirectFBSurface::~gfxDirectFBSurface()
+{
+     if (mDFBSurface)
+          mDFBSurface->Release( mDFBSurface );
+
+     if (mDFB)
+          mDFB->Release( mDFB );
+}
+
diff --git a/gfx/thebes/src/gfxFT2Fonts.cpp b/gfx/thebes/src/gfxFT2Fonts.cpp
new file mode 100644
--- /dev/null
+++ b/gfx/thebes/src/gfxFT2Fonts.cpp
@@ -0,0 +1,862 @@
+/* -*- Mode: C++; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*-
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Mozilla Foundation code.
+ *
+ * The Initial Developer of the Original Code is Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2005
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#include "gfxPlatformGtk.h"
+#include "gfxTypes.h"
+#include "gfxFT2Fonts.h"
+#include <locale.h>
+#include "cairo-ft.h"
+#include <freetype/tttables.h>
+#include "gfxFontUtils.h"
+
+/**
+ * FontEntry
+ */
+
+FontEntry::FontEntry(const FontEntry& aFontEntry) :
+    mFaceName(aFontEntry.mFaceName),
+    mUnicodeFont(aFontEntry.mUnicodeFont),
+    mSymbolFont(aFontEntry.mSymbolFont),
+    mItalic(aFontEntry.mItalic),
+    mWeight(aFontEntry.mWeight),
+    mCharacterMap(aFontEntry.mCharacterMap)
+{
+    if (aFontEntry.mFontFace)
+        mFontFace = cairo_font_face_reference(aFontEntry.mFontFace);
+    else
+        mFontFace = nsnull;
+}
+
+FontEntry::~FontEntry()
+{
+    if (mFontFace) {
+        cairo_font_face_destroy(mFontFace);
+        mFontFace = nsnull;
+    }
+}
+
+static void
+FTFontDestroyFunc(void *data)
+{
+    FT_Face face = (FT_Face)data;
+    FT_Done_Face(face);
+}
+
+cairo_font_face_t *
+FontEntry::CairoFontFace()
+{
+    static cairo_user_data_key_t key;
+
+    if (!mFontFace) {
+        FT_Face face;
+        FT_New_Face(gfxPlatformGtk::GetPlatform()->GetFTLibrary(), mFilename.get(), mFTFontIndex, &face);
+        mFontFace = cairo_ft_font_face_create_for_ft_face(face, 0);
+        cairo_font_face_set_user_data(mFontFace, &key, face, FTFontDestroyFunc);
+    }
+    return mFontFace;
+}
+
+FontEntry *
+FontFamily::FindFontEntry(const gfxFontStyle& aFontStyle)
+{
+    PRBool italic = (aFontStyle.style & (FONT_STYLE_ITALIC | FONT_STYLE_OBLIQUE)) != 0;
+
+    FontEntry *weightList[10] = { 0 };
+    for (PRUint32 j = 0; j < 2; j++) {
+        PRBool matchesSomething = PR_FALSE;
+        // build up an array of weights that match the italicness we're looking for
+        for (PRUint32 i = 0; i < mFaces.Length(); i++) {
+            FontEntry *fe = mFaces[i];
+            const PRUint8 weight = (fe->mWeight / 100);
+            if (fe->mItalic == italic) {
+                weightList[weight] = fe;
+                matchesSomething = PR_TRUE;
+            }
+        }
+        if (matchesSomething)
+            break;
+        italic = !italic;
+    }
+
+    PRInt8 baseWeight, weightDistance;
+    aFontStyle.ComputeWeightAndOffset(&baseWeight, &weightDistance);
+
+    // 500 isn't quite bold so we want to treat it as 400 if we don't
+    // have a 500 weight
+    if (baseWeight == 5 && weightDistance == 0) {
+        // If we have a 500 weight then use it
+        if (weightList[5])
+            return weightList[5];
+
+        // Otherwise treat as 400
+        baseWeight = 4;
+    }
+
+    PRInt8 matchBaseWeight = 0;
+    PRInt8 direction = (baseWeight > 5) ? 1 : -1;
+    for (PRInt8 i = baseWeight; ; i += direction) {
+        if (weightList[i]) {
+            matchBaseWeight = i;
+            break;
+        }
+
+        // if we've reached one side without finding a font,
+        // go the other direction until we find a match
+        if (i == 1 || i == 9)
+            direction = -direction;
+    }
+
+    FontEntry *matchFE;
+    const PRInt8 absDistance = abs(weightDistance);
+    direction = (weightDistance >= 0) ? 1 : -1;
+    for (PRInt8 i = matchBaseWeight, k = 0; i < 10 && i > 0; i += direction) {
+        if (weightList[i]) {
+            matchFE = weightList[i];
+            k++;
+        }
+        if (k > absDistance)
+            break;
+    }
+
+    if (!matchFE)
+        matchFE = weightList[matchBaseWeight];
+
+    NS_ASSERTION(matchFE, "we should always be able to return something here");
+    return matchFE;
+}
+
+
+
+/**
+ * gfxFT2FontGroup
+ */
+
+PRBool
+gfxFT2FontGroup::FontCallback(const nsAString& fontName,
+                             const nsACString& genericName,
+                             void *closure)
+{
+    nsStringArray *sa = static_cast<nsStringArray*>(closure);
+
+    if (!fontName.IsEmpty() && sa->IndexOf(fontName) < 0) {
+        sa->AppendString(fontName);
+#ifdef DEBUG_pavlov
+        printf(" - %s\n", NS_ConvertUTF16toUTF8(fontName).get());
+#endif
+    }
+
+    return PR_TRUE;
+}
+
+/**
+ * Look up the font in the gfxFont cache. If we don't find it, create one.
+ * In either case, add a ref, append it to the aFonts array, and return it ---
+ * except for OOM in which case we do nothing and return null.
+ */
+static already_AddRefed<gfxFT2Font>
+GetOrMakeFont(const nsAString& aName, const gfxFontStyle *aStyle)
+{
+    nsRefPtr<gfxFont> font = gfxFontCache::GetCache()->Lookup(aName, aStyle);
+    if (!font) {
+        FontEntry *fe = gfxPlatformGtk::GetPlatform()->FindFontEntry(aName, *aStyle);
+        if (!fe) {
+            printf("Failed to find font entry for %s\n", NS_ConvertUTF16toUTF8(aName).get());
+            return nsnull;
+        }
+
+        font = new gfxFT2Font(fe, aStyle);
+        if (!font)
+            return nsnull;
+        gfxFontCache::GetCache()->AddNew(font);
+    }
+    gfxFont *f = nsnull;
+    font.swap(f);
+    return static_cast<gfxFT2Font *>(f);
+}
+
+
+gfxFT2FontGroup::gfxFT2FontGroup(const nsAString& families,
+                               const gfxFontStyle *aStyle)
+    : gfxFontGroup(families, aStyle)
+{
+#ifdef DEBUG_pavlov
+    printf("Looking for %s\n", NS_ConvertUTF16toUTF8(families).get());
+#endif
+    nsStringArray familyArray;
+    ForEachFont(FontCallback, &familyArray);
+
+    if (familyArray.Count() == 0) {
+        nsAutoString prefFamilies;
+        gfxPlatformGtk::GetPlatform()->GetPrefFonts(aStyle->langGroup.get(), prefFamilies, nsnull);
+        if (!prefFamilies.IsEmpty()) {
+            ForEachFont(prefFamilies, aStyle->langGroup, FontCallback, &familyArray);
+        }
+    }
+#if 0 /* FIXME DFB */
+    if (familyArray.Count() == 0) {
+        printf("failde to find a font. sadface\n");
+        // We want to get rid of this entirely at some point, but first we need real lists of fonts.
+        QFont defaultFont;
+        QFontInfo fi (defaultFont);
+        familyArray.AppendString(nsDependentString(static_cast<const PRUnichar *>(fi.family().utf16())));
+    }
+#endif
+
+    for (int i = 0; i < familyArray.Count(); i++) {
+        nsRefPtr<gfxFT2Font> font = GetOrMakeFont(*familyArray[i], &mStyle);
+        if (font) {
+            mFonts.AppendElement(font);
+        }
+    }
+}
+
+gfxFT2FontGroup::~gfxFT2FontGroup()
+{
+}
+
+gfxFontGroup *
+gfxFT2FontGroup::Copy(const gfxFontStyle *aStyle)
+{
+     return new gfxFT2FontGroup(mFamilies, aStyle);
+}
+
+/**
+ * We use this to append an LTR or RTL Override character to the start of the
+ * string. This forces Pango to honour our direction even if there are neutral
+ * characters in the string.
+ */
+static PRInt32 AppendDirectionalIndicatorUTF8(PRBool aIsRTL, nsACString& aString)
+{
+    static const PRUnichar overrides[2][2] = { { 0x202d, 0 }, { 0x202e, 0 }}; // LRO, RLO
+    AppendUTF16toUTF8(overrides[aIsRTL], aString);
+    return 3; // both overrides map to 3 bytes in UTF8
+}
+
+gfxTextRun *gfxFT2FontGroup::MakeTextRun(const PRUnichar* aString, PRUint32 aLength,
+                                        const Parameters* aParams, PRUint32 aFlags)
+{
+    gfxTextRun *textRun = gfxTextRun::Create(aParams, aString, aLength, this, aFlags);
+    if (!textRun)
+        return nsnull;
+
+    textRun->RecordSurrogates(aString);
+
+    mString.Assign(nsDependentSubstring(aString, aString + aLength));
+
+    InitTextRun(textRun);
+
+    textRun->FetchGlyphExtents(aParams->mContext);
+
+    return textRun;
+}
+
+gfxTextRun *gfxFT2FontGroup::MakeTextRun(const PRUint8 *aString, PRUint32 aLength,
+                                        const Parameters *aParams, PRUint32 aFlags)
+{
+    NS_ASSERTION(aFlags & TEXT_IS_8BIT, "8bit should have been set");
+    gfxTextRun *textRun = gfxTextRun::Create(aParams, aString, aLength, this, aFlags);
+    if (!textRun)
+        return nsnull;
+
+    const char *chars = reinterpret_cast<const char *>(aString);
+
+    mString.Assign(NS_ConvertASCIItoUTF16(nsDependentCSubstring(chars, chars + aLength)));
+
+    InitTextRun(textRun);
+
+    textRun->FetchGlyphExtents(aParams->mContext);
+
+    return textRun;
+}
+
+void gfxFT2FontGroup::InitTextRun(gfxTextRun *aTextRun)
+{
+    CreateGlyphRunsFT(aTextRun);
+}
+
+
+// Helper function to return the leading UTF-8 character in a char pointer
+// as 32bit number. Also sets the length of the current character (i.e. the
+// offset to the next one) in the second argument
+PRUint32 getUTF8CharAndNext(const PRUint8 *aString, PRUint8 *aLength)
+{
+    *aLength = 1;
+    if (aString[0] < 0x80) { // normal 7bit ASCII char
+        return aString[0];
+    }
+    if ((aString[0] >> 5) == 6) { // two leading ones -> two bytes
+        *aLength = 2;
+        return ((aString[0] & 0x1F) << 6) + (aString[1] & 0x3F);
+    }
+    if ((aString[0] >> 4) == 14) { // three leading ones -> three bytes
+        *aLength = 3;
+        return ((aString[0] & 0x0F) << 12) + ((aString[1] & 0x3F) << 6) +
+               (aString[2] & 0x3F);
+    }
+    if ((aString[0] >> 4) == 15) { // four leading ones -> four bytes
+        *aLength = 4;
+        return ((aString[0] & 0x07) << 18) + ((aString[1] & 0x3F) << 12) +
+               ((aString[2] & 0x3F) <<  6) + (aString[3] & 0x3F);
+    }
+    return aString[0];
+}
+
+
+
+
+
+
+
+
+PRBool
+HasCharacter(gfxFT2Font *aFont, PRUint32 ch)
+{
+    if (aFont->GetFontEntry()->mCharacterMap.test(ch))
+        return PR_TRUE;
+
+    // XXX move this lock way way out
+    FT_Face face = cairo_ft_scaled_font_lock_face(aFont->CairoScaledFont());
+    FT_UInt gid = FT_Get_Char_Index(face, ch);
+    cairo_ft_scaled_font_unlock_face(aFont->CairoScaledFont());
+
+    if (gid != 0) {
+        aFont->GetFontEntry()->mCharacterMap.set(ch);
+        return PR_TRUE;
+    }
+    return PR_FALSE;
+}
+
+#if 0
+inline FontEntry *
+gfxFT2FontGroup::WhichFontSupportsChar(const nsTArray<>& foo, PRUint32 ch)
+{
+    for (int i = 0; i < aGroup->FontListLength(); i++) {
+        nsRefPtr<gfxFT2Font> font = aGroup->GetFontAt(i);
+        if (HasCharacter(font, ch))
+            return font;
+    }
+    return nsnull;
+}
+#endif
+
+inline gfxFT2Font *
+gfxFT2FontGroup::FindFontForChar(PRUint32 ch, PRUint32 prevCh, PRUint32 nextCh, gfxFT2Font *aFont)
+{
+    gfxFT2Font *selectedFont;
+
+    // if this character or the next one is a joiner use the
+    // same font as the previous range if we can
+    if (gfxFontUtils::IsJoiner(ch) || gfxFontUtils::IsJoiner(prevCh) || gfxFontUtils::IsJoiner(nextCh)) {
+        if (aFont && HasCharacter(aFont, ch))
+            return aFont;
+    }
+
+    for (PRUint32 i = 0; i < FontListLength(); i++) {
+        nsRefPtr<gfxFT2Font> font = GetFontAt(i);
+        if (HasCharacter(font, ch))
+            return font;
+    }
+    return nsnull;
+
+#if 0
+    // check the list of fonts
+    selectedFont = WhichFontSupportsChar(mGroup->GetFontList(), ch);
+
+
+    // don't look in other fonts if the character is in a Private Use Area
+    if ((ch >= 0xE000  && ch <= 0xF8FF) || 
+        (ch >= 0xF0000 && ch <= 0x10FFFD))
+        return selectedFont;
+
+    // check out the style's language group
+    if (!selectedFont) {
+        nsAutoTArray<nsRefPtr<FontEntry>, 5> fonts;
+        this->GetPrefFonts(mGroup->GetStyle()->langGroup.get(), fonts);
+        selectedFont = WhichFontSupportsChar(fonts, ch);
+    }
+
+    // otherwise search prefs
+    if (!selectedFont) {
+        /* first check with the script properties to see what they think */
+        if (ch <= 0xFFFF) {
+            PRUint32 unicodeRange = FindCharUnicodeRange(ch);
+            
+            /* special case CJK */
+            if (unicodeRange == kRangeSetCJK) {
+                if (PR_LOG_TEST(gFontLog, PR_LOG_DEBUG))
+                    PR_LOG(gFontLog, PR_LOG_DEBUG, (" - Trying to find fonts for: CJK"));
+
+                nsAutoTArray<nsRefPtr<FontEntry>, 15> fonts;
+                this->GetCJKPrefFonts(fonts);
+                selectedFont = WhichFontSupportsChar(fonts, ch);
+            } else {
+                const char *langGroup = LangGroupFromUnicodeRange(unicodeRange);
+                if (langGroup) {
+                    PR_LOG(gFontLog, PR_LOG_DEBUG, (" - Trying to find fonts for: %s", langGroup));
+
+                    nsAutoTArray<nsRefPtr<FontEntry>, 5> fonts;
+                    this->GetPrefFonts(langGroup, fonts);
+                    selectedFont = WhichFontSupportsChar(fonts, ch);
+                }
+            }
+        }
+    }
+
+    // before searching for something else check the font used for the previous character
+    if (!selectedFont && aFont && HasCharacter(aFont, ch))
+        selectedFont = aFont;
+
+    // otherwise look for other stuff
+    if (!selectedFont) {
+        PR_LOG(gFontLog, PR_LOG_DEBUG, (" - Looking for best match"));
+        
+        nsRefPtr<gfxWindowsFont> refFont = mGroup->GetFontAt(0);
+        gfxWindowsPlatform *platform = gfxWindowsPlatform::GetPlatform();
+        selectedFont = platform->FindFontForChar(ch, refFont);
+    }
+
+    return selectedFont;
+#endif
+}
+
+PRUint32
+gfxFT2FontGroup::ComputeRanges()
+{
+    const PRUnichar *str = mString.get();
+    PRUint32 len = mString.Length();
+
+    mRanges.Clear();
+
+    PRUint32 prevCh = 0;
+    for (PRUint32 i = 0; i < len; i++) {
+        const PRUint32 origI = i; // save off incase we increase for surrogate
+        PRUint32 ch = str[i];
+        if ((i+1 < len) && NS_IS_HIGH_SURROGATE(ch) && NS_IS_LOW_SURROGATE(str[i+1])) {
+            i++;
+            ch = SURROGATE_TO_UCS4(ch, str[i]);
+        }
+
+        PRUint32 nextCh = 0;
+        if (i+1 < len) {
+            nextCh = str[i+1];
+            if ((i+2 < len) && NS_IS_HIGH_SURROGATE(ch) && NS_IS_LOW_SURROGATE(str[i+2]))
+                nextCh = SURROGATE_TO_UCS4(nextCh, str[i+2]);
+        }
+        gfxFT2Font *fe = FindFontForChar(ch,
+                                        prevCh,
+                                        nextCh,
+                                        (mRanges.Length() == 0) ? nsnull : mRanges[mRanges.Length() - 1].font);
+
+        prevCh = ch;
+
+        if (mRanges.Length() == 0) {
+            TextRange r(0,1);
+            r.font = fe;
+            mRanges.AppendElement(r);
+        } else {
+            TextRange& prevRange = mRanges[mRanges.Length() - 1];
+            if (prevRange.font != fe) {
+                // close out the previous range
+                prevRange.end = origI;
+
+                TextRange r(origI, i+1);
+                r.font = fe;
+                mRanges.AppendElement(r);
+            }
+        }
+    }
+    mRanges[mRanges.Length()-1].end = len;
+
+    PRUint32 nranges = mRanges.Length();
+    return nranges;
+}
+
+void gfxFT2FontGroup::CreateGlyphRunsFT(gfxTextRun *aTextRun)
+{
+    ComputeRanges();
+
+    const PRUnichar *strStart = mString.get();
+    for (PRUint32 i = 0; i < mRanges.Length(); ++i) {
+        const TextRange& range = mRanges[i];
+        const PRUnichar *rangeString = strStart + range.start;
+        PRUint32 rangeLength = range.Length();
+
+        gfxFT2Font *font = range.font ? range.font.get() : GetFontAt(0);
+        AddRange(aTextRun, font, rangeString, rangeLength);
+    }
+    
+}
+
+void
+gfxFT2FontGroup::AddRange(gfxTextRun *aTextRun, gfxFT2Font *font, const PRUnichar *str, PRUint32 len)
+{
+    const PRUint32 appUnitsPerDevUnit = aTextRun->GetAppUnitsPerDevUnit();
+    // we'll pass this in/figure it out dynamically, but at this point there can be only one face.
+    FT_Face face = cairo_ft_scaled_font_lock_face(font->CairoScaledFont());
+
+    gfxTextRun::CompressedGlyph g;
+
+    aTextRun->AddGlyphRun(font, 0);
+    for (PRUint32 i = 0; i < len; i++) {
+        PRUint32 ch = str[i];
+
+        if (ch == 0) {
+            // treat this null byte as a missing glyph, don't create a glyph for it
+            aTextRun->SetMissingGlyph(i, 0);
+            continue;
+        }
+
+        NS_ASSERTION(!IsInvalidChar(ch), "Invalid char detected");
+        FT_UInt gid = FT_Get_Char_Index(face, ch); // find the glyph id
+        PRInt32 advance = 0;
+
+        if (gid == font->GetSpaceGlyph()) {
+            advance = (int)(font->GetMetrics().spaceWidth * appUnitsPerDevUnit);
+        } else if (gid == 0) {
+            advance = -1; // trigger the missing glyphs case below
+        } else {
+            // find next character and its glyph -- in case they exist
+            // and exist in the current font face -- to compute kerning
+            PRUint32 chNext = 0;
+            FT_UInt gidNext = 0;
+            FT_Pos lsbDeltaNext = 0;
+
+            if (FT_HAS_KERNING(face) && i + 1 < len) {
+                chNext = str[i+1];
+                if (chNext != 0) {
+                    gidNext = FT_Get_Char_Index(face, chNext);
+                    if (gidNext && gidNext != font->GetSpaceGlyph()) {
+                        FT_Load_Glyph(face, gidNext, FT_LOAD_DEFAULT);
+                        lsbDeltaNext = face->glyph->lsb_delta;
+                    }
+                }
+            }
+
+            // now load the current glyph
+            FT_Load_Glyph(face, gid, FT_LOAD_DEFAULT); // load glyph into the slot
+            advance = face->glyph->advance.x;
+
+            // now add kerning to the current glyph's advance
+            if (chNext && gidNext) {
+                FT_Vector kerning; kerning.x = 0;
+                FT_Get_Kerning(face, gid, gidNext, FT_KERNING_DEFAULT, &kerning);
+                advance += kerning.x;
+                if (face->glyph->rsb_delta - lsbDeltaNext >= 32) {
+                    advance -= 64;
+                } else if (face->glyph->rsb_delta - lsbDeltaNext < -32) {
+                    advance += 64;
+                }
+            }
+
+            // now apply unit conversion and scaling
+            advance = (advance >> 6) * appUnitsPerDevUnit;
+        }
+#ifdef DEBUG_thebes_2
+        printf(" gid=%d, advance=%d (%s)\n", gid, advance,
+               NS_LossyConvertUTF16toASCII(font->GetName()).get());
+#endif
+
+        if (advance >= 0 &&
+            gfxTextRun::CompressedGlyph::IsSimpleAdvance(advance) &&
+            gfxTextRun::CompressedGlyph::IsSimpleGlyphID(gid)) {
+            aTextRun->SetSimpleGlyph(i, g.SetSimpleGlyph(advance, gid));
+        } else if (gid == 0) {
+            // gid = 0 only happens when the glyph is missing from the font
+            aTextRun->SetMissingGlyph(i, ch);
+        } else {
+            gfxTextRun::DetailedGlyph details;
+            details.mGlyphID = gid;
+            NS_ASSERTION(details.mGlyphID == gid, "Seriously weird glyph ID detected!");
+            details.mAdvance = advance;
+            details.mXOffset = 0;
+            details.mYOffset = 0;
+            g.SetComplex(aTextRun->IsClusterStart(i), PR_TRUE, 1);
+            aTextRun->SetGlyphs(i, g, &details);
+        }
+    }
+
+    cairo_ft_scaled_font_unlock_face(font->CairoScaledFont());
+}
+
+/**
+ * gfxFT2Font
+ */
+gfxFT2Font::gfxFT2Font(FontEntry *aFontEntry,
+                     const gfxFontStyle *aFontStyle)
+    : gfxFont(aFontEntry, aFontStyle),
+    mScaledFont(nsnull),
+    mHasSpaceGlyph(PR_FALSE),
+    mSpaceGlyph(0),
+    mHasMetrics(PR_FALSE),
+    mAdjustedSize(0),
+    mFontEntry(aFontEntry)
+{
+}
+
+gfxFT2Font::~gfxFT2Font()
+{
+    if (mScaledFont) {
+        cairo_scaled_font_destroy(mScaledFont);
+        mScaledFont = nsnull;
+    }
+}
+
+// rounding and truncation functions for a Freetype floating point number 
+// (FT26Dot6) stored in a 32bit integer with high 26 bits for the integer
+// part and low 6 bits for the fractional part. 
+#define MOZ_FT_ROUND(x) (((x) + 32) & ~63) // 63 = 2^6 - 1
+#define MOZ_FT_TRUNC(x) ((x) >> 6)
+#define CONVERT_DESIGN_UNITS_TO_PIXELS(v, s) \
+        MOZ_FT_TRUNC(MOZ_FT_ROUND(FT_MulFix((v) , (s))))
+
+const gfxFont::Metrics&
+gfxFT2Font::GetMetrics()
+{
+    if (mHasMetrics)
+        return mMetrics;
+
+    mMetrics.emHeight = GetStyle()->size;
+
+    FT_Face face = cairo_ft_scaled_font_lock_face(CairoScaledFont());
+
+    if (!face) {
+        // Abort here already, otherwise we crash in the following
+        // this can happen if the font-size requested is zero.
+        // The metrics will be incomplete, but then we don't care.
+        return mMetrics;
+    }
+
+    mMetrics.emHeight = GetStyle()->size;
+
+    FT_UInt gid; // glyph ID
+
+    const double emUnit = 1.0 * face->units_per_EM;
+    const double xScale = face->size->metrics.x_ppem / emUnit;
+    const double yScale = face->size->metrics.y_ppem / emUnit;
+
+    // properties of space
+    gid = FT_Get_Char_Index(face, ' ');
+    if (gid) {
+        FT_Load_Glyph(face, gid, FT_LOAD_DEFAULT);
+        // face->glyph->metrics.width doesn't work for spaces, use advance.x instead
+        mMetrics.spaceWidth = face->glyph->advance.x >> 6;
+        // save the space glyph
+        mSpaceGlyph = gid;
+    } else {
+        NS_ASSERTION(0, "blah");
+    }
+            
+    // properties of 'x', also use its width as average width
+    gid = FT_Get_Char_Index(face, 'x'); // select the glyph
+    if (gid) {
+        // Load glyph into glyph slot. Here, use no_scale to get font units.
+        FT_Load_Glyph(face, gid, FT_LOAD_NO_SCALE);
+        mMetrics.xHeight = face->glyph->metrics.height * yScale;
+        mMetrics.aveCharWidth = face->glyph->metrics.width * xScale;
+    } else {
+        // this font doesn't have an 'x'...
+        // fake these metrics using a fraction of the font size
+        mMetrics.xHeight = mMetrics.emHeight * 0.5;
+        mMetrics.aveCharWidth = mMetrics.emHeight * 0.5;
+    }
+
+    // compute an adjusted size if we need to
+    if (mAdjustedSize == 0 && GetStyle()->sizeAdjust != 0) {
+        gfxFloat aspect = mMetrics.xHeight / GetStyle()->size;
+        mAdjustedSize = GetStyle()->GetAdjustedSize(aspect);
+        mMetrics.emHeight = mAdjustedSize;
+    }
+
+    // now load the OS/2 TrueType table to load access some more properties
+    TT_OS2 *os2 = (TT_OS2 *)FT_Get_Sfnt_Table(face, ft_sfnt_os2);
+    if (os2 && os2->version != 0xFFFF) { // should be there if not old Mac font
+        // if we are here we can improve the avgCharWidth
+        mMetrics.aveCharWidth = os2->xAvgCharWidth * xScale;
+
+        mMetrics.superscriptOffset = os2->ySuperscriptYOffset * yScale;
+        mMetrics.superscriptOffset = PR_MAX(1, mMetrics.superscriptOffset);
+        // some fonts have the incorrect sign (from gfxPangoFonts)
+        mMetrics.subscriptOffset   = fabs(os2->ySubscriptYOffset * yScale);
+        mMetrics.subscriptOffset   = PR_MAX(1, fabs(mMetrics.subscriptOffset));
+        mMetrics.strikeoutOffset   = os2->yStrikeoutPosition * yScale;
+        mMetrics.strikeoutSize     = os2->yStrikeoutSize * yScale;
+    } else {
+        // use fractions of emHeight instead of xHeight for these to be more robust
+        mMetrics.superscriptOffset = mMetrics.emHeight * 0.5;
+        mMetrics.subscriptOffset   = mMetrics.emHeight * 0.2;
+        mMetrics.strikeoutOffset   = mMetrics.emHeight * 0.3;
+        mMetrics.strikeoutSize     = face->underline_thickness * yScale;
+    }
+    // seems that underlineOffset really has to be negative
+    mMetrics.underlineOffset = face->underline_position * yScale;
+    mMetrics.underlineSize   = face->underline_thickness * yScale;
+
+    // descents are negative in FT but Thebes wants them positive
+    mMetrics.emAscent        = face->ascender * yScale;
+    mMetrics.emDescent       = -face->descender * yScale;
+    mMetrics.maxHeight       = face->height * yScale;
+    mMetrics.maxAscent       = face->bbox.yMax * yScale;
+    mMetrics.maxDescent      = -face->bbox.yMin * yScale;
+    mMetrics.maxAdvance      = face->max_advance_width * xScale;
+    // leading are not available directly (only for WinFNTs)
+    double lineHeight = mMetrics.maxAscent + mMetrics.maxDescent;
+    if (lineHeight > mMetrics.emHeight) {
+        mMetrics.internalLeading = lineHeight - mMetrics.emHeight;
+    } else {
+        mMetrics.internalLeading = 0;
+    }
+    mMetrics.externalLeading = 0; // normal value for OS/2 fonts, too
+
+    SanitizeMetrics(&mMetrics, PR_FALSE);
+
+    /*
+    printf("gfxOS2Font[%#x]::GetMetrics():\n"
+           "  emHeight=%f == %f=gfxFont::style.size == %f=adjSz\n"
+           "  maxHeight=%f  xHeight=%f\n"
+           "  aveCharWidth=%f==xWidth  spaceWidth=%f\n"
+           "  supOff=%f SubOff=%f   strOff=%f strSz=%f\n"
+           "  undOff=%f undSz=%f    intLead=%f extLead=%f\n"
+           "  emAsc=%f emDesc=%f maxH=%f\n"
+           "  maxAsc=%f maxDes=%f maxAdv=%f\n",
+           (unsigned)this,
+           mMetrics.emHeight, GetStyle()->size, mAdjustedSize,
+           mMetrics.maxHeight, mMetrics.xHeight,
+           mMetrics.aveCharWidth, mMetrics.spaceWidth,
+           mMetrics.superscriptOffset, mMetrics.subscriptOffset,
+           mMetrics.strikeoutOffset, mMetrics.strikeoutSize,
+           mMetrics.underlineOffset, mMetrics.underlineSize,
+           mMetrics.internalLeading, mMetrics.externalLeading,
+           mMetrics.emAscent, mMetrics.emDescent, mMetrics.maxHeight,
+           mMetrics.maxAscent, mMetrics.maxDescent, mMetrics.maxAdvance
+          );
+    */
+
+    // XXX mMetrics.height needs to be set.
+    cairo_ft_scaled_font_unlock_face(CairoScaledFont());
+
+    mHasMetrics = PR_TRUE;
+    return mMetrics;
+}
+
+
+nsString
+gfxFT2Font::GetUniqueName()
+{
+    return GetName();
+}
+
+PRUint32
+gfxFT2Font::GetSpaceGlyph()
+{
+    NS_ASSERTION (GetStyle ()->size != 0,
+    "forgot to short-circuit a text run with zero-sized font?");
+
+    if(!mHasSpaceGlyph)
+    {
+        FT_UInt gid = 0; // glyph ID
+        FT_Face face = cairo_ft_scaled_font_lock_face(CairoScaledFont());
+        gid = FT_Get_Char_Index(face, ' ');
+        FT_Load_Glyph(face, gid, FT_LOAD_DEFAULT);
+        mSpaceGlyph = gid;
+        mHasSpaceGlyph = PR_TRUE;
+        cairo_ft_scaled_font_unlock_face(CairoScaledFont());
+    }
+    return mSpaceGlyph;
+}
+
+cairo_font_face_t *
+gfxFT2Font::CairoFontFace()
+{
+    // XXX we need to handle fake bold here (or by having a sepaerate font entry)
+    if (mStyle.weight >= 600 && mFontEntry->mWeight < 600)
+        printf("** We want fake weight\n");
+    return mFontEntry->CairoFontFace();
+}
+
+cairo_scaled_font_t *
+gfxFT2Font::CairoScaledFont()
+{
+    if (!mScaledFont) {
+        cairo_matrix_t sizeMatrix;
+        cairo_matrix_t identityMatrix;
+
+        // XXX deal with adjusted size
+        cairo_matrix_init_scale(&sizeMatrix, mStyle.size, mStyle.size);
+        cairo_matrix_init_identity(&identityMatrix);
+
+        // synthetic oblique by skewing via the font matrix
+        PRBool needsOblique = (!mFontEntry->mItalic && (mStyle.style & (FONT_STYLE_ITALIC | FONT_STYLE_OBLIQUE)));
+
+        if (needsOblique) {
+            const double kSkewFactor = 0.25;
+
+            cairo_matrix_t style;
+            cairo_matrix_init(&style,
+                              1,                //xx
+                              0,                //yx
+                              -1 * kSkewFactor,  //xy
+                              1,                //yy
+                              0,                //x0
+                              0);               //y0
+            cairo_matrix_multiply(&sizeMatrix, &sizeMatrix, &style);
+        }
+
+        cairo_font_options_t *fontOptions = cairo_font_options_create();
+        mScaledFont = cairo_scaled_font_create(CairoFontFace(), &sizeMatrix,
+                                               &identityMatrix, fontOptions);
+        cairo_font_options_destroy(fontOptions);
+    }
+
+    NS_ASSERTION(mAdjustedSize == 0.0 ||
+                 cairo_scaled_font_status(mScaledFont) == CAIRO_STATUS_SUCCESS,
+                 "Failed to make scaled font");
+
+    return mScaledFont;
+}
+
+PRBool
+gfxFT2Font::SetupCairoFont(gfxContext *aContext)
+{
+    cairo_scaled_font_t *scaledFont = CairoScaledFont();
+
+    if (cairo_scaled_font_status(scaledFont) != CAIRO_STATUS_SUCCESS) {
+        // Don't cairo_set_scaled_font as that would propagate the error to
+        // the cairo_t, precluding any further drawing.
+        return PR_FALSE;
+    }
+    cairo_set_scaled_font(aContext->GetCairo(), scaledFont);
+    return PR_TRUE;
+}
diff --git a/gfx/thebes/src/gfxFont.cpp b/gfx/thebes/src/gfxFont.cpp
--- a/gfx/thebes/src/gfxFont.cpp
+++ b/gfx/thebes/src/gfxFont.cpp
@@ -19,10 +19,11 @@
  * the Initial Developer. All Rights Reserved.
  *
  * Contributor(s):
  *   Stuart Parmenter <stuart@mozilla.com>
  *   Masayuki Nakano <masayuki@d-toybox.com>
+ *   John Daggett <jdaggett@mozilla.com>
  *
  * Alternatively, the contents of this file may be used under the terms of
  * either the GNU General Public License Version 2 or later (the "GPL"), or
  * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
  * in which case the provisions of the GPL or the LGPL are applicable instead
@@ -70,10 +71,81 @@ static PRUint32 gGlyphExtentsSetupEagerS
 static PRUint32 gGlyphExtentsSetupEagerSimple = 0;
 static PRUint32 gGlyphExtentsSetupEagerTight = 0;
 static PRUint32 gGlyphExtentsSetupLazyTight = 0;
 static PRUint32 gGlyphExtentsSetupFallBackToTight = 0;
 #endif
+
+gfxFontEntry::~gfxFontEntry() {
+
+}
+
+
+PRBool gfxFontEntry::TestCharacterMap(PRUint32 aCh) {
+    if (!mCmapInitialized) ReadCMAP();
+    return mCharacterMap.test(aCh);
+}
+
+
+gfxFontEntry *gfxFontFamily::FindFontForStyle(const gfxFontStyle& aFontStyle, PRBool& aNeedsBold)
+{
+    gfxFontEntry *weightList[10] = { 0 };
+
+    aNeedsBold = PR_FALSE;
+
+    FindWeightsForStyle(weightList, aFontStyle);
+
+    PRInt8 baseWeight, weightDistance;
+    aFontStyle.ComputeWeightAndOffset(&baseWeight, &weightDistance);
+
+    // 500 isn't quite bold so we want to treat it as 400 if we don't
+    // have a 500 weight
+    if (baseWeight == 5 && weightDistance == 0) {
+        // If we have a 500 weight then use it
+        if (weightList[5])
+            return weightList[5];
+
+        // Otherwise treat as 400
+        baseWeight = 4;
+    }
+
+    PRInt8 matchBaseWeight = 0;
+    PRInt8 direction = (baseWeight > 5) ? 1 : -1;
+    for (PRInt8 i = baseWeight; ; i += direction) {
+        if (weightList[i]) {
+            matchBaseWeight = i;
+            break;
+        }
+
+        // if we've reached one side without finding a font,
+        // go the other direction until we find a match
+        if (i == 1 || i == 9)
+            direction = -direction;
+    }
+
+    gfxFontEntry *matchFE;
+    const PRInt8 absDistance = abs(weightDistance);
+    direction = (weightDistance >= 0) ? 1 : -1;
+    PRInt8 i, k;
+    for (i = matchBaseWeight, k = 0; i < 10 && i > 0; i += direction) {
+        if (weightList[i]) {
+            matchFE = weightList[i];
+            k++;
+        }
+        if (k > absDistance)
+            break;
+    }
+
+    if (weightDistance > 0 && k <= absDistance) {
+        aNeedsBold = PR_TRUE;
+    }
+
+    if (!matchFE)
+        matchFE = weightList[matchBaseWeight];
+
+    NS_ASSERTION(matchFE, "we should always be able to return something here");
+    return matchFE;
+}
 
 nsresult
 gfxFontCache::Init()
 {
     NS_ASSERTION(!gGlobalCache, "Where did this come from?");
@@ -172,12 +244,12 @@ gfxFontCache::DestroyFont(gfxFont *aFont
     NS_ASSERTION(aFont->GetRefCount() == 0,
                  "Destroying with non-zero ref count!");
     delete aFont;
 }
 
-gfxFont::gfxFont(const nsAString &aName, const gfxFontStyle *aFontStyle) :
-    mName(aName), mStyle(*aFontStyle), mSyntheticBoldOffset(0)
+gfxFont::gfxFont(gfxFontEntry *aFontEntry, const gfxFontStyle *aFontStyle) :
+    mIsValid(PR_TRUE), mStyle(*aFontStyle), mFontEntry(aFontEntry), mSyntheticBoldOffset(0)
 {
 #ifdef DEBUG_TEXT_RUN_STORAGE_METRICS
     ++gFontCount;
 #endif
 }
@@ -249,11 +321,11 @@ gfxFont::Draw(gfxTextRun *aTextRun, PRUi
         return;
 
     GlyphBuffer glyphs;
     cairo_glyph_t *glyph;
     cairo_t *cr = aContext->GetCairo();
-    
+
     if (aSpacing) {
         x += direction*aSpacing[0].mBefore;
     }
     for (i = aStart; i < aEnd; ++i) {
         const gfxTextRun::CompressedGlyph *glyphData = &charGlyphs[i];
@@ -371,18 +443,14 @@ GetAdvanceForGlyphs(gfxTextRun *aTextRun
     }
     return advance;
 }
 
 static void
-UnionWithXPoint(gfxRect *aRect, double aX)
+UnionRange(gfxFloat aX, gfxFloat* aDestMin, gfxFloat* aDestMax)
 {
-    if (aX < aRect->pos.x) {
-        aRect->size.width += aRect->pos.x - aX;
-        aRect->pos.x = aX;
-    } else if (aX > aRect->XMost()) {
-        aRect->size.width = aX - aRect->pos.x;
-    }
+    *aDestMin = PR_MIN(*aDestMin, aX);
+    *aDestMax = PR_MAX(*aDestMax, aX);
 }
 
 static PRBool
 NeedsGlyphExtents(gfxTextRun *aTextRun)
 {
@@ -400,18 +468,17 @@ gfxFont::Measure(gfxTextRun *aTextRun,
     const gfxFont::Metrics& fontMetrics = GetMetrics();
 
     RunMetrics metrics;
     metrics.mAscent = fontMetrics.maxAscent*appUnitsPerDevUnit;
     metrics.mDescent = fontMetrics.maxDescent*appUnitsPerDevUnit;
-    if (!aTightBoundingBox) {
+    if (aStart == aEnd) {
+        // exit now before we look at aSpacing[0], which is undefined
         metrics.mBoundingBox = gfxRect(0, -metrics.mAscent, 0, metrics.mAscent + metrics.mDescent);
-    }
-    if (aStart == aEnd) {
-      // exit now before we look at aSpacing[0], which is undefined
-      return metrics;
+        return metrics;
     }
 
+    gfxFloat advanceMin = 0, advanceMax = 0;
     const gfxTextRun::CompressedGlyph *charGlyphs = aTextRun->GetCharacterGlyphs();
     PRBool isRTL = aTextRun->IsRightToLeft();
     double direction = aTextRun->GetDirection();
     gfxGlyphExtents *extents =
         (!aTightBoundingBox && !NeedsGlyphExtents(aTextRun) && !aTextRun->HasDetailedGlyphs()) ? nsnull
@@ -429,11 +496,12 @@ gfxFont::Measure(gfxTextRun *aTextRun,
             // for the tight bounding box or we're in quality mode
             if ((aTightBoundingBox || NeedsGlyphExtents(aTextRun)) && extents) {
                 PRUint32 glyphIndex = glyphData->GetSimpleGlyph();
                 PRUint16 extentsWidth = extents->GetContainedGlyphWidthAppUnits(glyphIndex);
                 if (extentsWidth != gfxGlyphExtents::INVALID_WIDTH && !aTightBoundingBox) {
-                    UnionWithXPoint(&metrics.mBoundingBox, x + direction*extentsWidth);
+                    UnionRange(x, &advanceMin, &advanceMax);
+                    UnionRange(x + direction*extentsWidth, &advanceMin, &advanceMax);
                 } else {
                     gfxRect glyphRect;
                     if (!extents->GetTightGlyphExtentsAppUnits(this,
                             aRefContext, glyphIndex, &glyphRect)) {
                         glyphRect = gfxRect(0, metrics.mBoundingBox.Y(),
@@ -459,12 +527,12 @@ gfxFont::Measure(gfxTextRun *aTextRun,
                 if (glyphData->IsMissing() || !extents ||
                     !extents->GetTightGlyphExtentsAppUnits(this,
                             aRefContext, glyphIndex, &glyphRect)) {
                     // We might have failed to get glyph extents due to
                     // OOM or something
-                    glyphRect = gfxRect(0, metrics.mBoundingBox.Y(),
-                        advance, metrics.mBoundingBox.Height());
+                    glyphRect = gfxRect(0, -metrics.mAscent,
+                        advance, metrics.mAscent + metrics.mDescent);
                 }
                 if (isRTL) {
                     glyphRect.pos.x -= advance;
                 }
                 glyphRect.pos.x += x;
@@ -481,12 +549,14 @@ gfxFont::Measure(gfxTextRun *aTextRun,
             x += direction*space;
         }
     }
 
     if (!aTightBoundingBox) {
-        // Make sure the non-tight bounding box includes the entire advance
-        UnionWithXPoint(&metrics.mBoundingBox, x);
+        UnionRange(x, &advanceMin, &advanceMax);
+        gfxRect fontBox(advanceMin, -metrics.mAscent,
+                        advanceMax - advanceMin, metrics.mAscent + metrics.mDescent);
+        metrics.mBoundingBox = metrics.mBoundingBox.Union(fontBox);
     }
     if (isRTL) {
         metrics.mBoundingBox.pos.x -= x;
     }
 
@@ -633,10 +703,12 @@ gfxFont::SanitizeMetrics(gfxFont::Metric
     if (aMetrics->underlineSize > aMetrics->maxAscent) {
         aMetrics->underlineSize = aMetrics->maxAscent;
     }
 }
 
+
+
 gfxGlyphExtents::~gfxGlyphExtents()
 {
 #ifdef DEBUG_TEXT_RUN_STORAGE_METRICS
     gGlyphExtentsWidthsTotalSize += mContainedGlyphWidths.ComputeSize();
     gGlyphExtentsCount++;
@@ -664,11 +736,11 @@ gfxGlyphExtents::GetTightGlyphExtentsApp
         if (!entry) {
             NS_WARNING("Could not get glyph extents");
             return PR_FALSE;
         }
     }
-    
+
     *aExtents = gfxRect(entry->x, entry->y, entry->width, entry->height);
     return PR_TRUE;
 }
 
 gfxGlyphExtents::GlyphWidths::~GlyphWidths()
@@ -951,10 +1023,117 @@ gfxFontGroup::MakeSpaceTextRun(const Par
     // always contain an entry for the font's space glyph, so we don't have
     // to call FetchGlyphExtents here.
     return textRun.forget();
 }
 
+
+
+already_AddRefed<gfxFont>
+gfxFontGroup::FindFontForChar(PRUint32 aCh, PRUint32 aPrevCh, PRUint32 aNextCh, gfxFont *aPrevMatchedFont)
+{
+    nsRefPtr<gfxFont>    selectedFont;
+
+    // if this character or the next one is a joiner use the
+    // same font as the previous range if we can
+    if (gfxFontUtils::IsJoiner(aCh) || gfxFontUtils::IsJoiner(aPrevCh) || gfxFontUtils::IsJoiner(aNextCh)) {
+        if (aPrevMatchedFont && aPrevMatchedFont->HasCharacter(aCh)) {
+            selectedFont = aPrevMatchedFont;
+            return selectedFont.forget();
+        }
+    }
+
+    // 1. check fonts in the font group
+    for (PRUint32 i = 0; i < FontListLength(); i++) {
+        nsRefPtr<gfxFont> font = GetFontAt(i);
+        if (font->HasCharacter(aCh))
+            return font.forget();
+    }
+
+    // if match, return
+    if (selectedFont)
+        return selectedFont.forget();
+        
+    // if character is in Private Use Area, don't do matching against pref or system fonts
+    if ((aCh >= 0xE000  && aCh <= 0xF8FF) || (aCh >= 0xF0000 && aCh <= 0x10FFFD))
+        return nsnull;
+
+    // 2. search pref fonts
+    if ((selectedFont = WhichPrefFontSupportsChar(aCh))) {
+        return selectedFont.forget();
+    }
+
+    // 3. use fallback fonts
+    // -- before searching for something else check the font used for the previous character
+    if (!selectedFont && aPrevMatchedFont && aPrevMatchedFont->HasCharacter(aCh)) {
+        selectedFont = aPrevMatchedFont;
+        return selectedFont.forget();
+    }
+
+    // -- otherwise look for other stuff
+    if (!selectedFont) {
+        selectedFont = WhichSystemFontSupportsChar(aCh);
+        return selectedFont.forget();
+    }
+
+    return nsnull;
+}
+
+
+void gfxFontGroup::ComputeRanges(nsTArray<gfxTextRange>& aRanges, const PRUnichar *aString, PRUint32 begin, PRUint32 end)
+{
+    const PRUnichar *str = aString + begin;
+    PRUint32 len = end - begin;
+
+    aRanges.Clear();
+
+    PRUint32 prevCh = 0;
+    for (PRUint32 i = 0; i < len; i++) {
+
+        const PRUint32 origI = i; // save off in case we increase for surrogate
+
+        // set up current ch
+        PRUint32 ch = str[i];
+        if ((i+1 < len) && NS_IS_HIGH_SURROGATE(ch) && NS_IS_LOW_SURROGATE(str[i+1])) {
+            i++;
+            ch = SURROGATE_TO_UCS4(ch, str[i]);
+        }
+
+        // set up next ch
+        PRUint32 nextCh = 0;
+        if (i+1 < len) {
+            nextCh = str[i+1];
+            if ((i+2 < len) && NS_IS_HIGH_SURROGATE(nextCh) && NS_IS_LOW_SURROGATE(str[i+2]))
+                nextCh = SURROGATE_TO_UCS4(nextCh, str[i+2]);
+        }
+        
+        // find the font for this char
+        nsRefPtr<gfxFont> font = FindFontForChar(ch, prevCh, nextCh, (aRanges.Length() == 0) ? nsnull : aRanges[aRanges.Length() - 1].font);
+
+        prevCh = ch;
+
+        if (aRanges.Length() == 0) {
+            // first char ==> make a new range
+            gfxTextRange r(0,1);
+            r.font = font;
+            aRanges.AppendElement(r);
+        } else {
+            // if font has changed, make a new range
+            gfxTextRange& prevRange = aRanges[aRanges.Length() - 1];
+            if (prevRange.font != font) {
+                // close out the previous range
+                prevRange.end = origI;
+
+                gfxTextRange r(origI, i+1);
+                r.font = font;
+                aRanges.AppendElement(r);
+            }
+        }
+    }
+    aRanges[aRanges.Length()-1].end = len;
+}
+
+
 #define DEFAULT_PIXEL_FONT_SIZE 16.0f
 
 gfxFontStyle::gfxFontStyle() :
     style(FONT_STYLE_NORMAL), systemFont(PR_TRUE), familyNameQuirks(PR_FALSE),
     weight(FONT_WEIGHT_NORMAL), size(DEFAULT_PIXEL_FONT_SIZE),
@@ -1089,15 +1268,15 @@ gfxTextRun::gfxTextRun(const gfxTextRunF
     MOZ_COUNT_CTOR(gfxTextRun);
     NS_ADDREF(mFontGroup);
     if (aParams->mSkipChars) {
         mSkipChars.TakeFrom(aParams->mSkipChars);
     }
-    
+
     mCharacterGlyphs = reinterpret_cast<CompressedGlyph*>
         (reinterpret_cast<PRUint8*>(this) + aObjectSize);
     memset(mCharacterGlyphs, 0, sizeof(CompressedGlyph)*aLength);
-    
+
     if (mFlags & gfxTextRunFactory::TEXT_IS_8BIT) {
         mText.mSingle = static_cast<const PRUint8 *>(aText);
         if (!(mFlags & gfxTextRunFactory::TEXT_IS_PERSISTENT)) {
             PRUint8 *newText = reinterpret_cast<PRUint8*>(mCharacterGlyphs + aLength);
             memcpy(newText, aText, aLength);
@@ -1412,15 +1591,15 @@ HasNonOpaqueColor(gfxContext *aContext, 
 // helper class for double-buffering drawing with non-opaque color
 struct BufferAlphaColor {
     BufferAlphaColor(gfxContext *aContext)
         : mContext(aContext)
     {
-    
+
     }
-    
+
     ~BufferAlphaColor() {}
-    
+
     void PushSolidColor(const gfxRect& aBounds, const gfxRGBA& aAlphaColor, PRUint32 appsPerDevUnit)
     {
         mContext->Save();
         mContext->NewPath();
         mContext->Rectangle(gfxRect(aBounds.X() / appsPerDevUnit,
@@ -1430,11 +1609,11 @@ struct BufferAlphaColor {
         mContext->Clip();
         mContext->SetColor(gfxRGBA(aAlphaColor.r, aAlphaColor.g, aAlphaColor.b));
         mContext->PushGroup(gfxASurface::CONTENT_COLOR_ALPHA);
         mAlpha = aAlphaColor.a;
     }
-    
+
     void PopAlpha()
     {
         // pop the text, using the color alpha as the opacity
         mContext->PopGroupToSource();
         mContext->SetOperator(gfxContext::OPERATOR_OVER);
@@ -1506,19 +1685,19 @@ gfxTextRun::Draw(gfxContext *aContext, g
 
     // synthetic bolding draws glyphs twice ==> colors with opacity won't draw correctly unless first drawn without alpha
     BufferAlphaColor syntheticBoldBuffer(aContext);
     gfxRGBA currentColor;
     PRBool needToRestore = PR_FALSE;
-    
+
     if (HasNonOpaqueColor(aContext, currentColor) && HasSyntheticBold(this, aStart, aLength)) {
         needToRestore = PR_TRUE;
         // measure text, use the bounding box
         gfxTextRun::Metrics metrics = MeasureText(aStart, aLength, PR_FALSE, aContext, aProvider);
         metrics.mBoundingBox.MoveBy(aPt);
         syntheticBoldBuffer.PushSolidColor(metrics.mBoundingBox, currentColor, GetAppUnitsPerDevUnit());
     }
-    
+
     GlyphRunIterator iter(this, aStart, aLength);
     while (iter.NextRun()) {
         gfxFont *font = iter.GetGlyphRun()->mFont;
         PRUint32 start = iter.GetStringStart();
         PRUint32 end = iter.GetStringEnd();
@@ -1611,11 +1790,11 @@ gfxTextRun::AccumulatePartialLigatureMet
 
     // First measure the complete ligature
     Metrics metrics;
     AccumulateMetricsForRun(aFont, data.mLigatureStart, data.mLigatureEnd,
                             aTight, aRefContext, aProvider, aStart, aEnd, &metrics);
-    
+
     // Clip the bounding box to the ligature part
     gfxFloat bboxLeft = metrics.mBoundingBox.X();
     gfxFloat bboxRight = metrics.mBoundingBox.XMost();
     // Where we are going to start "drawing" relative to our left baseline origin
     gfxFloat origin = IsRightToLeft() ? metrics.mAdvanceWidth - data.mPartAdvance : 0;
diff --git a/gfx/thebes/src/gfxGdkNativeRenderer.cpp b/gfx/thebes/src/gfxGdkNativeRenderer.cpp
new file mode 100644
--- /dev/null
+++ b/gfx/thebes/src/gfxGdkNativeRenderer.cpp
@@ -0,0 +1,128 @@
+/* -*- Mode: C++; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*-
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Novell code.
+ *
+ * The Initial Developer of the Original Code is Novell.
+ * Portions created by the Initial Developer are Copyright (C) 2006
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   rocallahan@novell.com
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#include "gfxGdkNativeRenderer.h"
+#include "gfxContext.h"
+
+#include "cairo-gdk-utils.h"
+
+#include "gfxPlatformGtk.h"
+
+typedef struct {
+    gfxGdkNativeRenderer* mRenderer;
+    nsresult               mRV;
+} NativeRenderingClosure;
+
+
+static cairo_bool_t
+NativeRendering(void *closure,
+                GdkDrawable * drawable,
+                short offset_x, short offset_y,
+                GdkRectangle * rectangles, unsigned int num_rects)
+{
+    NativeRenderingClosure* cl = (NativeRenderingClosure*)closure;
+    nsresult rv = cl->mRenderer->
+        NativeDraw(drawable, offset_x, offset_y,
+                   rectangles, num_rects);
+    cl->mRV = rv;
+    return NS_SUCCEEDED(rv);
+}
+
+
+nsresult
+gfxGdkNativeRenderer::Draw(gfxContext* ctx, int width, int height,
+                            PRUint32 flags, DrawOutput* output)
+{
+    NativeRenderingClosure closure = { this, NS_OK };
+    cairo_gdk_drawing_result_t result;
+    // Make sure result.surface is null to start with; we rely on it
+    // being non-null meaning that a surface actually got allocated.
+    result.surface = NULL;
+  
+    if (output) {
+        output->mSurface = NULL;
+        output->mUniformAlpha = PR_FALSE;
+        output->mUniformColor = PR_FALSE;
+    }
+
+    int cairoFlags = 0;
+    if (flags & DRAW_SUPPORTS_OFFSET) {
+        cairoFlags |= CAIRO_GDK_DRAWING_SUPPORTS_OFFSET;
+    }
+    if (flags & DRAW_SUPPORTS_CLIP_RECT) {
+        cairoFlags |= CAIRO_GDK_DRAWING_SUPPORTS_CLIP_RECT;
+    }
+    if (flags & DRAW_SUPPORTS_CLIP_LIST) {
+        cairoFlags |= CAIRO_GDK_DRAWING_SUPPORTS_CLIP_LIST;
+    }
+    if (flags & DRAW_SUPPORTS_ALTERNATE_SCREEN) {
+        cairoFlags |= CAIRO_GDK_DRAWING_SUPPORTS_ALTERNATE_SCREEN;
+    }
+    if (flags & DRAW_SUPPORTS_NONDEFAULT_VISUAL) {
+        cairoFlags |= CAIRO_GDK_DRAWING_SUPPORTS_NONDEFAULT_VISUAL;
+    }
+    cairo_draw_with_gdk(ctx->GetCairo(),
+                        gfxPlatformGtk::GetPlatform()->GetGdkDrawable(ctx->OriginalSurface()),
+                        NativeRendering, 
+                        &closure, width, height,
+                        (flags & DRAW_IS_OPAQUE) ? CAIRO_GDK_DRAWING_OPAQUE : CAIRO_GDK_DRAWING_TRANSPARENT,
+                        (cairo_gdk_drawing_support_t)cairoFlags,
+                        output ? &result : NULL);
+    if (NS_FAILED(closure.mRV)) {
+        if (result.surface) {
+            NS_ASSERTION(output, "How did that happen?");
+            cairo_surface_destroy (result.surface);
+        }
+        return closure.mRV;
+    }
+
+    if (output) {
+        if (result.surface) {
+            output->mSurface = gfxASurface::Wrap(result.surface);
+            if (!output->mSurface) {
+                cairo_surface_destroy (result.surface);
+                return NS_ERROR_OUT_OF_MEMORY;
+            }
+        }
+
+        output->mUniformAlpha = result.uniform_alpha;
+        output->mUniformColor = result.uniform_color;
+        output->mColor = gfxRGBA(result.r, result.g, result.b, result.alpha);
+    }
+  
+    return NS_OK;
+}
diff --git a/gfx/thebes/src/gfxOS2Fonts.cpp b/gfx/thebes/src/gfxOS2Fonts.cpp
--- a/gfx/thebes/src/gfxOS2Fonts.cpp
+++ b/gfx/thebes/src/gfxOS2Fonts.cpp
@@ -52,12 +52,12 @@
 
 /**********************************************************************
  * class gfxOS2Font
  **********************************************************************/
 
-gfxOS2Font::gfxOS2Font(const nsAString &aName, const gfxFontStyle *aFontStyle)
-    : gfxFont(aName, aFontStyle),
+gfxOS2Font::gfxOS2Font(gfxOS2FontEntry *aFontEntry, const gfxFontStyle *aFontStyle)
+    : gfxFont(aFontEntry, aFontStyle),
       mFontFace(nsnull), mScaledFont(nsnull),
       mMetrics(nsnull), mAdjustedSize(0),
       mHinting(FC_HINT_MEDIUM), mAntialias(FcTrue)
 {
 #ifdef DEBUG_thebes_2
@@ -229,11 +229,11 @@ const gfxFont::Metrics& gfxOS2Font::GetM
                "  supOff=%f SubOff=%f   strOff=%f strSz=%f\n"
                "  undOff=%f undSz=%f    intLead=%f extLead=%f\n"
                "  emAsc=%f emDesc=%f maxH=%f\n"
                "  maxAsc=%f maxDes=%f maxAdv=%f\n",
                (unsigned)this,
-               NS_LossyConvertUTF16toASCII(mName).get(),
+               NS_LossyConvertUTF16toASCII(GetName()).get(),
                os2 && os2->version != 0xFFFF ? "has OS/2 table" : "no OS/2 table!",
                mMetrics->emHeight, GetStyle()->size, mAdjustedSize,
                mMetrics->maxHeight, mMetrics->xHeight,
                mMetrics->aveCharWidth, mMetrics->spaceWidth,
                mMetrics->superscriptOffset, mMetrics->subscriptOffset,
@@ -275,18 +275,18 @@ cairo_font_face_t *gfxOS2Font::CairoFont
     printf("gfxOS2Font[%#x]::CairoFontFace()\n", (unsigned)this);
 #endif
     if (!mFontFace) {
 #ifdef DEBUG_thebes
         printf("gfxOS2Font[%#x]::CairoFontFace(): create it for %s, %f\n",
-               (unsigned)this, NS_LossyConvertUTF16toASCII(mName).get(), GetStyle()->size);
+               (unsigned)this, NS_LossyConvertUTF16toASCII(GetName()).get(), GetStyle()->size);
 #endif
         FcPattern *fcPattern = FcPatternCreate();
 
         // add (family) name to pattern
         // (the conversion should work, font names don't contain high bit chars)
         FcPatternAddString(fcPattern, FC_FAMILY,
-                           (FcChar8 *)NS_LossyConvertUTF16toASCII(mName).get());
+                           (FcChar8 *)NS_LossyConvertUTF16toASCII(GetName()).get());
 
         // adjust font weight using the offset
         // The requirements outlined in gfxFont.h are difficult to meet without
         // having a table of available font weights, so we map the gfxFont
         // weight to possible FontConfig weights.
@@ -346,18 +346,18 @@ cairo_font_face_t *gfxOS2Font::CairoFont
         FcPatternGetString(fcMatch, FC_FAMILY, 0, &str2);
         FcPatternGetInteger(fcMatch, FC_WEIGHT, 0, &w2);
         FcPatternGetInteger(fcMatch, FC_SLANT, 0, &i2);
         FcPatternGetDouble(fcMatch, FC_PIXEL_SIZE, 0, &s2);
         printf("  input=%s,%d,%d,%f\n  fcPattern=%s,%d,%d,%f\n  fcMatch=%s,%d,%d,%f\n",
-               NS_LossyConvertUTF16toASCII(mName).get(),
+               NS_LossyConvertUTF16toASCII(GetName()).get(),
                GetStyle()->weight, GetStyle()->style, GetStyle()->size,
                (char *)str1, w1, i1, s1,
                (char *)str2, w2, i2, s2);
 #endif
         FcPatternDestroy(fcPattern);
 
-        if (mName == NS_LITERAL_STRING("Workplace Sans") && fcW >= FC_WEIGHT_DEMIBOLD) {
+        if (GetName() == NS_LITERAL_STRING("Workplace Sans") && fcW >= FC_WEIGHT_DEMIBOLD) {
             // if we are dealing with Workplace Sans and want a bold font, we
             // need to artificially embolden it (no bold counterpart yet)
             FcPatternAddBool(fcMatch, FC_EMBOLDEN, FcTrue);
         } else {
             // if we don't embolden, we can possibly switch off antialiasing
@@ -381,11 +381,11 @@ cairo_scaled_font_t *gfxOS2Font::CairoSc
     printf("gfxOS2Font[%#x]::CairoScaledFont()\n", (unsigned)this);
 #endif
     if (!mScaledFont) {
 #ifdef DEBUG_thebes_2
         printf("gfxOS2Font[%#x]::CairoScaledFont(): create it for %s, %f\n",
-               (unsigned)this, NS_LossyConvertUTF16toASCII(mName).get(), GetStyle()->size);
+               (unsigned)this, NS_LossyConvertUTF16toASCII(GetName()).get(), GetStyle()->size);
 #endif
 
         double size = mAdjustedSize ? mAdjustedSize : GetStyle()->size;
         cairo_matrix_t fontMatrix;
         cairo_matrix_init_scale(&fontMatrix, size, size);
@@ -402,16 +402,16 @@ cairo_scaled_font_t *gfxOS2Font::CairoSc
 }
 
 nsString gfxOS2Font::GetUniqueName()
 {
 #ifdef DEBUG_thebes
-    printf("gfxOS2Font::GetUniqueName()=%s\n", (char *)mName.get());
+    printf("gfxOS2Font::GetUniqueName()=%s\n", (char *)GetName().get());
 #endif
-    // gfxFont::mName should already be unique enough
+    // gfxFont::GetName() should already be unique enough
     // Atsui uses that, too, while Win appends size, and properties...
     // doesn't seem to get called at all anyway
-    return mName;
+    return GetName();
 }
 
 PRBool gfxOS2Font::SetupCairoFont(gfxContext *aContext)
 {
 #ifdef DEBUG_thebes_2
@@ -439,11 +439,12 @@ already_AddRefed<gfxOS2Font> gfxOS2Font:
 already_AddRefed<gfxOS2Font> gfxOS2Font::GetOrMakeFont(const nsAString& aName,
                                                        const gfxFontStyle *aStyle)
 {
     nsRefPtr<gfxFont> font = gfxFontCache::GetCache()->Lookup(aName, aStyle);
     if (!font) {
-        font = new gfxOS2Font(aName, aStyle);
+        nsRefPtr<gfxOS2FontEntry> fe = new gfxOS2FontEntry(aName);
+        font = new gfxOS2Font(fe, aStyle);
         if (!font)
             return nsnull;
         gfxFontCache::GetCache()->AddNew(font);
     }
     gfxFont *f = nsnull;
diff --git a/gfx/thebes/src/gfxPangoFonts.cpp b/gfx/thebes/src/gfxPangoFonts.cpp
--- a/gfx/thebes/src/gfxPangoFonts.cpp
+++ b/gfx/thebes/src/gfxPangoFonts.cpp
@@ -486,11 +486,12 @@ static already_AddRefed<gfxPangoFont>
 static already_AddRefed<gfxPangoFont>
 GetOrMakeFont(const nsAString& aName, const gfxFontStyle *aStyle)
 {
     nsRefPtr<gfxFont> font = gfxFontCache::GetCache()->Lookup(aName, aStyle);
     if (!font) {
-        font = new gfxPangoFont(aName, aStyle);
+        nsRefPtr<gfxPangoFontEntry> fe = new gfxPangoFontEntry(aName);
+        font = new gfxPangoFont(fe, aStyle);
         if (!font)
             return nsnull;
         gfxFontCache::GetCache()->AddNew(font);
     }
     gfxFont *f = nsnull;
@@ -550,13 +551,13 @@ gfxPangoFontGroup::Copy(const gfxFontSty
 
 /**
  ** gfxPangoFont
  **/
 
-gfxPangoFont::gfxPangoFont(const nsAString &aName,
+gfxPangoFont::gfxPangoFont(gfxPangoFontEntry *aFontEntry,
                            const gfxFontStyle *aFontStyle)
-    : gfxFont(aName, aFontStyle),
+    : gfxFont(aFontEntry, aFontStyle),
       mPangoFont(nsnull), mCairoFont(nsnull),
       mHasMetrics(PR_FALSE), mAdjustedSize(0)
 {
 }
 
@@ -568,13 +569,13 @@ static GQuark GetFontQuark()
     // g_quark_from_string() instead, which creates a small shutdown leak.
     static GQuark quark = g_quark_from_string("moz-gfxFont");
     return quark;
 }
 
-gfxPangoFont::gfxPangoFont(PangoFont *aPangoFont, const nsAString &aName,
+gfxPangoFont::gfxPangoFont(PangoFont *aPangoFont, gfxPangoFontEntry *aFontEntry,
                            const gfxFontStyle *aFontStyle)
-    : gfxFont(aName, aFontStyle),
+    : gfxFont(aFontEntry, aFontStyle),
       mPangoFont(aPangoFont), mCairoFont(nsnull),
       mHasMetrics(PR_FALSE), mAdjustedSize(aFontStyle->size)
 {
     g_object_ref(mPangoFont);
     g_object_set_qdata(G_OBJECT(mPangoFont), GetFontQuark(), this);
@@ -740,12 +741,12 @@ gfxPangoFont::GetOrMakeFont(PangoFont *a
         gfxFontStyle fontStyle(style, weight, size, langGroup, 0.0,
                                PR_TRUE, PR_FALSE);
 
         // (The PangoFontDescription owns the family string)
         const char *family = pango_font_description_get_family(desc);
-        font = new gfxPangoFont(aPangoFont,
-                                NS_ConvertUTF8toUTF16(family), &fontStyle);
+        nsRefPtr<gfxPangoFontEntry> fe = new gfxPangoFontEntry(NS_ConvertUTF8toUTF16(family));
+        font = new gfxPangoFont(aPangoFont, fe, &fontStyle);
 
         pango_font_description_free(desc);
         if (!font)
             return nsnull;
 
@@ -778,11 +779,11 @@ gfxPangoFont::RealizePangoFont()
     // already realized?
     if (mPangoFont)
         return;
 
     PangoFontDescription *pangoFontDesc =
-        NewPangoFontDescription(mName, GetStyle());
+        NewPangoFontDescription(GetName(), GetStyle());
 
     PangoContext *pangoCtx = gdk_pango_context_get();
 
     if (!GetStyle()->langGroup.IsEmpty()) {
         PangoLanguage *lang = GetPangoLanguage(GetStyle()->langGroup);
@@ -1010,14 +1011,14 @@ gfxPangoFont::GetMetrics()
     }
 
     SanitizeMetrics(&mMetrics, PR_FALSE);
 
 #if 0
-    //    printf("font name: %s %f %f\n", NS_ConvertUTF16toUTF8(mName).get(), GetStyle()->size, mAdjustedSize);
+    //    printf("font name: %s %f %f\n", NS_ConvertUTF16toUTF8(GetName()).get(), GetStyle()->size, mAdjustedSize);
     //    printf ("pango font %s\n", pango_font_description_to_string (pango_font_describe (font)));
 
-    fprintf (stderr, "Font: %s\n", NS_ConvertUTF16toUTF8(mName).get());
+    fprintf (stderr, "Font: %s\n", NS_ConvertUTF16toUTF8(GetName()).get());
     fprintf (stderr, "    emHeight: %f emAscent: %f emDescent: %f\n", mMetrics.emHeight, mMetrics.emAscent, mMetrics.emDescent);
     fprintf (stderr, "    maxAscent: %f maxDescent: %f\n", mMetrics.maxAscent, mMetrics.maxDescent);
     fprintf (stderr, "    internalLeading: %f externalLeading: %f\n", mMetrics.externalLeading, mMetrics.internalLeading);
     fprintf (stderr, "    spaceWidth: %f aveCharWidth: %f xHeight: %f\n", mMetrics.spaceWidth, mMetrics.aveCharWidth, mMetrics.xHeight);
     fprintf (stderr, "    uOff: %f uSize: %f stOff: %f stSize: %f suOff: %f suSize: %f\n", mMetrics.underlineOffset, mMetrics.underlineSize, mMetrics.strikeoutOffset, mMetrics.strikeoutSize, mMetrics.superscriptOffset, mMetrics.subscriptOffset);
diff --git a/gfx/thebes/src/gfxPlatformGtk.cpp b/gfx/thebes/src/gfxPlatformGtk.cpp
--- a/gfx/thebes/src/gfxPlatformGtk.cpp
+++ b/gfx/thebes/src/gfxPlatformGtk.cpp
@@ -34,43 +34,73 @@
  * the provisions above, a recipient may use your version of this file under
  * the terms of any one of the MPL, the GPL or the LGPL.
  *
  * ***** END LICENSE BLOCK ***** */
 
+#ifdef MOZ_PANGO
 #define PANGO_ENABLE_BACKEND
 #define PANGO_ENABLE_ENGINE
+#endif
 
 #include "gfxPlatformGtk.h"
 
 #include "gfxFontconfigUtils.h"
+#ifdef MOZ_PANGO
+#include <pango/pangocairo.h>
 #include "gfxPangoFonts.h"
 #include "gfxContext.h"
+#else
+#include <ft2build.h>
+#include FT_FREETYPE_H
+#include "gfxFT2Fonts.h"
+#endif
 
 #include "cairo.h"
 #include <gtk/gtk.h>
-#include <gdk/gdkx.h>
 
 #include "gfxImageSurface.h"
+#ifdef MOZ_X11
+#include <gdk/gdkx.h>
 #include "gfxXlibSurface.h"
+#endif /* MOZ_X11 */
 
-#include "gfxPangoFonts.h"
-
-#include <pango/pangocairo.h>
+#ifdef MOZ_DFB
+#include "gfxDirectFBSurface.h"
+#endif
 
 #ifdef MOZ_ENABLE_GLITZ
 #include "gfxGlitzSurface.h"
 #include "glitz-glx.h"
+#endif
+
+#ifdef MOZ_DFB
+#include "gfxDirectFBSurface.h"
 #endif
 
 #include <fontconfig/fontconfig.h>
 
 #include "nsMathUtils.h"
 
 #include "lcms.h"
 
+#ifndef MOZ_PANGO
+#include <ft2build.h>
+#include FT_FREETYPE_H
+#endif
+
 PRInt32 gfxPlatformGtk::sDPI = -1;
 gfxFontconfigUtils *gfxPlatformGtk::sFontconfigUtils = nsnull;
+
+static cairo_user_data_key_t cairo_gdk_drawable_key;
+
+#ifndef MOZ_PANGO
+typedef nsDataHashtable<nsStringHashKey, nsRefPtr<FontFamily> > FontTable;
+static FontTable *gPlatformFonts = NULL;
+static FontTable *gPlatformFontAliases = NULL;
+static FT_Library gPlatformFTLibrary = NULL;
+#endif
+
 
 static cairo_user_data_key_t cairo_gdk_pixmap_key;
 static void do_gdk_pixmap_unref (void *data)
 {
     GdkPixmap *pmap = (GdkPixmap*)data;
@@ -84,19 +114,39 @@ gfxPlatformGtk::gfxPlatformGtk()
         glitz_glx_init(NULL);
 #endif
     if (!sFontconfigUtils)
         sFontconfigUtils = gfxFontconfigUtils::GetFontconfigUtils();
 
+#ifndef MOZ_PANGO
+    FT_Init_FreeType(&gPlatformFTLibrary);
+
+    gPlatformFonts = new FontTable();
+    gPlatformFonts->Init(100);
+    gPlatformFontAliases = new FontTable();
+    gPlatformFontAliases->Init(100);
+    UpdateFontList();
+#endif
+
     InitDPI();
 }
 
 gfxPlatformGtk::~gfxPlatformGtk()
 {
     gfxFontconfigUtils::Shutdown();
     sFontconfigUtils = nsnull;
 
+#ifdef MOZ_PANGO
     gfxPangoFont::Shutdown();
+#else
+    delete gPlatformFonts;
+    gPlatformFonts = NULL;
+    delete gPlatformFontAliases;
+    gPlatformFontAliases = NULL;
+
+    FT_Done_FreeType(gPlatformFTLibrary);
+    gPlatformFTLibrary = NULL;
+#endif
 
 #if 0
     // It would be nice to do this (although it might need to be after
     // the cairo shutdown that happens in ~gfxPlatform).  It even looks
     // idempotent.  But it has fatal assertions that fire if stuff is
@@ -109,10 +159,11 @@ gfxPlatformGtk::CreateOffscreenSurface(c
 gfxPlatformGtk::CreateOffscreenSurface(const gfxIntSize& size,
                                        gfxASurface::gfxImageFormat imageFormat)
 {
     nsRefPtr<gfxASurface> newSurface = nsnull;
 
+#ifdef MOZ_X11
     int glitzf;
     int xrenderFormatID;
     switch (imageFormat) {
         case gfxASurface::ImageFormatARGB32:
             glitzf = 0; // GLITZ_STANDARD_ARGB32;
@@ -162,10 +213,11 @@ gfxPlatformGtk::CreateOffscreenSurface(c
                 // set up the surface to auto-unref the gdk pixmap when
                 // the surface is released
                 newSurface->SetData(&cairo_gdk_pixmap_key,
                                     pixmap,
                                     do_gdk_pixmap_unref);
+            SetGdkDrawable(newSurface, GDK_DRAWABLE(pixmap));
             } else {
                 // something went wrong with the surface creation.
                 // Ignore and let's fall back to image surfaces.
                 if (pixmap)
                     gdk_pixmap_unref(pixmap);
@@ -205,19 +257,26 @@ gfxPlatformGtk::CreateOffscreenSurface(c
 
         glitz_surface_attach(gsurf, gdraw, GLITZ_DRAWABLE_BUFFER_FRONT_COLOR);
         newSurface = new gfxGlitzSurface(gdraw, gsurf, PR_TRUE);
 #endif
     }
+#endif
+
+#ifdef MOZ_DFB
+    newSurface = new gfxDirectFBSurface(size, imageFormat);
+#endif
 
     if (newSurface) {
         gfxContext tmpCtx(newSurface);
         tmpCtx.SetOperator(gfxContext::OPERATOR_CLEAR);
         tmpCtx.Paint();
     }
 
     return newSurface.forget();
 }
+
+#ifdef MOZ_PANGO
 
 nsresult
 gfxPlatformGtk::GetFontList(const nsACString& aLangGroup,
                             const nsACString& aGenericFamily,
                             nsStringArray& aListOfFonts)
@@ -253,27 +312,251 @@ gfxPlatformGtk::CreateFontGroup(const ns
                                 const gfxFontStyle *aStyle)
 {
     return new gfxPangoFontGroup(aFamilies, aStyle);
 }
 
+#else
+
+nsresult
+gfxPlatformGtk::GetFontList(const nsACString& aLangGroup,
+                            const nsACString& aGenericFamily,
+                            nsStringArray& aListOfFonts)
+{
+    return sFontconfigUtils->GetFontList(aLangGroup, aGenericFamily,
+                                         aListOfFonts);
+}
+
+nsresult
+gfxPlatformGtk::UpdateFontList()
+{
+    FcPattern *pat = NULL;
+    FcObjectSet *os = NULL;
+    FcFontSet *fs = NULL;
+    PRInt32 result = -1;
+
+    pat = FcPatternCreate();
+    os = FcObjectSetBuild(FC_FAMILY, FC_FILE, FC_INDEX, FC_WEIGHT, FC_SLANT, FC_WIDTH, NULL);
+
+    fs = FcFontList(NULL, pat, os);
+
+
+    for (int i = 0; i < fs->nfont; i++) {
+        char *str;
+
+        if (FcPatternGetString(fs->fonts[i], FC_FAMILY, 0, (FcChar8 **) &str) != FcResultMatch)
+            continue;
+
+        //printf("Family: %s\n", str);
+
+        nsAutoString name(NS_ConvertUTF8toUTF16(nsDependentCString(str)).get());
+        nsAutoString key(name);
+        /* FIXME DFB */
+        //ToLowerCase(key);
+        nsRefPtr<FontFamily> ff;
+        if (!gPlatformFonts->Get(key, &ff)) {
+            ff = new FontFamily(name);
+            gPlatformFonts->Put(key, ff);
+        }
+
+        nsRefPtr<FontEntry> fe = new FontEntry(ff->mName);
+        ff->mFaces.AppendElement(fe);
+
+        if (FcPatternGetString(fs->fonts[i], FC_FILE, 0, (FcChar8 **) &str) == FcResultMatch) {
+            fe->mFilename = nsDependentCString(str);
+            //printf(" - file: %s\n", str);
+        }
+
+        int x;
+        if (FcPatternGetInteger(fs->fonts[i], FC_INDEX, 0, &x) == FcResultMatch) {
+            //printf(" - index: %d\n", x);
+            fe->mFTFontIndex = x;
+        } else {
+            fe->mFTFontIndex = 0;
+        }
+
+        if (FcPatternGetInteger(fs->fonts[i], FC_WEIGHT, 0, &x) == FcResultMatch) {
+            switch(x) {
+            case 0:
+                fe->mWeight = 100;
+                break;
+            case 40:
+                fe->mWeight = 200;
+                break;
+            case 50:
+                fe->mWeight = 300;
+                break;
+            case 75:
+            case 80:
+                fe->mWeight = 400;
+                break;
+            case 100:
+                fe->mWeight = 500;
+                break;
+            case 180:
+                fe->mWeight = 600;
+                break;
+            case 200:
+                fe->mWeight = 700;
+                break;
+            case 205:
+                fe->mWeight = 800;
+                break;
+            case 210:
+                fe->mWeight = 900;
+                break;
+            default:
+                // rough estimate
+                fe->mWeight = (((x * 4) + 100) / 100) * 100;
+                break;
+            }
+            //printf(" - weight: %d\n", fe->mWeight);
+        }
+
+        fe->mItalic = PR_FALSE;
+        if (FcPatternGetInteger(fs->fonts[i], FC_SLANT, 0, &x) == FcResultMatch) {
+            switch (x) {
+            case FC_SLANT_ITALIC:
+            case FC_SLANT_OBLIQUE:
+                fe->mItalic = PR_TRUE;
+            }
+            //printf(" - slant: %d\n", x);
+        }
+
+        //if (FcPatternGetInteger(fs->fonts[i], FC_WIDTH, 0, &x) == FcResultMatch)
+            //printf(" - width: %d\n", x);
+        // XXX deal with font-stretch stuff later
+    }
+
+    if (pat)
+        FcPatternDestroy(pat);
+    if (os)
+        FcObjectSetDestroy(os);
+    if (fs)
+        FcFontSetDestroy(fs);
+
+    return sFontconfigUtils->UpdateFontList();
+}
+
+nsresult
+gfxPlatformGtk::ResolveFontName(const nsAString& aFontName,
+                                FontResolverCallback aCallback,
+                                void *aClosure,
+                                PRBool& aAborted)
+{
+
+    nsAutoString name(aFontName);
+    /* FIXME: DFB */
+    //ToLowerCase(name);
+
+    nsRefPtr<FontFamily> ff;
+    if (gPlatformFonts->Get(name, &ff) ||
+        gPlatformFontAliases->Get(name, &ff)) {
+        aAborted = !(*aCallback)(ff->mName, aClosure);
+        return NS_OK;
+    }
+
+    nsCAutoString utf8Name = NS_ConvertUTF16toUTF8(aFontName);
+
+    FcPattern *npat = FcPatternCreate();
+    FcPatternAddString(npat, FC_FAMILY, (FcChar8*)utf8Name.get());
+    FcObjectSet *nos = FcObjectSetBuild(FC_FAMILY, NULL);
+    FcFontSet *nfs = FcFontList(NULL, npat, nos);
+
+    for (int k = 0; k < nfs->nfont; k++) {
+        FcChar8 *str;
+        if (FcPatternGetString(nfs->fonts[k], FC_FAMILY, 0, (FcChar8 **) &str) != FcResultMatch)
+            continue;
+        nsAutoString altName = NS_ConvertUTF8toUTF16(nsDependentCString(reinterpret_cast<char*>(str)));
+        /* FIXME: DFB */
+        //ToLowerCase(altName);
+        if (gPlatformFonts->Get(altName, &ff)) {
+            //printf("Adding alias: %s -> %s\n", utf8Name.get(), str);
+            gPlatformFontAliases->Put(name, ff);
+            aAborted = !(*aCallback)(NS_ConvertUTF8toUTF16(nsDependentCString(reinterpret_cast<char*>(str))), aClosure);
+            goto DONE;
+        }
+    }
+
+    FcPatternDestroy(npat);
+    FcObjectSetDestroy(nos);
+    FcFontSetDestroy(nfs);
+
+    {
+    npat = FcPatternCreate();
+    FcPatternAddString(npat, FC_FAMILY, (FcChar8*)utf8Name.get());
+    FcPatternDel(npat, FC_LANG);
+    FcConfigSubstitute(NULL, npat, FcMatchPattern);
+    FcDefaultSubstitute(npat);
+
+    nos = FcObjectSetBuild(FC_FAMILY, NULL);
+    nfs = FcFontList(NULL, npat, nos);
+
+    FcResult fresult;
+
+    FcPattern *match = FcFontMatch(NULL, npat, &fresult);
+    if (match)
+        FcFontSetAdd(nfs, match);
+
+    for (int k = 0; k < nfs->nfont; k++) {
+        FcChar8 *str;
+        if (FcPatternGetString(nfs->fonts[k], FC_FAMILY, 0, (FcChar8 **) &str) != FcResultMatch)
+            continue;
+        nsAutoString altName = NS_ConvertUTF8toUTF16(nsDependentCString(reinterpret_cast<char*>(str)));
+        /* FIXME: DFB */
+        //ToLowerCase(altName);
+        if (gPlatformFonts->Get(altName, &ff)) {
+            //printf("Adding alias: %s -> %s\n", utf8Name.get(), str);
+            gPlatformFontAliases->Put(name, ff);
+            aAborted = !(*aCallback)(NS_ConvertUTF8toUTF16(nsDependentCString(reinterpret_cast<char*>(str))), aClosure);
+            goto DONE;
+        }
+    }
+    }
+ DONE:
+    FcPatternDestroy(npat);
+    FcObjectSetDestroy(nos);
+    FcFontSetDestroy(nfs);
+
+    return NS_OK;
+}
+
+nsresult
+gfxPlatformGtk::GetStandardFamilyName(const nsAString& aFontName, nsAString& aFamilyName)
+{
+    return sFontconfigUtils->GetStandardFamilyName(aFontName, aFamilyName);
+}
+
+gfxFontGroup *
+gfxPlatformGtk::CreateFontGroup(const nsAString &aFamilies,
+                               const gfxFontStyle *aStyle)
+{
+    return new gfxFT2FontGroup(aFamilies, aStyle);
+}
+
+#endif
+
+
 /* static */
 void
 gfxPlatformGtk::InitDPI()
 {
+#ifdef MOZ_PANGO
     PangoContext *context = gdk_pango_context_get ();
     sDPI = pango_cairo_context_get_resolution (context);
     g_object_unref (context);
+#endif
 
     if (sDPI <= 0) {
 	// Fall back to something sane
 	sDPI = 96;
     }
 }
 
 cmsHPROFILE
 gfxPlatformGtk::GetPlatformCMSOutputProfile()
 {
+#ifdef MOZ_X11
     const char EDID1_ATOM_NAME[] = "XFree86_DDC_EDID1_RAWDATA";
     const char ICC_PROFILE_ATOM_NAME[] = "_ICC_PROFILE";
 
     Atom edidAtom, iccAtom;
     Display *dpy = GDK_DISPLAY();
@@ -391,7 +674,66 @@ gfxPlatformGtk::GetPlatformCMSOutputProf
 #endif
 
             return profile;
         }
     }
+#endif
+
     return nsnull;
 }
+
+
+#ifndef MOZ_PANGO
+FT_Library
+gfxPlatformGtk::GetFTLibrary()
+{
+    return gPlatformFTLibrary;
+}
+
+FontFamily *
+gfxPlatformGtk::FindFontFamily(const nsAString& aName)
+{
+    nsAutoString name(aName);
+    /* FIXME: DFB */
+    //ToLowerCase(name);
+
+    nsRefPtr<FontFamily> ff;
+    if (!gPlatformFonts->Get(name, &ff)) {
+        return nsnull;
+    }
+    return ff.get();
+}
+
+FontEntry *
+gfxPlatformGtk::FindFontEntry(const nsAString& aName, const gfxFontStyle& aFontStyle)
+{
+    nsRefPtr<FontFamily> ff = FindFontFamily(aName);
+    if (!ff)
+        return nsnull;
+
+    return ff->FindFontEntry(aFontStyle);
+}
+#endif
+
+
+void
+gfxPlatformGtk::SetGdkDrawable(gfxASurface *target,
+                               GdkDrawable *drawable)
+{
+    if (target->CairoStatus())
+        return;
+
+    cairo_surface_set_user_data (target->CairoSurface(),
+                                 &cairo_gdk_drawable_key,
+                                 drawable,
+                                 NULL);
+}
+
+GdkDrawable *
+gfxPlatformGtk::GetGdkDrawable(gfxASurface *target)
+{
+    if (target->CairoStatus())
+        return nsnull;
+
+    return (GdkDrawable*) cairo_surface_get_user_data (target->CairoSurface(),
+                                                       &cairo_gdk_drawable_key);
+}
diff --git a/gfx/thebes/src/gfxQuartzFontCache.h b/gfx/thebes/src/gfxQuartzFontCache.h
--- a/gfx/thebes/src/gfxQuartzFontCache.h
+++ b/gfx/thebes/src/gfxQuartzFontCache.h
@@ -52,83 +52,66 @@
 #include "nsUnicharUtils.h"
 #include "nsVoidArray.h"
 
 // used when picking fallback font
 struct FontSearch {
-    FontSearch(const PRUint32 aCharacter, gfxAtsuiFont *aFont) :
+    FontSearch(const PRUint32 aCharacter, gfxFont *aFont) :
         ch(aCharacter), fontToMatch(aFont), matchRank(0) {
     }
     const PRUint32 ch;
-    gfxAtsuiFont *fontToMatch;
+    gfxFont *fontToMatch;
     PRInt32 matchRank;
     nsRefPtr<MacOSFontEntry> bestMatch;
 };
 
 class MacOSFamilyEntry;
 class gfxQuartzFontCache;
 
 // a single member of a font family (i.e. a single face, such as Times Italic)
-class MacOSFontEntry
+class MacOSFontEntry : public gfxFontEntry
 {
 public:
-    THEBES_INLINE_DECL_REFCOUNTING(MacOSFontEntry)
-
     friend class gfxQuartzFontCache;
 
     // initialize with Apple-type weight [1..14]
     MacOSFontEntry(const nsAString& aPostscriptName, PRInt32 aAppleWeight, PRUint32 aTraits, 
                     MacOSFamilyEntry *aFamily);
 
-    const nsString& Name() { return mPostscriptName; }
     const nsString& FamilyName();
-    PRInt32 Weight() { return mWeight; }
+
     PRUint32 Traits() { return mTraits; }
     
-    PRBool IsFixedPitch();
-    PRBool IsItalicStyle();
-    PRBool IsBold();
-
     ATSUFontID GetFontID();
     nsresult ReadCMAP();
-    inline PRBool TestCharacterMap(PRUint32 aCh) {
-        if ( !mCmapInitialized ) ReadCMAP();
-        return mCharacterMap.test(aCh);
-    }
 
     MacOSFamilyEntry* FamilyEntry() { return mFamily; }
 protected:
-    nsString mPostscriptName;
-    PRInt32 mWeight; // CSS-type value: [1..9] which map to 100, 200, ..., 900
     PRUint32 mTraits;
     MacOSFamilyEntry *mFamily;
 
+    PRPackedBool mATSUIDInitialized;
     ATSUFontID mATSUFontID;
-    gfxSparseBitSet mCharacterMap;
-    
-    PRPackedBool mCmapInitialized;
-    PRPackedBool mATSUIDInitialized;
 };
 
 // helper class for adding other family names back into font cache
 class AddOtherFamilyNameFunctor;
 
 // a single font family, referencing one or more faces 
-class MacOSFamilyEntry
+class MacOSFamilyEntry : public gfxFontFamily
 {
 public:
-    THEBES_INLINE_DECL_REFCOUNTING(MacOSFamilyEntry)
 
     friend class gfxQuartzFontCache;
 
+    // name is canonical font family name returned from NSFontManager
     MacOSFamilyEntry(nsString &aName) :
-        mName(aName), mOtherFamilyNamesInitialized(PR_FALSE), mHasOtherFamilyNames(PR_FALSE),
+        gfxFontFamily(aName), mOtherFamilyNamesInitialized(PR_FALSE), mHasOtherFamilyNames(PR_FALSE),
         mIsBadUnderlineFontFamily(PR_FALSE)
     {}
   
     virtual ~MacOSFamilyEntry() {}
         
-    const nsString& Name() { return mName; }
     virtual void LocalizedName(nsAString& aLocalizedName);
     virtual PRBool HasOtherFamilyNames();
     
     nsTArray<nsRefPtr<MacOSFontEntry> >& GetFontList() { return mAvailableFonts; }
     
@@ -165,17 +148,15 @@ protected:
 protected:
     
     // add font entries into array that match specified traits, returned in array listed by weight
     // i.e. aFontsForWeights[4] ==> pointer to the font entry for a 400-weight face on return
     // returns true if one or more faces found
-    PRBool FindFontsWithTraits(MacOSFontEntry* aFontsForWeights[], PRUint32 aPosTraitsMask, 
+    PRBool FindFontsWithTraits(gfxFontEntry* aFontsForWeights[], PRUint32 aPosTraitsMask, 
                                 PRUint32 aNegTraitsMask);
 
-    // choose font based on CSS font-weight selection rules, never null
-    MacOSFontEntry* FindFontWeight(MacOSFontEntry* aFontsForWeights[], const gfxFontStyle* aStyle, PRBool& aNeedsBold);
-    
-    nsString mName;  // canonical font family name returned from NSFontManager
+    PRBool FindWeightsForStyle(gfxFontEntry* aFontsForWeights[], const gfxFontStyle& aFontStyle);
+
     nsTArray<nsRefPtr<MacOSFontEntry> >  mAvailableFonts;
     PRPackedBool mOtherFamilyNamesInitialized;
     PRPackedBool mHasOtherFamilyNames;
     PRPackedBool mIsBadUnderlineFontFamily;
 };
@@ -224,11 +205,11 @@ public:
     PRBool GetStandardFamilyName(const nsAString& aFontName, nsAString& aFamilyName);
     void UpdateFontList() { InitFontList(); }
 
     void GetFontFamilyList(nsTArray<nsRefPtr<MacOSFamilyEntry> >& aFamilyArray);
 
-    MacOSFontEntry* FindFontForChar(const PRUint32 aCh, gfxAtsuiFont *aPrevFont);
+    MacOSFontEntry* FindFontForChar(const PRUint32 aCh, gfxFont *aPrevFont);
 
     MacOSFamilyEntry* FindFamily(const nsAString& aFamily);
     
     MacOSFontEntry* FindFontForFamily(const nsAString& aFamily, const gfxFontStyle* aStyle, PRBool& aNeedsBold);
     
diff --git a/gfx/thebes/src/gfxQuartzFontCache.mm b/gfx/thebes/src/gfxQuartzFontCache.mm
--- a/gfx/thebes/src/gfxQuartzFontCache.mm
+++ b/gfx/thebes/src/gfxQuartzFontCache.mm
@@ -108,39 +108,30 @@ gfxQuartzFontCache::GenerateFontListKey(
 /* MacOSFontEntry */
 #pragma mark-
 
 MacOSFontEntry::MacOSFontEntry(const nsAString& aPostscriptName, 
                                 PRInt32 aAppleWeight, PRUint32 aTraits, MacOSFamilyEntry *aFamily)
-    : mPostscriptName(aPostscriptName), mTraits(aTraits), mFamily(aFamily), mATSUFontID(0),
-        mCmapInitialized(0), mATSUIDInitialized(0)
+    : gfxFontEntry(aPostscriptName), mTraits(aTraits), mFamily(aFamily), mATSUFontID(0),
+        mATSUIDInitialized(0)
 {
     mWeight = gfxQuartzFontCache::AppleWeightToCSSWeight(aAppleWeight);
+
+    mItalic = (mTraits & NSItalicFontMask ? 1 : 0);
+    mFixedPitch = (mTraits & NSFixedPitchFontMask ? 1 : 0);
 }
 
 const nsString& 
 MacOSFontEntry::FamilyName()
 {
     return mFamily->Name();
 }
 
-PRBool MacOSFontEntry::IsFixedPitch() {
-    return mTraits & NSFixedPitchFontMask;
-}
-
-PRBool MacOSFontEntry::IsItalicStyle() {
-    return mTraits & NSItalicFontMask;
-}
-
-PRBool MacOSFontEntry::IsBold() {
-    return mTraits & NSBoldFontMask;
-}
-
 ATSUFontID MacOSFontEntry::GetFontID() 
 {
     if (!mATSUIDInitialized) {
         mATSUIDInitialized = PR_TRUE;
-        NSString *psname = GetNSStringForString(mPostscriptName);
+        NSString *psname = GetNSStringForString(mName);
         NSFont *font = [NSFont fontWithName:psname size:0.0];
         if (font) mATSUFontID = [font _atsFontID];
     }
     return mATSUFontID; 
 }
@@ -198,13 +189,13 @@ MacOSFontEntry::ReadCMAP()
     PRPackedBool  unicodeFont, symbolFont; // currently ignored
     rv = gfxFontUtils::ReadCMAP(cmap, size, mCharacterMap, unicodeFont, symbolFont);
 
     // for complex scripts, check for the presence of mort/morx
     PRBool checkedForMorphTable = PR_FALSE, hasMorphTable = PR_FALSE;
-    
+
     PRUint32 s, numScripts = sizeof(gScriptsThatRequireShaping) / sizeof(ScriptRange);
-    
+
     for (s = 0; s < numScripts; s++) {
         eComplexScript  whichScript = gScriptsThatRequireShaping[s].script;
         
         // check to see if the cmap includes complex script codepoints
         if (mCharacterMap.TestRange(gScriptsThatRequireShaping[s].rangeStart, gScriptsThatRequireShaping[s].rangeEnd)) {
@@ -226,11 +217,11 @@ MacOSFontEntry::ReadCMAP()
             }
             
             // rude hack - the Chinese STxxx fonts on 10.4 contain morx tables and Arabic glyphs but 
             // lack the proper info for shaping Arabic, so exclude explicitly, ick
             if (whichScript == eComplexScriptArabic && hasMorphTable) {
-                if (mPostscriptName.CharAt(0) == 'S' && mPostscriptName.CharAt(1) == 'T') {
+                if (mName.CharAt(0) == 'S' && mName.CharAt(1) == 'T') {
                     mCharacterMap.ClearRange(gScriptsThatRequireShaping[s].rangeStart, gScriptsThatRequireShaping[s].rangeEnd);
                 }
             }
 
             // general exclusion - if no morph table, exclude codepoints
@@ -239,11 +230,11 @@ MacOSFontEntry::ReadCMAP()
             }
         }
     }
 
     PR_LOG(gFontInfoLog, PR_LOG_DEBUG, ("(fontinit-cmap) psname: %s, size: %d\n", 
-                                        NS_ConvertUTF16toUTF8(mPostscriptName).get(), mCharacterMap.GetSize()));
+                                        NS_ConvertUTF16toUTF8(mName).get(), mCharacterMap.GetSize()));
                                         
     return rv;
 }
 
 
@@ -270,17 +261,17 @@ void MacOSFamilyEntry::LocalizedName(nsA
     // no other names ==> only one name, just return it
     if (!HasOtherFamilyNames()) {
         aLocalizedName = mName;
         return;
     }
-    
+
     NSFontManager *fontManager = [NSFontManager sharedFontManager];
-    
+
     // dig out the localized family name
     NSString *family = GetNSStringForString(mName);
     NSString *localizedFamily = [fontManager localizedNameForFamily:family face:nil];
-    
+
     if (localizedFamily) {
         GetStringForNSString(localizedFamily, aLocalizedName);
     } else {
         // failed to get a localized name, just use the canonical name
         aLocalizedName = mName;
@@ -301,60 +292,11 @@ static const PRUint32 kTraits_NonNormalW
                             NSCondensedFontMask | NSCompressedFontMask | NSFixedPitchFontMask;
 
 MacOSFontEntry*
 MacOSFamilyEntry::FindFont(const gfxFontStyle* aStyle, PRBool& aNeedsBold)
 {
-    aNeedsBold = PR_FALSE;
-    
-    // short-circuit the single face per family case
-    if (mAvailableFonts.Length() == 1) {
-        PRInt8 baseWeight, weightDistance;
-        aStyle->ComputeWeightAndOffset(&baseWeight, &weightDistance);
-        // for fonts with a single face, any weight distance implies synthetic bolding needed
-        aNeedsBold = (weightDistance > 0);
-        return mAvailableFonts[0];
-    }
-    
-    PRBool found = PR_FALSE;
-    PRBool isItalic = (aStyle->style == FONT_STYLE_ITALIC || aStyle->style == FONT_STYLE_OBLIQUE);
-    MacOSFontEntry* fontsWithTraits[10];
-    
-    memset(fontsWithTraits, 0, sizeof(fontsWithTraits));
-    
-    // match italic faces
-    if (isItalic) {    
-        // first search for italic normal width fonts
-        found = FindFontsWithTraits(fontsWithTraits, NSItalicFontMask, kTraits_NonNormalWidthMask);
-        
-        // if not found, italic any width ones
-        if (!found) {
-            found = FindFontsWithTraits(fontsWithTraits, NSItalicFontMask, 0);        
-        }
-    }
-    
-    // match non-italic faces, if no italic faces fall through here
-    if (!found) {
-        // look for normal width fonts
-        found = FindFontsWithTraits(fontsWithTraits, NSUnitalicFontMask, kTraits_NonNormalWidthMask);
-        
-        // if not found, any face will do
-        if (!found) {
-            found = FindFontsWithTraits(fontsWithTraits, NSUnitalicFontMask, 0);        
-        } 
-    }
-    
-    // still not found?!? family must only contain italic fonts when looking for a normal 
-    // face, just use the whole list
-    if (!found) {
-        found = FindFontsWithTraits(fontsWithTraits, 0, 0);
-    }
-    NS_ASSERTION(found, "Font family containing no faces");
-    if (!found) return nsnull;
-    
-    MacOSFontEntry* chosenFont = FindFontWeight(fontsWithTraits, aStyle, aNeedsBold);
-    NS_ASSERTION(chosenFont, "Somehow selected a null font entry when choosing based on font weight");
-    return chosenFont;
+    return static_cast<MacOSFontEntry*> (FindFontForStyle(*aStyle, aNeedsBold));
 }
 
 MacOSFontEntry*
 MacOSFamilyEntry::FindFont(const nsString& aPostscriptName)
 {
@@ -372,56 +314,56 @@ MacOSFamilyEntry::FindFontForChar(FontSe
 MacOSFamilyEntry::FindFontForChar(FontSearch *aMatchData)
 {
     // xxx - optimization point - keep a bit vector with the union of supported unicode ranges
     // by all fonts for this family and bail immediately if the character is not in any of
     // this family's cmaps
-    
+
     // iterate over fonts
     PRUint32 numFonts = mAvailableFonts.Length();
     for (PRUint32 i = 0; i < numFonts; i++) {
         MacOSFontEntry *fe = mAvailableFonts[i];
         PRInt32 rank = 0;
-    
+
         if (fe->TestCharacterMap(aMatchData->ch)) {
             rank += 20;
         }
-    
+
         // if we didn't match any characters don't bother wasting more time with this face.
         if (rank == 0)
             continue;
             
         // omitting from original windows code -- family name, lang group, pitch
         // not available in current FontEntry implementation
-    
+
         if (aMatchData->fontToMatch) { 
             const gfxFontStyle *style = aMatchData->fontToMatch->GetStyle();
             
             // italics
-            if (fe->IsItalicStyle() && 
+            if (fe->IsItalic() && 
                     (style->style == FONT_STYLE_ITALIC || style->style == FONT_STYLE_ITALIC)) {
                 rank += 5;
             }
             
             // weight
             PRInt8 baseWeight, weightDistance;
             style->ComputeWeightAndOffset(&baseWeight, &weightDistance);
-    
+
             // xxx - not entirely correct, the one unit of weight distance reflects 
             // the "next bolder/lighter face"
             PRUint32 targetWeight = (baseWeight * 100) + (weightDistance * 100);
-    
+
             PRUint32 entryWeight = fe->Weight() * 100;
             if (entryWeight == targetWeight) {
                 rank += 5;
             } else {
                 PRUint32 diffWeight = abs(entryWeight - targetWeight);
                 if (diffWeight <= 100)  // favor faces close in weight
                     rank += 2;
             }
         } else {
             // if no font to match, prefer non-bold, non-italic fonts
-            if (!fe->IsItalicStyle() && !fe->IsBold())
+            if (!fe->IsItalic() && !fe->IsBold())
                 rank += 5;
         }
         
         // xxx - add whether AAT font with morphing info for specific lang groups
         
@@ -429,20 +371,20 @@ MacOSFamilyEntry::FindFontForChar(FontSe
             || (rank == aMatchData->matchRank && Compare(fe->Name(), aMatchData->bestMatch->Name()) > 0)) 
         {
             aMatchData->bestMatch = fe;
             aMatchData->matchRank = rank;
         }
-    
+
     }
 }
 
 PRBool
-MacOSFamilyEntry::FindFontsWithTraits(MacOSFontEntry* aFontsForWeights[], PRUint32 aPosTraitsMask, 
+MacOSFamilyEntry::FindFontsWithTraits(gfxFontEntry* aFontsForWeights[], PRUint32 aPosTraitsMask, 
                                         PRUint32 aNegTraitsMask)
 {
     PRBool found = PR_FALSE;
-    
+
     // iterate over fonts
     PRUint32 numFonts = mAvailableFonts.Length();
     for (PRUint32 i = 0; i < numFonts; i++) {
         MacOSFontEntry *fe = mAvailableFonts[i];
         
@@ -462,97 +404,61 @@ MacOSFamilyEntry::FindFontsWithTraits(Ma
         }
     }
     return found;
 }
 
-MacOSFontEntry* 
-MacOSFamilyEntry::FindFontWeight(MacOSFontEntry* aFontsForWeights[], const gfxFontStyle* aStyle, PRBool& aNeedsBold)
+PRBool 
+MacOSFamilyEntry::FindWeightsForStyle(gfxFontEntry* aFontsForWeights[], const gfxFontStyle& aFontStyle)
 {
-    // calculate the desired weight from the style
-    PRInt32 w, direction, offset, baseMatch;
-    PRInt8 baseWeight, weightDistance;
+    // short-circuit the single face per family case
+    if (mAvailableFonts.Length() == 1) {
+        MacOSFontEntry *fe = mAvailableFonts[0];
+        PRUint32 weight = fe->Weight();
+        aFontsForWeights[weight] = fe;
+        return PR_TRUE;
+    }
 
-    aNeedsBold = PR_FALSE;
-    
-    aStyle->ComputeWeightAndOffset(&baseWeight, &weightDistance);
-    NS_ASSERTION(baseWeight != 0, "Style with font weight 0 (whacked)");
-    
-    // choose the weight that matches the base weight using CSS Fonts spec rules
-    
-    // have the desired weight ==> use it
-    baseMatch = 0;
-    if (aFontsForWeights[baseWeight]) {
-    
-        baseMatch = baseWeight;
+    PRBool found = PR_FALSE;
+    PRBool isItalic = (aFontStyle.style == FONT_STYLE_ITALIC || aFontStyle.style == FONT_STYLE_OBLIQUE);
+
+    // match italic faces
+    if (isItalic) {    
+        // first search for italic normal width fonts
+        found = FindFontsWithTraits(aFontsForWeights, NSItalicFontMask, kTraits_NonNormalWidthMask);
         
-    } else {
-    
-        // CSS2.1 and draft CSS3 Fonts specs are ambiguous about how to handle missing 400 weight face
-        // substitute 400 and 500 for each other (example: Futura family that ships with Mac OS X)
-        if (baseWeight == 4 && aFontsForWeights[5]) {
-            baseMatch = 5;
-        } else {
-        
-            // otherwise, use explicit CSS rules
-            // weights above 500 ==> look up in weights, then down, otherwise look down, then up
-            direction = (baseWeight > 5 ? 1 : -1);
-            
-            // search in one direction
-            for (w = baseWeight + direction; w >= 1 && w <= 9; w += direction) {
-                if (aFontsForWeights[w]) {
-                    baseMatch = w;
-                    break;
-                }
-            }
-            
-            // not found? switch direction and search the remaining entries
-            if (!baseMatch) {
-                direction = -direction;
-                for (w = baseWeight + direction; w >= 1 && w <= 9; w += direction) {
-                    if (aFontsForWeights[w]) {
-                        baseMatch = w;
-                        break;
-                    }
-                }
-            }
+        // if not found, italic any width ones
+        if (!found) {
+            found = FindFontsWithTraits(aFontsForWeights, NSItalicFontMask, 0);        
         }
     }
-    
-    // at this point, should have found an entry matching the base weight
-    NS_ASSERTION(baseMatch, "Somehow didn't find matching weight");
-                
-    // handle weight offsets
-    if (weightDistance) {
-        direction = (weightDistance < 0 ? -1 : 1);
-        offset = abs(weightDistance);
+
+    // match non-italic faces, if no italic faces fall through here
+    if (!found) {
+        // look for normal width fonts
+        found = FindFontsWithTraits(aFontsForWeights, NSUnitalicFontMask, kTraits_NonNormalWidthMask);
         
-        // look for bolder/lighter face [offset] number of faces away from the base face
-        // e.g. weight = 698 with Helvetica Neue ==> offset = 2, direction = -1, 
-        //      baseMatch starts at 7 (Bold), then 4 (Regular), then 2 (Light)
-        for (w = baseMatch + direction; w >= 1 && w <= 9 && offset; w += direction) {
-            if (aFontsForWeights[w]) {
-                baseMatch = w;
-                offset--;
-            }
-        }
-        
-        // didn't find a face bold enough? flag this for the synthetic bolding case
-        if (direction == 1 && offset) {
-            aNeedsBold = PR_TRUE;
-        }
+        // if not found, any face will do
+        if (!found) {
+            found = FindFontsWithTraits(aFontsForWeights, NSUnitalicFontMask, 0);        
+        } 
+    }
 
+    // still not found?!? family must only contain italic fonts when looking for a normal 
+    // face, just use the whole list
+    if (!found) {
+        found = FindFontsWithTraits(aFontsForWeights, 0, 0);
     }
-    
-    NS_ASSERTION(aFontsForWeights[baseMatch], "Chose a weight without a corresponding face");
-    return aFontsForWeights[baseMatch];
+    NS_ASSERTION(found, "Font family containing no faces");
+
+    return found;
 }
 
 static NSString* CreateNameFromBuffer(const UInt8 *aBuf, ByteCount aLength, 
         FontPlatformCode aPlatformCode, FontScriptCode aScriptCode, FontLanguageCode aLangCode)
 {
     CFStringRef outName = NULL;
-    
+
     if (aPlatformCode == kFontMacintoshPlatform) {
         TextEncoding encoding;
         OSStatus err = GetTextEncodingFromScriptInfo(aScriptCode, aLangCode, 
                                                         kTextRegionDontCare, &encoding);
         if (err) {
@@ -659,11 +565,11 @@ MacOSFamilyEntry::ReadOtherFamilyNames(A
 
     // read in other family names for the first face in the list
     MacOSFontEntry *fe = mAvailableFonts[0];
 
     mHasOtherFamilyNames = ReadOtherFamilyNamesForFace(aOtherFamilyFunctor, this, familyName, fe->GetFontID());
-    
+
     // read in other names for the first face in the list with the assumption
     // that if extra names don't exist in that face then they don't exist in
     // other faces for the same font
     if (mHasOtherFamilyNames) {
         PRUint32 numFonts, i;
@@ -682,20 +588,20 @@ MacOSFamilyEntry::ReadOtherFamilyNames(A
 #pragma mark-
 
 void SingleFaceFamily::LocalizedName(nsAString& aLocalizedName)
 {
     MacOSFontEntry *fontEntry;
-    
+
     // use the display name of the single face
     fontEntry = mAvailableFonts[0];
     if (!fontEntry) 
         return;
         
     NSFont *font = [NSFont fontWithName:GetNSStringForString(fontEntry->Name()) size:0.0];
     if (!font)
         return;
-    
+
     NSString *fullname = [font displayName];
     if (fullname) {
         GetStringForNSString(fullname, aLocalizedName);
     }
 }
@@ -725,22 +631,22 @@ gfxQuartzFontCache::gfxQuartzFontCache()
 {
     mFontFamilies.Init(100);
     mOtherFamilyNames.Init(30);
     mOtherFamilyNamesInitialized = PR_FALSE;
     mPrefFonts.Init(10);
-    
+
     InitFontList();
     ::ATSFontNotificationSubscribe(ATSNotification,
                                    kATSFontNotifyOptionDefault,
                                    (void*)this, nsnull);
 
     // pref changes notification setup
     nsCOMPtr<nsIPref> pref = do_GetService(NS_PREF_CONTRACTID);
     pref->RegisterCallback("font.", PrefChangedCallback, this);
     pref->RegisterCallback("font.name-list.", PrefChangedCallback, this);
     pref->RegisterCallback("intl.accept_languages", PrefChangedCallback, this);  // hmmmm...
-    
+
 }
 
 const PRUint32 kNonNormalTraits = NSItalicFontMask | NSBoldFontMask | NSNarrowFontMask | NSExpandedFontMask | NSCondensedFontMask | NSCompressedFontMask;
 
 void
@@ -754,11 +660,11 @@ gfxQuartzFontCache::InitFontList()
     CancelLoader();
 
     // iterate over available families
     NSFontManager *fontManager = [NSFontManager sharedFontManager];
     NSEnumerator *families = [[fontManager availableFontFamilies] objectEnumerator];  // returns "canonical", non-localized family name
-    
+
     nsAutoString availableFamilyName, postscriptFontName;
    
     NSString *availableFamily = nil;
     while ((availableFamily = [families nextObject])) {
 
@@ -802,18 +708,18 @@ gfxQuartzFontCache::InitFontList()
         
         // add the family entry to the hash table
         ToLowerCase(availableFamilyName);
         mFontFamilies.Put(availableFamilyName, familyEntry);
     }
-    
+
     InitSingleFaceList();
-    
+
     // to avoid full search of font name tables, seed the other names table with localized names from 
     // some of the prefs fonts which are accessed via their localized names.  changes in the pref fonts will only cause
     // a font lookup miss earlier. this is a simple optimization, it's not required for correctness
     PreloadNamesList();
-    
+
     // clean up various minor 10.4 font problems for specific fonts
     if (gfxPlatformMac::GetPlatform()->OSXVersion() < MAC_OS_X_VERSION_10_5_HEX) {
         // Cocoa calls report that italic faces exist for Courier and Helvetica,
         // even though only bold faces exist so test for this using ATSUI id's (10.5 has proper faces)
         EliminateDuplicateFaces(NS_LITERAL_STRING("Courier"));
@@ -822,11 +728,11 @@ gfxQuartzFontCache::InitFontList()
         // Cocoa reports that Courier and Monaco are not fixed-pitch fonts
         // so explicitly tweak these settings
         SetFixedPitch(NS_LITERAL_STRING("Courier"));
         SetFixedPitch(NS_LITERAL_STRING("Monaco"));
     }
-    
+
     // initialize ranges of characters for which system-wide font search should be skipped
     mCodepointsWithNoFonts.SetRange(0,0x1f);     // C0 controls
     mCodepointsWithNoFonts.SetRange(0x7f,0x9f);  // C1 controls
 
     InitBadUnderlineList();
@@ -838,11 +744,11 @@ gfxQuartzFontCache::InitFontList()
 
 void 
 gfxQuartzFontCache::InitOtherFamilyNames()
 {
     mOtherFamilyNamesInitialized = PR_TRUE;
-    
+
     // iterate over all font families and read in other family names
     mFontFamilies.Enumerate(gfxQuartzFontCache::InitOtherFamilyNamesProc, this);
 }
                                                          
 PLDHashOperator PR_CALLBACK gfxQuartzFontCache::InitOtherFamilyNamesProc(nsStringHashKey::KeyType aKey,
@@ -852,16 +758,16 @@ PLDHashOperator PR_CALLBACK gfxQuartzFon
     gfxQuartzFontCache *fc = (gfxQuartzFontCache*) userArg;
     AddOtherFamilyNameFunctor addOtherNames(fc);
     aFamilyEntry->ReadOtherFamilyNames(addOtherNames);
     return PL_DHASH_NEXT;
 }
-    
+
 void
 gfxQuartzFontCache::ReadOtherFamilyNamesForFamily(const nsAString& aFamilyName)
 {
     MacOSFamilyEntry *familyEntry = FindFamily(aFamilyName);
-    
+
     if (familyEntry) {
         AddOtherFamilyNameFunctor addOtherNames(this);
         familyEntry->ReadOtherFamilyNames(addOtherNames);
     }
 }
@@ -869,11 +775,11 @@ void
 void
 gfxQuartzFontCache::InitSingleFaceList()
 {
     nsAutoTArray<nsString, 10> singleFaceFonts;
     gfxFontUtils::GetPrefsFontList("font.single-face-list", singleFaceFonts);
-    
+
     PRUint32 numFonts = singleFaceFonts.Length();
     for (PRUint32 i = 0; i < numFonts; i++) {
         nsAutoString availableFamilyName;
 
         // lookup the font using NSFont    
@@ -914,11 +820,11 @@ void
 void
 gfxQuartzFontCache::PreloadNamesList()
 {
     nsAutoTArray<nsString, 10> preloadFonts;
     gfxFontUtils::GetPrefsFontList("font.preload-names-list", preloadFonts);
-    
+
     PRUint32 numFonts = preloadFonts.Length();
     for (PRUint32 i = 0; i < numFonts; i++) {
         PRBool found;
         nsAutoString key;
         GenerateFontListKey(preloadFonts[i], key);
@@ -1099,11 +1005,11 @@ MacOSFontEntry*
 MacOSFontEntry*
 gfxQuartzFontCache::GetDefaultFont(const gfxFontStyle* aStyle, PRBool& aNeedsBold)
 {
     NSString *defaultFamily = [[NSFont userFontOfSize:aStyle->size] familyName];
     nsAutoString familyName;
-    
+
     GetStringForNSString(defaultFamily, familyName);
     return FindFontForFamily(familyName, aStyle, aNeedsBold);
 }
 
 struct FontListData {
@@ -1166,17 +1072,17 @@ gfxQuartzFontCache::GetFontFamilyList(ns
     FontFamilyListData data(aFamilyArray);
     mFontFamilies.Enumerate(FontFamilyListData::AppendFamily, &data);
 }
 
 MacOSFontEntry*  
-gfxQuartzFontCache::FindFontForChar(const PRUint32 aCh, gfxAtsuiFont *aPrevFont)
+gfxQuartzFontCache::FindFontForChar(const PRUint32 aCh, gfxFont *aPrevFont)
 {
     // is codepoint with no matching font? return null immediately
     if (mCodepointsWithNoFonts.test(aCh)) {
         return nsnull;
     }
-    
+
     // short-circuit system font fallback for U+FFFD, used to represent encoding errors
     // just use Lucida Grande (system font, guaranteed to be around)
     // this helps speed up pages with lots of encoding errors, binary-as-text, etc.
     if (aCh == 0xFFFD) {
         MacOSFontEntry* fontEntry;
@@ -1242,21 +1148,21 @@ gfxQuartzFontCache::FindFamily(const nsA
         InitOtherFamilyNames();
         if ((familyEntry = mOtherFamilyNames.GetWeak(key, &found))) {
             return familyEntry;
         }
     }
-    
+
     return nsnull;
 }
-    
+
 MacOSFontEntry*
 gfxQuartzFontCache::FindFontForFamily(const nsAString& aFamily, const gfxFontStyle* aStyle, PRBool& aNeedsBold)
 {
     MacOSFamilyEntry *familyEntry = FindFamily(aFamily);
 
     aNeedsBold = PR_FALSE;
-    
+
     if (familyEntry)
         return familyEntry->FindFont(aStyle, aNeedsBold);
 
     return nsnull;
 }
diff --git a/gfx/thebes/src/gfxWindowsFonts.cpp b/gfx/thebes/src/gfxWindowsFonts.cpp
--- a/gfx/thebes/src/gfxWindowsFonts.cpp
+++ b/gfx/thebes/src/gfxWindowsFonts.cpp
@@ -20,10 +20,11 @@
  *
  * Contributor(s):
  *   Stuart Parmenter <stuart@mozilla.com>
  *   Masayuki Nakano <masayuki@d-toybox.com>
  *   Mats Palmgren <mats.palmgren@bredband.net>
+ *   John Daggett <jdaggett@mozilla.com>
  *
  * Alternatively, the contents of this file may be used under the terms of
  * either the GNU General Public License Version 2 or later (the "GPL"), or
  * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
  * in which case the provisions of the GPL or the LGPL are applicable instead
@@ -362,93 +363,106 @@ FontFamily::FindStyleVariations()
 
 
 FontEntry *
 FontFamily::FindFontEntry(const gfxFontStyle& aFontStyle)
 {
+    PRBool needsBold;
+    return static_cast<FontEntry*> (FindFontForStyle(aFontStyle, needsBold));
+}
+
+PRBool
+FontFamily::FindWeightsForStyle(gfxFontEntry* aFontsForWeights[], const gfxFontStyle& aFontStyle)
+{
     if (!mHasStyles)
         FindStyleVariations();
 
-    PRUint8 bestMatch = 0;
     PRBool italic = (aFontStyle.style & (FONT_STYLE_ITALIC | FONT_STYLE_OBLIQUE)) != 0;
+    PRBool matchesSomething;
 
-    FontEntry *weightList[10] = { 0 };
     for (PRUint32 j = 0; j < 2; j++) {
-        PRBool matchesSomething = PR_FALSE;
+        matchesSomething = PR_FALSE;
         // build up an array of weights that match the italicness we're looking for
         for (PRUint32 i = 0; i < mVariations.Length(); i++) {
             FontEntry *fe = mVariations[i];
             const PRUint8 weight = (fe->mWeight / 100);
             if (fe->mItalic == italic) {
-                weightList[weight] = fe;
+                aFontsForWeights[weight] = fe;
                 matchesSomething = PR_TRUE;
             }
         }
         if (matchesSomething)
             break;
         italic = !italic;
     }
 
-    PRInt8 baseWeight, weightDistance;
-    aFontStyle.ComputeWeightAndOffset(&baseWeight, &weightDistance);
+    return matchesSomething;
+}
 
-    // 500 isn't quite bold so we want to treat it as 400 if we don't
-    // have a 500 weight
-    if (baseWeight == 5 && weightDistance == 0) {
-        // If we have a 500 weight then use it
-        if (weightList[5])
-            return weightList[5];
+PRBool 
+FontEntry::TestCharacterMap(PRUint32 aCh)
+{
+    if (mUnknownCMAP) {
+        if (aCh > 0xFFFF)
+            return PR_FALSE;
 
-        // Otherwise treat as 400
-        baseWeight = 4;
+        // previous code was using the group style
+        gfxFontStyle fakeStyle;  
+        if (mItalic)
+            fakeStyle.style = FONT_STYLE_ITALIC;
+        fakeStyle.weight = mWeight * 100;
+
+        nsRefPtr<gfxWindowsFont> font =
+            gfxWindowsFont::GetOrMakeFont(this, &fakeStyle);
+        if (!font->IsValid())
+            return PR_FALSE;
+
+        HDC dc = GetDC((HWND)nsnull);
+        SetGraphicsMode(dc, GM_ADVANCED);
+        HFONT hfont = font->GetHFONT();
+        HFONT oldFont = (HFONT)SelectObject(dc, hfont);
+
+        PRUnichar str[1] = { (PRUnichar)aCh };
+        WORD glyph[1];
+
+        PRBool hasGlyph = PR_FALSE;
+        if (IsType1()) {
+            // Type1 fonts and uniscribe APIs don't get along.  ScriptGetCMap will return E_HANDLE
+            DWORD ret = GetGlyphIndicesW(dc, str, 1, glyph, GGI_MARK_NONEXISTING_GLYPHS);
+            if (ret != GDI_ERROR && glyph[0] != 0xFFFF)
+                hasGlyph = PR_TRUE;
+        } else {
+            // ScriptGetCMap works better than GetGlyphIndicesW for things like bitmap/vector fonts
+            HRESULT rv = ScriptGetCMap(dc, font->ScriptCache(), str, 1, 0, glyph);
+            if (rv == S_OK)
+                hasGlyph = PR_TRUE;
+        }
+
+        if (hasGlyph) {
+            mCharacterMap.set(aCh);
+            return PR_TRUE;         // jtdcheck -- don't we need to do a ReleaseDC??
+        }
+
+        SelectObject(dc, oldFont);
+        ReleaseDC(NULL, dc);
     }
 
-    PRInt8 matchBaseWeight = 0;
-    PRInt8 direction = (baseWeight > 5) ? 1 : -1;
-    for (PRInt8 i = baseWeight; ; i += direction) {
-        if (weightList[i]) {
-            matchBaseWeight = i;
-            break;
-        }
-
-        // if we've reached one side without finding a font,
-        // go the other direction until we find a match
-        if (i == 1 || i == 9)
-            direction = -direction;
-    }
-
-    FontEntry *matchFE;
-    const PRInt8 absDistance = abs(weightDistance);
-    direction = (weightDistance >= 0) ? 1 : -1;
-    for (PRInt8 i = matchBaseWeight, k = 0; i < 10 && i > 0; i += direction) {
-        if (weightList[i]) {
-            matchFE = weightList[i];
-            k++;
-        }
-        if (k > absDistance)
-            break;
-    }
-
-    if (!matchFE)
-        matchFE = weightList[matchBaseWeight];
-
-    NS_ASSERTION(matchFE, "we should always be able to return something here");
-    return matchFE;
+    return PR_FALSE;
 }
-
 
 /**********************************************************************
  *
  * class gfxWindowsFont
  *
  **********************************************************************/
 
-gfxWindowsFont::gfxWindowsFont(const nsAString& aName, const gfxFontStyle *aFontStyle, FontEntry *aFontEntry)
-    : gfxFont(aName, aFontStyle),
+gfxWindowsFont::gfxWindowsFont(FontEntry *aFontEntry, const gfxFontStyle *aFontStyle)
+    : gfxFont(aFontEntry, aFontStyle),
       mFont(nsnull), mAdjustedSize(0.0), mScriptCache(nsnull),
       mFontFace(nsnull), mScaledFont(nsnull),
-      mMetrics(nsnull), mFontEntry(aFontEntry), mIsValid(PR_TRUE)
+      mMetrics(nsnull)
 {
+    mFontEntry = aFontEntry;
     NS_ASSERTION(mFontEntry, "Unable to find font entry for font.  Something is whack.");
 
     mFont = MakeHFONT(); // create the HFONT, compute metrics, etc
     NS_ASSERTION(mFont, "Failed to make HFONT");
 }
@@ -652,11 +666,11 @@ gfxWindowsFont::ComputeMetrics()
 
     SelectObject(dc, oldFont);
 
     ReleaseDC((HWND)nsnull, dc);
 
-    SanitizeMetrics(mMetrics, mFontEntry->IsBadUnderlineFont());
+    SanitizeMetrics(mMetrics, GetFontEntry()->IsBadUnderlineFont());
 }
 
 void
 gfxWindowsFont::FillLogFont(gfxFloat aSize)
 {
@@ -672,34 +686,34 @@ gfxWindowsFont::FillLogFont(gfxFloat aSi
     mLogFont.lfEscapement     = 0;
     mLogFont.lfOrientation    = 0;
     mLogFont.lfUnderline      = FALSE;
     mLogFont.lfStrikeOut      = FALSE;
     mLogFont.lfCharSet        = DEFAULT_CHARSET;
-    mLogFont.lfOutPrecision   = FontTypeToOutPrecision(mFontEntry->mFontType);
+    mLogFont.lfOutPrecision   = FontTypeToOutPrecision(GetFontEntry()->mFontType);
     mLogFont.lfClipPrecision  = CLIP_TURNOFF_FONTASSOCIATION;
     mLogFont.lfQuality        = DEFAULT_QUALITY;
     mLogFont.lfPitchAndFamily = DEFAULT_PITCH | FF_DONTCARE;
     // always force lfItalic if we want it.  Font selection code will
     // do its best to give us an italic font entry, but if no face exists
     // it may give us a regular one based on weight.  Windows should
     // do fake italic for us in that case.
     mLogFont.lfItalic         = (GetStyle()->style & (FONT_STYLE_ITALIC | FONT_STYLE_OBLIQUE)) ? TRUE : FALSE;
-    mLogFont.lfWeight         = mFontEntry->mWeight;
+    mLogFont.lfWeight         = GetFontEntry()->mWeight;
 
-    int len = PR_MIN(mName.Length(), LF_FACESIZE - 1);
-    memcpy(mLogFont.lfFaceName, nsPromiseFlatString(mName).get(), len * 2);
+    int len = PR_MIN(GetName().Length(), LF_FACESIZE - 1);
+    memcpy(mLogFont.lfFaceName, nsPromiseFlatString(mFontEntry->Name()).get(), len * 2);
     mLogFont.lfFaceName[len] = '\0';
 }
 
 
 nsString
 gfxWindowsFont::GetUniqueName()
 {
     nsString uniqueName;
 
     // start with the family name
-    uniqueName.Assign(mName);
+    uniqueName.Assign(GetName());
 
     // append the weight code
     if (mLogFont.lfWeight != 400) {
         uniqueName.AppendLiteral(":");
         uniqueName.AppendInt((PRInt32)mLogFont.lfWeight);
@@ -724,10 +738,16 @@ gfxWindowsFont::Draw(gfxTextRun *aTextRu
                      Spacing *aSpacing)
 {
     // XXX stuart may want us to do something faster here
     gfxFont::Draw(aTextRun, aStart, aEnd, aContext, aDrawToPath, aBaselineOrigin,
                   aSpacing);
+}
+
+FontEntry*
+gfxWindowsFont::GetFontEntry()
+{
+    return static_cast<FontEntry*> (mFontEntry.get()); 
 }
 
 PRBool
 gfxWindowsFont::SetupCairoFont(gfxContext *aContext)
 {
@@ -761,13 +781,13 @@ gfxWindowsFont::GetOrMakeFont(FontEntry 
     style.weight = aFontEntry->mWeight;
     // also pre-round the size if there is no size adjust
     if (style.sizeAdjust == 0.0)
         style.size = ROUND(style.size);
 
-    nsRefPtr<gfxFont> font = gfxFontCache::GetCache()->Lookup(aFontEntry->GetName(), &style);
+    nsRefPtr<gfxFont> font = gfxFontCache::GetCache()->Lookup(aFontEntry->Name(), &style);
     if (!font) {
-        font = new gfxWindowsFont(aFontEntry->GetName(), &style, aFontEntry);
+        font = new gfxWindowsFont(aFontEntry, &style);
         if (!font)
             return nsnull;
         gfxFontCache::GetCache()->AddNew(font);
     }
     gfxFont *f = nsnull;
@@ -1612,349 +1632,27 @@ public:
         cairo_win32_scaled_font_select_font(scaledFont, mDC);
 
         mFontSelected = PR_TRUE;
     }
 
-    struct TextRange {
-        TextRange(PRUint32 aStart,  PRUint32 aEnd) : start(aStart), end(aEnd) { }
-        PRUint32 Length() const { return end - start; }
-        nsRefPtr<gfxWindowsFont> font;
-        PRUint32 start, end;
-    };
+    nsTArray<gfxTextRange>& Ranges() { return mRanges; }
 
     void SetRange(PRUint32 i) {
         nsRefPtr<gfxWindowsFont> font;
         if (mRanges[i].font)
-            font = mRanges[i].font;
+            font = static_cast<gfxWindowsFont*> (mRanges[i].font.get());
         else
             font = mGroup->GetFontAt(0);
 
         SetCurrentFont(font);
 
         mRangeString = mItemString + mRanges[i].start;
         mRangeLength = mRanges[i].Length();
     }
 
-    PRBool HasCharacter(FontEntry *aFontEntry, PRUint32 ch) {
-        if (aFontEntry->mCharacterMap.test(ch))
-            return PR_TRUE;
-
-        if (aFontEntry->mUnknownCMAP) {
-            if (ch > 0xFFFF)
-                return PR_FALSE;
-
-            nsRefPtr<gfxWindowsFont> font =
-                gfxWindowsFont::GetOrMakeFont(aFontEntry, mGroup->GetStyle());
-            if (!font->IsValid())
-                return PR_FALSE;
-
-            HDC dc = GetDC((HWND)nsnull);
-            SetGraphicsMode(dc, GM_ADVANCED);
-            HFONT hfont = font->GetHFONT();
-            HFONT oldFont = (HFONT)SelectObject(dc, hfont);
-
-            PRUnichar str[1] = { (PRUnichar)ch };
-            WORD glyph[1];
-
-            PRBool hasGlyph = PR_FALSE;
-            if (aFontEntry->IsType1()) {
-                // Type1 fonts and uniscribe APIs don't get along.  ScriptGetCMap will return E_HANDLE
-                DWORD ret = GetGlyphIndicesW(dc, str, 1, glyph, GGI_MARK_NONEXISTING_GLYPHS);
-                if (ret != GDI_ERROR && glyph[0] != 0xFFFF)
-                    hasGlyph = PR_TRUE;
-            } else {
-                // ScriptGetCMap works better than GetGlyphIndicesW for things like bitmap/vector fonts
-                HRESULT rv = ScriptGetCMap(dc, font->ScriptCache(), str, 1, 0, glyph);
-                if (rv == S_OK)
-                    hasGlyph = PR_TRUE;
-            }
-
-            if (hasGlyph) {
-                aFontEntry->mCharacterMap.set(ch);
-                return PR_TRUE;
-            }
-
-            SelectObject(dc, oldFont);
-            ReleaseDC(NULL, dc);
-        }
-
-        return PR_FALSE;
-    }
-
-    inline already_AddRefed<gfxWindowsFont>
-    WhichFontSupportsChar(const nsTArray<nsRefPtr<FontEntry> >& fonts, PRUint32 ch) {
-        for (PRUint32 i = 0; i < fonts.Length(); i++) {
-            nsRefPtr<FontEntry> fe = fonts[i];
-            if (fe->mSymbolFont && !mGroup->GetStyle()->familyNameQuirks)
-                continue;
-            if (HasCharacter(fe, ch)) {
-                nsRefPtr<gfxWindowsFont> font =
-                    gfxWindowsFont::GetOrMakeFont(fe, mGroup->GetStyle());
-                // Check that the font is still usable.
-                if (!font->IsValid())
-                    continue;
-                return font.forget();
-            }
-        }
-        return nsnull;
-    }
-
-    static inline bool IsJoiner(PRUint32 ch) {
-        return (ch == 0x200C ||
-                ch == 0x200D ||
-                ch == 0x2060);
-    }
-
-    inline already_AddRefed<gfxWindowsFont>
-    FindFontForChar(PRUint32 ch, PRUint32 prevCh, PRUint32 nextCh,
-                    gfxWindowsFont *aFont) {
-        nsRefPtr<gfxWindowsFont> selectedFont;
-
-        // if this character or the next one is a joiner use the
-        // same font as the previous range if we can
-        if (IsJoiner(ch) || IsJoiner(prevCh) || IsJoiner(nextCh)) {
-            if (aFont && HasCharacter(aFont->GetFontEntry(), ch)) {
-                NS_ADDREF(aFont);
-                return aFont;
-            }
-        }
-
-        // check the list of fonts
-        selectedFont = WhichFontSupportsChar(mGroup->GetFontList(), ch);
-
-        // don't look in other fonts if the character is in a Private Use Area
-        if ((ch >= 0xE000  && ch <= 0xF8FF) || 
-            (ch >= 0xF0000 && ch <= 0x10FFFD))
-            return selectedFont.forget();
-
-        // check out the style's language group
-        if (!selectedFont) {
-            nsAutoTArray<nsRefPtr<FontEntry>, 5> fonts;
-            this->GetPrefFonts(mGroup->GetStyle()->langGroup.get(), fonts);
-            selectedFont = WhichFontSupportsChar(fonts, ch);
-        }
-
-        // otherwise search prefs
-        if (!selectedFont) {
-            /* first check with the script properties to see what they think */
-            const SCRIPT_PROPERTIES *sp = ScriptProperties();
-            if (!sp->fAmbiguousCharSet) {
-                WORD primaryId = PRIMARYLANGID(sp->langid);
-                const char *langGroup = gScriptToText[primaryId].langCode;
-                if (langGroup) {
-                    PR_LOG(gFontLog, PR_LOG_DEBUG, (" - Trying to find fonts for: %s (%s)", langGroup, gScriptToText[primaryId].value));
-
-                    nsAutoTArray<nsRefPtr<FontEntry>, 5> fonts;
-                    this->GetPrefFonts(langGroup, fonts);
-                    selectedFont = WhichFontSupportsChar(fonts, ch);
-                }
-            } else if (ch <= 0xFFFF) {
-                PRUint32 unicodeRange = FindCharUnicodeRange(ch);
-
-                /* special case CJK */
-                if (unicodeRange == kRangeSetCJK) {
-                    if (PR_LOG_TEST(gFontLog, PR_LOG_DEBUG))
-                        PR_LOG(gFontLog, PR_LOG_DEBUG, (" - Trying to find fonts for: CJK"));
-
-                    nsAutoTArray<nsRefPtr<FontEntry>, 15> fonts;
-                    this->GetCJKPrefFonts(fonts);
-                    selectedFont = WhichFontSupportsChar(fonts, ch);
-                } else {
-                    const char *langGroup = LangGroupFromUnicodeRange(unicodeRange);
-                    if (langGroup) {
-                        PR_LOG(gFontLog, PR_LOG_DEBUG, (" - Trying to find fonts for: %s", langGroup));
-
-                        nsAutoTArray<nsRefPtr<FontEntry>, 5> fonts;
-                        this->GetPrefFonts(langGroup, fonts);
-                        selectedFont = WhichFontSupportsChar(fonts, ch);
-                    }
-                }
-            }
-        }
-
-        // before searching for something else check the font used for the previous character
-        if (!selectedFont && aFont && HasCharacter(aFont->GetFontEntry(), ch))
-            selectedFont = aFont;
-
-        // otherwise look for other stuff
-        if (!selectedFont) {
-            PR_LOG(gFontLog, PR_LOG_DEBUG, (" - Looking for best match"));
-
-            nsRefPtr<gfxWindowsFont> refFont = mGroup->GetFontAt(0);
-            gfxWindowsPlatform *platform = gfxWindowsPlatform::GetPlatform();
-            selectedFont = platform->FindFontForChar(ch, refFont);
-        }
-
-        return selectedFont.forget();
-    }
-
-    PRUint32 ComputeRanges() {
-        if (mItemLength == 0)
-            return 0;
-
-        PR_LOG(gFontLog, PR_LOG_DEBUG, ("Computing ranges for string: (len = %d)", mItemLength));
-
-        PRUint32 prevCh = 0;
-        for (PRUint32 i = 0; i < mItemLength; i++) {
-            const PRUint32 origI = i; // save off incase we increase for surrogate
-            PRUint32 ch = mItemString[i];
-            if ((i+1 < mItemLength) && NS_IS_HIGH_SURROGATE(ch) && NS_IS_LOW_SURROGATE(mItemString[i+1])) {
-                i++;
-                ch = SURROGATE_TO_UCS4(ch, mItemString[i]);
-            }
-
-            PR_LOG(gFontLog, PR_LOG_DEBUG, (" 0x%04x - ", ch));
-            PRUint32 nextCh = 0;
-            if (i+1 < mItemLength) {
-                nextCh = mItemString[i+1];
-                if ((i+2 < mItemLength) && NS_IS_HIGH_SURROGATE(nextCh) && NS_IS_LOW_SURROGATE(mItemString[i+2]))
-                    nextCh = SURROGATE_TO_UCS4(nextCh, mItemString[i+2]);
-            }
-            nsRefPtr<gfxWindowsFont> font =
-                FindFontForChar(ch,
-                                prevCh,
-                                nextCh,
-                                (mRanges.Length() == 0) ? nsnull : mRanges[mRanges.Length() - 1].font);
-
-            prevCh = ch;
-
-            if (mRanges.Length() == 0) {
-                TextRange r(0,1);
-                r.font = font;
-                mRanges.AppendElement(r);
-            } else {
-                TextRange& prevRange = mRanges[mRanges.Length() - 1];
-                if (prevRange.font != font) {
-                    // close out the previous range
-                    prevRange.end = origI;
-
-                    TextRange r(origI, i+1);
-                    r.font = font;
-                    mRanges.AppendElement(r);
-                }
-            }
-            if (PR_LOG_TEST(gFontLog, PR_LOG_DEBUG)) {
-                if (font)
-                    PR_LOG(gFontLog, PR_LOG_DEBUG, (" - Using %s", NS_LossyConvertUTF16toASCII(font->GetUniqueName()).get()));
-                else
-                    PR_LOG(gFontLog, PR_LOG_DEBUG, (" - Unable to find font"));
-            }
-        }
-        mRanges[mRanges.Length()-1].end = mItemLength;
-
-        PRUint32 nranges = mRanges.Length();
-        PR_LOG(gFontLog, PR_LOG_DEBUG, (" Found %d ranges", nranges));
-        return nranges;
-    }
 
 private:
-    static PRInt32 GetCJKLangGroupIndex(const char *aLangGroup) {
-        PRInt32 i;
-        for (i = 0; i < COUNT_OF_CJK_LANG_GROUP; i++) {
-            if (!PL_strcasecmp(aLangGroup, sCJKLangGroup[i]))
-                return i;
-        }
-        return -1;
-    }
-
-    // this function appends to the array passed in.
-    void GetPrefFonts(const char *aLangGroup, nsTArray<nsRefPtr<FontEntry> >& array) {
-        NS_ASSERTION(aLangGroup, "aLangGroup is null");
-        gfxWindowsPlatform *platform = gfxWindowsPlatform::GetPlatform();
-        nsAutoTArray<nsRefPtr<FontEntry>, 5> fonts;
-        /* this lookup has to depend on weight and style */
-        nsCAutoString key(aLangGroup);
-        key.Append("-");
-        key.AppendInt(mGroup->GetStyle()->style);
-        key.Append("-");
-        key.AppendInt(mGroup->GetStyle()->weight);
-        if (!platform->GetPrefFontEntries(key, &fonts)) {
-            nsString fontString;
-            platform->GetPrefFonts(aLangGroup, fontString);
-            if (fontString.IsEmpty())
-                return;
-
-            mGroup->FamilyListToArrayList(fontString, nsDependentCString(aLangGroup),
-                                          &fonts);
-
-            platform->SetPrefFontEntries(key, fonts);
-        }
-        array.AppendElements(fonts);
-    }
-
-    // this function assigns to the array passed in.
-    void GetCJKPrefFonts(nsTArray<nsRefPtr<FontEntry> >& array) {
-        gfxWindowsPlatform *platform = gfxWindowsPlatform::GetPlatform();
-
-        nsCAutoString key("x-internal-cjk-");
-        key.AppendInt(mGroup->GetStyle()->style);
-        key.Append("-");
-        key.AppendInt(mGroup->GetStyle()->weight);
-
-        if (!platform->GetPrefFontEntries(key, &array)) {
-            nsCOMPtr<nsIPrefService> prefs = do_GetService(NS_PREFSERVICE_CONTRACTID);
-            if (!prefs)
-                return;
-
-            nsCOMPtr<nsIPrefBranch> prefBranch;
-            prefs->GetBranch(0, getter_AddRefs(prefBranch));
-            if (!prefBranch)
-                return;
-
-            // Add the CJK pref fonts from accept languages, the order should be same order
-            nsCAutoString list;
-            nsCOMPtr<nsIPrefLocalizedString> val;
-            nsresult rv = prefBranch->GetComplexValue("intl.accept_languages", NS_GET_IID(nsIPrefLocalizedString),
-                                                      getter_AddRefs(val));
-            if (NS_SUCCEEDED(rv) && val) {
-                nsAutoString temp;
-                val->ToString(getter_Copies(temp));
-                LossyCopyUTF16toASCII(temp, list);
-            }
-            if (!list.IsEmpty()) {
-                const char kComma = ',';
-                const char *p, *p_end;
-                list.BeginReading(p);
-                list.EndReading(p_end);
-                while (p < p_end) {
-                    while (nsCRT::IsAsciiSpace(*p)) {
-                        if (++p == p_end)
-                            break;
-                    }
-                    if (p == p_end)
-                        break;
-                    const char *start = p;
-                    while (++p != p_end && *p != kComma)
-                        /* nothing */ ;
-                    nsCAutoString lang(Substring(start, p));
-                    lang.CompressWhitespace(PR_FALSE, PR_TRUE);
-                    PRInt32 index = GetCJKLangGroupIndex(lang.get());
-                    if (index >= 0)
-                        GetPrefFonts(sCJKLangGroup[index], array);
-                    p++;
-                }
-            }
-
-            // Add the system locale
-            switch (::GetACP()) {
-                case 932: GetPrefFonts(CJK_LANG_JA, array); break;
-                case 936: GetPrefFonts(CJK_LANG_ZH_CN, array); break;
-                case 949: GetPrefFonts(CJK_LANG_KO, array); break;
-                // XXX Don't we need to append CJK_LANG_ZH_HK if the codepage is 950?
-                case 950: GetPrefFonts(CJK_LANG_ZH_TW, array); break;
-            }
-
-            // last resort...
-            GetPrefFonts(CJK_LANG_JA, array);
-            GetPrefFonts(CJK_LANG_KO, array);
-            GetPrefFonts(CJK_LANG_ZH_CN, array);
-            GetPrefFonts(CJK_LANG_ZH_HK, array);
-            GetPrefFonts(CJK_LANG_ZH_TW, array);
-
-            platform->SetPrefFontEntries(key, array);
-        }
-    }
 
     void GenerateAlternativeString() {
         if (mAlternativeString)
             free(mAlternativeString);
         mAlternativeString = (PRUnichar *)malloc(mRangeLength * sizeof(PRUnichar));
@@ -1977,14 +1675,16 @@ private:
 
     // these point to the current range
     const PRUnichar *mRangeString;
     PRUint32 mRangeLength;
 
+public:
     // these point to the full string/length of the item
     const PRUnichar *mItemString;
     const PRUint32 mItemLength;
 
+private:
     PRUnichar *mAlternativeString;
 
     gfxWindowsFontGroup *mGroup;
 
 #define AVERAGE_ITEM_LENGTH 40
@@ -2003,11 +1703,11 @@ private:
 
     nsRefPtr<gfxWindowsFont> mCurrentFont;
 
     PRPackedBool mFontSelected;
 
-    nsTArray<TextRange> mRanges;
+    nsTArray<gfxTextRange> mRanges;
 };
 
 
 #define MAX_ITEM_LENGTH 32768
 
@@ -2171,10 +1871,210 @@ private:
     SCRIPT_STATE   mState;
     nsTArray<SCRIPT_ITEM> mItems;
     int mNumItems;
 };
 
+already_AddRefed<gfxWindowsFont>
+gfxWindowsFontGroup::WhichFontSupportsChar(const nsTArray<nsRefPtr<FontEntry> >& fonts, PRUint32 ch) {
+    for (PRUint32 i = 0; i < fonts.Length(); i++) {
+        nsRefPtr<FontEntry> fe = fonts[i];
+        if (fe->mSymbolFont && !mStyle.familyNameQuirks)
+            continue;
+        if (fe->HasCharacter(ch)) {
+            nsRefPtr<gfxWindowsFont> font =
+                gfxWindowsFont::GetOrMakeFont(fe, &mStyle);
+            // Check that the font is still usable.
+            if (!font->IsValid())
+                continue;
+            return font.forget();
+        }
+    }
+    return nsnull;
+}
+
+// this function appends to the array passed in.
+void gfxWindowsFontGroup::GetPrefFonts(const char *aLangGroup, nsTArray<nsRefPtr<FontEntry> >& array) {
+    NS_ASSERTION(aLangGroup, "aLangGroup is null");
+    gfxWindowsPlatform *platform = gfxWindowsPlatform::GetPlatform();
+    nsAutoTArray<nsRefPtr<FontEntry>, 5> fonts;
+    /* this lookup has to depend on weight and style */
+    nsCAutoString key(aLangGroup);
+    key.Append("-");
+    key.AppendInt(GetStyle()->style);
+    key.Append("-");
+    key.AppendInt(GetStyle()->weight);
+    if (!platform->GetPrefFontEntries(key, &fonts)) {
+        nsString fontString;
+        platform->GetPrefFonts(aLangGroup, fontString);
+        if (fontString.IsEmpty())
+            return;
+
+        FamilyListToArrayList(fontString, nsDependentCString(aLangGroup),
+                                      &fonts);
+
+        platform->SetPrefFontEntries(key, fonts);
+    }
+    array.AppendElements(fonts);
+}
+
+static PRInt32 GetCJKLangGroupIndex(const char *aLangGroup) {
+    PRInt32 i;
+    for (i = 0; i < COUNT_OF_CJK_LANG_GROUP; i++) {
+        if (!PL_strcasecmp(aLangGroup, sCJKLangGroup[i]))
+            return i;
+    }
+    return -1;
+}
+
+// this function assigns to the array passed in.
+void gfxWindowsFontGroup::GetCJKPrefFonts(nsTArray<nsRefPtr<FontEntry> >& array) {
+    gfxWindowsPlatform *platform = gfxWindowsPlatform::GetPlatform();
+
+    nsCAutoString key("x-internal-cjk-");
+    key.AppendInt(mStyle.style);
+    key.Append("-");
+    key.AppendInt(mStyle.weight);
+
+    if (!platform->GetPrefFontEntries(key, &array)) {
+        nsCOMPtr<nsIPrefService> prefs = do_GetService(NS_PREFSERVICE_CONTRACTID);
+        if (!prefs)
+            return;
+
+        nsCOMPtr<nsIPrefBranch> prefBranch;
+        prefs->GetBranch(0, getter_AddRefs(prefBranch));
+        if (!prefBranch)
+            return;
+
+        // Add the CJK pref fonts from accept languages, the order should be same order
+        nsCAutoString list;
+        nsCOMPtr<nsIPrefLocalizedString> val;
+        nsresult rv = prefBranch->GetComplexValue("intl.accept_languages", NS_GET_IID(nsIPrefLocalizedString),
+                                                  getter_AddRefs(val));
+        if (NS_SUCCEEDED(rv) && val) {
+            nsAutoString temp;
+            val->ToString(getter_Copies(temp));
+            LossyCopyUTF16toASCII(temp, list);
+        }
+        if (!list.IsEmpty()) {
+            const char kComma = ',';
+            const char *p, *p_end;
+            list.BeginReading(p);
+            list.EndReading(p_end);
+            while (p < p_end) {
+                while (nsCRT::IsAsciiSpace(*p)) {
+                    if (++p == p_end)
+                        break;
+                }
+                if (p == p_end)
+                    break;
+                const char *start = p;
+                while (++p != p_end && *p != kComma)
+                    /* nothing */ ;
+                nsCAutoString lang(Substring(start, p));
+                lang.CompressWhitespace(PR_FALSE, PR_TRUE);
+                PRInt32 index = GetCJKLangGroupIndex(lang.get());
+                if (index >= 0)
+                    GetPrefFonts(sCJKLangGroup[index], array);
+                p++;
+            }
+        }
+
+        // Add the system locale
+        switch (::GetACP()) {
+            case 932: GetPrefFonts(CJK_LANG_JA, array); break;
+            case 936: GetPrefFonts(CJK_LANG_ZH_CN, array); break;
+            case 949: GetPrefFonts(CJK_LANG_KO, array); break;
+            // XXX Don't we need to append CJK_LANG_ZH_HK if the codepage is 950?
+            case 950: GetPrefFonts(CJK_LANG_ZH_TW, array); break;
+        }
+
+        // last resort...
+        GetPrefFonts(CJK_LANG_JA, array);
+        GetPrefFonts(CJK_LANG_KO, array);
+        GetPrefFonts(CJK_LANG_ZH_CN, array);
+        GetPrefFonts(CJK_LANG_ZH_HK, array);
+        GetPrefFonts(CJK_LANG_ZH_TW, array);
+
+        platform->SetPrefFontEntries(key, array);
+    }
+}
+
+already_AddRefed<gfxFont> 
+gfxWindowsFontGroup::WhichPrefFontSupportsChar(PRUint32 aCh)
+{
+    nsRefPtr<gfxWindowsFont> selectedFont;
+
+    // check out the style's language group
+    if (!selectedFont) {
+        nsAutoTArray<nsRefPtr<FontEntry>, 5> fonts;
+        this->GetPrefFonts(mStyle.langGroup.get(), fonts);
+        selectedFont = WhichFontSupportsChar(fonts, aCh);
+    }
+
+    // otherwise search prefs
+    if (!selectedFont) {
+        /* first check with the script properties to see what they think */
+        if (mItemLangGroup) {
+            PR_LOG(gFontLog, PR_LOG_DEBUG, (" - Trying to find fonts for: %s ", mItemLangGroup));
+
+            nsAutoTArray<nsRefPtr<FontEntry>, 5> fonts;
+            this->GetPrefFonts(mItemLangGroup, fonts);
+            selectedFont = WhichFontSupportsChar(fonts, aCh);
+        } else if (aCh <= 0xFFFF) {
+            PRUint32 unicodeRange = FindCharUnicodeRange(aCh);
+
+            /* special case CJK */
+            if (unicodeRange == kRangeSetCJK) {
+                if (PR_LOG_TEST(gFontLog, PR_LOG_DEBUG))
+                    PR_LOG(gFontLog, PR_LOG_DEBUG, (" - Trying to find fonts for: CJK"));
+
+                nsAutoTArray<nsRefPtr<FontEntry>, 15> fonts;
+                this->GetCJKPrefFonts(fonts);
+                selectedFont = WhichFontSupportsChar(fonts, aCh);
+            } else {
+                const char *langGroup = LangGroupFromUnicodeRange(unicodeRange);
+                if (langGroup) {
+                    PR_LOG(gFontLog, PR_LOG_DEBUG, (" - Trying to find fonts for: %s", langGroup));
+
+                    nsAutoTArray<nsRefPtr<FontEntry>, 5> fonts;
+                    this->GetPrefFonts(langGroup, fonts);
+                    selectedFont = WhichFontSupportsChar(fonts, aCh);
+                }
+            }
+        }
+    }
+
+    if (selectedFont) {
+        nsRefPtr<gfxFont> f = static_cast<gfxFont*>(selectedFont.get());
+        return f.forget();
+    }
+
+    return nsnull;
+}
+
+
+already_AddRefed<gfxFont> 
+gfxWindowsFontGroup::WhichSystemFontSupportsChar(PRUint32 aCh)
+{
+    nsRefPtr<gfxWindowsFont> selectedFont;
+
+    // system font lookup
+    PR_LOG(gFontLog, PR_LOG_DEBUG, (" - Looking for best match"));
+
+    nsRefPtr<gfxWindowsFont> refFont = GetFontAt(0);
+    gfxWindowsPlatform *platform = gfxWindowsPlatform::GetPlatform();
+    selectedFont = platform->FindFontForChar(aCh, refFont);
+
+    if (selectedFont) {
+        nsRefPtr<gfxFont> f = static_cast<gfxFont*>(selectedFont.get());
+        return f.forget();
+    }
+
+    return nsnull;
+}
+
+
 void
 gfxWindowsFontGroup::InitTextRunUniscribe(gfxContext *aContext, gfxTextRun *aRun, const PRUnichar *aString,
                                           PRUint32 aLength)
 {
     DCFromContext aDC(aContext);
@@ -2191,11 +2091,22 @@ gfxWindowsFontGroup::InitTextRunUniscrib
     for (int i = 0; i < numItems; ++i) {
         SaveDC(aDC);
 
         nsAutoPtr<UniscribeItem> item(us.GetItem(i, this));
 
-        PRUint32 nranges = item->ComputeRanges();
+        // jtdfix - push this into the pref handling code??
+        mItemLangGroup = nsnull;
+
+        const SCRIPT_PROPERTIES *sp = item->ScriptProperties();
+        if (!sp->fAmbiguousCharSet) {
+            WORD primaryId = PRIMARYLANGID(sp->langid);
+            mItemLangGroup = gScriptToText[primaryId].langCode;
+        }
+
+        ComputeRanges(item->Ranges(), item->mItemString, 0, item->mItemLength);
+
+        PRUint32 nranges = item->Ranges().Length();
 
         for (PRUint32 j = 0; j < nranges; ++j) {
 
             item->SetRange(j);
 
@@ -2235,5 +2146,6 @@ gfxWindowsFontGroup::InitTextRunUniscrib
         if (FAILED(rv)) {
             i = -1;
         }
     }
 }
+
diff --git a/gfx/thebes/src/gfxWindowsPlatform.cpp b/gfx/thebes/src/gfxWindowsPlatform.cpp
--- a/gfx/thebes/src/gfxWindowsPlatform.cpp
+++ b/gfx/thebes/src/gfxWindowsPlatform.cpp
@@ -479,11 +479,11 @@ gfxWindowsPlatform::FindFontForCharProc(
         rank += 2;
     else if (fe->mWeight == data->fontToMatch->GetFontEntry()->mWeight)
         rank += 1;
 
     if (rank > data->matchRank ||
-        (rank == data->matchRank && Compare(fe->GetName(), data->bestMatch->GetName()) > 0)) {
+        (rank == data->matchRank && Compare(fe->Name(), data->bestMatch->Name()) > 0)) {
         data->bestMatch = fe;
         data->matchRank = rank;
     }
 
     return PL_DHASH_NEXT;
diff --git a/gfx/thebes/src/gfxXlibNativeRenderer.cpp b/gfx/thebes/src/gfxXlibNativeRenderer.cpp
deleted file mode 100644
--- a/gfx/thebes/src/gfxXlibNativeRenderer.cpp
+++ /dev/null
@@ -1,209 +0,0 @@
-/* -*- Mode: C++; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*-
- * ***** BEGIN LICENSE BLOCK *****
- * Version: MPL 1.1/GPL 2.0/LGPL 2.1
- *
- * The contents of this file are subject to the Mozilla Public License Version
- * 1.1 (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- * http://www.mozilla.org/MPL/
- *
- * Software distributed under the License is distributed on an "AS IS" basis,
- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
- * for the specific language governing rights and limitations under the
- * License.
- *
- * The Original Code is Novell code.
- *
- * The Initial Developer of the Original Code is Novell.
- * Portions created by the Initial Developer are Copyright (C) 2006
- * the Initial Developer. All Rights Reserved.
- *
- * Contributor(s):
- *   rocallahan@novell.com
- *
- * Alternatively, the contents of this file may be used under the terms of
- * either the GNU General Public License Version 2 or later (the "GPL"), or
- * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
- * in which case the provisions of the GPL or the LGPL are applicable instead
- * of those above. If you wish to allow use of your version of this file only
- * under the terms of either the GPL or the LGPL, and not to allow others to
- * use your version of this file under the terms of the MPL, indicate your
- * decision by deleting the provisions above and replace them with the notice
- * and other provisions required by the GPL or the LGPL. If you do not delete
- * the provisions above, a recipient may use your version of this file under
- * the terms of any one of the MPL, the GPL or the LGPL.
- *
- * ***** END LICENSE BLOCK ***** */
-
-#include "gfxXlibNativeRenderer.h"
-#include "gfxContext.h"
-
-#include "cairo-xlib-utils.h"
-
-#ifdef MOZ_WIDGET_GTK2
-#include <gdk/gdkscreen.h>
-#include <gdk/gdkx.h>
-#endif
-
-// Look for an existing Colormap that known to be associated with visual.
-static Colormap
-LookupColormapForVisual(const Screen* screen, const Visual* visual)
-{
-    // common case
-    if (visual == DefaultVisualOfScreen(screen))
-        return DefaultColormapOfScreen(screen);
-
-#ifdef MOZ_WIDGET_GTK2
-    // I wish there were a gdk_x11_display_lookup_screen.
-    Display* dpy = DisplayOfScreen(screen);
-    GdkDisplay* gdkDpy = gdk_x11_lookup_xdisplay(dpy);
-    if (gdkDpy) {
-        gint screen_num = 0;
-        for (int s = 0; s < ScreenCount(dpy); ++s) {
-            if (ScreenOfDisplay(dpy, s) == screen) {
-                screen_num = s;
-                break;
-            }
-        }
-        GdkScreen* gdkScreen = gdk_display_get_screen(gdkDpy, screen_num);
-
-        GdkColormap* gdkColormap = NULL;
-        if (visual ==
-            GDK_VISUAL_XVISUAL(gdk_screen_get_rgb_visual(gdkScreen))) {
-            // widget/src/gtk2/mozcontainer.c uses gdk_rgb_get_colormap()
-            // which is inherited by child widgets, so this is the visual
-            // expected when drawing directly to widget surfaces or surfaces
-            // created using cairo_surface_create_similar with
-            // CAIRO_CONTENT_COLOR.
-            // gdk_screen_get_rgb_colormap is the generalization of
-            // gdk_rgb_get_colormap for any screen.
-            gdkColormap = gdk_screen_get_rgb_colormap(gdkScreen);
-        }
-        else if (visual ==
-             GDK_VISUAL_XVISUAL(gdk_screen_get_rgba_visual(gdkScreen))) {
-            // This is the visual expected on displays with the Composite
-            // extension enabled when the surface has been created using
-            // cairo_surface_create_similar with CAIRO_CONTENT_COLOR_ALPHA,
-            // as happens with non-unit opacity.
-            gdkColormap = gdk_screen_get_rgba_colormap(gdkScreen);
-        }
-        if (gdkColormap != NULL)
-            return GDK_COLORMAP_XCOLORMAP(gdkColormap);
-    }
-#endif
-
-    return None;
-}
-
-typedef struct {
-    gfxXlibNativeRenderer* mRenderer;
-    nsresult               mRV;
-} NativeRenderingClosure;
-
-static cairo_bool_t
-NativeRendering(void *closure,
-                Screen *screen,
-                Drawable drawable,
-                Visual *visual,
-                short offset_x, short offset_y,
-                XRectangle* rectangles, unsigned int num_rects)
-{
-    // Cairo doesn't provide a Colormap.
-    // See if a suitable existing Colormap is known.
-    Colormap colormap = LookupColormapForVisual(screen, visual);
-    PRBool allocColormap = colormap == None;
-    if (allocColormap) {
-        // No existing colormap found.
-        // This case is not expected with MOZ_WIDGET_GTK2.
-        // Create a Colormap for the Visual.
-        // This is only really useful for Visual classes with predefined
-        // Colormap entries, but cairo would be all confused with
-        // non-default non-TrueColor colormaps anyway.
-        NS_ASSERTION(visual->c_class == TrueColor ||
-                     visual->c_class == StaticColor ||
-                     visual->c_class == StaticGray,
-                     "Creating empty colormap");
-        // If this case were expected then it might be worth considering
-        // using a service that maintains a set of Colormaps for associated
-        // Visuals so as to avoid repeating the LockDisplay required in
-        // XCreateColormap, but then it's no worse than the XCreatePixmap
-        // that produced the Drawable here.
-        colormap = XCreateColormap(DisplayOfScreen(screen),
-                                   RootWindowOfScreen(screen),
-                                   visual, AllocNone);
-    }
-
-    NativeRenderingClosure* cl = (NativeRenderingClosure*)closure;
-    nsresult rv = cl->mRenderer->
-        NativeDraw(screen, drawable, visual, colormap, offset_x, offset_y,
-                   rectangles, num_rects);
-    cl->mRV = rv;
-
-    if (allocColormap) {
-        XFreeColormap(DisplayOfScreen(screen), colormap);
-    }
-    return NS_SUCCEEDED(rv);
-}
-
-nsresult
-gfxXlibNativeRenderer::Draw(Display* dpy, gfxContext* ctx, int width, int height,
-                            PRUint32 flags, DrawOutput* output)
-{
-    NativeRenderingClosure closure = { this, NS_OK };
-    cairo_xlib_drawing_result_t result;
-    // Make sure result.surface is null to start with; we rely on it
-    // being non-null meaning that a surface actually got allocated.
-    result.surface = NULL;
-
-    if (output) {
-        output->mSurface = NULL;
-        output->mUniformAlpha = PR_FALSE;
-        output->mUniformColor = PR_FALSE;
-    }
-
-    int cairoFlags = 0;
-    if (flags & DRAW_SUPPORTS_OFFSET) {
-        cairoFlags |= CAIRO_XLIB_DRAWING_SUPPORTS_OFFSET;
-    }
-    if (flags & DRAW_SUPPORTS_CLIP_RECT) {
-        cairoFlags |= CAIRO_XLIB_DRAWING_SUPPORTS_CLIP_RECT;
-    }
-    if (flags & DRAW_SUPPORTS_CLIP_LIST) {
-        cairoFlags |= CAIRO_XLIB_DRAWING_SUPPORTS_CLIP_LIST;
-    }
-    if (flags & DRAW_SUPPORTS_ALTERNATE_SCREEN) {
-        cairoFlags |= CAIRO_XLIB_DRAWING_SUPPORTS_ALTERNATE_SCREEN;
-    }
-    if (flags & DRAW_SUPPORTS_NONDEFAULT_VISUAL) {
-        cairoFlags |= CAIRO_XLIB_DRAWING_SUPPORTS_NONDEFAULT_VISUAL;
-    }
-    cairo_draw_with_xlib(ctx->GetCairo(), NativeRendering, &closure, dpy,
-                         width, height,
-                         (flags & DRAW_IS_OPAQUE) ? CAIRO_XLIB_DRAWING_OPAQUE
-                                                  : CAIRO_XLIB_DRAWING_TRANSPARENT,
-                         (cairo_xlib_drawing_support_t)cairoFlags,
-                         output ? &result : NULL);
-    if (NS_FAILED(closure.mRV)) {
-        if (result.surface) {
-            NS_ASSERTION(output, "How did that happen?");
-            cairo_surface_destroy (result.surface);
-        }
-        return closure.mRV;
-    }
-
-    if (output) {
-        if (result.surface) {
-            output->mSurface = gfxASurface::Wrap(result.surface);
-            if (!output->mSurface) {
-                cairo_surface_destroy (result.surface);
-                return NS_ERROR_OUT_OF_MEMORY;
-            }
-        }
-
-        output->mUniformAlpha = result.uniform_alpha;
-        output->mUniformColor = result.uniform_color;
-        output->mColor = gfxRGBA(result.r, result.g, result.b, result.alpha);
-    }
-  
-    return NS_OK;
-}
diff --git a/js/src/dtoa.c b/js/src/dtoa.c
new file mode 100644
--- /dev/null
+++ b/js/src/dtoa.c
@@ -0,0 +1,3332 @@
+/****************************************************************
+ *
+ * The author of this software is David M. Gay.
+ *
+ * Copyright (c) 1991, 2000, 2001 by Lucent Technologies.
+ *
+ * Permission to use, copy, modify, and distribute this software for any
+ * purpose without fee is hereby granted, provided that this entire notice
+ * is included in all copies of any software which is or includes a copy
+ * or modification of this software and in all copies of the supporting
+ * documentation for such software.
+ *
+ * THIS SOFTWARE IS BEING PROVIDED "AS IS", WITHOUT ANY EXPRESS OR IMPLIED
+ * WARRANTY.  IN PARTICULAR, NEITHER THE AUTHOR NOR LUCENT MAKES ANY
+ * REPRESENTATION OR WARRANTY OF ANY KIND CONCERNING THE MERCHANTABILITY
+ * OF THIS SOFTWARE OR ITS FITNESS FOR ANY PARTICULAR PURPOSE.
+ *
+ ***************************************************************/
+
+/* Please send bug reports to David M. Gay (dmg at acm dot org,
+ * with " at " changed at "@" and " dot " changed to ".").	*/
+
+/* On a machine with IEEE extended-precision registers, it is
+ * necessary to specify double-precision (53-bit) rounding precision
+ * before invoking strtod or dtoa.  If the machine uses (the equivalent
+ * of) Intel 80x87 arithmetic, the call
+ *	_control87(PC_53, MCW_PC);
+ * does this with many compilers.  Whether this or another call is
+ * appropriate depends on the compiler; for this to work, it may be
+ * necessary to #include "float.h" or another system-dependent header
+ * file.
+ */
+
+/* strtod for IEEE-, VAX-, and IBM-arithmetic machines.
+ *
+ * This strtod returns a nearest machine number to the input decimal
+ * string (or sets errno to ERANGE).  With IEEE arithmetic, ties are
+ * broken by the IEEE round-even rule.  Otherwise ties are broken by
+ * biased rounding (add half and chop).
+ *
+ * Inspired loosely by William D. Clinger's paper "How to Read Floating
+ * Point Numbers Accurately" [Proc. ACM SIGPLAN '90, pp. 92-101].
+ *
+ * Modifications:
+ *
+ *	1. We only require IEEE, IBM, or VAX double-precision
+ *		arithmetic (not IEEE double-extended).
+ *	2. We get by with floating-point arithmetic in a case that
+ *		Clinger missed -- when we're computing d * 10^n
+ *		for a small integer d and the integer n is not too
+ *		much larger than 22 (the maximum integer k for which
+ *		we can represent 10^k exactly), we may be able to
+ *		compute (d*10^k) * 10^(e-k) with just one roundoff.
+ *	3. Rather than a bit-at-a-time adjustment of the binary
+ *		result in the hard case, we use floating-point
+ *		arithmetic to determine the adjustment to within
+ *		one bit; only in really hard cases do we need to
+ *		compute a second residual.
+ *	4. Because of 3., we don't need a large table of powers of 10
+ *		for ten-to-e (just some small tables, e.g. of 10^k
+ *		for 0 <= k <= 22).
+ */
+
+/*
+ * #define IEEE_8087 for IEEE-arithmetic machines where the least
+ *	significant byte has the lowest address.
+ * #define IEEE_MC68k for IEEE-arithmetic machines where the most
+ *	significant byte has the lowest address.
+ * #define Long int on machines with 32-bit ints and 64-bit longs.
+ * #define IBM for IBM mainframe-style floating-point arithmetic.
+ * #define VAX for VAX-style floating-point arithmetic (D_floating).
+ * #define No_leftright to omit left-right logic in fast floating-point
+ *	computation of dtoa.
+ * #define Honor_FLT_ROUNDS if FLT_ROUNDS can assume the values 2 or 3
+ *	and strtod and dtoa should round accordingly.
+ * #define Check_FLT_ROUNDS if FLT_ROUNDS can assume the values 2 or 3
+ *	and Honor_FLT_ROUNDS is not #defined.
+ * #define RND_PRODQUOT to use rnd_prod and rnd_quot (assembly routines
+ *	that use extended-precision instructions to compute rounded
+ *	products and quotients) with IBM.
+ * #define ROUND_BIASED for IEEE-format with biased rounding.
+ * #define Inaccurate_Divide for IEEE-format with correctly rounded
+ *	products but inaccurate quotients, e.g., for Intel i860.
+ * #define NO_LONG_LONG on machines that do not have a "long long"
+ *	integer type (of >= 64 bits).  On such machines, you can
+ *	#define Just_16 to store 16 bits per 32-bit Long when doing
+ *	high-precision integer arithmetic.  Whether this speeds things
+ *	up or slows things down depends on the machine and the number
+ *	being converted.  If long long is available and the name is
+ *	something other than "long long", #define Llong to be the name,
+ *	and if "unsigned Llong" does not work as an unsigned version of
+ *	Llong, #define #ULLong to be the corresponding unsigned type.
+ * #define KR_headers for old-style C function headers.
+ * #define Bad_float_h if your system lacks a float.h or if it does not
+ *	define some or all of DBL_DIG, DBL_MAX_10_EXP, DBL_MAX_EXP,
+ *	FLT_RADIX, FLT_ROUNDS, and DBL_MAX.
+ * #define MALLOC your_malloc, where your_malloc(n) acts like malloc(n)
+ *	if memory is available and otherwise does something you deem
+ *	appropriate.  If MALLOC is undefined, malloc will be invoked
+ *	directly -- and assumed always to succeed.
+ * #define Omit_Private_Memory to omit logic (added Jan. 1998) for making
+ *	memory allocations from a private pool of memory when possible.
+ *	When used, the private pool is PRIVATE_MEM bytes long:  2304 bytes,
+ *	unless #defined to be a different length.  This default length
+ *	suffices to get rid of MALLOC calls except for unusual cases,
+ *	such as decimal-to-binary conversion of a very long string of
+ *	digits.  The longest string dtoa can return is about 751 bytes
+ *	long.  For conversions by strtod of strings of 800 digits and
+ *	all dtoa conversions in single-threaded executions with 8-byte
+ *	pointers, PRIVATE_MEM >= 7400 appears to suffice; with 4-byte
+ *	pointers, PRIVATE_MEM >= 7112 appears adequate.
+ * #define NO_INFNAN_CHECK if you do not wish to have INFNAN_CHECK
+ *	#defined automatically on IEEE systems.  On such systems,
+ *	when INFNAN_CHECK is #defined, strtod checks
+ *	for Infinity and NaN (case insensitively).  On some systems
+ *	(e.g., some HP systems), it may be necessary to #define NAN_WORD0
+ *	appropriately -- to the most significant word of a quiet NaN.
+ *	(On HP Series 700/800 machines, -DNAN_WORD0=0x7ff40000 works.)
+ *	When INFNAN_CHECK is #defined and No_Hex_NaN is not #defined,
+ *	strtod also accepts (case insensitively) strings of the form
+ *	NaN(x), where x is a string of hexadecimal digits and spaces;
+ *	if there is only one string of hexadecimal digits, it is taken
+ *	for the 52 fraction bits of the resulting NaN; if there are two
+ *	or more strings of hex digits, the first is for the high 20 bits,
+ *	the second and subsequent for the low 32 bits, with intervening
+ *	white space ignored; but if this results in none of the 52
+ *	fraction bits being on (an IEEE Infinity symbol), then NAN_WORD0
+ *	and NAN_WORD1 are used instead.
+ * #define MULTIPLE_THREADS if the system offers preemptively scheduled
+ *	multiple threads.  In this case, you must provide (or suitably
+ *	#define) two locks, acquired by ACQUIRE_DTOA_LOCK(n) and freed
+ *	by FREE_DTOA_LOCK(n) for n = 0 or 1.  (The second lock, accessed
+ *	in pow5mult, ensures lazy evaluation of only one copy of high
+ *	powers of 5; omitting this lock would introduce a small
+ *	probability of wasting memory, but would otherwise be harmless.)
+ *	You must also invoke freedtoa(s) to free the value s returned by
+ *	dtoa.  You may do so whether or not MULTIPLE_THREADS is #defined.
+ * #define NO_IEEE_Scale to disable new (Feb. 1997) logic in strtod that
+ *	avoids underflows on inputs whose result does not underflow.
+ *	If you #define NO_IEEE_Scale on a machine that uses IEEE-format
+ *	floating-point numbers and flushes underflows to zero rather
+ *	than implementing gradual underflow, then you must also #define
+ *	Sudden_Underflow.
+ * #define YES_ALIAS to permit aliasing certain double values with
+ *	arrays of ULongs.  This leads to slightly better code with
+ *	some compilers and was always used prior to 19990916, but it
+ *	is not strictly legal and can cause trouble with aggressively
+ *	optimizing compilers (e.g., gcc 2.95.1 under -O2).
+ * #define USE_LOCALE to use the current locale's decimal_point value.
+ * #define SET_INEXACT if IEEE arithmetic is being used and extra
+ *	computation should be done to set the inexact flag when the
+ *	result is inexact and avoid setting inexact when the result
+ *	is exact.  In this case, dtoa.c must be compiled in
+ *	an environment, perhaps provided by #include "dtoa.c" in a
+ *	suitable wrapper, that defines two functions,
+ *		int get_inexact(void);
+ *		void clear_inexact(void);
+ *	such that get_inexact() returns a nonzero value if the
+ *	inexact bit is already set, and clear_inexact() sets the
+ *	inexact bit to 0.  When SET_INEXACT is #defined, strtod
+ *	also does extra computations to set the underflow and overflow
+ *	flags when appropriate (i.e., when the result is tiny and
+ *	inexact or when it is a numeric value rounded to +-infinity).
+ * #define NO_ERRNO if strtod should not assign errno = ERANGE when
+ *	the result overflows to +-Infinity or underflows to 0.
+ */
+
+#ifndef Long
+#define Long long
+#endif
+#ifndef ULong
+typedef unsigned Long ULong;
+#endif
+
+#ifdef DEBUG
+#include "stdio.h"
+#define Bug(x) {fprintf(stderr, "%s\n", x); exit(1);}
+#endif
+
+#include "stdlib.h"
+#include "string.h"
+
+#ifdef USE_LOCALE
+#include "locale.h"
+#endif
+
+#ifdef MALLOC
+#ifdef KR_headers
+extern char *MALLOC();
+#else
+extern void *MALLOC(size_t);
+#endif
+#else
+#define MALLOC malloc
+#endif
+
+#ifndef Omit_Private_Memory
+#ifndef PRIVATE_MEM
+#define PRIVATE_MEM 2304
+#endif
+#define PRIVATE_mem ((PRIVATE_MEM+sizeof(double)-1)/sizeof(double))
+static double private_mem[PRIVATE_mem], *pmem_next = private_mem;
+#endif
+
+#undef IEEE_Arith
+#undef Avoid_Underflow
+#ifdef IEEE_MC68k
+#define IEEE_Arith
+#endif
+#ifdef IEEE_8087
+#define IEEE_Arith
+#endif
+
+#ifdef IEEE_Arith
+#ifndef NO_INFNAN_CHECK
+#undef INFNAN_CHECK
+#define INFNAN_CHECK
+#endif
+#else
+#undef INFNAN_CHECK
+#endif
+
+#include "errno.h"
+
+#ifdef Bad_float_h
+
+#ifdef IEEE_Arith
+#define DBL_DIG 15
+#define DBL_MAX_10_EXP 308
+#define DBL_MAX_EXP 1024
+#define FLT_RADIX 2
+#endif /*IEEE_Arith*/
+
+#ifdef IBM
+#define DBL_DIG 16
+#define DBL_MAX_10_EXP 75
+#define DBL_MAX_EXP 63
+#define FLT_RADIX 16
+#define DBL_MAX 7.2370055773322621e+75
+#endif
+
+#ifdef VAX
+#define DBL_DIG 16
+#define DBL_MAX_10_EXP 38
+#define DBL_MAX_EXP 127
+#define FLT_RADIX 2
+#define DBL_MAX 1.7014118346046923e+38
+#endif
+
+#ifndef LONG_MAX
+#define LONG_MAX 2147483647
+#endif
+
+#else /* ifndef Bad_float_h */
+#include "float.h"
+#endif /* Bad_float_h */
+
+#ifndef __MATH_H__
+#include "math.h"
+#endif
+
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+#ifndef CONST
+#ifdef KR_headers
+#define CONST /* blank */
+#else
+#define CONST const
+#endif
+#endif
+
+#if defined(IEEE_8087) + defined(IEEE_MC68k) + defined(VAX) + defined(IBM) != 1
+Exactly one of IEEE_8087, IEEE_MC68k, VAX, or IBM should be defined.
+#endif
+
+typedef union { double d; ULong L[2]; } U;
+
+#ifdef YES_ALIAS
+#define dval(x) x
+#ifdef IEEE_8087
+#define word0(x) ((ULong *)&x)[1]
+#define word1(x) ((ULong *)&x)[0]
+#else
+#define word0(x) ((ULong *)&x)[0]
+#define word1(x) ((ULong *)&x)[1]
+#endif
+#else
+#ifdef IEEE_8087
+#define word0(x) ((U*)&x)->L[1]
+#define word1(x) ((U*)&x)->L[0]
+#else
+#define word0(x) ((U*)&x)->L[0]
+#define word1(x) ((U*)&x)->L[1]
+#endif
+#define dval(x) ((U*)&x)->d
+#endif
+
+/* The following definition of Storeinc is appropriate for MIPS processors.
+ * An alternative that might be better on some machines is
+ * #define Storeinc(a,b,c) (*a++ = b << 16 | c & 0xffff)
+ */
+#if defined(IEEE_8087) + defined(VAX)
+#define Storeinc(a,b,c) (((unsigned short *)a)[1] = (unsigned short)b, \
+((unsigned short *)a)[0] = (unsigned short)c, a++)
+#else
+#define Storeinc(a,b,c) (((unsigned short *)a)[0] = (unsigned short)b, \
+((unsigned short *)a)[1] = (unsigned short)c, a++)
+#endif
+
+/* #define P DBL_MANT_DIG */
+/* Ten_pmax = floor(P*log(2)/log(5)) */
+/* Bletch = (highest power of 2 < DBL_MAX_10_EXP) / 16 */
+/* Quick_max = floor((P-1)*log(FLT_RADIX)/log(10) - 1) */
+/* Int_max = floor(P*log(FLT_RADIX)/log(10) - 1) */
+
+#ifdef IEEE_Arith
+#define Exp_shift  20
+#define Exp_shift1 20
+#define Exp_msk1    0x100000
+#define Exp_msk11   0x100000
+#define Exp_mask  0x7ff00000
+#define P 53
+#define Bias 1023
+#define Emin (-1022)
+#define Exp_1  0x3ff00000
+#define Exp_11 0x3ff00000
+#define Ebits 11
+#define Frac_mask  0xfffff
+#define Frac_mask1 0xfffff
+#define Ten_pmax 22
+#define Bletch 0x10
+#define Bndry_mask  0xfffff
+#define Bndry_mask1 0xfffff
+#define LSB 1
+#define Sign_bit 0x80000000
+#define Log2P 1
+#define Tiny0 0
+#define Tiny1 1
+#define Quick_max 14
+#define Int_max 14
+#ifndef NO_IEEE_Scale
+#define Avoid_Underflow
+#ifdef Flush_Denorm	/* debugging option */
+#undef Sudden_Underflow
+#endif
+#endif
+
+#ifndef Flt_Rounds
+#ifdef FLT_ROUNDS
+#define Flt_Rounds FLT_ROUNDS
+#else
+#define Flt_Rounds 1
+#endif
+#endif /*Flt_Rounds*/
+
+#ifdef Honor_FLT_ROUNDS
+#define Rounding rounding
+#undef Check_FLT_ROUNDS
+#define Check_FLT_ROUNDS
+#else
+#define Rounding Flt_Rounds
+#endif
+
+#else /* ifndef IEEE_Arith */
+#undef Check_FLT_ROUNDS
+#undef Honor_FLT_ROUNDS
+#undef SET_INEXACT
+#undef  Sudden_Underflow
+#define Sudden_Underflow
+#ifdef IBM
+#undef Flt_Rounds
+#define Flt_Rounds 0
+#define Exp_shift  24
+#define Exp_shift1 24
+#define Exp_msk1   0x1000000
+#define Exp_msk11  0x1000000
+#define Exp_mask  0x7f000000
+#define P 14
+#define Bias 65
+#define Exp_1  0x41000000
+#define Exp_11 0x41000000
+#define Ebits 8	/* exponent has 7 bits, but 8 is the right value in b2d */
+#define Frac_mask  0xffffff
+#define Frac_mask1 0xffffff
+#define Bletch 4
+#define Ten_pmax 22
+#define Bndry_mask  0xefffff
+#define Bndry_mask1 0xffffff
+#define LSB 1
+#define Sign_bit 0x80000000
+#define Log2P 4
+#define Tiny0 0x100000
+#define Tiny1 0
+#define Quick_max 14
+#define Int_max 15
+#else /* VAX */
+#undef Flt_Rounds
+#define Flt_Rounds 1
+#define Exp_shift  23
+#define Exp_shift1 7
+#define Exp_msk1    0x80
+#define Exp_msk11   0x800000
+#define Exp_mask  0x7f80
+#define P 56
+#define Bias 129
+#define Exp_1  0x40800000
+#define Exp_11 0x4080
+#define Ebits 8
+#define Frac_mask  0x7fffff
+#define Frac_mask1 0xffff007f
+#define Ten_pmax 24
+#define Bletch 2
+#define Bndry_mask  0xffff007f
+#define Bndry_mask1 0xffff007f
+#define LSB 0x10000
+#define Sign_bit 0x8000
+#define Log2P 1
+#define Tiny0 0x80
+#define Tiny1 0
+#define Quick_max 15
+#define Int_max 15
+#endif /* IBM, VAX */
+#endif /* IEEE_Arith */
+
+#ifndef IEEE_Arith
+#define ROUND_BIASED
+#endif
+
+#ifdef RND_PRODQUOT
+#define rounded_product(a,b) a = rnd_prod(a, b)
+#define rounded_quotient(a,b) a = rnd_quot(a, b)
+#ifdef KR_headers
+extern double rnd_prod(), rnd_quot();
+#else
+extern double rnd_prod(double, double), rnd_quot(double, double);
+#endif
+#else
+#define rounded_product(a,b) a *= b
+#define rounded_quotient(a,b) a /= b
+#endif
+
+#define Big0 (Frac_mask1 | Exp_msk1*(DBL_MAX_EXP+Bias-1))
+#define Big1 0xffffffff
+
+#ifndef Pack_32
+#define Pack_32
+#endif
+
+#ifdef KR_headers
+#define FFFFFFFF ((((unsigned long)0xffff)<<16)|(unsigned long)0xffff)
+#else
+#define FFFFFFFF 0xffffffffUL
+#endif
+
+#ifdef NO_LONG_LONG
+#undef ULLong
+#ifdef Just_16
+#undef Pack_32
+/* When Pack_32 is not defined, we store 16 bits per 32-bit Long.
+ * This makes some inner loops simpler and sometimes saves work
+ * during multiplications, but it often seems to make things slightly
+ * slower.  Hence the default is now to store 32 bits per Long.
+ */
+#endif
+#else	/* long long available */
+#ifndef Llong
+#define Llong long long
+#endif
+#ifndef ULLong
+#define ULLong unsigned Llong
+#endif
+#endif /* NO_LONG_LONG */
+
+#ifndef MULTIPLE_THREADS
+#define ACQUIRE_DTOA_LOCK(n)	/*nothing*/
+#define FREE_DTOA_LOCK(n)	/*nothing*/
+#endif
+
+#define Kmax 15
+
+ struct
+Bigint {
+	struct Bigint *next;
+	int k, maxwds, sign, wds;
+	ULong x[1];
+	};
+
+ typedef struct Bigint Bigint;
+
+ static Bigint *freelist[Kmax+1];
+
+ static Bigint *
+Balloc
+#ifdef KR_headers
+	(k) int k;
+#else
+	(int k)
+#endif
+{
+	int x;
+	Bigint *rv;
+#ifndef Omit_Private_Memory
+	size_t len;
+#endif
+
+	ACQUIRE_DTOA_LOCK(0);
+	if ((rv = freelist[k])) {
+		freelist[k] = rv->next;
+		}
+	else {
+		x = 1 << k;
+#ifdef Omit_Private_Memory
+		rv = (Bigint *)MALLOC(sizeof(Bigint) + (x-1)*sizeof(ULong));
+#else
+		len = (sizeof(Bigint) + (x-1)*sizeof(ULong) + sizeof(double) - 1)
+			/sizeof(double);
+		if (pmem_next - private_mem + len <= PRIVATE_mem) {
+			rv = (Bigint*)pmem_next;
+			pmem_next += len;
+			}
+		else
+			rv = (Bigint*)MALLOC(len*sizeof(double));
+#endif
+		rv->k = k;
+		rv->maxwds = x;
+		}
+	FREE_DTOA_LOCK(0);
+	rv->sign = rv->wds = 0;
+	return rv;
+	}
+
+ static void
+Bfree
+#ifdef KR_headers
+	(v) Bigint *v;
+#else
+	(Bigint *v)
+#endif
+{
+	if (v) {
+		ACQUIRE_DTOA_LOCK(0);
+		v->next = freelist[v->k];
+		freelist[v->k] = v;
+		FREE_DTOA_LOCK(0);
+		}
+	}
+
+#define Bcopy(x,y) memcpy((char *)&x->sign, (char *)&y->sign, \
+y->wds*sizeof(Long) + 2*sizeof(int))
+
+ static Bigint *
+multadd
+#ifdef KR_headers
+	(b, m, a) Bigint *b; int m, a;
+#else
+	(Bigint *b, int m, int a)	/* multiply by m and add a */
+#endif
+{
+	int i, wds;
+#ifdef ULLong
+	ULong *x;
+	ULLong carry, y;
+#else
+	ULong carry, *x, y;
+#ifdef Pack_32
+	ULong xi, z;
+#endif
+#endif
+	Bigint *b1;
+
+	wds = b->wds;
+	x = b->x;
+	i = 0;
+	carry = a;
+	do {
+#ifdef ULLong
+		y = *x * (ULLong)m + carry;
+		carry = y >> 32;
+		*x++ = (ULong) y & FFFFFFFF;
+#else
+#ifdef Pack_32
+		xi = *x;
+		y = (xi & 0xffff) * m + carry;
+		z = (xi >> 16) * m + (y >> 16);
+		carry = z >> 16;
+		*x++ = (z << 16) + (y & 0xffff);
+#else
+		y = *x * m + carry;
+		carry = y >> 16;
+		*x++ = y & 0xffff;
+#endif
+#endif
+		}
+		while(++i < wds);
+	if (carry) {
+		if (wds >= b->maxwds) {
+			b1 = Balloc(b->k+1);
+			Bcopy(b1, b);
+			Bfree(b);
+			b = b1;
+			}
+		b->x[wds++] = (ULong) carry;
+		b->wds = wds;
+		}
+	return b;
+	}
+
+ static Bigint *
+s2b
+#ifdef KR_headers
+	(s, nd0, nd, y9) CONST char *s; int nd0, nd; ULong y9;
+#else
+	(CONST char *s, int nd0, int nd, ULong y9)
+#endif
+{
+	Bigint *b;
+	int i, k;
+	Long x, y;
+
+	x = (nd + 8) / 9;
+	for(k = 0, y = 1; x > y; y <<= 1, k++) ;
+#ifdef Pack_32
+	b = Balloc(k);
+	b->x[0] = y9;
+	b->wds = 1;
+#else
+	b = Balloc(k+1);
+	b->x[0] = y9 & 0xffff;
+	b->wds = (b->x[1] = y9 >> 16) ? 2 : 1;
+#endif
+
+	i = 9;
+	if (9 < nd0) {
+		s += 9;
+		do b = multadd(b, 10, *s++ - '0');
+			while(++i < nd0);
+		s++;
+		}
+	else
+		s += 10;
+	for(; i < nd; i++)
+		b = multadd(b, 10, *s++ - '0');
+	return b;
+	}
+
+ static int
+hi0bits
+#ifdef KR_headers
+	(x) register ULong x;
+#else
+	(register ULong x)
+#endif
+{
+	register int k = 0;
+
+	if (!(x & 0xffff0000)) {
+		k = 16;
+		x <<= 16;
+		}
+	if (!(x & 0xff000000)) {
+		k += 8;
+		x <<= 8;
+		}
+	if (!(x & 0xf0000000)) {
+		k += 4;
+		x <<= 4;
+		}
+	if (!(x & 0xc0000000)) {
+		k += 2;
+		x <<= 2;
+		}
+	if (!(x & 0x80000000)) {
+		k++;
+		if (!(x & 0x40000000))
+			return 32;
+		}
+	return k;
+	}
+
+ static int
+lo0bits
+#ifdef KR_headers
+	(y) ULong *y;
+#else
+	(ULong *y)
+#endif
+{
+	register int k;
+	register ULong x = *y;
+
+	if (x & 7) {
+		if (x & 1)
+			return 0;
+		if (x & 2) {
+			*y = x >> 1;
+			return 1;
+			}
+		*y = x >> 2;
+		return 2;
+		}
+	k = 0;
+	if (!(x & 0xffff)) {
+		k = 16;
+		x >>= 16;
+		}
+	if (!(x & 0xff)) {
+		k += 8;
+		x >>= 8;
+		}
+	if (!(x & 0xf)) {
+		k += 4;
+		x >>= 4;
+		}
+	if (!(x & 0x3)) {
+		k += 2;
+		x >>= 2;
+		}
+	if (!(x & 1)) {
+		k++;
+		x >>= 1;
+		if (!x)
+			return 32;
+		}
+	*y = x;
+	return k;
+	}
+
+ static Bigint *
+i2b
+#ifdef KR_headers
+	(i) int i;
+#else
+	(int i)
+#endif
+{
+	Bigint *b;
+
+	b = Balloc(1);
+	b->x[0] = i;
+	b->wds = 1;
+	return b;
+	}
+
+ static Bigint *
+mult
+#ifdef KR_headers
+	(a, b) Bigint *a, *b;
+#else
+	(Bigint *a, Bigint *b)
+#endif
+{
+	Bigint *c;
+	int k, wa, wb, wc;
+	ULong *x, *xa, *xae, *xb, *xbe, *xc, *xc0;
+	ULong y;
+#ifdef ULLong
+	ULLong carry, z;
+#else
+	ULong carry, z;
+#ifdef Pack_32
+	ULong z2;
+#endif
+#endif
+
+	if (a->wds < b->wds) {
+		c = a;
+		a = b;
+		b = c;
+		}
+	k = a->k;
+	wa = a->wds;
+	wb = b->wds;
+	wc = wa + wb;
+	if (wc > a->maxwds)
+		k++;
+	c = Balloc(k);
+	for(x = c->x, xa = x + wc; x < xa; x++)
+		*x = 0;
+	xa = a->x;
+	xae = xa + wa;
+	xb = b->x;
+	xbe = xb + wb;
+	xc0 = c->x;
+#ifdef ULLong
+	for(; xb < xbe; xc0++) {
+		if ((y = *xb++)) {
+			x = xa;
+			xc = xc0;
+			carry = 0;
+			do {
+				z = *x++ * (ULLong)y + *xc + carry;
+				carry = z >> 32;
+				*xc++ = (ULong) z & FFFFFFFF;
+				}
+				while(x < xae);
+			*xc = (ULong) carry;
+			}
+		}
+#else
+#ifdef Pack_32
+	for(; xb < xbe; xb++, xc0++) {
+		if (y = *xb & 0xffff) {
+			x = xa;
+			xc = xc0;
+			carry = 0;
+			do {
+				z = (*x & 0xffff) * y + (*xc & 0xffff) + carry;
+				carry = z >> 16;
+				z2 = (*x++ >> 16) * y + (*xc >> 16) + carry;
+				carry = z2 >> 16;
+				Storeinc(xc, z2, z);
+				}
+				while(x < xae);
+			*xc = carry;
+			}
+		if (y = *xb >> 16) {
+			x = xa;
+			xc = xc0;
+			carry = 0;
+			z2 = *xc;
+			do {
+				z = (*x & 0xffff) * y + (*xc >> 16) + carry;
+				carry = z >> 16;
+				Storeinc(xc, z, z2);
+				z2 = (*x++ >> 16) * y + (*xc & 0xffff) + carry;
+				carry = z2 >> 16;
+				}
+				while(x < xae);
+			*xc = z2;
+			}
+		}
+#else
+	for(; xb < xbe; xc0++) {
+		if (y = *xb++) {
+			x = xa;
+			xc = xc0;
+			carry = 0;
+			do {
+				z = *x++ * y + *xc + carry;
+				carry = z >> 16;
+				*xc++ = z & 0xffff;
+				}
+				while(x < xae);
+			*xc = carry;
+			}
+		}
+#endif
+#endif
+	for(xc0 = c->x, xc = xc0 + wc; wc > 0 && !*--xc; --wc) ;
+	c->wds = wc;
+	return c;
+	}
+
+ static Bigint *p5s;
+
+ static Bigint *
+pow5mult
+#ifdef KR_headers
+	(b, k) Bigint *b; int k;
+#else
+	(Bigint *b, int k)
+#endif
+{
+	Bigint *b1, *p5, *p51;
+	int i;
+	static int p05[3] = { 5, 25, 125 };
+
+	if ((i = k & 3))
+		b = multadd(b, p05[i-1], 0);
+
+	if (!(k >>= 2))
+		return b;
+	if (!(p5 = p5s)) {
+		/* first time */
+#ifdef MULTIPLE_THREADS
+		ACQUIRE_DTOA_LOCK(1);
+		if (!(p5 = p5s)) {
+			p5 = p5s = i2b(625);
+			p5->next = 0;
+			}
+		FREE_DTOA_LOCK(1);
+#else
+		p5 = p5s = i2b(625);
+		p5->next = 0;
+#endif
+		}
+	for(;;) {
+		if (k & 1) {
+			b1 = mult(b, p5);
+			Bfree(b);
+			b = b1;
+			}
+		if (!(k >>= 1))
+			break;
+		if (!(p51 = p5->next)) {
+#ifdef MULTIPLE_THREADS
+			ACQUIRE_DTOA_LOCK(1);
+			if (!(p51 = p5->next)) {
+				p51 = p5->next = mult(p5,p5);
+				p51->next = 0;
+				}
+			FREE_DTOA_LOCK(1);
+#else
+			p51 = p5->next = mult(p5,p5);
+			p51->next = 0;
+#endif
+			}
+		p5 = p51;
+		}
+	return b;
+	}
+
+ static Bigint *
+lshift
+#ifdef KR_headers
+	(b, k) Bigint *b; int k;
+#else
+	(Bigint *b, int k)
+#endif
+{
+	int i, k1, n, n1;
+	Bigint *b1;
+	ULong *x, *x1, *xe, z;
+
+#ifdef Pack_32
+	n = k >> 5;
+#else
+	n = k >> 4;
+#endif
+	k1 = b->k;
+	n1 = n + b->wds + 1;
+	for(i = b->maxwds; n1 > i; i <<= 1)
+		k1++;
+	b1 = Balloc(k1);
+	x1 = b1->x;
+	for(i = 0; i < n; i++)
+		*x1++ = 0;
+	x = b->x;
+	xe = x + b->wds;
+#ifdef Pack_32
+	if (k &= 0x1f) {
+		k1 = 32 - k;
+		z = 0;
+		do {
+			*x1++ = *x << k | z;
+			z = *x++ >> k1;
+			}
+			while(x < xe);
+		if ((*x1 = z))
+			++n1;
+		}
+#else
+	if (k &= 0xf) {
+		k1 = 16 - k;
+		z = 0;
+		do {
+			*x1++ = *x << k  & 0xffff | z;
+			z = *x++ >> k1;
+			}
+			while(x < xe);
+		if (*x1 = z)
+			++n1;
+		}
+#endif
+	else do
+		*x1++ = *x++;
+		while(x < xe);
+	b1->wds = n1 - 1;
+	Bfree(b);
+	return b1;
+	}
+
+ static int
+cmp
+#ifdef KR_headers
+	(a, b) Bigint *a, *b;
+#else
+	(Bigint *a, Bigint *b)
+#endif
+{
+	ULong *xa, *xa0, *xb, *xb0;
+	int i, j;
+
+	i = a->wds;
+	j = b->wds;
+#ifdef DEBUG
+	if (i > 1 && !a->x[i-1])
+		Bug("cmp called with a->x[a->wds-1] == 0");
+	if (j > 1 && !b->x[j-1])
+		Bug("cmp called with b->x[b->wds-1] == 0");
+#endif
+	if (i -= j)
+		return i;
+	xa0 = a->x;
+	xa = xa0 + j;
+	xb0 = b->x;
+	xb = xb0 + j;
+	for(;;) {
+		if (*--xa != *--xb)
+			return *xa < *xb ? -1 : 1;
+		if (xa <= xa0)
+			break;
+		}
+	return 0;
+	}
+
+ static Bigint *
+diff
+#ifdef KR_headers
+	(a, b) Bigint *a, *b;
+#else
+	(Bigint *a, Bigint *b)
+#endif
+{
+	Bigint *c;
+	int i, wa, wb;
+	ULong *xa, *xae, *xb, *xbe, *xc;
+#ifdef ULLong
+	ULLong borrow, y;
+#else
+	ULong borrow, y;
+#ifdef Pack_32
+	ULong z;
+#endif
+#endif
+
+	i = cmp(a,b);
+	if (!i) {
+		c = Balloc(0);
+		c->wds = 1;
+		c->x[0] = 0;
+		return c;
+		}
+	if (i < 0) {
+		c = a;
+		a = b;
+		b = c;
+		i = 1;
+		}
+	else
+		i = 0;
+	c = Balloc(a->k);
+	c->sign = i;
+	wa = a->wds;
+	xa = a->x;
+	xae = xa + wa;
+	wb = b->wds;
+	xb = b->x;
+	xbe = xb + wb;
+	xc = c->x;
+	borrow = 0;
+#ifdef ULLong
+	do {
+		y = (ULLong)*xa++ - *xb++ - borrow;
+		borrow = y >> 32 & (ULong)1;
+		*xc++ = (ULong) y & FFFFFFFF;
+		}
+		while(xb < xbe);
+	while(xa < xae) {
+		y = *xa++ - borrow;
+		borrow = y >> 32 & (ULong)1;
+		*xc++ = (ULong) y & FFFFFFFF;
+		}
+#else
+#ifdef Pack_32
+	do {
+		y = (*xa & 0xffff) - (*xb & 0xffff) - borrow;
+		borrow = (y & 0x10000) >> 16;
+		z = (*xa++ >> 16) - (*xb++ >> 16) - borrow;
+		borrow = (z & 0x10000) >> 16;
+		Storeinc(xc, z, y);
+		}
+		while(xb < xbe);
+	while(xa < xae) {
+		y = (*xa & 0xffff) - borrow;
+		borrow = (y & 0x10000) >> 16;
+		z = (*xa++ >> 16) - borrow;
+		borrow = (z & 0x10000) >> 16;
+		Storeinc(xc, z, y);
+		}
+#else
+	do {
+		y = *xa++ - *xb++ - borrow;
+		borrow = (y & 0x10000) >> 16;
+		*xc++ = y & 0xffff;
+		}
+		while(xb < xbe);
+	while(xa < xae) {
+		y = *xa++ - borrow;
+		borrow = (y & 0x10000) >> 16;
+		*xc++ = y & 0xffff;
+		}
+#endif
+#endif
+	while(!*--xc)
+		wa--;
+	c->wds = wa;
+	return c;
+	}
+
+ static double
+ulp
+#ifdef KR_headers
+	(x) double x;
+#else
+	(double x)
+#endif
+{
+	register Long L;
+	double a;
+
+	L = (word0(x) & Exp_mask) - (P-1)*Exp_msk1;
+#ifndef Avoid_Underflow
+#ifndef Sudden_Underflow
+	if (L > 0) {
+#endif
+#endif
+#ifdef IBM
+		L |= Exp_msk1 >> 4;
+#endif
+		word0(a) = L;
+		word1(a) = 0;
+#ifndef Avoid_Underflow
+#ifndef Sudden_Underflow
+		}
+	else {
+		L = -L >> Exp_shift;
+		if (L < Exp_shift) {
+			word0(a) = 0x80000 >> L;
+			word1(a) = 0;
+			}
+		else {
+			word0(a) = 0;
+			L -= Exp_shift;
+			word1(a) = L >= 31 ? 1 : 1 << 31 - L;
+			}
+		}
+#endif
+#endif
+	return dval(a);
+	}
+
+ static double
+b2d
+#ifdef KR_headers
+	(a, e) Bigint *a; int *e;
+#else
+	(Bigint *a, int *e)
+#endif
+{
+	ULong *xa, *xa0, w, y, z;
+	int k;
+	double d;
+#ifdef VAX
+	ULong d0, d1;
+#else
+#define d0 word0(d)
+#define d1 word1(d)
+#endif
+
+	xa0 = a->x;
+	xa = xa0 + a->wds;
+	y = *--xa;
+#ifdef DEBUG
+	if (!y) Bug("zero y in b2d");
+#endif
+	k = hi0bits(y);
+	*e = 32 - k;
+#ifdef Pack_32
+	if (k < Ebits) {
+		d0 = Exp_1 | y >> (Ebits - k);
+		w = xa > xa0 ? *--xa : 0;
+		d1 = y << ((32-Ebits) + k) | w >> (Ebits - k);
+		goto ret_d;
+		}
+	z = xa > xa0 ? *--xa : 0;
+	if (k -= Ebits) {
+		d0 = Exp_1 | y << k | z >> (32 - k);
+		y = xa > xa0 ? *--xa : 0;
+		d1 = z << k | y >> (32 - k);
+		}
+	else {
+		d0 = Exp_1 | y;
+		d1 = z;
+		}
+#else
+	if (k < Ebits + 16) {
+		z = xa > xa0 ? *--xa : 0;
+		d0 = Exp_1 | y << k - Ebits | z >> Ebits + 16 - k;
+		w = xa > xa0 ? *--xa : 0;
+		y = xa > xa0 ? *--xa : 0;
+		d1 = z << k + 16 - Ebits | w << k - Ebits | y >> 16 + Ebits - k;
+		goto ret_d;
+		}
+	z = xa > xa0 ? *--xa : 0;
+	w = xa > xa0 ? *--xa : 0;
+	k -= Ebits + 16;
+	d0 = Exp_1 | y << k + 16 | z << k | w >> 16 - k;
+	y = xa > xa0 ? *--xa : 0;
+	d1 = w << k + 16 | y << k;
+#endif
+ ret_d:
+#ifdef VAX
+	word0(d) = d0 >> 16 | d0 << 16;
+	word1(d) = d1 >> 16 | d1 << 16;
+#else
+#undef d0
+#undef d1
+#endif
+	return dval(d);
+	}
+
+ static Bigint *
+d2b
+#ifdef KR_headers
+	(d, e, bits) double d; int *e, *bits;
+#else
+	(double d, int *e, int *bits)
+#endif
+{
+	Bigint *b;
+	int de, k;
+	ULong *x, y, z;
+#ifndef Sudden_Underflow
+	int i;
+#endif
+#ifdef VAX
+	ULong d0, d1;
+	d0 = word0(d) >> 16 | word0(d) << 16;
+	d1 = word1(d) >> 16 | word1(d) << 16;
+#else
+#define d0 word0(d)
+#define d1 word1(d)
+#endif
+
+#ifdef Pack_32
+	b = Balloc(1);
+#else
+	b = Balloc(2);
+#endif
+	x = b->x;
+
+	z = d0 & Frac_mask;
+	d0 &= 0x7fffffff;	/* clear sign bit, which we ignore */
+#ifdef Sudden_Underflow
+	de = (int)(d0 >> Exp_shift);
+#ifndef IBM
+	z |= Exp_msk11;
+#endif
+#else
+	if ((de = (int)(d0 >> Exp_shift)))
+		z |= Exp_msk1;
+#endif
+#ifdef Pack_32
+	if ((y = d1)) {
+		if ((k = lo0bits(&y))) {
+			x[0] = y | z << (32 - k);
+			z >>= k;
+			}
+		else
+			x[0] = y;
+#ifndef Sudden_Underflow
+		i =
+#endif
+		    b->wds = (x[1] = z) ? 2 : 1;
+		}
+	else {
+#ifdef DEBUG
+		if (!z)
+			Bug("Zero passed to d2b");
+#endif
+		k = lo0bits(&z);
+		x[0] = z;
+#ifndef Sudden_Underflow
+		i =
+#endif
+		    b->wds = 1;
+		k += 32;
+		}
+#else
+	if (y = d1) {
+		if (k = lo0bits(&y))
+			if (k >= 16) {
+				x[0] = y | z << 32 - k & 0xffff;
+				x[1] = z >> k - 16 & 0xffff;
+				x[2] = z >> k;
+				i = 2;
+				}
+			else {
+				x[0] = y & 0xffff;
+				x[1] = y >> 16 | z << 16 - k & 0xffff;
+				x[2] = z >> k & 0xffff;
+				x[3] = z >> k+16;
+				i = 3;
+				}
+		else {
+			x[0] = y & 0xffff;
+			x[1] = y >> 16;
+			x[2] = z & 0xffff;
+			x[3] = z >> 16;
+			i = 3;
+			}
+		}
+	else {
+#ifdef DEBUG
+		if (!z)
+			Bug("Zero passed to d2b");
+#endif
+		k = lo0bits(&z);
+		if (k >= 16) {
+			x[0] = z;
+			i = 0;
+			}
+		else {
+			x[0] = z & 0xffff;
+			x[1] = z >> 16;
+			i = 1;
+			}
+		k += 32;
+		}
+	while(!x[i])
+		--i;
+	b->wds = i + 1;
+#endif
+#ifndef Sudden_Underflow
+	if (de) {
+#endif
+#ifdef IBM
+		*e = (de - Bias - (P-1) << 2) + k;
+		*bits = 4*P + 8 - k - hi0bits(word0(d) & Frac_mask);
+#else
+		*e = de - Bias - (P-1) + k;
+		*bits = P - k;
+#endif
+#ifndef Sudden_Underflow
+		}
+	else {
+		*e = de - Bias - (P-1) + 1 + k;
+#ifdef Pack_32
+		*bits = 32*i - hi0bits(x[i-1]);
+#else
+		*bits = (i+2)*16 - hi0bits(x[i]);
+#endif
+		}
+#endif
+	return b;
+	}
+#undef d0
+#undef d1
+
+ static double
+ratio
+#ifdef KR_headers
+	(a, b) Bigint *a, *b;
+#else
+	(Bigint *a, Bigint *b)
+#endif
+{
+	double da, db;
+	int k, ka, kb;
+
+	dval(da) = b2d(a, &ka);
+	dval(db) = b2d(b, &kb);
+#ifdef Pack_32
+	k = ka - kb + 32*(a->wds - b->wds);
+#else
+	k = ka - kb + 16*(a->wds - b->wds);
+#endif
+#ifdef IBM
+	if (k > 0) {
+		word0(da) += (k >> 2)*Exp_msk1;
+		if (k &= 3)
+			dval(da) *= 1 << k;
+		}
+	else {
+		k = -k;
+		word0(db) += (k >> 2)*Exp_msk1;
+		if (k &= 3)
+			dval(db) *= 1 << k;
+		}
+#else
+	if (k > 0)
+		word0(da) += k*Exp_msk1;
+	else {
+		k = -k;
+		word0(db) += k*Exp_msk1;
+		}
+#endif
+	return dval(da) / dval(db);
+	}
+
+ static CONST double
+tens[] = {
+		1e0, 1e1, 1e2, 1e3, 1e4, 1e5, 1e6, 1e7, 1e8, 1e9,
+		1e10, 1e11, 1e12, 1e13, 1e14, 1e15, 1e16, 1e17, 1e18, 1e19,
+		1e20, 1e21, 1e22
+#ifdef VAX
+		, 1e23, 1e24
+#endif
+		};
+
+ static CONST double
+#ifdef IEEE_Arith
+bigtens[] = { 1e16, 1e32, 1e64, 1e128, 1e256 };
+static CONST double tinytens[] = { 1e-16, 1e-32, 1e-64, 1e-128,
+#ifdef Avoid_Underflow
+		9007199254740992.*9007199254740992.e-256
+		/* = 2^106 * 1e-53 */
+#else
+		1e-256
+#endif
+		};
+/* The factor of 2^53 in tinytens[4] helps us avoid setting the underflow */
+/* flag unnecessarily.  It leads to a song and dance at the end of strtod. */
+#define Scale_Bit 0x10
+#define n_bigtens 5
+#else
+#ifdef IBM
+bigtens[] = { 1e16, 1e32, 1e64 };
+static CONST double tinytens[] = { 1e-16, 1e-32, 1e-64 };
+#define n_bigtens 3
+#else
+bigtens[] = { 1e16, 1e32 };
+static CONST double tinytens[] = { 1e-16, 1e-32 };
+#define n_bigtens 2
+#endif
+#endif
+
+#ifdef INFNAN_CHECK
+
+#ifndef NAN_WORD0
+#define NAN_WORD0 0x7ff80000
+#endif
+
+#ifndef NAN_WORD1
+#define NAN_WORD1 0
+#endif
+
+ static int
+match
+#ifdef KR_headers
+	(sp, t) char **sp, *t;
+#else
+	(CONST char **sp, CONST char *t)
+#endif
+{
+	int c, d;
+	CONST char *s = *sp;
+
+	while((d = *t++)) {
+		if ((c = *++s) >= 'A' && c <= 'Z')
+			c += 'a' - 'A';
+		if (c != d)
+			return 0;
+		}
+	*sp = s + 1;
+	return 1;
+	}
+
+#ifndef No_Hex_NaN
+ static void
+hexnan
+#ifdef KR_headers
+	(rvp, sp) double *rvp; CONST char **sp;
+#else
+	(double *rvp, CONST char **sp)
+#endif
+{
+	ULong c, x[2];
+	CONST char *s;
+	int havedig, udx0, xshift;
+
+	x[0] = x[1] = 0;
+	havedig = xshift = 0;
+	udx0 = 1;
+	s = *sp;
+	/* allow optional initial 0x or 0X */
+	while((c = *(CONST unsigned char*)(s+1)) && c <= ' ')
+		++s;
+	if (s[1] == '0' && (s[2] == 'x' || s[2] == 'X'))
+		s += 2;
+	while((c = *(CONST unsigned char*)++s)) {
+		if (c >= '0' && c <= '9')
+			c -= '0';
+		else if (c >= 'a' && c <= 'f')
+			c += 10 - 'a';
+		else if (c >= 'A' && c <= 'F')
+			c += 10 - 'A';
+		else if (c <= ' ') {
+			if (udx0 && havedig) {
+				udx0 = 0;
+				xshift = 1;
+				}
+			continue;
+			}
+#ifdef GDTOA_NON_PEDANTIC_NANCHECK
+		else if (/*(*/ c == ')' && havedig) {
+			*sp = s + 1;
+			break;
+			}
+		else
+			return;	/* invalid form: don't change *sp */
+#else
+		else {
+			do {
+				if (/*(*/ c == ')') {
+					*sp = s + 1;
+					break;
+					}
+				} while((c = *++s));
+			break;
+			}
+#endif
+		havedig = 1;
+		if (xshift) {
+			xshift = 0;
+			x[0] = x[1];
+			x[1] = 0;
+			}
+		if (udx0)
+			x[0] = (x[0] << 4) | (x[1] >> 28);
+		x[1] = (x[1] << 4) | c;
+		}
+	if ((x[0] &= 0xfffff) || x[1]) {
+		word0(*rvp) = Exp_mask | x[0];
+		word1(*rvp) = x[1];
+		}
+	}
+#endif /*No_Hex_NaN*/
+#endif /* INFNAN_CHECK */
+
+ static double
+_strtod
+#ifdef KR_headers
+	(s00, se) CONST char *s00; char **se;
+#else
+	(CONST char *s00, char **se)
+#endif
+{
+#ifdef Avoid_Underflow
+	int scale;
+#endif
+	int bb2, bb5, bbe, bd2, bd5, bbbits, bs2, c, dsign,
+		 e, e1, esign, i, j, k, nd, nd0, nf, nz, nz0, sign;
+	CONST char *s, *s0, *s1;
+	double aadj, aadj1, adj, rv, rv0;
+	Long L;
+	ULong y, z;
+	Bigint *bb, *bb1, *bd, *bd0, *bs, *delta;
+#ifdef SET_INEXACT
+	int inexact, oldinexact;
+#endif
+#ifdef Honor_FLT_ROUNDS
+	int rounding;
+#endif
+#ifdef USE_LOCALE
+	CONST char *s2;
+#endif
+
+#ifdef __GNUC__
+    delta = bb = bd = bs = 0;
+#endif
+
+	sign = nz0 = nz = 0;
+	dval(rv) = 0.;
+	for(s = s00;;s++) switch(*s) {
+		case '-':
+			sign = 1;
+			/* no break */
+		case '+':
+			if (*++s)
+				goto break2;
+			/* no break */
+		case 0:
+			goto ret0;
+		case '\t':
+		case '\n':
+		case '\v':
+		case '\f':
+		case '\r':
+		case ' ':
+			continue;
+		default:
+			goto break2;
+		}
+ break2:
+	if (*s == '0') {
+		nz0 = 1;
+		while(*++s == '0') ;
+		if (!*s)
+			goto ret;
+		}
+	s0 = s;
+	y = z = 0;
+	for(nd = nf = 0; (c = *s) >= '0' && c <= '9'; nd++, s++)
+		if (nd < 9)
+			y = 10*y + c - '0';
+		else if (nd < 16)
+			z = 10*z + c - '0';
+	nd0 = nd;
+#ifdef USE_LOCALE
+	s1 = localeconv()->decimal_point;
+	if (c == *s1) {
+		c = '.';
+		if (*++s1) {
+			s2 = s;
+			for(;;) {
+				if (*++s2 != *s1) {
+					c = 0;
+					break;
+					}
+				if (!*++s1) {
+					s = s2;
+					break;
+					}
+				}
+			}
+		}
+#endif
+	if (c == '.') {
+		c = *++s;
+		if (!nd) {
+			for(; c == '0'; c = *++s)
+				nz++;
+			if (c > '0' && c <= '9') {
+				s0 = s;
+				nf += nz;
+				nz = 0;
+				goto have_dig;
+				}
+			goto dig_done;
+			}
+		for(; c >= '0' && c <= '9'; c = *++s) {
+ have_dig:
+			nz++;
+			if (c -= '0') {
+				nf += nz;
+				for(i = 1; i < nz; i++)
+					if (nd++ < 9)
+						y *= 10;
+					else if (nd <= DBL_DIG + 1)
+						z *= 10;
+				if (nd++ < 9)
+					y = 10*y + c;
+				else if (nd <= DBL_DIG + 1)
+					z = 10*z + c;
+				nz = 0;
+				}
+			}
+		}
+ dig_done:
+	e = 0;
+	if (c == 'e' || c == 'E') {
+		if (!nd && !nz && !nz0) {
+			goto ret0;
+			}
+		s00 = s;
+		esign = 0;
+		switch(c = *++s) {
+			case '-':
+				esign = 1;
+			case '+':
+				c = *++s;
+			}
+		if (c >= '0' && c <= '9') {
+			while(c == '0')
+				c = *++s;
+			if (c > '0' && c <= '9') {
+				L = c - '0';
+				s1 = s;
+				while((c = *++s) >= '0' && c <= '9')
+					L = 10*L + c - '0';
+				if (s - s1 > 8 || L > 19999)
+					/* Avoid confusion from exponents
+					 * so large that e might overflow.
+					 */
+					e = 19999; /* safe for 16 bit ints */
+				else
+					e = (int)L;
+				if (esign)
+					e = -e;
+				}
+			else
+				e = 0;
+			}
+		else
+			s = s00;
+		}
+	if (!nd) {
+		if (!nz && !nz0) {
+#ifdef INFNAN_CHECK
+			/* Check for Nan and Infinity */
+			switch(c) {
+			  case 'i':
+			  case 'I':
+				if (match(&s,"nf")) {
+					--s;
+					if (!match(&s,"inity"))
+						++s;
+					word0(rv) = 0x7ff00000;
+					word1(rv) = 0;
+					goto ret;
+					}
+				break;
+			  case 'n':
+			  case 'N':
+				if (match(&s, "an")) {
+					word0(rv) = NAN_WORD0;
+					word1(rv) = NAN_WORD1;
+#ifndef No_Hex_NaN
+					if (*s == '(') /*)*/
+						hexnan(&rv, &s);
+#endif
+					goto ret;
+					}
+			  }
+#endif /* INFNAN_CHECK */
+ ret0:
+			s = s00;
+			sign = 0;
+			}
+		goto ret;
+		}
+	e1 = e -= nf;
+
+	/* Now we have nd0 digits, starting at s0, followed by a
+	 * decimal point, followed by nd-nd0 digits.  The number we're
+	 * after is the integer represented by those digits times
+	 * 10**e */
+
+	if (!nd0)
+		nd0 = nd;
+	k = nd < DBL_DIG + 1 ? nd : DBL_DIG + 1;
+	dval(rv) = y;
+	if (k > 9) {
+#ifdef SET_INEXACT
+		if (k > DBL_DIG)
+			oldinexact = get_inexact();
+#endif
+		dval(rv) = tens[k - 9] * dval(rv) + z;
+		}
+	bd0 = 0;
+	if (nd <= DBL_DIG
+#ifndef RND_PRODQUOT
+#ifndef Honor_FLT_ROUNDS
+		&& Flt_Rounds == 1
+#endif
+#endif
+			) {
+		if (!e)
+			goto ret;
+		if (e > 0) {
+			if (e <= Ten_pmax) {
+#ifdef VAX
+				goto vax_ovfl_check;
+#else
+#ifdef Honor_FLT_ROUNDS
+				/* round correctly FLT_ROUNDS = 2 or 3 */
+				if (sign) {
+					rv = -rv;
+					sign = 0;
+					}
+#endif
+				/* rv = */ rounded_product(dval(rv), tens[e]);
+				goto ret;
+#endif
+				}
+			i = DBL_DIG - nd;
+			if (e <= Ten_pmax + i) {
+				/* A fancier test would sometimes let us do
+				 * this for larger i values.
+				 */
+#ifdef Honor_FLT_ROUNDS
+				/* round correctly FLT_ROUNDS = 2 or 3 */
+				if (sign) {
+					rv = -rv;
+					sign = 0;
+					}
+#endif
+				e -= i;
+				dval(rv) *= tens[i];
+#ifdef VAX
+				/* VAX exponent range is so narrow we must
+				 * worry about overflow here...
+				 */
+ vax_ovfl_check:
+				word0(rv) -= P*Exp_msk1;
+				/* rv = */ rounded_product(dval(rv), tens[e]);
+				if ((word0(rv) & Exp_mask)
+				 > Exp_msk1*(DBL_MAX_EXP+Bias-1-P))
+					goto ovfl;
+				word0(rv) += P*Exp_msk1;
+#else
+				/* rv = */ rounded_product(dval(rv), tens[e]);
+#endif
+				goto ret;
+				}
+			}
+#ifndef Inaccurate_Divide
+		else if (e >= -Ten_pmax) {
+#ifdef Honor_FLT_ROUNDS
+			/* round correctly FLT_ROUNDS = 2 or 3 */
+			if (sign) {
+				rv = -rv;
+				sign = 0;
+				}
+#endif
+			/* rv = */ rounded_quotient(dval(rv), tens[-e]);
+			goto ret;
+			}
+#endif
+		}
+	e1 += nd - k;
+
+#ifdef IEEE_Arith
+#ifdef SET_INEXACT
+	inexact = 1;
+	if (k <= DBL_DIG)
+		oldinexact = get_inexact();
+#endif
+#ifdef Avoid_Underflow
+	scale = 0;
+#endif
+#ifdef Honor_FLT_ROUNDS
+	if ((rounding = Flt_Rounds) >= 2) {
+		if (sign)
+			rounding = rounding == 2 ? 0 : 2;
+		else
+			if (rounding != 2)
+				rounding = 0;
+		}
+#endif
+#endif /*IEEE_Arith*/
+
+	/* Get starting approximation = rv * 10**e1 */
+
+	if (e1 > 0) {
+		if ((i = e1 & 15))
+			dval(rv) *= tens[i];
+		if (e1 &= ~15) {
+			if (e1 > DBL_MAX_10_EXP) {
+ ovfl:
+#ifndef NO_ERRNO
+				errno = ERANGE;
+#endif
+				/* Can't trust HUGE_VAL */
+#ifdef IEEE_Arith
+#ifdef Honor_FLT_ROUNDS
+				switch(rounding) {
+				  case 0: /* toward 0 */
+				  case 3: /* toward -infinity */
+					word0(rv) = Big0;
+					word1(rv) = Big1;
+					break;
+				  default:
+					word0(rv) = Exp_mask;
+					word1(rv) = 0;
+				  }
+#else /*Honor_FLT_ROUNDS*/
+				word0(rv) = Exp_mask;
+				word1(rv) = 0;
+#endif /*Honor_FLT_ROUNDS*/
+#ifdef SET_INEXACT
+				/* set overflow bit */
+				dval(rv0) = 1e300;
+				dval(rv0) *= dval(rv0);
+#endif
+#else /*IEEE_Arith*/
+				word0(rv) = Big0;
+				word1(rv) = Big1;
+#endif /*IEEE_Arith*/
+				if (bd0)
+					goto retfree;
+				goto ret;
+				}
+			e1 >>= 4;
+			for(j = 0; e1 > 1; j++, e1 >>= 1)
+				if (e1 & 1)
+					dval(rv) *= bigtens[j];
+		/* The last multiplication could overflow. */
+			word0(rv) -= P*Exp_msk1;
+			dval(rv) *= bigtens[j];
+			if ((z = word0(rv) & Exp_mask)
+			 > Exp_msk1*(DBL_MAX_EXP+Bias-P))
+				goto ovfl;
+			if (z > Exp_msk1*(DBL_MAX_EXP+Bias-1-P)) {
+				/* set to largest number */
+				/* (Can't trust DBL_MAX) */
+				word0(rv) = Big0;
+				word1(rv) = Big1;
+				}
+			else
+				word0(rv) += P*Exp_msk1;
+			}
+		}
+	else if (e1 < 0) {
+		e1 = -e1;
+		if ((i = e1 & 15))
+			dval(rv) /= tens[i];
+		if (e1 >>= 4) {
+			if (e1 >= 1 << n_bigtens)
+				goto undfl;
+#ifdef Avoid_Underflow
+			if (e1 & Scale_Bit)
+				scale = 2*P;
+			for(j = 0; e1 > 0; j++, e1 >>= 1)
+				if (e1 & 1)
+					dval(rv) *= tinytens[j];
+			if (scale && (j = 2*P + 1 - ((word0(rv) & Exp_mask)
+						>> Exp_shift)) > 0) {
+				/* scaled rv is denormal; zap j low bits */
+				if (j >= 32) {
+					word1(rv) = 0;
+					if (j >= 53)
+					 word0(rv) = (P+2)*Exp_msk1;
+					else
+					 word0(rv) &= 0xffffffff << (j-32);
+					}
+				else
+					word1(rv) &= 0xffffffff << j;
+				}
+#else
+			for(j = 0; e1 > 1; j++, e1 >>= 1)
+				if (e1 & 1)
+					dval(rv) *= tinytens[j];
+			/* The last multiplication could underflow. */
+			dval(rv0) = dval(rv);
+			dval(rv) *= tinytens[j];
+			if (!dval(rv)) {
+				dval(rv) = 2.*dval(rv0);
+				dval(rv) *= tinytens[j];
+#endif
+				if (!dval(rv)) {
+ undfl:
+					dval(rv) = 0.;
+#ifndef NO_ERRNO
+					errno = ERANGE;
+#endif
+					if (bd0)
+						goto retfree;
+					goto ret;
+					}
+#ifndef Avoid_Underflow
+				word0(rv) = Tiny0;
+				word1(rv) = Tiny1;
+				/* The refinement below will clean
+				 * this approximation up.
+				 */
+				}
+#endif
+			}
+		}
+
+	/* Now the hard part -- adjusting rv to the correct value.*/
+
+	/* Put digits into bd: true value = bd * 10^e */
+
+	bd0 = s2b(s0, nd0, nd, y);
+
+	for(;;) {
+		bd = Balloc(bd0->k);
+		Bcopy(bd, bd0);
+		bb = d2b(dval(rv), &bbe, &bbbits);	/* rv = bb * 2^bbe */
+		bs = i2b(1);
+
+		if (e >= 0) {
+			bb2 = bb5 = 0;
+			bd2 = bd5 = e;
+			}
+		else {
+			bb2 = bb5 = -e;
+			bd2 = bd5 = 0;
+			}
+		if (bbe >= 0)
+			bb2 += bbe;
+		else
+			bd2 -= bbe;
+		bs2 = bb2;
+#ifdef Honor_FLT_ROUNDS
+		if (rounding != 1)
+			bs2++;
+#endif
+#ifdef Avoid_Underflow
+		j = bbe - scale;
+		i = j + bbbits - 1;	/* logb(rv) */
+		if (i < Emin)	/* denormal */
+			j += P - Emin;
+		else
+			j = P + 1 - bbbits;
+#else /*Avoid_Underflow*/
+#ifdef Sudden_Underflow
+#ifdef IBM
+		j = 1 + 4*P - 3 - bbbits + ((bbe + bbbits - 1) & 3);
+#else
+		j = P + 1 - bbbits;
+#endif
+#else /*Sudden_Underflow*/
+		j = bbe;
+		i = j + bbbits - 1;	/* logb(rv) */
+		if (i < Emin)	/* denormal */
+			j += P - Emin;
+		else
+			j = P + 1 - bbbits;
+#endif /*Sudden_Underflow*/
+#endif /*Avoid_Underflow*/
+		bb2 += j;
+		bd2 += j;
+#ifdef Avoid_Underflow
+		bd2 += scale;
+#endif
+		i = bb2 < bd2 ? bb2 : bd2;
+		if (i > bs2)
+			i = bs2;
+		if (i > 0) {
+			bb2 -= i;
+			bd2 -= i;
+			bs2 -= i;
+			}
+		if (bb5 > 0) {
+			bs = pow5mult(bs, bb5);
+			bb1 = mult(bs, bb);
+			Bfree(bb);
+			bb = bb1;
+			}
+		if (bb2 > 0)
+			bb = lshift(bb, bb2);
+		if (bd5 > 0)
+			bd = pow5mult(bd, bd5);
+		if (bd2 > 0)
+			bd = lshift(bd, bd2);
+		if (bs2 > 0)
+			bs = lshift(bs, bs2);
+		delta = diff(bb, bd);
+		dsign = delta->sign;
+		delta->sign = 0;
+		i = cmp(delta, bs);
+#ifdef Honor_FLT_ROUNDS
+		if (rounding != 1) {
+			if (i < 0) {
+				/* Error is less than an ulp */
+				if (!delta->x[0] && delta->wds <= 1) {
+					/* exact */
+#ifdef SET_INEXACT
+					inexact = 0;
+#endif
+					break;
+					}
+				if (rounding) {
+					if (dsign) {
+						adj = 1.;
+						goto apply_adj;
+						}
+					}
+				else if (!dsign) {
+					adj = -1.;
+					if (!word1(rv)
+					 && !(word0(rv) & Frac_mask)) {
+						y = word0(rv) & Exp_mask;
+#ifdef Avoid_Underflow
+						if (!scale || y > 2*P*Exp_msk1)
+#else
+						if (y)
+#endif
+						  {
+						  delta = lshift(delta,Log2P);
+						  if (cmp(delta, bs) <= 0)
+							adj = -0.5;
+						  }
+						}
+ apply_adj:
+#ifdef Avoid_Underflow
+					if (scale && (y = word0(rv) & Exp_mask)
+						<= 2*P*Exp_msk1)
+					  word0(adj) += (2*P+1)*Exp_msk1 - y;
+#else
+#ifdef Sudden_Underflow
+					if ((word0(rv) & Exp_mask) <=
+							P*Exp_msk1) {
+						word0(rv) += P*Exp_msk1;
+						dval(rv) += adj*ulp(dval(rv));
+						word0(rv) -= P*Exp_msk1;
+						}
+					else
+#endif /*Sudden_Underflow*/
+#endif /*Avoid_Underflow*/
+					dval(rv) += adj*ulp(dval(rv));
+					}
+				break;
+				}
+			adj = ratio(delta, bs);
+			if (adj < 1.)
+				adj = 1.;
+			if (adj <= 0x7ffffffe) {
+				/* adj = rounding ? ceil(adj) : floor(adj); */
+				y = adj;
+				if (y != adj) {
+					if (!((rounding>>1) ^ dsign))
+						y++;
+					adj = y;
+					}
+				}
+#ifdef Avoid_Underflow
+			if (scale && (y = word0(rv) & Exp_mask) <= 2*P*Exp_msk1)
+				word0(adj) += (2*P+1)*Exp_msk1 - y;
+#else
+#ifdef Sudden_Underflow
+			if ((word0(rv) & Exp_mask) <= P*Exp_msk1) {
+				word0(rv) += P*Exp_msk1;
+				adj *= ulp(dval(rv));
+				if (dsign)
+					dval(rv) += adj;
+				else
+					dval(rv) -= adj;
+				word0(rv) -= P*Exp_msk1;
+				goto cont;
+				}
+#endif /*Sudden_Underflow*/
+#endif /*Avoid_Underflow*/
+			adj *= ulp(dval(rv));
+			if (dsign)
+				dval(rv) += adj;
+			else
+				dval(rv) -= adj;
+			goto cont;
+			}
+#endif /*Honor_FLT_ROUNDS*/
+
+		if (i < 0) {
+			/* Error is less than half an ulp -- check for
+			 * special case of mantissa a power of two.
+			 */
+			if (dsign || word1(rv) || word0(rv) & Bndry_mask
+#ifdef IEEE_Arith
+#ifdef Avoid_Underflow
+			 || (word0(rv) & Exp_mask) <= (2*P+1)*Exp_msk1
+#else
+			 || (word0(rv) & Exp_mask) <= Exp_msk1
+#endif
+#endif
+				) {
+#ifdef SET_INEXACT
+				if (!delta->x[0] && delta->wds <= 1)
+					inexact = 0;
+#endif
+				break;
+				}
+			if (!delta->x[0] && delta->wds <= 1) {
+				/* exact result */
+#ifdef SET_INEXACT
+				inexact = 0;
+#endif
+				break;
+				}
+			delta = lshift(delta,Log2P);
+			if (cmp(delta, bs) > 0)
+				goto drop_down;
+			break;
+			}
+		if (i == 0) {
+			/* exactly half-way between */
+			if (dsign) {
+				if ((word0(rv) & Bndry_mask1) == Bndry_mask1
+				 &&  word1(rv) == (
+#ifdef Avoid_Underflow
+			(scale && (y = word0(rv) & Exp_mask) <= 2*P*Exp_msk1)
+		? (0xffffffff & (0xffffffff << (2*P+1-(y>>Exp_shift)))) :
+#endif
+						   0xffffffff)) {
+					/*boundary case -- increment exponent*/
+					word0(rv) = (word0(rv) & Exp_mask)
+						+ Exp_msk1
+#ifdef IBM
+						| Exp_msk1 >> 4
+#endif
+						;
+					word1(rv) = 0;
+#ifdef Avoid_Underflow
+					dsign = 0;
+#endif
+					break;
+					}
+				}
+			else if (!(word0(rv) & Bndry_mask) && !word1(rv)) {
+ drop_down:
+				/* boundary case -- decrement exponent */
+#ifdef Sudden_Underflow /*{{*/
+				L = word0(rv) & Exp_mask;
+#ifdef IBM
+				if (L <  Exp_msk1)
+#else
+#ifdef Avoid_Underflow
+				if (L <= (scale ? (2*P+1)*Exp_msk1 : Exp_msk1))
+#else
+				if (L <= Exp_msk1)
+#endif /*Avoid_Underflow*/
+#endif /*IBM*/
+					goto undfl;
+				L -= Exp_msk1;
+#else /*Sudden_Underflow}{*/
+#ifdef Avoid_Underflow
+				if (scale) {
+					L = word0(rv) & Exp_mask;
+					if (L <= (2*P+1)*Exp_msk1) {
+						if (L > (P+2)*Exp_msk1)
+							/* round even ==> */
+							/* accept rv */
+							break;
+						/* rv = smallest denormal */
+						goto undfl;
+						}
+					}
+#endif /*Avoid_Underflow*/
+				L = (word0(rv) & Exp_mask) - Exp_msk1;
+#endif /*Sudden_Underflow}}*/
+				word0(rv) = L | Bndry_mask1;
+				word1(rv) = 0xffffffff;
+#ifdef IBM
+				goto cont;
+#else
+				break;
+#endif
+				}
+#ifndef ROUND_BIASED
+			if (!(word1(rv) & LSB))
+				break;
+#endif
+			if (dsign)
+				dval(rv) += ulp(dval(rv));
+#ifndef ROUND_BIASED
+			else {
+				dval(rv) -= ulp(dval(rv));
+#ifndef Sudden_Underflow
+				if (!dval(rv))
+					goto undfl;
+#endif
+				}
+#ifdef Avoid_Underflow
+			dsign = 1 - dsign;
+#endif
+#endif
+			break;
+			}
+		if ((aadj = ratio(delta, bs)) <= 2.) {
+			if (dsign)
+				aadj = aadj1 = 1.;
+			else if (word1(rv) || word0(rv) & Bndry_mask) {
+#ifndef Sudden_Underflow
+				if (word1(rv) == Tiny1 && !word0(rv))
+					goto undfl;
+#endif
+				aadj = 1.;
+				aadj1 = -1.;
+				}
+			else {
+				/* special case -- power of FLT_RADIX to be */
+				/* rounded down... */
+
+				if (aadj < 2./FLT_RADIX)
+					aadj = 1./FLT_RADIX;
+				else
+					aadj *= 0.5;
+				aadj1 = -aadj;
+				}
+			}
+		else {
+			aadj *= 0.5;
+			aadj1 = dsign ? aadj : -aadj;
+#ifdef Check_FLT_ROUNDS
+			switch(Rounding) {
+				case 2: /* towards +infinity */
+					aadj1 -= 0.5;
+					break;
+				case 0: /* towards 0 */
+				case 3: /* towards -infinity */
+					aadj1 += 0.5;
+				}
+#else
+			if (Flt_Rounds == 0)
+				aadj1 += 0.5;
+#endif /*Check_FLT_ROUNDS*/
+			}
+		y = word0(rv) & Exp_mask;
+
+		/* Check for overflow */
+
+		if (y == Exp_msk1*(DBL_MAX_EXP+Bias-1)) {
+			dval(rv0) = dval(rv);
+			word0(rv) -= P*Exp_msk1;
+			adj = aadj1 * ulp(dval(rv));
+			dval(rv) += adj;
+			if ((word0(rv) & Exp_mask) >=
+					Exp_msk1*(DBL_MAX_EXP+Bias-P)) {
+				if (word0(rv0) == Big0 && word1(rv0) == Big1)
+					goto ovfl;
+				word0(rv) = Big0;
+				word1(rv) = Big1;
+				goto cont;
+				}
+			else
+				word0(rv) += P*Exp_msk1;
+			}
+		else {
+#ifdef Avoid_Underflow
+			if (scale && y <= 2*P*Exp_msk1) {
+				if (aadj <= 0x7fffffff) {
+					if ((z = (ULong) aadj) <= 0)
+						z = 1;
+					aadj = z;
+					aadj1 = dsign ? aadj : -aadj;
+					}
+				word0(aadj1) += (2*P+1)*Exp_msk1 - y;
+				}
+			adj = aadj1 * ulp(dval(rv));
+			dval(rv) += adj;
+#else
+#ifdef Sudden_Underflow
+			if ((word0(rv) & Exp_mask) <= P*Exp_msk1) {
+				dval(rv0) = dval(rv);
+				word0(rv) += P*Exp_msk1;
+				adj = aadj1 * ulp(dval(rv));
+				dval(rv) += adj;
+#ifdef IBM
+				if ((word0(rv) & Exp_mask) <  P*Exp_msk1)
+#else
+				if ((word0(rv) & Exp_mask) <= P*Exp_msk1)
+#endif
+					{
+					if (word0(rv0) == Tiny0
+					 && word1(rv0) == Tiny1)
+						goto undfl;
+					word0(rv) = Tiny0;
+					word1(rv) = Tiny1;
+					goto cont;
+					}
+				else
+					word0(rv) -= P*Exp_msk1;
+				}
+			else {
+				adj = aadj1 * ulp(dval(rv));
+				dval(rv) += adj;
+				}
+#else /*Sudden_Underflow*/
+			/* Compute adj so that the IEEE rounding rules will
+			 * correctly round rv + adj in some half-way cases.
+			 * If rv * ulp(rv) is denormalized (i.e.,
+			 * y <= (P-1)*Exp_msk1), we must adjust aadj to avoid
+			 * trouble from bits lost to denormalization;
+			 * example: 1.2e-307 .
+			 */
+			if (y <= (P-1)*Exp_msk1 && aadj > 1.) {
+				aadj1 = (double)(int)(aadj + 0.5);
+				if (!dsign)
+					aadj1 = -aadj1;
+				}
+			adj = aadj1 * ulp(dval(rv));
+			dval(rv) += adj;
+#endif /*Sudden_Underflow*/
+#endif /*Avoid_Underflow*/
+			}
+		z = word0(rv) & Exp_mask;
+#ifndef SET_INEXACT
+#ifdef Avoid_Underflow
+		if (!scale)
+#endif
+		if (y == z) {
+			/* Can we stop now? */
+			L = (Long)aadj;
+			aadj -= L;
+			/* The tolerances below are conservative. */
+			if (dsign || word1(rv) || word0(rv) & Bndry_mask) {
+				if (aadj < .4999999 || aadj > .5000001)
+					break;
+				}
+			else if (aadj < .4999999/FLT_RADIX)
+				break;
+			}
+#endif
+ cont:
+		Bfree(bb);
+		Bfree(bd);
+		Bfree(bs);
+		Bfree(delta);
+		}
+#ifdef SET_INEXACT
+	if (inexact) {
+		if (!oldinexact) {
+			word0(rv0) = Exp_1 + (70 << Exp_shift);
+			word1(rv0) = 0;
+			dval(rv0) += 1.;
+			}
+		}
+	else if (!oldinexact)
+		clear_inexact();
+#endif
+#ifdef Avoid_Underflow
+	if (scale) {
+		word0(rv0) = Exp_1 - 2*P*Exp_msk1;
+		word1(rv0) = 0;
+		dval(rv) *= dval(rv0);
+#ifndef NO_ERRNO
+		/* try to avoid the bug of testing an 8087 register value */
+		if (word0(rv) == 0 && word1(rv) == 0)
+			errno = ERANGE;
+#endif
+		}
+#endif /* Avoid_Underflow */
+#ifdef SET_INEXACT
+	if (inexact && !(word0(rv) & Exp_mask)) {
+		/* set underflow bit */
+		dval(rv0) = 1e-300;
+		dval(rv0) *= dval(rv0);
+		}
+#endif
+ retfree:
+	Bfree(bb);
+	Bfree(bd);
+	Bfree(bs);
+	Bfree(bd0);
+	Bfree(delta);
+ ret:
+	if (se)
+		*se = (char *)s;
+	return sign ? -dval(rv) : dval(rv);
+	}
+
+ static int
+quorem
+#ifdef KR_headers
+	(b, S) Bigint *b, *S;
+#else
+	(Bigint *b, Bigint *S)
+#endif
+{
+	int n;
+	ULong *bx, *bxe, q, *sx, *sxe;
+#ifdef ULLong
+	ULLong borrow, carry, y, ys;
+#else
+	ULong borrow, carry, y, ys;
+#ifdef Pack_32
+	ULong si, z, zs;
+#endif
+#endif
+
+	n = S->wds;
+#ifdef DEBUG
+	/*debug*/ if (b->wds > n)
+	/*debug*/	Bug("oversize b in quorem");
+#endif
+	if (b->wds < n)
+		return 0;
+	sx = S->x;
+	sxe = sx + --n;
+	bx = b->x;
+	bxe = bx + n;
+	q = *bxe / (*sxe + 1);	/* ensure q <= true quotient */
+#ifdef DEBUG
+	/*debug*/ if (q > 9)
+	/*debug*/	Bug("oversized quotient in quorem");
+#endif
+	if (q) {
+		borrow = 0;
+		carry = 0;
+		do {
+#ifdef ULLong
+			ys = *sx++ * (ULLong)q + carry;
+			carry = ys >> 32;
+			y = *bx - (ys & FFFFFFFF) - borrow;
+			borrow = y >> 32 & (ULong)1;
+			*bx++ = (ULong) y & FFFFFFFF;
+#else
+#ifdef Pack_32
+			si = *sx++;
+			ys = (si & 0xffff) * q + carry;
+			zs = (si >> 16) * q + (ys >> 16);
+			carry = zs >> 16;
+			y = (*bx & 0xffff) - (ys & 0xffff) - borrow;
+			borrow = (y & 0x10000) >> 16;
+			z = (*bx >> 16) - (zs & 0xffff) - borrow;
+			borrow = (z & 0x10000) >> 16;
+			Storeinc(bx, z, y);
+#else
+			ys = *sx++ * q + carry;
+			carry = ys >> 16;
+			y = *bx - (ys & 0xffff) - borrow;
+			borrow = (y & 0x10000) >> 16;
+			*bx++ = y & 0xffff;
+#endif
+#endif
+			}
+			while(sx <= sxe);
+		if (!*bxe) {
+			bx = b->x;
+			while(--bxe > bx && !*bxe)
+				--n;
+			b->wds = n;
+			}
+		}
+	if (cmp(b, S) >= 0) {
+		q++;
+		borrow = 0;
+		carry = 0;
+		bx = b->x;
+		sx = S->x;
+		do {
+#ifdef ULLong
+			ys = *sx++ + carry;
+			carry = ys >> 32;
+			y = *bx - (ys & FFFFFFFF) - borrow;
+			borrow = y >> 32 & (ULong)1;
+			*bx++ = (ULong) y & FFFFFFFF;
+#else
+#ifdef Pack_32
+			si = *sx++;
+			ys = (si & 0xffff) + carry;
+			zs = (si >> 16) + (ys >> 16);
+			carry = zs >> 16;
+			y = (*bx & 0xffff) - (ys & 0xffff) - borrow;
+			borrow = (y & 0x10000) >> 16;
+			z = (*bx >> 16) - (zs & 0xffff) - borrow;
+			borrow = (z & 0x10000) >> 16;
+			Storeinc(bx, z, y);
+#else
+			ys = *sx++ + carry;
+			carry = ys >> 16;
+			y = *bx - (ys & 0xffff) - borrow;
+			borrow = (y & 0x10000) >> 16;
+			*bx++ = y & 0xffff;
+#endif
+#endif
+			}
+			while(sx <= sxe);
+		bx = b->x;
+		bxe = bx + n;
+		if (!*bxe) {
+			while(--bxe > bx && !*bxe)
+				--n;
+			b->wds = n;
+			}
+		}
+	return q;
+	}
+
+#ifndef MULTIPLE_THREADS
+ static char *dtoa_result;
+#endif
+
+ static char *
+#ifdef KR_headers
+rv_alloc(i) int i;
+#else
+rv_alloc(int i)
+#endif
+{
+	int j, k, *r;
+
+	j = sizeof(ULong);
+	for(k = 0;
+		sizeof(Bigint) - sizeof(ULong) - sizeof(int) + j <= sizeof(i);
+		j <<= 1)
+			k++;
+	r = (int*)Balloc(k);
+	*r = k;
+	return
+#ifndef MULTIPLE_THREADS
+	dtoa_result =
+#endif
+		(char *)(r+1);
+	}
+
+ static char *
+#ifdef KR_headers
+nrv_alloc(s, rve, n) char *s, **rve; int n;
+#else
+nrv_alloc(CONST char *s, char **rve, int n)
+#endif
+{
+	char *rv, *t;
+
+	t = rv = rv_alloc(n);
+	while((*t = *s++)) t++;
+	if (rve)
+		*rve = t;
+	return rv;
+	}
+
+/* freedtoa(s) must be used to free values s returned by dtoa
+ * when MULTIPLE_THREADS is #defined.  It should be used in all cases,
+ * but for consistency with earlier versions of dtoa, it is optional
+ * when MULTIPLE_THREADS is not defined.
+ */
+
+ void
+#ifdef KR_headers
+freedtoa(s) char *s;
+#else
+freedtoa(char *s)
+#endif
+{
+	Bigint *b = (Bigint *)((int *)s - 1);
+	b->maxwds = 1 << (b->k = *(int*)b);
+	Bfree(b);
+#ifndef MULTIPLE_THREADS
+	if (s == dtoa_result)
+		dtoa_result = 0;
+#endif
+	}
+
+/* dtoa for IEEE arithmetic (dmg): convert double to ASCII string.
+ *
+ * Inspired by "How to Print Floating-Point Numbers Accurately" by
+ * Guy L. Steele, Jr. and Jon L. White [Proc. ACM SIGPLAN '90, pp. 112-126].
+ *
+ * Modifications:
+ *	1. Rather than iterating, we use a simple numeric overestimate
+ *	   to determine k = floor(log10(d)).  We scale relevant
+ *	   quantities using O(log2(k)) rather than O(k) multiplications.
+ *	2. For some modes > 2 (corresponding to ecvt and fcvt), we don't
+ *	   try to generate digits strictly left to right.  Instead, we
+ *	   compute with fewer bits and propagate the carry if necessary
+ *	   when rounding the final digit up.  This is often faster.
+ *	3. Under the assumption that input will be rounded nearest,
+ *	   mode 0 renders 1e23 as 1e23 rather than 9.999999999999999e22.
+ *	   That is, we allow equality in stopping tests when the
+ *	   round-nearest rule will give the same floating-point value
+ *	   as would satisfaction of the stopping test with strict
+ *	   inequality.
+ *	4. We remove common factors of powers of 2 from relevant
+ *	   quantities.
+ *	5. When converting floating-point integers less than 1e16,
+ *	   we use floating-point arithmetic rather than resorting
+ *	   to multiple-precision integers.
+ *	6. When asked to produce fewer than 15 digits, we first try
+ *	   to get by with floating-point arithmetic; we resort to
+ *	   multiple-precision integer arithmetic only if we cannot
+ *	   guarantee that the floating-point calculation has given
+ *	   the correctly rounded result.  For k requested digits and
+ *	   "uniformly" distributed input, the probability is
+ *	   something like 10^(k-15) that we must resort to the Long
+ *	   calculation.
+ */
+
+ static char *
+dtoa
+#ifdef KR_headers
+	(d, mode, ndigits, decpt, sign, rve)
+	double d; int mode, ndigits, *decpt, *sign; char **rve;
+#else
+	(double d, int mode, int ndigits, int *decpt, int *sign, char **rve)
+#endif
+{
+ /*	Arguments ndigits, decpt, sign are similar to those
+	of ecvt and fcvt; trailing zeros are suppressed from
+	the returned string.  If not null, *rve is set to point
+	to the end of the return value.  If d is +-Infinity or NaN,
+	then *decpt is set to 9999.
+
+	mode:
+		0 ==> shortest string that yields d when read in
+			and rounded to nearest.
+		1 ==> like 0, but with Steele & White stopping rule;
+			e.g. with IEEE P754 arithmetic , mode 0 gives
+			1e23 whereas mode 1 gives 9.999999999999999e22.
+		2 ==> max(1,ndigits) significant digits.  This gives a
+			return value similar to that of ecvt, except
+			that trailing zeros are suppressed.
+		3 ==> through ndigits past the decimal point.  This
+			gives a return value similar to that from fcvt,
+			except that trailing zeros are suppressed, and
+			ndigits can be negative.
+		4,5 ==> similar to 2 and 3, respectively, but (in
+			round-nearest mode) with the tests of mode 0 to
+			possibly return a shorter string that rounds to d.
+			With IEEE arithmetic and compilation with
+			-DHonor_FLT_ROUNDS, modes 4 and 5 behave the same
+			as modes 2 and 3 when FLT_ROUNDS != 1.
+		6-9 ==> Debugging modes similar to mode - 4:  don't try
+			fast floating-point estimate (if applicable).
+
+		Values of mode other than 0-9 are treated as mode 0.
+
+		Sufficient space is allocated to the return value
+		to hold the suppressed trailing zeros.
+	*/
+
+	int bbits, b2, b5, be, dig, i, ieps, ilim, ilim0, ilim1,
+		j, j1, k, k0, k_check, leftright, m2, m5, s2, s5,
+		spec_case, try_quick;
+	Long L;
+#ifndef Sudden_Underflow
+	int denorm;
+	ULong x;
+#endif
+	Bigint *b, *b1, *delta, *mlo, *mhi, *S;
+	double d2, ds, eps;
+	char *s, *s0;
+#ifdef Honor_FLT_ROUNDS
+	int rounding;
+#endif
+#ifdef SET_INEXACT
+	int inexact, oldinexact;
+#endif
+
+#ifdef __GNUC__
+    ilim = ilim1 = 0;
+    mlo = NULL;
+#endif
+
+#ifndef MULTIPLE_THREADS
+	if (dtoa_result) {
+		freedtoa(dtoa_result);
+		dtoa_result = 0;
+		}
+#endif
+
+	if (word0(d) & Sign_bit) {
+		/* set sign for everything, including 0's and NaNs */
+		*sign = 1;
+		word0(d) &= ~Sign_bit;	/* clear sign bit */
+		}
+	else
+		*sign = 0;
+
+#if defined(IEEE_Arith) + defined(VAX)
+#ifdef IEEE_Arith
+	if ((word0(d) & Exp_mask) == Exp_mask)
+#else
+	if (word0(d)  == 0x8000)
+#endif
+		{
+		/* Infinity or NaN */
+		*decpt = 9999;
+#ifdef IEEE_Arith
+		if (!word1(d) && !(word0(d) & 0xfffff))
+			return nrv_alloc("Infinity", rve, 8);
+#endif
+		return nrv_alloc("NaN", rve, 3);
+		}
+#endif
+#ifdef IBM
+	dval(d) += 0; /* normalize */
+#endif
+	if (!dval(d)) {
+		*decpt = 1;
+		return nrv_alloc("0", rve, 1);
+		}
+
+#ifdef SET_INEXACT
+	try_quick = oldinexact = get_inexact();
+	inexact = 1;
+#endif
+#ifdef Honor_FLT_ROUNDS
+	if ((rounding = Flt_Rounds) >= 2) {
+		if (*sign)
+			rounding = rounding == 2 ? 0 : 2;
+		else
+			if (rounding != 2)
+				rounding = 0;
+		}
+#endif
+
+	b = d2b(dval(d), &be, &bbits);
+#ifdef Sudden_Underflow
+	i = (int)(word0(d) >> Exp_shift1 & (Exp_mask>>Exp_shift1));
+#else
+	if ((i = (int)(word0(d) >> Exp_shift1 & (Exp_mask>>Exp_shift1)))) {
+#endif
+		dval(d2) = dval(d);
+		word0(d2) &= Frac_mask1;
+		word0(d2) |= Exp_11;
+#ifdef IBM
+		if (j = 11 - hi0bits(word0(d2) & Frac_mask))
+			dval(d2) /= 1 << j;
+#endif
+
+		/* log(x)	~=~ log(1.5) + (x-1.5)/1.5
+		 * log10(x)	 =  log(x) / log(10)
+		 *		~=~ log(1.5)/log(10) + (x-1.5)/(1.5*log(10))
+		 * log10(d) = (i-Bias)*log(2)/log(10) + log10(d2)
+		 *
+		 * This suggests computing an approximation k to log10(d) by
+		 *
+		 * k = (i - Bias)*0.301029995663981
+		 *	+ ( (d2-1.5)*0.289529654602168 + 0.176091259055681 );
+		 *
+		 * We want k to be too large rather than too small.
+		 * The error in the first-order Taylor series approximation
+		 * is in our favor, so we just round up the constant enough
+		 * to compensate for any error in the multiplication of
+		 * (i - Bias) by 0.301029995663981; since |i - Bias| <= 1077,
+		 * and 1077 * 0.30103 * 2^-52 ~=~ 7.2e-14,
+		 * adding 1e-13 to the constant term more than suffices.
+		 * Hence we adjust the constant term to 0.1760912590558.
+		 * (We could get a more accurate k by invoking log10,
+		 *  but this is probably not worthwhile.)
+		 */
+
+		i -= Bias;
+#ifdef IBM
+		i <<= 2;
+		i += j;
+#endif
+#ifndef Sudden_Underflow
+		denorm = 0;
+		}
+	else {
+		/* d is denormalized */
+
+		i = bbits + be + (Bias + (P-1) - 1);
+		x = i > 32  ? word0(d) << (64 - i) | word1(d) >> (i - 32)
+			    : word1(d) << (32 - i);
+		dval(d2) = x;
+		word0(d2) -= 31*Exp_msk1; /* adjust exponent */
+		i -= (Bias + (P-1) - 1) + 1;
+		denorm = 1;
+		}
+#endif
+	ds = (dval(d2)-1.5)*0.289529654602168 + 0.1760912590558 + i*0.301029995663981;
+	k = (int)ds;
+	if (ds < 0. && ds != k)
+		k--;	/* want k = floor(ds) */
+	k_check = 1;
+	if (k >= 0 && k <= Ten_pmax) {
+		if (dval(d) < tens[k])
+			k--;
+		k_check = 0;
+		}
+	j = bbits - i - 1;
+	if (j >= 0) {
+		b2 = 0;
+		s2 = j;
+		}
+	else {
+		b2 = -j;
+		s2 = 0;
+		}
+	if (k >= 0) {
+		b5 = 0;
+		s5 = k;
+		s2 += k;
+		}
+	else {
+		b2 -= k;
+		b5 = -k;
+		s5 = 0;
+		}
+	if (mode < 0 || mode > 9)
+		mode = 0;
+
+#ifndef SET_INEXACT
+#ifdef Check_FLT_ROUNDS
+	try_quick = Rounding == 1;
+#else
+	try_quick = 1;
+#endif
+#endif /*SET_INEXACT*/
+
+	if (mode > 5) {
+		mode -= 4;
+		try_quick = 0;
+		}
+	leftright = 1;
+	switch(mode) {
+		case 0:
+		case 1:
+			ilim = ilim1 = -1;
+			i = 18;
+			ndigits = 0;
+			break;
+		case 2:
+			leftright = 0;
+			/* no break */
+		case 4:
+			if (ndigits <= 0)
+				ndigits = 1;
+			ilim = ilim1 = i = ndigits;
+			break;
+		case 3:
+			leftright = 0;
+			/* no break */
+		case 5:
+			i = ndigits + k + 1;
+			ilim = i;
+			ilim1 = i - 1;
+			if (i <= 0)
+				i = 1;
+		}
+	s = s0 = rv_alloc(i);
+
+#ifdef Honor_FLT_ROUNDS
+	if (mode > 1 && rounding != 1)
+		leftright = 0;
+#endif
+
+	if (ilim >= 0 && ilim <= Quick_max && try_quick) {
+
+		/* Try to get by with floating-point arithmetic. */
+
+		i = 0;
+		dval(d2) = dval(d);
+		k0 = k;
+		ilim0 = ilim;
+		ieps = 2; /* conservative */
+		if (k > 0) {
+			ds = tens[k&0xf];
+			j = k >> 4;
+			if (j & Bletch) {
+				/* prevent overflows */
+				j &= Bletch - 1;
+				dval(d) /= bigtens[n_bigtens-1];
+				ieps++;
+				}
+			for(; j; j >>= 1, i++)
+				if (j & 1) {
+					ieps++;
+					ds *= bigtens[i];
+					}
+			dval(d) /= ds;
+			}
+		else if ((j1 = -k)) {
+			dval(d) *= tens[j1 & 0xf];
+			for(j = j1 >> 4; j; j >>= 1, i++)
+				if (j & 1) {
+					ieps++;
+					dval(d) *= bigtens[i];
+					}
+			}
+		if (k_check && dval(d) < 1. && ilim > 0) {
+			if (ilim1 <= 0)
+				goto fast_failed;
+			ilim = ilim1;
+			k--;
+			dval(d) *= 10.;
+			ieps++;
+			}
+		dval(eps) = ieps*dval(d) + 7.;
+		word0(eps) -= (P-1)*Exp_msk1;
+		if (ilim == 0) {
+			S = mhi = 0;
+			dval(d) -= 5.;
+			if (dval(d) > dval(eps))
+				goto one_digit;
+			if (dval(d) < -dval(eps))
+				goto no_digits;
+			goto fast_failed;
+			}
+#ifndef No_leftright
+		if (leftright) {
+			/* Use Steele & White method of only
+			 * generating digits needed.
+			 */
+			dval(eps) = 0.5/tens[ilim-1] - dval(eps);
+			for(i = 0;;) {
+				L = (ULong) dval(d);
+				dval(d) -= L;
+				*s++ = '0' + (int)L;
+				if (dval(d) < dval(eps))
+					goto ret1;
+				if (1. - dval(d) < dval(eps))
+					goto bump_up;
+				if (++i >= ilim)
+					break;
+				dval(eps) *= 10.;
+				dval(d) *= 10.;
+				}
+			}
+		else {
+#endif
+			/* Generate ilim digits, then fix them up. */
+			dval(eps) *= tens[ilim-1];
+			for(i = 1;; i++, dval(d) *= 10.) {
+				L = (Long)(dval(d));
+				if (!(dval(d) -= L))
+					ilim = i;
+				*s++ = '0' + (int)L;
+				if (i == ilim) {
+					if (dval(d) > 0.5 + dval(eps))
+						goto bump_up;
+					else if (dval(d) < 0.5 - dval(eps)) {
+						while(*--s == '0');
+						s++;
+						goto ret1;
+						}
+					break;
+					}
+				}
+#ifndef No_leftright
+			}
+#endif
+ fast_failed:
+		s = s0;
+		dval(d) = dval(d2);
+		k = k0;
+		ilim = ilim0;
+		}
+
+	/* Do we have a "small" integer? */
+
+	if (be >= 0 && k <= Int_max) {
+		/* Yes. */
+		ds = tens[k];
+		if (ndigits < 0 && ilim <= 0) {
+			S = mhi = 0;
+			if (ilim < 0 || dval(d) <= 5*ds)
+				goto no_digits;
+			goto one_digit;
+			}
+		for(i = 1;; i++, dval(d) *= 10.) {
+			L = (Long)(dval(d) / ds);
+			dval(d) -= L*ds;
+#ifdef Check_FLT_ROUNDS
+			/* If FLT_ROUNDS == 2, L will usually be high by 1 */
+			if (dval(d) < 0) {
+				L--;
+				dval(d) += ds;
+				}
+#endif
+			*s++ = '0' + (int)L;
+			if (!dval(d)) {
+#ifdef SET_INEXACT
+				inexact = 0;
+#endif
+				break;
+				}
+			if (i == ilim) {
+#ifdef Honor_FLT_ROUNDS
+				if (mode > 1)
+				switch(rounding) {
+				  case 0: goto ret1;
+				  case 2: goto bump_up;
+				  }
+#endif
+				dval(d) += dval(d);
+				if (dval(d) > ds || (dval(d) == ds && L & 1)) {
+ bump_up:
+					while(*--s == '9')
+						if (s == s0) {
+							k++;
+							*s = '0';
+							break;
+							}
+					++*s++;
+					}
+				break;
+				}
+			}
+		goto ret1;
+		}
+
+	m2 = b2;
+	m5 = b5;
+	mhi = mlo = 0;
+	if (leftright) {
+		i =
+#ifndef Sudden_Underflow
+			denorm ? be + (Bias + (P-1) - 1 + 1) :
+#endif
+#ifdef IBM
+			1 + 4*P - 3 - bbits + ((bbits + be - 1) & 3);
+#else
+			1 + P - bbits;
+#endif
+		b2 += i;
+		s2 += i;
+		mhi = i2b(1);
+		}
+	if (m2 > 0 && s2 > 0) {
+		i = m2 < s2 ? m2 : s2;
+		b2 -= i;
+		m2 -= i;
+		s2 -= i;
+		}
+	if (b5 > 0) {
+		if (leftright) {
+			if (m5 > 0) {
+				mhi = pow5mult(mhi, m5);
+				b1 = mult(mhi, b);
+				Bfree(b);
+				b = b1;
+				}
+			if ((j = b5 - m5))
+				b = pow5mult(b, j);
+			}
+		else
+			b = pow5mult(b, b5);
+		}
+	S = i2b(1);
+	if (s5 > 0)
+		S = pow5mult(S, s5);
+
+	/* Check for special case that d is a normalized power of 2. */
+
+	spec_case = 0;
+	if ((mode < 2 || leftright)
+#ifdef Honor_FLT_ROUNDS
+			&& rounding == 1
+#endif
+				) {
+		if (!word1(d) && !(word0(d) & Bndry_mask)
+#ifndef Sudden_Underflow
+		 && word0(d) & (Exp_mask & ~Exp_msk1)
+#endif
+				) {
+			/* The special case */
+			b2 += Log2P;
+			s2 += Log2P;
+			spec_case = 1;
+			}
+		}
+
+	/* Arrange for convenient computation of quotients:
+	 * shift left if necessary so divisor has 4 leading 0 bits.
+	 *
+	 * Perhaps we should just compute leading 28 bits of S once
+	 * and for all and pass them and a shift to quorem, so it
+	 * can do shifts and ors to compute the numerator for q.
+	 */
+#ifdef Pack_32
+	if ((i = ((s5 ? 32 - hi0bits(S->x[S->wds-1]) : 1) + s2) & 0x1f))
+		i = 32 - i;
+#else
+	if (i = ((s5 ? 32 - hi0bits(S->x[S->wds-1]) : 1) + s2) & 0xf)
+		i = 16 - i;
+#endif
+	if (i > 4) {
+		i -= 4;
+		b2 += i;
+		m2 += i;
+		s2 += i;
+		}
+	else if (i < 4) {
+		i += 28;
+		b2 += i;
+		m2 += i;
+		s2 += i;
+		}
+	if (b2 > 0)
+		b = lshift(b, b2);
+	if (s2 > 0)
+		S = lshift(S, s2);
+	if (k_check) {
+		if (cmp(b,S) < 0) {
+			k--;
+			b = multadd(b, 10, 0);	/* we botched the k estimate */
+			if (leftright)
+				mhi = multadd(mhi, 10, 0);
+			ilim = ilim1;
+			}
+		}
+	if (ilim <= 0 && (mode == 3 || mode == 5)) {
+		if (ilim < 0 || cmp(b,S = multadd(S,5,0)) <= 0) {
+			/* no digits, fcvt style */
+ no_digits:
+			k = -1 - ndigits;
+			goto ret;
+			}
+ one_digit:
+		*s++ = '1';
+		k++;
+		goto ret;
+		}
+	if (leftright) {
+		if (m2 > 0)
+			mhi = lshift(mhi, m2);
+
+		/* Compute mlo -- check for special case
+		 * that d is a normalized power of 2.
+		 */
+
+		mlo = mhi;
+		if (spec_case) {
+			mhi = Balloc(mhi->k);
+			Bcopy(mhi, mlo);
+			mhi = lshift(mhi, Log2P);
+			}
+
+		for(i = 1;;i++) {
+			dig = quorem(b,S) + '0';
+			/* Do we yet have the shortest decimal string
+			 * that will round to d?
+			 */
+			j = cmp(b, mlo);
+			delta = diff(S, mhi);
+			j1 = delta->sign ? 1 : cmp(b, delta);
+			Bfree(delta);
+#ifndef ROUND_BIASED
+			if (j1 == 0 && mode != 1 && !(word1(d) & 1)
+#ifdef Honor_FLT_ROUNDS
+				&& rounding >= 1
+#endif
+								   ) {
+				if (dig == '9')
+					goto round_9_up;
+				if (j > 0)
+					dig++;
+#ifdef SET_INEXACT
+				else if (!b->x[0] && b->wds <= 1)
+					inexact = 0;
+#endif
+				*s++ = dig;
+				goto ret;
+				}
+#endif
+			if (j < 0 || (j == 0 && mode != 1
+#ifndef ROUND_BIASED
+							&& !(word1(d) & 1)
+#endif
+					)) {
+				if (!b->x[0] && b->wds <= 1) {
+#ifdef SET_INEXACT
+					inexact = 0;
+#endif
+					goto accept_dig;
+					}
+#ifdef Honor_FLT_ROUNDS
+				if (mode > 1)
+				 switch(rounding) {
+				  case 0: goto accept_dig;
+				  case 2: goto keep_dig;
+				  }
+#endif /*Honor_FLT_ROUNDS*/
+				if (j1 > 0) {
+					b = lshift(b, 1);
+					j1 = cmp(b, S);
+					if ((j1 > 0 || (j1 == 0 && dig & 1))
+					&& dig++ == '9')
+						goto round_9_up;
+					}
+ accept_dig:
+				*s++ = dig;
+				goto ret;
+				}
+			if (j1 > 0) {
+#ifdef Honor_FLT_ROUNDS
+				if (!rounding)
+					goto accept_dig;
+#endif
+				if (dig == '9') { /* possible if i == 1 */
+ round_9_up:
+					*s++ = '9';
+					goto roundoff;
+					}
+				*s++ = dig + 1;
+				goto ret;
+				}
+#ifdef Honor_FLT_ROUNDS
+ keep_dig:
+#endif
+			*s++ = dig;
+			if (i == ilim)
+				break;
+			b = multadd(b, 10, 0);
+			if (mlo == mhi)
+				mlo = mhi = multadd(mhi, 10, 0);
+			else {
+				mlo = multadd(mlo, 10, 0);
+				mhi = multadd(mhi, 10, 0);
+				}
+			}
+		}
+	else
+		for(i = 1;; i++) {
+			*s++ = dig = quorem(b,S) + '0';
+			if (!b->x[0] && b->wds <= 1) {
+#ifdef SET_INEXACT
+				inexact = 0;
+#endif
+				goto ret;
+				}
+			if (i >= ilim)
+				break;
+			b = multadd(b, 10, 0);
+			}
+
+	/* Round off last digit */
+
+#ifdef Honor_FLT_ROUNDS
+	switch(rounding) {
+	  case 0: goto trimzeros;
+	  case 2: goto roundoff;
+	  }
+#endif
+	b = lshift(b, 1);
+	j = cmp(b, S);
+	if (j > 0 || (j == 0 && dig & 1)) {
+ roundoff:
+		while(*--s == '9')
+			if (s == s0) {
+				k++;
+				*s++ = '1';
+				goto ret;
+				}
+		++*s++;
+		}
+	else {
+#ifdef Honor_FLT_ROUNDS
+ trimzeros:
+#endif
+		while(*--s == '0');
+		s++;
+		}
+ ret:
+	Bfree(S);
+	if (mhi) {
+		if (mlo && mlo != mhi)
+			Bfree(mlo);
+		Bfree(mhi);
+		}
+ ret1:
+#ifdef SET_INEXACT
+	if (inexact) {
+		if (!oldinexact) {
+			word0(d) = Exp_1 + (70 << Exp_shift);
+			word1(d) = 0;
+			dval(d) += 1.;
+			}
+		}
+	else if (!oldinexact)
+		clear_inexact();
+#endif
+	Bfree(b);
+	*s = 0;
+	*decpt = k + 1;
+	if (rve)
+		*rve = s;
+	return s0;
+	}
+#ifdef __cplusplus
+}
+#endif
diff --git a/js/src/js.cpp b/js/src/js.cpp
--- a/js/src/js.cpp
+++ b/js/src/js.cpp
@@ -809,21 +809,24 @@ GC(JSContext *cx, uintN argc, jsval *vp)
 }
 
 static JSBool
 GCParameter(JSContext *cx, uintN argc, jsval *vp)
 {
-    jsval *argv;
     JSString *str;
     const char *paramName;
     JSGCParamKey param;
     uint32 value;
 
-    argv = JS_ARGV(cx, vp);
-    str = JS_ValueToString(cx, argv[0]);
-    if (!str)
-        return JS_FALSE;
-    argv[0] = STRING_TO_JSVAL(str);
+    if (argc == 0) {
+        str = JS_ValueToString(cx, JSVAL_VOID);
+        JS_ASSERT(str);
+    } else {
+        str = JS_ValueToString(cx, vp[2]);
+        if (!str)
+            return JS_FALSE;
+        vp[2] = STRING_TO_JSVAL(str);
+    }
     paramName = JS_GetStringBytes(str);
     if (!paramName)
         return JS_FALSE;
     if (strcmp(paramName, "maxBytes") == 0) {
         param = JSGC_MAX_BYTES;
@@ -834,11 +837,11 @@ GCParameter(JSContext *cx, uintN argc, j
                        "the first argument argument must be either maxBytes "
                        "or maxMallocBytes");
         return JS_FALSE;
     }
 
-    if (!JS_ValueToECMAUint32(cx, argv[1], &value))
+    if (!JS_ValueToECMAUint32(cx, argc < 2 ? JSVAL_VOID : vp[3], &value))
         return JS_FALSE;
     if (value == 0) {
         JS_ReportError(cx,
                        "the second argument must be convertable to uint32 with "
                        "non-zero value");
@@ -853,11 +856,11 @@ static JSBool
 static JSBool
 GCZeal(JSContext *cx, uintN argc, jsval *vp)
 {
     uint32 zeal;
 
-    if (!JS_ValueToECMAUint32(cx, vp[2], &zeal))
+    if (!JS_ValueToECMAUint32(cx, argc == 0 ? JSVAL_VOID : vp[2], &zeal))
         return JS_FALSE;
     JS_SetGCZeal(cx, zeal);
     *vp = JSVAL_VOID;
     return JS_TRUE;
 }
@@ -1030,10 +1033,16 @@ ValueToScript(JSContext *cx, jsval v)
         fun = JS_ValueToFunction(cx, v);
         if (!fun)
             return NULL;
         script = FUN_SCRIPT(fun);
     }
+
+    if (!script) {
+        JS_ReportErrorNumber(cx, my_GetErrorMessage, NULL,
+                             JSSMSG_SCRIPTS_ONLY);
+    }
+
     return script;
 }
 
 static JSBool
 GetTrapArgs(JSContext *cx, uintN argc, jsval *argv, JSScript **scriptp,
@@ -1366,44 +1375,38 @@ Disassemble(JSContext *cx, JSObject *obj
     } else {
         lines = JS_FALSE;
     }
     for (i = 0; i < argc; i++) {
         script = ValueToScript(cx, argv[i]);
-        if (!script) {
-            JS_ReportErrorNumber(cx, my_GetErrorMessage, NULL,
-                                 JSSMSG_SCRIPTS_ONLY);
+        if (!script)
             return JS_FALSE;
-        }
         if (VALUE_IS_FUNCTION(cx, argv[i])) {
             JSFunction *fun = JS_ValueToFunction(cx, argv[i]);
             if (fun && (fun->flags & JSFUN_FLAGS_MASK)) {
                 uint16 flags = fun->flags;
                 fputs("flags:", stdout);
-                
+
 #define SHOW_FLAG(flag) if (flags & JSFUN_##flag) fputs(" " #flag, stdout);
-                
+
                 SHOW_FLAG(LAMBDA);
                 SHOW_FLAG(SETTER);
                 SHOW_FLAG(GETTER);
                 SHOW_FLAG(BOUND_METHOD);
                 SHOW_FLAG(HEAVYWEIGHT);
                 SHOW_FLAG(THISP_STRING);
                 SHOW_FLAG(THISP_NUMBER);
                 SHOW_FLAG(THISP_BOOLEAN);
                 SHOW_FLAG(EXPR_CLOSURE);
                 SHOW_FLAG(INTERPRETED);
-                
+
 #undef SHOW_FLAG
                 putchar('\n');
             }
         }
-        
-        if (!js_Disassemble(cx, script, lines, stdout)) {
-            JS_ReportErrorNumber(cx, my_GetErrorMessage, NULL,
-                                 JSSMSG_CANT_DISASSEMBLE);
+
+        if (!js_Disassemble(cx, script, lines, stdout))
             return JS_FALSE;
-        }
         SrcNotes(cx, script);
         TryNotes(cx, script);
     }
     return JS_TRUE;
 }
@@ -1416,25 +1419,30 @@ DisassWithSrc(JSContext *cx, JSObject *o
     uintN i, len, line1, line2, bupline;
     JSScript *script;
     FILE *file;
     char linebuf[LINE_BUF_LEN];
     jsbytecode *pc, *end;
+    JSBool ok;
     static char sep[] = ";-------------------------";
 
-    for (i = 0; i < argc; i++) {
+    ok = JS_TRUE;
+    for (i = 0; ok && i < argc; i++) {
         script = ValueToScript(cx, argv[i]);
-        if (!script || !script->filename) {
+        if (!script)
+           return JS_FALSE;
+
+        if (!script->filename) {
             JS_ReportErrorNumber(cx, my_GetErrorMessage, NULL,
                                  JSSMSG_FILE_SCRIPTS_ONLY);
             return JS_FALSE;
         }
 
         file = fopen(script->filename, "r");
         if (!file) {
             JS_ReportErrorNumber(cx, my_GetErrorMessage, NULL,
-                            JSSMSG_CANT_OPEN,
-                            script->filename, strerror(errno));
+                                 JSSMSG_CANT_OPEN, script->filename,
+                                 strerror(errno));
             return JS_FALSE;
         }
 
         pc = script->code;
         end = pc + script->length;
@@ -1460,10 +1468,11 @@ DisassWithSrc(JSContext *cx, JSObject *o
                 while (line1 < line2) {
                     if (!fgets(linebuf, LINE_BUF_LEN, file)) {
                         JS_ReportErrorNumber(cx, my_GetErrorMessage, NULL,
                                              JSSMSG_UNEXPECTED_EOF,
                                              script->filename);
+                        ok = JS_FALSE;
                         goto bail;
                     }
                     line1++;
                     fprintf(gOutFile, "%s %3u: %s", sep, line1, linebuf);
                 }
@@ -1471,21 +1480,20 @@ DisassWithSrc(JSContext *cx, JSObject *o
 
             len = js_Disassemble1(cx, script, pc,
                                   PTRDIFF(pc, script->code, jsbytecode),
                                   JS_TRUE, stdout);
             if (!len) {
-                JS_ReportErrorNumber(cx, my_GetErrorMessage, NULL,
-                                     JSSMSG_CANT_DISASSEMBLE);
-                return JS_FALSE;
+                ok = JS_FALSE;
+                goto bail;
             }
             pc += len;
         }
 
       bail:
         fclose(file);
     }
-    return JS_TRUE;
+    return ok;
 #undef LINE_BUF_LEN
 }
 
 static JSBool
 Tracing(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
@@ -1558,11 +1566,10 @@ DumpScope(JSContext *cx, JSObject *obj, 
         }
 #define DUMP_ATTR(name) if (sprop->attrs & JSPROP_##name) fputs(" " #name, fp)
         DUMP_ATTR(ENUMERATE);
         DUMP_ATTR(READONLY);
         DUMP_ATTR(PERMANENT);
-        DUMP_ATTR(EXPORTED);
         DUMP_ATTR(GETTER);
         DUMP_ATTR(SETTER);
 #undef  DUMP_ATTR
 
         fprintf(fp, " slot %lu flags %x shortid %d\n",
@@ -1715,46 +1722,10 @@ DumpHeap(JSContext *cx, uintN argc, jsva
     return JS_FALSE;
 }
 
 #endif /* DEBUG */
 
-#ifdef TEST_EXPORT
-static JSBool
-DoExport(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
-{
-    jsid id;
-    JSObject *obj2;
-    JSProperty *prop;
-    JSBool ok;
-    uintN attrs;
-
-    if (argc != 2) {
-        JS_ReportErrorNumber(cx, my_GetErrorMessage, NULL, JSSMSG_DOEXP_USAGE);
-        return JS_FALSE;
-    }
-    if (!JS_ValueToObject(cx, argv[0], &obj))
-        return JS_FALSE;
-    argv[0] = OBJECT_TO_JSVAL(obj);
-    if (!js_ValueToStringId(cx, argv[1], &id))
-        return JS_FALSE;
-    if (!OBJ_LOOKUP_PROPERTY(cx, obj, id, &obj2, &prop))
-        return JS_FALSE;
-    if (!prop) {
-        ok = OBJ_DEFINE_PROPERTY(cx, obj, id, JSVAL_VOID, NULL, NULL,
-                                 JSPROP_EXPORTED, NULL);
-    } else {
-        ok = OBJ_GET_ATTRIBUTES(cx, obj, id, prop, &attrs);
-        if (ok) {
-            attrs |= JSPROP_EXPORTED;
-            ok = OBJ_SET_ATTRIBUTES(cx, obj, id, prop, &attrs);
-        }
-        OBJ_DROP_PROPERTY(cx, obj2, prop);
-    }
-    return ok;
-}
-#endif
-
 #ifdef TEST_CVTARGS
 #include <ctype.h>
 
 static const char *
 EscapeWideString(jschar *w)
@@ -1893,11 +1864,11 @@ static JSBool
 static JSBool
 Intern(JSContext *cx, uintN argc, jsval *vp)
 {
     JSString *str;
 
-    str = JS_ValueToString(cx, vp[2]);
+    str = JS_ValueToString(cx, argc == 0 ? JSVAL_VOID : vp[2]);
     if (!str)
         return JS_FALSE;
     if (!JS_InternUCStringN(cx, JS_GetStringChars(str),
                                 JS_GetStringLength(str))) {
         return JS_FALSE;
@@ -1950,11 +1921,11 @@ GetPDA(JSContext *cx, uintN argc, jsval 
     JSPropertyDescArray pda;
     JSPropertyDesc *pd;
     uint32 i;
     jsval v;
 
-    if (!JS_ValueToObject(cx, vp[2], &vobj))
+    if (!JS_ValueToObject(cx, argc == 0 ? JSVAL_VOID : vp[2], &vobj))
         return JS_FALSE;
     if (!vobj)
         return JS_TRUE;
 
     aobj = JS_NewArrayObject(cx, 0, NULL);
@@ -1996,11 +1967,11 @@ static JSBool
 static JSBool
 GetSLX(JSContext *cx, uintN argc, jsval *vp)
 {
     JSScript *script;
 
-    script = ValueToScript(cx, vp[2]);
+    script = ValueToScript(cx, argc == 0 ? JSVAL_VOID : vp[2]);
     if (!script)
         return JS_FALSE;
     *vp = INT_TO_JSVAL(js_GetScriptLineExtent(script));
     return JS_TRUE;
 }
@@ -2008,11 +1979,11 @@ static JSBool
 static JSBool
 ToInt32(JSContext *cx, uintN argc, jsval *vp)
 {
     int32 i;
 
-    if (!JS_ValueToInt32(cx, vp[2], &i))
+    if (!JS_ValueToInt32(cx, argc == 0 ? JSVAL_VOID : vp[2], &i))
         return JS_FALSE;
     return JS_NewNumberValue(cx, i, vp);
 }
 
 static JSBool
@@ -2523,11 +2494,11 @@ Sleep(JSContext *cx, uintN argc, jsval *
 {
     jsdouble t_secs;
     PRUint32 t_ticks;
     jsrefcount rc;
 
-    if (!JS_ConvertArguments(cx, argc, JS_ARGV(cx, vp), "d", &t_secs))
+    if (!JS_ValueToNumber(cx, argc == 0 ? JSVAL_VOID : vp[2], &t_secs))
         return JS_FALSE;
 
     if (t_secs < 0 || JSDOUBLE_IS_NaN(t_secs))
         t_secs = 0;
 
@@ -2635,12 +2606,14 @@ Scatter(JSContext *cx, uintN argc, jsval
     sd.cvar = NULL;
     sd.results = NULL;
     sd.threads = NULL;
     sd.status = SCATTER_WAIT;
 
-    if (JSVAL_IS_PRIMITIVE(JS_ARGV(cx, vp)[0]))
+    if (argc == 0 || JSVAL_IS_PRIMITIVE(JS_ARGV(cx, vp)[0])) {
+        JS_ReportError(cx, "the first argument must be an object");
         goto fail;
+    }
 
     inArr = JSVAL_TO_OBJECT(JS_ARGV(cx, vp)[0]);
     ok = JS_GetArrayLength(cx, inArr, &n);
     if (!ok)
         goto out;
@@ -2780,50 +2753,47 @@ fail:
 /* We use a mix of JS_FS and JS_FN to test both kinds of natives. */
 static JSFunctionSpec shell_functions[] = {
     JS_FS("version",        Version,        0,0,0),
     JS_FS("options",        Options,        0,0,0),
     JS_FS("load",           Load,           1,0,0),
-    JS_FN("readline",       ReadLine,       0,0,0),
+    JS_FN("readline",       ReadLine,       0,0),
     JS_FS("print",          Print,          0,0,0),
     JS_FS("help",           Help,           0,0,0),
     JS_FS("quit",           Quit,           0,0,0),
-    JS_FN("gc",             GC,             0,0,0),
-    JS_FN("gcparam",        GCParameter,    2,2,0),
-    JS_FN("countHeap",      CountHeap,      0,0,0),
+    JS_FN("gc",             GC,             0,0),
+    JS_FN("gcparam",        GCParameter,    2,0),
+    JS_FN("countHeap",      CountHeap,      0,0),
 #ifdef JS_GC_ZEAL
-    JS_FN("gczeal",         GCZeal,         1,1,0),
+    JS_FN("gczeal",         GCZeal,         1,0),
 #endif
     JS_FS("trap",           Trap,           3,0,0),
     JS_FS("untrap",         Untrap,         2,0,0),
     JS_FS("line2pc",        LineToPC,       0,0,0),
     JS_FS("pc2line",        PCToLine,       0,0,0),
-    JS_FN("stackQuota",     StackQuota,     0,0,0),
+    JS_FN("stackQuota",     StackQuota,     0,0),
     JS_FS("stringsAreUTF8", StringsAreUTF8, 0,0,0),
     JS_FS("testUTF8",       TestUTF8,       1,0,0),
     JS_FS("throwError",     ThrowError,     0,0,0),
 #ifdef DEBUG
     JS_FS("dis",            Disassemble,    1,0,0),
     JS_FS("dissrc",         DisassWithSrc,  1,0,0),
-    JS_FN("dumpHeap",       DumpHeap,       0,0,0),
+    JS_FN("dumpHeap",       DumpHeap,       0,0),
     JS_FS("notes",          Notes,          1,0,0),
     JS_FS("tracing",        Tracing,        0,0,0),
     JS_FS("stats",          DumpStats,      1,0,0),
 #endif
-#ifdef TEST_EXPORT
-    JS_FS("xport",          DoExport,       2,0,0),
-#endif
 #ifdef TEST_CVTARGS
     JS_FS("cvtargs",        ConvertArgs,    0,0,12),
 #endif
-    JS_FN("build",          BuildDate,      0,0,0),
+    JS_FN("build",          BuildDate,      0,0),
     JS_FS("clear",          Clear,          0,0,0),
-    JS_FN("intern",         Intern,         1,1,0),
+    JS_FN("intern",         Intern,         1,0),
     JS_FS("clone",          Clone,          1,0,0),
     JS_FS("seal",           Seal,           1,0,1),
-    JS_FN("getpda",         GetPDA,         1,1,0),
-    JS_FN("getslx",         GetSLX,         1,1,0),
-    JS_FN("toint32",        ToInt32,        1,1,0),
+    JS_FN("getpda",         GetPDA,         1,0),
+    JS_FN("getslx",         GetSLX,         1,0),
+    JS_FN("toint32",        ToInt32,        1,0),
     JS_FS("evalcx",         EvalInContext,  1,0,0),
 #ifdef MOZ_SHARK
     JS_FS("startShark",      js_StartShark,      0,0,0),
     JS_FS("stopShark",       js_StopShark,       0,0,0),
     JS_FS("connectShark",    js_ConnectShark,    0,0,0),
@@ -2842,12 +2812,12 @@ static JSFunctionSpec shell_functions[] 
 #endif
 #ifdef DEBUG_ARRAYS
     JS_FS("arrayInfo",       js_ArrayInfo,       1,0,0),
 #endif
 #ifdef JS_THREADSAFE
-    JS_FN("sleep",          Sleep,          1,1,0),
-    JS_FN("scatter",        Scatter,        1,1,0),
+    JS_FN("sleep",          Sleep,          1,0),
+    JS_FN("scatter",        Scatter,        1,0),
 #endif
     JS_FS_END
 };
 
 static const char shell_help_header[] =
@@ -2888,13 +2858,10 @@ static const char *const shell_help_mess
 "dumpHeap([fileName[, start[, toFind[, maxDepth[, toIgnore]]]]])\n"
 "  Interface to JS_DumpHeap with output sent to file",
 "notes([fun])             Show source notes for functions",
 "tracing([toggle])        Turn tracing on or off",
 "stats([string ...])      Dump 'arena', 'atom', 'global' stats",
-#endif
-#ifdef TEST_EXPORT
-"xport(obj, property)     Export the given property of obj",
 #endif
 #ifdef TEST_CVTARGS
 "cvtargs(arg1..., arg12)  Test argument formater",
 #endif
 "build()                  Show build date and time",
diff --git a/js/src/js.msg b/js/src/js.msg
--- a/js/src/js.msg
+++ b/js/src/js.msg
@@ -102,11 +102,11 @@ MSG_DEF(JSMSG_BAD_FORMAL,              2
 MSG_DEF(JSMSG_BAD_FORMAL,              20, 0, JSEXN_SYNTAXERR, "malformed formal parameter")
 MSG_DEF(JSMSG_BAD_ITERATOR,            21, 3, JSEXN_TYPEERR, "{0} has invalid {1} value {2}")
 MSG_DEF(JSMSG_NOT_FUNCTION,            22, 1, JSEXN_TYPEERR, "{0} is not a function")
 MSG_DEF(JSMSG_NOT_CONSTRUCTOR,         23, 1, JSEXN_TYPEERR, "{0} is not a constructor")
 MSG_DEF(JSMSG_SCRIPT_STACK_QUOTA,      24, 0, JSEXN_INTERNALERR, "script stack space quota is exhausted")
-MSG_DEF(JSMSG_NOT_EXPORTED,            25, 1, JSEXN_TYPEERR, "{0} is not exported")
+MSG_DEF(JSMSG_UNUSED25,                25, 0, JSEXN_NONE, "unused25")
 MSG_DEF(JSMSG_OVER_RECURSED,           26, 0, JSEXN_INTERNALERR, "too much recursion")
 MSG_DEF(JSMSG_IN_NOT_OBJECT,           27, 1, JSEXN_TYPEERR, "invalid 'in' operand {0}")
 MSG_DEF(JSMSG_BAD_NEW_RESULT,          28, 1, JSEXN_TYPEERR, "invalid new expression result {0}")
 MSG_DEF(JSMSG_BAD_SHARP_DEF,           29, 1, JSEXN_ERR, "invalid sharp variable definition #{0}=")
 MSG_DEF(JSMSG_BAD_SHARP_USE,           30, 1, JSEXN_ERR, "invalid sharp variable use #{0}#")
@@ -153,14 +153,14 @@ MSG_DEF(JSMSG_PAREN_AFTER_FORMAL,      7
 MSG_DEF(JSMSG_PAREN_AFTER_FORMAL,      71, 0, JSEXN_SYNTAXERR, "missing ) after formal parameters")
 MSG_DEF(JSMSG_CURLY_BEFORE_BODY,       72, 0, JSEXN_SYNTAXERR, "missing { before function body")
 MSG_DEF(JSMSG_CURLY_AFTER_BODY,        73, 0, JSEXN_SYNTAXERR, "missing } after function body")
 MSG_DEF(JSMSG_PAREN_BEFORE_COND,       74, 0, JSEXN_SYNTAXERR, "missing ( before condition")
 MSG_DEF(JSMSG_PAREN_AFTER_COND,        75, 0, JSEXN_SYNTAXERR, "missing ) after condition")
-MSG_DEF(JSMSG_NO_IMPORT_NAME,          76, 0, JSEXN_SYNTAXERR, "missing name in import statement")
+MSG_DEF(JSMSG_UNUSED76,                76, 0, JSEXN_NONE, "unused76")
 MSG_DEF(JSMSG_NAME_AFTER_DOT,          77, 0, JSEXN_SYNTAXERR, "missing name after . operator")
 MSG_DEF(JSMSG_BRACKET_IN_INDEX,        78, 0, JSEXN_SYNTAXERR, "missing ] in index expression")
-MSG_DEF(JSMSG_NO_EXPORT_NAME,          79, 0, JSEXN_SYNTAXERR, "missing name in export statement")
+MSG_DEF(JSMSG_UNUSED79,                79, 0, JSEXN_NONE, "unused79")
 MSG_DEF(JSMSG_PAREN_BEFORE_SWITCH,     80, 0, JSEXN_SYNTAXERR, "missing ( before switch expression")
 MSG_DEF(JSMSG_PAREN_AFTER_SWITCH,      81, 0, JSEXN_SYNTAXERR, "missing ) after switch expression")
 MSG_DEF(JSMSG_CURLY_BEFORE_SWITCH,     82, 0, JSEXN_SYNTAXERR, "missing { before switch body")
 MSG_DEF(JSMSG_COLON_AFTER_CASE,        83, 0, JSEXN_SYNTAXERR, "missing : after case label")
 MSG_DEF(JSMSG_WHILE_AFTER_DO,          84, 0, JSEXN_SYNTAXERR, "missing while after do-loop body")
@@ -190,11 +190,11 @@ MSG_DEF(JSMSG_PAREN_IN_PAREN,         10
 MSG_DEF(JSMSG_PAREN_IN_PAREN,         108, 0, JSEXN_SYNTAXERR, "missing ) in parenthetical")
 MSG_DEF(JSMSG_SEMI_BEFORE_STMNT,      109, 0, JSEXN_SYNTAXERR, "missing ; before statement")
 MSG_DEF(JSMSG_NO_RETURN_VALUE,        110, 1, JSEXN_TYPEERR, "function {0} does not always return a value")
 MSG_DEF(JSMSG_DUPLICATE_FORMAL,       111, 1, JSEXN_TYPEERR, "duplicate formal argument {0}")
 MSG_DEF(JSMSG_EQUAL_AS_ASSIGN,        112, 1, JSEXN_SYNTAXERR, "test for equality (==) mistyped as assignment (=)?{0}")
-MSG_DEF(JSMSG_BAD_IMPORT,             113, 0, JSEXN_SYNTAXERR, "invalid import expression")
+MSG_DEF(JSMSG_UNUSED113,              113, 0, JSEXN_NONE, "unused113")
 MSG_DEF(JSMSG_TOO_MANY_DEFAULTS,      114, 0, JSEXN_SYNTAXERR, "more than one switch default")
 MSG_DEF(JSMSG_TOO_MANY_CASES,         115, 0, JSEXN_INTERNALERR, "too many switch cases")
 MSG_DEF(JSMSG_BAD_SWITCH,             116, 0, JSEXN_SYNTAXERR, "invalid switch statement")
 MSG_DEF(JSMSG_BAD_FOR_LEFTSIDE,       117, 0, JSEXN_SYNTAXERR, "invalid for/in left-hand side")
 MSG_DEF(JSMSG_CATCH_AFTER_GENERAL,    118, 0, JSEXN_SYNTAXERR, "catch after unconditional catch")
@@ -304,5 +304,6 @@ MSG_DEF(JSMSG_NULL_OR_UNDEFINED,      22
 MSG_DEF(JSMSG_NULL_OR_UNDEFINED,      222, 2, JSEXN_TYPEERR, "{0} is {1}")
 MSG_DEF(JSMSG_LET_DECL_NOT_IN_BLOCK,  223, 0, JSEXN_SYNTAXERR, "let declaration not directly within block")
 MSG_DEF(JSMSG_BAD_OBJECT_INIT,        224, 0, JSEXN_SYNTAXERR, "invalid object initializer")
 MSG_DEF(JSMSG_CANT_SET_ARRAY_ATTRS,   225, 0, JSEXN_INTERNALERR, "can't set attributes on indexed array properties")
 MSG_DEF(JSMSG_EVAL_ARITY,             226, 0, JSEXN_TYPEERR, "eval accepts only one parameter")
+MSG_DEF(JSMSG_MISSING_FUN_ARG,        227, 2, JSEXN_TYPEERR, "missing argument {0} when calling function {1}")
diff --git a/js/src/jsapi.cpp b/js/src/jsapi.cpp
--- a/js/src/jsapi.cpp
+++ b/js/src/jsapi.cpp
@@ -739,10 +739,12 @@ JS_NewRuntime(uint32 maxbytes)
     memset(rt, 0, sizeof(JSRuntime));
     JS_INIT_CLIST(&rt->contextList);
     JS_INIT_CLIST(&rt->trapList);
     JS_INIT_CLIST(&rt->watchPointList);
 
+    if (!js_InitDtoa())
+        goto bad;
     if (!js_InitGC(rt, maxbytes))
         goto bad;
     if (!js_InitAtomState(rt))
         goto bad;
     if (!js_InitDeflatedStringCache(rt))
@@ -4476,11 +4478,10 @@ JS_DefineFunctions(JSContext *cx, JSObje
                                     : js_generic_native_method_dispatcher,
                                     fs->nargs + 1, flags);
             if (!fun)
                 return JS_FALSE;
             fun->u.n.extra = (uint16)fs->extra;
-            fun->u.n.minargs = (uint16)(fs->extra >> 16);
 
             /*
              * As jsapi.h notes, fs must point to storage that lives as long
              * as fun->object lives.
              */
@@ -4492,11 +4493,10 @@ JS_DefineFunctions(JSContext *cx, JSObje
                   (uint16)(fs->extra >> 16) <= fs->nargs);
         fun = JS_DefineFunction(cx, obj, fs->name, fs->call, fs->nargs, flags);
         if (!fun)
             return JS_FALSE;
         fun->u.n.extra = (uint16)fs->extra;
-        fun->u.n.minargs = (uint16)(fs->extra >> 16);
     }
     return JS_TRUE;
 }
 
 JS_PUBLIC_API(JSFunction *)
diff --git a/js/src/jsapi.h b/js/src/jsapi.h
--- a/js/src/jsapi.h
+++ b/js/src/jsapi.h
@@ -119,11 +119,10 @@ JS_BEGIN_EXTERN_C
 
 /* Property attributes, set in JSPropertySpec and passed to API functions. */
 #define JSPROP_ENUMERATE        0x01    /* property is visible to for/in loop */
 #define JSPROP_READONLY         0x02    /* not settable: assignment is no-op */
 #define JSPROP_PERMANENT        0x04    /* property cannot be deleted */
-#define JSPROP_EXPORTED         0x08    /* property is exported from object */
 #define JSPROP_GETTER           0x10    /* property holds getter function */
 #define JSPROP_SETTER           0x20    /* property holds setter function */
 #define JSPROP_SHARED           0x40    /* don't allocate a value slot for this
                                            property; don't copy the property on
                                            set of the same-named property in an
@@ -1465,14 +1464,13 @@ struct JSFunctionSpec {
 /*
  * "Fast native" initializer macro for a JSFunctionSpec array element. Use this
  * in preference to JS_FS if the native in question does not need its own stack
  * frame when activated.
  */
-#define JS_FN(name,fastcall,minargs,nargs,flags)                              \
+#define JS_FN(name,fastcall,nargs,flags)                                      \
     {name, (JSNative)(fastcall), nargs,                                       \
-     (flags) | JSFUN_FAST_NATIVE | JSFUN_STUB_GSOPS,                          \
-     (minargs) << 16}
+     (flags) | JSFUN_FAST_NATIVE | JSFUN_STUB_GSOPS, 0}
 
 extern JS_PUBLIC_API(JSObject *)
 JS_InitClass(JSContext *cx, JSObject *obj, JSObject *parent_proto,
              JSClass *clasp, JSNative constructor, uintN nargs,
              JSPropertySpec *ps, JSFunctionSpec *fs,
diff --git a/js/src/jsarray.cpp b/js/src/jsarray.cpp
--- a/js/src/jsarray.cpp
+++ b/js/src/jsarray.cpp
@@ -1509,11 +1509,11 @@ array_join(JSContext *cx, uintN argc, js
 array_join(JSContext *cx, uintN argc, jsval *vp)
 {
     JSString *str;
     JSObject *obj;
 
-    if (JSVAL_IS_VOID(vp[2])) {
+    if (argc == 0 || JSVAL_IS_VOID(vp[2])) {
         str = NULL;
     } else {
         str = js_ValueToString(cx, vp[2]);
         if (!str)
             return JS_FALSE;
@@ -2548,10 +2548,11 @@ static JSBool
 static JSBool
 array_indexOfHelper(JSContext *cx, JSBool isLast, uintN argc, jsval *vp)
 {
     JSObject *obj;
     jsuint length, i, stop;
+    jsval tosearch;
     jsint direction;
     JSBool hole;
 
     obj = JS_THIS_OBJECT(cx, vp);
     if (!obj || !js_GetLengthProperty(cx, obj, &length))
@@ -2559,13 +2560,15 @@ array_indexOfHelper(JSContext *cx, JSBoo
     if (length == 0)
         goto not_found;
 
     if (argc <= 1) {
         i = isLast ? length - 1 : 0;
+        tosearch = (argc != 0) ? vp[2] : JSVAL_VOID;
     } else {
         jsdouble start;
 
+        tosearch = vp[2];
         start = js_ValueToNumber(cx, &vp[3]);
         if (JSVAL_IS_NULL(vp[3]))
             return JS_FALSE;
         start = js_DoubleToInteger(start);
         if (start < 0) {
@@ -2597,11 +2600,11 @@ array_indexOfHelper(JSContext *cx, JSBoo
     for (;;) {
         if (!JS_CHECK_OPERATION_LIMIT(cx, JSOW_JUMP) ||
             !GetArrayElement(cx, obj, (jsuint)i, &hole, vp)) {
             return JS_FALSE;
         }
-        if (!hole && js_StrictlyEqual(cx, *vp, vp[2]))
+        if (!hole && js_StrictlyEqual(cx, *vp, tosearch))
             return js_NewNumberInRootedValue(cx, i, vp);
         if (i == stop)
             goto not_found;
         i += direction;
     }
@@ -2653,10 +2656,14 @@ array_extra(JSContext *cx, ArrayExtraMod
 
     /*
      * First, get or compute our callee, so that we error out consistently
      * when passed a non-callable object.
      */
+    if (argc == 0) {
+        js_ReportMissingArg(cx, vp, 0);
+        return JS_FALSE;
+    }
     argv = vp + 2;
     callable = js_ValueToCallableObject(cx, &argv[0], JSV2F_SEARCH_STACK);
     if (!callable)
         return JS_FALSE;
 
@@ -2865,39 +2872,39 @@ static JSPropertySpec array_props[] = {
     {0,0,0,0,0}
 };
 
 static JSFunctionSpec array_methods[] = {
 #if JS_HAS_TOSOURCE
-    JS_FN(js_toSource_str,      array_toSource,     0,0,0),
+    JS_FN(js_toSource_str,      array_toSource,     0,0),
 #endif
-    JS_FN(js_toString_str,      array_toString,     0,0,0),
-    JS_FN(js_toLocaleString_str,array_toLocaleString,0,0,0),
+    JS_FN(js_toString_str,      array_toString,     0,0),
+    JS_FN(js_toLocaleString_str,array_toLocaleString,0,0),
 
     /* Perl-ish methods. */
-    JS_FN("join",               array_join,         1,1,JSFUN_GENERIC_NATIVE),
-    JS_FN("reverse",            array_reverse,      0,0,JSFUN_GENERIC_NATIVE),
-    JS_FN("sort",               array_sort,         0,1,JSFUN_GENERIC_NATIVE),
-    JS_FN("push",               array_push,         1,1,JSFUN_GENERIC_NATIVE),
-    JS_FN("pop",                array_pop,          0,0,JSFUN_GENERIC_NATIVE),
-    JS_FN("shift",              array_shift,        0,0,JSFUN_GENERIC_NATIVE),
-    JS_FN("unshift",            array_unshift,      0,1,JSFUN_GENERIC_NATIVE),
-    JS_FN("splice",             array_splice,       0,2,JSFUN_GENERIC_NATIVE),
+    JS_FN("join",               array_join,         1,JSFUN_GENERIC_NATIVE),
+    JS_FN("reverse",            array_reverse,      0,JSFUN_GENERIC_NATIVE),
+    JS_FN("sort",               array_sort,         1,JSFUN_GENERIC_NATIVE),
+    JS_FN("push",               array_push,         1,JSFUN_GENERIC_NATIVE),
+    JS_FN("pop",                array_pop,          0,JSFUN_GENERIC_NATIVE),
+    JS_FN("shift",              array_shift,        0,JSFUN_GENERIC_NATIVE),
+    JS_FN("unshift",            array_unshift,      1,JSFUN_GENERIC_NATIVE),
+    JS_FN("splice",             array_splice,       2,JSFUN_GENERIC_NATIVE),
 
     /* Pythonic sequence methods. */
-    JS_FN("concat",             array_concat,       0,1,JSFUN_GENERIC_NATIVE),
-    JS_FN("slice",              array_slice,        0,2,JSFUN_GENERIC_NATIVE),
+    JS_FN("concat",             array_concat,       1,JSFUN_GENERIC_NATIVE),
+    JS_FN("slice",              array_slice,        2,JSFUN_GENERIC_NATIVE),
 
 #if JS_HAS_ARRAY_EXTRAS
-    JS_FN("indexOf",            array_indexOf,      1,1,JSFUN_GENERIC_NATIVE),
-    JS_FN("lastIndexOf",        array_lastIndexOf,  1,1,JSFUN_GENERIC_NATIVE),
-    JS_FN("forEach",            array_forEach,      1,1,JSFUN_GENERIC_NATIVE),
-    JS_FN("map",                array_map,          1,1,JSFUN_GENERIC_NATIVE),
-    JS_FN("reduce",             array_reduce,       1,1,JSFUN_GENERIC_NATIVE),
-    JS_FN("reduceRight",        array_reduceRight,  1,1,JSFUN_GENERIC_NATIVE),
-    JS_FN("filter",             array_filter,       1,1,JSFUN_GENERIC_NATIVE),
-    JS_FN("some",               array_some,         1,1,JSFUN_GENERIC_NATIVE),
-    JS_FN("every",              array_every,        1,1,JSFUN_GENERIC_NATIVE),
+    JS_FN("indexOf",            array_indexOf,      1,JSFUN_GENERIC_NATIVE),
+    JS_FN("lastIndexOf",        array_lastIndexOf,  1,JSFUN_GENERIC_NATIVE),
+    JS_FN("forEach",            array_forEach,      1,JSFUN_GENERIC_NATIVE),
+    JS_FN("map",                array_map,          1,JSFUN_GENERIC_NATIVE),
+    JS_FN("reduce",             array_reduce,       1,JSFUN_GENERIC_NATIVE),
+    JS_FN("reduceRight",        array_reduceRight,  1,JSFUN_GENERIC_NATIVE),
+    JS_FN("filter",             array_filter,       1,JSFUN_GENERIC_NATIVE),
+    JS_FN("some",               array_some,         1,JSFUN_GENERIC_NATIVE),
+    JS_FN("every",              array_every,        1,JSFUN_GENERIC_NATIVE),
 #endif
 
     JS_FS_END
 };
 
diff --git a/js/src/jsbool.cpp b/js/src/jsbool.cpp
--- a/js/src/jsbool.cpp
+++ b/js/src/jsbool.cpp
@@ -115,14 +115,14 @@ bool_valueOf(JSContext *cx, uintN argc, 
     return js_GetPrimitiveThis(cx, vp, &js_BooleanClass, vp);
 }
 
 static JSFunctionSpec boolean_methods[] = {
 #if JS_HAS_TOSOURCE
-    JS_FN(js_toSource_str,  bool_toSource,  0, 0, JSFUN_THISP_BOOLEAN),
+    JS_FN(js_toSource_str,  bool_toSource,  0, JSFUN_THISP_BOOLEAN),
 #endif
-    JS_FN(js_toString_str,  bool_toString,  0, 0, JSFUN_THISP_BOOLEAN),
-    JS_FN(js_valueOf_str,   bool_valueOf,   0, 0, JSFUN_THISP_BOOLEAN),
+    JS_FN(js_toString_str,  bool_toString,  0, JSFUN_THISP_BOOLEAN),
+    JS_FN(js_valueOf_str,   bool_valueOf,   0, JSFUN_THISP_BOOLEAN),
     JS_FS_END
 };
 
 static JSBool
 Boolean(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
diff --git a/js/src/jscntxt.cpp b/js/src/jscntxt.cpp
--- a/js/src/jscntxt.cpp
+++ b/js/src/jscntxt.cpp
@@ -53,10 +53,11 @@
 #include "jsatom.h"
 #include "jscntxt.h"
 #include "jsconfig.h"
 #include "jsdbgapi.h"
 #include "jsexn.h"
+#include "jsfun.h"
 #include "jsgc.h"
 #include "jslock.h"
 #include "jsnum.h"
 #include "jsobj.h"
 #include "jsopcode.h"
@@ -1279,10 +1280,32 @@ js_ReportIsNullOrUndefined(JSContext *cx
 
     JS_free(cx, bytes);
     return ok;
 }
 
+void
+js_ReportMissingArg(JSContext *cx, jsval *vp, uintN arg)
+{
+    char argbuf[11];
+    char *bytes;
+    JSAtom *atom;
+
+    JS_snprintf(argbuf, sizeof argbuf, "%u", arg);
+    bytes = NULL;
+    if (VALUE_IS_FUNCTION(cx, *vp)) {
+        atom = GET_FUNCTION_PRIVATE(cx, JSVAL_TO_OBJECT(*vp))->atom;
+        bytes = js_DecompileValueGenerator(cx, JSDVG_SEARCH_STACK, *vp,
+                                           ATOM_TO_STRING(atom));
+        if (!bytes)
+            return;
+    }
+    JS_ReportErrorNumber(cx, js_GetErrorMessage, NULL,
+                         JSMSG_MISSING_FUN_ARG, argbuf,
+                         bytes ? bytes : "");
+    JS_free(cx, bytes);
+}
+
 JSBool
 js_ReportValueErrorFlags(JSContext *cx, uintN flags, const uintN errorNumber,
                          intN spindex, jsval v, JSString *fallback,
                          const char *arg1, const char *arg2)
 {
diff --git a/js/src/jscntxt.h b/js/src/jscntxt.h
--- a/js/src/jscntxt.h
+++ b/js/src/jscntxt.h
@@ -1020,10 +1020,13 @@ js_ReportIsNotDefined(JSContext *cx, con
  */
 extern JSBool
 js_ReportIsNullOrUndefined(JSContext *cx, intN spindex, jsval v,
                            JSString *fallback);
 
+extern void
+js_ReportMissingArg(JSContext *cx, jsval *vp, uintN arg);
+
 /*
  * Report error using js_DecompileValueGenerator(cx, spindex, v, fallback) as
  * the first argument for the error message. If the error message has less
  * then 3 arguments, use null for arg1 or arg2.
  */
diff --git a/js/src/jsconfig.h b/js/src/jsconfig.h
--- a/js/src/jsconfig.h
+++ b/js/src/jsconfig.h
@@ -84,11 +84,10 @@
 #define JS_HAS_OBJ_PROTO_PROP   1       /* has o.__proto__ etc. */
 #else
 #define JS_HAS_OBJ_PROTO_PROP   0       /* has o.__proto__ etc. */
 #endif
 #define JS_HAS_OBJ_WATCHPOINT   0       /* has o.watch and o.unwatch */
-#define JS_HAS_EXPORT_IMPORT    0       /* has export fun; import obj.fun */
 #define JS_HAS_EVAL_THIS_SCOPE  0       /* Math.eval is same as with (Math) */
 #define JS_HAS_SHARP_VARS       0       /* has #n=, #n# for object literals */
 #define JS_HAS_SCRIPT_OBJECT    0       /* has (new Script("x++")).exec() */
 #define JS_HAS_XDR              0       /* has XDR API and internal support */
 #define JS_HAS_XDR_FREEZE_THAW  0       /* has XDR freeze/thaw script methods */
@@ -118,11 +117,10 @@
 
 #define JS_HAS_STR_HTML_HELPERS 1       /* has str.anchor, str.bold, etc. */
 #define JS_HAS_PERL_SUBSTR      1       /* has str.substr */
 #define JS_HAS_OBJ_PROTO_PROP   1       /* has o.__proto__ etc. */
 #define JS_HAS_OBJ_WATCHPOINT   1       /* has o.watch and o.unwatch */
-#define JS_HAS_EXPORT_IMPORT    1       /* has export fun; import obj.fun */
 #define JS_HAS_EVAL_THIS_SCOPE  1       /* Math.eval is same as with (Math) */
 #define JS_HAS_SHARP_VARS       1       /* has #n=, #n# for object literals */
 #define JS_HAS_SCRIPT_OBJECT    1       /* has (new Script("x++")).exec() */
 #define JS_HAS_XDR              1       /* has XDR API and internal support */
 #define JS_HAS_XDR_FREEZE_THAW  0       /* has XDR freeze/thaw script methods */
@@ -148,11 +146,10 @@
 
 #define JS_HAS_STR_HTML_HELPERS 1       /* has str.anchor, str.bold, etc. */
 #define JS_HAS_PERL_SUBSTR      1       /* has str.substr */
 #define JS_HAS_OBJ_PROTO_PROP   1       /* has o.__proto__ etc. */
 #define JS_HAS_OBJ_WATCHPOINT   1       /* has o.watch and o.unwatch */
-#define JS_HAS_EXPORT_IMPORT    1       /* has export fun; import obj.fun */
 #define JS_HAS_EVAL_THIS_SCOPE  1       /* Math.eval is same as with (Math) */
 #define JS_HAS_SHARP_VARS       1       /* has #n=, #n# for object literals */
 #define JS_HAS_SCRIPT_OBJECT    1       /* has (new Script("x++")).exec() */
 #define JS_HAS_XDR              1       /* has XDR API and internal support */
 #define JS_HAS_XDR_FREEZE_THAW  0       /* has XDR freeze/thaw script methods */
@@ -178,11 +175,10 @@
 
 #define JS_HAS_STR_HTML_HELPERS 1       /* has str.anchor, str.bold, etc. */
 #define JS_HAS_PERL_SUBSTR      1       /* has str.substr */
 #define JS_HAS_OBJ_PROTO_PROP   1       /* has o.__proto__ etc. */
 #define JS_HAS_OBJ_WATCHPOINT   1       /* has o.watch and o.unwatch */
-#define JS_HAS_EXPORT_IMPORT    1       /* has export fun; import obj.fun */
 #define JS_HAS_EVAL_THIS_SCOPE  1       /* Math.eval is same as with (Math) */
 #define JS_HAS_SHARP_VARS       1       /* has #n=, #n# for object literals */
 #define JS_HAS_SCRIPT_OBJECT    0       /* has (new Script("x++")).exec() */
 #define JS_HAS_XDR              1       /* has XDR API and internal support */
 #define JS_HAS_XDR_FREEZE_THAW  0       /* has XDR freeze/thaw script methods */
@@ -208,11 +204,10 @@
 
 #define JS_HAS_STR_HTML_HELPERS 1       /* has str.anchor, str.bold, etc. */
 #define JS_HAS_PERL_SUBSTR      1       /* has str.substr */
 #define JS_HAS_OBJ_PROTO_PROP   1       /* has o.__proto__ etc. */
 #define JS_HAS_OBJ_WATCHPOINT   1       /* has o.watch and o.unwatch */
-#define JS_HAS_EXPORT_IMPORT    1       /* has export fun; import obj.fun */
 #define JS_HAS_EVAL_THIS_SCOPE  1       /* Math.eval is same as with (Math) */
 #define JS_HAS_SHARP_VARS       1       /* has #n=, #n# for object literals */
 #define JS_HAS_SCRIPT_OBJECT    0       /* has (new Script("x++")).exec() */
 #define JS_HAS_XDR              1       /* has XDR API and internal support */
 #define JS_HAS_XDR_FREEZE_THAW  0       /* has XDR freeze/thaw script methods */
diff --git a/js/src/jsdate.cpp b/js/src/jsdate.cpp
--- a/js/src/jsdate.cpp
+++ b/js/src/jsdate.cpp
@@ -467,11 +467,11 @@ msFromTime(jsdouble t)
                      ? js_DoubleToInteger(d + (+0.)) : *cx->runtime->jsNaN)
 
 /**
  * end of ECMA 'support' functions
  */
-
+
 /*
  * Other Support routines and definitions
  */
 
 /*
@@ -599,11 +599,10 @@ date_msecFromArgs(JSContext *cx, uintN a
                                   array[3], array[4], array[5], array[6]);
     *rval = msec_time;
     return JS_TRUE;
 }
 
-
 /*
  * See ECMA 15.9.4.[3-10];
  */
 static JSBool
 date_UTC(JSContext *cx, uintN argc, jsval *vp)
@@ -891,13 +890,18 @@ date_parse(JSContext *cx, uintN argc, js
 date_parse(JSContext *cx, uintN argc, jsval *vp)
 {
     JSString *str;
     jsdouble result;
 
+    if (argc == 0) {
+        *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+        return JS_TRUE;
+    }
     str = js_ValueToString(cx, vp[2]);
     if (!str)
         return JS_FALSE;
+    vp[2] = STRING_TO_JSVAL(str);
     if (!date_parseString(str, &result)) {
         *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
         return JS_TRUE;
     }
 
@@ -1257,14 +1261,28 @@ date_getTimezoneOffset(JSContext *cx, ui
     result = (utctime - localtime) / msPerMinute;
     return js_NewNumberInRootedValue(cx, result, vp);
 }
 
 static JSBool
+SetDateToNaN(JSContext *cx, jsval *vp)
+{
+    JSObject *obj;
+
+    obj = JS_THIS_OBJECT(cx, vp);
+    if (!SetUTCTimePtr(cx, obj, NULL, cx->runtime->jsNaN))
+        return JS_FALSE;
+    *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+    return JS_TRUE;
+}
+
+static JSBool
 date_setTime(JSContext *cx, uintN argc, jsval *vp)
 {
     jsdouble result;
 
+    if (argc == 0)
+        return SetDateToNaN(cx, vp);
     result = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
 
     result = TIMECLIP(result);
@@ -1304,26 +1322,22 @@ date_makeTime(JSContext *cx, uintN maxar
      * beyond the first argument; this should be set to undefined
      * if it's not given.  This means that "d = new Date();
      * d.setMilliseconds()" returns NaN.  Blech.
      */
     if (argc == 0)
-        argc = 1;   /* should be safe, because length of all setters is 1 */
-    else if (argc > maxargs)
+        return SetDateToNaN(cx, vp);
+    if (argc > maxargs)
         argc = maxargs;  /* clamp argc */
-    JS_ASSERT(1 <= argc && argc <= 4);
+    JS_ASSERT(argc <= 4);
 
     argv = vp + 2;
     for (i = 0; i < argc; i++) {
         args[i] = js_ValueToNumber(cx, &argv[i]);
         if (JSVAL_IS_NULL(argv[i]))
             return JS_FALSE;
-        if (!JSDOUBLE_IS_FINITE(args[i])) {
-            if (!SetUTCTimePtr(cx, obj, NULL, cx->runtime->jsNaN))
-                return JS_FALSE;
-            *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
-            return JS_TRUE;
-        }
+        if (!JSDOUBLE_IS_FINITE(args[i]))
+            return SetDateToNaN(cx, vp);
         args[i] = js_DoubleToInteger(args[i]);
     }
 
     if (local)
         lorutime = LocalTime(result);
@@ -1432,26 +1446,22 @@ date_makeDate(JSContext *cx, uintN maxar
     if (!GetUTCTime(cx, obj, vp, &result))
         return JS_FALSE;
 
     /* see complaint about ECMA in date_MakeTime */
     if (argc == 0)
-        argc = 1;   /* should be safe, because length of all setters is 1 */
-    else if (argc > maxargs)
+        return SetDateToNaN(cx, vp);
+    if (argc > maxargs)
         argc = maxargs;   /* clamp argc */
     JS_ASSERT(1 <= argc && argc <= 3);
 
     argv = vp + 2;
     for (i = 0; i < argc; i++) {
         args[i] = js_ValueToNumber(cx, &argv[i]);
         if (JSVAL_IS_NULL(argv[i]))
             return JS_FALSE;
-        if (!JSDOUBLE_IS_FINITE(args[i])) {
-            if (!SetUTCTimePtr(cx, obj, NULL, cx->runtime->jsNaN))
-                return JS_FALSE;
-            *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
-            return JS_TRUE;
-        }
+        if (!JSDOUBLE_IS_FINITE(args[i]))
+            return SetDateToNaN(cx, vp);
         args[i] = js_DoubleToInteger(args[i]);
     }
 
     /* return NaN if date is NaN and we're not setting the year,
      * If we are, use 0 as the time. */
@@ -1540,18 +1550,17 @@ date_setYear(JSContext *cx, uintN argc, 
 
     obj = JS_THIS_OBJECT(cx, vp);
     if (!GetUTCTime(cx, obj, vp, &result))
         return JS_FALSE;
 
+    if (argc == 0)
+        return SetDateToNaN(cx, vp);
     year = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
-    if (!JSDOUBLE_IS_FINITE(year)) {
-        if (!SetUTCTimePtr(cx, obj, NULL, cx->runtime->jsNaN))
-            return JS_FALSE;
-        return js_NewNumberInRootedValue(cx, *cx->runtime->jsNaN, vp);
-    }
+    if (!JSDOUBLE_IS_FINITE(year))
+        return SetDateToNaN(cx, vp);
 
     year = js_DoubleToInteger(year);
 
     if (!JSDOUBLE_IS_FINITE(result)) {
         t = +0.0;
@@ -1954,70 +1963,69 @@ date_valueOf(JSContext *cx, uintN argc, 
     if (js_EqualStrings(str, str2))
         return date_getTime(cx, argc, vp);
     return date_toString(cx, argc, vp);
 }
 
-
 /*
  * creation and destruction
  */
 
 static JSFunctionSpec date_static_methods[] = {
-    JS_FN("UTC",                 date_UTC,                2,MAXARGS,0),
-    JS_FN("parse",               date_parse,              1,1,0),
-    JS_FN("now",                 date_now,                0,0,0),
+    JS_FN("UTC",                 date_UTC,                MAXARGS,0),
+    JS_FN("parse",               date_parse,              1,0),
+    JS_FN("now",                 date_now,                0,0),
     JS_FS_END
 };
 
 static JSFunctionSpec date_methods[] = {
-    JS_FN("getTime",             date_getTime,            0,0,0),
-    JS_FN("getTimezoneOffset",   date_getTimezoneOffset,  0,0,0),
-    JS_FN("getYear",             date_getYear,            0,0,0),
-    JS_FN("getFullYear",         date_getFullYear,        0,0,0),
-    JS_FN("getUTCFullYear",      date_getUTCFullYear,     0,0,0),
-    JS_FN("getMonth",            date_getMonth,           0,0,0),
-    JS_FN("getUTCMonth",         date_getUTCMonth,        0,0,0),
-    JS_FN("getDate",             date_getDate,            0,0,0),
-    JS_FN("getUTCDate",          date_getUTCDate,         0,0,0),
-    JS_FN("getDay",              date_getDay,             0,0,0),
-    JS_FN("getUTCDay",           date_getUTCDay,          0,0,0),
-    JS_FN("getHours",            date_getHours,           0,0,0),
-    JS_FN("getUTCHours",         date_getUTCHours,        0,0,0),
-    JS_FN("getMinutes",          date_getMinutes,         0,0,0),
-    JS_FN("getUTCMinutes",       date_getUTCMinutes,      0,0,0),
-    JS_FN("getSeconds",          date_getUTCSeconds,      0,0,0),
-    JS_FN("getUTCSeconds",       date_getUTCSeconds,      0,0,0),
-    JS_FN("getMilliseconds",     date_getUTCMilliseconds, 0,0,0),
-    JS_FN("getUTCMilliseconds",  date_getUTCMilliseconds, 0,0,0),
-    JS_FN("setTime",             date_setTime,            1,1,0),
-    JS_FN("setYear",             date_setYear,            1,1,0),
-    JS_FN("setFullYear",         date_setFullYear,        1,3,0),
-    JS_FN("setUTCFullYear",      date_setUTCFullYear,     1,3,0),
-    JS_FN("setMonth",            date_setMonth,           1,2,0),
-    JS_FN("setUTCMonth",         date_setUTCMonth,        1,2,0),
-    JS_FN("setDate",             date_setDate,            1,1,0),
-    JS_FN("setUTCDate",          date_setUTCDate,         1,1,0),
-    JS_FN("setHours",            date_setHours,           1,4,0),
-    JS_FN("setUTCHours",         date_setUTCHours,        1,4,0),
-    JS_FN("setMinutes",          date_setMinutes,         1,3,0),
-    JS_FN("setUTCMinutes",       date_setUTCMinutes,      1,3,0),
-    JS_FN("setSeconds",          date_setSeconds,         1,2,0),
-    JS_FN("setUTCSeconds",       date_setUTCSeconds,      1,2,0),
-    JS_FN("setMilliseconds",     date_setMilliseconds,    1,1,0),
-    JS_FN("setUTCMilliseconds",  date_setUTCMilliseconds, 1,1,0),
-    JS_FN("toUTCString",         date_toGMTString,        0,0,0),
-    JS_FN(js_toLocaleString_str, date_toLocaleString,     0,0,0),
-    JS_FN("toLocaleDateString",  date_toLocaleDateString, 0,0,0),
-    JS_FN("toLocaleTimeString",  date_toLocaleTimeString, 0,0,0),
-    JS_FN("toLocaleFormat",      date_toLocaleFormat,     0,0,0),
-    JS_FN("toDateString",        date_toDateString,       0,0,0),
-    JS_FN("toTimeString",        date_toTimeString,       0,0,0),
+    JS_FN("getTime",             date_getTime,            0,0),
+    JS_FN("getTimezoneOffset",   date_getTimezoneOffset,  0,0),
+    JS_FN("getYear",             date_getYear,            0,0),
+    JS_FN("getFullYear",         date_getFullYear,        0,0),
+    JS_FN("getUTCFullYear",      date_getUTCFullYear,     0,0),
+    JS_FN("getMonth",            date_getMonth,           0,0),
+    JS_FN("getUTCMonth",         date_getUTCMonth,        0,0),
+    JS_FN("getDate",             date_getDate,            0,0),
+    JS_FN("getUTCDate",          date_getUTCDate,         0,0),
+    JS_FN("getDay",              date_getDay,             0,0),
+    JS_FN("getUTCDay",           date_getUTCDay,          0,0),
+    JS_FN("getHours",            date_getHours,           0,0),
+    JS_FN("getUTCHours",         date_getUTCHours,        0,0),
+    JS_FN("getMinutes",          date_getMinutes,         0,0),
+    JS_FN("getUTCMinutes",       date_getUTCMinutes,      0,0),
+    JS_FN("getSeconds",          date_getUTCSeconds,      0,0),
+    JS_FN("getUTCSeconds",       date_getUTCSeconds,      0,0),
+    JS_FN("getMilliseconds",     date_getUTCMilliseconds, 0,0),
+    JS_FN("getUTCMilliseconds",  date_getUTCMilliseconds, 0,0),
+    JS_FN("setTime",             date_setTime,            1,0),
+    JS_FN("setYear",             date_setYear,            1,0),
+    JS_FN("setFullYear",         date_setFullYear,        3,0),
+    JS_FN("setUTCFullYear",      date_setUTCFullYear,     3,0),
+    JS_FN("setMonth",            date_setMonth,           2,0),
+    JS_FN("setUTCMonth",         date_setUTCMonth,        2,0),
+    JS_FN("setDate",             date_setDate,            1,0),
+    JS_FN("setUTCDate",          date_setUTCDate,         1,0),
+    JS_FN("setHours",            date_setHours,           4,0),
+    JS_FN("setUTCHours",         date_setUTCHours,        4,0),
+    JS_FN("setMinutes",          date_setMinutes,         3,0),
+    JS_FN("setUTCMinutes",       date_setUTCMinutes,      3,0),
+    JS_FN("setSeconds",          date_setSeconds,         2,0),
+    JS_FN("setUTCSeconds",       date_setUTCSeconds,      2,0),
+    JS_FN("setMilliseconds",     date_setMilliseconds,    1,0),
+    JS_FN("setUTCMilliseconds",  date_setUTCMilliseconds, 1,0),
+    JS_FN("toUTCString",         date_toGMTString,        0,0),
+    JS_FN(js_toLocaleString_str, date_toLocaleString,     0,0),
+    JS_FN("toLocaleDateString",  date_toLocaleDateString, 0,0),
+    JS_FN("toLocaleTimeString",  date_toLocaleTimeString, 0,0),
+    JS_FN("toLocaleFormat",      date_toLocaleFormat,     0,0),
+    JS_FN("toDateString",        date_toDateString,       0,0),
+    JS_FN("toTimeString",        date_toTimeString,       0,0),
 #if JS_HAS_TOSOURCE
-    JS_FN(js_toSource_str,       date_toSource,           0,0,0),
+    JS_FN(js_toSource_str,       date_toSource,           0,0),
 #endif
-    JS_FN(js_toString_str,       date_toString,           0,0,0),
-    JS_FN(js_valueOf_str,        date_valueOf,            0,0,0),
+    JS_FN(js_toString_str,       date_toString,           0,0),
+    JS_FN(js_valueOf_str,        date_valueOf,            0,0),
     JS_FS_END
 };
 
 static jsdouble *
 date_constructor(JSContext *cx, JSObject* obj)
diff --git a/js/src/jsdtoa.cpp b/js/src/jsdtoa.cpp
--- a/js/src/jsdtoa.cpp
+++ b/js/src/jsdtoa.cpp
@@ -49,135 +49,13 @@
 #include "jspubtd.h"
 #include "jsnum.h"
 #include "jsbit.h"
 
 #ifdef JS_THREADSAFE
-#include "prlock.h"
+#include "jslock.h"
 #endif
 
-/****************************************************************
- *
- * The author of this software is David M. Gay.
- *
- * Copyright (c) 1991 by Lucent Technologies.
- *
- * Permission to use, copy, modify, and distribute this software for any
- * purpose without fee is hereby granted, provided that this entire notice
- * is included in all copies of any software which is or includes a copy
- * or modification of this software and in all copies of the supporting
- * documentation for such software.
- *
- * THIS SOFTWARE IS BEING PROVIDED "AS IS", WITHOUT ANY EXPRESS OR IMPLIED
- * WARRANTY.  IN PARTICULAR, NEITHER THE AUTHOR NOR LUCENT MAKES ANY
- * REPRESENTATION OR WARRANTY OF ANY KIND CONCERNING THE MERCHANTABILITY
- * OF THIS SOFTWARE OR ITS FITNESS FOR ANY PARTICULAR PURPOSE.
- *
- ***************************************************************/
-
-/* Please send bug reports to
-    David M. Gay
-    Bell Laboratories, Room 2C-463
-    600 Mountain Avenue
-    Murray Hill, NJ 07974-0636
-    U.S.A.
-    dmg@bell-labs.com
- */
-
-/* On a machine with IEEE extended-precision registers, it is
- * necessary to specify double-precision (53-bit) rounding precision
- * before invoking strtod or dtoa.  If the machine uses (the equivalent
- * of) Intel 80x87 arithmetic, the call
- *  _control87(PC_53, MCW_PC);
- * does this with many compilers.  Whether this or another call is
- * appropriate depends on the compiler; for this to work, it may be
- * necessary to #include "float.h" or another system-dependent header
- * file.
- */
-
-/* strtod for IEEE-arithmetic machines.
- *
- * This strtod returns a nearest machine number to the input decimal
- * string (or sets err to JS_DTOA_ERANGE or JS_DTOA_ENOMEM).  With IEEE
- * arithmetic, ties are broken by the IEEE round-even rule.  Otherwise
- * ties are broken by biased rounding (add half and chop).
- *
- * Inspired loosely by William D. Clinger's paper "How to Read Floating
- * Point Numbers Accurately" [Proc. ACM SIGPLAN '90, pp. 92-101].
- *
- * Modifications:
- *
- *  1. We only require IEEE double-precision
- *      arithmetic (not IEEE double-extended).
- *  2. We get by with floating-point arithmetic in a case that
- *      Clinger missed -- when we're computing d * 10^n
- *      for a small integer d and the integer n is not too
- *      much larger than 22 (the maximum integer k for which
- *      we can represent 10^k exactly), we may be able to
- *      compute (d*10^k) * 10^(e-k) with just one roundoff.
- *  3. Rather than a bit-at-a-time adjustment of the binary
- *      result in the hard case, we use floating-point
- *      arithmetic to determine the adjustment to within
- *      one bit; only in really hard cases do we need to
- *      compute a second residual.
- *  4. Because of 3., we don't need a large table of powers of 10
- *      for ten-to-e (just some small tables, e.g. of 10^k
- *      for 0 <= k <= 22).
- */
-
-/*
- * #define IEEE_8087 for IEEE-arithmetic machines where the least
- *  significant byte has the lowest address.
- * #define IEEE_MC68k for IEEE-arithmetic machines where the most
- *  significant byte has the lowest address.
- * #define Long int on machines with 32-bit ints and 64-bit longs.
- * #define Sudden_Underflow for IEEE-format machines without gradual
- *  underflow (i.e., that flush to zero on underflow).
- * #define No_leftright to omit left-right logic in fast floating-point
- *  computation of js_dtoa.
- * #define Check_FLT_ROUNDS if FLT_ROUNDS can assume the values 2 or 3.
- * #define RND_PRODQUOT to use rnd_prod and rnd_quot (assembly routines
- *  that use extended-precision instructions to compute rounded
- *  products and quotients) with IBM.
- * #define ROUND_BIASED for IEEE-format with biased rounding.
- * #define Inaccurate_Divide for IEEE-format with correctly rounded
- *  products but inaccurate quotients, e.g., for Intel i860.
- * #define JS_HAVE_LONG_LONG on machines that have a "long long"
- *  integer type (of >= 64 bits).  If long long is available and the name is
- *  something other than "long long", #define Llong to be the name,
- *  and if "unsigned Llong" does not work as an unsigned version of
- *  Llong, #define #ULLong to be the corresponding unsigned type.
- * #define Bad_float_h if your system lacks a float.h or if it does not
- *  define some or all of DBL_DIG, DBL_MAX_10_EXP, DBL_MAX_EXP,
- *  FLT_RADIX, FLT_ROUNDS, and DBL_MAX.
- * #define MALLOC your_malloc, where your_malloc(n) acts like malloc(n)
- *  if memory is available and otherwise does something you deem
- *  appropriate.  If MALLOC is undefined, malloc will be invoked
- *  directly -- and assumed always to succeed.
- * #define Omit_Private_Memory to omit logic (added Jan. 1998) for making
- *  memory allocations from a private pool of memory when possible.
- *  When used, the private pool is PRIVATE_MEM bytes long: 2000 bytes,
- *  unless #defined to be a different length.  This default length
- *  suffices to get rid of MALLOC calls except for unusual cases,
- *  such as decimal-to-binary conversion of a very long string of
- *  digits.
- * #define INFNAN_CHECK on IEEE systems to cause strtod to check for
- *  Infinity and NaN (case insensitively).  On some systems (e.g.,
- *  some HP systems), it may be necessary to #define NAN_WORD0
- *  appropriately -- to the most significant word of a quiet NaN.
- *  (On HP Series 700/800 machines, -DNAN_WORD0=0x7ff40000 works.)
- * #define MULTIPLE_THREADS if the system offers preemptively scheduled
- *  multiple threads.  In this case, you must provide (or suitably
- *  #define) two locks, acquired by ACQUIRE_DTOA_LOCK() and released
- *  by RELEASE_DTOA_LOCK().  (The second lock, accessed
- *  in pow5mult, ensures lazy evaluation of only one copy of high
- *  powers of 5; omitting this lock would introduce a small
- *  probability of wasting memory, but would otherwise be harmless.)
- *  You must also invoke freedtoa(s) to free the value s returned by
- *  dtoa.  You may do so whether or not MULTIPLE_THREADS is #defined.
- * #define NO_IEEE_Scale to disable new (Feb. 1997) logic in strtod that
- *  avoids underflows on inputs whose result does not underflow.
- */
 #ifdef IS_LITTLE_ENDIAN
 #define IEEE_8087
 #else
 #define IEEE_MC68k
 #endif
@@ -188,2634 +66,125 @@
 
 #ifndef ULong
 #define ULong uint32
 #endif
 
-#define Bug(errorMessageString) JS_ASSERT(!errorMessageString)
-
-#include "stdlib.h"
-#include "string.h"
-
-#ifdef MALLOC
-extern void *MALLOC(size_t);
-#else
-#define MALLOC malloc
-#endif
-
-#define Omit_Private_Memory
-/* Private memory currently doesn't work with JS_THREADSAFE */
-#ifndef Omit_Private_Memory
-#ifndef PRIVATE_MEM
-#define PRIVATE_MEM 2000
-#endif
-#define PRIVATE_mem ((PRIVATE_MEM+sizeof(double)-1)/sizeof(double))
-static double private_mem[PRIVATE_mem], *pmem_next = private_mem;
-#endif
-
-#ifdef Bad_float_h
-#undef __STDC__
-
-#define DBL_DIG 15
-#define DBL_MAX_10_EXP 308
-#define DBL_MAX_EXP 1024
-#define FLT_RADIX 2
-#define FLT_ROUNDS 1
-#define DBL_MAX 1.7976931348623157e+308
-
-
-
-#ifndef LONG_MAX
-#define LONG_MAX 2147483647
-#endif
-
-#else /* ifndef Bad_float_h */
-#include "float.h"
-#endif /* Bad_float_h */
-
-#ifndef __MATH_H__
-#include "math.h"
-#endif
-
-#ifndef CONST
-#define CONST const
-#endif
-
-#if defined(IEEE_8087) + defined(IEEE_MC68k) != 1
-Exactly one of IEEE_8087 or IEEE_MC68k should be defined.
-#endif
-
-#define word0(x)        JSDOUBLE_HI32(x)
-#define set_word0(x, y) JSDOUBLE_SET_HI32(x, y)
-#define word1(x)        JSDOUBLE_LO32(x)
-#define set_word1(x, y) JSDOUBLE_SET_LO32(x, y)
-
-#define Storeinc(a,b,c) (*(a)++ = (b) << 16 | (c) & 0xffff)
-
-/* #define P DBL_MANT_DIG */
-/* Ten_pmax = floor(P*log(2)/log(5)) */
-/* Bletch = (highest power of 2 < DBL_MAX_10_EXP) / 16 */
-/* Quick_max = floor((P-1)*log(FLT_RADIX)/log(10) - 1) */
-/* Int_max = floor(P*log(FLT_RADIX)/log(10) - 1) */
-
-#define Exp_shift  20
-#define Exp_shift1 20
-#define Exp_msk1    0x100000
-#define Exp_msk11   0x100000
-#define Exp_mask  0x7ff00000
-#define P 53
-#define Bias 1023
-#define Emin (-1022)
-#define Exp_1  0x3ff00000
-#define Exp_11 0x3ff00000
-#define Ebits 11
-#define Frac_mask  0xfffff
-#define Frac_mask1 0xfffff
-#define Ten_pmax 22
-#define Bletch 0x10
-#define Bndry_mask  0xfffff
-#define Bndry_mask1 0xfffff
-#define LSB 1
-#define Sign_bit 0x80000000
-#define Log2P 1
-#define Tiny0 0
-#define Tiny1 1
-#define Quick_max 14
-#define Int_max 14
-#define Infinite(x) (word0(x) == 0x7ff00000) /* sufficient test for here */
-#ifndef NO_IEEE_Scale
-#define Avoid_Underflow
-#endif
-
-
-
-#ifdef RND_PRODQUOT
-#define rounded_product(a,b) a = rnd_prod(a, b)
-#define rounded_quotient(a,b) a = rnd_quot(a, b)
-extern double rnd_prod(double, double), rnd_quot(double, double);
-#else
-#define rounded_product(a,b) a *= b
-#define rounded_quotient(a,b) a /= b
-#endif
-
-#define Big0 (Frac_mask1 | Exp_msk1*(DBL_MAX_EXP+Bias-1))
-#define Big1 0xffffffff
-
-#ifndef JS_HAVE_LONG_LONG
-#undef ULLong
-#else   /* long long available */
+/*
 #ifndef Llong
 #define Llong JSInt64
 #endif
-#ifndef ULLong
-#define ULLong JSUint64
+
+#ifndef ULlong
+#define ULlong JSUint64
 #endif
-#endif /* JS_HAVE_LONG_LONG */
+*/
 
 #ifdef JS_THREADSAFE
-#define MULTIPLE_THREADS
-static PRLock *freelist_lock;
-#define ACQUIRE_DTOA_LOCK()                                                   \
-    JS_BEGIN_MACRO                                                            \
-        if (!initialized)                                                     \
-            InitDtoa();                                                       \
-        PR_Lock(freelist_lock);                                               \
-    JS_END_MACRO
-#define RELEASE_DTOA_LOCK() PR_Unlock(freelist_lock)
+static PRLock *dtoalock;
+static JSBool _dtoainited = JS_FALSE;
+
+#define LOCK_DTOA() PR_Lock(dtoalock);
+#define UNLOCK_DTOA() PR_Unlock(dtoalock)
 #else
-#undef MULTIPLE_THREADS
-#define ACQUIRE_DTOA_LOCK()   /*nothing*/
-#define RELEASE_DTOA_LOCK()   /*nothing*/
+#define LOCK_DTOA()
+#define UNLOCK_DTOA()
 #endif
+#include "dtoa.c"
 
-#define Kmax 15
+JS_FRIEND_API(JSBool)
+js_InitDtoa()
+{
+#ifdef JS_THREADSAFE
+    if (!_dtoainited) {
+        dtoalock = PR_NewLock();
+        JS_ASSERT(dtoalock);
+        _dtoainited = JS_TRUE;
+    }
 
-struct Bigint {
-    struct Bigint *next;  /* Free list link */
-    int32 k;              /* lg2(maxwds) */
-    int32 maxwds;         /* Number of words allocated for x */
-    int32 sign;           /* Zero if positive, 1 if negative.  Ignored by most Bigint routines! */
-    int32 wds;            /* Actual number of words.  If value is nonzero, the most significant word must be nonzero. */
-    ULong x[1];           /* wds words of number in little endian order */
-};
-
-#ifdef ENABLE_OOM_TESTING
-/* Out-of-memory testing.  Use a good testcase (over and over) and then use
- * these routines to cause a memory failure on every possible Balloc allocation,
- * to make sure that all out-of-memory paths can be followed.  See bug 14044.
- */
-
-static int allocationNum;               /* which allocation is next? */
-static int desiredFailure;              /* which allocation should fail? */
-
-/**
- * js_BigintTestingReset
- *
- * Call at the beginning of a test run to set the allocation failure position.
- * (Set to 0 to just have the engine count allocations without failing.)
- */
-JS_PUBLIC_API(void)
-js_BigintTestingReset(int newFailure)
-{
-    allocationNum = 0;
-    desiredFailure = newFailure;
+    return (dtoalock != 0);
+#else
+    return JS_TRUE;
+#endif
 }
 
-/**
- * js_BigintTestingWhere
- *
- * Report the current allocation position.  This is really only useful when you
- * want to learn how many allocations a test run has.
- */
-JS_PUBLIC_API(int)
-js_BigintTestingWhere()
+JS_FRIEND_API(void)
+js_FinishDtoa()
 {
-    return allocationNum;
+#ifdef JS_THREADSAFE
+    if (_dtoainited) {
+        PR_DestroyLock(dtoalock);
+        dtoalock = NULL;
+        _dtoainited = JS_FALSE;
+    }
+#endif
 }
 
-
-/*
- * So here's what you do: Set up a fantastic test case that exercises the
- * elements of the code you wish.  Set the failure point at 0 and run the test,
- * then get the allocation position.  This number is the number of allocations
- * your test makes.  Now loop from 1 to that number, setting the failure point
- * at each loop count, and run the test over and over, causing failures at each
- * step.  Any memory failure *should* cause a Out-Of-Memory exception; if it
- * doesn't, then there's still an error here.
- */
-#endif
-
-typedef struct Bigint Bigint;
-
-static Bigint *freelist[Kmax+1];
-
-/*
- * Allocate a Bigint with 2^k words.
- * This is not threadsafe. The caller must use thread locks
- */
-static Bigint *Balloc(int32 k)
-{
-    int32 x;
-    Bigint *rv;
-#ifndef Omit_Private_Memory
-    uint32 len;
-#endif
-
-#ifdef ENABLE_OOM_TESTING
-    if (++allocationNum == desiredFailure) {
-        printf("Forced Failing Allocation number %d\n", allocationNum);
-        return NULL;
-    }
-#endif
-
-    if ((rv = freelist[k]) != NULL)
-        freelist[k] = rv->next;
-    if (rv == NULL) {
-        x = 1 << k;
-#ifdef Omit_Private_Memory
-        rv = (Bigint *)MALLOC(sizeof(Bigint) + (x-1)*sizeof(ULong));
-#else
-        len = (sizeof(Bigint) + (x-1)*sizeof(ULong) + sizeof(double) - 1)
-            /sizeof(double);
-        if (pmem_next - private_mem + len <= PRIVATE_mem) {
-            rv = (Bigint*)pmem_next;
-            pmem_next += len;
-            }
-        else
-            rv = (Bigint*)MALLOC(len*sizeof(double));
-#endif
-        if (!rv)
-            return NULL;
-        rv->k = k;
-        rv->maxwds = x;
-    }
-    rv->sign = rv->wds = 0;
-    return rv;
-}
-
-static void Bfree(Bigint *v)
-{
-    if (v) {
-        v->next = freelist[v->k];
-        freelist[v->k] = v;
-    }
-}
-
-#define Bcopy(x,y) memcpy((char *)&x->sign, (char *)&y->sign, \
-                          y->wds*sizeof(Long) + 2*sizeof(int32))
-
-/* Return b*m + a.  Deallocate the old b.  Both a and m must be between 0 and
- * 65535 inclusive.  NOTE: old b is deallocated on memory failure.
- */
-static Bigint *multadd(Bigint *b, int32 m, int32 a)
-{
-    int32 i, wds;
-#ifdef ULLong
-    ULong *x;
-    ULLong carry, y;
-#else
-    ULong carry, *x, y;
-    ULong xi, z;
-#endif
-    Bigint *b1;
-
-#ifdef ENABLE_OOM_TESTING
-    if (++allocationNum == desiredFailure) {
-        /* Faux allocation, because I'm not getting all of the failure paths
-         * without it.
-         */
-        printf("Forced Failing Allocation number %d\n", allocationNum);
-        Bfree(b);
-        return NULL;
-    }
-#endif
-
-    wds = b->wds;
-    x = b->x;
-    i = 0;
-    carry = a;
-    do {
-#ifdef ULLong
-        y = *x * (ULLong)m + carry;
-        carry = y >> 32;
-        *x++ = (ULong)(y & 0xffffffffUL);
-#else
-        xi = *x;
-        y = (xi & 0xffff) * m + carry;
-        z = (xi >> 16) * m + (y >> 16);
-        carry = z >> 16;
-        *x++ = (z << 16) + (y & 0xffff);
-#endif
-    }
-    while(++i < wds);
-    if (carry) {
-        if (wds >= b->maxwds) {
-            b1 = Balloc(b->k+1);
-            if (!b1) {
-                Bfree(b);
-                return NULL;
-            }
-            Bcopy(b1, b);
-            Bfree(b);
-            b = b1;
-        }
-        b->x[wds++] = (ULong)carry;
-        b->wds = wds;
-    }
-    return b;
-}
-
-static Bigint *s2b(CONST char *s, int32 nd0, int32 nd, ULong y9)
-{
-    Bigint *b;
-    int32 i, k;
-    Long x, y;
-
-    x = (nd + 8) / 9;
-    for(k = 0, y = 1; x > y; y <<= 1, k++) ;
-    b = Balloc(k);
-    if (!b)
-        return NULL;
-    b->x[0] = y9;
-    b->wds = 1;
-
-    i = 9;
-    if (9 < nd0) {
-        s += 9;
-        do {
-            b = multadd(b, 10, *s++ - '0');
-            if (!b)
-                return NULL;
-        } while(++i < nd0);
-        s++;
-    }
-    else
-        s += 10;
-    for(; i < nd; i++) {
-        b = multadd(b, 10, *s++ - '0');
-        if (!b)
-            return NULL;
-    }
-    return b;
-}
-
-
-/* Return the number (0 through 32) of most significant zero bits in x. */
-static int32 hi0bits(register ULong x)
-{
-#ifdef JS_HAS_BUILTIN_BITSCAN32
-    return( (!x) ? 32 : js_bitscan_clz32(x) );
-#else
-    register int32 k = 0;
-
-    if (!(x & 0xffff0000)) {
-        k = 16;
-        x <<= 16;
-    }
-    if (!(x & 0xff000000)) {
-        k += 8;
-        x <<= 8;
-    }
-    if (!(x & 0xf0000000)) {
-        k += 4;
-        x <<= 4;
-    }
-    if (!(x & 0xc0000000)) {
-        k += 2;
-        x <<= 2;
-    }
-    if (!(x & 0x80000000)) {
-        k++;
-        if (!(x & 0x40000000))
-            return 32;
-    }
-    return k;
-#endif /* JS_HAS_BUILTIN_BITSCAN32 */
-}
-
-
-/* Return the number (0 through 32) of least significant zero bits in y.
- * Also shift y to the right past these 0 through 32 zeros so that y's
- * least significant bit will be set unless y was originally zero. */
-static int32 lo0bits(ULong *y)
-{
-#ifdef JS_HAS_BUILTIN_BITSCAN32
-    int32 k;
-    ULong x = *y;
-
-   if (x>1)
-      *y = ( x >> (k = js_bitscan_ctz32(x)) );
-   else
-      k = ((x ^ 1) << 5);
-#else
-    register int32 k;
-    register ULong x = *y;
-
-    if (x & 7) {
-        if (x & 1)
-            return 0;
-        if (x & 2) {
-            *y = x >> 1;
-            return 1;
-        }
-        *y = x >> 2;
-        return 2;
-    }
-    k = 0;
-    if (!(x & 0xffff)) {
-        k = 16;
-        x >>= 16;
-    }
-    if (!(x & 0xff)) {
-        k += 8;
-        x >>= 8;
-    }
-    if (!(x & 0xf)) {
-        k += 4;
-        x >>= 4;
-    }
-    if (!(x & 0x3)) {
-        k += 2;
-        x >>= 2;
-    }
-    if (!(x & 1)) {
-        k++;
-        x >>= 1;
-        if (!x & 1)
-            return 32;
-    }
-    *y = x;
-#endif /* JS_HAS_BUILTIN_BITSCAN32 */
-    return k;
-}
-
-/* Return a new Bigint with the given integer value, which must be nonnegative. */
-static Bigint *i2b(int32 i)
-{
-    Bigint *b;
-
-    b = Balloc(1);
-    if (!b)
-        return NULL;
-    b->x[0] = i;
-    b->wds = 1;
-    return b;
-}
-
-/* Return a newly allocated product of a and b. */
-static Bigint *mult(CONST Bigint *a, CONST Bigint *b)
-{
-    CONST Bigint *t;
-    Bigint *c;
-    int32 k, wa, wb, wc;
-    ULong y;
-    ULong *xc, *xc0, *xce;
-    CONST ULong *x, *xa, *xae, *xb, *xbe;
-#ifdef ULLong
-    ULLong carry, z;
-#else
-    ULong carry, z;
-    ULong z2;
-#endif
-
-    if (a->wds < b->wds) {
-        t = a;
-        a = b;
-        b = t;
-    }
-    k = a->k;
-    wa = a->wds;
-    wb = b->wds;
-    wc = wa + wb;
-    if (wc > a->maxwds)
-        k++;
-    c = Balloc(k);
-    if (!c)
-        return NULL;
-    for(xc = c->x, xce = xc + wc; xc < xce; xc++)
-        *xc = 0;
-    xa = a->x;
-    xae = xa + wa;
-    xb = b->x;
-    xbe = xb + wb;
-    xc0 = c->x;
-#ifdef ULLong
-    for(; xb < xbe; xc0++) {
-        if ((y = *xb++) != 0) {
-            x = xa;
-            xc = xc0;
-            carry = 0;
-            do {
-                z = *x++ * (ULLong)y + *xc + carry;
-                carry = z >> 32;
-                *xc++ = (ULong)(z & 0xffffffffUL);
-                }
-                while(x < xae);
-            *xc = (ULong)carry;
-            }
-        }
-#else
-    for(; xb < xbe; xb++, xc0++) {
-        if ((y = *xb & 0xffff) != 0) {
-            x = xa;
-            xc = xc0;
-            carry = 0;
-            do {
-                z = (*x & 0xffff) * y + (*xc & 0xffff) + carry;
-                carry = z >> 16;
-                z2 = (*x++ >> 16) * y + (*xc >> 16) + carry;
-                carry = z2 >> 16;
-                Storeinc(xc, z2, z);
-            }
-            while(x < xae);
-            *xc = carry;
-        }
-        if ((y = *xb >> 16) != 0) {
-            x = xa;
-            xc = xc0;
-            carry = 0;
-            z2 = *xc;
-            do {
-                z = (*x & 0xffff) * y + (*xc >> 16) + carry;
-                carry = z >> 16;
-                Storeinc(xc, z, z2);
-                z2 = (*x++ >> 16) * y + (*xc & 0xffff) + carry;
-                carry = z2 >> 16;
-            }
-            while(x < xae);
-            *xc = z2;
-        }
-    }
-#endif
-    for(xc0 = c->x, xc = xc0 + wc; wc > 0 && !*--xc; --wc) ;
-    c->wds = wc;
-    return c;
-}
-
-/*
- * 'p5s' points to a linked list of Bigints that are powers of 5.
- * This list grows on demand, and it can only grow: it won't change
- * in any other way.  So if we read 'p5s' or the 'next' field of
- * some Bigint on the list, and it is not NULL, we know it won't
- * change to NULL or some other value.  Only when the value of
- * 'p5s' or 'next' is NULL do we need to acquire the lock and add
- * a new Bigint to the list.
- */
-
-static Bigint *p5s;
-
-#ifdef JS_THREADSAFE
-static PRLock *p5s_lock;
-#endif
-
-/* Return b * 5^k.  Deallocate the old b.  k must be nonnegative. */
-/* NOTE: old b is deallocated on memory failure. */
-static Bigint *pow5mult(Bigint *b, int32 k)
-{
-    Bigint *b1, *p5, *p51;
-    int32 i;
-    static CONST int32 p05[3] = { 5, 25, 125 };
-
-    if ((i = k & 3) != 0) {
-        b = multadd(b, p05[i-1], 0);
-        if (!b)
-            return NULL;
-    }
-
-    if (!(k >>= 2))
-        return b;
-    if (!(p5 = p5s)) {
-#ifdef JS_THREADSAFE
-        /*
-         * We take great care to not call i2b() and Bfree()
-         * while holding the lock.
-         */
-        Bigint *wasted_effort = NULL;
-        p5 = i2b(625);
-        if (!p5) {
-            Bfree(b);
-            return NULL;
-        }
-        /* lock and check again */
-        PR_Lock(p5s_lock);
-        if (!p5s) {
-            /* first time */
-            p5s = p5;
-            p5->next = 0;
-        } else {
-            /* some other thread just beat us */
-            wasted_effort = p5;
-            p5 = p5s;
-        }
-        PR_Unlock(p5s_lock);
-        if (wasted_effort) {
-            Bfree(wasted_effort);
-        }
-#else
-        /* first time */
-        p5 = p5s = i2b(625);
-        if (!p5) {
-            Bfree(b);
-            return NULL;
-        }
-        p5->next = 0;
-#endif
-    }
-    for(;;) {
-        if (k & 1) {
-            b1 = mult(b, p5);
-            Bfree(b);
-            if (!b1)
-                return NULL;
-            b = b1;
-        }
-        if (!(k >>= 1))
-            break;
-        if (!(p51 = p5->next)) {
-#ifdef JS_THREADSAFE
-            Bigint *wasted_effort = NULL;
-            p51 = mult(p5, p5);
-            if (!p51) {
-                Bfree(b);
-                return NULL;
-            }
-            PR_Lock(p5s_lock);
-            if (!p5->next) {
-                p5->next = p51;
-                p51->next = 0;
-            } else {
-                wasted_effort = p51;
-                p51 = p5->next;
-            }
-            PR_Unlock(p5s_lock);
-            if (wasted_effort) {
-                Bfree(wasted_effort);
-            }
-#else
-            p51 = mult(p5,p5);
-            if (!p51) {
-                Bfree(b);
-                return NULL;
-            }
-            p51->next = 0;
-            p5->next = p51;
-#endif
-        }
-        p5 = p51;
-    }
-    return b;
-}
-
-/* Return b * 2^k.  Deallocate the old b.  k must be nonnegative.
- * NOTE: on memory failure, old b is deallocated. */
-static Bigint *lshift(Bigint *b, int32 k)
-{
-    int32 i, k1, n, n1;
-    Bigint *b1;
-    ULong *x, *x1, *xe, z;
-
-    n = k >> 5;
-    k1 = b->k;
-    n1 = n + b->wds + 1;
-    for(i = b->maxwds; n1 > i; i <<= 1)
-        k1++;
-    b1 = Balloc(k1);
-    if (!b1)
-        goto done;
-    x1 = b1->x;
-    for(i = 0; i < n; i++)
-        *x1++ = 0;
-    x = b->x;
-    xe = x + b->wds;
-    if (k &= 0x1f) {
-        k1 = 32 - k;
-        z = 0;
-        do {
-            *x1++ = *x << k | z;
-            z = *x++ >> k1;
-        }
-        while(x < xe);
-        if ((*x1 = z) != 0)
-            ++n1;
-    }
-    else do
-        *x1++ = *x++;
-         while(x < xe);
-    b1->wds = n1 - 1;
-done:
-    Bfree(b);
-    return b1;
-}
-
-/* Return -1, 0, or 1 depending on whether a<b, a==b, or a>b, respectively. */
-static int32 cmp(Bigint *a, Bigint *b)
-{
-    ULong *xa, *xa0, *xb, *xb0;
-    int32 i, j;
-
-    i = a->wds;
-    j = b->wds;
-#ifdef DEBUG
-    if (i > 1 && !a->x[i-1])
-        Bug("cmp called with a->x[a->wds-1] == 0");
-    if (j > 1 && !b->x[j-1])
-        Bug("cmp called with b->x[b->wds-1] == 0");
-#endif
-    if (i -= j)
-        return i;
-    xa0 = a->x;
-    xa = xa0 + j;
-    xb0 = b->x;
-    xb = xb0 + j;
-    for(;;) {
-        if (*--xa != *--xb)
-            return *xa < *xb ? -1 : 1;
-        if (xa <= xa0)
-            break;
-    }
-    return 0;
-}
-
-static Bigint *diff(Bigint *a, Bigint *b)
-{
-    Bigint *c;
-    int32 i, wa, wb;
-    ULong *xa, *xae, *xb, *xbe, *xc;
-#ifdef ULLong
-    ULLong borrow, y;
-#else
-    ULong borrow, y;
-    ULong z;
-#endif
-
-    i = cmp(a,b);
-    if (!i) {
-        c = Balloc(0);
-        if (!c)
-            return NULL;
-        c->wds = 1;
-        c->x[0] = 0;
-        return c;
-    }
-    if (i < 0) {
-        c = a;
-        a = b;
-        b = c;
-        i = 1;
-    }
-    else
-        i = 0;
-    c = Balloc(a->k);
-    if (!c)
-        return NULL;
-    c->sign = i;
-    wa = a->wds;
-    xa = a->x;
-    xae = xa + wa;
-    wb = b->wds;
-    xb = b->x;
-    xbe = xb + wb;
-    xc = c->x;
-    borrow = 0;
-#ifdef ULLong
-    do {
-        y = (ULLong)*xa++ - *xb++ - borrow;
-        borrow = y >> 32 & 1UL;
-        *xc++ = (ULong)(y & 0xffffffffUL);
-        }
-        while(xb < xbe);
-    while(xa < xae) {
-        y = *xa++ - borrow;
-        borrow = y >> 32 & 1UL;
-        *xc++ = (ULong)(y & 0xffffffffUL);
-        }
-#else
-    do {
-        y = (*xa & 0xffff) - (*xb & 0xffff) - borrow;
-        borrow = (y & 0x10000) >> 16;
-        z = (*xa++ >> 16) - (*xb++ >> 16) - borrow;
-        borrow = (z & 0x10000) >> 16;
-        Storeinc(xc, z, y);
-        }
-        while(xb < xbe);
-    while(xa < xae) {
-        y = (*xa & 0xffff) - borrow;
-        borrow = (y & 0x10000) >> 16;
-        z = (*xa++ >> 16) - borrow;
-        borrow = (z & 0x10000) >> 16;
-        Storeinc(xc, z, y);
-        }
-#endif
-    while(!*--xc)
-        wa--;
-    c->wds = wa;
-    return c;
-}
-
-/* Return the absolute difference between x and the adjacent greater-magnitude double number (ignoring exponent overflows). */
-static double ulp(double x)
-{
-    register Long L;
-    double a = 0;
-
-    L = (word0(x) & Exp_mask) - (P-1)*Exp_msk1;
-#ifndef Sudden_Underflow
-    if (L > 0) {
-#endif
-        set_word0(a, L);
-        set_word1(a, 0);
-#ifndef Sudden_Underflow
-    }
-    else {
-        L = -L >> Exp_shift;
-        if (L < Exp_shift) {
-            set_word0(a, 0x80000 >> L);
-            set_word1(a, 0);
-        }
-        else {
-            set_word0(a, 0);
-            L -= Exp_shift;
-            set_word1(a, L >= 31 ? 1 : 1 << (31 - L));
-        }
-    }
-#endif
-    return a;
-}
-
-
-static double b2d(Bigint *a, int32 *e)
-{
-    ULong *xa, *xa0, w, y, z;
-    int32 k;
-    double d = 0;
-#define d0 word0(d)
-#define d1 word1(d)
-#define set_d0(x) set_word0(d, x)
-#define set_d1(x) set_word1(d, x)
-
-    xa0 = a->x;
-    xa = xa0 + a->wds;
-    y = *--xa;
-#ifdef DEBUG
-    if (!y) Bug("zero y in b2d");
-#endif
-    k = hi0bits(y);
-    *e = 32 - k;
-    if (k < Ebits) {
-        set_d0(Exp_1 | y >> (Ebits - k));
-        w = xa > xa0 ? *--xa : 0;
-        set_d1(y << (32-Ebits + k) | w >> (Ebits - k));
-        goto ret_d;
-    }
-    z = xa > xa0 ? *--xa : 0;
-    if (k -= Ebits) {
-        set_d0(Exp_1 | y << k | z >> (32 - k));
-        y = xa > xa0 ? *--xa : 0;
-        set_d1(z << k | y >> (32 - k));
-    }
-    else {
-        set_d0(Exp_1 | y);
-        set_d1(z);
-    }
-  ret_d:
-#undef d0
-#undef d1
-#undef set_d0
-#undef set_d1
-    return d;
-}
-
-
-/* Convert d into the form b*2^e, where b is an odd integer.  b is the returned
- * Bigint and e is the returned binary exponent.  Return the number of significant
- * bits in b in bits.  d must be finite and nonzero. */
-static Bigint *d2b(double d, int32 *e, int32 *bits)
-{
-    Bigint *b;
-    int32 de, i, k;
-    ULong *x, y, z;
-#define d0 word0(d)
-#define d1 word1(d)
-#define set_d0(x) set_word0(d, x)
-#define set_d1(x) set_word1(d, x)
-
-    b = Balloc(1);
-    if (!b)
-        return NULL;
-    x = b->x;
-
-    z = d0 & Frac_mask;
-    set_d0(d0 & 0x7fffffff);  /* clear sign bit, which we ignore */
-#ifdef Sudden_Underflow
-    de = (int32)(d0 >> Exp_shift);
-    z |= Exp_msk11;
-#else
-    if ((de = (int32)(d0 >> Exp_shift)) != 0)
-        z |= Exp_msk1;
-#endif
-    if ((y = d1) != 0) {
-        if ((k = lo0bits(&y)) != 0) {
-            x[0] = y | z << (32 - k);
-            z >>= k;
-        }
-        else
-            x[0] = y;
-        i = b->wds = (x[1] = z) ? 2 : 1;
-    }
-    else {
-        JS_ASSERT(z);
-        k = lo0bits(&z);
-        x[0] = z;
-        i = b->wds = 1;
-        k += 32;
-    }
-#ifndef Sudden_Underflow
-    if (de) {
-#endif
-        *e = de - Bias - (P-1) + k;
-        *bits = P - k;
-#ifndef Sudden_Underflow
-    }
-    else {
-        *e = de - Bias - (P-1) + 1 + k;
-        *bits = 32*i - hi0bits(x[i-1]);
-    }
-#endif
-    return b;
-}
-#undef d0
-#undef d1
-#undef set_d0
-#undef set_d1
-
-
-static double ratio(Bigint *a, Bigint *b)
-{
-    double da, db;
-    int32 k, ka, kb;
-
-    da = b2d(a, &ka);
-    db = b2d(b, &kb);
-    k = ka - kb + 32*(a->wds - b->wds);
-    if (k > 0)
-        set_word0(da, word0(da) + k*Exp_msk1);
-    else {
-        k = -k;
-        set_word0(db, word0(db) + k*Exp_msk1);
-    }
-    return da / db;
-}
-
-static CONST double
-tens[] = {
-    1e0, 1e1, 1e2, 1e3, 1e4, 1e5, 1e6, 1e7, 1e8, 1e9,
-    1e10, 1e11, 1e12, 1e13, 1e14, 1e15, 1e16, 1e17, 1e18, 1e19,
-    1e20, 1e21, 1e22
-};
-
-static CONST double bigtens[] = { 1e16, 1e32, 1e64, 1e128, 1e256 };
-static CONST double tinytens[] = { 1e-16, 1e-32, 1e-64, 1e-128,
-#ifdef Avoid_Underflow
-        9007199254740992.e-256
-#else
-        1e-256
-#endif
-        };
-/* The factor of 2^53 in tinytens[4] helps us avoid setting the underflow */
-/* flag unnecessarily.  It leads to a song and dance at the end of strtod. */
-#define Scale_Bit 0x10
-#define n_bigtens 5
-
-
-#ifdef INFNAN_CHECK
-
-#ifndef NAN_WORD0
-#define NAN_WORD0 0x7ff80000
-#endif
-
-#ifndef NAN_WORD1
-#define NAN_WORD1 0
-#endif
-
-static int match(CONST char **sp, char *t)
-{
-    int c, d;
-    CONST char *s = *sp;
-
-    while(d = *t++) {
-        if ((c = *++s) >= 'A' && c <= 'Z')
-            c += 'a' - 'A';
-        if (c != d)
-            return 0;
-        }
-    *sp = s + 1;
-    return 1;
-    }
-#endif /* INFNAN_CHECK */
-
-
-#ifdef JS_THREADSAFE
-static JSBool initialized = JS_FALSE;
-
-/* hacked replica of nspr _PR_InitDtoa */
-static void InitDtoa(void)
-{
-    freelist_lock = PR_NewLock();
-        p5s_lock = PR_NewLock();
-    initialized = JS_TRUE;
-}
-#endif
-
-void js_FinishDtoa(void)
-{
-    int count;
-    Bigint *temp;
-
-#ifdef JS_THREADSAFE
-    if (initialized == JS_TRUE) {
-        PR_DestroyLock(freelist_lock);
-        PR_DestroyLock(p5s_lock);
-        initialized = JS_FALSE;
-    }
-#endif
-
-    /* clear down the freelist array and p5s */
-
-    /* static Bigint *freelist[Kmax+1]; */
-    for (count = 0; count <= Kmax; count++) {
-        Bigint **listp = &freelist[count];
-        while ((temp = *listp) != NULL) {
-            *listp = temp->next;
-            free(temp);
-        }
-        freelist[count] = NULL;
-    }
-
-    /* static Bigint *p5s; */
-    while (p5s) {
-        temp = p5s;
-        p5s = p5s->next;
-        free(temp);
-    }
-}
-
-/* nspr2 watcom bug ifdef omitted */
-
-JS_FRIEND_API(double)
-JS_strtod(CONST char *s00, char **se, int *err)
-{
-    int32 scale;
-    int32 bb2, bb5, bbe, bd2, bd5, bbbits, bs2, c, dsign,
-        e, e1, esign, i, j, k, nd, nd0, nf, nz, nz0, sign;
-    CONST char *s, *s0, *s1;
-    double aadj, aadj1, adj, rv, rv0;
-    Long L;
-    ULong y, z;
-    Bigint *bb, *bb1, *bd, *bd0, *bs, *delta;
-
-    *err = 0;
-
-    bb = bd = bs = delta = NULL;
-    sign = nz0 = nz = 0;
-    rv = 0.;
-
-    /* Locking for Balloc's shared buffers that will be used in this block */
-    ACQUIRE_DTOA_LOCK();
-
-    for(s = s00;;s++) switch(*s) {
-    case '-':
-        sign = 1;
-        /* no break */
-    case '+':
-        if (*++s)
-            goto break2;
-        /* no break */
-    case 0:
-        s = s00;
-        goto ret;
-    case '\t':
-    case '\n':
-    case '\v':
-    case '\f':
-    case '\r':
-    case ' ':
-        continue;
-    default:
-        goto break2;
-    }
-break2:
-
-    if (*s == '0') {
-        nz0 = 1;
-        while(*++s == '0') ;
-        if (!*s)
-            goto ret;
-    }
-    s0 = s;
-    y = z = 0;
-    for(nd = nf = 0; (c = *s) >= '0' && c <= '9'; nd++, s++)
-        if (nd < 9)
-            y = 10*y + c - '0';
-        else if (nd < 16)
-            z = 10*z + c - '0';
-    nd0 = nd;
-    if (c == '.') {
-        c = *++s;
-        if (!nd) {
-            for(; c == '0'; c = *++s)
-                nz++;
-            if (c > '0' && c <= '9') {
-                s0 = s;
-                nf += nz;
-                nz = 0;
-                goto have_dig;
-            }
-            goto dig_done;
-        }
-        for(; c >= '0' && c <= '9'; c = *++s) {
-        have_dig:
-            nz++;
-            if (c -= '0') {
-                nf += nz;
-                for(i = 1; i < nz; i++)
-                    if (nd++ < 9)
-                        y *= 10;
-                    else if (nd <= DBL_DIG + 1)
-                        z *= 10;
-                if (nd++ < 9)
-                    y = 10*y + c;
-                else if (nd <= DBL_DIG + 1)
-                    z = 10*z + c;
-                nz = 0;
-            }
-        }
-    }
-dig_done:
-    e = 0;
-    if (c == 'e' || c == 'E') {
-        if (!nd && !nz && !nz0) {
-            s = s00;
-            goto ret;
-        }
-        s00 = s;
-        esign = 0;
-        switch(c = *++s) {
-        case '-':
-            esign = 1;
-        case '+':
-            c = *++s;
-        }
-        if (c >= '0' && c <= '9') {
-            while(c == '0')
-                c = *++s;
-            if (c > '0' && c <= '9') {
-                L = c - '0';
-                s1 = s;
-                while((c = *++s) >= '0' && c <= '9')
-                    L = 10*L + c - '0';
-                if (s - s1 > 8 || L > 19999)
-                    /* Avoid confusion from exponents
-                     * so large that e might overflow.
-                     */
-                    e = 19999; /* safe for 16 bit ints */
-                else
-                    e = (int32)L;
-                if (esign)
-                    e = -e;
-            }
-            else
-                e = 0;
-        }
-        else
-            s = s00;
-    }
-    if (!nd) {
-        if (!nz && !nz0) {
-#ifdef INFNAN_CHECK
-            /* Check for Nan and Infinity */
-            switch(c) {
-              case 'i':
-              case 'I':
-                if (match(&s,"nfinity")) {
-                    set_word0(rv, 0x7ff00000);
-                    set_word1(rv, 0);
-                    goto ret;
-                    }
-                break;
-              case 'n':
-              case 'N':
-                if (match(&s, "an")) {
-                    set_word0(rv, NAN_WORD0);
-                    set_word1(rv, NAN_WORD1);
-                    goto ret;
-                    }
-              }
-#endif /* INFNAN_CHECK */
-            s = s00;
-            }
-        goto ret;
-    }
-    e1 = e -= nf;
-
-    /* Now we have nd0 digits, starting at s0, followed by a
-     * decimal point, followed by nd-nd0 digits.  The number we're
-     * after is the integer represented by those digits times
-     * 10**e */
-
-    if (!nd0)
-        nd0 = nd;
-    k = nd < DBL_DIG + 1 ? nd : DBL_DIG + 1;
-    rv = y;
-    if (k > 9)
-        rv = tens[k - 9] * rv + z;
-    bd0 = 0;
-    if (nd <= DBL_DIG
-#ifndef RND_PRODQUOT
-        && FLT_ROUNDS == 1
-#endif
-        ) {
-        if (!e)
-            goto ret;
-        if (e > 0) {
-            if (e <= Ten_pmax) {
-                /* rv = */ rounded_product(rv, tens[e]);
-                goto ret;
-            }
-            i = DBL_DIG - nd;
-            if (e <= Ten_pmax + i) {
-                /* A fancier test would sometimes let us do
-                 * this for larger i values.
-                 */
-                e -= i;
-                rv *= tens[i];
-                /* rv = */ rounded_product(rv, tens[e]);
-                goto ret;
-            }
-        }
-#ifndef Inaccurate_Divide
-        else if (e >= -Ten_pmax) {
-            /* rv = */ rounded_quotient(rv, tens[-e]);
-            goto ret;
-        }
-#endif
-    }
-    e1 += nd - k;
-
-    scale = 0;
-
-    /* Get starting approximation = rv * 10**e1 */
-
-    if (e1 > 0) {
-        if ((i = e1 & 15) != 0)
-            rv *= tens[i];
-        if (e1 &= ~15) {
-            if (e1 > DBL_MAX_10_EXP) {
-            ovfl:
-                *err = JS_DTOA_ERANGE;
-#ifdef __STDC__
-                rv = HUGE_VAL;
-#else
-                /* Can't trust HUGE_VAL */
-                set_word0(rv, Exp_mask);
-                set_word1(rv, 0);
-#endif
-                if (bd0)
-                    goto retfree;
-                goto ret;
-            }
-            e1 >>= 4;
-            for(j = 0; e1 > 1; j++, e1 >>= 1)
-                if (e1 & 1)
-                    rv *= bigtens[j];
-            /* The last multiplication could overflow. */
-            set_word0(rv, word0(rv) - P*Exp_msk1);
-            rv *= bigtens[j];
-            if ((z = word0(rv) & Exp_mask) > Exp_msk1*(DBL_MAX_EXP+Bias-P))
-                goto ovfl;
-            if (z > Exp_msk1*(DBL_MAX_EXP+Bias-1-P)) {
-                /* set to largest number */
-                /* (Can't trust DBL_MAX) */
-                set_word0(rv, Big0);
-                set_word1(rv, Big1);
-                }
-            else
-                set_word0(rv, word0(rv) + P*Exp_msk1);
-            }
-    }
-    else if (e1 < 0) {
-        e1 = -e1;
-        if ((i = e1 & 15) != 0)
-            rv /= tens[i];
-        if (e1 &= ~15) {
-            e1 >>= 4;
-            if (e1 >= 1 << n_bigtens)
-                goto undfl;
-#ifdef Avoid_Underflow
-            if (e1 & Scale_Bit)
-                scale = P;
-            for(j = 0; e1 > 0; j++, e1 >>= 1)
-                if (e1 & 1)
-                    rv *= tinytens[j];
-            if (scale && (j = P + 1 - ((word0(rv) & Exp_mask)
-                        >> Exp_shift)) > 0) {
-                /* scaled rv is denormal; zap j low bits */
-                if (j >= 32) {
-                    set_word1(rv, 0);
-                    set_word0(rv, word0(rv) & (0xffffffff << (j-32)));
-                    if (!word0(rv))
-                        set_word0(rv, 1);
-                    }
-                else
-                    set_word1(rv, word1(rv) & (0xffffffff << j));
-                }
-#else
-            for(j = 0; e1 > 1; j++, e1 >>= 1)
-                if (e1 & 1)
-                    rv *= tinytens[j];
-            /* The last multiplication could underflow. */
-            rv0 = rv;
-            rv *= tinytens[j];
-            if (!rv) {
-                rv = 2.*rv0;
-                rv *= tinytens[j];
-#endif
-                if (!rv) {
-                undfl:
-                    rv = 0.;
-                    *err = JS_DTOA_ERANGE;
-                    if (bd0)
-                        goto retfree;
-                    goto ret;
-                }
-#ifndef Avoid_Underflow
-                set_word0(rv, Tiny0);
-                set_word1(rv, Tiny1);
-                /* The refinement below will clean
-                 * this approximation up.
-                 */
-            }
-#endif
-        }
-    }
-
-    /* Now the hard part -- adjusting rv to the correct value.*/
-
-    /* Put digits into bd: true value = bd * 10^e */
-
-    bd0 = s2b(s0, nd0, nd, y);
-    if (!bd0)
-        goto nomem;
-
-    for(;;) {
-        bd = Balloc(bd0->k);
-        if (!bd)
-            goto nomem;
-        Bcopy(bd, bd0);
-        bb = d2b(rv, &bbe, &bbbits);    /* rv = bb * 2^bbe */
-        if (!bb)
-            goto nomem;
-        bs = i2b(1);
-        if (!bs)
-            goto nomem;
-
-        if (e >= 0) {
-            bb2 = bb5 = 0;
-            bd2 = bd5 = e;
-        }
-        else {
-            bb2 = bb5 = -e;
-            bd2 = bd5 = 0;
-        }
-        if (bbe >= 0)
-            bb2 += bbe;
-        else
-            bd2 -= bbe;
-        bs2 = bb2;
-#ifdef Sudden_Underflow
-        j = P + 1 - bbbits;
-#else
-#ifdef Avoid_Underflow
-        j = bbe - scale;
-#else
-        j = bbe;
-#endif
-        i = j + bbbits - 1; /* logb(rv) */
-        if (i < Emin)   /* denormal */
-            j += P - Emin;
-        else
-            j = P + 1 - bbbits;
-#endif
-        bb2 += j;
-        bd2 += j;
-#ifdef Avoid_Underflow
-        bd2 += scale;
-#endif
-        i = bb2 < bd2 ? bb2 : bd2;
-        if (i > bs2)
-            i = bs2;
-        if (i > 0) {
-            bb2 -= i;
-            bd2 -= i;
-            bs2 -= i;
-        }
-        if (bb5 > 0) {
-            bs = pow5mult(bs, bb5);
-            if (!bs)
-                goto nomem;
-            bb1 = mult(bs, bb);
-            if (!bb1)
-                goto nomem;
-            Bfree(bb);
-            bb = bb1;
-        }
-        if (bb2 > 0) {
-            bb = lshift(bb, bb2);
-            if (!bb)
-                goto nomem;
-        }
-        if (bd5 > 0) {
-            bd = pow5mult(bd, bd5);
-            if (!bd)
-                goto nomem;
-        }
-        if (bd2 > 0) {
-            bd = lshift(bd, bd2);
-            if (!bd)
-                goto nomem;
-        }
-        if (bs2 > 0) {
-            bs = lshift(bs, bs2);
-            if (!bs)
-                goto nomem;
-        }
-        delta = diff(bb, bd);
-        if (!delta)
-            goto nomem;
-        dsign = delta->sign;
-        delta->sign = 0;
-        i = cmp(delta, bs);
-        if (i < 0) {
-            /* Error is less than half an ulp -- check for
-             * special case of mantissa a power of two.
-             */
-            if (dsign || word1(rv) || word0(rv) & Bndry_mask
-#ifdef Avoid_Underflow
-             || (word0(rv) & Exp_mask) <= Exp_msk1 + P*Exp_msk1
-#else
-             || (word0(rv) & Exp_mask) <= Exp_msk1
-#endif
-                ) {
-#ifdef Avoid_Underflow
-                if (!delta->x[0] && delta->wds == 1)
-                    dsign = 2;
-#endif
-                break;
-                }
-            delta = lshift(delta,Log2P);
-            if (!delta)
-                goto nomem;
-            if (cmp(delta, bs) > 0)
-                goto drop_down;
-            break;
-        }
-        if (i == 0) {
-            /* exactly half-way between */
-            if (dsign) {
-                if ((word0(rv) & Bndry_mask1) == Bndry_mask1
-                    &&  word1(rv) == 0xffffffff) {
-                    /*boundary case -- increment exponent*/
-                    set_word0(rv, (word0(rv) & Exp_mask) + Exp_msk1);
-                    set_word1(rv, 0);
-#ifdef Avoid_Underflow
-                    dsign = 0;
-#endif
-                    break;
-                }
-            }
-            else if (!(word0(rv) & Bndry_mask) && !word1(rv)) {
-#ifdef Avoid_Underflow
-                dsign = 2;
-#endif
-            drop_down:
-                /* boundary case -- decrement exponent */
-#ifdef Sudden_Underflow
-                L = word0(rv) & Exp_mask;
-                if (L <= Exp_msk1)
-                    goto undfl;
-                L -= Exp_msk1;
-#else
-                L = (word0(rv) & Exp_mask) - Exp_msk1;
-#endif
-                set_word0(rv, L | Bndry_mask1);
-                set_word1(rv, 0xffffffff);
-                break;
-            }
-#ifndef ROUND_BIASED
-            if (!(word1(rv) & LSB))
-                break;
-#endif
-            if (dsign)
-                rv += ulp(rv);
-#ifndef ROUND_BIASED
-            else {
-                rv -= ulp(rv);
-#ifndef Sudden_Underflow
-                if (!rv)
-                    goto undfl;
-#endif
-            }
-#ifdef Avoid_Underflow
-            dsign = 1 - dsign;
-#endif
-#endif
-            break;
-        }
-        if ((aadj = ratio(delta, bs)) <= 2.) {
-            if (dsign)
-                aadj = aadj1 = 1.;
-            else if (word1(rv) || word0(rv) & Bndry_mask) {
-#ifndef Sudden_Underflow
-                if (word1(rv) == Tiny1 && !word0(rv))
-                    goto undfl;
-#endif
-                aadj = 1.;
-                aadj1 = -1.;
-            }
-            else {
-                /* special case -- power of FLT_RADIX to be */
-                /* rounded down... */
-
-                if (aadj < 2./FLT_RADIX)
-                    aadj = 1./FLT_RADIX;
-                else
-                    aadj *= 0.5;
-                aadj1 = -aadj;
-            }
-        }
-        else {
-            aadj *= 0.5;
-            aadj1 = dsign ? aadj : -aadj;
-#ifdef Check_FLT_ROUNDS
-            switch(FLT_ROUNDS) {
-            case 2: /* towards +infinity */
-                aadj1 -= 0.5;
-                break;
-            case 0: /* towards 0 */
-            case 3: /* towards -infinity */
-                aadj1 += 0.5;
-            }
-#else
-            if (FLT_ROUNDS == 0)
-                aadj1 += 0.5;
-#endif
-        }
-        y = word0(rv) & Exp_mask;
-
-        /* Check for overflow */
-
-        if (y == Exp_msk1*(DBL_MAX_EXP+Bias-1)) {
-            rv0 = rv;
-            set_word0(rv, word0(rv) - P*Exp_msk1);
-            adj = aadj1 * ulp(rv);
-            rv += adj;
-            if ((word0(rv) & Exp_mask) >=
-                Exp_msk1*(DBL_MAX_EXP+Bias-P)) {
-                if (word0(rv0) == Big0 && word1(rv0) == Big1)
-                    goto ovfl;
-                set_word0(rv, Big0);
-                set_word1(rv, Big1);
-                goto cont;
-            }
-            else
-                set_word0(rv, word0(rv) + P*Exp_msk1);
-        }
-        else {
-#ifdef Sudden_Underflow
-            if ((word0(rv) & Exp_mask) <= P*Exp_msk1) {
-                rv0 = rv;
-                set_word0(rv, word0(rv) + P*Exp_msk1);
-                adj = aadj1 * ulp(rv);
-                rv += adj;
-                    if ((word0(rv) & Exp_mask) <= P*Exp_msk1)
-                        {
-                            if (word0(rv0) == Tiny0
-                                && word1(rv0) == Tiny1)
-                                goto undfl;
-                            set_word0(rv, Tiny0);
-                            set_word1(rv, Tiny1);
-                            goto cont;
-                        }
-                    else
-                        set_word0(rv, word0(rv) - P*Exp_msk1);
-            }
-            else {
-                adj = aadj1 * ulp(rv);
-                rv += adj;
-            }
-#else
-            /* Compute adj so that the IEEE rounding rules will
-             * correctly round rv + adj in some half-way cases.
-             * If rv * ulp(rv) is denormalized (i.e.,
-             * y <= (P-1)*Exp_msk1), we must adjust aadj to avoid
-             * trouble from bits lost to denormalization;
-             * example: 1.2e-307 .
-             */
-#ifdef Avoid_Underflow
-            if (y <= P*Exp_msk1 && aadj > 1.)
-#else
-            if (y <= (P-1)*Exp_msk1 && aadj > 1.)
-#endif
-                {
-                aadj1 = (double)(int32)(aadj + 0.5);
-                if (!dsign)
-                    aadj1 = -aadj1;
-            }
-#ifdef Avoid_Underflow
-            if (scale && y <= P*Exp_msk1)
-                set_word0(aadj1, word0(aadj1) + (P+1)*Exp_msk1 - y);
-#endif
-            adj = aadj1 * ulp(rv);
-            rv += adj;
-#endif
-        }
-        z = word0(rv) & Exp_mask;
-#ifdef Avoid_Underflow
-        if (!scale)
-#endif
-        if (y == z) {
-            /* Can we stop now? */
-            L = (Long)aadj;
-            aadj -= L;
-            /* The tolerances below are conservative. */
-            if (dsign || word1(rv) || word0(rv) & Bndry_mask) {
-                if (aadj < .4999999 || aadj > .5000001)
-                    break;
-            }
-            else if (aadj < .4999999/FLT_RADIX)
-                break;
-        }
-    cont:
-        Bfree(bb);
-        Bfree(bd);
-        Bfree(bs);
-        Bfree(delta);
-        bb = bd = bs = delta = NULL;
-    }
-#ifdef Avoid_Underflow
-    if (scale) {
-        rv0 = 0.;
-        set_word0(rv0, Exp_1 - P*Exp_msk1);
-        set_word1(rv0, 0);
-        if ((word0(rv) & Exp_mask) <= P*Exp_msk1
-              && word1(rv) & 1
-              && dsign != 2) {
-            if (dsign) {
-#ifdef Sudden_Underflow
-                /* rv will be 0, but this would give the  */
-                /* right result if only rv *= rv0 worked. */
-                set_word0(rv, word0(rv) + P*Exp_msk1);
-                set_word0(rv0, Exp_1 - 2*P*Exp_msk1);
-#endif
-                rv += ulp(rv);
-                }
-            else
-                set_word1(rv, word1(rv) & ~1);
-        }
-        rv *= rv0;
-    }
-#endif /* Avoid_Underflow */
-retfree:
-    Bfree(bb);
-    Bfree(bd);
-    Bfree(bs);
-    Bfree(bd0);
-    Bfree(delta);
-ret:
-    RELEASE_DTOA_LOCK();
-    if (se)
-        *se = (char *)s;
-    return sign ? -rv : rv;
-
-nomem:
-    Bfree(bb);
-    Bfree(bd);
-    Bfree(bs);
-    Bfree(bd0);
-    Bfree(delta);
-    RELEASE_DTOA_LOCK();
-    *err = JS_DTOA_ENOMEM;
-    return 0;
-}
-
-
-/* Return floor(b/2^k) and set b to be the remainder.  The returned quotient must be less than 2^32. */
-static uint32 quorem2(Bigint *b, int32 k)
-{
-    ULong mask;
-    ULong result;
-    ULong *bx, *bxe;
-    int32 w;
-    int32 n = k >> 5;
-    k &= 0x1F;
-    mask = (1<<k) - 1;
-
-    w = b->wds - n;
-    if (w <= 0)
-        return 0;
-    JS_ASSERT(w <= 2);
-    bx = b->x;
-    bxe = bx + n;
-    result = *bxe >> k;
-    *bxe &= mask;
-    if (w == 2) {
-        JS_ASSERT(!(bxe[1] & ~mask));
-        if (k)
-            result |= bxe[1] << (32 - k);
-    }
-    n++;
-    while (!*bxe && bxe != bx) {
-        n--;
-        bxe--;
-    }
-    b->wds = n;
-    return result;
-}
-
-/* Return floor(b/S) and set b to be the remainder.  As added restrictions, b must not have
- * more words than S, the most significant word of S must not start with a 1 bit, and the
- * returned quotient must be less than 36. */
-static int32 quorem(Bigint *b, Bigint *S)
-{
-    int32 n;
-    ULong *bx, *bxe, q, *sx, *sxe;
-#ifdef ULLong
-    ULLong borrow, carry, y, ys;
-#else
-    ULong borrow, carry, y, ys;
-    ULong si, z, zs;
-#endif
-
-    n = S->wds;
-    JS_ASSERT(b->wds <= n);
-    if (b->wds < n)
-        return 0;
-    sx = S->x;
-    sxe = sx + --n;
-    bx = b->x;
-    bxe = bx + n;
-    JS_ASSERT(*sxe <= 0x7FFFFFFF);
-    q = *bxe / (*sxe + 1);  /* ensure q <= true quotient */
-    JS_ASSERT(q < 36);
-    if (q) {
-        borrow = 0;
-        carry = 0;
-        do {
-#ifdef ULLong
-            ys = *sx++ * (ULLong)q + carry;
-            carry = ys >> 32;
-            y = *bx - (ys & 0xffffffffUL) - borrow;
-            borrow = y >> 32 & 1UL;
-            *bx++ = (ULong)(y & 0xffffffffUL);
-#else
-            si = *sx++;
-            ys = (si & 0xffff) * q + carry;
-            zs = (si >> 16) * q + (ys >> 16);
-            carry = zs >> 16;
-            y = (*bx & 0xffff) - (ys & 0xffff) - borrow;
-            borrow = (y & 0x10000) >> 16;
-            z = (*bx >> 16) - (zs & 0xffff) - borrow;
-            borrow = (z & 0x10000) >> 16;
-            Storeinc(bx, z, y);
-#endif
-        }
-        while(sx <= sxe);
-        if (!*bxe) {
-            bx = b->x;
-            while(--bxe > bx && !*bxe)
-                --n;
-            b->wds = n;
-        }
-    }
-    if (cmp(b, S) >= 0) {
-        q++;
-        borrow = 0;
-        carry = 0;
-        bx = b->x;
-        sx = S->x;
-        do {
-#ifdef ULLong
-            ys = *sx++ + carry;
-            carry = ys >> 32;
-            y = *bx - (ys & 0xffffffffUL) - borrow;
-            borrow = y >> 32 & 1UL;
-            *bx++ = (ULong)(y & 0xffffffffUL);
-#else
-            si = *sx++;
-            ys = (si & 0xffff) + carry;
-            zs = (si >> 16) + (ys >> 16);
-            carry = zs >> 16;
-            y = (*bx & 0xffff) - (ys & 0xffff) - borrow;
-            borrow = (y & 0x10000) >> 16;
-            z = (*bx >> 16) - (zs & 0xffff) - borrow;
-            borrow = (z & 0x10000) >> 16;
-            Storeinc(bx, z, y);
-#endif
-        } while(sx <= sxe);
-        bx = b->x;
-        bxe = bx + n;
-        if (!*bxe) {
-            while(--bxe > bx && !*bxe)
-                --n;
-            b->wds = n;
-        }
-    }
-    return (int32)q;
-}
-
-/* dtoa for IEEE arithmetic (dmg): convert double to ASCII string.
- *
- * Inspired by "How to Print Floating-Point Numbers Accurately" by
- * Guy L. Steele, Jr. and Jon L. White [Proc. ACM SIGPLAN '90, pp. 92-101].
- *
- * Modifications:
- *  1. Rather than iterating, we use a simple numeric overestimate
- *     to determine k = floor(log10(d)).  We scale relevant
- *     quantities using O(log2(k)) rather than O(k) multiplications.
- *  2. For some modes > 2 (corresponding to ecvt and fcvt), we don't
- *     try to generate digits strictly left to right.  Instead, we
- *     compute with fewer bits and propagate the carry if necessary
- *     when rounding the final digit up.  This is often faster.
- *  3. Under the assumption that input will be rounded nearest,
- *     mode 0 renders 1e23 as 1e23 rather than 9.999999999999999e22.
- *     That is, we allow equality in stopping tests when the
- *     round-nearest rule will give the same floating-point value
- *     as would satisfaction of the stopping test with strict
- *     inequality.
- *  4. We remove common factors of powers of 2 from relevant
- *     quantities.
- *  5. When converting floating-point integers less than 1e16,
- *     we use floating-point arithmetic rather than resorting
- *     to multiple-precision integers.
- *  6. When asked to produce fewer than 15 digits, we first try
- *     to get by with floating-point arithmetic; we resort to
- *     multiple-precision integer arithmetic only if we cannot
- *     guarantee that the floating-point calculation has given
- *     the correctly rounded result.  For k requested digits and
- *     "uniformly" distributed input, the probability is
- *     something like 10^(k-15) that we must resort to the Long
- *     calculation.
- */
-
-/* Always emits at least one digit. */
-/* If biasUp is set, then rounding in modes 2 and 3 will round away from zero
- * when the number is exactly halfway between two representable values.  For example,
- * rounding 2.5 to zero digits after the decimal point will return 3 and not 2.
- * 2.49 will still round to 2, and 2.51 will still round to 3. */
-/* bufsize should be at least 20 for modes 0 and 1.  For the other modes,
- * bufsize should be two greater than the maximum number of output characters expected. */
-static JSBool
-js_dtoa(double d, int mode, JSBool biasUp, int ndigits,
-    int *decpt, int *sign, char **rve, char *buf, size_t bufsize)
-{
-    /*  Arguments ndigits, decpt, sign are similar to those
-        of ecvt and fcvt; trailing zeros are suppressed from
-        the returned string.  If not null, *rve is set to point
-        to the end of the return value.  If d is +-Infinity or NaN,
-        then *decpt is set to 9999.
-
-        mode:
-        0 ==> shortest string that yields d when read in
-        and rounded to nearest.
-        1 ==> like 0, but with Steele & White stopping rule;
-        e.g. with IEEE P754 arithmetic , mode 0 gives
-        1e23 whereas mode 1 gives 9.999999999999999e22.
-        2 ==> max(1,ndigits) significant digits.  This gives a
-        return value similar to that of ecvt, except
-        that trailing zeros are suppressed.
-        3 ==> through ndigits past the decimal point.  This
-        gives a return value similar to that from fcvt,
-        except that trailing zeros are suppressed, and
-        ndigits can be negative.
-        4-9 should give the same return values as 2-3, i.e.,
-        4 <= mode <= 9 ==> same return as mode
-        2 + (mode & 1).  These modes are mainly for
-        debugging; often they run slower but sometimes
-        faster than modes 2-3.
-        4,5,8,9 ==> left-to-right digit generation.
-        6-9 ==> don't try fast floating-point estimate
-        (if applicable).
-
-        Values of mode other than 0-9 are treated as mode 0.
-
-        Sufficient space is allocated to the return value
-        to hold the suppressed trailing zeros.
-    */
-
-    int32 bbits, b2, b5, be, dig, i, ieps, ilim, ilim0, ilim1,
-        j, j1, k, k0, k_check, leftright, m2, m5, s2, s5,
-        spec_case, try_quick;
-    Long L;
-#ifndef Sudden_Underflow
-    int32 denorm;
-    ULong x;
-#endif
-    Bigint *b, *b1, *delta, *mlo, *mhi, *S;
-    double d2, ds, eps;
-    char *s;
-    const char *cs;
-
-    if (word0(d) & Sign_bit) {
-        /* set sign for everything, including 0's and NaNs */
-        *sign = 1;
-        set_word0(d, word0(d) & ~Sign_bit);  /* clear sign bit */
-    }
-    else
-        *sign = 0;
-
-    if ((word0(d) & Exp_mask) == Exp_mask) {
-        /* Infinity or NaN */
-        *decpt = 9999;
-        cs = !word1(d) && !(word0(d) & Frac_mask) ? "Infinity" : "NaN";
-        if ((cs[0] == 'I' && bufsize < 9) || (cs[0] == 'N' && bufsize < 4)) {
-            JS_ASSERT(JS_FALSE);
-/*          JS_SetError(JS_BUFFER_OVERFLOW_ERROR, 0); */
-            return JS_FALSE;
-        }
-        strcpy(buf, cs);
-        if (rve) {
-            *rve = buf[3] ? buf + 8 : buf + 3;
-            JS_ASSERT(**rve == '\0');
-        }
-        return JS_TRUE;
-    }
-
-    b = NULL;                           /* initialize for abort protection */
-    S = NULL;
-    mlo = mhi = NULL;
-
-    if (!d) {
-      no_digits:
-        *decpt = 1;
-        if (bufsize < 2) {
-            JS_ASSERT(JS_FALSE);
-/*          JS_SetError(JS_BUFFER_OVERFLOW_ERROR, 0); */
-            return JS_FALSE;
-        }
-        buf[0] = '0'; buf[1] = '\0';  /* copy "0" to buffer */
-        if (rve)
-            *rve = buf + 1;
-        /* We might have jumped to "no_digits" from below, so we need
-         * to be sure to free the potentially allocated Bigints to avoid
-         * memory leaks. */
-        Bfree(b);
-        Bfree(S);
-        if (mlo != mhi)
-            Bfree(mlo);
-        Bfree(mhi);
-        return JS_TRUE;
-    }
-
-    b = d2b(d, &be, &bbits);
-    if (!b)
-        goto nomem;
-#ifdef Sudden_Underflow
-    i = (int32)(word0(d) >> Exp_shift1 & (Exp_mask>>Exp_shift1));
-#else
-    if ((i = (int32)(word0(d) >> Exp_shift1 & (Exp_mask>>Exp_shift1))) != 0) {
-#endif
-        d2 = d;
-        set_word0(d2, word0(d2) & Frac_mask1);
-        set_word0(d2, word0(d2) | Exp_11);
-
-        /* log(x)   ~=~ log(1.5) + (x-1.5)/1.5
-         * log10(x)  =  log(x) / log(10)
-         *      ~=~ log(1.5)/log(10) + (x-1.5)/(1.5*log(10))
-         * log10(d) = (i-Bias)*log(2)/log(10) + log10(d2)
-         *
-         * This suggests computing an approximation k to log10(d) by
-         *
-         * k = (i - Bias)*0.301029995663981
-         *  + ( (d2-1.5)*0.289529654602168 + 0.176091259055681 );
-         *
-         * We want k to be too large rather than too small.
-         * The error in the first-order Taylor series approximation
-         * is in our favor, so we just round up the constant enough
-         * to compensate for any error in the multiplication of
-         * (i - Bias) by 0.301029995663981; since |i - Bias| <= 1077,
-         * and 1077 * 0.30103 * 2^-52 ~=~ 7.2e-14,
-         * adding 1e-13 to the constant term more than suffices.
-         * Hence we adjust the constant term to 0.1760912590558.
-         * (We could get a more accurate k by invoking log10,
-         *  but this is probably not worthwhile.)
-         */
-
-        i -= Bias;
-#ifndef Sudden_Underflow
-        denorm = 0;
-    }
-    else {
-        /* d is denormalized */
-
-        i = bbits + be + (Bias + (P-1) - 1);
-        x = i > 32 ? word0(d) << (64 - i) | word1(d) >> (i - 32) : word1(d) << (32 - i);
-        d2 = x;
-        set_word0(d2, word0(d2) - 31*Exp_msk1); /* adjust exponent */
-        i -= (Bias + (P-1) - 1) + 1;
-        denorm = 1;
-    }
-#endif
-    /* At this point d = f*2^i, where 1 <= f < 2.  d2 is an approximation of f. */
-    ds = (d2-1.5)*0.289529654602168 + 0.1760912590558 + i*0.301029995663981;
-    k = (int32)ds;
-    if (ds < 0. && ds != k)
-        k--;    /* want k = floor(ds) */
-    k_check = 1;
-    if (k >= 0 && k <= Ten_pmax) {
-        if (d < tens[k])
-            k--;
-        k_check = 0;
-    }
-    /* At this point floor(log10(d)) <= k <= floor(log10(d))+1.
-       If k_check is zero, we're guaranteed that k = floor(log10(d)). */
-    j = bbits - i - 1;
-    /* At this point d = b/2^j, where b is an odd integer. */
-    if (j >= 0) {
-        b2 = 0;
-        s2 = j;
-    }
-    else {
-        b2 = -j;
-        s2 = 0;
-    }
-    if (k >= 0) {
-        b5 = 0;
-        s5 = k;
-        s2 += k;
-    }
-    else {
-        b2 -= k;
-        b5 = -k;
-        s5 = 0;
-    }
-    /* At this point d/10^k = (b * 2^b2 * 5^b5) / (2^s2 * 5^s5), where b is an odd integer,
-       b2 >= 0, b5 >= 0, s2 >= 0, and s5 >= 0. */
-    if (mode < 0 || mode > 9)
-        mode = 0;
-    try_quick = 1;
-    if (mode > 5) {
-        mode -= 4;
-        try_quick = 0;
-    }
-    leftright = 1;
-    ilim = ilim1 = 0;
-    switch(mode) {
-    case 0:
-    case 1:
-        ilim = ilim1 = -1;
-        i = 18;
-        ndigits = 0;
-        break;
-    case 2:
-        leftright = 0;
-        /* no break */
-    case 4:
-        if (ndigits <= 0)
-            ndigits = 1;
-        ilim = ilim1 = i = ndigits;
-        break;
-    case 3:
-        leftright = 0;
-        /* no break */
-    case 5:
-        i = ndigits + k + 1;
-        ilim = i;
-        ilim1 = i - 1;
-        if (i <= 0)
-            i = 1;
-    }
-    /* ilim is the maximum number of significant digits we want, based on k and ndigits. */
-    /* ilim1 is the maximum number of significant digits we want, based on k and ndigits,
-       when it turns out that k was computed too high by one. */
-
-    /* Ensure space for at least i+1 characters, including trailing null. */
-    if (bufsize <= (size_t)i) {
-        Bfree(b);
-        JS_ASSERT(JS_FALSE);
-        return JS_FALSE;
-    }
-    s = buf;
-
-    if (ilim >= 0 && ilim <= Quick_max && try_quick) {
-
-        /* Try to get by with floating-point arithmetic. */
-
-        i = 0;
-        d2 = d;
-        k0 = k;
-        ilim0 = ilim;
-        ieps = 2; /* conservative */
-        /* Divide d by 10^k, keeping track of the roundoff error and avoiding overflows. */
-        if (k > 0) {
-            ds = tens[k&0xf];
-            j = k >> 4;
-            if (j & Bletch) {
-                /* prevent overflows */
-                j &= Bletch - 1;
-                d /= bigtens[n_bigtens-1];
-                ieps++;
-            }
-            for(; j; j >>= 1, i++)
-                if (j & 1) {
-                    ieps++;
-                    ds *= bigtens[i];
-                }
-            d /= ds;
-        }
-        else if ((j1 = -k) != 0) {
-            d *= tens[j1 & 0xf];
-            for(j = j1 >> 4; j; j >>= 1, i++)
-                if (j & 1) {
-                    ieps++;
-                    d *= bigtens[i];
-                }
-        }
-        /* Check that k was computed correctly. */
-        if (k_check && d < 1. && ilim > 0) {
-            if (ilim1 <= 0)
-                goto fast_failed;
-            ilim = ilim1;
-            k--;
-            d *= 10.;
-            ieps++;
-        }
-        /* eps bounds the cumulative error. */
-        eps = ieps*d + 7.;
-        set_word0(eps, word0(eps) - (P-1)*Exp_msk1);
-        if (ilim == 0) {
-            S = mhi = 0;
-            d -= 5.;
-            if (d > eps)
-                goto one_digit;
-            if (d < -eps)
-                goto no_digits;
-            goto fast_failed;
-        }
-#ifndef No_leftright
-        if (leftright) {
-            /* Use Steele & White method of only
-             * generating digits needed.
-             */
-            eps = 0.5/tens[ilim-1] - eps;
-            for(i = 0;;) {
-                L = (Long)d;
-                d -= L;
-                *s++ = '0' + (char)L;
-                if (d < eps)
-                    goto ret1;
-                if (1. - d < eps) {
-#ifdef DEBUG
-                    /* Clear d to avoid precision warning. */
-                    d = 0;
-#endif
-                    goto bump_up;
-                }
-                if (++i >= ilim)
-                    break;
-                eps *= 10.;
-                d *= 10.;
-            }
-        }
-        else {
-#endif
-            /* Generate ilim digits, then fix them up. */
-            eps *= tens[ilim-1];
-            for(i = 1;; i++, d *= 10.) {
-                L = (Long)d;
-                d -= L;
-                *s++ = '0' + (char)L;
-                if (i == ilim) {
-                    if (d > 0.5 + eps) {
-#ifdef DEBUG
-                        /* Clear d to avoid precision warning. */
-                        d = 0;
-#endif
-                        goto bump_up;
-                    }
-                    else if (d < 0.5 - eps) {
-                        while(*--s == '0') ;
-                        s++;
-                        goto ret1;
-                    }
-                    break;
-                }
-            }
-#ifndef No_leftright
-        }
-#endif
-    fast_failed:
-        s = buf;
-        d = d2;
-        k = k0;
-        ilim = ilim0;
-    }
-
-    /* Do we have a "small" integer? */
-
-    if (be >= 0 && k <= Int_max) {
-        /* Yes. */
-        ds = tens[k];
-        if (ndigits < 0 && ilim <= 0) {
-            S = mhi = 0;
-            if (ilim < 0 || d < 5*ds || (!biasUp && d == 5*ds))
-                goto no_digits;
-            goto one_digit;
-        }
-
-        /* Use true number of digits to limit looping. */
-        for(i = 1; i<=k+1; i++) {
-            L = (Long) (d / ds);
-            d -= L*ds;
-#ifdef Check_FLT_ROUNDS
-            /* If FLT_ROUNDS == 2, L will usually be high by 1 */
-            if (d < 0) {
-                L--;
-                d += ds;
-            }
-#endif
-            *s++ = '0' + (char)L;
-            if (i == ilim) {
-                d += d;
-                if ((d > ds) || (d == ds && (L & 1 || biasUp))) {
-                bump_up:
-                    while(*--s == '9')
-                        if (s == buf) {
-                            k++;
-                            *s = '0';
-                            break;
-                        }
-                    ++*s++;
-                }
-                break;
-            }
-            d *= 10.;
-        }
-#ifdef DEBUG
-        if (d != 0.0) {
-            fprintf(stderr,
-"WARNING: A loss of precision for double floating point is detected.\n"
-"         The result of any operation on doubles can be meaningless.\n"
-"         A possible cause is missing code to restore FPU state, see\n"
-"         bug 360282 for details.\n");
-        }
-#endif
-        goto ret1;
-    }
-
-    m2 = b2;
-    m5 = b5;
-    if (leftright) {
-        if (mode < 2) {
-            i =
-#ifndef Sudden_Underflow
-                denorm ? be + (Bias + (P-1) - 1 + 1) :
-#endif
-            1 + P - bbits;
-            /* i is 1 plus the number of trailing zero bits in d's significand. Thus,
-               (2^m2 * 5^m5) / (2^(s2+i) * 5^s5) = (1/2 lsb of d)/10^k. */
-        }
-        else {
-            j = ilim - 1;
-            if (m5 >= j)
-                m5 -= j;
-            else {
-                s5 += j -= m5;
-                b5 += j;
-                m5 = 0;
-            }
-            if ((i = ilim) < 0) {
-                m2 -= i;
-                i = 0;
-            }
-            /* (2^m2 * 5^m5) / (2^(s2+i) * 5^s5) = (1/2 * 10^(1-ilim))/10^k. */
-        }
-        b2 += i;
-        s2 += i;
-        mhi = i2b(1);
-        if (!mhi)
-            goto nomem;
-        /* (mhi * 2^m2 * 5^m5) / (2^s2 * 5^s5) = one-half of last printed (when mode >= 2) or
-           input (when mode < 2) significant digit, divided by 10^k. */
-    }
-    /* We still have d/10^k = (b * 2^b2 * 5^b5) / (2^s2 * 5^s5).  Reduce common factors in
-       b2, m2, and s2 without changing the equalities. */
-    if (m2 > 0 && s2 > 0) {
-        i = m2 < s2 ? m2 : s2;
-        b2 -= i;
-        m2 -= i;
-        s2 -= i;
-    }
-
-    /* Fold b5 into b and m5 into mhi. */
-    if (b5 > 0) {
-        if (leftright) {
-            if (m5 > 0) {
-                mhi = pow5mult(mhi, m5);
-                if (!mhi)
-                    goto nomem;
-                b1 = mult(mhi, b);
-                if (!b1)
-                    goto nomem;
-                Bfree(b);
-                b = b1;
-            }
-            if ((j = b5 - m5) != 0) {
-                b = pow5mult(b, j);
-                if (!b)
-                    goto nomem;
-            }
-        }
-        else {
-            b = pow5mult(b, b5);
-            if (!b)
-                goto nomem;
-        }
-    }
-    /* Now we have d/10^k = (b * 2^b2) / (2^s2 * 5^s5) and
-       (mhi * 2^m2) / (2^s2 * 5^s5) = one-half of last printed or input significant digit, divided by 10^k. */
-
-    S = i2b(1);
-    if (!S)
-        goto nomem;
-    if (s5 > 0) {
-        S = pow5mult(S, s5);
-        if (!S)
-            goto nomem;
-    }
-    /* Now we have d/10^k = (b * 2^b2) / (S * 2^s2) and
-       (mhi * 2^m2) / (S * 2^s2) = one-half of last printed or input significant digit, divided by 10^k. */
-
-    /* Check for special case that d is a normalized power of 2. */
-    spec_case = 0;
-    if (mode < 2) {
-        if (!word1(d) && !(word0(d) & Bndry_mask)
-#ifndef Sudden_Underflow
-            && word0(d) & (Exp_mask & Exp_mask << 1)
-#endif
-            ) {
-            /* The special case.  Here we want to be within a quarter of the last input
-               significant digit instead of one half of it when the decimal output string's value is less than d.  */
-            b2 += Log2P;
-            s2 += Log2P;
-            spec_case = 1;
-        }
-    }
-
-    /* Arrange for convenient computation of quotients:
-     * shift left if necessary so divisor has 4 leading 0 bits.
-     *
-     * Perhaps we should just compute leading 28 bits of S once
-     * and for all and pass them and a shift to quorem, so it
-     * can do shifts and ors to compute the numerator for q.
-     */
-    if ((i = ((s5 ? 32 - hi0bits(S->x[S->wds-1]) : 1) + s2) & 0x1f) != 0)
-        i = 32 - i;
-    /* i is the number of leading zero bits in the most significant word of S*2^s2. */
-    if (i > 4) {
-        i -= 4;
-        b2 += i;
-        m2 += i;
-        s2 += i;
-    }
-    else if (i < 4) {
-        i += 28;
-        b2 += i;
-        m2 += i;
-        s2 += i;
-    }
-    /* Now S*2^s2 has exactly four leading zero bits in its most significant word. */
-    if (b2 > 0) {
-        b = lshift(b, b2);
-        if (!b)
-            goto nomem;
-    }
-    if (s2 > 0) {
-        S = lshift(S, s2);
-        if (!S)
-            goto nomem;
-    }
-    /* Now we have d/10^k = b/S and
-       (mhi * 2^m2) / S = maximum acceptable error, divided by 10^k. */
-    if (k_check) {
-        if (cmp(b,S) < 0) {
-            k--;
-            b = multadd(b, 10, 0);  /* we botched the k estimate */
-            if (!b)
-                goto nomem;
-            if (leftright) {
-                mhi = multadd(mhi, 10, 0);
-                if (!mhi)
-                    goto nomem;
-            }
-            ilim = ilim1;
-        }
-    }
-    /* At this point 1 <= d/10^k = b/S < 10. */
-
-    if (ilim <= 0 && mode > 2) {
-        /* We're doing fixed-mode output and d is less than the minimum nonzero output in this mode.
-           Output either zero or the minimum nonzero output depending on which is closer to d. */
-        if (ilim < 0)
-            goto no_digits;
-        S = multadd(S,5,0);
-        if (!S)
-            goto nomem;
-        i = cmp(b,S);
-        if (i < 0 || (i == 0 && !biasUp)) {
-        /* Always emit at least one digit.  If the number appears to be zero
-           using the current mode, then emit one '0' digit and set decpt to 1. */
-        /*no_digits:
-            k = -1 - ndigits;
-            goto ret; */
-            goto no_digits;
-        }
-    one_digit:
-        *s++ = '1';
-        k++;
-        goto ret;
-    }
-    if (leftright) {
-        if (m2 > 0) {
-            mhi = lshift(mhi, m2);
-            if (!mhi)
-                goto nomem;
-        }
-
-        /* Compute mlo -- check for special case
-         * that d is a normalized power of 2.
-         */
-
-        mlo = mhi;
-        if (spec_case) {
-            mhi = Balloc(mhi->k);
-            if (!mhi)
-                goto nomem;
-            Bcopy(mhi, mlo);
-            mhi = lshift(mhi, Log2P);
-            if (!mhi)
-                goto nomem;
-        }
-        /* mlo/S = maximum acceptable error, divided by 10^k, if the output is less than d. */
-        /* mhi/S = maximum acceptable error, divided by 10^k, if the output is greater than d. */
-
-        for(i = 1;;i++) {
-            dig = quorem(b,S) + '0';
-            /* Do we yet have the shortest decimal string
-             * that will round to d?
-             */
-            j = cmp(b, mlo);
-            /* j is b/S compared with mlo/S. */
-            delta = diff(S, mhi);
-            if (!delta)
-                goto nomem;
-            j1 = delta->sign ? 1 : cmp(b, delta);
-            Bfree(delta);
-            /* j1 is b/S compared with 1 - mhi/S. */
-#ifndef ROUND_BIASED
-            if (j1 == 0 && !mode && !(word1(d) & 1)) {
-                if (dig == '9')
-                    goto round_9_up;
-                if (j > 0)
-                    dig++;
-                *s++ = (char)dig;
-                goto ret;
-            }
-#endif
-            if ((j < 0) || (j == 0 && !mode
-#ifndef ROUND_BIASED
-                && !(word1(d) & 1)
-#endif
-                )) {
-                if (j1 > 0) {
-                    /* Either dig or dig+1 would work here as the least significant decimal digit.
-                       Use whichever would produce a decimal value closer to d. */
-                    b = lshift(b, 1);
-                    if (!b)
-                        goto nomem;
-                    j1 = cmp(b, S);
-                    if (((j1 > 0) || (j1 == 0 && (dig & 1 || biasUp)))
-                        && (dig++ == '9'))
-                        goto round_9_up;
-                }
-                *s++ = (char)dig;
-                goto ret;
-            }
-            if (j1 > 0) {
-                if (dig == '9') { /* possible if i == 1 */
-                round_9_up:
-                    *s++ = '9';
-                    goto roundoff;
-                }
-                *s++ = (char)dig + 1;
-                goto ret;
-            }
-            *s++ = (char)dig;
-            if (i == ilim)
-                break;
-            b = multadd(b, 10, 0);
-            if (!b)
-                goto nomem;
-            if (mlo == mhi) {
-                mlo = mhi = multadd(mhi, 10, 0);
-                if (!mhi)
-                    goto nomem;
-            }
-            else {
-                mlo = multadd(mlo, 10, 0);
-                if (!mlo)
-                    goto nomem;
-                mhi = multadd(mhi, 10, 0);
-                if (!mhi)
-                    goto nomem;
-            }
-        }
-    }
-    else
-        for(i = 1;; i++) {
-            *s++ = (char)(dig = quorem(b,S) + '0');
-            if (i >= ilim)
-                break;
-            b = multadd(b, 10, 0);
-            if (!b)
-                goto nomem;
-        }
-
-    /* Round off last digit */
-
-    b = lshift(b, 1);
-    if (!b)
-        goto nomem;
-    j = cmp(b, S);
-    if ((j > 0) || (j == 0 && (dig & 1 || biasUp))) {
-    roundoff:
-        while(*--s == '9')
-            if (s == buf) {
-                k++;
-                *s++ = '1';
-                goto ret;
-            }
-        ++*s++;
-    }
-    else {
-        /* Strip trailing zeros */
-        while(*--s == '0') ;
-        s++;
-    }
-  ret:
-    Bfree(S);
-    if (mhi) {
-        if (mlo && mlo != mhi)
-            Bfree(mlo);
-        Bfree(mhi);
-    }
-  ret1:
-    Bfree(b);
-    JS_ASSERT(s < buf + bufsize);
-    *s = '\0';
-    if (rve)
-        *rve = s;
-    *decpt = k + 1;
-    return JS_TRUE;
-
-nomem:
-    Bfree(S);
-    if (mhi) {
-        if (mlo && mlo != mhi)
-            Bfree(mlo);
-        Bfree(mhi);
-    }
-    Bfree(b);
-    return JS_FALSE;
-}
-
-
 /* Mapping of JSDToStrMode -> js_dtoa mode */
-static const int dtoaModes[] = {
+static const uint8 dtoaModes[] = {
     0,   /* DTOSTR_STANDARD */
     0,   /* DTOSTR_STANDARD_EXPONENTIAL, */
     3,   /* DTOSTR_FIXED, */
     2,   /* DTOSTR_EXPONENTIAL, */
     2};  /* DTOSTR_PRECISION */
 
+JS_FRIEND_API(double)
+JS_strtod(const char *s00, char **se, int *err)
+{
+    double retval;
+    if (err)
+        *err = 0;
+    LOCK_DTOA();
+    retval = _strtod(s00, se);
+    UNLOCK_DTOA();
+    return retval;
+}
+
 JS_FRIEND_API(char *)
 JS_dtostr(char *buffer, size_t bufferSize, JSDToStrMode mode, int precision, double d)
 {
-    int decPt;                  /* Position of decimal point relative to first digit returned by js_dtoa */
-    int sign;                   /* Nonzero if the sign bit was set in d */
-    int nDigits;                /* Number of significand digits returned by js_dtoa */
-    char *numBegin = buffer+2;  /* Pointer to the digits returned by js_dtoa; the +2 leaves space for */
-                                /* the sign and/or decimal point */
-    char *numEnd;               /* Pointer past the digits returned by js_dtoa */
-    JSBool dtoaRet;
+    int decPt;        /* Offset of decimal point from first digit */
+    int sign;         /* Nonzero if the sign bit was set in d */
+    int nDigits;      /* Number of significand digits returned by js_dtoa */
+    char *numBegin;   /* Pointer to the digits returned by js_dtoa */
+    char *numEnd = 0; /* Pointer past the digits returned by js_dtoa */
 
-    JS_ASSERT(bufferSize >= (size_t)(mode <= DTOSTR_STANDARD_EXPONENTIAL ? DTOSTR_STANDARD_BUFFER_SIZE :
-            DTOSTR_VARIABLE_BUFFER_SIZE(precision)));
+    JS_ASSERT(bufferSize >= (size_t)(mode <= DTOSTR_STANDARD_EXPONENTIAL
+                                    ? DTOSTR_STANDARD_BUFFER_SIZE
+                                    : DTOSTR_VARIABLE_BUFFER_SIZE(precision)));
 
+    /*
+     * Change mode here rather than below because the buffer may not be large
+     * enough to hold a large integer.
+     */
     if (mode == DTOSTR_FIXED && (d >= 1e21 || d <= -1e21))
-        mode = DTOSTR_STANDARD; /* Change mode here rather than below because the buffer may not be large enough to hold a large integer. */
+        mode = DTOSTR_STANDARD;
 
-    /* Locking for Balloc's shared buffers */
-    ACQUIRE_DTOA_LOCK();
-    dtoaRet = js_dtoa(d, dtoaModes[mode], mode >= DTOSTR_FIXED, precision, &decPt, &sign, &numEnd, numBegin, bufferSize-2);
-    RELEASE_DTOA_LOCK();
-    if (!dtoaRet)
-        return 0;
+    LOCK_DTOA();
+    numBegin = dtoa(d, dtoaModes[mode], precision, &decPt, &sign, &numEnd);
+    if (!numBegin) {
+        UNLOCK_DTOA();
+        return NULL;
+    }
 
     nDigits = numEnd - numBegin;
+    JS_ASSERT((size_t) nDigits <= bufferSize - 2);
+    if ((size_t) nDigits > bufferSize - 2) {
+        UNLOCK_DTOA();
+        return NULL;
+    }
 
-    /* If Infinity, -Infinity, or NaN, return the string regardless of the mode. */
+    memcpy(buffer + 2, numBegin, nDigits);
+    freedtoa(numBegin);
+    UNLOCK_DTOA();
+    numBegin = buffer + 2; /* +2 leaves space for sign and/or decimal point */
+    numEnd = numBegin + nDigits;
+    *numEnd = '\0';
+
+    /* If Infinity, -Infinity, or NaN, return the string regardless of mode. */
     if (decPt != 9999) {
         JSBool exponentialNotation = JS_FALSE;
-        int minNDigits = 0;         /* Minimum number of significand digits required by mode and precision */
+        int minNDigits = 0;  /* Min number of significant digits required */
         char *p;
         char *q;
 
         switch (mode) {
             case DTOSTR_STANDARD:
@@ -2846,11 +215,11 @@ JS_dtostr(char *buffer, size_t bufferSiz
                 if (decPt < -5 || decPt > precision)
                     exponentialNotation = JS_TRUE;
                 break;
         }
 
-        /* If the number has fewer than minNDigits, pad it with zeros at the end */
+        /* If the number has fewer than minNDigits, end-pad it with zeros. */
         if (nDigits < minNDigits) {
             p = numBegin + minNDigits;
             nDigits = minNDigits;
             do {
                 *numEnd++ = '0';
@@ -2940,10 +309,43 @@ divrem(Bigint *b, uint32 divisor)
     if (bx[n-1] == 0)
         b->wds--;
     return remainder;
 }
 
+/* Return floor(b/2^k) and set b to be the remainder.  The returned quotient must be less than 2^32. */
+static uint32 quorem2(Bigint *b, int32 k)
+{
+    ULong mask;
+    ULong result;
+    ULong *bx, *bxe;
+    int32 w;
+    int32 n = k >> 5;
+    k &= 0x1F;
+    mask = (1<<k) - 1;
+
+    w = b->wds - n;
+    if (w <= 0)
+        return 0;
+    JS_ASSERT(w <= 2);
+    bx = b->x;
+    bxe = bx + n;
+    result = *bxe >> k;
+    *bxe &= mask;
+    if (w == 2) {
+        JS_ASSERT(!(bxe[1] & ~mask));
+        if (k)
+            result |= bxe[1] << (32 - k);
+    }
+    n++;
+    while (!*bxe && bxe != bx) {
+        n--;
+        bxe--;
+    }
+    b->wds = n;
+    return result;
+}
+
 
 /* "-0.0000...(1073 zeros after decimal point)...0001\0" is the longest string that we could produce,
  * which occurs when printing -5e-324 in binary.  We could compute a better estimate of the size of
  * the output string and malloc fewer bytes depending on d and base, but why bother? */
 #define DTOBASESTR_BUFFER_SIZE 1078
@@ -2978,13 +380,11 @@ JS_dtobasestr(int base, double d)
         if ((word0(d) & Exp_mask) == Exp_mask) {
             strcpy(p, !word1(d) && !(word0(d) & Frac_mask) ? "Infinity" : "NaN");
             return buffer;
         }
 
-        /* Locking for Balloc's shared buffers */
-        ACQUIRE_DTOA_LOCK();
-
+        LOCK_DTOA();
         /* Output the integer part of d with the digits in reverse order. */
         pInt = p;
         di = fd_floor(d);
         if (di <= 4294967295.0) {
             uint32 n = (uint32)di;
@@ -2996,20 +396,20 @@ JS_dtobasestr(int base, double d)
                     JS_ASSERT(digit < (uint32)base);
                     *p++ = BASEDIGIT(digit);
                 } while (n);
             else *p++ = '0';
         } else {
-            int32 e;
-            int32 bits;  /* Number of significant bits in di; not used. */
+            int e;
+            int bits;  /* Number of significant bits in di; not used. */
             Bigint *b = d2b(di, &e, &bits);
             if (!b)
                 goto nomem1;
             b = lshift(b, e);
             if (!b) {
               nomem1:
                 Bfree(b);
-                RELEASE_DTOA_LOCK();
+                UNLOCK_DTOA();
                 free(buffer);
                 return NULL;
             }
             do {
                 digit = divrem(b, base);
@@ -3027,11 +427,12 @@ JS_dtobasestr(int base, double d)
         }
 
         df = d - di;
         if (df != 0.0) {
             /* We have a fraction. */
-            int32 e, bbits, s2, done;
+            int e, bbits;
+            int32 s2, done;
             Bigint *b, *s, *mlo, *mhi;
 
             b = s = mlo = mhi = NULL;
 
             *p++ = '.';
@@ -3041,11 +442,11 @@ JS_dtobasestr(int base, double d)
                 Bfree(b);
                 Bfree(s);
                 if (mlo != mhi)
                     Bfree(mlo);
                 Bfree(mhi);
-                RELEASE_DTOA_LOCK();
+                UNLOCK_DTOA();
                 free(buffer);
                 return NULL;
             }
             JS_ASSERT(e < 0);
             /* At this point df = b * 2^e.  e must be less than zero because 0 < df < 1. */
@@ -3159,9 +560,9 @@ JS_dtobasestr(int base, double d)
                 Bfree(mlo);
             Bfree(mhi);
         }
         JS_ASSERT(p < buffer + DTOBASESTR_BUFFER_SIZE);
         *p = '\0';
-        RELEASE_DTOA_LOCK();
+        UNLOCK_DTOA();
     }
     return buffer;
 }
diff --git a/js/src/jsdtoa.h b/js/src/jsdtoa.h
--- a/js/src/jsdtoa.h
+++ b/js/src/jsdtoa.h
@@ -121,10 +121,11 @@ JS_dtobasestr(int base, double d);
 
 /*
  * Clean up any persistent RAM allocated during the execution of DtoA
  * routines, and remove any locks that might have been created.
  */
-extern void js_FinishDtoa(void);
+JS_FRIEND_API(JSBool) js_InitDtoa(void);
+JS_FRIEND_API(void) js_FinishDtoa(void);
 
 JS_END_EXTERN_C
 
 #endif /* jsdtoa_h___ */
diff --git a/js/src/jsdtracef.c b/js/src/jsdtracef.c
--- a/js/src/jsdtracef.c
+++ b/js/src/jsdtracef.c
@@ -178,11 +178,10 @@ jsdtrace_function_name(JSContext *cx, JS
           case JSOP_GETELEM:
           case JSOP_SETELEM:
           case JSOP_CALLGVAR:
           case JSOP_GETGVAR:
           case JSOP_SETGVAR:
-          case JSOP_CALLVAR:
           case JSOP_CALLARG:
           case JSOP_CALLLOCAL:
             /* FIXME: try to recover a name from these ops. */
             /* FALL THROUGH */
 
diff --git a/js/src/jsemit.cpp b/js/src/jsemit.cpp
--- a/js/src/jsemit.cpp
+++ b/js/src/jsemit.cpp
@@ -1497,29 +1497,22 @@ js_DefineCompileTimeConstant(JSContext *
         ale->entry.value = (void *)v;
     }
     return JS_TRUE;
 }
 
-#define LET_DECL 1
-#define VAR_DECL 2
-
 JSStmtInfo *
-js_LexicalLookup(JSTreeContext *tc, JSAtom *atom, jsint *slotp, uintN declType)
+js_LexicalLookup(JSTreeContext *tc, JSAtom *atom, jsint *slotp)
 {
     JSStmtInfo *stmt;
     JSObject *obj;
     JSScope *scope;
     JSScopeProperty *sprop;
     jsval v;
 
     for (stmt = tc->topScopeStmt; stmt; stmt = stmt->downScope) {
-        if (stmt->type == STMT_WITH) {
-            /* Ignore with statements enclosing a single let declaration. */
-            if (declType == LET_DECL)
-                continue;
-            break;
-        }
+        if (stmt->type == STMT_WITH)
+            break;
 
         /* Skip "maybe scope" statements that don't contain let bindings. */
         if (!(stmt->flags & SIF_SCOPE))
             continue;
 
@@ -1579,11 +1572,11 @@ LookupCompileTimeConstant(JSContext *cx,
     *vp = JSVAL_HOLE;
     do {
         if ((cg->treeContext.flags & TCF_IN_FUNCTION) ||
             cx->fp->varobj == cx->fp->scopeChain) {
             /* XXX this will need revising when 'let const' is added. */
-            stmt = js_LexicalLookup(&cg->treeContext, atom, NULL, 0);
+            stmt = js_LexicalLookup(&cg->treeContext, atom, NULL);
             if (stmt)
                 return JS_TRUE;
 
             ATOM_LIST_SEARCH(ale, &cg->constList, atom);
             if (ale) {
@@ -1811,12 +1804,11 @@ AdjustBlockSlot(JSContext *cx, JSCodeGen
  * NB: if you add more opcodes specialized from JSOP_NAME, etc., don't forget
  * to update the TOK_FOR (for-in) and TOK_ASSIGN (op=, e.g. +=) special cases
  * in js_EmitTree.
  */
 static JSBool
-BindNameToSlot(JSContext *cx, JSCodeGenerator *cg, JSParseNode *pn,
-               uintN declType)
+BindNameToSlot(JSContext *cx, JSCodeGenerator *cg, JSParseNode *pn)
 {
     JSTreeContext *tc;
     JSAtom *atom;
     JSStmtInfo *stmt;
     jsint slot;
@@ -1841,12 +1833,11 @@ BindNameToSlot(JSContext *cx, JSCodeGene
      * as this node.  FIXME: we should be able to optimize catch vars to be
      * block-locals.
      */
     tc = &cg->treeContext;
     atom = pn->pn_atom;
-    if (declType != VAR_DECL &&
-        (stmt = js_LexicalLookup(tc, atom, &slot, declType))) {
+    if ((stmt = js_LexicalLookup(tc, atom, &slot))) {
         if (stmt->type == STMT_WITH)
             return JS_TRUE;
 
         JS_ASSERT(stmt->flags & SIF_SCOPE);
         JS_ASSERT(slot >= 0);
@@ -1883,18 +1874,11 @@ BindNameToSlot(JSContext *cx, JSCodeGene
     if (!(tc->flags & TCF_IN_FUNCTION) &&
         !((cx->fp->flags & JSFRAME_SPECIAL) && cx->fp->fun)) {
         /*
          * We are compiling a script or eval, and eval is not inside a function
          * activation.
-         *
-         * We can't optimize if this name use is within a with statement in
-         * the same compilation unit, or if the compiler was invoked by eval
-         * called inside a with statement in its caller.
-         */
-        if (js_InWithStatement(tc))
-            return JS_TRUE;
-
+         */
         fp = cx->fp;
         if (fp->scopeChain != fp->varobj)
             return JS_TRUE;
 
         /*
@@ -1985,18 +1969,18 @@ BindNameToSlot(JSContext *cx, JSCodeGene
                 pn->pn_const = JS_FALSE;
             } else {
                 JS_ASSERT(localKind == JSLOCAL_VAR ||
                           localKind == JSLOCAL_CONST);
                 switch (op) {
-                  case JSOP_NAME:     op = JSOP_GETVAR; break;
-                  case JSOP_SETNAME:  op = JSOP_SETVAR; break;
-                  case JSOP_SETCONST: op = JSOP_SETVAR; break;
-                  case JSOP_INCNAME:  op = JSOP_INCVAR; break;
-                  case JSOP_NAMEINC:  op = JSOP_VARINC; break;
-                  case JSOP_DECNAME:  op = JSOP_DECVAR; break;
-                  case JSOP_NAMEDEC:  op = JSOP_VARDEC; break;
-                  case JSOP_FORNAME:  op = JSOP_FORVAR; break;
+                  case JSOP_NAME:     op = JSOP_GETLOCAL; break;
+                  case JSOP_SETNAME:  op = JSOP_SETLOCAL; break;
+                  case JSOP_SETCONST: op = JSOP_SETLOCAL; break;
+                  case JSOP_INCNAME:  op = JSOP_INCLOCAL; break;
+                  case JSOP_NAMEINC:  op = JSOP_LOCALINC; break;
+                  case JSOP_DECNAME:  op = JSOP_DECLOCAL; break;
+                  case JSOP_NAMEDEC:  op = JSOP_LOCALDEC; break;
+                  case JSOP_FORNAME:  op = JSOP_FORLOCAL; break;
                   case JSOP_DELNAME:  op = JSOP_FALSE; break;
                   default: JS_ASSERT(0);
                 }
                 pn->pn_const = (localKind == JSLOCAL_CONST);
             }
@@ -2110,11 +2094,11 @@ CheckSideEffects(JSContext *cx, JSCodeGe
              */
             pn2 = pn->pn_left;
             if (pn2->pn_type != TOK_NAME) {
                 *answer = JS_TRUE;
             } else {
-                if (!BindNameToSlot(cx, cg, pn2, 0))
+                if (!BindNameToSlot(cx, cg, pn2))
                     return JS_FALSE;
                 if (!CheckSideEffects(cx, cg, pn->pn_right, answer))
                     return JS_FALSE;
                 if (!*answer &&
                     (pn->pn_op != JSOP_NOP ||
@@ -2176,11 +2160,11 @@ CheckSideEffects(JSContext *cx, JSCodeGe
          * Take care to avoid trying to bind a label name (labels, both for
          * statements and property values in object initialisers, have pn_op
          * defaulted to JSOP_NOP).
          */
         if (pn->pn_type == TOK_NAME && pn->pn_op != JSOP_NOP) {
-            if (!BindNameToSlot(cx, cg, pn, 0))
+            if (!BindNameToSlot(cx, cg, pn))
                 return JS_FALSE;
             if (pn->pn_slot < 0 && pn->pn_op != JSOP_ARGUMENTS) {
                 /*
                  * Not an argument or local variable use, so this expression
                  * could invoke a getter that has side effects.
@@ -2188,11 +2172,11 @@ CheckSideEffects(JSContext *cx, JSCodeGe
                 *answer = JS_TRUE;
             }
         }
         pn2 = pn->pn_expr;
         if (pn->pn_type == TOK_DOT) {
-            if (pn2->pn_type == TOK_NAME && !BindNameToSlot(cx, cg, pn2, 0))
+            if (pn2->pn_type == TOK_NAME && !BindNameToSlot(cx, cg, pn2))
                 return JS_FALSE;
             if (!(pn2->pn_op == JSOP_ARGUMENTS &&
                   pn->pn_atom == cx->runtime->atomState.lengthAtom)) {
                 /*
                  * Any dotted property reference could call a getter, except
@@ -2216,21 +2200,18 @@ EmitNameOp(JSContext *cx, JSCodeGenerato
 EmitNameOp(JSContext *cx, JSCodeGenerator *cg, JSParseNode *pn,
            JSBool callContext)
 {
     JSOp op;
 
-    if (!BindNameToSlot(cx, cg, pn, 0))
+    if (!BindNameToSlot(cx, cg, pn))
         return JS_FALSE;
     op = PN_OP(pn);
 
     if (callContext) {
         switch (op) {
           case JSOP_NAME:
             op = JSOP_CALLNAME;
-            break;
-          case JSOP_GETVAR:
-            op = JSOP_CALLVAR;
             break;
           case JSOP_GETGVAR:
             op = JSOP_CALLGVAR;
             break;
           case JSOP_GETARG:
@@ -2309,26 +2290,22 @@ EmitPropOp(JSContext *cx, JSParseNode *p
         if (pn2->pn_type == TOK_NAME) {
             /*
              * Try to optimize:
              *  - arguments.length into JSOP_ARGCNT
              *  - argname.prop into JSOP_GETARGPROP
-             *  - varname.prop into JSOP_GETVARPROP
              *  - localname.prop into JSOP_GETLOCALPROP
              */
-            if (!BindNameToSlot(cx, cg, pn2, 0))
+            if (!BindNameToSlot(cx, cg, pn2))
                 return JS_FALSE;
             switch (pn2->pn_op) {
               case JSOP_ARGUMENTS:
                 if (pn->pn_atom == cx->runtime->atomState.lengthAtom)
                     return js_Emit1(cx, cg, JSOP_ARGCNT) >= 0;
                 break;
 
               case JSOP_GETARG:
                 op = JSOP_GETARGPROP;
-                goto do_indexconst;
-              case JSOP_GETVAR:
-                op = JSOP_GETVARPROP;
                 goto do_indexconst;
               case JSOP_GETLOCAL:
                 op = JSOP_GETLOCALPROP;
               do_indexconst: {
                 JSAtomListElement *ale;
@@ -2391,19 +2368,12 @@ EmitPropOp(JSContext *cx, JSParseNode *p
 
     if (js_NewSrcNote2(cx, cg, SRC_PCBASE,
                        CG_OFFSET(cg) - pn2->pn_offset) < 0) {
         return JS_FALSE;
     }
-    if (!pn->pn_atom) {
-        JS_ASSERT(op == JSOP_IMPORTALL);
-        if (js_Emit1(cx, cg, op) < 0)
-            return JS_FALSE;
-    } else {
-        if (!EmitAtomOp(cx, pn, op, cg))
-            return JS_FALSE;
-    }
-    return JS_TRUE;
+
+    return EmitAtomOp(cx, pn, op, cg);
 }
 
 static JSBool
 EmitElemOp(JSContext *cx, JSParseNode *pn, JSOp op, JSCodeGenerator *cg)
 {
@@ -2412,11 +2382,11 @@ EmitElemOp(JSContext *cx, JSParseNode *p
     jsint slot;
 
     top = CG_OFFSET(cg);
     if (pn->pn_arity == PN_LIST) {
         /* Left-associative operator chain to avoid too much recursion. */
-        JS_ASSERT(pn->pn_op == JSOP_GETELEM || pn->pn_op == JSOP_IMPORTELEM);
+        JS_ASSERT(pn->pn_op == JSOP_GETELEM);
         JS_ASSERT(pn->pn_count >= 3);
         left = pn->pn_head;
         right = PN_LAST(pn);
         next = left->pn_next;
         JS_ASSERT(next != right);
@@ -2424,11 +2394,11 @@ EmitElemOp(JSContext *cx, JSParseNode *p
         /*
          * Try to optimize arguments[0][j]... into JSOP_ARGSUB<0> followed by
          * one or more index expression and JSOP_GETELEM op pairs.
          */
         if (left->pn_type == TOK_NAME && next->pn_type == TOK_NUMBER) {
-            if (!BindNameToSlot(cx, cg, left, 0))
+            if (!BindNameToSlot(cx, cg, left))
                 return JS_FALSE;
             if (left->pn_op == JSOP_ARGUMENTS &&
                 JSDOUBLE_IS_INT(next->pn_dval, slot) &&
                 (jsuint)slot < JS_BIT(16)) {
                 /*
@@ -2499,11 +2469,11 @@ EmitElemOp(JSContext *cx, JSParseNode *p
 
         /* Try to optimize arguments[0] (e.g.) into JSOP_ARGSUB<0>. */
         if (op == JSOP_GETELEM &&
             left->pn_type == TOK_NAME &&
             right->pn_type == TOK_NUMBER) {
-            if (!BindNameToSlot(cx, cg, left, 0))
+            if (!BindNameToSlot(cx, cg, left))
                 return JS_FALSE;
             if (left->pn_op == JSOP_ARGUMENTS &&
                 JSDOUBLE_IS_INT(right->pn_dval, slot) &&
                 (jsuint)slot < JS_BIT(16)) {
                 left->pn_offset = right->pn_offset = top;
@@ -3237,15 +3207,12 @@ typedef JSBool
 
 static JSBool
 EmitDestructuringDecl(JSContext *cx, JSCodeGenerator *cg, JSOp prologOp,
                       JSParseNode *pn)
 {
-    JSOp declType;
-
     JS_ASSERT(pn->pn_type == TOK_NAME);
-    declType = (JSOp) ((prologOp == JSOP_NOP) ? LET_DECL : VAR_DECL);
-    if (!BindNameToSlot(cx, cg, pn, declType))
+    if (!BindNameToSlot(cx, cg, pn))
         return JS_FALSE;
 
     JS_ASSERT(pn->pn_op != JSOP_ARGUMENTS);
     return MaybeEmitVarDecl(cx, cg, prologOp, pn, NULL);
 }
@@ -3303,11 +3270,11 @@ EmitDestructuringLHS(JSContext *cx, JSCo
         if (!EmitDestructuringOpsHelper(cx, cg, pn))
             return JS_FALSE;
         if (js_Emit1(cx, cg, JSOP_POP) < 0)
             return JS_FALSE;
     } else {
-        if (pn->pn_type == TOK_NAME && !BindNameToSlot(cx, cg, pn, 0))
+        if (pn->pn_type == TOK_NAME && !BindNameToSlot(cx, cg, pn))
             return JS_FALSE;
 
         switch (pn->pn_op) {
           case JSOP_SETNAME:
             /*
@@ -3328,11 +3295,10 @@ EmitDestructuringLHS(JSContext *cx, JSCo
             slot = (jsuint) pn->pn_slot;
             EMIT_UINT16_IMM_OP(JSOP_SETLOCALPOP, slot);
             break;
 
           case JSOP_SETARG:
-          case JSOP_SETVAR:
           case JSOP_SETGVAR:
             slot = (jsuint) pn->pn_slot;
             EMIT_UINT16_IMM_OP(PN_OP(pn), slot);
             if (js_Emit1(cx, cg, JSOP_POP) < 0)
                 return JS_FALSE;
@@ -3727,11 +3693,11 @@ EmitVariables(JSContext *cx, JSCodeGener
         }
 #else
         JS_ASSERT(pn2->pn_type == TOK_NAME);
 #endif
 
-        if (!BindNameToSlot(cx, cg, pn2, let ? LET_DECL : VAR_DECL))
+        if (!BindNameToSlot(cx, cg, pn2))
             return JS_FALSE;
         JS_ASSERT(pn2->pn_slot >= 0 || !let);
 
         op = PN_OP(pn2);
         if (op == JSOP_ARGUMENTS) {
@@ -4044,46 +4010,10 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
                 return JS_FALSE;
         }
         break;
       }
 
-#if JS_HAS_EXPORT_IMPORT
-      case TOK_EXPORT:
-        pn2 = pn->pn_head;
-        if (pn2->pn_type == TOK_STAR) {
-            /*
-             * 'export *' must have no other elements in the list (what would
-             * be the point?).
-             */
-            if (js_Emit1(cx, cg, JSOP_EXPORTALL) < 0)
-                return JS_FALSE;
-        } else {
-            /*
-             * If not 'export *', the list consists of NAME nodes identifying
-             * properties of the variables object to flag as exported.
-             */
-            do {
-                ale = js_IndexAtom(cx, pn2->pn_atom, &cg->atomList);
-                if (!ale)
-                    return JS_FALSE;
-                EMIT_INDEX_OP(JSOP_EXPORTNAME, ALE_INDEX(ale));
-            } while ((pn2 = pn2->pn_next) != NULL);
-        }
-        break;
-
-      case TOK_IMPORT:
-        for (pn2 = pn->pn_head; pn2; pn2 = pn2->pn_next) {
-            /*
-             * Each subtree on an import list is rooted by a DOT or LB node.
-             * A DOT may have a null pn_atom member, in which case pn_op must
-             * be JSOP_IMPORTALL -- see EmitPropOp above.
-             */
-            if (!js_EmitTree(cx, cg, pn2))
-                return JS_FALSE;
-        }
-        break;
-#endif /* JS_HAS_EXPORT_IMPORT */
 
       case TOK_IF:
         /* Initialize so we can detect else-if chains and avoid recursion. */
         stmtInfo.type = STMT_IF;
         beq = jmp = -1;
@@ -4367,27 +4297,25 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
                 if (pn3->pn_slot >= 0) {
                     op = PN_OP(pn3);
                     switch (op) {
                       case JSOP_GETARG:   /* FALL THROUGH */
                       case JSOP_SETARG:   op = JSOP_FORARG; break;
-                      case JSOP_GETVAR:   /* FALL THROUGH */
-                      case JSOP_SETVAR:   op = JSOP_FORVAR; break;
                       case JSOP_GETGVAR:  /* FALL THROUGH */
                       case JSOP_SETGVAR:  op = JSOP_FORNAME; break;
                       case JSOP_GETLOCAL: /* FALL THROUGH */
                       case JSOP_SETLOCAL: op = JSOP_FORLOCAL; break;
                       default:            JS_ASSERT(0);
                     }
                 } else {
                     pn3->pn_op = JSOP_FORNAME;
-                    if (!BindNameToSlot(cx, cg, pn3, 0))
+                    if (!BindNameToSlot(cx, cg, pn3))
                         return JS_FALSE;
                     op = PN_OP(pn3);
                 }
                 if (pn3->pn_slot >= 0) {
                     if (pn3->pn_const) {
-                        JS_ASSERT(op == JSOP_FORVAR);
+                        JS_ASSERT(op == JSOP_FORLOCAL);
                         op = JSOP_FORCONST;
                     }
                     atomIndex = (jsatomid) pn3->pn_slot;
                     EMIT_UINT16_IMM_OP(op, atomIndex);
                 } else {
@@ -5333,11 +5261,11 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
         pn2 = pn->pn_left;
         JS_ASSERT(pn2->pn_type != TOK_RP);
         atomIndex = (jsatomid) -1;              /* quell GCC overwarning */
         switch (pn2->pn_type) {
           case TOK_NAME:
-            if (!BindNameToSlot(cx, cg, pn2, 0))
+            if (!BindNameToSlot(cx, cg, pn2))
                 return JS_FALSE;
             if (pn2->pn_slot >= 0) {
                 atomIndex = (jsatomid) pn2->pn_slot;
             } else {
                 ale = js_IndexAtom(cx, pn2->pn_atom, &cg->atomList);
@@ -5414,13 +5342,11 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
                 if (pn2->pn_op != JSOP_SETNAME) {
                     EMIT_UINT16_IMM_OP((pn2->pn_op == JSOP_SETGVAR)
                                        ? JSOP_GETGVAR
                                        : (pn2->pn_op == JSOP_SETARG)
                                        ? JSOP_GETARG
-                                       : (pn2->pn_op == JSOP_SETLOCAL)
-                                       ? JSOP_GETLOCAL
-                                       : JSOP_GETVAR,
+                                       : JSOP_GETLOCAL,
                                        atomIndex);
                     break;
                 }
                 if (js_Emit1(cx, cg, JSOP_DUP) < 0)
                     return JS_FALSE;
@@ -5727,19 +5653,19 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
         op = PN_OP(pn);
         switch (pn2->pn_type) {
           default:
             JS_ASSERT(pn2->pn_type == TOK_NAME);
             pn2->pn_op = op;
-            if (!BindNameToSlot(cx, cg, pn2, 0))
+            if (!BindNameToSlot(cx, cg, pn2))
                 return JS_FALSE;
             op = PN_OP(pn2);
             if (pn2->pn_slot >= 0) {
                 if (pn2->pn_const) {
                     /* Incrementing a declared const: just get its value. */
                     op = (JOF_OPTYPE(op) == JOF_ATOM)
                          ? JSOP_GETGVAR
-                         : JSOP_GETVAR;
+                         : JSOP_GETLOCAL;
                 }
                 atomIndex = (jsatomid) pn2->pn_slot;
                 EMIT_UINT16_IMM_OP(op, atomIndex);
             } else {
                 if (!EmitAtomOp(cx, pn2, op, cg))
@@ -5787,11 +5713,11 @@ js_EmitTree(JSContext *cx, JSCodeGenerat
          */
         pn2 = pn->pn_kid;
         switch (pn2->pn_type) {
           case TOK_NAME:
             pn2->pn_op = JSOP_DELNAME;
-            if (!BindNameToSlot(cx, cg, pn2, 0))
+            if (!BindNameToSlot(cx, cg, pn2))
                 return JS_FALSE;
             op = PN_OP(pn2);
             if (op == JSOP_FALSE) {
                 if (js_Emit1(cx, cg, op) < 0)
                     return JS_FALSE;
diff --git a/js/src/jsemit.h b/js/src/jsemit.h
--- a/js/src/jsemit.h
+++ b/js/src/jsemit.h
@@ -507,12 +507,11 @@ js_DefineCompileTimeConstant(JSContext *
  *
  * In any event, directly return the statement info record in which atom was
  * found. Otherwise return null.
  */
 extern JSStmtInfo *
-js_LexicalLookup(JSTreeContext *tc, JSAtom *atom, jsint *slotp,
-                 uintN declType);
+js_LexicalLookup(JSTreeContext *tc, JSAtom *atom, jsint *slotp);
 
 /*
  * Emit code into cg for the tree rooted at pn.
  */
 extern JSBool
diff --git a/js/src/jsexn.cpp b/js/src/jsexn.cpp
--- a/js/src/jsexn.cpp
+++ b/js/src/jsexn.cpp
@@ -1008,13 +1008,13 @@ out:
 }
 #endif
 
 static JSFunctionSpec exception_methods[] = {
 #if JS_HAS_TOSOURCE
-    JS_FN(js_toSource_str,   exn_toSource,           0,0,0),
+    JS_FN(js_toSource_str,   exn_toSource,           0,0),
 #endif
-    JS_FN(js_toString_str,   exn_toString,           0,0,0),
+    JS_FN(js_toString_str,   exn_toString,           0,0),
     JS_FS_END
 };
 
 JSObject *
 js_InitExceptionClasses(JSContext *cx, JSObject *obj)
diff --git a/js/src/jsfun.cpp b/js/src/jsfun.cpp
--- a/js/src/jsfun.cpp
+++ b/js/src/jsfun.cpp
@@ -1771,15 +1771,15 @@ out:
 }
 #endif
 
 static JSFunctionSpec function_methods[] = {
 #if JS_HAS_TOSOURCE
-    JS_FN(js_toSource_str,   fun_toSource,   0,0,0),
+    JS_FN(js_toSource_str,   fun_toSource,   0,0),
 #endif
-    JS_FN(js_toString_str,   fun_toString,   0,0,0),
-    JS_FN("apply",           fun_apply,      0,2,0),
-    JS_FN(call_str,          fun_call,       0,1,0),
+    JS_FN(js_toString_str,   fun_toString,   0,0),
+    JS_FN("apply",           fun_apply,      2,0),
+    JS_FN(call_str,          fun_call,       1,0),
 #ifdef NARCISSUS
     JS_FN("__applyConstructor__", fun_applyConstructor, 0,1,0),
 #endif
     JS_FS_END
 };
@@ -2090,11 +2090,11 @@ js_NewFunction(JSContext *cx, JSObject *
         fun->u.i.names.taggedAtom = 0;
 #endif
     } else {
         fun->u.n.native = native;
         fun->u.n.extra = 0;
-        fun->u.n.minargs = 0;
+        fun->u.n.spare = 0;
         fun->u.n.clasp = NULL;
     }
     fun->atom = atom;
 
     /* Set private to self to indicate non-cloned fully initialized function. */
diff --git a/js/src/jsfun.h b/js/src/jsfun.h
--- a/js/src/jsfun.h
+++ b/js/src/jsfun.h
@@ -69,12 +69,11 @@ struct JSFunction {
                                    reflected as f.length/f.arity */
     uint16          flags;      /* bound method and other flags, see jsapi.h */
     union {
         struct {
             uint16      extra;  /* number of arg slots for local GC roots */
-            uint16      minargs;/* minimum number of specified arguments, used
-                                   only when calling fast native */
+            uint16      spare;  /* reserved for future use */
             JSNative    native; /* native method pointer or null */
             JSClass     *clasp; /* if non-null, constructor for this class */
         } n;
         struct {
             uint16      nvars;  /* number of local variables */
@@ -98,11 +97,11 @@ struct JSFunction {
 #define FUN_NATIVE(fun)      (FUN_SLOW_NATIVE(fun) ? (fun)->u.n.native : NULL)
 #define FUN_FAST_NATIVE(fun) (((fun)->flags & JSFUN_FAST_NATIVE)              \
                               ? (JSFastNative) (fun)->u.n.native              \
                               : NULL)
 #define FUN_MINARGS(fun)     (((fun)->flags & JSFUN_FAST_NATIVE)              \
-                              ? (fun)->u.n.minargs                            \
+                              ? 0                                             \
                               : (fun)->nargs)
 
 extern JSClass js_ArgumentsClass;
 extern JS_FRIEND_DATA(JSClass) js_CallClass;
 
diff --git a/js/src/jsinterp.cpp b/js/src/jsinterp.cpp
--- a/js/src/jsinterp.cpp
+++ b/js/src/jsinterp.cpp
@@ -1050,11 +1050,11 @@ js_Invoke(JSContext *cx, uintN argc, jsv
     JSClass *clasp;
     JSObjectOps *ops;
     JSNative native;
     JSFunction *fun;
     JSScript *script;
-    uintN nslots, i, skip;
+    uintN nslots, i;
     uint32 rootedArgsFlag;
     JSInterpreterHook hook;
     void *hookData;
 
     /* [vp .. vp + 2 + argc) must belong to the last JS stack arena. */
@@ -1143,11 +1143,11 @@ have_fun:
             /* Handle bound method special case. */
             vp[1] = OBJECT_TO_JSVAL(parent);
         } else if (!JSVAL_IS_OBJECT(vp[1])) {
             JS_ASSERT(!(flags & JSINVOKE_CONSTRUCT));
             if (PRIMITIVE_THIS_TEST(fun, vp[1]))
-                goto init_slots;
+                goto start_call;
         }
     }
 
     if (flags & JSINVOKE_CONSTRUCT) {
         JS_ASSERT(!JSVAL_IS_PRIMITIVE(vp[1]));
@@ -1169,11 +1169,29 @@ have_fun:
             }
             flags |= JSFRAME_COMPUTED_THIS;
         }
     }
 
-  init_slots:
+  start_call:
+    if (native && fun && (fun->flags & JSFUN_FAST_NATIVE)) {
+#ifdef DEBUG_NOT_THROWING
+        JSBool alreadyThrowing = cx->throwing;
+#endif
+        JS_ASSERT(nslots == 0);
+#if JS_HAS_LVALUE_RETURN
+        /* Set by JS_SetCallReturnValue2, used to return reference types. */
+        cx->rval2set = JS_FALSE;
+#endif
+        ok = ((JSFastNative) native)(cx, argc, vp);
+        JS_RUNTIME_METER(cx->runtime, nativeCalls);
+#ifdef DEBUG_NOT_THROWING
+        if (ok && !alreadyThrowing)
+            ASSERT_NOT_THROWING(cx);
+#endif
+        goto out2;
+    }
+
     argv = vp + 2;
     sp = argv + argc;
 
     rootedArgsFlag = JSFRAME_ROOTED_ARGV;
     if (nslots != 0) {
@@ -1198,39 +1216,10 @@ have_fun:
         /* Push void to initialize missing args. */
         i = nslots;
         do {
             *sp++ = JSVAL_VOID;
         } while (--i != 0);
-    }
-
-    if (native && fun && (fun->flags & JSFUN_FAST_NATIVE)) {
-        JSTempValueRooter tvr;
-#ifdef DEBUG_NOT_THROWING
-        JSBool alreadyThrowing = cx->throwing;
-#endif
-#if JS_HAS_LVALUE_RETURN
-        /* Set by JS_SetCallReturnValue2, used to return reference types. */
-        cx->rval2set = JS_FALSE;
-#endif
-        /* Root the slots that are not covered by [vp..vp+2+argc). */
-        skip = rootedArgsFlag ? 2 + argc : 0;
-        JS_PUSH_TEMP_ROOT(cx, 2 + argc + nslots - skip, argv - 2 + skip, &tvr);
-        ok = ((JSFastNative) native)(cx, argc, argv - 2);
-
-        /*
-         * To avoid extra checks we always copy the result to *vp even if we
-         * have not copied argv and vp == argv - 2.
-         */
-        *vp = argv[-2];
-        JS_POP_TEMP_ROOT(cx, &tvr);
-
-        JS_RUNTIME_METER(cx->runtime, nativeCalls);
-#ifdef DEBUG_NOT_THROWING
-        if (ok && !alreadyThrowing)
-            ASSERT_NOT_THROWING(cx);
-#endif
-        goto out2;
     }
 
     /* Allocate space for local variables and stack of interpreted function. */
     if (script && script->nslots != 0) {
         if (!AllocateAfterSP(cx, sp, script->nslots)) {
@@ -1576,117 +1565,10 @@ out:
         jsdtrace_execute_done(script);
 #endif
     return ok;
 }
 
-#if JS_HAS_EXPORT_IMPORT
-/*
- * If id is JSVAL_VOID, import all exported properties from obj.
- */
-JS_STATIC_INTERPRET JSBool
-js_ImportProperty(JSContext *cx, JSObject *obj, jsid id)
-{
-    JSBool ok;
-    JSIdArray *ida;
-    JSProperty *prop;
-    JSObject *obj2, *target, *funobj, *closure;
-    uintN attrs;
-    jsint i;
-    jsval value;
-
-    if (JSVAL_IS_VOID(id)) {
-        ida = JS_Enumerate(cx, obj);
-        if (!ida)
-            return JS_FALSE;
-        ok = JS_TRUE;
-        if (ida->length == 0)
-            goto out;
-    } else {
-        ida = NULL;
-        if (!OBJ_LOOKUP_PROPERTY(cx, obj, id, &obj2, &prop))
-            return JS_FALSE;
-        if (!prop) {
-            js_ReportValueError(cx, JSMSG_NOT_DEFINED,
-                                JSDVG_IGNORE_STACK, ID_TO_VALUE(id), NULL);
-            return JS_FALSE;
-        }
-        ok = OBJ_GET_ATTRIBUTES(cx, obj, id, prop, &attrs);
-        OBJ_DROP_PROPERTY(cx, obj2, prop);
-        if (!ok)
-            return JS_FALSE;
-        if (!(attrs & JSPROP_EXPORTED)) {
-            js_ReportValueError(cx, JSMSG_NOT_EXPORTED,
-                                JSDVG_IGNORE_STACK, ID_TO_VALUE(id), NULL);
-            return JS_FALSE;
-        }
-    }
-
-    target = cx->fp->varobj;
-    i = 0;
-    do {
-        if (ida) {
-            id = ida->vector[i];
-            ok = OBJ_GET_ATTRIBUTES(cx, obj, id, NULL, &attrs);
-            if (!ok)
-                goto out;
-            if (!(attrs & JSPROP_EXPORTED))
-                continue;
-        }
-        ok = OBJ_CHECK_ACCESS(cx, obj, id, JSACC_IMPORT, &value, &attrs);
-        if (!ok)
-            goto out;
-        if (VALUE_IS_FUNCTION(cx, value)) {
-            funobj = JSVAL_TO_OBJECT(value);
-            closure = js_CloneFunctionObject(cx,
-                                             GET_FUNCTION_PRIVATE(cx, funobj),
-                                             obj);
-            if (!closure) {
-                ok = JS_FALSE;
-                goto out;
-            }
-            value = OBJECT_TO_JSVAL(closure);
-        }
-
-        /*
-         * Handle the case of importing a property that refers to a local
-         * variable or formal parameter of a function activation.  These
-         * properties are accessed by opcodes using stack slot numbers
-         * generated by the compiler rather than runtime name-lookup.  These
-         * local references, therefore, bypass the normal scope chain lookup.
-         * So, instead of defining a new property in the activation object,
-         * modify the existing value in the stack slot.
-         */
-        if (OBJ_GET_CLASS(cx, target) == &js_CallClass) {
-            ok = OBJ_LOOKUP_PROPERTY(cx, target, id, &obj2, &prop);
-            if (!ok)
-                goto out;
-        } else {
-            prop = NULL;
-        }
-        if (prop && target == obj2) {
-            ok = OBJ_SET_PROPERTY(cx, target, id, &value);
-        } else {
-            ok = OBJ_DEFINE_PROPERTY(cx, target, id, value,
-                                     JS_PropertyStub, JS_PropertyStub,
-                                     attrs & ~(JSPROP_EXPORTED |
-                                               JSPROP_GETTER |
-                                               JSPROP_SETTER),
-                                     NULL);
-        }
-        if (prop)
-            OBJ_DROP_PROPERTY(cx, obj2, prop);
-        if (!ok)
-            goto out;
-    } while (ida && ++i < ida->length);
-
-out:
-    if (ida)
-        JS_DestroyIdArray(cx, ida);
-    return ok;
-}
-#endif /* JS_HAS_EXPORT_IMPORT */
-
 JSBool
 js_CheckRedeclaration(JSContext *cx, JSObject *obj, jsid id, uintN attrs,
                       JSObject **objp, JSProperty **propp)
 {
     JSObject *obj2;
@@ -2466,11 +2348,11 @@ JS_STATIC_ASSERT(!CAN_DO_FAST_INC_DEC(IN
  * on shutdown that shows the graph of significant predecessor/successor pairs
  * executed, where the edge labels give the succession counts.  The .dot file
  * is named by the JS_OPMETER_FILE envariable, and defaults to /tmp/ops.dot.
  *
  * Bonus feature: JS_OPMETER also enables counters for stack-addressing ops
- * such as JSOP_GETVAR, JSOP_INCARG, via METER_SLOT_OP.  The resulting counts
+ * such as JSOP_GETLOCAL, JSOP_INCARG, via METER_SLOT_OP. The resulting counts
  * are written to JS_OPMETER_HIST, defaulting to /tmp/ops.hist.
  */
 #ifndef JS_OPMETER
 # define METER_OP_INIT(op)      /* nothing */
 # define METER_OP_PAIR(op1,op2) /* nothing */
@@ -2519,11 +2401,10 @@ JS_STATIC_ASSERT(JSOP_INTERRUPT == 0);
  * Ensure that the intrepreter switch can close call-bytecode cases in the
  * same way as non-call bytecodes.
  */
 JS_STATIC_ASSERT(JSOP_NAME_LENGTH == JSOP_CALLNAME_LENGTH);
 JS_STATIC_ASSERT(JSOP_GETGVAR_LENGTH == JSOP_CALLGVAR_LENGTH);
-JS_STATIC_ASSERT(JSOP_GETVAR_LENGTH == JSOP_CALLVAR_LENGTH);
 JS_STATIC_ASSERT(JSOP_GETARG_LENGTH == JSOP_CALLARG_LENGTH);
 JS_STATIC_ASSERT(JSOP_GETLOCAL_LENGTH == JSOP_CALLLOCAL_LENGTH);
 JS_STATIC_ASSERT(JSOP_XMLNAME_LENGTH == JSOP_CALLXMLNAME_LENGTH);
 
 /*
@@ -2577,13 +2458,10 @@ js_Interpret(JSContext *cx)
     register void * const *jumpTable;
 #else
     register uint32 switchMask;
     uintN switchOp;
 #endif
-#if JS_HAS_EXPORT_IMPORT
-    JSIdArray *ida;
-#endif
     jsint low, high, off, npairs;
     JSBool match;
 #if JS_HAS_GETTER_SETTER
     JSPropertyOp getter, setter;
 #endif
@@ -3168,17 +3046,16 @@ js_Interpret(JSContext *cx)
             LOAD_ATOM(0);
             id = ATOM_TO_JSID(atom);
             /* FALL THROUGH */
 
           BEGIN_CASE(JSOP_FORARG)
-          BEGIN_CASE(JSOP_FORVAR)
           BEGIN_CASE(JSOP_FORCONST)
           BEGIN_CASE(JSOP_FORLOCAL)
             /*
-             * JSOP_FORARG, JSOP_FORVAR, JSOP_FORLOCAL don't require any lval
-             * computation here, because they address slots on the stack (in
-             * fp->args and fp->slots, respectively).
+             * These bytecodes don't require any lval computation here,
+             * because they address slots on the stack (in fp->args or
+             * fp->slots).
              */
             /* FALL THROUGH */
 
           BEGIN_CASE(JSOP_FORELEM)
             /*
@@ -3212,11 +3089,10 @@ js_Interpret(JSContext *cx)
               case JSOP_FORCONST:
                 /* Don't update the const slot. */
                 break;
 
               case JSOP_FORLOCAL:
-              case JSOP_FORVAR:
                 slot = GET_SLOTNO(regs.pc);
                 JS_ASSERT(slot < fp->script->nslots);
                 vp = &fp->slots[slot];
                 GC_POKE(cx, *vp);
                 *vp = rval;
@@ -4096,19 +3972,15 @@ js_Interpret(JSContext *cx)
             METER_SLOT_OP(op, slot);
             vp = fp->argv + slot;
             goto do_int_fast_incop;
 
           BEGIN_CASE(JSOP_DECLOCAL)
-          BEGIN_CASE(JSOP_DECVAR)
             incr = -2; incr2 = -2; goto do_local_incop;
           BEGIN_CASE(JSOP_LOCALDEC)
-          BEGIN_CASE(JSOP_VARDEC)
             incr = -2; incr2 =  0; goto do_local_incop;
           BEGIN_CASE(JSOP_INCLOCAL)
-          BEGIN_CASE(JSOP_INCVAR)
             incr =  2; incr2 =  2; goto do_local_incop;
-          BEGIN_CASE(JSOP_VARINC)
           BEGIN_CASE(JSOP_LOCALINC)
             incr =  2; incr2 =  0;
 
           /*
            * do_local_incop comes right before do_int_fast_incop as we want to
@@ -4222,11 +4094,10 @@ js_Interpret(JSContext *cx)
             JS_ASSERT(slot < fp->fun->nargs);
             PUSH_OPND(fp->argv[slot]);
             goto do_getprop_body;
 
           BEGIN_CASE(JSOP_GETLOCALPROP)
-          BEGIN_CASE(JSOP_GETVARPROP)
             i = SLOTNO_LEN;
             slot = GET_SLOTNO(regs.pc);
             JS_ASSERT(slot < script->nslots);
             PUSH_OPND(fp->slots[slot]);
             goto do_getprop_body;
@@ -4905,28 +4776,12 @@ js_Interpret(JSContext *cx)
                 }
 #endif
 
                 if (fun->flags & JSFUN_FAST_NATIVE) {
                     JS_ASSERT(fun->u.n.extra == 0);
-                    if (argc < fun->u.n.minargs) {
-                        uintN nargs;
-
-                        /*
-                         * If we can't fit missing args and local roots in
-                         * this frame's operand stack, take the slow path.
-                         */
-                        nargs = fun->u.n.minargs - argc;
-                        if (regs.sp + nargs > fp->slots + script->nslots)
-                            goto do_invoke;
-                        do {
-                            PUSH(JSVAL_VOID);
-                        } while (--nargs != 0);
-                    }
-
                     JS_ASSERT(JSVAL_IS_OBJECT(vp[1]) ||
                               PRIMITIVE_THIS_TEST(fun, vp[1]));
-
                     ok = ((JSFastNative) fun->u.n.native)(cx, argc, vp);
 #ifdef INCLUDE_MOZILLA_DTRACE
                     if (VALUE_IS_FUNCTION(cx, lval)) {
                         if (JAVASCRIPT_FUNCTION_RVAL_ENABLED())
                             jsdtrace_function_rval(cx, fp, fun);
@@ -4939,11 +4794,10 @@ js_Interpret(JSContext *cx)
                     regs.sp = vp + 1;
                     goto end_call;
                 }
             }
 
-          do_invoke:
             ok = js_Invoke(cx, argc, vp, 0);
 #ifdef INCLUDE_MOZILLA_DTRACE
             /* DTrace function return, non-inlines */
             if (VALUE_IS_FUNCTION(cx, lval)) {
                 if (JAVASCRIPT_FUNCTION_RVAL_ENABLED())
@@ -5398,83 +5252,10 @@ js_Interpret(JSContext *cx)
             len = (op == JSOP_LOOKUPSWITCH)
                   ? GET_JUMP_OFFSET(pc2)
                   : GET_JUMPX_OFFSET(pc2);
           END_VARLEN_CASE
 
-#if JS_HAS_EXPORT_IMPORT
-          BEGIN_CASE(JSOP_EXPORTALL)
-            obj = fp->varobj;
-            ida = JS_Enumerate(cx, obj);
-            if (!ida)
-                goto error;
-            ok = JS_TRUE;
-            for (i = 0; i != ida->length; i++) {
-                id = ida->vector[i];
-                ok = OBJ_LOOKUP_PROPERTY(cx, obj, id, &obj2, &prop);
-                if (!ok)
-                    break;
-                if (!prop)
-                    continue;
-                ok = OBJ_GET_ATTRIBUTES(cx, obj, id, prop, &attrs);
-                if (ok) {
-                    attrs |= JSPROP_EXPORTED;
-                    ok = OBJ_SET_ATTRIBUTES(cx, obj, id, prop, &attrs);
-                }
-                OBJ_DROP_PROPERTY(cx, obj2, prop);
-                if (!ok)
-                    break;
-            }
-            JS_ASSERT(ok == (i == ida->length));
-            JS_DestroyIdArray(cx, ida);
-            if (!ok)
-                goto error;
-          END_CASE(JSOP_EXPORTALL)
-
-          BEGIN_CASE(JSOP_EXPORTNAME)
-            LOAD_ATOM(0);
-            id = ATOM_TO_JSID(atom);
-            obj = fp->varobj;
-            if (!OBJ_LOOKUP_PROPERTY(cx, obj, id, &obj2, &prop))
-                goto error;
-            if (!prop) {
-                if (!OBJ_DEFINE_PROPERTY(cx, obj, id, JSVAL_VOID,
-                                         JS_PropertyStub, JS_PropertyStub,
-                                         JSPROP_EXPORTED, NULL)) {
-                    goto error;
-                }
-            } else {
-                ok = OBJ_GET_ATTRIBUTES(cx, obj, id, prop, &attrs);
-                if (ok) {
-                    attrs |= JSPROP_EXPORTED;
-                    ok = OBJ_SET_ATTRIBUTES(cx, obj, id, prop, &attrs);
-                }
-                OBJ_DROP_PROPERTY(cx, obj2, prop);
-                if (!ok)
-                    goto error;
-            }
-          END_CASE(JSOP_EXPORTNAME)
-
-          BEGIN_CASE(JSOP_IMPORTALL)
-            id = (jsid) JSVAL_VOID;
-            PROPERTY_OP(-1, js_ImportProperty(cx, obj, id));
-            regs.sp--;
-          END_CASE(JSOP_IMPORTALL)
-
-          BEGIN_CASE(JSOP_IMPORTPROP)
-            /* Get an immediate atom naming the property. */
-            LOAD_ATOM(0);
-            id = ATOM_TO_JSID(atom);
-            PROPERTY_OP(-1, js_ImportProperty(cx, obj, id));
-            regs.sp--;
-          END_CASE(JSOP_IMPORTPROP)
-
-          BEGIN_CASE(JSOP_IMPORTELEM)
-            ELEMENT_OP(-1, js_ImportProperty(cx, obj, id));
-            regs.sp -= 2;
-          END_CASE(JSOP_IMPORTELEM)
-#endif /* JS_HAS_EXPORT_IMPORT */
-
           BEGIN_CASE(JSOP_TRAP)
           {
             JSTrapStatus status;
 
             status = JS_HandleTrap(cx, script, regs.pc, &rval);
@@ -5538,32 +5319,29 @@ js_Interpret(JSContext *cx)
             GC_POKE(cx, *vp);
             *vp = FETCH_OPND(-1);
           END_SET_CASE(JSOP_SETARG)
 
           BEGIN_CASE(JSOP_GETLOCAL)
-          BEGIN_CASE(JSOP_GETVAR)
             slot = GET_SLOTNO(regs.pc);
             JS_ASSERT(slot < script->nslots);
             PUSH_OPND(fp->slots[slot]);
-          END_CASE(JSOP_GETVAR)
+          END_CASE(JSOP_GETLOCAL)
 
           BEGIN_CASE(JSOP_CALLLOCAL)
-          BEGIN_CASE(JSOP_CALLVAR)
             slot = GET_SLOTNO(regs.pc);
             JS_ASSERT(slot < script->nslots);
             PUSH_OPND(fp->slots[slot]);
             PUSH_OPND(JSVAL_NULL);
-          END_CASE(JSOP_GETVAR)
+          END_CASE(JSOP_CALLLOCAL)
 
           BEGIN_CASE(JSOP_SETLOCAL)
-          BEGIN_CASE(JSOP_SETVAR)
             slot = GET_SLOTNO(regs.pc);
             JS_ASSERT(slot < script->nslots);
             vp = &fp->slots[slot];
             GC_POKE(cx, *vp);
             *vp = FETCH_OPND(-1);
-          END_SET_CASE(JSOP_SETVAR)
+          END_SET_CASE(JSOP_SETLOCAL)
 
           BEGIN_CASE(JSOP_GETGVAR)
           BEGIN_CASE(JSOP_CALLGVAR)
             slot = GET_SLOTNO(regs.pc);
             JS_ASSERT(slot < GlobalVarCount(fp));
@@ -6815,12 +6593,26 @@ js_Interpret(JSContext *cx)
           L_JSOP_QNAMEPART:
           L_JSOP_ANYNAME:
           L_JSOP_DEFXMLNS:
 # endif
 
+          L_JSOP_UNUSED75:
+          L_JSOP_UNUSED76:
+          L_JSOP_UNUSED77:
+          L_JSOP_UNUSED78:
+          L_JSOP_UNUSED79:
           L_JSOP_UNUSED186:
+          L_JSOP_UNUSED201:
+          L_JSOP_UNUSED202:
+          L_JSOP_UNUSED203:
+          L_JSOP_UNUSED204:
+          L_JSOP_UNUSED205:
+          L_JSOP_UNUSED206:
+          L_JSOP_UNUSED207:
           L_JSOP_UNUSED213:
+          L_JSOP_UNUSED219:
+          L_JSOP_UNUSED226:
 
 #else /* !JS_THREADED_INTERP */
           default:
 #endif
           {
diff --git a/js/src/jsinterp.h b/js/src/jsinterp.h
--- a/js/src/jsinterp.h
+++ b/js/src/jsinterp.h
@@ -533,13 +533,10 @@ js_UnwindScope(JSContext *cx, JSStackFra
 
 extern JSBool
 js_InternNonIntElementId(JSContext *cx, JSObject *obj, jsval idval, jsid *idp);
 
 extern JSBool
-js_ImportProperty(JSContext *cx, JSObject *obj, jsid id);
-
-extern JSBool
 js_OnUnknownMethod(JSContext *cx, jsval *vp);
 
 /*
  * Find the results of incrementing or decrementing *vp. For pre-increments,
  * both *vp and *vp2 will contain the result on return. For post-increments,
diff --git a/js/src/jsiter.cpp b/js/src/jsiter.cpp
--- a/js/src/jsiter.cpp
+++ b/js/src/jsiter.cpp
@@ -307,12 +307,12 @@ iterator_self(JSContext *cx, uintN argc,
 }
 
 #define JSPROP_ROPERM   (JSPROP_READONLY | JSPROP_PERMANENT)
 
 static JSFunctionSpec iterator_methods[] = {
-    JS_FN(js_iterator_str,  iterator_self,  0,0,JSPROP_ROPERM),
-    JS_FN(js_next_str,      iterator_next,  0,0,JSPROP_ROPERM),
+    JS_FN(js_iterator_str,  iterator_self,  0,JSPROP_ROPERM),
+    JS_FN(js_next_str,      iterator_next,  0,JSPROP_ROPERM),
     JS_FS_END
 };
 
 uintN
 js_GetNativeIteratorFlags(JSContext *cx, JSObject *iterobj)
@@ -932,11 +932,11 @@ CloseGenerator(JSContext *cx, JSObject *
 
 /*
  * Common subroutine of generator_(next|send|throw|close) methods.
  */
 static JSBool
-generator_op(JSContext *cx, JSGeneratorOp op, jsval *vp)
+generator_op(JSContext *cx, JSGeneratorOp op, jsval *vp, uintN argc)
 {
     JSObject *obj;
     JSGenerator *gen;
     jsval arg;
 
@@ -955,11 +955,11 @@ generator_op(JSContext *cx, JSGeneratorO
           case JSGENOP_NEXT:
           case JSGENOP_THROW:
             break;
 
           case JSGENOP_SEND:
-            if (!JSVAL_IS_VOID(vp[2])) {
+            if (argc >= 1 && !JSVAL_IS_VOID(vp[2])) {
                 js_ReportValueError(cx, JSMSG_BAD_GENERATOR_SEND,
                                     JSDVG_SEARCH_STACK, vp[2], NULL);
                 return JS_FALSE;
             }
             break;
@@ -974,19 +974,19 @@ generator_op(JSContext *cx, JSGeneratorO
         switch (op) {
           case JSGENOP_NEXT:
           case JSGENOP_SEND:
             return js_ThrowStopIteration(cx);
           case JSGENOP_THROW:
-            JS_SetPendingException(cx, vp[2]);
+            JS_SetPendingException(cx, argc >= 1 ? vp[2] : JSVAL_VOID);
             return JS_FALSE;
           default:
             JS_ASSERT(op == JSGENOP_CLOSE);
             return JS_TRUE;
         }
     }
 
-    arg = (op == JSGENOP_SEND || op == JSGENOP_THROW)
+    arg = ((op == JSGENOP_SEND || op == JSGENOP_THROW) && argc != 0)
           ? vp[2]
           : JSVAL_VOID;
     if (!SendToGenerator(cx, op, obj, gen, arg))
         return JS_FALSE;
     *vp = gen->frame.rval;
@@ -994,37 +994,37 @@ generator_op(JSContext *cx, JSGeneratorO
 }
 
 static JSBool
 generator_send(JSContext *cx, uintN argc, jsval *vp)
 {
-    return generator_op(cx, JSGENOP_SEND, vp);
+    return generator_op(cx, JSGENOP_SEND, vp, argc);
 }
 
 static JSBool
 generator_next(JSContext *cx, uintN argc, jsval *vp)
 {
-    return generator_op(cx, JSGENOP_NEXT, vp);
+    return generator_op(cx, JSGENOP_NEXT, vp, argc);
 }
 
 static JSBool
 generator_throw(JSContext *cx, uintN argc, jsval *vp)
 {
-    return generator_op(cx, JSGENOP_THROW, vp);
+    return generator_op(cx, JSGENOP_THROW, vp, argc);
 }
 
 static JSBool
 generator_close(JSContext *cx, uintN argc, jsval *vp)
 {
-    return generator_op(cx, JSGENOP_CLOSE, vp);
+    return generator_op(cx, JSGENOP_CLOSE, vp, argc);
 }
 
 static JSFunctionSpec generator_methods[] = {
-    JS_FN(js_iterator_str,  iterator_self,      0,0,JSPROP_ROPERM),
-    JS_FN(js_next_str,      generator_next,     0,0,JSPROP_ROPERM),
-    JS_FN(js_send_str,      generator_send,     1,1,JSPROP_ROPERM),
-    JS_FN(js_throw_str,     generator_throw,    1,1,JSPROP_ROPERM),
-    JS_FN(js_close_str,     generator_close,    0,0,JSPROP_ROPERM),
+    JS_FN(js_iterator_str,  iterator_self,      0,JSPROP_ROPERM),
+    JS_FN(js_next_str,      generator_next,     0,JSPROP_ROPERM),
+    JS_FN(js_send_str,      generator_send,     1,JSPROP_ROPERM),
+    JS_FN(js_throw_str,     generator_throw,    1,JSPROP_ROPERM),
+    JS_FN(js_close_str,     generator_close,    0,JSPROP_ROPERM),
     JS_FS_END
 };
 
 #endif /* JS_HAS_GENERATORS */
 
diff --git a/js/src/jskeyword.tbl b/js/src/jskeyword.tbl
--- a/js/src/jskeyword.tbl
+++ b/js/src/jskeyword.tbl
@@ -43,11 +43,11 @@ JS_KEYWORD(continue,    TOK_CONTINUE,   
 JS_KEYWORD(continue,    TOK_CONTINUE,   JSOP_NOP,       JSVERSION_DEFAULT)
 JS_KEYWORD(default,     TOK_DEFAULT,    JSOP_NOP,       JSVERSION_DEFAULT)
 JS_KEYWORD(delete,      TOK_DELETE,     JSOP_NOP,       JSVERSION_DEFAULT)
 JS_KEYWORD(do,          TOK_DO,         JSOP_NOP,       JSVERSION_DEFAULT)
 JS_KEYWORD(else,        TOK_ELSE,       JSOP_NOP,       JSVERSION_DEFAULT)
-JS_KEYWORD(export,      TOK_EXPORT,     JSOP_NOP,       JSVERSION_DEFAULT)
+JS_KEYWORD(export,      TOK_RESERVED,   JSOP_NOP,       JSVERSION_DEFAULT)
 JS_KEYWORD(false,       TOK_PRIMARY,    JSOP_FALSE,     JSVERSION_DEFAULT)
 JS_KEYWORD(for,         TOK_FOR,        JSOP_NOP,       JSVERSION_DEFAULT)
 JS_KEYWORD(function,    TOK_FUNCTION,   JSOP_NOP,       JSVERSION_DEFAULT)
 JS_KEYWORD(if,          TOK_IF,         JSOP_NOP,       JSVERSION_DEFAULT)
 JS_KEYWORD(in,          TOK_IN,         JSOP_IN,        JSVERSION_DEFAULT)
@@ -85,11 +85,11 @@ JS_KEYWORD(extends,     TOK_RESERVED,   
 JS_KEYWORD(extends,     TOK_RESERVED,   JSOP_NOP,       JSVERSION_DEFAULT)
 JS_KEYWORD(final,       TOK_RESERVED,   JSOP_NOP,       JSVERSION_DEFAULT)
 JS_KEYWORD(float,       TOK_RESERVED,   JSOP_NOP,       JSVERSION_DEFAULT)
 JS_KEYWORD(goto,        TOK_RESERVED,   JSOP_NOP,       JSVERSION_DEFAULT)
 JS_KEYWORD(implements,  TOK_RESERVED,   JSOP_NOP,       JSVERSION_DEFAULT)
-JS_KEYWORD(import,      TOK_IMPORT,     JSOP_NOP,       JSVERSION_DEFAULT)
+JS_KEYWORD(import,      TOK_RESERVED,   JSOP_NOP,       JSVERSION_DEFAULT)
 JS_KEYWORD(int,         TOK_RESERVED,   JSOP_NOP,       JSVERSION_DEFAULT)
 JS_KEYWORD(interface,   TOK_RESERVED,   JSOP_NOP,       JSVERSION_DEFAULT)
 JS_KEYWORD(long,        TOK_RESERVED,   JSOP_NOP,       JSVERSION_DEFAULT)
 JS_KEYWORD(native,      TOK_RESERVED,   JSOP_NOP,       JSVERSION_DEFAULT)
 JS_KEYWORD(package,     TOK_RESERVED,   JSOP_NOP,       JSVERSION_DEFAULT)
diff --git a/js/src/jslock.cpp b/js/src/jslock.cpp
--- a/js/src/jslock.cpp
+++ b/js/src/jslock.cpp
@@ -403,22 +403,24 @@ js_FinishSharingTitle(JSContext *cx, JST
     if (!MAP_IS_NATIVE(map))
         return;
     scope = (JSScope *)map;
 
     obj = scope->object;
-    nslots = scope->map.freeslot;
-    for (i = 0; i != nslots; ++i) {
-        v = STOBJ_GET_SLOT(obj, i);
-        if (JSVAL_IS_STRING(v) &&
-            !js_MakeStringImmutable(cx, JSVAL_TO_STRING(v))) {
-            /*
-             * FIXME bug 363059: The following error recovery changes runtime
-             * execution semantics, arbitrarily and silently ignoring errors
-             * except out-of-memory, which should have been reported through
-             * JS_ReportOutOfMemory at this point.
-             */
-            STOBJ_SET_SLOT(obj, i, JSVAL_VOID);
+    if (obj) {
+        nslots = scope->map.freeslot;
+        for (i = 0; i != nslots; ++i) {
+            v = STOBJ_GET_SLOT(obj, i);
+            if (JSVAL_IS_STRING(v) &&
+                !js_MakeStringImmutable(cx, JSVAL_TO_STRING(v))) {
+                /*
+                 * FIXME bug 363059: The following error recovery changes
+                 * runtime execution semantics, arbitrarily and silently
+                 * ignoring errors except out-of-memory, which should have been
+                 * reported through JS_ReportOutOfMemory at this point.
+                 */
+                STOBJ_SET_SLOT(obj, i, JSVAL_VOID);
+            }
         }
     }
 
     title->ownercx = NULL;  /* NB: set last, after lock init */
     JS_RUNTIME_METER(cx->runtime, sharedTitles);
diff --git a/js/src/jsmath.cpp b/js/src/jsmath.cpp
--- a/js/src/jsmath.cpp
+++ b/js/src/jsmath.cpp
@@ -103,10 +103,14 @@ static JSBool
 static JSBool
 math_abs(JSContext *cx, uintN argc, jsval *vp)
 {
     jsdouble x, z;
 
+    if (argc == 0) {
+        *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+        return JS_TRUE;
+    }
     x = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
     z = fd_fabs(x);
     return js_NewNumberInRootedValue(cx, z, vp);
@@ -115,10 +119,14 @@ static JSBool
 static JSBool
 math_acos(JSContext *cx, uintN argc, jsval *vp)
 {
     jsdouble x, z;
 
+    if (argc == 0) {
+        *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+        return JS_TRUE;
+    }
     x = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
 #if !JS_USE_FDLIBM_MATH && defined(SOLARIS) && defined(__GNUC__)
     if (x < -1 || 1 < x) {
@@ -133,10 +141,14 @@ static JSBool
 static JSBool
 math_asin(JSContext *cx, uintN argc, jsval *vp)
 {
     jsdouble x, z;
 
+    if (argc == 0) {
+        *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+        return JS_TRUE;
+    }
     x = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
 #if !JS_USE_FDLIBM_MATH && defined(SOLARIS) && defined(__GNUC__)
     if (x < -1 || 1 < x) {
@@ -151,10 +163,14 @@ static JSBool
 static JSBool
 math_atan(JSContext *cx, uintN argc, jsval *vp)
 {
     jsdouble x, z;
 
+    if (argc == 0) {
+        *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+        return JS_TRUE;
+    }
     x = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
     z = fd_atan(x);
     return js_NewNumberInRootedValue(cx, z, vp);
@@ -163,10 +179,14 @@ static JSBool
 static JSBool
 math_atan2(JSContext *cx, uintN argc, jsval *vp)
 {
     jsdouble x, y, z;
 
+    if (argc <= 1) {
+        *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+        return JS_TRUE;
+    }
     x = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
     y = js_ValueToNumber(cx, &vp[3]);
     if (JSVAL_IS_NULL(vp[3]))
@@ -206,10 +226,14 @@ static JSBool
 static JSBool
 math_ceil(JSContext *cx, uintN argc, jsval *vp)
 {
     jsdouble x, z;
 
+    if (argc == 0) {
+        *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+        return JS_TRUE;
+    }
     x = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
     z = fd_ceil(x);
     return js_NewNumberInRootedValue(cx, z, vp);
@@ -218,10 +242,14 @@ static JSBool
 static JSBool
 math_cos(JSContext *cx, uintN argc, jsval *vp)
 {
     jsdouble x, z;
 
+    if (argc == 0) {
+        *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+        return JS_TRUE;
+    }
     x = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
     z = fd_cos(x);
     return js_NewNumberInRootedValue(cx, z, vp);
@@ -230,10 +258,14 @@ static JSBool
 static JSBool
 math_exp(JSContext *cx, uintN argc, jsval *vp)
 {
     jsdouble x, z;
 
+    if (argc == 0) {
+        *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+        return JS_TRUE;
+    }
     x = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
 #ifdef _WIN32
     if (!JSDOUBLE_IS_NaN(x)) {
@@ -254,10 +286,14 @@ static JSBool
 static JSBool
 math_floor(JSContext *cx, uintN argc, jsval *vp)
 {
     jsdouble x, z;
 
+    if (argc == 0) {
+        *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+        return JS_TRUE;
+    }
     x = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
     z = fd_floor(x);
     return js_NewNumberInRootedValue(cx, z, vp);
@@ -266,10 +302,14 @@ static JSBool
 static JSBool
 math_log(JSContext *cx, uintN argc, jsval *vp)
 {
     jsdouble x, z;
 
+    if (argc == 0) {
+        *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+        return JS_TRUE;
+    }
     x = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
 #if !JS_USE_FDLIBM_MATH && defined(SOLARIS) && defined(__GNUC__)
     if (x < 0) {
@@ -340,10 +380,14 @@ static JSBool
 static JSBool
 math_pow(JSContext *cx, uintN argc, jsval *vp)
 {
     jsdouble x, y, z;
 
+    if (argc <= 1) {
+        *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+        return JS_TRUE;
+    }
     x = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
     y = js_ValueToNumber(cx, &vp[3]);
     if (JSVAL_IS_NULL(vp[3]))
@@ -470,10 +514,14 @@ static JSBool
 static JSBool
 math_round(JSContext *cx, uintN argc, jsval *vp)
 {
     jsdouble x, z;
 
+    if (argc == 0) {
+        *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+        return JS_TRUE;
+    }
     x = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
     z = fd_copysign(fd_floor(x + 0.5), x);
     return js_NewNumberInRootedValue(cx, z, vp);
@@ -482,10 +530,14 @@ static JSBool
 static JSBool
 math_sin(JSContext *cx, uintN argc, jsval *vp)
 {
     jsdouble x, z;
 
+    if (argc == 0) {
+        *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+        return JS_TRUE;
+    }
     x = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
     z = fd_sin(x);
     return js_NewNumberInRootedValue(cx, z, vp);
@@ -494,10 +546,14 @@ static JSBool
 static JSBool
 math_sqrt(JSContext *cx, uintN argc, jsval *vp)
 {
     jsdouble x, z;
 
+    if (argc == 0) {
+        *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+        return JS_TRUE;
+    }
     x = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
     z = fd_sqrt(x);
     return js_NewNumberInRootedValue(cx, z, vp);
@@ -506,10 +562,14 @@ static JSBool
 static JSBool
 math_tan(JSContext *cx, uintN argc, jsval *vp)
 {
     jsdouble x, z;
 
+    if (argc == 0) {
+        *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+        return JS_TRUE;
+    }
     x = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
     z = fd_tan(x);
     return js_NewNumberInRootedValue(cx, z, vp);
@@ -524,30 +584,30 @@ math_toSource(JSContext *cx, uintN argc,
 }
 #endif
 
 static JSFunctionSpec math_static_methods[] = {
 #if JS_HAS_TOSOURCE
-    JS_FN(js_toSource_str,  math_toSource,      0, 0, 0),
+    JS_FN(js_toSource_str,  math_toSource,      0, 0),
 #endif
-    JS_FN("abs",            math_abs,           1, 1, 0),
-    JS_FN("acos",           math_acos,          1, 1, 0),
-    JS_FN("asin",           math_asin,          1, 1, 0),
-    JS_FN("atan",           math_atan,          1, 1, 0),
-    JS_FN("atan2",          math_atan2,         2, 2, 0),
-    JS_FN("ceil",           math_ceil,          1, 1, 0),
-    JS_FN("cos",            math_cos,           1, 1, 0),
-    JS_FN("exp",            math_exp,           1, 1, 0),
-    JS_FN("floor",          math_floor,         1, 1, 0),
-    JS_FN("log",            math_log,           1, 1, 0),
-    JS_FN("max",            math_max,           0, 2, 0),
-    JS_FN("min",            math_min,           0, 2, 0),
-    JS_FN("pow",            math_pow,           2, 2, 0),
-    JS_FN("random",         math_random,        0, 0, 0),
-    JS_FN("round",          math_round,         1, 1, 0),
-    JS_FN("sin",            math_sin,           1, 1, 0),
-    JS_FN("sqrt",           math_sqrt,          1, 1, 0),
-    JS_FN("tan",            math_tan,           1, 1, 0),
+    JS_FN("abs",            math_abs,           1, 0),
+    JS_FN("acos",           math_acos,          1, 0),
+    JS_FN("asin",           math_asin,          1, 0),
+    JS_FN("atan",           math_atan,          1, 0),
+    JS_FN("atan2",          math_atan2,         2, 0),
+    JS_FN("ceil",           math_ceil,          1, 0),
+    JS_FN("cos",            math_cos,           1, 0),
+    JS_FN("exp",            math_exp,           1, 0),
+    JS_FN("floor",          math_floor,         1, 0),
+    JS_FN("log",            math_log,           1, 0),
+    JS_FN("max",            math_max,           2, 0),
+    JS_FN("min",            math_min,           2, 0),
+    JS_FN("pow",            math_pow,           2, 0),
+    JS_FN("random",         math_random,        0, 0),
+    JS_FN("round",          math_round,         1, 0),
+    JS_FN("sin",            math_sin,           1, 0),
+    JS_FN("sqrt",           math_sqrt,          1, 0),
+    JS_FN("tan",            math_tan,           1, 0),
     JS_FS_END
 };
 
 JSObject *
 js_InitMathClass(JSContext *cx, JSObject *obj)
diff --git a/js/src/jsnum.cpp b/js/src/jsnum.cpp
--- a/js/src/jsnum.cpp
+++ b/js/src/jsnum.cpp
@@ -69,10 +69,14 @@ static JSBool
 static JSBool
 num_isNaN(JSContext *cx, uintN argc, jsval *vp)
 {
     jsdouble x;
 
+    if (argc == 0) {
+        *vp = JSVAL_TRUE;
+        return JS_TRUE;
+    }
     x = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
     *vp = BOOLEAN_TO_JSVAL(JSDOUBLE_IS_NaN(x));
     return JS_TRUE;
@@ -81,10 +85,14 @@ static JSBool
 static JSBool
 num_isFinite(JSContext *cx, uintN argc, jsval *vp)
 {
     jsdouble x;
 
+    if (argc == 0) {
+        *vp = JSVAL_FALSE;
+        return JS_TRUE;
+    }
     x = js_ValueToNumber(cx, &vp[2]);
     if (JSVAL_IS_NULL(vp[2]))
         return JS_FALSE;
     *vp = BOOLEAN_TO_JSVAL(JSDOUBLE_IS_FINITE(x));
     return JS_TRUE;
@@ -95,10 +103,14 @@ num_parseFloat(JSContext *cx, uintN argc
 {
     JSString *str;
     jsdouble d;
     const jschar *bp, *end, *ep;
 
+    if (argc == 0) {
+        *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+        return JS_TRUE;
+    }
     str = js_ValueToString(cx, vp[2]);
     if (!str)
         return JS_FALSE;
     JSSTRING_CHARS_AND_END(str, bp, end);
     if (!js_strtod(cx, bp, end, &ep, &d))
@@ -117,10 +129,14 @@ num_parseInt(JSContext *cx, uintN argc, 
     jsint radix;
     JSString *str;
     jsdouble d;
     const jschar *bp, *end, *ep;
 
+    if (argc == 0) {
+        *vp = DOUBLE_TO_JSVAL(cx->runtime->jsNaN);
+        return JS_TRUE;
+    }
     if (argc > 1) {
         radix = js_ValueToECMAInt32(cx, &vp[3]);
         if (JSVAL_IS_NULL(vp[3]))
             return JS_FALSE;
     } else {
@@ -155,14 +171,14 @@ const char js_isFinite_str[]   = "isFini
 const char js_isFinite_str[]   = "isFinite";
 const char js_parseFloat_str[] = "parseFloat";
 const char js_parseInt_str[]   = "parseInt";
 
 static JSFunctionSpec number_functions[] = {
-    JS_FN(js_isNaN_str,         num_isNaN,              1,1,0),
-    JS_FN(js_isFinite_str,      num_isFinite,           1,1,0),
-    JS_FN(js_parseFloat_str,    num_parseFloat,         1,1,0),
-    JS_FN(js_parseInt_str,      num_parseInt,           1,2,0),
+    JS_FN(js_isNaN_str,         num_isNaN,              1,0),
+    JS_FN(js_isFinite_str,      num_isFinite,           1,0),
+    JS_FN(js_parseFloat_str,    num_parseFloat,         1,0),
+    JS_FN(js_parseInt_str,      num_parseInt,           2,0),
     JS_FS_END
 };
 
 JSClass js_NumberClass = {
     js_Number_str,
@@ -496,26 +512,26 @@ num_toExponential(JSContext *cx, uintN a
 }
 
 static JSBool
 num_toPrecision(JSContext *cx, uintN argc, jsval *vp)
 {
-    if (JSVAL_IS_VOID(vp[2]))
+    if (argc == 0 || JSVAL_IS_VOID(vp[2]))
         return num_toString(cx, 0, vp);
     return num_to(cx, DTOSTR_STANDARD, DTOSTR_PRECISION, 1, MAX_PRECISION, 0,
                   argc, vp);
 }
 
 static JSFunctionSpec number_methods[] = {
 #if JS_HAS_TOSOURCE
-    JS_FN(js_toSource_str,       num_toSource,       0,0,JSFUN_THISP_NUMBER),
+    JS_FN(js_toSource_str,       num_toSource,       0,JSFUN_THISP_NUMBER),
 #endif
-    JS_FN(js_toString_str,       num_toString,       0,1,JSFUN_THISP_NUMBER),
-    JS_FN(js_toLocaleString_str, num_toLocaleString, 0,0,JSFUN_THISP_NUMBER),
-    JS_FN(js_valueOf_str,        num_valueOf,        0,0,JSFUN_THISP_NUMBER),
-    JS_FN("toFixed",             num_toFixed,        1,1,JSFUN_THISP_NUMBER),
-    JS_FN("toExponential",       num_toExponential,  1,1,JSFUN_THISP_NUMBER),
-    JS_FN("toPrecision",         num_toPrecision,    1,1,JSFUN_THISP_NUMBER),
+    JS_FN(js_toString_str,       num_toString,       1,JSFUN_THISP_NUMBER),
+    JS_FN(js_toLocaleString_str, num_toLocaleString, 0,JSFUN_THISP_NUMBER),
+    JS_FN(js_valueOf_str,        num_valueOf,        0,JSFUN_THISP_NUMBER),
+    JS_FN("toFixed",             num_toFixed,        1,JSFUN_THISP_NUMBER),
+    JS_FN("toExponential",       num_toExponential,  1,JSFUN_THISP_NUMBER),
+    JS_FN("toPrecision",         num_toPrecision,    1,JSFUN_THISP_NUMBER),
     JS_FS_END
 };
 
 /* NB: Keep this in synch with number_constants[]. */
 enum nc_slot {
@@ -1013,22 +1029,14 @@ js_strtod(JSContext *cx, const jschar *s
         d = *(negative ? cx->runtime->jsNegativeInfinity : cx->runtime->jsPositiveInfinity);
         estr = istr + 8;
     } else {
         int err;
         d = JS_strtod(cstr, &estr, &err);
-        if (err == JS_DTOA_ENOMEM) {
-            JS_ReportOutOfMemory(cx);
-            if (cstr != cbuf)
-                JS_free(cx, cstr);
-            return JS_FALSE;
-        }
-        if (err == JS_DTOA_ERANGE) {
-            if (d == HUGE_VAL)
-                d = *cx->runtime->jsPositiveInfinity;
-            else if (d == -HUGE_VAL)
-                d = *cx->runtime->jsNegativeInfinity;
-        }
+        if (d == HUGE_VAL)
+            d = *cx->runtime->jsPositiveInfinity;
+        else if (d == -HUGE_VAL)
+            d = *cx->runtime->jsNegativeInfinity;
 #ifdef HPUX
         if (d == 0.0 && negative) {
             /*
              * "-0", "-1e-2000" come out as positive zero
              * here on HPUX. Force a negative zero instead.
diff --git a/js/src/jsobj.cpp b/js/src/jsobj.cpp
--- a/js/src/jsobj.cpp
+++ b/js/src/jsobj.cpp
@@ -1420,10 +1420,15 @@ obj_watch(JSContext *cx, uintN argc, jsv
     jsval userid, value;
     jsid propid;
     JSObject *obj;
     uintN attrs;
 
+    if (argc <= 1) {
+        js_ReportMissingArg(cx, vp, 1);
+        return JS_FALSE;
+    }
+
     callable = js_ValueToCallableObject(cx, &vp[3], 0);
     if (!callable)
         return JS_FALSE;
 
     /* Compute the unique int/atom symbol id needed by js_LookupProperty. */
@@ -1450,11 +1455,12 @@ obj_unwatch(JSContext *cx, uintN argc, j
 
     obj = JS_THIS_OBJECT(cx, vp);
     if (!obj)
         return JS_FALSE;
     *vp = JSVAL_VOID;
-    return JS_ClearWatchPoint(cx, obj, vp[2], NULL, NULL);
+    return JS_ClearWatchPoint(cx, obj, argc != 0 ? vp[2] : JSVAL_VOID,
+                              NULL, NULL);
 }
 
 #endif /* JS_HAS_OBJ_WATCHPOINT */
 
 /*
@@ -1468,22 +1474,23 @@ obj_hasOwnProperty(JSContext *cx, uintN 
 {
     JSObject *obj;
 
     obj = JS_THIS_OBJECT(cx, vp);
     return obj &&
-           js_HasOwnPropertyHelper(cx, obj->map->ops->lookupProperty, vp);
-}
-
-JSBool
-js_HasOwnPropertyHelper(JSContext *cx, JSLookupPropOp lookup, jsval *vp)
+           js_HasOwnPropertyHelper(cx, obj->map->ops->lookupProperty, argc, vp);
+}
+
+JSBool
+js_HasOwnPropertyHelper(JSContext *cx, JSLookupPropOp lookup, uintN argc,
+                        jsval *vp)
 {
     jsid id;
     JSObject *obj, *obj2;
     JSProperty *prop;
     JSScopeProperty *sprop;
 
-    if (!JS_ValueToId(cx, vp[2], &id))
+    if (!JS_ValueToId(cx, argc != 0 ? vp[2] : JSVAL_VOID, &id))
         return JS_FALSE;
     obj = JS_THIS_OBJECT(cx, vp);
     if (!obj || !lookup(cx, obj, id, &obj2, &prop))
         return JS_FALSE;
     if (!prop) {
@@ -1537,12 +1544,14 @@ static JSBool
 static JSBool
 obj_isPrototypeOf(JSContext *cx, uintN argc, jsval *vp)
 {
     JSBool b;
 
-    if (!js_IsDelegate(cx, JS_THIS_OBJECT(cx, vp), vp[2], &b))
-        return JS_FALSE;
+    if (!js_IsDelegate(cx, JS_THIS_OBJECT(cx, vp),
+                       argc != 0 ? vp[2] : JSVAL_VOID, &b)) {
+        return JS_FALSE;
+    }
     *vp = BOOLEAN_TO_JSVAL(b);
     return JS_TRUE;
 }
 
 /* Proposed ECMA 15.2.4.7. */
@@ -1553,11 +1562,11 @@ obj_propertyIsEnumerable(JSContext *cx, 
     JSObject *obj, *pobj;
     uintN attrs;
     JSProperty *prop;
     JSBool ok;
 
-    if (!JS_ValueToId(cx, vp[2], &id))
+    if (!JS_ValueToId(cx, argc != 0 ? vp[2] : JSVAL_VOID, &id))
         return JS_FALSE;
 
     obj = JS_THIS_OBJECT(cx, vp);
     if (!obj || !OBJ_LOOKUP_PROPERTY(cx, obj, id, &pobj, &prop))
         return JS_FALSE;
@@ -1600,17 +1609,17 @@ obj_defineGetter(JSContext *cx, uintN ar
     jsval fval, junk;
     jsid id;
     JSObject *obj;
     uintN attrs;
 
-    fval = vp[3];
-    if (JS_TypeOfValue(cx, fval) != JSTYPE_FUNCTION) {
+    if (argc <= 1 || JS_TypeOfValue(cx, vp[3]) != JSTYPE_FUNCTION) {
         JS_ReportErrorNumber(cx, js_GetErrorMessage, NULL,
                              JSMSG_BAD_GETTER_OR_SETTER,
                              js_getter_str);
         return JS_FALSE;
     }
+    fval = vp[3];
 
     if (!JS_ValueToId(cx, vp[2], &id))
         return JS_FALSE;
     obj = JS_THIS_OBJECT(cx, vp);
     if (!obj || !js_CheckRedeclaration(cx, obj, id, JSPROP_GETTER, NULL, NULL))
@@ -1635,17 +1644,17 @@ obj_defineSetter(JSContext *cx, uintN ar
     jsval fval, junk;
     jsid id;
     JSObject *obj;
     uintN attrs;
 
-    fval = vp[3];
-    if (JS_TypeOfValue(cx, fval) != JSTYPE_FUNCTION) {
+    if (argc <= 1 || JS_TypeOfValue(cx, vp[3]) != JSTYPE_FUNCTION) {
         JS_ReportErrorNumber(cx, js_GetErrorMessage, NULL,
                              JSMSG_BAD_GETTER_OR_SETTER,
                              js_setter_str);
         return JS_FALSE;
     }
+    fval = vp[3];
 
     if (!JS_ValueToId(cx, vp[2], &id))
         return JS_FALSE;
     obj = JS_THIS_OBJECT(cx, vp);
     if (!obj || !js_CheckRedeclaration(cx, obj, id, JSPROP_SETTER, NULL, NULL))
@@ -1670,11 +1679,11 @@ obj_lookupGetter(JSContext *cx, uintN ar
     jsid id;
     JSObject *obj, *pobj;
     JSProperty *prop;
     JSScopeProperty *sprop;
 
-    if (!JS_ValueToId(cx, vp[2], &id))
+    if (!JS_ValueToId(cx, argc != 0 ? vp[2] : JSVAL_VOID, &id))
         return JS_FALSE;
     obj = JS_THIS_OBJECT(cx, vp);
     if (!obj || !OBJ_LOOKUP_PROPERTY(cx, obj, id, &pobj, &prop))
         return JS_FALSE;
     *vp = JSVAL_VOID;
@@ -1695,11 +1704,11 @@ obj_lookupSetter(JSContext *cx, uintN ar
     jsid id;
     JSObject *obj, *pobj;
     JSProperty *prop;
     JSScopeProperty *sprop;
 
-    if (!JS_ValueToId(cx, vp[2], &id))
+    if (!JS_ValueToId(cx, argc != 0 ? vp[2] : JSVAL_VOID, &id))
         return JS_FALSE;
     obj = JS_THIS_OBJECT(cx, vp);
     if (!obj || !OBJ_LOOKUP_PROPERTY(cx, obj, id, &pobj, &prop))
         return JS_FALSE;
     *vp = JSVAL_VOID;
@@ -1713,10 +1722,31 @@ obj_lookupSetter(JSContext *cx, uintN ar
     }
     return JS_TRUE;
 }
 #endif /* JS_HAS_GETTER_SETTER */
 
+JSBool
+obj_getPrototypeOf(JSContext *cx, uintN argc, jsval *vp)
+{
+    JSObject *obj;
+    uintN attrs;
+
+    if (argc == 0) {
+        js_ReportMissingArg(cx, vp, 0);
+        return JS_FALSE;
+    }
+
+    obj = js_ValueToNonNullObject(cx, vp[2]);
+    if (!obj)
+        return JS_FALSE;
+    vp[2] = OBJECT_TO_JSVAL(obj);
+
+    return OBJ_CHECK_ACCESS(cx, obj,
+                            ATOM_TO_JSID(cx->runtime->atomState.protoAtom),
+                            JSACC_PROTO, vp, &attrs);
+}
+
 #if JS_HAS_OBJ_WATCHPOINT
 const char js_watch_str[] = "watch";
 const char js_unwatch_str[] = "unwatch";
 #endif
 const char js_hasOwnProperty_str[] = "hasOwnProperty";
@@ -1729,28 +1759,33 @@ const char js_lookupSetter_str[] = "__lo
 const char js_lookupSetter_str[] = "__lookupSetter__";
 #endif
 
 static JSFunctionSpec object_methods[] = {
 #if JS_HAS_TOSOURCE
-    JS_FN(js_toSource_str,             obj_toSource, 0,0,0),
-#endif
-    JS_FN(js_toString_str,             obj_toString,             0,0,0),
-    JS_FN(js_toLocaleString_str,       obj_toLocaleString,       0,0,0),
-    JS_FN(js_valueOf_str,              obj_valueOf,              0,0,0),
+    JS_FN(js_toSource_str,             obj_toSource, 0,0),
+#endif
+    JS_FN(js_toString_str,             obj_toString,             0,0),
+    JS_FN(js_toLocaleString_str,       obj_toLocaleString,       0,0),
+    JS_FN(js_valueOf_str,              obj_valueOf,              0,0),
 #if JS_HAS_OBJ_WATCHPOINT
-    JS_FN(js_watch_str,                obj_watch,                2,2,0),
-    JS_FN(js_unwatch_str,              obj_unwatch,              1,1,0),
-#endif
-    JS_FN(js_hasOwnProperty_str,       obj_hasOwnProperty,       1,1,0),
-    JS_FN(js_isPrototypeOf_str,        obj_isPrototypeOf,        1,1,0),
-    JS_FN(js_propertyIsEnumerable_str, obj_propertyIsEnumerable, 1,1,0),
-#if JS_HAS_GETTER_SETTER
-    JS_FN(js_defineGetter_str,         obj_defineGetter,         2,2,0),
-    JS_FN(js_defineSetter_str,         obj_defineSetter,         2,2,0),
-    JS_FN(js_lookupGetter_str,         obj_lookupGetter,         1,1,0),
-    JS_FN(js_lookupSetter_str,         obj_lookupSetter,         1,1,0),
-#endif
+    JS_FN(js_watch_str,                obj_watch,                2,0),
+    JS_FN(js_unwatch_str,              obj_unwatch,              1,0),
+#endif
+    JS_FN(js_hasOwnProperty_str,       obj_hasOwnProperty,       1,0),
+    JS_FN(js_isPrototypeOf_str,        obj_isPrototypeOf,        1,0),
+    JS_FN(js_propertyIsEnumerable_str, obj_propertyIsEnumerable, 1,0),
+#if JS_HAS_GETTER_SETTER
+    JS_FN(js_defineGetter_str,         obj_defineGetter,         2,0),
+    JS_FN(js_defineSetter_str,         obj_defineSetter,         2,0),
+    JS_FN(js_lookupGetter_str,         obj_lookupGetter,         1,0),
+    JS_FN(js_lookupSetter_str,         obj_lookupSetter,         1,0),
+#endif
+    JS_FS_END
+};
+
+static JSFunctionSpec object_static_methods[] = {
+    JS_FN("getPrototypeOf",            obj_getPrototypeOf,       1,0),
     JS_FS_END
 };
 
 static JSBool
 Object(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
@@ -2242,11 +2277,12 @@ js_InitEval(JSContext *cx, JSObject *obj
 
 JSObject *
 js_InitObjectClass(JSContext *cx, JSObject *obj)
 {
     return JS_InitClass(cx, obj, NULL, &js_ObjectClass, Object, 1,
-                        object_props, object_methods, NULL, NULL);
+                        object_props, object_methods, NULL,
+                        object_static_methods);
 }
 
 void
 js_InitObjectMap(JSObjectMap *map, jsrefcount nrefs, JSObjectOps *ops,
                  JSClass *clasp)
@@ -4328,12 +4364,14 @@ js_CheckAccess(JSContext *cx, JSObject *
         if (!OBJ_IS_NATIVE(pobj)) {
             OBJ_DROP_PROPERTY(cx, pobj, prop);
 
             /* Avoid diverging for non-natives that reuse js_CheckAccess. */
             if (pobj->map->ops->checkAccess == js_CheckAccess) {
-                if (!writing)
+                if (!writing) {
                     *vp = JSVAL_VOID;
+                    *attrsp = 0;
+                }
                 break;
             }
             return OBJ_CHECK_ACCESS(cx, pobj, id, mode, vp, attrsp);
         }
 
diff --git a/js/src/jsobj.h b/js/src/jsobj.h
--- a/js/src/jsobj.h
+++ b/js/src/jsobj.h
@@ -386,11 +386,12 @@ js_LeaveSharpObject(JSContext *cx, JSIdA
  */
 extern void
 js_TraceSharpMap(JSTracer *trc, JSSharpObjectMap *map);
 
 extern JSBool
-js_HasOwnPropertyHelper(JSContext *cx, JSLookupPropOp lookup, jsval *vp);
+js_HasOwnPropertyHelper(JSContext *cx, JSLookupPropOp lookup, uintN argc,
+                        jsval *vp);
 
 extern JSObject *
 js_InitBlockClass(JSContext *cx, JSObject* obj);
 
 extern JSObject *
diff --git a/js/src/jsopcode.cpp b/js/src/jsopcode.cpp
--- a/js/src/jsopcode.cpp
+++ b/js/src/jsopcode.cpp
@@ -319,11 +319,10 @@ js_Disassemble1(JSContext *cx, JSScript 
             return 0;
         fprintf(fp, " %s", bytes);
         break;
 
       case JOF_UINT16:
-      case JOF_LOCAL:
         i = (jsint)GET_UINT16(pc);
         goto print_int;
 
       case JOF_2BYTE:
         fprintf(fp, " %u", (uintN)pc[1]);
@@ -386,11 +385,11 @@ js_Disassemble1(JSContext *cx, JSScript 
 
       case JOF_QARG:
         fprintf(fp, " %u", GET_ARGNO(pc));
         break;
 
-      case JOF_QVAR:
+      case JOF_LOCAL:
         fprintf(fp, " %u", GET_SLOTNO(pc));
         break;
 
       case JOF_SLOTATOM:
       case JOF_SLOTOBJECT:
@@ -1175,24 +1174,16 @@ DecompileSwitch(SprintStack *ss, TableEn
         JS_ASSERT(expr);                                                      \
         if (!(expr)) return (rv);                                             \
     JS_END_MACRO
 
 static JSAtom *
-GetSlotAtom(JSPrinter *jp, JSBool argument, uintN slot)
-{
-    JSFunction *fun;
+GetArgOrVarAtom(JSPrinter *jp, uintN slot)
+{
     JSAtom *name;
 
-    fun = jp->fun;
     LOCAL_ASSERT_RV(jp->fun, NULL);
-    LOCAL_ASSERT_RV(jp->localNames, NULL);
-    if (argument) {
-        LOCAL_ASSERT_RV(slot < fun->nargs, NULL);
-    } else {
-        LOCAL_ASSERT_RV(slot < fun->u.i.nvars, NULL);
-        slot += fun->nargs;
-    }
+    LOCAL_ASSERT_RV(slot < JS_GET_LOCAL_NAME_COUNT(jp->fun), NULL);
     name = JS_LOCAL_NAME_TO_ATOM(jp->localNames[slot]);
 #if !JS_HAS_DESTRUCTURING
     LOCAL_ASSERT_RV(name, NULL);
 #endif
     return name;
@@ -1256,10 +1247,29 @@ GetLocal(SprintStack *ss, jsint i)
 #if JS_HAS_DESTRUCTURING
 
 #define LOCAL_ASSERT(expr)  LOCAL_ASSERT_RV(expr, NULL)
 #define LOAD_OP_DATA(pc)    (oplen = (cs = &js_CodeSpec[op=(JSOp)*pc])->length)
 
+static JSBool
+IsVarSlot(JSPrinter *jp, jsbytecode *pc, jsint *indexp)
+{
+    uintN slot;
+
+    slot = GET_SLOTNO(pc);
+    if (slot < jp->script->nfixed) {
+        /* The slot refers to a variable with name stored in jp->localNames. */
+        *indexp = jp->fun->nargs + slot;
+        return JS_TRUE;
+    }
+
+    /* We have a local which index is relative to the stack base. */
+    slot -= jp->script->nfixed;
+    JS_ASSERT(slot < StackDepth(jp->script));
+    *indexp = slot;
+    return JS_FALSE;
+}
+
 static jsbytecode *
 DecompileDestructuring(SprintStack *ss, jsbytecode *pc, jsbytecode *endpc);
 
 static jsbytecode *
 DecompileDestructuringLHS(SprintStack *ss, jsbytecode *pc, jsbytecode *endpc,
@@ -1267,11 +1277,12 @@ DecompileDestructuringLHS(SprintStack *s
 {
     JSContext *cx;
     JSPrinter *jp;
     JSOp op;
     const JSCodeSpec *cs;
-    uintN oplen, i;
+    uintN oplen;
+    jsint i;
     const char *lval, *xval;
     ptrdiff_t todo;
     JSAtom *atom;
 
     *hole = JS_FALSE;
@@ -1298,27 +1309,28 @@ DecompileDestructuringLHS(SprintStack *s
             return pc;
         LOCAL_ASSERT(*pc == JSOP_POP);
         break;
 
       case JSOP_SETARG:
-      case JSOP_SETVAR:
       case JSOP_SETGVAR:
       case JSOP_SETLOCAL:
         LOCAL_ASSERT(pc[oplen] == JSOP_POP || pc[oplen] == JSOP_POPN);
         /* FALL THROUGH */
 
       case JSOP_SETLOCALPOP:
-        i = GET_SLOTNO(pc);
         atom = NULL;
         lval = NULL;
-        if (op == JSOP_SETARG || op == JSOP_SETVAR) {
-            atom = GetSlotAtom(jp, op == JSOP_SETARG, i);
+        if (op == JSOP_SETARG) {
+            atom = GetArgOrVarAtom(jp, GET_SLOTNO(pc));
             LOCAL_ASSERT(atom);
         } else if (op == JSOP_SETGVAR) {
             GET_ATOM_FROM_BYTECODE(jp->script, pc, 0, atom);
-        } else {
-            lval = GetLocal(ss, i - jp->script->nfixed);
+        } else if (IsVarSlot(jp, pc, &i)) {
+            atom = GetArgOrVarAtom(jp, i);
+            LOCAL_ASSERT(atom);
+        } else {
+            lval = GetLocal(ss, i);
         }
         if (atom)
             lval = js_AtomToPrintableString(cx, atom);
         LOCAL_ASSERT(lval);
         todo = SprintCString(&ss->sprinter, lval);
@@ -1837,25 +1849,22 @@ Decompile(SprintStack *ss, jsbytecode *p
             for (fp = cx->fp; fp && !fp->script; fp = fp->down)
                 continue;
             format = cs->format;
             if (((fp && fp->regs && pc == fp->regs->pc) ||
                  (pc == startpc && cs->nuses != 0)) &&
-                format & (JOF_SET|JOF_DEL|JOF_INCDEC|JOF_IMPORT|JOF_FOR|
-                          JOF_VARPROP)) {
+                format & (JOF_SET|JOF_DEL|JOF_INCDEC|JOF_FOR|JOF_VARPROP)) {
                 mode = JOF_MODE(format);
                 if (mode == JOF_NAME) {
                     /*
                      * JOF_NAME does not imply JOF_ATOM, so we must check for
                      * the QARG and QVAR format types, and translate those to
-                     * JSOP_GETARG or JSOP_GETVAR appropriately, instead of to
-                     * JSOP_NAME.
+                     * JSOP_GETARG or JSOP_GETLOCAL appropriately, instead of
+                     * to JSOP_NAME.
                      */
                     type = JOF_TYPE(format);
                     op = (type == JOF_QARG)
                          ? JSOP_GETARG
-                         : (type == JOF_QVAR)
-                         ? JSOP_GETVAR
                          : (type == JOF_LOCAL)
                          ? JSOP_GETLOCAL
                          : JSOP_NAME;
 
                     i = cs->nuses - js_CodeSpec[op].nuses;
@@ -1901,22 +1910,19 @@ Decompile(SprintStack *ss, jsbytecode *p
                              * this may change for ES4). Therefore any error
                              * resulting from this op must be due to the value
                              * of the property accessed via |this|, so do not
                              * rewrite op to JSOP_THIS.
                              *
-                             * The next three cases should not change op if
+                             * The next two cases should not change op if
                              * js_DecompileValueGenerator was called from the
                              * the property getter. They should rewrite only
                              * if the base object in the arg/var/local is null
                              * or undefined. FIXME: bug 431569.
                              */
                             break;
                           case JSOP_GETARGPROP:
                             op = JSOP_GETARG;
-                            break;
-                          case JSOP_GETVARPROP:
-                            op = JSOP_GETVAR;
                             break;
                           case JSOP_GETLOCALPROP:
                             op = JSOP_GETLOCAL;
                             break;
                           default:
@@ -2686,11 +2692,15 @@ Decompile(SprintStack *ss, jsbytecode *p
                 break;
               }
 
               case JSOP_CALLLOCAL:
               case JSOP_GETLOCAL:
-                i = GET_SLOTNO(pc) - jp->script->nfixed;
+                if (IsVarSlot(jp, pc, &i)) {
+                    atom = GetArgOrVarAtom(jp, i);
+                    LOCAL_ASSERT(atom);
+                    goto do_name;
+                }
                 LOCAL_ASSERT((uintN)i < ss->top);
                 sn = js_GetSrcNote(jp->script, pc);
 
 #if JS_HAS_DESTRUCTURING
                 if (sn && SN_TYPE(sn) == SRC_GROUPASSIGN) {
@@ -2707,32 +2717,38 @@ Decompile(SprintStack *ss, jsbytecode *p
                 todo = Sprint(&ss->sprinter, ss_format, VarPrefix(sn), rval);
                 break;
 
               case JSOP_SETLOCAL:
               case JSOP_SETLOCALPOP:
-                i = GET_SLOTNO(pc) - jp->script->nfixed;
+                if (IsVarSlot(jp, pc, &i)) {
+                    atom = GetArgOrVarAtom(jp, i);
+                    LOCAL_ASSERT(atom);
+                    goto do_setname;
+                }
                 lval = GetStr(ss, i);
                 rval = POP_STR();
                 goto do_setlval;
 
               case JSOP_INCLOCAL:
               case JSOP_DECLOCAL:
-                i = GET_SLOTNO(pc) - jp->script->nfixed;
+                if (IsVarSlot(jp, pc, &i)) {
+                    atom = GetArgOrVarAtom(jp, i);
+                    LOCAL_ASSERT(atom);
+                    goto do_incatom;
+                }
                 lval = GetLocal(ss, i);
                 goto do_inclval;
 
               case JSOP_LOCALINC:
               case JSOP_LOCALDEC:
-                i = GET_SLOTNO(pc) - jp->script->nfixed;
+                if (IsVarSlot(jp, pc, &i)) {
+                    atom = GetArgOrVarAtom(jp, i);
+                    LOCAL_ASSERT(atom);
+                    goto do_atominc;
+                }
                 lval = GetLocal(ss, i);
                 goto do_lvalinc;
-
-              case JSOP_FORLOCAL:
-                i = GET_SLOTNO(pc) - jp->script->nfixed;
-                lval = GetStr(ss, i);
-                atom = NULL;
-                goto do_forlvalinloop;
 
               case JSOP_RETRVAL:
                 todo = -2;
                 break;
 
@@ -3077,19 +3093,25 @@ Decompile(SprintStack *ss, jsbytecode *p
               case JSOP_ANDX:
                 xval = "&&";
                 goto do_logical_connective;
 
               case JSOP_FORARG:
-                atom = GetSlotAtom(jp, JS_TRUE, GET_ARGNO(pc));
+                atom = GetArgOrVarAtom(jp, GET_ARGNO(pc));
                 LOCAL_ASSERT(atom);
                 goto do_fornameinloop;
 
-              case JSOP_FORVAR:
               case JSOP_FORCONST:
-                atom = GetSlotAtom(jp, JS_FALSE, GET_SLOTNO(pc));
-                LOCAL_ASSERT(atom);
-                goto do_fornameinloop;
+              case JSOP_FORLOCAL:
+                if (IsVarSlot(jp, pc, &i)) {
+                    atom = GetArgOrVarAtom(jp, i);
+                    LOCAL_ASSERT(atom);
+                    goto do_fornameinloop;
+                }
+                JS_ASSERT(op == JSOP_FORLOCAL);
+                lval = GetStr(ss, i);
+                atom = NULL;
+                goto do_forlvalinloop;
 
               case JSOP_FORNAME:
                 LOAD_ATOM(0);
 
               do_fornameinloop:
@@ -3312,16 +3334,11 @@ Decompile(SprintStack *ss, jsbytecode *p
                 saveop = (JSOp) ss->opcodes[ss->top-1];
                 todo = SprintCString(&ss->sprinter, rval);
                 break;
 
               case JSOP_SETARG:
-                atom = GetSlotAtom(jp, JS_TRUE, GET_ARGNO(pc));
-                LOCAL_ASSERT(atom);
-                goto do_setname;
-
-              case JSOP_SETVAR:
-                atom = GetSlotAtom(jp, JS_FALSE, GET_SLOTNO(pc));
+                atom = GetArgOrVarAtom(jp, GET_ARGNO(pc));
                 LOCAL_ASSERT(atom);
                 goto do_setname;
 
               case JSOP_SETCONST:
               case JSOP_SETNAME:
@@ -3492,17 +3509,11 @@ Decompile(SprintStack *ss, jsbytecode *p
                               rval);
                 break;
 
               case JSOP_INCARG:
               case JSOP_DECARG:
-                atom = GetSlotAtom(jp, JS_TRUE, GET_ARGNO(pc));
-                LOCAL_ASSERT(atom);
-                goto do_incatom;
-
-              case JSOP_INCVAR:
-              case JSOP_DECVAR:
-                atom = GetSlotAtom(jp, JS_FALSE, GET_SLOTNO(pc));
+                atom = GetArgOrVarAtom(jp, GET_ARGNO(pc));
                 LOCAL_ASSERT(atom);
                 goto do_incatom;
 
               case JSOP_INCNAME:
               case JSOP_DECNAME:
@@ -3554,17 +3565,11 @@ Decompile(SprintStack *ss, jsbytecode *p
                 }
                 break;
 
               case JSOP_ARGINC:
               case JSOP_ARGDEC:
-                atom = GetSlotAtom(jp, JS_TRUE, GET_ARGNO(pc));
-                LOCAL_ASSERT(atom);
-                goto do_atominc;
-
-              case JSOP_VARINC:
-              case JSOP_VARDEC:
-                atom = GetSlotAtom(jp, JS_FALSE, GET_SLOTNO(pc));
+                atom = GetArgOrVarAtom(jp, GET_ARGNO(pc));
                 LOCAL_ASSERT(atom);
                 goto do_atominc;
 
               case JSOP_NAMEINC:
               case JSOP_NAMEDEC:
@@ -3642,14 +3647,15 @@ Decompile(SprintStack *ss, jsbytecode *p
                 GET_QUOTE_AND_FMT(index_format, dot_format, rval);
                 todo = Sprint(&ss->sprinter, fmt, js_this_str, rval);
                 break;
 
               case JSOP_GETARGPROP:
-              case JSOP_GETVARPROP:
                 /* Get the name of the argument or variable. */
-                atom = GetSlotAtom(ss->printer, op == JSOP_GETARGPROP,
-                                   GET_UINT16(pc));
+                i = GET_ARGNO(pc);
+
+              do_getarg_prop:
+                atom = GetArgOrVarAtom(ss->printer, i);
                 LOCAL_ASSERT(atom);
                 LOCAL_ASSERT(ATOM_IS_STRING(atom));
                 lval = QuoteString(&ss->sprinter, ATOM_TO_STRING(atom), 0);
                 if (!lval || !PushOff(ss, STR2OFF(&ss->sprinter, lval), op))
                     return NULL;
@@ -3657,19 +3663,20 @@ Decompile(SprintStack *ss, jsbytecode *p
                 /* Get the name of the property. */
                 LOAD_ATOM(ARGNO_LEN);
                 goto do_getprop;
 
               case JSOP_GETLOCALPROP:
-                LOAD_ATOM(2);
-                i = GET_SLOTNO(pc) - jp->script->nfixed;
+                if (IsVarSlot(jp, pc, &i))
+                    goto do_getarg_prop;
                 LOCAL_ASSERT((uintN)i < ss->top);
                 lval = GetLocal(ss, i);
                 if (!lval)
                     return NULL;
                 todo = SprintCString(&ss->sprinter, lval);
                 if (todo < 0 || !PushOff(ss, todo, op))
                     return NULL;
+                LOAD_ATOM(2);
                 goto do_getprop;
 
               case JSOP_SETPROP:
                 LOAD_ATOM(0);
                 GET_QUOTE_AND_FMT("%s[%s] %s= %s", "%s.%s %s= %s", xval);
@@ -3754,25 +3761,19 @@ Decompile(SprintStack *ss, jsbytecode *p
                 break;
 
               case JSOP_CALLARG:
               case JSOP_GETARG:
                 i = GET_ARGNO(pc);
-                atom = GetSlotAtom(jp, JS_TRUE, i);
+                atom = GetArgOrVarAtom(jp, i);
 #if JS_HAS_DESTRUCTURING
                 if (!atom) {
                     todo = Sprint(&ss->sprinter, "%s[%d]", js_arguments_str, i);
                     break;
                 }
 #else
                 LOCAL_ASSERT(atom);
 #endif
-                goto do_name;
-
-              case JSOP_CALLVAR:
-              case JSOP_GETVAR:
-                atom = GetSlotAtom(jp, JS_FALSE, GET_SLOTNO(pc));
-                LOCAL_ASSERT(atom);
                 goto do_name;
 
               case JSOP_CALLNAME:
               case JSOP_NAME:
               case JSOP_GETGVAR:
@@ -4187,53 +4188,10 @@ Decompile(SprintStack *ss, jsbytecode *p
               case JSOP_CLOSURE:
                 LOAD_FUNCTION(0);
                 todo = -2;
                 goto do_function;
                 break;
-
-#if JS_HAS_EXPORT_IMPORT
-              case JSOP_EXPORTALL:
-                js_printf(jp, "\texport *;\n");
-                todo = -2;
-                break;
-
-              case JSOP_EXPORTNAME:
-                LOAD_ATOM(0);
-                rval = QuoteString(&ss->sprinter, ATOM_TO_STRING(atom), 0);
-                if (!rval)
-                    return NULL;
-                RETRACT(&ss->sprinter, rval);
-                js_printf(jp, "\texport %s;\n", rval);
-                todo = -2;
-                break;
-
-              case JSOP_IMPORTALL:
-                lval = POP_STR();
-                js_printf(jp, "\timport %s.*;\n", lval);
-                todo = -2;
-                break;
-
-              case JSOP_IMPORTPROP:
-              do_importprop:
-                GET_ATOM_QUOTE_AND_FMT("\timport %s[%s];\n",
-                                       "\timport %s.%s;\n",
-                                       rval);
-                lval = POP_STR();
-                js_printf(jp, fmt, lval, rval);
-                todo = -2;
-                break;
-
-              case JSOP_IMPORTELEM:
-                xval = POP_STR();
-                op = JSOP_GETELEM;
-                if (JOF_OPMODE(lastop) == JOF_XMLNAME)
-                    goto do_importprop;
-                lval = POP_STR();
-                js_printf(jp, "\timport %s[%s];\n", lval, xval);
-                todo = -2;
-                break;
-#endif /* JS_HAS_EXPORT_IMPORT */
 
               case JSOP_TRAP:
                 saveop = op = JS_GetTrapOpcode(cx, jp->script, pc);
                 *pc = op;
                 cs = &js_CodeSpec[op];
@@ -4840,11 +4798,11 @@ js_DecompileFunction(JSPrinter *jp)
 
         for (i = 0; i < fun->nargs; i++) {
             if (i > 0)
                 js_puts(jp, ", ");
 
-            param = GetSlotAtom(jp, JS_TRUE, i);
+            param = GetArgOrVarAtom(jp, i);
 
 #if JS_HAS_DESTRUCTURING
 #define LOCAL_ASSERT(expr)      LOCAL_ASSERT_RV(expr, JS_FALSE)
 
             if (!param) {
diff --git a/js/src/jsopcode.h b/js/src/jsopcode.h
--- a/js/src/jsopcode.h
+++ b/js/src/jsopcode.h
@@ -68,24 +68,23 @@ typedef enum JSOp {
 #define JOF_ATOM          2       /* unsigned 16-bit constant pool index */
 #define JOF_UINT16        3       /* unsigned 16-bit immediate operand */
 #define JOF_TABLESWITCH   4       /* table switch */
 #define JOF_LOOKUPSWITCH  5       /* lookup switch */
 #define JOF_QARG          6       /* quickened get/set function argument ops */
-#define JOF_QVAR          7       /* quickened get/set local variable ops */
+#define JOF_LOCAL         7       /* var or block-local variable */
 #define JOF_SLOTATOM      8       /* uint16 slot index + constant pool index */
 #define JOF_JUMPX         9       /* signed 32-bit jump offset immediate */
 #define JOF_TABLESWITCHX  10      /* extended (32-bit offset) table switch */
 #define JOF_LOOKUPSWITCHX 11      /* extended (32-bit offset) lookup switch */
 #define JOF_UINT24        12      /* extended unsigned 24-bit literal (index) */
 #define JOF_2BYTE         13      /* 2-byte opcode, e.g., upper 8 bits of 24-bit
                                      atom index */
-#define JOF_LOCAL         14      /* block-local operand stack variable */
+#define JOF_INT32         14      /* int32 immediate operand */
 #define JOF_OBJECT        15      /* unsigned 16-bit object pool index */
 #define JOF_SLOTOBJECT    16      /* uint16 slot index + object pool index */
 #define JOF_REGEXP        17      /* unsigned 16-bit regexp pool index */
 #define JOF_INT8          18      /* int8 immediate operand */
-#define JOF_INT32         19      /* int32 immediate operand */
 #define JOF_TYPEMASK      0x001f  /* mask for above immediate types */
 
 #define JOF_NAME          (1U<<5) /* name operation */
 #define JOF_PROP          (2U<<5) /* obj.prop operation */
 #define JOF_ELEM          (3U<<5) /* obj[index] operation */
@@ -96,30 +95,29 @@ typedef enum JSOp {
 #define JOF_DEL           (1U<<9) /* delete operation */
 #define JOF_DEC          (1U<<10) /* decrement (--, not ++) opcode */
 #define JOF_INC          (2U<<10) /* increment (++, not --) opcode */
 #define JOF_INCDEC       (3U<<10) /* increment or decrement opcode */
 #define JOF_POST         (1U<<12) /* postorder increment or decrement */
-#define JOF_IMPORT       (1U<<13) /* import property op */
-#define JOF_FOR          (1U<<14) /* for-in property op */
+#define JOF_FOR          (1U<<13) /* for-in property op */
 #define JOF_ASSIGNING     JOF_SET /* hint for JSClass.resolve, used for ops
                                      that do simplex assignment */
-#define JOF_DETECTING    (1U<<15) /* object detection for JSNewResolveOp */
-#define JOF_BACKPATCH    (1U<<16) /* backpatch placeholder during codegen */
-#define JOF_LEFTASSOC    (1U<<17) /* left-associative operator */
-#define JOF_DECLARING    (1U<<18) /* var, const, or function declaration op */
-#define JOF_INDEXBASE    (1U<<19) /* atom segment base setting prefix op */
-#define JOF_CALLOP       (1U<<20) /* call operation that pushes function and
+#define JOF_DETECTING    (1U<<14) /* object detection for JSNewResolveOp */
+#define JOF_BACKPATCH    (1U<<15) /* backpatch placeholder during codegen */
+#define JOF_LEFTASSOC    (1U<<16) /* left-associative operator */
+#define JOF_DECLARING    (1U<<17) /* var, const, or function declaration op */
+#define JOF_INDEXBASE    (1U<<18) /* atom segment base setting prefix op */
+#define JOF_CALLOP       (1U<<19) /* call operation that pushes function and
                                      this */
-#define JOF_PARENHEAD    (1U<<21) /* opcode consumes value of expression in
+#define JOF_PARENHEAD    (1U<<20) /* opcode consumes value of expression in
                                      parenthesized statement head */
-#define JOF_INVOKE       (1U<<22) /* JSOP_CALL, JSOP_NEW, JSOP_EVAL */
-#define JOF_TMPSLOT      (1U<<23) /* interpreter uses extra temporary slot
+#define JOF_INVOKE       (1U<<21) /* JSOP_CALL, JSOP_NEW, JSOP_EVAL */
+#define JOF_TMPSLOT      (1U<<22) /* interpreter uses extra temporary slot
                                      to root intermediate objects besides
                                      the slots opcode uses */
-#define JOF_TMPSLOT2     (2U<<23) /* interpreter uses extra 2 temporary slot
+#define JOF_TMPSLOT2     (2U<<22) /* interpreter uses extra 2 temporary slot
                                      besides the slots opcode uses */
-#define JOF_TMPSLOT_SHIFT 23
+#define JOF_TMPSLOT_SHIFT 22
 #define JOF_TMPSLOT_MASK  (JS_BITMASK(2) << JOF_TMPSLOT_SHIFT)
 
 /* Shorthands for type from format and type from opcode. */
 #define JOF_TYPE(fmt)   ((fmt) & JOF_TYPEMASK)
 #define JOF_OPTYPE(op)  JOF_TYPE(js_CodeSpec[op].format)
@@ -233,11 +231,11 @@ JS_STATIC_ASSERT(sizeof(uint32) * JS_BIT
 #define ARGC_HI(argc)           UINT16_HI(argc)
 #define ARGC_LO(argc)           UINT16_LO(argc)
 #define GET_ARGC(pc)            GET_UINT16(pc)
 #define ARGC_LIMIT              UINT16_LIMIT
 
-/* Synonyms for quick JOF_QARG and JOF_QVAR bytecodes. */
+/* Synonyms for quick JOF_QARG and JOF_LOCAL bytecodes. */
 #define GET_ARGNO(pc)           GET_UINT16(pc)
 #define SET_ARGNO(pc,argno)     SET_UINT16(pc,argno)
 #define ARGNO_LEN               2
 #define ARGNO_LIMIT             UINT16_LIMIT
 
diff --git a/js/src/jsopcode.tbl b/js/src/jsopcode.tbl
--- a/js/src/jsopcode.tbl
+++ b/js/src/jsopcode.tbl
@@ -108,13 +108,13 @@ OPDEF(JSOP_IFNE,      8,  "ifne",       
 OPDEF(JSOP_IFNE,      8,  "ifne",       NULL,         3,  1,  0,  0,  JOF_JUMP|JOF_PARENHEAD)
 
 /* Get the arguments object for the current, lightweight function activation. */
 OPDEF(JSOP_ARGUMENTS, 9, js_arguments_str, js_arguments_str, 1, 0, 1, 18, JOF_BYTE)
 
-/* ECMA-compliant for-in loop with argument or local variable loop control. */
+/* ECMA-compliant for-in loop with argument or local loop control. */
 OPDEF(JSOP_FORARG,    10, "forarg",     NULL,         3,  0,  1, 19,  JOF_QARG|JOF_NAME|JOF_FOR)
-OPDEF(JSOP_FORVAR,    11, "forvar",     NULL,         3,  0,  1, 19,  JOF_QVAR|JOF_NAME|JOF_FOR)
+OPDEF(JSOP_FORLOCAL,  11, "forlocal",   NULL,         3,  0,  1, 19,  JOF_LOCAL|JOF_NAME|JOF_FOR)
 
 /* More longstanding bytecodes. */
 OPDEF(JSOP_DUP,       12, "dup",        NULL,         1,  1,  2,  0,  JOF_BYTE)
 OPDEF(JSOP_DUP2,      13, "dup2",       NULL,         1,  2,  4,  0,  JOF_BYTE)
 OPDEF(JSOP_SETCONST,  14, "setconst",   NULL,         3,  1,  1,  3,  JOF_ATOM|JOF_NAME|JOF_SET)
@@ -185,16 +185,15 @@ OPDEF(JSOP_STRICTNE,  73, "strictne",   
 OPDEF(JSOP_STRICTNE,  73, "strictne",   NULL,         1,  2,  1,  10,  JOF_BYTE|JOF_DETECTING)
 
 /* Lexical closure constructor. */
 OPDEF(JSOP_CLOSURE,   74, "closure",    NULL,         3,  0,  0,  0,  JOF_OBJECT)
 
-/* Export and import ops. */
-OPDEF(JSOP_EXPORTALL, 75, "exportall",  NULL,         1,  0,  0,  0,  JOF_BYTE)
-OPDEF(JSOP_EXPORTNAME,76, "exportname", NULL,         3,  0,  0,  0,  JOF_ATOM|JOF_NAME)
-OPDEF(JSOP_IMPORTALL, 77, "importall",  NULL,         1,  1,  0,  0,  JOF_BYTE)
-OPDEF(JSOP_IMPORTPROP,78, "importprop", NULL,         3,  1,  0,  0,  JOF_ATOM|JOF_PROP|JOF_IMPORT)
-OPDEF(JSOP_IMPORTELEM,79, "importelem", NULL,         1,  2,  0,  0,  JOF_BYTE |JOF_ELEM|JOF_IMPORT)
+OPDEF(JSOP_UNUSED75,  75, "unused75",   NULL,         1,  0,  0,  0,  JOF_BYTE)
+OPDEF(JSOP_UNUSED76,  76, "unused76",   NULL,         1,  0,  0,  0,  JOF_BYTE)
+OPDEF(JSOP_UNUSED77,  77, "unused77",   NULL,         1,  0,  0,  0,  JOF_BYTE)
+OPDEF(JSOP_UNUSED78,  78, "unused78",   NULL,         1,  0,  0,  0,  JOF_BYTE)
+OPDEF(JSOP_UNUSED79,  79, "unused79",   NULL,         1,  0,  0,  0,  JOF_BYTE)
 
 /* Push object literal. */
 OPDEF(JSOP_OBJECT,    80, "object",     NULL,         3,  0,  1, 19,  JOF_OBJECT)
 
 /* Pop value and discard it. */
@@ -207,12 +206,12 @@ OPDEF(JSOP_TRAP,      83, "trap",       
 OPDEF(JSOP_TRAP,      83, "trap",       NULL,         1,  0,  0,  0,  JOF_BYTE)
 
 /* Fast get/set ops for function arguments and local variables. */
 OPDEF(JSOP_GETARG,    84, "getarg",     NULL,         3,  0,  1, 19,  JOF_QARG |JOF_NAME)
 OPDEF(JSOP_SETARG,    85, "setarg",     NULL,         3,  1,  1,  3,  JOF_QARG |JOF_NAME|JOF_SET)
-OPDEF(JSOP_GETVAR,    86, "getvar",     NULL,         3,  0,  1, 19,  JOF_QVAR |JOF_NAME)
-OPDEF(JSOP_SETVAR,    87, "setvar",     NULL,         3,  1,  1,  3,  JOF_QVAR |JOF_NAME|JOF_SET|JOF_DETECTING)
+OPDEF(JSOP_GETLOCAL,  86,"getlocal",    NULL,         3,  0,  1, 19,  JOF_LOCAL|JOF_NAME)
+OPDEF(JSOP_SETLOCAL,  87,"setlocal",    NULL,         3,  1,  1,  3,  JOF_LOCAL|JOF_NAME|JOF_SET|JOF_DETECTING)
 
 /* Push unsigned 16-bit int constant. */
 OPDEF(JSOP_UINT16,    88, "uint16",     NULL,         3,  0,  1, 16,  JOF_UINT16)
 
 /* Object and array literal support. */
@@ -221,19 +220,20 @@ OPDEF(JSOP_INITPROP,  91, "initprop",   
 OPDEF(JSOP_INITPROP,  91, "initprop",   NULL,         3,  1,  0,  3,  JOF_ATOM|JOF_PROP|JOF_SET|JOF_DETECTING)
 OPDEF(JSOP_INITELEM,  92, "initelem",   NULL,         1,  2,  0,  3,  JOF_BYTE |JOF_ELEM|JOF_SET|JOF_DETECTING)
 OPDEF(JSOP_DEFSHARP,  93, "defsharp",   NULL,         3,  0,  0,  0,  JOF_UINT16)
 OPDEF(JSOP_USESHARP,  94, "usesharp",   NULL,         3,  0,  1,  0,  JOF_UINT16)
 
-/* Fast inc/dec ops for args and local vars. */
+/* Fast inc/dec ops for args and locals. */
 OPDEF(JSOP_INCARG,    95, "incarg",     NULL,         3,  0,  1, 15,  JOF_QARG |JOF_NAME|JOF_INC)
-OPDEF(JSOP_INCVAR,    96, "incvar",     NULL,         3,  0,  1, 15,  JOF_QVAR |JOF_NAME|JOF_INC)
-OPDEF(JSOP_DECARG,    97, "decarg",     NULL,         3,  0,  1, 15,  JOF_QARG |JOF_NAME|JOF_DEC)
-OPDEF(JSOP_DECVAR,    98, "decvar",     NULL,         3,  0,  1, 15,  JOF_QVAR |JOF_NAME|JOF_DEC)
-OPDEF(JSOP_ARGINC,    99, "arginc",     NULL,         3,  0,  1, 15,  JOF_QARG |JOF_NAME|JOF_INC|JOF_POST)
-OPDEF(JSOP_VARINC,    100,"varinc",     NULL,         3,  0,  1, 15,  JOF_QVAR |JOF_NAME|JOF_INC|JOF_POST)
-OPDEF(JSOP_ARGDEC,    101,"argdec",     NULL,         3,  0,  1, 15,  JOF_QARG |JOF_NAME|JOF_DEC|JOF_POST)
-OPDEF(JSOP_VARDEC,    102,"vardec",     NULL,         3,  0,  1, 15,  JOF_QVAR |JOF_NAME|JOF_DEC|JOF_POST)
+OPDEF(JSOP_DECARG,    96, "decarg",     NULL,         3,  0,  1, 15,  JOF_QARG |JOF_NAME|JOF_DEC)
+OPDEF(JSOP_ARGINC,    97, "arginc",     NULL,         3,  0,  1, 15,  JOF_QARG |JOF_NAME|JOF_INC|JOF_POST)
+OPDEF(JSOP_ARGDEC,    98, "argdec",     NULL,         3,  0,  1, 15,  JOF_QARG |JOF_NAME|JOF_DEC|JOF_POST)
+
+OPDEF(JSOP_INCLOCAL,  99, "inclocal",   NULL,         3,  0,  1, 15,  JOF_LOCAL|JOF_NAME|JOF_INC)
+OPDEF(JSOP_DECLOCAL,  100,"declocal",   NULL,         3,  0,  1, 15,  JOF_LOCAL|JOF_NAME|JOF_DEC)
+OPDEF(JSOP_LOCALINC,  101,"localinc",   NULL,         3,  0,  1, 15,  JOF_LOCAL|JOF_NAME|JOF_INC|JOF_POST)
+OPDEF(JSOP_LOCALDEC,  102,"localdec",   NULL,         3,  0,  1, 15,  JOF_LOCAL|JOF_NAME|JOF_DEC|JOF_POST)
 
 /*
  * Initialize for-in iterator using the JSITER_* flag bits in this op's uint8
  * immediate operand. See also JSOP_ENDITER.
  */
@@ -459,22 +459,22 @@ OPDEF(JSOP_TYPEOFEXPR,    198,"typeofexp
 /*
  * Block-local scope support.
  */
 OPDEF(JSOP_ENTERBLOCK,    199,"enterblock",  NULL,    3,  0,  0,  0,  JOF_OBJECT)
 OPDEF(JSOP_LEAVEBLOCK,    200,"leaveblock",  NULL,    3,  0,  0,  0,  JOF_UINT16)
-OPDEF(JSOP_GETLOCAL,      201,"getlocal",    NULL,    3,  0,  1, 19,  JOF_LOCAL|JOF_NAME)
-OPDEF(JSOP_SETLOCAL,      202,"setlocal",    NULL,    3,  1,  1,  3,  JOF_LOCAL|JOF_NAME|JOF_SET)
-OPDEF(JSOP_INCLOCAL,      203,"inclocal",    NULL,    3,  0,  1, 15,  JOF_LOCAL|JOF_NAME|JOF_INC)
-OPDEF(JSOP_DECLOCAL,      204,"declocal",    NULL,    3,  0,  1, 15,  JOF_LOCAL|JOF_NAME|JOF_DEC)
-OPDEF(JSOP_LOCALINC,      205,"localinc",    NULL,    3,  0,  1, 15,  JOF_LOCAL|JOF_NAME|JOF_INC|JOF_POST)
-OPDEF(JSOP_LOCALDEC,      206,"localdec",    NULL,    3,  0,  1, 15,  JOF_LOCAL|JOF_NAME|JOF_DEC|JOF_POST)
-OPDEF(JSOP_FORLOCAL,      207,"forlocal",    NULL,    3,  0,  1, 19,  JOF_LOCAL|JOF_NAME|JOF_FOR)
+OPDEF(JSOP_UNUSED201,     201,"unused201",   NULL,    1,  0,  0,  0,  JOF_BYTE)
+OPDEF(JSOP_UNUSED202,     202,"unused202",   NULL,    1,  0,  0,  0,  JOF_BYTE)
+OPDEF(JSOP_UNUSED203,     203,"unused203",   NULL,    1,  0,  0,  0,  JOF_BYTE)
+OPDEF(JSOP_UNUSED204,     204,"unused204",   NULL,    1,  0,  0,  0,  JOF_BYTE)
+OPDEF(JSOP_UNUSED205,     205,"unused205",   NULL,    1,  0,  0,  0,  JOF_BYTE)
+OPDEF(JSOP_UNUSED206,     206,"unused206",   NULL,    1,  0,  0,  0,  JOF_BYTE)
+OPDEF(JSOP_UNUSED207,     207,"unused207",   NULL,    1,  0,  0, 0,   JOF_BYTE)
 
 /*
  * Iterator, generator, and array comprehension support.
  */
-OPDEF(JSOP_FORCONST,      208,"forconst",    NULL,    3,  0,  1, 19,  JOF_QVAR|JOF_NAME|JOF_FOR)
+OPDEF(JSOP_FORCONST,      208,"forconst",    NULL,    3,  0,  1, 19,  JOF_LOCAL|JOF_NAME|JOF_FOR)
 OPDEF(JSOP_ENDITER,       209,"enditer",     NULL,    1,  1,  0,  0,  JOF_BYTE|JOF_TMPSLOT)
 OPDEF(JSOP_GENERATOR,     210,"generator",   NULL,    1,  0,  0,  0,  JOF_BYTE)
 OPDEF(JSOP_YIELD,         211,"yield",       NULL,    1,  1,  1,  1,  JOF_BYTE)
 OPDEF(JSOP_ARRAYPUSH,     212,"arraypush",   NULL,    3,  1,  0,  3,  JOF_LOCAL)
 
@@ -490,29 +490,29 @@ OPDEF(JSOP_ENUMCONSTELEM, 214,"enumconst
  * which must be moved down when the block pops.
  */
 OPDEF(JSOP_LEAVEBLOCKEXPR,215,"leaveblockexpr",NULL,  3,  0,  0,  1,  JOF_UINT16)
 
 /*
- * Optimize common JSOP_{THIS,GET{ARG,VAR,LOCAL}} -> JSOP_GETPROP cliches.
+ * Optimize common JSOP_{THIS,GET{ARG,LOCAL}} -> JSOP_GETPROP cliches.
  */
 OPDEF(JSOP_GETTHISPROP,   216,"getthisprop",   NULL,  3,  0,  1, 18,  JOF_ATOM|JOF_VARPROP)
 OPDEF(JSOP_GETARGPROP,    217,"getargprop",    NULL,  5,  0,  1, 18,  JOF_SLOTATOM|JOF_VARPROP)
-OPDEF(JSOP_GETVARPROP,    218,"getvarprop",    NULL,  5,  0,  1, 18,  JOF_SLOTATOM|JOF_VARPROP)
-OPDEF(JSOP_GETLOCALPROP,  219,"getlocalprop",  NULL,  5,  0,  1, 18,  JOF_SLOTATOM|JOF_VARPROP)
+OPDEF(JSOP_GETLOCALPROP,  218,"getlocalprop",  NULL,  5,  0,  1, 18,  JOF_SLOTATOM|JOF_VARPROP)
+OPDEF(JSOP_UNUSED219,     219,"unused219",     NULL,  1,  0,  0,  0,  JOF_BYTE)
 
 /*
  * Optimize atom segments 1-3.  These must be followed by JSOP_RESETBASE0 after
  * the opcode that they prefix.
  */
 OPDEF(JSOP_INDEXBASE1,    220,"atombase1",     NULL,  1,  0,  0,  0,  JOF_BYTE |JOF_INDEXBASE)
 OPDEF(JSOP_INDEXBASE2,    221,"atombase2",     NULL,  1,  0,  0,  0,  JOF_BYTE |JOF_INDEXBASE)
 OPDEF(JSOP_INDEXBASE3,    222,"atombase3",     NULL,  1,  0,  0,  0,  JOF_BYTE |JOF_INDEXBASE)
 
 OPDEF(JSOP_CALLGVAR,      223, "callgvar",     NULL,  3,  0,  2, 19,  JOF_ATOM|JOF_NAME|JOF_CALLOP)
-OPDEF(JSOP_CALLVAR,       224, "callvar",      NULL,  3,  0,  2, 19,  JOF_QVAR |JOF_NAME|JOF_CALLOP)
+OPDEF(JSOP_CALLLOCAL,     224, "calllocal",    NULL,  3,  0,  2, 19,  JOF_LOCAL|JOF_NAME|JOF_CALLOP)
 OPDEF(JSOP_CALLARG,       225, "callarg",      NULL,  3,  0,  2, 19,  JOF_QARG |JOF_NAME|JOF_CALLOP)
-OPDEF(JSOP_CALLLOCAL,     226, "calllocal",    NULL,  3,  0,  2, 19,  JOF_LOCAL|JOF_NAME|JOF_CALLOP)
+OPDEF(JSOP_UNUSED226,     226, "unused226",    NULL,  1,  0,  1,  1,  JOF_BYTE)
 
 /*
  * Opcodes to hold 8-bit and 32-bit immediate integer operands.
  */
 OPDEF(JSOP_INT8,          227, "int8",         NULL,  2,  0,  1, 16,  JOF_INT8)
diff --git a/js/src/jsparse.cpp b/js/src/jsparse.cpp
--- a/js/src/jsparse.cpp
+++ b/js/src/jsparse.cpp
@@ -612,14 +612,10 @@ js_CompileScript(JSContext *cx, JSObject
         if (!pn) {
             script = NULL;
             goto out;
         }
 
-        /*
-         * FIXME bug 346749: let declarations at the top level in a script are
-         * turned into var declarations and do not introduce block nodes.
-         */
         JS_ASSERT(!cg.treeContext.blockNode);
 
         if (!js_FoldConstants(cx, pn, &cg.treeContext) ||
             !js_EmitTree(cx, &cg, pn)) {
             script = NULL;
@@ -651,12 +647,12 @@ js_CompileScript(JSContext *cx, JSObject
                   ? (uintN) cs->length
                   : js_GetVariableBytecodeLength(code);
             if (JOF_TYPE(cs->format) == JOF_LOCAL ||
                 (JOF_TYPE(cs->format) == JOF_SLOTATOM)) {
                 /*
-                 * JSOP_GETARGPROP and JSOP_GETVARPROP also have JOF_SLOTATOM
-                 * type, but they may be emitted only for a function.
+                 * JSOP_GETARGPROP also has JOF_SLOTATOM type, but it may be
+                 * emitted only for a function.
                  */
                 JS_ASSERT((JOF_TYPE(cs->format) == JOF_SLOTATOM) ==
                           (op == JSOP_GETLOCALPROP));
                 slot = GET_SLOTNO(code);
                 slot += scriptGlobals;
@@ -1202,11 +1198,11 @@ FunctionDef(JSContext *cx, JSTokenStream
          * A function nested at top level inside another's body needs only a
          * local variable to bind its name to its value, and not an activation
          * object property (it might also need the activation property, if the
          * outer function contains with statements, e.g., but the stack slot
          * wins when jsemit.c's BindNameToSlot can optimize a JSOP_NAME into a
-         * JSOP_GETVAR bytecode).
+         * JSOP_GETLOCAL bytecode).
          */
         if (AT_TOP_LEVEL(tc) && (tc->flags & TCF_IN_FUNCTION)) {
             JSLocalKind localKind;
 
             /*
@@ -1389,13 +1385,13 @@ FunctionDef(JSContext *cx, JSTokenStream
 #endif
 
     /*
      * If we collected flags that indicate nested heavyweight functions, or
      * this function contains heavyweight-making statements (references to
-     * __parent__ or __proto__; use of with, eval, import, or export; and
-     * assignment to arguments), flag the function as heavyweight (requiring
-     * a call object per invocation).
+     * __parent__ or __proto__; use of with, or eval; and assignment to 
+     * arguments), flag the function as heavyweight (requiring a call object 
+     * per invocation).
      */
     if (funtc.flags & TCF_FUN_HEAVYWEIGHT) {
         fun->flags |= JSFUN_HEAVYWEIGHT;
         tc->flags |= TCF_FUN_HEAVYWEIGHT;
     } else {
@@ -1580,86 +1576,10 @@ MatchLabel(JSContext *cx, JSTokenStream 
     }
     pn->pn_atom = label;
     return JS_TRUE;
 }
 
-#if JS_HAS_EXPORT_IMPORT
-static JSParseNode *
-ImportExpr(JSContext *cx, JSTokenStream *ts, JSTreeContext *tc)
-{
-    JSParseNode *pn, *pn2;
-    JSTokenType tt;
-
-    MUST_MATCH_TOKEN(TOK_NAME, JSMSG_NO_IMPORT_NAME);
-    pn = NewParseNode(cx, ts, PN_NAME, tc);
-    if (!pn)
-        return NULL;
-    pn->pn_op = JSOP_NAME;
-    pn->pn_atom = CURRENT_TOKEN(ts).t_atom;
-    pn->pn_slot = -1;
-
-    ts->flags |= TSF_OPERAND;
-    while ((tt = js_GetToken(cx, ts)) == TOK_DOT || tt == TOK_LB) {
-        ts->flags &= ~TSF_OPERAND;
-        if (pn->pn_op == JSOP_IMPORTALL)
-            goto bad_import;
-
-        if (tt == TOK_DOT) {
-            pn2 = NewParseNode(cx, ts, PN_NAME, tc);
-            if (!pn2)
-                return NULL;
-            ts->flags |= TSF_KEYWORD_IS_NAME;
-            if (js_MatchToken(cx, ts, TOK_STAR)) {
-                pn2->pn_op = JSOP_IMPORTALL;
-                pn2->pn_slot = -1;
-            } else {
-                MUST_MATCH_TOKEN(TOK_NAME, JSMSG_NAME_AFTER_DOT);
-                pn2->pn_op = JSOP_GETPROP;
-                pn2->pn_atom = CURRENT_TOKEN(ts).t_atom;
-                pn2->pn_slot = -1;
-            }
-            ts->flags &= ~TSF_KEYWORD_IS_NAME;
-            pn2->pn_expr = pn;
-            pn2->pn_pos.begin = pn->pn_pos.begin;
-            pn2->pn_pos.end = CURRENT_TOKEN(ts).pos.end;
-        } else {
-            /* Make a TOK_LB binary node. */
-            pn2 = NewBinary(cx, tt, JSOP_GETELEM, pn, Expr(cx, ts, tc), tc);
-            if (!pn2)
-                return NULL;
-
-            MUST_MATCH_TOKEN(TOK_RB, JSMSG_BRACKET_IN_INDEX);
-        }
-
-        pn = pn2;
-        ts->flags |= TSF_OPERAND;
-    }
-    ts->flags &= ~TSF_OPERAND;
-    if (tt == TOK_ERROR)
-        return NULL;
-    js_UngetToken(ts);
-
-    switch (pn->pn_op) {
-      case JSOP_GETPROP:
-        pn->pn_op = JSOP_IMPORTPROP;
-        break;
-      case JSOP_GETELEM:
-        pn->pn_op = JSOP_IMPORTELEM;
-        break;
-      case JSOP_IMPORTALL:
-        break;
-      default:
-        goto bad_import;
-    }
-    return pn;
-
-  bad_import:
-    js_ReportCompileErrorNumber(cx, ts, NULL, JSREPORT_ERROR, JSMSG_BAD_IMPORT);
-    return NULL;
-}
-#endif /* JS_HAS_EXPORT_IMPORT */
-
 static JSBool
 BindLet(JSContext *cx, BindData *data, JSAtom *atom, JSTreeContext *tc)
 {
     JSObject *blockObj;
     JSScopeProperty *sprop;
@@ -1712,11 +1632,11 @@ BindVarOrConst(JSContext *cx, BindData *
     JSAtomListElement *ale;
     JSOp op, prevop;
     const char *name;
     JSLocalKind localKind;
 
-    stmt = js_LexicalLookup(tc, atom, NULL, 0);
+    stmt = js_LexicalLookup(tc, atom, NULL);
     ATOM_LIST_SEARCH(ale, &tc->decls, atom);
     op = data->op;
     if ((stmt && stmt->type != STMT_WITH) || ale) {
         prevop = ale ? ALE_JSOP(ale) : JSOP_DEFVAR;
         if (JS_HAS_STRICT_OPTION(cx)
@@ -2464,53 +2384,10 @@ Statement(JSContext *cx, JSTokenStream *
             return NULL;
     }
 #endif
 
     switch (tt) {
-#if JS_HAS_EXPORT_IMPORT
-      case TOK_EXPORT:
-        pn = NewParseNode(cx, ts, PN_LIST, tc);
-        if (!pn)
-            return NULL;
-        PN_INIT_LIST(pn);
-        if (js_MatchToken(cx, ts, TOK_STAR)) {
-            pn2 = NewParseNode(cx, ts, PN_NULLARY, tc);
-            if (!pn2)
-                return NULL;
-            PN_APPEND(pn, pn2);
-        } else {
-            do {
-                MUST_MATCH_TOKEN(TOK_NAME, JSMSG_NO_EXPORT_NAME);
-                pn2 = NewParseNode(cx, ts, PN_NAME, tc);
-                if (!pn2)
-                    return NULL;
-                pn2->pn_op = JSOP_NAME;
-                pn2->pn_atom = CURRENT_TOKEN(ts).t_atom;
-                pn2->pn_slot = -1;
-                PN_APPEND(pn, pn2);
-            } while (js_MatchToken(cx, ts, TOK_COMMA));
-        }
-        pn->pn_pos.end = PN_LAST(pn)->pn_pos.end;
-        tc->flags |= TCF_FUN_HEAVYWEIGHT;
-        break;
-
-      case TOK_IMPORT:
-        pn = NewParseNode(cx, ts, PN_LIST, tc);
-        if (!pn)
-            return NULL;
-        PN_INIT_LIST(pn);
-        do {
-            pn2 = ImportExpr(cx, ts, tc);
-            if (!pn2)
-                return NULL;
-            PN_APPEND(pn, pn2);
-        } while (js_MatchToken(cx, ts, TOK_COMMA));
-        pn->pn_pos.end = PN_LAST(pn)->pn_pos.end;
-        tc->flags |= TCF_FUN_HEAVYWEIGHT;
-        break;
-#endif /* JS_HAS_EXPORT_IMPORT */
-
       case TOK_FUNCTION:
 #if JS_HAS_XML_SUPPORT
         ts->flags |= TSF_KEYWORD_IS_NAME;
         tt = js_PeekToken(cx, ts);
         ts->flags &= ~TSF_KEYWORD_IS_NAME;
@@ -3328,20 +3205,14 @@ Statement(JSContext *cx, JSTokenStream *
 
         if (stmt && (stmt->flags & SIF_SCOPE)) {
             JS_ASSERT(tc->blockChain == stmt->u.blockObj);
             obj = tc->blockChain;
         } else {
-            if (!stmt) {
-                /*
-                 * FIXME: https://bugzilla.mozilla.org/show_bug.cgi?id=346749
-                 *
-                 * This is a hard case that requires more work. In particular,
-                 * in many cases, we're trying to emit code as we go. However,
-                 * this means that we haven't necessarily finished processing
-                 * all let declarations in the implicit top-level block when
-                 * we emit a reference to one of them.  For now, punt on this
-                 * and pretend this is a var declaration.
+            if (!stmt || (stmt->flags & SIF_BODY_BLOCK)) {
+                /*
+                 * ES4 specifies that let at top level and at body-block scope
+                 * does not shadow var, so convert back to var.
                  */
                 CURRENT_TOKEN(ts).type = TOK_VAR;
                 CURRENT_TOKEN(ts).t_op = JSOP_DEFVAR;
 
                 pn = Variables(cx, ts, tc);
@@ -5885,14 +5756,10 @@ PrimaryExpr(JSContext *cx, JSTokenStream
 #if JS_HAS_SHARP_VARS
         notsharp = JS_TRUE;
 #endif
         break;
 
-#if !JS_HAS_EXPORT_IMPORT
-      case TOK_EXPORT:
-      case TOK_IMPORT:
-#endif
       case TOK_ERROR:
         /* The scanner or one of its subroutines reported the error. */
         return NULL;
 
       default:
@@ -6596,15 +6463,10 @@ js_FoldConstants(JSContext *cx, JSParseN
 
         /* Can't concatenate string literals, let's try numbers. */
         goto do_binary_op;
 
       case TOK_STAR:
-        /* The * in 'import *;' parses as a nullary star node. */
-        if (pn->pn_arity == PN_NULLARY)
-            break;
-        /* FALL THROUGH */
-
       case TOK_SHOP:
       case TOK_MINUS:
       case TOK_DIVOP:
       do_binary_op:
         if (pn->pn_arity == PN_LIST) {
diff --git a/js/src/jsparse.h b/js/src/jsparse.h
--- a/js/src/jsparse.h
+++ b/js/src/jsparse.h
@@ -69,17 +69,10 @@ JS_BEGIN_EXTERN_C
  *                          pn_flags: TCF_FUN_* flags (see jsemit.h) collected
  *                            while parsing the function's body
  *
  * <Statements>
  * TOK_LC       list        pn_head: list of pn_count statements
- * TOK_EXPORT   list        pn_head: list of pn_count TOK_NAMEs or one TOK_STAR
- *                            (which is not a multiply node)
- * TOK_IMPORT   list        pn_head: list of pn_count sub-trees of the form
- *                            a.b.*, a[b].*, a.*, a.b, or a[b] -- but never a.
- *                            Each member is expressed with TOK_DOT or TOK_LB.
- *                            Each sub-tree's root node has a pn_op in the set
- *                            JSOP_IMPORT{ALL,PROP,ELEM}
  * TOK_IF       ternary     pn_kid1: cond, pn_kid2: then, pn_kid3: else or null
  * TOK_SWITCH   binary      pn_left: discriminant
  *                          pn_right: list of TOK_CASE nodes, with at most one
  *                            TOK_DEFAULT node, or if there are let bindings
  *                            in the top level of the switch body's cases, a
diff --git a/js/src/jspubtd.h b/js/src/jspubtd.h
--- a/js/src/jspubtd.h
+++ b/js/src/jspubtd.h
@@ -103,11 +103,16 @@ typedef enum JSProtoKey {
 
 /* JSObjectOps.checkAccess mode enumeration. */
 typedef enum JSAccessMode {
     JSACC_PROTO  = 0,           /* XXXbe redundant w.r.t. id */
     JSACC_PARENT = 1,           /* XXXbe redundant w.r.t. id */
-    JSACC_IMPORT = 2,           /* import foo.bar */
+
+                                /* 
+                                 * enum value #2 formerly called JSACC_IMPORT, 
+                                 * gap preserved for liveconnect ABI compatibility.
+                                 */
+
     JSACC_WATCH  = 3,           /* a watchpoint on object foo for id 'bar' */
     JSACC_READ   = 4,           /* a "get" of foo.bar */
     JSACC_WRITE  = 8,           /* a "set" of foo.bar = baz */
     JSACC_LIMIT
 } JSAccessMode;
diff --git a/js/src/jsregexp.cpp b/js/src/jsregexp.cpp
--- a/js/src/jsregexp.cpp
+++ b/js/src/jsregexp.cpp
@@ -4224,16 +4224,16 @@ regexp_test(JSContext *cx, uintN argc, j
     return JS_TRUE;
 }
 
 static JSFunctionSpec regexp_methods[] = {
 #if JS_HAS_TOSOURCE
-    JS_FN(js_toSource_str,  regexp_toString,    0,0,0),
-#endif
-    JS_FN(js_toString_str,  regexp_toString,    0,0,0),
-    JS_FN("compile",        regexp_compile,     0,2,0),
-    JS_FN("exec",           regexp_exec,        0,1,0),
-    JS_FN("test",           regexp_test,        0,1,0),
+    JS_FN(js_toSource_str,  regexp_toString,    0,0),
+#endif
+    JS_FN(js_toString_str,  regexp_toString,    0,0),
+    JS_FN("compile",        regexp_compile,     2,0),
+    JS_FN("exec",           regexp_exec,        1,0),
+    JS_FN("test",           regexp_test,        1,0),
     JS_FS_END
 };
 
 static JSBool
 RegExp(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
diff --git a/js/src/jsscan.h b/js/src/jsscan.h
--- a/js/src/jsscan.h
+++ b/js/src/jsscan.h
@@ -85,60 +85,58 @@ typedef enum JSTokenType {
     TOK_NUMBER = 30,                    /* numeric constant */
     TOK_STRING = 31,                    /* string constant */
     TOK_REGEXP = 32,                    /* RegExp constant */
     TOK_PRIMARY = 33,                   /* true, false, null, this, super */
     TOK_FUNCTION = 34,                  /* function keyword */
-    TOK_EXPORT = 35,                    /* export keyword */
-    TOK_IMPORT = 36,                    /* import keyword */
-    TOK_IF = 37,                        /* if keyword */
-    TOK_ELSE = 38,                      /* else keyword */
-    TOK_SWITCH = 39,                    /* switch keyword */
-    TOK_CASE = 40,                      /* case keyword */
-    TOK_DEFAULT = 41,                   /* default keyword */
-    TOK_WHILE = 42,                     /* while keyword */
-    TOK_DO = 43,                        /* do keyword */
-    TOK_FOR = 44,                       /* for keyword */
-    TOK_BREAK = 45,                     /* break keyword */
-    TOK_CONTINUE = 46,                  /* continue keyword */
-    TOK_IN = 47,                        /* in keyword */
-    TOK_VAR = 48,                       /* var keyword */
-    TOK_WITH = 49,                      /* with keyword */
-    TOK_RETURN = 50,                    /* return keyword */
-    TOK_NEW = 51,                       /* new keyword */
-    TOK_DELETE = 52,                    /* delete keyword */
-    TOK_DEFSHARP = 53,                  /* #n= for object/array initializers */
-    TOK_USESHARP = 54,                  /* #n# for object/array initializers */
-    TOK_TRY = 55,                       /* try keyword */
-    TOK_CATCH = 56,                     /* catch keyword */
-    TOK_FINALLY = 57,                   /* finally keyword */
-    TOK_THROW = 58,                     /* throw keyword */
-    TOK_INSTANCEOF = 59,                /* instanceof keyword */
-    TOK_DEBUGGER = 60,                  /* debugger keyword */
-    TOK_XMLSTAGO = 61,                  /* XML start tag open (<) */
-    TOK_XMLETAGO = 62,                  /* XML end tag open (</) */
-    TOK_XMLPTAGC = 63,                  /* XML point tag close (/>) */
-    TOK_XMLTAGC = 64,                   /* XML start or end tag close (>) */
-    TOK_XMLNAME = 65,                   /* XML start-tag non-final fragment */
-    TOK_XMLATTR = 66,                   /* XML quoted attribute value */
-    TOK_XMLSPACE = 67,                  /* XML whitespace */
-    TOK_XMLTEXT = 68,                   /* XML text */
-    TOK_XMLCOMMENT = 69,                /* XML comment */
-    TOK_XMLCDATA = 70,                  /* XML CDATA section */
-    TOK_XMLPI = 71,                     /* XML processing instruction */
-    TOK_AT = 72,                        /* XML attribute op (@) */
-    TOK_DBLCOLON = 73,                  /* namespace qualified name op (::) */
-    TOK_ANYNAME = 74,                   /* XML AnyName singleton (*) */
-    TOK_DBLDOT = 75,                    /* XML descendant op (..) */
-    TOK_FILTER = 76,                    /* XML filtering predicate op (.()) */
-    TOK_XMLELEM = 77,                   /* XML element node type (no token) */
-    TOK_XMLLIST = 78,                   /* XML list node type (no token) */
-    TOK_YIELD = 79,                     /* yield from generator function */
-    TOK_ARRAYCOMP = 80,                 /* array comprehension initialiser */
-    TOK_ARRAYPUSH = 81,                 /* array push within comprehension */
-    TOK_LEXICALSCOPE = 82,              /* block scope AST node label */
-    TOK_LET = 83,                       /* let keyword */
-    TOK_BODY = 84,                      /* synthetic body of function with
+    TOK_IF = 35,                        /* if keyword */
+    TOK_ELSE = 36,                      /* else keyword */
+    TOK_SWITCH = 37,                    /* switch keyword */
+    TOK_CASE = 38,                      /* case keyword */
+    TOK_DEFAULT = 39,                   /* default keyword */
+    TOK_WHILE = 40,                     /* while keyword */
+    TOK_DO = 41,                        /* do keyword */
+    TOK_FOR = 42,                       /* for keyword */
+    TOK_BREAK = 43,                     /* break keyword */
+    TOK_CONTINUE = 44,                  /* continue keyword */
+    TOK_IN = 45,                        /* in keyword */
+    TOK_VAR = 46,                       /* var keyword */
+    TOK_WITH = 47,                      /* with keyword */
+    TOK_RETURN = 48,                    /* return keyword */
+    TOK_NEW = 49,                       /* new keyword */
+    TOK_DELETE = 50,                    /* delete keyword */
+    TOK_DEFSHARP = 51,                  /* #n= for object/array initializers */
+    TOK_USESHARP = 52,                  /* #n# for object/array initializers */
+    TOK_TRY = 53,                       /* try keyword */
+    TOK_CATCH = 54,                     /* catch keyword */
+    TOK_FINALLY = 55,                   /* finally keyword */
+    TOK_THROW = 56,                     /* throw keyword */
+    TOK_INSTANCEOF = 57,                /* instanceof keyword */
+    TOK_DEBUGGER = 58,                  /* debugger keyword */
+    TOK_XMLSTAGO = 59,                  /* XML start tag open (<) */
+    TOK_XMLETAGO = 60,                  /* XML end tag open (</) */
+    TOK_XMLPTAGC = 61,                  /* XML point tag close (/>) */
+    TOK_XMLTAGC = 62,                   /* XML start or end tag close (>) */
+    TOK_XMLNAME = 63,                   /* XML start-tag non-final fragment */
+    TOK_XMLATTR = 64,                   /* XML quoted attribute value */
+    TOK_XMLSPACE = 65,                  /* XML whitespace */
+    TOK_XMLTEXT = 66,                   /* XML text */
+    TOK_XMLCOMMENT = 67,                /* XML comment */
+    TOK_XMLCDATA = 68,                  /* XML CDATA section */
+    TOK_XMLPI = 69,                     /* XML processing instruction */
+    TOK_AT = 70,                        /* XML attribute op (@) */
+    TOK_DBLCOLON = 71,                  /* namespace qualified name op (::) */
+    TOK_ANYNAME = 72,                   /* XML AnyName singleton (*) */
+    TOK_DBLDOT = 73,                    /* XML descendant op (..) */
+    TOK_FILTER = 74,                    /* XML filtering predicate op (.()) */
+    TOK_XMLELEM = 75,                   /* XML element node type (no token) */
+    TOK_XMLLIST = 76,                   /* XML list node type (no token) */
+    TOK_YIELD = 77,                     /* yield from generator function */
+    TOK_ARRAYCOMP = 78,                 /* array comprehension initialiser */
+    TOK_ARRAYPUSH = 79,                 /* array push within comprehension */
+    TOK_LEXICALSCOPE = 80,              /* block scope AST node label */
+    TOK_LET = 81,                       /* let keyword */
+    TOK_BODY = 82,                      /* synthetic body of function with
                                            destructuring formal parameters */
     TOK_RESERVED,                       /* reserved keywords */
     TOK_LIMIT                           /* domain size */
 } JSTokenType;
 
diff --git a/js/src/jsshell.msg b/js/src/jsshell.msg
--- a/js/src/jsshell.msg
+++ b/js/src/jsshell.msg
@@ -46,7 +46,6 @@ MSG_DEF(JSSMSG_TRAP_USAGE,              
 MSG_DEF(JSSMSG_TRAP_USAGE,               2, 0, JSEXN_NONE, "usage: trap [fun] [pc] expr") 
 MSG_DEF(JSSMSG_LINE2PC_USAGE,            3, 0, JSEXN_NONE, "usage: line2pc [fun] line") 
 MSG_DEF(JSSMSG_FILE_SCRIPTS_ONLY,        4, 0, JSEXN_NONE, "only works on JS scripts read from files") 
 MSG_DEF(JSSMSG_UNEXPECTED_EOF,           5, 1, JSEXN_NONE, "unexpected EOF in {0}") 
 MSG_DEF(JSSMSG_DOEXP_USAGE,              6, 0, JSEXN_NONE, "usage: doexp obj id") 
-MSG_DEF(JSSMSG_SCRIPTS_ONLY,             7, 0, JSEXN_NONE, "only works on JS scripts") 
-MSG_DEF(JSSMSG_CANT_DISASSEMBLE,         8, 0, JSEXN_NONE, "Could not disassemble script")
+MSG_DEF(JSSMSG_SCRIPTS_ONLY,             7, 0, JSEXN_NONE, "only works on scripts") 
diff --git a/js/src/jsstr.cpp b/js/src/jsstr.cpp
--- a/js/src/jsstr.cpp
+++ b/js/src/jsstr.cpp
@@ -237,10 +237,45 @@ js_MakeStringImmutable(JSContext *cx, JS
     }
     JSFLATSTR_CLEAR_MUTABLE(str);
     return JS_TRUE;
 }
 
+static JSString *
+ArgToRootedString(JSContext *cx, uintN argc, jsval *vp, uintN arg)
+{
+    JSObject *obj;
+    JSString *str;
+
+    if (arg >= argc)
+        return ATOM_TO_STRING(cx->runtime->atomState.typeAtoms[JSTYPE_VOID]);
+    vp += 2 + arg;
+
+    if (JSVAL_IS_OBJECT(*vp)) {
+        obj = JSVAL_TO_OBJECT(*vp);
+        if (!obj)
+            return ATOM_TO_STRING(cx->runtime->atomState.nullAtom);
+        if (!OBJ_DEFAULT_VALUE(cx, obj, JSTYPE_STRING, vp))
+            return NULL;
+    }
+    if (JSVAL_IS_STRING(*vp))
+        return JSVAL_TO_STRING(*vp);
+    if (JSVAL_IS_INT(*vp)) {
+        str = js_NumberToString(cx, JSVAL_TO_INT(*vp));
+    } else if (JSVAL_IS_DOUBLE(*vp)) {
+        str = js_NumberToString(cx, *JSVAL_TO_DOUBLE(*vp));
+    } else if (JSVAL_IS_BOOLEAN(*vp)) {
+        return ATOM_TO_STRING(cx->runtime->atomState.booleanAtoms[
+                                  JSVAL_TO_BOOLEAN(*vp)? 1 : 0]);
+    } else {
+        JS_ASSERT(JSVAL_IS_VOID(*vp));
+        return ATOM_TO_STRING(cx->runtime->atomState.typeAtoms[JSTYPE_VOID]);
+    }
+    if (str)
+        *vp = STRING_TO_JSVAL(str);
+    return str;
+}
+
 /*
  * Forward declarations for URI encode/decode and helper routines
  */
 static JSBool
 str_decodeURI(JSContext *cx, uintN argc, jsval *vp);
@@ -325,14 +360,13 @@ js_str_escape(JSContext *cx, JSObject *o
                                  JSMSG_BAD_STRING_MASK, numBuf);
             return JS_FALSE;
         }
     }
 
-    str = js_ValueToString(cx, argv[0]);
-    if (!str)
-        return JS_FALSE;
-    argv[0] = STRING_TO_JSVAL(str);
+    str = ArgToRootedString(cx, argc, argv - 2, 0);
+    if (!str)
+        return JS_FALSE;
 
     JSSTRING_CHARS_AND_LENGTH(str, chars, length);
     newlength = length;
 
     /* Take a first pass and see how big the result string will need to be. */
@@ -415,14 +449,13 @@ str_unescape(JSContext *cx, uintN argc, 
     size_t i, ni, length;
     const jschar *chars;
     jschar *newchars;
     jschar ch;
 
-    str = js_ValueToString(cx, vp[2]);
-    if (!str)
-        return JS_FALSE;
-    vp[2] = STRING_TO_JSVAL(str);
+    str = ArgToRootedString(cx, argc, vp, 0);
+    if (!str)
+        return JS_FALSE;
 
     JSSTRING_CHARS_AND_LENGTH(str, chars, length);
 
     /* Don't bother allocating less space for the new string. */
     newchars = (jschar *) JS_malloc(cx, (length + 1) * sizeof(jschar));
@@ -465,11 +498,11 @@ static JSBool
 static JSBool
 str_uneval(JSContext *cx, uintN argc, jsval *vp)
 {
     JSString *str;
 
-    str = js_ValueToSource(cx, vp[2]);
+    str = js_ValueToSource(cx, argc != 0 ? vp[2] : JSVAL_VOID);
     if (!str)
         return JS_FALSE;
     *vp = STRING_TO_JSVAL(str);
     return JS_TRUE;
 }
@@ -484,19 +517,19 @@ const char js_encodeURI_str[] = "encodeU
 const char js_encodeURI_str[] = "encodeURI";
 const char js_decodeURIComponent_str[] = "decodeURIComponent";
 const char js_encodeURIComponent_str[] = "encodeURIComponent";
 
 static JSFunctionSpec string_functions[] = {
-    JS_FN(js_escape_str,             str_escape,                1,1,0),
-    JS_FN(js_unescape_str,           str_unescape,              1,1,0),
+    JS_FN(js_escape_str,             str_escape,                1,0),
+    JS_FN(js_unescape_str,           str_unescape,              1,0),
 #if JS_HAS_UNEVAL
-    JS_FN(js_uneval_str,             str_uneval,                1,1,0),
-#endif
-    JS_FN(js_decodeURI_str,          str_decodeURI,             1,1,0),
-    JS_FN(js_encodeURI_str,          str_encodeURI,             1,1,0),
-    JS_FN(js_decodeURIComponent_str, str_decodeURI_Component,   1,1,0),
-    JS_FN(js_encodeURIComponent_str, str_encodeURI_Component,   1,1,0),
+    JS_FN(js_uneval_str,             str_uneval,                1,0),
+#endif
+    JS_FN(js_decodeURI_str,          str_decodeURI,             1,0),
+    JS_FN(js_encodeURI_str,          str_encodeURI,             1,0),
+    JS_FN(js_decodeURIComponent_str, str_decodeURI_Component,   1,0),
+    JS_FN(js_encodeURIComponent_str, str_encodeURI_Component,   1,0),
 
     JS_FS_END
 };
 
 jschar      js_empty_ucstr[]  = {0};
@@ -848,20 +881,19 @@ str_localeCompare(JSContext *cx, uintN a
 }
 
 static JSBool
 str_charAt(JSContext *cx, uintN argc, jsval *vp)
 {
-    jsval t, v;
+    jsval t;
     JSString *str;
     jsint i;
     jsdouble d;
 
     t = vp[1];
-    v = vp[2];
-    if (JSVAL_IS_STRING(t) && JSVAL_IS_INT(v)) {
+    if (JSVAL_IS_STRING(t) && argc != 0 && JSVAL_IS_INT(vp[2])) {
         str = JSVAL_TO_STRING(t);
-        i = JSVAL_TO_INT(v);
+        i = JSVAL_TO_INT(vp[2]);
         if ((size_t)i >= JSSTRING_LENGTH(str))
             goto out_of_range;
     } else {
         str = NormalizeThis(cx, vp);
         if (!str)
@@ -893,20 +925,19 @@ out_of_range:
 }
 
 static JSBool
 str_charCodeAt(JSContext *cx, uintN argc, jsval *vp)
 {
-    jsval t, v;
+    jsval t;
     JSString *str;
     jsint i;
     jsdouble d;
 
     t = vp[1];
-    v = vp[2];
-    if (JSVAL_IS_STRING(t) && JSVAL_IS_INT(v)) {
+    if (JSVAL_IS_STRING(t) && argc != 0 && JSVAL_IS_INT(vp[2])) {
         str = JSVAL_TO_STRING(t);
-        i = JSVAL_TO_INT(v);
+        i = JSVAL_TO_INT(vp[2]);
         if ((size_t)i >= JSSTRING_LENGTH(str))
             goto out_of_range;
     } else {
         str = NormalizeThis(cx, vp);
         if (!str)
@@ -967,30 +998,28 @@ js_BoyerMooreHorspool(const jschar *text
 }
 
 static JSBool
 str_indexOf(JSContext *cx, uintN argc, jsval *vp)
 {
-    jsval t, v;
+    jsval t;
     JSString *str, *str2;
     const jschar *text, *pat;
     jsint i, j, index, textlen, patlen;
     jsdouble d;
 
     t = vp[1];
-    v = vp[2];
-    if (JSVAL_IS_STRING(t) && JSVAL_IS_STRING(v)) {
+    if (JSVAL_IS_STRING(t) && argc != 0 && JSVAL_IS_STRING(vp[2])) {
         str = JSVAL_TO_STRING(t);
-        str2 = JSVAL_TO_STRING(v);
+        str2 = JSVAL_TO_STRING(vp[2]);
     } else {
         str = NormalizeThis(cx, vp);
         if (!str)
             return JS_FALSE;
 
-        str2 = js_ValueToString(cx, v);
-        if (!str2)
-            return JS_FALSE;
-        vp[2] = STRING_TO_JSVAL(str2);
+        str2 = ArgToRootedString(cx, argc, vp, 0);
+        if (!str)
+            return JS_FALSE;
     }
 
     text = JSSTRING_CHARS(str);
     textlen = (jsint) JSSTRING_LENGTH(str);
     pat = JSSTRING_CHARS(str2);
@@ -1051,14 +1080,13 @@ str_lastIndexOf(JSContext *cx, uintN arg
 
     NORMALIZE_THIS(cx, vp, str);
     text = JSSTRING_CHARS(str);
     textlen = (jsint) JSSTRING_LENGTH(str);
 
-    str2 = js_ValueToString(cx, vp[2]);
-    if (!str2)
-        return JS_FALSE;
-    vp[2] = STRING_TO_JSVAL(str2);
+    str2 = ArgToRootedString(cx, argc, vp, 0);
+    if (!str)
+        return JS_FALSE;
     pat = JSSTRING_CHARS(str2);
     patlen = (jsint) JSSTRING_LENGTH(str2);
 
     if (argc > 1) {
         d = js_ValueToNumber(cx, &vp[3]);
@@ -1137,19 +1165,18 @@ match_or_replace(JSContext *cx,
     jsint count;
 
     NORMALIZE_THIS(cx, vp, str);
     data->str = str;
 
-    if (JSVAL_IS_REGEXP(cx, vp[2])) {
+    if (argc != 0 && JSVAL_IS_REGEXP(cx, vp[2])) {
         reobj = JSVAL_TO_OBJECT(vp[2]);
         re = (JSRegExp *) JS_GetPrivate(cx, reobj);
     } else {
-        src = js_ValueToString(cx, vp[2]);
+        src = ArgToRootedString(cx, argc, vp, 0);
         if (!src)
             return JS_FALSE;
         if (data->optarg < argc) {
-            vp[2] = STRING_TO_JSVAL(src);
             opt = js_ValueToString(cx, vp[2 + data->optarg]);
             if (!opt)
                 return JS_FALSE;
         } else {
             opt = NULL;
@@ -1586,18 +1613,18 @@ str_replace(JSContext *cx, uintN argc, j
     ReplaceData rdata;
     JSBool ok;
     jschar *chars;
     size_t leftlen, rightlen, length;
 
-    if (JS_TypeOfValue(cx, vp[3]) == JSTYPE_FUNCTION) {
+    if (argc >= 2 && JS_TypeOfValue(cx, vp[3]) == JSTYPE_FUNCTION) {
         lambda = JSVAL_TO_OBJECT(vp[3]);
         repstr = NULL;
     } else {
-        if (!JS_ConvertValue(cx, vp[3], JSTYPE_STRING, &vp[3]))
-            return JS_FALSE;
-        repstr = JSVAL_TO_STRING(vp[3]);
         lambda = NULL;
+        repstr = ArgToRootedString(cx, argc, vp, 1);
+        if (!repstr)
+            return JS_FALSE;
     }
 
     /*
      * For ECMA Edition 3, the first argument is to be converted to a string
      * to match in a "flat" sense (without regular expression metachars having
@@ -2107,18 +2134,18 @@ tagify(JSContext *cx, const char *begin,
     *vp = STRING_TO_JSVAL(str);
     return JS_TRUE;
 }
 
 static JSBool
-tagify_value(JSContext *cx, const char *begin, const char *end, jsval *vp)
+tagify_value(JSContext *cx, uintN argc, jsval *vp,
+             const char *begin, const char *end)
 {
     JSString *param;
 
-    param = js_ValueToString(cx, vp[2]);
+    param = ArgToRootedString(cx, argc, vp, 0);
     if (!param)
         return JS_FALSE;
-    vp[2] = STRING_TO_JSVAL(param);
     return tagify(cx, begin, param, end, vp);
 }
 
 static JSBool
 str_bold(JSContext *cx, uintN argc, jsval *vp)
@@ -2139,29 +2166,29 @@ str_fixed(JSContext *cx, uintN argc, jsv
 }
 
 static JSBool
 str_fontsize(JSContext *cx, uintN argc, jsval *vp)
 {
-    return tagify_value(cx, "font size", "font", vp);
+    return tagify_value(cx, argc, vp, "font size", "font");
 }
 
 static JSBool
 str_fontcolor(JSContext *cx, uintN argc, jsval *vp)
 {
-    return tagify_value(cx, "font color", "font", vp);
+    return tagify_value(cx, argc, vp, "font color", "font");
 }
 
 static JSBool
 str_link(JSContext *cx, uintN argc, jsval *vp)
 {
-    return tagify_value(cx, "a href", "a", vp);
+    return tagify_value(cx, argc, vp, "a href", "a");
 }
 
 static JSBool
 str_anchor(JSContext *cx, uintN argc, jsval *vp)
 {
-    return tagify_value(cx, "a name", "a", vp);
+    return tagify_value(cx, argc, vp, "a name", "a");
 }
 
 static JSBool
 str_strike(JSContext *cx, uintN argc, jsval *vp)
 {
@@ -2203,56 +2230,56 @@ str_sub(JSContext *cx, uintN argc, jsval
 #define PRIMITIVE         JSFUN_THISP_PRIMITIVE
 #define GENERIC_PRIMITIVE (GENERIC | PRIMITIVE)
 
 static JSFunctionSpec string_methods[] = {
 #if JS_HAS_TOSOURCE
-    JS_FN("quote",             str_quote,             0,0,GENERIC_PRIMITIVE),
-    JS_FN(js_toSource_str,     str_toSource,          0,0,JSFUN_THISP_STRING),
+    JS_FN("quote",             str_quote,             0,GENERIC_PRIMITIVE),
+    JS_FN(js_toSource_str,     str_toSource,          0,JSFUN_THISP_STRING),
 #endif
 
     /* Java-like methods. */
-    JS_FN(js_toString_str,     str_toString,          0,0,JSFUN_THISP_STRING),
-    JS_FN(js_valueOf_str,      str_toString,          0,0,JSFUN_THISP_STRING),
-    JS_FN("substring",         str_substring,         0,2,GENERIC_PRIMITIVE),
-    JS_FN("toLowerCase",       str_toLowerCase,       0,0,GENERIC_PRIMITIVE),
-    JS_FN("toUpperCase",       str_toUpperCase,       0,0,GENERIC_PRIMITIVE),
-    JS_FN("charAt",            str_charAt,            1,1,GENERIC_PRIMITIVE),
-    JS_FN("charCodeAt",        str_charCodeAt,        1,1,GENERIC_PRIMITIVE),
-    JS_FN("indexOf",           str_indexOf,           1,1,GENERIC_PRIMITIVE),
-    JS_FN("lastIndexOf",       str_lastIndexOf,       1,1,GENERIC_PRIMITIVE),
-    JS_FN("toLocaleLowerCase", str_toLocaleLowerCase, 0,0,GENERIC_PRIMITIVE),
-    JS_FN("toLocaleUpperCase", str_toLocaleUpperCase, 0,0,GENERIC_PRIMITIVE),
-    JS_FN("localeCompare",     str_localeCompare,     1,1,GENERIC_PRIMITIVE),
+    JS_FN(js_toString_str,     str_toString,          0,JSFUN_THISP_STRING),
+    JS_FN(js_valueOf_str,      str_toString,          0,JSFUN_THISP_STRING),
+    JS_FN("substring",         str_substring,         2,GENERIC_PRIMITIVE),
+    JS_FN("toLowerCase",       str_toLowerCase,       0,GENERIC_PRIMITIVE),
+    JS_FN("toUpperCase",       str_toUpperCase,       0,GENERIC_PRIMITIVE),
+    JS_FN("charAt",            str_charAt,            1,GENERIC_PRIMITIVE),
+    JS_FN("charCodeAt",        str_charCodeAt,        1,GENERIC_PRIMITIVE),
+    JS_FN("indexOf",           str_indexOf,           1,GENERIC_PRIMITIVE),
+    JS_FN("lastIndexOf",       str_lastIndexOf,       1,GENERIC_PRIMITIVE),
+    JS_FN("toLocaleLowerCase", str_toLocaleLowerCase, 0,GENERIC_PRIMITIVE),
+    JS_FN("toLocaleUpperCase", str_toLocaleUpperCase, 0,GENERIC_PRIMITIVE),
+    JS_FN("localeCompare",     str_localeCompare,     1,GENERIC_PRIMITIVE),
 
     /* Perl-ish methods (search is actually Python-esque). */
-    JS_FN("match",             str_match,             1,1,GENERIC_PRIMITIVE),
-    JS_FN("search",            str_search,            1,1,GENERIC_PRIMITIVE),
-    JS_FN("replace",           str_replace,           2,2,GENERIC_PRIMITIVE),
-    JS_FN("split",             str_split,             0,2,GENERIC_PRIMITIVE),
+    JS_FN("match",             str_match,             1,GENERIC_PRIMITIVE),
+    JS_FN("search",            str_search,            1,GENERIC_PRIMITIVE),
+    JS_FN("replace",           str_replace,           2,GENERIC_PRIMITIVE),
+    JS_FN("split",             str_split,             2,GENERIC_PRIMITIVE),
 #if JS_HAS_PERL_SUBSTR
-    JS_FN("substr",            str_substr,            0,2,GENERIC_PRIMITIVE),
+    JS_FN("substr",            str_substr,            2,GENERIC_PRIMITIVE),
 #endif
 
     /* Python-esque sequence methods. */
-    JS_FN("concat",            str_concat,            0,1,GENERIC_PRIMITIVE),
-    JS_FN("slice",             str_slice,             1,2,GENERIC_PRIMITIVE),
+    JS_FN("concat",            str_concat,            1,GENERIC_PRIMITIVE),
+    JS_FN("slice",             str_slice,             2,GENERIC_PRIMITIVE),
 
     /* HTML string methods. */
 #if JS_HAS_STR_HTML_HELPERS
-    JS_FN("bold",              str_bold,              0,0,PRIMITIVE),
-    JS_FN("italics",           str_italics,           0,0,PRIMITIVE),
-    JS_FN("fixed",             str_fixed,             0,0,PRIMITIVE),
-    JS_FN("fontsize",          str_fontsize,          1,1,PRIMITIVE),
-    JS_FN("fontcolor",         str_fontcolor,         1,1,PRIMITIVE),
-    JS_FN("link",              str_link,              1,1,PRIMITIVE),
-    JS_FN("anchor",            str_anchor,            1,1,PRIMITIVE),
-    JS_FN("strike",            str_strike,            0,0,PRIMITIVE),
-    JS_FN("small",             str_small,             0,0,PRIMITIVE),
-    JS_FN("big",               str_big,               0,0,PRIMITIVE),
-    JS_FN("blink",             str_blink,             0,0,PRIMITIVE),
-    JS_FN("sup",               str_sup,               0,0,PRIMITIVE),
-    JS_FN("sub",               str_sub,               0,0,PRIMITIVE),
+    JS_FN("bold",              str_bold,              0,PRIMITIVE),
+    JS_FN("italics",           str_italics,           0,PRIMITIVE),
+    JS_FN("fixed",             str_fixed,             0,PRIMITIVE),
+    JS_FN("fontsize",          str_fontsize,          1,PRIMITIVE),
+    JS_FN("fontcolor",         str_fontcolor,         1,PRIMITIVE),
+    JS_FN("link",              str_link,              1,PRIMITIVE),
+    JS_FN("anchor",            str_anchor,            1,PRIMITIVE),
+    JS_FN("strike",            str_strike,            0,PRIMITIVE),
+    JS_FN("small",             str_small,             0,PRIMITIVE),
+    JS_FN("big",               str_big,               0,PRIMITIVE),
+    JS_FN("blink",             str_blink,             0,PRIMITIVE),
+    JS_FN("sup",               str_sup,               0,PRIMITIVE),
+    JS_FN("sub",               str_sub,               0,PRIMITIVE),
 #endif
 
     JS_FS_END
 };
 
@@ -2308,11 +2335,11 @@ str_fromCharCode(JSContext *cx, uintN ar
     *vp = STRING_TO_JSVAL(str);
     return JS_TRUE;
 }
 
 static JSFunctionSpec string_static_methods[] = {
-    JS_FN("fromCharCode",    str_fromCharCode,       0,1,0),
+    JS_FN("fromCharCode",    str_fromCharCode,       1,0),
     JS_FS_END
 };
 
 JS_STATIC_DLL_CALLBACK(JSHashNumber)
 js_hash_string_pointer(const void *key)
@@ -4779,51 +4806,47 @@ static JSBool
 static JSBool
 str_decodeURI(JSContext *cx, uintN argc, jsval *vp)
 {
     JSString *str;
 
-    str = js_ValueToString(cx, vp[2]);
-    if (!str)
-        return JS_FALSE;
-    vp[2] = STRING_TO_JSVAL(str);
+    str = ArgToRootedString(cx, argc, vp, 0);
+    if (!str)
+        return JS_FALSE;
     return Decode(cx, str, js_uriReservedPlusPound_ucstr, vp);
 }
 
 static JSBool
 str_decodeURI_Component(JSContext *cx, uintN argc, jsval *vp)
 {
     JSString *str;
 
-    str = js_ValueToString(cx, vp[2]);
-    if (!str)
-        return JS_FALSE;
-    vp[2] = STRING_TO_JSVAL(str);
+    str = ArgToRootedString(cx, argc, vp, 0);
+    if (!str)
+        return JS_FALSE;
     return Decode(cx, str, js_empty_ucstr, vp);
 }
 
 static JSBool
 str_encodeURI(JSContext *cx, uintN argc, jsval *vp)
 {
     JSString *str;
 
-    str = js_ValueToString(cx, vp[2]);
-    if (!str)
-        return JS_FALSE;
-    vp[2] = STRING_TO_JSVAL(str);
+    str = ArgToRootedString(cx, argc, vp, 0);
+    if (!str)
+        return JS_FALSE;
     return Encode(cx, str, js_uriReservedPlusPound_ucstr, js_uriUnescaped_ucstr,
                   vp);
 }
 
 static JSBool
 str_encodeURI_Component(JSContext *cx, uintN argc, jsval *vp)
 {
     JSString *str;
 
-    str = js_ValueToString(cx, vp[2]);
-    if (!str)
-        return JS_FALSE;
-    vp[2] = STRING_TO_JSVAL(str);
+    str = ArgToRootedString(cx, argc, vp, 0);
+    if (!str)
+        return JS_FALSE;
     return Encode(cx, str, js_uriUnescaped_ucstr, NULL, vp);
 }
 
 /*
  * Convert one UCS-4 char and write it into a UTF-8 buffer, which must be at
diff --git a/js/src/jsxdrapi.h b/js/src/jsxdrapi.h
--- a/js/src/jsxdrapi.h
+++ b/js/src/jsxdrapi.h
@@ -200,11 +200,11 @@ JS_XDRFindClassById(JSXDRState *xdr, uin
  * This version number should be XDR'ed once near the front of any file or
  * larger storage unit containing XDR'ed bytecode and other data, and checked
  * before deserialization of bytecode.  If the saved version does not match
  * the current version, abort deserialization and invalidate the file.
  */
-#define JSXDR_BYTECODE_VERSION      (0xb973c0de - 28)
+#define JSXDR_BYTECODE_VERSION      (0xb973c0de - 29)
 
 /*
  * Library-private functions.
  */
 extern JSBool
diff --git a/js/src/jsxml.cpp b/js/src/jsxml.cpp
--- a/js/src/jsxml.cpp
+++ b/js/src/jsxml.cpp
@@ -267,11 +267,11 @@ namespace_toString(JSContext *cx, uintN 
     *vp = STRING_TO_JSVAL(ns->uri);
     return JS_TRUE;
 }
 
 static JSFunctionSpec namespace_methods[] = {
-    JS_FN(js_toString_str,  namespace_toString,        0,0,0),
+    JS_FN(js_toString_str,  namespace_toString,        0,0),
     JS_FS_END
 };
 
 JSXMLNamespace *
 js_NewXMLNamespace(JSContext *cx, JSString *prefix, JSString *uri,
@@ -548,11 +548,11 @@ qname_toString(JSContext *cx, uintN argc
     *vp = STRING_TO_JSVAL(str);
     return JS_TRUE;
 }
 
 static JSFunctionSpec qname_methods[] = {
-    JS_FN(js_toString_str,  qname_toString,    0,0,0),
+    JS_FN(js_toString_str,  qname_toString,    0,0),
     JS_FS_END
 };
 
 JSXMLQName *
 js_NewXMLQName(JSContext *cx, JSString *uri, JSString *prefix,
@@ -725,33 +725,41 @@ js_IsXMLName(JSContext *cx, jsval v)
     }
 
     return IsXMLName(JSSTRING_CHARS(name), JSSTRING_LENGTH(name));
 }
 
-static JSBool
-NamespaceHelper(JSContext *cx, JSObject *obj, uintN argc, jsval *argv,
+/*
+ * When argc is -1, it indicates argv is empty but the code should behave as
+ * if argc is 1 and argv[0] is JSVAL_VOID.
+ */
+static JSBool
+NamespaceHelper(JSContext *cx, JSObject *obj, intN argc, jsval *argv,
                 jsval *rval)
 {
     jsval urival, prefixval;
     JSObject *uriobj;
     JSBool isNamespace, isQName;
     JSClass *clasp;
     JSString *empty, *prefix;
     JSXMLNamespace *ns, *ns2;
     JSXMLQName *qn;
 
-    urival = argv[argc > 1];
     isNamespace = isQName = JS_FALSE;
-    if (!JSVAL_IS_PRIMITIVE(urival)) {
-        uriobj = JSVAL_TO_OBJECT(urival);
-        clasp = OBJ_GET_CLASS(cx, uriobj);
-        isNamespace = (clasp == &js_NamespaceClass.base);
-        isQName = (clasp == &js_QNameClass.base);
-    }
 #ifdef __GNUC__         /* suppress bogus gcc warnings */
-    else uriobj = NULL;
-#endif
+    uriobj = NULL;
+#endif
+    if (argc <= 0) {
+        urival = JSVAL_VOID;
+    } else {
+        urival = argv[argc > 1];
+        if (!JSVAL_IS_PRIMITIVE(urival)) {
+            uriobj = JSVAL_TO_OBJECT(urival);
+            clasp = OBJ_GET_CLASS(cx, uriobj);
+            isNamespace = (clasp == &js_NamespaceClass.base);
+            isQName = (clasp == &js_QNameClass.base);
+        }
+    }
 
     if (!obj) {
         /* Namespace called as function. */
         if (argc == 1 && isNamespace) {
             /* Namespace called with one Namespace argument is identity. */
@@ -779,11 +787,11 @@ NamespaceHelper(JSContext *cx, JSObject 
         return JS_FALSE;
     if (!JS_SetPrivate(cx, obj, ns))
         return JS_FALSE;
     ns->object = obj;
 
-    if (argc == 1) {
+    if (argc == 1 || argc == -1) {
         if (isNamespace) {
             ns2 = (JSXMLNamespace *) JS_GetPrivate(cx, uriobj);
             ns->uri = ns2->uri;
             ns->prefix = ns2->prefix;
         } else if (isQName &&
@@ -843,12 +851,16 @@ Namespace(JSContext *cx, JSObject *obj, 
     return NamespaceHelper(cx,
                            (cx->fp->flags & JSFRAME_CONSTRUCTING) ? obj : NULL,
                            argc, argv, rval);
 }
 
-static JSBool
-QNameHelper(JSContext *cx, JSObject *obj, JSClass *clasp, uintN argc,
+/*
+ * When argc is -1, it indicates argv is empty but the code should behave as
+ * if argc is 1 and argv[0] is JSVAL_VOID.
+ */
+static JSBool
+QNameHelper(JSContext *cx, JSObject *obj, JSClass *clasp, intN argc,
             jsval *argv, jsval *rval)
 {
     jsval nameval, nsval;
     JSBool isQName, isNamespace;
     JSXMLQName *qn;
@@ -856,14 +868,19 @@ QNameHelper(JSContext *cx, JSObject *obj
     JSObject *nsobj;
     JSXMLNamespace *ns;
 
     JS_ASSERT(clasp == &js_QNameClass.base ||
               clasp == &js_AttributeNameClass);
-    nameval = argv[argc > 1];
-    isQName =
-        !JSVAL_IS_PRIMITIVE(nameval) &&
-        OBJ_GET_CLASS(cx, JSVAL_TO_OBJECT(nameval)) == &js_QNameClass.base;
+    if (argc <= 0) {
+        nameval = JSVAL_VOID;
+        isQName = JS_FALSE;
+    } else {
+        nameval = argv[argc > 1];
+        isQName =
+            !JSVAL_IS_PRIMITIVE(nameval) &&
+            OBJ_GET_CLASS(cx, JSVAL_TO_OBJECT(nameval)) == &js_QNameClass.base;
+    }
 
     if (!obj) {
         /* QName called as function. */
         if (argc == 1 && isQName) {
             /* QName called with one QName argument is identity. */
@@ -897,27 +914,29 @@ QNameHelper(JSContext *cx, JSObject *obj
         nameval = STRING_TO_JSVAL(qn->localName);
     }
 
     if (argc == 0) {
         name = cx->runtime->emptyString;
+    } else if (argc < 0) {
+        name = ATOM_TO_STRING(cx->runtime->atomState.typeAtoms[JSTYPE_VOID]);
     } else {
         name = js_ValueToString(cx, nameval);
         if (!name)
             return JS_FALSE;
-
-        /* Use argv[1] as a local root for name, even if it was not passed. */
-        argv[1] = STRING_TO_JSVAL(name);
-    }
-
-    nsval = argv[0];
-    if (argc == 1 || JSVAL_IS_VOID(nsval)) {
-        if (IS_STAR(name)) {
-            nsval = JSVAL_NULL;
-        } else {
-            if (!js_GetDefaultXMLNamespace(cx, &nsval))
-                return JS_FALSE;
-        }
+        argv[argc > 1] = STRING_TO_JSVAL(name);
+    }
+
+    if (argc > 1 && !JSVAL_IS_VOID(argv[0])) {
+        nsval = argv[0];
+    } else if (IS_STAR(name)) {
+        nsval = JSVAL_NULL;
+    } else {
+        if (!js_GetDefaultXMLNamespace(cx, &nsval))
+            return JS_FALSE;
+        JS_ASSERT(!JSVAL_IS_PRIMITIVE(nsval));
+        JS_ASSERT(OBJ_GET_CLASS(cx, JSVAL_TO_OBJECT(nsval)) ==
+                  &js_NamespaceClass.base);
     }
 
     if (JSVAL_IS_NULL(nsval)) {
         /* NULL prefix represents *undefined* in ECMA-357 13.3.2 5(a). */
         uri = prefix = NULL;
@@ -944,13 +963,15 @@ QNameHelper(JSContext *cx, JSObject *obj
             ns = (JSXMLNamespace *) JS_GetPrivate(cx, nsobj);
             uri = ns->uri;
             prefix = ns->prefix;
         } else if (isQName &&
                    (qn = (JSXMLQName *) JS_GetPrivate(cx, nsobj))->uri) {
+            JS_ASSERT(argc > 1);
             uri = qn->uri;
             prefix = qn->prefix;
         } else {
+            JS_ASSERT(argc > 1);
             uri = js_ValueToString(cx, nsval);
             if (!uri)
                 return JS_FALSE;
             argv[0] = STRING_TO_JSVAL(uri);     /* local root */
 
@@ -961,12 +982,11 @@ QNameHelper(JSContext *cx, JSObject *obj
 
 out:
     qn = js_NewXMLQName(cx, uri, prefix, name);
     if (!qn)
         return JS_FALSE;
-    if (!JS_SetPrivate(cx, obj, qn))
-        return JS_FALSE;
+    obj->fslots[JSSLOT_PRIVATE] = PRIVATE_TO_JSVAL(qn);
     qn->object = obj;
     return JS_TRUE;
 }
 
 static JSBool
@@ -5656,11 +5676,11 @@ xml_addNamespace(JSContext *cx, uintN ar
         goto done;
     xml = CHECK_COPY_ON_WRITE(cx, xml, obj);
     if (!xml)
         return JS_FALSE;
 
-    if (!NamespaceHelper(cx, NULL, 1, vp + 2, vp))
+    if (!NamespaceHelper(cx, NULL, argc == 0 ? -1 : 1, vp + 2, vp))
         return JS_FALSE;
     JS_ASSERT(!JSVAL_IS_PRIMITIVE(*vp));
 
     ns = (JSXMLNamespace *) JS_GetPrivate(cx, JSVAL_TO_OBJECT(*vp));
     if (!AddInScopeNamespace(cx, xml, ns))
@@ -5696,11 +5716,12 @@ xml_appendChild(JSContext *cx, uintN arg
     vxml = (JSXML *) JS_GetPrivate(cx, vobj);
     JS_ASSERT(vxml->xml_class == JSXML_CLASS_LIST);
 
     if (!IndexToIdVal(cx, vxml->xml_kids.length, &name))
         return JS_FALSE;
-    if (!PutProperty(cx, JSVAL_TO_OBJECT(v), name, &vp[2]))
+    *vp = (argc != 0) ? vp[2] : JSVAL_VOID;
+    if (!PutProperty(cx, JSVAL_TO_OBJECT(v), name, vp))
         return JS_FALSE;
 
     *vp = OBJECT_TO_JSVAL(obj);
     return JS_TRUE;
 }
@@ -5708,10 +5729,15 @@ xml_appendChild(JSContext *cx, uintN arg
 /* XML and XMLList */
 static JSBool
 xml_attribute(JSContext *cx, uintN argc, jsval *vp)
 {
     JSXMLQName *qn;
+
+    if (argc == 0) {
+        js_ReportMissingArg(cx, vp, 0);
+        return JS_FALSE;
+    }
 
     qn = ToAttributeName(cx, vp[2]);
     if (!qn)
         return JS_FALSE;
     vp[2] = OBJECT_TO_JSVAL(qn->object);      /* local root */
@@ -5794,11 +5820,11 @@ xml_child(JSContext *cx, uintN argc, jsv
     JSXML *list, *kid, *vxml;
     JSXMLArrayCursor cursor;
     JSObject *kidobj;
 
     XML_METHOD_PROLOG;
-    name = vp[2];
+    name = argc != 0 ? vp[2] : JSVAL_VOID;
     if (xml->xml_class == JSXML_CLASS_LIST) {
         /* ECMA-357 13.5.4.4 */
         list = xml_list_helper(cx, xml, vp);
         if (!list)
             return JS_FALSE;
@@ -5937,11 +5963,11 @@ xml_contains(JSContext *cx, uintN argc, 
     JSXMLArrayCursor cursor;
     JSXML *kid;
     JSObject *kidobj;
 
     XML_METHOD_PROLOG;
-    value = vp[2];
+    value = argc != 0 ? vp[2] : JSVAL_VOID;
     if (xml->xml_class == JSXML_CLASS_LIST) {
         eq = JS_FALSE;
         XMLArrayCursorInit(&cursor, &xml->xml_kids);
         while ((kid = (JSXML *) XMLArrayCursorNext(&cursor)) != NULL) {
             kidobj = js_GetXMLObject(cx, kid);
@@ -6083,18 +6109,18 @@ xml_hasOwnProperty(JSContext *cx, uintN 
 
     obj = JS_THIS_OBJECT(cx, vp);
     if (!JS_InstanceOf(cx, obj, &js_XMLClass, vp + 2))
         return JS_FALSE;
 
-    name = vp[2];
+    name = argc != 0 ? vp[2] : JSVAL_VOID;
     if (!HasProperty(cx, obj, name, &found))
         return JS_FALSE;
     if (found) {
         *vp = JSVAL_TRUE;
         return JS_TRUE;
     }
-    return js_HasOwnPropertyHelper(cx, js_LookupProperty, vp);
+    return js_HasOwnPropertyHelper(cx, js_LookupProperty, argc, vp);
 }
 
 /* XML and XMLList */
 static JSBool
 xml_hasComplexContent(JSContext *cx, uintN argc, jsval *vp)
@@ -6272,11 +6298,12 @@ xml_insertChildAfter(JSContext *cx, uint
     jsval arg;
     JSXML *kid;
     uint32 i;
 
     NON_LIST_XML_METHOD_PROLOG;
-    if (!JSXML_HAS_KIDS(xml))
+    *vp = OBJECT_TO_JSVAL(obj);
+    if (!JSXML_HAS_KIDS(xml) || argc == 0)
         return JS_TRUE;
 
     arg = vp[2];
     if (JSVAL_IS_NULL(arg)) {
         kid = NULL;
@@ -6292,25 +6319,23 @@ xml_insertChildAfter(JSContext *cx, uint
     }
 
     xml = CHECK_COPY_ON_WRITE(cx, xml, obj);
     if (!xml)
         return JS_FALSE;
-    if (!Insert(cx, xml, i, vp[3]))
-        return JS_FALSE;
-    *vp = OBJECT_TO_JSVAL(obj);
-    return JS_TRUE;
+    return Insert(cx, xml, i, argc >= 2 ? vp[3] : JSVAL_VOID);
 }
 
 static JSBool
 xml_insertChildBefore(JSContext *cx, uintN argc, jsval *vp)
 {
     jsval arg;
     JSXML *kid;
     uint32 i;
 
     NON_LIST_XML_METHOD_PROLOG;
-    if (!JSXML_HAS_KIDS(xml))
+    *vp = OBJECT_TO_JSVAL(obj);
+    if (!JSXML_HAS_KIDS(xml) || argc == 0)
         return JS_TRUE;
 
     arg = vp[2];
     if (JSVAL_IS_NULL(arg)) {
         kid = NULL;
@@ -6325,14 +6350,11 @@ xml_insertChildBefore(JSContext *cx, uin
     }
 
     xml = CHECK_COPY_ON_WRITE(cx, xml, obj);
     if (!xml)
         return JS_FALSE;
-    if (!Insert(cx, xml, i, vp[3]))
-        return JS_FALSE;
-    *vp = OBJECT_TO_JSVAL(obj);
-    return JS_TRUE;
+    return Insert(cx, xml, i, argc >= 2 ? vp[3] : JSVAL_VOID);
 }
 
 /* XML and XMLList */
 static JSBool
 xml_length(JSContext *cx, uintN argc, jsval *vp)
@@ -6708,24 +6730,22 @@ xml_prependChild(JSContext *cx, uintN ar
     NON_LIST_XML_METHOD_PROLOG;
     xml = CHECK_COPY_ON_WRITE(cx, xml, obj);
     if (!xml)
         return JS_FALSE;
     *vp = OBJECT_TO_JSVAL(obj);
-    return Insert(cx, xml, 0, vp[2]);
+    return Insert(cx, xml, 0, argc != 0 ? vp[2] : JSVAL_VOID);
 }
 
 /* XML and XMLList */
 static JSBool
 xml_propertyIsEnumerable(JSContext *cx, uintN argc, jsval *vp)
 {
-    jsval name;
     uint32 index;
 
     XML_METHOD_PROLOG;
-    name = vp[2];
     *vp = JSVAL_FALSE;
-    if (js_IdIsIndex(name, &index)) {
+    if (argc != 0 && js_IdIsIndex(vp[2], &index)) {
         if (xml->xml_class == JSXML_CLASS_LIST) {
             /* 13.5.4.18. */
             *vp = BOOLEAN_TO_JSVAL(index < xml->xml_kids.length);
         } else {
             /* 13.4.4.30. */
@@ -6794,11 +6814,11 @@ xml_removeNamespace(JSContext *cx, uintN
         goto done;
     xml = CHECK_COPY_ON_WRITE(cx, xml, obj);
     if (!xml)
         return JS_FALSE;
 
-    if (!NamespaceHelper(cx, NULL, 1, vp + 2, vp))
+    if (!NamespaceHelper(cx, NULL, argc == 0 ? -1 : 1, vp + 2, vp))
         return JS_FALSE;
     JS_ASSERT(!JSVAL_IS_PRIMITIVE(*vp));
     ns = (JSXMLNamespace *) JS_GetPrivate(cx, JSVAL_TO_OBJECT(*vp));
 
     /* NOTE: remove ns from each ancestor if not used by that ancestor. */
@@ -6819,36 +6839,43 @@ xml_replace(JSContext *cx, uintN argc, j
 
     NON_LIST_XML_METHOD_PROLOG;
     if (xml->xml_class != JSXML_CLASS_ELEMENT)
         goto done;
 
-    value = vp[3];
-    vxml = VALUE_IS_XML(cx, value)
-           ? (JSXML *) JS_GetPrivate(cx, JSVAL_TO_OBJECT(value))
-           : NULL;
-    if (!vxml) {
-        if (!JS_ConvertValue(cx, value, JSTYPE_STRING, &vp[3]))
-            return JS_FALSE;
+    if (argc <= 1) {
+        value = STRING_TO_JSVAL(ATOM_TO_STRING(cx->runtime->atomState.
+                                               typeAtoms[JSTYPE_VOID]));
+    } else {
         value = vp[3];
-    } else {
-        vxml = DeepCopy(cx, vxml, NULL, 0);
-        if (!vxml)
-            return JS_FALSE;
-        value = vp[3] = OBJECT_TO_JSVAL(vxml->object);
-    }
-
-    xml = CHECK_COPY_ON_WRITE(cx, xml, obj);
-    if (!xml)
-        return JS_FALSE;
-
-    if (!js_IdIsIndex(vp[2], &index)) {
+        vxml = VALUE_IS_XML(cx, value)
+               ? (JSXML *) JS_GetPrivate(cx, JSVAL_TO_OBJECT(value))
+               : NULL;
+        if (!vxml) {
+            if (!JS_ConvertValue(cx, value, JSTYPE_STRING, &vp[3]))
+                return JS_FALSE;
+            value = vp[3];
+        } else {
+            vxml = DeepCopy(cx, vxml, NULL, 0);
+            if (!vxml)
+                return JS_FALSE;
+            value = vp[3] = OBJECT_TO_JSVAL(vxml->object);
+        }
+    }
+
+    xml = CHECK_COPY_ON_WRITE(cx, xml, obj);
+    if (!xml)
+        return JS_FALSE;
+
+    if (argc == 0 || !js_IdIsIndex(vp[2], &index)) {
         /*
          * Call function QName per spec, not ToXMLName, to avoid attribute
          * names.
          */
-        if (!QNameHelper(cx, NULL, &js_QNameClass.base, 1, vp + 2, vp))
-            return JS_FALSE;
+        if (!QNameHelper(cx, NULL, &js_QNameClass.base, argc == 0 ? -1 : 1,
+                         vp + 2, vp)) {
+            return JS_FALSE;
+        }
         JS_ASSERT(!JSVAL_IS_PRIMITIVE(*vp));
         nameqn = (JSXMLQName *) JS_GetPrivate(cx, JSVAL_TO_OBJECT(*vp));
 
         i = xml->xml_kids.length;
         index = XML_NOT_FOUND;
@@ -6880,14 +6907,13 @@ xml_setChildren(JSContext *cx, uintN arg
     JSObject *obj;
 
     if (!StartNonListXMLMethod(cx, vp, &obj))
         return JS_FALSE;
 
-    if (!PutProperty(cx, obj, ATOM_KEY(cx->runtime->atomState.starAtom),
-                     &vp[2])) {
-        return JS_FALSE;
-    }
+    *vp = argc != 0 ? vp[2] : JSVAL_VOID;     /* local root */
+    if (!PutProperty(cx, obj, ATOM_KEY(cx->runtime->atomState.starAtom), vp))
+        return JS_FALSE;
 
     *vp = OBJECT_TO_JSVAL(obj);
     return JS_TRUE;
 }
 
@@ -6900,20 +6926,24 @@ xml_setLocalName(JSContext *cx, uintN ar
 
     NON_LIST_XML_METHOD_PROLOG;
     if (!JSXML_HAS_NAME(xml))
         return JS_TRUE;
 
-    name = vp[2];
-    if (!JSVAL_IS_PRIMITIVE(name) &&
-        OBJ_GET_CLASS(cx, JSVAL_TO_OBJECT(name)) == &js_QNameClass.base) {
-        nameqn = (JSXMLQName *) JS_GetPrivate(cx, JSVAL_TO_OBJECT(name));
-        namestr = nameqn->localName;
-    } else {
-        if (!JS_ConvertValue(cx, name, JSTYPE_STRING, &vp[2]))
-            return JS_FALSE;
+    if (argc == 0) {
+        namestr = ATOM_TO_STRING(cx->runtime->atomState.typeAtoms[JSTYPE_VOID]);
+    } else {
         name = vp[2];
-        namestr = JSVAL_TO_STRING(name);
+        if (!JSVAL_IS_PRIMITIVE(name) &&
+            OBJ_GET_CLASS(cx, JSVAL_TO_OBJECT(name)) == &js_QNameClass.base) {
+            nameqn = (JSXMLQName *) JS_GetPrivate(cx, JSVAL_TO_OBJECT(name));
+            namestr = nameqn->localName;
+        } else {
+            if (!JS_ConvertValue(cx, name, JSTYPE_STRING, &vp[2]))
+                return JS_FALSE;
+            name = vp[2];
+            namestr = JSVAL_TO_STRING(name);
+        }
     }
 
     xml = CHECK_COPY_ON_WRITE(cx, xml, obj);
     if (!xml)
         return JS_FALSE;
@@ -6934,16 +6964,21 @@ xml_setName(JSContext *cx, uintN argc, j
 
     NON_LIST_XML_METHOD_PROLOG;
     if (!JSXML_HAS_NAME(xml))
         return JS_TRUE;
 
-    name = vp[2];
-    if (!JSVAL_IS_PRIMITIVE(name) &&
-        OBJ_GET_CLASS(cx, JSVAL_TO_OBJECT(name)) == &js_QNameClass.base &&
-        !(nameqn = (JSXMLQName *) JS_GetPrivate(cx, JSVAL_TO_OBJECT(name)))
-         ->uri) {
-        name = vp[2] = STRING_TO_JSVAL(nameqn->localName);
+    if (argc == 0) {
+        name = STRING_TO_JSVAL(ATOM_TO_STRING(cx->runtime->atomState.
+                                              typeAtoms[JSTYPE_VOID]));
+    } else {
+        name = vp[2];
+        if (!JSVAL_IS_PRIMITIVE(name) &&
+            OBJ_GET_CLASS(cx, JSVAL_TO_OBJECT(name)) == &js_QNameClass.base &&
+            !(nameqn = (JSXMLQName *) JS_GetPrivate(cx, JSVAL_TO_OBJECT(name)))
+            ->uri) {
+            name = vp[2] = STRING_TO_JSVAL(nameqn->localName);
+        }
     }
 
     nameobj = js_ConstructObject(cx, &js_QNameClass.base, NULL, NULL, 1, &name);
     if (!nameobj)
         return JS_FALSE;
@@ -7020,11 +7055,14 @@ xml_setName(JSContext *cx, uintN argc, j
         ns = js_NewXMLNamespace(cx, NULL, nameqn->uri, JS_TRUE);
         if (!ns)
             return JS_FALSE;
     }
 
-    return AddInScopeNamespace(cx, nsowner, ns);
+    if (!AddInScopeNamespace(cx, nsowner, ns))
+        return JS_FALSE;
+    vp[0] = JSVAL_VOID;
+    return JS_TRUE;
 }
 
 static JSBool
 xml_setNamespace(JSContext *cx, uintN argc, jsval *vp)
 {
@@ -7039,14 +7077,15 @@ xml_setNamespace(JSContext *cx, uintN ar
 
     xml = CHECK_COPY_ON_WRITE(cx, xml, obj);
     if (!xml || !js_GetXMLQNameObject(cx, xml->name))
         return JS_FALSE;
 
-    nsobj = js_ConstructObject(cx, &js_NamespaceClass.base, NULL, obj, 1,
-                               vp + 2);
+    nsobj = js_ConstructObject(cx, &js_NamespaceClass.base, NULL, obj,
+                               argc == 0 ? 0 : 1, vp + 2);
     if (!nsobj)
         return JS_FALSE;
+    vp[0] = OBJECT_TO_JSVAL(nsobj);
     ns = (JSXMLNamespace *) JS_GetPrivate(cx, nsobj);
     ns->declared = JS_TRUE;
 
     qnargv[0] = vp[2] = OBJECT_TO_JSVAL(nsobj);
     qnargv[1] = OBJECT_TO_JSVAL(xml->name->object);
@@ -7065,11 +7104,14 @@ xml_setNamespace(JSContext *cx, uintN ar
     } else {
         if (!xml->parent || xml->parent->xml_class != JSXML_CLASS_ELEMENT)
             return JS_TRUE;
         nsowner = xml->parent;
     }
-    return AddInScopeNamespace(cx, nsowner, ns);
+    if (!AddInScopeNamespace(cx, nsowner, ns))
+        return JS_FALSE;
+    vp[0] = JSVAL_VOID;
+    return JS_TRUE;
 }
 
 /* XML and XMLList */
 static JSBool
 xml_text_helper(JSContext *cx, JSObject *obj, JSXML *xml, jsval *vp)
@@ -7217,50 +7259,50 @@ xml_valueOf(JSContext *cx, uintN argc, j
     *vp = JS_THIS(cx, vp);
     return !JSVAL_IS_NULL(*vp);
 }
 
 static JSFunctionSpec xml_methods[] = {
-    JS_FN("addNamespace",          xml_addNamespace,          1,1,0),
-    JS_FN("appendChild",           xml_appendChild,           1,1,0),
-    JS_FN(js_attribute_str,        xml_attribute,             1,1,0),
-    JS_FN("attributes",            xml_attributes,            0,0,0),
-    JS_FN("child",                 xml_child,                 1,1,0),
-    JS_FN("childIndex",            xml_childIndex,            0,0,0),
-    JS_FN("children",              xml_children,              0,0,0),
-    JS_FN("comments",              xml_comments,              0,0,0),
-    JS_FN("contains",              xml_contains,              1,1,0),
-    JS_FN("copy",                  xml_copy,                  0,0,0),
-    JS_FN("descendants",           xml_descendants,           0,1,0),
-    JS_FN("elements",              xml_elements,              0,1,0),
-    JS_FN("hasOwnProperty",        xml_hasOwnProperty,        1,1,0),
-    JS_FN("hasComplexContent",     xml_hasComplexContent,     1,1,0),
-    JS_FN("hasSimpleContent",      xml_hasSimpleContent,      1,1,0),
-    JS_FN("inScopeNamespaces",     xml_inScopeNamespaces,     0,0,0),
-    JS_FN("insertChildAfter",      xml_insertChildAfter,      2,2,0),
-    JS_FN("insertChildBefore",     xml_insertChildBefore,     2,2,0),
-    JS_FN(js_length_str,           xml_length,                0,0,0),
-    JS_FN(js_localName_str,        xml_localName,             0,0,0),
-    JS_FN(js_name_str,             xml_name,                  0,0,0),
-    JS_FN(js_namespace_str,        xml_namespace,             0,1,0),
-    JS_FN("namespaceDeclarations", xml_namespaceDeclarations, 0,0,0),
-    JS_FN("nodeKind",              xml_nodeKind,              0,0,0),
-    JS_FN("normalize",             xml_normalize,             0,0,0),
-    JS_FN(js_xml_parent_str,       xml_parent,                0,0,0),
-    JS_FN("processingInstructions",xml_processingInstructions,0,1,0),
-    JS_FN("prependChild",          xml_prependChild,          1,1,0),
-    JS_FN("propertyIsEnumerable",  xml_propertyIsEnumerable,  1,1,0),
-    JS_FN("removeNamespace",       xml_removeNamespace,       1,1,0),
-    JS_FN("replace",               xml_replace,               2,2,0),
-    JS_FN("setChildren",           xml_setChildren,           1,1,0),
-    JS_FN("setLocalName",          xml_setLocalName,          1,1,0),
-    JS_FN("setName",               xml_setName,               1,1,0),
-    JS_FN("setNamespace",          xml_setNamespace,          1,1,0),
-    JS_FN(js_text_str,             xml_text,                  0,0,0),
-    JS_FN(js_toSource_str,         xml_toSource,              0,0,0),
-    JS_FN(js_toString_str,         xml_toString,              0,0,0),
-    JS_FN(js_toXMLString_str,      xml_toXMLString,           0,0,0),
-    JS_FN(js_valueOf_str,          xml_valueOf,               0,0,0),
+    JS_FN("addNamespace",          xml_addNamespace,          1,0),
+    JS_FN("appendChild",           xml_appendChild,           1,0),
+    JS_FN(js_attribute_str,        xml_attribute,             1,0),
+    JS_FN("attributes",            xml_attributes,            0,0),
+    JS_FN("child",                 xml_child,                 1,0),
+    JS_FN("childIndex",            xml_childIndex,            0,0),
+    JS_FN("children",              xml_children,              0,0),
+    JS_FN("comments",              xml_comments,              0,0),
+    JS_FN("contains",              xml_contains,              1,0),
+    JS_FN("copy",                  xml_copy,                  0,0),
+    JS_FN("descendants",           xml_descendants,           1,0),
+    JS_FN("elements",              xml_elements,              1,0),
+    JS_FN("hasOwnProperty",        xml_hasOwnProperty,        1,0),
+    JS_FN("hasComplexContent",     xml_hasComplexContent,     1,0),
+    JS_FN("hasSimpleContent",      xml_hasSimpleContent,      1,0),
+    JS_FN("inScopeNamespaces",     xml_inScopeNamespaces,     0,0),
+    JS_FN("insertChildAfter",      xml_insertChildAfter,      2,0),
+    JS_FN("insertChildBefore",     xml_insertChildBefore,     2,0),
+    JS_FN(js_length_str,           xml_length,                0,0),
+    JS_FN(js_localName_str,        xml_localName,             0,0),
+    JS_FN(js_name_str,             xml_name,                  0,0),
+    JS_FN(js_namespace_str,        xml_namespace,             1,0),
+    JS_FN("namespaceDeclarations", xml_namespaceDeclarations, 0,0),
+    JS_FN("nodeKind",              xml_nodeKind,              0,0),
+    JS_FN("normalize",             xml_normalize,             0,0),
+    JS_FN(js_xml_parent_str,       xml_parent,                0,0),
+    JS_FN("processingInstructions",xml_processingInstructions,1,0),
+    JS_FN("prependChild",          xml_prependChild,          1,0),
+    JS_FN("propertyIsEnumerable",  xml_propertyIsEnumerable,  1,0),
+    JS_FN("removeNamespace",       xml_removeNamespace,       1,0),
+    JS_FN("replace",               xml_replace,               2,0),
+    JS_FN("setChildren",           xml_setChildren,           1,0),
+    JS_FN("setLocalName",          xml_setLocalName,          1,0),
+    JS_FN("setName",               xml_setName,               1,0),
+    JS_FN("setNamespace",          xml_setNamespace,          1,0),
+    JS_FN(js_text_str,             xml_text,                  0,0),
+    JS_FN(js_toSource_str,         xml_toSource,              0,0),
+    JS_FN(js_toString_str,         xml_toString,              0,0),
+    JS_FN(js_toXMLString_str,      xml_toXMLString,           0,0),
+    JS_FN(js_valueOf_str,          xml_valueOf,               0,0),
     JS_FS_END
 };
 
 static JSBool
 CopyXMLSettings(JSContext *cx, JSObject *from, JSObject *to)
@@ -7322,11 +7364,11 @@ xml_setSettings(JSContext *cx, uintN arg
     JSBool ok;
 
     obj = JS_THIS_OBJECT(cx, vp);
     if (!obj)
         return JS_FALSE;
-    v = vp[2];
+    v = (argc == 0) ? JSVAL_VOID : vp[2];
     if (JSVAL_IS_NULL(v) || JSVAL_IS_VOID(v)) {
         cx->xmlSettingFlags = 0;
         ok = SetDefaultXMLSettings(cx, obj);
     } else {
         if (JSVAL_IS_PRIMITIVE(v))
@@ -7351,13 +7393,13 @@ xml_defaultSettings(JSContext *cx, uintN
     *vp = OBJECT_TO_JSVAL(settings);
     return SetDefaultXMLSettings(cx, settings);
 }
 
 static JSFunctionSpec xml_static_methods[] = {
-    JS_FN("settings",         xml_settings,          0,0,0),
-    JS_FN("setSettings",      xml_setSettings,       1,1,0),
-    JS_FN("defaultSettings",  xml_defaultSettings,   0,0,0),
+    JS_FN("settings",         xml_settings,          0,0),
+    JS_FN("setSettings",      xml_setSettings,       1,0),
+    JS_FN("defaultSettings",  xml_defaultSettings,   0,0),
     JS_FS_END
 };
 
 static JSBool
 XML(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval)
diff --git a/js/src/liveconnect/jsj_JavaArray.c b/js/src/liveconnect/jsj_JavaArray.c
--- a/js/src/liveconnect/jsj_JavaArray.c
+++ b/js/src/liveconnect/jsj_JavaArray.c
@@ -396,15 +396,10 @@ JavaArray_checkAccess(JSContext *cx, JSO
     case JSACC_WATCH:
         JS_ReportErrorNumber(cx, jsj_GetErrorMessage, NULL, 
                                             JSJMSG_JARRAY_PROP_WATCH);
         return JS_FALSE;
 
-    case JSACC_IMPORT:
-        JS_ReportErrorNumber(cx, jsj_GetErrorMessage, NULL, 
-                                            JSJMSG_JARRAY_PROP_EXPORT);
-        return JS_FALSE;
-
     default:
         return JS_TRUE;
     }
 }
 
diff --git a/js/src/liveconnect/jsj_JavaClass.c b/js/src/liveconnect/jsj_JavaClass.c
--- a/js/src/liveconnect/jsj_JavaClass.c
+++ b/js/src/liveconnect/jsj_JavaClass.c
@@ -467,15 +467,10 @@ JavaClass_checkAccess(JSContext *cx, JSO
     case JSACC_WATCH:
         JS_ReportErrorNumber(cx, jsj_GetErrorMessage, NULL, 
                                             JSJMSG_JCLASS_PROP_WATCH);
         return JS_FALSE;
 
-    case JSACC_IMPORT:
-        JS_ReportErrorNumber(cx, jsj_GetErrorMessage, NULL, 
-                                            JSJMSG_JCLASS_PROP_EXPORT);
-        return JS_FALSE;
-
     default:
         return JS_TRUE;
     }
 }
 
diff --git a/js/src/liveconnect/jsj_JavaObject.c b/js/src/liveconnect/jsj_JavaObject.c
--- a/js/src/liveconnect/jsj_JavaObject.c
+++ b/js/src/liveconnect/jsj_JavaObject.c
@@ -984,15 +984,10 @@ JavaObject_checkAccess(JSContext *cx, JS
     case JSACC_WATCH:
         JS_ReportErrorNumber(cx, jsj_GetErrorMessage, NULL,
                              JSJMSG_JOBJECT_PROP_WATCH);
         return JS_FALSE;
 
-    case JSACC_IMPORT:
-        JS_ReportErrorNumber(cx, jsj_GetErrorMessage, NULL,
-                             JSJMSG_JOBJECT_PROP_EXPORT);
-        return JS_FALSE;
-
     default:
         return JS_TRUE;
     }
 }
 
diff --git a/js/src/xpconnect/loader/mozJSComponentLoader.cpp b/js/src/xpconnect/loader/mozJSComponentLoader.cpp
--- a/js/src/xpconnect/loader/mozJSComponentLoader.cpp
+++ b/js/src/xpconnect/loader/mozJSComponentLoader.cpp
@@ -635,11 +635,12 @@ mozJSComponentLoader::LoadModule(nsILoca
 
     nsAutoPtr<ModuleEntry> entry(new ModuleEntry);
     if (!entry)
         return NS_ERROR_OUT_OF_MEMORY;
 
-    rv = GlobalForLocation(aComponentFile, &entry->global, &entry->location);
+    rv = GlobalForLocation(aComponentFile, &entry->global, &entry->location,
+                           nsnull);
     if (NS_FAILED(rv)) {
 #ifdef DEBUG_shaver
         fprintf(stderr, "GlobalForLocation failed!\n");
 #endif
         return rv;
@@ -1058,11 +1059,12 @@ mozJSComponentLoader::WriteScript(nsIFas
 }
 
 nsresult
 mozJSComponentLoader::GlobalForLocation(nsILocalFile *aComponent,
                                         JSObject **aGlobal,
-                                        char **aLocation)
+                                        char **aLocation,
+                                        jsval *exception)
 {
     nsresult rv;
 
     JSPrincipals* jsPrincipals = nsnull;
     JSCLContextHelper cx(this);
@@ -1188,34 +1190,50 @@ mozJSComponentLoader::GlobalForLocation(
 
     if (!script || NS_FAILED(rv)) {
         // The script wasn't in the fastload cache, so compile it now.
         LOG(("Slow loading %s\n", nativePath.get()));
 
+        // If |exception| is non-null, then our caller wants us to propagate
+        // any exceptions out to our caller. Ensure that the engine doesn't
+        // eagerly report the exception.
+        uint32 oldopts = 0;
+        if (exception) {
+            oldopts = JS_GetOptions(cx);
+            JS_SetOptions(cx, oldopts | JSOPTION_DONT_REPORT_UNCAUGHT);
+        }
+
 #ifdef HAVE_PR_MEMMAP
         PRInt64 fileSize;
         rv = aComponent->GetFileSize(&fileSize);
-        if (NS_FAILED(rv))
+        if (NS_FAILED(rv)) {
+            JS_SetOptions(cx, oldopts);
             return rv;
+        }
 
         PRInt64 maxSize;
         LL_UI2L(maxSize, PR_UINT32_MAX);
         if (LL_CMP(fileSize, >, maxSize)) {
             NS_ERROR("file too large");
+            JS_SetOptions(cx, oldopts);
             return NS_ERROR_FAILURE;
         }
 
         PRFileDesc *fileHandle;
         rv = aComponent->OpenNSPRFileDesc(PR_RDONLY, 0, &fileHandle);
-        NS_ENSURE_SUCCESS(rv, rv);
+        if (NS_FAILED(rv)) {
+            JS_SetOptions(cx, oldopts);
+            return NS_ERROR_FILE_NOT_FOUND;
+        }
 
         // Make sure the file is closed, no matter how we return.
         FileAutoCloser fileCloser(fileHandle);
 
         PRFileMap *map = PR_CreateFileMap(fileHandle, fileSize,
                                           PR_PROT_READONLY);
         if (!map) {
             NS_ERROR("Failed to create file map");
+            JS_SetOptions(cx, oldopts);
             return NS_ERROR_FAILURE;
         }
 
         // Make sure the file map is closed, no matter how we return.
         FileMapAutoCloser mapCloser(map);
@@ -1224,10 +1242,11 @@ mozJSComponentLoader::GlobalForLocation(
         LL_L2UI(fileSize32, fileSize);
 
         char *buf = static_cast<char*>(PR_MemMap(map, 0, fileSize32));
         if (!buf) {
             NS_WARNING("Failed to map file");
+            JS_SetOptions(cx, oldopts);
             return NS_ERROR_FAILURE;
         }
 
         script = JS_CompileScriptForPrincipals(cx, global,
                                                jsPrincipals,
@@ -1242,19 +1261,33 @@ mozJSComponentLoader::GlobalForLocation(
          * JS_CompileFileHandleForPrincipals().
          */
 
         FILE *fileHandle;
         rv = aComponent->OpenANSIFileDesc("r", &fileHandle);
-        NS_ENSURE_SUCCESS(rv, rv);
+        if (NS_FAILED(rv)) {
+            JS_SetOptions(cx, oldopts);
+            return NS_ERROR_FILE_NOT_FOUND;
+        }
 
         script = JS_CompileFileHandleForPrincipals(cx, global,
                                                    nativePath.get(),
                                                    fileHandle, jsPrincipals);
 
         /* JS will close the filehandle after compilation is complete. */
+#endif /* HAVE_PR_MEMMAP */
 
-#endif /* HAVE_PR_MEMMAP */
+        // Propagate the exception, if one exists. Also, don't leave the stale
+        // exception on this context.
+        // NB: The caller must stick exception into a rooted slot (probably on
+        // its context) as soon as possible to avoid GC hazards.
+        if (exception) {
+            JS_SetOptions(cx, oldopts);
+            if (!script) {
+                JS_GetPendingException(cx, exception);
+                JS_ClearPendingException(cx);
+            }
+        }
     }
 
     if (!script) {
 #ifdef DEBUG_shaver_off
         fprintf(stderr, "mJCL: script compilation of %s FAILED\n",
@@ -1472,17 +1505,30 @@ mozJSComponentLoader::ImportInto(const n
     if (!mImports.Get(lfhash, &mod) && !mInProgressImports.Get(lfhash, &mod)) {
         newEntry = new ModuleEntry;
         if (!newEntry || !mInProgressImports.Put(lfhash, newEntry))
             return NS_ERROR_OUT_OF_MEMORY;
 
+        jsval exception = JSVAL_VOID;
         rv = GlobalForLocation(componentFile, &newEntry->global,
-                               &newEntry->location);
+                               &newEntry->location, &exception);
 
         mInProgressImports.Remove(lfhash);
 
         if (NS_FAILED(rv)) {
             *_retval = nsnull;
+
+            if (!JSVAL_IS_VOID(exception)) {
+                // An exception was thrown during compilation. Propagate it
+                // out to our caller so they can report it.
+                JSContext *callercx;
+                cc->GetJSContext(&callercx);
+                JS_SetPendingException(callercx, exception);
+                cc->SetExceptionWasThrown(PR_TRUE);
+                return NS_OK;
+            }
+
+            // Something failed, but we don't know what it is, guess.
             return NS_ERROR_FILE_NOT_FOUND;
         }
 
         mod = newEntry;
     }
diff --git a/js/src/xpconnect/loader/mozJSComponentLoader.h b/js/src/xpconnect/loader/mozJSComponentLoader.h
--- a/js/src/xpconnect/loader/mozJSComponentLoader.h
+++ b/js/src/xpconnect/loader/mozJSComponentLoader.h
@@ -108,11 +108,12 @@ class mozJSComponentLoader : public nsIM
     nsresult ReallyInit();
     void UnloadModules();
 
     nsresult GlobalForLocation(nsILocalFile *aComponent,
                                JSObject **aGlobal,
-                               char **location);
+                               char **location,
+                               jsval *exception);
 
     nsresult StartFastLoad(nsIFastLoadService *flSvc);
     nsresult ReadScript(nsIFastLoadService *flSvc, const char *nativePath,
                         nsIURI *uri, JSContext *cx, JSScript **script);
     nsresult WriteScript(nsIFastLoadService *flSvc, JSScript *script,
diff --git a/js/src/xpconnect/src/xpcwrappednativescope.cpp b/js/src/xpconnect/src/xpcwrappednativescope.cpp
--- a/js/src/xpconnect/src/xpcwrappednativescope.cpp
+++ b/js/src/xpconnect/src/xpcwrappednativescope.cpp
@@ -790,23 +790,30 @@ XPCWrappedNativeScope::FindInJSObjectSco
 
     obj = JS_GetGlobalForObject(ccx, obj);
 
     // XXX We are assuming that the scope count is low enough that traversing
     // the linked list is more reasonable then doing a hashtable lookup.
+    XPCWrappedNativeScope* found = nsnull;
     {   // scoped lock
         XPCAutoLock lock(ccx.GetRuntime()->GetMapLock());
 
         DEBUG_TrackScopeTraversal();
 
         for(XPCWrappedNativeScope* cur = gScopes; cur; cur = cur->mNext)
         {
             if(obj == cur->GetGlobalJSObject())
             {
-                DEBUG_CheckForComponentsInScope(ccx, obj, OKIfNotInitialized);
-                return cur;
+                found = cur;
+                break;
             }
         }
+    }
+
+    if(found) {
+        // This cannot be called within the map lock!
+        DEBUG_CheckForComponentsInScope(ccx, obj, OKIfNotInitialized);
+        return found;
     }
 
     // Failure to find the scope is only OK if the caller told us it might fail.
     // This flag would only be set in the call from
     // XPCWrappedNativeScope::GetNewOrUsed
diff --git a/js/src/xpconnect/tests/unit/syntax_error.jsm b/js/src/xpconnect/tests/unit/syntax_error.jsm
new file mode 100644
--- /dev/null
+++ b/js/src/xpconnect/tests/unit/syntax_error.jsm
@@ -0,0 +1,1 @@
+bogusjs)(
diff --git a/js/src/xpconnect/tests/unit/test_bug408412.js b/js/src/xpconnect/tests/unit/test_bug408412.js
new file mode 100644
--- /dev/null
+++ b/js/src/xpconnect/tests/unit/test_bug408412.js
@@ -0,0 +1,51 @@
+/*
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Mozilla code.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2007
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *    Dave Townsend <dtownsend@oxymoronical.com> (original author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+ 
+function run_test() {
+  var file = do_get_file("js/src/xpconnect/tests/unit/syntax_error.jsm");
+  var ios = Components.classes["@mozilla.org/network/io-service;1"]
+                      .getService(Components.interfaces.nsIIOService);
+  var uri = ios.newFileURI(file);
+
+  try {
+    Components.utils.import(uri.spec);
+    do_throw("Failed to report any error at all");
+  } catch (e) {
+    do_check_neq(/^SyntaxError:/(e + ''), null);
+  }
+}
diff --git a/js/tests/ecma_3/ExecutionContexts/regress-448595-01.js b/js/tests/ecma_3/ExecutionContexts/regress-448595-01.js
new file mode 100755
--- /dev/null
+++ b/js/tests/ecma_3/ExecutionContexts/regress-448595-01.js
@@ -0,0 +1,91 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Oliver Hunt
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-448595-01.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 448595;
+var summary = 'scope chain var declaration with initialiser in |with| clauses';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  var f;
+
+  expect = 'bar';
+
+  f = function(){
+    var e = "bar"; 
+    with({e:"foo"}) {
+      var e = "wibble";
+    };
+
+    actual = e;
+  }
+
+  f();
+
+  reportCompare(expect, actual, summary + ': with');
+
+  f = function(){
+    var e = "bar"; 
+    try
+    {
+      throw {e:"foo"};
+    }
+    catch(e) {
+      var e = "wibble";
+    };
+
+    actual = e;
+  }
+
+  f();
+
+  reportCompare(expect, actual, summary + ': catch');
+
+  exitFunc ('test');
+}
diff --git a/js/tests/ecma_3/Number/15.7.4.3-02.js b/js/tests/ecma_3/Number/15.7.4.3-02.js
new file mode 100644
--- /dev/null
+++ b/js/tests/ecma_3/Number/15.7.4.3-02.js
@@ -0,0 +1,53 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Jeff Walden.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Philip Taylor
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = '15.7.4.3-02.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = "446494";
+var summary = "num.toLocaleString should handle exponents";
+var actual, expect;
+
+printBugNumber(BUGNUMBER);
+printStatus(summary);
+
+expect = '1e-10';
+actual = 1e-10.toLocaleString();
+reportCompare(expect, actual, summary + ': ' + expect);
+
+expect = 'Infinity';
+actual = Infinity.toLocaleString();
+reportCompare(expect, actual, summary + ': ' + expect);
diff --git a/js/tests/ecma_3/Number/regress-442242-01.js b/js/tests/ecma_3/Number/regress-442242-01.js
new file mode 100755
--- /dev/null
+++ b/js/tests/ecma_3/Number/regress-442242-01.js
@@ -0,0 +1,62 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Igor Bukanov
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-442242-01.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 442242;
+var summary = 'Do not assert: INT_FITS_IN_JSVAL(i)';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  var i = 28800000;
+  -i;
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff --git a/js/tests/ecma_3/Operators/order-01.js b/js/tests/ecma_3/Operators/order-01.js
new file mode 100755
--- /dev/null
+++ b/js/tests/ecma_3/Operators/order-01.js
@@ -0,0 +1,108 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'order-01.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 433672;
+var summary = 'operator evaluation order';
+var actual = '';
+var expect = '';
+
+function makeObject(label) 
+{
+  var o = (function (){});
+
+  o.label    = label;
+  o.valueOf  = (function() { actual += this.label + ' valueOf, ';  return Object.prototype.valueOf.call(this); });
+  o.toString = (function() { actual += this.label + ' toString, '; return Object.prototype.toString.call(this); });
+
+  return o;
+}
+
+operators = [
+  {section: '11.5.1', operator: '*'},
+  {section: '11.5.2', operator: '/'},
+  {section: '11.5.3', operator: '%'},
+  {section: '11.6.1', operator: '+'},
+  {section: '11.6.2', operator: '-'},
+  {section: '11.7.1', operator: '<<'},
+  {section: '11.7.2', operator: '>>'},
+  {section: '11.7.3', operator: '>>>'},
+  {section: '11.8.1', operator: '<'},
+  {section: '11.8.2', operator: '>'},
+  {section: '11.8.3', operator: '<='},
+  {section: '11.8.4', operator: '>='},
+  {section: '11.10', operator: '&'},
+  {section: '11.10', operator: '^'},
+  {section: '11.10', operator: '|'},
+  {section: '11.13.2', operator: '*='},
+  {section: '11.13.2', operator: '/='},
+  {section: '11.13.2', operator: '%='},
+  {section: '11.13.2', operator: '+='},
+  {section: '11.13.2', operator: '<<='},
+  {section: '11.13.2', operator: '>>='},
+  {section: '11.13.2', operator: '>>>='},
+  {section: '11.13.2', operator: '&='},
+  {section: '11.13.2', operator: '^='},
+  {section: '11.13.2', operator: '|='},
+  ];
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  for (var i = 0; i < operators.length; i++)
+  {
+    expect = 'left valueOf, left toString, right valueOf, right toString, ';
+    actual = '';
+
+    var left  = makeObject('left');
+    var right = makeObject('right');
+
+    eval('left ' + operators[i].operator + ' right');
+
+    reportCompare(expect, actual, summary + ': ' + operators[i].section + ' ' + operators[i].operator);
+  }
+
+  exitFunc ('test');
+}
diff --git a/js/tests/ecma_3/Regress/regress-441477-01.js b/js/tests/ecma_3/Regress/regress-441477-01.js
new file mode 100755
--- /dev/null
+++ b/js/tests/ecma_3/Regress/regress-441477-01.js
@@ -0,0 +1,73 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jason Orendorff
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-441477-01.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 441477-01;
+var summary = '';
+var actual = 'No Exception';
+var expect = 'No Exception';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  try
+  {
+    for (i = 0; i < 5;) 
+    { 
+      if (i > 5) 
+        throw "bad"; 
+      i++; 
+      continue; 
+    }
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+  }
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff --git a/js/tests/ecma_3/extensions/regress-368516.js b/js/tests/ecma_3/extensions/regress-368516.js
--- a/js/tests/ecma_3/extensions/regress-368516.js
+++ b/js/tests/ecma_3/extensions/regress-368516.js
@@ -36,11 +36,11 @@
  * ***** END LICENSE BLOCK ***** */
 
 var gTestfile = 'regress-368516.js';
 //-----------------------------------------------------------------------------
 var BUGNUMBER = 368516;
-var summary = 'Ignore unicode BOM characters';
+var summary = 'Treat unicode BOM characters as whitespace';
 var actual = '';
 var expect = '';
 
 
 //-----------------------------------------------------------------------------
@@ -56,16 +56,17 @@ function test()
   var bomchars = ['\uFFFE',
                   '\uFEFF'];
 
   for (var i = 0; i < bomchars.length; i++)
   {
-    expect = 'No Error';
-    actual = 'No Error';
+    expect = 'howdie';
+    actual = '';
 
     try
     {
-      eval("hi" + bomchars[i] + "there = 'howdie';");
+      eval("var" + bomchars[i] + "hithere = 'howdie';");
+      actual = hithere;
     }
     catch(ex)
     {
       actual = ex + '';
     }
diff --git a/js/tests/js1_5/GC/regress-440558.js b/js/tests/js1_5/GC/regress-440558.js
new file mode 100755
--- /dev/null
+++ b/js/tests/js1_5/GC/regress-440558.js
@@ -0,0 +1,69 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Ben Turner
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-440558.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 440558;
+var summary = 'Do not assert: *flagp != GCF_FINAL';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  print('Note: this test requires that javascript.options.gczeal ' +
+        'be set to 2 prior to the browser start');
+
+  m = function(a, b) {
+    if (++i < 10) {
+    }
+  };
+  e = function(a, b) {
+  };
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
+
diff --git a/js/tests/js1_5/Regress/regress-410852.js b/js/tests/js1_5/Regress/regress-410852.js
new file mode 100755
--- /dev/null
+++ b/js/tests/js1_5/Regress/regress-410852.js
@@ -0,0 +1,71 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Robert Sayre
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-410852.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 410852;
+var summary = 'Valgrind errors in jsemit.c';
+var actual = '';
+var expect = 'SyntaxError: syntax error';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  print('Note: You must run this test under valgrind to determine if it passes');
+
+  try
+  {
+    eval('function(){if(t)');
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+    print(actual);
+  }
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff --git a/js/tests/js1_5/Regress/regress-438415-02.js b/js/tests/js1_5/Regress/regress-438415-02.js
new file mode 100755
--- /dev/null
+++ b/js/tests/js1_5/Regress/regress-438415-02.js
@@ -0,0 +1,64 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Brian Crowder
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-438415-02.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 438415;
+var summary = 'Do not assert: *vp != JSVAL_HOLE';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  expect = 'zero';
+  Array.prototype[0] = 'zero';
+  var a = [];
+  a.length = 1;
+  actual = a.pop();
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff --git a/js/tests/js1_5/extensions/regress-434837-01.js b/js/tests/js1_5/extensions/regress-434837-01.js
new file mode 100755
--- /dev/null
+++ b/js/tests/js1_5/extensions/regress-434837-01.js
@@ -0,0 +1,168 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Cyrus Omar
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-434837-01.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 434837;
+var summary = '|this| in accessors in prototype chain of array';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  try
+  {
+    expect = true;
+    actual = null;
+    x = [ "one", "two" ];
+    Array.prototype.__defineGetter__('test1', function() { actual = (this === x); });
+    x.test1;
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+  }
+  reportCompare(expect, actual, summary + ': x.test1');
+
+  try
+  {
+    expect = false;
+    actual = null;
+    Array.prototype.__defineGetter__('test2', function() { actual = (this === Array.prototype) });
+    x.test2;
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+  }
+  reportCompare(expect, actual, summary + ': x.test2');
+
+  Array.prototype.__defineGetter__('test3', function() { actual = (this === x) });
+  Array.prototype.__defineSetter__('test3', function() { actual = (this === x) });
+
+  try
+  {
+    expect = true;
+    actual = null;
+    x.test3;
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+  }
+  reportCompare(expect, actual, summary + ': x.test3 (1)');
+
+  try
+  {
+    expect = true;
+    actual = null;
+    x.test3 = 5;
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+  }
+  reportCompare(expect, actual, summary + ': x.test3 = 5');
+
+  try
+  {
+    expect = true;
+    actual = null;
+    x.test3;
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+  }
+  reportCompare(expect, actual, summary + ': x.test3 (2)');
+
+  try
+  {
+    var y = ['a', 'b', 'c', 'd'];
+    expect = 4;
+    actual = y.__count__;
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+  }
+  reportCompare(expect, actual, summary + ': y.__count__');
+
+  try
+  {
+    expect = 0;
+    actual = [].__count__;
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+  }
+  reportCompare(expect, actual, summary + ': [].__count__');
+
+  try
+  {
+    expect = 1;
+    actual = [1].__count__;
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+  }
+  reportCompare(expect, actual, summary + ': [1].__count__');
+
+  try
+  {
+    expect = 9;
+    actual = [1,2,3,4,5,6,7,8,9].__count__;
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+  }
+  reportCompare(expect, actual, summary + ': [1].__count__');
+
+  exitFunc ('test');
+}
diff --git a/js/tests/js1_5/extensions/regress-435345-01.js b/js/tests/js1_5/extensions/regress-435345-01.js
new file mode 100755
--- /dev/null
+++ b/js/tests/js1_5/extensions/regress-435345-01.js
@@ -0,0 +1,132 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2007
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Cyrus Omar
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-435345-01.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 435345;
+var summary = 'Watch the length property of arrays';
+var actual = '';
+var expect = '';
+
+// see http://developer.mozilla.org/en/docs/Core_JavaScript_1.5_Reference:Objects:Object:watch
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+  
+  var arr;
+ 
+  try
+  {
+    expect = 'watcher: propname=length, oldval=0, newval=1; ';
+    actual = '';
+    arr = [];
+    arr.watch('length', watcher);
+    arr[0] = '0';
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+  }
+  reportCompare(expect, actual, summary + ': 1');
+
+  try
+  {
+    expect = 'watcher: propname=length, oldval=1, newval=2; ' + 
+      'watcher: propname=length, oldval=2, newval=2; ';
+    actual = '';
+    arr.push(5);
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+  }
+  reportCompare(expect, actual, summary + ': 2');
+
+  try
+  {
+    expect = 'watcher: propname=length, oldval=2, newval=1; ';
+    actual = '';
+    arr.pop();
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+  }
+  reportCompare(expect, actual, summary + ': 3');
+
+  try
+  {
+    expect = 'watcher: propname=length, oldval=1, newval=2; ';
+    actual = '';
+    arr.length++;
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+  }
+  reportCompare(expect, actual, summary + ': 4');
+
+  try
+  {
+    expect = 'watcher: propname=length, oldval=2, newval=5; ';
+    actual = '';
+    arr.length = 5;
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+  }
+  reportCompare(expect, actual, summary + ': 5');
+
+  exitFunc ('test');
+}
+
+function watcher(propname, oldval, newval)
+{
+  actual += 'watcher: propname=' + propname + ', oldval=' + oldval + 
+    ', newval=' + newval + '; ';
+
+  return newval;
+}
+
diff --git a/js/tests/js1_5/extensions/regress-443569.js b/js/tests/js1_5/extensions/regress-443569.js
new file mode 100755
--- /dev/null
+++ b/js/tests/js1_5/extensions/regress-443569.js
@@ -0,0 +1,74 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-443569-01.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 443569;
+var summary = 'Do not assert: OBJ_IS_NATIVE(obj)';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+
+printBugNumber(BUGNUMBER);
+printStatus (summary);
+
+if (typeof window != 'undefined')
+{
+  // delay test driver end
+  gDelayTestDriverEnd = true;
+
+  window.addEventListener("load", boom, false);
+}
+else
+{
+  reportCompare(expect, actual, summary);
+}
+
+function boom()
+{
+  var r = RegExp.prototype;
+  r["-1"] = 0;
+  Array.prototype.__proto__ = r;
+  []["-1"];
+
+  reportCompare(expect, actual, summary);
+
+  gDelayTestDriverEnd = false;
+  jsTestDriverEnd();
+}
+
+
diff --git a/js/tests/js1_8/extensions/regress-422269.js b/js/tests/js1_8/extensions/regress-422269.js
new file mode 100755
--- /dev/null
+++ b/js/tests/js1_8/extensions/regress-422269.js
@@ -0,0 +1,83 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Igor Bukanov
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-422269.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 422269;
+var summary = 'Compile-time let block should not capture runtime references';
+var actual = 'No leak';
+var expect = 'No leak';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+
+  function f()
+  {
+    let m = {sin: Math.sin};
+    (function() { m.sin(1); })();
+    return m;
+  }
+
+  if (typeof countHeap == 'undefined')
+  {
+    expect = actual = 'Test skipped';
+    print('Test skipped. Requires countHeap function.');
+  }
+  else
+  {
+    var x = f();
+    gc();
+    var n = countHeap();
+    x = null;
+    gc();
+
+    var n2 = countHeap();
+    if (n2 >= n)
+      actual = "leak is detected, something roots the result of f";
+  }
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff --git a/js/tests/js1_8/extensions/regress-446169-01.js b/js/tests/js1_8/extensions/regress-446169-01.js
new file mode 100755
--- /dev/null
+++ b/js/tests/js1_8/extensions/regress-446169-01.js
@@ -0,0 +1,82 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2007
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): romaxa
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-446169-01.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 446169;
+var summary = 'Do not assert: Thin_GetWait(tl->owner) in thread-safe build';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+var array = [{}, {}, {}, {}];
+
+function foo() 
+{
+  for (var i = 0; i != 42*42*42; ++i) 
+  {
+    var obj = array[i % array.length];
+    obj["a"+i] = 1;
+    var tmp = {};
+    tmp["a"+i] = 2;
+  }
+}
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  if (typeof scatter == 'function')
+  {
+    scatter([foo, foo, foo, foo]);
+  }
+  else
+  {
+    print('Test skipped. Requires thread-safe build with scatter function.');
+  }
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
+
+
diff --git a/js/tests/js1_8/extensions/regress-446169-02.js b/js/tests/js1_8/extensions/regress-446169-02.js
new file mode 100755
--- /dev/null
+++ b/js/tests/js1_8/extensions/regress-446169-02.js
@@ -0,0 +1,80 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2007
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Igor Bukanov
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-446169-02.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 446169;
+var summary = 'Do not assert: Thin_GetWait(tl->owner) in thread-safe build';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+var array = [];
+for (var i = 0; i != 100*1000; i += 2) {
+    array[i] = i;
+    array[i+1] = i;
+}
+
+var src = array.join(';x');
+
+function f() {
+    new Function(src);
+}
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  if (typeof scatter == 'function')
+  {
+    scatter([f, f, f, f]);
+  }
+  else
+  {
+    print('Test skipped. Requires thread-safe build with scatter function.');
+  }
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
+
+
diff --git a/js/tests/js1_8/regress/regress-427798.js b/js/tests/js1_8/regress/regress-427798.js
new file mode 100755
--- /dev/null
+++ b/js/tests/js1_8/regress/regress-427798.js
@@ -0,0 +1,91 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Igor Bukanov
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-427798.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 427798;
+var summary = 'js_PutBlockObject is slow';
+var actual = 'Good result';
+var expect = 'Good result';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  function f(N)
+  {
+    for (var i = 0; i != N; ++i) {
+      var f, g;
+      {
+        let j = i + 1;
+        f = function() { j += 2; return j; }
+        if (f() != i + 3)
+          throw "Bad result";
+      }
+      if (f() != i + 5)
+        throw "Bad result";
+      {
+        let j = i + 1, k = i + 2;
+        f = function() { j += 2; k++; return j + k; }
+        if (f() != i + i + 6)
+          throw "Bad result";
+      }
+      if (f() != i + i + 9)
+        throw "Bad result";
+    }
+  }
+
+  try
+  {
+    f(20*1000);
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+  }
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff --git a/js/tests/js1_8/regress/regress-433279-01.js b/js/tests/js1_8/regress/regress-433279-01.js
new file mode 100755
--- /dev/null
+++ b/js/tests/js1_8/regress/regress-433279-01.js
@@ -0,0 +1,61 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): nanto_vi (TOYAMA Nao)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-433279-01.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 433279;
+var summary = 'Do not assert: pn != tc->parseContext->nodeList';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  var { sin, PI } = Math; sin(PI / 2);
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff --git a/js/tests/js1_8/regress/regress-433279-02.js b/js/tests/js1_8/regress/regress-433279-02.js
new file mode 100755
--- /dev/null
+++ b/js/tests/js1_8/regress/regress-433279-02.js
@@ -0,0 +1,66 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-433279-02.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 433279;
+var summary = 'Do not assert: pn != tc->parseContext->nodeList';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  try
+  {
+    eval('var {a} = b; c(d + 1);');
+  }
+  catch(ex)
+  {
+  }
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff --git a/js/tests/js1_8/regress/regress-433279-03.js b/js/tests/js1_8/regress/regress-433279-03.js
new file mode 100755
--- /dev/null
+++ b/js/tests/js1_8/regress/regress-433279-03.js
@@ -0,0 +1,66 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s): Jesse Ruderman
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-433279-03.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 433279;
+var summary = 'Do not assert: pn != tc->parseContext->nodeList';
+var actual = 'No Crash';
+var expect = 'No Crash';
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  try
+  {
+    eval('({a}) = b; with({}) { for(let y in z) { } }');
+  }
+  catch(ex)
+  {
+  }
+
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff --git a/js/tests/js1_8/regress/regress-442333-01.js b/js/tests/js1_8/regress/regress-442333-01.js
new file mode 100755
--- /dev/null
+++ b/js/tests/js1_8/regress/regress-442333-01.js
@@ -0,0 +1,70 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is JavaScript Engine testing utilities.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+var gTestfile = 'regress-442333-01.js';
+//-----------------------------------------------------------------------------
+var BUGNUMBER = 442333;
+var summary = 'Remove eval\'s optional second argument';
+var actual = '';
+var expect = '';
+
+
+//-----------------------------------------------------------------------------
+test();
+//-----------------------------------------------------------------------------
+
+function test()
+{
+  enterFunc ('test');
+  printBugNumber(BUGNUMBER);
+  printStatus (summary);
+ 
+  expect = 'ReferenceError: a is not defined';
+  var o = {a : 1};
+
+  try
+  {
+    eval('a', o);
+  }
+  catch(ex)
+  {
+    actual = ex + '';
+  }
+  reportCompare(expect, actual, summary);
+
+  exitFunc ('test');
+}
diff --git a/js/tests/spidermonkey-n-1.9.1.tests b/js/tests/spidermonkey-n-1.9.1.tests
new file mode 100755
--- /dev/null
+++ b/js/tests/spidermonkey-n-1.9.1.tests
@@ -0,0 +1,106 @@
+# Obsolete SpiderMonkey tests
+#
+# invalidated by bug 10278
+#
+js1_2/function/function-001-n.js
+js1_3/Script/function-001-n.js
+js1_3/regress/function-001-n.js
+#
+# WONTFIX bug 119719
+#
+js1_5/Regress/regress-119719.js
+#
+# Spidermonkey now defaults lineNumber and fileName
+# to the location and file where the exception occured.
+# exclude original test which assumes the defaults are
+# 0 and ''
+#
+js1_5/extensions/regress-50447.js
+#
+# Invalid bug
+#
+e4x/Regress/regress-278112.js
+#
+# behavior changed to match MSIE/Opera/etc
+# see bug 309840
+#
+js1_5/Regress/regress-173067.js
+#
+# per comment in bug, this test is obsolete
+# for spidermonkey and rhino.
+#
+ecma_3/Statements/regress-121744.js
+#
+# remove version dependent tests
+# see bug 325921
+#
+js1_2/Array/array_split_1.js
+js1_2/Array/tostring_1.js
+js1_2/Array/tostring_2.js
+js1_2/Objects/toString-001.js
+js1_2/String/concat.js
+js1_2/function/Function_object.js
+js1_2/function/Number.js
+js1_2/function/String.js
+js1_2/function/function-001-n.js
+js1_2/function/length.js
+js1_2/function/regexparg-2-n.js
+js1_2/function/tostring-1.js
+js1_2/function/tostring-2.js
+js1_2/operator/equality.js
+js1_2/regexp/RegExp_lastIndex.js
+js1_2/regexp/string_split.js
+js1_2/version120/boolean-001.js
+js1_2/version120/regress-99663.js
+js1_3/Script/delete-001.js
+js1_3/Script/function-001-n.js
+js1_3/regress/delete-001.js
+js1_3/regress/function-001-n.js
+#
+# tests not yet implemented
+#
+e4x/TypeConversion/10.5.1.js
+e4x/TypeConversion/10.5.js
+e4x/TypeConversion/10.6.1.js
+e4x/TypeConversion/10.6.js
+e4x/Types/9.1.1.10.js
+e4x/Types/9.1.1.11.js
+e4x/Types/9.1.1.12.js
+e4x/Types/9.1.1.13.js
+e4x/Types/9.1.1.4.js
+e4x/Types/9.1.1.5.js
+e4x/Types/9.1.1.7.js
+e4x/Types/9.1.1.8.js
+e4x/Types/9.2.1.10.js
+e4x/Types/9.2.1.3.js
+e4x/Types/9.2.1.4.js
+e4x/Types/9.2.1.5.js
+e4x/Types/9.2.1.6.js
+e4x/Types/9.2.1.7.js
+e4x/XML/13.4.4.1.js
+ecma_2/RegExp/exec-001.js
+ecma_2/String/replace-001.js
+#
+# pre ecma warnings are doa
+#
+js1_5/Regress/regress-106244.js
+#
+# do not ignore unicode formatting chars/trunk - bug 274152
+#
+ecma_3/Unicode/uc-001.js
+#
+# import/export removed in Gecko 1.9.1/SpiderMonkey 1.8.1 - bug 447713
+e4x/Regress/regress-361451.js
+ecma_2/Exceptions/lexical-010.js
+ecma_2/Exceptions/lexical-022.js
+ecma/LexicalConventions/7.4.3-3-n.js
+js1_5/decompilation/regress-349484.js
+js1_5/extensions/regress-355622.js
+js1_5/extensions/regress-418730.js
+js1_5/GetSet/regress-353264.js
+js1_5/Regress/regress-249211.js
+js1_5/Regress/regress-350692.js
+js1_5/Regress/regress-354924.js
+js1_5/Regress/regress-362583.js
+js1_7/extensions/regress-353214-01.js
+js1_7/lexical/regress-346642-03.js
diff --git a/layout/base/crashtests/374193-1.xhtml b/layout/base/crashtests/374193-1.xhtml
new file mode 100644
--- /dev/null
+++ b/layout/base/crashtests/374193-1.xhtml
@@ -0,0 +1,7 @@
+<html xmlns="http://www.w3.org/1999/xhtml"
+  ><mtd xmlns="http://www.w3.org/1998/Math/MathML"
+  ><th xmlns="http://www.w3.org/1999/xhtml"
+  /><mtable xmlns="http://www.w3.org/1998/Math/MathML"
+  ><th xmlns="http://www.w3.org/1999/xhtml" style="-moz-binding: url(374193-1xbl.xml);" id="mw_th20"></th></mtable></mtd><style>
+mtable::after { content:"anonymous text"; }
+</style></html>
diff --git a/layout/reftests/bugs/374193-1xbl.xml b/layout/base/crashtests/374193-1xbl.xml
copy from layout/reftests/bugs/374193-1xbl.xml
copy to layout/base/crashtests/374193-1xbl.xml
diff --git a/layout/base/nsCSSFrameConstructor.cpp b/layout/base/nsCSSFrameConstructor.cpp
--- a/layout/base/nsCSSFrameConstructor.cpp
+++ b/layout/base/nsCSSFrameConstructor.cpp
@@ -145,10 +145,13 @@
 #undef NOISY_FIRST_LETTER
 
 #ifdef MOZ_MATHML
 #include "nsMathMLParts.h"
 #endif
+#ifdef MOZ_SVG
+#include "nsSVGUtils.h"
+#endif
 
 nsIFrame*
 NS_NewHTMLCanvasFrame (nsIPresShell* aPresShell, nsStyleContext* aContext);
 
 #if defined(MOZ_MEDIA)
@@ -1789,10 +1792,11 @@ nsCSSFrameConstructor::nsCSSFrameConstru
 nsCSSFrameConstructor::nsCSSFrameConstructor(nsIDocument *aDocument,
                                              nsIPresShell *aPresShell)
   : mDocument(aDocument)
   , mPresShell(aPresShell)
   , mInitialContainingBlock(nsnull)
+  , mRootElementStyleFrame(nsnull)
   , mFixedContainingBlock(nsnull)
   , mDocElementContainingBlock(nsnull)
   , mGfxScrollFrame(nsnull)
   , mPageSequenceFrame(nsnull)
   , mUpdateCount(0)
@@ -4374,10 +4378,20 @@ nsCSSFrameConstructor::ConstructDocEleme
 
   *aNewFrame = contentFrame;
 
   mInitialContainingBlock = contentFrame;
   mInitialContainingBlockIsAbsPosContainer = PR_FALSE;
+
+  // Figure out which frame has the main style for the document element,
+  // assigning it to mRootElementStyleFrame.
+  // Backgrounds should be propagated from that frame to the viewport.
+  PRBool isChild;
+  contentFrame->GetParentStyleContextFrame(aState.mPresContext,
+          &mRootElementStyleFrame, &isChild);
+  if (!isChild) {
+    mRootElementStyleFrame = mInitialContainingBlock;
+  }
 
   // if it was a table then we don't need to process our children.
   if (!docElemIsTable) {
     // Process the child content
     nsFrameConstructorSaveState absoluteSaveState;
@@ -7142,11 +7156,18 @@ nsCSSFrameConstructor::ConstructSVGFrame
 #endif
   else if (aTag == nsGkAtoms::a) {
     newFrame = NS_NewSVGAFrame(mPresShell, aContent, aStyleContext);
   }
   else if (aTag == nsGkAtoms::text) {
-    newFrame = NS_NewSVGTextFrame(mPresShell, aContent, aStyleContext);
+    nsIFrame *ancestorFrame = SVG_GetFirstNonAAncestorFrame(aParentFrame);
+    if (ancestorFrame) {
+      nsISVGTextContentMetrics* metrics;
+      CallQueryInterface(ancestorFrame, &metrics);
+      // Text cannot be nested
+      if (!metrics)
+        newFrame = NS_NewSVGTextFrame(mPresShell, aContent, aStyleContext);
+    }
   }
   else if (aTag == nsGkAtoms::tspan) {
     nsIFrame *ancestorFrame = SVG_GetFirstNonAAncestorFrame(aParentFrame);
     if (ancestorFrame) {
       nsISVGTextContentMetrics* metrics;
@@ -7642,10 +7663,13 @@ nsCSSFrameConstructor::ReconstructDocEle
           mIsDestroyingFrameTree = wasDestroyingFrameTree;
           if (NS_FAILED(rv)) {
             return rv;
           }
         }
+        
+        mInitialContainingBlock = nsnull;
+        mRootElementStyleFrame = nsnull;
 
         // Create the new document element hierarchy
         nsIFrame* newChild;
         rv = ConstructDocElementFrame(state, rootContent,
                                       mDocElementContainingBlock, &newChild);
@@ -9448,11 +9472,11 @@ nsCSSFrameConstructor::ContentRemoved(ns
       }
     }
 
     if (mInitialContainingBlock == childFrame) {
       mInitialContainingBlock = nsnull;
-      mInitialContainingBlockIsAbsPosContainer = PR_FALSE;
+      mRootElementStyleFrame = nsnull;
     }
 
     if (haveFLS && mInitialContainingBlock) {
       NS_ASSERTION(containingBlock == GetFloatContainingBlock(parentFrame),
                    "What happened here?");
@@ -9812,10 +9836,15 @@ nsCSSFrameConstructor::ProcessRestyledFr
 
     if (hint & nsChangeHint_ReconstructFrame) {
       RecreateFramesForContent(content);
     } else {
       NS_ASSERTION(frame, "This shouldn't happen");
+#ifdef MOZ_SVG
+      if (hint & nsChangeHint_UpdateEffects) {
+        nsSVGUtils::UpdateEffects(frame);
+      }
+#endif
       if (hint & nsChangeHint_ReflowFrame) {
         StyleChangeReflow(frame);
       }
       if (hint & (nsChangeHint_RepaintFrame | nsChangeHint_SyncFrameView)) {
         ApplyRenderingChangeToTree(mPresShell->GetPresContext(), frame, hint);
diff --git a/layout/base/nsCSSFrameConstructor.h b/layout/base/nsCSSFrameConstructor.h
--- a/layout/base/nsCSSFrameConstructor.h
+++ b/layout/base/nsCSSFrameConstructor.h
@@ -246,11 +246,17 @@ public:
                                 PRBool          aIsScrollbar,
                                 nsILayoutHistoryState* aFrameState);
 
   nsresult RemoveMappingsForFrameSubtree(nsIFrame* aRemovedFrame);
 
+  // This is misnamed! This returns the outermost frame for the root element
   nsIFrame* GetInitialContainingBlock() { return mInitialContainingBlock; }
+  // This returns the outermost frame for the root element
+  nsIFrame* GetRootElementFrame() { return mInitialContainingBlock; }
+  // This returns the frame for the root element that does not
+  // have a psuedo-element style
+  nsIFrame* GetRootElementStyleFrame() { return mRootElementStyleFrame; }
   nsIFrame* GetPageSequenceFrame() { return mPageSequenceFrame; }
 
 private:
 
   nsresult ReconstructDocElementHierarchyInternal();
@@ -1142,12 +1148,19 @@ private:
   };
 
   nsIDocument*        mDocument;  // Weak ref
   nsIPresShell*       mPresShell; // Weak ref
 
+  // This is not the real CSS 2.1 "initial containing block"! It is just
+  // the outermost frame for the root element.
   nsIFrame*           mInitialContainingBlock;
+  // This is the frame for the root element that has no pseudo-element style.
+  nsIFrame*           mRootElementStyleFrame;
+  // This is the containing block for fixed-pos frames --- the viewport
   nsIFrame*           mFixedContainingBlock;
+  // This is the containing block that contains the root element ---
+  // the real "initial containing block" according to CSS 2.1.
   nsIFrame*           mDocElementContainingBlock;
   nsIFrame*           mGfxScrollFrame;
   nsIFrame*           mPageSequenceFrame;
   nsQuoteList         mQuoteList;
   nsCounterManager    mCounterManager;
diff --git a/layout/base/nsCSSRendering.cpp b/layout/base/nsCSSRendering.cpp
--- a/layout/base/nsCSSRendering.cpp
+++ b/layout/base/nsCSSRendering.cpp
@@ -76,10 +76,11 @@
 #include "gfxContext.h"
 #include "nsIInterfaceRequestorUtils.h"
 #include "gfxPlatform.h"
 #include "gfxImageSurface.h"
 #include "nsStyleStructInlines.h"
+#include "nsCSSFrameConstructor.h"
 
 #include "nsCSSRenderingBorders.h"
 
 // To avoid storing this data on nsInlineFrame (bloat) and to avoid
 // recalculating this for each frame in a continuation (perf), hold
@@ -261,14 +262,10 @@ protected:
   }
 };
 
 static InlineBackgroundData* gInlineBGData = nsnull;
 
-// FillRect or InvertRect depending on the renderingaInvert parameter
-static void FillOrInvertRect(nsIRenderingContext& aRC,nscoord aX, nscoord aY, nscoord aWidth, nscoord aHeight, PRBool aInvert);
-static void FillOrInvertRect(nsIRenderingContext& aRC,const nsRect& aRect, PRBool aInvert);
-
 // Initialize any static variables used by nsCSSRendering.
 nsresult nsCSSRendering::Init()
 {  
   NS_ASSERTION(!gInlineBGData, "Init called twice");
   gInlineBGData = new InlineBackgroundData();
@@ -409,475 +406,10 @@ nscolor nsCSSRendering::MakeBevelColor(P
   default:
     theColor = colors[0];
     break;
   }
   return theColor;
-}
-
-// Maximum poly points in any of the polygons we generate below
-#define MAX_POLY_POINTS 4
-
-#define ACTUAL_THICKNESS(outside, inside, frac, tpp) \
-  (NSToCoordRound(((outside) - (inside)) * (frac) / (tpp)) * (tpp))
-
-
-/**
- * Draw a dotted/dashed sides of a box
- */
-//XXX dashes which span more than two edges are not handled properly MMP
-void nsCSSRendering::DrawDashedSides(PRIntn startSide,
-                                     nsIRenderingContext& aContext,
-                   /* XXX unused */  const nsRect& aDirtyRect,
-                                     const PRUint8 borderStyles[],  
-                                     const nscolor borderColors[],  
-                                     const nsRect& borderOutside,
-                                     const nsRect& borderInside,
-                                     PRIntn aSkipSides,
-                   /* XXX unused */  nsRect* aGap)
-{
-PRIntn  dashLength;
-nsRect  dashRect, firstRect, currRect;
-PRBool  bSolid = PR_TRUE;
-float   over = 0.0f;
-PRUint8 style = borderStyles[startSide];  
-PRBool  skippedSide = PR_FALSE;
-
-  for (PRIntn whichSide = startSide; whichSide < 4; whichSide++) {
-    PRUint8 prevStyle = style;
-    style = borderStyles[whichSide];  
-    if ((1<<whichSide) & aSkipSides) {
-      // Skipped side
-      skippedSide = PR_TRUE;
-      continue;
-    }
-    if ((style == NS_STYLE_BORDER_STYLE_DASHED) ||
-        (style == NS_STYLE_BORDER_STYLE_DOTTED))
-    {
-      if ((style != prevStyle) || skippedSide) {
-        //style discontinuity
-        over = 0.0f;
-        bSolid = PR_TRUE;
-      }
-
-      // XXX units for dash & dot?
-      if (style == NS_STYLE_BORDER_STYLE_DASHED) {
-        dashLength = DASH_LENGTH;
-      } else {
-        dashLength = DOT_LENGTH;
-      }
-
-      aContext.SetColor(borderColors[whichSide]);  
-      switch (whichSide) {
-      case NS_SIDE_LEFT:
-        //XXX need to properly handle wrap around from last edge to first edge
-        //(this is the first edge) MMP
-        dashRect.width = borderInside.x - borderOutside.x;
-        dashRect.height = nscoord(dashRect.width * dashLength);
-        dashRect.x = borderOutside.x;
-        dashRect.y = borderInside.YMost() - dashRect.height;
-
-        if (over > 0.0f) {
-          firstRect.x = dashRect.x;
-          firstRect.width = dashRect.width;
-          firstRect.height = nscoord(dashRect.height * over);
-          firstRect.y = dashRect.y + (dashRect.height - firstRect.height);
-          over = 0.0f;
-          currRect = firstRect;
-        } else {
-          currRect = dashRect;
-        }
-
-        while (currRect.YMost() > borderInside.y) {
-          //clip if necessary
-          if (currRect.y < borderInside.y) {
-            over = float(borderInside.y - dashRect.y) /
-              float(dashRect.height);
-            currRect.height = currRect.height - (borderInside.y - currRect.y);
-            currRect.y = borderInside.y;
-          }
-
-          //draw if necessary
-          if (bSolid) {
-            aContext.FillRect(currRect);
-          }
-
-          //setup for next iteration
-          if (over == 0.0f) {
-            bSolid = PRBool(!bSolid);
-          }
-          dashRect.y = dashRect.y - currRect.height;
-          currRect = dashRect;
-        }
-        break;
-
-      case NS_SIDE_TOP:
-        //if we are continuing a solid rect, fill in the corner first
-        if (bSolid) {
-          aContext.FillRect(borderOutside.x, borderOutside.y,
-                            borderInside.x - borderOutside.x,
-                            borderInside.y - borderOutside.y);
-        }
-
-        dashRect.height = borderInside.y - borderOutside.y;
-        dashRect.width = dashRect.height * dashLength;
-        dashRect.x = borderInside.x;
-        dashRect.y = borderOutside.y;
-
-        if (over > 0.0f) {
-          firstRect.x = dashRect.x;
-          firstRect.y = dashRect.y;
-          firstRect.width = nscoord(dashRect.width * over);
-          firstRect.height = dashRect.height;
-          over = 0.0f;
-          currRect = firstRect;
-        } else {
-          currRect = dashRect;
-        }
-
-        while (currRect.x < borderInside.XMost()) {
-          //clip if necessary
-          if (currRect.XMost() > borderInside.XMost()) {
-            over = float(dashRect.XMost() - borderInside.XMost()) /
-              float(dashRect.width);
-            currRect.width = currRect.width -
-              (currRect.XMost() - borderInside.XMost());
-          }
-
-          //draw if necessary
-          if (bSolid) {
-            aContext.FillRect(currRect);
-          }
-
-          //setup for next iteration
-          if (over == 0.0f) {
-            bSolid = PRBool(!bSolid);
-          }
-          dashRect.x = dashRect.x + currRect.width;
-          currRect = dashRect;
-        }
-        break;
-
-      case NS_SIDE_RIGHT:
-        //if we are continuing a solid rect, fill in the corner first
-        if (bSolid) {
-          aContext.FillRect(borderInside.XMost(), borderOutside.y,
-                            borderOutside.XMost() - borderInside.XMost(),
-                            borderInside.y - borderOutside.y);
-        }
-
-        dashRect.width = borderOutside.XMost() - borderInside.XMost();
-        dashRect.height = nscoord(dashRect.width * dashLength);
-        dashRect.x = borderInside.XMost();
-        dashRect.y = borderInside.y;
-
-        if (over > 0.0f) {
-          firstRect.x = dashRect.x;
-          firstRect.y = dashRect.y;
-          firstRect.width = dashRect.width;
-          firstRect.height = nscoord(dashRect.height * over);
-          over = 0.0f;
-          currRect = firstRect;
-        } else {
-          currRect = dashRect;
-        }
-
-        while (currRect.y < borderInside.YMost()) {
-          //clip if necessary
-          if (currRect.YMost() > borderInside.YMost()) {
-            over = float(dashRect.YMost() - borderInside.YMost()) /
-              float(dashRect.height);
-            currRect.height = currRect.height -
-              (currRect.YMost() - borderInside.YMost());
-          }
-
-          //draw if necessary
-          if (bSolid) {
-            aContext.FillRect(currRect);
-          }
-
-          //setup for next iteration
-          if (over == 0.0f) {
-            bSolid = PRBool(!bSolid);
-          }
-          dashRect.y = dashRect.y + currRect.height;
-          currRect = dashRect;
-        }
-        break;
-
-      case NS_SIDE_BOTTOM:
-        //if we are continuing a solid rect, fill in the corner first
-        if (bSolid) {
-          aContext.FillRect(borderInside.XMost(), borderInside.YMost(),
-                            borderOutside.XMost() - borderInside.XMost(),
-                            borderOutside.YMost() - borderInside.YMost());
-        }
-
-        dashRect.height = borderOutside.YMost() - borderInside.YMost();
-        dashRect.width = nscoord(dashRect.height * dashLength);
-        dashRect.x = borderInside.XMost() - dashRect.width;
-        dashRect.y = borderInside.YMost();
-
-        if (over > 0.0f) {
-          firstRect.y = dashRect.y;
-          firstRect.width = nscoord(dashRect.width * over);
-          firstRect.height = dashRect.height;
-          firstRect.x = dashRect.x + (dashRect.width - firstRect.width);
-          over = 0.0f;
-          currRect = firstRect;
-        } else {
-          currRect = dashRect;
-        }
-
-        while (currRect.XMost() > borderInside.x) {
-          //clip if necessary
-          if (currRect.x < borderInside.x) {
-            over = float(borderInside.x - dashRect.x) / float(dashRect.width);
-            currRect.width = currRect.width - (borderInside.x - currRect.x);
-            currRect.x = borderInside.x;
-          }
-
-          //draw if necessary
-          if (bSolid) {
-            aContext.FillRect(currRect);
-          }
-
-          //setup for next iteration
-          if (over == 0.0f) {
-            bSolid = PRBool(!bSolid);
-          }
-          dashRect.x = dashRect.x - currRect.width;
-          currRect = dashRect;
-        }
-        break;
-      }
-    }
-    skippedSide = PR_FALSE;
-  }
-}
-
-/** ---------------------------------------------------
- *  See documentation in nsCSSRendering.h
- *  @update 10/22/99 dwc
- */
-void nsCSSRendering::DrawDashedSides(PRIntn startSide,
-                                     nsIRenderingContext& aContext,
-                                     const nsRect& aDirtyRect,
-                                     const nsStyleColor* aColorStyle,
-                                     const nsStyleBorder* aBorderStyle,  
-                                     const nsStyleOutline* aOutlineStyle,  
-                                     PRBool aDoOutline,
-                                     const nsRect& borderOutside,
-                                     const nsRect& borderInside,
-                                     PRIntn aSkipSides,
-                   /* XXX unused */  nsRect* aGap)
-{
-
-PRIntn  dashLength;
-nsRect  dashRect, currRect;
-nscoord temp, temp1, adjust;
-PRBool  bSolid = PR_TRUE;
-float   over = 0.0f;
-PRBool  skippedSide = PR_FALSE;
-
-  NS_ASSERTION(aColorStyle &&
-               ((aDoOutline && aOutlineStyle) || (!aDoOutline && aBorderStyle)),
-               "null params not allowed");
-  PRUint8 style = aDoOutline
-                  ? aOutlineStyle->GetOutlineStyle()
-                  : aBorderStyle->GetBorderStyle(startSide);  
-
-  // find the x and y width
-  nscoord xwidth = aDirtyRect.XMost();
-  nscoord ywidth = aDirtyRect.YMost();
-
-  for (PRIntn whichSide = startSide; whichSide < 4; whichSide++) {
-    PRUint8 prevStyle = style;
-    style = aDoOutline
-              ? aOutlineStyle->GetOutlineStyle()
-              : aBorderStyle->GetBorderStyle(whichSide);  
-    if ((1<<whichSide) & aSkipSides) {
-      // Skipped side
-      skippedSide = PR_TRUE;
-      continue;
-    }
-    if ((style == NS_STYLE_BORDER_STYLE_DASHED) ||
-        (style == NS_STYLE_BORDER_STYLE_DOTTED))
-    {
-      if ((style != prevStyle) || skippedSide) {
-        //style discontinuity
-        over = 0.0f;
-        bSolid = PR_TRUE;
-      }
-
-      if (style == NS_STYLE_BORDER_STYLE_DASHED) {
-        dashLength = DASH_LENGTH;
-      } else {
-        dashLength = DOT_LENGTH;
-      }
-
-      // default to current color in case color cannot be resolved
-      // (because invert is not supported on cur platform)
-      nscolor sideColor(aColorStyle->mColor);
-
-      PRBool  isInvert = PR_FALSE;
-      if (aDoOutline) {
-        if (!aOutlineStyle->GetOutlineInitialColor()) {
-          aOutlineStyle->GetOutlineColor(sideColor);
-        }
-#ifdef GFX_HAS_INVERT
-        else {
-          isInvert = PR_TRUE;
-        }
-#endif
-      } else {
-        PRBool transparent; 
-        PRBool foreground;
-        aBorderStyle->GetBorderColor(whichSide, sideColor, transparent, foreground);
-        if (foreground)
-          sideColor = aColorStyle->mColor;
-        if (transparent)
-          continue; // side is transparent
-      }
-      aContext.SetColor(sideColor);  
-
-      switch (whichSide) {
-      case NS_SIDE_RIGHT:
-      case NS_SIDE_LEFT:
-        bSolid = PR_FALSE;
-        
-        // This is our dot or dash..
-        if(whichSide==NS_SIDE_LEFT){ 
-          dashRect.width = borderInside.x - borderOutside.x;
-        } else {
-          dashRect.width = borderOutside.XMost() - borderInside.XMost();
-        }
-        if( dashRect.width >0 ) {
-          dashRect.height = dashRect.width * dashLength;
-          dashRect.y = borderOutside.y;
-
-          if(whichSide == NS_SIDE_RIGHT){
-            dashRect.x = borderInside.XMost();
-          } else {
-            dashRect.x = borderOutside.x;
-          }
-
-          temp = borderOutside.height;
-          temp1 = temp/dashRect.height;
-
-          currRect = dashRect;
-
-          if((temp1%2)==0){
-            adjust = (dashRect.height-(temp%dashRect.height))/2; // adjust back
-            // draw in the left and right
-            FillOrInvertRect(aContext,  dashRect.x, borderOutside.y,dashRect.width, dashRect.height-adjust,isInvert);
-            FillOrInvertRect(aContext,dashRect.x,(borderOutside.YMost()-(dashRect.height-adjust)),dashRect.width, dashRect.height-adjust,isInvert);
-            currRect.y += (dashRect.height-adjust);
-            temp-= (dashRect.height-adjust);
-          } else {
-            adjust = (temp%dashRect.width)/2;                   // adjust a tad longer
-            // draw in the left and right
-            FillOrInvertRect(aContext, dashRect.x, borderOutside.y,dashRect.width, dashRect.height+adjust,isInvert);
-            FillOrInvertRect(aContext, dashRect.x,(borderOutside.YMost()-(dashRect.height+adjust)),dashRect.width, dashRect.height+adjust,isInvert);
-            currRect.y += (dashRect.height+adjust);
-            temp-= (dashRect.height+adjust);
-          }
-        
-          temp += borderOutside.y;
-          if( temp > ywidth)
-            temp = ywidth;
-
-          // get the currRect's x into the view before we start
-          if( currRect.y < aDirtyRect.y){
-            temp1 = NSToCoordFloor((float)((aDirtyRect.y-currRect.y)/dashRect.height));
-            currRect.y += temp1*dashRect.height;
-            if((temp1%2)==1){
-              bSolid = PR_TRUE;
-            }
-          }
-
-          while(currRect.y<temp) {
-            //draw if necessary
-            if (bSolid) {
-              FillOrInvertRect(aContext, currRect,isInvert);
-            }
-
-            bSolid = PRBool(!bSolid);
-            currRect.y += dashRect.height;
-          }
-        }
-        break;
-
-      case NS_SIDE_BOTTOM:
-      case NS_SIDE_TOP:
-        bSolid = PR_FALSE;
-        
-        // This is our dot or dash..
-
-        if(whichSide==NS_SIDE_TOP){ 
-          dashRect.height = borderInside.y - borderOutside.y;
-        } else {
-          dashRect.height = borderOutside.YMost() - borderInside.YMost();
-        }
-        if( dashRect.height >0 ) {
-          dashRect.width = dashRect.height * dashLength;
-          dashRect.x = borderOutside.x;
-
-          if(whichSide == NS_SIDE_BOTTOM){
-            dashRect.y = borderInside.YMost();
-          } else {
-            dashRect.y = borderOutside.y;
-          }
-
-          temp = borderOutside.width;
-          temp1 = temp/dashRect.width;
-
-          currRect = dashRect;
-
-          if((temp1%2)==0){
-            adjust = (dashRect.width-(temp%dashRect.width))/2;     // even, adjust back
-            // draw in the left and right
-            FillOrInvertRect(aContext, borderOutside.x,dashRect.y,dashRect.width-adjust,dashRect.height,isInvert);
-            FillOrInvertRect(aContext, (borderOutside.XMost()-(dashRect.width-adjust)),dashRect.y,dashRect.width-adjust,dashRect.height,isInvert);
-            currRect.x += (dashRect.width-adjust);
-            temp-= (dashRect.width-adjust);
-          } else {
-            adjust = (temp%dashRect.width)/2;
-            // draw in the left and right
-            FillOrInvertRect(aContext, borderOutside.x,dashRect.y,dashRect.width+adjust,dashRect.height,isInvert);
-            FillOrInvertRect(aContext, (borderOutside.XMost()-(dashRect.width+adjust)),dashRect.y,dashRect.width+adjust,dashRect.height,isInvert);
-            currRect.x += (dashRect.width+adjust);
-            temp-= (dashRect.width+adjust);
-          }
-       
-          temp += borderOutside.x;
-          if( temp > xwidth)
-            temp = xwidth;
-
-          // get the currRect's x into the view before we start
-          if( currRect.x < aDirtyRect.x){
-            temp1 = NSToCoordFloor((float)((aDirtyRect.x-currRect.x)/dashRect.width));
-            currRect.x += temp1*dashRect.width;
-            if((temp1%2)==1){
-              bSolid = PR_TRUE;
-            }
-          }
-
-          while(currRect.x<temp) {
-            //draw if necessary
-            if (bSolid) {
-              FillOrInvertRect(aContext, currRect,isInvert);
-            }
-
-            bSolid = PRBool(!bSolid);
-            currRect.x += dashRect.width;
-          }
-        }
-      break;
-      }
-    }
-    skippedSide = PR_FALSE;
-  }
 }
 
 nscolor
 nsCSSRendering::TransformColor(nscolor  aMapColor,PRBool aNoBackGround)
 {
@@ -986,18 +518,14 @@ nsCSSRendering::PaintBorder(nsPresContex
                             nsIFrame* aForFrame,
                             const nsRect& aDirtyRect,
                             const nsRect& aBorderArea,
                             const nsStyleBorder& aBorderStyle,
                             nsStyleContext* aStyleContext,
-                            PRIntn aSkipSides,
-                            nsRect* aGap,
-                            nscoord aHardBorderSize,
-                            PRBool  aShouldIgnoreRounded)
+                            PRIntn aSkipSides)
 {
   nsMargin            border;
   nscoord             twipsRadii[4];
-  float               percent;
   nsCompatibility     compatMode = aPresContext->CompatibilityMode();
 
   SN("++ PaintBorder");
 
   // Check to see if we have an appearance defined.  If so, we let the theme
@@ -1010,11 +538,11 @@ nsCSSRendering::PaintBorder(nsPresContex
       return; // Let the theme handle it.
   }
 
   if (aBorderStyle.IsBorderImageLoaded()) {
     DrawBorderImage(aPresContext, aRenderingContext, aForFrame,
-                    aBorderArea, aBorderStyle, aHardBorderSize);
+                    aBorderArea, aBorderStyle);
     return;
   }
   
   // Get our style context's color struct.
   const nsStyleColor* ourColor = aStyleContext->GetStyleColor();
@@ -1022,16 +550,11 @@ nsCSSRendering::PaintBorder(nsPresContex
   // in NavQuirks mode we want to use the parent's context as a starting point
   // for determining the background color
   const nsStyleBackground* bgColor = nsCSSRendering::FindNonTransparentBackground
     (aStyleContext, compatMode == eCompatibility_NavQuirks ? PR_TRUE : PR_FALSE);
 
-  if (aHardBorderSize > 0) {
-    border.SizeTo(aHardBorderSize, aHardBorderSize, aHardBorderSize, aHardBorderSize);
-  } else {
-    border = aBorderStyle.GetComputedBorder();
-  }
-
+  border = aBorderStyle.GetComputedBorder();
   if ((0 == border.left) && (0 == border.right) &&
       (0 == border.top) && (0 == border.bottom)) {
     // Empty border area
     return;
   }
@@ -1100,25 +623,20 @@ nsCSSRendering::PaintBorder(nsPresContex
   ctx->Restore();
 #endif
 
   //SF ("borderRadii: %f %f %f %f\n", borderRadii[0], borderRadii[1], borderRadii[2], borderRadii[3]);
 
-  gfxRect gapRect;
-  if (aGap)
-    gapRect = RectToGfxRect(*aGap, twipsPerPixel);
-
   nsCSSBorderRenderer br(twipsPerPixel,
                          ctx,
                          oRect,
                          borderStyles,
                          borderWidths,
                          borderRadii,
                          borderColors,
                          compositeColors,
                          aSkipSides,
-                         bgColor->mBackgroundColor,
-                         aGap ? &gapRect : nsnull);
+                         bgColor->mBackgroundColor);
   br.DrawBorders();
 
   ctx->Restore();
 
   SN();
@@ -1130,12 +648,11 @@ nsCSSRendering::PaintOutline(nsPresConte
                              nsIFrame* aForFrame,
                              const nsRect& aDirtyRect,
                              const nsRect& aBorderArea,
                              const nsStyleBorder& aBorderStyle,
                              const nsStyleOutline& aOutlineStyle,
-                             nsStyleContext* aStyleContext,
-                             nsRect* aGap)
+                             nsStyleContext* aStyleContext)
 {
   nscoord             twipsRadii[4];
 
   // Get our style context's color struct.
   const nsStyleColor* ourColor = aStyleContext->GetStyleColor();
@@ -1240,12 +757,10 @@ nsCSSRendering::PaintOutline(nsPresConte
   nscolor outlineColors[4] = { outlineColor,
                                outlineColor,
                                outlineColor,
                                outlineColor };
 
-  nsBorderColors *outlineCompositeColors[4] = { nsnull };
-
   // convert the border widths
   gfxFloat outlineWidths[4] = { width / twipsPerPixel,
                                 width / twipsPerPixel,
                                 width / twipsPerPixel,
                                 width / twipsPerPixel };
@@ -1253,25 +768,74 @@ nsCSSRendering::PaintOutline(nsPresConte
   // start drawing
   gfxContext *ctx = aRenderingContext.ThebesContext();
 
   ctx->Save();
 
-  gfxRect gapRect;
-  if (aGap)
-    gapRect = RectToGfxRect(*aGap, twipsPerPixel);
-
   nsCSSBorderRenderer br(twipsPerPixel,
                          ctx,
                          oRect,
                          outlineStyles,
                          outlineWidths,
                          outlineRadii,
                          outlineColors,
-                         outlineCompositeColors,
-                         0,
-                         bgColor->mBackgroundColor,
-                         aGap ? &gapRect : nsnull);
+                         nsnull, 0,
+                         bgColor->mBackgroundColor);
+  br.DrawBorders();
+
+  ctx->Restore();
+
+  SN();
+}
+
+void
+nsCSSRendering::PaintFocus(nsPresContext* aPresContext,
+                           nsIRenderingContext& aRenderingContext,
+                           const nsRect& aFocusRect,
+                           nscolor aColor)
+{
+  nscoord oneCSSPixel = nsPresContext::CSSPixelsToAppUnits(1);
+  nscoord oneDevPixel = aPresContext->DevPixelsToAppUnits(1);
+
+  gfxRect focusRect(RectToGfxRect(aFocusRect, oneDevPixel));
+
+  gfxCornerSizes focusRadii;
+  {
+    nscoord twipsRadii[4] = { 0, 0, 0, 0 };
+    nsMargin focusMargin(oneCSSPixel, oneCSSPixel, oneCSSPixel, oneCSSPixel);
+    ComputePixelRadii(twipsRadii, aFocusRect, focusMargin, 0, oneDevPixel,
+                      &focusRadii);
+  }
+  gfxFloat focusWidths[4] = { oneCSSPixel / oneDevPixel,
+                              oneCSSPixel / oneDevPixel,
+                              oneCSSPixel / oneDevPixel,
+                              oneCSSPixel / oneDevPixel };
+
+  PRUint8 focusStyles[4] = { NS_STYLE_BORDER_STYLE_DOTTED,
+                             NS_STYLE_BORDER_STYLE_DOTTED,
+                             NS_STYLE_BORDER_STYLE_DOTTED,
+                             NS_STYLE_BORDER_STYLE_DOTTED };
+  nscolor focusColors[4] = { aColor, aColor, aColor, aColor };
+
+  gfxContext *ctx = aRenderingContext.ThebesContext();
+
+  ctx->Save();
+
+  // Because this renders a dotted border, the background color
+  // should not be used.  Therefore, we provide a value that will
+  // be blatantly wrong if it ever does get used.  (If this becomes
+  // something that CSS can style, this function will then have access
+  // to a style context and can use the same logic that PaintBorder
+  // and PaintOutline do.)
+  nsCSSBorderRenderer br(oneDevPixel,
+                         ctx,
+                         focusRect,
+                         focusStyles,
+                         focusWidths,
+                         focusRadii,
+                         focusColors,
+                         nsnull, 0,
+                         NS_RGB(255, 0, 0));
   br.DrawBorders();
 
   ctx->Restore();
 
   SN();
@@ -1442,84 +1006,56 @@ nsCSSRendering::FindNonTransparentBackgr
  * whether the frame is the canvas frame to allow PaintBackground to
  * ensure that it always paints something non-transparent for the
  * canvas.
  */
 
-// Returns nsnull if aFrame is not a canvas frame.
-// Otherwise, it returns the frame we should look for the background on.
-// This is normally aFrame but if aFrame is the viewport, we need to
-// look for the background starting at the scroll root (which shares
-// style context with the document root) or the document root itself.
+// Returns true if aFrame is a canvas frame.
 // We need to treat the viewport as canvas because, even though
 // it does not actually paint a background, we need to get the right
 // background style so we correctly detect transparent documents.
-inline nsIFrame*
+inline PRBool
 IsCanvasFrame(nsIFrame *aFrame)
 {
   nsIAtom* frameType = aFrame->GetType();
-  if (frameType == nsGkAtoms::canvasFrame ||
-      frameType == nsGkAtoms::rootFrame ||
-      frameType == nsGkAtoms::pageFrame ||
-      frameType == nsGkAtoms::pageContentFrame) {
-    return aFrame;
-  } else if (frameType == nsGkAtoms::viewportFrame) {
-    nsIFrame* firstChild = aFrame->GetFirstChild(nsnull);
-    if (firstChild) {
-      return firstChild;
-    }
-  }
-  
-  return nsnull;
+  return frameType == nsGkAtoms::canvasFrame ||
+         frameType == nsGkAtoms::rootFrame ||
+         frameType == nsGkAtoms::pageFrame ||
+         frameType == nsGkAtoms::pageContentFrame ||
+         frameType == nsGkAtoms::viewportFrame;
 }
 
 inline PRBool
-FindCanvasBackground(nsIFrame* aForFrame,
+FindCanvasBackground(nsIFrame* aForFrame, nsIFrame* aRootElementFrame,
                      const nsStyleBackground** aBackground)
 {
-  // XXXldb What if the root element is positioned, etc.?  (We don't
-  // allow that yet, do we?)
-  nsIFrame *firstChild = aForFrame->GetFirstChild(nsnull);
-  if (firstChild) {
-    const nsStyleBackground* result = firstChild->GetStyleBackground();
-    nsIFrame* topFrame = aForFrame;
-
-    if (firstChild->GetType() == nsGkAtoms::pageContentFrame) {
-      topFrame = firstChild->GetFirstChild(nsnull);
-      NS_ASSERTION(topFrame,
-                   "nsPageContentFrame is missing a normal flow child");
-      if (!topFrame) {
-        return PR_FALSE;
-      }
-      NS_ASSERTION(topFrame->GetContent(),
-                   "nsPageContentFrame child without content");
-      result = topFrame->GetStyleBackground();
-    }
+  if (aRootElementFrame) {
+    const nsStyleBackground* result = aRootElementFrame->GetStyleBackground();
 
     // Check if we need to do propagation from BODY rather than HTML.
     if (result->IsTransparent()) {
-      nsIContent* content = topFrame->GetContent();
-      if (content) {
-        // Use |GetOwnerDoc| so it works during destruction.
-        nsIDocument* document = content->GetOwnerDoc();
-        nsCOMPtr<nsIHTMLDocument> htmlDoc = do_QueryInterface(document);
-        if (htmlDoc) {
-          nsIContent* bodyContent = htmlDoc->GetBodyContentExternal();
-          // We need to null check the body node (bug 118829) since
-          // there are cases, thanks to the fix for bug 5569, where we
-          // will reflow a document with no body.  In particular, if a
-          // SCRIPT element in the head blocks the parser and then has a
-          // SCRIPT that does "document.location.href = 'foo'", then
-          // nsParser::Terminate will call |DidBuildModel| methods
-          // through to the content sink, which will call |StartLayout|
-          // and thus |InitialReflow| on the pres shell.  See bug 119351
-          // for the ugly details.
-          if (bodyContent) {
-            nsIFrame *bodyFrame = aForFrame->PresContext()->GetPresShell()->
-              GetPrimaryFrameFor(bodyContent);
-            if (bodyFrame)
-              result = bodyFrame->GetStyleBackground();
-          }
+      nsIContent* content = aRootElementFrame->GetContent();
+      // The root element content can't be null. We wouldn't know what
+      // frame to create for aRootElementFrame.
+      // Use |GetOwnerDoc| so it works during destruction.
+      nsIDocument* document = content->GetOwnerDoc();
+      nsCOMPtr<nsIHTMLDocument> htmlDoc = do_QueryInterface(document);
+      if (htmlDoc) {
+        nsIContent* bodyContent = htmlDoc->GetBodyContentExternal();
+        // We need to null check the body node (bug 118829) since
+        // there are cases, thanks to the fix for bug 5569, where we
+        // will reflow a document with no body.  In particular, if a
+        // SCRIPT element in the head blocks the parser and then has a
+        // SCRIPT that does "document.location.href = 'foo'", then
+        // nsParser::Terminate will call |DidBuildModel| methods
+        // through to the content sink, which will call |StartLayout|
+        // and thus |InitialReflow| on the pres shell.  See bug 119351
+        // for the ugly details.
+        if (bodyContent) {
+          nsIFrame *bodyFrame = aForFrame->PresContext()->GetPresShell()->
+            GetPrimaryFrameFor(bodyContent);
+          if (bodyFrame)
+            result = bodyFrame->GetStyleBackground();
         }
       }
     }
 
     *aBackground = result;
@@ -1532,39 +1068,31 @@ FindCanvasBackground(nsIFrame* aForFrame
   
   return PR_TRUE;
 }
 
 inline PRBool
-FindElementBackground(nsIFrame* aForFrame,
+FindElementBackground(nsIFrame* aForFrame, nsIFrame* aRootElementFrame,
                       const nsStyleBackground** aBackground)
 {
-  nsIFrame *parentFrame = aForFrame->GetParent();
-  // XXXldb We shouldn't have to null-check |parentFrame| here.
-  if (parentFrame && IsCanvasFrame(parentFrame) == parentFrame) {
-    // Check that we're really the root (rather than in another child list).
-    nsIFrame *childFrame = parentFrame->GetFirstChild(nsnull);
-    if (childFrame == aForFrame)
-      return PR_FALSE; // Background was already drawn for the canvas.
+  if (aForFrame == aRootElementFrame) {
+    // We must have propagated our background to the viewport or canvas. Abort.
+    return PR_FALSE;
   }
 
   *aBackground = aForFrame->GetStyleBackground();
 
   // Return true unless the frame is for a BODY element whose background
   // was propagated to the viewport.
 
+  nsIContent* content = aForFrame->GetContent();
+  if (!content || content->Tag() != nsGkAtoms::body)
+    return PR_TRUE; // not frame for a "body" element
+  // It could be a non-HTML "body" element but that's OK, we'd fail the
+  // bodyContent check below
+
   if (aForFrame->GetStyleContext()->GetPseudoType())
     return PR_TRUE; // A pseudo-element frame.
-
-  nsIContent* content = aForFrame->GetContent();
-  if (!content || !content->IsNodeOfType(nsINode::eHTML))
-    return PR_TRUE;  // not frame for an HTML element
-
-  if (!parentFrame)
-    return PR_TRUE; // no parent to look at
-
-  if (content->Tag() != nsGkAtoms::body)
-    return PR_TRUE; // not frame for <BODY> element
 
   // We should only look at the <html> background if we're in an HTML document
   nsIDocument* document = content->GetOwnerDoc();
   nsCOMPtr<nsIHTMLDocument> htmlDoc = do_QueryInterface(document);
   if (!htmlDoc)
@@ -1572,25 +1100,33 @@ FindElementBackground(nsIFrame* aForFram
 
   nsIContent* bodyContent = htmlDoc->GetBodyContentExternal();
   if (bodyContent != content)
     return PR_TRUE; // this wasn't the background that was propagated
 
-  const nsStyleBackground* htmlBG = parentFrame->GetStyleBackground();
+  // This can be called even when there's no root element yet, during frame
+  // construction, via nsLayoutUtils::FrameHasTransparency and
+  // nsContainerFrame::SyncFrameViewProperties.
+  if (!aRootElementFrame)
+    return PR_TRUE;
+
+  const nsStyleBackground* htmlBG = aRootElementFrame->GetStyleBackground();
   return !htmlBG->IsTransparent();
 }
 
 PRBool
 nsCSSRendering::FindBackground(nsPresContext* aPresContext,
                                nsIFrame* aForFrame,
                                const nsStyleBackground** aBackground,
                                PRBool* aIsCanvas)
 {
-  nsIFrame* canvasFrame = IsCanvasFrame(aForFrame);
-  *aIsCanvas = canvasFrame != nsnull;
-  return canvasFrame
-      ? FindCanvasBackground(canvasFrame, aBackground)
-      : FindElementBackground(aForFrame, aBackground);
+  nsIFrame* rootElementFrame =
+    aPresContext->PresShell()->FrameConstructor()->GetRootElementStyleFrame();
+  PRBool isCanvasFrame = IsCanvasFrame(aForFrame);
+  *aIsCanvas = isCanvasFrame;
+  return isCanvasFrame
+      ? FindCanvasBackground(aForFrame, rootElementFrame, aBackground)
+      : FindElementBackground(aForFrame, rootElementFrame, aBackground);
 }
 
 void
 nsCSSRendering::DidPaint()
 {
@@ -2360,26 +1896,20 @@ void
 void
 nsCSSRendering::DrawBorderImage(nsPresContext* aPresContext,
                                 nsIRenderingContext& aRenderingContext,
                                 nsIFrame* aForFrame,
                                 const nsRect& aBorderArea,
-                                const nsStyleBorder& aBorderStyle,
-                                nscoord aHardBorderSize)
+                                const nsStyleBorder& aBorderStyle)
 {
     float percent;
     nsStyleCoord borderImageSplit[4];
     PRInt32 borderImageSplitInt[4];
     nsMargin border;
     gfxFloat borderTop, borderRight, borderBottom, borderLeft;
     gfxFloat borderImageSplitGfx[4];
 
-    if (aHardBorderSize > 0) {
-      border.SizeTo(aHardBorderSize, aHardBorderSize, aHardBorderSize, aHardBorderSize);
-    } else {
-      border = aBorderStyle.GetActualBorder();
-    }
-
+    border = aBorderStyle.GetActualBorder();
     if ((0 == border.left) && (0 == border.right) &&
         (0 == border.top) && (0 == border.bottom)) {
       // Empty border area
       return;
     }
@@ -2869,36 +2399,10 @@ nsCSSRendering::PaintRoundedBackground(n
   ctx->RoundedRectangle(oRect, radii);
   ctx->SetColor(gfxRGBA(color));
   ctx->Fill();
 }
 
-
-void FillOrInvertRect(nsIRenderingContext& aRC, nscoord aX, nscoord aY, nscoord aWidth, nscoord aHeight, PRBool aInvert)
-{
-#ifdef GFX_HAS_INVERT
-  if (aInvert) {
-    aRC.InvertRect(aX, aY, aWidth, aHeight);
-  } else {
-#endif
-    aRC.FillRect(aX, aY, aWidth, aHeight);
-#ifdef GFX_HAS_INVERT
-  }
-#endif
-}
-
-void FillOrInvertRect(nsIRenderingContext& aRC, const nsRect& aRect, PRBool aInvert)
-{
-#ifdef GFX_HAS_INVERT
-  if (aInvert) {
-    aRC.InvertRect(aRect);
-  } else {
-#endif
-    aRC.FillRect(aRect);
-#ifdef GFX_HAS_INVERT
-  }
-#endif
-}
 
 // Begin table border-collapsing section
 // These functions were written to not disrupt the normal ones and yet satisfy some additional requirements
 // At some point, all functions should be unified to include the additional functionality that these provide
 
diff --git a/layout/base/nsCSSRendering.h b/layout/base/nsCSSRendering.h
--- a/layout/base/nsCSSRendering.h
+++ b/layout/base/nsCSSRendering.h
@@ -78,14 +78,11 @@ public:
                           nsIFrame* aForFrame,
                           const nsRect& aDirtyRect,
                           const nsRect& aBorderArea,
                           const nsStyleBorder& aBorderStyle,
                           nsStyleContext* aStyleContext,
-                          PRIntn aSkipSides,
-                          nsRect* aGap = 0,
-                          nscoord aHardBorderSize = 0,
-                          PRBool aShouldIgnoreRounded = PR_FALSE);
+                          PRIntn aSkipSides = 0);
 
   /**
    * Render the outline for an element using css rendering rules
    * for borders. aSkipSides is a bitmask of the sides to skip
    * when rendering. If 0 then no sides are skipped.
@@ -98,12 +95,22 @@ public:
                           nsIFrame* aForFrame,
                           const nsRect& aDirtyRect,
                           const nsRect& aBorderArea,
                           const nsStyleBorder& aBorderStyle,
                           const nsStyleOutline& aOutlineStyle,
-                          nsStyleContext* aStyleContext,
-                          nsRect* aGap = 0);
+                          nsStyleContext* aStyleContext);
+
+  /**
+   * Render keyboard focus on an element.
+   * |aFocusRect| is the outer rectangle of the focused element.
+   * Uses a fixed style equivalent to "1px dotted |aColor|".
+   * Not used for controls, because the native theme may differ.
+   */
+  static void PaintFocus(nsPresContext* aPresContext,
+                         nsIRenderingContext& aRenderingContext,
+                         const nsRect& aFocusRect,
+                         nscolor aColor);
 
   /**
    * Fill in an nsStyleBackground to be used to paint the background for
    * an element.  The nsStyleBackground should first be initialized
    * using the pres context.  This applies the rules for propagating
@@ -161,33 +168,10 @@ public:
   /**
    * Called by the presShell when painting is finished, so we can clear our
    * inline background data cache.
    */
   static void DidPaint();
-
-
-  static void DrawDashedSides(PRIntn startSide,
-                              nsIRenderingContext& aContext,
-                              const nsRect& aDirtyRect,
-                              const PRUint8 borderStyles[],
-                              const nscolor borderColors[],    
-                              const nsRect& borderOutside,
-                              const nsRect& borderInside,
-                              PRIntn aSkipSides,
-                              nsRect* aGap);
-
-  static void DrawDashedSides(PRIntn startSide,
-                              nsIRenderingContext& aContext,
-                              const nsRect& aDirtyRect,
-                              const nsStyleColor* aColorStyle,
-                              const nsStyleBorder* aBorderStyle,  
-                              const nsStyleOutline* aOutlineStyle,  
-                              PRBool aDoOutline,
-                              const nsRect& borderOutside,
-                              const nsRect& borderInside,
-                              PRIntn aSkipSides,
-                              nsRect* aGap);
 
   // Draw a border segment in the table collapsing border model without beveling corners
   static void DrawTableBorderSegment(nsIRenderingContext&     aContext,
                                      PRUint8                  aBorderStyle,  
                                      nscolor                  aBorderColor,
@@ -275,12 +259,11 @@ protected:
 
   static void DrawBorderImage(nsPresContext* aPresContext,
                               nsIRenderingContext& aRenderingContext,
                               nsIFrame* aForFrame,
                               const nsRect& aBorderArea,
-                              const nsStyleBorder& aBorderStyle,
-                              nscoord aHardBorderSize);
+                              const nsStyleBorder& aBorderStyle);
 
   static void DrawBorderImageSide(gfxContext *aThebesContext,
                                   nsIDeviceContext* aDeviceContext,
                                   imgIContainer* aImage,
                                   gfxRect& aDestRect,
diff --git a/layout/base/nsCSSRenderingBorders.cpp b/layout/base/nsCSSRenderingBorders.cpp
--- a/layout/base/nsCSSRenderingBorders.cpp
+++ b/layout/base/nsCSSRenderingBorders.cpp
@@ -77,11 +77,10 @@
  *   -> DrawBorders
  *
  * DrawBorders
  *   |- separate corners?
  *   |- dashed side mask
- *   |- gap clip
  *   |
  *   -> can border be drawn in 1 pass? (e.g., solid border same color all around)
  *      |- DrawBorderSides with all 4 sides
  *   -> more than 1 pass?
  *      |- for each corner
@@ -174,23 +173,21 @@ nsCSSBorderRenderer::nsCSSBorderRenderer
                                          const gfxFloat* aBorderWidths,
                                          gfxCornerSizes& aBorderRadii,
                                          const nscolor* aBorderColors,
                                          nsBorderColors* const* aCompositeColors,
                                          PRIntn aSkipSides,
-                                         nscolor aBackgroundColor,
-                                         const gfxRect* aGapRect)
+                                         nscolor aBackgroundColor)
   : mAUPP(aAppUnitsPerPixel),
     mContext(aDestContext),
     mOuterRect(aOuterRect),
     mBorderStyles(aBorderStyles),
     mBorderWidths(aBorderWidths),
     mBorderRadii(aBorderRadii),
     mBorderColors(aBorderColors),
     mCompositeColors(aCompositeColors),
     mSkipSides(aSkipSides),
-    mBackgroundColor(aBackgroundColor),
-    mGapRect(aGapRect)
+    mBackgroundColor(aBackgroundColor)
 {
   if (!mCompositeColors) {
     static nsBorderColors * const noColors[4] = { NULL };
     mCompositeColors = &noColors[0];
   }
@@ -1102,28 +1099,10 @@ nsCSSBorderRenderer::DrawBorders()
     mat.x0 = floor(mat.x0 + 0.5);
     mat.y0 = floor(mat.y0 + 0.5);
     mContext->SetMatrix(mat);
   }
 
-  // Only do this clip if we have to clip out a gap; otherwise,
-  // intersecting with this clip is pretty expensive.
-  if (mGapRect) {
-    mContext->NewPath();
-    mContext->Rectangle(mOuterRect);
-
-    // draw the rectangle backwards, so that we get it
-    // clipped out via the winding rule
-    mContext->MoveTo(mGapRect->pos);
-    mContext->LineTo(mGapRect->pos + gfxSize(0.0, mGapRect->size.height));
-    mContext->LineTo(mGapRect->pos + mGapRect->size);
-    mContext->LineTo(mGapRect->pos + gfxSize(mGapRect->size.width, 0.0));
-    mContext->ClosePath();
-
-    mContext->Clip();
-  }
-
-
   if (allBordersSame && !forceSeparateCorners) {
     /* Draw everything in one go */
     DrawBorderSides(SIDE_BITS_ALL);
     SN("---------------- (1)");
   } else {
diff --git a/layout/base/nsCSSRenderingBorders.h b/layout/base/nsCSSRenderingBorders.h
--- a/layout/base/nsCSSRenderingBorders.h
+++ b/layout/base/nsCSSRenderingBorders.h
@@ -103,12 +103,11 @@ struct nsCSSBorderRenderer {
                       const gfxFloat* aBorderWidths,
                       gfxCornerSizes& aBorderRadii,
                       const nscolor* aBorderColors,
                       nsBorderColors* const* aCompositeColors,
                       PRIntn aSkipSides,
-                      nscolor aBackgroundColor,
-                      const gfxRect* aGapRect = nsnull);
+                      nscolor aBackgroundColor);
 
   // core app units per pixel
   PRInt32 mAUPP;
 
   // destination context
@@ -125,15 +124,13 @@ struct nsCSSBorderRenderer {
 
   // colors
   const nscolor* mBorderColors;
   nsBorderColors* const* mCompositeColors;
 
-  // misc -- which sides to skip, the background color, and whether we should
-  // leave a gap in the border (e.g. for a label)
+  // misc -- which sides to skip, the background color
   PRIntn mSkipSides;
   nscolor mBackgroundColor;
-  const gfxRect* mGapRect;
 
   // calculated values
   PRPackedBool mOneUnitBorder;
   PRPackedBool mNoBorderRadius;
 
diff --git a/layout/base/nsChangeHint.h b/layout/base/nsChangeHint.h
--- a/layout/base/nsChangeHint.h
+++ b/layout/base/nsChangeHint.h
@@ -47,11 +47,21 @@ enum nsChangeHint {
 enum nsChangeHint {
   nsChangeHint_RepaintFrame = 0x01,  // change was visual only (e.g., COLOR=)
   nsChangeHint_ReflowFrame = 0x02,   // change requires reflow (e.g., WIDTH=)
   nsChangeHint_SyncFrameView = 0x04, // change requires view to be updated, if there is one (e.g., clip:)
   nsChangeHint_UpdateCursor = 0x08,  // The currently shown mouse cursor needs to be updated
-  nsChangeHint_ReconstructFrame = 0x10   // change requires frame change (e.g., display:)
+  /**
+   * SVG filter/mask/clip effects need to be recomputed because the URI
+   * in the filter/mask/clip-path property has changed. This wipes
+   * out cached nsSVGPropertyBase and subclasses which hold a reference to
+   * the element referenced by the URI, and a mutation observer for
+   * the DOM subtree rooted at that element. Also, for filters they store a
+   * bounding-box for the filter result so that if the filter changes we can
+   * invalidate the old covered area.
+   */
+  nsChangeHint_UpdateEffects = 0x10,
+  nsChangeHint_ReconstructFrame = 0x20   // change requires frame change (e.g., display:)
                                          // This subsumes all the above
   // TBD: add nsChangeHint_ForceFrameView to force frame reconstruction if the frame doesn't yet
   // have a view
 };
 
diff --git a/layout/base/nsDisplayList.cpp b/layout/base/nsDisplayList.cpp
--- a/layout/base/nsDisplayList.cpp
+++ b/layout/base/nsDisplayList.cpp
@@ -565,12 +565,12 @@ nsDisplayOutline::Paint(nsDisplayListBui
   // TODO join outlines together
   nsPoint offset = aBuilder->ToReferenceFrame(mFrame);
   nsCSSRendering::PaintOutline(mFrame->PresContext(), *aCtx, mFrame,
                                aDirtyRect, nsRect(offset, mFrame->GetSize()),
                                *mFrame->GetStyleBorder(),
-                               *mFrame->GetStyleOutline(),                              
-                               mFrame->GetStyleContext(), 0);
+                               *mFrame->GetStyleOutline(),
+                               mFrame->GetStyleContext());
 }
 
 PRBool
 nsDisplayOutline::OptimizeVisibility(nsDisplayListBuilder* aBuilder,
                                      nsRegion* aVisibleRegion) {
@@ -630,11 +630,12 @@ nsDisplayBorder::Paint(nsDisplayListBuil
      nsIRenderingContext* aCtx, const nsRect& aDirtyRect) {
   nsPoint offset = aBuilder->ToReferenceFrame(mFrame);
   nsCSSRendering::PaintBorder(mFrame->PresContext(), *aCtx, mFrame,
                               aDirtyRect, nsRect(offset, mFrame->GetSize()),
                               *mFrame->GetStyleBorder(),
-                              mFrame->GetStyleContext(), mFrame->GetSkipSides());
+                              mFrame->GetStyleContext(),
+                              mFrame->GetSkipSides());
 }
 
 void
 nsDisplayBoxShadow::Paint(nsDisplayListBuilder* aBuilder,
      nsIRenderingContext* aCtx, const nsRect& aDirtyRect) {
diff --git a/layout/base/nsPresContext.cpp b/layout/base/nsPresContext.cpp
--- a/layout/base/nsPresContext.cpp
+++ b/layout/base/nsPresContext.cpp
@@ -77,10 +77,11 @@
 #include "nsThreadUtils.h"
 #include "nsFrameManager.h"
 #include "nsLayoutUtils.h"
 #include "nsIViewManager.h"
 #include "nsCSSFrameConstructor.h"
+#include "nsCSSRuleProcessor.h"
 #include "nsStyleChangeList.h"
 #include "nsRuleNode.h"
 
 #ifdef IBMBIDI
 #include "nsBidiPresUtils.h"
@@ -1384,10 +1385,13 @@ nsPresContext::ThemeChangedInternal()
   if (mLookAndFeel && sLookAndFeelChanged) {
     mLookAndFeel->LookAndFeelChanged();
     sLookAndFeelChanged = PR_FALSE;
   }
 
+  // This will force the system metrics to be generated the next time they're used
+  nsCSSRuleProcessor::FreeSystemMetrics();
+
   // Changes in theme can change system colors (whose changes are
   // properly reflected in computed style data), system fonts (whose
   // changes are not), and -moz-appearance (whose changes likewise are
   // not), so we need to reflow.
   RebuildAllStyleData(NS_STYLE_HINT_REFLOW);
diff --git a/layout/build/Makefile.in b/layout/build/Makefile.in
--- a/layout/build/Makefile.in
+++ b/layout/build/Makefile.in
@@ -149,17 +149,17 @@ SHARED_LIBRARY_LIBS 	+= \
 	$(NULL)
 endif
 
 ifdef MOZ_OGG
 SHARED_LIBRARY_LIBS 	+= \
-	$(DEPTH)/modules/libfishsound/src/libfishsound/$(LIB_PREFIX)fishsound.$(LIB_SUFFIX) \
-	$(DEPTH)/modules/libogg/src/$(LIB_PREFIX)ogg.$(LIB_SUFFIX) \
-	$(DEPTH)/modules/liboggplay/src/liboggplay/$(LIB_PREFIX)oggplay.$(LIB_SUFFIX) \
-	$(DEPTH)/modules/liboggz/src/liboggz/$(LIB_PREFIX)oggz.$(LIB_SUFFIX) \
-	$(DEPTH)/modules/liboggplay_audio/$(LIB_PREFIX)oggplay_audio.$(LIB_SUFFIX) \
-	$(DEPTH)/modules/libtheora/lib/$(LIB_PREFIX)theora.$(LIB_SUFFIX) \
-	$(DEPTH)/modules/libvorbis/lib/$(LIB_PREFIX)vorbis.$(LIB_SUFFIX) \
+	$(DEPTH)/media/libfishsound/src/libfishsound/$(LIB_PREFIX)fishsound.$(LIB_SUFFIX) \
+	$(DEPTH)/media/libogg/src/$(LIB_PREFIX)ogg.$(LIB_SUFFIX) \
+	$(DEPTH)/media/liboggplay/src/liboggplay/$(LIB_PREFIX)oggplay.$(LIB_SUFFIX) \
+	$(DEPTH)/media/liboggz/src/liboggz/$(LIB_PREFIX)oggz.$(LIB_SUFFIX) \
+	$(DEPTH)/media/liboggplay_audio/$(LIB_PREFIX)oggplay_audio.$(LIB_SUFFIX) \
+	$(DEPTH)/media/libtheora/lib/$(LIB_PREFIX)theora.$(LIB_SUFFIX) \
+	$(DEPTH)/media/libvorbis/lib/$(LIB_PREFIX)vorbis.$(LIB_SUFFIX) \
 	$(NULL)
 endif
 
 ifdef NS_PRINTING
 SHARED_LIBRARY_LIBS += \
diff --git a/layout/build/nsLayoutStatics.cpp b/layout/build/nsLayoutStatics.cpp
--- a/layout/build/nsLayoutStatics.cpp
+++ b/layout/build/nsLayoutStatics.cpp
@@ -276,11 +276,11 @@ nsLayoutStatics::Shutdown()
   nsDOMEventRTTearoff::Shutdown();
   nsEventListenerManager::Shutdown();
   nsContentList::Shutdown();
   nsComputedDOMStyle::Shutdown();
   CSSLoaderImpl::Shutdown();
-  nsCSSRuleProcessor::Shutdown();
+  nsCSSRuleProcessor::FreeSystemMetrics();
   nsTextFrameTextRunCache::Shutdown();
   nsCSSRendering::Shutdown();
 #ifdef DEBUG
   nsFrame::DisplayReflowShutdown();
 #endif
diff --git a/layout/forms/nsButtonFrameRenderer.cpp b/layout/forms/nsButtonFrameRenderer.cpp
--- a/layout/forms/nsButtonFrameRenderer.cpp
+++ b/layout/forms/nsButtonFrameRenderer.cpp
@@ -176,35 +176,37 @@ nsButtonFrameRenderer::PaintOutlineAndFo
 nsButtonFrameRenderer::PaintOutlineAndFocusBorders(nsPresContext* aPresContext,
           nsIRenderingContext& aRenderingContext,
           const nsRect& aDirtyRect,
           const nsRect& aRect)
 {
-  // once we have all that we'll draw the focus if we have it. We will need to draw 2 focuses,
-  // the inner and the outer. This is so we can do any kind of look and feel some buttons have
-  // focus on the outside like mac and motif. While others like windows have it inside (dotted line).
-  // Usually only one will be specifed. But I guess you could have both if you wanted to.
+  // once we have all that we'll draw the focus if we have it. We will
+  // need to draw 2 focuses, the inner and the outer. This is so we
+  // can do any kind of look and feel. Some buttons have focus on the
+  // outside like mac and motif. While others like windows have it
+  // inside (dotted line).  Usually only one will be specifed. But I
+  // guess you could have both if you wanted to.
 
   nsRect rect;
 
   if (mOuterFocusStyle) {
     // ---------- paint the outer focus border -------------
 
     GetButtonOuterFocusRect(aRect, rect);
 
     const nsStyleBorder* border = mOuterFocusStyle->GetStyleBorder();
     nsCSSRendering::PaintBorder(aPresContext, aRenderingContext, mFrame,
-                                aDirtyRect, rect, *border, mOuterFocusStyle, 0);
+                                aDirtyRect, rect, *border, mOuterFocusStyle);
   }
 
   if (mInnerFocusStyle) { 
     // ---------- paint the inner focus border -------------
 
     GetButtonInnerFocusRect(aRect, rect);
 
     const nsStyleBorder* border = mInnerFocusStyle->GetStyleBorder();
     nsCSSRendering::PaintBorder(aPresContext, aRenderingContext, mFrame,
-                                aDirtyRect, rect, *border, mInnerFocusStyle, 0);
+                                aDirtyRect, rect, *border, mInnerFocusStyle);
   }
 }
 
 
 void
@@ -225,11 +227,11 @@ nsButtonFrameRenderer::PaintBorderAndBac
 
   nsCSSRendering::PaintBackground(aPresContext, aRenderingContext, mFrame,
                                   aDirtyRect, buttonRect, *border, *padding,
                                   PR_FALSE);
   nsCSSRendering::PaintBorder(aPresContext, aRenderingContext, mFrame,
-                              aDirtyRect, buttonRect, *border, context, 0);
+                              aDirtyRect, buttonRect, *border, context);
 }
 
 
 void
 nsButtonFrameRenderer::GetButtonOuterFocusRect(const nsRect& aRect, nsRect& focusRect)
diff --git a/layout/forms/nsFieldSetFrame.cpp b/layout/forms/nsFieldSetFrame.cpp
--- a/layout/forms/nsFieldSetFrame.cpp
+++ b/layout/forms/nsFieldSetFrame.cpp
@@ -292,11 +292,12 @@ nsFieldSetFrame::PaintBorderBackground(n
     clipRect.height = topBorder;
 
     aRenderingContext.PushState();
     aRenderingContext.SetClipRect(clipRect, nsClipCombine_kIntersect);
     nsCSSRendering::PaintBorder(presContext, aRenderingContext, this,
-                                aDirtyRect, rect, *borderStyle, mStyleContext, skipSides);
+                                aDirtyRect, rect, *borderStyle, mStyleContext,
+                                skipSides);
 
     aRenderingContext.PopState();
 
 
     // draw right side
@@ -306,11 +307,12 @@ nsFieldSetFrame::PaintBorderBackground(n
     clipRect.height = topBorder;
 
     aRenderingContext.PushState();
     aRenderingContext.SetClipRect(clipRect, nsClipCombine_kIntersect);
     nsCSSRendering::PaintBorder(presContext, aRenderingContext, this,
-                                aDirtyRect, rect, *borderStyle, mStyleContext, skipSides);
+                                aDirtyRect, rect, *borderStyle, mStyleContext,
+                                skipSides);
 
     aRenderingContext.PopState();
 
     
     // draw bottom
@@ -319,11 +321,12 @@ nsFieldSetFrame::PaintBorderBackground(n
     clipRect.height = mRect.height - (yoff + topBorder);
     
     aRenderingContext.PushState();
     aRenderingContext.SetClipRect(clipRect, nsClipCombine_kIntersect);
     nsCSSRendering::PaintBorder(presContext, aRenderingContext, this,
-                                aDirtyRect, rect, *borderStyle, mStyleContext, skipSides);
+                                aDirtyRect, rect, *borderStyle, mStyleContext,
+                                skipSides);
 
     aRenderingContext.PopState();
   } else {
 
     nsCSSRendering::PaintBorder(presContext, aRenderingContext, this,
@@ -500,10 +503,18 @@ nsFieldSetFrame::Reflow(nsPresContext*  
     // Our child is "height:100%" but we actually want its height to be reduced
     // by the amount of content-height the legend is eating up, unless our
     // height is unconstrained (in which case the child's will be too).
     if (aReflowState.ComputedHeight() != NS_UNCONSTRAINEDSIZE) {
       kidReflowState.SetComputedHeight(PR_MAX(0, aReflowState.ComputedHeight() - mLegendSpace));
+    }
+
+    kidReflowState.mComputedMinHeight =
+      PR_MAX(0, aReflowState.mComputedMinHeight - mLegendSpace);
+
+    if (aReflowState.mComputedMaxHeight != NS_UNCONSTRAINEDSIZE) {
+      kidReflowState.mComputedMaxHeight =
+        PR_MAX(0, aReflowState.mComputedMaxHeight - mLegendSpace);
     }
 
     nsHTMLReflowMetrics kidDesiredSize(aDesiredSize.mFlags);
     // Reflow the frame
     NS_ASSERTION(kidReflowState.mComputedMargin == nsMargin(0,0,0,0),
diff --git a/layout/forms/nsGfxCheckboxControlFrame.cpp b/layout/forms/nsGfxCheckboxControlFrame.cpp
--- a/layout/forms/nsGfxCheckboxControlFrame.cpp
+++ b/layout/forms/nsGfxCheckboxControlFrame.cpp
@@ -267,11 +267,12 @@ nsGfxCheckboxControlFrame::PaintCheckBox
 
   nsCSSRendering::PaintBackgroundWithSC(PresContext(), aRenderingContext,
                                         this, aDirtyRect, rect, *myBackground,
                                         *myBorder, *myPadding, PR_FALSE);
   nsCSSRendering::PaintBorder(PresContext(), aRenderingContext, this,
-                              aDirtyRect, rect, *myBorder, mCheckButtonFaceStyle, 0);
+                              aDirtyRect, rect, *myBorder,
+                              mCheckButtonFaceStyle);
 }
 
 //------------------------------------------------------------
 PRBool
 nsGfxCheckboxControlFrame::GetCheckboxState ( )
diff --git a/layout/forms/nsListControlFrame.cpp b/layout/forms/nsListControlFrame.cpp
--- a/layout/forms/nsListControlFrame.cpp
+++ b/layout/forms/nsListControlFrame.cpp
@@ -363,18 +363,11 @@ void nsListControlFrame::PaintFocus(nsIR
   presContext->LookAndFeel()->
     GetColor(lastItemIsSelected ?
              nsILookAndFeel::eColor_WidgetSelectForeground :
              nsILookAndFeel::eColor_WidgetSelectBackground, color);
 
-  nscoord onePixelInTwips = nsPresContext::CSSPixelsToAppUnits(1);
-
-  nsRect dirty;
-  nscolor colors[] = {color, color, color, color};
-  PRUint8 borderStyle[] = {NS_STYLE_BORDER_STYLE_DOTTED, NS_STYLE_BORDER_STYLE_DOTTED, NS_STYLE_BORDER_STYLE_DOTTED, NS_STYLE_BORDER_STYLE_DOTTED};
-  nsRect innerRect = fRect;
-  innerRect.Deflate(nsSize(onePixelInTwips, onePixelInTwips));
-  nsCSSRendering::DrawDashedSides(0, aRC, dirty, borderStyle, colors, fRect, innerRect, 0, nsnull);
+  nsCSSRendering::PaintFocus(presContext, aRC, fRect, color);
 }
 
 void
 nsListControlFrame::InvalidateFocus()
 {
diff --git a/layout/generic/nsAbsoluteContainingBlock.cpp b/layout/generic/nsAbsoluteContainingBlock.cpp
--- a/layout/generic/nsAbsoluteContainingBlock.cpp
+++ b/layout/generic/nsAbsoluteContainingBlock.cpp
@@ -422,11 +422,14 @@ nsAbsoluteContainingBlock::ReflowAbsolut
     && (aKidFrame->GetRect().y <= aReflowState.availableHeight);
        // Don't split things below the fold. (Ideally we shouldn't *have*
        // anything totally below the fold, but we can't position frames
        // across next-in-flow breaks yet.
   if (constrainHeight) {
-    kidReflowState.availableHeight = aReflowState.availableHeight - aKidFrame->GetRect().y;
+    kidReflowState.availableHeight = aReflowState.availableHeight - border.top
+                                     - kidReflowState.mComputedMargin.top;
+    if (NS_AUTOOFFSET != kidReflowState.mComputedOffsets.top)
+      kidReflowState.availableHeight -= kidReflowState.mComputedOffsets.top;
   }
 
   // Do the reflow
   rv = aKidFrame->Reflow(aPresContext, kidDesiredSize, kidReflowState, aStatus);
 
diff --git a/layout/generic/nsBlockFrame.cpp b/layout/generic/nsBlockFrame.cpp
--- a/layout/generic/nsBlockFrame.cpp
+++ b/layout/generic/nsBlockFrame.cpp
@@ -3566,18 +3566,16 @@ nsBlockFrame::ReflowInlineFrame(nsBlockR
 {
   NS_ENSURE_ARG_POINTER(aFrame);
   
   *aLineReflowStatus = LINE_REFLOW_OK;
 
-  // If it's currently ok to be reflowing in first-letter style then
-  // we must be about to reflow a frame that has first-letter style.
-  PRBool reflowingFirstLetter = aLineLayout.GetFirstLetterStyleOK();
 #ifdef NOISY_FIRST_LETTER
   ListTag(stdout);
   printf(": reflowing ");
   nsFrame::ListTag(stdout, aFrame);
-  printf(" reflowingFirstLetter=%s\n", reflowingFirstLetter ? "on" : "off");
+  printf(" reflowingFirstLetter=%s\n",
+         aLineLayout.GetFirstLetterStyleOK() ? "on" : "off");
 #endif
 
   // Reflow the inline frame
   nsReflowStatus frameReflowStatus;
   PRBool         pushedFrame;
@@ -3713,22 +3711,14 @@ nsBlockFrame::ReflowInlineFrame(nsBlockR
     // Remember that the line has wrapped
     if (!aLineLayout.GetLineEndsInBR()) {
       aLine->SetLineWrapped(PR_TRUE);
     }
     
-    // If we are reflowing the first letter frame or a placeholder then 
+    // If we just ended a first-letter frame or reflowed a placeholder then 
     // don't split the line and don't stop the line reflow...
-    PRBool splitLine = !reflowingFirstLetter && 
-      nsGkAtoms::placeholderFrame != frameType;
-    if (reflowingFirstLetter) {
-      if ((nsGkAtoms::inlineFrame == frameType) ||
-          (nsGkAtoms::lineFrame == frameType)) {
-        splitLine = PR_TRUE;
-      }
-    }
-
-    if (splitLine) {
+    if (!(frameReflowStatus & NS_INLINE_BREAK_FIRST_LETTER_COMPLETE) && 
+        nsGkAtoms::placeholderFrame != frameType) {
       // Split line after the current frame
       *aLineReflowStatus = LINE_REFLOW_STOP;
       rv = SplitLine(aState, aLineLayout, aLine, aFrame->GetNextSibling(), aLineReflowStatus);
       NS_ENSURE_SUCCESS(rv, rv);
 
diff --git a/layout/generic/nsFrameFrame.cpp b/layout/generic/nsFrameFrame.cpp
--- a/layout/generic/nsFrameFrame.cpp
+++ b/layout/generic/nsFrameFrame.cpp
@@ -179,10 +179,12 @@ public:
   NS_IMETHOD GetAccessible(nsIAccessible** aAccessible);
 #endif
 
   // nsIFrameFrame
   NS_IMETHOD GetDocShell(nsIDocShell **aDocShell);
+  NS_IMETHOD BeginSwapDocShells(nsIFrame* aOther);
+  virtual void EndSwapDocShells(nsIFrame* aOther);
 
   NS_IMETHOD  VerifyTree() const;
 
   // nsIReflowCallback
   virtual PRBool ReflowFinished();
@@ -196,10 +198,14 @@ protected:
 
   virtual nscoord GetIntrinsicWidth();
   virtual nscoord GetIntrinsicHeight();
 
   virtual PRIntn GetSkipSides() const;
+
+  // Hide or show our document viewer
+  void HideViewer();
+  void ShowViewer();
 
   /* Obtains the frame we should use for intrinsic size information if we are
    * an HTML <object>, <embed> or <applet> (a replaced element - not <iframe>)
    * and our sub-document has an intrinsic size. The frame returned is the
    * frame for the document element of the document we're embedding.
@@ -301,22 +307,31 @@ nsSubDocumentFrame::Init(nsIContent*    
   if (aParent->GetStyleDisplay()->mDisplay == NS_STYLE_DISPLAY_DECK
       && !view->HasWidget()) {
     view->CreateWidget(kCChildCID);
   }
 
-  if (!aPresContext->IsDynamic()) {
+  ShowViewer();
+  return NS_OK;
+}
+
+void
+nsSubDocumentFrame::ShowViewer()
+{
+  if (!PresContext()->IsDynamic()) {
     // We let the printing code take care of loading the document; just
     // create a widget for it to use
-    rv = CreateViewAndWidget(eContentTypeContent);
-    NS_ENSURE_SUCCESS(rv,rv);
+    nsresult rv = CreateViewAndWidget(eContentTypeContent);
+    if (NS_FAILED(rv)) {
+      return;
+    }
   } else {
-    rv = ShowDocShell();
-    NS_ENSURE_SUCCESS(rv,rv);
+    nsresult rv = ShowDocShell();
+    if (NS_FAILED(rv)) {
+      return;
+    }
     mDidCreateDoc = PR_TRUE;
   }
-
-  return NS_OK;
 }
 
 PRIntn
 nsSubDocumentFrame::GetSkipSides() const
 {
@@ -743,10 +758,18 @@ nsSubDocumentFrame::Destroy()
   if (mPostedReflowCallback) {
     PresContext()->PresShell()->CancelReflowCallback(this);
     mPostedReflowCallback = PR_FALSE;
   }
   
+  HideViewer();
+
+  nsLeafFrame::Destroy();
+}
+
+void
+nsSubDocumentFrame::HideViewer()
+{
   if (mFrameLoader && mDidCreateDoc) {
     // Get the content viewer through the docshell, but don't call
     // GetDocShell() since we don't want to create one if we don't
     // have one.
 
@@ -772,16 +795,14 @@ nsSubDocumentFrame::Destroy()
       // needed.
 
       // Hide the content viewer now that the frame is going away...
       baseWin->SetVisibility(PR_FALSE);
 
-      // Clear out the parentWidget, since it's about to die with us
+      // Clear out the parentWidget, since it might be about to die with us
       baseWin->SetParentWidget(nsnull);
     }
   }
-
-  nsLeafFrame::Destroy();
 }
 
 nsSize nsSubDocumentFrame::GetMargin()
 {
   nsSize result(-1, -1);
@@ -820,10 +841,50 @@ nsSubDocumentFrame::GetDocShell(nsIDocSh
 
     NS_ENSURE_STATE(mFrameLoader);
   }
 
   return mFrameLoader->GetDocShell(aDocShell);
+}
+
+NS_IMETHODIMP
+nsSubDocumentFrame::BeginSwapDocShells(nsIFrame* aOther)
+{
+  if (!aOther || aOther->GetType() != nsGkAtoms::subDocumentFrame) {
+    return NS_ERROR_NOT_IMPLEMENTED;
+  }
+
+  nsSubDocumentFrame* other = static_cast<nsSubDocumentFrame*>(aOther);
+  if (!mFrameLoader || !mDidCreateDoc || !other->mFrameLoader ||
+      !other->mDidCreateDoc) {
+    return NS_ERROR_NOT_IMPLEMENTED;
+  }
+
+  HideViewer();
+  other->HideViewer();
+
+  mFrameLoader.swap(other->mFrameLoader);
+  return NS_OK;
+}
+
+void
+nsSubDocumentFrame::EndSwapDocShells(nsIFrame* aOther)
+{
+  nsSubDocumentFrame* other = static_cast<nsSubDocumentFrame*>(aOther);
+  ShowViewer();
+  other->ShowViewer();
+
+  // Now make sure we reflow both frames, in case their contents
+  // determine their size.
+  PresContext()->PresShell()->
+    FrameNeedsReflow(this, nsIPresShell::eTreeChange, NS_FRAME_IS_DIRTY);
+  other->PresContext()->PresShell()->
+    FrameNeedsReflow(other, nsIPresShell::eTreeChange, NS_FRAME_IS_DIRTY);
+
+  // And repaint them, for good measure, in case there's nothing
+  // interesting that happens during reflow.
+  InvalidateOverflowRect();
+  other->InvalidateOverflowRect();
 }
 
 inline PRInt32 ConvertOverflow(PRUint8 aOverflow)
 {
   switch (aOverflow) {
@@ -933,10 +994,15 @@ nsSubDocumentFrame::ShowDocShell()
 }
 
 nsresult
 nsSubDocumentFrame::CreateViewAndWidget(nsContentType aContentType)
 {
+  if (mInnerView) {
+    // Nothing to do here
+    return NS_OK;
+  }
+  
   // create, init, set the parent of the view
   nsIView* outerView = GetView();
   NS_ASSERTION(outerView, "Must have an outer view already");
   nsRect viewBounds(0, 0, 0, 0); // size will be fixed during reflow
 
diff --git a/layout/generic/nsFrameSelection.h b/layout/generic/nsFrameSelection.h
--- a/layout/generic/nsFrameSelection.h
+++ b/layout/generic/nsFrameSelection.h
@@ -61,10 +61,18 @@
 
 // Selection interface
 
 struct SelectionDetails
 {
+#ifdef NS_BUILD_REFCNT_LOGGING
+  SelectionDetails() {
+    MOZ_COUNT_CTOR(SelectionDetails);
+  }
+  ~SelectionDetails() {
+    MOZ_COUNT_DTOR(SelectionDetails);
+  }
+#endif
   PRInt32 mStart;
   PRInt32 mEnd;
   SelectionType mType;
   SelectionDetails *mNext;
 };
diff --git a/layout/generic/nsGfxScrollFrame.cpp b/layout/generic/nsGfxScrollFrame.cpp
--- a/layout/generic/nsGfxScrollFrame.cpp
+++ b/layout/generic/nsGfxScrollFrame.cpp
@@ -2495,27 +2495,58 @@ static void LayoutAndInvalidate(nsBoxLay
   nsBoxFrame::LayoutChildAt(aState, aBox, aRect);
   if (rectChanged)
     aBox->Invalidate(aBox->GetOverflowRect());
 }
 
+static void AdjustScrollbarRect(nsIView* aView, nsPresContext* aPresContext,
+                                nsRect& aRect, PRBool aVertical)
+{
+  if ((aVertical ? aRect.width : aRect.height) == 0)
+    return;
+
+  nsPoint offset;
+  nsIWidget* widget = aView->GetNearestWidget(&offset);
+
+  nsIntRect widgetRect;
+  if (!widget->ShowsResizeIndicator(&widgetRect))
+    return;
+
+  nsRect resizerRect =
+      nsRect(aPresContext->DevPixelsToAppUnits(widgetRect.x) - offset.x,
+             aPresContext->DevPixelsToAppUnits(widgetRect.y) - offset.y,
+             aPresContext->DevPixelsToAppUnits(widgetRect.width),
+             aPresContext->DevPixelsToAppUnits(widgetRect.height));
+
+  if (!aRect.Intersects(resizerRect))
+    return;
+
+  if (aVertical)
+    aRect.height = PR_MAX(0, resizerRect.y - aRect.y);
+  else
+    aRect.width = PR_MAX(0, resizerRect.x - aRect.x);
+}
+
 void
 nsGfxScrollFrameInner::LayoutScrollbars(nsBoxLayoutState& aState,
                                         const nsRect& aContentArea,
                                         const nsRect& aOldScrollArea,
                                         const nsRect& aScrollArea)
 {
   NS_ASSERTION(!mSupppressScrollbarUpdate,
                "This should have been suppressed");
     
+  nsIView* view = mOuter->GetView();
+  nsPresContext* presContext = mScrolledFrame->PresContext();
   if (mVScrollbarBox) {
     NS_PRECONDITION(mVScrollbarBox->IsBoxFrame(), "Must be a box frame!");
     nsRect vRect(aScrollArea);
     vRect.width = aContentArea.width - aScrollArea.width;
     vRect.x = IsScrollbarOnRight() ? aScrollArea.XMost() : aContentArea.x;
     nsMargin margin;
     mVScrollbarBox->GetMargin(margin);
     vRect.Deflate(margin);
+    AdjustScrollbarRect(view, presContext, vRect, PR_TRUE);
     LayoutAndInvalidate(aState, mVScrollbarBox, vRect);
   }
 
   if (mHScrollbarBox) {
     NS_PRECONDITION(mHScrollbarBox->IsBoxFrame(), "Must be a box frame!");
@@ -2523,10 +2554,11 @@ nsGfxScrollFrameInner::LayoutScrollbars(
     hRect.height = aContentArea.height - aScrollArea.height;
     hRect.y = PR_TRUE ? aScrollArea.YMost() : aContentArea.y;
     nsMargin margin;
     mHScrollbarBox->GetMargin(margin);
     hRect.Deflate(margin);
+    AdjustScrollbarRect(view, presContext, hRect, PR_FALSE);
     LayoutAndInvalidate(aState, mHScrollbarBox, hRect);
   }
 
   // place the scrollcorner
   if (mScrollCornerBox) {
diff --git a/layout/generic/nsHTMLFrame.cpp b/layout/generic/nsHTMLFrame.cpp
--- a/layout/generic/nsHTMLFrame.cpp
+++ b/layout/generic/nsHTMLFrame.cpp
@@ -485,14 +485,10 @@ CanvasFrame::PaintFocus(nsIRenderingCont
     scrollableView->GetScrollPosition(x, y);
     focusRect.x += x;
     focusRect.y += y;
   }
 
-  nsStyleOutline outlineStyle(PresContext());
-  outlineStyle.SetOutlineStyle(NS_STYLE_BORDER_STYLE_DOTTED);
-  outlineStyle.SetOutlineInitialColor();
-
  // XXX use the root frame foreground color, but should we find BODY frame
  // for HTML documents?
   nsIFrame* root = mFrames.FirstChild();
   const nsStyleColor* color =
     root ? root->GetStyleContext()->GetStyleColor() :
@@ -500,25 +496,12 @@ CanvasFrame::PaintFocus(nsIRenderingCont
   if (!color) {
     NS_ERROR("current color cannot be found");
     return;
   }
 
-  // XXX the CSS border for links is specified as 2px, but it
-  // is only drawn as 1px.  Match this here.
-  nscoord onePixel = nsPresContext::CSSPixelsToAppUnits(1);
-
-  nsRect borderInside(focusRect.x + onePixel,
-                      focusRect.y + onePixel,
-                      focusRect.width - 2 * onePixel,
-                      focusRect.height - 2 * onePixel);
-
-  nsCSSRendering::DrawDashedSides(0, aRenderingContext, 
-                                  focusRect, color,
-                                  nsnull, &outlineStyle,
-                                  PR_TRUE, focusRect,
-                                  borderInside, 0, 
-                                  nsnull);
+  nsCSSRendering::PaintFocus(PresContext(), aRenderingContext,
+                             focusRect, color->mColor);
 }
 
 /* virtual */ nscoord
 CanvasFrame::GetMinWidth(nsIRenderingContext *aRenderingContext)
 {
diff --git a/layout/generic/nsIFrame.h b/layout/generic/nsIFrame.h
--- a/layout/generic/nsIFrame.h
+++ b/layout/generic/nsIFrame.h
@@ -371,10 +371,13 @@ typedef PRUint32 nsReflowStatus;
 #define NS_INLINE_BREAK_BEFORE       0x0000
 #define NS_INLINE_BREAK_AFTER        0x0200
 
 // The type of break requested can be found in these bits.
 #define NS_INLINE_BREAK_TYPE_MASK    0xF000
+
+// Set when a break was induced by completion of a first-letter
+#define NS_INLINE_BREAK_FIRST_LETTER_COMPLETE 0x10000
 
 //----------------------------------------
 // Macros that use those bits
 
 #define NS_INLINE_IS_BREAK(_status) \
diff --git a/layout/generic/nsIFrameFrame.h b/layout/generic/nsIFrameFrame.h
--- a/layout/generic/nsIFrameFrame.h
+++ b/layout/generic/nsIFrameFrame.h
@@ -44,19 +44,27 @@
 #define nsIFrameFrame_h___
 
 class nsIDocShell;
 
 #define NS_IFRAMEFRAME_IID \
-{ 0xda876f25, 0x1cff, 0x4f0a, { \
-  0xbf, 0x7e, 0x83, 0xd7, 0x4f, 0xc5, 0x2a, 0x3b } }
+{ 0x22e34108, 0xc24b, 0x40ea, { \
+  0xb9, 0x79, 0x50, 0x18, 0x38, 0x8d, 0xd5, 0x88 } }
 
 class nsIFrameFrame : public nsISupports
 {
 public:
   NS_DECLARE_STATIC_IID_ACCESSOR(NS_IFRAMEFRAME_IID)
 
   NS_IMETHOD GetDocShell(nsIDocShell **aDocShell) = 0;
+
+  /**
+   * Only allowed to fail if the other frame is not the same type as
+   * this one or if one of the frames has no docshell.  Don't call
+   * EndSwapDocShells() unless BeginSwapDocShells() succeeds.
+   */
+  NS_IMETHOD BeginSwapDocShells(nsIFrame* aOther) = 0;
+  virtual void EndSwapDocShells(nsIFrame* aOther) = 0;
 };
 
 NS_DEFINE_STATIC_IID_ACCESSOR(nsIFrameFrame, NS_IFRAMEFRAME_IID)
 
 #endif
diff --git a/layout/generic/nsImageFrame.cpp b/layout/generic/nsImageFrame.cpp
--- a/layout/generic/nsImageFrame.cpp
+++ b/layout/generic/nsImageFrame.cpp
@@ -1032,11 +1032,11 @@ nsImageFrame::DisplayAltFeedback(nsIRend
   }
 
   // Paint the border
   nsRecessedBorder recessedBorder(borderEdgeWidth, PresContext());
   nsCSSRendering::PaintBorder(PresContext(), aRenderingContext, this, inner,
-                              inner, recessedBorder, mStyleContext, 0);
+                              inner, recessedBorder, mStyleContext);
 
   // Adjust the inner rect to account for the one pixel recessed border,
   // and a six pixel padding on each edge
   inner.Deflate(nsPresContext::CSSPixelsToAppUnits(ICON_PADDING+ALT_BORDER_WIDTH), 
                 nsPresContext::CSSPixelsToAppUnits(ICON_PADDING+ALT_BORDER_WIDTH));
@@ -1130,11 +1130,11 @@ static void PaintDebugImageMap(nsIFrame*
   nsPresContext* pc = f->PresContext();
 
   aCtx->SetColor(NS_RGB(0, 0, 0));
   aCtx->PushState();
   aCtx->Translate(inner.x, inner.y);
-  f->GetImageMap(pc)->Draw(pc, *aCtx);
+  f->GetImageMap(pc)->Draw(aFrame, *aCtx);
   aCtx->PopState();
 }
 #endif
 
 /**
@@ -1187,11 +1187,11 @@ nsImageFrame::PaintImage(nsIRenderingCon
   if (nsnull != map) {
     aRenderingContext.PushState();
     aRenderingContext.SetColor(NS_RGB(0, 0, 0));
     aRenderingContext.SetLineStyle(nsLineStyle_kDotted);
     aRenderingContext.Translate(inner.x, inner.y);
-    map->Draw(presContext, aRenderingContext);
+    map->Draw(this, aRenderingContext);
     aRenderingContext.PopState();
   }
 }
 
 NS_IMETHODIMP
diff --git a/layout/generic/nsImageMap.cpp b/layout/generic/nsImageMap.cpp
--- a/layout/generic/nsImageMap.cpp
+++ b/layout/generic/nsImageMap.cpp
@@ -77,13 +77,12 @@ public:
   virtual ~Area();
 
   virtual void ParseCoords(const nsAString& aSpec);
 
   virtual PRBool IsInside(nscoord x, nscoord y) const = 0;
-  virtual void Draw(nsPresContext* aCX,
-                    nsIRenderingContext& aRC) = 0;
-  virtual void GetRect(nsPresContext* aCX, nsRect& aRect) = 0;
+  virtual void Draw(nsIFrame* aFrame, nsIRenderingContext& aRC) = 0;
+  virtual void GetRect(nsIFrame* aFrame, nsRect& aRect) = 0;
 
   void HasFocus(PRBool aHasFocus);
 
   void GetHREF(nsAString& aHref) const;
   void GetArea(nsIContent** aArea) const;
@@ -335,13 +334,12 @@ class DefaultArea : public Area {
 class DefaultArea : public Area {
 public:
   DefaultArea(nsIContent* aArea);
 
   virtual PRBool IsInside(nscoord x, nscoord y) const;
-  virtual void Draw(nsPresContext* aCX,
-                    nsIRenderingContext& aRC);
-  virtual void GetRect(nsPresContext* aCX, nsRect& aRect);
+  virtual void Draw(nsIFrame* aFrame, nsIRenderingContext& aRC);
+  virtual void GetRect(nsIFrame* aFrame, nsRect& aRect);
 };
 
 DefaultArea::DefaultArea(nsIContent* aArea)
   : Area(aArea)
 {
@@ -350,29 +348,44 @@ PRBool DefaultArea::IsInside(nscoord x, 
 PRBool DefaultArea::IsInside(nscoord x, nscoord y) const
 {
   return PR_TRUE;
 }
 
-void DefaultArea::Draw(nsPresContext* aCX, nsIRenderingContext& aRC)
+void DefaultArea::Draw(nsIFrame* aFrame, nsIRenderingContext& aRC)
 {
+  if (mHasFocus) {
+    nsRect r = aFrame->GetRect();
+    r.MoveTo(0, 0);
+    nscoord x1 = r.x;
+    nscoord y1 = r.y;
+    const nscoord kOnePixel = nsPresContext::CSSPixelsToAppUnits(1);
+    nscoord x2 = r.XMost() - kOnePixel;
+    nscoord y2 = r.YMost() - kOnePixel;
+    // XXX aRC.DrawRect(r) result is ugly, that's why we use DrawLine.
+    aRC.DrawLine(x1, y1, x1, y2);
+    aRC.DrawLine(x1, y2, x2, y2);
+    aRC.DrawLine(x1, y1, x2, y1);
+    aRC.DrawLine(x2, y1, x2, y2);
+  }
 }
 
-void DefaultArea::GetRect(nsPresContext* aCX, nsRect& aRect)
+void DefaultArea::GetRect(nsIFrame* aFrame, nsRect& aRect)
 {
+  aRect = aFrame->GetRect();
+  aRect.MoveTo(0, 0);
 }
 
 //----------------------------------------------------------------------
 
 class RectArea : public Area {
 public:
   RectArea(nsIContent* aArea);
 
   virtual void ParseCoords(const nsAString& aSpec);
   virtual PRBool IsInside(nscoord x, nscoord y) const;
-  virtual void Draw(nsPresContext* aCX,
-                    nsIRenderingContext& aRC);
-  virtual void GetRect(nsPresContext* aCX, nsRect& aRect);
+  virtual void Draw(nsIFrame* aFrame, nsIRenderingContext& aRC);
+  virtual void GetRect(nsIFrame* aFrame, nsRect& aRect);
 };
 
 RectArea::RectArea(nsIContent* aArea)
   : Area(aArea)
 {
@@ -429,11 +442,11 @@ PRBool RectArea::IsInside(nscoord x, nsc
     }
   }
   return PR_FALSE;
 }
 
-void RectArea::Draw(nsPresContext* aCX, nsIRenderingContext& aRC)
+void RectArea::Draw(nsIFrame* aFrame, nsIRenderingContext& aRC)
 {
   if (mHasFocus) {
     if (mNumCoords >= 4) {
       nscoord x1 = nsPresContext::CSSPixelsToAppUnits(mCoords[0]);
       nscoord y1 = nsPresContext::CSSPixelsToAppUnits(mCoords[1]);
@@ -447,11 +460,11 @@ void RectArea::Draw(nsPresContext* aCX, 
       aRC.DrawLine(x2, y1, x2, y2);
     }
   }
 }
 
-void RectArea::GetRect(nsPresContext* aCX, nsRect& aRect)
+void RectArea::GetRect(nsIFrame* aFrame, nsRect& aRect)
 {
   if (mNumCoords >= 4) {
     nscoord x1 = nsPresContext::CSSPixelsToAppUnits(mCoords[0]);
     nscoord y1 = nsPresContext::CSSPixelsToAppUnits(mCoords[1]);
     nscoord x2 = nsPresContext::CSSPixelsToAppUnits(mCoords[2]);
@@ -469,13 +482,12 @@ public:
 public:
   PolyArea(nsIContent* aArea);
 
   virtual void ParseCoords(const nsAString& aSpec);
   virtual PRBool IsInside(nscoord x, nscoord y) const;
-  virtual void Draw(nsPresContext* aCX,
-                    nsIRenderingContext& aRC);
-  virtual void GetRect(nsPresContext* aCX, nsRect& aRect);
+  virtual void Draw(nsIFrame* aFrame, nsIRenderingContext& aRC);
+  virtual void GetRect(nsIFrame* aFrame, nsRect& aRect);
 };
 
 PolyArea::PolyArea(nsIContent* aArea)
   : Area(aArea)
 {
@@ -560,11 +572,11 @@ PRBool PolyArea::IsInside(nscoord x, nsc
     }
   }
   return PR_FALSE;
 }
 
-void PolyArea::Draw(nsPresContext* aCX, nsIRenderingContext& aRC)
+void PolyArea::Draw(nsIFrame* aFrame, nsIRenderingContext& aRC)
 {
   if (mHasFocus) {
     if (mNumCoords >= 6) {
       nscoord x0 = nsPresContext::CSSPixelsToAppUnits(mCoords[0]);
       nscoord y0 = nsPresContext::CSSPixelsToAppUnits(mCoords[1]);
@@ -581,11 +593,11 @@ void PolyArea::Draw(nsPresContext* aCX, 
       aRC.DrawLine(x0, y0, x1, y1);
     }
   }
 }
 
-void PolyArea::GetRect(nsPresContext* aCX, nsRect& aRect)
+void PolyArea::GetRect(nsIFrame* aFrame, nsRect& aRect)
 {
   if (mNumCoords >= 6) {
     nscoord x1, x2, y1, y2, xtmp, ytmp;
     x1 = x2 = nsPresContext::CSSPixelsToAppUnits(mCoords[0]);
     y1 = y2 = nsPresContext::CSSPixelsToAppUnits(mCoords[1]);
@@ -608,13 +620,12 @@ public:
 public:
   CircleArea(nsIContent* aArea);
 
   virtual void ParseCoords(const nsAString& aSpec);
   virtual PRBool IsInside(nscoord x, nscoord y) const;
-  virtual void Draw(nsPresContext* aCX,
-                    nsIRenderingContext& aRC);
-  virtual void GetRect(nsPresContext* aCX, nsRect& aRect);
+  virtual void Draw(nsIFrame* aFrame, nsIRenderingContext& aRC);
+  virtual void GetRect(nsIFrame* aFrame, nsRect& aRect);
 };
 
 CircleArea::CircleArea(nsIContent* aArea)
   : Area(aArea)
 {
@@ -668,11 +679,11 @@ PRBool CircleArea::IsInside(nscoord x, n
     }
   }
   return PR_FALSE;
 }
 
-void CircleArea::Draw(nsPresContext* aCX, nsIRenderingContext& aRC)
+void CircleArea::Draw(nsIFrame* aFrame, nsIRenderingContext& aRC)
 {
   if (mHasFocus) {
     if (mNumCoords >= 3) {
       nscoord x1 = nsPresContext::CSSPixelsToAppUnits(mCoords[0]);
       nscoord y1 = nsPresContext::CSSPixelsToAppUnits(mCoords[1]);
@@ -686,11 +697,11 @@ void CircleArea::Draw(nsPresContext* aCX
       aRC.DrawEllipse(x, y, w, w);
     }
   }
 }
 
-void CircleArea::GetRect(nsPresContext* aCX, nsRect& aRect)
+void CircleArea::GetRect(nsIFrame* aFrame, nsRect& aRect)
 {
   if (mNumCoords >= 3) {
     nscoord x1 = nsPresContext::CSSPixelsToAppUnits(mCoords[0]);
     nscoord y1 = nsPresContext::CSSPixelsToAppUnits(mCoords[1]);
     nscoord radius = nsPresContext::CSSPixelsToAppUnits(mCoords[2]);
@@ -726,16 +737,25 @@ NS_IMETHODIMP
 NS_IMETHODIMP
 nsImageMap::GetBoundsForAreaContent(nsIContent *aContent, 
                                    nsPresContext* aPresContext, 
                                    nsRect& aBounds)
 {
+  NS_ENSURE_TRUE(aContent && aPresContext, NS_ERROR_INVALID_ARG);
+
   // Find the Area struct associated with this content node, and return bounds
   PRInt32 i, n = mAreas.Count();
   for (i = 0; i < n; i++) {
     Area* area = (Area*) mAreas.ElementAt(i);
     if (area->mArea == aContent) {
-      area->GetRect(aPresContext, aBounds);
+      aBounds = nsRect();
+      nsIPresShell* shell = aPresContext->PresShell();
+      if (shell) {
+        nsIFrame* frame = shell->GetPrimaryFrameFor(aContent);
+        if (frame) {
+          area->GetRect(frame, aBounds);
+        }
+      }
       return NS_OK;
     }
   }
   return NS_ERROR_FAILURE;
 }
@@ -903,16 +923,16 @@ nsImageMap::IsInside(nscoord aX, nscoord
 
   return PR_FALSE;
 }
 
 void
-nsImageMap::Draw(nsPresContext* aCX, nsIRenderingContext& aRC)
+nsImageMap::Draw(nsIFrame* aFrame, nsIRenderingContext& aRC)
 {
   PRInt32 i, n = mAreas.Count();
   for (i = 0; i < n; i++) {
     Area* area = (Area*) mAreas.ElementAt(i);
-    area->Draw(aCX, aRC);
+    area->Draw(aFrame, aRC);
   }
 }
 
 void
 nsImageMap::MaybeUpdateAreas(nsIContent *aContent)
@@ -981,43 +1001,40 @@ nsImageMap::Blur(nsIDOMEvent* aEvent)
 {
   return ChangeFocus(aEvent, PR_FALSE);
 }
 
 nsresult
-nsImageMap::ChangeFocus(nsIDOMEvent* aEvent, PRBool aFocus) {
+nsImageMap::ChangeFocus(nsIDOMEvent* aEvent, PRBool aFocus)
+{
   //Set which one of our areas changed focus
   nsCOMPtr<nsIDOMEventTarget> target;
   if (NS_SUCCEEDED(aEvent->GetTarget(getter_AddRefs(target))) && target) {
     nsCOMPtr<nsIContent> targetContent(do_QueryInterface(target));
     if (targetContent) {
       PRInt32 i, n = mAreas.Count();
       for (i = 0; i < n; i++) {
         Area* area = (Area*) mAreas.ElementAt(i);
         nsCOMPtr<nsIContent> areaContent;
         area->GetArea(getter_AddRefs(areaContent));
-        if (areaContent) {
-          if (areaContent.get() == targetContent.get()) {
-            //Set or Remove internal focus
-            area->HasFocus(aFocus);
-            //Now invalidate the rect
-            nsCOMPtr<nsIDocument> doc = targetContent->GetDocument();
-            //This check is necessary to see if we're still attached to the doc
-            if (doc) {
-              nsIPresShell *presShell = doc->GetPrimaryShell();
-              if (presShell) {
-                nsIFrame* imgFrame = presShell->GetPrimaryFrameFor(targetContent);
-                if (imgFrame) {
-                  nsPresContext *presContext = presShell->GetPresContext();
-                  if (presContext) {
-                    nsRect dmgRect;
-                    area->GetRect(presContext, dmgRect);
-                    imgFrame->Invalidate(dmgRect, PR_TRUE);
-                  }
-                }
+        if (areaContent.get() == targetContent.get()) {
+          //Set or Remove internal focus
+          area->HasFocus(aFocus);
+          //Now invalidate the rect
+          nsCOMPtr<nsIDocument> doc = targetContent->GetDocument();
+          //This check is necessary to see if we're still attached to the doc
+          if (doc) {
+            nsIPresShell *presShell = doc->GetPrimaryShell();
+            if (presShell) {
+              nsIFrame* imgFrame = presShell->GetPrimaryFrameFor(targetContent);
+              if (imgFrame) {
+                nsRect dmgRect;
+                area->GetRect(imgFrame, dmgRect);
+                imgFrame->Invalidate(dmgRect, PR_FALSE);
               }
             }
           }
+          break;
         }
       }
     }
   }
   return NS_OK;
diff --git a/layout/generic/nsImageMap.h b/layout/generic/nsImageMap.h
--- a/layout/generic/nsImageMap.h
+++ b/layout/generic/nsImageMap.h
@@ -71,11 +71,11 @@ public:
    * is returned.
    */
   PRBool IsInside(nscoord aX, nscoord aY,
                   nsIContent** aContent) const;
 
-  void Draw(nsPresContext* aCX, nsIRenderingContext& aRC);
+  void Draw(nsIFrame* aFrame, nsIRenderingContext& aRC);
   
   /** 
    * Called just before the nsImageFrame releases us. 
    * Used to break the cycle caused by the DOM listener.
    */
diff --git a/layout/generic/nsObjectFrame.cpp b/layout/generic/nsObjectFrame.cpp
--- a/layout/generic/nsObjectFrame.cpp
+++ b/layout/generic/nsObjectFrame.cpp
@@ -157,15 +157,18 @@ static NS_DEFINE_CID(kAppShellCID, NS_AP
 /* X headers suck */
 enum { XKeyPress = KeyPress };
 #ifdef KeyPress
 #undef KeyPress
 #endif
-#include "gfxXlibNativeRenderer.h"
 #ifdef MOZ_WIDGET_GTK2
 #include <gdk/gdkwindow.h>
 #include <gdk/gdkx.h>
 #endif
+#endif
+
+#ifdef MOZ_WIDGET_GTK2
+#include "gfxGdkNativeRenderer.h"
 #endif
 
 #ifdef XP_WIN
 #include <wtypes.h>
 #include <winuser.h>
@@ -359,11 +362,11 @@ public:
   
 #ifdef XP_WIN
   void Paint(const nsRect& aDirtyRect, HDC ndc);
 #elif defined(XP_MACOSX)
   void Paint(const nsRect& aDirtyRect);  
-#elif defined(MOZ_X11)
+#elif defined(MOZ_X11) || defined(MOZ_DFB)
   void Paint(gfxContext* aContext,
              const gfxRect& aFrameRect,
              const gfxRect& aDirtyRect);
 #elif defined(XP_OS2)
   void Paint(const nsRect& aDirtyRect, HPS aHPS);
@@ -475,22 +478,20 @@ private:
   nsresult DispatchMouseToPlugin(nsIDOMEvent* aMouseEvent);
   nsresult DispatchFocusToPlugin(nsIDOMEvent* aFocusEvent);
 
   nsresult EnsureCachedAttrParamArrays();
 
-#ifdef MOZ_X11
-  class Renderer : public gfxXlibNativeRenderer {
+#ifdef MOZ_WIDGET_GTK2
+  class Renderer : public gfxGdkNativeRenderer {
   public:
     Renderer(nsPluginWindow* aWindow, nsIPluginInstance* aInstance,
              const nsIntSize& aPluginSize, const nsIntRect& aDirtyRect)
       : mWindow(aWindow), mInstance(aInstance),
         mPluginSize(aPluginSize), mDirtyRect(aDirtyRect)
     {}
-    virtual nsresult NativeDraw(Screen* screen, Drawable drawable,
-                                Visual* visual, Colormap colormap,
-                                short offsetX, short offsetY,
-                                XRectangle* clipRects, PRUint32 numClipRects);
+    virtual nsresult NativeDraw(GdkDrawable * drawable, short offsetX, 
+            short offsetY, GdkRectangle * clipRects, PRUint32 numClipRects);
   private:
     nsPluginWindow* mWindow;
     nsIPluginInstance* mInstance;
     const nsIntSize& mPluginSize;
     const nsIntRect& mDirtyRect;
@@ -1370,11 +1371,11 @@ nsObjectFrame::PaintPlugin(nsIRenderingC
       nativeDrawing.EndNativeDrawing();
     } else {
       mInstanceOwner->Paint(aDirtyRect);
     }
   }
-#elif defined(MOZ_X11)
+#elif defined(MOZ_X11) || defined(MOZ_DFB)
   if (mInstanceOwner)
     {
       nsPluginWindow * window;
       mInstanceOwner->GetWindow(window);
 
@@ -2500,11 +2501,13 @@ NS_IMETHODIMP nsPluginInstanceOwner::Get
         GdkWindow* gdkWindow =
           static_cast<GdkWindow*>(win->GetNativeData(NS_NATIVE_WINDOW));
         if (!gdkWindow)
           return rv;
         gdkWindow = gdk_window_get_toplevel(gdkWindow);
+#ifdef MOZ_X11
         *static_cast<Window*>(value) = GDK_WINDOW_XID(gdkWindow);
+#endif
         return NS_OK;
 #endif
       } else NS_ASSERTION(mOwner, "plugin owner has no owner in getting doc's window handle");
       break;
     }
@@ -4040,11 +4043,11 @@ void nsPluginInstanceOwner::Paint(const 
   PRBool eventHandled = PR_FALSE;
   mInstance->HandleEvent(&pluginEvent, &eventHandled);
 }
 #endif
 
-#ifdef MOZ_X11
+#if defined(MOZ_X11) || defined(MOZ_DFB)
 void nsPluginInstanceOwner::Paint(gfxContext* aContext,
                                   const gfxRect& aFrameRect,
                                   const gfxRect& aDirtyRect)
 {
   if (!mInstance || !mOwner)
@@ -4103,20 +4106,15 @@ void nsPluginInstanceOwner::Paint(gfxCon
 
   // Renderer::Draw() draws a rectangle with top-left at the aContext origin.
   gfxContextAutoSaveRestore autoSR(aContext);
   aContext->Translate(pluginRect.pos);
 
-  // The display used by gfxXlibNativeRenderer will be the one for the cairo
-  // surface (provided that it is an Xlib surface) but the display argument
-  // here needs to be non-NULL for cairo_draw_with_xlib ->
-  // _create_temp_xlib_surface -> DefaultScreen(dpy).
-  NPSetWindowCallbackStruct* ws_info = 
-    static_cast<NPSetWindowCallbackStruct*>(window->ws_info);
-  renderer.Draw(ws_info->display, aContext, pluginSize.width, pluginSize.height,
+  renderer.Draw(aContext, window->width, window->height,
                 rendererFlags, nsnull);
 }
 
+#ifdef MOZ_X11
 static int
 DepthOfVisual(const Screen* screen, const Visual* visual)
 {
   for (int d = 0; d < screen->ndepths; d++) {
     Depth *d_info = &screen->depths[d];
@@ -4127,18 +4125,24 @@ DepthOfVisual(const Screen* screen, cons
   }
 
   NS_ERROR("Visual not on Screen.");
   return 0;
 }
-
-nsresult
-nsPluginInstanceOwner::Renderer::NativeDraw(Screen* screen, Drawable drawable,
-                                            Visual* visual, Colormap colormap,
+#endif
+
+nsresult
+nsPluginInstanceOwner::Renderer::NativeDraw(GdkDrawable * drawable, 
                                             short offsetX, short offsetY,
-                                            XRectangle* clipRects,
+                                            GdkRectangle * clipRects, 
                                             PRUint32 numClipRects)
-{
+
+{
+#ifdef MOZ_X11
+  Visual * visual = GDK_VISUAL_XVISUAL(gdk_drawable_get_visual(drawable));
+  Colormap colormap = GDK_COLORMAP_XCOLORMAP(gdk_drawable_get_colormap(drawable));
+  Screen * screen = GDK_SCREEN_XSCREEN (gdk_drawable_get_screen(drawable));
+#endif
   // See if the plugin must be notified of new window parameters.
   PRBool doupdatewindow = PR_FALSE;
 
   if (mWindow->x != offsetX || mWindow->y != offsetY) {
     mWindow->x = offsetX;
@@ -4185,20 +4189,23 @@ nsPluginInstanceOwner::Renderer::NativeD
     doupdatewindow = PR_TRUE;
   }
 
   NPSetWindowCallbackStruct* ws_info = 
     static_cast<NPSetWindowCallbackStruct*>(mWindow->ws_info);
+#ifdef MOZ_X11
   if (ws_info->visual != visual || ws_info->colormap != colormap) {
     ws_info->visual = visual;
     ws_info->colormap = colormap;
     ws_info->depth = DepthOfVisual(screen, visual);
     doupdatewindow = PR_TRUE;
   }
+#endif
 
   if (doupdatewindow)
       mInstance->SetWindow(mWindow);
 
+#ifdef MOZ_X11
   // Translate the dirty rect to drawable coordinates.
   nsIntRect dirtyRect = mDirtyRect + nsIntPoint(offsetX, offsetY);
   // Intersect the dirty rect with the clip rect to ensure that it lies within
   // the drawable.
   if (!dirtyRect.IntersectRect(dirtyRect, clipRect))
@@ -4207,24 +4214,25 @@ nsPluginInstanceOwner::Renderer::NativeD
   nsPluginEvent pluginEvent;
   XGraphicsExposeEvent& exposeEvent = pluginEvent.event.xgraphicsexpose;
   // set the drawing info
   exposeEvent.type = GraphicsExpose;
   exposeEvent.display = DisplayOfScreen(screen);
-  exposeEvent.drawable = drawable;
-  exposeEvent.x = dirtyRect.x;
-  exposeEvent.y = dirtyRect.y;
-  exposeEvent.width  = dirtyRect.width;
-  exposeEvent.height = dirtyRect.height;
+  exposeEvent.drawable = GDK_DRAWABLE_XID(drawable);
+  exposeEvent.x = mDirtyRect.x + offsetX;
+  exposeEvent.y = mDirtyRect.y + offsetY;
+  exposeEvent.width  = mDirtyRect.width;
+  exposeEvent.height = mDirtyRect.height;
   exposeEvent.count = 0;
   // information not set:
   exposeEvent.serial = 0;
   exposeEvent.send_event = False;
   exposeEvent.major_code = 0;
   exposeEvent.minor_code = 0;
 
   PRBool eventHandled = PR_FALSE;
   mInstance->HandleEvent(&pluginEvent, &eventHandled);
+#endif
 
   return NS_OK;
 }
 #endif
 
diff --git a/layout/generic/nsSelection.cpp b/layout/generic/nsSelection.cpp
--- a/layout/generic/nsSelection.cpp
+++ b/layout/generic/nsSelection.cpp
@@ -2534,10 +2534,11 @@ nsFrameSelection::SetMouseDownState(PRBo
 
   mMouseDownState = aState;
     
   if (!mMouseDownState)
   {
+    mDragSelectingCells = PR_FALSE;
     PostReason(nsISelectionListener::MOUSEUP_REASON);
     NotifySelectionListeners(nsISelectionController::SELECTION_NORMAL); //notify that reason is mouse up please.
   }
 }
 
diff --git a/layout/generic/nsTextFrame.h b/layout/generic/nsTextFrame.h
--- a/layout/generic/nsTextFrame.h
+++ b/layout/generic/nsTextFrame.h
@@ -371,10 +371,13 @@ protected:
   // start.
   PRInt32     mContentLengthHint;
   nscoord     mAscent;
   gfxTextRun* mTextRun;
 
+  // The caller of this method must call DestroySelectionDetails() on the
+  // return value, if that return value is not null.  Calling
+  // DestroySelectionDetails() on a null value is still OK, just not necessary.
   SelectionDetails* GetSelectionDetails();
   
   void AdjustSelectionPointsForBidi(SelectionDetails *sdptr,
                                     PRInt32 textLength,
                                     PRBool isRTLChars,
diff --git a/layout/generic/nsTextFrameThebes.cpp b/layout/generic/nsTextFrameThebes.cpp
--- a/layout/generic/nsTextFrameThebes.cpp
+++ b/layout/generic/nsTextFrameThebes.cpp
@@ -4513,16 +4513,22 @@ nsTextFrame::HasSelectionOverflowingDeco
   if (aRatio)
     *aRatio = ratio;
   if (ratio <= 1.0f)
     return PR_FALSE;
 
-  for (SelectionDetails *sd = GetSelectionDetails(); sd; sd = sd->mNext) {
+  SelectionDetails *details = GetSelectionDetails();
+  PRBool retval = PR_FALSE;
+  for (SelectionDetails *sd = details; sd; sd = sd->mNext) {
     if (sd->mStart != sd->mEnd &&
-        sd->mType & SelectionTypesWithDecorations)
-      return PR_TRUE;
-  }
-  return PR_FALSE;
+        sd->mType & SelectionTypesWithDecorations) {
+      retval = PR_TRUE;
+      break;
+    }
+  }
+  DestroySelectionDetails(details);
+  
+  return retval;
 }
 
 //null range means the whole thing
 NS_IMETHODIMP
 nsTextFrame::SetSelected(nsPresContext* aPresContext,
@@ -5893,10 +5899,14 @@ nsTextFrame::Reflow(nsPresContext*      
     aStatus = NS_INLINE_LINE_BREAK_AFTER(aStatus);
     lineLayout.SetLineEndsInBR(PR_TRUE);
   } else if (breakAfter) {
     aStatus = NS_INLINE_LINE_BREAK_AFTER(aStatus);
   }
+  if (completedFirstLetter) {
+    lineLayout.SetFirstLetterStyleOK(PR_FALSE);
+    aStatus |= NS_INLINE_BREAK_FIRST_LETTER_COMPLETE;
+  }
 
   // Compute space and letter counts for justification, if required
   if (NS_STYLE_TEXT_ALIGN_JUSTIFY == textStyle->mTextAlign &&
       !textStyle->WhiteSpaceIsSignificant()) {
     // This will include a space for trailing whitespace, if any is present.
diff --git a/layout/generic/test/Makefile.in b/layout/generic/test/Makefile.in
--- a/layout/generic/test/Makefile.in
+++ b/layout/generic/test/Makefile.in
@@ -60,10 +60,11 @@ _TEST_FILES = 	test_bug288789.html \
 		test_bug402380.html \
 		test_bug404872.html \
 		test_bug405178.html \
 		test_bug416168.html \
 		test_bug421436.html \
+		test_bug448860.html \
 		test_character_movement.html \
 		test_word_movement.html \
 		test_backspace_delete.html \
 		$(NULL)
 
diff --git a/layout/generic/test/test_bug448860.html b/layout/generic/test/test_bug448860.html
new file mode 100644
--- /dev/null
+++ b/layout/generic/test/test_bug448860.html
@@ -0,0 +1,64 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=448860
+-->
+<head>
+  <title>Test for Bug 448860</title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/EventUtils.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+<style>
+:focus {outline:2px solid red}
+</style>
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=448860">Mozilla Bug 448860</a>
+<p id="display">
+
+<img src='data:image/gif,GIF89a%93%01D%01%F7%00%00%F9%F9%F9%FA%FA%F5%EB%E9%CE%FC%FC%FC%E9%E7%CC%EE%EE%EE%FE%FE%FEhhg%A0%A0%A0HHH%ED%EB%D0333%F6%F6%F6%F0%EE%D2%C3%C3%C1%F1%EF%D3%DB%D9%C0%DB%DC%DChhh%9D%9D%9B%D5%D3%BB%C9%C9%C9%F1%F1%F1%E0%E0%E0%CA%C8%B2%ED%EB%D1%E3%E1%C7%DF%DE%C4%8F%8E%82%B9%B9%B8%F5%F4%E8%E8%E8%E7%D0%CE%B7%B3%B2%9F%E6%E6%E6%BF%BD%A9%B9%B8%A4%F3%F0%D4%D7%D7%D7%F4%F4%F4%DF%DF%DD%E4%E4%E4%84%84%83%F0%F0%EF%F7%F5%D7%90%90%8Duup%EE%EE%ED%EA%EA%E9%E2%E3%E2%9C%9D%9B%EB%E9%D2%D3%D3%D2yyt%F0%EE%DD%93%92%85%E5%E4%C9%EB%EC%EB%F5%F2%D6%85%85z%93%93%91%C4%C3%AD%ED%ED%ED%E5%E3%C9%88%88%83%7F%7Ev%AA%AA%A7%F5%F5%F5%C5%C4%C2%CF%CF%CF%8C%8B%80%AD%AD%AC%DD%DD%DC%F9%F7%D9%8C%8C%8A%B8%B8%B7%B1%B1%B1%80%80%7E%85%85%7E%A8%A6%96%AD%AC%9B%87%87%86%F7%F4%D7%C6%C6%C5%97%97%94%5B%5B%5B%EF%EF%E1%AF%AE%9C%9F%9E%8F%AC%AB%99%92%93%92%95%94%87%9C%9B%8C%80%81%81%F7%F7%EE%A7%A6%95%FD%FC%F6%9E%9D%8E%A3%A2%92%FC%FB%DD%98%98%98%EA%EB%EA%98%98%8B%8E%8F%8E%95%95%88%ED%ED%E8%D6%D6%D6ddc%81%81yooi%A1%A0%90%9B%9A%8C%5B%5BZ%AA%AA%A8%A4%A3%93xyv%A7%A7%A7%7E%7Ev%D0%D0%CF%C8%C8%C7%AC%AD%AC%B1%B1%B0%A6%A5%A4%97%97%95%9A%9B%96%F0%EF%EF%C7%C7%C7%F3%F3%F3%C4%C2%AD%BF%BF%BF%D9%D9%D9%A2%A3%A2%AA%A8%96%D3%D3%D3%E9%E9%E9%E3%E3%E1%F8%F8%ED%A7%A7%A6%98%9A%99%A2%A2%99%A7%A6%99%A3%A5%A4%E2%E2%E3%F0%F0%EB%A0%A0%96ooj%C9%C9%C3%CA%CD%CE%AA%AD%A0%A0%9F%96%F4%F4%EF%EA%E9%E4%E3%E2%D2y%80%80%E8%E6%CB%FF%FF%FF%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%21%F9%04%00%00%00%00%00%2C%00%00%00%00%93%01D%01%00%08%FF%007%09%1CH%B0%A0%C1%83%08%13%2A%5C%C8%B0%A1%C3%87%10%23J%9CH%B1%A2%C5%8B%183j%DCx%B1%00%00%8E%20C%8A%1CI%B2%A4%C9%93%28S%A6%F4%A8%B2%A5%CB%970c%CA%9CI%D3%21%CB%9A8s%EA%DC%C9%B3%27%CC%9B%3E%83%0A%1DJ%B4hO%A0F%93%2A%5D%CA%B4iD%A4N%A3J%9DJu%27%D4%AAX%B3j%DD%AA%F1%2A%D7%AF%60%C3%8A%F5%2A%B6%AC%D9%B3K%C9%A2%5D%CB%B6-M%B5n%E3%CA%9D%1B%12.%DD%BBx%F36%B4%AB%B7%AF%DF%BC%7C%FF%0A%1E%BC60%E1%C3%88%B7%1AN%CC%B8q%D3%C5%8E%23K%0E%0Ay%B2%E5%CB3%2Bc%DE%CC%F9%A4%E6%CE%A0Cw%FD%28%BA%B4%E9%92%9FO%AB%5E%7D05%EB%D7%AB%5D%C3%9E-Z6%ED%DB%9Bm%E3%DE-Y7%EF%DF%89%7D%03%1F.X8%F1%E3%80I%23_%9E%5B9%F3%E7%BD%9DC%9F%1E%5C%3A%F5%EB%C5%ADc%DF%9E%9C%BB%F7%BE%C6%BF%8B%FFw%1A%7E%BC%F9%A4%E5%CF%AB%17%9A%7E%BD%7B%AB%DA%DF%CB%A7%DA%7E%BE%FD%9F%F1%EF%EBG%9F%7F%BF%7F%F6%FD%FD%27%20%7C%03%168T%7D%06%26h%11%82%0A6%F8T%80%0EFh%12%83%12V%88%10%85%16f8%10%86%1Af%C8a%87%15%7E%08b%84%22%8E%D8%60%89%26%26%88b%8A%05%AE%C8%A2%80.%BE%E8_%8C2%EAGc%8D%F6%DD%88%A3%7C%3A%EE%E8%5E%8F%3E%AA%07d%90%E6%0DI%A4xF%1E%E9%5D%92Jn%C7d%93%D7%3D%09%E5tRN%F9%5C%95V.%87e%96%C7m%C9%E5p%5E%7E%F9%5B%98b%EEFf%99%B7%9D%89%26U%00%0C%00%E0%9A%AF%01%F0B%0E1%0C%12%C1%9Bp%9EvB%11G%B4%B0%83%1B%244%E1%A6Oj%E6Y%D4%0A%08p%00B%03I4%20%C0%17z%0C%CAS%A1%86%0A%05%C0%11%84%8C%A1%00%01%9Ah%22%00%04F%A4%60%C0Q%10V%DAX%04-%94%20%40%A7%AC%96%40%02%10%92%EA%FFD%A9%A9%3DU%80E%12%AC%B2%CA%A9%19%0E%C4%8A%D3%AC%B4%EE%E4%C0%17%3A%E4%CAj%03%3D%28%01%C0%A8%B2%96%1A%ECa%0E%10R%AC%B1%9A%10%D0%00%16%1D%F8%FA%96%B3%CF%0E%E6%C0%15%25P%DB%A9%ABd%2C%DBl%B7%989%10B%B8%E2%2A%00%01%0F%29h%2B%13%B0%E8%D2%D4%01%09%EC%8A%3B%06%1AEp%EB%99%BF%F5%EA%D5%C1%08%0D%88%DBi%1278%60%EE%AF%00%07%8C%97%1E%3D%14l%B0%0E_0%C1%00%B35%D1%EB0L%40%80%A0%80%C1%9A4%40%82%10%16%C8%8B%DF%C6%8E%01%80%06%04%AB%1A%AC%00%05-%C4%9B%93%C6%28%ABDC%08%D5%82%ACI%12%40D%60%F2K4%D7%8C%12%02%18%B4%0C%B2%14%3B%98%D0%F0HA%0Bm%92%0A%2C%EB%ACI%09%1C%D0p1%C3N%1F%F6%C2%0D%1Bp%AA%B3%02Wtp%02%C6%99-%9D%F5YJ%80%20u%A7%04%40%40%C5%0B%3F%B7%D4%F4%D9%20%1D%C1E%CEk%2B%E0%02%0Cq%AB%FF47%DD%1A%D1%81%85%00%5E%AF-%C0%0DJc%0Dx%5E%7Cp%B0%E9%DA%B9b%40%06%03%8A%2FNW%07%1C%E0P8%E4%9AhP%C3%09%7D%A3%F4%B7%E5%13%BD%B0%83%00Fs%AE%09%0E%5C%F4%9A%B1%D9%A4%B3yD%0F%1F%AB%AE%2B%05M%5C%5Dv%ECqY%D0F%03%9B%ABN%C0%06%40%5C%10%FA%84%B0%F3%1EU%117%E4k%3B%DB%18%B4%90%7CF%A3%2B%CF%10%03tP%90%FA%F3%9F%EE%F0%02%D9%40Oo%BDR%29%D40%ED%F3%B9%0A0%82%B2%BB%8Fo%96%01%1DH%8B%BE%B1%02l%60%84%09%E0%CB-%BE%FBD%7D%10%04%0E%DB%9B%9F%02%5E%B5%3F%8AT%8F%7F%05%11A%13%D65%3Fj%09%00%077%C8VL%0E%E8%BE%08%E8%81%0C%3C%A0%C2%0Dz%80%B7%06%E6%EAe%2A%88A%FEDW%40%04%D6%C4%04T%80%00%04%28%40%01%96%05%D0%83%04%18%A0%12%2Cp2%13%FA%E4%03wr%C8%14%E4%A0%03%D4%A1%CE%83%20C%9D%19%FF%84p%3C%90P%B0%5E%0E%E0%01%1F%F4%20%82%86t%80%81%40%CC%DB%06%94%80%82%11%A2%A6%846%D4%08%03%A8P%B4%F55q%21%83%88X%14%21%27%85%2B%0C%A2%88%1B9b%B7V%00%89%0D4%40%0A%18%00%C2%07%142%00%3EP%A0vc%D4Y%FDZ%10%034R%0F%8BY%C4%C8%0A%16%B1%81U%25%21%0B-%A0%1CB%06Y%C8%3C%AEm_%15%F0%23F%D4%F8%AC%1C%10rU%D6%92%83%10%14i%90%220%82%00%C1s%24%B5%C6%D0%82%0A%E8%8E%84%81%D4%C9%07%18%A1%81%96%09%A0%01f%40%40%04V%60%90%23%90%40b%A2%04Y%12vP%84S%FE%2B%959a%C0%CA%8C%F6J%12p%80%07%17%20%C8%00Z%80%01%3C%E6R%5C%0D%08%01%25%3AP%04%1A%E4%10y%C0%C4%89%018%A0%BD%5CYk%0C%20%E0%E3%09%18%00%80%0A%C8%A1k%CF%04%19%01p%D0%83%10%7C%C1%0DFP%186%B39%13%18%E8%C1%0D%E8%A4V%12%B0%00%FF%04%1E%F0%80%0C.%00%C1%0B%D3%A9%AB%06%94%40%07I%20%00%17%E8%00%B0%14p%8B%92%5Cj%D3A%180%81%16%84%80%02%3A%2B%81%14%A4%A0%03G%11%D4v%02H%02%1A%22%E9%90%01%1C%21%08%AE%DB%0B%20%E9Y%90%17%1C%C0%05J%88%E9%0D8%D0%02%04%A8%E0%A2%1E%FD%28A%05%A0%01%25%AC%C0%8A%04%E9%00%10F%10%84%3B%2Cl%21%10%B5R%130%B0%3A%0Dl%60%03%10%00%01%06%3C%E6L%9D%A63%09M0A%DC%8A%D0%04B%40%C0%0Dt%10%01%E8T%CA%D2%91%9C%A0%06%1A%D0%15%28%05%A0%80%81ZU%94%EAS%82%08%0F%02%83%26%60%01%03%B0%A4%C3%05%C4z%BC%A4B%A9%05%18%7D%AB%60%0DV%82%2B4A%04%A7%8C%00%10%D0%00%02%0D%E8%C0%08G%40A%0C%5EpT%85%F8UI%270%82%5B%07%FB%D6%06%80%20%08T%D0%EA%14%9A%A0%A8B6%60%07L%88%C0d%2Bk%D9%95%B2%14%00%2A%C0%40%F0%AC%A5%03%29%FF%8Ca%0CI%A8%2Ag%1D%29%80%12l%40%0E%1C%B8%02%0E%D2%8A%BA%20t%40%B5%94%05%AAA.%1B%24%03D%60%07%B8d%9B%06%B8%C0%81%1D%B8%00%08%1C%28%DAn%09J%80%1F%B2%0A%0758n%0CV%C0Z%A4%BA6%9B%00%98%40%23u%B5%8160%A1%02Sp%C0%14%3A%10%84%CDn%D7%918po%04R%40%5E%E5%B6%E6%BC%C0%3CA%0Bp%A5%2B%1C%5Ca%02%11%B8%40%0CR%20%02%11%D0%01%8A%F7%25%28%0EH%20%CB%14%94%CC%BF%FF-%2BG%2C%C0%83%12%14%AE%7B%26%98%EC%09%C6%C9%00%14%A05%94%11%1E%E3%F0nP%84%F1JrC%00N%E5%A5%08%C6%2A%01%E0%EE%02%94%1D%80%01v%CC%80%23%5C%21%BA%DE%04%25%8AS%AC%B3%B6%ED%00%05%C95%60%8CS%19%81%E6%B1J%01%3D%88%99%2F%0D%60%02%0E%9C%CFSl%FD%98%0A%21%90V%22sn%C5%26%18%5BE%98%1B%24%18%28%E1%8E%9D%12%19%19%3E%60%9D%0B%28a%FF%0C%AF%EC%E8%06%A4%DAN%23%D4%20%085%E8%A6%97%A5F%00%0D%B8%A1%97%0BZr%20%070%85%20LK%01%20P%01e%0D%F2%81%16%E8%00%02%23%B8%02%23%CC%10S%15%D0%C1%04%11%88%C0%14%DA%E0%A9%3D%EBQ%03%90%B0%1A%86%13Bf%1F%19%00%00%83%80%A2%02F%E0%82d%16%04%00z0B%0Bx%80%00%3AL%21%D3%11%90%AC%08%3E%F0%81%23%DC%80%C0%9E%16%17%A7%18%D1%01_%3EH%C3%20%214%B1t%05%82%1Dt%A0%20%06%88%01%13%8A%90i%05%EF%1A%06%2F%B0%009%01%90%83%16%E0%2B%D8%84%0D%C1%11%C4%ACddsd%00%0E%C8%C2%95%87%87%06%04%90%0D%00%2B%D8u%0E%B2%BD%ED61k%00%5C%85%80n%C1-2%04%8C%B5%DC%E6%CEH%0E%EE%E0m%E7y%8A%00f%60%02%C6%06%00%80q%B6I%C7%0795%138%00%3Cp%1BKd%24%7B1%8C%03%8E%11%06%20%80%0B%1B%E8%60%AB0%C0%83S%1A%00%E2%0B%FF%19%00%87%B3%00l%8B%EF%EC%0BBX%81%C6%05R%EA%1A%0D%80%09%83%1B%A8%B5np%07%8D%0F%E0%02%2AX%94%CB5%F1%B2%1D8%00nc%16%B4%09%EF%C0%B5%7D%B7%AA%07%7C0vCN%DD%81%1BtZ%941%3Ch%12%C6%D0C%D5%E9%20%0B%13%88A%C9%92%CE%F1%8A%7C%A0c%06%A7%96%B5%E2%E9s%0B%28%01%C2%40%7C%A5%14J%40%81%2Cp%01%0DF%F8%C2%D4%86L%BF%0D%EC%60%93%A3%BE%90%D2%DD7%00%25%7C%DBX%DDU%C0%E3B%86%BB%0F%04%BE%20%3Fo%02%05%80%CC%3D%29%40%00%0BAP%01%0F%98%E0%80%0Et%80%0C%40%C0k%C1b%D8V%14%F7%D9%0CGx%FCr%07%3F%BE%29%60%A1%95%C6b%27%168%90%05%D8%87%EC%C0%27%98%C8%A9%EF%09%CA%F9%3D%90%10mP%81%03%2AP%01%13%A0%00%05%0A%96%B6%12%CC%B0%28%01H%15%02%21g%5B%A7%E2%8C0%07%A8%9E%205O%11%03%800%F9%5C%B9%CA%05%13p%40%FF%11%12EtO%29%00%084%F0%F9%0Bj%40%3B%DBq%0A%07r8%80%1E%AA%99%E0%18%7C%20%07%2B%B0%80%FEs%10%01%3E%28%21%0B%23%D0%06F%80%06r%A0o%9D%02%02F%10%7Cw%16%7F%F83%11%D9g%22%15%20%5C%5E%03J%25%80%06%0E%90k%17%10%01%83%60%04%E5%E7Yos%7D%021%00%26%B0%03%1B%E0tj%27%00%18%D0%06%97%96k%29%80%7F%0E7%000%C8p%16%F0%01%26%40%07M%D0%04%99V%03%23%A0%01%3D%10%04m%D0%01%26%60%024P%04%1D%E0%02%7C%F0%02%0E%C8z%CA%C3%04%23%A0%2A%A8%A3%018%40%08%3C%60%02%22%90m3%88%00%A73wcp%3F%1Ag%00%D8s7%F6U-%02%10%02.P%01%09%F6%01%2F%40N%3A%06%3E%27%C7%00%2B%F0%011%90i%22Pu5%A0%04%D6t%860%00%874%60%022%27%11%0F8%22%A8B%02%2CD%01_%E0%02%97fa%0F%07%000%D0%015%E0%06_%FF%C0%05A%A04%20%B8%09%03%90%03%0B%D4%7B%EA%D4%00YP%03E%80%02%22%B0%02%0C%80r%09%D1%86%2B0o%0Cp%02%1F%80%02%2C%08%03%DA%06%00%A7%B8%02%2F%F0o%10%F1%87%20%F2s%40p%03F%D0%04%A9%85%5C%0Bsj%2Fp%07%9D%C7%04%1D%10%03RWR%11%10%04%025d1%D4%03.%40%03%28%00%03%A0%F3x%27go%03p%02y%18%8B%F6%B6%09%3B%C6p%12ule%17%11%03%C0%000%90%81%B9f%7F%FDE%10%A7%16o%17%B0%8E0P%8CS%07%004%10%04z%E6%40%18%E0%02%C6%D7%8E3%27%10%D3%98%8D%06%B1cI%F8%8D%12%11%8E%2F%C0k9%A0m%A28%10mh%01%F9%17%8A%16%11%8E%9B%165%F4C%01.%D0%89%F8%88%27%00%09%110%08%00%1Ay%90%02q%04%AEvr1%88%11%D5%C8%04.%00%91%D2W%03%0E%F0%8C%0Ci%91%17%A9%11M%D0%03%1C%E0%00%22%A1rzP%03%EBEtr%FF%40%06%11%F0%01%2B%C9%92-y%3D%CF%98%03%D2%C1%00%07%00%02m%13%04%3F%15%12%03%B0%02z%C0%01%B0%D76m%B0_cG%14%B4X%8B%0E%B0%03%90HD%03Qx%23%B0%2A%CE%07%2B%21%91%8ELp%03%9AC%00%28%85cJHv%3F%D9%10%DB%A7%03%25%D0%00%5CP%01%A3%02%00%08%F0%05%A9%83%05G%90%8F%A3%08ot%60%06%0A%90%05%3D%C3%93%93%18%3Ek%D9%10%16%B0%03%E1%D2g5p1%23%B8x%D5%02%01%3B%80%00%17%A8%97%FD%08o%2A%20%075%A0ZSY%14U%D9%21%11%C0%05%B8%D4%03G%C0%00%2A%D0%5D%3E%A4%00o%09%01%24%40%09%90%40%05%20qj%11P%05%09%B6h%FCQ%98%29%27%04%CD4%7D%20%40%060p%00%21%D0%03%180U%23%80%05%24%20w%20P%03%E5e%11%5E%18b0%90%9C%94%91%96%B1S%01%40%20%05%BA%12%02d%B0%02%7BB%07z0%08%13%20%04S%00X%0D%A0%01%F1%FFD%5E%C9%E6%86%EE%F8%9C%B6%89%10%16Pu%06%E8%29%14%904%B18%8E%B8%96i-%00%01%0A%85%00%28%20%94J%D9%8DJ%D1%99%0DB%03%E2w%07T%80%06%AF%F4d%24%A0%04%17%40%5E%AF%08%8B%2F%80%02-%20%05%81%22%95%94%89%10%83%D9%3Ek%C9%00S0%08%7C%B0%08_p%05_%D0%03I%40L%1A%80-%22%80%2A%13%00%3A1H%03V%D7%04w%90%A0%13%AA%15%FE9%20E%C0%01%23%B0%28IpP%40%B6%2Ax%09%03%C3%22n%83b%02.%80%01%90%92%9F%CE%29%171%2A%20%15%10%02%9A%C2w%21S%8F%83%D01%20%00%04%CB%22%04A%00%01%C9b%02%3C%F9%A20%0A%9D%28s%2Fi%D7.%1AP%A3mU%88%16%A5%01%1A%10A.%96%1D%859%00DCy%06%83%89%9D%A3B8%00%A1-%10%01%CDY%A1aq%A4%FEq%29%98%40y%5E3%03%9C%02%A8j%D7%5D%B0%C4%04%829%18z%BA%1F%2F%00%03%01%FF%10%00%1E%60%036%00%A8%1E%E0%A8%93%1A%00%5E%D0%A8%1E%20.%25%80%094%20sx%3A%16%5Cj%28%15%B0%09%29%90%02%05%A1%7F%2Fp%04i%D0%A8%8Dz%A9%AB%1A%00%28%B0%AA4%B0%AA%99%9A%2B3%00%06s%D2%26Gp%04%081%AA%A5%1A%17%89j%1E%0B%B0%09%08%80%00%04a%01%090%08%1D%B0%00%13%D0%AC%E1%17%00%0EP%05i%40%03%2A%E0%02%CB%DA%01%28%10%003%90%2B6%00%06%83p%00%E0%9A%00%09%00%AE%07%C0%03%041%AC%C5%0A%AC%A1%9A%27%E8j%AC%3C%40C%9B%60%02%3CP%05-%E0%AC%CF%1A%00%2Ap%00-p%00%E2%0A%AEB%10%006%E0%01%5E%E0%05%1Ep%ABE%20_w%A0%02%2A%40%7C%C5w%AE%C4%EA%AE%F0%8A%16%C1%EA%1D%08%B0%00%16K%AC5p%00U%60%02%C4%3A%01T%90%00%16k%B1%07%60%A9%8DJ%034%C0%AF%E3%DA%02%98%CA%AA%8E%1A%00%1F%40%06%E3%DA%AFUp%00%02Q%B1%17%FF%8B%00%19%BB%B1l1%B1%E2%81%AE%09%60%AC%02a%01U%E0%00%F5%EA%00%C27%B2%D0%DA%9D%0E%90%00%CD%9A%AF-%9B%06%E2%BA%AA%5E%F0%B2%07%80%00%E0jS4%EB%B0%08%F0%B3n%C1%B3%DF%D1%AE%03%11o%260%01%21%1B%B2%23k%B4%07%B0%B4M%3B%B2%93J%03%16K%03%8E%FA%02d%B0%B0%0A%5B%01V%5B%10%60%DB%B5%EB%BA%26G0%AC%13%C0%03%22p%04%0E%00%03%96%D0%02E%D8%01%CD%DA%01H%0B%ADi%CB%B4%13%E0%B4%02%1B%00B%F0%AF%5E%60%03%01%60%B5%20%BB%00%E3j%AE%03%D1%B7%0F%BB%09%40%B8%B3%7B%2B%26%5B%7B%00%C3J%06d%10%00d%C0%07%8D%9A%00%1D%90%00U%00%BB%E2%0A%B7%92%5B%05%27K%AE%2A%AB%AD%2C%3B%03%01%00%06%220%01%09P%035%F0%B3%F0Z%BA%60%9B%AE%851%BA_%D2%01%A3%EA%B7%070%01U%F0%AFB%90%00%28%B0%00%0E%E0%00%D0%DB%02%AB%0A%BC.P%05%F6Z%AF%00%FF%3B%03%90%2A%BE%92%3B%AE1P%AC%29%A0%02%09%A0%02%A0%DB%BC%C4Z%B5U%C0%AB%C9kn4%BB%02%F5z%04%60%00%064%F0%AF%AC%FAR%AF%EA%8C%01%40%03%F6%FA%AC%DB%CA%2A%BC%8B%02%0E%F0%01%26%25%BF%290%AA%03A%B3%16P%AC%F2%3B%BF%1C%87%8A%22%10%03%D9%CA%AA%95%8A%A9%97J%B2%2C%DB%AA%C13%A9%60%A0U%9F%9A%A7%CA%0B%27%DC%96%02%26%10%04%E2%5B%C0%01%FB%A8%9D2%03%DB%2A%BE%90%3A%BE%28%26%BE%1C%C07%84%E1%B5%E3Q%8D9%00%03%40%C0%A4%0Dd%04%17%C0I%7F%C1%C3%E21%8D%0C%C0%03%26%E8AY%E0%00F%EC%17Hl%1E%DB%E7%A6%40%84%03%21%206%25%FC%15S%3C%1E0%00%5D%CFd%60%0E%40nG%7C%C2y%02%00%7C%20P%B9%D4gO%BC%99Rl%C6k2%00%1D%E0%06V%0CC%1A%40%08S%E0%C6%E0%01%C7eb%00%0E%C0%01%84%F3L%7D%F6%05%15%20%8Bo%5Cv%0EP%039%FF%B5%C6%1A%40%C8d%7C%C8%E6f%00E%B0%03%00%B4S%A0%12%01%8F%BC%C7%E6%86nF%D0%5D%1F%05B%29p%9Et%D1%C5%D4Ah6%19%86%1E%A4%00%18%C0%07%88%B5%C3%7Cl%25%26%00%04%ED%F9%C9P%C7f%AE%ACa%03%20%04pGP%223%08%B6%8C%A8%AF%0C%25%0E%60%06%DE%A5S%22s%04%CDy%CB%2C%D5hx%25XI%E0%06G%A0%9F%C0%FCZd%10%02%D4%F9V%D6%82%06%1D%D0%87%D3LO%1D08B%9CG%2F3%85z%AC%C9%D9%94%027%80f%82%A5%03%210%01%7C%A5%CC%16b%01K%A0%10%40%BB%09j%F0%AB%0Aa%01%1Ck%02%11K%AA%C4%17%B4%1CK%11%2F%B0T_JP%3C%C3%04w%0A%CF%FEQ%01e%1B%B2%120%10K%00%07x%20%01%14-%01x%20%10%0D%BC%00%15%40C%12%80%00%0F%AD%10%15%40%B3%07%E0%C05%2B%AE%2A%60S%3F%5B%CF%0F%F1%01%3C%40%02M%9CK%C82%85H%A7%D0%FB%FFQ%01%1F-%01%A3j%D3%03%21%01ZP%D1%15%AD%06%9B0%D1%0B%20%01sP%B6%0B%11%D2%9B0%D2%1CV%B36U%AC%EA%8B%BClI%03BU%9C%E1%ECHI%60%04%1D%90%02%86%5C%C6%03R%01%09%40%D1%09%00%07%12%20%D6%02%C1%D0KP%ACh%8D%074%A4%06%0C%5D%01Z%80%00Z%60%B7%09a%BA%0B%20%D2%3C%10%BC4%84%00w%CD%03%1A%3B%AE%070%C1%09q%02%15%A0%07%3B%F0%058P%C7W%F5%05%08%60%02B%B9%C5%60A%CAIQ%01p%40%7Cp%80%00v%FB%D1p%90%00n%ED%D3%17%BD%09%3D%3D%D4sP%ACQ%F0%D1%9B%E0%D5sP%10H%CD%AF%CFV%B3%EA%5B%01%2AP%05%0A%8B%00%AB%9D%10%26%D0%027%80%01%3A%D0u%9CU%02%3D%00%04E%A0%D5Z%FA%D8%C1%CC%19%5E%5D%AC%09%10%05%080%DA%02%B1%048%DD%D3%15%DD%D9x%80%07%1A%FD%D6K%B0%00%9DM%AC%9A%8B%DA%22M%D2%0F%FB%DA%0B%FF%60%B5%9A%1B%D0%08%81%2A.0yU-J%C8%82%92HV%A4%DD%81%A4%29%7D%DC%C9M%DA8%8D%07hm%D9L%3D%D4%99-%01%DF%ED%C0%11%CC%DD%1C%B6%DD%C4%9A%D7%F9z%00%0A%9B%D2%0A%01%00M%00%02%3D%B0%03%F6%B9%5B%0D0%02%28i%A7%A2%DC%DE%06%82%D3%06%81%D3c%0D%D62%A0%91%5D%00%B2jP%AC%12%9D%00%A6z%10%2AP%D7%00%3E%D2%18%AB%02%26%80%D2P%7D%10%86G%00%BB4%02%BBU%02F%00%04%15%80%02Y%CA%18%90%CD%14%16%5E%10%18%DE%05%7B%B0%07k%B0%07%3Ep%01%09%B0%04%09%B0%062%00%D7%C5%0A%D4%07%81%00%0D%2C%D2%27-%E2%0F%9B%02N%9D%D2%DCM%10L%E0%06%81%7Cy%5D%A6S%9C%A2%00F%40%06%CE%08%8D%C1%0D%AA%0A%A2%05NN%108%BD%06u%A0%082%20%012%90%BFq%00%06%8F%90%07g%B0%E4-%7E%10%F2%1A%AF%C5%EA%C0%E8%5B%DF%7F%7E%104%B0%03%98%D8%00A%FF%00%E6%0F%04U%A8e%02%17%90%03%3DY%1D%1D%02%00%29%90%BF%1F%CC%B2%88P%06%8E%CD%10%16P%92%9B%E3%02%D1%F7L%ABRw%D6uk%ABu%E6e%B1%E3U1%00D%60%05%1E%60%05V%80%08%1E%C0%02%0F%60%05%F5%A3%01y%E0%08%EC%BD%11J%90%9B%D2%E7N%E7%AD%3A%F5C%02%07%40%07%99%E6%89%E7%18%19%AAN%15CP%07%2C%E0%29%0F%80%01%21%40%02%23%00%08%21%10%05l%80%07%17%D0%07%A8%FE%E4Y%C0.%BD%C5%29%10%D0%06%2F%FD%3Cm%C3%01%2APm%22%90%03%D18%19%13%FB%07%1A%F9%15%17%10%06%19%C0SP%C0%06Z%D0%08%08%20%03%89%20%08%82%80%04%220%04%2F%CApn%02%03%98%16%01B%C0%04%08%40%A0%9CR%3Fnp%05%EED%08%A8%AC%3AgZ%A78%0E%8A%FC%19%1D%7E%F1%07K%10%08%08%90%08q%40%04%87%90%02e0%04%9B%1E%13%03%B0%04%23%F0%00%10%B0%05Z%60%07H%B0%8E%EB%FF%E8%08%29%60%08%E5%1C%900%C0%045%B0%03%1C%60%06%21%00%F1t%165%F5%F3%27W%00%80%D7%8C_%24%90%EE1%00%E9%1C%A9%F1%7D%91%07%5B%40%02%2AD%01%21%10%06%1C%10%052%A0%06%C3%FD%10%16%A0%08%02%90%01%80%20%011%FF%01%3E%D0%07%16%60%F6C%C0%8F%15Ah%07%D0%03%3A%F0%7E8%10%F7%8A%D7V%9E%02%01%1C%E0%06n%D9%00%E5%0ER%10%90%99%ABu%F2%EA%AA%17%22%B0%04l%40%EB%19p%F8%0F%F0%00%2C%C0%02%1A%C0%01%89%00%F8-%F1%01Q%C0%02m%E3%04%81%E0%03%02%1F%83M%3F%11%27%D0%01m%80%03%BA5%5B%3DP%03%09%B5S%18P%03D%0A%F9z%2B%17%22%90%07%20%DF%08q%10%06b%B0%F2%06%13%ED%8A%B0%EBBQ%01a%40%F9%04%10%02y%20%F0%21%01%03%83%80%06R%10%86%9F%92%05%B7%C4%5D%8D%DC%01%88%A5%FA%AB%CF%16%F0%C3%06%B3%0F%08%18%00%08%8D%95%F8%3F%600%19%00%02e%FF%B8%F5%0B%21%02Q%C02%2C%CF%06H%60%F2%20%81B%EAV%D5%CE%C7%05p%DA%40%0A%20%05%5B%27%05%1E%F5%29F%10%01%D2%0C%1Aa%D2%01M%90%E5%13%01%10%26Td%D9%A0A%C0%83%0C%09%05%10%D0%D4%D0%E1CM%194%3Cq%11%25%10%80M%195n%E4%D8%D1%E3G%90%21%3F%0A%E2%80%01%21%08%272R%FC%19%20%D2%E5%C6%13%1D%80%60H%02%D1%E6C%05%18%B8%E8%B8%D9%F3%26%81%06%14n%18Ac%86%84%06%05%0A%40%18%89a%A1%E5K%A8Q%A5N%A5Z%F5c%01%8CV%B5N5%C1C%C3%0D%04%06%40%9E%10%91%E2C%8E%15%16N0%00%00%A0H%0D3%10p%2C%F4Y%97%80%00%01%1BHp%E8%22h%EB%DF%A8K%A2Px%A0%89%C5%93%BE%1F%00%88%05%BC%89%C6%84%1B%1AJ%D4%B5%A9%A0%C7%97%9A%94%7D%DE%0D%D1DH%87%0EL%10%98%D1Tb%04%15%11%0C%1A%AFf%DDZ%2AV%D7%B1%85%5C%91%A2a%07%FF%1D%C6%1B%2B%88%A6%C2%83G%0B%E0-%A8%28%09%E2%06%82%26%02%0C5%2F%D7%84%81%AF%A3%D8%AB%FFDy%B3%A1%B0%A6%07%24%B4%1C%EA%F34%E3%9F%3E%7F%DAzw%19%81%09%87%1EI%040oH%20%09%86%1A%3D%1A%B0%87h%BA%C9%9D%08%17b%A4%B8%C0%E3%CA%98%10%26%80%21%AB%E8%0A4%100%D8%0E%FC%8B%06%2A%E6%12%40%03%2CZ%28%E2%85%15L%E8%E0%08%0E%B2%A0%A0%841%3AL%22%09%29th%60%3D%FA%98ch%03%0C%DE8%03%09%05%A9%22%22%8A%A3%AE%D3%E4A%0E.%CAM%10%19%A2%E0%20%8A%3D%F6%90%21%10A%04A%E2%02%B3%60X%21%82%29%A6%08%CD%3F%02x%A2o%A1%10v%E0%02%03%05Jl%A8%81%11%82%B8%03%85%0F%5EP%CB%82%29%80%18c%91%0Er%20%B0E4%D3%BC%EAL%AD%C8k%8D%87%11%E6%9BQ%03%0C%18%81%04%92E%E4%C0%A0%01%29%14P%CEJ%40%1D%BAk%83%11%DE%D8%C3%0F5C%12%FFa%0E1%20%C0%0B%A2%07P%12%84%B1%0B8%80%80%85%07%10%CA%00%82%11B%08%01%0A%28%9Ex%82%91E%18%A1%84%12BH%C0A%BD%12%F1%CA%E2%86%116%90%B3%C4%12z%08%C2%01%14%608a%00%5E%07%C8%81%0F%0CZ0a%057%135%B6%C5%04%B7%3A%81%86%0Fr%5BM%0F7%1Emo%BE%0D6P%40%8A%06%FE%0Ct%5B%87%F0BQ%0C%04%F2%28%C4%822%0A%29D%C8%0B%0Ciq%08-%9C%C0%E0%07%BAlz%00%83%28%FC%B8%40%0D-F%60%E1%A6%1F%FA%D5%E0_%0D6%D0D%87%10G%5CN%5B%01%14%40%C3%08%08%0C%B6R%00%1C88%82K%06%C8%1B%80%89%1A%A8Ha%D7c%3BF3Y%AD%8E%B8%A1%0D%13%ACb%C0H%F2%5E%E0%81%82l%21%BA%2B%5Enc%86%E8%A0%E6%A0%A8%04%81F%E6p%E2%890%B6%E0%60%12%1F%8A%FDk%00%00%0C%D9%83%8Dw%91%AB%EB%01%0A%C4%08%E3%0D%C2%ECJ%EEe%12%97%CB%FF%29CM%AAL%8A%83%1D6%DCV%87%10x0%E1%03%8E72%20%87%0E%EE%F8%80%01g%3Dv%DB5%90%AB2%80%0A%0A%40h%22%05%AAL%A0%83%07%2A%3AX%5B%AC%23z%20%E1%28me6%7C%B3%0CX%C8%8B%0010%60%E1q%02%C2%98c%09%1F%00%10z%AA%21%FA%28%A4%0B%27%28%60%A8%F0%9E%12%7F%3C%83%C3m%CA%0B%8B%10%AE%A8%E1%0B%01%20%A8%C1%D2%2A%03M%F8%86%0E%9A%12z%00%0BP%7E%7B%F7%D8%E2%CE%FB%06%08%A4%B8%82%8F%132%02%40%0F24%1A%A0%88%29%22%D0%E8%03%26vH%8F%80%2C%85%05%80%0A%12Z%A8%02%84YK%F7%FE%27%A6%9F%00%81D%01X%C8%00%90%3A%A2%A8%E0%F2%97%2C%40b%0F%17%C4%D8%80%F4%EFen%80%84%2B%1C%DD%20%84%1Bn%20%C1Zn5%00%04%3C%88%80%99%DA%96%11%03%00%80-%EC%E3%5D%03%A7%E2%BB%A8%0C%E0%025%00A%95%A4%10%84%F5mb%02%238%8D%10%16A%FF%85E%5C%81%0AL%B8C%07x%C0%05%01L%26aR%80%00%17j%D0%86%03T%40%0FX%98K%FDl%F8%90%07%7Cj%03%DA%22%40%06%0A%13%02%278%21%0F%1F%98%0A%12%14%E1%04%08%20%04t7%A4%95%1Bz%10%3B%1C%40%40.U%0BT%09H0%88%8D%B1%CF%00%038%A0%03%BD%F8%406I%05%00%99%A8A%16%8Es%97%1A%AC%E0%04%96%12%00%080%D0%83%F1%25A%03%24%40%03%166%A0%03%2A%CE%28%28d%C8%CF%05%9A%F0%C4%252Qf%0F%08%C3%08%7E%10%C8%A9%01%22%0Cu%20%02%035b%87%3A%98%24%8F%82%04T%09n%F0DA%25Gf%25%C8B%07%06%D4%C5%2F%86%12Aa%94%CA%00N%E0%80%1A8%AA%8D5%A8%02%06%92%93%B0%A40D%00%0D%00%D1%24%1D%92%04%20%98%00%06%16%88%C1%F6t%E0%27J%96%EE%01%1C%A0%80-m%A2%81%07%9C%A1%0C%A0%D4H%058%F0%03%19%D5%05%2F%07%C9T5%8D%F9%3DK%FFb%F2%7BR%B8%81%03%5E%E0HQ%86%13%8C%5B%C1%DD%07%94P%CC%86l%40.%81%D4%8C%0000%81%18%EC%0A%004%00B%0D0%A0%03%3C%9A%28%98%3EaA%E7%AE%89C%12%28%A2%0C%0C%14%01%1B%E6%A7%99%C4A%A0n%21%08C%18%A0%20%86%10h%20%03%EC%E4%D64%09%A0%003%8C%AF%7E%25%E0%C2%14%88%25N%90%8E%92%9C%0A%24%03%04%94%A3%C9m%B9%93%0E%8A%D9%22%03%22p%07%1E%04%21%0B8%C0V%20%05%40%81%11%1Cg%9F6a%08%1B5C%80%07%D4A%0De%20%A5F%CE%A0Q%CAd%60%04N%08%83%18%A0%10%02%12%40%F5%09bx%02%09%E0%F5%BD%06%28%B4%98%3D%C0%82%A3%EA%A7%03%0ET%C0%29%21%25%ABU%208%95%154a%87%87%13%40%16%98%60%A6%8C%98%12%06%26p%00%02%94%00%2B%05%D8%B2%01%1CPA%1BF%A0%81%9D%3E%84%05a%20%1CB%9F%10%899%D8%A1%A8%9B%B8%C0%1B4%40Q%E4d%60%FF%0E%23%A0%40e%E7WM%02%40a%0BO%40%A7%CC.%AA%14.%18%21%08%18%F0%D4Z%BF%07%D6%22%8C%B5%AC%AB%8D%CAY%A3%22%82%03%60%C0%7B%02%B8%C1%B0%BCC4%0B%E4%20%05%BB%A1%82%116%90G%02%E0%C0%05%11%88%C0%04%5C%80%85%C0%12%80%05%18%88%84I%0FF%01%85%BA%80%7D2%00%01d%B1%C3%01%ABZ%F4%21%40%D5%C0%1B%C2%00%82V%25%25%29%0Dh%C0d00%82%1D%5C%A1J%1C%08%82i%B1%C9%01%1A%A8%96%B5%F3%0D%89k_b%80%26%DC%A5%27%0A%28A%09%AC%BB%5D%0E%A0%40%BE%9B%D8%22%00N%F0%82%0F%C4%80%0E%BE%E5%21%17%98%C0%25%11%5C%A0%03U%C0A0%05%90%81%27%60%F7%07%F4%E9%21%07%F6%40%A0%3F8%C2%0E%7E%90%04%07%1EK%19w%1A%14%C5%2C%08%01%07%DC%BB4%29P%00%03%18%00A%0FRw%85%10p%C1%C5%F3%D9%AB%0B%9C%8B%1C%05%90%97%BC%FD%EDo%F7%98%23%85%1A%98%E0%04%CC%FF%A4%2F%7D%ED%EB%92%01%04%21v6%11%60%16B0e%E6%18%21%02K%EE%C8%16%07%C0%80%DC1%E1%06%27m%00%06T%10%01%B21%60%05%1F%D8%A0%20%CB%07%81-%BCa%04%0F%F8%EFC%04P%87%10l6%0E%7BxB%25%A6%DA%B8%E5%FC%40%02%14%60%0E%0B%E6%00X%CD%3C%40%0CF%90%83%A7B%20%87%2B%C8%C1%0C%84%80%40%09%C87%82%2A%E8T%00%3D%B8%C1%0Evp%034p%E1%06n%E0%02%09%26%C3%9E%9B%B6%00%05lkr%AB%3B%F2d%91%00%80%07Fn%88%06%DC%00%04%26%CC%F0%9F6%81%80%0B%88%08%92%02%A7%D5%95%04%F0%82%17.p%02%DBy9%07%96%08%40%B3%9B%ED%01%5BZ%C1%03%D3%A6%F6%B4%AD%20%00%0F8%5B%DB%01%F0%40%188%00%85%83%02%AA%0E%9A%80%80%1B1%B0%81%1F%3C%CE%7C%17%9E%26%5E%10%C6%01%40%D4%99%00.%D80e%08%B0%97%11%80%A0%B2%95-%AF%88%F2%A8%00%F4%8A%D6%08%84%80n%FFe%DD%D8%03%C1%7Da%CC%A8%FE%02%13R%C3dW%97%15%D6%21a%40%0BhM%00%0D%B8%A0%08%110A%1B%B0%BC%1C%0Ad%8C%06%2B%006%00%2C%E4%85lw%C0%01%0A%E4b%5CS%00%060l%1B%11%7F%C2%0B%22%B6-%F3%9B7%7B%08%228%04%20%A4e%A5%1F8Aq%09%C9%C0%A3.%FC%00%0D%00%C2%8D%FA%A6%80%C0%1C%02%02%0E%D4%B99%5B%F8o%E7%F2%DAn%14%E7U%138%A80%D5%60%99%D5%1A%10%9A9%02%D8%81%09%E0%1Aq%B4O%1C%24%0C%00%16%15%19B%02%15p%09%06%13%F0%2A%7D%A2H%08%0E%A0%81%07t%98B%97%01%90%02g%F3%80%0C%15k%E6%02%0C%7Fx%C3%13%21%00%A4%E3%EE%0F%C0P%08%09D%5E%F2%91%B7C%00%88%80x%C4%07%22%00V%90%BAM%7E%D0TLU3S%1B%00%C4%A78%C0%06%27p%60%0Bux%03%06%10M%01z%B3%07%89%D6%FD%01%07%E8W%3Fwb%A1%CE%1Bh%C3%05%06%FF%8C%F6%26%AB%FD%23%03%E8%C0%08%A6%8C%97%11%B4%81%06%1B%03%C0%1D%D4%0B%28%1C%A8%93%02%B6j%F9F%7Cu%00%EC%27%20%01%D8%3F%40K%2Ap%80%3BL%80%0FT%D8%03%02%D6%90%87%00%B0%00%11%888%84%24%E2%E0%83%40%C0%81%08p%E8B%FD%E7%AFx%22H%80%082%E0%BF%0C%E2%B0%06%3F%00%83h%02%14%0A%E0%00%0Eh%2A%AA%0A%95P%D9%02%28%D0%847%00%81%D0%A3%80-p%810%A0%80%A0%83%82%5Dk%08%94%18%C0%9E%D8%80q%D3%81%12%F88%C3%B1%8D%0C%DC%3A98%82%14%605%E0s5%E1%FB%88%22p%83S%BB%A9%1D%90%10%14x%01%8C0%01385%2By%25%0D%40%83%0Bp%13%03%B0%80%05p%00%07P%01%15%20%C2%05%10%81M%F8%BE%F0%C3%3E%FF%93%80%40H%01%3Bx%04C%10%81%3FH%01%1FX%825%B0%00%09%E8%BF%00%D0%3F%CB%D3%3F%19%88%3C%FF%5B%83%40%40%84L%89%19%19%C3%00%40%18%81%FF%C1%81%82%9C%C2%949%1A%01%F2%29%3A%0C%F0%99%278%24%14%DB%80%CE%A9%B3%11X%03%23%C0%02%0C%28A%F6%C0%B8%20%A0%B5%9B%C8%B8%08%18%90%15%8C%B8%16%F4%88%08%D8%01M%18%01%23p%01%25%98%02%1A%C8%15V%BB%004p%92%40%C189%28%820%02%80%05%80%814%A0%02%2A%F8%00%18X%80%1C%18%80%EFK%01%04pB%3F%90%00%3F%F8%03%0BH%01%ED%AB%1C%00%20%8250%84%04X%02E%90%813%00%C3%FC%BB%801%94%80%3D%D0%C2%25%28%03%04p%9C%8A%BA0%A2%CB%94%A2C%8E%1F%18%01%28%B8%BD%F6%D0%84%7E%A1%A8%0B%A3%80%27%D8%82%7Da%8Ej%B41.%10An%21%00%08%90D%C8%C2%01%12%A0%82%0B%F8%A8Fl%B5G%EC%88%E6S%02%04%A8%00%130%01%14%88%81%1C%20%BCM%88%013%F0D%40y%10%2C%28%02%15%D4%08%03X%00%3E%E0%03%EC%9B%80%09X%00%CB%B9%83%03H%81%09%C8%BE%FC%5B%1F%FF%00%B0%03%C3%2B%04%5E%99%C5.H%00%1F%D0%825X%003%7C%04-%9C%04%91%5C%83%04%08%04%28%DCEw%09G%1Bj%1D%0E%E0%40%84z%00%08%80%82%A7%81%99%9FB%BA%1B%18D%EF%21%80%0D%10%C4%7FB%C7%E1z%B8x%94%C7%C5%82%0A%03%60%80%0F%B8%00%FD%10%81%1C8%01%CB%D1%08%11%B8%81%CC%10%94%19%F8%13%02%98%01%97%99%25Z%DA%80%1DX%B5%03Z%00%87l%C8%87%8C%C8%03P%92%26h%825%C0%03%09%A8%00%2F%C3%03%3C%60%8C%0A%80%038%28%84%8C%94%01-%0C%04%0B%60I%3B%20%82%FA%93%80%25%D0%3F%00%F0%01%3F%88%02%08%BC%A1%9B%DA%02%9A%94%26%0Ax%031%10%03%12x%00Bl%0F%0D%08%01%23%D0A%EF%D1%89Y%29%1CPt%C7o%3AJ%A4%04%0CSZ%015Z%20%8Ep%8B1x%88%19%F0%82%00%F0%02%1B%98%B6f%F3%82n%D1%0B7X%98%1D%40%00%A3%EC%B2%01%40%00%04%E8%15%030%80%FF%298%00%25%E0%3E%09%88%825%A8%00%02%0B%CE%DC%A8%00%09%20%B0%5E%01%00%C2%CC%BFa%94%3C-%A0E%DC%B2%83%CE%81%C9%9F%C4%800h%CC%D0%C1%00%3C%A3C%F0%F4%89%0C%A0%80%1D%F8-%DCCO%9E%C0%0B%1C%D0Jw%0A%82%08%D8M%D1%9C%AFy%E4M%5E%E9%22%7D%84%811%F8%93ls%00mK%03%1A%08%00%1B%98%91%0D%40%032%98%82%22%B8%83%3B%18%9B%A4%F4M%8E%E8%80%ED3N%09H%00%22%F8%88%0A%C0%BC%C3%F3%83%01%F0%83%04%98%BC%C8K%00%E5%DC%A2%3F%A8%80%28H%A2%9F%B0%89%DB%CB%00%2B%F0%21%CA%BC%B6n%F1F%40%C0%C6v%02%01%A4a%81%CEk%88%D6%81%82%2B%10%C8%D2i%A3%1B%20%2F%0D%E8%81%2B%A0%92%19%D94%E5%7BGp%AA%CFP%BA%CF%A98%00%01%899%0F%D0%84%19h%B6%05%08%00%078%00%2C%D5%D2%29-%8D%2C%00%02%14p%CA%18%F8%80%DF%E3%88%238%02%E59%25%15%98%02%FF%22t%00%22%20%82%3A%98%84.r%84D%28%83%0F0%842%28%83K%90%01%3B%B0%005P%9F%0A%08%D4%40%8D%025P%9E%21%20%02%27%D8%00%C5%21%11%02%C86h%B3%02ik6D%D0%04%2B%C89nk%08%A5%9A%C9%87%19%01%0E%E0N%F6P%2A6%00%26%DC%83%80%2F%F8%82%11%C8%024%F0%B4%11%D1%80%118%80%0E%40%01%03bR%27K%CA%BF%D8%AD%0A%A8%022%E8%80%29H%83%00%A8R%2B%DDR%60%856G%95%89%B4X%8B%EA%13%095%EB%00%13%C890%28%03%118V%8D%E8%03C%08%00%98%AB%D6%98%23%92%21%80%B2%3FX%02w%01%81%1F%28%3A%9B%F3%81%9B%AB%BCl%0B%00%19%C8%C2%25%08%80%F7%DB%3C%01%F8%81%87%F2%D4%E5x%00%40x%83%F2%EC%89%BB%20%81-%90%02n%99%01%1B%B0%01%AE%BC%09%10%C0%029%F8%02Y%C9%02%3D%E1%80%260%014%F3GYe-%27%7D%89%23%C0%BE%05%A8%82%03%18B%FF%02%0D%00%87%5C%00W%AD%82%2A%C8RnsMg%03%81%20%A0%81%E0%04%89%01%88%01%11%40%B0%22%40%80%1A%08%01M%88M%7F%9D%81%19%60Q%2B%98%D7D%C8%83%0A%10%01%008%84D%80%02%0F%88%26%01%B8%B6%84%90%045%808%DC%C9%83%3Dh%A8X%B1%BC%04%40%02u%1D%C3%04%80%03qE%02%098%03%AB%FD%C8%FA%E36%8C%C3I%83%E0%B0%0C%60%28%F0%B4%29%08%08%01%400Gl%FB%D8iC9n%E3W%D9t%B6i%EBW%9C%202%05%28%40%E2l%1E.%29%9B%86uXZm%8C%05%98%020%B0X%1B%08%80%16x%C8%16P%81%03p%01%C3%E56%2CM%00%17%E06%0A0%024%FD%08%00%E8%80%3A%BA%013%08%81%861G%1D%BD%A9N%E9%B3FHZ%892O%E7%F0%01%A3%B5%00%11%40%82%3C%D0%91C%08%80.%90%80%2F%EC%02%22p%DA%00%B0%B9%8F%ECB%09%88%03%C6%15%D7%84%8031%D0I%14%FB%81%FF%C8%84%D7l%AC%9B%3C%CA%8B%10%88%13%9E%02YK%DD6%21%10%82m%2BP%88%C8%AA%20%E0%A3%08%40%81%14%E8%C7%25%CD%5B%2FzX%A8%98%82%04%B0%84%BF%05%D0f%3B%00%07X%80%0Ep%81%03%10%82%C4%CD%B6%87L%80f%5B%8F%B0%EA%22%06%A0%9B1%00A%87%B1%8B%84%90%C3%E3P%1C%CA%60%01pq%A4%04%22%97%0F8%84%0B%40%82Cx%84%CA%93%80.%E8%3F%C5%B3%83%DAm%5D%17%D0%3E%19%D8%3C%EC%80%009%A3Q%BB%10%80%A9%C2%60L%C5%00%170%A8%3C%FA%DA%27%D0%CC%86%A8R%07%D8%BE%04%A8H%8AM%00%00%15%02%EE%D3%3E%EEk%01%02%85%08%05%80%00%0E%D0%83%FC%E8%12%A9%848%EDm%D2%BD%FD%8B6h%02%2Bu%80Wm%B6%0E%D0R%8F%F5%D8lK%83%09%00%D0%29%1D%033X%B9.%12%02S%FBDv%3B%98%0Cp%02%22%80%B8%02%03%00%5B%DCE-%40%80%D7%95%81%05%90%01%FC%3B%03%FEs%81%FF2%BE%DD%09%B6%82%868%0C1%A8W%88%C8%00%10%10%9FIj%D7-%20%AC%C9%84%14Q%F1Q%2A%5D%DC%03H%E1%03Xa%00E%8165%C26%1DP%E8%BD%92%0D0%02%1CN%81%17%A8%98%EC%ED%E1%ED%FDa%AD%18%84%05%28%82%21V%81%09h6%17%90%E1%24%E6%D2r%7DM%BC%D8%AB%0A%C0%DB%8D%A0%02%F9%D8%A9%F3%8C%82%14%E0%E1%B8%EA%C8.X%83GX%00%A7%BD%D2f%DB%BF%FEc%DC.8%838%A0%60%EC%80%82%3D%A6%0F%0C%0B%01%0E%7C%80%A9%DA%80%AA%1A%C0%EC%80%82%F7%84%08%13Fa%15%0Ed%F1%9D%00%14%DE%3E%8A%7DM%9C%20%003%98%80%08H%81%15X%0CJ%1E%CD%02%21%83%05p%5E%2BU%01%16%0E%00%21H%00%14%00V%25%A6R%7Fe%88%1A%26%20T6%1E%BA%D1%5C%1Bz%00%28%F8%B0%A90%00%5E%5C%02%F7%0D%00%5C%B6R8%D0%3E%17H%E8%09%0E%00%12A%E69%7B%12o%C4%00%1A%3D%CF%FF%D6%0B%95%AB%B2%B3%0D%10%03%E4eM%60U%01%1A%10%82N%26%DFf%AB%C8%8A%84%D2%F5%ED%96%06%90%03%02%8A%81p%86%E5q%F6%E1%02%11%01%95%7B6vvH%23Fg%01%0D%00%1A%90%E1Ev%88%B9%E5%83%0B8H%8D%80%01F%E8%DA%9D%EA%A1-X%82IN%20-H%00%FE%FBUg%5B%80%83%FE%C5%0F%FDK%0AV%AE%27%A0C%FAP%B4%10%40%29%87x%80-%08%01%16%08k%9Ad%01%0E%08%01%1F5%E1%F4%0Dd%8Au%E1j%3EBD%AE%C8Km%08%1D%20%01%20%A0%01%96%16%E7%97%0E%3EK%96%0A%1A%08%82%0F%98M%99%5D%DErU%DE%9En%88%B9%9D%80%14%D0%EB%8DX%81E0%EA%9D%C2%8B-h%84%3Fh%9F%3Eh%EA%08F%E31%7Cj%82n%DD%0F%95%E0%C6%F5%80%89%92%40%06%AC%BBD%933fN%11%0A%F8%14%D3%C6%A1Gkm%B5%06%E9%04%E0d%B7n6%17N%00%C3%DB%3E%9E%BE%12%08%00%82%FF%29%B8%00%1Bt%E9%BD%FE%22%EEU%1E%5E%29%8260%83b%9A%E7%12%EEW%7F%15%80%7E%E5%CA%AD%7CY%B8%AD%0C%10%E0%83%C5%F6%08%1A%28%EA%CA%3C%1C%B3%5E%82%21%00%A5%01%10%01A%20%82D%C8%C2%0B%08%00%3B%E8%3F%FEK%D7%2F%7CSa%F4%813X%80t%F5%00%08%10%03%1E9%CCaN%B40p%1Ci%F4%A1%1F%A8%03%12%60%016x%E8%9F%20%004%D0%A6%12%DER%1A%E8%80%05H%80%0E%A0%01%91%1Ei%C6%8D%E0%09%E0U%02%BD%28%23x0%18%10%EA%E1%D6%DB%BF8%81%0B8%02%25%28%23%0Ax%2C%86%F8W%2AU%F1%F6%60qi%92%020e%93%8B%01%82%1E%F0%EA%9D%EA%A7%3E-%165X%02%3C%D0%026%B8Fg%B3%B9%E5%B5T0%C0%00%27%88%02tI%04%03%D7%0C%B3%3E%5EO%21%01%40%F0N1%60U%CE%BA%26%160%02%E3%E3%E8%2C%B5%E6%E6M%E1%8Ee%E7%EDC%01%87D%01uV%01n%93%82%FF%B0%19%1B%86%FDp%FB%ECk%8F%C8%81%16%08%82%1EP%1A%A59%5B%0F%88%CDgs%88ruT%C5%85%B6%F6%08%B2%24%40%C7%1A%88%006%A1%DCb%FA%2F%05x%00u%1B%9D%1C%D5Q%0A%D0%02A%F8%BD%0A%D8%021%00%81%C4%A1%B3%83X%0F%9A%85T%2BxQ%0FhQH%CD%80lC%04%10p%81%25%18%92%0F%90o%89f%8E%0C%20%81%27%08%01%9E%F1%AEoK7%0E%B0%F4%BAhu%82%F8%93%2A%DDi%5Ci%B64P%01%17%E0UC%B6mt%1Ev%1B%10%80%FB%B0%1D6%27%E7%AA%18%00%17x%A2I%CA%B6wn6%14xg%7F%5D%E2i%DF6%DA%04%B8Nk%03%15%20%03%07%60%A9%8D%D8%01%0Dh%99%AC%DB%0B%D4%D3%11%CE%C2%94%EE%9E%11%10%40%80%0B%08o%8E%A8%83K%99%C6%8A%CA%B8%D8%C5%C2%CCa%83%CE%0A4%CF%11%BDL%01%AA-%E8%F7%9F%A0-%A4j%08%E5%E5%B6QV%DC%D7%D4%B6%C2%96%02B%C0%E1%FFX%5D%F6Y%D5%0A%13%20%04%7B%0D%804H%00%19%C6%D8Nv6%26n%814%D0X%8DM%80%29%08%80V%05%F7%22Xy%13%B8%80%89%CF%88%1Bx%B1%FD%22%81%1A%40%00%3F%F0%83%40%0D%84FP%3D%12%F8%B9%E5P%AA8%10w%8DP%83%3Cl%F4%9B%C0%B08%40%022%5D%8C%3C%60C%9D%3A%18%DFm%88a%AA%AEn%29%3Am%D1%81%B0%CB%23%E7%FE%D7%D8%BC%F3%15%DF%CA%E8%5E%F1%84%A9%81%22%10%81%7B%A6x%89ss%8E%40%00%F0%BA%09_%15%F3%B2%84%D2%09xgk%9E%00%15%20yjN%03%3D%A0%01%7D%7CJ%18%88d7i%82%13%93%9A%1A%C0G%A7%14%81%0F%E09%3B%C8%03-%B0%14T%23%00%09%00%1A7%E9%C3%C3%F9%DA%3C%B0%C2%A7h%84%0DX%03%24%92%99%AF%8D%A8%0C%80%02%03%AC%83%27%00%AALa%811%D0%93%0A3%9C%06%20%84A%88%80%D0D%FB%8A%B7%0A%20%F0%89%C0%05i%82.ik%06%D0%FF%8DO%00%1A%20K%B2%84%F0%18%B8%00%14HY%0B%60%00%B6%98J3%95%83%A8%C7%89%20%E8%80%F9%F4%01%0B%18%02%EA%FF%03%1F%18%60Ex%A6%9D%04%01%C1%BC%80%EE%D8%88Bx%26%A3%FF%89%1F%98%83%1F%D4%888%80%02%04%D8%83%3A%80%02DK%29z%C7%006%80%80%7E%01%A2%20z%03%098%806%B8%82%F7%07%08M%02%07%12%2ChP%60%09%23%15D00%B0%E9%21%C4%88%12%27R%ACh%F1%22%C6%8C%1A7r%EC%E81b%01%00%1F%1F%0E%B8%21%E0%A0%A6%19%01hTi%B1%20%C0%84%09%01%0E8%08%10%C0%C5%84%031%17L%20S%01%40%8C%1C%0C%06%0C0%60%B4%E2%0A%20%844%14%24%A0I%83%06%10m%98D%10q%02%40Q%A3D%01X%28s%86%04A%02%02%C6%FE%28%BB%01%8A%8B3%15%90%88%18%E2%10%E2%1C%0A%28%E7%D2%15%98%21%C4%99%01%10%0B%C1%29t%E1%02%829L%EB%D2%CD%F0%06%8A%84%0DN%09%FFh%80%40%81%C2%16%27%5C%5C%F4%C0A%F8%B2%A6%06FL%BC%D0%3B%F23%E8%D0%A2G%93%86%18%F23%80%1D%27Qz%B1%99f%81%03%15%2A%1CT%A9%29%A4J%82%03%3C%17PI%E0%00%C0%8A%86%1A%07%AC8%40%C2%A9%40%02%1B0p%09%02%A4H%84%18%16%3CK40%00%80%08%17%AB%05hxL%81%C4%16%17s%96%14R%C3vz%C4%25PVc%C6%9C%81C%1E%CF%03%16%1A%F2%F1%A1%11%94%1F%ED%0F%3E%80CB%FF%40be%E0%04%04%04%800%D8%5Cc%21W%97%02F%A0p%C2%5B%A5I8%21%85%15vt%DAH9p%A1%C0%5C%1E%C0%D4%C1%02%07%24%90%9Bo%2B%A9%A0S%88%21%FAv%5D%84%17%0D%10%83%03-%84%C0%DE%06%1C%A8%D0A%04%11%A0%20%C2%0A%00%B4X%1D%00Nh%20%16%08o%B8%10%85%16%8D%10%21%08%12H%5C%20%82%0FC%14%05%D1%00ph%C0%DE%7Eu%11%90A%1DH84%80%0F%86X%00%FF%C0%10%3E%B0%91%E5A%10%609%90%00uhB%80%02%0B%1A%24%96c%10%5C%26%40%10%28%08g%21%9F%7D%FA%29%21%86%1E%0DP%C4%15%1C%1E%A4R%00%09tPSL%2B%A5%01%D3%01%91%A6%28%E2%11G%0D%D7A%1B8%24%B1%9A%06%5CL%A0c%0C%22%BCp%C2%94..1%82%00%20%CC%81%00%93N%5Ep%88%08eX0%04V%12%0D%90%07%07%1B%A0%89%19%04Q%88tk%20%814I%04%1Bk%A2i%EC%40N%10%26%00%0E%18%EC%A0B%0D%20%10F%80%1B%1D0%F0%27%B6%D9j%ABQ%A0%1D%01%D0%01%08%C8jb%03L%09%D8%04%93L%E7%B6%90%D3%04T%A4%00%DB%045t4%C0%05%3Cd1%C2%06%0D%E0%40B%0D%D1%E5%60%C1P%3FVd%80%1AohR%87%B0O%96%E1%C3%AC%00%60%25%F0C%00%E4%B1%C5%03%BB%DA%F5%00%0B%0FdP%D0%0Fg%FCQT%19%81%28%B2F%02%91%8C%A0q%06%E2%D2%E5%D4%06%1B%FC%20%FF%A7%26%3Fp0%96%02%C8%0A%40%81%1B5L%11A%11.%D8Y%17%05J%EC%B9-%D1Ec%DB-G%0C%20%40%C1j8%E0%20%96S%2A%D1%D0A%00%1E%0A%21D%006%90%9B%C6%14-%A4%F1%01%00-Dj%82%A0%270%D1%C2%0D%20Pp%40t%2F%D4%DA%91%0F%1C%84%B0%07%5B%7D%D0J%14%C4%12%01%D0G%17%2F%1F%CB%02%04Pp%00%05%04%19%2F%B6%C1%19%3E%FCJ%E6%10CT%10%18%1Bo%60%C0B%CAVX%B1%A6S%02%5C%3E%D6%06%80%B0%D1E%1D%1CT%3C%90%06%1C%B0%A0%09%04%0AH%D1%40A%20%00%D1%82%8E%29%7C%60%C2%01%86%CE%85C%0D%E8%19%BD%3B%EF%13%22m%11%00%2F%40D%83%11c%BC%B9%01%215%04%E1%86b%9A%B4f%13%A2%D0k%E2a%000%7C%00%C3%C3%23%0D%C0%40%0E1tP%83%1BJ%A0%90%83%8F%1F%F90G%97%29L%97%F7%C0C%E0%81%81%CA%28e%40%C1%1CZ%C4%91G%1EQ%84q%FF%F2%03%0F%F4j%88H%0C%E0%B0%3F%F4%A1%0C%22%40%82%1A%0A%B1%84%0A%5C%02%0C%E7%F2%80%07%AC%90%01%0FQ%2F%00V%10%C4%12%B4%D0%2A%5C%8DN9%91%03%02%158%C0%05%0C%94%E0%24%04%80%40%10%1C%10%81%0B%C0%E0%04%0CX%C1%04%C25%17%C6%18%21%05%22%E9%1D%0Es8%92%DFU%04%06%08p%40%0C%2A%A0%04%0C%D4l%03f%80%5D%04%8Ep%03%1D%08d%0668%89%13m0%03%81p%28%04%1DH%C1%05t%A7%3D%AE%E4%E0%025%A0%03C%D8w%91%3F%2C%F0%02%8A%1B%C9%10%12%C1%B4%F6%88e%04%E3%29%84%AB%2A%10%07%0E%BC%21%04%23%A8%C4%19%00%F8%10%EB8l%08%16%F0%81%E2%00%F0%87%0F%5C%22%0Eq8%D7%B9%7C%60%938%88%C0%10%29%A0%D5%10%1A%29%828%BC%E1t%02%80%C0%1A%CEp%07%138%80%09J%E0%C2X4%E0%86AT%A5Gz%B1%00%1D%E0%17%96%06%94%A0%04%0D%60%16%21%7E%A3%C3Y%D2%12%FF%23%3C%A4%88%08%9A%80%05%1E%18%01%04%3ApJ%16%80%A0%23%11%D0%00%08%C6%A3%0B%87%E4%A0%84%15%BAM%8C%19%E1%E3%0Ab%90%02%B7%7DF%80%0B%2B%9F%F9%CE%C0%02%98%CDP%13%24p%C2Z%1C%B1%B0%3E%D8%C7%11yP%C4%1Ed%80%842%DC%D0V%D7%19%00%1E%24%20%01%92%25%40%9E%128C%00%7C%90%808%10a%01ZH%A7%0C%880%00Z%01%A0%0C%7B%08A%CA%28%20%01%BF%88%00%06%22%88%00%0F%DCp%B3%20Te%7D%C1%13%82%0B%98%C8%26%05%8C%00%0B_%20%C1%06%A4%80%81%09%0C%AD%96%26%AD%E5-%27r%01%2A%80a%0CI%E0%90%00B%D0%2F%14t%20%08M%B8A%12%E8%C2%1De%AE%90%7C%CE%E4%C8%F6%00F%9D%8F%0C%F4m%E6%D3%C26%2FC%80%07%60%80%0Dv%B8%C0%07%C6%B4%15%3F%96%01%8BH8D%1F%86J%91%14T%C0%0F%7E%E8%C2x%88%40%04%3B%D8%C4%0E%8A%80C%14d%A0V%19%F8%C1%28%06%FF%B8%80%13%D8%00%82%94%8D%40%0B%17%10%0A%00%5E%08%032%90%80%02-%B8%C0%0A%06p%82%180%21%08W%D0%A8%40%04%B0%01%9CL%C1%01%08%E0%25%07%3A%A0%C5%93R6%87%29%95H%0Cx%20%85%D54%A0%07A0%C1%05%1C%60%04%05%40%85%9B%04i%C0%08%3E%7B%81fN%88%28%A5%1A%89u%7E%0A%BCD%8C%E0t%2B%FB%01%068P%07%22%5C%A0%0CR%8A%10%1F%FF%C80l%5E%04%01%F5%1C%D1%1A%E0%20%010%80A%06%8A%D0B%02%16%20%DD%05H%60%8FH%88%04%05%CAr3%27%14%82%21Y%D9%5E%04%82%40%01%1E%7C%80%01%26%98%40%10B%F0J%82%5C%D2%08%1D0%01%0A%FE25%26HG%AB%95%BDo%D1.%1B%91%13%F0%81%04%25%D4%84%0E%18A%87%F1%11%AA%04%CB%DA%00%1A%3ApW%E2%E2%F7%23%04c%C3RQB%80%1F%00b%0E%8A%A8%00%1C%0D%21%25%8AX%E7%9D%B2E%80%04%40%2C%01%19ta%0Dex%C4%FF%21%E0%10%883%B0%15%9C%D5%DD%C4%10%10p2%A7d%00%03u0%E3P%0D%00%83%16%7C%E1%080p%00%10z0%06%DB%25%27%A6%3C%F0%D7%0AV%F0%02%87%B6%D0%BE%0D%7E%B2%9F%F4%0B%11%03%98%A0%09%21%D8%80%00J%10%02%04%94%F7%0E%210p%5Dt%40%02%F1%C1%A0%A4P%F6%D6%C4%7E0%BA%00%29v%0B%5DP%83%20%5E%E5%5B%27%7F%06%01Q%A8%40%14%9C%E0%07%19H%C0%07%EBT%83%0C%A6%3B%DD%EA%A6%60%0B%B6%15%0B%14%10%D0%96%1F%0D%A0%03%2A%A0%81%038%C0%CA%83%28%00%04%9F%8D%81%29%B7%E2B%3A%9F%B9%D3%80j%27F%04%28%02%25%DC%00%02%3A%18%01%15%3A3%05%12%B0%8E.%0D%80%80%12%1C%60%15N%7B%DA%22%03%F8%03%028%00%81%94%25%F6f%1C%60%15%5B%7C%F0%07%A3%92%26%9E%D1%5D%40%3D%B50%801%9Da%09%E3A%00%02%96P%5D%00%2C%E1Jv%81%C0%19%D4%C0%CE%89%18%80%01%C4%E4%00%0E%88%FF%CC%26%0D%98%01%01%AB%25n%87e%5B%EBu_%08%D4%18%D9%1E%0C%F4%60%861%40%80%BC%03%A0C%0FZ-%96%9A%B1%B7%01f%98%00%0A%A8%C9%EEy%F5%21%11l%C0%97%00R%06%08%17%C4%C1Is%7E%AD%84%8C%3B%879%24%00%01Y%25J%02%96%90%008l%7CDj%F0Am%13%FB%00%28D%C1%11Y%A5%08q%26%10%82%9C%1E%04%B5M0Ay%D5%3D%F0%99%7BD%CA%11%D9%5E%11%CC%D02%0E%14%81%01%13%C0%00%EBn%86%01%0Ch%A0%D5%0A%28A%16Z%40%03%EF%D2%7C%23%02%EC%83%1D%A2%B0%85%11P%00%0As%F0%03%12R%D0%07%06K%08%0F%F5L%01%B4S%10%85%04D%C1%00%5E%7FW%05%1E%07%07-%18%C2%10%0F%10%C0%960%E0%82%3D%D8%E1%03n%E1p%11ffB%02%F0%9D%EF%95%DE%01%10%03%DB%F4%C1%97%C6%E6%111%80%05%06%C1%01H%08%B3%03X%18%8B%26%C6p%03%25%20%00%08%148%BA%00vY%04%FFL%D3%9A%F0S%E6%8A%08%88p%06%274%C2%3C%22%18%93%CC%3D%C2%D5%87%E0%01%0F%0FY%BD%1A%5C%0F%11%09%CCaV%92%F8%81%06H0%F7%0A%A8%01%C7%16%11%02%096%D5%00%E5%40%00%02%BA%02%81%0B%10%10%01%EC%A5%DE%F3%CE%07%89%BB%87%C3%80%0F%E4%A8%03%A5%E6%90%02%20%D0%82%0AD%40%09W%18%03%08v0%01%1A%2C%B8%F94%B7N%99%B0x%01q%FE%F6%A4%06%28D%14%BA%10%07%3B%F4%3E%05%8A%CB%9B%08%F8%F04%10%60%80%047p%8E%0A4%81%12%BC%D7%AC%3D%9F%01%D6%5C%F4%3D%13p%5C%00%13%DC%C0%06p%08%014%C0%06P%C1%F2E%40%0D%EC%00%10P%C5%5D%0D%C5%01f%C4u%94%C9pu%1E%EF%0C%D4%07%5C%80%93%40%09%AD%B0%CF%05%B4%40G%B5%80%0A%0C%02t%E4%88%8E%EC%C8du%A0%0DV%84%E1U%C7%07L%C0%0EP%40c%F4%80%1C%98%81%0B%F0A%0C%B8P%27q%DF4%11%DB%0DV%84kA%FF%9CI%A1%1F%20%D9%8D%12r%5B%8C%08A%8E%C4W%0A%88%C0%F5%E4%C0%A8p%DD%12%7E%E1%26%E4%60D%00%00%1DT%C1%0E%F0%00%10%A8%80%1Et%00%0D%D0%80%09%60%CF%F6%7C%40%0CD%95%17%82%E1%C0%5DG%F6%3C%13%03%C0%C0%05%CC%E1%BF0%00%038%0CV8%A1%1D.%A1%18B%84%05%2C%DF%0B%C4%00%0A%E8%C8_%84%0Az%04U%C0%14%22%25%DA%CA%09%BC%00%C0%E4a%25n%E2%21R%C9%09%E4%C0%07%5C%CF%0B%AC%80%05%B8P%F9%A4%DB%26%A6%E2%26t%18%21%AA%A2%1Dv%22I%E4U%20%3A%0C%DE%98%9F%2B%DE%22.%1A%20%2C%AE%A2%A5%E4%A2%2F%FE%A2%2B%EE%220%0E%231V%A20%16%232%26%E3%01%1E%A326%A33%0E%1C3%3E%A34N%23%7EE%235%5E%236ZV%02f%237vceY%A37%86%A38%FA%CE6%8E%A39%9E%E3%D1%94%23%3A%AE%23%3B%16%9E%3A%B6%23%3C%C6c%BB%C9%23%3D%D6%23%02%DA%7F%23%3E%E6%23%0E%BE%A3%3E%F6%23%3B%82%A3%3F%06d3%02%A4%40%16%241%12%A4A%26d.%22%A4B6d%2A2%A4CF%E4%2B%F2%A3DV%E40B%A4Ef%E4%F3a%A4Fvd%D3q%A4G%86%E4%BA%81%A4H%96%24%94%91%A4I%A6%E47R%A4J%B6%A4%E7%A1%A4K%C6%24%0E%C1%A4L%D6d%7E%B1%A4M%E6%E4I%E2%A4N%F6%E4J%FA%24P%B2%1BM%06%25Q%8E%C6P%16%25R%EE%10%00%04%04%00%3B'  alt="" width="403" height="324" border="0" usemap="#Map9" id="innermapBox">
+
+
+<map name="Map9">
+  <area shape="poly" coords="228,236,250,213,243,204,275,155,278,120,311,102,335,74,357,80,377,119,382,143,346,148,333,163,316,153,304,173,300,207,260,252,225,235" href="javascript:void(0);" onfocus="mapChange(1);" alt="" onclick="mapChange(1);">
+  <area shape="poly" coords="212,264,211,243,225,239,257,254,243,265,242,278,229,289,209,278,211,264" href="javascript:void(0);" onfocus="mapChange(2);" alt="" onclick="mapChange(2);">
+  <area shape="poly" coords="207,261,205,240,222,236,244,213,237,207,179,215,154,235,175,239,189,232,189,244,185,259" href="javascript:void(0);" onfocus="mapChange(3);" alt="" onclick="mapChange(3);">
+  <area shape="poly" coords="163,241,180,242,186,238,182,252,183,261,202,264,205,267,205,284,164,274,161,241" href="javascript:void(0);" onfocus="mapChange(4);" alt="" onclick="mapChange(4);">
+  <area shape="poly" coords="129,228,145,231,152,241,157,241,160,275,151,276,134,282,123,277,119,266,127,260,126,247,119,244,126,227" href="javascript:void(0);" onfocus="mapChange(5);" alt="" onclick="mapChange(5);">
+  <area shape="poly" coords="56,225,101,214,123,227,114,244,118,259,114,270,86,266,76,272" href="javascript:void(0);" onfocus="mapChange(6);" onclick="mapChange(6);">
+  <area shape="poly" coords="54,231,65,268,24,292,9,282,27,255,17,241,23,230,53,231" href="javascript:void(0);" onfocus="mapChange(7);" alt="" onclick="mapChange(7);">
+</map>
+</p>
+<div id="content" style="display: none">
+
+</div>
+<pre id="test">
+<script class="testbody" type="text/javascript">
+
+/** Test for Bug 448860 **/
+
+function mapChange(mapNo){
+	$('innermapBox').style.display = 'none';
+}
+
+function focusarea() {
+  synthesizeKey("VK_TAB", {});
+  synthesizeKey("VK_TAB", {});
+  synthesizeKey("VK_TAB", {});
+  synthesizeKey("VK_TAB", {});
+  synthesizeKey("VK_TAB", {});
+  ok(true, "we did not crash");
+  SimpleTest.finish();
+}
+function delayed_focusarea() {
+  setTimeout(focusarea,100);
+}
+
+SimpleTest.waitForExplicitFinish();
+addLoadEvent(delayed_focusarea);
+
+</script>
+</pre>
+</body>
+</html>
diff --git a/layout/mathml/base/src/nsMathMLChar.cpp b/layout/mathml/base/src/nsMathMLChar.cpp
--- a/layout/mathml/base/src/nsMathMLChar.cpp
+++ b/layout/mathml/base/src/nsMathMLChar.cpp
@@ -2005,14 +2005,15 @@ void nsDisplayMathMLCharDebug::Paint(nsD
   nsPresContext* presContext = mFrame->PresContext();
   const nsStyleBorder* border = mFrame->GetStyleBorder();
   nsStyleContext* styleContext = mFrame->GetStyleContext();
   nsRect rect = mRect + aBuilder->ToReferenceFrame(mFrame);
   nsCSSRendering::PaintBorder(presContext, *aCtx, mFrame,
-                              aDirtyRect, rect, *border, styleContext, skipSides);
+                              aDirtyRect, rect, *border, styleContext,
+                              skipSides);
   nsCSSRendering::PaintOutline(presContext, *aCtx, mFrame,
                                aDirtyRect, rect, *border,
-                               *mFrame->GetStyleOutline(), styleContext, 0);
+                               *mFrame->GetStyleOutline(), styleContext);
 }
 #endif
 
 
 nsresult
diff --git a/layout/reftests/border-image/reftest.list b/layout/reftests/border-image/reftest.list
--- a/layout/reftests/border-image/reftest.list
+++ b/layout/reftests/border-image/reftest.list
@@ -1,7 +1,7 @@ fails-if(MOZ_WIDGET_TOOLKIT=="cocoa") ==
 fails-if(MOZ_WIDGET_TOOLKIT=="cocoa") == solid-image-1.html solid-image-1-ref.html # bug 445911
 == transparent-image-1.html transparent-image-1-ref.html
 fails-if(MOZ_WIDGET_TOOLKIT=="cocoa") == solid-image-2.html solid-image-2-ref.html # bug 445911
 == multicolor-image-1.html multicolor-image-1-ref.html
-== multicolor-image-2.html multicolor-image-2-ref.html
+fails-if(http.oscpu.match(/Mac\x20OS\x20X\x2010\.4$/)) == multicolor-image-2.html multicolor-image-2-ref.html # fails on OS X 10.4 (bug 448121)
 == multicolor-image-3.html multicolor-image-3-ref.html
 != repeat-image-1.html repeat-image-1-ref.html
diff --git a/layout/reftests/bugs/210094-1-ref.html b/layout/reftests/bugs/210094-1-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/210094-1-ref.html
@@ -0,0 +1,8 @@
+<!DOCTYPE html>
+<html>
+  <body>
+    <fieldset style="height: 100px">
+      <legend>This is a test</legend>
+    </fieldset>
+  </body>
+</html>
diff --git a/layout/reftests/bugs/210094-1a.html b/layout/reftests/bugs/210094-1a.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/210094-1a.html
@@ -0,0 +1,8 @@
+<!DOCTYPE html>
+<html>
+  <body>
+    <fieldset style="min-height: 100px">
+      <legend>This is a test</legend>
+    </fieldset>
+  </body>
+</html>
diff --git a/layout/reftests/bugs/210094-1b.html b/layout/reftests/bugs/210094-1b.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/210094-1b.html
@@ -0,0 +1,10 @@
+<!DOCTYPE html>
+<html>
+  <body>
+    <fieldset style="max-height: 100px">
+      <legend>This is a test</legend>
+      <div style="height: 200px">
+      </div>
+    </fieldset>
+  </body>
+</html>
diff --git a/layout/reftests/bugs/210094-1c.html b/layout/reftests/bugs/210094-1c.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/210094-1c.html
@@ -0,0 +1,8 @@
+<!DOCTYPE html>
+<html>
+  <body>
+    <fieldset style="height: 150px">
+      <legend>This is a test</legend>
+    </fieldset>
+  </body>
+</html>
diff --git a/layout/reftests/bugs/294306-1.html b/layout/reftests/bugs/294306-1.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/294306-1.html
@@ -0,0 +1,10 @@
+<!DOCTYPE html>
+
+<html>
+  <body>
+    <!-- Lack of space before <span> is important -->
+    <p style="text-indent: 4em;"><span src="test.jpg" style="text-indent: 0; width: 150px; height: 200px; float: right;">Right Float</span>
+Text in the block
+    </p>
+  </body>
+</html>
diff --git a/layout/reftests/bugs/294306-1a-ref.html b/layout/reftests/bugs/294306-1a-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/294306-1a-ref.html
@@ -0,0 +1,10 @@
+<!DOCTYPE html>
+
+<html>
+  <body>
+    <span src="test.jpg" style="width: 150px; height: 200px; float: right;">Right Float</span>
+    <p style="text-indent: 4em;">
+Text in the block
+    </p>
+  </body>
+</html>
diff --git a/layout/reftests/bugs/294306-1b-ref.html b/layout/reftests/bugs/294306-1b-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/294306-1b-ref.html
@@ -0,0 +1,10 @@
+<!DOCTYPE html>
+
+<html>
+  <body>
+    <span src="test.jpg" style="width: 150px; height: 200px; float: right;">Right Float</span>
+    <p>
+Text in the block
+    </p>
+  </body>
+</html>
diff --git a/layout/reftests/bugs/395390-1-ref.html b/layout/reftests/bugs/395390-1-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/395390-1-ref.html
@@ -0,0 +1,5 @@
+<html>
+<body>
+<img src='data:text/plain,' alt="initial. I'M INVISIBLE!">
+</body>
+</html>
diff --git a/layout/reftests/bugs/395390-1.html b/layout/reftests/bugs/395390-1.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/395390-1.html
@@ -0,0 +1,14 @@
+<html class="reftest-wait">
+<head>
+<script type='text/javascript'>
+function changeAltText(img)
+{
+        img.alt = img.alt + ". I'M INVISIBLE!";
+        document.documentElement.className = "";
+}
+</script>
+</head>
+<body onload="changeAltText(document.images[0])">
+<img src='data:text/plain,' alt="initial">
+</body>
+</html>
diff --git a/layout/reftests/bugs/428278-iframe.html b/layout/reftests/bugs/428278-iframe.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/428278-iframe.html
@@ -0,0 +1,10 @@
+<!DOCTYPE HTML>
+<html><head>
+<meta http-equiv="content-type" content="text/html; charset=UTF-8">
+
+
+</head><body>
+<table style="outline-color: red; outline-style: solid; outline-width: medium; border:1px solid black">
+<tr><td style="border:1px solid blue">resize the window
+</table>
+</body></html>
diff --git a/layout/reftests/bugs/428278-ref.html b/layout/reftests/bugs/428278-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/428278-ref.html
@@ -0,0 +1,9 @@
+<!DOCTYPE HTML>
+<html><head>
+<meta http-equiv="content-type" content="text/html; charset=UTF-8">
+
+
+</head><body>
+
+<iframe id="x" src="428278-iframe.html" style="width:400px"></iframe>
+</body></html>
diff --git a/layout/reftests/bugs/428278.html b/layout/reftests/bugs/428278.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/428278.html
@@ -0,0 +1,18 @@
+<!DOCTYPE HTML>
+<html><head>
+<meta http-equiv="content-type" content="text/html; charset=UTF-8">
+
+
+</head><body onload="foo()">
+
+<iframe id="x" src="428278-iframe.html"></iframe>
+<script>
+var w = 400;
+function foo() {
+  var div = document.getElementById('x');
+  div.style.width=w+"px";
+  ++w;
+  var v = document.offsetHeight;
+}
+</script>
+</body></html>
diff --git a/layout/reftests/bugs/438987-1-ref.html b/layout/reftests/bugs/438987-1-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/438987-1-ref.html
@@ -0,0 +1,6 @@
+<!DOCTYPE HTML>
+<html style="background:yellow;">
+<body style="margin:0">
+The yellow table background should be propagated to the viewport.
+</body>
+</html>
diff --git a/layout/reftests/bugs/438987-1.html b/layout/reftests/bugs/438987-1.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/438987-1.html
@@ -0,0 +1,7 @@
+<!DOCTYPE HTML>
+<!-- check that the background of a root table element propagates to the viewport -->
+<html style="display:table; background:yellow;">
+<body style="margin:0">
+The yellow table background should be propagated to the viewport.
+</body>
+</html>
diff --git a/layout/reftests/bugs/438987-2-ref.html b/layout/reftests/bugs/438987-2-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/438987-2-ref.html
@@ -0,0 +1,6 @@
+<!DOCTYPE HTML>
+<html>
+<body>
+<div style="background:rgba(0,0,255,0.5); position:fixed; top:0; left:0; right:0; bottom:0;"></div>
+</body>
+</html>
diff --git a/layout/reftests/bugs/438987-2a.html b/layout/reftests/bugs/438987-2a.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/438987-2a.html
@@ -0,0 +1,5 @@
+<!DOCTYPE HTML>
+<html>
+<body style="background:rgba(0,0,255,0.5);">
+</body>
+</html>
diff --git a/layout/reftests/bugs/438987-2b.html b/layout/reftests/bugs/438987-2b.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/438987-2b.html
@@ -0,0 +1,5 @@
+<!DOCTYPE HTML>
+<html style="background:rgba(0,0,255,0.5);">
+<body>
+</body>
+</html>
diff --git a/layout/reftests/bugs/438987-2c.html b/layout/reftests/bugs/438987-2c.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/438987-2c.html
@@ -0,0 +1,5 @@
+<!DOCTYPE HTML>
+<html style="background:rgba(0,0,255,0.5);">
+<body style="background:red;">
+</body>
+</html>
diff --git a/layout/reftests/bugs/438987-2d.html b/layout/reftests/bugs/438987-2d.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/438987-2d.html
@@ -0,0 +1,5 @@
+<!DOCTYPE HTML>
+<html style="background:rgba(0,0,255,0.5);">
+<body style="background:red;">
+</body>
+</html>
diff --git a/layout/reftests/bugs/448987-ref.html b/layout/reftests/bugs/448987-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/448987-ref.html
@@ -0,0 +1,50 @@
+<!DOCTYPE HTML>
+<html><body onload="focus_area()">
+<pre tabindex="1" id="pre">
+STEPS TO REPRODUCE:
+1. TAB to the image map area below
+
+EXPECTED RESULT:
+a focus border is painted just inside the image edge
+<pre>
+
+<div style="background:lime;padding:1em;float:left"><img src='data:image/gif;base64,R0lGODlhFAFuAPcAAPf39//7/+fn59bT1u/r787Lzq0UAN7b3hhFrRhJtRA0hBA8lMYYALWytffz94wQAMa+vb26vRhNxufj5+/v78bDxvfz772+vcbHxghRCM7PzggkYyFZ1tYkCNbX1hhRzpyenO+6AN7f3gBlANauAGOW7zFl1kp95wg8pbW2tZyanHOi797f5zlx3msMAAB9CP/PAL22va2mraWipedJMSlRtf91Y72WAFqK76WmpRBFta2qrcaeAK2urfdpUuc8If39/e9ZQmPTY94wGFrLWrUkEISq9/n5+ZR5ABCWGLWOAIRpAGNRAClJlK2GAL0sGGssITG2OaWCAK3H9848KaW+762qpcbX/73jvWN5pGvTc/eGc//vCFppfIwgEJRBMYSGlPeWhJSSjHN5jMaSjKWmrb3P787V1ilBa4R9c9nXy+rq6ntNQu/y95Su3svO1kphlISa1t7b1vf7/3uGraWGexdAmoySlDm6QrWyraWqrRiiIWtpa0LDStrl/1JtrcbHzpxlWntlUklVcztZk3vbhISStfffWufr786upVmB1ta2taW21tLS0ve6rd7j5zlhtfemnJSetefn78LCw7W2vdnZ2bVFMf/3//f3/8Z1a9bb59bb3eHh4a2WjM7HxoR1OSGqKbW6xvT09JyGQrXD3v/r5+fk3s7rzufb3q2ytffXKbWiY6inp1p1WrWmjP/LxnOOzsC/v+/n56qSMffXzr2eEP/3hPHx8f//987T57m4ubVZShk5f97LjO/HKQ03ks7DpdZlWv/vMd7LxqWuvefr/86uKd66QgwyhcnJyf/ztbKxsrWqpe/37//z7///75zTpf/397Szsvfn1ozLjO/jlN7v3qWko62OEO/r5//73tbX3vf37wotd1qqYxlNvYyujN7X1qKgoHuWe5KUmkKOQhZKvildMRh5IZqZmcXEwZ2amaajoNfU0QMaTAsiV5STlSo+bZibpSti2puZl5u28pGs5pqbn9Hd8/fr94WFi7i1sBguYfP09v///ywAAAAAFAFuAAAI/wD/CRxIsKDBgwgTKlzIsKHDhxAjSpxIsaLFixgzatzIsaPHjyBDihxJsqTJkyhTqlzJsqXLlzBjypxJs6bNmzhz6tzJs6fPn0CDCh1KtKjRo0iDYinEtJAWLUSIfJv6DVFShnOMXTEzpYrX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' usemap="#bug" border="0"></div>
+
+<map name="bug" id="bug"><area id="area" shape="rect" coords="0,0,275,109" href="#area_1" onclick="alert( 'click' ); return false;"></map>
+
+<script>
+function synthesizeKey(aKey, aEvent, aWindow)
+{
+  netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
+
+  if (!aWindow)
+    aWindow = window;
+
+  var utils = aWindow.QueryInterface(Components.interfaces.nsIInterfaceRequestor).
+                      getInterface(Components.interfaces.nsIDOMWindowUtils);
+  if (utils) {
+    var keyCode = 0, charCode = 0;
+    if (aKey.indexOf("VK_") == 0)
+      keyCode = KeyEvent["DOM_" + aKey];
+    else
+      charCode = aKey.charCodeAt(0);
+
+    if (aEvent.type) {
+      utils.sendKeyEvent(aEvent.type, keyCode, charCode, 0);
+    }
+    else {
+      utils.sendKeyEvent("keydown", keyCode, charCode, 0);
+      utils.sendKeyEvent("keypress", keyCode, charCode, 0);
+      utils.sendKeyEvent("keyup", keyCode, charCode, 0);
+    }
+  }
+}
+
+function focus_area() {
+  document.getElementById("pre").focus();
+  synthesizeKey("VK_TAB",{},window)
+}
+</script>
+
+</body>
+</html>
diff --git a/layout/reftests/bugs/448987.html b/layout/reftests/bugs/448987.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/448987.html
@@ -0,0 +1,50 @@
+<!DOCTYPE HTML>
+<html><body onload="focus_area()">
+<pre tabindex="1" id="pre">
+STEPS TO REPRODUCE:
+1. TAB to the image map area below
+
+EXPECTED RESULT:
+a focus border is painted just inside the image edge
+<pre>
+
+<div style="background:lime;padding:1em;float:left"><img src='data:image/gif;base64,R0lGODlhFAFuAPcAAPf39//7/+fn59bT1u/r787Lzq0UAN7b3hhFrRhJtRA0hBA8lMYYALWytffz94wQAMa+vb26vRhNxufj5+/v78bDxvfz772+vcbHxghRCM7PzggkYyFZ1tYkCNbX1hhRzpyenO+6AN7f3gBlANauAGOW7zFl1kp95wg8pbW2tZyanHOi797f5zlx3msMAAB9CP/PAL22va2mraWipedJMSlRtf91Y72WAFqK76WmpRBFta2qrcaeAK2urfdpUuc8If39/e9ZQmPTY94wGFrLWrUkEISq9/n5+ZR5ABCWGLWOAIRpAGNRAClJlK2GAL0sGGssITG2OaWCAK3H9848KaW+762qpcbX/73jvWN5pGvTc/eGc//vCFppfIwgEJRBMYSGlPeWhJSSjHN5jMaSjKWmrb3P787V1ilBa4R9c9nXy+rq6ntNQu/y95Su3svO1kphlISa1t7b1vf7/3uGraWGexdAmoySlDm6QrWyraWqrRiiIWtpa0LDStrl/1JtrcbHzpxlWntlUklVcztZk3vbhISStfffWufr786upVmB1ta2taW21tLS0ve6rd7j5zlhtfemnJSetefn78LCw7W2vdnZ2bVFMf/3//f3/8Z1a9bb59bb3eHh4a2WjM7HxoR1OSGqKbW6xvT09JyGQrXD3v/r5+fk3s7rzufb3q2ytffXKbWiY6inp1p1WrWmjP/LxnOOzsC/v+/n56qSMffXzr2eEP/3hPHx8f//987T57m4ubVZShk5f97LjO/HKQ03ks7DpdZlWv/vMd7LxqWuvefr/86uKd66QgwyhcnJyf/ztbKxsrWqpe/37//z7///75zTpf/397Szsvfn1ozLjO/jlN7v3qWko62OEO/r5//73tbX3vf37wotd1qqYxlNvYyujN7X1qKgoHuWe5KUmkKOQhZKvildMRh5IZqZmcXEwZ2amaajoNfU0QMaTAsiV5STlSo+bZibpSti2puZl5u28pGs5pqbn9Hd8/fr94WFi7i1sBguYfP09v///ywAAAAAFAFuAAAI/wD/CRxIsKDBgwgTKlzIsKHDhxAjSpxIsaLFixgzatzIsaPHjyBDihxJsqTJkyhTqlzJsqXLlzBjypxJs6bNmzhz6tzJs6fPn0CDCh1KtKjRo0iDYinEtJAWLUSIfJv6DVFShnOMXTEzpYrX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' usemap="#bug" border="0"></div>
+
+<map name="bug" id="bug"><area id="area" shape="default" href="#area_1" onclick="alert( 'click' ); return false;"></map>
+
+<script>
+function synthesizeKey(aKey, aEvent, aWindow)
+{
+  netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
+
+  if (!aWindow)
+    aWindow = window;
+
+  var utils = aWindow.QueryInterface(Components.interfaces.nsIInterfaceRequestor).
+                      getInterface(Components.interfaces.nsIDOMWindowUtils);
+  if (utils) {
+    var keyCode = 0, charCode = 0;
+    if (aKey.indexOf("VK_") == 0)
+      keyCode = KeyEvent["DOM_" + aKey];
+    else
+      charCode = aKey.charCodeAt(0);
+
+    if (aEvent.type) {
+      utils.sendKeyEvent(aEvent.type, keyCode, charCode, 0);
+    }
+    else {
+      utils.sendKeyEvent("keydown", keyCode, charCode, 0);
+      utils.sendKeyEvent("keypress", keyCode, charCode, 0);
+      utils.sendKeyEvent("keyup", keyCode, charCode, 0);
+    }
+  }
+}
+
+function focus_area() {
+  document.getElementById("pre").focus();
+  synthesizeKey("VK_TAB",{},window)
+}
+</script>
+
+</body>
+</html>
diff --git a/layout/reftests/bugs/reftest.list b/layout/reftests/bugs/reftest.list
--- a/layout/reftests/bugs/reftest.list
+++ b/layout/reftests/bugs/reftest.list
@@ -128,10 +128,13 @@ fails == 25888-3r.html 25888-3r-ref.html
 == 201293-1a.html 201293-1-ref.html
 == 201293-1b.html 201293-1-ref.html
 == 201293-1c.html 201293-1-ref.html
 == 201293-1d.html 201293-1-ref.html
 == 206516-1.html 206516-1-ref.html
+== 210094-1a.html 210094-1-ref.html
+== 210094-1b.html 210094-1-ref.html
+!= 210094-1c.html 210094-1-ref.html
 == 210876-1.html 210876-1-ref.html
 == 212563-1.html 212563-1-ref.html
 == 214077-1a.html 214077-1-ref.html
 == 214077-1b.html 214077-1-ref.html
 == 218473-1.html 218473-1-ref.html
@@ -175,10 +178,12 @@ fails-if(MOZ_WIDGET_TOOLKIT!="cocoa") HT
 fails-if(MOZ_WIDGET_TOOLKIT!="cocoa") HTTP == 289480.html#top 289480-ref.html # basically-verbatim acid2 test, HTTP for a 404 page -- bug 409329 for the non-Mac failures
 == 290129-1.html 290129-1-ref.html
 == 291078-1.html 291078-1-ref.html
 == 291078-2.html 291078-2-ref.html
 == 291262-1.html 291262-1-ref.html
+== 294306-1.html 294306-1a-ref.html
+!= 294306-1.html 294306-1b-ref.html
 == 296904-1.html 296904-1-ref.html
 == 300691-1a.html 300691-1-ref.html
 == 300691-1b.html 300691-1-ref.html
 == 300691-1c.html 300691-1-ref.html
 == 300691-1d.html 300691-1-ref.html
@@ -627,10 +632,11 @@ skip-if(MOZ_WIDGET_TOOLKIT!="windows") =
 == 395107-4.html 395107-4-ref.html
 == 395107-5.html 395107-5-ref.html
 == 395130-1.html 395130-1-ref.html
 == 395130-2.html 395130-2-ref.html
 == 395331-1.xml 395331-1-ref.xml
+== 395390-1.html 395390-1-ref.html
 == 396286-1.html about:blank  # crash test
 == 397428-1.html 397428-1-ref.html
 == 397844-1.xhtml 397844-1-ref.xhtml
 == 398092-1.html 398092-1-ref.html
 == 398101-1.html 398101-1-ref.html
@@ -838,10 +844,11 @@ fails-if(MOZ_WIDGET_TOOLKIT=="gtk2") == 
 == 427129-table.html 427129-ref.html
 == 427129-image.html 427129-ref.html
 == 427129-table-caption.html 427129-table-caption-ref.html
 == 427370-1.html 427370-1-ref.html
 == 427730-1.html 427730-1-ref.html
+== 428278.html 428278-ref.html
 == 428423-1a.html 428423-1-ref.html
 == 428423-1b.html 428423-1-ref.html
 == 428521-1a.html 428521-1-ref.html
 == 428521-1b.html 428521-1-ref.html
 == 428521-1c.html 428521-1-ref.html
@@ -857,7 +864,13 @@ random == 429849-1.html 429849-1-ref.htm
 == 433640-1.html 433640-1-ref.html
 == 433700.html 433700-ref.html
 == 436356-1.html 436356-1-ref.html
 == 436356-2.html 436356-2-ref.html
 == 438981-1.xhtml about:blank
+== 438987-1.html 438987-1-ref.html
+== 438987-2a.html 438987-2-ref.html
+== 438987-2b.html 438987-2-ref.html
+== 438987-2c.html 438987-2-ref.html
+!= about:blank 438987-2-ref.html # check that backgrounds work at all 
 == 439004-1.html 439004-1-ref.html
 == 439910.html 439910-ref.html
+# == 448987.html 448987-ref.html  # Disabled for now - it needs privileges
diff --git a/layout/reftests/first-letter/441418-1-ref.html b/layout/reftests/first-letter/441418-1-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/441418-1-ref.html
@@ -0,0 +1,16 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+<style>
+p { color:black; }
+</style>
+</head>
+<body>
+<p><br>
+Hello
+<p>"<br>
+Hello
+<p>"<br>
+Hello
+</body>
+</html>
diff --git a/layout/reftests/first-letter/441418-1.html b/layout/reftests/first-letter/441418-1.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/441418-1.html
@@ -0,0 +1,18 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+<style>
+p { width:0; color:black; }
+p::first-letter { color:yellow; }
+p.pre { white-space:pre; }
+</style>
+</head>
+<body>
+<p class="pre">
+Hello
+<p class="pre">"
+Hello
+<p>"
+Hello
+</body>
+</html>
diff --git a/layout/reftests/first-letter/reftest.list b/layout/reftests/first-letter/reftest.list
--- a/layout/reftests/first-letter/reftest.list
+++ b/layout/reftests/first-letter/reftest.list
@@ -41,5 +41,6 @@ random-if(MOZ_WIDGET_TOOLKIT=="gtk2") ==
 == 399941-5.html 399941-5-ref.html
 == 399941-6.html 399941-6-ref.html
 == 399941-7.html 399941-7-ref.html
 == 399941-8.html 399941-8-ref.html
 == 399941-9.html 399941-9-ref.html
+== 441418-1.html 441418-1-ref.html
diff --git a/layout/reftests/generated-content/display-types-01-ref.html b/layout/reftests/generated-content/display-types-01-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/generated-content/display-types-01-ref.html
@@ -0,0 +1,45 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+<style>
+div { border:1px solid green; margin:5px; }
+</style>
+</head>
+<body>
+<table width="100%"><tr><td valign="top">
+  <div><span style="display:block">1<img src="square-outline-32x32.png">"Before block</span
+>Inner<span style="display:block">2<img src="square-outline-32x32.png">After block"</span
+></div>
+  <div><span style="display:inline">1<img src="square-outline-32x32.png">"Before inline</span
+>Inner<span style="display:inline">2<img src="square-outline-32x32.png">After inline"</span
+></div>
+  <div><span style="display:inline-block">1<img src="square-outline-32x32.png">"Before inline-block</span
+>Inner<span style="display:inline-block">2<img src="square-outline-32x32.png">After inline-block"</span
+></div>
+  <div><span style="display:table">1<img src="square-outline-32x32.png">"Before table</span
+>Inner<span style="display:table">2<img src="square-outline-32x32.png">After table"</span
+></div>
+  <div><span style="display:inline-table">1<img src="square-outline-32x32.png">"Before inline-table</span
+>Inner<span style="display:inline-table">2<img src="square-outline-32x32.png">After inline-table"</span
+></div>
+  <div><span style="display:table-row-group">1<img src="square-outline-32x32.png">"Before table-row-group</span
+>Inner<span style="display:table-row-group">2<img src="square-outline-32x32.png">After table-row-group"</span
+></div>
+</td><td valign="top">
+  <div><span style="display:table-row">1<img src="square-outline-32x32.png">"Before table-row</span
+>Inner<span style="display:table-row">2<img src="square-outline-32x32.png">After table-row"</span
+></div>
+  <div><span style="display:table-cell">1<img src="square-outline-32x32.png">"Before table-cell</span
+>Inner<span style="display:table-cell">2<img src="square-outline-32x32.png">After table-cell"</span
+></div>
+  <div><span style="display:table-caption">1<img src="square-outline-32x32.png">"Before table-caption</span
+>Inner<span style="display:table-caption">2<img src="square-outline-32x32.png">After table-caption"</span
+></div>
+  <div><span style="display:-moz-box">1<img src="square-outline-32x32.png">"Before flexbox</span
+>Inner<span style="display:-moz-box">2<img src="square-outline-32x32.png">After flexbox"</span
+></div>
+  <div><span style="display:-moz-inline-box">1<img src="square-outline-32x32.png">"Before inline-flexbox</span
+>Inner<span style="display:-moz-inline-box">2<img src="square-outline-32x32.png">After inline-flexbox"</span
+></div>
+</body>
+</html>
diff --git a/layout/reftests/generated-content/display-types-01.html b/layout/reftests/generated-content/display-types-01.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/generated-content/display-types-01.html
@@ -0,0 +1,48 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+<style>
+div { counter-reset:ctr; quotes:"\0022" "\0022" "\0022" "\0022"}
+
+div::before {
+  content:counter(ctr) url(square-outline-32x32.png) open-quote "Before " attr(class);
+  counter-increment:ctr;
+}
+div::after {
+  content:counter(ctr) url(square-outline-32x32.png) "After " attr(class) close-quote;
+  counter-increment:ctr;
+}
+
+.block::before, .block::after { display:block; }
+.inline::before, .inline::after { display:inline; }
+.inline-block::before, .inline-block::after { display:inline-block; }
+.table::before, .table::after { display:table; }
+.inline-table::before, .inline-table::after { display:inline-table; }
+.table-row-group::before, .table-row-group::after { display:table-row-group; }
+.table-row::before, .table-row::after { display:table-row; }
+.table-cell::before, .table-cell::after { display:table-cell; }
+.table-caption::before, .table-caption::after { display:table-caption; }
+.flexbox::before, .flexbox::after { display:-moz-box; }
+.inline-flexbox::before, .inline-flexbox::after { display:-moz-inline-box; }
+
+div { border:1px solid green; margin:5px; }
+</style>
+</head>
+
+<body>
+<table width="100%"><tr><td valign="top">
+  <div class="block">Inner</div>
+  <div class="inline">Inner</div>
+  <div class="inline-block">Inner</div>
+  <div class="table">Inner</div>
+  <div class="inline-table">Inner</div>
+  <div class="table-row-group">Inner</div>
+</td><td valign="top">
+  <div class="table-row">Inner</div>
+  <div class="table-cell">Inner</div>
+  <div class="table-caption">Inner</div>
+  <div class="flexbox">Inner</div>
+  <div class="inline-flexbox">Inner</div>
+</td></tr></table>
+</body>
+</html>
diff --git a/layout/reftests/generated-content/dynamic-attr-01-ref.html b/layout/reftests/generated-content/dynamic-attr-01-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/generated-content/dynamic-attr-01-ref.html
@@ -0,0 +1,6 @@
+<!DOCTYPE HTML>
+<html>
+<body>
+before after
+</body>
+</html>
diff --git a/layout/reftests/generated-content/dynamic-attr-01.html b/layout/reftests/generated-content/dynamic-attr-01.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/generated-content/dynamic-attr-01.html
@@ -0,0 +1,22 @@
+<!DOCTYPE HTML>
+<html class="reftest-wait">
+<head>
+<style>
+body::before {
+  content:attr(my-attr);
+}
+body::after {
+  content:attr(my-attr-2);
+}
+</style>
+<script>
+function fixupDOM() {
+  document.body.setAttribute("my-attr", "before");
+  document.body.setAttribute("my-attr-2", "after");
+  document.documentElement.className = "";
+}
+</script>
+</head>
+<body my-attr-2="xyz" onload="fixupDOM()">
+</body>
+</html>
diff --git a/layout/reftests/generated-content/dynamic-restyle-01-ref.html b/layout/reftests/generated-content/dynamic-restyle-01-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/generated-content/dynamic-restyle-01-ref.html
@@ -0,0 +1,7 @@
+<!DOCTYPE HTML>
+<html>
+<body style="border:2px solid red;">
+<span style="border:2px solid red;">Before</span>
+<div>After</div>
+</body>
+</html>
diff --git a/layout/reftests/generated-content/dynamic-restyle-01.html b/layout/reftests/generated-content/dynamic-restyle-01.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/generated-content/dynamic-restyle-01.html
@@ -0,0 +1,24 @@
+<!DOCTYPE HTML>
+<html class="reftest-wait">
+<head>
+<style>
+body::before {
+  content:"Before";
+  border:inherit;
+}
+.cl::after {
+  display:block;
+  content:"After";
+}
+</style>
+<script>
+function fixupDOM() {
+  document.body.setAttribute("style", "border:2px solid red;");
+  document.body.className = "cl";
+  document.documentElement.className = "";
+}
+</script>
+</head>
+<body onload="fixupDOM()">
+</body>
+</html>
diff --git a/layout/reftests/generated-content/floated-01-ref.html b/layout/reftests/generated-content/floated-01-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/generated-content/floated-01-ref.html
@@ -0,0 +1,23 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+<style>
+div { border:1px solid green; margin:5px; }
+div { overflow:auto; }
+</style>
+</head>
+<body>
+<div><span style="float:left">1<img src="square-outline-32x32.png">"Before beforeleft afterleft</span
+>Inner<span style="float:left">2<img src="square-outline-32x32.png">After beforeleft afterleft"</span
+></div>
+<div><span style="float:left">1<img src="square-outline-32x32.png">"Before beforeleft afterright</span
+>Inner<span style="float:right">2<img src="square-outline-32x32.png">After beforeleft afterright"</span
+></div>
+<div><span style="float:right">1<img src="square-outline-32x32.png">"Before beforeright afterleft</span
+>Inner<span style="float:left">2<img src="square-outline-32x32.png">After beforeright afterleft"</span
+></div>
+<div><span style="float:right">1<img src="square-outline-32x32.png">"Before beforeright afterright</span
+>Inner<span style="float:right">2<img src="square-outline-32x32.png">After beforeright afterright"</span
+></div>
+</body>
+</html>
diff --git a/layout/reftests/generated-content/floated-01.html b/layout/reftests/generated-content/floated-01.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/generated-content/floated-01.html
@@ -0,0 +1,39 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+<style>
+div { counter-reset:ctr; quotes:"\0022" "\0022" "\0022" "\0022"; }
+
+div::before {
+  content:counter(ctr) url(square-outline-32x32.png) open-quote "Before " attr(class);
+  counter-increment:ctr;
+}
+div::after {
+  content:counter(ctr) url(square-outline-32x32.png) "After " attr(class) close-quote;
+  counter-increment:ctr;
+}
+
+.beforeleft::before {
+  float:left;
+}
+.beforeright::before {
+  float:right;
+}
+.afterleft::after {
+  float:left;
+}
+.afterright::after {
+  float:right;
+}
+
+div { border:1px solid green; margin:5px; }
+div { overflow:auto; }
+</style>
+</head>
+<body>
+<div class="beforeleft afterleft">Inner</div>
+<div class="beforeleft afterright">Inner</div>
+<div class="beforeright afterleft">Inner</div>
+<div class="beforeright afterright">Inner</div>
+</body>
+</html>
diff --git a/layout/reftests/generated-content/images-01-ref.html b/layout/reftests/generated-content/images-01-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/generated-content/images-01-ref.html
@@ -0,0 +1,11 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+<style>
+div { border:1px solid green; margin:5px; }
+</style>
+</head>
+<body>
+<div>Inner</div>
+</body>
+</html>
diff --git a/layout/reftests/generated-content/images-01.html b/layout/reftests/generated-content/images-01.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/generated-content/images-01.html
@@ -0,0 +1,13 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+<style>
+div::before {
+  content:url(missing-image.png);
+}
+div { border:1px solid green; margin:5px; }
+</style>
+</head>
+<div>Inner</div>
+</body>
+</html>
diff --git a/layout/reftests/generated-content/positioned-01-ref.html b/layout/reftests/generated-content/positioned-01-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/generated-content/positioned-01-ref.html
@@ -0,0 +1,21 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+<style>
+div { border:1px solid green; margin:5px; height:100px; }
+</style>
+</head>
+<div><span style="position:absolute; left:0">1<img src="square-outline-32x32.png">"Before gen abs</span
+>Inner<span style="position:absolute; right:0">2<img src="square-outline-32x32.png">After gen abs"</span
+></div>
+<div style="position:relative"><span style="position:absolute; left:0">1<img src="square-outline-32x32.png">"Before gen abs</span
+>Inner<span style="position:absolute; right:0">2<img src="square-outline-32x32.png">After gen abs"</span
+></div>
+<div><span style="position:relative; top:-10px;">1<img src="square-outline-32x32.png">"Before gen rel</span
+>Inner<span style="position:relative; top:10px;">2<img src="square-outline-32x32.png">After gen rel"</span
+></div>
+<div>Begin <span style="position:relative; top:-10px;">1<img src="square-outline-32x32.png">"Before gen rel</span
+>Inner<span style="position:relative; top:10px;">2<img src="square-outline-32x32.png">After gen rel"</span
+> End</div>
+</body>
+</html>
diff --git a/layout/reftests/generated-content/positioned-01.html b/layout/reftests/generated-content/positioned-01.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/generated-content/positioned-01.html
@@ -0,0 +1,43 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+<style>
+div { counter-reset:ctr; quotes:"\0022" "\0022" "\0022" "\0022"; }
+
+.gen::before {
+  content:counter(ctr) url(square-outline-32x32.png) open-quote "Before " attr(class);
+  counter-increment:ctr;
+}
+.gen::after {
+  content:counter(ctr) url(square-outline-32x32.png) "After " attr(class) close-quote;
+  counter-increment:ctr;
+}
+
+.abs::before {
+  position:absolute;
+  left:0;
+}
+.abs::after {
+  position:absolute;
+  right:0;
+}
+
+.rel::before {
+  position:relative;
+  top:-10px;
+}
+.rel::after {
+  position:relative;
+  top:10px;
+}
+
+div { border:1px solid green; margin:5px; height:100px; }
+</style>
+</head>
+<div class="gen abs">Inner</div>
+<!-- an element should be the containing block for its positioned content -->
+<div style="position:relative;" class="gen abs">Inner</div>
+<div class="gen rel">Inner</div>
+<div>Begin <span class="gen rel">Inner</span> End</div>
+</body>
+</html>
diff --git a/layout/reftests/generated-content/reftest.list b/layout/reftests/generated-content/reftest.list
new file mode 100644
--- /dev/null
+++ b/layout/reftests/generated-content/reftest.list
@@ -0,0 +1,8 @@
+== display-types-01.html display-types-01-ref.html
+== dynamic-attr-01.html dynamic-attr-01-ref.html
+== dynamic-restyle-01.html dynamic-restyle-01-ref.html
+== floated-01.html floated-01-ref.html
+== images-01.html images-01-ref.html
+== positioned-01.html positioned-01-ref.html
+== table-ignoring-whitespace-01.html table-ignoring-whitespace-01-ref.html
+# == table-parts-01.html table-parts-01-ref.html
diff --git a/layout/reftests/generated-content/square-outline-32x32.png b/layout/reftests/generated-content/square-outline-32x32.png
new file mode 100644
index 0000000000000000000000000000000000000000..144cb3b10aba99f34ec7be4261bc848632008866
GIT binary patch
literal 119
zc%17D@N?(olHy`uVBq!ia0vp^3LwnE1SJ1Ryj={W7>k44ofy`glX(f`7<#%mhIkx*
zd)|?k!9n2Afueu5o3%XNUF1q&>fydnwsqc~ugr`v&=}uP$-b<Y+2&+-iY!nwgQu&X
J%Q~loCIA@aA>9A~

diff --git a/layout/reftests/generated-content/table-ignoring-whitespace-01-ref.html b/layout/reftests/generated-content/table-ignoring-whitespace-01-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/generated-content/table-ignoring-whitespace-01-ref.html
@@ -0,0 +1,27 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+<style>
+div { border:1px solid green; margin:5px; }
+</style>
+</head>
+
+<body>
+<div>
+  <table><tbody><tr><td>Cell0</td><td></td></tr>
+                <tr><td>Cell1</td><td>Cell2</td></tr></tbody></table>
+</div>
+<div>
+  <table><tbody><tr><td></td><td>Cell0</td></tr>
+                <tr><td>Cell1</td><td>Cell2</td></tr></tbody></table>
+</div>
+<div>
+  <table><tbody><tr><td></td><td>Cell0</td></tr>
+                <tr><td>Cell1</td><td>Cell2</td></tr></tbody></table>
+</div>
+<div>
+  <table><tbody><tr><td></td><td>Cell0</td></tr>
+                <tr><td>Cell1</td><td>Cell2</td></tr></tbody></table>
+</div>
+</body>
+</html>
diff --git a/layout/reftests/generated-content/table-ignoring-whitespace-01.html b/layout/reftests/generated-content/table-ignoring-whitespace-01.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/generated-content/table-ignoring-whitespace-01.html
@@ -0,0 +1,44 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+<style>
+.gen0::before {
+  padding:1px;
+}
+.gen1::before {
+  content: " ";
+}
+.gen2::before {
+  content: attr(missing);
+}
+.gen3::before {
+  content: url(missing-image.png);
+}
+
+div { border:1px solid green; margin:5px; }
+</style>
+</head>
+
+<!-- This tests that generated content items that evaluate to empty strings or
+     broken images are *not* treated as whitespace text and ignored by the table.
+     Altogether missing content should be ignored, though. (In fact it won't even be generated.) -->
+
+<body>
+<div>
+  <table><tbody><tr class="gen0"><td>Cell0</td></tr>
+                <tr><td>Cell1</td><td>Cell2</td></tr></tbody></table>
+</div>
+<div>
+  <table><tbody><tr class="gen1"><td>Cell0</td></tr>
+                <tr><td>Cell1</td><td>Cell2</td></tr></tbody></table>
+</div>
+<div>
+  <table><tbody><tr class="gen2"><td>Cell0</td></tr>
+                <tr><td>Cell1</td><td>Cell2</td></tr></tbody></table>
+</div>
+<div>
+  <table><tbody><tr class="gen3"><td>Cell0</td></tr>
+                <tr><td>Cell1</td><td>Cell2</td></tr></tbody></table>
+</div>
+</body>
+</html>
diff --git a/layout/reftests/generated-content/table-parts-01-ref.html b/layout/reftests/generated-content/table-parts-01-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/generated-content/table-parts-01-ref.html
@@ -0,0 +1,76 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+<style>
+table { counter-reset:ctr; quotes:"\0022" "\0022" "\0022" "\0022"; }
+
+table { border:1px solid blue; }
+tbody { vertical-align:baseline; }
+td.real { border:1px solid cyan; }
+td { border-spacing:0; padding:0; }
+
+.table { display:table; }
+.row { display:table-row; }
+.rowgroup { display:table-row-group; }
+
+div { border:1px solid green; margin:5px; }
+div.cell { border:none; display:table-cell; }
+div.real { display:table-cell; }
+
+.tall { height:100px; }
+
+.yellow { background:yellow; }
+.orange { background:orange; }
+.brown { background:brown; }
+</style>
+</head>
+
+<body>
+<table style="border:none" width="100%"><tr><td style="border:none" valign="top">
+  <div><table><tbody><tr><td>1<img src="square-outline-32x32.png">"Before gen</td
+><td class="real">Inner</td><td>2<img src="square-outline-32x32.png">After gen"</td
+></tr></tbody></table></div>
+  <div><table><tbody><tr><td>1<img src="square-outline-32x32.png">"Before gen</td
+></tr><tr><td class="real">Inner</td></tr><tr><td>2<img src="square-outline-32x32.png">After gen"</td
+></tr></tbody></table></div>
+  <div><table><tbody><tr><td>1<img src="square-outline-32x32.png">"Before gen</td
+></tr><tr><td>2<img src="square-outline-32x32.png">After gen"</td
+></tr><tr><td class="real">Inner</td></tr></tbody></table></div>
+  <div><table><tbody><tr><td class="real">Inner</td></tr></tbody></table></div>
+  <div><table><tbody><tr><td>2<img src="square-outline-32x32.png">After gen headfoot"</td
+></tr><tr><td class="real">Inner</td></tr><tr><td>1<img src="square-outline-32x32.png">"Before gen headfoot</td
+></tr></tbody></table></div>
+  <div><div class="table tall"><div class="cell yellow">1<img src="square-outline-32x32.png">"Before gen table gencell varyheight</div
+><div class="real orange">Inner</div><div class="cell brown">2<img src="square-outline-32x32.png">After gen table gencell varyheight"</div
+></div></div>
+  <div><div><div class="table tall" style="border:none; margin:0;"><div class="cell yellow">1<img src="square-outline-32x32.png">"Before gen gencell varyheight</div
+><div class="real orange">Inner</div><div class="cell brown">2<img src="square-outline-32x32.png">After gen gencell varyheight"</div
+></div></div></div>
+  <div><div><div class="table" style="border:none; margin:0;"><div class="row yellow">1<img src="square-outline-32x32.png">"Before gen genrow varywidth</div
+><div class="row orange">Inner</div><div class="row brown">2<img src="square-outline-32x32.png">After gen genrow varywidth"</div
+></div></div></div>
+</td><td style="border:none" valign="top">
+  <div><div class="row"><div class="cell">1<img src="square-outline-32x32.png">"Before gen row gencell</div
+><div class="real">Inner</div><div class="cell">2<img src="square-outline-32x32.png">After gen row gencell"</div
+></div></div>
+  <div><div class="row"><div class="cell">1<img src="square-outline-32x32.png">"Before gen row genblock</div
+><div class="real">Inner</div><div class="cell">2<img src="square-outline-32x32.png">After gen row genblock"</div
+></div></div>
+  <div><div class="row"><div class="cell">1<img src="square-outline-32x32.png">"Before gen row geninline</div
+><div class="real">Inner</div><div class="cell">2<img src="square-outline-32x32.png">After gen row geninline"</div
+></div></div>
+  <div><div class="rowgroup"><div class="row">1<img src="square-outline-32x32.png">"Before gen rowgroup genrow</div
+><div class="row"><div class="real">Inner</div></div><div class="row">2<img src="square-outline-32x32.png">After gen rowgroup genrow"</div
+></div></div>
+  <div><div class="rowgroup"><div class="row">1<img src="square-outline-32x32.png">"Before gen rowgroup gencell</div
+><div class="row"><div class="real">Inner</div></div><div class="row">2<img src="square-outline-32x32.png">After gen rowgroup gencell"</div
+></div></div>
+  <div><div class="rowgroup"><div class="row">1<img src="square-outline-32x32.png">"Before gen rowgroup genblock</div
+><div class="row"><div class="real">Inner</div></div><div class="row">2<img src="square-outline-32x32.png">After gen rowgroup genblock"</div
+></div></div>
+  <div><div class="rowgroup"><div class="row">1<img src="square-outline-32x32.png">"Before gen rowgroup geninline</div
+><div class="row"><div class="real">Inner</div></div><div class="row">2<img src="square-outline-32x32.png">After gen rowgroup geninline"</div
+></div></div>
+</tr></td></table>
+</body>
+</html>
diff --git a/layout/reftests/generated-content/table-parts-01.html b/layout/reftests/generated-content/table-parts-01.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/generated-content/table-parts-01.html
@@ -0,0 +1,70 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+<style>
+table, div.gen { counter-reset:ctr; quotes:"\0022" "\0022" "\0022" "\0022"; }
+
+.gen::before {
+  content:counter(ctr) url(square-outline-32x32.png) open-quote "Before " attr(class);
+  counter-increment:ctr;
+}
+.gen::after {
+  content:counter(ctr) url(square-outline-32x32.png) "After " attr(class) close-quote;
+  counter-increment:ctr;
+}
+
+table { border:1px solid blue; }
+tbody { vertical-align:baseline; }
+td { border:1px solid cyan; }
+td { border-spacing:0; padding:0; }
+
+tr.gen::before, tr.gen::after { display:table-cell; }
+tbody.gen::before, tbody.gen::after { display:table-row; }
+table.gen::before, table.gen::after { display:table-row-group; }
+table.col::before, table.gen.col::after { display:table-column-group; }
+/* note reordering here! */
+table.headfoot::after { display:table-header-group; }
+table.headfoot::before { display:table-footer-group; }
+
+.cell { display:table-cell; }
+.row { display:table-row; }
+.rowgroup { display:table-row-group; }
+.table { display:table; }
+div.gencell::before, div.gencell::after { display:table-cell; }
+div.genrow::before, div.genrow::after { display:table-row; }
+div.genblock::before, div.genblock::after { display:block; }
+div.geninline::before, div.geninline::after { display:inline; }
+
+div { border:1px solid green; margin:5px; }
+
+.varyheight::before { height:100px; background:yellow; }
+.varyheight > div { height:80px; background:orange; }
+.varyheight::after { height:60px; background:brown; }
+
+.varywidth::before { background:yellow; }
+.varywidth > div { background:orange; }
+.varywidth::after { background:brown; }
+</style>
+</head>
+
+<body>
+<table style="border:none" width="100%"><tr><td style="border:none" valign="top">
+  <div><table><tbody><tr class="gen"><td>Inner</td></tr></tbody></table></div>
+  <div><table><tbody class="gen"><tr><td>Inner</td></tr></tbody></table></div>
+  <div><table class="gen"><tfoot><tr><td>Inner</td></tr></tfoot></table></div>
+  <div><table class="gen col"><tbody><tr><td>Inner</td></tr></tbody></table></div>
+  <div><table class="gen headfoot"><tbody><tr><td>Inner</td></tr></tbody></table></div>
+  <div><div class="gen table gencell varyheight"><div class="cell">Inner</div></div></div>
+  <div><div class="gen gencell varyheight"><div class="cell">Inner</div></div></div>
+  <div><div class="gen genrow varywidth"><div class="row">Inner</div></div></div>
+</td><td style="border:none" valign="top">
+  <div><div class="gen row gencell"><div class="cell">Inner</div></div></div>
+  <div><div class="gen row genblock"><div class="cell">Inner</div></div></div>
+  <div><div class="gen row geninline"><div class="cell">Inner</div></div></div>
+  <div><div class="gen rowgroup genrow"><div class="row"><div class="cell">Inner</div></div></div></div>
+  <div><div class="gen rowgroup gencell"><div class="row"><div class="cell">Inner</div></div></div></div>
+  <div><div class="gen rowgroup genblock"><div class="row"><div class="cell">Inner</div></div></div></div>
+  <div><div class="gen rowgroup geninline"><div class="row"><div class="cell">Inner</div></div></div></div>
+</tr></td></table>
+</body>
+</html>
diff --git a/layout/reftests/pagination/abspos-breaking-000.ref.xhtml b/layout/reftests/pagination/abspos-breaking-000.ref.xhtml
new file mode 100644
--- /dev/null
+++ b/layout/reftests/pagination/abspos-breaking-000.ref.xhtml
@@ -0,0 +1,40 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" class="reftest-print">
+ <head>
+  <title>AbsPos Pagination</title>
+  <style type="text/css">
+    html, body, pre { margin: 0; padding: 0; }
+    pre {
+      padding-top: 1in;
+      line-height: 1;
+      font-size: 0.25in;
+    }
+  </style>
+ </head>
+ <body>
+ <pre>1
+2
+3
+4
+5
+6
+7
+8
+9
+10
+11
+12
+13
+14
+15
+16
+17
+18
+19
+20
+21
+22
+23
+24</pre>
+</body>
+</html>
diff --git a/layout/reftests/pagination/abspos-breaking-000.xhtml b/layout/reftests/pagination/abspos-breaking-000.xhtml
new file mode 100644
--- /dev/null
+++ b/layout/reftests/pagination/abspos-breaking-000.xhtml
@@ -0,0 +1,41 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" class="reftest-print">
+ <head>
+  <title>AbsPos Pagination</title>
+  <style type="text/css">
+    html, body, pre { margin: 0; padding: 0; }
+    pre {
+      position: absolute;
+      top: 1in;
+      line-height: 1;
+      font-size: 0.25in;
+    }
+  </style>
+ </head>
+ <body>
+ <pre>1
+2
+3
+4
+5
+6
+7
+8
+9
+10
+11
+12
+13
+14
+15
+16
+17
+18
+19
+20
+21
+22
+23
+24</pre>
+</body>
+</html>
diff --git a/layout/reftests/pagination/abspos-breaking-001.xhtml b/layout/reftests/pagination/abspos-breaking-001.xhtml
new file mode 100644
--- /dev/null
+++ b/layout/reftests/pagination/abspos-breaking-001.xhtml
@@ -0,0 +1,42 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" class="reftest-print">
+ <head>
+  <title>AbsPos Pagination</title>
+  <style type="text/css">
+    html, body, pre { margin: 0; padding: 0; }
+    pre {
+      position: absolute;
+      margin-top: 0.5in;
+      padding-top: 0.5in;
+      line-height: 1;
+      font-size: 0.25in;
+    }
+  </style>
+ </head>
+ <body>
+ <pre>1
+2
+3
+4
+5
+6
+7
+8
+9
+10
+11
+12
+13
+14
+15
+16
+17
+18
+19
+20
+21
+22
+23
+24</pre>
+</body>
+</html>
diff --git a/layout/reftests/pagination/abspos-breaking-002.xhtml b/layout/reftests/pagination/abspos-breaking-002.xhtml
new file mode 100644
--- /dev/null
+++ b/layout/reftests/pagination/abspos-breaking-002.xhtml
@@ -0,0 +1,43 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" class="reftest-print">
+ <head>
+  <title>AbsPos Pagination</title>
+  <style type="text/css">
+    html, body, pre { margin: 0; padding: 0; }
+    pre {
+      position: absolute;
+      margin-top: 0.3in;
+      padding-top: 0.3in;
+      top: 0.4in;
+      line-height: 1;
+      font-size: 0.25in;
+    }
+  </style>
+ </head>
+ <body>
+ <pre>1
+2
+3
+4
+5
+6
+7
+8
+9
+10
+11
+12
+13
+14
+15
+16
+17
+18
+19
+20
+21
+22
+23
+24</pre>
+</body>
+</html>
diff --git a/layout/reftests/pagination/reftest.list b/layout/reftests/pagination/reftest.list
--- a/layout/reftests/pagination/reftest.list
+++ b/layout/reftests/pagination/reftest.list
@@ -18,5 +18,8 @@
 == content-inserted-005.xhtml content-inserted-002.ref.xhtml
 == content-inserted-006.xhtml content-inserted-002.ref.xhtml
 == content-inserted-007.xhtml content-inserted-002.ref.xhtml
 == content-inserted-008.xhtml content-inserted-001.ref.xhtml
 == content-inserted-009.xhtml content-inserted-002.ref.xhtml
+== abspos-breaking-000.xhtml abspos-breaking-000.ref.xhtml
+== abspos-breaking-001.xhtml abspos-breaking-000.ref.xhtml
+== abspos-breaking-002.xhtml abspos-breaking-000.ref.xhtml
diff --git a/layout/reftests/svg/conditions-01.svg b/layout/reftests/svg/conditions-01.svg
new file mode 100644
--- /dev/null
+++ b/layout/reftests/svg/conditions-01.svg
@@ -0,0 +1,20 @@
+<?xml version="1.0"?>
+<!--
+     Any copyright is dedicated to the Public Domain.
+     http://creativecommons.org/licenses/publicdomain/
+-->
+<svg version="1.1" xmlns="http://www.w3.org/2000/svg">
+	<title>Testcase for conditions</title>
+	<!-- From https://bugzilla.mozilla.org/show_bug.cgi?id=409383 -->
+
+	<rect width="100%" height="100%" fill="lime"/>
+	
+	<rect systemLanguage="foo" x="50" y="100" width="50" height="50" fill="red"/>
+
+	<rect x="200" y="100" width="50" height="50" fill="red"/>
+	<rect requiredFeatures="http://www.w3.org/TR/SVG11/feature#Gradient" x="200" y="100" width="50" height="50" fill="lime"/>
+
+	<rect requiredFeatures="foo" x="50" y="200" width="50" height="50" fill="red"/>
+
+	<rect requiredExtensions="foo" x="200" y="200" width="50" height="50" fill="red"/>
+</svg>
diff --git a/layout/reftests/svg/dynamic-clipPath-01.svg b/layout/reftests/svg/dynamic-clipPath-01.svg
new file mode 100644
--- /dev/null
+++ b/layout/reftests/svg/dynamic-clipPath-01.svg
@@ -0,0 +1,120 @@
+<!--
+     Any copyright is dedicated to the Public Domain.
+     http://creativecommons.org/licenses/publicdomain/
+-->
+<svg xmlns="http://www.w3.org/2000/svg" version="1.1"
+     class="reftest-wait"
+     onload="setTimeout(doTest,10)"
+     xmlns:xlink="http://www.w3.org/1999/xlink">
+  <title>Testing that dynamic changes to the element for a given ID are reflected in clip-path</title>
+  <defs>
+    <svg id="d">
+      <rect width="100%" height="50%" fill="lime"/>
+      <rect y="50%" width="100%" height="50%" fill="red"/>
+    </svg>
+  </defs>
+
+  <rect y="30%" width="100%" height="70%" fill="lime"/>
+
+  <use xlink:href="#d" id="u1" x="10%" width="11%" height="100%" clip-path="url(#r1)"/>
+  <script>
+    // force frame construction; test that parsing "r1" after frame construction
+    // is still bound to "u1" eventually
+    var rect = document.getElementById("u1").getBoundingClientRect();
+  </script>
+  <clipPath id="r1">
+    <rect width="100%" height="40%"/>
+  </clipPath>
+
+  <clipPath id="x">
+    <rect width="100%" height="40%"/>
+  </clipPath>
+  <use xlink:href="#d" id="u2" x="20%" width="11%" height="100%" clip-path="url(#r2)"/>
+
+  <clipPath id="r3">
+    <rect width="100%" height="100%"/>
+  </clipPath>
+  <clipPath id="r3">
+    <rect width="100%" height="40%"/>
+  </clipPath>
+  <use xlink:href="#d" id="u3" x="30%" width="11%" height="100%" clip-path="url(#r3)"/>
+
+  <clipPath id="r4">
+    <rect width="100%" height="100%"/>
+  </clipPath>
+  <clipPath id="r4">
+    <rect width="100%" height="40%"/>
+  </clipPath>
+  <use xlink:href="#d" id="u4" x="40%" width="11%" height="100%" clip-path="url(#r4)"/>
+
+  <clipPath id="r5">
+    <rect width="100%" height="100%"/>
+  </clipPath>
+  <use xlink:href="#d" id="u5" x="50%" width="11%" height="100%" clip-path="url(#r5)"/>
+
+  <clipPath id="r6">
+    <rect width="100%" height="100%"/>
+  </clipPath>
+  <clipPath id="r6-2">
+    <rect width="100%" height="40%"/>
+  </clipPath>
+  <use xlink:href="#d" id="u6" x="60%" width="11%" height="100%" clip-path="url(#r6)"/>
+
+  <clipPath id="r7">
+    <rect width="100%" height="40%"/>
+  </clipPath>
+  <clipPath id="r7-2">
+    <rect width="100%" height="100%"/>
+  </clipPath>
+  <use xlink:href="#d" id="u7" x="70%" width="11%" height="100%" clip-path="url(#r7)"/>
+
+  <clipPath id="r8-2">
+    <rect width="100%" height="40%"/>
+  </clipPath>
+  <clipPath id="r8">
+    <rect width="100%" height="100%"/>
+  </clipPath>
+  <use xlink:href="#d" id="u8" x="80%" width="11%" height="100%" clip-path="url(#r8)"/>
+
+  <rect width="11%" height="100%" fill="lime"/>
+  <rect x="90%" width="11%" height="100%" fill="lime"/>
+
+  <script>
+  function doTest() {
+    // check that changing an id to "r2" lets u2 find it
+    var r2 = document.getElementById("x");
+    r2.setAttribute("id", "r2");
+
+    var rect = document.getElementById("u3").getBoundingClientRect();
+    // check that removing the bad r3 lets u3 find the good one
+    var r3 = document.getElementById("r3");
+    r3.parentNode.removeChild(r3);
+
+    // check that renaming the bad r4 lets u4 find the good one
+    var r4 = document.getElementById("r4");
+    r4.removeAttribute("id");
+
+    // check that changing u5's reference works
+    var u5 = document.getElementById("u5");
+    u5.setAttribute("clip-path", "url(#r1)");
+
+    // check that inserting a good element before the bad r6 works
+    var r6 = document.getElementById("r6-2");
+    r6.parentNode.removeChild(r6);
+    r6.setAttribute("id", "r6");
+    document.documentElement.insertBefore(r6, document.documentElement.firstChild);
+
+    // check that inserting a bad element after a good one doesn't break anything
+    var r7 = document.getElementById("r7-2");
+    r7.parentNode.removeChild(r7);
+    r7.setAttribute("id", "r7");
+    document.documentElement.appendChild(r7);
+
+    // check that renaming a good element to r8 works
+    var r8 = document.getElementById("r8-2");
+    r8.setAttribute("id", "r8");
+
+    document.documentElement.removeAttribute("class");
+  }
+  </script>
+</svg>
diff --git a/layout/reftests/svg/dynamic-conditions-01.svg b/layout/reftests/svg/dynamic-conditions-01.svg
new file mode 100644
--- /dev/null
+++ b/layout/reftests/svg/dynamic-conditions-01.svg
@@ -0,0 +1,38 @@
+<?xml version="1.0"?>
+<!--
+     Any copyright is dedicated to the Public Domain.
+     http://creativecommons.org/licenses/publicdomain/
+-->
+<svg version="1.1" xmlns="http://www.w3.org/2000/svg" onload="m();">
+	<title>Testcase for dynamic conditions</title>
+	<!-- From https://bugzilla.mozilla.org/show_bug.cgi?id=409383 -->
+
+	<script>
+		function m() {
+		var svgns = "http://www.w3.org/2000/svg";
+
+		var rect1 = document.getElementById("rect1");
+		rect1.setAttribute("systemLanguage", "foo");
+
+		var rect2 = document.getElementById("rect2");
+		rect2.setAttribute("requiredFeatures", "http://www.w3.org/TR/SVG11/feature#Gradient");
+
+		var rect3 = document.getElementById("rect3");
+		rect3.setAttribute("requiredFeatures", "foo");
+
+		var rect4 = document.getElementById("rect4");
+		rect4.setAttribute("requiredExtensions", "foo");
+		}
+	</script>
+
+	<rect width="100%" height="100%" fill="lime"/>
+	
+	<rect id="rect1" x="50" y="100" width="50" height="50" fill="red"/>
+
+	<rect x="200" y="100" width="50" height="50" fill="red"/>
+	<rect id="rect2" x="200" y="100" width="50" height="50" fill="lime"/>
+
+	<rect id="rect3" x="50" y="200" width="50" height="50" fill="red"/>
+
+	<rect id="rect4" x="200" y="200" width="50" height="50" fill="red"/>
+</svg>
diff --git a/layout/reftests/svg/invalid-text-01.svg b/layout/reftests/svg/invalid-text-01.svg
new file mode 100644
--- /dev/null
+++ b/layout/reftests/svg/invalid-text-01.svg
@@ -0,0 +1,15 @@
+<!--
+     Any copyright is dedicated to the Public Domain.
+     http://creativecommons.org/licenses/publicdomain/
+-->
+<svg xmlns="http://www.w3.org/2000/svg" version="1.1">
+
+  <title>Testcase for invalid text</title>
+
+  <!-- From https://bugzilla.mozilla.org/show_bug.cgi?id=445687 -->
+
+  <rect width="100%" height="100%" fill="lime"/>
+
+  <text x="50" y="50" font-size="30"><tspan><text x="50" y="50" font-size="30">Should not see this</text></tspan></text>
+
+</svg>
diff --git a/layout/reftests/svg/reftest.list b/layout/reftests/svg/reftest.list
--- a/layout/reftests/svg/reftest.list
+++ b/layout/reftests/svg/reftest.list
@@ -10,13 +10,16 @@ include filters/reftest.list
 # Mozilla only tests (i.e. those containing XUL/XBL/etc.)
 include moz-only/reftest.list
 
 == clipPath-basic-01.svg pass.svg
 == clip-surface-clone-01.svg clip-surface-clone-01-ref.svg
+== conditions-01.svg pass.svg
 == currentColor-01.svg pass.svg
 == currentColor-02.svg pass.svg
 == currentColor-03.svg pass.svg
+== dynamic-conditions-01.svg pass.svg
+== dynamic-clipPath-01.svg pass.svg
 == dynamic-link-style-01.svg pass.svg
 == dynamic-rect-01.svg dynamic-rect-01-ref.svg
 == dynamic-rect-02.svg dynamic-rect-02-ref.svg
 == dynamic-rect-03.svg dynamic-rect-03-ref.svg
 == dynamic-rect-04.xhtml pass.svg
@@ -42,10 +45,11 @@ include moz-only/reftest.list
 == foreignObject-overflow-01.svg pass.svg
 == getElementById-a-element-01.svg pass.svg
 fails == inline-in-xul-basic-01.xul pass.svg
 == image-scaling-01.svg pass.svg
 == image-scaling-02.svg pass.svg
+== invalid-text-01.svg pass.svg
 == linearGradient-basic-01.svg pass.svg
 == linearGradient-basic-02.svg pass.svg
 == nested-viewBox-01.svg pass.svg
 == objectBoundingBox-and-pattern-01a.svg objectBoundingBox-and-pattern-01-ref.svg
 == objectBoundingBox-and-pattern-01b.svg objectBoundingBox-and-pattern-01-ref.svg
diff --git a/layout/style/Makefile.in b/layout/style/Makefile.in
--- a/layout/style/Makefile.in
+++ b/layout/style/Makefile.in
@@ -85,10 +85,12 @@ EXPORTS		= \
 		nsCSSProps.h \
 		nsCSSPseudoClassList.h \
 		nsCSSPseudoClasses.h \
 		nsCSSPseudoElementList.h \
 		nsCSSPseudoElements.h \
+		nsCSSRuleProcessor.h \
+		nsCSSStyleSheet.h \
 		nsCSSStruct.h \
 		nsCSSValue.h \
 		nsDOMCSSDeclaration.h \
 		nsICSSDeclaration.h \
 		nsICSSGroupRule.h \
diff --git a/layout/style/nsCSSDataBlock.cpp b/layout/style/nsCSSDataBlock.cpp
--- a/layout/style/nsCSSDataBlock.cpp
+++ b/layout/style/nsCSSDataBlock.cpp
@@ -46,14 +46,14 @@
 #include "nsRuleNode.h"
 #include "nsStyleSet.h"
 
 /*
  * nsCSSCompressedDataBlock holds property-value pairs corresponding to
- * CSS declaration blocks.  The value is stored in one of the six CSS
- * data types.  These six types are nsCSSValue, nsCSSRect,
- * nsCSSValueList, nsCSSCounterData, nsCSSQuotes, and nsCSSValuePair, and
- * each correspond to a value of the nsCSSType enumeration.
+ * CSS declaration blocks.  The value is stored in one of the five CSS
+ * data types: nsCSSValue, nsCSSRect, nsCSSValueList, nsCSSValuePair,
+ * and nsCSSValuePairList, which each correspond to a value of the
+ * nsCSSType enumeration.
  *
  * The storage strategy uses the CDB*Storage structs below to help
  * ensure that all the types remain properly aligned.  nsCSSValue's
  * alignment requirements cannot be weaker than any others, since it
  * contains a pointer and an enumeration.
@@ -150,27 +150,17 @@ inline nsCSSValueList* ValueListAtCursor
 inline nsCSSValueList* ValueListAtCursor(const char *aCursor) {
     return static_cast<nsCSSValueList*>
                       (reinterpret_cast<const CDBPointerStorage*>(aCursor)->value);
 }
 
-inline nsCSSCounterData*& CounterDataAtCursor(char *aCursor) {
-    return * reinterpret_cast<nsCSSCounterData**>
+inline nsCSSValuePairList*& ValuePairListAtCursor(char *aCursor) {
+    return * reinterpret_cast<nsCSSValuePairList**>
                              (& reinterpret_cast<CDBPointerStorage*>(aCursor)->value);
 }
 
-inline nsCSSCounterData* CounterDataAtCursor(const char *aCursor) {
-    return static_cast<nsCSSCounterData*>
-                      (reinterpret_cast<const CDBPointerStorage*>(aCursor)->value);
-}
-
-inline nsCSSQuotes*& QuotesAtCursor(char *aCursor) {
-    return * reinterpret_cast<nsCSSQuotes**>
-                             (& reinterpret_cast<CDBPointerStorage*>(aCursor)->value);
-}
-
-inline nsCSSQuotes* QuotesAtCursor(const char *aCursor) {
-    return static_cast<nsCSSQuotes*>
+inline nsCSSValuePairList* ValuePairListAtCursor(const char *aCursor) {
+    return static_cast<nsCSSValuePairList*>
                       (reinterpret_cast<const CDBPointerStorage*>(aCursor)->value);
 }
 
 static PRBool
 ShouldIgnoreColors(nsRuleData *aRuleData)
@@ -308,12 +298,11 @@ nsCSSCompressedDataBlock::MapRuleInfoInt
                                     val.StartImageLoad(
                                       aRuleData->mPresContext->Document());
                             }
                     }
                 // fall through
-                case eCSSType_CounterData:
-                case eCSSType_Quotes: {
+                case eCSSType_ValuePairList: {
                     void** target = static_cast<void**>(prop);
                     if (!*target) {
                         void* val = PointerAtCursor(cursor);
                         NS_ASSERTION(val, "oops");
                         *target = val;
@@ -343,12 +332,11 @@ nsCSSCompressedDataBlock::MapRuleInfoInt
                 case eCSSType_ValuePair: {
                     cursor += CDBValuePairStorage_advance;
                 } break;
 
                 case eCSSType_ValueList:
-                case eCSSType_CounterData:
-                case eCSSType_Quotes: {
+                case eCSSType_ValuePairList: {
                     cursor += CDBPointerStorage_advance;
                 } break;
             }
         }
     }
@@ -384,12 +372,11 @@ nsCSSCompressedDataBlock::StorageFor(nsC
                 }
                 case eCSSType_ValuePair: {
                     return ValuePairAtCursor(cursor);
                 }
                 case eCSSType_ValueList:
-                case eCSSType_CounterData:
-                case eCSSType_Quotes: {
+                case eCSSType_ValuePairList: {
                     return &PointerAtCursor(const_cast<char*>(cursor));
                 }
             }
         }
         switch (nsCSSProps::kTypeTable[iProp]) {
@@ -404,12 +391,11 @@ nsCSSCompressedDataBlock::StorageFor(nsC
             case eCSSType_ValuePair: {
                 cursor += CDBValuePairStorage_advance;
             } break;
 
             case eCSSType_ValueList:
-            case eCSSType_CounterData:
-            case eCSSType_Quotes: {
+            case eCSSType_ValuePairList: {
                 cursor += CDBPointerStorage_advance;
             } break;
         }
     }
     NS_ASSERTION(cursor == cursor_end, "inconsistent data");
@@ -463,28 +449,23 @@ nsCSSCompressedDataBlock::Clone() const
                 cursor += CDBValuePairStorage_advance;
                 result_cursor += CDBValuePairStorage_advance;
             } break;
 
             case eCSSType_ValueList:
-            case eCSSType_CounterData:
-            case eCSSType_Quotes: {
+            case eCSSType_ValuePairList: {
                 void *copy;
                 NS_ASSERTION(PointerAtCursor(cursor), "oops");
                 switch (nsCSSProps::kTypeTable[iProp]) {
                     default:
                         NS_NOTREACHED("unreachable");
                         // fall through to keep gcc's uninitialized
                         // variable warning quiet
                     case eCSSType_ValueList:
                         copy = new nsCSSValueList(*ValueListAtCursor(cursor));
                         break;
-                    case eCSSType_CounterData:
-                        copy =
-                            new nsCSSCounterData(*CounterDataAtCursor(cursor));
-                        break;
-                    case eCSSType_Quotes:
-                        copy = new nsCSSQuotes(*QuotesAtCursor(cursor));
+                    case eCSSType_ValuePairList:
+                        copy = new nsCSSValuePairList(*ValuePairListAtCursor(cursor));
                         break;
                 }
                 if (!copy) {
                     result->mBlockEnd = result_cursor;
                     result->Destroy();
@@ -542,19 +523,12 @@ nsCSSCompressedDataBlock::Destroy()
                 NS_ASSERTION(val, "oops");
                 delete val;
                 cursor += CDBPointerStorage_advance;
             } break;
 
-            case eCSSType_CounterData: {
-                nsCSSCounterData* val = CounterDataAtCursor(cursor);
-                NS_ASSERTION(val, "oops");
-                delete val;
-                cursor += CDBPointerStorage_advance;
-            } break;
-
-            case eCSSType_Quotes: {
-                nsCSSQuotes* val = QuotesAtCursor(cursor);
+            case eCSSType_ValuePairList: {
+                nsCSSValuePairList* val = ValuePairListAtCursor(cursor);
                 NS_ASSERTION(val, "oops");
                 delete val;
                 cursor += CDBPointerStorage_advance;
             } break;
         }
@@ -667,12 +641,11 @@ nsCSSExpandedDataBlock::DoExpand(nsCSSCo
                 memcpy(dest, val, sizeof(nsCSSValuePair));
                 cursor += CDBValuePairStorage_advance;
             } break;
 
             case eCSSType_ValueList:
-            case eCSSType_CounterData:
-            case eCSSType_Quotes: {
+            case eCSSType_ValuePairList: {
                 void* val = PointerAtCursor(cursor);
                 void** dest = static_cast<void**>(prop);
                 NS_ASSERTION(val, "oops");
                 NS_ASSERTION(!*dest, "expanding into non-empty block");
                 *dest = val;
@@ -744,12 +717,11 @@ nsCSSExpandedDataBlock::ComputeSize()
 #endif
                     increment = CDBValuePairStorage_advance;
                 } break;
 
                 case eCSSType_ValueList:
-                case eCSSType_CounterData:
-                case eCSSType_Quotes: {
+                case eCSSType_ValuePairList: {
 #ifdef DEBUG
                     void* val = *static_cast<void**>(prop);
                     NS_ASSERTION(val, "Null pointer while computing size");
 #endif
                     increment = CDBPointerStorage_advance;
@@ -852,12 +824,11 @@ nsCSSExpandedDataBlock::Compress(nsCSSCo
                     new (val) nsCSSValuePair();
                     cursor += CDBValuePairStorage_advance;
                 } break;
 
                 case eCSSType_ValueList:
-                case eCSSType_CounterData:
-                case eCSSType_Quotes: {
+                case eCSSType_ValuePairList: {
                     void*& val = *static_cast<void**>(prop);
                     NS_ASSERTION(val, "Null pointer while compressing");
                     CDBPointerStorage *storage =
                         reinterpret_cast<CDBPointerStorage*>(cursor);
                     storage->property = iProp;
@@ -937,21 +908,13 @@ nsCSSExpandedDataBlock::ClearProperty(ns
                 delete val;
                 val = nsnull;
             }
         } break;
 
-        case eCSSType_CounterData: {
-            nsCSSCounterData*& val =
-                *static_cast<nsCSSCounterData**>(prop);
-            if (val) {
-                delete val;
-                val = nsnull;
-            }
-        } break;
-
-        case eCSSType_Quotes: {
-            nsCSSQuotes*& val = *static_cast<nsCSSQuotes**>(prop);
+        case eCSSType_ValuePairList: {
+            nsCSSValuePairList*& val =
+              *static_cast<nsCSSValuePairList**>(prop);
             if (val) {
                 delete val;
                 val = nsnull;
             }
         } break;
@@ -1002,18 +965,13 @@ nsCSSExpandedDataBlock::DoAssertInitialS
             case eCSSType_ValueList: {
                 nsCSSValueList* val = *static_cast<nsCSSValueList**>(prop);
                 NS_ASSERTION(val == nsnull, "not initial state");
             } break;
 
-            case eCSSType_CounterData: {
-                nsCSSCounterData* val =
-                    *static_cast<nsCSSCounterData**>(prop);
-                NS_ASSERTION(val == nsnull, "not initial state");
-            } break;
-
-            case eCSSType_Quotes: {
-                nsCSSQuotes* val = *static_cast<nsCSSQuotes**>(prop);
+            case eCSSType_ValuePairList: {
+                nsCSSValuePairList* val =
+                  *static_cast<nsCSSValuePairList**>(prop);
                 NS_ASSERTION(val == nsnull, "not initial state");
             } break;
         }
     }
 }
diff --git a/layout/style/nsCSSDeclaration.cpp b/layout/style/nsCSSDeclaration.cpp
--- a/layout/style/nsCSSDeclaration.cpp
+++ b/layout/style/nsCSSDeclaration.cpp
@@ -253,49 +253,26 @@ PRBool nsCSSDeclaration::AppendValueToSt
               aResult.Append(PRUnichar(','));
             aResult.Append(PRUnichar(' '));
           }
         } while (val);
       } break;
-      case eCSSType_CounterData: {
-        const nsCSSCounterData* counter =
-            *static_cast<nsCSSCounterData*const*>(storage);
+      case eCSSType_ValuePairList: {
+        const nsCSSValuePairList* item =
+            *static_cast<nsCSSValuePairList*const*>(storage);
         do {
-          if (AppendCSSValueToString(aProperty, counter->mCounter, aResult)) {
-            if (counter->mValue.GetUnit() != eCSSUnit_Null) {
-              aResult.Append(PRUnichar(' '));
-              AppendCSSValueToString(aProperty, counter->mValue, aResult);
-            }
+          NS_ASSERTION(item->mXValue.GetUnit() != eCSSUnit_Null,
+                       "unexpected null unit");
+          AppendCSSValueToString(aProperty, item->mXValue, aResult);
+          if (item->mYValue.GetUnit() != eCSSUnit_Null) {
+            aResult.Append(PRUnichar(' '));
+            AppendCSSValueToString(aProperty, item->mYValue, aResult);
           }
-          counter = counter->mNext;
-          if (counter) {
+          item = item->mNext;
+          if (item) {
             aResult.Append(PRUnichar(' '));
           }
-        } while (counter);
-      } break;
-      case eCSSType_Quotes: {
-        const nsCSSQuotes* quotes = 
-            *static_cast<nsCSSQuotes*const*>(storage);
-        NS_ASSERTION((quotes->mOpen.GetUnit() == eCSSUnit_String) ||
-                     (quotes->mNext == nsnull),
-                     "non-strings must be alone");
-        do {
-          AppendCSSValueToString(aProperty, quotes->mOpen, aResult);
-          NS_ASSERTION((quotes->mOpen.GetUnit() == eCSSUnit_String) ==
-                       (quotes->mClose.GetUnit() == eCSSUnit_String),
-                       "strings must come in pairs");
-          NS_ASSERTION((quotes->mOpen.GetUnit() != eCSSUnit_String) ==
-                       (quotes->mClose.GetUnit() == eCSSUnit_Null),
-                       "non-strings must be alone");
-          if (quotes->mClose.GetUnit() != eCSSUnit_Null) {
-            aResult.Append(PRUnichar(' '));
-            AppendCSSValueToString(aProperty, quotes->mClose, aResult);
-          }
-          quotes = quotes->mNext;
-          if (quotes) {
-            aResult.Append(PRUnichar(' '));
-          }
-        } while (quotes);
+        } while (item);
       } break;
     }
   }
   return storage != nsnull;
 }
diff --git a/layout/style/nsCSSParser.cpp b/layout/style/nsCSSParser.cpp
--- a/layout/style/nsCSSParser.cpp
+++ b/layout/style/nsCSSParser.cpp
@@ -408,11 +408,11 @@ protected:
   PRBool ParseRect(nsCSSRect& aRect, nsresult& aErrorCode,
                    nsCSSProperty aPropID);
   PRBool DoParseRect(nsCSSRect& aRect, nsresult& aErrorCode);
   PRBool ParseContent(nsresult& aErrorCode);
   PRBool ParseCounterData(nsresult& aErrorCode,
-                          nsCSSCounterData** aResult,
+                          nsCSSValuePairList** aResult,
                           nsCSSProperty aPropID);
   PRBool ParseCue(nsresult& aErrorCode);
   PRBool ParseCursor(nsresult& aErrorCode);
   PRBool ParseFont(nsresult& aErrorCode);
   PRBool ParseFontWeight(nsresult& aErrorCode, nsCSSValue& aValue);
@@ -3926,24 +3926,16 @@ CSSParserImpl::DoTransferTempData(nsCSSD
       delete *dest;
       *dest = *source;
       *source = nsnull;
     } break;
 
-    case eCSSType_CounterData: {
-      nsCSSCounterData **source = static_cast<nsCSSCounterData**>(v_source);
-      nsCSSCounterData **dest = static_cast<nsCSSCounterData**>(v_dest);
-      if (!nsCSSCounterData::Equal(*source, *dest))
-        *aChanged = PR_TRUE;
-      delete *dest;
-      *dest = *source;
-      *source = nsnull;
-    } break;
-
-    case eCSSType_Quotes: {
-      nsCSSQuotes **source = static_cast<nsCSSQuotes**>(v_source);
-      nsCSSQuotes **dest = static_cast<nsCSSQuotes**>(v_dest);
-      if (!nsCSSQuotes::Equal(*source, *dest))
+    case eCSSType_ValuePairList: {
+      nsCSSValuePairList **source =
+        static_cast<nsCSSValuePairList**>(v_source);
+      nsCSSValuePairList **dest =
+        static_cast<nsCSSValuePairList**>(v_dest);
+      if (!nsCSSValuePairList::Equal(*source, *dest))
         *aChanged = PR_TRUE;
       delete *dest;
       *dest = *source;
       *source = nsnull;
     } break;
@@ -6171,11 +6163,11 @@ struct SingleCounterPropValue {
   char str[13];
   nsCSSUnit unit;
 };
 
 PRBool CSSParserImpl::ParseCounterData(nsresult& aErrorCode,
-                                       nsCSSCounterData** aResult,
+                                       nsCSSValuePairList** aResult,
                                        nsCSSProperty aPropID)
 {
   nsSubstring* ident = NextIdent(aErrorCode);
   if (nsnull == ident) {
     return PR_FALSE;
@@ -6188,41 +6180,41 @@ PRBool CSSParserImpl::ParseCounterData(n
   for (const SingleCounterPropValue *sv = singleValues,
            *sv_end = singleValues + NS_ARRAY_LENGTH(singleValues);
        sv != sv_end; ++sv) {
     if (ident->LowerCaseEqualsASCII(sv->str)) {
       if (ExpectEndProperty(aErrorCode)) {
-        nsCSSCounterData* dataHead = new nsCSSCounterData();
+        nsCSSValuePairList* dataHead = new nsCSSValuePairList();
         if (!dataHead) {
           aErrorCode = NS_ERROR_OUT_OF_MEMORY;
           return PR_FALSE;
         }
-        dataHead->mCounter = nsCSSValue(sv->unit);
+        dataHead->mXValue = nsCSSValue(sv->unit);
         *aResult = dataHead;
         mTempData.SetPropertyBit(aPropID);
         return PR_TRUE;
       }
       return PR_FALSE;
     }
   }
   UngetToken(); // undo NextIdent
 
-  nsCSSCounterData* dataHead = nsnull;
-  nsCSSCounterData **next = &dataHead;
+  nsCSSValuePairList* dataHead = nsnull;
+  nsCSSValuePairList **next = &dataHead;
   for (;;) {
     if (!GetToken(aErrorCode, PR_TRUE) || mToken.mType != eCSSToken_Ident) {
       break;
     }
-    nsCSSCounterData *data = *next = new nsCSSCounterData();
+    nsCSSValuePairList *data = *next = new nsCSSValuePairList();
     if (!data) {
       aErrorCode = NS_ERROR_OUT_OF_MEMORY;
       break;
     }
     next = &data->mNext;
-    data->mCounter.SetStringValue(mToken.mIdent, eCSSUnit_String);
+    data->mXValue.SetStringValue(mToken.mIdent, eCSSUnit_String);
     if (GetToken(aErrorCode, PR_TRUE)) {
       if (eCSSToken_Number == mToken.mType && mToken.mIntegerValid) {
-        data->mValue.SetIntValue(mToken.mInteger, eCSSUnit_Integer);
+        data->mYValue.SetIntValue(mToken.mInteger, eCSSUnit_Integer);
       } else {
         UngetToken();
       }
     }
     if (ExpectEndProperty(aErrorCode)) {
@@ -6697,32 +6689,33 @@ PRBool CSSParserImpl::ParseQuotes(nsresu
 PRBool CSSParserImpl::ParseQuotes(nsresult& aErrorCode)
 {
   nsCSSValue  open;
   if (ParseVariant(aErrorCode, open, VARIANT_HOS, nsnull)) {
     if (eCSSUnit_String == open.GetUnit()) {
-      nsCSSQuotes* quotesHead = new nsCSSQuotes();
-      nsCSSQuotes* quotes = quotesHead;
+      nsCSSValuePairList* quotesHead = new nsCSSValuePairList();
+      nsCSSValuePairList* quotes = quotesHead;
       if (nsnull == quotes) {
         aErrorCode = NS_ERROR_OUT_OF_MEMORY;
         return PR_FALSE;
       }
-      quotes->mOpen = open;
+      quotes->mXValue = open;
       while (nsnull != quotes) {
         // get mandatory close
-        if (ParseVariant(aErrorCode, quotes->mClose, VARIANT_STRING, nsnull)) {
+        if (ParseVariant(aErrorCode, quotes->mYValue, VARIANT_STRING,
+                         nsnull)) {
           if (ExpectEndProperty(aErrorCode)) {
             mTempData.SetPropertyBit(eCSSProperty_quotes);
             mTempData.mContent.mQuotes = quotesHead;
             aErrorCode = NS_OK;
             return PR_TRUE;
           }
           // look for another open
           if (ParseVariant(aErrorCode, open, VARIANT_STRING, nsnull)) {
-            quotes->mNext = new nsCSSQuotes();
+            quotes->mNext = new nsCSSValuePairList();
             quotes = quotes->mNext;
             if (nsnull != quotes) {
-              quotes->mOpen = open;
+              quotes->mXValue = open;
               continue;
             }
             aErrorCode = NS_ERROR_OUT_OF_MEMORY;
           }
         }
@@ -6730,12 +6723,12 @@ PRBool CSSParserImpl::ParseQuotes(nsresu
       }
       delete quotesHead;
       return PR_FALSE;
     }
     if (ExpectEndProperty(aErrorCode)) {
-      nsCSSQuotes* quotesHead = new nsCSSQuotes();
-      quotesHead->mOpen = open;
+      nsCSSValuePairList* quotesHead = new nsCSSValuePairList();
+      quotesHead->mXValue = open;
       mTempData.mContent.mQuotes = quotesHead;
       mTempData.SetPropertyBit(eCSSProperty_quotes);
       return PR_TRUE;
     }
   }
diff --git a/layout/style/nsCSSPropList.h b/layout/style/nsCSSPropList.h
--- a/layout/style/nsCSSPropList.h
+++ b/layout/style/nsCSSPropList.h
@@ -379,12 +379,12 @@ CSS_PROP_SHORTHAND(-moz-column-rule, _mo
 CSS_PROP_SHORTHAND(-moz-column-rule, _moz_column_rule, MozColumnRule)
 CSS_PROP_COLUMN(-moz-column-rule-color, _moz_column_rule_color, MozColumnRuleColor, Column, mColumnRuleColor, eCSSType_Value, nsnull)
 CSS_PROP_COLUMN(-moz-column-rule-style, _moz_column_rule_style, MozColumnRuleStyle, Column, mColumnRuleStyle, eCSSType_Value, kBorderStyleKTable)
 CSS_PROP_COLUMN(-moz-column-rule-width, _moz_column_rule_width, MozColumnRuleWidth, Column, mColumnRuleWidth, eCSSType_Value, kBorderWidthKTable)
 CSS_PROP_CONTENT(content, content, Content, Content, mContent, eCSSType_ValueList, kContentKTable)
-CSS_PROP_CONTENT(counter-increment, counter_increment, CounterIncrement, Content, mCounterIncrement, eCSSType_CounterData, nsnull) // XXX bug 137285
-CSS_PROP_CONTENT(counter-reset, counter_reset, CounterReset, Content, mCounterReset, eCSSType_CounterData, nsnull) // XXX bug 137285
+CSS_PROP_CONTENT(counter-increment, counter_increment, CounterIncrement, Content, mCounterIncrement, eCSSType_ValuePairList, nsnull) // XXX bug 137285
+CSS_PROP_CONTENT(counter-reset, counter_reset, CounterReset, Content, mCounterReset, eCSSType_ValuePairList, nsnull) // XXX bug 137285
 CSS_PROP_SHORTHAND(cue, cue, Cue)
 CSS_PROP_BACKENDONLY(cue-after, cue_after, CueAfter, Aural, mCueAfter, eCSSType_Value, nsnull)
 CSS_PROP_BACKENDONLY(cue-before, cue_before, CueBefore, Aural, mCueBefore, eCSSType_Value, nsnull)
 CSS_PROP_USERINTERFACE(cursor, cursor, Cursor, UserInterface, mCursor, eCSSType_ValueList, kCursorKTable)
 CSS_PROP_VISIBILITY(direction, direction, Direction, Display, mDirection, eCSSType_Value, kDirectionKTable)
@@ -482,11 +482,11 @@ CSS_PROP_BACKENDONLY(pause-after, pause_
 CSS_PROP_BACKENDONLY(pause-after, pause_after, PauseAfter, Aural, mPauseAfter, eCSSType_Value, nsnull)
 CSS_PROP_BACKENDONLY(pause-before, pause_before, PauseBefore, Aural, mPauseBefore, eCSSType_Value, nsnull)
 CSS_PROP_BACKENDONLY(pitch, pitch, Pitch, Aural, mPitch, eCSSType_Value, kPitchKTable)
 CSS_PROP_BACKENDONLY(pitch-range, pitch_range, PitchRange, Aural, mPitchRange, eCSSType_Value, nsnull)
 CSS_PROP_DISPLAY(position, position, Position, Display, mPosition, eCSSType_Value, kPositionKTable)
-CSS_PROP_QUOTES(quotes, quotes, Quotes, Content, mQuotes, eCSSType_Quotes, nsnull)
+CSS_PROP_QUOTES(quotes, quotes, Quotes, Content, mQuotes, eCSSType_ValuePairList, nsnull)
 CSS_PROP_BACKENDONLY(richness, richness, Richness, Aural, mRichness, eCSSType_Value, nsnull)
 CSS_PROP_POSITION(right, right, Right, Position, mOffset.mRight, eCSSType_Value, nsnull)
 CSS_PROP_BACKENDONLY(size, size, Size, Page, mSize, eCSSType_ValuePair, kPageSizeKTable)
 CSS_PROP_BACKENDONLY(speak, speak, Speak, Aural, mSpeak, eCSSType_Value, kSpeakKTable)
 CSS_PROP_BACKENDONLY(speak-header, speak_header, SpeakHeader, Aural, mSpeakHeader, eCSSType_Value, kSpeakHeaderKTable)
diff --git a/layout/style/nsCSSProperty.h b/layout/style/nsCSSProperty.h
--- a/layout/style/nsCSSProperty.h
+++ b/layout/style/nsCSSProperty.h
@@ -70,10 +70,9 @@ enum nsCSSType {
 enum nsCSSType {
   eCSSType_Value,
   eCSSType_Rect,
   eCSSType_ValuePair,
   eCSSType_ValueList,
-  eCSSType_CounterData,
-  eCSSType_Quotes
+  eCSSType_ValuePairList
 };
 
 #endif /* nsCSSProperty_h___ */
diff --git a/layout/style/nsCSSRuleProcessor.cpp b/layout/style/nsCSSRuleProcessor.cpp
--- a/layout/style/nsCSSRuleProcessor.cpp
+++ b/layout/style/nsCSSRuleProcessor.cpp
@@ -793,11 +793,11 @@ InitSystemMetrics()
 
   return PR_TRUE;
 }
 
 /* static */ void
-nsCSSRuleProcessor::Shutdown()
+nsCSSRuleProcessor::FreeSystemMetrics()
 {
   delete sSystemMetrics;
   sSystemMetrics = nsnull;
 }
 
@@ -2089,11 +2089,19 @@ NS_IMETHODIMP
 NS_IMETHODIMP
 nsCSSRuleProcessor::MediumFeaturesChanged(nsPresContext* aPresContext,
                                           PRBool* aRulesChanged)
 {
   RuleCascadeData *old = mRuleCascades;
-  RefreshRuleCascade(aPresContext);
+  // We don't want to do anything if there aren't any sets of rules
+  // cached yet (or somebody cleared them and is thus responsible for
+  // rebuilding things), since we should not build the rule cascade too
+  // early (e.g., before we know whether the quirk style sheet should be
+  // enabled).  And if there's nothing cached, it doesn't matter if
+  // anything changed.  See bug 448281.
+  if (old) {
+    RefreshRuleCascade(aPresContext);
+  }
   *aRulesChanged = (old != mRuleCascades);
   return NS_OK;
 }
 
 nsresult
diff --git a/layout/style/nsCSSRuleProcessor.h b/layout/style/nsCSSRuleProcessor.h
--- a/layout/style/nsCSSRuleProcessor.h
+++ b/layout/style/nsCSSRuleProcessor.h
@@ -70,11 +70,11 @@ public:
   NS_DECL_ISUPPORTS
 
 public:
   nsresult ClearRuleCascades();
 
-  static void Shutdown();
+  static void FreeSystemMetrics();
 
   /*
    * Returns true if the given RuleProcessorData matches one of the
    * selectors in aSelectorList.  Note that this method will assume
    * the matching is not for styling purposes.
@@ -94,10 +94,16 @@ public:
                                         nsReStyleHint* aResult);
 
   NS_IMETHOD MediumFeaturesChanged(nsPresContext* aPresContext,
                                    PRBool* aRulesChanged);
 
+#ifdef DEBUG
+  void AssertQuirksChangeOK() {
+    NS_ASSERTION(!mRuleCascades, "too late to set quirks style sheet");
+  }
+#endif
+
 protected:
   RuleCascadeData* GetRuleCascade(nsPresContext* aPresContext);
   void RefreshRuleCascade(nsPresContext* aPresContext);
 
   // The sheet order here is the same as in nsStyleSet::mSheets
diff --git a/layout/style/nsCSSScanner.cpp b/layout/style/nsCSSScanner.cpp
--- a/layout/style/nsCSSScanner.cpp
+++ b/layout/style/nsCSSScanner.cpp
@@ -323,17 +323,10 @@ void nsCSSScanner::ClearError()
 
 void nsCSSScanner::OutputError()
 {
   if (mError.IsEmpty()) return;
  
-#ifdef DEBUG
-  if (gReportErrors)
-    fprintf(stderr, "CSS Error (%s :%u.%u): %s\n",
-                    mFileName.get(), mErrorLineNumber, mErrorColNumber,
-                    NS_ConvertUTF16toUTF8(mError).get());
-#endif
-
   // Log it to the Error console
 
   if (InitGlobals() && gReportErrors) {
     nsresult rv;
     nsCOMPtr<nsIScriptError> errorObject =
diff --git a/layout/style/nsCSSStruct.cpp b/layout/style/nsCSSStruct.cpp
--- a/layout/style/nsCSSStruct.cpp
+++ b/layout/style/nsCSSStruct.cpp
@@ -297,77 +297,42 @@ nsCSSPage::~nsCSSPage(void)
   MOZ_COUNT_DTOR(nsCSSPage);
 }
 
 // --- nsCSSContent support -----------------
 
-nsCSSCounterData::nsCSSCounterData(void)
+nsCSSValuePairList::nsCSSValuePairList()
   : mNext(nsnull)
 {
-  MOZ_COUNT_CTOR(nsCSSCounterData);
+  MOZ_COUNT_CTOR(nsCSSValuePairList);
 }
 
-nsCSSCounterData::nsCSSCounterData(const nsCSSCounterData& aCopy)
-  : mCounter(aCopy.mCounter),
-    mValue(aCopy.mValue),
+nsCSSValuePairList::nsCSSValuePairList(const nsCSSValuePairList& aCopy)
+  : mXValue(aCopy.mXValue),
+    mYValue(aCopy.mYValue),
     mNext(nsnull)
 {
-  MOZ_COUNT_CTOR(nsCSSCounterData);
-  CSS_IF_COPY(mNext, nsCSSCounterData);
+  MOZ_COUNT_CTOR(nsCSSValuePairList);
+  CSS_IF_COPY(mNext, nsCSSValuePairList);
 }
 
-nsCSSCounterData::~nsCSSCounterData(void)
+nsCSSValuePairList::~nsCSSValuePairList()
 {
-  MOZ_COUNT_DTOR(nsCSSCounterData);
+  MOZ_COUNT_DTOR(nsCSSValuePairList);
   CSS_IF_DELETE(mNext);
 }
 
 /* static */ PRBool
-nsCSSCounterData::Equal(nsCSSCounterData* aList1, nsCSSCounterData* aList2)
+nsCSSValuePairList::Equal(nsCSSValuePairList* aList1,
+                          nsCSSValuePairList* aList2)
 {
   if (aList1 == aList2)
     return PR_TRUE;
 
-  nsCSSCounterData *p1 = aList1, *p2 = aList2;
+  nsCSSValuePairList *p1 = aList1, *p2 = aList2;
   for ( ; p1 && p2; p1 = p1->mNext, p2 = p2->mNext) {
-    if (p1->mCounter != p2->mCounter ||
-        p1->mValue != p2->mValue)
-      return PR_FALSE;
-  }
-  return !p1 && !p2; // true if same length, false otherwise
-}
-
-nsCSSQuotes::nsCSSQuotes(void)
-  : mNext(nsnull)
-{
-  MOZ_COUNT_CTOR(nsCSSQuotes);
-}
-
-nsCSSQuotes::nsCSSQuotes(const nsCSSQuotes& aCopy)
-  : mOpen(aCopy.mOpen),
-    mClose(aCopy.mClose),
-    mNext(nsnull)
-{
-  MOZ_COUNT_CTOR(nsCSSQuotes);
-  CSS_IF_COPY(mNext, nsCSSQuotes);
-}
-
-nsCSSQuotes::~nsCSSQuotes(void)
-{
-  MOZ_COUNT_DTOR(nsCSSQuotes);
-  CSS_IF_DELETE(mNext);
-}
-
-/* static */ PRBool
-nsCSSQuotes::Equal(nsCSSQuotes* aList1, nsCSSQuotes* aList2)
-{
-  if (aList1 == aList2)
-    return PR_TRUE;
-
-  nsCSSQuotes *p1 = aList1, *p2 = aList2;
-  for ( ; p1 && p2; p1 = p1->mNext, p2 = p2->mNext) {
-    if (p1->mOpen != p2->mOpen ||
-        p1->mClose != p2->mClose)
+    if (p1->mXValue != p2->mXValue ||
+        p1->mYValue != p2->mYValue)
       return PR_FALSE;
   }
   return !p1 && !p2; // true if same length, false otherwise
 }
 
diff --git a/layout/style/nsCSSStruct.h b/layout/style/nsCSSStruct.h
--- a/layout/style/nsCSSStruct.h
+++ b/layout/style/nsCSSStruct.h
@@ -152,34 +152,21 @@ struct nsCSSValueListRect {
 
   typedef nsCSSValueList* nsCSSValueListRect::*side_type;
   static const side_type sides[4];
 };
 
-// Should be replaced with nsCSSValueList and nsCSSValue::Array.
-struct nsCSSCounterData {
-  nsCSSCounterData(void);
-  nsCSSCounterData(const nsCSSCounterData& aCopy);
-  ~nsCSSCounterData(void);
+// Maybe should be replaced with nsCSSValueList and nsCSSValue::Array?
+struct nsCSSValuePairList {
+  nsCSSValuePairList(void);
+  nsCSSValuePairList(const nsCSSValuePairList& aCopy);
+  ~nsCSSValuePairList(void);
 
-  static PRBool Equal(nsCSSCounterData* aList1, nsCSSCounterData* aList2);
+  static PRBool Equal(nsCSSValuePairList* aList1, nsCSSValuePairList* aList2);
 
-  nsCSSValue        mCounter;
-  nsCSSValue        mValue;
-  nsCSSCounterData* mNext;
-};
-
-// Should be replaced with nsCSSValueList and nsCSSValue::Array.
-struct nsCSSQuotes {
-  nsCSSQuotes(void);
-  nsCSSQuotes(const nsCSSQuotes& aCopy);
-  ~nsCSSQuotes(void);
-
-  static PRBool Equal(nsCSSQuotes* aList1, nsCSSQuotes* aList2);
-
-  nsCSSValue    mOpen;
-  nsCSSValue    mClose;
-  nsCSSQuotes*  mNext;
+  nsCSSValue          mXValue;
+  nsCSSValue          mYValue;
+  nsCSSValuePairList* mNext;
 };
 
 /****************************************************************************/
 
 struct nsCSSStruct {
@@ -471,15 +458,15 @@ private:
 
 struct nsCSSContent : public nsCSSStruct  {
   nsCSSContent(void);
   ~nsCSSContent(void);
 
-  nsCSSValueList*   mContent;
-  nsCSSCounterData* mCounterIncrement;
-  nsCSSCounterData* mCounterReset;
-  nsCSSValue        mMarkerOffset;
-  nsCSSQuotes*      mQuotes;
+  nsCSSValueList*     mContent;
+  nsCSSValuePairList* mCounterIncrement;
+  nsCSSValuePairList* mCounterReset;
+  nsCSSValue          mMarkerOffset;
+  nsCSSValuePairList* mQuotes;
 private:
   nsCSSContent(const nsCSSContent& aOther); // NOT IMPLEMENTED
 };
 
 struct nsRuleDataContent : public nsCSSContent {
diff --git a/layout/style/nsHTMLCSSStyleSheet.cpp b/layout/style/nsHTMLCSSStyleSheet.cpp
--- a/layout/style/nsHTMLCSSStyleSheet.cpp
+++ b/layout/style/nsHTMLCSSStyleSheet.cpp
@@ -79,21 +79,21 @@ public:
 #ifdef DEBUG
   NS_IMETHOD List(FILE* out = stdout, PRInt32 aIndent = 0) const;
 #endif
 protected:
   nsCSSValueList mInheritList;
-  nsCSSQuotes mInheritQuotes;
-  nsCSSCounterData mNoneCounter;
+  nsCSSValuePairList mInheritQuotes;
+  nsCSSValuePairList mNoneCounter;
 };
 
 CSSDisablePropsRule::CSSDisablePropsRule()
 {
   nsCSSValue none(eCSSUnit_None);
-  mNoneCounter.mCounter = none;
+  mNoneCounter.mXValue = none;
   nsCSSValue inherit(eCSSUnit_Inherit);
   mInheritList.mValue = inherit;
-  mInheritQuotes.mOpen = inherit;
+  mInheritQuotes.mXValue = inherit;
 }
 
 class CSSFirstLineRule : public CSSDisablePropsRule {
 public:
   CSSFirstLineRule() {}
diff --git a/layout/style/nsRuleNode.cpp b/layout/style/nsRuleNode.cpp
--- a/layout/style/nsRuleNode.cpp
+++ b/layout/style/nsRuleNode.cpp
@@ -964,21 +964,14 @@ ValueListArrayAtOffset(const nsRuleDataS
 {
   return * reinterpret_cast<const nsCSSValueList**const*>
                            (reinterpret_cast<const char*>(&aRuleDataStruct) + aOffset);
 }
 
-inline const nsCSSCounterData*
-CounterDataAtOffset(const nsRuleDataStruct& aRuleDataStruct, size_t aOffset)
-{
-  return * reinterpret_cast<const nsCSSCounterData*const*>
-                           (reinterpret_cast<const char*>(&aRuleDataStruct) + aOffset);
-}
-
-inline const nsCSSQuotes*
-QuotesAtOffset(const nsRuleDataStruct& aRuleDataStruct, size_t aOffset)
-{
-  return * reinterpret_cast<const nsCSSQuotes*const*>
+inline const nsCSSValuePairList*
+ValuePairListAtOffset(const nsRuleDataStruct& aRuleDataStruct, size_t aOffset)
+{
+  return * reinterpret_cast<const nsCSSValuePairList*const*>
                            (reinterpret_cast<const char*>(&aRuleDataStruct) + aOffset);
 }
 
 #if defined(MOZ_MATHML) && defined(DEBUG)
 static PRBool
@@ -1038,32 +1031,18 @@ nsRuleNode::CheckSpecifiedProperties(con
             }
           }
         }
         break;
 
-      case eCSSType_CounterData:
+      case eCSSType_ValuePairList:
         {
           ++total;
-          const nsCSSCounterData* counterData =
-              CounterDataAtOffset(aRuleDataStruct, prop->offset);
-          if (counterData) {
-            ++specified;
-            if (eCSSUnit_Inherit == counterData->mCounter.GetUnit()) {
-              ++inherited;
-            }
-          }
-        }
-        break;
-
-      case eCSSType_Quotes:
-        {
-          ++total;
-          const nsCSSQuotes* quotes =
-              QuotesAtOffset(aRuleDataStruct, prop->offset);
+          const nsCSSValuePairList* quotes =
+              ValuePairListAtOffset(aRuleDataStruct, prop->offset);
           if (quotes) {
             ++specified;
-            if (eCSSUnit_Inherit == quotes->mOpen.GetUnit()) {
+            if (eCSSUnit_Inherit == quotes->mXValue.GetUnit()) {
               ++inherited;
             }
           }
         }
         break;
@@ -4486,88 +4465,88 @@ nsRuleNode::ComputeContentData(void* aSt
       } 
     }
   }
 
   // counter-increment: [string [int]]+, none, inherit
-  nsCSSCounterData* ourIncrement = contentData.mCounterIncrement;
+  nsCSSValuePairList* ourIncrement = contentData.mCounterIncrement;
   if (ourIncrement) {
-    if (eCSSUnit_None == ourIncrement->mCounter.GetUnit() ||
-        eCSSUnit_Initial == ourIncrement->mCounter.GetUnit()) {
+    if (eCSSUnit_None == ourIncrement->mXValue.GetUnit() ||
+        eCSSUnit_Initial == ourIncrement->mXValue.GetUnit()) {
       content->AllocateCounterIncrements(0);
     }
-    else if (eCSSUnit_Inherit == ourIncrement->mCounter.GetUnit()) {
+    else if (eCSSUnit_Inherit == ourIncrement->mXValue.GetUnit()) {
       inherited = PR_TRUE;
       count = parentContent->CounterIncrementCount();
       if (NS_SUCCEEDED(content->AllocateCounterIncrements(count))) {
         while (0 < count--) {
           const nsStyleCounterData *data =
             parentContent->GetCounterIncrementAt(count);
           content->SetCounterIncrementAt(count, data->mCounter, data->mValue);
         }
       }
     }
-    else if (eCSSUnit_String == ourIncrement->mCounter.GetUnit()) {
+    else if (eCSSUnit_String == ourIncrement->mXValue.GetUnit()) {
       count = 0;
       while (ourIncrement) {
         count++;
         ourIncrement = ourIncrement->mNext;
       }
       if (NS_SUCCEEDED(content->AllocateCounterIncrements(count))) {
         count = 0;
         ourIncrement = contentData.mCounterIncrement;
         while (ourIncrement) {
           PRInt32 increment;
-          if (eCSSUnit_Integer == ourIncrement->mValue.GetUnit()) {
-            increment = ourIncrement->mValue.GetIntValue();
+          if (eCSSUnit_Integer == ourIncrement->mYValue.GetUnit()) {
+            increment = ourIncrement->mYValue.GetIntValue();
           }
           else {
             increment = 1;
           }
-          ourIncrement->mCounter.GetStringValue(buffer);
+          ourIncrement->mXValue.GetStringValue(buffer);
           content->SetCounterIncrementAt(count++, buffer, increment);
           ourIncrement = ourIncrement->mNext;
         }
       }
     }
   }
 
   // counter-reset: [string [int]]+, none, inherit
-  nsCSSCounterData* ourReset = contentData.mCounterReset;
+  nsCSSValuePairList* ourReset = contentData.mCounterReset;
   if (ourReset) {
-    if (eCSSUnit_None == ourReset->mCounter.GetUnit() ||
-        eCSSUnit_Initial == ourReset->mCounter.GetUnit()) {
+    if (eCSSUnit_None == ourReset->mXValue.GetUnit() ||
+        eCSSUnit_Initial == ourReset->mXValue.GetUnit()) {
       content->AllocateCounterResets(0);
     }
-    else if (eCSSUnit_Inherit == ourReset->mCounter.GetUnit()) {
+    else if (eCSSUnit_Inherit == ourReset->mXValue.GetUnit()) {
       inherited = PR_TRUE;
       count = parentContent->CounterResetCount();
       if (NS_SUCCEEDED(content->AllocateCounterResets(count))) {
         while (0 < count--) {
           const nsStyleCounterData *data =
             parentContent->GetCounterResetAt(count);
           content->SetCounterResetAt(count, data->mCounter, data->mValue);
         }
       }
     }
-    else if (eCSSUnit_String == ourReset->mCounter.GetUnit()) {
+    else if (eCSSUnit_String == ourReset->mXValue.GetUnit()) {
       count = 0;
       while (ourReset) {
         count++;
         ourReset = ourReset->mNext;
       }
       if (NS_SUCCEEDED(content->AllocateCounterResets(count))) {
         count = 0;
         ourReset = contentData.mCounterReset;
         while (ourReset) {
           PRInt32 reset;
-          if (eCSSUnit_Integer == ourReset->mValue.GetUnit()) {
-            reset = ourReset->mValue.GetIntValue();
+          if (eCSSUnit_Integer == ourReset->mYValue.GetUnit()) {
+            reset = ourReset->mYValue.GetIntValue();
           }
           else {
             reset = 0;
           }
-          ourReset->mCounter.GetStringValue(buffer);
+          ourReset->mXValue.GetStringValue(buffer);
           content->SetCounterResetAt(count++, buffer, reset);
           ourReset = ourReset->mNext;
         }
       }
     }
@@ -4592,40 +4571,40 @@ nsRuleNode::ComputeQuotesData(void* aSta
                           Content, contentData)
 
   // quotes: [string string]+, none, inherit
   PRUint32 count;
   nsAutoString  buffer;
-  nsCSSQuotes* ourQuotes = contentData.mQuotes;
+  nsCSSValuePairList* ourQuotes = contentData.mQuotes;
   if (ourQuotes) {
     nsAutoString  closeBuffer;
     // FIXME Bug 389406: Implement eCSSUnit_Initial (correctly, unlike
     // style structs), and remove the "initial" value from ua.css.
-    if (eCSSUnit_Inherit == ourQuotes->mOpen.GetUnit()) {
+    if (eCSSUnit_Inherit == ourQuotes->mXValue.GetUnit()) {
       inherited = PR_TRUE;
       count = parentQuotes->QuotesCount();
       if (NS_SUCCEEDED(quotes->AllocateQuotes(count))) {
         while (0 < count--) {
           parentQuotes->GetQuotesAt(count, buffer, closeBuffer);
           quotes->SetQuotesAt(count, buffer, closeBuffer);
         }
       }
     }
-    else if (eCSSUnit_None == ourQuotes->mOpen.GetUnit()) {
+    else if (eCSSUnit_None == ourQuotes->mXValue.GetUnit()) {
       quotes->AllocateQuotes(0);
     }
-    else if (eCSSUnit_String == ourQuotes->mOpen.GetUnit()) {
+    else if (eCSSUnit_String == ourQuotes->mXValue.GetUnit()) {
       count = 0;
       while (ourQuotes) {
         count++;
         ourQuotes = ourQuotes->mNext;
       }
       if (NS_SUCCEEDED(quotes->AllocateQuotes(count))) {
         count = 0;
         ourQuotes = contentData.mQuotes;
         while (ourQuotes) {
-          ourQuotes->mOpen.GetStringValue(buffer);
-          ourQuotes->mClose.GetStringValue(closeBuffer);
+          ourQuotes->mXValue.GetStringValue(buffer);
+          ourQuotes->mYValue.GetStringValue(closeBuffer);
           Unquote(buffer);
           Unquote(closeBuffer);
           quotes->SetQuotesAt(count++, buffer, closeBuffer);
           ourQuotes = ourQuotes->mNext;
         }
diff --git a/layout/style/nsStyleContext.cpp b/layout/style/nsStyleContext.cpp
--- a/layout/style/nsStyleContext.cpp
+++ b/layout/style/nsStyleContext.cpp
@@ -444,10 +444,15 @@ nsStyleContext::CalcStyleDifference(nsSt
   DO_STRUCT_DIFFERENCE(UIReset);
   DO_STRUCT_DIFFERENCE(List);
   // If the quotes implementation is ever going to change we might not need
   // a framechange here and a reflow should be sufficient.  See bug 35768.
   DO_STRUCT_DIFFERENCE(Quotes);
+
+#ifdef MOZ_SVG
+  maxHint = nsChangeHint(NS_STYLE_HINT_REFLOW | nsChangeHint_UpdateEffects);
+  DO_STRUCT_DIFFERENCE(SVGReset);
+#endif
 
   // At this point, we know that the worst kind of damage we could do is
   // a reflow.
   maxHint = NS_STYLE_HINT_REFLOW;
       
diff --git a/layout/style/nsStyleSet.cpp b/layout/style/nsStyleSet.cpp
--- a/layout/style/nsStyleSet.cpp
+++ b/layout/style/nsStyleSet.cpp
@@ -367,10 +367,16 @@ nsStyleSet::EnableQuirkStyleSheet(PRBool
       }
     }
   }
   NS_ASSERTION(mQuirkStyleSheet, "no quirk stylesheet");
   if (mQuirkStyleSheet) {
+#ifdef DEBUG
+    if (mRuleProcessors[eAgentSheet]) {
+      static_cast<nsCSSRuleProcessor*>(static_cast<nsIStyleRuleProcessor*>(
+        mRuleProcessors[eAgentSheet]))->AssertQuirksChangeOK();
+    }
+#endif
 #ifdef DEBUG_dbaron_off // XXX Make this |DEBUG| once it stops firing.
     PRBool applicableNow;
     mQuirkStyleSheet->GetApplicable(applicableNow);
     NS_ASSERTION(!mRuleProcessors[eAgentSheet] || aEnable == applicableNow,
                  "enabling/disabling quirk stylesheet too late or incomplete quirk stylesheet");
diff --git a/layout/style/nsStyleStruct.cpp b/layout/style/nsStyleStruct.cpp
--- a/layout/style/nsStyleStruct.cpp
+++ b/layout/style/nsStyleStruct.cpp
@@ -883,29 +883,38 @@ nsStyleSVGReset::nsStyleSVGReset(const n
   mDominantBaseline = aSource.mDominantBaseline;
 }
 
 nsChangeHint nsStyleSVGReset::CalcDifference(const nsStyleSVGReset& aOther) const
 {
+  nsChangeHint hint = nsChangeHint(0);
+
+  if (!EqualURIs(mClipPath, aOther.mClipPath) ||
+      !EqualURIs(mFilter, aOther.mFilter)     ||
+      !EqualURIs(mMask, aOther.mMask)) {
+    NS_UpdateHint(hint, nsChangeHint_UpdateEffects);
+    NS_UpdateHint(hint, nsChangeHint_ReflowFrame);
+    NS_UpdateHint(hint, nsChangeHint_RepaintFrame);
+  }
+
   if (mStopColor             != aOther.mStopColor     ||
       mFloodColor            != aOther.mFloodColor    ||
       mLightingColor         != aOther.mLightingColor ||
-      !EqualURIs(mClipPath, aOther.mClipPath)         ||
-      !EqualURIs(mFilter, aOther.mFilter)             ||
-      !EqualURIs(mMask, aOther.mMask)                 ||
       mStopOpacity           != aOther.mStopOpacity   ||
       mFloodOpacity          != aOther.mFloodOpacity  ||
       mDominantBaseline != aOther.mDominantBaseline)
-    return NS_STYLE_HINT_VISUAL;
-  
-  return NS_STYLE_HINT_NONE;
+    NS_UpdateHint(hint, nsChangeHint_RepaintFrame);
+
+  return hint;
 }
 
 #ifdef DEBUG
 /* static */
 nsChangeHint nsStyleSVGReset::MaxDifference()
 {
-  return NS_STYLE_HINT_VISUAL;
+  return NS_CombineHint(NS_CombineHint(nsChangeHint_UpdateEffects,
+                                       nsChangeHint_ReflowFrame),
+                                       nsChangeHint_RepaintFrame);
 }
 #endif
 
 // nsStyleSVGPaint implementation
 nsStyleSVGPaint::~nsStyleSVGPaint()
diff --git a/layout/style/nsStyleStruct.h b/layout/style/nsStyleStruct.h
--- a/layout/style/nsStyleStruct.h
+++ b/layout/style/nsStyleStruct.h
@@ -625,16 +625,16 @@ struct nsStyleOutline {
 #ifdef DEBUG
   static nsChangeHint MaxDifference();
 #endif
  
   nsStyleSides  mOutlineRadius;    // [reset] length, percent
-  																// (top=topLeft, right=topRight, bottom=bottomRight, left=bottomLeft)
+                                   // (top=topLeft, right=topRight, bottom=bottomRight, left=bottomLeft)
 
   // Note that these are specified values.  You can get the actual values with
   // GetOutlineWidth and GetOutlineOffset.  You cannot get the computed values
   // directly.
-  nsStyleCoord  mOutlineOffset;   // [reset] length
+  nsStyleCoord  mOutlineOffset;   // [reset] length XXX Why nsStyleCoord?
   nsStyleCoord  mOutlineWidth;    // [reset] length, enum (see nsStyleConsts.h)
 
   PRBool GetOutlineOffset(nscoord& aOffset) const
   {
     if (mOutlineOffset.GetUnit() == eStyleUnit_Coord) {
@@ -748,19 +748,19 @@ struct nsStylePosition {
   nsChangeHint CalcDifference(const nsStylePosition& aOther) const;
 #ifdef DEBUG
   static nsChangeHint MaxDifference();
 #endif
   
-  nsStyleSides  mOffset;                // [reset]
+  nsStyleSides  mOffset;                // [reset] coord, percent, auto
   nsStyleCoord  mWidth;                 // [reset] coord, percent, auto, enum
   nsStyleCoord  mMinWidth;              // [reset] coord, percent, enum
   nsStyleCoord  mMaxWidth;              // [reset] coord, percent, null, enum
   nsStyleCoord  mHeight;                // [reset] coord, percent, auto
   nsStyleCoord  mMinHeight;             // [reset] coord, percent
   nsStyleCoord  mMaxHeight;             // [reset] coord, percent, null
   PRUint8       mBoxSizing;             // [reset] see nsStyleConsts.h
-  nsStyleCoord  mZIndex;                // [reset] 
+  nsStyleCoord  mZIndex;                // [reset] integer, auto
 };
 
 struct nsStyleTextReset {
   nsStyleTextReset(void);
   nsStyleTextReset(const nsStyleTextReset& aOther);
@@ -780,11 +780,11 @@ struct nsStyleTextReset {
 #endif
   
   PRUint8 mTextDecoration;              // [reset] see nsStyleConsts.h
   PRUint8 mUnicodeBidi;                 // [reset] see nsStyleConsts.h
 
-  nsStyleCoord  mVerticalAlign;         // [reset] see nsStyleConsts.h for enums
+  nsStyleCoord  mVerticalAlign;         // [reset] coord, percent, enum (see nsStyleConsts.h)
 };
 
 struct nsStyleText {
   nsStyleText(void);
   nsStyleText(const nsStyleText& aOther);
@@ -806,14 +806,14 @@ struct nsStyleText {
   PRUint8 mTextAlign;                   // [inherited] see nsStyleConsts.h
   PRUint8 mTextTransform;               // [inherited] see nsStyleConsts.h
   PRUint8 mWhiteSpace;                  // [inherited] see nsStyleConsts.h
   PRUint8 mWordWrap;                    // [inherited] see nsStyleConsts.h
 
-  nsStyleCoord  mLetterSpacing;         // [inherited] 
-  nsStyleCoord  mLineHeight;            // [inherited] 
-  nsStyleCoord  mTextIndent;            // [inherited] 
-  nsStyleCoord  mWordSpacing;           // [inherited] 
+  nsStyleCoord  mLetterSpacing;         // [inherited] coord, normal
+  nsStyleCoord  mLineHeight;            // [inherited] coord, factor, normal
+  nsStyleCoord  mTextIndent;            // [inherited] coord, percent
+  nsStyleCoord  mWordSpacing;           // [inherited] coord, normal
 
   nsRefPtr<nsCSSShadowArray> mTextShadow; // [inherited] NULL in case of a zero-length
   
   PRBool WhiteSpaceIsSignificant() const {
     return mWhiteSpace == NS_STYLE_WHITESPACE_PRE ||
@@ -851,17 +851,17 @@ struct nsStyleVisibility {
   PRUint8 mDirection;                  // [inherited] see nsStyleConsts.h NS_STYLE_DIRECTION_*
   PRUint8   mVisible;                  // [inherited]
   nsCOMPtr<nsIAtom> mLangGroup;        // [inherited]
  
   PRBool IsVisible() const {
-		return (mVisible == NS_STYLE_VISIBILITY_VISIBLE);
-	}
+    return (mVisible == NS_STYLE_VISIBILITY_VISIBLE);
+  }
 
-	PRBool IsVisibleOrCollapsed() const {
-		return ((mVisible == NS_STYLE_VISIBILITY_VISIBLE) ||
-						(mVisible == NS_STYLE_VISIBILITY_COLLAPSE));
-	}
+  PRBool IsVisibleOrCollapsed() const {
+    return ((mVisible == NS_STYLE_VISIBILITY_VISIBLE) ||
+            (mVisible == NS_STYLE_VISIBILITY_COLLAPSE));
+  }
 };
 
 struct nsStyleDisplay {
   nsStyleDisplay();
   nsStyleDisplay(const nsStyleDisplay& aOther); 
@@ -995,12 +995,12 @@ struct nsStyleTableBorder {
   nsChangeHint CalcDifference(const nsStyleTableBorder& aOther) const;
 #ifdef DEBUG
   static nsChangeHint MaxDifference();
 #endif
   
-  nsStyleCoord  mBorderSpacingX;// [inherited]
-  nsStyleCoord  mBorderSpacingY;// [inherited]
+  nsStyleCoord  mBorderSpacingX;// [inherited] coord
+  nsStyleCoord  mBorderSpacingY;// [inherited] coord
   PRUint8       mBorderCollapse;// [inherited]
   PRUint8       mCaptionSide;   // [inherited]
   PRUint8       mEmptyCells;    // [inherited]
 };
 
@@ -1205,11 +1205,11 @@ struct nsStyleContent {
       return NS_OK;
     }
     return NS_ERROR_ILLEGAL_VALUE;
   }
 
-  nsStyleCoord  mMarkerOffset;  // [reset]
+  nsStyleCoord  mMarkerOffset;  // [reset] coord, auto
 
 protected:
   PRUint32            mContentCount;
   nsStyleContentData* mContents;
 
@@ -1330,12 +1330,12 @@ struct nsStyleColumn {
 #ifdef DEBUG
   static nsChangeHint MaxDifference();
 #endif
 
   PRUint32     mColumnCount; // [reset] see nsStyleConsts.h
-  nsStyleCoord mColumnWidth; // [reset]
-  nsStyleCoord mColumnGap;   // [reset] coord
+  nsStyleCoord mColumnWidth; // [reset] coord, auto
+  nsStyleCoord mColumnGap;   // [reset] coord, percent, normal
 
   nscolor      mColumnRuleColor;  // [reset]
   PRUint8      mColumnRuleStyle;  // [reset]
   PRPackedBool mColumnRuleColorIsForeground;
 
@@ -1400,14 +1400,14 @@ struct nsStyleSVG {
   nsStyleSVGPaint  mFill;             // [inherited]
   nsStyleSVGPaint  mStroke;           // [inherited]
   nsCOMPtr<nsIURI> mMarkerEnd;        // [inherited]
   nsCOMPtr<nsIURI> mMarkerMid;        // [inherited]
   nsCOMPtr<nsIURI> mMarkerStart;      // [inherited]
-  nsStyleCoord    *mStrokeDasharray;  // [inherited]
+  nsStyleCoord    *mStrokeDasharray;  // [inherited] coord, percent, factor
 
-  nsStyleCoord     mStrokeDashoffset; // [inherited]
-  nsStyleCoord     mStrokeWidth;      // [inherited]
+  nsStyleCoord     mStrokeDashoffset; // [inherited] coord, percent, factor
+  nsStyleCoord     mStrokeWidth;      // [inherited] coord, percent, factor
 
   float            mFillOpacity;      // [inherited]
   float            mStrokeMiterlimit; // [inherited]
   float            mStrokeOpacity;    // [inherited]
 
diff --git a/layout/style/test/test_dont_use_document_colors.html b/layout/style/test/test_dont_use_document_colors.html
--- a/layout/style/test/test_dont_use_document_colors.html
+++ b/layout/style/test/test_dont_use_document_colors.html
@@ -78,10 +78,12 @@ function part1()
           "border-right-color applies");
     isnot(cs1.borderLeftColor, cs2.borderLeftColor,
           "border-left-color applies");
     isnot(cs1.borderBottomColor, cs2.borderBottomColor,
           "border-top-color applies");
+    isnot(cs1.MozColumnRuleColor, cs2.MozColumnRuleColor,
+       "-moz-column-rule-color applies");
     is(cs1.borderTopColor, cs3.borderTopColor, "border-top-color applies");
     is(cs1.borderRightColor, cs3.borderRightColor,
        "border-right-color applies");
     is(cs1.borderLeftColor, cs3.borderLeftColor,
        "border-left-color applies");
@@ -106,12 +108,10 @@ function part1()
           "border-right-color applies");
     isnot(cs3.borderLeftColor, cs4.borderLeftColor,
           "border-left-color applies");
     isnot(cs3.borderBottomColor, cs4.borderBottomColor,
           "border-bottom-color applies");
-    isnot(cs2.MozColumnRuleColor, cs3.MozColumnRuleColor,
-       "-moz-column-rule-color applies");
     transparentBackgroundColor = cs2.backgroundColor;
     inputBackgroundColor = cs4.backgroundColor;
     inputColor = cs4.color;
     inputBorderTopColor = cs4.borderTopColor;
     inputBorderRightColor = cs4.borderRightColor;
@@ -139,11 +139,11 @@ function part2()
        "-moz-border-start-color is blocked");
     is(cs6.borderLeftColor, cs2.borderLeftColor,
        "-moz-border-end-color is blocked");
     is(cs1.borderBottomColor, cs2.borderBottomColor,
        "border-bottom-color is blocked");
-    is(cs2.MozColumnRuleColor, cs3.MozColumnRuleColor,
+    is(cs1.MozColumnRuleColor, cs2.MozColumnRuleColor,
        "-moz-column-rule-color is blocked");
     is(cs3.backgroundColor, cs1.backgroundColor, "background-color transparency preserved (opaque)");
     is(cs3.color, cs4.color, "color is blocked");
     is(cs3.borderTopColor, cs4.borderTopColor, "border-top-color is blocked");
     is(cs3.borderRightColor, cs4.borderRightColor,
diff --git a/layout/svg/base/src/Makefile.in b/layout/svg/base/src/Makefile.in
--- a/layout/svg/base/src/Makefile.in
+++ b/layout/svg/base/src/Makefile.in
@@ -67,10 +67,11 @@ REQUIRES	= xpcom \
 
 CPPSRCS		= \
 		nsSVGAFrame.cpp \
 		nsSVGClipPathFrame.cpp \
 		nsSVGContainerFrame.cpp \
+		nsSVGEffects.cpp \
 		nsSVGFilterFrame.cpp \
 		nsSVGFilterInstance.cpp \
 		nsSVGGFrame.cpp \
 		nsSVGGenericContainerFrame.cpp \
 		nsSVGGeometryFrame.cpp \
diff --git a/layout/svg/base/src/nsSVGAFrame.cpp b/layout/svg/base/src/nsSVGAFrame.cpp
--- a/layout/svg/base/src/nsSVGAFrame.cpp
+++ b/layout/svg/base/src/nsSVGAFrame.cpp
@@ -63,12 +63,10 @@ public:
   // nsIFrame:
   NS_IMETHOD  AttributeChanged(PRInt32         aNameSpaceID,
                                nsIAtom*        aAttribute,
                                PRInt32         aModType);
 
-  NS_IMETHOD DidSetStyleContext();
-
   /**
    * Get the "type" of the frame
    *
    * @see nsGkAtoms::svgAFrame
    */
@@ -127,18 +125,10 @@ nsSVGAFrame::AttributeChanged(PRInt32   
   }
 
  return NS_OK;
 }
 
-NS_IMETHODIMP
-nsSVGAFrame::DidSetStyleContext()
-{
-  nsSVGUtils::StyleEffects(this);
-
-  return NS_OK;
-}
-
 nsIAtom *
 nsSVGAFrame::GetType() const
 {
   return nsGkAtoms::svgAFrame;
 }
diff --git a/layout/svg/base/src/nsSVGClipPathFrame.cpp b/layout/svg/base/src/nsSVGClipPathFrame.cpp
--- a/layout/svg/base/src/nsSVGClipPathFrame.cpp
+++ b/layout/svg/base/src/nsSVGClipPathFrame.cpp
@@ -55,23 +55,10 @@ NS_NewSVGClipPathFrame(nsIPresShell* aPr
     NS_ERROR("Can't create frame! Content is not an SVG clipPath!");
     return nsnull;
   }
 
   return new (aPresShell) nsSVGClipPathFrame(aContext);
-}
-
-nsIContent *
-NS_GetSVGClipPathElement(nsIURI *aURI, nsIContent *aContent)
-{
-  nsIContent* content = nsContentUtils::GetReferencedElement(aURI, aContent);
-
-  nsCOMPtr<nsIDOMSVGClipPathElement> clipPath = do_QueryInterface(content);
-
-  if (clipPath)
-    return content;
-
-  return nsnull;
 }
 
 nsresult
 nsSVGClipPathFrame::ClipPaint(nsSVGRenderState* aContext,
                               nsISVGChildFrame* aParent,
diff --git a/layout/svg/base/src/nsSVGClipPathFrame.h b/layout/svg/base/src/nsSVGClipPathFrame.h
--- a/layout/svg/base/src/nsSVGClipPathFrame.h
+++ b/layout/svg/base/src/nsSVGClipPathFrame.h
@@ -108,9 +108,6 @@ public:
 
   // recursion prevention flag
   PRPackedBool mInUse;
 };
 
-nsIContent *
-NS_GetSVGClipPathElement(nsIURI *aURI, nsIContent *aContent);
-
 #endif
diff --git a/layout/svg/base/src/nsSVGContainerFrame.cpp b/layout/svg/base/src/nsSVGContainerFrame.cpp
--- a/layout/svg/base/src/nsSVGContainerFrame.cpp
+++ b/layout/svg/base/src/nsSVGContainerFrame.cpp
@@ -101,17 +101,10 @@ nsSVGDisplayContainerFrame::Init(nsICont
   if (!(GetStateBits() & NS_STATE_IS_OUTER_SVG)) {
     AddStateBits(aParent->GetStateBits() & NS_STATE_SVG_NONDISPLAY_CHILD);
   }
   nsresult rv = nsSVGContainerFrameBase::Init(aContent, aParent, aPrevInFlow);
   return rv;
-}
-
-void
-nsSVGDisplayContainerFrame::Destroy()
-{
-  nsSVGUtils::StyleEffects(this);
-  nsSVGContainerFrame::Destroy();
 }
 
 NS_IMETHODIMP
 nsSVGDisplayContainerFrame::InsertFrames(nsIAtom* aListName,
                                          nsIFrame* aPrevFrame,
diff --git a/layout/svg/base/src/nsSVGContainerFrame.h b/layout/svg/base/src/nsSVGContainerFrame.h
--- a/layout/svg/base/src/nsSVGContainerFrame.h
+++ b/layout/svg/base/src/nsSVGContainerFrame.h
@@ -89,11 +89,10 @@ private:
   NS_IMETHOD_(nsrefcnt) AddRef() { return 1; }
   NS_IMETHOD_(nsrefcnt) Release() { return 1; }
 
 public:
   // nsIFrame:
-  virtual void Destroy();
   NS_IMETHOD InsertFrames(nsIAtom*        aListName,
                           nsIFrame*       aPrevFrame,
                           nsIFrame*       aFrameList);
   NS_IMETHOD RemoveFrame(nsIAtom*        aListName,
                          nsIFrame*       aOldFrame);
diff --git a/layout/svg/base/src/nsSVGEffects.cpp b/layout/svg/base/src/nsSVGEffects.cpp
new file mode 100644
--- /dev/null
+++ b/layout/svg/base/src/nsSVGEffects.cpp
@@ -0,0 +1,271 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is the Mozilla SVG project.
+ *
+ * The Initial Developer of the Original Code is IBM Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2005
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   rocallahan@mozilla.com
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either of the GNU General Public License Version 2 or later (the "GPL"),
+ * or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#include "nsSVGEffects.h"
+#include "nsISupportsImpl.h"
+#include "nsSVGOuterSVGFrame.h"
+
+NS_IMPL_ISUPPORTS1(nsSVGPropertyBase, nsIMutationObserver)
+
+nsSVGPropertyBase::nsSVGPropertyBase(nsIURI *aURI,
+                                     nsIFrame *aFrame)
+  : mElement(this), mFrame(aFrame)
+{
+  // Start watching the target element
+  mElement.Reset(aFrame->GetContent(), aURI);
+  if (mElement.get()) {
+    mElement.get()->AddMutationObserver(this);
+  }
+}
+
+nsSVGPropertyBase::~nsSVGPropertyBase()
+{
+  if (mElement.get()) {
+    mElement.get()->RemoveMutationObserver(this);
+  }
+}
+
+nsIFrame*
+nsSVGPropertyBase::GetReferencedFrame(nsIAtom* aFrameType, PRBool* aOK)
+{
+  if (mElement.get()) {
+    nsIFrame *frame =
+      static_cast<nsGenericElement*>(mElement.get())->GetPrimaryFrame();
+    if (frame && frame->GetType() == aFrameType)
+      return frame;
+  }
+  if (aOK) {
+    *aOK = PR_FALSE;
+  }
+  return nsnull;
+}
+
+void
+nsSVGPropertyBase::AttributeChanged(nsIDocument *aDocument,
+                                    nsIContent *aContent,
+                                    PRInt32 aNameSpaceID,
+                                    nsIAtom *aAttribute,
+                                    PRInt32 aModType,
+                                    PRUint32 aStateMask)
+{
+  DoUpdate();
+}
+
+void
+nsSVGPropertyBase::ContentAppended(nsIDocument *aDocument,
+                                   nsIContent *aContainer,
+                                   PRInt32 aNewIndexInContainer)
+{
+  DoUpdate();
+}
+
+void
+nsSVGPropertyBase::ContentInserted(nsIDocument *aDocument,
+                                   nsIContent *aContainer,
+                                   nsIContent *aChild,
+                                   PRInt32 aIndexInContainer)
+{
+  DoUpdate();
+}
+
+void
+nsSVGPropertyBase::ContentRemoved(nsIDocument *aDocument,
+                                  nsIContent *aContainer,
+                                  nsIContent *aChild,
+                                  PRInt32 aIndexInContainer)
+{
+  DoUpdate();
+}
+
+NS_IMPL_ISUPPORTS_INHERITED1(nsSVGFilterProperty,
+                             nsSVGPropertyBase,
+                             nsISVGFilterProperty)
+
+nsSVGFilterProperty::nsSVGFilterProperty(nsIURI *aURI,
+                                         nsIFrame *aFilteredFrame)
+  : nsSVGPropertyBase(aURI, aFilteredFrame)
+{
+  UpdateRect();
+}
+
+void
+nsSVGFilterProperty::UpdateRect()
+{
+  nsSVGFilterFrame *filter = GetFilterFrame(nsnull);
+  if (filter) {
+    mFilterRect = filter->GetInvalidationRegion(mFrame, mFrame->GetRect());
+  } else {
+    mFilterRect = nsRect();
+  }
+}
+
+void
+nsSVGFilterProperty::DoUpdate()
+{
+  nsSVGOuterSVGFrame *outerSVGFrame = nsSVGUtils::GetOuterSVGFrame(mFrame);
+  if (outerSVGFrame) {
+    outerSVGFrame->InvalidateRect(mFilterRect);
+    UpdateRect();
+    outerSVGFrame->InvalidateRect(mFilterRect);
+  }
+}
+
+void
+nsSVGFilterProperty::ParentChainChanged(nsIContent *aContent)
+{
+  if (aContent->IsInDoc())
+    return;
+
+  nsSVGOuterSVGFrame *outerSVGFrame = nsSVGUtils::GetOuterSVGFrame(mFrame);
+  if (outerSVGFrame) {
+    outerSVGFrame->InvalidateCoveredRegion(mFrame);
+  }
+
+  mFrame->DeleteProperty(nsGkAtoms::filter);
+}
+
+void
+nsSVGClipPathProperty::DoUpdate()
+{
+  nsSVGOuterSVGFrame *outerSVGFrame = nsSVGUtils::GetOuterSVGFrame(mFrame);
+  if (outerSVGFrame) {
+    outerSVGFrame->InvalidateCoveredRegion(mFrame);
+  }
+}
+
+void
+nsSVGClipPathProperty::ParentChainChanged(nsIContent *aContent)
+{
+  if (aContent->IsInDoc())
+    return;
+
+  nsSVGOuterSVGFrame *outerSVGFrame = nsSVGUtils::GetOuterSVGFrame(mFrame);
+  if (outerSVGFrame) {
+    outerSVGFrame->InvalidateCoveredRegion(mFrame);
+  }
+
+  mFrame->DeleteProperty(nsGkAtoms::clipPath);
+}
+
+void
+nsSVGMaskProperty::DoUpdate()
+{
+  nsSVGOuterSVGFrame *outerSVGFrame = nsSVGUtils::GetOuterSVGFrame(mFrame);
+  if (outerSVGFrame) {
+    outerSVGFrame->InvalidateCoveredRegion(mFrame);
+  }
+}
+
+void
+nsSVGMaskProperty::ParentChainChanged(nsIContent *aContent)
+{
+  if (aContent->IsInDoc())
+    return;
+
+  nsSVGOuterSVGFrame *outerSVGFrame = nsSVGUtils::GetOuterSVGFrame(mFrame);
+  if (outerSVGFrame) {
+    outerSVGFrame->InvalidateCoveredRegion(mFrame);
+  }
+
+  mFrame->DeleteProperty(nsGkAtoms::mask);
+}
+
+static nsSVGPropertyBase *
+CreateFilterProperty(nsIURI *aURI, nsIFrame *aFrame)
+{ return new nsSVGFilterProperty(aURI, aFrame); }
+
+static nsSVGPropertyBase *
+CreateMaskProperty(nsIURI *aURI, nsIFrame *aFrame)
+{ return new nsSVGMaskProperty(aURI, aFrame); }
+
+static nsSVGPropertyBase *
+CreateClipPathProperty(nsIURI *aURI, nsIFrame *aFrame)
+{ return new nsSVGClipPathProperty(aURI, aFrame); }
+
+static nsSVGPropertyBase *
+GetEffectProperty(nsIURI *aURI, nsIFrame *aFrame, nsIAtom *aProp,
+                  nsSVGPropertyBase * (* aCreate)(nsIURI *, nsIFrame *))
+{
+  if (!aURI)
+    return nsnull;
+  nsSVGPropertyBase *prop = static_cast<nsSVGPropertyBase*>(aFrame->GetProperty(aProp));
+  if (prop)
+    return prop;
+  prop = aCreate(aURI, aFrame);
+  if (!prop)
+    return nsnull;
+  NS_ADDREF(prop);
+  aFrame->SetProperty(aProp,
+                      static_cast<nsISupports*>(prop),
+                      nsPropertyTable::SupportsDtorFunc);
+  return prop;
+}
+
+nsSVGEffects::EffectProperties
+nsSVGEffects::GetEffectProperties(nsIFrame *aFrame)
+{
+  NS_ASSERTION(!aFrame->GetPrevContinuation(), "aFrame should be first continuation");
+
+  EffectProperties result;
+  const nsStyleSVGReset *style = aFrame->GetStyleSVGReset();
+  result.mFilter = static_cast<nsSVGFilterProperty*>
+    (GetEffectProperty(style->mFilter, aFrame, nsGkAtoms::filter, CreateFilterProperty));
+  result.mClipPath = static_cast<nsSVGClipPathProperty*>
+    (GetEffectProperty(style->mClipPath, aFrame, nsGkAtoms::clipPath, CreateClipPathProperty));
+  result.mMask = static_cast<nsSVGMaskProperty*>
+    (GetEffectProperty(style->mMask, aFrame, nsGkAtoms::mask, CreateMaskProperty));
+  return result;
+}
+
+void
+nsSVGEffects::UpdateEffects(nsIFrame *aFrame)
+{
+  aFrame->DeleteProperty(nsGkAtoms::filter);
+  aFrame->DeleteProperty(nsGkAtoms::mask);
+  aFrame->DeleteProperty(nsGkAtoms::clipPath);
+}
+
+nsSVGFilterProperty *
+nsSVGEffects::GetFilterProperty(nsIFrame *aFrame)
+{
+  NS_ASSERTION(!aFrame->GetPrevContinuation(), "aFrame should be first continuation");
+
+  if (!aFrame->GetStyleSVGReset()->mFilter)
+    return nsnull;
+
+  return static_cast<nsSVGFilterProperty *>(aFrame->GetProperty(nsGkAtoms::filter));
+}
diff --git a/layout/svg/base/src/nsSVGEffects.h b/layout/svg/base/src/nsSVGEffects.h
new file mode 100644
--- /dev/null
+++ b/layout/svg/base/src/nsSVGEffects.h
@@ -0,0 +1,197 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is the Mozilla SVG project.
+ *
+ * The Initial Developer of the Original Code is IBM Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2005
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   rocallahan@mozilla.com
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either of the GNU General Public License Version 2 or later (the "GPL"),
+ * or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#ifndef NSSVGEFFECTS_H_
+#define NSSVGEFFECTS_H_
+
+#include "nsIContent.h"
+#include "nsIFrame.h"
+#include "nsReferencedElement.h"
+#include "nsStubMutationObserver.h"
+#include "nsSVGUtils.h"
+#include "nsSVGFilterFrame.h"
+#include "nsSVGClipPathFrame.h"
+#include "nsSVGMaskFrame.h"
+
+class nsSVGPropertyBase : public nsStubMutationObserver {
+public:
+  nsSVGPropertyBase(nsIURI* aURI, nsIFrame *aFrame);
+  virtual ~nsSVGPropertyBase();
+
+  // nsISupports
+  NS_DECL_ISUPPORTS
+
+  // nsIMutationObserver
+  NS_DECL_NSIMUTATIONOBSERVER_ATTRIBUTECHANGED
+  NS_DECL_NSIMUTATIONOBSERVER_CONTENTAPPENDED
+  NS_DECL_NSIMUTATIONOBSERVER_CONTENTINSERTED
+  NS_DECL_NSIMUTATIONOBSERVER_CONTENTREMOVED
+
+protected:
+  // This is called when the referenced filter/mask/clipPath changes
+  virtual void DoUpdate() = 0;
+
+  class SourceReference : public nsReferencedElement {
+  public:
+    SourceReference(nsSVGPropertyBase* aContainer) : mContainer(aContainer) {}
+  protected:
+    virtual void ContentChanged(nsIContent* aFrom, nsIContent* aTo) {
+      if (aFrom) {
+        aFrom->RemoveMutationObserver(mContainer);
+      }
+      nsReferencedElement::ContentChanged(aFrom, aTo);
+      if (aTo) {
+        aTo->AddMutationObserver(mContainer);
+      }
+      mContainer->DoUpdate();
+    }
+    /**
+     * Override IsPersistent because we want to keep tracking the element
+     * for the ID even when it changes.
+     */
+    virtual PRBool IsPersistent() { return PR_TRUE; }
+  private:
+    nsSVGPropertyBase* mContainer;
+  };
+  
+  /**
+   * @param aOK this is only for the convenience of callers. We set *aOK to false
+   * if this function returns null.
+   */
+  nsIFrame* GetReferencedFrame(nsIAtom* aFrameType, PRBool* aOK);
+
+  SourceReference mElement;
+  nsIFrame *mFrame;
+};
+
+class nsSVGFilterProperty :
+  public nsSVGPropertyBase, public nsISVGFilterProperty {
+public:
+  nsSVGFilterProperty(nsIURI *aURI, nsIFrame *aFilteredFrame);
+
+  nsSVGFilterFrame *GetFilterFrame(PRBool *aOK) {
+    return static_cast<nsSVGFilterFrame *>
+      (GetReferencedFrame(nsGkAtoms::svgFilterFrame, aOK));
+  }
+  void UpdateRect();
+
+  // nsISupports
+  NS_DECL_ISUPPORTS
+
+  // nsIMutationObserver
+  NS_DECL_NSIMUTATIONOBSERVER_PARENTCHAINCHANGED
+
+  // nsISVGFilterProperty
+  virtual void Invalidate() { DoUpdate(); }
+
+private:
+  // nsSVGPropertyBase
+  virtual void DoUpdate();
+  
+  // Tracks a bounding box for the filtered mFrame. We need this so that
+  // if the filter changes we know how much to redraw. We only need this
+  // for SVG frames since regular frames have an overflow area
+  // that includes the filtered area.
+  nsRect mFilterRect;
+};
+
+class nsSVGClipPathProperty : public nsSVGPropertyBase {
+public:
+  nsSVGClipPathProperty(nsIURI *aURI, nsIFrame *aClippedFrame)
+    : nsSVGPropertyBase(aURI, aClippedFrame) {}
+
+  nsSVGClipPathFrame *GetClipPathFrame(PRBool *aOK) {
+    return static_cast<nsSVGClipPathFrame *>
+      (GetReferencedFrame(nsGkAtoms::svgClipPathFrame, aOK));
+  }
+
+  // nsIMutationObserver
+  NS_DECL_NSIMUTATIONOBSERVER_PARENTCHAINCHANGED
+
+private:
+  virtual void DoUpdate();
+};
+
+class nsSVGMaskProperty : public nsSVGPropertyBase {
+public:
+  nsSVGMaskProperty(nsIURI *aURI, nsIFrame *aMaskedFrame)
+    : nsSVGPropertyBase(aURI, aMaskedFrame) {}
+
+  nsSVGMaskFrame *GetMaskFrame(PRBool *aOK) {
+    return static_cast<nsSVGMaskFrame *>
+      (GetReferencedFrame(nsGkAtoms::svgMaskFrame, aOK));
+  }
+
+  // nsIMutationObserver
+  NS_DECL_NSIMUTATIONOBSERVER_PARENTCHAINCHANGED
+
+private:
+  virtual void DoUpdate();
+};
+
+class nsSVGEffects {
+public:
+  struct EffectProperties {
+    nsSVGFilterProperty*   mFilter;
+    nsSVGMaskProperty*     mMask;
+    nsSVGClipPathProperty* mClipPath;
+  };
+
+  /**
+   * @param aFrame should be the first continuation
+   */
+  static EffectProperties GetEffectProperties(nsIFrame *aFrame);
+
+  /**
+   * Called by nsCSSFrameConstructor when style changes require the
+   * effect properties on aFrame to be updated
+   */
+  static void UpdateEffects(nsIFrame *aFrame);
+
+  /**
+   * @param aFrame should be the first continuation
+   */
+  static nsSVGFilterProperty *GetFilterProperty(nsIFrame *aFrame);
+  
+  static nsSVGFilterFrame *GetFilterFrame(nsIFrame *aFrame) {
+    nsSVGFilterProperty *prop = GetFilterProperty(aFrame);
+    PRBool ok;
+    return prop ? prop->GetFilterFrame(&ok) : nsnull;
+  }
+};
+
+#endif /*NSSVGEFFECTS_H_*/
diff --git a/layout/svg/base/src/nsSVGFilterFrame.cpp b/layout/svg/base/src/nsSVGFilterFrame.cpp
--- a/layout/svg/base/src/nsSVGFilterFrame.cpp
+++ b/layout/svg/base/src/nsSVGFilterFrame.cpp
@@ -56,22 +56,10 @@ NS_NewSVGFilterFrame(nsIPresShell* aPres
     NS_ERROR("Can't create frame! Content is not an SVG filter");
     return nsnull;
   }
 
   return new (aPresShell) nsSVGFilterFrame(aContext);
-}
-
-nsIContent *
-NS_GetSVGFilterElement(nsIURI *aURI, nsIContent *aContent)
-{
-  nsIContent* content = nsContentUtils::GetReferencedElement(aURI, aContent);
-
-  nsCOMPtr<nsIDOMSVGFilterElement> filter = do_QueryInterface(content);
-  if (filter)
-    return content;
-
-  return nsnull;
 }
 
 static nsIntRect
 MapDeviceRectToFilterSpace(const gfxMatrix& aMatrix,
                            const gfxIntSize& aFilterSize,
diff --git a/layout/svg/base/src/nsSVGFilterFrame.h b/layout/svg/base/src/nsSVGFilterFrame.h
--- a/layout/svg/base/src/nsSVGFilterFrame.h
+++ b/layout/svg/base/src/nsSVGFilterFrame.h
@@ -75,9 +75,6 @@ private:
                           const nsRect *aDirtyOutputRect,
                           const nsRect *aDirtyInputRect,
                           nsSVGFilterInstance **aInstance);
 };
 
-nsIContent *
-NS_GetSVGFilterElement(nsIURI *aURI, nsIContent *aContent);
-
 #endif
diff --git a/layout/svg/base/src/nsSVGForeignObjectFrame.cpp b/layout/svg/base/src/nsSVGForeignObjectFrame.cpp
--- a/layout/svg/base/src/nsSVGForeignObjectFrame.cpp
+++ b/layout/svg/base/src/nsSVGForeignObjectFrame.cpp
@@ -104,14 +104,10 @@ nsSVGForeignObjectFrame::Init(nsIContent
 }
 
 void nsSVGForeignObjectFrame::Destroy()
 {
   nsSVGUtils::GetOuterSVGFrame(this)->UnregisterForeignObject(this);
-  // Delete any clipPath/filter/mask properties _before_ we die. The properties
-  // and property hash table have weak pointers to us that are dereferenced
-  // when the properties are destroyed.
-  nsSVGUtils::StyleEffects(this);
   nsSVGForeignObjectFrameBase::Destroy();
 }
 
 nsIAtom *
 nsSVGForeignObjectFrame::GetType() const
@@ -138,17 +134,10 @@ nsSVGForeignObjectFrame::AttributeChange
       mCanvasTM = nsnull;
       UpdateGraphic();
     }
   }
 
-  return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSVGForeignObjectFrame::DidSetStyleContext()
-{
-  nsSVGUtils::StyleEffects(this);
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsSVGForeignObjectFrame::Reflow(nsPresContext*           aPresContext,
diff --git a/layout/svg/base/src/nsSVGForeignObjectFrame.h b/layout/svg/base/src/nsSVGForeignObjectFrame.h
--- a/layout/svg/base/src/nsSVGForeignObjectFrame.h
+++ b/layout/svg/base/src/nsSVGForeignObjectFrame.h
@@ -72,12 +72,10 @@ public:
                                PRInt32         aModType);
 
   virtual nsIFrame* GetContentInsertionFrame() {
     return GetFirstChild(nsnull)->GetContentInsertionFrame();
   }
-
-  NS_IMETHOD DidSetStyleContext();
 
   NS_IMETHOD Reflow(nsPresContext*           aPresContext,
                     nsHTMLReflowMetrics&     aDesiredSize,
                     const nsHTMLReflowState& aReflowState,
                     nsReflowStatus&          aStatus);
diff --git a/layout/svg/base/src/nsSVGGFrame.cpp b/layout/svg/base/src/nsSVGGFrame.cpp
--- a/layout/svg/base/src/nsSVGGFrame.cpp
+++ b/layout/svg/base/src/nsSVGGFrame.cpp
@@ -139,17 +139,10 @@ nsSVGGFrame::GetCanvasTM()
   NS_IF_ADDREF(retval);
   return retval;
 }
 
 NS_IMETHODIMP
-nsSVGGFrame::DidSetStyleContext()
-{
-  nsSVGUtils::StyleEffects(this);
-  return NS_OK;
-}
-
-NS_IMETHODIMP
 nsSVGGFrame::AttributeChanged(PRInt32         aNameSpaceID,
                               nsIAtom*        aAttribute,
                               PRInt32         aModType)
 {
   if (aNameSpaceID == kNameSpaceID_None &&
diff --git a/layout/svg/base/src/nsSVGGFrame.h b/layout/svg/base/src/nsSVGGFrame.h
--- a/layout/svg/base/src/nsSVGGFrame.h
+++ b/layout/svg/base/src/nsSVGGFrame.h
@@ -65,11 +65,10 @@ public:
     return MakeFrameName(NS_LITERAL_STRING("SVGG"), aResult);
   }
 #endif
 
   // nsIFrame interface:
-  NS_IMETHOD DidSetStyleContext();
   NS_IMETHOD AttributeChanged(PRInt32         aNameSpaceID,
                               nsIAtom*        aAttribute,
                               PRInt32         aModType);
 
   // nsISVGChildFrame interface:
diff --git a/layout/svg/base/src/nsSVGInnerSVGFrame.cpp b/layout/svg/base/src/nsSVGInnerSVGFrame.cpp
--- a/layout/svg/base/src/nsSVGInnerSVGFrame.cpp
+++ b/layout/svg/base/src/nsSVGInnerSVGFrame.cpp
@@ -62,13 +62,10 @@ private:
 private:
   NS_IMETHOD_(nsrefcnt) AddRef() { return 1; }
   NS_IMETHOD_(nsrefcnt) Release() { return 1; }
 
 public:
-  // nsIFrame:
-  NS_IMETHOD DidSetStyleContext();
-
   // We don't define an AttributeChanged method since changes to the
   // 'x', 'y', 'width' and 'height' attributes of our content object
   // are handled in nsSVGSVGElement::DidModifySVGObservable
 
   /**
@@ -402,12 +399,5 @@ nsSVGInnerSVGFrame::DidModifySVGObservab
                                             nsISVGValue::modificationType aModType)
 {
   NotifyViewportChange();
   return NS_OK;
 }
-
-NS_IMETHODIMP
-nsSVGInnerSVGFrame::DidSetStyleContext()
-{
-  nsSVGUtils::StyleEffects(this);
-  return NS_OK;
-}
diff --git a/layout/svg/base/src/nsSVGMaskFrame.cpp b/layout/svg/base/src/nsSVGMaskFrame.cpp
--- a/layout/svg/base/src/nsSVGMaskFrame.cpp
+++ b/layout/svg/base/src/nsSVGMaskFrame.cpp
@@ -55,23 +55,10 @@ NS_NewSVGMaskFrame(nsIPresShell* aPresSh
     NS_ERROR("Can't create frame! Content is not an SVG mask");
     return nsnull;
   }
 
   return new (aPresShell) nsSVGMaskFrame(aContext);
-}
-
-nsIContent *
-NS_GetSVGMaskElement(nsIURI *aURI, nsIContent *aContent)
-{
-  nsIContent* content = nsContentUtils::GetReferencedElement(aURI, aContent);
-
-  nsCOMPtr<nsIDOMSVGMaskElement> mask = do_QueryInterface(content);
-
-  if (mask)
-    return content;
-
-  return nsnull;
 }
 
 already_AddRefed<gfxPattern>
 nsSVGMaskFrame::ComputeMaskAlpha(nsSVGRenderState *aContext,
                                  nsISVGChildFrame* aParent,
diff --git a/layout/svg/base/src/nsSVGMaskFrame.h b/layout/svg/base/src/nsSVGMaskFrame.h
--- a/layout/svg/base/src/nsSVGMaskFrame.h
+++ b/layout/svg/base/src/nsSVGMaskFrame.h
@@ -102,9 +102,6 @@ private:
 
   // nsSVGContainerFrame methods:
   virtual already_AddRefed<nsIDOMSVGMatrix> GetCanvasTM();
 };
 
-nsIContent *
-NS_GetSVGMaskElement(nsIURI *aURI, nsIContent *aContent);
-
 #endif
diff --git a/layout/svg/base/src/nsSVGPathGeometryFrame.cpp b/layout/svg/base/src/nsSVGPathGeometryFrame.cpp
--- a/layout/svg/base/src/nsSVGPathGeometryFrame.cpp
+++ b/layout/svg/base/src/nsSVGPathGeometryFrame.cpp
@@ -597,12 +597,10 @@ nsSVGPathGeometryFrame::UpdateMarkerProp
 }
 
 void
 nsSVGPathGeometryFrame::RemovePathProperties()
 {
-  nsSVGUtils::StyleEffects(this);
-
   if (GetStateBits() & NS_STATE_SVG_HAS_MARKERS)
     DeleteProperty(nsGkAtoms::marker);
 }
 
 void
diff --git a/layout/svg/base/src/nsSVGTextFrame.cpp b/layout/svg/base/src/nsSVGTextFrame.cpp
--- a/layout/svg/base/src/nsSVGTextFrame.cpp
+++ b/layout/svg/base/src/nsSVGTextFrame.cpp
@@ -95,18 +95,10 @@ nsSVGTextFrame::AttributeChanged(PRInt32
              aAttribute == nsGkAtoms::dy) {
     NotifyGlyphMetricsChange();
   }
 
  return NS_OK;
-}
-
-NS_IMETHODIMP
-nsSVGTextFrame::DidSetStyleContext()
-{
-  nsSVGUtils::StyleEffects(this);
-
-  return NS_OK;
 }
 
 nsIAtom *
 nsSVGTextFrame::GetType() const
 {
diff --git a/layout/svg/base/src/nsSVGTextFrame.h b/layout/svg/base/src/nsSVGTextFrame.h
--- a/layout/svg/base/src/nsSVGTextFrame.h
+++ b/layout/svg/base/src/nsSVGTextFrame.h
@@ -57,11 +57,10 @@ public:
 public:
   // nsIFrame:
   NS_IMETHOD  AttributeChanged(PRInt32         aNameSpaceID,
                                nsIAtom*        aAttribute,
                                PRInt32         aModType);
-  NS_IMETHOD DidSetStyleContext();
 
   /**
    * Get the "type" of the frame
    *
    * @see nsGkAtoms::svgTextFrame
diff --git a/layout/svg/base/src/nsSVGUtils.cpp b/layout/svg/base/src/nsSVGUtils.cpp
--- a/layout/svg/base/src/nsSVGUtils.cpp
+++ b/layout/svg/base/src/nsSVGUtils.cpp
@@ -75,304 +75,18 @@
 #include "nsIScriptError.h"
 #include "gfxContext.h"
 #include "gfxMatrix.h"
 #include "gfxRect.h"
 #include "gfxImageSurface.h"
-#include "nsStubMutationObserver.h"
 #include "gfxPlatform.h"
 #include "nsSVGForeignObjectFrame.h"
 #include "nsIFontMetrics.h"
 #include "nsIDOMSVGUnitTypes.h"
+#include "nsSVGRect.h"
+#include "nsSVGEffects.h"
 
-static PRBool AddEffectProperties(nsIFrame *aFrame);
-
-class nsSVGPropertyBase : public nsStubMutationObserver {
-public:
-  nsSVGPropertyBase(nsIContent *aContent, nsIFrame *aFrame, nsIAtom *aName);
-  virtual ~nsSVGPropertyBase();
-
-  // nsISupports
-  NS_DECL_ISUPPORTS
-
-  // nsIMutationObserver
-  NS_DECL_NSIMUTATIONOBSERVER_ATTRIBUTECHANGED
-  NS_DECL_NSIMUTATIONOBSERVER_CONTENTAPPENDED
-  NS_DECL_NSIMUTATIONOBSERVER_CONTENTINSERTED
-  NS_DECL_NSIMUTATIONOBSERVER_CONTENTREMOVED
-
-protected:
-  virtual void DoUpdate() = 0;
-
-  nsWeakPtr mObservedContent;
-  nsIFrame *mFrame;
-};
-
-NS_IMPL_ISUPPORTS1(nsSVGPropertyBase, nsIMutationObserver)
-
-nsSVGPropertyBase::nsSVGPropertyBase(nsIContent *aContent,
-                                     nsIFrame *aFrame,
-                                     nsIAtom *aName)
-  : mFrame(aFrame)
-{
-  mObservedContent = do_GetWeakReference(aContent);
-  aContent->AddMutationObserver(this);
-
-  // Would like to NS_ADDREF here to avoid AddEffectProperties needing
-  // to do it manually, but that confuses the XPCOM_MEM_LOG_LEAKS
-  // tracking code because the call isn't virtual at this point.
-
-  mFrame->SetProperty(aName,
-                      static_cast<nsISupports*>(this),
-                      nsPropertyTable::SupportsDtorFunc);
-}
-
-nsSVGPropertyBase::~nsSVGPropertyBase()
-{
-  nsCOMPtr<nsIContent> content = do_QueryReferent(mObservedContent);
-  if (content)
-    content->RemoveMutationObserver(this);
-}
-
-void
-nsSVGPropertyBase::AttributeChanged(nsIDocument *aDocument,
-                                    nsIContent *aContent,
-                                    PRInt32 aNameSpaceID,
-                                    nsIAtom *aAttribute,
-                                    PRInt32 aModType,
-                                    PRUint32 aStateMask)
-{
-  DoUpdate();
-}
-
-void
-nsSVGPropertyBase::ContentAppended(nsIDocument *aDocument,
-                                   nsIContent *aContainer,
-                                   PRInt32 aNewIndexInContainer)
-{
-  DoUpdate();
-}
-
-void
-nsSVGPropertyBase::ContentInserted(nsIDocument *aDocument,
-                                   nsIContent *aContainer,
-                                   nsIContent *aChild,
-                                   PRInt32 aIndexInContainer)
-{
-  DoUpdate();
-}
-
-void
-nsSVGPropertyBase::ContentRemoved(nsIDocument *aDocument,
-                                  nsIContent *aContainer,
-                                  nsIContent *aChild,
-                                  PRInt32 aIndexInContainer)
-{
-  DoUpdate();
-}
-
-class nsSVGFilterProperty :
-  public nsSVGPropertyBase, public nsISVGFilterProperty {
-public:
-  nsSVGFilterProperty(nsIContent *aFilter, nsIFrame *aFilteredFrame);
-  virtual ~nsSVGFilterProperty() {
-    mFrame->RemoveStateBits(NS_STATE_SVG_FILTERED);
-  }
-
-  nsSVGFilterFrame *GetFilterFrame();
-  void UpdateRect();
-
-  // nsISupports
-  NS_DECL_ISUPPORTS
-
-  // nsIMutationObserver
-  NS_DECL_NSIMUTATIONOBSERVER_PARENTCHAINCHANGED
-
-  // nsISVGFilterProperty
-  virtual void Invalidate() { DoUpdate(); }
-
-private:
-  // nsSVGPropertyBase
-  virtual void DoUpdate();
-
-  nsRect mFilterRect;
-};
-
-NS_IMPL_ISUPPORTS_INHERITED1(nsSVGFilterProperty,
-                             nsSVGPropertyBase,
-                             nsISVGFilterProperty)
-
-nsSVGFilterProperty::nsSVGFilterProperty(nsIContent *aFilter,
-                                         nsIFrame *aFilteredFrame)
-  : nsSVGPropertyBase(aFilter, aFilteredFrame, nsGkAtoms::filter)
-{
-  mFrame->AddStateBits(NS_STATE_SVG_FILTERED);
-  UpdateRect();
-}
-
-nsSVGFilterFrame *
-nsSVGFilterProperty::GetFilterFrame()
-{
-  nsCOMPtr<nsIContent> filter = do_QueryReferent(mObservedContent);
-  if (filter) {
-    nsIFrame *frame =
-      static_cast<nsGenericElement*>(filter.get())->GetPrimaryFrame();
-    if (frame && frame->GetType() == nsGkAtoms::svgFilterFrame)
-      return static_cast<nsSVGFilterFrame*>(frame);
-  }
-
-  return nsnull;
-}
-
-void
-nsSVGFilterProperty::UpdateRect()
-{
-  nsSVGFilterFrame *filter = GetFilterFrame();
-  if (filter) {
-    nsISVGChildFrame *svg;
-    CallQueryInterface(mFrame, &svg);
-    mFilterRect = filter->GetInvalidationRegion(mFrame, svg->GetCoveredRegion());
-  }
-}
-
-void
-nsSVGFilterProperty::DoUpdate()
-{
-  nsSVGOuterSVGFrame *outerSVGFrame = nsSVGUtils::GetOuterSVGFrame(mFrame);
-  if (outerSVGFrame) {
-    outerSVGFrame->InvalidateRect(mFilterRect);
-    UpdateRect();
-    outerSVGFrame->InvalidateRect(mFilterRect);
-  }
-}
-
-void
-nsSVGFilterProperty::ParentChainChanged(nsIContent *aContent)
-{
-  if (aContent->IsInDoc())
-    return;
-
-  nsSVGOuterSVGFrame *outerSVGFrame = nsSVGUtils::GetOuterSVGFrame(mFrame);
-  if (outerSVGFrame)
-    outerSVGFrame->InvalidateCoveredRegion(mFrame);
-
-  mFrame->DeleteProperty(nsGkAtoms::filter);
-}
-
-class nsSVGClipPathProperty : public nsSVGPropertyBase {
-public:
-  nsSVGClipPathProperty(nsIContent *aClipPath, nsIFrame *aClippedFrame)
-    : nsSVGPropertyBase(aClipPath, aClippedFrame, nsGkAtoms::clipPath) {
-    mFrame->AddStateBits(NS_STATE_SVG_CLIPPED);
-  }
-  virtual ~nsSVGClipPathProperty() {
-    mFrame->RemoveStateBits(NS_STATE_SVG_CLIPPED);
-  }
-
-  nsSVGClipPathFrame *GetClipPathFrame();
-
-  // nsIMutationObserver
-  NS_DECL_NSIMUTATIONOBSERVER_PARENTCHAINCHANGED
-
-private:
-  virtual void DoUpdate();
-};
-
-nsSVGClipPathFrame *
-nsSVGClipPathProperty::GetClipPathFrame()
-{
-  nsCOMPtr<nsIContent> clipPath = do_QueryReferent(mObservedContent);
-  if (clipPath) {
-    nsIFrame *frame =
-      static_cast<nsGenericElement*>(clipPath.get())->GetPrimaryFrame();
-    if (frame && frame->GetType() == nsGkAtoms::svgClipPathFrame)
-      return static_cast<nsSVGClipPathFrame*>(frame);
-  }
-
-  return nsnull;
-}
-
-void
-nsSVGClipPathProperty::DoUpdate()
-{
-  nsISVGChildFrame *svgChildFrame;
-  CallQueryInterface(mFrame, &svgChildFrame);
-
-  if (!svgChildFrame)
-    return;
-
-  nsSVGOuterSVGFrame *outerSVGFrame = nsSVGUtils::GetOuterSVGFrame(mFrame);
-  if (outerSVGFrame)
-    outerSVGFrame->InvalidateCoveredRegion(mFrame);
-}
-
-void
-nsSVGClipPathProperty::ParentChainChanged(nsIContent *aContent)
-{
-  if (aContent->IsInDoc())
-    return;
-
-  mFrame->DeleteProperty(nsGkAtoms::clipPath);
-}
-
-
-class nsSVGMaskProperty : public nsSVGPropertyBase {
-public:
-  nsSVGMaskProperty(nsIContent *aMask, nsIFrame *aMaskedFrame)
-    : nsSVGPropertyBase(aMask, aMaskedFrame, nsGkAtoms::mask) {
-    mFrame->AddStateBits(NS_STATE_SVG_MASKED);
-  }
-  virtual ~nsSVGMaskProperty() {
-    mFrame->RemoveStateBits(NS_STATE_SVG_MASKED);
-  }
-
-  nsSVGMaskFrame *GetMaskFrame();
-
-  // nsIMutationObserver
-  NS_DECL_NSIMUTATIONOBSERVER_PARENTCHAINCHANGED
-
-private:
-  virtual void DoUpdate();
-};
-
-nsSVGMaskFrame *
-nsSVGMaskProperty::GetMaskFrame()
-{
-  nsCOMPtr<nsIContent> mask = do_QueryReferent(mObservedContent);
-  if (mask) {
-    nsIFrame *frame =
-      static_cast<nsGenericElement*>(mask.get())->GetPrimaryFrame();
-    if (frame && frame->GetType() == nsGkAtoms::svgMaskFrame)
-      return static_cast<nsSVGMaskFrame*>(frame);
-  }
-
-  return nsnull;
-}
-
-void
-nsSVGMaskProperty::DoUpdate()
-{
-  nsISVGChildFrame *svgChildFrame;
-  CallQueryInterface(mFrame, &svgChildFrame);
-
-  if (!svgChildFrame)
-    return;
-
-  nsSVGOuterSVGFrame *outerSVGFrame = nsSVGUtils::GetOuterSVGFrame(mFrame);
-  if (outerSVGFrame)
-    outerSVGFrame->InvalidateCoveredRegion(mFrame);
-}
-
-void
-nsSVGMaskProperty::ParentChainChanged(nsIContent *aContent)
-{
-  if (aContent->IsInDoc())
-    return;
-
-  mFrame->DeleteProperty(nsGkAtoms::mask);
-}
-
-gfxASurface     *nsSVGUtils::mThebesComputationalSurface = nsnull;
+gfxASurface *nsSVGUtils::mThebesComputationalSurface = nsnull;
 
 // c = n / 255
 // (c <= 0.0031308 ? c * 12.92 : 1.055 * pow(c, 1 / 2.4) - 0.055) * 255 + 0.5
 static const PRUint8 glinearRGBTosRGBMap[256] = {
   0,  13,  22,  28,  34,  38,  42,  46,
@@ -860,15 +574,13 @@ nsSVGUtils::FindFilterInvalidation(nsIFr
 
   while (aFrame) {
     if (aFrame->GetStateBits() & NS_STATE_IS_OUTER_SVG)
       break;
 
-    if (aFrame->GetStateBits() & NS_STATE_SVG_FILTERED) {
-      nsSVGFilterProperty *property;
-      property = static_cast<nsSVGFilterProperty *>
-                            (aFrame->GetProperty(nsGkAtoms::filter));
-      nsSVGFilterFrame *filter = property->GetFilterFrame();
+    nsSVGFilterProperty *property = nsSVGEffects::GetFilterProperty(aFrame);
+    if (property) {
+      nsSVGFilterFrame *filter = property->GetFilterFrame(nsnull);
       if (filter) {
         rect = filter->GetInvalidationRegion(aFrame, rect);
       }
     }
     aFrame = aFrame->GetParent();
@@ -878,17 +590,14 @@ nsSVGUtils::FindFilterInvalidation(nsIFr
 }
 
 void
 nsSVGUtils::UpdateFilterRegion(nsIFrame *aFrame)
 {
-  AddEffectProperties(aFrame);
-
-  if (aFrame->GetStateBits() & NS_STATE_SVG_FILTERED) {
-    nsSVGFilterProperty *property;
-    property = static_cast<nsSVGFilterProperty *>
-                          (aFrame->GetProperty(nsGkAtoms::filter));
-    property->UpdateRect();
+  nsSVGEffects::EffectProperties props =
+    nsSVGEffects::GetEffectProperties(aFrame);
+  if (props.mFilter) {
+    props.mFilter->UpdateRect();
   }
 }
 
 void
 nsSVGUtils::UpdateGraphic(nsISVGChildFrame *aSVGFrame)
@@ -929,14 +638,12 @@ nsSVGUtils::NotifyAncestorsOfFilterRegio
 
   while (aFrame) {
     if (aFrame->GetStateBits() & NS_STATE_IS_OUTER_SVG)
       return;
 
-    if (aFrame->GetStateBits() & NS_STATE_SVG_FILTERED) {
-      nsSVGFilterProperty *property;
-      property = static_cast<nsSVGFilterProperty *>
-                            (aFrame->GetProperty(nsGkAtoms::filter));
+    nsSVGFilterProperty *property = nsSVGEffects::GetFilterProperty(aFrame);
+    if (property) {
       property->Invalidate();
     }
     aFrame = aFrame->GetParent();
   }
 }
@@ -1207,98 +914,10 @@ nsSVGUtils::RemoveObserver(nsISupports *
   if (observer && v)
     v->RemoveObserver(observer);
 }
 
 // ************************************************************
-// Effect helper functions
-
-static PRBool
-AddEffectProperties(nsIFrame *aFrame)
-{
-  const nsStyleSVGReset *style = aFrame->GetStyleSVGReset();
-
-  if (style->mFilter && !(aFrame->GetStateBits() & NS_STATE_SVG_FILTERED)) {
-    nsIContent *filter = NS_GetSVGFilterElement(style->mFilter,
-                                                aFrame->GetContent());
-    if (!filter) {
-      return PR_FALSE;
-    }
-    nsSVGPropertyBase *property;
-    if (!(property = new nsSVGFilterProperty(filter, aFrame))) {
-      NS_ERROR("Could not create filter property");
-      return PR_FALSE;
-    }
-    NS_ADDREF(property); // addref to allow QI - SupportsDtorFunc releases
-  }
-
-  if (style->mClipPath && !(aFrame->GetStateBits() & NS_STATE_SVG_CLIPPED)) {
-    nsIContent *clipPath = NS_GetSVGClipPathElement(style->mClipPath,
-                                                    aFrame->GetContent());
-    if (!clipPath) {
-      return PR_FALSE;
-    }
-    nsSVGPropertyBase *property;
-    if (!(property = new nsSVGClipPathProperty(clipPath, aFrame))) {
-      NS_ERROR("Could not create clipPath property");
-      return PR_FALSE;
-    }
-    NS_ADDREF(property); // addref to allow QI - SupportsDtorFunc releases
-  }
-
-  if (style->mMask && !(aFrame->GetStateBits() & NS_STATE_SVG_MASKED)) {
-    nsIContent *mask = NS_GetSVGMaskElement(style->mMask,
-                                            aFrame->GetContent());
-    if (!mask) {
-      return PR_FALSE;
-    }
-    nsSVGPropertyBase *property;
-    if (!(property = new nsSVGMaskProperty(mask, aFrame))) {
-      NS_ERROR("Could not create mask property");
-      return PR_FALSE;
-    }
-    NS_ADDREF(property); // addref to allow QI - SupportsDtorFunc releases
-  }
-  return PR_TRUE;
-}
-
-static nsSVGFilterFrame *
-GetFilterFrame(nsFrameState aState, nsIFrame *aFrame)
-{
-  if (aState & NS_STATE_SVG_FILTERED) {
-    nsSVGFilterProperty *property;
-    property = static_cast<nsSVGFilterProperty *>
-                          (aFrame->GetProperty(nsGkAtoms::filter));
-    return property->GetFilterFrame();
-  }
-  return nsnull;
-}
-
-static nsSVGClipPathFrame *
-GetClipPathFrame(nsFrameState aState, nsIFrame *aFrame)
-{
-  if (aState & NS_STATE_SVG_CLIPPED) {
-    nsSVGClipPathProperty *property;
-    property = static_cast<nsSVGClipPathProperty *>
-                          (aFrame->GetProperty(nsGkAtoms::clipPath));
-    return property->GetClipPathFrame();
-  }
-  return nsnull;
-}
-
-static nsSVGMaskFrame *
-GetMaskFrame(nsFrameState aState, nsIFrame *aFrame)
-{
-  if (aState & NS_STATE_SVG_MASKED) {
-    nsSVGMaskProperty *property;
-    property = static_cast<nsSVGMaskProperty *>
-                          (aFrame->GetProperty(nsGkAtoms::mask));
-    return property->GetMaskFrame();
-  }
-  return nsnull;
-}
-
-// ************************************************************
 
 void
 nsSVGUtils::PaintChildWithEffects(nsSVGRenderState *aContext,
                                   nsRect *aDirtyRect,
                                   nsIFrame *aFrame)
@@ -1314,17 +933,16 @@ nsSVGUtils::PaintChildWithEffects(nsSVGR
     return;
 
   /* Properties are added lazily and may have been removed by a restyle,
      so make sure all applicable ones are set again. */
 
-  if (!AddEffectProperties(aFrame))
-    return;
-  nsFrameState state = aFrame->GetStateBits();
+  nsSVGEffects::EffectProperties effectProperties =
+    nsSVGEffects::GetEffectProperties(aFrame);
 
   /* Check if we need to draw anything */
   if (aDirtyRect && svgChildFrame->HasValidCoveredRect()) {
-    if (state & NS_STATE_SVG_FILTERED) {
+    if (effectProperties.mFilter) {
       if (!aDirtyRect->Intersects(FindFilterInvalidation(aFrame, aFrame->GetRect())))
         return;
     } else {
       if (!aDirtyRect->Intersects(aFrame->GetRect()))
         return;
@@ -1349,15 +967,25 @@ nsSVGUtils::PaintChildWithEffects(nsSVGR
     opacity = 1.0f;
 
   gfxContext *gfx = aContext->GetGfxContext();
   PRBool complexEffects = PR_FALSE;
 
-  nsSVGClipPathFrame *clipPathFrame = GetClipPathFrame(state, aFrame);
+  PRBool isOK = PR_TRUE;
+  nsSVGClipPathFrame *clipPathFrame = effectProperties.mClipPath ?
+    effectProperties.mClipPath->GetClipPathFrame(&isOK) : nsnull;
+  nsSVGFilterFrame *filterFrame = effectProperties.mFilter ?
+    effectProperties.mFilter->GetFilterFrame(&isOK) : nsnull;
+  nsSVGMaskFrame *maskFrame = effectProperties.mMask ?
+    effectProperties.mMask->GetMaskFrame(&isOK) : nsnull;
+
   PRBool isTrivialClip = clipPathFrame ? clipPathFrame->IsTrivial() : PR_TRUE;
 
-  nsSVGMaskFrame *maskFrame = GetMaskFrame(state, aFrame);
-
+  if (!isOK) {
+    // Some resource is missing. We shouldn't paint anything.
+    return;
+  }
+  
   nsCOMPtr<nsIDOMSVGMatrix> matrix =
     (clipPathFrame || maskFrame) ? GetCanvasTM(aFrame) : nsnull;
 
   /* Check if we need to do additional operations on this child's
    * rendering, which necessitates rendering into another surface. */
@@ -1374,11 +1002,10 @@ nsSVGUtils::PaintChildWithEffects(nsSVGR
     gfx->Save();
     clipPathFrame->ClipPaint(aContext, svgChildFrame, matrix);
   }
 
   /* Paint the child */
-  nsSVGFilterFrame *filterFrame = GetFilterFrame(state, aFrame);
   if (filterFrame) {
     filterFrame->FilterPaint(aContext, svgChildFrame, aDirtyRect);
   } else {
     svgChildFrame->PaintSVG(aContext, aDirtyRect);
   }
@@ -1424,44 +1051,37 @@ nsSVGUtils::PaintChildWithEffects(nsSVGR
 
   gfx->Restore();
 }
 
 void
-nsSVGUtils::StyleEffects(nsIFrame *aFrame)
+nsSVGUtils::UpdateEffects(nsIFrame *aFrame)
 {
-  nsFrameState state = aFrame->GetStateBits();
-
-  /* clear out all effects */
-
-  if (state & NS_STATE_SVG_CLIPPED) {
-    aFrame->DeleteProperty(nsGkAtoms::clipPath);
-  }
-
-  if (state & NS_STATE_SVG_FILTERED) {
-    aFrame->DeleteProperty(nsGkAtoms::filter);
-  }
-
-  if (state & NS_STATE_SVG_MASKED) {
-    aFrame->DeleteProperty(nsGkAtoms::mask);
-  }
+  aFrame->DeleteProperty(nsGkAtoms::filter);
+  aFrame->DeleteProperty(nsGkAtoms::mask);
+  aFrame->DeleteProperty(nsGkAtoms::clipPath);
 }
 
 PRBool
 nsSVGUtils::HitTestClip(nsIFrame *aFrame, float x, float y)
 {
-  nsSVGClipPathFrame *clipPathFrame =
-    GetClipPathFrame(aFrame->GetStateBits(), aFrame);
+  nsSVGEffects::EffectProperties props =
+    nsSVGEffects::GetEffectProperties(aFrame);
+  if (!props.mClipPath)
+    return PR_TRUE;
 
-  if (clipPathFrame) {
-    nsISVGChildFrame* SVGFrame;
-    CallQueryInterface(aFrame, &SVGFrame);
-
-    nsCOMPtr<nsIDOMSVGMatrix> matrix = GetCanvasTM(aFrame);
-    return clipPathFrame->ClipHitTest(SVGFrame, matrix, x, y);
+  nsSVGClipPathFrame *clipPathFrame = props.mClipPath->GetClipPathFrame(nsnull);
+  if (!clipPathFrame) {
+    // clipPath is not a valid resource, so nothing gets painted, so
+    // hit-testing must fail.
+    return PR_FALSE;
   }
 
-  return PR_TRUE;
+  nsISVGChildFrame* SVGFrame;
+  CallQueryInterface(aFrame, &SVGFrame);
+
+  nsCOMPtr<nsIDOMSVGMatrix> matrix = GetCanvasTM(aFrame);
+  return clipPathFrame->ClipHitTest(SVGFrame, matrix, x, y);
 }
 
 void
 nsSVGUtils::HitTestChildren(nsIFrame *aFrame, float x, float y,
                             nsIFrame **aResult)
@@ -1706,11 +1326,11 @@ nsSVGUtils::GfxRectToIntRect(const gfxRe
 }
 
 PRBool
 nsSVGUtils::CanOptimizeOpacity(nsIFrame *aFrame)
 {
-  if (!(aFrame->GetStateBits() & NS_STATE_SVG_FILTERED)) {
+  if (!aFrame->GetStyleSVGReset()->mFilter) {
     nsIAtom *type = aFrame->GetType();
     if (type == nsGkAtoms::svgImageFrame)
       return PR_TRUE;
     if (type == nsGkAtoms::svgPathGeometryFrame) {
       nsSVGGeometryFrame *geom = static_cast<nsSVGGeometryFrame*>(aFrame);
diff --git a/layout/svg/base/src/nsSVGUtils.h b/layout/svg/base/src/nsSVGUtils.h
--- a/layout/svg/base/src/nsSVGUtils.h
+++ b/layout/svg/base/src/nsSVGUtils.h
@@ -41,11 +41,10 @@
 #define _USE_MATH_DEFINES
 #include <math.h>
 
 #include "nscore.h"
 #include "nsCOMPtr.h"
-#include "nsISVGValue.h"
 #include "nsRect.h"
 
 class nsIDocument;
 class nsPresContext;
 class nsIContent;
@@ -59,11 +58,10 @@ class nsIDOMSVGMatrix;
 class nsIDOMSVGMatrix;
 class nsIURI;
 class nsSVGOuterSVGFrame;
 class nsIPresShell;
 class nsIDOMSVGAnimatedPreserveAspectRatio;
-class nsISVGValueObserver;
 class nsIAtom;
 class nsSVGLength2;
 class nsSVGElement;
 class nsSVGSVGElement;
 class nsAttrValue;
@@ -85,27 +83,23 @@ class nsISVGChildFrame;
 #endif
 
 // SVG Frame state bits
 #define NS_STATE_IS_OUTER_SVG         0x00100000
 
-#define NS_STATE_SVG_CLIPPED          0x00200000
-#define NS_STATE_SVG_FILTERED         0x00400000
-#define NS_STATE_SVG_MASKED           0x00800000
+#define NS_STATE_SVG_HAS_MARKERS      0x00200000
 
-#define NS_STATE_SVG_HAS_MARKERS      0x01000000
-
-#define NS_STATE_SVG_DIRTY            0x02000000
+#define NS_STATE_SVG_DIRTY            0x00400000
 
 /* Do we have a paint server for fill with a valid URL? */
-#define NS_STATE_SVG_FILL_PSERVER     0x04000000
+#define NS_STATE_SVG_FILL_PSERVER     0x00800000
 /* Do we have a paint server for stroke with a valid URL? */
-#define NS_STATE_SVG_STROKE_PSERVER   0x08000000
+#define NS_STATE_SVG_STROKE_PSERVER   0x01000000
 /* Do we have any paint servers with valid URLs? */
-#define NS_STATE_SVG_PSERVER_MASK     0x0c000000
+#define NS_STATE_SVG_PSERVER_MASK     0x01800000
 
 /* are we the child of a non-display container? */
-#define NS_STATE_SVG_NONDISPLAY_CHILD 0x10000000
+#define NS_STATE_SVG_NONDISPLAY_CHILD 0x02000000
 
 /**
  * Byte offsets of channels in a native packed gfxColor or cairo image surface.
  */
 #ifdef IS_BIG_ENDIAN
@@ -130,10 +124,13 @@ class nsISVGChildFrame;
  * successfully be created.  Declared as a function instead of a
  * nsSVGUtil method so that files that can't pull in nsSVGUtils.h (due
  * to cairo.h usage) can still query this information.
  */
 PRBool NS_SVGEnabled();
+
+// GRRR WINDOWS HATE HATE HATE
+#undef CLIP_MASK
 
 class nsSVGRenderState
 {
 public:
   enum RenderMode { NORMAL, CLIP, CLIP_MASK };
@@ -338,15 +335,16 @@ public:
   static void
   PaintChildWithEffects(nsSVGRenderState *aContext,
                         nsRect *aDirtyRect,
                         nsIFrame *aFrame);
 
-  /* Style change for effects (filter/clip/mask/opacity) - call when
-   * the frame's style has changed to make sure the effects properties
-   * stay in sync. */
+  /**
+   * Called by nsCSSFrameConstructor when style changes require the
+   * effect properties on aFrame to be updated
+   */
   static void
-  StyleEffects(nsIFrame *aFrame);
+  UpdateEffects(nsIFrame *aFrame);
 
   /* Hit testing - check if point hits the clipPath of indicated
    * frame.  (x,y) are specified in device pixels relative to the
    * origin of the outer svg frame.  Returns true if no clipPath
    * set. */
diff --git a/layout/tables/crashtests/416845-1.xhtml b/layout/tables/crashtests/416845-1.xhtml
new file mode 100644
--- /dev/null
+++ b/layout/tables/crashtests/416845-1.xhtml
@@ -0,0 +1,7 @@
+<html xmlns="http://www.w3.org/1999/xhtml">
+
+<head></head>
+
+<body><table height="82">x<tbody height="30"></tbody></table></body>
+
+</html>
diff --git a/layout/tables/crashtests/416845-2.xhtml b/layout/tables/crashtests/416845-2.xhtml
new file mode 100644
--- /dev/null
+++ b/layout/tables/crashtests/416845-2.xhtml
@@ -0,0 +1,15 @@
+<!DOCTYPE HTML>
+<html xmlns="http://www.w3.org/1999/xhtml">
+<head>
+    <style type="text/css">
+
+        html,body {
+            color:black; background-color:white; font-size:16px; padding:0; margin:0;
+        }
+
+    </style>
+</head>
+
+<body><table style="border:6px solid lime" height="82"><tbody>1</tbody><tbody height="30">2</tbody></table></body>
+
+</html>
diff --git a/layout/tables/crashtests/416845-3.html b/layout/tables/crashtests/416845-3.html
new file mode 100644
--- /dev/null
+++ b/layout/tables/crashtests/416845-3.html
@@ -0,0 +1,38 @@
+<!DOCTYPE HTML>
+<html class="reftest-wait">
+<head>
+    <style type="text/css">
+
+        html,body {
+            color:black; background-color:white; font-size:16px; padding:0; margin:0;
+        }
+
+    </style>
+
+<script>
+function insertTable() {
+  var table = document.createElement('table');
+  var tbody = document.createElement('tbody');
+  var tbody2 = document.createElement('tbody');
+  var text = document.createTextNode('1');
+  var text2 = document.createTextNode('2');
+  tbody.appendChild(text);
+  tbody2.appendChild(text2);
+  table.appendChild(tbody);
+  table.appendChild(tbody2);
+
+  table.setAttribute('height','82');
+  table.setAttribute('style','border:6px solid lime');
+
+  tbody2.setAttribute('height','30');
+
+  document.body.appendChild(table);
+
+  setTimeout(function() { document.documentElement.className = ""; }, 0);
+}
+</script>
+</head>
+
+<body onload="insertTable()"></body>
+
+</html>
diff --git a/layout/tables/crashtests/crashtests.list b/layout/tables/crashtests/crashtests.list
--- a/layout/tables/crashtests/crashtests.list
+++ b/layout/tables/crashtests/crashtests.list
@@ -44,6 +44,9 @@ load 403579-1.html
 load 403579-1.html
 load 404301-1.xhtml
 load 408753-1.xhtml
 load 411582.xhtml
 load 413180-1.html
+load 416845-1.xhtml
+load 416845-2.xhtml
+load 416845-3.html   
 load 423514-1.xhtml
diff --git a/layout/tables/nsTableFrame.cpp b/layout/tables/nsTableFrame.cpp
--- a/layout/tables/nsTableFrame.cpp
+++ b/layout/tables/nsTableFrame.cpp
@@ -1870,11 +1870,10 @@ NS_METHOD nsTableFrame::Reflow(nsPresCon
 
   // Check for an overflow list, and append any row group frames being pushed
   MoveOverflowToChildList(aPresContext);
 
   PRBool haveDesiredHeight = PR_FALSE;
-  PRBool reflowedChildren  = PR_FALSE;
   SetHaveReflowedColGroups(PR_FALSE);
 
   if (aReflowState.ComputedHeight() != NS_UNCONSTRAINEDSIZE ||
       // Also check mVResize, to handle the first Reflow preceding a
       // special height Reflow, when we've already had a special height
@@ -1923,11 +1922,10 @@ NS_METHOD nsTableFrame::Reflow(nsPresCon
     nscoord availHeight = needToInitiateSpecialReflow 
                           ? NS_UNCONSTRAINEDSIZE : aReflowState.availableHeight;
 
     ReflowTable(aDesiredSize, aReflowState, availHeight,
                 lastChildReflowed, aStatus);
-    reflowedChildren = PR_TRUE;
 
     // reevaluate special height reflow conditions
     if (GetStateBits() & NS_FRAME_CONTAINS_RELATIVE_HEIGHT)
       needToInitiateSpecialReflow = PR_TRUE;
 
@@ -1955,13 +1953,18 @@ NS_METHOD nsTableFrame::Reflow(nsPresCon
         nsMargin borderPadding = GetChildAreaOffset(&aReflowState);
         aDesiredSize.height = borderPadding.bottom + GetCellSpacingY() +
                               lastChildReflowed->GetRect().YMost();
       }
       haveDesiredHeight = PR_TRUE;
-      reflowedChildren  = PR_TRUE;
 
       mutable_rs.mFlags.mSpecialHeightReflow = PR_FALSE;
+    }
+  }
+  else {
+    // Calculate the overflow area contribution from our children.
+    for (nsIFrame* kid = GetFirstChild(nsnull); kid; kid = kid->GetNextSibling()) {
+      ConsiderChildOverflow(aDesiredSize.mOverflowArea, kid);
     }
   }
 
   aDesiredSize.width = aReflowState.ComputedWidth() +
                        aReflowState.mComputedBorderPadding.LeftRight();
@@ -1987,16 +1990,10 @@ NS_METHOD nsTableFrame::Reflow(nsPresCon
     nsMargin bcMargin = GetExcludedOuterBCBorder();
     tableRect.Inflate(bcMargin);
   }
   aDesiredSize.mOverflowArea.UnionRect(aDesiredSize.mOverflowArea, tableRect);
   
-  if (!reflowedChildren) {
-    // use the old overflow area
-     aDesiredSize.mOverflowArea.UnionRect(aDesiredSize.mOverflowArea,
-                                          GetOverflowRect());
-  }
-
   if (GetStateBits() & NS_FRAME_FIRST_REFLOW) {
     // Fulfill the promise InvalidateFrame makes.
     Invalidate(aDesiredSize.mOverflowArea);
   } else {
     CheckInvalidateSizeChange(aPresContext, aDesiredSize, aReflowState);
@@ -3334,14 +3331,13 @@ nsTableFrame::DistributeHeightToRows(con
 
         nsTableFrame::InvalidateFrame(rgFrame, origRgRect, origRgOverflowRect,
                                       PR_FALSE);
       }
     }
-    else if (amountUsed > 0 && yOriginRG != rgFrame->GetPosition().y) {
-      NS_ASSERTION(rgFrame->GetPosition().x == 0, "Unexpected position");
+    else if (amountUsed > 0 && yOriginRG != rgRect.y) {
       rgFrame->InvalidateOverflowRect();
-      rgFrame->SetPosition(nsPoint(0, yOriginRG));
+      rgFrame->SetPosition(nsPoint(rgRect.x, yOriginRG));
       // Make sure child views are properly positioned
       nsTableFrame::RePositionViews(rgFrame);
       rgFrame->InvalidateOverflowRect();
     }
     yOriginRG = yEndRG;
@@ -3495,14 +3491,13 @@ nsTableFrame::DistributeHeightToRows(con
                                       PR_FALSE);
       }
       // Make sure child views are properly positioned
       // XXX what happens if childFrame is a scroll frame and this gets skipped? see also below
     }
-    else if (amountUsed > 0 && yOriginRG != rgFrame->GetPosition().y) {
-      NS_ASSERTION(rgFrame->GetPosition().x == 0, "Unexpected position");
+    else if (amountUsed > 0 && yOriginRG != rgRect.y) {
       rgFrame->InvalidateOverflowRect();
-      rgFrame->SetPosition(nsPoint(0, yOriginRG));
+      rgFrame->SetPosition(nsPoint(rgRect.x, yOriginRG));
       // Make sure child views are properly positioned
       nsTableFrame::RePositionViews(rgFrame);
       rgFrame->InvalidateOverflowRect();
     }
     yOriginRG = yEndRG;
diff --git a/layout/tables/nsTableRowFrame.cpp b/layout/tables/nsTableRowFrame.cpp
--- a/layout/tables/nsTableRowFrame.cpp
+++ b/layout/tables/nsTableRowFrame.cpp
@@ -161,10 +161,13 @@ nsTableRowFrame::Init(nsIContent*      a
 {
   nsresult  rv;
 
   // Let the base class do its initialization
   rv = nsHTMLContainerFrame::Init(aContent, aParent, aPrevInFlow);
+
+  NS_ASSERTION(NS_STYLE_DISPLAY_TABLE_ROW == GetStyleDisplay()->mDisplay,
+               "wrong display on table row frame");
 
   if (aPrevInFlow) {
     // Set the row index
     nsTableRowFrame* rowFrame = (nsTableRowFrame*)aPrevInFlow;
     
diff --git a/layout/tables/nsTableRowGroupFrame.cpp b/layout/tables/nsTableRowGroupFrame.cpp
--- a/layout/tables/nsTableRowGroupFrame.cpp
+++ b/layout/tables/nsTableRowGroupFrame.cpp
@@ -1411,10 +1411,13 @@ nsTableRowGroupFrame::AppendFrames(nsIAt
   // collect the new row frames in an array
   nsAutoVoidArray rows;
   for (nsIFrame* rowFrame = aFrameList; rowFrame;
        rowFrame = rowFrame->GetNextSibling()) {
     if (nsGkAtoms::tableRowFrame == rowFrame->GetType()) {
+      NS_ASSERTION(NS_STYLE_DISPLAY_TABLE_ROW ==
+                     rowFrame->GetStyleDisplay()->mDisplay,
+                   "wrong display type on rowframe");      
       rows.AppendElement(rowFrame);
     }
   }
 
   PRInt32 rowIndex = GetRowCount();
@@ -1454,10 +1457,13 @@ nsTableRowGroupFrame::InsertFrames(nsIAt
   nsVoidArray rows;
   PRBool gotFirstRow = PR_FALSE;
   for (nsIFrame* rowFrame = aFrameList; rowFrame;
        rowFrame = rowFrame->GetNextSibling()) {
     if (nsGkAtoms::tableRowFrame == rowFrame->GetType()) {
+      NS_ASSERTION(NS_STYLE_DISPLAY_TABLE_ROW ==
+                     rowFrame->GetStyleDisplay()->mDisplay,
+                   "wrong display type on rowframe");      
       rows.AppendElement(rowFrame);
       if (!gotFirstRow) {
         ((nsTableRowFrame*)rowFrame)->SetFirstInserted(PR_TRUE);
         gotFirstRow = PR_TRUE;
         tableFrame->SetRowInserted(PR_TRUE);
diff --git a/layout/tools/reftest/reftest.js b/layout/tools/reftest/reftest.js
--- a/layout/tools/reftest/reftest.js
+++ b/layout/tools/reftest/reftest.js
@@ -48,10 +48,12 @@ const NS_LOCALFILEINPUTSTREAM_CONTRACTID
           "@mozilla.org/network/file-input-stream;1";
 const NS_SCRIPTSECURITYMANAGER_CONTRACTID =
           "@mozilla.org/scriptsecuritymanager;1";
 const NS_REFTESTHELPER_CONTRACTID =
           "@mozilla.org/reftest-helper;1";
+const NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX =
+          "@mozilla.org/network/protocol;1?name=";
 
 const LOAD_FAILURE_TIMEOUT = 10000; // ms
 
 var gBrowser;
 var gCanvas1, gCanvas2;
@@ -141,13 +143,22 @@ function ReadManifest(aURL)
     var fis = CC[NS_LOCALFILEINPUTSTREAM_CONTRACTID].
                   createInstance(CI.nsIFileInputStream);
     fis.init(listURL.file, -1, -1, false);
     var lis = fis.QueryInterface(CI.nsILineInputStream);
 
+    // Build the sandbox for fails-if(), etc., condition evaluation.
     var sandbox = new Components.utils.Sandbox(aURL.spec);
     for (var prop in gAutoconfVars)
         sandbox[prop] = gAutoconfVars[prop];
+    var hh = CC[NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX + "http"].
+                 getService(CI.nsIHttpProtocolHandler);
+    sandbox.http = {};
+    for each (var prop in [ "userAgent", "appName", "appVersion", 
+                            "vendor", "vendorSub", "vendorComment",
+                            "product", "productSub", "productComment",
+                            "platform", "oscpu", "language", "misc" ])
+        sandbox.http[prop] = hh[prop];
 
     var line = {value:null};
     var lineNo = 0;
     do {
         var more = lis.readLine(line);
diff --git a/layout/xul/base/src/nsGroupBoxFrame.cpp b/layout/xul/base/src/nsGroupBoxFrame.cpp
--- a/layout/xul/base/src/nsGroupBoxFrame.cpp
+++ b/layout/xul/base/src/nsGroupBoxFrame.cpp
@@ -188,11 +188,12 @@ nsGroupBoxFrame::PaintBorderBackground(n
     clipRect.height = border.top;
 
     aRenderingContext.PushState();
     aRenderingContext.SetClipRect(clipRect, nsClipCombine_kIntersect);
     nsCSSRendering::PaintBorder(presContext, aRenderingContext, this,
-                                aDirtyRect, rect, *borderStyleData, mStyleContext, skipSides);
+                                aDirtyRect, rect, *borderStyleData,
+                                mStyleContext, skipSides);
 
     aRenderingContext.PopState();
 
 
     // draw right side
@@ -202,11 +203,12 @@ nsGroupBoxFrame::PaintBorderBackground(n
     clipRect.height = border.top;
 
     aRenderingContext.PushState();
     aRenderingContext.SetClipRect(clipRect, nsClipCombine_kIntersect);
     nsCSSRendering::PaintBorder(presContext, aRenderingContext, this,
-                                aDirtyRect, rect, *borderStyleData, mStyleContext, skipSides);
+                                aDirtyRect, rect, *borderStyleData,
+                                mStyleContext, skipSides);
 
     aRenderingContext.PopState();
 
     
   
@@ -217,11 +219,12 @@ nsGroupBoxFrame::PaintBorderBackground(n
     clipRect.height = mRect.height - (yoff + border.top);
   
     aRenderingContext.PushState();
     aRenderingContext.SetClipRect(clipRect, nsClipCombine_kIntersect);
     nsCSSRendering::PaintBorder(presContext, aRenderingContext, this,
-                                aDirtyRect, rect, *borderStyleData, mStyleContext, skipSides);
+                                aDirtyRect, rect, *borderStyleData,
+                                mStyleContext, skipSides);
 
     aRenderingContext.PopState();
     
   } else {
     nsCSSRendering::PaintBorder(presContext, aRenderingContext, this,
diff --git a/layout/xul/base/src/tree/src/nsTreeBodyFrame.cpp b/layout/xul/base/src/tree/src/nsTreeBodyFrame.cpp
--- a/layout/xul/base/src/tree/src/nsTreeBodyFrame.cpp
+++ b/layout/xul/base/src/tree/src/nsTreeBodyFrame.cpp
@@ -3791,15 +3791,15 @@ nsTreeBodyFrame::PaintBackgroundLayer(ns
                                         this, aDirtyRect, aRect,
                                         *myColor, *myBorder, *myPadding,
                                         PR_TRUE);
 
   nsCSSRendering::PaintBorder(aPresContext, aRenderingContext, this,
-                              aDirtyRect, aRect, *myBorder, mStyleContext, 0);
+                              aDirtyRect, aRect, *myBorder, mStyleContext);
 
   nsCSSRendering::PaintOutline(aPresContext, aRenderingContext, this,
                                aDirtyRect, aRect, *myBorder, *myOutline,
-                               aStyleContext, 0);
+                               aStyleContext);
 }
 
 // Scrolling
 NS_IMETHODIMP nsTreeBodyFrame::EnsureRowIsVisible(PRInt32 aRow)
 {
diff --git a/modules/libfishsound/AUTHORS b/media/libfishsound/AUTHORS
rename from modules/libfishsound/AUTHORS
rename to media/libfishsound/AUTHORS
diff --git a/modules/libfishsound/COPYING b/media/libfishsound/COPYING
rename from modules/libfishsound/COPYING
rename to media/libfishsound/COPYING
diff --git a/modules/libfishsound/ChangeLog b/media/libfishsound/ChangeLog
rename from modules/libfishsound/ChangeLog
rename to media/libfishsound/ChangeLog
diff --git a/modules/libfishsound/Makefile.in b/media/libfishsound/Makefile.in
rename from modules/libfishsound/Makefile.in
rename to media/libfishsound/Makefile.in
diff --git a/modules/libfishsound/README b/media/libfishsound/README
rename from modules/libfishsound/README
rename to media/libfishsound/README
diff --git a/modules/libfishsound/README_MOZILLA b/media/libfishsound/README_MOZILLA
rename from modules/libfishsound/README_MOZILLA
rename to media/libfishsound/README_MOZILLA
diff --git a/modules/libfishsound/include/Makefile.in b/media/libfishsound/include/Makefile.in
rename from modules/libfishsound/include/Makefile.in
rename to media/libfishsound/include/Makefile.in
diff --git a/modules/libfishsound/include/fishsound/Makefile.in b/media/libfishsound/include/fishsound/Makefile.in
rename from modules/libfishsound/include/fishsound/Makefile.in
rename to media/libfishsound/include/fishsound/Makefile.in
diff --git a/modules/libfishsound/include/fishsound/comments.h b/media/libfishsound/include/fishsound/comments.h
rename from modules/libfishsound/include/fishsound/comments.h
rename to media/libfishsound/include/fishsound/comments.h
diff --git a/modules/libfishsound/include/fishsound/config.h b/media/libfishsound/include/fishsound/config.h
rename from modules/libfishsound/include/fishsound/config.h
rename to media/libfishsound/include/fishsound/config.h
diff --git a/modules/libfishsound/include/fishsound/constants.h b/media/libfishsound/include/fishsound/constants.h
rename from modules/libfishsound/include/fishsound/constants.h
rename to media/libfishsound/include/fishsound/constants.h
diff --git a/modules/libfishsound/include/fishsound/decode.h b/media/libfishsound/include/fishsound/decode.h
rename from modules/libfishsound/include/fishsound/decode.h
rename to media/libfishsound/include/fishsound/decode.h
diff --git a/modules/libfishsound/include/fishsound/deprecated.h b/media/libfishsound/include/fishsound/deprecated.h
rename from modules/libfishsound/include/fishsound/deprecated.h
rename to media/libfishsound/include/fishsound/deprecated.h
diff --git a/modules/libfishsound/include/fishsound/encode.h b/media/libfishsound/include/fishsound/encode.h
rename from modules/libfishsound/include/fishsound/encode.h
rename to media/libfishsound/include/fishsound/encode.h
diff --git a/modules/libfishsound/include/fishsound/fishsound.h b/media/libfishsound/include/fishsound/fishsound.h
rename from modules/libfishsound/include/fishsound/fishsound.h
rename to media/libfishsound/include/fishsound/fishsound.h
diff --git a/modules/libfishsound/src/Makefile.in b/media/libfishsound/src/Makefile.in
rename from modules/libfishsound/src/Makefile.in
rename to media/libfishsound/src/Makefile.in
diff --git a/modules/libfishsound/src/libfishsound/Makefile.in b/media/libfishsound/src/libfishsound/Makefile.in
rename from modules/libfishsound/src/libfishsound/Makefile.in
rename to media/libfishsound/src/libfishsound/Makefile.in
diff --git a/modules/libfishsound/src/libfishsound/config.h b/media/libfishsound/src/libfishsound/config.h
rename from modules/libfishsound/src/libfishsound/config.h
rename to media/libfishsound/src/libfishsound/config.h
diff --git a/modules/libfishsound/src/libfishsound/convert.h b/media/libfishsound/src/libfishsound/convert.h
rename from modules/libfishsound/src/libfishsound/convert.h
rename to media/libfishsound/src/libfishsound/convert.h
diff --git a/modules/libfishsound/src/libfishsound/convert_c.h b/media/libfishsound/src/libfishsound/convert_c.h
rename from modules/libfishsound/src/libfishsound/convert_c.h
rename to media/libfishsound/src/libfishsound/convert_c.h
diff --git a/modules/libfishsound/src/libfishsound/convert_oil.h b/media/libfishsound/src/libfishsound/convert_oil.h
rename from modules/libfishsound/src/libfishsound/convert_oil.h
rename to media/libfishsound/src/libfishsound/convert_oil.h
diff --git a/modules/libfishsound/src/libfishsound/fishsound.c b/media/libfishsound/src/libfishsound/fishsound.c
rename from modules/libfishsound/src/libfishsound/fishsound.c
rename to media/libfishsound/src/libfishsound/fishsound.c
diff --git a/modules/libfishsound/src/libfishsound/fishsound_comments.c b/media/libfishsound/src/libfishsound/fishsound_comments.c
rename from modules/libfishsound/src/libfishsound/fishsound_comments.c
rename to media/libfishsound/src/libfishsound/fishsound_comments.c
diff --git a/modules/libfishsound/src/libfishsound/fishsound_decode.c b/media/libfishsound/src/libfishsound/fishsound_decode.c
rename from modules/libfishsound/src/libfishsound/fishsound_decode.c
rename to media/libfishsound/src/libfishsound/fishsound_decode.c
diff --git a/modules/libfishsound/src/libfishsound/fishsound_encode.c b/media/libfishsound/src/libfishsound/fishsound_encode.c
rename from modules/libfishsound/src/libfishsound/fishsound_encode.c
rename to media/libfishsound/src/libfishsound/fishsound_encode.c
diff --git a/modules/libfishsound/src/libfishsound/fishsound_flac.c b/media/libfishsound/src/libfishsound/fishsound_flac.c
rename from modules/libfishsound/src/libfishsound/fishsound_flac.c
rename to media/libfishsound/src/libfishsound/fishsound_flac.c
diff --git a/modules/libfishsound/src/libfishsound/fishsound_speex.c b/media/libfishsound/src/libfishsound/fishsound_speex.c
rename from modules/libfishsound/src/libfishsound/fishsound_speex.c
rename to media/libfishsound/src/libfishsound/fishsound_speex.c
diff --git a/modules/libfishsound/src/libfishsound/fishsound_vorbis.c b/media/libfishsound/src/libfishsound/fishsound_vorbis.c
rename from modules/libfishsound/src/libfishsound/fishsound_vorbis.c
rename to media/libfishsound/src/libfishsound/fishsound_vorbis.c
diff --git a/modules/libfishsound/src/libfishsound/fs_compat.h b/media/libfishsound/src/libfishsound/fs_compat.h
rename from modules/libfishsound/src/libfishsound/fs_compat.h
rename to media/libfishsound/src/libfishsound/fs_compat.h
diff --git a/modules/libfishsound/src/libfishsound/fs_vector.c b/media/libfishsound/src/libfishsound/fs_vector.c
rename from modules/libfishsound/src/libfishsound/fs_vector.c
rename to media/libfishsound/src/libfishsound/fs_vector.c
diff --git a/modules/libfishsound/src/libfishsound/fs_vector.h b/media/libfishsound/src/libfishsound/fs_vector.h
rename from modules/libfishsound/src/libfishsound/fs_vector.h
rename to media/libfishsound/src/libfishsound/fs_vector.h
diff --git a/modules/libfishsound/src/libfishsound/private.h b/media/libfishsound/src/libfishsound/private.h
rename from modules/libfishsound/src/libfishsound/private.h
rename to media/libfishsound/src/libfishsound/private.h
diff --git a/modules/libfishsound/update.sh b/media/libfishsound/update.sh
rename from modules/libfishsound/update.sh
rename to media/libfishsound/update.sh
diff --git a/modules/libogg/AUTHORS b/media/libogg/AUTHORS
rename from modules/libogg/AUTHORS
rename to media/libogg/AUTHORS
diff --git a/modules/libogg/CHANGES b/media/libogg/CHANGES
rename from modules/libogg/CHANGES
rename to media/libogg/CHANGES
diff --git a/modules/libogg/COPYING b/media/libogg/COPYING
rename from modules/libogg/COPYING
rename to media/libogg/COPYING
diff --git a/modules/libogg/Makefile.in b/media/libogg/Makefile.in
rename from modules/libogg/Makefile.in
rename to media/libogg/Makefile.in
diff --git a/modules/libogg/README b/media/libogg/README
rename from modules/libogg/README
rename to media/libogg/README
diff --git a/modules/libogg/README_MOZILLA b/media/libogg/README_MOZILLA
rename from modules/libogg/README_MOZILLA
rename to media/libogg/README_MOZILLA
diff --git a/modules/libogg/include/Makefile.in b/media/libogg/include/Makefile.in
rename from modules/libogg/include/Makefile.in
rename to media/libogg/include/Makefile.in
diff --git a/modules/libogg/include/ogg/Makefile.in b/media/libogg/include/ogg/Makefile.in
rename from modules/libogg/include/ogg/Makefile.in
rename to media/libogg/include/ogg/Makefile.in
diff --git a/modules/libogg/include/ogg/config_types.h b/media/libogg/include/ogg/config_types.h
rename from modules/libogg/include/ogg/config_types.h
rename to media/libogg/include/ogg/config_types.h
diff --git a/modules/libogg/include/ogg/ogg.h b/media/libogg/include/ogg/ogg.h
rename from modules/libogg/include/ogg/ogg.h
rename to media/libogg/include/ogg/ogg.h
diff --git a/modules/libogg/include/ogg/os_types.h b/media/libogg/include/ogg/os_types.h
rename from modules/libogg/include/ogg/os_types.h
rename to media/libogg/include/ogg/os_types.h
diff --git a/modules/libogg/src/Makefile.in b/media/libogg/src/Makefile.in
rename from modules/libogg/src/Makefile.in
rename to media/libogg/src/Makefile.in
diff --git a/modules/libogg/src/bitwise.c b/media/libogg/src/bitwise.c
rename from modules/libogg/src/bitwise.c
rename to media/libogg/src/bitwise.c
diff --git a/modules/libogg/src/framing.c b/media/libogg/src/framing.c
rename from modules/libogg/src/framing.c
rename to media/libogg/src/framing.c
diff --git a/modules/libogg/src/ogg_bitwise.c b/media/libogg/src/ogg_bitwise.c
rename from modules/libogg/src/ogg_bitwise.c
rename to media/libogg/src/ogg_bitwise.c
diff --git a/modules/libogg/src/ogg_framing.c b/media/libogg/src/ogg_framing.c
rename from modules/libogg/src/ogg_framing.c
rename to media/libogg/src/ogg_framing.c
diff --git a/modules/libogg/update.sh b/media/libogg/update.sh
rename from modules/libogg/update.sh
rename to media/libogg/update.sh
diff --git a/modules/liboggplay/Makefile.in b/media/liboggplay/Makefile.in
rename from modules/liboggplay/Makefile.in
rename to media/liboggplay/Makefile.in
diff --git a/modules/liboggplay/README b/media/liboggplay/README
rename from modules/liboggplay/README
rename to media/liboggplay/README
diff --git a/modules/liboggplay/README_MOZILLA b/media/liboggplay/README_MOZILLA
rename from modules/liboggplay/README_MOZILLA
rename to media/liboggplay/README_MOZILLA
diff --git a/modules/liboggplay/include/Makefile.in b/media/liboggplay/include/Makefile.in
rename from modules/liboggplay/include/Makefile.in
rename to media/liboggplay/include/Makefile.in
diff --git a/modules/liboggplay/include/oggplay/Makefile.in b/media/liboggplay/include/oggplay/Makefile.in
rename from modules/liboggplay/include/oggplay/Makefile.in
rename to media/liboggplay/include/oggplay/Makefile.in
diff --git a/modules/liboggplay/include/oggplay/config_win32.h b/media/liboggplay/include/oggplay/config_win32.h
rename from modules/liboggplay/include/oggplay/config_win32.h
rename to media/liboggplay/include/oggplay/config_win32.h
diff --git a/modules/liboggplay/include/oggplay/oggplay.h b/media/liboggplay/include/oggplay/oggplay.h
rename from modules/liboggplay/include/oggplay/oggplay.h
rename to media/liboggplay/include/oggplay/oggplay.h
diff --git a/modules/liboggplay/include/oggplay/oggplay_callback_info.h b/media/liboggplay/include/oggplay/oggplay_callback_info.h
rename from modules/liboggplay/include/oggplay/oggplay_callback_info.h
rename to media/liboggplay/include/oggplay/oggplay_callback_info.h
diff --git a/modules/liboggplay/include/oggplay/oggplay_enums.h b/media/liboggplay/include/oggplay/oggplay_enums.h
rename from modules/liboggplay/include/oggplay/oggplay_enums.h
rename to media/liboggplay/include/oggplay/oggplay_enums.h
diff --git a/modules/liboggplay/include/oggplay/oggplay_query.h b/media/liboggplay/include/oggplay/oggplay_query.h
rename from modules/liboggplay/include/oggplay/oggplay_query.h
rename to media/liboggplay/include/oggplay/oggplay_query.h
diff --git a/modules/liboggplay/include/oggplay/oggplay_reader.h b/media/liboggplay/include/oggplay/oggplay_reader.h
rename from modules/liboggplay/include/oggplay/oggplay_reader.h
rename to media/liboggplay/include/oggplay/oggplay_reader.h
diff --git a/modules/liboggplay/include/oggplay/oggplay_seek.h b/media/liboggplay/include/oggplay/oggplay_seek.h
rename from modules/liboggplay/include/oggplay/oggplay_seek.h
rename to media/liboggplay/include/oggplay/oggplay_seek.h
diff --git a/modules/liboggplay/include/oggplay/oggplay_tools.h b/media/liboggplay/include/oggplay/oggplay_tools.h
rename from modules/liboggplay/include/oggplay/oggplay_tools.h
rename to media/liboggplay/include/oggplay/oggplay_tools.h
diff --git a/modules/liboggplay/src/Makefile.in b/media/liboggplay/src/Makefile.in
rename from modules/liboggplay/src/Makefile.in
rename to media/liboggplay/src/Makefile.in
diff --git a/modules/liboggplay/src/liboggplay/Makefile.in b/media/liboggplay/src/liboggplay/Makefile.in
rename from modules/liboggplay/src/liboggplay/Makefile.in
rename to media/liboggplay/src/liboggplay/Makefile.in
diff --git a/modules/liboggplay/src/liboggplay/config.h b/media/liboggplay/src/liboggplay/config.h
rename from modules/liboggplay/src/liboggplay/config.h
rename to media/liboggplay/src/liboggplay/config.h
diff --git a/modules/liboggplay/src/liboggplay/oggplay.c b/media/liboggplay/src/liboggplay/oggplay.c
rename from modules/liboggplay/src/liboggplay/oggplay.c
rename to media/liboggplay/src/liboggplay/oggplay.c
diff --git a/modules/liboggplay/src/liboggplay/oggplay_buffer.c b/media/liboggplay/src/liboggplay/oggplay_buffer.c
rename from modules/liboggplay/src/liboggplay/oggplay_buffer.c
rename to media/liboggplay/src/liboggplay/oggplay_buffer.c
diff --git a/modules/liboggplay/src/liboggplay/oggplay_buffer.h b/media/liboggplay/src/liboggplay/oggplay_buffer.h
rename from modules/liboggplay/src/liboggplay/oggplay_buffer.h
rename to media/liboggplay/src/liboggplay/oggplay_buffer.h
diff --git a/modules/liboggplay/src/liboggplay/oggplay_callback.c b/media/liboggplay/src/liboggplay/oggplay_callback.c
rename from modules/liboggplay/src/liboggplay/oggplay_callback.c
rename to media/liboggplay/src/liboggplay/oggplay_callback.c
diff --git a/modules/liboggplay/src/liboggplay/oggplay_callback.h b/media/liboggplay/src/liboggplay/oggplay_callback.h
rename from modules/liboggplay/src/liboggplay/oggplay_callback.h
rename to media/liboggplay/src/liboggplay/oggplay_callback.h
diff --git a/modules/liboggplay/src/liboggplay/oggplay_callback_info.c b/media/liboggplay/src/liboggplay/oggplay_callback_info.c
rename from modules/liboggplay/src/liboggplay/oggplay_callback_info.c
rename to media/liboggplay/src/liboggplay/oggplay_callback_info.c
diff --git a/modules/liboggplay/src/liboggplay/oggplay_data.c b/media/liboggplay/src/liboggplay/oggplay_data.c
rename from modules/liboggplay/src/liboggplay/oggplay_data.c
rename to media/liboggplay/src/liboggplay/oggplay_data.c
diff --git a/modules/liboggplay/src/liboggplay/oggplay_data.h b/media/liboggplay/src/liboggplay/oggplay_data.h
rename from modules/liboggplay/src/liboggplay/oggplay_data.h
rename to media/liboggplay/src/liboggplay/oggplay_data.h
diff --git a/modules/liboggplay/src/liboggplay/oggplay_file_reader.c b/media/liboggplay/src/liboggplay/oggplay_file_reader.c
rename from modules/liboggplay/src/liboggplay/oggplay_file_reader.c
rename to media/liboggplay/src/liboggplay/oggplay_file_reader.c
diff --git a/modules/liboggplay/src/liboggplay/oggplay_file_reader.h b/media/liboggplay/src/liboggplay/oggplay_file_reader.h
rename from modules/liboggplay/src/liboggplay/oggplay_file_reader.h
rename to media/liboggplay/src/liboggplay/oggplay_file_reader.h
diff --git a/modules/liboggplay/src/liboggplay/oggplay_private.h b/media/liboggplay/src/liboggplay/oggplay_private.h
rename from modules/liboggplay/src/liboggplay/oggplay_private.h
rename to media/liboggplay/src/liboggplay/oggplay_private.h
diff --git a/modules/liboggplay/src/liboggplay/oggplay_query.c b/media/liboggplay/src/liboggplay/oggplay_query.c
rename from modules/liboggplay/src/liboggplay/oggplay_query.c
rename to media/liboggplay/src/liboggplay/oggplay_query.c
diff --git a/modules/liboggplay/src/liboggplay/oggplay_seek.c b/media/liboggplay/src/liboggplay/oggplay_seek.c
rename from modules/liboggplay/src/liboggplay/oggplay_seek.c
rename to media/liboggplay/src/liboggplay/oggplay_seek.c
diff --git a/modules/liboggplay/src/liboggplay/oggplay_tcp_reader.c b/media/liboggplay/src/liboggplay/oggplay_tcp_reader.c
rename from modules/liboggplay/src/liboggplay/oggplay_tcp_reader.c
rename to media/liboggplay/src/liboggplay/oggplay_tcp_reader.c
diff --git a/modules/liboggplay/src/liboggplay/oggplay_tcp_reader.h b/media/liboggplay/src/liboggplay/oggplay_tcp_reader.h
rename from modules/liboggplay/src/liboggplay/oggplay_tcp_reader.h
rename to media/liboggplay/src/liboggplay/oggplay_tcp_reader.h
diff --git a/modules/liboggplay/src/liboggplay/oggplay_tools.c b/media/liboggplay/src/liboggplay/oggplay_tools.c
rename from modules/liboggplay/src/liboggplay/oggplay_tools.c
rename to media/liboggplay/src/liboggplay/oggplay_tools.c
diff --git a/modules/liboggplay/src/liboggplay/oggplay_yuv2rgb.c b/media/liboggplay/src/liboggplay/oggplay_yuv2rgb.c
rename from modules/liboggplay/src/liboggplay/oggplay_yuv2rgb.c
rename to media/liboggplay/src/liboggplay/oggplay_yuv2rgb.c
diff --git a/modules/liboggplay/src/liboggplay/std_semaphore.h b/media/liboggplay/src/liboggplay/std_semaphore.h
rename from modules/liboggplay/src/liboggplay/std_semaphore.h
rename to media/liboggplay/src/liboggplay/std_semaphore.h
diff --git a/modules/liboggplay/update.sh b/media/liboggplay/update.sh
rename from modules/liboggplay/update.sh
rename to media/liboggplay/update.sh
diff --git a/modules/liboggplay_audio/Makefile.in b/media/liboggplay_audio/Makefile.in
rename from modules/liboggplay_audio/Makefile.in
rename to media/liboggplay_audio/Makefile.in
diff --git a/modules/liboggplay_audio/README_MOZILLA b/media/liboggplay_audio/README_MOZILLA
rename from modules/liboggplay_audio/README_MOZILLA
rename to media/liboggplay_audio/README_MOZILLA
diff --git a/modules/liboggplay_audio/sydney_audio.h b/media/liboggplay_audio/sydney_audio.h
rename from modules/liboggplay_audio/sydney_audio.h
rename to media/liboggplay_audio/sydney_audio.h
diff --git a/modules/liboggplay_audio/sydney_audio_alsa.c b/media/liboggplay_audio/sydney_audio_alsa.c
rename from modules/liboggplay_audio/sydney_audio_alsa.c
rename to media/liboggplay_audio/sydney_audio_alsa.c
diff --git a/modules/liboggplay_audio/sydney_audio_mac.c b/media/liboggplay_audio/sydney_audio_mac.c
rename from modules/liboggplay_audio/sydney_audio_mac.c
rename to media/liboggplay_audio/sydney_audio_mac.c
diff --git a/modules/liboggplay_audio/sydney_audio_oss.c b/media/liboggplay_audio/sydney_audio_oss.c
rename from modules/liboggplay_audio/sydney_audio_oss.c
rename to media/liboggplay_audio/sydney_audio_oss.c
diff --git a/modules/liboggplay_audio/sydney_audio_waveapi.c b/media/liboggplay_audio/sydney_audio_waveapi.c
rename from modules/liboggplay_audio/sydney_audio_waveapi.c
rename to media/liboggplay_audio/sydney_audio_waveapi.c
diff --git a/modules/liboggplay_audio/update.sh b/media/liboggplay_audio/update.sh
rename from modules/liboggplay_audio/update.sh
rename to media/liboggplay_audio/update.sh
diff --git a/modules/liboggz/AUTHORS b/media/liboggz/AUTHORS
rename from modules/liboggz/AUTHORS
rename to media/liboggz/AUTHORS
diff --git a/modules/liboggz/COPYING b/media/liboggz/COPYING
rename from modules/liboggz/COPYING
rename to media/liboggz/COPYING
diff --git a/modules/liboggz/ChangeLog b/media/liboggz/ChangeLog
rename from modules/liboggz/ChangeLog
rename to media/liboggz/ChangeLog
diff --git a/modules/liboggz/Makefile.in b/media/liboggz/Makefile.in
rename from modules/liboggz/Makefile.in
rename to media/liboggz/Makefile.in
diff --git a/modules/liboggz/README b/media/liboggz/README
rename from modules/liboggz/README
rename to media/liboggz/README
diff --git a/modules/liboggz/README_MOZILLA b/media/liboggz/README_MOZILLA
rename from modules/liboggz/README_MOZILLA
rename to media/liboggz/README_MOZILLA
diff --git a/modules/liboggz/include/Makefile.in b/media/liboggz/include/Makefile.in
rename from modules/liboggz/include/Makefile.in
rename to media/liboggz/include/Makefile.in
diff --git a/modules/liboggz/include/oggz/Makefile.in b/media/liboggz/include/oggz/Makefile.in
rename from modules/liboggz/include/oggz/Makefile.in
rename to media/liboggz/include/oggz/Makefile.in
diff --git a/modules/liboggz/include/oggz/config.h b/media/liboggz/include/oggz/config.h
rename from modules/liboggz/include/oggz/config.h
rename to media/liboggz/include/oggz/config.h
diff --git a/modules/liboggz/include/oggz/config_win32.h b/media/liboggz/include/oggz/config_win32.h
rename from modules/liboggz/include/oggz/config_win32.h
rename to media/liboggz/include/oggz/config_win32.h
diff --git a/modules/liboggz/include/oggz/oggz.h b/media/liboggz/include/oggz/oggz.h
rename from modules/liboggz/include/oggz/oggz.h
rename to media/liboggz/include/oggz/oggz.h
diff --git a/modules/liboggz/include/oggz/oggz_comments.h b/media/liboggz/include/oggz/oggz_comments.h
rename from modules/liboggz/include/oggz/oggz_comments.h
rename to media/liboggz/include/oggz/oggz_comments.h
diff --git a/modules/liboggz/include/oggz/oggz_constants.h b/media/liboggz/include/oggz/oggz_constants.h
rename from modules/liboggz/include/oggz/oggz_constants.h
rename to media/liboggz/include/oggz/oggz_constants.h
diff --git a/modules/liboggz/include/oggz/oggz_deprecated.h b/media/liboggz/include/oggz/oggz_deprecated.h
rename from modules/liboggz/include/oggz/oggz_deprecated.h
rename to media/liboggz/include/oggz/oggz_deprecated.h
diff --git a/modules/liboggz/include/oggz/oggz_io.h b/media/liboggz/include/oggz/oggz_io.h
rename from modules/liboggz/include/oggz/oggz_io.h
rename to media/liboggz/include/oggz/oggz_io.h
diff --git a/modules/liboggz/include/oggz/oggz_off_t.h b/media/liboggz/include/oggz/oggz_off_t.h
rename from modules/liboggz/include/oggz/oggz_off_t.h
rename to media/liboggz/include/oggz/oggz_off_t.h
diff --git a/modules/liboggz/include/oggz/oggz_off_t_generated.h b/media/liboggz/include/oggz/oggz_off_t_generated.h
rename from modules/liboggz/include/oggz/oggz_off_t_generated.h
rename to media/liboggz/include/oggz/oggz_off_t_generated.h
diff --git a/modules/liboggz/include/oggz/oggz_read.h b/media/liboggz/include/oggz/oggz_read.h
rename from modules/liboggz/include/oggz/oggz_read.h
rename to media/liboggz/include/oggz/oggz_read.h
diff --git a/modules/liboggz/include/oggz/oggz_seek.h b/media/liboggz/include/oggz/oggz_seek.h
rename from modules/liboggz/include/oggz/oggz_seek.h
rename to media/liboggz/include/oggz/oggz_seek.h
diff --git a/modules/liboggz/include/oggz/oggz_stream.h b/media/liboggz/include/oggz/oggz_stream.h
rename from modules/liboggz/include/oggz/oggz_stream.h
rename to media/liboggz/include/oggz/oggz_stream.h
diff --git a/modules/liboggz/include/oggz/oggz_table.h b/media/liboggz/include/oggz/oggz_table.h
rename from modules/liboggz/include/oggz/oggz_table.h
rename to media/liboggz/include/oggz/oggz_table.h
diff --git a/modules/liboggz/include/oggz/oggz_write.h b/media/liboggz/include/oggz/oggz_write.h
rename from modules/liboggz/include/oggz/oggz_write.h
rename to media/liboggz/include/oggz/oggz_write.h
diff --git a/modules/liboggz/src/Makefile.in b/media/liboggz/src/Makefile.in
rename from modules/liboggz/src/Makefile.in
rename to media/liboggz/src/Makefile.in
diff --git a/modules/liboggz/src/liboggz/Makefile.in b/media/liboggz/src/liboggz/Makefile.in
rename from modules/liboggz/src/liboggz/Makefile.in
rename to media/liboggz/src/liboggz/Makefile.in
diff --git a/modules/liboggz/src/liboggz/metric_internal.c b/media/liboggz/src/liboggz/metric_internal.c
rename from modules/liboggz/src/liboggz/metric_internal.c
rename to media/liboggz/src/liboggz/metric_internal.c
diff --git a/modules/liboggz/src/liboggz/oggz.c b/media/liboggz/src/liboggz/oggz.c
rename from modules/liboggz/src/liboggz/oggz.c
rename to media/liboggz/src/liboggz/oggz.c
diff --git a/modules/liboggz/src/liboggz/oggz_auto.c b/media/liboggz/src/liboggz/oggz_auto.c
rename from modules/liboggz/src/liboggz/oggz_auto.c
rename to media/liboggz/src/liboggz/oggz_auto.c
diff --git a/modules/liboggz/src/liboggz/oggz_auto.h b/media/liboggz/src/liboggz/oggz_auto.h
rename from modules/liboggz/src/liboggz/oggz_auto.h
rename to media/liboggz/src/liboggz/oggz_auto.h
diff --git a/modules/liboggz/src/liboggz/oggz_byteorder.h b/media/liboggz/src/liboggz/oggz_byteorder.h
rename from modules/liboggz/src/liboggz/oggz_byteorder.h
rename to media/liboggz/src/liboggz/oggz_byteorder.h
diff --git a/modules/liboggz/src/liboggz/oggz_comments.c b/media/liboggz/src/liboggz/oggz_comments.c
rename from modules/liboggz/src/liboggz/oggz_comments.c
rename to media/liboggz/src/liboggz/oggz_comments.c
diff --git a/modules/liboggz/src/liboggz/oggz_compat.h b/media/liboggz/src/liboggz/oggz_compat.h
rename from modules/liboggz/src/liboggz/oggz_compat.h
rename to media/liboggz/src/liboggz/oggz_compat.h
diff --git a/modules/liboggz/src/liboggz/oggz_dlist.c b/media/liboggz/src/liboggz/oggz_dlist.c
rename from modules/liboggz/src/liboggz/oggz_dlist.c
rename to media/liboggz/src/liboggz/oggz_dlist.c
diff --git a/modules/liboggz/src/liboggz/oggz_dlist.h b/media/liboggz/src/liboggz/oggz_dlist.h
rename from modules/liboggz/src/liboggz/oggz_dlist.h
rename to media/liboggz/src/liboggz/oggz_dlist.h
diff --git a/modules/liboggz/src/liboggz/oggz_io.c b/media/liboggz/src/liboggz/oggz_io.c
rename from modules/liboggz/src/liboggz/oggz_io.c
rename to media/liboggz/src/liboggz/oggz_io.c
diff --git a/modules/liboggz/src/liboggz/oggz_macros.h b/media/liboggz/src/liboggz/oggz_macros.h
rename from modules/liboggz/src/liboggz/oggz_macros.h
rename to media/liboggz/src/liboggz/oggz_macros.h
diff --git a/modules/liboggz/src/liboggz/oggz_private.h b/media/liboggz/src/liboggz/oggz_private.h
rename from modules/liboggz/src/liboggz/oggz_private.h
rename to media/liboggz/src/liboggz/oggz_private.h
diff --git a/modules/liboggz/src/liboggz/oggz_read.c b/media/liboggz/src/liboggz/oggz_read.c
rename from modules/liboggz/src/liboggz/oggz_read.c
rename to media/liboggz/src/liboggz/oggz_read.c
diff --git a/modules/liboggz/src/liboggz/oggz_seek.c b/media/liboggz/src/liboggz/oggz_seek.c
rename from modules/liboggz/src/liboggz/oggz_seek.c
rename to media/liboggz/src/liboggz/oggz_seek.c
diff --git a/modules/liboggz/src/liboggz/oggz_stream.c b/media/liboggz/src/liboggz/oggz_stream.c
rename from modules/liboggz/src/liboggz/oggz_stream.c
rename to media/liboggz/src/liboggz/oggz_stream.c
diff --git a/modules/liboggz/src/liboggz/oggz_stream.h b/media/liboggz/src/liboggz/oggz_stream.h
rename from modules/liboggz/src/liboggz/oggz_stream.h
rename to media/liboggz/src/liboggz/oggz_stream.h
diff --git a/modules/liboggz/src/liboggz/oggz_stream_private.h b/media/liboggz/src/liboggz/oggz_stream_private.h
rename from modules/liboggz/src/liboggz/oggz_stream_private.h
rename to media/liboggz/src/liboggz/oggz_stream_private.h
diff --git a/modules/liboggz/src/liboggz/oggz_table.c b/media/liboggz/src/liboggz/oggz_table.c
rename from modules/liboggz/src/liboggz/oggz_table.c
rename to media/liboggz/src/liboggz/oggz_table.c
diff --git a/modules/liboggz/src/liboggz/oggz_vector.c b/media/liboggz/src/liboggz/oggz_vector.c
rename from modules/liboggz/src/liboggz/oggz_vector.c
rename to media/liboggz/src/liboggz/oggz_vector.c
diff --git a/modules/liboggz/src/liboggz/oggz_vector.h b/media/liboggz/src/liboggz/oggz_vector.h
rename from modules/liboggz/src/liboggz/oggz_vector.h
rename to media/liboggz/src/liboggz/oggz_vector.h
diff --git a/modules/liboggz/src/liboggz/oggz_write.c b/media/liboggz/src/liboggz/oggz_write.c
rename from modules/liboggz/src/liboggz/oggz_write.c
rename to media/liboggz/src/liboggz/oggz_write.c
diff --git a/modules/liboggz/update.sh b/media/liboggz/update.sh
rename from modules/liboggz/update.sh
rename to media/liboggz/update.sh
diff --git a/modules/libtheora/AUTHORS b/media/libtheora/AUTHORS
rename from modules/libtheora/AUTHORS
rename to media/libtheora/AUTHORS
diff --git a/modules/libtheora/CHANGES b/media/libtheora/CHANGES
rename from modules/libtheora/CHANGES
rename to media/libtheora/CHANGES
diff --git a/modules/libtheora/COPYING b/media/libtheora/COPYING
rename from modules/libtheora/COPYING
rename to media/libtheora/COPYING
diff --git a/modules/libtheora/LICENSE b/media/libtheora/LICENSE
rename from modules/libtheora/LICENSE
rename to media/libtheora/LICENSE
diff --git a/modules/libtheora/Makefile.in b/media/libtheora/Makefile.in
rename from modules/libtheora/Makefile.in
rename to media/libtheora/Makefile.in
diff --git a/modules/libtheora/README b/media/libtheora/README
rename from modules/libtheora/README
rename to media/libtheora/README
diff --git a/modules/libtheora/README_MOZILLA b/media/libtheora/README_MOZILLA
rename from modules/libtheora/README_MOZILLA
rename to media/libtheora/README_MOZILLA
diff --git a/modules/libtheora/changeset_r15144.diff b/media/libtheora/changeset_r15144.diff
rename from modules/libtheora/changeset_r15144.diff
rename to media/libtheora/changeset_r15144.diff
diff --git a/modules/libtheora/include/Makefile.in b/media/libtheora/include/Makefile.in
rename from modules/libtheora/include/Makefile.in
rename to media/libtheora/include/Makefile.in
diff --git a/modules/libtheora/include/theora/Makefile.in b/media/libtheora/include/theora/Makefile.in
rename from modules/libtheora/include/theora/Makefile.in
rename to media/libtheora/include/theora/Makefile.in
diff --git a/modules/libtheora/include/theora/codec.h b/media/libtheora/include/theora/codec.h
rename from modules/libtheora/include/theora/codec.h
rename to media/libtheora/include/theora/codec.h
diff --git a/modules/libtheora/include/theora/config.h b/media/libtheora/include/theora/config.h
rename from modules/libtheora/include/theora/config.h
rename to media/libtheora/include/theora/config.h
diff --git a/modules/libtheora/include/theora/theora.h b/media/libtheora/include/theora/theora.h
rename from modules/libtheora/include/theora/theora.h
rename to media/libtheora/include/theora/theora.h
diff --git a/modules/libtheora/include/theora/theoradec.h b/media/libtheora/include/theora/theoradec.h
rename from modules/libtheora/include/theora/theoradec.h
rename to media/libtheora/include/theora/theoradec.h
diff --git a/modules/libtheora/lib/Makefile.in b/media/libtheora/lib/Makefile.in
rename from modules/libtheora/lib/Makefile.in
rename to media/libtheora/lib/Makefile.in
diff --git a/modules/libtheora/lib/config.h b/media/libtheora/lib/config.h
rename from modules/libtheora/lib/config.h
rename to media/libtheora/lib/config.h
diff --git a/modules/libtheora/lib/cpu.c b/media/libtheora/lib/cpu.c
rename from modules/libtheora/lib/cpu.c
rename to media/libtheora/lib/cpu.c
diff --git a/modules/libtheora/lib/cpu.h b/media/libtheora/lib/cpu.h
rename from modules/libtheora/lib/cpu.h
rename to media/libtheora/lib/cpu.h
diff --git a/modules/libtheora/lib/dec/apiwrapper.c b/media/libtheora/lib/dec/apiwrapper.c
rename from modules/libtheora/lib/dec/apiwrapper.c
rename to media/libtheora/lib/dec/apiwrapper.c
diff --git a/modules/libtheora/lib/dec/apiwrapper.h b/media/libtheora/lib/dec/apiwrapper.h
rename from modules/libtheora/lib/dec/apiwrapper.h
rename to media/libtheora/lib/dec/apiwrapper.h
diff --git a/modules/libtheora/lib/dec/bitwise.c b/media/libtheora/lib/dec/bitwise.c
rename from modules/libtheora/lib/dec/bitwise.c
rename to media/libtheora/lib/dec/bitwise.c
diff --git a/modules/libtheora/lib/dec/bitwise.h b/media/libtheora/lib/dec/bitwise.h
rename from modules/libtheora/lib/dec/bitwise.h
rename to media/libtheora/lib/dec/bitwise.h
diff --git a/modules/libtheora/lib/dec/dct.h b/media/libtheora/lib/dec/dct.h
rename from modules/libtheora/lib/dec/dct.h
rename to media/libtheora/lib/dec/dct.h
diff --git a/modules/libtheora/lib/dec/decapiwrapper.c b/media/libtheora/lib/dec/decapiwrapper.c
rename from modules/libtheora/lib/dec/decapiwrapper.c
rename to media/libtheora/lib/dec/decapiwrapper.c
diff --git a/modules/libtheora/lib/dec/decinfo.c b/media/libtheora/lib/dec/decinfo.c
rename from modules/libtheora/lib/dec/decinfo.c
rename to media/libtheora/lib/dec/decinfo.c
diff --git a/modules/libtheora/lib/dec/decint.h b/media/libtheora/lib/dec/decint.h
rename from modules/libtheora/lib/dec/decint.h
rename to media/libtheora/lib/dec/decint.h
diff --git a/modules/libtheora/lib/dec/decode.c b/media/libtheora/lib/dec/decode.c
rename from modules/libtheora/lib/dec/decode.c
rename to media/libtheora/lib/dec/decode.c
diff --git a/modules/libtheora/lib/dec/dequant.c b/media/libtheora/lib/dec/dequant.c
rename from modules/libtheora/lib/dec/dequant.c
rename to media/libtheora/lib/dec/dequant.c
diff --git a/modules/libtheora/lib/dec/dequant.h b/media/libtheora/lib/dec/dequant.h
rename from modules/libtheora/lib/dec/dequant.h
rename to media/libtheora/lib/dec/dequant.h
diff --git a/modules/libtheora/lib/dec/enquant.h b/media/libtheora/lib/dec/enquant.h
rename from modules/libtheora/lib/dec/enquant.h
rename to media/libtheora/lib/dec/enquant.h
diff --git a/modules/libtheora/lib/dec/fragment.c b/media/libtheora/lib/dec/fragment.c
rename from modules/libtheora/lib/dec/fragment.c
rename to media/libtheora/lib/dec/fragment.c
diff --git a/modules/libtheora/lib/dec/huffdec.c b/media/libtheora/lib/dec/huffdec.c
rename from modules/libtheora/lib/dec/huffdec.c
rename to media/libtheora/lib/dec/huffdec.c
diff --git a/modules/libtheora/lib/dec/huffdec.h b/media/libtheora/lib/dec/huffdec.h
rename from modules/libtheora/lib/dec/huffdec.h
rename to media/libtheora/lib/dec/huffdec.h
diff --git a/modules/libtheora/lib/dec/huffman.h b/media/libtheora/lib/dec/huffman.h
rename from modules/libtheora/lib/dec/huffman.h
rename to media/libtheora/lib/dec/huffman.h
diff --git a/modules/libtheora/lib/dec/idct.c b/media/libtheora/lib/dec/idct.c
rename from modules/libtheora/lib/dec/idct.c
rename to media/libtheora/lib/dec/idct.c
diff --git a/modules/libtheora/lib/dec/idct.h b/media/libtheora/lib/dec/idct.h
rename from modules/libtheora/lib/dec/idct.h
rename to media/libtheora/lib/dec/idct.h
diff --git a/modules/libtheora/lib/dec/info.c b/media/libtheora/lib/dec/info.c
rename from modules/libtheora/lib/dec/info.c
rename to media/libtheora/lib/dec/info.c
diff --git a/modules/libtheora/lib/dec/internal.c b/media/libtheora/lib/dec/internal.c
rename from modules/libtheora/lib/dec/internal.c
rename to media/libtheora/lib/dec/internal.c
diff --git a/modules/libtheora/lib/dec/ocintrin.h b/media/libtheora/lib/dec/ocintrin.h
rename from modules/libtheora/lib/dec/ocintrin.h
rename to media/libtheora/lib/dec/ocintrin.h
diff --git a/modules/libtheora/lib/dec/quant.c b/media/libtheora/lib/dec/quant.c
rename from modules/libtheora/lib/dec/quant.c
rename to media/libtheora/lib/dec/quant.c
diff --git a/modules/libtheora/lib/dec/quant.h b/media/libtheora/lib/dec/quant.h
rename from modules/libtheora/lib/dec/quant.h
rename to media/libtheora/lib/dec/quant.h
diff --git a/modules/libtheora/lib/dec/state.c b/media/libtheora/lib/dec/state.c
rename from modules/libtheora/lib/dec/state.c
rename to media/libtheora/lib/dec/state.c
diff --git a/modules/libtheora/lib/dec/x86/mmxfrag.c b/media/libtheora/lib/dec/x86/mmxfrag.c
rename from modules/libtheora/lib/dec/x86/mmxfrag.c
rename to media/libtheora/lib/dec/x86/mmxfrag.c
diff --git a/modules/libtheora/lib/dec/x86/mmxidct.c b/media/libtheora/lib/dec/x86/mmxidct.c
rename from modules/libtheora/lib/dec/x86/mmxidct.c
rename to media/libtheora/lib/dec/x86/mmxidct.c
diff --git a/modules/libtheora/lib/dec/x86/mmxstate.c b/media/libtheora/lib/dec/x86/mmxstate.c
rename from modules/libtheora/lib/dec/x86/mmxstate.c
rename to media/libtheora/lib/dec/x86/mmxstate.c
diff --git a/modules/libtheora/lib/dec/x86/x86int.h b/media/libtheora/lib/dec/x86/x86int.h
rename from modules/libtheora/lib/dec/x86/x86int.h
rename to media/libtheora/lib/dec/x86/x86int.h
diff --git a/modules/libtheora/lib/dec/x86/x86state.c b/media/libtheora/lib/dec/x86/x86state.c
rename from modules/libtheora/lib/dec/x86/x86state.c
rename to media/libtheora/lib/dec/x86/x86state.c
diff --git a/modules/libtheora/lib/internal.h b/media/libtheora/lib/internal.h
rename from modules/libtheora/lib/internal.h
rename to media/libtheora/lib/internal.h
diff --git a/modules/libtheora/update.sh b/media/libtheora/update.sh
rename from modules/libtheora/update.sh
rename to media/libtheora/update.sh
diff --git a/modules/libvorbis/AUTHORS b/media/libvorbis/AUTHORS
rename from modules/libvorbis/AUTHORS
rename to media/libvorbis/AUTHORS
diff --git a/modules/libvorbis/COPYING b/media/libvorbis/COPYING
rename from modules/libvorbis/COPYING
rename to media/libvorbis/COPYING
diff --git a/modules/libvorbis/Makefile.in b/media/libvorbis/Makefile.in
rename from modules/libvorbis/Makefile.in
rename to media/libvorbis/Makefile.in
diff --git a/modules/libvorbis/README b/media/libvorbis/README
rename from modules/libvorbis/README
rename to media/libvorbis/README
diff --git a/modules/libvorbis/README_MOZILLA b/media/libvorbis/README_MOZILLA
rename from modules/libvorbis/README_MOZILLA
rename to media/libvorbis/README_MOZILLA
diff --git a/modules/libvorbis/include/Makefile.in b/media/libvorbis/include/Makefile.in
rename from modules/libvorbis/include/Makefile.in
rename to media/libvorbis/include/Makefile.in
diff --git a/modules/libvorbis/include/vorbis/Makefile.in b/media/libvorbis/include/vorbis/Makefile.in
rename from modules/libvorbis/include/vorbis/Makefile.in
rename to media/libvorbis/include/vorbis/Makefile.in
diff --git a/modules/libvorbis/include/vorbis/codec.h b/media/libvorbis/include/vorbis/codec.h
rename from modules/libvorbis/include/vorbis/codec.h
rename to media/libvorbis/include/vorbis/codec.h
diff --git a/modules/libvorbis/lib/Makefile.in b/media/libvorbis/lib/Makefile.in
rename from modules/libvorbis/lib/Makefile.in
rename to media/libvorbis/lib/Makefile.in
diff --git a/modules/libvorbis/lib/backends.h b/media/libvorbis/lib/backends.h
rename from modules/libvorbis/lib/backends.h
rename to media/libvorbis/lib/backends.h
diff --git a/modules/libvorbis/lib/bitrate.h b/media/libvorbis/lib/bitrate.h
rename from modules/libvorbis/lib/bitrate.h
rename to media/libvorbis/lib/bitrate.h
diff --git a/modules/libvorbis/lib/codebook.h b/media/libvorbis/lib/codebook.h
rename from modules/libvorbis/lib/codebook.h
rename to media/libvorbis/lib/codebook.h
diff --git a/modules/libvorbis/lib/codec_internal.h b/media/libvorbis/lib/codec_internal.h
rename from modules/libvorbis/lib/codec_internal.h
rename to media/libvorbis/lib/codec_internal.h
diff --git a/modules/libvorbis/lib/envelope.h b/media/libvorbis/lib/envelope.h
rename from modules/libvorbis/lib/envelope.h
rename to media/libvorbis/lib/envelope.h
diff --git a/modules/libvorbis/lib/highlevel.h b/media/libvorbis/lib/highlevel.h
rename from modules/libvorbis/lib/highlevel.h
rename to media/libvorbis/lib/highlevel.h
diff --git a/modules/libvorbis/lib/lookup.h b/media/libvorbis/lib/lookup.h
rename from modules/libvorbis/lib/lookup.h
rename to media/libvorbis/lib/lookup.h
diff --git a/modules/libvorbis/lib/lookup_data.h b/media/libvorbis/lib/lookup_data.h
rename from modules/libvorbis/lib/lookup_data.h
rename to media/libvorbis/lib/lookup_data.h
diff --git a/modules/libvorbis/lib/lpc.h b/media/libvorbis/lib/lpc.h
rename from modules/libvorbis/lib/lpc.h
rename to media/libvorbis/lib/lpc.h
diff --git a/modules/libvorbis/lib/lsp.h b/media/libvorbis/lib/lsp.h
rename from modules/libvorbis/lib/lsp.h
rename to media/libvorbis/lib/lsp.h
diff --git a/modules/libvorbis/lib/masking.h b/media/libvorbis/lib/masking.h
rename from modules/libvorbis/lib/masking.h
rename to media/libvorbis/lib/masking.h
diff --git a/modules/libvorbis/lib/mdct.h b/media/libvorbis/lib/mdct.h
rename from modules/libvorbis/lib/mdct.h
rename to media/libvorbis/lib/mdct.h
diff --git a/modules/libvorbis/lib/misc.h b/media/libvorbis/lib/misc.h
rename from modules/libvorbis/lib/misc.h
rename to media/libvorbis/lib/misc.h
diff --git a/modules/libvorbis/lib/os.h b/media/libvorbis/lib/os.h
rename from modules/libvorbis/lib/os.h
rename to media/libvorbis/lib/os.h
diff --git a/modules/libvorbis/lib/psy.h b/media/libvorbis/lib/psy.h
rename from modules/libvorbis/lib/psy.h
rename to media/libvorbis/lib/psy.h
diff --git a/modules/libvorbis/lib/registry.h b/media/libvorbis/lib/registry.h
rename from modules/libvorbis/lib/registry.h
rename to media/libvorbis/lib/registry.h
diff --git a/modules/libvorbis/lib/scales.h b/media/libvorbis/lib/scales.h
rename from modules/libvorbis/lib/scales.h
rename to media/libvorbis/lib/scales.h
diff --git a/modules/libvorbis/lib/smallft.h b/media/libvorbis/lib/smallft.h
rename from modules/libvorbis/lib/smallft.h
rename to media/libvorbis/lib/smallft.h
diff --git a/modules/libvorbis/lib/vorbis_analysis.c b/media/libvorbis/lib/vorbis_analysis.c
rename from modules/libvorbis/lib/vorbis_analysis.c
rename to media/libvorbis/lib/vorbis_analysis.c
diff --git a/modules/libvorbis/lib/vorbis_bitrate.c b/media/libvorbis/lib/vorbis_bitrate.c
rename from modules/libvorbis/lib/vorbis_bitrate.c
rename to media/libvorbis/lib/vorbis_bitrate.c
diff --git a/modules/libvorbis/lib/vorbis_block.c b/media/libvorbis/lib/vorbis_block.c
rename from modules/libvorbis/lib/vorbis_block.c
rename to media/libvorbis/lib/vorbis_block.c
diff --git a/modules/libvorbis/lib/vorbis_codebook.c b/media/libvorbis/lib/vorbis_codebook.c
rename from modules/libvorbis/lib/vorbis_codebook.c
rename to media/libvorbis/lib/vorbis_codebook.c
diff --git a/modules/libvorbis/lib/vorbis_envelope.c b/media/libvorbis/lib/vorbis_envelope.c
rename from modules/libvorbis/lib/vorbis_envelope.c
rename to media/libvorbis/lib/vorbis_envelope.c
diff --git a/modules/libvorbis/lib/vorbis_floor0.c b/media/libvorbis/lib/vorbis_floor0.c
rename from modules/libvorbis/lib/vorbis_floor0.c
rename to media/libvorbis/lib/vorbis_floor0.c
diff --git a/modules/libvorbis/lib/vorbis_floor1.c b/media/libvorbis/lib/vorbis_floor1.c
rename from modules/libvorbis/lib/vorbis_floor1.c
rename to media/libvorbis/lib/vorbis_floor1.c
diff --git a/modules/libvorbis/lib/vorbis_info.c b/media/libvorbis/lib/vorbis_info.c
rename from modules/libvorbis/lib/vorbis_info.c
rename to media/libvorbis/lib/vorbis_info.c
diff --git a/modules/libvorbis/lib/vorbis_lookup.c b/media/libvorbis/lib/vorbis_lookup.c
rename from modules/libvorbis/lib/vorbis_lookup.c
rename to media/libvorbis/lib/vorbis_lookup.c
diff --git a/modules/libvorbis/lib/vorbis_lpc.c b/media/libvorbis/lib/vorbis_lpc.c
rename from modules/libvorbis/lib/vorbis_lpc.c
rename to media/libvorbis/lib/vorbis_lpc.c
diff --git a/modules/libvorbis/lib/vorbis_lsp.c b/media/libvorbis/lib/vorbis_lsp.c
rename from modules/libvorbis/lib/vorbis_lsp.c
rename to media/libvorbis/lib/vorbis_lsp.c
diff --git a/modules/libvorbis/lib/vorbis_mapping0.c b/media/libvorbis/lib/vorbis_mapping0.c
rename from modules/libvorbis/lib/vorbis_mapping0.c
rename to media/libvorbis/lib/vorbis_mapping0.c
diff --git a/modules/libvorbis/lib/vorbis_mdct.c b/media/libvorbis/lib/vorbis_mdct.c
rename from modules/libvorbis/lib/vorbis_mdct.c
rename to media/libvorbis/lib/vorbis_mdct.c
diff --git a/modules/libvorbis/lib/vorbis_psy.c b/media/libvorbis/lib/vorbis_psy.c
rename from modules/libvorbis/lib/vorbis_psy.c
rename to media/libvorbis/lib/vorbis_psy.c
diff --git a/modules/libvorbis/lib/vorbis_registry.c b/media/libvorbis/lib/vorbis_registry.c
rename from modules/libvorbis/lib/vorbis_registry.c
rename to media/libvorbis/lib/vorbis_registry.c
diff --git a/modules/libvorbis/lib/vorbis_res0.c b/media/libvorbis/lib/vorbis_res0.c
rename from modules/libvorbis/lib/vorbis_res0.c
rename to media/libvorbis/lib/vorbis_res0.c
diff --git a/modules/libvorbis/lib/vorbis_sharedbook.c b/media/libvorbis/lib/vorbis_sharedbook.c
rename from modules/libvorbis/lib/vorbis_sharedbook.c
rename to media/libvorbis/lib/vorbis_sharedbook.c
diff --git a/modules/libvorbis/lib/vorbis_smallft.c b/media/libvorbis/lib/vorbis_smallft.c
rename from modules/libvorbis/lib/vorbis_smallft.c
rename to media/libvorbis/lib/vorbis_smallft.c
diff --git a/modules/libvorbis/lib/vorbis_synthesis.c b/media/libvorbis/lib/vorbis_synthesis.c
rename from modules/libvorbis/lib/vorbis_synthesis.c
rename to media/libvorbis/lib/vorbis_synthesis.c
diff --git a/modules/libvorbis/lib/vorbis_window.c b/media/libvorbis/lib/vorbis_window.c
rename from modules/libvorbis/lib/vorbis_window.c
rename to media/libvorbis/lib/vorbis_window.c
diff --git a/modules/libvorbis/lib/window.h b/media/libvorbis/lib/window.h
rename from modules/libvorbis/lib/window.h
rename to media/libvorbis/lib/window.h
diff --git a/modules/libvorbis/todo.txt b/media/libvorbis/todo.txt
rename from modules/libvorbis/todo.txt
rename to media/libvorbis/todo.txt
diff --git a/modules/libvorbis/update.sh b/media/libvorbis/update.sh
rename from modules/libvorbis/update.sh
rename to media/libvorbis/update.sh
diff --git a/modules/libpref/src/init/all.js b/modules/libpref/src/init/all.js
--- a/modules/libpref/src/init/all.js
+++ b/modules/libpref/src/init/all.js
@@ -1168,14 +1168,14 @@ pref("font.name-list.serif.ko", "Batang,
 pref("font.name-list.serif.ko", "Batang, , Gulim, "); 
 pref("font.name-list.sans-serif.ko", "Gulim, "); 
 pref("font.name-list.monospace.ko", "GulimChe, "); 
 pref("font.name-list.cursive.ko", "Gungseo, "); 
 
-pref("font.name.serif.th", "Times New Roman");
-pref("font.name.sans-serif.th", "Arial");
-pref("font.name.monospace.th", "Courier New");
-pref("font.name.cursive.th", "Comic Sans MS");
+pref("font.name.serif.th", "Tahoma");
+pref("font.name.sans-serif.th", "Tahoma");
+pref("font.name.monospace.th", "Tahoma");
+pref("font.name.cursive.th", "Tahoma");
 
 pref("font.name.serif.tr", "Times New Roman");
 pref("font.name.sans-serif.tr", "Arial");
 pref("font.name.monospace.tr", "Courier New");
 pref("font.name.cursive.tr", "Comic Sans MS");
@@ -1350,10 +1350,11 @@ pref("font.size.fixed.ko", 16);
 pref("font.size.fixed.ko", 16);
 
 pref("font.default.th", "serif");
 pref("font.size.variable.th", 16);
 pref("font.size.fixed.th", 13);
+pref("font.minimum-size.th", 10);
 
 pref("font.default.tr", "serif");
 pref("font.size.variable.tr", 16);
 pref("font.size.fixed.tr", 13);
 
@@ -1570,14 +1571,14 @@ pref("font.name-list.serif.ko", "AppleMy
 pref("font.name-list.serif.ko", "AppleMyungjo"); 
 pref("font.name-list.sans-serif.ko", "AppleGothic"); 
 pref("font.name-list.monospace.ko", "AppleGothic"); 
 
 pref("font.name.serif.th", "Thonburi");
-pref("font.name.sans-serif.th", "Krungthep");
+pref("font.name.sans-serif.th", "Thonburi");
 pref("font.name.monospace.th", "Ayuthaya");
 pref("font.name-list.serif.th", "Thonburi");
-pref("font.name-list.sans-serif.th", "Krungthep");
+pref("font.name-list.sans-serif.th", "Thonburi");
 pref("font.name-list.monospace.th", "Ayuthaya");
 
 pref("font.name.serif.tr", "Times");
 pref("font.name.sans-serif.tr", "Helvetica");
 pref("font.name.monospace.tr", "Courier");
@@ -1791,10 +1792,11 @@ pref("font.size.fixed.ko", 16);
 pref("font.size.fixed.ko", 16);
 
 pref("font.default.th", "serif");
 pref("font.size.variable.th", 16);
 pref("font.size.fixed.th", 13);
+pref("font.minimum-size.th", 10);
 
 pref("font.default.tr", "serif");
 pref("font.size.variable.tr", 16);
 pref("font.size.fixed.tr", 13);
 
@@ -2301,11 +2303,13 @@ pref("font.name.monospace.ja", "monospac
 
 pref("font.name.serif.ko", "serif");
 pref("font.name.sans-serif.ko", "sans-serif");
 pref("font.name.monospace.ko", "monospace");
 
-// th
+pref("font.name.serif.th", "serif");
+pref("font.name.sans-serif.th", "sans-serif");
+pref("font.name.monospace.th", "monospace");
 
 pref("font.name.serif.tr", "serif");
 pref("font.name.sans-serif.tr", "sans-serif");
 pref("font.name.monospace.tr", "monospace");
 
@@ -2365,11 +2369,12 @@ pref("font.size.variable.ko", 16);
 pref("font.size.variable.ko", 16);
 pref("font.size.fixed.ko", 16);
 
 pref("font.default.th", "serif");
 pref("font.size.variable.th", 16);
-pref("font.size.fixed.th", 12);
+pref("font.size.fixed.th", 13);
+pref("font.minimum-size.th", 13);
 
 pref("font.default.tr", "serif");
 pref("font.size.variable.tr", 16);
 pref("font.size.fixed.tr", 12);
 
diff --git a/modules/plugin/base/public/npapi.h b/modules/plugin/base/public/npapi.h
--- a/modules/plugin/base/public/npapi.h
+++ b/modules/plugin/base/public/npapi.h
@@ -118,11 +118,11 @@
 /*----------------------------------------------------------------------*/
 /*                        Plugin Version Constants                      */
 /*----------------------------------------------------------------------*/
 
 #define NP_VERSION_MAJOR 0
-#define NP_VERSION_MINOR 19
+#define NP_VERSION_MINOR 20
 
 
 /* The OS/2 version of Netscape uses RC_DATA to define the
    mime types, file extensions, etc that are required.
    Use a vertical bar to separate types, end types with \0.
@@ -409,11 +409,18 @@ typedef enum {
   /* Get the plugin value (as \0-terminated UTF-8 string data) for
    * form submission if the plugin is part of a form. Use
    * NPN_MemAlloc() to allocate memory for the string data. Introduced
    * in Mozilla 1.8b2 (NPAPI minor version 15).
    */
-  NPPVformValue = 16
+  NPPVformValue = 16,
+  
+  NPPVpluginUrlRequestsDisplayedBool = 17,
+  
+  /* Checks if the plugin is interested in receiving the http body of
+   * all http requests (including failed ones, http status != 200).
+   */
+  NPPVpluginWantsAllNetworkStreams = 18
 #ifdef XP_MACOSX
   /* Used for negotiating drawing models */
   , NPPVpluginDrawingModel = 1000
 #endif
 } NPPVariable;
@@ -656,10 +663,11 @@ enum NPEventType {
 #define NPVERS_HAS_FORM_VALUES              15
 #define NPVERS_HAS_POPUPS_ENABLED_STATE     16
 #define NPVERS_HAS_RESPONSE_HEADERS         17
 #define NPVERS_HAS_NPOBJECT_ENUM            18
 #define NPVERS_HAS_PLUGIN_THREAD_ASYNC_CALL 19
+#define NPVERS_HAS_ALL_NETWORK_STREAMS      20
 
 /*----------------------------------------------------------------------*/
 /*                        Function Prototypes                           */
 /*----------------------------------------------------------------------*/
 
diff --git a/modules/plugin/base/public/nsplugindefs.h b/modules/plugin/base/public/nsplugindefs.h
--- a/modules/plugin/base/public/nsplugindefs.h
+++ b/modules/plugin/base/public/nsplugindefs.h
@@ -199,11 +199,12 @@ enum nsPluginInstanceVariable {
     nsPluginInstanceVariable_TransparentBool         = 4,
     nsPluginInstanceVariable_DoCacheBool             = 5,
     nsPluginInstanceVariable_CallSetWindowAfterDestroyBool = 6,
     nsPluginInstanceVariable_ScriptableInstance      = 10,
     nsPluginInstanceVariable_ScriptableIID           = 11,
-    nsPluginInstanceVariable_NeedsXEmbed             = 14
+    nsPluginInstanceVariable_NeedsXEmbed             = 14,
+    nsPluginInstanceVariable_WantsAllNetworkStreams  = 18
 #ifdef XP_MACOSX
     , nsPluginInstanceVariable_DrawingModel          = 20
 #endif
 };
 
diff --git a/modules/plugin/base/src/ns4xPlugin.cpp b/modules/plugin/base/src/ns4xPlugin.cpp
--- a/modules/plugin/base/src/ns4xPlugin.cpp
+++ b/modules/plugin/base/src/ns4xPlugin.cpp
@@ -2449,17 +2449,21 @@ _setvalue(NPP npp, NPPVariable variable,
             rv = contextStack->Pop(nsnull);
           }
         }
         return NS_SUCCEEDED(rv) ? NPERR_NO_ERROR : NPERR_GENERIC_ERROR;
       }
-      break;
 
     case NPPVpluginKeepLibraryInMemory: {
       NPBool bCached = (result != nsnull);
       return inst->SetCached(bCached);
     }
-      
+
+    case NPPVpluginWantsAllNetworkStreams: {
+      PRBool bWantsAllNetworkStreams = (result != nsnull);
+      return inst->SetWantsAllNetworkStreams(bWantsAllNetworkStreams);
+    }
+
 #ifdef XP_MACOSX
     case NPPVpluginDrawingModel: {
       if (inst) {
         int dModelValue = (int)result;
         inst->SetDrawingModel((NPDrawingModel)dModelValue);
diff --git a/modules/plugin/base/src/ns4xPluginInstance.cpp b/modules/plugin/base/src/ns4xPluginInstance.cpp
--- a/modules/plugin/base/src/ns4xPluginInstance.cpp
+++ b/modules/plugin/base/src/ns4xPluginInstance.cpp
@@ -831,10 +831,11 @@ ns4xPluginInstance::ns4xPluginInstance(N
     mWindowless(PR_FALSE),
     mTransparent(PR_FALSE),
     mStarted(PR_FALSE),
     mCached(PR_FALSE),
     mIsJavaPlugin(PR_FALSE),
+    mWantsAllNetworkStreams(PR_FALSE),
     mInPluginInitCall(PR_FALSE),
     fLibrary(aLibrary),
     mStreams(nsnull)
 {
   NS_ASSERTION(fCallbacks != NULL, "null callbacks");
@@ -1435,10 +1436,17 @@ NPError ns4xPluginInstance::SetTranspare
 {
   mTransparent = aTransparent;
   return NPERR_NO_ERROR;
 }
 
+////////////////////////////////////////////////////////////////////////
+NPError ns4xPluginInstance::SetWantsAllNetworkStreams(PRBool aWantsAllNetworkStreams)
+{
+  mWantsAllNetworkStreams = aWantsAllNetworkStreams;
+  return NPERR_NO_ERROR;
+}
+
 #ifdef XP_MACOSX
 ////////////////////////////////////////////////////////////////////////
 void ns4xPluginInstance::SetDrawingModel(NPDrawingModel aModel)
 {
   mDrawingModel = aModel;
diff --git a/modules/plugin/base/src/ns4xPluginInstance.h b/modules/plugin/base/src/ns4xPluginInstance.h
--- a/modules/plugin/base/src/ns4xPluginInstance.h
+++ b/modules/plugin/base/src/ns4xPluginInstance.h
@@ -113,10 +113,12 @@ public:
 
     NPError SetWindowless(PRBool aWindowless);
 
     NPError SetTransparent(PRBool aTransparent);
 
+    NPError SetWantsAllNetworkStreams(PRBool aWantsAllNetworkStreams);
+
 #ifdef XP_MACOSX
     void SetDrawingModel(NPDrawingModel aModel);
     NPDrawingModel GetDrawingModel();
 #endif
 
@@ -185,10 +187,11 @@ protected:
     PRPackedBool  mWindowless;
     PRPackedBool  mTransparent;
     PRPackedBool  mStarted;
     PRPackedBool  mCached;
     PRPackedBool  mIsJavaPlugin;
+    PRPackedBool  mWantsAllNetworkStreams;
 
 public:
     // True while creating the plugin, or calling NPP_SetWindow() on
     // it.
     PRPackedBool  mInPluginInitCall;
diff --git a/modules/plugin/base/src/nsPluginHostImpl.cpp b/modules/plugin/base/src/nsPluginHostImpl.cpp
--- a/modules/plugin/base/src/nsPluginHostImpl.cpp
+++ b/modules/plugin/base/src/nsPluginHostImpl.cpp
@@ -172,11 +172,11 @@
 #include "nsIScriptSecurityManager.h"
 #include "nsIContentPolicy.h"
 #include "nsContentPolicyUtils.h"
 #include "nsContentErrors.h"
 
-#if defined(XP_UNIX) && defined(MOZ_WIDGET_GTK2)
+#if defined(XP_UNIX) && defined(MOZ_WIDGET_GTK2) & defined(MOZ_X11)
 #include <gdk/gdkx.h> // for GDK_DISPLAY()
 #endif
 
 #ifdef XP_MACOSX
 #include <Carbon/Carbon.h> // for ::UseInputWindow()
@@ -1310,10 +1310,12 @@ public:
   nsresult InitializeFullPage(nsIPluginInstance *aInstance);
 
   nsresult OnFileAvailable(nsIFile* aFile);
 
   nsresult ServeStreamAsFile(nsIRequest *request, nsISupports *ctxt);
+  
+  nsIPluginInstance *GetPluginInstance() { return mInstance; }
 
 private:
   nsresult SetUpCache(nsIURI* aURL); // todo: see about removing this...
   nsresult SetUpStreamListener(nsIRequest* request, nsIURI* aURL);
   nsresult SetupPluginCacheFile(nsIChannel* channel);
@@ -2028,17 +2030,27 @@ nsPluginStreamListenerPeer::OnStartReque
   // just return, this causes the request to be ignored.
   nsCOMPtr<nsIHttpChannel> httpChannel(do_QueryInterface(channel));
   if (httpChannel) {
     PRUint32 responseCode = 0;
     rv = httpChannel->GetResponseStatus(&responseCode);
-    if (NS_FAILED(rv) || responseCode > 206) { // not normal
+    if (NS_FAILED(rv)) {
       // NPP_Notify() will be called from OnStopRequest
       // in ns4xPluginStreamListener::CleanUpStream
       // return error will cancel this request
       // ...and we also need to tell the plugin that
       mRequestFailed = PR_TRUE;
       return NS_ERROR_FAILURE;
+    }
+
+    if (responseCode > 206) { // not normal
+      PRBool bWantsAllNetworkStreams = PR_FALSE;
+      mInstance->GetValue(nsPluginInstanceVariable_WantsAllNetworkStreams,
+                          (void *)&bWantsAllNetworkStreams);
+      if(!bWantsAllNetworkStreams) {
+        mRequestFailed = PR_TRUE;
+        return NS_ERROR_FAILURE;
+      }
     }
   }
 
   // do a little sanity check to make sure our frame isn't gone
   // by getting the tag type and checking for an error, we can determine if
@@ -2907,19 +2919,28 @@ nsresult nsPluginHostImpl::UserAgent(con
   res = http->GetUserAgent(uaString);
 
   if (NS_SUCCEEDED(res))
   {
     if(NS_RETURN_UASTRING_SIZE > uaString.Length())
-    {
       PL_strcpy(resultString, uaString.get());
-      *retstring = resultString;
-    }
     else
     {
-      *retstring = nsnull;
-      res = NS_ERROR_OUT_OF_MEMORY;
-    }
+      // Copy as much of UA string as we can (terminate at right-most space).
+      PL_strncpy(resultString, uaString.get(), NS_RETURN_UASTRING_SIZE);
+      for (int i = NS_RETURN_UASTRING_SIZE - 1; i >= 0; i--)
+      {
+        if (0 == i)
+          resultString[NS_RETURN_UASTRING_SIZE - 1] = '\0';
+        else if (resultString[i] == ' ')
+        {
+          resultString[i] = '\0';
+          break;
+        }
+      }
+    }
+
+    *retstring = resultString;
   }
   else
     *retstring = nsnull;
 
   PLUGIN_LOG(PLUGIN_LOG_NORMAL, ("nsPluginHostImpl::UserAgent return=%s\n", *retstring));
@@ -7120,22 +7141,33 @@ nsPluginByteRangeStreamListener::OnStart
     return NS_ERROR_FAILURE;
   }
 
   PRUint32 responseCode = 0;
   rv = httpChannel->GetResponseStatus(&responseCode);
-  if (NS_FAILED(rv) || responseCode != 200) {
-    return NS_ERROR_FAILURE;
+  if (NS_FAILED(rv)) {
+    return NS_ERROR_FAILURE;
+  }
+  
+  // get nsPluginStreamListenerPeer* ptr from finalStreamListener
+  nsPluginStreamListenerPeer *pslp =
+    reinterpret_cast<nsPluginStreamListenerPeer*>(finalStreamListener.get());
+
+  if (responseCode != 200) {
+    PRBool bWantsAllNetworkStreams = PR_FALSE;
+    pslp->GetPluginInstance()->
+      GetValue(nsPluginInstanceVariable_WantsAllNetworkStreams,
+               (void *)&bWantsAllNetworkStreams);
+    if (!bWantsAllNetworkStreams){
+      return NS_ERROR_FAILURE;
+    }
   }
 
   // if server cannot continue with byte range (206 status) and sending us whole object (200 status)
   // reset this seekable stream & try serve it to plugin instance as a file
   mStreamConverter = finalStreamListener;
   mRemoveMagicNumber = PR_TRUE;
 
-  //get nsPluginStreamListenerPeer* ptr from finalStreamListener
-  nsPluginStreamListenerPeer *pslp = reinterpret_cast<nsPluginStreamListenerPeer*>
-                                                     (finalStreamListener.get());
   rv = pslp->ServeStreamAsFile(request, ctxt);
   return rv;
 }
 
 NS_IMETHODIMP
diff --git a/modules/plugin/samples/default/unix/nullplugin.c b/modules/plugin/samples/default/unix/nullplugin.c
--- a/modules/plugin/samples/default/unix/nullplugin.c
+++ b/modules/plugin/samples/default/unix/nullplugin.c
@@ -48,11 +48,13 @@
  *
  */
 
 #include <stdio.h>
 #include <gtk/gtk.h>
+#ifdef MOZ_X11
 #include <gdk/gdkx.h>
+#endif
 #include <gdk/gdkkeysyms.h>
 
 /* Xlib/Xt stuff */
 #ifdef MOZ_X11
 #include <X11/Xlib.h>
diff --git a/other-licenses/7zstub/thunderbird/7zSD.sfx b/other-licenses/7zstub/thunderbird/7zSD.sfx
index 4b2bf7d6458477a5f4c38ebc0805aef6d30f3b34..fe6ed680647b1422bc0e12e4082969380f5f842c
GIT binary patch
literal 122368
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

diff --git a/storage/src/mozStorageStatementWrapper.cpp b/storage/src/mozStorageStatementWrapper.cpp
--- a/storage/src/mozStorageStatementWrapper.cpp
+++ b/storage/src/mozStorageStatementWrapper.cpp
@@ -520,12 +520,10 @@ mozStorageStatementRow::GetScriptableFla
 /* PRBool getProperty (in nsIXPConnectWrappedNative wrapper, in JSContextPtr cx, in JSObjectPtr obj, in JSVal id, in JSValPtr vp); */
 NS_IMETHODIMP
 mozStorageStatementRow::GetProperty(nsIXPConnectWrappedNative *wrapper, JSContext * cx,
                          JSObject * obj, jsval id, jsval * vp, PRBool *_retval)
 {
-    *_retval = PR_FALSE;
-
     if (JSVAL_IS_STRING(id)) {
         nsDependentString jsid((PRUnichar *)::JS_GetStringChars(JSVAL_TO_STRING(id)),
                                ::JS_GetStringLength(JSVAL_TO_STRING(id)));
 
         for (int i = 0; i < mNumColumns; i++) {
@@ -534,36 +532,35 @@ mozStorageStatementRow::GetProperty(nsIX
 
                 if (ctype == SQLITE_INTEGER || ctype == SQLITE_FLOAT) {
                     double dval = sqlite3_column_double(NativeStatement(), i);
                     if (!JS_NewNumberValue(cx, dval, vp)) {
                         *_retval = PR_FALSE;
-                        return NS_ERROR_OUT_OF_MEMORY;
+                        return NS_OK;
                     }
                 } else if (ctype == SQLITE_TEXT) {
                     JSString *str = JS_NewUCStringCopyN(cx,
                                                         (jschar*) sqlite3_column_text16(NativeStatement(), i),
                                                         sqlite3_column_bytes16(NativeStatement(), i)/2);
                     if (!str) {
                         *_retval = PR_FALSE;
-                        return NS_ERROR_OUT_OF_MEMORY;
+                        return NS_OK;
                     }
                     *vp = STRING_TO_JSVAL(str);
                 } else if (ctype == SQLITE_BLOB) {
                     JSString *str = JS_NewStringCopyN(cx,
                                                       (char*) sqlite3_column_blob(NativeStatement(), i),
                                                       sqlite3_column_bytes(NativeStatement(), i));
                     if (!str) {
                         *_retval = PR_FALSE;
-                        return NS_ERROR_OUT_OF_MEMORY;
+                        return NS_OK;
                     }
                 } else if (ctype == SQLITE_NULL) {
                     *vp = JSVAL_NULL;
                 } else {
                     NS_ERROR("sqlite3_column_type returned unknown column type, what's going on?");
                 }
 
-                *_retval = PR_TRUE;
                 break;
             }
         }
     }
 
diff --git a/storage/test/unit/test_bug-429521.js b/storage/test/unit/test_bug-429521.js
new file mode 100644
--- /dev/null
+++ b/storage/test/unit/test_bug-429521.js
@@ -0,0 +1,92 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Storage Test Code.
+ *
+ * The Initial Developer of the Original Code is
+ *   Stefan Sitter.
+ * Portions created by the Initial Developer are Copyright (C) 2007
+ * the Initial Developer. All Rights Reserved.
+ *
+ * This code is based off of like.test from the sqlite code
+ *
+ * Contributor(s):
+ *   Stefan Sitter <ssitter@gmail.com> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+function createStatementWrapper(aSQL) 
+{
+    var stmt = getOpenedDatabase().createStatement(aSQL);
+    var wrapper = Components.Constructor("@mozilla.org/storage/statement-wrapper;1", Ci.mozIStorageStatementWrapper)();
+    wrapper.initialize(stmt);
+    return wrapper;
+}
+
+function setup() 
+{
+    getOpenedDatabase().createTable("t1", "x TEXT");
+
+    var stmt = getOpenedDatabase().createStatement("INSERT INTO t1 (x) VALUES ('/mozilla.org/20070129_1/Europe/Berlin')");
+    stmt.execute();
+    stmt.finalize();
+}
+
+function test_bug429521() 
+{
+    var wrapper = createStatementWrapper(
+        "SELECT DISTINCT(zone) FROM ("+
+            "SELECT x AS zone FROM t1 WHERE x LIKE '/mozilla.org%'" +
+        ");");
+
+    print("*** test_bug429521: started");
+
+    try {
+        while (wrapper.step()) {
+            print("*** test_bug429521: step() Read wrapper.row.zone");
+
+            // BUG: the print commands after the following statement
+            // are never executed. Script stops immediately.
+            var tzId = wrapper.row.zone;
+
+            print("*** test_bug429521: step() Read wrapper.row.zone finished");
+        }
+    } catch (e) {
+        print("*** test_bug429521: " + e);
+    }
+
+    print("*** test_bug429521: finished");
+
+    wrapper.statement.finalize();
+}
+
+function run_test()
+{
+  setup();
+
+  test_bug429521();
+    
+  cleanup();
+}
diff --git a/testing/sisyphus/bin/set-build-env.sh b/testing/sisyphus/bin/set-build-env.sh
--- a/testing/sisyphus/bin/set-build-env.sh
+++ b/testing/sisyphus/bin/set-build-env.sh
@@ -155,39 +155,39 @@ for step in step1; do # dummy loop for h
             #
             # Note that when calling a command string of the form $buildbash --login -c "command",
             # you must cd to the desired directory as part of "command" since msys will set the 
             # directory to the home directory prior to executing the command.
 
-            if [[ -e "/c/mozilla-build" ]]; then
+            if [[ -e "/c/mozilla-build" && $branch != "1.8.0" ]]; then
                 export BUILDDIR=${BUILDDIR:-/c/work/mozilla/builds}
                 export buildbash="/c/mozilla-build/msys/bin/bash"
                 export bashlogin=--login # this is for msys' bash.
 
                 if echo $branch | egrep -q '^1\.8'; then
-                    export MOZ_TOOLS="/c/mozilla-build/moztools-180compat"
-                    source ${TEST_DIR}/bin/set-msvc6-env.sh
+                    export MOZ_TOOLS=${MOZ_TOOLS:-"/c/mozilla-build/moztools-180compat"}
+                    export SET_MSVC_ENV=${SET_MSVC_ENV:-${TEST_DIR}/bin/set-msvc6-env.sh}
                 else
-                    export MOZ_TOOLS="/c/mozilla-build/moztools"
-                    source ${TEST_DIR}/bin/set-msvc8-env.sh
+                    export MOZ_TOOLS=${MOZ_TOOLS:-"/c/mozilla-build/moztools"}
+                    export SET_MSVC_ENV=${SET_MSVC_ENV:-${TEST_DIR}/bin/set-msvc8-env.sh}
                 fi
 
-                echo moztools Location: $MOZ_TOOLS
             else
                 export BUILDDIR=${BUILDDIR:-/work/mozilla/builds}
                 export buildbash="/bin/bash"
                 export bashlogin=-l
 
                 if echo $branch | egrep -q '^1\.8'; then
-                    export MOZ_TOOLS="$BUILDDIR/moztools"
-                    source ${TEST_DIR}/bin/set-msvc6-env.sh
+                    export MOZ_TOOLS=${MOZ_TOOLS:-"$BUILDDIR/moztools"}
+                    export SET_MSVC_ENV=${SET_MSVC_ENV:-${TEST_DIR}/bin/set-msvc6-env.sh}
                 else
-                    export MOZ_TOOLS="$BUILDDIR/moztools-static"
-                    source ${TEST_DIR}/bin/set-msvc8-env.sh
+                    export MOZ_TOOLS=${MOZ_TOOLS:-"$BUILDDIR/moztools-static"}
+                    export SET_MSVC_ENV=${SET_MSVC_ENV:-${TEST_DIR}/bin/set-msvc8-env.sh}
                 fi
+            fi
 
-                echo moztools Location: $MOZ_TOOLS
-            fi
+            source $SET_MSVC_ENV
+            echo moztools Location: $MOZ_TOOLS
 
             # now convert TEST_DIR and BUILDDIR to cross compatible paths using
             # the common cygdrive prefix for cygwin and msys
             TEST_DIR_WIN=`cygpath -w $TEST_DIR`
             BUILDDIR_WIN=`cygpath -w $BUILDDIR`
diff --git a/testing/sisyphus/bin/set-msvc6-env.sh b/testing/sisyphus/bin/set-msvc6-env.sh
--- a/testing/sisyphus/bin/set-msvc6-env.sh
+++ b/testing/sisyphus/bin/set-msvc6-env.sh
@@ -33,29 +33,32 @@
 # the provisions above, a recipient may use your version of this file under
 # the terms of any one of the MPL, the GPL or the LGPL.
 #
 # ***** END LICENSE BLOCK *****
 
+echo Setting environment for using Microsoft Visual Studio 6
+
+# Visual Studio 6 Installation Directory
+export VS6INSTALLDIR=${VS6INSTALLDIR:-'C:\Program Files\Microsoft Visual Studio'}
+
 # Root of Visual Developer Studio Common files.
-export VSCommonDir='C:\Program Files\Microsoft Visual Studio\Common'
+export VSCommonDir="$VS6INSTALLDIR\\Common"
 export VSCommonDir_cyg=`cygpath -u "$VSCommonDir"`
 
 # Root of Visual Developer Studio installed files.
-export MSDevDir='C:\Program Files\Microsoft Visual Studio\Common\MSDev98'
+export MSDevDir="$VSCommonDir\\MSDev98"
 export MSDevDir_cyg=`cygpath -u "$MSDevDir"`
 
 # Root of Visual C++ installed files.
-export MSVCDir='C:\Program Files\Microsoft Visual Studio\VC98'
+export MSVCDir="$VS6INSTALLDIR\\VC98"
 export MSVCDir_cyg=`cygpath -u "$MSVCDir"`
 
 # VcOsDir is used to help create either a Windows 95 or Windows NT specific path.
 export VcOsDir=WIN95
 if [[ "$OS" == "Windows_NT" ]]; then
     export VcOsDir=WINNT
 fi
-
-echo Setting environment for using Microsoft Visual C++ tools.
 
 if [[ "$OS" == "Windows_NT" ]]; then
     export PATH="$MSDevDir_cyg/Bin":"$MSVCDir_cyg/Bin":"$VSCommonDir_cyg/Tools/$VcOsDir":"$VSCommonDir_cyg/Tools":"$MOZ_TOOLS/bin":"$PATH"
 elif [[ "$OS" == "" ]]; then
     export PATH="$MSDevDir_cyg/Bin":"MSVCDir_cyg/Bin":"$VSCommonDir_cyg/Tools/$VcOsDir":"$VSCommonDir_cyg/Tools":"$windir/SYSTEM":$MOZ_TOOLS/bin:"$PATH"
diff --git a/testing/sisyphus/bin/set-msvc8-env.sh b/testing/sisyphus/bin/set-msvc8-env.sh
--- a/testing/sisyphus/bin/set-msvc8-env.sh
+++ b/testing/sisyphus/bin/set-msvc8-env.sh
@@ -33,33 +33,35 @@
 # the provisions above, a recipient may use your version of this file under
 # the terms of any one of the MPL, the GPL or the LGPL.
 #
 # ***** END LICENSE BLOCK *****
 
-export VSINSTALLDIR='C:\Program Files\Microsoft Visual Studio 8'
-export VS80COMNTOOLS="$VSINSTALLDIR\\Common7\\Tools\\"
-export VCINSTALLDIR="$VSINSTALLDIR\\VC"
-export FrameworkDir='C:\WINDOWS\Microsoft.NET\Framework'
-export FrameworkVersion='v2.0.50727'
-export FrameworkSDKDir="$VSINSTALLDIR\\SDK\\v2.0"
-export DevEnvDir="$VSINSTALLDIR\\Common7\\IDE"
-export MSVCDir="$VSINSTALLDIR\\VC"
+echo Setting environment for using Microsoft Visual Studio 8
+
+export VS8INSTALLDIR=${VS8INSTALLDIR:-'C:\Program Files\Microsoft Visual Studio 8'}
+export VS8COMNTOOLS="$VS8INSTALLDIR\\Common7\\Tools\\"
+export VCINSTALLDIR="$VS8INSTALLDIR\\VC"
+export FrameworkDir=${FrameworkDir:-'C:\WINDOWS\Microsoft.NET\Framework'}
+export FrameworkVersion=${FrameworkVersion:-'v2.0.50727'}
+export FrameworkSDKDir="$VS8INSTALLDIR\\SDK\\v2.0"
+export DevEnvDir="$VS8INSTALLDIR\\Common7\\IDE"
+export MSVCDir="$VS8INSTALLDIR\\VC"
 export PlatformSDKDir="$MSVCDir"\\PlatformSDK
 
 # Windows SDK 6 or later is required after https://bugzilla.mozilla.org/show_bug.cgi?id=412374
 # v6.0 - Windows SDK Update for Vista
 # v6.1 - Windows SDK for Windows Server 2008
-export WindowsSDK6='c:\Program Files\Microsoft SDKs\Windows\v6.0'
+export WindowsSDK6=${WindowsSDK6:-'c:\Program Files\Microsoft SDKs\Windows\v6.0'}
 export WindowsSDK6_cyg=`cygpath -u "$WindowsSDK6"`
 
 if [[ ! -d "$WindowsSDK6_cyg" ]]; then
     export WindowsSDK6='c:\Program Files\Microsoft SDKs\Windows\v6.1'
     export WindowsSDK6_cyg=`cygpath -u "$WindowsSDK6"`
 fi
 
-export VSINSTALLDIR_cyg=`cygpath -u "$VSINSTALLDIR"`
-export VS80COMNTOOLS_cyg=`cygpath -u "$VSINSTALLDIR"`
+export VS8INSTALLDIR_cyg=`cygpath -u "$VS8INSTALLDIR"`
+export VS8COMNTOOLS_cyg=`cygpath -u "$VS8COMNTOOLS"`
 export VCINSTALLDIR_cyg=`cygpath -u "$VCINSTALLDIR"`
 export FrameworkDir_cyg=`cygpath -u "$FrameworkDir"`
 export DevEnvDir_cyg=`cygpath -u "$DevEnvDir"`
 export MSVCDir_cyg=`cygpath -u "$VCINSTALLDIR"`
 export PlatformSDKDir_cyg=`cygpath -u "$PlatformSDKDir"`
@@ -85,12 +87,12 @@ fi
 
 export PATH="\
 $WindowsSDK6_cyg/bin:\
 $DevEnvDir_cyg:\
 $MSVCDir_cyg/bin:\
-$VS80COMNTOOLS_cyg:\
-$VS80COMNTOOLS_cyg/bin:\
+$VS8COMNTOOLS_cyg:\
+$VS8COMNTOOLS_cyg/bin:\
 $PlatformSDKDir_cyg/bin:\
 $FrameworkSDKDir_cyg/bin:\
 $FrameworkDir_cyg/$FrameworkVersion:\
 $MSVCDir/VCPackages:\
 $MOZ_TOOLS/bin:\
diff --git a/toolkit/components/alerts/resources/content/alert.js b/toolkit/components/alerts/resources/content/alert.js
--- a/toolkit/components/alerts/resources/content/alert.js
+++ b/toolkit/components/alerts/resources/content/alert.js
@@ -196,26 +196,28 @@ function animateAlert()
   {
     animate(gSlideIncrement);
     setTimeout(animateAlert, gSlideTime);
   }
   else
-    setTimeout(closeAlert, gOpenTime);  
+    setTimeout(animateCloseAlert, gOpenTime);  
 }
 
-function closeAlert()
+function animateCloseAlert()
 {
   if (gCurrentSize > 1)
   {
     animate(-gSlideIncrement);
-    setTimeout(closeAlert, gSlideTime);
+    setTimeout(animateCloseAlert, gSlideTime);
   }
   else
-  {
-    if (gAlertListener)
-      gAlertListener.observe(null, "alertfinished", gAlertCookie); 
-    window.close(); 
-  }
+    closeAlert();
+}
+
+function closeAlert() {
+  if (gAlertListener)
+    gAlertListener.observe(null, "alertfinished", gAlertCookie); 
+  window.close(); 
 }
 
 function onAlertClick()
 {
   if (gAlertListener && gAlertTextClickable)
diff --git a/toolkit/components/alerts/resources/content/alert.xul b/toolkit/components/alerts/resources/content/alert.xul
--- a/toolkit/components/alerts/resources/content/alert.xul
+++ b/toolkit/components/alerts/resources/content/alert.xul
@@ -42,11 +42,12 @@
         xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
         windowtype="alert:alert"
         xmlns:xhtml="http://www.w3.org/1999/xhtml"
         xhtml:role="alert"
         pack="start"
-        onload="onAlertLoad()">
+        onload="onAlertLoad()"
+        onclick="closeAlert();">
   
   <script type="application/javascript" src="chrome://global/content/alerts/alert.js"/>
 
   <box id="alertBox" class="alertBox">
     
diff --git a/toolkit/components/downloads/src/nsDownloadScanner.h b/toolkit/components/downloads/src/nsDownloadScanner.h
--- a/toolkit/components/downloads/src/nsDownloadScanner.h
+++ b/toolkit/components/downloads/src/nsDownloadScanner.h
@@ -5,11 +5,11 @@
 
 #ifdef WIN32_LEAN_AND_MEAN
 #undef WIN32_LEAN_AND_MEAN
 #endif
 #define INITGUID
-#include <Windows.h>
+#include <windows.h>
 #define AVVENDOR
 #include <msoav.h>
 // To cope with both msvs8 header and sdk6 header
 #ifdef _WIN32_IE_IE60SP2
 #undef _WIN32_IE
diff --git a/toolkit/components/passwordmgr/content/passwordManager.js b/toolkit/components/passwordmgr/content/passwordManager.js
--- a/toolkit/components/passwordmgr/content/passwordManager.js
+++ b/toolkit/components/passwordmgr/content/passwordManager.js
@@ -95,11 +95,15 @@ var signonsTreeView = {
  };
 
 
 function LoadSignons() {
   // loads signons into table
-  signons = passwordmanager.getAllLogins({});
+  try {
+    signons = passwordmanager.getAllLogins({});
+  } catch (e) {
+    signons = [];
+  }
   signonsTreeView.rowCount = signons.length;
 
   // sort and display the table
   signonsTree.treeBoxObject.view = signonsTreeView;
   SignonColumnSort('hostname');
@@ -202,12 +206,17 @@ function FinalizeSignonDeletions(syncNee
   for (var s=0; s<deletedSignons.length; s++) {
     passwordmanager.removeLogin(deletedSignons[s]);
   }
   // If the deletion has been performed in a filtered view, reflect the deletion in the unfiltered table.
   // See bug 405389.
-  if (syncNeeded)
-    signons = passwordmanager.getAllLogins({});
+  if (syncNeeded) {
+    try {
+      signons = passwordmanager.getAllLogins({});
+    } catch (e) {
+      signons = [];
+    }
+  }
   deletedSignons.length = 0;
 }
 
 function HandleSignonKeyPress(e) {
   if (e.keyCode == 46) {
diff --git a/toolkit/components/passwordmgr/src/storage-Legacy.js b/toolkit/components/passwordmgr/src/storage-Legacy.js
--- a/toolkit/components/passwordmgr/src/storage-Legacy.js
+++ b/toolkit/components/passwordmgr/src/storage-Legacy.js
@@ -313,10 +313,13 @@ LoginManagerStorage_legacy.prototype = {
             result = result.concat(hostLogins);
         }
 
         // decrypt entries for caller.
         [result, userCanceled] = this._decryptLogins(result);
+
+        if (userCanceled)
+            throw "User canceled Master Password entry";
 
         count.value = result.length; // needed for XPCOM
         return result;
     },
 
@@ -812,14 +815,13 @@ LoginManagerStorage_legacy.prototype = {
     _readFile : function () {
         var formatVersion;
 
         this.log("Reading passwords from " + this._signonsFile.path);
 
-        // If it doesn't exist, just create an empty file and bail out.
+        // If it doesn't exist, just bail out.
         if (!this._signonsFile.exists()) {
-            this.log("Creating new signons file...");
-            this._writeFile();
+            this.log("No existing signons file found.");
             return;
         }
 
         var inputStream = Cc["@mozilla.org/network/file-input-stream;1"].
                           createInstance(Ci.nsIFileInputStream);
diff --git a/toolkit/components/passwordmgr/test/unit/test_storage_legacy_1.js b/toolkit/components/passwordmgr/test/unit/test_storage_legacy_1.js
--- a/toolkit/components/passwordmgr/test/unit/test_storage_legacy_1.js
+++ b/toolkit/components/passwordmgr/test/unit/test_storage_legacy_1.js
@@ -57,11 +57,12 @@ testdesc = "Initialize with a non-exista
 
 LoginTest.initStorage(storage, OUTDIR, filename);
 
 LoginTest.checkStorageData(storage, [], []);
 
-file.remove(false);
+if (file.exists())
+    file.remove(false);
 
 /* ========== 3 ========== */
 testnum++;
 testdesc = "Initialize with signons-00.txt (a zero-length file)";
 
diff --git a/toolkit/components/places/src/nsAnnotationService.cpp b/toolkit/components/places/src/nsAnnotationService.cpp
--- a/toolkit/components/places/src/nsAnnotationService.cpp
+++ b/toolkit/components/places/src/nsAnnotationService.cpp
@@ -48,10 +48,11 @@
 #include "nsIServiceManager.h"
 #include "nsIVariant.h"
 #include "nsString.h"
 #include "nsVariant.h"
 #include "nsNavBookmarks.h"
+#include "nsPlacesTables.h"
 
 const PRInt32 nsAnnotationService::kAnnoIndex_ID = 0;
 const PRInt32 nsAnnotationService::kAnnoIndex_PageOrItem = 1;
 const PRInt32 nsAnnotationService::kAnnoIndex_Name = 2;
 const PRInt32 nsAnnotationService::kAnnoIndex_MimeType = 3;
@@ -246,50 +247,29 @@ nsAnnotationService::InitTables(mozIStor
   nsresult rv;
   PRBool exists;
   rv = aDBConn->TableExists(NS_LITERAL_CSTRING("moz_annos"), &exists);
   NS_ENSURE_SUCCESS(rv, rv);
   if (! exists) {
-    rv = aDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING("CREATE TABLE moz_annos ("
-        "id INTEGER PRIMARY KEY,"
-        "place_id INTEGER NOT NULL,"
-        "anno_attribute_id INTEGER,"
-        "mime_type VARCHAR(32) DEFAULT NULL,"
-        "content LONGVARCHAR, flags INTEGER DEFAULT 0,"
-        "expiration INTEGER DEFAULT 0,"
-        "type INTEGER DEFAULT 0,"
-        "dateAdded INTEGER DEFAULT 0," 
-        "lastModified INTEGER DEFAULT 0)"));
+    rv = aDBConn->ExecuteSimpleSQL(CREATE_MOZ_ANNOS);
     NS_ENSURE_SUCCESS(rv, rv);
 
     rv = aDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
         "CREATE UNIQUE INDEX moz_annos_placeattributeindex ON moz_annos (place_id, anno_attribute_id)"));
     NS_ENSURE_SUCCESS(rv, rv);
   }
 
   rv = aDBConn->TableExists(NS_LITERAL_CSTRING("moz_anno_attributes"), &exists);
   NS_ENSURE_SUCCESS(rv, rv);
   if (! exists) {
-    rv = aDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
-        "CREATE TABLE moz_anno_attributes ("
-        "id INTEGER PRIMARY KEY,"
-        "name VARCHAR(32) UNIQUE NOT NULL)"));
+    rv = aDBConn->ExecuteSimpleSQL(CREATE_MOZ_ANNO_ATTRIBUTES);
     NS_ENSURE_SUCCESS(rv, rv);
   }
 
   rv = aDBConn->TableExists(NS_LITERAL_CSTRING("moz_items_annos"), &exists);
   NS_ENSURE_SUCCESS(rv, rv);
   if (! exists) {
-    rv = aDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING("CREATE TABLE moz_items_annos ("
-        "id INTEGER PRIMARY KEY,"
-        "item_id INTEGER NOT NULL,"
-        "anno_attribute_id INTEGER,"
-        "mime_type VARCHAR(32) DEFAULT NULL,"
-        "content LONGVARCHAR, flags INTEGER DEFAULT 0,"
-        "expiration INTEGER DEFAULT 0,"
-        "type INTEGER DEFAULT 0,"
-        "dateAdded INTEGER DEFAULT 0," 
-        "lastModified INTEGER DEFAULT 0)"));
+    rv = aDBConn->ExecuteSimpleSQL(CREATE_MOZ_ITEMS_ANNOS);
     NS_ENSURE_SUCCESS(rv, rv);
     rv = aDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
         "CREATE UNIQUE INDEX moz_items_annos_itemattributeindex ON moz_items_annos (item_id, anno_attribute_id)"));
     NS_ENSURE_SUCCESS(rv, rv);
   }
diff --git a/toolkit/components/places/src/nsFaviconService.cpp b/toolkit/components/places/src/nsFaviconService.cpp
--- a/toolkit/components/places/src/nsFaviconService.cpp
+++ b/toolkit/components/places/src/nsFaviconService.cpp
@@ -61,10 +61,11 @@
 #include "nsReadableUtils.h"
 #include "nsStreamUtils.h"
 #include "nsStringStream.h"
 #include "mozStorageHelper.h"
 #include "plbase64.h"
+#include "nsPlacesTables.h"
 
 // For favicon optimization
 #include "imgITools.h"
 #include "imgIContainer.h"
 
@@ -192,16 +193,11 @@ nsFaviconService::InitTables(mozIStorage
 {
   nsresult rv;
   PRBool exists = PR_FALSE;
   aDBConn->TableExists(NS_LITERAL_CSTRING("moz_favicons"), &exists);
   if (! exists) {
-    rv = aDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
-      "CREATE TABLE moz_favicons (id INTEGER PRIMARY KEY, "
-                                  "url LONGVARCHAR UNIQUE, "
-                                  "data BLOB, "
-                                  "mime_type VARCHAR(32), "
-                                  "expiration LONG)"));
+    rv = aDBConn->ExecuteSimpleSQL(CREATE_MOZ_FAVICONS);
     NS_ENSURE_SUCCESS(rv, rv);
   }
   return NS_OK;
 }
 
diff --git a/toolkit/components/places/src/nsNavBookmarks.cpp b/toolkit/components/places/src/nsNavBookmarks.cpp
--- a/toolkit/components/places/src/nsNavBookmarks.cpp
+++ b/toolkit/components/places/src/nsNavBookmarks.cpp
@@ -48,10 +48,12 @@
 #include "nsAnnotationService.h"
 #include "nsPrintfCString.h"
 #include "nsIUUIDGenerator.h"
 #include "prprf.h"
 #include "nsILivemarkService.h"
+#include "nsPlacesTriggers.h"
+#include "nsPlacesTables.h"
 
 const PRInt32 nsNavBookmarks::kFindBookmarksIndex_ID = 0;
 const PRInt32 nsNavBookmarks::kFindBookmarksIndex_Type = 1;
 const PRInt32 nsNavBookmarks::kFindBookmarksIndex_ForeignKey = 2;
 const PRInt32 nsNavBookmarks::kFindBookmarksIndex_Parent = 3;
@@ -324,23 +326,11 @@ nsNavBookmarks::InitTables(mozIStorageCo
 {
   PRBool exists;
   nsresult rv = aDBConn->TableExists(NS_LITERAL_CSTRING("moz_bookmarks"), &exists);
   NS_ENSURE_SUCCESS(rv, rv);
   if (! exists) {
-    // The fk column is for "foreign key". It contains ids from moz_places
-    // if the row is a bookmark.
-    rv = aDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING("CREATE TABLE moz_bookmarks ("
-        "id INTEGER PRIMARY KEY,"
-        "type INTEGER, "
-        "fk INTEGER DEFAULT NULL, "
-        "parent INTEGER, "
-        "position INTEGER, "
-        "title LONGVARCHAR, "
-        "keyword_id INTEGER, "
-        "folder_type TEXT, "
-        "dateAdded INTEGER, " 
-        "lastModified INTEGER)"));
+    rv = aDBConn->ExecuteSimpleSQL(CREATE_MOZ_BOOKMARKS);
     NS_ENSURE_SUCCESS(rv, rv);
 
     // This index will make it faster to determine if a given item is
     // bookmarked (used by history queries and vacuuming, for example).
     // Making it compound with "type" speeds up type-differentiation
@@ -365,24 +355,23 @@ nsNavBookmarks::InitTables(mozIStorageCo
 
   // moz_bookmarks_roots
   rv = aDBConn->TableExists(NS_LITERAL_CSTRING("moz_bookmarks_roots"), &exists);
   NS_ENSURE_SUCCESS(rv, rv);
   if (!exists) {
-    rv = aDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING("CREATE TABLE moz_bookmarks_roots ("
-        "root_name VARCHAR(16) UNIQUE, "
-        "folder_id INTEGER)"));
+    rv = aDBConn->ExecuteSimpleSQL(CREATE_MOZ_BOOKMARKS_ROOTS);
     NS_ENSURE_SUCCESS(rv, rv);
   }
 
   // moz_keywords
   rv = aDBConn->TableExists(NS_LITERAL_CSTRING("moz_keywords"), &exists);
   NS_ENSURE_SUCCESS(rv, rv);
   if (! exists) {
-    rv = aDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
-        "CREATE TABLE moz_keywords ("
-        "id INTEGER PRIMARY KEY AUTOINCREMENT, "
-        "keyword TEXT UNIQUE)"));
+    rv = aDBConn->ExecuteSimpleSQL(CREATE_MOZ_KEYWORDS);
+    NS_ENSURE_SUCCESS(rv, rv);
+
+    // Create trigger to update as well
+    rv = aDBConn->ExecuteSimpleSQL(CREATE_KEYWORD_VALIDITY_TRIGGER);
     NS_ENSURE_SUCCESS(rv, rv);
   }
 
   return NS_OK;
 }
diff --git a/toolkit/components/places/src/nsNavHistory.cpp b/toolkit/components/places/src/nsNavHistory.cpp
--- a/toolkit/components/places/src/nsNavHistory.cpp
+++ b/toolkit/components/places/src/nsNavHistory.cpp
@@ -42,10 +42,11 @@
 
 #include <stdio.h>
 #include "nsNavHistory.h"
 #include "nsNavBookmarks.h"
 #include "nsAnnotationService.h"
+#include "nsPlacesTables.h"
 
 #include "nsIArray.h"
 #include "nsArrayEnumerator.h"
 #include "nsCollationCID.h"
 #include "nsCOMPtr.h"
@@ -83,10 +84,11 @@
 #include "mozIStorageValueArray.h"
 #include "mozIStorageStatement.h"
 #include "mozIStorageFunction.h"
 #include "mozStorageCID.h"
 #include "mozStorageHelper.h"
+#include "nsPlacesTriggers.h"
 #include "nsAppDirectoryServiceDefs.h"
 #include "nsIIdleService.h"
 #include "nsILivemarkService.h"
 
 #include "nsMathUtils.h" // for NS_ceilf()
@@ -630,11 +632,11 @@ nsNavHistory::InitDBFile(PRBool aForceIn
 
 // nsNavHistory::InitDB
 //
 
 
-#define PLACES_SCHEMA_VERSION 6
+#define PLACES_SCHEMA_VERSION 7
 
 nsresult
 nsNavHistory::InitDB(PRInt16 *aMadeChanges)
 {
   nsresult rv;
@@ -716,11 +718,17 @@ nsNavHistory::InitDB(PRInt16 *aMadeChang
       if (DBSchemaVersion < 6) {
         rv = MigrateV6Up(mDBConn);
         NS_ENSURE_SUCCESS(rv, rv);
       }
 
-      // XXX Upgrades >V6 must add migration code here.
+      // Migrate historyvisits and bookmarks up to V7
+      if (DBSchemaVersion < 7) {
+        rv = MigrateV7Up(mDBConn);
+        NS_ENSURE_SUCCESS(rv, rv);
+      }
+
+      // XXX Upgrades >V7 must add migration code here.
 
     } else {
       // Downgrading
 
       // XXX Need to prompt user or otherwise notify of 
@@ -783,20 +791,11 @@ nsNavHistory::InitDB(PRInt16 *aMadeChang
   NS_ENSURE_SUCCESS(rv, rv);
 
   // moz_places
   if (!tableExists) {
     *aMadeChanges = DB_MIGRATION_CREATED;
-    rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING("CREATE TABLE moz_places ("
-        "id INTEGER PRIMARY KEY, "
-        "url LONGVARCHAR, "
-        "title LONGVARCHAR, "
-        "rev_host LONGVARCHAR, "
-        "visit_count INTEGER DEFAULT 0, "
-        "hidden INTEGER DEFAULT 0 NOT NULL, "
-        "typed INTEGER DEFAULT 0 NOT NULL, "
-        "favicon_id INTEGER, "
-        "frecency INTEGER DEFAULT -1 NOT NULL)"));
+    rv = mDBConn->ExecuteSimpleSQL(CREATE_MOZ_PLACES);
     NS_ENSURE_SUCCESS(rv, rv);
 
     rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
         "CREATE UNIQUE INDEX moz_places_url_uniqueindex ON moz_places (url)"));
     NS_ENSURE_SUCCESS(rv, rv);
@@ -821,17 +820,11 @@ nsNavHistory::InitDB(PRInt16 *aMadeChang
 
   // moz_historyvisits
   rv = mDBConn->TableExists(NS_LITERAL_CSTRING("moz_historyvisits"), &tableExists);
   NS_ENSURE_SUCCESS(rv, rv);
   if (! tableExists) {
-    rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING("CREATE TABLE moz_historyvisits ("
-        "id INTEGER PRIMARY KEY, "
-        "from_visit INTEGER, "
-        "place_id INTEGER, "
-        "visit_date INTEGER, "
-        "visit_type INTEGER, "
-        "session INTEGER)"));
+    rv = mDBConn->ExecuteSimpleSQL(CREATE_MOZ_HISTORYVISITS);
     NS_ENSURE_SUCCESS(rv, rv);
 
     rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
         "CREATE INDEX moz_historyvisits_placedateindex "
         "ON moz_historyvisits (place_id, visit_date)"));
@@ -844,21 +837,23 @@ nsNavHistory::InitDB(PRInt16 *aMadeChang
     NS_ENSURE_SUCCESS(rv, rv);
 
     rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
         "CREATE INDEX moz_historyvisits_dateindex ON moz_historyvisits (visit_date)"));
     NS_ENSURE_SUCCESS(rv, rv);
+
+    // Create our triggers for this table
+    rv = mDBConn->ExecuteSimpleSQL(CREATE_VISIT_COUNT_INSERT_TRIGGER);
+    NS_ENSURE_SUCCESS(rv, rv);
+    rv = mDBConn->ExecuteSimpleSQL(CREATE_VISIT_COUNT_DELETE_TRIGGER);
+    NS_ENSURE_SUCCESS(rv, rv);
   }
 
   // moz_inputhistory
   rv = mDBConn->TableExists(NS_LITERAL_CSTRING("moz_inputhistory"), &tableExists);
   NS_ENSURE_SUCCESS(rv, rv);
   if (!tableExists) {
-    rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING("CREATE TABLE moz_inputhistory ("
-        "place_id INTEGER NOT NULL, "
-        "input LONGVARCHAR NOT NULL, "
-        "use_count INTEGER, "
-        "PRIMARY KEY (place_id, input))"));
+    rv = mDBConn->ExecuteSimpleSQL(CREATE_MOZ_INPUTHISTORY);
     NS_ENSURE_SUCCESS(rv, rv);
   }
 
   PRBool migrated = PR_FALSE;
   rv = EnsureCurrentSchema(mDBConn, &migrated);
@@ -867,132 +862,18 @@ nsNavHistory::InitDB(PRInt16 *aMadeChang
     *aMadeChanges = DB_MIGRATION_UPDATED;
 
   rv = transaction.Commit();
   NS_ENSURE_SUCCESS(rv, rv);
 
-  rv = CreateTriggers();
-  NS_ENSURE_SUCCESS(rv, rv);
-
   // --- PUT SCHEMA-MODIFYING THINGS (like create table) ABOVE THIS LINE ---
 
   // DO NOT PUT ANY SCHEMA-MODIFYING THINGS HERE
 
   rv = InitFunctions();
   NS_ENSURE_SUCCESS(rv, rv);
   rv = InitStatements();
   NS_ENSURE_SUCCESS(rv, rv);
-
-  return NS_OK;
-}
-
-// nsNavHistory::CreateTriggers
-//
-//  This creates our triggers
-//  When creating a trigger we must ensure that related records are correct
-//  and be sure that there are no other queries that could change the 
-//  triggered values, especially for counting triggers.
-//
-// NOTE: never create loops between triggers!
-
-nsresult
-nsNavHistory::CreateTriggers()
-{
-  // we are creating 2 triggers on moz_historyvisits to maintain
-  // moz_places.visit_count in sync with moz_historyvisits, for this
-  // to work we must ensure that all visit_count values are correct
-  // See bug 416313 for details
-  nsCOMPtr<mozIStorageStatement> detectVisitCountTrigger;
-  nsresult rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING(
-      "SELECT name FROM sqlite_master WHERE type = 'trigger' AND "
-      "name = 'moz_historyvisits_afterinsert_v1_trigger'"),
-    getter_AddRefs(detectVisitCountTrigger));
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  PRBool hasTrigger;
-  rv = detectVisitCountTrigger->ExecuteStep(&hasTrigger);
-  NS_ENSURE_SUCCESS(rv, rv);
-  rv = detectVisitCountTrigger->Reset();
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  if (!hasTrigger) {
-    mozStorageTransaction createTriggersTransaction(mDBConn, PR_FALSE);
-
-    // do a one-time reset of all the visit_count values
-    rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
-      "UPDATE moz_places SET visit_count = "
-      "(SELECT count(*) FROM moz_historyvisits "
-      "WHERE place_id = moz_places.id AND visit_type NOT IN (0,4,7))"));
-    NS_ENSURE_SUCCESS(rv, rv);
-
-    // moz_historyvisits_afterinsert_v1_trigger
-    // increment visit_count by 1 for each inserted visit
-    // excluding invalid, embed, download visits
-    rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
-      "CREATE TRIGGER IF NOT EXISTS moz_historyvisits_afterinsert_v1_trigger "
-      "AFTER INSERT ON moz_historyvisits FOR EACH ROW "
-      "WHEN NEW.visit_type NOT IN (0,4,7) "
-      "BEGIN "
-        "UPDATE moz_places SET visit_count = visit_count + 1 "
-        "WHERE moz_places.id = NEW.place_id; "
-      "END"));
-    NS_ENSURE_SUCCESS(rv, rv);
-
-    // moz_historyvisits_afterdelete_v1_trigger
-    // decrement visit_count by 1 for each deleted visit
-    // ensure that we can't become negative
-    rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
-      "CREATE TRIGGER IF NOT EXISTS moz_historyvisits_afterdelete_v1_trigger "
-      "AFTER DELETE ON moz_historyvisits FOR EACH ROW "
-      "WHEN OLD.visit_type NOT IN (0,4,7) "
-      "BEGIN "
-        "UPDATE moz_places SET visit_count = visit_count - 1 "
-        "WHERE moz_places.id = OLD.place_id AND visit_count > 0; "
-      "END"));
-    NS_ENSURE_SUCCESS(rv, rv);
-
-    rv = createTriggersTransaction.Commit();
-    NS_ENSURE_SUCCESS(rv, rv);
-  }
-
-  // we are creating 1 trigger on moz_bookmarks to remove unused keywords
-  nsCOMPtr<mozIStorageStatement> detectRemoveKeywordsTrigger;
-  rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING(
-      "SELECT name FROM sqlite_master WHERE type = 'trigger' AND "
-      "name = 'moz_bookmarks_beforedelete_v1_trigger'"),
-    getter_AddRefs(detectRemoveKeywordsTrigger));
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  hasTrigger = PR_FALSE;
-  rv = detectRemoveKeywordsTrigger->ExecuteStep(&hasTrigger);
-  NS_ENSURE_SUCCESS(rv, rv);
-  rv = detectRemoveKeywordsTrigger->Reset();
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  if (!hasTrigger) {
-    // Remove dangling keywords.
-    // We must remove old keywords that have not been deleted with bookmarks.
-    // See bug 421180 for details.
-    rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
-        "DELETE FROM moz_keywords WHERE id IN ("
-          "SELECT k.id FROM moz_keywords k "
-          "LEFT OUTER JOIN moz_bookmarks b ON b.keyword_id = k.id "
-          "WHERE b.id IS NULL)"));
-    NS_ENSURE_SUCCESS(rv, rv);
-
-    // moz_bookmarks_beforedelete_v1_trigger
-    // Remove keywords if there are no more bookmarks using them.
-    rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
-      "CREATE TRIGGER IF NOT EXISTS moz_bookmarks_beforedelete_v1_trigger "
-      "BEFORE DELETE ON moz_bookmarks FOR EACH ROW "
-      "WHEN OLD.keyword_id NOT NULL "
-      "BEGIN "
-        "DELETE FROM moz_keywords WHERE id = OLD.keyword_id AND "
-        " NOT EXISTS (SELECT id FROM moz_bookmarks "
-          "WHERE keyword_id = OLD.keyword_id AND id <> OLD.id LIMIT 1); "
-      "END"));
-    NS_ENSURE_SUCCESS(rv, rv);
-  }
 
   return NS_OK;
 }
 
 nsresult
@@ -1374,10 +1255,12 @@ nsNavHistory::MigrateV3Up(mozIStorageCon
 
 // nsNavHistory::MigrateV6Up
 nsresult
 nsNavHistory::MigrateV6Up(mozIStorageConnection* aDBConn) 
 {
+  mozStorageTransaction transaction(aDBConn, PR_FALSE);
+
   // if dateAdded & lastModified cols are already there, then a partial update occurred,
   // and so we should not attempt to add these cols.
   nsCOMPtr<mozIStorageStatement> statement;
   nsresult rv = mDBConn->CreateStatement(NS_LITERAL_CSTRING(
     "SELECT a.dateAdded, a.lastModified FROM moz_annos a"), 
@@ -1416,11 +1299,93 @@ nsNavHistory::MigrateV6Up(mozIStorageCon
   NS_ENSURE_SUCCESS(rv, rv);
   rv = aDBConn->ExecuteSimpleSQL(
     NS_LITERAL_CSTRING("DROP INDEX IF EXISTS moz_anno_attributes_nameindex"));
   NS_ENSURE_SUCCESS(rv, rv);
 
-  return NS_OK;
+  return transaction.Commit();
+}
+
+// nsNavHistory::MigrateV7Up
+nsresult
+nsNavHistory::MigrateV7Up(mozIStorageConnection* aDBConn) 
+{
+  mozStorageTransaction transaction(aDBConn, PR_FALSE);
+
+  // Create a statement to test for trigger creation
+  nsCOMPtr<mozIStorageStatement> triggerDetection;
+  nsresult rv = aDBConn->CreateStatement(NS_LITERAL_CSTRING(
+    "SELECT name "
+    "FROM sqlite_master "
+    "WHERE type = 'trigger' "
+    "AND name = ?"
+  ), getter_AddRefs(triggerDetection));
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  // Check for existence
+  PRBool triggerExists;
+  rv = triggerDetection->BindUTF8StringParameter(
+    0, NS_LITERAL_CSTRING("moz_historyvisits_afterinsert_v1_trigger")
+  );
+  NS_ENSURE_SUCCESS(rv, rv);
+  rv = triggerDetection->ExecuteStep(&triggerExists);
+  NS_ENSURE_SUCCESS(rv, rv);
+  rv = triggerDetection->Reset();
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  // We need to create two triggers on moz_historyvists to maintain the
+  // accuracy of moz_places.visit_count.  For this to work, we must ensure that
+  // all moz_places.visit_count values are correct.
+  // See bug 416313 for details.
+  if (!triggerExists) {
+    // First, we do a one-time reset of all the moz_places.visit_count values.
+    rv = aDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+      "UPDATE moz_places SET visit_count = "
+        "(SELECT count(*) FROM moz_historyvisits "
+         "WHERE place_id = moz_places.id "
+         "AND visit_type NOT IN (0, 4, 7))") /* invalid, EMBED, DOWNLOAD */
+    );
+    NS_ENSURE_SUCCESS(rv, rv);
+
+    // Now we create our two triggers
+    rv = aDBConn->ExecuteSimpleSQL(CREATE_VISIT_COUNT_INSERT_TRIGGER);
+    NS_ENSURE_SUCCESS(rv, rv);
+    rv = aDBConn->ExecuteSimpleSQL(CREATE_VISIT_COUNT_DELETE_TRIGGER);
+    NS_ENSURE_SUCCESS(rv, rv);
+  }
+
+  // Check for existence
+  rv = triggerDetection->BindUTF8StringParameter(
+    0, NS_LITERAL_CSTRING("moz_bookmarks_beforedelete_v1_trigger")
+  );
+  NS_ENSURE_SUCCESS(rv, rv);
+  rv = triggerDetection->ExecuteStep(&triggerExists);
+  NS_ENSURE_SUCCESS(rv, rv);
+  rv = triggerDetection->Reset();
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  // We need to create one trigger on moz_bookmarks to remove unused keywords.
+  // See bug 421180 for details.
+  if (!triggerExists) {
+    // First, remove any existing dangling keywords
+    rv = mDBConn->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+      "DELETE FROM moz_keywords "
+      "WHERE id IN ("
+        "SELECT k.id "
+        "FROM moz_keywords k "
+        "LEFT OUTER JOIN moz_bookmarks b "
+        "ON b.keyword_id = k.id "
+        "WHERE b.id IS NULL"
+      ")")
+    );
+    NS_ENSURE_SUCCESS(rv, rv);
+
+    // Now we create our trigger
+    rv = aDBConn->ExecuteSimpleSQL(CREATE_KEYWORD_VALIDITY_TRIGGER);
+    NS_ENSURE_SUCCESS(rv, rv);
+  }
+
+  return transaction.Commit();
 }
 
 nsresult
 nsNavHistory::EnsureCurrentSchema(mozIStorageConnection* aDBConn, PRBool* aDidMigrate)
 {
diff --git a/toolkit/components/places/src/nsNavHistory.h b/toolkit/components/places/src/nsNavHistory.h
--- a/toolkit/components/places/src/nsNavHistory.h
+++ b/toolkit/components/places/src/nsNavHistory.h
@@ -459,14 +459,14 @@ protected:
    *          The database was migrated to a new version.
    */
   nsresult InitDB(PRInt16 *aMadeChanges);
   nsresult InitFunctions();
   nsresult InitStatements();
-  nsresult CreateTriggers();
   nsresult ForceMigrateBookmarksDB(mozIStorageConnection *aDBConn);
   nsresult MigrateV3Up(mozIStorageConnection *aDBConn);
   nsresult MigrateV6Up(mozIStorageConnection *aDBConn);
+  nsresult MigrateV7Up(mozIStorageConnection *aDBConn);
   nsresult EnsureCurrentSchema(mozIStorageConnection* aDBConn, PRBool *aMadeChanges);
   nsresult CleanUpOnQuit();
 
   nsresult RemovePagesInternal(const nsCString& aPlaceIdsQueryString);
 
diff --git a/toolkit/components/places/src/nsNavHistoryAutoComplete.cpp b/toolkit/components/places/src/nsNavHistoryAutoComplete.cpp
--- a/toolkit/components/places/src/nsNavHistoryAutoComplete.cpp
+++ b/toolkit/components/places/src/nsNavHistoryAutoComplete.cpp
@@ -488,10 +488,13 @@ nsNavHistory::StartSearch(const nsAStrin
   mOrigSearchString = aSearchString;
   // Remove whitespace, see bug #392141 for details
   mOrigSearchString.Trim(" \r\n\t\b");
   // Copy the input search string for case-insensitive search
   ToLowerCase(mOrigSearchString, mCurrentSearchString);
+
+  // Fix up the search the same way we fix up the entry url
+  mCurrentSearchString = FixupURIText(mCurrentSearchString);
 
   mCurrentListener = aListener;
 
   nsresult rv;
   mCurrentResult = do_CreateInstance(NS_AUTOCOMPLETESIMPLERESULT_CONTRACTID, &rv);
@@ -1005,10 +1008,19 @@ nsNavHistory::FixupURIText(const nsAStri
 nsNavHistory::FixupURIText(const nsAString &aURIText)
 {
   // Unescaping utilities expect UTF8 strings
   NS_ConvertUTF16toUTF8 escaped(aURIText);
 
+  // Strip off some prefixes so we don't have to match the exact protocol for
+  // sites. E.g., http://mozilla.org/ can match other mozilla.org pages.
+  if (StringBeginsWith(escaped, NS_LITERAL_CSTRING("https://")))
+    escaped.Cut(0, 8);
+  else if (StringBeginsWith(escaped, NS_LITERAL_CSTRING("http://")))
+    escaped.Cut(0, 7);
+  else if (StringBeginsWith(escaped, NS_LITERAL_CSTRING("ftp://")))
+    escaped.Cut(0, 6);
+
   nsString fixedUp;
   // Use the service if we have it to avoid invalid UTF8 strings
   if (mTextURIService) {
     mTextURIService->UnEscapeURIForUI(NS_LITERAL_CSTRING("UTF-8"),
       escaped, fixedUp);
diff --git a/toolkit/components/places/src/nsPlacesTables.h b/toolkit/components/places/src/nsPlacesTables.h
new file mode 100644
--- /dev/null
+++ b/toolkit/components/places/src/nsPlacesTables.h
@@ -0,0 +1,152 @@
+/* vim: sw=2 ts=2 sts=2 expandtab
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Places code.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Shawn Wilsher <me@shawnwilsher.com> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#ifndef __nsPlacesTables_h__
+#define __nsPlacesTables_h__
+
+#define CREATE_MOZ_PLACES NS_LITERAL_CSTRING( \
+  "CREATE TABLE moz_places ( " \
+    "  id INTEGER PRIMARY KEY" \
+    ", url LONGVARCHAR" \
+    ", title LONGVARCHAR" \
+    ", rev_host LONGVARCHAR" \
+    ", visit_count INTEGER DEFAULT 0" \
+    ", hidden INTEGER DEFAULT 0 NOT NULL" \
+    ", typed INTEGER DEFAULT 0 NOT NULL" \
+    ", favicon_id INTEGER" \
+    ", frecency INTEGER DEFAULT -1 NOT NULL" \
+  ")" \
+)
+
+#define CREATE_MOZ_HISTORYVISITS NS_LITERAL_CSTRING( \
+  "CREATE TABLE moz_historyvisits (" \
+    "  id INTEGER PRIMARY KEY" \
+    ", from_visit INTEGER" \
+    ", place_id INTEGER" \
+    ", visit_date INTEGER" \
+    ", visit_type INTEGER" \
+    ", session INTEGER" \
+  ")" \
+)
+
+#define CREATE_MOZ_INPUTHISTORY NS_LITERAL_CSTRING( \
+  "CREATE TABLE moz_inputhistory (" \
+    "  place_id INTEGER NOT NULL" \
+    ", input LONGVARCHAR NOT NULL" \
+    ", use_count INTEGER" \
+    ", PRIMARY KEY (place_id, input)" \
+  ")" \
+)
+
+#define CREATE_MOZ_ANNOS NS_LITERAL_CSTRING( \
+  "CREATE TABLE moz_annos (" \
+    "  id INTEGER PRIMARY KEY" \
+    ", place_id INTEGER NOT NULL" \
+    ", anno_attribute_id INTEGER" \
+    ", mime_type VARCHAR(32) DEFAULT NULL" \
+    ", content LONGVARCHAR" \
+    ", flags INTEGER DEFAULT 0" \
+    ", expiration INTEGER DEFAULT 0" \
+    ", type INTEGER DEFAULT 0" \
+    ", dateAdded INTEGER DEFAULT 0" \
+    ", lastModified INTEGER DEFAULT 0" \
+  ")" \
+)
+
+#define CREATE_MOZ_ANNO_ATTRIBUTES NS_LITERAL_CSTRING( \
+  "CREATE TABLE moz_anno_attributes (" \
+    "  id INTEGER PRIMARY KEY" \
+    ", name VARCHAR(32) UNIQUE NOT NULL" \
+  ")" \
+)
+
+#define CREATE_MOZ_ITEMS_ANNOS NS_LITERAL_CSTRING( \
+  "CREATE TABLE moz_items_annos (" \
+    "  id INTEGER PRIMARY KEY" \
+    ", item_id INTEGER NOT NULL" \
+    ", anno_attribute_id INTEGER" \
+    ", mime_type VARCHAR(32) DEFAULT NULL" \
+    ", content LONGVARCHAR" \
+    ", flags INTEGER DEFAULT 0" \
+    ", expiration INTEGER DEFAULT 0" \
+    ", type INTEGER DEFAULT 0" \
+    ", dateAdded INTEGER DEFAULT 0" \
+    ", lastModified INTEGER DEFAULT 0" \
+  ")" \
+)
+
+#define CREATE_MOZ_FAVICONS NS_LITERAL_CSTRING( \
+  "CREATE TABLE moz_favicons (" \
+    "  id INTEGER PRIMARY KEY" \
+    ", url LONGVARCHAR UNIQUE" \
+    ", data BLOB" \
+    ", mime_type VARCHAR(32)" \
+    ", expiration LONG" \
+  ")" \
+)
+
+#define CREATE_MOZ_BOOKMARKS NS_LITERAL_CSTRING( \
+  "CREATE TABLE moz_bookmarks (" \
+    "  id INTEGER PRIMARY KEY" \
+    ", type INTEGER" \
+    ", fk INTEGER DEFAULT NULL" /* place_id */ \
+    ", parent INTEGER" \
+    ", position INTEGER" \
+    ", title LONGVARCHAR" \
+    ", keyword_id INTEGER" \
+    ", folder_type TEXT" \
+    ", dateAdded INTEGER" \
+    ", lastModified INTEGER" \
+  ")" \
+)
+
+#define CREATE_MOZ_BOOKMARKS_ROOTS NS_LITERAL_CSTRING( \
+  "CREATE TABLE moz_bookmarks_roots (" \
+    "  root_name VARCHAR(16) UNIQUE" \
+    ", folder_id INTEGER" \
+  ")" \
+)
+
+#define CREATE_MOZ_KEYWORDS NS_LITERAL_CSTRING( \
+  "CREATE TABLE moz_keywords (" \
+    "  id INTEGER PRIMARY KEY AUTOINCREMENT" \
+    ", keyword TEXT UNIQUE" \
+  ")" \
+)
+
+#endif // __nsPlacesTables_h__
diff --git a/toolkit/components/places/src/nsPlacesTriggers.h b/toolkit/components/places/src/nsPlacesTriggers.h
new file mode 100644
--- /dev/null
+++ b/toolkit/components/places/src/nsPlacesTriggers.h
@@ -0,0 +1,96 @@
+/* vim: sw=2 ts=2 sts=2 expandtab
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Places code.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla Corporation.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Shawn Wilsher <me@shawnwilsher.com> (Original Author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#ifndef __nsPlacesTriggers_h__
+#define __nsPlacesTriggers_h__
+
+/**
+ * Trigger increments the visit count by one for each inserted visit that isn't
+ * an invalid transition, embedded transition, or a download transition.
+ */
+#define CREATE_VISIT_COUNT_INSERT_TRIGGER NS_LITERAL_CSTRING( \
+  "CREATE TRIGGER moz_historyvisits_afterinsert_v1_trigger " \
+  "AFTER INSERT ON moz_historyvisits FOR EACH ROW " \
+  "WHEN NEW.visit_type NOT IN (0, 4, 7) " /* invalid, EMBED, DOWNLOAD */ \
+  "BEGIN " \
+    "UPDATE moz_places " \
+    "SET visit_count = visit_count + 1 " \
+    "WHERE moz_places.id = NEW.place_id; " \
+  "END" \
+)
+
+/**
+ * Trigger decrements the visit count by one for each removed visit that isn't
+ * an invalid transition, embeded transition, or a download transition.  To be
+ * safe, we ensure that the visit count will not fall below zero.
+ */
+#define CREATE_VISIT_COUNT_DELETE_TRIGGER NS_LITERAL_CSTRING( \
+  "CREATE TRIGGER moz_historyvisits_afterdelete_v1_trigger " \
+  "AFTER DELETE ON moz_historyvisits FOR EACH ROW " \
+  "WHEN OLD.visit_type NOT IN (0, 4, 7) " /* invalid, EMBED, DOWNLOAD */ \
+  "BEGIN " \
+    "UPDATE moz_places " \
+    "SET visit_count = visit_count - 1 " \
+    "WHERE moz_places.id = OLD.place_id " \
+    "AND visit_count > 0; " \
+  "END" \
+)
+
+/**
+ * Trigger checks to ensure that at least one bookmark is still using a keyword
+ * when any bookmark is deleted.  If there are no more bookmarks using it, the
+ * keyword is deleted.
+ */
+#define CREATE_KEYWORD_VALIDITY_TRIGGER NS_LITERAL_CSTRING( \
+  "CREATE TRIGGER moz_bookmarks_beforedelete_v1_trigger " \
+  "BEFORE DELETE ON moz_bookmarks FOR EACH ROW " \
+  "WHEN OLD.keyword_id NOT NULL " \
+  "BEGIN " \
+    "DELETE FROM moz_keywords " \
+    "WHERE id = OLD.keyword_id " \
+    "AND NOT EXISTS ( " \
+      "SELECT id " \
+      "FROM moz_bookmarks " \
+      "WHERE keyword_id = OLD.keyword_id " \
+      "AND id <> OLD.id " \
+      "LIMIT 1 " \
+    ");" \
+  "END" \
+)
+
+#endif // __nsPlacesTriggers_h__
diff --git a/toolkit/components/places/tests/autocomplete/test_escape_self.js b/toolkit/components/places/tests/autocomplete/test_escape_self.js
new file mode 100644
--- /dev/null
+++ b/toolkit/components/places/tests/autocomplete/test_escape_self.js
@@ -0,0 +1,62 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Places Test Code.
+ *
+ * The Initial Developer of the Original Code is
+ * Edward Lee <edward.lee@engineering.uiuc.edu>.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+/**
+ * Test bug 422698 to make sure searches with urls from the location bar
+ * correctly match itself when it contains escaped characters.
+ */
+
+// Define some shared uris and titles (each page needs its own uri)
+let kURIs = [
+  "http://unescapeduri/",
+  "http://escapeduri/%40/",
+];
+let kTitles = [
+  "title",
+];
+
+// Add unescaped and escaped uris
+addPageBook(0, 0);
+addPageBook(1, 0);
+
+// Provide for each test: description; search terms; array of gPages indices of
+// pages that should match; optional function to be run before the test
+let gTests = [
+  ["0: Unescaped location matches itself",
+   kURIs[0], [0]],
+  ["1: Escaped location matches itself",
+   kURIs[1], [1]],
+];
diff --git a/toolkit/components/places/tests/autocomplete/test_ignore_protocol.js b/toolkit/components/places/tests/autocomplete/test_ignore_protocol.js
new file mode 100644
--- /dev/null
+++ b/toolkit/components/places/tests/autocomplete/test_ignore_protocol.js
@@ -0,0 +1,59 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Places Test Code.
+ *
+ * The Initial Developer of the Original Code is
+ * Edward Lee <edward.lee@engineering.uiuc.edu>.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+/**
+ * Test bug 424509 to make sure searching for "h" doesn't match "http" of urls.
+ */
+
+// Define some shared uris and titles (each page needs its own uri)
+let kURIs = [
+  "http://site/",
+  "http://happytimes/",
+];
+let kTitles = [
+  "title",
+];
+
+// Add site without "h" and with "h"
+addPageBook(0, 0);
+addPageBook(1, 0);
+
+// Provide for each test: description; search terms; array of gPages indices of
+// pages that should match; optional function to be run before the test
+let gTests = [
+  ["0: Searching for h matches site and not http://",
+   "h", [1]],
+];
diff --git a/toolkit/components/places/tests/autocomplete/test_swap_protocol.js b/toolkit/components/places/tests/autocomplete/test_swap_protocol.js
new file mode 100644
--- /dev/null
+++ b/toolkit/components/places/tests/autocomplete/test_swap_protocol.js
@@ -0,0 +1,85 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Places Test Code.
+ *
+ * The Initial Developer of the Original Code is
+ * Edward Lee <edward.lee@engineering.uiuc.edu>.
+ * Portions created by the Initial Developer are Copyright (C) 2008
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+/**
+ * Test bug 424717 to make sure searching with an existing location like
+ * http://site/ also matches https://site/ or ftp://site/. Same thing for
+ * ftp://site/ and https://site/.
+ */
+
+// Define some shared uris and titles (each page needs its own uri)
+let kURIs = [
+  "http://www.site/",
+  "http://site/",
+  "ftp://ftp.site/",
+  "ftp://site/",
+  "https://www.site/",
+  "https://site/",
+];
+let kTitles = [
+  "title",
+];
+
+// Add various protocols of site
+addPageBook(0, 0);
+addPageBook(1, 0);
+addPageBook(2, 0);
+addPageBook(3, 0);
+addPageBook(4, 0);
+addPageBook(5, 0);
+
+let allSite = [0,1,2,3,4,5];
+let allWWW = [0,4];
+
+// Provide for each test: description; search terms; array of gPages indices of
+// pages that should match; optional function to be run before the test
+let gTests = [
+  ["0: http://www. matches all www.site",
+   kURIs[0], allWWW],
+  ["1: http:// matches all site",
+   kURIs[1], allSite],
+  ["2: ftp://ftp. matches itself",
+   kURIs[2], [2]],
+  ["3: ftp:// matches all site",
+   kURIs[3], allSite],
+  ["4: https://www. matches all www.site",
+   kURIs[4], allWWW],
+  ["5: https:// matches all site",
+   kURIs[5], allSite],
+
+  ["6: www.site matches all www.site",
+   "www.site", allWWW],
+];
diff --git a/toolkit/components/places/tests/chrome/test_329534.xul b/toolkit/components/places/tests/chrome/test_329534.xul
new file mode 100644
--- /dev/null
+++ b/toolkit/components/places/tests/chrome/test_329534.xul
@@ -0,0 +1,157 @@
+<?xml version="1.0"?>
+<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
+<?xml-stylesheet
+  href="file:///c:/mozbuild/fx3.1/mozilla-central/testing/mochitest/tests/SimpleTest/test.css" type="text/css"?>
+<window title="Distribute to loading Livemark"
+  xmlns:html="http://www.w3.org/1999/xhtml"
+  xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
+  <script type="application/javascript"
+   src="chrome://mochikit/content/MochiKit/packed.js"></script>
+  <script type="application/javascript"
+   src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"></script>
+
+  <body xmlns="http://www.w3.org/1999/xhtml" />
+
+<script type="application/javascript">
+<![CDATA[
+/*
+ Test distribute the load of livemark update
+ */
+SimpleTest.waitForExplicitFinish();
+
+const Cc = Components.classes;
+const Ci = Components.interfaces;
+const Cr = Components.results;
+
+var iosvc = Cc["@mozilla.org/network/io-service;1"].getService(Ci.nsIIOService);
+
+function uri(spec) {
+  return iosvc.newURI(spec, null, null);
+}
+
+var lmsvc = Cc["@mozilla.org/browser/livemark-service;2"].
+              getService(Ci.nsILivemarkService);
+var bmsvc = Cc["@mozilla.org/browser/nav-bookmarks-service;1"].
+              getService(Ci.nsINavBookmarksService);
+var histsvc = Cc["@mozilla.org/browser/nav-history-service;1"].
+                getService(Ci.nsINavHistoryService);
+
+var toolbarFolderId = bmsvc.toolbarFolder;
+var status = 0;
+var secondFolderId = 0;
+var firstLoadTime = 0;
+
+// add 2 feeds
+const FEED1 = "http://localhost:8888/tests/toolkit/components/places/tests/chrome/rss_as_html.rss";
+gLivemarkId1 = lmsvc.createLivemarkFolderOnly( toolbarFolderId, "foo",
+                                             uri("http:/localhost:8888/"),
+                                             uri(FEED1), -1);
+bmsvc.removeChildAt( gLivemarkId1, 0 );
+
+const FEED2 = "http://localhost:8888/tests/toolkit/components/places/tests/chrome/sample_feed.atom";
+gLivemarkId2 = lmsvc.createLivemarkFolderOnly( toolbarFolderId, "bar",
+                                             uri("http:/localhost:8888/"),
+                                             uri(FEED2), -1);
+bmsvc.removeChildAt( gLivemarkId2, 0 );
+
+var observer =
+{
+  QueryInterface: function(iid) {
+    if (iid.equals(Ci.nsINavBookmarkObserver) ||
+        iid.equals(Ci.nsISupports))
+      return this;
+    throw Cr.NS_ERROR_NO_INTERFACE;
+  },
+
+  // nsINavBookmarkObserver
+  onBeginUpdateBatch: function(){},
+  onEndUpdateBatch: function(){},
+  onItemAdded: function(bookmarkId, folderId, index) {
+    if ( status == 0 ) {
+      runTest1( folderId );
+    } else {
+      runTest2( folderId );
+      if ( status == 2 ) {
+        bmsvc.removeObserver(this);
+        bmsvc.removeFolder(gLivemarkId1);
+        bmsvc.removeFolder(gLivemarkId2);
+        SimpleTest.finish();
+      }
+    }
+  },
+  onItemRemoved: function(bookmarkId, bookmark, folder, index){},
+  onItemChanged: function(bookmarkId, property, isAnnotationProperty, value){},
+  onItemVisited: function(bookmarkId, bookmark, aVisitID, time){},
+  onItemMoved: function(itemId, oldParent, oldIndex, newParent, newIndex){}
+};
+bmsvc.addObserver(observer, false);
+
+// start updating livemarks
+lmsvc.start();
+
+// First
+function runTest1( folderId ) {
+  if ( folderId == gLivemarkId1 )
+    secondFolderId = gLivemarkId2
+  else if ( folderId == gLivemarkId2 )
+    secondFolderId = gLivemarkId1;
+
+  if ( secondFolderId != 0 ) {
+    status++;
+    firstLoadTime = new Date();
+
+    /* first folder is loading now */
+    var options = histsvc.getNewQueryOptions();
+    var query = histsvc.getNewQuery();
+    query.setFolders([folderId], 1);
+    var result = histsvc.executeQuery(query, options);
+    var rootNode = result.root;
+    rootNode.containerOpen = true;
+    var cc = rootNode.childCount;
+    ok( cc == 1, "first livemark is empty" );
+    var node = rootNode.getChild( 0 );
+    ok( node.uri == "about:livemark-loading",
+        "first livemark item is invalid value "+node.uri);
+
+    /* second folder has no item */
+    options = histsvc.getNewQueryOptions();
+    query = histsvc.getNewQuery();
+    query.setFolders([secondFolderId], 1);
+    result = histsvc.executeQuery(query, options);
+    rootNode = result.root;
+    rootNode.containerOpen = true;
+    cc = rootNode.childCount;
+    ok( cc == 0, "second livemark is not empty" );
+  }
+}
+
+// Second
+function runTest2( folderId ) {
+  if ( folderId == secondFolderId ) {
+    status++;
+    var secondLoadTime = new Date();
+
+    /* second folder is loading now */
+    var options = histsvc.getNewQueryOptions();
+    var query = histsvc.getNewQuery();
+    query.setFolders([folderId], 1);
+    var result = histsvc.executeQuery(query, options);
+    var rootNode = result.root;
+    rootNode.containerOpen = true;
+    var cc = rootNode.childCount;
+    ok( cc == 1, "second livemark is empty" );
+    var node = rootNode.getChild( 0 );
+    ok( node.uri == "about:livemark-loading",
+        "second livemark item is invalid value "+node.uri);
+
+    /* check passed 3sec */
+    t = parseInt( (secondLoadTime - firstLoadTime) / 1000 );
+    ok( t >= 3, "not passed 3sec when second livemark loading" );
+  }
+}
+
+
+]]>
+</script>
+
+</window>
diff --git a/toolkit/components/satchel/src/nsFormFillController.cpp b/toolkit/components/satchel/src/nsFormFillController.cpp
--- a/toolkit/components/satchel/src/nsFormFillController.cpp
+++ b/toolkit/components/satchel/src/nsFormFillController.cpp
@@ -752,22 +752,10 @@ nsFormFillController::HandleEndCompositi
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsFormFillController::HandleQueryComposition(nsIDOMEvent* aCompositionEvent)
-{
-  return NS_OK;
-}
-
-NS_IMETHODIMP
-nsFormFillController::HandleQueryReconversion(nsIDOMEvent* aCompositionEvent)
-{
-  return NS_OK;
-}
-
-NS_IMETHODIMP
-nsFormFillController::HandleQueryCaretRect(nsIDOMEvent* aCompostionEvent)
 {
   return NS_OK;
 }
 
 ////////////////////////////////////////////////////////////////////////
diff --git a/toolkit/components/satchel/src/nsFormFillController.h b/toolkit/components/satchel/src/nsFormFillController.h
--- a/toolkit/components/satchel/src/nsFormFillController.h
+++ b/toolkit/components/satchel/src/nsFormFillController.h
@@ -89,12 +89,10 @@ public:
 
   // nsIDOMCompositionListener
   NS_IMETHOD HandleStartComposition(nsIDOMEvent* aCompositionEvent);
   NS_IMETHOD HandleEndComposition(nsIDOMEvent* aCompositionEvent);
   NS_IMETHOD HandleQueryComposition(nsIDOMEvent* aCompositionEvent);
-  NS_IMETHOD HandleQueryReconversion(nsIDOMEvent* aCompositionEvent);
-  NS_IMETHOD HandleQueryCaretRect(nsIDOMEvent* aCompositionEvent);
 
   // nsIDOMFormListener
   NS_IMETHOD Submit(nsIDOMEvent* aEvent);
   NS_IMETHOD Reset(nsIDOMEvent* aEvent);
   NS_IMETHOD Change(nsIDOMEvent* aEvent);
diff --git a/toolkit/content/tests/chrome/Makefile.in b/toolkit/content/tests/chrome/Makefile.in
--- a/toolkit/content/tests/chrome/Makefile.in
+++ b/toolkit/content/tests/chrome/Makefile.in
@@ -65,10 +65,12 @@ _TEST_FILES = 	findbar_window.xul \
 		window_popup_anchor.xul \
 		frame_popup_anchor.xul \
 		test_preferences.xul \
 		window_preferences.xul \
 		test_autocomplete2.xul \
+		test_keys.xul \
+		window_keys.xul \
 		$(NULL)
 
 ifeq (,$(filter mac cocoa,$(MOZ_WIDGET_TOOLKIT)))
 _TEST_FILES += test_panel_focus.xul \
                window_panel_focus.xul
diff --git a/toolkit/content/tests/chrome/test_keys.xul b/toolkit/content/tests/chrome/test_keys.xul
new file mode 100644
--- /dev/null
+++ b/toolkit/content/tests/chrome/test_keys.xul
@@ -0,0 +1,31 @@
+<?xml version="1.0"?>
+<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
+<?xml-stylesheet href="chrome://mochikit/content/tests/SimpleTest/test.css" type="text/css"?>
+
+<window title="Keys Test"
+  onload="setTimeout(runTest, 0);"
+  xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
+
+  <script type="application/javascript" 
+          src="chrome://mochikit/content/MochiKit/packed.js"/>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"/>
+
+<script>
+SimpleTest.waitForExplicitFinish();
+function runTest()
+{
+  window.open("window_keys.xul", "_blank", "chrome,width=200,height=200");
+}
+</script>
+
+<body xmlns="http://www.w3.org/1999/xhtml">
+<p id="display">
+</p>
+<div id="content" style="display: none">
+</div>
+<pre id="test">
+</pre>
+</body>
+
+</window>
diff --git a/toolkit/content/tests/chrome/window_keys.xul b/toolkit/content/tests/chrome/window_keys.xul
new file mode 100644
--- /dev/null
+++ b/toolkit/content/tests/chrome/window_keys.xul
@@ -0,0 +1,129 @@
+<?xml version="1.0"?>
+<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
+<?xml-stylesheet href="chrome://mochikit/content/tests/SimpleTest/test.css" type="text/css"?>
+
+<window title="Key Tests"
+  onfocus="setTimeout(runTest, 0);"
+  xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
+
+  <script type="application/javascript" 
+          src="chrome://mochikit/content/MochiKit/packed.js"/>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"/>
+  <script type="application/javascript"
+          src="chrome://mochikit/content/tests/SimpleTest/EventUtils.js"/>
+
+<script>
+<![CDATA[
+
+SimpleTest.waitForExplicitFinish();
+
+var gExpected = null;
+
+var keysToTest = [
+  ["k-v", "V", { } ],
+  ["", "V", { shiftKey: true } ],
+  ["k-v-scy", "V", { ctrlKey: true } ],
+  ["", "V", { altKey: true } ],
+  ["", "V", { metaKey: true } ],
+  ["k-v-scy", "V", { shiftKey: true, ctrlKey: true } ],
+  ["", "V", { shiftKey: true, ctrlKey: true, altKey: true } ],
+  ["k-e-y", "E", { } ],
+  ["", "E", { shiftKey: true } ],
+  ["", "E", { ctrlKey: true } ],
+  ["", "E", { altKey: true } ],
+  ["", "E", { metaKey: true } ],
+  ["k-d-a", "D", { altKey: true } ],
+  ["k-8-m", "8", { metaKey: true } ],
+  ["k-c-scaym", "C", { metaKey: true } ],
+  ["k-c-scaym", "C", { shiftKey: true, ctrlKey: true, altKey: true, metaKey: true } ],
+  ["", "V", { shiftKey: true, ctrlKey: true, altKey: true } ],
+  ["k-h-l", "H", { accelKey: true } ],
+//  ["k-j-s", "J", { accessKey: true } ],
+  ["", "T", { } ],
+  ["scommand", "Y", { } ],
+  ["", "U", { } ],
+];
+
+function runTest()
+{
+  iterateKeys(true, "normal");
+
+  var keyset = document.getElementById("keyset");
+  keyset.setAttribute("disabled", "true");
+  iterateKeys(false, "disabled");
+
+  var keyset = document.getElementById("keyset");
+  keyset.removeAttribute("disabled");
+  iterateKeys(true, "reenabled");
+
+  keyset.parentNode.removeChild(keyset);
+  iterateKeys(false, "removed");
+
+  document.documentElement.appendChild(keyset);
+  iterateKeys(true, "appended");
+
+  window.close();
+  window.opener.wrappedJSObject.SimpleTest.finish();
+}
+
+function iterateKeys(enabled, testid)
+{
+  for (var k = 0; k < keysToTest.length; k++) {
+    gExpected = keysToTest[k];
+    var expectedKey = gExpected[0];
+    if (!gExpected[2].accessKey || navigator.platform.indexOf("Mac") == -1) {
+      synthesizeKey(gExpected[1], gExpected[2]);
+      ok((enabled && expectedKey) || expectedKey == "k-d-a" ?
+         !gExpected : gExpected, testid + " key step " + (k + 1));
+    }
+  }
+}
+
+function checkKey(event)
+{
+  // the first element of the gExpected array holds the id of the <key> element
+  // that was expected. If this is empty, a handler wasn't expected to be called
+  if (gExpected[0])
+    is(event.originalTarget.id, gExpected[0], "key " + gExpected[1]);
+  else
+    is("key " + event.originalTarget.id + " was activated", "", "key " + gExpected[1]);
+  gExpected = null;
+}
+
+function is(l, r, n) { window.opener.wrappedJSObject.SimpleTest.is(l,r,n); }
+function ok(v, n) { window.opener.wrappedJSObject.SimpleTest.ok(v,n); }
+
+]]>
+</script>
+
+<command id="scommand" oncommand="checkKey(event)"/>
+<command id="scommand-disabled" disabled="true"/>
+
+<keyset id="keyset">
+  <key id="k-v" key="v" oncommand="checkKey(event)"/>
+  <key id="k-v-scy" key="v" modifiers="shift any control" oncommand="checkKey(event)"/>
+  <key id="k-e-y" key="e" modifiers="any" oncommand="checkKey(event)"/>
+  <key id="k-8-m" key="8" modifiers="meta" oncommand="checkKey(event)"/>
+  <key id="k-c-scaym" key="c" modifiers="shift control alt any meta" oncommand="checkKey(event)"/>
+  <key id="k-h-l" key="h" modifiers="accel" oncommand="checkKey(event)"/>
+  <key id="k-j-s" key="j" modifiers="access" oncommand="checkKey(event)"/>
+  <key id="k-t-y" disabled="true" key="t" oncommand="checkKey(event)"/>
+  <key id="k-y" key="y" command="scommand"/>
+  <key id="k-u" key="u" command="scommand-disabled"/>
+</keyset>
+
+<keyset id="keyset2">
+  <key id="k-d-a" key="d" modifiers="alt" oncommand="checkKey(event)"/>
+</keyset>
+
+<body xmlns="http://www.w3.org/1999/xhtml">
+<p id="display">
+</p>
+<div id="content" style="display: none">
+</div>
+<pre id="test">
+</pre>
+</body>
+
+</window>
diff --git a/toolkit/content/tests/widgets/Makefile.in b/toolkit/content/tests/widgets/Makefile.in
--- a/toolkit/content/tests/widgets/Makefile.in
+++ b/toolkit/content/tests/widgets/Makefile.in
@@ -82,10 +82,11 @@ _TEST_FILES = 	test_bug360220.xul \
 		test_tree_hier_cell.xul \
 		test_tree_column_reorder.xul \
 		tree_shared.js \
 		test_textbox_emptytext.xul \
 		test_textbox_number.xul \
+		test_textbox_search.xul \
 		xul_selectcontrol.js \
 		test_popupincontent.xul \
 		test_panelfrommenu.xul \
 		test_hiddenitems.xul \
 		test_hiddenpaging.xul \
diff --git a/toolkit/content/tests/widgets/test_textbox_search.xul b/toolkit/content/tests/widgets/test_textbox_search.xul
new file mode 100644
--- /dev/null
+++ b/toolkit/content/tests/widgets/test_textbox_search.xul
@@ -0,0 +1,172 @@
+<?xml version="1.0"?>
+<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
+<?xml-stylesheet href="/tests/SimpleTest/test.css" type="text/css"?>
+<!--
+  XUL Widget Test for search textbox
+  -->
+<window title="Search textbox test" width="500" height="600"
+        onload="window.focus();"
+        onfocus="if (!gDone) { gDone = true; doTests(); }"
+        xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
+  <script type="application/javascript" src="/MochiKit/packed.js"/>
+  <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"/>
+  <script type="application/javascript" src="/tests/SimpleTest/EventUtils.js"/>
+
+  <hbox>
+    <textbox id="searchbox"
+             type="search"
+             oncommand="doSearch(this.value);"
+             emptytext="random emptytext"
+             timeout="1"/>
+  </hbox>
+
+  <!-- test results are displayed in the html:body -->
+  <body xmlns="http://www.w3.org/1999/xhtml" style="height: 300px; overflow: auto;"/>
+
+  <!-- test code goes here -->
+  <script type="application/javascript"><![CDATA[
+
+SimpleTest.waitForExplicitFinish();
+
+var gDone = false;
+var gExpectedValue;
+var gLastTest;
+
+function doTests() {
+  var textbox = $("searchbox");
+  var icons = document.getAnonymousElementByAttribute(textbox, "anonid", "search-icons");
+  var searchIcon = document.getAnonymousElementByAttribute(textbox, "class", "textbox-search-icon");
+  var clearIcon = document.getAnonymousElementByAttribute(textbox, "class", "textbox-search-clear");
+
+  ok(icons, "icon deck found");
+  ok(searchIcon, "search icon found");
+  ok(clearIcon, "clear icon found");
+  is(icons.selectedPanel, searchIcon, "search icon is displayed");
+
+  is(textbox.emptyText, "random emptytext", "search textbox supports emptytext");
+  is(textbox.value, "", "emptytext doesn't interfere with the real value");
+
+  function iconClick(aIcon) {
+    is(icons.selectedPanel, aIcon, aIcon.className + " icon must be displayed in order to be clickable");
+
+    //XXX synthesizeMouse worked on Linux but failed on Windows an Mac
+    //    for unknown reasons. Manually dispatch the event for now.
+    //synthesizeMouse(aIcon, 0, 0, {});
+
+    var event = document.createEvent("MouseEvent");
+    event.initMouseEvent("click", true, true, window, 1,
+                         0, 0, 0, 0,
+                         false, false, false, false,
+                         0, null);
+    aIcon.dispatchEvent(event);
+  }
+
+  iconClick(searchIcon);
+  is(textbox.getAttribute("focused"), "true", "clicking the search icon focuses the textbox");
+
+  textbox.value = "foo";
+  is(icons.selectedPanel, clearIcon, "clear icon is displayed when setting a value");
+
+  textbox.reset();
+  is(textbox.defaultValue, "", "defaultValue is empty");
+  is(textbox.value, "", "reset method clears the textbox");
+  is(icons.selectedPanel, searchIcon, "search icon is displayed after textbox.reset()");
+
+  textbox.value = "foo";
+  gExpectedValue = "";
+  iconClick(clearIcon);
+  is(textbox.value, "", "clicking the clear icon clears the textbox");
+  ok(gExpectedValue == null, "search triggered when clearing the textbox with the clear icon");
+
+  textbox.value = "foo";
+  gExpectedValue = "";
+  synthesizeKey("VK_ESCAPE", {});
+  is(textbox.value, "", "escape key clears the textbox");
+  ok(gExpectedValue == null, "search triggered when clearing the textbox with the escape key");
+
+  textbox.value = "bar";
+  gExpectedValue = "bar";
+  textbox.doCommand();
+  ok(gExpectedValue == null, "search triggered with doCommand");
+
+  gExpectedValue = "bar";
+  synthesizeKey("VK_RETURN", {});
+  ok(gExpectedValue == null, "search triggered with enter key");
+
+  textbox.value = "";
+  textbox.searchButton = true;
+  is(textbox.getAttribute("searchbutton"), "true", "searchbutton attribute set on the textbox");
+  is(searchIcon.getAttribute("searchbutton"), "true", "searchbutton attribute inherited to the search icon");
+
+  textbox.value = "foo";
+  is(icons.selectedPanel, searchIcon, "search icon displayed in search button mode if there's a value");
+
+  gExpectedValue = "foo";
+  iconClick(searchIcon);
+  ok(gExpectedValue == null, "search triggered when clicking the search icon in search button mode");
+  is(icons.selectedPanel, clearIcon, "clear icon displayed in search button mode after submitting");
+
+  synthesizeKey("o", {});
+  is(icons.selectedPanel, searchIcon, "search icon displayed in search button mode when typing a key");
+
+  gExpectedValue = "fooo";
+  iconClick(searchIcon); // display the clear icon (tested above)
+
+  textbox.value = "foo";
+  is(icons.selectedPanel, searchIcon, "search icon displayed in search button mode when the value is changed");
+
+  gExpectedValue = "foo";
+  synthesizeKey("VK_RETURN", {});
+  ok(gExpectedValue == null, "search triggered with enter key in search button mode");
+  is(icons.selectedPanel, clearIcon, "clear icon displayed in search button mode after submitting with enter key");
+
+  textbox.value = "x";
+  synthesizeKey("VK_BACK_SPACE", {});
+  is(icons.selectedPanel, searchIcon, "search icon displayed in search button mode when deleting the value with the backspace key");
+
+  gExpectedValue = "";
+  synthesizeKey("VK_RETURN", {});
+  ok(gExpectedValue == null, "search triggered with enter key in search button mode");
+  is(icons.selectedPanel, searchIcon, "search icon displayed in search button mode after submitting an empty string");
+
+  textbox.readOnly = true;
+  gExpectedValue = "foo";
+  textbox.value = "foo";
+  iconClick(searchIcon);
+  ok(gExpectedValue == null, "search triggered when clicking the search icon in search button mode while the textbox is read-only");
+  is(icons.selectedPanel, searchIcon, "search icon persists in search button mode after submitting while the textbox is read-only");
+  textbox.readOnly = false;
+
+  textbox.disabled = true;
+  is(searchIcon.getAttribute("disabled"), "true", "disabled attribute inherited to the search icon");
+  is(clearIcon.getAttribute("disabled"), "true", "disabled attribute inherited to the clear icon");
+  gExpectedValue = false;
+  textbox.value = "foo";
+  iconClick(searchIcon);
+  ok(gExpectedValue == false, "search *not* triggered when clicking the search icon in search button mode while the textbox is disabled");
+  is(icons.selectedPanel, searchIcon, "search icon persists in search button mode when trying to submit while the textbox is disabled");
+  textbox.disabled = false;
+  ok(!searchIcon.hasAttribute("disabled"), "disabled attribute removed from the search icon");
+  ok(!clearIcon.hasAttribute("disabled"), "disabled attribute removed from the clear icon");
+
+  textbox.searchButton = false;
+  ok(!textbox.hasAttribute("searchbutton"), "searchbutton attribute removed from the textbox");
+  ok(!searchIcon.hasAttribute("searchbutton"), "searchbutton attribute removed from the search icon");
+
+  gLastTest = true;
+  gExpectedValue = "123";
+  textbox.value = "1";
+  synthesizeKey("2", {});
+  synthesizeKey("3", {});
+}
+
+function doSearch(aValue) {
+  is(aValue, gExpectedValue, "search triggered with expected value");
+  gExpectedValue = null;
+  if (gLastTest)
+    SimpleTest.finish();
+}
+
+  ]]></script>
+
+</window>
diff --git a/toolkit/content/widgets/browser.xml b/toolkit/content/widgets/browser.xml
--- a/toolkit/content/widgets/browser.xml
+++ b/toolkit/content/widgets/browser.xml
@@ -955,10 +955,43 @@
             }
           }
         ]]>
         </body>
       </method>
+
+      <method name="swapDocShells">
+        <parameter name="aOtherBrowser"/>
+        <body>
+        <![CDATA[
+          // We need to swap fields that are tied to our docshell
+          var fieldsToSwap = [ "_docShell", "_webBrowserFind" ];
+
+          var ourTabBrowser = this.getTabBrowser();
+
+          // _fastFind is tied to the docshell if we don't have a tabbrowser
+          if ((ourTabBrowser != null) !=
+              (aOtherBrowser.getTabBrowser() != null))
+            throw "Unable to perform swap on <browsers> if one is in a <tabbrowser> and one is not";
+
+          if (!ourTabBrowser)
+            fieldsToSwap.push("_fastFind");
+
+          var ourFieldValues = {};
+          var otherFieldValues = {};
+          for each (var field in fieldsToSwap) {
+            ourFieldValues[field] = this[field];
+            otherFieldValues[field] = aOtherBrowser[field];
+          }
+          this.QueryInterface(Components.interfaces.nsIFrameLoaderOwner)
+              .swapFrameLoaders(aOtherBrowser);
+          for each (var field in fieldsToSwap) {
+            this[field] = otherFieldValues[field];
+            aOtherBrowser[field] = ourFieldValues[field];
+          }
+        ]]>
+        </body>
+      </method>
     </implementation>
 
     <handlers>
       <handler event="keypress" keycode="VK_F7" group="system">
         <![CDATA[
diff --git a/toolkit/content/widgets/textbox.xml b/toolkit/content/widgets/textbox.xml
--- a/toolkit/content/widgets/textbox.xml
+++ b/toolkit/content/widgets/textbox.xml
@@ -1,8 +1,10 @@
 <?xml version="1.0"?>
 
 <!DOCTYPE bindings [
+  <!ENTITY % globalDTD SYSTEM "chrome://global/locale/global.dtd">
+  %globalDTD;
   <!ENTITY % textcontextDTD SYSTEM "chrome://global/locale/textcontext.dtd" >
   %textcontextDTD;
 ]>
 
 <bindings id="textboxBindings"
@@ -335,10 +337,128 @@
         ]]>
       </handler>
     </handlers>
   </binding>
 
+  <binding id="search-textbox" extends="chrome://global/content/bindings/textbox.xml#textbox">
+    <content>
+      <children/>
+      <xul:hbox class="textbox-input-box" flex="1" xbl:inherits="context,spellcheck" align="center">
+        <html:input class="textbox-input" flex="1" anonid="input"
+                    xbl:inherits="onfocus,onblur,value,type,maxlength,disabled,size,readonly,tabindex,accesskey"/>
+        <xul:deck class="textbox-search-icons" anonid="search-icons">
+          <xul:image class="textbox-search-icon"
+                     onclick="document.getBindingParent(this)._iconClick();"
+                     xbl:inherits="src=image,searchbutton,disabled"
+                     chromedir="&locale.dir;"/>
+          <xul:image class="textbox-search-clear"
+                     onclick="document.getBindingParent(this)._clearSearch();"
+                     xbl:inherits="disabled"
+                     chromedir="&locale.dir;"/>
+        </xul:deck>
+      </xul:hbox>
+    </content>
+    <implementation>
+      <field name="_timer">null</field>
+      <field name="_searchIcons">
+        document.getAnonymousElementByAttribute(this, "anonid", "search-icons");
+      </field>
+      <property name="timeout"
+                onset="this.setAttribute('timeout', val); return val;"
+                onget="return parseInt(this.getAttribute('timeout')) || 500;"/>
+      <property name="searchButton"
+                onget="return this.hasAttribute('searchbutton');"
+                onset="if (val) this.setAttribute('searchbutton', 'true');
+                       else this.removeAttribute('searchbutton'); return val;"/>
+      <property name="value"
+                onget="return this.hasAttribute('empty') ? '' : this.inputField.value;">
+        <setter><![CDATA[
+          if (val) {
+            // clear the emptyText _before_ setting a new non-empty value
+            this._clearEmptyText();
+            this.inputField.value = val;
+            this._searchIcons.selectedIndex = this.searchButton ? 0 : 1;
+          } else {
+            // display the emptyText _after_ setting a value that's an empty string
+            this.inputField.value = val;
+            this._updateVisibleText();
+            this._searchIcons.selectedIndex = 0;
+          }
+          if (this._timer)
+            clearTimeout(this._timer);
+          return val;
+        ]]></setter>
+      </property>
+      <method name="_fireCommand">
+        <parameter name="me"/>
+        <body><![CDATA[
+          if (me._timer)
+            clearTimeout(me._timer);
+          me._timer = null;
+          me.doCommand();
+        ]]></body>
+      </method>
+      <method name="_iconClick">
+        <body><![CDATA[
+          if (this.searchButton)
+            this._enterSearch();
+          else
+            this.focus();
+        ]]></body>
+      </method>
+      <method name="_enterSearch">
+        <body><![CDATA[
+          if (this.disabled)
+            return;
+          if (this.searchButton && this.value && !this.readOnly)
+            this._searchIcons.selectedIndex = 1;
+          this._fireCommand(this);
+        ]]></body>
+      </method>
+      <method name="_clearSearch">
+        <body><![CDATA[
+          if (!this.disabled && !this.readOnly && this.value) {
+            this.value = "";
+            this._fireCommand(this);
+            this._searchIcons.selectedIndex = 0;
+            return true;
+          }
+          return false;
+        ]]></body>
+      </method>
+    </implementation>
+    <handlers>
+      <handler event="input">
+        <![CDATA[
+          if (this.searchButton) {
+            this._searchIcons.selectedIndex = 0;
+            return;
+          }
+          if (this._timer)
+            clearTimeout(this._timer);
+          this._timer = this.timeout && setTimeout(this._fireCommand, this.timeout, this);
+          this._searchIcons.selectedIndex = this.value ? 1 : 0;
+        ]]>
+      </handler>
+      <handler event="keypress" keycode="VK_ESCAPE">
+        <![CDATA[
+          if (this._clearSearch()) {
+            event.preventDefault();
+            event.stopPropagation();
+          }
+        ]]>
+      </handler>
+      <handler event="keypress" keycode="VK_RETURN">
+        <![CDATA[
+          this._enterSearch();
+          event.preventDefault();
+          event.stopPropagation();
+        ]]>
+      </handler>
+    </handlers>
+  </binding>
+
   <binding id="textarea" extends="chrome://global/content/bindings/textbox.xml#textbox">
     <content>
       <xul:hbox class="textbox-input-box" flex="1" xbl:inherits="context,spellcheck">
         <html:textarea class="textbox-textarea" flex="1" anonid="input"
                        xbl:inherits="onfocus,onblur,xbl:text=value,disabled,tabindex,rows,cols,readonly,wrap"><children/></html:textarea>
diff --git a/toolkit/content/xul.css b/toolkit/content/xul.css
--- a/toolkit/content/xul.css
+++ b/toolkit/content/xul.css
@@ -700,10 +700,14 @@ html|*.textbox-textarea {
 
 textbox[type="timed"] {
   -moz-binding: url("chrome://global/content/bindings/textbox.xml#timed-textbox");
 }
 
+textbox[type="search"] {
+  -moz-binding: url("chrome://global/content/bindings/textbox.xml#search-textbox");
+}
+
 textbox[type="number"] {
   -moz-binding: url("chrome://global/content/bindings/numberbox.xml#numberbox");
 }
 
 /********** autocomplete textbox **********/
diff --git a/toolkit/library/libxul-config.mk b/toolkit/library/libxul-config.mk
--- a/toolkit/library/libxul-config.mk
+++ b/toolkit/library/libxul-config.mk
@@ -275,11 +275,13 @@ COMPONENT_LIBS += system-pref
 COMPONENT_LIBS += system-pref
 endif
 endif
 
 ifdef MOZ_ENABLE_GTK2
+ifdef MOZ_X11
 STATIC_LIBS += gtkxtbin
+endif
 endif
 
 ifdef MOZ_IPCD
 DEFINES += -DMOZ_IPCD
 COMPONENT_LIBS += ipcdc
diff --git a/toolkit/mozapps/downloads/content/downloads.js b/toolkit/mozapps/downloads/content/downloads.js
--- a/toolkit/mozapps/downloads/content/downloads.js
+++ b/toolkit/mozapps/downloads/content/downloads.js
@@ -461,19 +461,15 @@ function Startup()
   obs.addObserver(gDownloadObserver, "download-manager-remove-download", false);
 
   // Clear the search box and move focus to the list on escape from the box
   gSearchBox.addEventListener("keypress", function(e) {
     if (e.keyCode == e.DOM_VK_ESCAPE) {
-      // Clear the input as if the user did it
-      gSearchBox.value = "";
-      gSearchBox.doCommand();
-
       // Move focus to the list instead of closing the window
       gDownloadsView.focus();
       e.preventDefault();
     }
-  }, true);
+  }, false);
 }
 
 function Shutdown()
 {
   gDownloadManager.removeListener(gDownloadListener);
diff --git a/toolkit/mozapps/downloads/content/downloads.xul b/toolkit/mozapps/downloads/content/downloads.xul
--- a/toolkit/mozapps/downloads/content/downloads.xul
+++ b/toolkit/mozapps/downloads/content/downloads.xul
@@ -187,10 +187,10 @@
     <button id="clearListButton" command="cmd_clearList"
             label="&cmd.clearList.label;"
             accesskey="&cmd.clearList.accesskey;"
             tooltiptext="&cmd.clearList.tooltip;"/>
     <spacer flex="1"/>
-    <textbox type="timed" timeout="500" id="searchbox"
+    <textbox type="search" id="searchbox"
              oncommand="buildDownloadList();" emptytext="&searchBox.label;"/>
   </hbox>
 
 </window>
diff --git a/toolkit/mozapps/extensions/content/extensions.css b/toolkit/mozapps/extensions/content/extensions.css
--- a/toolkit/mozapps/extensions/content/extensions.css
+++ b/toolkit/mozapps/extensions/content/extensions.css
@@ -145,14 +145,10 @@ richlistitem[opType="needs-disable"] hbo
 richlistitem[opType="needs-disable"] hbox.addon-optype,
 richlistitem[opType="needs-disable"] hbox.addon-description {
   -moz-binding: url("chrome://mozapps/content/extensions/extensions.xml#addon-needs-disable");
 }
 
-#searchbox {
-  -moz-binding: url("chrome://mozapps/content/extensions/extensions.xml#search-textbox");
-}
-
 #viewGroup radio {
   -moz-binding: url("chrome://mozapps/content/extensions/extensions.xml#viewbutton");
   -moz-box-orient: vertical;
   -moz-box-align: center;
   -moz-appearance: none;
diff --git a/toolkit/mozapps/extensions/content/extensions.js b/toolkit/mozapps/extensions/content/extensions.js
--- a/toolkit/mozapps/extensions/content/extensions.js
+++ b/toolkit/mozapps/extensions/content/extensions.js
@@ -353,11 +353,11 @@ function showView(aView) {
                             ["link", "?link" ] ] ];
       var types = [ [ ["searchResult", "true", null] ],
                     [ ["statusMessage", "true", null] ] ];
       var displays = [ "richlistitem", "vbox" ];
       showCheckUpdatesAll = false;
-      document.getElementById("searchbox").disabled = isOffline("offlineSearchMsg");
+      document.getElementById("searchfield").disabled = isOffline("offlineSearchMsg");
       break;
     case "extensions":
       prefURL = PREF_EXTENSIONS_GETMOREEXTENSIONSURL;
       types = [ [ ["type", nsIUpdateItem.TYPE_EXTENSION, "Integer"] ] ];
       break;
@@ -641,13 +641,13 @@ function displaySearchThrobber(aKey) {
                    true);
 }
 
 // Clears the search box and updates the result list
 function resetSearch() {
-  var searchbox = document.getElementById("searchbox");
-  searchbox.value = "";
-  searchbox.focus();
+  var searchfield = document.getElementById("searchfield");
+  searchfield.value = "";
+  searchfield.focus();
   retrieveRepositoryAddons("");
 }
 
 // Searches for results
 function retrieveRepositoryAddons(aTerms) {
@@ -796,13 +796,12 @@ function displaySearchResults(addons, co
                      true);
     gSearchDS.Assert(labelNode,
                      gRDF.GetResource(PREFIX_NS_EM + "count"),
                      gRDF.GetIntLiteral(count),
                      true);
-    var searchbox = document.getElementById("searchbox");
-    // The value attribute will be the persisted value of the last search run
-    url = gAddonRepository.getSearchURL(searchbox.getAttribute("value"));
+    var searchfield = document.getElementById("searchfield");
+    url = gAddonRepository.getSearchURL(searchfield.value);
   }
   gSearchDS.Assert(labelNode,
                    gRDF.GetResource(PREFIX_NS_EM + "link"),
                    gRDF.GetLiteral(url),
                    true);
@@ -873,11 +872,11 @@ function initSearchDS() {
                         .createInstance(Components.interfaces.nsIRDFDataSource);
   gExtensionsView.database.AddDataSource(gSearchDS);
   var ioService = Components.classes["@mozilla.org/network/io-service;1"]
                             .getService(nsIIOService);
   if (!ioService.offline)
-    retrieveRepositoryAddons(document.getElementById("searchbox").value);
+    retrieveRepositoryAddons(document.getElementById("searchfield").value);
 }
 
 function initPluginsDS()
 {
   gPluginsDS = Components.classes["@mozilla.org/rdf/datasource;1?name=in-memory-datasource"]
@@ -1967,13 +1966,13 @@ const gAddonsMsgObserver = {
       var ioService = Components.classes["@mozilla.org/network/io-service;1"]
                                 .getService(nsIIOService);
       ioService.offline = false;
       // If no results have been retrieved start pulling some
       if (!gRetrievedResults)
-        retrieveRepositoryAddons(document.getElementById("searchbox").value);
+        retrieveRepositoryAddons(document.getElementById("searchfield").value);
       if (gView == "search")
-        document.getElementById("searchbox").disabled = false;
+        document.getElementById("searchfield").disabled = false;
       break;
     case "addons-message-dismiss":
       break;
     case "addons-restart-app":
       restartApp();
diff --git a/toolkit/mozapps/extensions/content/extensions.xml b/toolkit/mozapps/extensions/content/extensions.xml
--- a/toolkit/mozapps/extensions/content/extensions.xml
+++ b/toolkit/mozapps/extensions/content/extensions.xml
@@ -877,119 +877,10 @@
         </xul:vbox>
       </xul:hbox>
     </content>  
   </binding>
 
-  <binding id="search-textbox" extends="xul:box">
-    <resources>
-      <stylesheet src="chrome://global/skin/textbox.css"/>
-    </resources>
-
-    <content align="center">
-      <xul:textbox class="plain"
-                   xbl:inherits="emptytext,onfocus,onblur,spellcheck,value,maxlength,disabled,size,readonly,tabindex,accesskey"/>
-      <xul:button class="searchbox-search" xbl:inherits="disabled" oncommand="this.parentNode.startSearch()" chromedir="&locale.dir;"/>
-      <xul:button class="searchbox-cancel" xbl:inherits="disabled" hidden="true" oncommand="this.parentNode.clearSearch()"/>
-    </content>
-
-    <implementation>
-      <field name="textbox">
-        document.getAnonymousNodes(this)[0];
-      </field>
-
-      <field name="_searchButton">
-        document.getAnonymousElementByAttribute(this, "class", "searchbox-search");
-      </field>
-
-      <field name="_cancelButton">
-        document.getAnonymousElementByAttribute(this, "class", "searchbox-cancel");
-      </field>
-
-      <property name="value" onget="return this.textbox.value">
-        <setter>
-          this.textbox.value = val;
-          this.setAttribute("value", val);
-          this._cancelButton.hidden = !val;
-          this._searchButton.hidden = !!val;
-        </setter>
-      </property>
-
-      <property name="disabled" onget="return this.textbox.disabled">
-        <setter>
-          if (val)
-            this.setAttribute("disabled", "true");
-          else
-            this.removeAttribute("disabled");
-        </setter>
-      </property>
-
-      <constructor>
-        if (this.value) {
-          this._cancelButton.hidden = false;
-          this._searchButton.hidden = true;
-        }
-      </constructor>
-
-      <method name="startSearch">
-        <body>
-          if (this.value) {
-            this._cancelButton.hidden = false;
-            this._searchButton.hidden = true;
-          }
-          this.setAttribute("value", this.value);
-        </body>
-      </method>
-
-      <method name="clearSearch">
-        <body>
-          this.value = "";
-          this.setAttribute("value", "");
-          this._cancelButton.hidden = true;
-          this._searchButton.hidden = false;
-          this.focus();
-        </body>
-      </method>
-
-      <method name="_dispatchCommandEvent">
-        <parameter name="aEvent"/>
-        <body>
-          var event = document.createEvent("commandevent");
-          event.initCommandEvent("command", true, true, window, null,
-                                 false, false, false, false, aEvent);
-          this.dispatchEvent(event);
-        </body>
-      </method>
-    </implementation>
-    
-    <handlers>
-      <handler event="focus" phase="capturing">
-        if (event.originalTarget == this)
-          this.textbox.focus(); // Forward focus to actual textbox
-      </handler>
-
-      <handler event="keypress" keycode="VK_ENTER">
-        if (event.originalTarget == this.textbox.inputField) {
-          this.startSearch();
-          this._dispatchCommandEvent(event);
-        }
-      </handler>
-
-      <handler event="keypress" keycode="VK_RETURN">
-        if (event.originalTarget == this.textbox.inputField) {
-          this.startSearch();
-          this._dispatchCommandEvent(event);
-        }
-      </handler>
-
-      <handler event="input">
-        this._cancelButton.hidden = true;
-        this._searchButton.hidden = false;
-      </handler>
-
-    </handlers>
-  </binding>
-
 <!-- based on preferences.xml paneButton -->
   <binding id="viewbutton" extends="chrome://global/content/bindings/radio.xml#radio">
     <resources>
       <stylesheet src="chrome://mozapps/skin/extensions/extensions.css"/>
     </resources>
diff --git a/toolkit/mozapps/extensions/content/extensions.xul b/toolkit/mozapps/extensions/content/extensions.xul
--- a/toolkit/mozapps/extensions/content/extensions.xul
+++ b/toolkit/mozapps/extensions/content/extensions.xul
@@ -181,13 +181,13 @@
     </vbox>
   </stack>
   <notificationbox id="addonsMsg" flex="1">
     <vbox id="extensionsBox" flex="1">
       <hbox id="searchPanel" align="center">
-        <textbox id="searchbox" emptytext="&searchAddons.label;"
-                 oncommand="retrieveRepositoryAddons(this.value);"
-                 persist="value"/>
+        <textbox id="searchfield" emptytext="&searchAddons.label;"
+                 type="search" searchbutton="true"
+                 oncommand="retrieveRepositoryAddons(this.value);"/>
         <spacer flex="1"/>
         <label id="browseAddons" class="text-link" value="&browseAddons.label;"
                onclick="openURL(this.getAttribute('homepageURL'));"/>
       </hbox>
       
diff --git a/toolkit/spatial-navigation/SpatialNavigation.js b/toolkit/spatial-navigation/SpatialNavigation.js
--- a/toolkit/spatial-navigation/SpatialNavigation.js
+++ b/toolkit/spatial-navigation/SpatialNavigation.js
@@ -38,30 +38,31 @@
  * 
  * Import this module through
  *
  * Components.utils.import("resource://gre/modules/SpatialNavigation.js");
  *
- * Usage:
+ * Usage: (Literal class)
  *
- *
- * var snav = new SpatialNavigation(browser_element, optional_callback);
+ * SpatialNavigation(browser_element, optional_callback);
  *
  * optional_callback will be called when a new element is focused.
  *
  *    function optional_callback(element) {}
  *
  */
 
 
 var EXPORTED_SYMBOLS = ["SpatialNavigation"];
 
-function SpatialNavigation (browser, callback)
-{
-  browser.addEventListener("keypress", function (event) { _onInputKeyPress(event, callback) }, true);
-};
+var SpatialNavigation = {
 
-SpatialNavigation.prototype = {
+  init: function(browser, callback) {
+    browser.addEventListener("keypress", function (event) { _onInputKeyPress(event, callback) }, true);
+  },
+  
+  uninit: function() {
+  }
 };
 
 
 // Private stuff
 
@@ -76,22 +77,27 @@ function dump(msg)
 
 var gDirectionalBias = 10;
 var gRectFudge = 1;
 
 function _onInputKeyPress (event, callback) {
-  
-  var target = event.target;
 
   // If it isn't an arrow key, bail.
   if (event.keyCode != event.DOM_VK_LEFT  &&
       event.keyCode != event.DOM_VK_RIGHT &&
       event.keyCode != event.DOM_VK_UP    &&
       event.keyCode != event.DOM_VK_DOWN  )
     return;
   
   // check to see if we are in a textarea or text input element, and if so,
   // ensure that we let the arrow keys work properly.
+
+  var target = event.target;
+  
+  if (target instanceof Ci.nsIDOMHTMLHtmlElement) {
+      _focusNextUsingCmdDispatcher(event, callback);
+      return;
+  }
 
   if ((target instanceof Ci.nsIDOMHTMLInputElement && (target.type == "text" || target.type == "password")) ||
       target instanceof Ci.nsIDOMHTMLTextAreaElement ) {
     
     // if there is any selection at all, just ignore
@@ -129,11 +135,11 @@ function _onInputKeyPress (event, callba
         return;
     }
   }
 
   function snavfilter(node) {
-    
+
     if (node instanceof Ci.nsIDOMHTMLLinkElement ||
         node instanceof Ci.nsIDOMHTMLAnchorElement) {
       // if a anchor doesn't have a href, don't target it.
       if (node.href == "")
         return Ci.nsIDOMNodeFilter.FILTER_SKIP;
@@ -153,36 +159,40 @@ function _onInputKeyPress (event, callba
   }
   var bestElementToFocus = null;
   var distanceToBestElement = Infinity;
   var focusedRect = _inflateRect(target.getBoundingClientRect(),
                                  - gRectFudge);
+
   var doc = target.ownerDocument;
-  
+
   var treeWalker = doc.createTreeWalker(doc, Ci.nsIDOMNodeFilter.SHOW_ELEMENT, snavfilter, false);
   var nextNode;
   
   while ((nextNode = treeWalker.nextNode())) {
-    
+
     if (nextNode == target)
       continue;
 
     var nextRect = _inflateRect(nextNode.getBoundingClientRect(),
                                 - gRectFudge);
     
     if (! _isRectInDirection(event, focusedRect, nextRect))
       continue;
-    
+
     var distance = _spatialDistance(event, focusedRect, nextRect);
+
+    //dump("looking at: " + nextNode + " " + distance);
     
     if (distance <= distanceToBestElement && distance > 0) {
       distanceToBestElement = distance;
       bestElementToFocus = nextNode;
     }
   }
   
   if (bestElementToFocus != null) {
-    dump("focusing element  " + bestElementToFocus.nodeName + " " + bestElementToFocus) + "id=" + bestElementToFocus.getAttribute("id");
+    //dump("focusing element  " + bestElementToFocus.nodeName + " " + bestElementToFocus) + "id=" + bestElementToFocus.getAttribute("id");
+
     // Wishing we could do element.focus()
     doc.defaultView.QueryInterface(Ci.nsIInterfaceRequestor).getInterface(Ci.nsIDOMWindowUtils).focus(bestElementToFocus);
 
     // if it is a text element, select all.
     if((bestElementToFocus instanceof Ci.nsIDOMHTMLInputElement && (bestElementToFocus.type == "text" || bestElementToFocus.type == "password")) ||
@@ -194,24 +204,30 @@ function _onInputKeyPress (event, callba
     if (callback != undefined)
       callback(bestElementToFocus);
     
   } else {
     // couldn't find anything.  just advance and hope.
-    var windowMediator = Cc['@mozilla.org/appshell/window-mediator;1'].getService(Ci.nsIWindowMediator);
-    var window = windowMediator.getMostRecentWindow("navigator:browser");
-    
-    if (event.keyCode == event.DOM_VK_RIGHT || event.keyCode != event.DOM_VK_DOWN  )
-      window.document.commandDispatcher.advanceFocus();
-    else
-      window.document.commandDispatcher.rewindFocus();
-    
-    if (callback != undefined)
-      callback(null);
+    _focusNextUsingCmdDispatcher(event, callback);
   }
   
   event.preventDefault();
   event.stopPropagation();
+}
+
+function _focusNextUsingCmdDispatcher(event, callback) {
+
+    var windowMediator = Cc['@mozilla.org/appshell/window-mediator;1'].getService(Ci.nsIWindowMediator);
+    var window = windowMediator.getMostRecentWindow("navigator:browser");
+
+    if (event.keyCode == event.DOM_VK_RIGHT || event.keyCode == event.DOM_VK_DOWN  ) {
+      window.document.commandDispatcher.advanceFocus();
+    } else {
+      window.document.commandDispatcher.rewindFocus();
+    }
+
+    if (callback != undefined)
+      callback(null);
 }
 
 function _isRectInDirection(event, focusedRect, anotherRect)
 {
     if (event.keyCode == event.DOM_VK_LEFT) {  
diff --git a/toolkit/spatial-navigation/tests/chrome/test_snav.xul b/toolkit/spatial-navigation/tests/chrome/test_snav.xul
--- a/toolkit/spatial-navigation/tests/chrome/test_snav.xul
+++ b/toolkit/spatial-navigation/tests/chrome/test_snav.xul
@@ -60,17 +60,19 @@ var moveTable = [
 ];
 
 function onLoad()
 {
     var x = document.getElementById("some-content");
-    var snav = new SpatialNavigation(x);
+    SpatialNavigation.init(x);
 
     // get to a known place.
     document.getElementById("start").focus();
     
     testMoves(moveTable);
 
     SimpleTest.waitForExplicitFinish();
+
+    SpatialNavigation.uninit();
 }
 
 ]]></script>
 </window>
diff --git a/toolkit/spatial-navigation/tests/chrome/test_snav_disabledElement.xul b/toolkit/spatial-navigation/tests/chrome/test_snav_disabledElement.xul
--- a/toolkit/spatial-navigation/tests/chrome/test_snav_disabledElement.xul
+++ b/toolkit/spatial-navigation/tests/chrome/test_snav_disabledElement.xul
@@ -43,17 +43,19 @@ var moveTable = [
 ];
 
 function onLoad()
 {
     var x = document.getElementById("some-content");
-    var snav = new SpatialNavigation(x);
+    SpatialNavigation.init(x);
 
     // get to a known place.
     document.getElementById("start").focus();
 
     testMoves(moveTable);
     
     SimpleTest.waitForExplicitFinish();
+
+    SpatialNavigation.uninit();
 }
 
 ]]></script>
 </window>
diff --git a/toolkit/spatial-navigation/tests/chrome/test_snav_selects.xul b/toolkit/spatial-navigation/tests/chrome/test_snav_selects.xul
--- a/toolkit/spatial-navigation/tests/chrome/test_snav_selects.xul
+++ b/toolkit/spatial-navigation/tests/chrome/test_snav_selects.xul
@@ -54,17 +54,19 @@ Components.utils.import("resource://gre/
 Components.utils.import("resource://gre/modules/SpatialNavigation.js");
 
 function onLoad()
 {
     var x = document.getElementById("some-content");
-    var snav = new SpatialNavigation(x);
+    SpatialNavigation.init(x);
     
     // get to a known place.
     document.getElementById("start").focus();
     
     testMoves(moveTable);
 
     SimpleTest.waitForExplicitFinish();
+
+    SpatialNavigation.uninit();
 }
 
 ]]></script>
 </window>
diff --git a/toolkit/spatial-navigation/tests/chrome/test_snav_textFields.xul b/toolkit/spatial-navigation/tests/chrome/test_snav_textFields.xul
--- a/toolkit/spatial-navigation/tests/chrome/test_snav_textFields.xul
+++ b/toolkit/spatial-navigation/tests/chrome/test_snav_textFields.xul
@@ -112,17 +112,19 @@ var moveTable = [
 ];
 
 function onLoad()
 {
     var x = document.getElementById("some-content");
-    var snav = new SpatialNavigation(x);
+    SpatialNavigation.init(x);
     
     // get to a known place.
     document.getElementById("start").focus();
 
     testMoves(moveTable);
 
     SimpleTest.waitForExplicitFinish();
+
+    SpatialNavigation.uninit();
 }
 
 ]]></script>
 </window>
diff --git a/toolkit/spatial-navigation/tests/chrome/test_snav_tightlinks.xul b/toolkit/spatial-navigation/tests/chrome/test_snav_tightlinks.xul
--- a/toolkit/spatial-navigation/tests/chrome/test_snav_tightlinks.xul
+++ b/toolkit/spatial-navigation/tests/chrome/test_snav_tightlinks.xul
@@ -92,17 +92,19 @@ var moveTable = [
 ];
 
 function onLoad()
 {
     var x = document.getElementById("some-content");
-    var snav = new SpatialNavigation(x);
+    SpatialNavigation.init(x);
 
     // get to a known place.
     document.getElementById("1").focus();
 
     testMoves(moveTable);
 
     SimpleTest.waitForExplicitFinish();
+
+    SpatialNavigation.uninit();
 }
 
 ]]></script>
 </window>
diff --git a/toolkit/themes/gnomestripe/global/textbox.css b/toolkit/themes/gnomestripe/global/textbox.css
--- a/toolkit/themes/gnomestripe/global/textbox.css
+++ b/toolkit/themes/gnomestripe/global/textbox.css
@@ -89,19 +89,38 @@ textbox[readonly="true"] {
 
 textbox[disabled="true"] {
   cursor: default;
   background-color: -moz-Dialog;
   color: GrayText;
-} 
+}
 
 /* ::::: plain textbox ::::: */
 
 textbox.plain {
   -moz-appearance: none !important;
   padding: 0px !important;
   margin: 0px !important;
   border: none !important;
+}
+
+/* ::::: search textbox ::::: */
+
+.textbox-search-icon {
+  list-style-image: url(chrome://global/skin/icons/Search-glass.png);
+}
+
+.textbox-search-icon[chromedir="rtl"] {
+  list-style-image: url(chrome://global/skin/icons/Search-glass-rtl.png);
+}
+
+.textbox-search-clear {
+  list-style-image: url(moz-icon://stock/gtk-clear?size=menu);
+}
+
+.textbox-search-icon[searchbutton]:not([disabled]) ,
+.textbox-search-clear:not([disabled]) {
+  cursor: pointer;
 }
 
 /* ::::: textboxes inside toolbarpaletteitems ::::: */
 
 toolbarpaletteitem > toolbaritem > textbox > .textbox-input-box > html|*.textbox-input {
diff --git a/toolkit/themes/gnomestripe/mozapps/extensions/extensions.css b/toolkit/themes/gnomestripe/mozapps/extensions/extensions.css
--- a/toolkit/themes/gnomestripe/mozapps/extensions/extensions.css
+++ b/toolkit/themes/gnomestripe/mozapps/extensions/extensions.css
@@ -336,30 +336,10 @@ vbox[typeName="status"][type="header-rec
 vbox[typeName="status"][type="header-recommended"] {
   font-size: 150%;
   background: -moz-dialog;
 }
 
-.searchbox-search, .searchbox-cancel {
-  -moz-appearance: none;
-  cursor: default;
-  background-color: transparent;
-  margin: 0;
-  border: 0;
-  padding: 0;
-  width: 16px;
-  height: 16px;
-  min-width: 16px;
-}
-
-.searchbox-search {
-  list-style-image: url("chrome://mozapps/skin/extensions/searchIcons.png");
-}
-
-.searchbox-cancel {
-  list-style-image: url("moz-icon://stock/gtk-clear?size=menu");
-}
-
 #progressBox {
   padding: 5px 5px 5px 5px;
 }
 
 #progressBox > hbox {
diff --git a/toolkit/themes/gnomestripe/mozapps/extensions/searchIcons.png b/toolkit/themes/gnomestripe/mozapps/extensions/searchIcons.png
deleted file mode 100644
Binary file toolkit/themes/gnomestripe/mozapps/extensions/searchIcons.png has changed
diff --git a/toolkit/themes/gnomestripe/mozapps/jar.mn b/toolkit/themes/gnomestripe/mozapps/jar.mn
--- a/toolkit/themes/gnomestripe/mozapps/jar.mn
+++ b/toolkit/themes/gnomestripe/mozapps/jar.mn
@@ -3,11 +3,10 @@ classic.jar:
 + skin/classic/mozapps/update/updates.css                  (update/updates.css)
 + skin/classic/mozapps/downloads/downloadIcon.png          (downloads/downloadIcon.png)
 + skin/classic/mozapps/downloads/downloads.css             (downloads/downloads.css)
 + skin/classic/mozapps/extensions/notifyBadges.png         (extensions/notifyBadges.png)
 + skin/classic/mozapps/extensions/extensionIcons.png       (extensions/extensionIcons.png)
-+ skin/classic/mozapps/extensions/searchIcons.png          (extensions/searchIcons.png)
 + skin/classic/mozapps/extensions/extensions.css           (extensions/extensions.css)
 + skin/classic/mozapps/extensions/ratings.png              (extensions/ratings.png)
 + skin/classic/mozapps/extensions/themeGeneric.png         (extensions/themeGeneric.png)
 + skin/classic/mozapps/extensions/viewButtons.png          (extensions/viewButtons.png)
 + skin/classic/mozapps/passwordmgr/key.png                 (passwordmgr/key.png)
diff --git a/toolkit/themes/pinstripe/global/icons/Search-close.png b/toolkit/themes/pinstripe/global/icons/Search-close.png
new file mode 100644
index 0000000000000000000000000000000000000000..dcbd2ae970133022b57bf8e8595949c72fe41195
GIT binary patch
literal 581
zc$@)60=oT)P)<h;3K|Lk000e1NJLTq000gE000gM1^@s6A4o0H00001b5ch_0Itp)
z=>Px#24YJ`L;(K){{a7>y{D4^000SaNLh0L03N{r03N{s!)a7g00007bV*G`2iOM|
z4muIAY%?$b00G5GL_t(2&z+J_s}fNdhoA9J$Z4!Q$MBMdZh~WidoPU_E{L08z|YV&
z=Ccgaw$C6969fq@?1FHYE^?sFT#`U@)HD&JYnyvS>aIGw-^=fT=jA={pU?O!p8z#L
z0Z(pcUx5%90*kxAaz3AbVOiGmTrPKFnx+Y`Ua!})*=#YN&o3vF$vYrA22U!L%1g_#
zE~J$5F10w0<N194aWope0Tu}WrBq!*K@gm|u3OfC>$>G22+pLG(z2`zrBodt1yCpy
z&V>*X!1w*B<2VHkwpy)%@B32#DW%M0GUs6!zE1%p5{Zf~dY*R;pkd$lr=I6s3n4h}
zCIGV8tf@gE#4edk-sqf6CU1lgJDqh`t1hD`GWAZaR_j#jIgWFhPN#o&I-N*&4`8WO
z8bwi5Jl;twYi$jdN~O`^9Q}U3+3j{;g<+VF<M@6illi6fHk-}8?RJ}%QvOs*P1^1D
z>qeu|O99xneYIMxdO$M_!~F66gb+I+#7-$SX*QcZ+qSO`s)k`K_xt_Za=E-23<maa
zID9l7j~@UOi^U(cTJ3wiUjJ0BRzDbqvHa(+?)UqLz%$?}@c4H84fq0l))2rSW4EVQ
Tu~g|V00000NkvXXu0mjfvWNaj

diff --git a/toolkit/themes/pinstripe/global/icons/Search-glass.png b/toolkit/themes/pinstripe/global/icons/Search-glass.png
index 90dc860826d919e029c3a47ae9f947f899e3a3d2..ade53c8570493dc5c8f0c553dfb76a8151963fa2
GIT binary patch
literal 377
zc%17D@N?(olHy`uVBq!ia0vp^d?3uh1|;P@bT0xa#^NA%Cx&(BWL^R}Y)RhkE)4%c
zaKYZ?lYt_f1s;*b3=G`DAk4@xYmNj^kiEpy*OmPSyBMF9=8U}VbwHt?o-U3d8t3O;
z+UwOE$iw#FdCk^Ev+aWg)x`x{E_ud$VOp|!`@^L#LU(jeo@~`Ix#Llq<HFf~Rv{Z|
z=6iFkv=Cu#|1-fnf70ZnD6J_M0v2=Hs;b`1eY2puw}ZE!Kf2~WYtG{S<|Aqw=RMYG
zj-I%q+qvcu)AAih*sX3HlWx1XYiGh+x5m{gZ2ArzzVP?N&XcECT=FSr%zD(TtX8y&
z=g;&I!#@gt;<EO)-1U}T_qmAcS#lenn86{TZyVcPW7v1h{A#Vn{;^4T&*IFb`>Xn<
zUO)Jub$LS6F)Oo=9f30+K1pD8XRJF~_*#5}=k`eT`WE(_L|wj=G|h;)7WS#T?b1aT
S%y0w-0)wZkpUXO@geCwAyqCHF

diff --git a/toolkit/themes/pinstripe/global/jar.mn b/toolkit/themes/pinstripe/global/jar.mn
--- a/toolkit/themes/pinstripe/global/jar.mn
+++ b/toolkit/themes/pinstripe/global/jar.mn
@@ -124,10 +124,11 @@ classic.jar:
 +  skin/classic/global/icons/notfound.png                             (icons/notfound.png)
 +  skin/classic/global/icons/popup-icon-spacer.png                    (icons/popup-icon-spacer.png)
 +  skin/classic/global/icons/popup-overlay.png                        (icons/popup-overlay.png)
 +  skin/classic/global/icons/question-mark.png                        (icons/question-mark.png)
 +  skin/classic/global/icons/restore.gif                              (icons/restore.gif)
++  skin/classic/global/icons/Search-close.png                         (icons/Search-close.png)
 +  skin/classic/global/icons/Search-glass.png                         (icons/Search-glass.png)
 +  skin/classic/global/icons/search-textbox.png                       (icons/search-textbox.png)
 +  skin/classic/global/icons/small-document.png                       (icons/small-document.png)
 +  skin/classic/global/icons/small-globe-sunken-grey.png              (icons/small-globe-sunken-grey.png)
 +  skin/classic/global/icons/small-globe-sunken.png                   (icons/small-globe-sunken.png)
diff --git a/toolkit/themes/pinstripe/global/textbox.css b/toolkit/themes/pinstripe/global/textbox.css
--- a/toolkit/themes/pinstripe/global/textbox.css
+++ b/toolkit/themes/pinstripe/global/textbox.css
@@ -116,25 +116,42 @@ textbox.plain {
 }
 
 
 /* ::::: rounded search box ::::: */
 
-#search-box {
+textbox[type="search"] {
   -moz-appearance: none;
   border: 3px solid;
   -moz-border-top-colors: #5F5F5F #CFCFCF -moz-Field;
   -moz-border-bottom-colors: #9F9F9F #EEE -moz-Field;
   -moz-border-right-colors: #7F7F7F #EEE -moz-Field;
   -moz-border-left-colors: #7F7F7F #EFEFEF -moz-Field;
   -moz-border-radius: 11px;
-  background: url("chrome://global/skin/icons/search-textbox.png") -moz-Field no-repeat 1px center;
-  -moz-background-clip: border !important;
   padding: 0 8px;
+}
+
+textbox[type="search"]:not([searchbutton]) {
+  background-image: url("chrome://global/skin/icons/Search-glass.png");
+  background-repeat: no-repeat;
+  background-position: 1px center;
   -moz-padding-start: 17px;
 }
 
-#search-box[focused="true"] {
+textbox[type="search"][focused="true"] {
   outline: 2px solid #4A8BC7;
   outline-offset: -2px;
   -moz-outline-radius: 11px;
 }
 
+.textbox-search-icon[searchbutton] {
+  list-style-image: url(chrome://global/skin/icons/Search-glass.png);
+}
+
+.textbox-search-clear {
+  list-style-image: url(chrome://global/skin/icons/Search-close.png);
+}
+
+.textbox-search-icon[searchbutton]:not([disabled]) ,
+.textbox-search-clear:not([disabled]) {
+  cursor: default;
+}
+
diff --git a/toolkit/themes/pinstripe/mozapps/downloads/downloads.css b/toolkit/themes/pinstripe/mozapps/downloads/downloads.css
--- a/toolkit/themes/pinstripe/mozapps/downloads/downloads.css
+++ b/toolkit/themes/pinstripe/mozapps/downloads/downloads.css
@@ -132,25 +132,5 @@ richlistitem[type="download"] button {
 }
 
 #clearListButton:hover:active:not([disabled="true"]) {
   background: url(chrome://global/skin/icons/white-gray-gradient-active.gif);
 }
-
-#searchbox {
-  -moz-appearance: none;
-  border: 3px solid;
-  -moz-border-top-colors: #676767 #C5C5C5 -moz-Field;
-  -moz-border-bottom-colors: #C2C2C2 #A4A4A4 -moz-Field;
-  -moz-border-right-colors: #969696 #C5C5C5 -moz-Field;
-  -moz-border-left-colors: #969696 #C5C5C5 -moz-Field;
-  -moz-border-radius: 11.5px;
-  background: url("chrome://global/skin/icons/search-textbox.png") -moz-Field no-repeat 1px center;
-  -moz-background-clip: border !important;
-  padding: 0 8px;
-  -moz-padding-start: 16px;
-}
-
-#searchbox[focused="true"] {
-  outline: 2px solid -moz-mac-focusring;
-  outline-offset: -2px;
-  -moz-outline-radius: 100%;
-}
diff --git a/toolkit/themes/pinstripe/mozapps/extensions/extensions.css b/toolkit/themes/pinstripe/mozapps/extensions/extensions.css
--- a/toolkit/themes/pinstripe/mozapps/extensions/extensions.css
+++ b/toolkit/themes/pinstripe/mozapps/extensions/extensions.css
@@ -348,50 +348,10 @@ vbox[typeName="status"][type="header-rec
 
 #searchPanel {
   border-bottom: 1px solid #878787;
 }
 
-#searchbox {
-  -moz-appearance: none;
-  border: 3px solid;
-  -moz-border-top-colors: #5F5F5F #CFCFCF -moz-Field;
-  -moz-border-bottom-colors: #9F9F9F #EEE -moz-Field;
-  -moz-border-right-colors: #7F7F7F #EEE -moz-Field;
-  -moz-border-left-colors: #7F7F7F #EFEFEF -moz-Field;
-  -moz-border-radius: 11px;
-  -moz-background-clip: border !important;
-  padding: 0 8px;
-}
-
-#searchbox[focused="true"] {
-  outline: 2px solid #4A8BC7;
-  outline-offset: -2px;
-  -moz-outline-radius: 11px;
-}
-
-
-.searchbox-search, .searchbox-cancel {
-  list-style-image: url(chrome://mozapps/skin/extensions/searchIcons.png);
-  -moz-appearance: none;
-  cursor: default;
-  margin: 0;
-  border: 0;
-  padding: 0;
-  width: 16px;
-  height: 16px;
-  min-width: 16px;
-  min-height: 16px;
-}
-
-.searchbox-search {
-  -moz-image-region: rect(0px 16px 16px 0px);
-}
-
-.searchbox-cancel {
-  -moz-image-region: rect(0px 32px 16px 16px);
-}
-
 #progressBox {
   padding: 5px 5px 5px 5px;
 }
 
 #progressBox > hbox {
diff --git a/toolkit/themes/pinstripe/mozapps/extensions/searchIcons.png b/toolkit/themes/pinstripe/mozapps/extensions/searchIcons.png
deleted file mode 100644
Binary file toolkit/themes/pinstripe/mozapps/extensions/searchIcons.png has changed
diff --git a/toolkit/themes/pinstripe/mozapps/jar.mn b/toolkit/themes/pinstripe/mozapps/jar.mn
--- a/toolkit/themes/pinstripe/mozapps/jar.mn
+++ b/toolkit/themes/pinstripe/mozapps/jar.mn
@@ -11,11 +11,10 @@ classic.jar:
   skin/classic/mozapps/extensions/notifyBadges.png                (extensions/notifyBadges.png)
   skin/classic/mozapps/extensions/themeGeneric.png                (extensions/themeGeneric.png)
   skin/classic/mozapps/extensions/viewButtons.png                 (extensions/viewButtons.png)
   skin/classic/mozapps/extensions/ratings.png                     (extensions/ratings.png)
   skin/classic/mozapps/extensions/extensionIcons.png              (extensions/extensionIcons.png)
-  skin/classic/mozapps/extensions/searchIcons.png                 (extensions/searchIcons.png)
   skin/classic/mozapps/extensions/about.css                       (extensions/about.css)
   skin/classic/mozapps/extensions/extensions.css                  (extensions/extensions.css)
   skin/classic/mozapps/extensions/extensions.xml                  (extensions/extensions.xml)
   skin/classic/mozapps/extensions/update.css                      (extensions/update.css)
   skin/classic/mozapps/extensions/eula.css                        (extensions/eula.css)
diff --git a/toolkit/themes/winstripe/global/textbox.css b/toolkit/themes/winstripe/global/textbox.css
--- a/toolkit/themes/winstripe/global/textbox.css
+++ b/toolkit/themes/winstripe/global/textbox.css
@@ -89,21 +89,59 @@ textbox[readonly="true"] {
 
 textbox[disabled="true"] {
   cursor: default;
   background-color: -moz-Dialog;
   color: GrayText;
-} 
+}
 
 /* ::::: plain textbox ::::: */
 
 textbox.plain {
   -moz-appearance: none !important;
   padding: 0px !important;
   margin: 0px !important;
   border: none !important;
 }
 
+/* ::::: search textbox ::::: */
+
+.textbox-search-icon {
+  list-style-image: url(chrome://global/skin/icons/Search-glass.png);
+  -moz-image-region: rect(0, 16px, 16px, 0);
+}
+
+.textbox-search-icon[chromedir="rtl"] {
+  list-style-image: url(chrome://global/skin/icons/Search-glass-rtl.png);
+}
+
+.textbox-search-icon[searchbutton]:not([disabled]) {
+  cursor: pointer;
+}
+
+.textbox-search-clear {
+  list-style-image: url(chrome://global/skin/icons/Search-close.png);
+  -moz-image-region: rect(0, 16px, 16px, 0);
+}
+
+.textbox-search-clear:not([disabled]) {
+  cursor: default;
+}
+
+.textbox-search-clear[chromedir="rtl"] {
+  list-style-image: url(chrome://global/skin/icons/Search-close-rtl.png);
+}
+
+.textbox-search-clear:not([disabled]):hover ,
+.textbox-search-icon[searchbutton]:not([disabled]):hover {
+  -moz-image-region: rect(0, 32px, 16px, 16px);
+}
+
+.textbox-search-clear:not([disabled]):hover:active ,
+.textbox-search-icon[searchbutton]:not([disabled]):hover:active {
+  -moz-image-region: rect(0, 48px, 16px, 32px);
+}
+
 /* ::::: textboxes inside toolbarpaletteitems ::::: */
 
 toolbarpaletteitem > toolbaritem > textbox > .textbox-input-box > html|*.textbox-input {
   visibility: hidden;
 }
diff --git a/toolkit/themes/winstripe/mozapps/extensions/extensions.css b/toolkit/themes/winstripe/mozapps/extensions/extensions.css
--- a/toolkit/themes/winstripe/mozapps/extensions/extensions.css
+++ b/toolkit/themes/winstripe/mozapps/extensions/extensions.css
@@ -328,63 +328,10 @@ vbox[typeName="status"][type="header-rec
 vbox[typeName="status"][type="header-recommended"] {
   font-size: 150%;
   background: -moz-dialog;
 }
 
-#searchbox {
-  padding: 2px;
-}
-
-.searchbox-search,
-.searchbox-cancel {
-  -moz-appearance: none;
-  cursor: default;
-  margin: 0;
-  border: 0;
-  padding: 0;
-  width: 16px;
-  height: 16px;
-  min-width: 16px;
-  background-color: -moz-field;
-}
-
-.searchbox-search {
-  list-style-image: url("chrome://global/skin/icons/Search-glass.png");
-  -moz-image-region: rect(0px 16px 16px 0px);
-}
-
-.searchbox-search[chromedir="rtl"] {
-  list-style-image: url("chrome://global/skin/icons/Search-glass-rtl.png");
-}
-
-.searchbox-search:hover {
-  -moz-image-region: rect(0px 32px 16px 16px);
-}
-
-.searchbox-search:hover:active {
-  -moz-image-region: rect(0px 48px 16px 32px);
-}
-
-.searchbox-cancel {
-  list-style-image: url("chrome://global/skin/icons/Search-close.png");
-  -moz-image-region: rect(0px 16px 16px 0px);
-}
-
-.searchbox-cancel:hover {
-  -moz-image-region: rect(0px 32px 16px 16px);
-}
-
-.searchbox-cancel:hover:active {
-  -moz-image-region: rect(0px 48px 16px 32px);
-}
-
-.searchbox-search .button-box,
-.searchbox-cancel .button-box {
-  border: 0px;
-  padding: 0px;
-}
-
 #progressBox {
   padding: 5px 5px 5px 5px;
 }
 
 #progressBox > hbox {
diff --git a/toolkit/toolkit-makefiles.sh b/toolkit/toolkit-makefiles.sh
--- a/toolkit/toolkit-makefiles.sh
+++ b/toolkit/toolkit-makefiles.sh
@@ -281,56 +281,56 @@ MAKEFILES_libutil="
   modules/libutil/public/Makefile
   modules/libutil/src/Makefile
 "
 
 MAKEFILES_libvorbis="
-  modules/libvorbis/Makefile
-  modules/libvorbis/lib/Makefile
-  modules/libvorbis/include/Makefile
-  modules/libvorbis/include/vorbis/Makefile
+  media/libvorbis/Makefile
+  media/libvorbis/lib/Makefile
+  media/libvorbis/include/Makefile
+  media/libvorbis/include/vorbis/Makefile
 "
 
 MAKEFILES_libtheora="
-  modules/libtheora/Makefile
-  modules/libtheora/lib/Makefile
-  modules/libtheora/include/Makefile
-  modules/libtheora/include/theora/Makefile
+  media/libtheora/Makefile
+  media/libtheora/lib/Makefile
+  media/libtheora/include/Makefile
+  media/libtheora/include/theora/Makefile
 "
 
 MAKEFILES_liboggz="
-  modules/liboggz/Makefile
-  modules/liboggz/src/Makefile
-  modules/liboggz/src/liboggz/Makefile
-  modules/liboggz/include/Makefile
-  modules/liboggz/include/oggz/Makefile
+  media/liboggz/Makefile
+  media/liboggz/src/Makefile
+  media/liboggz/src/liboggz/Makefile
+  media/liboggz/include/Makefile
+  media/liboggz/include/oggz/Makefile
 "
 
 MAKEFILES_libogg="
-  modules/libogg/Makefile
-  modules/libogg/src/Makefile
-  modules/libogg/include/Makefile
-  modules/libogg/include/ogg/Makefile
+  media/libogg/Makefile
+  media/libogg/src/Makefile
+  media/libogg/include/Makefile
+  media/libogg/include/ogg/Makefile
 "
 
 MAKEFILES_libfishsound="
-  modules/libfishsound/Makefile
-  modules/libfishsound/src/Makefile
-  modules/libfishsound/src/libfishsound/Makefile
-  modules/libfishsound/include/Makefile
-  modules/libfishsound/include/fishsound/Makefile
+  media/libfishsound/Makefile
+  media/libfishsound/src/Makefile
+  media/libfishsound/src/libfishsound/Makefile
+  media/libfishsound/include/Makefile
+  media/libfishsound/include/fishsound/Makefile
 "
 
 MAKEFILES_liboggplay="
-  modules/liboggplay/Makefile
-  modules/liboggplay/src/Makefile
-  modules/liboggplay/src/liboggplay/Makefile
-  modules/liboggplay/include/Makefile
-  modules/liboggplay/include/oggplay/Makefile
+  media/liboggplay/Makefile
+  media/liboggplay/src/Makefile
+  media/liboggplay/src/liboggplay/Makefile
+  media/liboggplay/include/Makefile
+  media/liboggplay/include/oggplay/Makefile
 "
 
 MAKEFILES_liboggplay_audio="
-  modules/liboggplay_audio/Makefile
+  media/liboggplay_audio/Makefile
 "
 
 MAKEFILES_oji="
   modules/oji/Makefile
   modules/oji/public/Makefile
diff --git a/toolkit/toolkit-tiers.mk b/toolkit/toolkit-tiers.mk
--- a/toolkit/toolkit-tiers.mk
+++ b/toolkit/toolkit-tiers.mk
@@ -82,11 +82,13 @@ tier_gecko_dirs += \
 		js/src/xpconnect \
 		intl/chardet \
 		$(NULL)
 
 ifdef MOZ_ENABLE_GTK2
+ifdef MOZ_X11
 tier_gecko_dirs     += widget/src/gtkxtbin
+endif
 endif
 
 ifdef MOZ_IPCD
 tier_gecko_dirs += ipc/ipcd
 endif
@@ -116,17 +118,17 @@ tier_gecko_dirs += js/jsd
 tier_gecko_dirs += js/jsd
 endif
 
 ifdef MOZ_OGG
 tier_gecko_dirs += \
-		modules/libfishsound \
-		modules/libogg \
-		modules/liboggplay \
-		modules/liboggplay_audio \
-		modules/liboggz \
-		modules/libtheora \
-		modules/libvorbis \
+		media/libfishsound \
+		media/libogg \
+		media/liboggplay \
+		media/liboggplay_audio \
+		media/liboggz \
+		media/libtheora \
+		media/libvorbis \
 		$(NULL)
 endif
 
 tier_gecko_dirs	+= \
 		uriloader \
diff --git a/toolkit/xre/make-platformini.py b/toolkit/xre/make-platformini.py
--- a/toolkit/xre/make-platformini.py
+++ b/toolkit/xre/make-platformini.py
@@ -10,11 +10,11 @@ o.add_option("--print-buildid", action="
 o.add_option("--print-buildid", action="store_true", dest="print_buildid")
 
 (options, args) = o.parse_args()
 
 if options.print_buildid:
-    print datetime.now().strftime('%Y%m%d%H')
+    print datetime.now().strftime('%Y%m%d%H%M%S')
     sys.exit(0)
 
 if not options.buildid:
     print >>sys.stderr, "--buildid is required"
     sys.exit(1)
diff --git a/toolkit/xre/nsAppRunner.cpp b/toolkit/xre/nsAppRunner.cpp
--- a/toolkit/xre/nsAppRunner.cpp
+++ b/toolkit/xre/nsAppRunner.cpp
@@ -267,11 +267,13 @@ static int    gRestartArgc;
 static int    gRestartArgc;
 static char **gRestartArgv;
 
 #if defined(MOZ_WIDGET_GTK2)
 #include <gtk/gtk.h>
+#ifdef MOZ_X11
 #include <gdk/gdkx.h>
+#endif /* MOZ_X11 */
 #include "nsGTKToolkit.h"
 #endif
 
 // Save the given word to the specified environment variable.
 static void
@@ -2384,17 +2386,21 @@ static void MOZ_gdk_display_close(GdkDis
   // gdk_display_close was broken prior to gtk+-2.10.0.
   // (http://bugzilla.gnome.org/show_bug.cgi?id=85715)
   // gdk_display_manager_set_default_display (gdk_display_manager_get(), NULL)
   // was also broken.
   if (gtk_check_version(2,10,0) != NULL) {
+#ifdef MOZ_X11
     // Version check failed - broken gdk_display_close.
     //
     // Let the gdk structures leak but at least close the Display,
     // assuming that gdk will not use it again.
     Display* dpy = GDK_DISPLAY_XDISPLAY(display);
     if (!theme_is_qt)
       XCloseDisplay(dpy);
+#else
+    gdk_display_close(display);
+#endif /* MOZ_X11 */
   }
   else {
     if (!theme_is_qt)
       gdk_display_close(display);
 #if GTK_CHECK_VERSION(2,8,0) && \
diff --git a/toolkit/xre/nsNativeAppSupportUnix.cpp b/toolkit/xre/nsNativeAppSupportUnix.cpp
--- a/toolkit/xre/nsNativeAppSupportUnix.cpp
+++ b/toolkit/xre/nsNativeAppSupportUnix.cpp
@@ -295,10 +295,12 @@ nsNativeAppSupportUnix::Start(PRBool *aR
 
 #endif
 
   *aRetVal = PR_TRUE;
 
+#ifdef MOZ_X11
+
   PRLibrary *gnomeuiLib = PR_LoadLibrary("libgnomeui-2.so.0");
   if (!gnomeuiLib)
     return NS_OK;
 
   PRLibrary *gnomeLib = PR_LoadLibrary("libgnome-2.so.0");
@@ -314,20 +316,24 @@ nsNativeAppSupportUnix::Start(PRBool *aR
     PR_UnloadLibrary(gnomeuiLib);
     PR_UnloadLibrary(gnomeLib);
     return NS_OK;
   }
 
+#endif /* MOZ_X11 */
+
 #ifdef ACCESSIBILITY
   // We will load gail, atk-bridge by ourself later
   // We can't run atk-bridge init here, because gail get the control
   // Set GNOME_ACCESSIBILITY to 0 can avoid this
   static const char *accEnv = "GNOME_ACCESSIBILITY";
   const char *accOldValue = getenv(accEnv);
   setenv(accEnv, "0", 1);
 #endif
 
+#ifdef MOZ_X11
   gnome_program_init("Gecko", "1.0", libgnomeui_module_info_get(), gArgc, gArgv, NULL);
+#endif /* MOZ_X11 */
 
 #ifdef ACCESSIBILITY
   if (accOldValue) { 
     setenv(accEnv, accOldValue, 1);
   } else {
@@ -337,10 +343,11 @@ nsNativeAppSupportUnix::Start(PRBool *aR
 
   // Careful! These libraries cannot be unloaded after this point because
   // gnome_program_init causes atexit handlers to be registered. Strange
   // crashes will occur if these libraries are unloaded.
 
+#ifdef MOZ_X11
   gnome_client_request_interaction = (_gnome_client_request_interaction_fn)
     PR_FindFunctionSymbol(gnomeuiLib, "gnome_client_request_interaction");
   gnome_interaction_key_return = (_gnome_interaction_key_return_fn)
     PR_FindFunctionSymbol(gnomeuiLib, "gnome_interaction_key_return");
   gnome_client_set_restart_command = (_gnome_client_set_restart_command_fn)
@@ -350,10 +357,11 @@ nsNativeAppSupportUnix::Start(PRBool *aR
     PR_FindFunctionSymbol(gnomeuiLib, "gnome_master_client");
 
   GnomeClient *client = gnome_master_client();
   g_signal_connect(client, "save-yourself", G_CALLBACK(save_yourself_cb), NULL);
   g_signal_connect(client, "die", G_CALLBACK(die_cb), NULL);
+#endif /* MOZ_X11 */
 
   return NS_OK;
 }
 
 NS_IMETHODIMP
diff --git a/view/src/nsViewManager.cpp b/view/src/nsViewManager.cpp
--- a/view/src/nsViewManager.cpp
+++ b/view/src/nsViewManager.cpp
@@ -1349,14 +1349,10 @@ NS_IMETHODIMP nsViewManager::DispatchEve
             case NS_COMPOSITION_START:
             case NS_COMPOSITION_QUERY:
               ConvertRectAppUnitsToIntPixels(
                 ((nsCompositionEvent*)aEvent)->theReply.mCursorPosition, p2a);
               break;
-            case NS_QUERYCARETRECT:
-              ConvertRectAppUnitsToIntPixels(
-                ((nsQueryCaretRectEvent*)aEvent)->theReply.mCaretRect, p2a);
-              break;
             case NS_QUERY_CHARACTER_RECT:
             case NS_QUERY_CARET_RECT:
               ConvertRectAppUnitsToIntPixels(
                 ((nsQueryContentEvent*)aEvent)->mReply.mRect, p2a);
               break;
diff --git a/widget/public/nsEvent.h b/widget/public/nsEvent.h
--- a/widget/public/nsEvent.h
+++ b/widget/public/nsEvent.h
@@ -76,9 +76,7 @@ class nsReconversionEvent;
 class nsReconversionEvent;
 class nsTooltipEvent;
 class nsMenuEvent;
 
 struct nsTextEventReply;
-struct nsReconversionEventReply;
-struct nsQueryCaretRectEventReply;
 
 #endif // nsEvent_h__
diff --git a/widget/public/nsGUIEvent.h b/widget/public/nsGUIEvent.h
--- a/widget/public/nsGUIEvent.h
+++ b/widget/public/nsGUIEvent.h
@@ -83,11 +83,10 @@ class nsHashKey;
 #define NS_MOUSE_EVENT                    10
 #define NS_MENU_EVENT                     11
 #define NS_SCRIPT_ERROR_EVENT             12
 #define NS_TEXT_EVENT                     13
 #define NS_COMPOSITION_EVENT              14
-#define NS_RECONVERSION_EVENT             15
 #define NS_MOUSE_SCROLL_EVENT             16
 #define NS_SCROLLPORT_EVENT               18
 #define NS_MUTATION_EVENT                 19 // |nsMutationEvent| in content
 #define NS_ACCESSIBLE_EVENT               20
 #define NS_FORM_EVENT                     21
@@ -95,11 +94,10 @@ class nsHashKey;
 #define NS_POPUP_EVENT                    23
 #define NS_COMMAND_EVENT                  24
 #define NS_POPUPBLOCKED_EVENT             25
 #define NS_BEFORE_PAGE_UNLOAD_EVENT       26
 #define NS_UI_EVENT                       27
-#define NS_QUERYCARETRECT_EVENT           28
 #define NS_PAGETRANSITION_EVENT           29
 #ifdef MOZ_SVG
 #define NS_SVG_EVENT                      30
 #define NS_SVGZOOM_EVENT                  31
 #endif // MOZ_SVG
@@ -294,28 +292,20 @@ class nsHashKey;
 #define NS_COMPOSITION_EVENT_START    2200
 #define NS_COMPOSITION_START          (NS_COMPOSITION_EVENT_START)
 #define NS_COMPOSITION_END            (NS_COMPOSITION_EVENT_START + 1)
 #define NS_COMPOSITION_QUERY          (NS_COMPOSITION_EVENT_START + 2)
 
-// reconversion events
-#define NS_RECONVERSION_START         2300
-#define NS_RECONVERSION_QUERY         (NS_RECONVERSION_START)
-
 // text events
 #define NS_TEXT_START                 2400
 #define NS_TEXT_TEXT                  (NS_TEXT_START)
 
 // UI events
 #define NS_UI_EVENT_START          2500
 // this is not to be confused with NS_ACTIVATE!
 #define NS_UI_ACTIVATE             (NS_UI_EVENT_START)
 #define NS_UI_FOCUSIN              (NS_UI_EVENT_START + 1)
 #define NS_UI_FOCUSOUT             (NS_UI_EVENT_START + 2)
-
-// query caret rect events
-#define NS_QUERYCARETRECT_START    2600
-#define NS_QUERYCARETRECT          (NS_QUERYCARETRECT_START)
 
 // pagetransition events
 #define NS_PAGETRANSITION_START    2700
 #define NS_PAGE_SHOW               (NS_PAGETRANSITION_START + 1)
 #define NS_PAGE_HIDE               (NS_PAGETRANSITION_START + 2)
@@ -846,52 +836,10 @@ public:
 
   PRInt32               scrollFlags;
   PRInt32               delta;
 };
 
-struct nsReconversionEventReply {
-  nsReconversionEventReply()
-    : mReconversionString(nsnull)
-  {
-  }
-
-  PRUnichar *mReconversionString;
-};
-
-class nsReconversionEvent : public nsInputEvent
-{
-public:
-  nsReconversionEvent(PRBool isTrusted, PRUint32 msg, nsIWidget *w)
-    : nsInputEvent(isTrusted, msg, w, NS_RECONVERSION_EVENT)
-  {
-  }
-
-  nsReconversionEventReply  theReply;
-};
-
-struct nsQueryCaretRectEventReply
-{
-  nsQueryCaretRectEventReply()
-    : mRectIsValid(PR_FALSE)
-  {
-  }
-
-  PRBool mRectIsValid;
-  nsRect mCaretRect;
-};
-
-class nsQueryCaretRectEvent : public nsInputEvent
-{
-public:
-  nsQueryCaretRectEvent(PRBool isTrusted, PRUint32 msg, nsIWidget *w)
-    : nsInputEvent(isTrusted, msg, w, NS_QUERYCARETRECT_EVENT)
-  {
-  }
-
-  nsQueryCaretRectEventReply theReply;
-};
-
 class nsQueryContentEvent : public nsGUIEvent
 {
 public:
   nsQueryContentEvent(PRBool aIsTrusted, PRUint32 aMsg, nsIWidget *aWidget) :
     nsGUIEvent(aIsTrusted, aMsg, aWidget, NS_QUERY_CONTENT_EVENT),
@@ -1121,12 +1069,10 @@ enum nsDragDropEventStatus {
 
 #define NS_IS_IME_EVENT(evnt) \
        (((evnt)->message == NS_TEXT_TEXT) ||  \
         ((evnt)->message == NS_COMPOSITION_START) ||  \
         ((evnt)->message == NS_COMPOSITION_END) || \
-        ((evnt)->message == NS_RECONVERSION_QUERY) || \
-        ((evnt)->message == NS_QUERYCARETRECT) || \
         ((evnt)->message == NS_COMPOSITION_QUERY))
 
 #define NS_IS_FOCUS_EVENT(evnt) \
        (((evnt)->message == NS_GOTFOCUS) ||  \
         ((evnt)->message == NS_LOSTFOCUS) ||  \
diff --git a/widget/public/nsIWidget.h b/widget/public/nsIWidget.h
--- a/widget/public/nsIWidget.h
+++ b/widget/public/nsIWidget.h
@@ -39,10 +39,11 @@
 #define nsIWidget_h__
 
 #include "nsISupports.h"
 #include "nsColor.h"
 #include "nsCoord.h"
+#include "nsRect.h"
 
 #include "prthread.h"
 #include "nsEvent.h"
 #include "nsCOMPtr.h"
 
@@ -51,11 +52,10 @@ class   nsIToolkit;
 class   nsIToolkit;
 class   nsIFontMetrics;
 class   nsIRenderingContext;
 class   nsIDeviceContext;
 class   nsIRegion;
-struct  nsRect;
 struct  nsFont;
 class   nsIEventListener;
 class   nsIRollupListener;
 class   nsGUIEvent;
 struct  nsColorMap;
@@ -92,14 +92,14 @@ typedef nsEventStatus (*PR_CALLBACK EVEN
 #ifdef XP_MACOSX
 #define NS_NATIVE_PLUGIN_PORT_QD    100
 #define NS_NATIVE_PLUGIN_PORT_CG    101
 #endif
 
-// 594d22a3-ef2d-4189-9bc1-3c3da586f47a
+// 3d304df2-8e6b-4f09-8782-98bd649c7e96
 #define NS_IWIDGET_IID \
-{ 0x594d22a3, 0xef2d, 0x4189, \
-  { 0x9b, 0xc1, 0x3c, 0x3d, 0xa5, 0x86, 0xf4, 0x7a } }
+{ 0x3d304df2, 0x8e6b, 0x4f09, \
+  { 0x87, 0x82, 0x98, 0xbd, 0x64, 0x9c, 0x7e, 0x96 } }
 
 // Hide the native window systems real window type so as to avoid
 // including native window system types and APIs. This is necessary
 // to ensure cross-platform code.
 typedef void* nsNativeWidget;
@@ -1043,10 +1043,21 @@ class nsIWidget : public nsISupports {
      *
      * @param aActive Whether the color should be applied to active or inactive
      *                windows.
      */
     NS_IMETHOD SetWindowTitlebarColor(nscolor aColor, PRBool aActive) = 0;
+    
+    /*
+     * Determine whether the widget shows a resize widget. If it does,
+     * aResizerRect returns the resizer's rect.
+     *
+     * Returns false on any platform that does not support it.
+     *
+     * @param aResizerRect The resizer's rect in device pixels.
+     * @return Whether a resize widget is shown.
+     */
+    virtual PRBool ShowsResizeIndicator(nsIntRect* aResizerRect) = 0;
 
     /**
      * Get the Thebes surface associated with this widget.
      */
     virtual gfxASurface *GetThebesSurface() = 0;
diff --git a/widget/src/Makefile.in b/widget/src/Makefile.in
--- a/widget/src/Makefile.in
+++ b/widget/src/Makefile.in
@@ -68,11 +68,13 @@ endif
 # multiple implementations of widget can be built on the same
 # source tree.
 #
 ifdef MOZ_ENABLE_GTK2
 DIRS		+= gtk2
+ifdef MOZ_X11
 DIRS		+= gtkxtbin
+endif
 endif
 
 ifdef MOZ_ENABLE_PHOTON
 DIRS		+= photon
 endif
diff --git a/widget/src/cocoa/nsChildView.h b/widget/src/cocoa/nsChildView.h
--- a/widget/src/cocoa/nsChildView.h
+++ b/widget/src/cocoa/nsChildView.h
@@ -302,10 +302,11 @@ public:
   NS_IMETHOD              Scroll(PRInt32 aDx, PRInt32 aDy, nsRect *aClipRect);
   NS_IMETHOD              WidgetToScreen(const nsRect& aOldRect, nsRect& aNewRect);
   NS_IMETHOD              ScreenToWidget(const nsRect& aOldRect, nsRect& aNewRect);
   NS_IMETHOD              BeginResizingChildren(void);
   NS_IMETHOD              EndResizingChildren(void);
+  virtual PRBool          ShowsResizeIndicator(nsIntRect* aResizerRect);
 
   static  PRBool          ConvertStatus(nsEventStatus aStatus)
                           { return aStatus == nsEventStatus_eConsumeNoDefault; }
   NS_IMETHOD              DispatchEvent(nsGUIEvent* event, nsEventStatus & aStatus);
   virtual PRBool          DispatchMouseEvent(nsMouseEvent &aEvent);
diff --git a/widget/src/cocoa/nsChildView.mm b/widget/src/cocoa/nsChildView.mm
--- a/widget/src/cocoa/nsChildView.mm
+++ b/widget/src/cocoa/nsChildView.mm
@@ -1153,10 +1153,33 @@ NS_IMETHODIMP nsChildView::BeginResizing
 
 
 NS_IMETHODIMP nsChildView::EndResizingChildren(void)
 {
   return NS_OK;
+}
+
+
+static const PRInt32 resizeIndicatorWidth = 15;
+static const PRInt32 resizeIndicatorHeight = 15;
+PRBool nsChildView::ShowsResizeIndicator(nsIntRect* aResizerRect)
+{
+  NSView *topLevelView = mView, *superView = nil;
+  while (superView = [topLevelView superview])
+    topLevelView = superView;
+
+  if (![[topLevelView window] showsResizeIndicator])
+    return PR_FALSE;
+
+  if (aResizerRect) {
+    NSSize bounds = [topLevelView bounds].size;
+    NSPoint corner = NSMakePoint(bounds.width, [topLevelView isFlipped] ? bounds.height : 0);
+    corner = [topLevelView convertPoint:corner toView:mView];
+    aResizerRect->SetRect(NSToIntRound(corner.x) - resizeIndicatorWidth,
+                          NSToIntRound(corner.y) - resizeIndicatorHeight,
+                          resizeIndicatorWidth, resizeIndicatorHeight);
+  }
+  return PR_TRUE;
 }
 
 
 NS_IMETHODIMP nsChildView::GetPluginClipRect(nsRect& outClipRect, nsPoint& outOrigin, PRBool& outWidgetVisible)
 {
diff --git a/widget/src/gtk2/Makefile.in b/widget/src/gtk2/Makefile.in
--- a/widget/src/gtk2/Makefile.in
+++ b/widget/src/gtk2/Makefile.in
@@ -61,20 +61,23 @@ REQUIRES	= xpcom \
 		  dom \
 		  docshell \
 		  necko \
 		  uconv \
 		  intl \
-		  gtkxtbin \
 		  imglib2 \
 		  view \
 		  content \
 		  layout \
 		  util \
 		  locale \
 		  thebes \
 		  cairo \
 		  $(NULL)
+
+ifdef MOZ_X11
+REQUIRES += gtkxtbin
+endif
 
 ifeq ($(MOZ_ENABLE_GLITZ),1)
 REQUIRES += glitz glitzglx
 endif
 
@@ -96,12 +99,10 @@ CPPSRCS		= \
 		nsToolkit.cpp \
 		nsBidiKeyboard.cpp \
 		nsCommonWidget.cpp \
 		nsLookAndFeel.cpp \
 		nsGtkKeyUtils.cpp \
-		nsClipboard.cpp \
-		nsDragService.cpp \
 		nsFilePicker.cpp \
 		nsSound.cpp \
 		nsNativeKeyBindings.cpp \
 		nsScreenGtk.cpp \
 		nsScreenManagerGtk.cpp \
@@ -110,19 +111,27 @@ CPPSRCS		= \
 		$(NULL)
 
 ifdef NS_OSSO
 CPPSRCS         += nsIdleServiceOSSO.cpp
 else
+ifdef MOZ_X11
 CPPSRCS         += nsIdleServiceGTK.cpp
+endif
 endif
 
 ifdef NS_PRINTING
 CPPSRCS		+= \
 		nsDeviceContextSpecG.cpp \
 		nsPrintOptionsGTK.cpp \
 		nsPrintDialogGTK.cpp \
 		nsPrintSettingsGTK.cpp \
+		$(NULL)
+endif
+
+ifdef MOZ_X11
+CPPSRCS += 	nsClipboard.cpp \
+		nsDragService.cpp \
 		$(NULL)
 endif
 
 # build our subdirs, too
 ifdef ACCESSIBILITY
@@ -132,18 +141,21 @@ SHARED_LIBRARY_LIBS = ../xpwidgets/libxp
 SHARED_LIBRARY_LIBS = ../xpwidgets/libxpwidgets_s.a
 
 EXTRA_DSO_LDOPTS += \
 		$(MOZ_COMPONENT_LIBS) \
 		-lgkgfx \
-		-lgtkxtbin \
                 $(MOZ_STARTUP_NOTIFICATION_LIBS) \
 		$(XLDFLAGS) \
 		$(XLIBS) \
 		$(MOZ_GTK2_LIBS) \
 		-lthebes \
 		$(LCMS_LIBS) \
 		$(NULL)
+
+ifdef MOZ_X11
+EXTRA_DSO_LDOPTS += -lgtkxtbin
+endif
 
 EXPORTS		= \
                 nsGTKToolkit.h \
 		nsIImageToPixbuf.h \
 		mozdrawingarea.h \
diff --git a/widget/src/gtk2/keysym2ucs.h b/widget/src/gtk2/keysym2ucs.h
--- a/widget/src/gtk2/keysym2ucs.h
+++ b/widget/src/gtk2/keysym2ucs.h
@@ -43,11 +43,15 @@
 /*
  * This module converts keysym values into the corresponding ISO 10646-1
  * (UCS, Unicode) values.
  */
 
+#ifdef MOZ_X11
 #include <X11/X.h>
+#else
+#define KeySym unsigned int
+#endif /* MOZ_X11 */
 
 #ifdef __cplusplus
 extern "C" { 
 #endif
 
diff --git a/widget/src/gtk2/nsBidiKeyboard.cpp b/widget/src/gtk2/nsBidiKeyboard.cpp
--- a/widget/src/gtk2/nsBidiKeyboard.cpp
+++ b/widget/src/gtk2/nsBidiKeyboard.cpp
@@ -51,12 +51,19 @@ static GdkKeymapHaveBidiLayoutsType GdkK
 
 NS_IMPL_ISUPPORTS1(nsBidiKeyboard, nsIBidiKeyboard)
 
 nsBidiKeyboard::nsBidiKeyboard()
 {
+#if defined(MOZ_X11)
     if (!gtklib)
         gtklib = PR_LoadLibrary("libgtk-x11-2.0.so.0");
+#elif defined(MOZ_DFB)
+    if (!gtklib)
+        gtklib = PR_LoadLibrary("libgtk-directfb-2.0.so.0");
+#else
+    return;
+#endif
 
     if (gtklib && !GdkKeymapHaveBidiLayouts)
             GdkKeymapHaveBidiLayouts = (GdkKeymapHaveBidiLayoutsType) PR_FindFunctionSymbol(gtklib, "gdk_keymap_have_bidi_layouts");
 
     SetHaveBidiKeyboards();
diff --git a/widget/src/gtk2/nsGtkKeyUtils.cpp b/widget/src/gtk2/nsGtkKeyUtils.cpp
--- a/widget/src/gtk2/nsGtkKeyUtils.cpp
+++ b/widget/src/gtk2/nsGtkKeyUtils.cpp
@@ -37,11 +37,13 @@
  *
  * ***** END LICENSE BLOCK ***** */
 
 #include <gdk/gdkkeysyms.h>
 #include <gdk/gdkevents.h>
+#ifdef MOZ_X11
 #include <gdk/gdkx.h>
+#endif /* MOZ_X11 */
 #include "nsGUIEvent.h"
 #include "keysym2ucs.h"
 
 struct nsKeyConverter {
     int vkCode; // Platform independent key code
@@ -152,12 +154,14 @@ struct nsKeyConverter nsKeycodes[] = {
     { NS_VK_0, GDK_parenright },
     { NS_VK_SUBTRACT, GDK_underscore },
     { NS_VK_EQUALS, GDK_plus }
 };
 
+#ifdef MOZ_X11
 #define IS_XSUN_XSERVER(dpy) \
     (strstr(XServerVendor(dpy), "Sun Microsystems") != NULL)
+#endif /* MOZ_X11 */
 
 // map Sun Keyboard special keysyms on to NS_VK keys
 struct nsKeyConverter nsSunKeycodes[] = {
     {NS_VK_ESCAPE, GDK_F11 }, //bug 57262, Sun Stop key generates F11 keysym
     {NS_VK_F1, GDK_Help }, //Mapping Help key to F1
@@ -191,18 +195,20 @@ GdkKeyCodeToDOMKeyCode(int aKeysym)
 
     // keypad numbers
     if (aKeysym >= GDK_KP_0 && aKeysym <= GDK_KP_9)
         return aKeysym - GDK_KP_0 + NS_VK_NUMPAD0;
 
+#ifdef MOZ_X11
     // map Sun Keyboard special keysyms
     if (IS_XSUN_XSERVER(GDK_DISPLAY())) {
         length = sizeof(nsSunKeycodes) / sizeof(struct nsKeyConverter);
         for (i = 0; i < length; i++) {
             if (nsSunKeycodes[i].keysym == aKeysym)
                 return(nsSunKeycodes[i].vkCode);
         }
     }
+#endif /* MOZ_X11 */
 
     // misc other things
     length = sizeof(nsKeycodes) / sizeof(struct nsKeyConverter);
     for (i = 0; i < length; i++) {
         if (nsKeycodes[i].keysym == aKeysym)
diff --git a/widget/src/gtk2/nsNativeThemeGTK.cpp b/widget/src/gtk2/nsNativeThemeGTK.cpp
--- a/widget/src/gtk2/nsNativeThemeGTK.cpp
+++ b/widget/src/gtk2/nsNativeThemeGTK.cpp
@@ -60,20 +60,19 @@
 #include "prlink.h"
 #include "nsIDOMHTMLInputElement.h"
 #include "nsWidgetAtoms.h"
 
 #include <gdk/gdkprivate.h>
-#include <gdk/gdkx.h>
 #include <gtk/gtk.h>
 
 #include "gfxContext.h"
 #include "gfxPlatformGtk.h"
-#include "gfxXlibNativeRenderer.h"
+#include "gfxGdkNativeRenderer.h"
 
 NS_IMPL_ISUPPORTS2(nsNativeThemeGTK, nsITheme, nsIObserver)
 
-static int gLastXError;
+static int gLastGdkError;
 
 static inline bool IsCheckboxWidgetType(PRUint8 aWidgetType)
 {
   return (aWidgetType == NS_THEME_CHECKBOX || aWidgetType == NS_THEME_CHECKBOX_SMALL);
 }
@@ -614,26 +613,19 @@ nsNativeThemeGTK::GetGtkWidgetAndState(P
   }
 
   return PR_TRUE;
 }
 
-static int
-NativeThemeErrorHandler(Display* dpy, XErrorEvent* error) {
-  gLastXError = error->error_code;
-  return 0;
-}
-
-class ThemeRenderer : public gfxXlibNativeRenderer {
+class ThemeRenderer : public gfxGdkNativeRenderer {
 public:
   ThemeRenderer(GtkWidgetState aState, GtkThemeWidgetType aGTKWidgetType,
                 gint aFlags, GtkTextDirection aDirection,
                 const GdkRectangle& aGDKRect, const GdkRectangle& aGDKClip)
     : mState(aState), mGTKWidgetType(aGTKWidgetType), mFlags(aFlags),
       mDirection(aDirection), mGDKRect(aGDKRect), mGDKClip(aGDKClip) {}
-  nsresult NativeDraw(Screen* screen, Drawable drawable, Visual* visual,
-                      Colormap colormap, short offsetX, short offsetY,
-                      XRectangle* clipRects, PRUint32 numClipRects);
+  nsresult NativeDraw(GdkDrawable * drawable, short offsetX, short offsetY,
+                      GdkRectangle * clipRects, PRUint32 numClipRects);
 private:
   GtkWidgetState mState;
   GtkThemeWidgetType mGTKWidgetType;
   gint mFlags;
   GtkTextDirection mDirection;
@@ -641,54 +633,25 @@ private:
   const GdkRectangle& mGDKRect;
   const GdkRectangle& mGDKClip;
 };
 
 nsresult
-ThemeRenderer::NativeDraw(Screen* screen, Drawable drawable, Visual* visual,
-                          Colormap colormap, short offsetX, short offsetY,
-                          XRectangle* clipRects, PRUint32 numClipRects)
+ThemeRenderer::NativeDraw(GdkDrawable * drawable, short offsetX, 
+        short offsetY, GdkRectangle * clipRects, PRUint32 numClipRects)
 {
   GdkRectangle gdk_rect = mGDKRect;
   gdk_rect.x += offsetX;
   gdk_rect.y += offsetY;
 
   GdkRectangle gdk_clip = mGDKClip;
   gdk_clip.x += offsetX;
   gdk_clip.y += offsetY;
   
-  GdkDisplay* gdkDpy = gdk_x11_lookup_xdisplay(DisplayOfScreen(screen));
-  if (!gdkDpy)
-    return NS_ERROR_FAILURE;
+  NS_ASSERTION(numClipRects == 0, "We don't support clipping!!!");
+  moz_gtk_widget_paint(mGTKWidgetType, drawable, &gdk_rect, &gdk_clip,
+                       &mState, mFlags, mDirection);
 
-  GdkPixmap* gdkPixmap = gdk_pixmap_lookup_for_display(gdkDpy, drawable);
-  if (gdkPixmap) {
-    g_object_ref(G_OBJECT(gdkPixmap));
-  } else {
-    // XXX gtk+-2.10 has gdk_pixmap_foreign_new_for_screen which would not
-    // use XGetGeometry.
-    gdkPixmap = gdk_pixmap_foreign_new_for_display(gdkDpy, drawable);
-    if (!gdkPixmap)
-      return NS_ERROR_FAILURE;
-
-    // We requested that gfxXlibNativeRenderer give us the default screen
-    GdkScreen* gdkScreen = gdk_display_get_default_screen(gdkDpy);
-    NS_ASSERTION(screen == GDK_SCREEN_XSCREEN(gdkScreen),
-                 "'screen' should be the default Screen");
-    // GDK requires a GdkColormap to be set on the GdkPixmap.
-    GdkVisual* gdkVisual =
-      gdk_x11_screen_lookup_visual(gdkScreen, visual->visualid);
-    GdkColormap* gdkColormap =
-      gdk_x11_colormap_foreign_new(gdkVisual, colormap);
-    gdk_drawable_set_colormap(gdkPixmap, gdkColormap);
-    g_object_unref(G_OBJECT(gdkColormap));
-  }
-
-  NS_ASSERTION(numClipRects == 0, "We don't support clipping!!!");
-  moz_gtk_widget_paint(mGTKWidgetType, gdkPixmap, &gdk_rect, &gdk_clip, &mState,
-                       mFlags, mDirection);
-
-  g_object_unref(G_OBJECT(gdkPixmap));
   return NS_OK;
 }
 
 static PRBool
 GetExtraSizeForWidget(PRUint8 aWidgetType, nsIntMargin* aExtra)
@@ -802,12 +765,12 @@ nsNativeThemeGTK::DrawWidgetBackground(n
   // We require the use of the default screen and visual
   // because I'm afraid that otherwise the GTK theme may explode.
   // Some themes (e.g. Clearlooks) just don't clip properly to any
   // clip rect we provide, so we cannot advertise support for clipping within
   // the widget bounds.
-  PRUint32 rendererFlags = gfxXlibNativeRenderer::DRAW_SUPPORTS_OFFSET;
-   
+  PRUint32 rendererFlags = gfxGdkNativeRenderer::DRAW_SUPPORTS_OFFSET;
+
   // translate everything so (0,0) is the top left of the drawingRect
   gfxContextAutoSaveRestore autoSR(ctx);
   if (snapXY) {
     // Rects are in device coords.
     ctx->IdentityMatrix(); 
@@ -816,29 +779,26 @@ nsNativeThemeGTK::DrawWidgetBackground(n
 
   NS_ASSERTION(!IsWidgetTypeDisabled(mDisabledWidgetTypes, aWidgetType),
                "Trying to render an unsafe widget!");
 
   PRBool safeState = IsWidgetStateSafe(mSafeWidgetStates, aWidgetType, &state);
-  XErrorHandler oldHandler = nsnull;
   if (!safeState) {
-    gLastXError = 0;
-    oldHandler = XSetErrorHandler(NativeThemeErrorHandler);
+    gLastGdkError = 0;
+    gdk_error_trap_push ();
   }
 
-  renderer.Draw(gdk_x11_get_default_xdisplay(), ctx,
-                drawingRect.width, drawingRect.height,
-                rendererFlags, nsnull);
+  renderer.Draw(ctx, drawingRect.width, drawingRect.height, rendererFlags, nsnull);
 
   if (!safeState) {
     gdk_flush();
-    XSetErrorHandler(oldHandler);
+    gLastGdkError = gdk_error_trap_pop ();
 
-    if (gLastXError) {
+    if (gLastGdkError) {
 #ifdef DEBUG
       printf("GTK theme failed for widget type %d, error was %d, state was "
              "[active=%d,focused=%d,inHover=%d,disabled=%d]\n",
-             aWidgetType, gLastXError, state.active, state.focused,
+             aWidgetType, gLastGdkError, state.active, state.focused,
              state.inHover, state.disabled);
 #endif
       NS_WARNING("GTK theme failed; disabling unsafe widget");
       SetWidgetTypeDisabled(mDisabledWidgetTypes, aWidgetType);
       // force refresh of the window, because the widget was not
diff --git a/widget/src/gtk2/nsScreenGtk.cpp b/widget/src/gtk2/nsScreenGtk.cpp
--- a/widget/src/gtk2/nsScreenGtk.cpp
+++ b/widget/src/gtk2/nsScreenGtk.cpp
@@ -36,13 +36,16 @@
  *
  * ***** END LICENSE BLOCK ***** */
 
 #include "nsScreenGtk.h"
 
+#include <gdk/gdk.h>
+#ifdef MOZ_X11
 #include <gdk/gdkx.h>
+#include <X11/Xatom.h>
+#endif
 #include <gtk/gtk.h>
-#include <X11/Xatom.h>
 
 nsScreenGtk :: nsScreenGtk (  )
   : mScreenNum(0),
     mRect(0, 0, 0, 0),
     mAvailRect(0, 0, 0, 0)
@@ -111,10 +114,11 @@ nsScreenGtk :: Init (GdkWindow *aRootWin
   // changes to this rect.  We could listen for "size_changed" signals
   // on the default screen to do this, except that doesn't work with
   // versions of GDK predating the GdkScreen object.  See bug 256646.
   mAvailRect = mRect = nsRect(0, 0, gdk_screen_width(), gdk_screen_height());
 
+#ifdef MOZ_X11
   // We need to account for the taskbar, etc in the available rect.
   // See http://freedesktop.org/Standards/wm-spec/index.html#id2767771
 
   // XXX do we care about _NET_WM_STRUT_PARTIAL?  That will
   // add much more complexity to the code here (our screen
@@ -174,17 +178,20 @@ nsScreenGtk :: Init (GdkWindow *aRootWin
 
       mAvailRect.IntersectRect(mAvailRect, workarea);
     }
   }
   g_free (workareas);
+#endif
 }
 
+#ifdef MOZ_X11
 void
 nsScreenGtk :: Init (XineramaScreenInfo *aScreenInfo)
 {
   nsRect xineRect(aScreenInfo->x_org, aScreenInfo->y_org,
                   aScreenInfo->width, aScreenInfo->height);
 
   mScreenNum = aScreenInfo->screen_number;
 
   mAvailRect = mRect = xineRect;
 }
+#endif
diff --git a/widget/src/gtk2/nsScreenGtk.h b/widget/src/gtk2/nsScreenGtk.h
--- a/widget/src/gtk2/nsScreenGtk.h
+++ b/widget/src/gtk2/nsScreenGtk.h
@@ -39,20 +39,22 @@
 #define nsScreenGtk_h___
 
 #include "nsIScreen.h"
 #include "nsRect.h"
 #include "gdk/gdk.h"
+#ifdef MOZ_X11
 #include <X11/Xlib.h>
 
 // from Xinerama.h
 typedef struct {
    int   screen_number;
    short x_org;
    short y_org;
    short width;
    short height;
 } XineramaScreenInfo;
+#endif /* MOZ_X11 */
 
 //------------------------------------------------------------------------
 
 class nsScreenGtk : public nsIScreen
 {
@@ -62,11 +64,13 @@ public:
 
   NS_DECL_ISUPPORTS
   NS_DECL_NSISCREEN
 
   void Init(GdkWindow *aRootWindow);
+#ifdef MOZ_X11
   void Init(XineramaScreenInfo *aScreenInfo);
+#endif /* MOZ_X11 */
 
 private:
   PRUint32 mScreenNum;
   nsRect mRect; // in pixels, not twips
   nsRect mAvailRect; // in pixels, not twips
diff --git a/widget/src/gtk2/nsScreenManagerGtk.cpp b/widget/src/gtk2/nsScreenManagerGtk.cpp
--- a/widget/src/gtk2/nsScreenManagerGtk.cpp
+++ b/widget/src/gtk2/nsScreenManagerGtk.cpp
@@ -41,25 +41,33 @@
 #include "nsScreenGtk.h"
 #include "nsIComponentManager.h"
 #include "nsRect.h"
 #include "nsAutoPtr.h"
 
-#include <gdk/gdkx.h>
-#include <gtk/gtk.h>
-
 #define SCREEN_MANAGER_LIBRARY_LOAD_FAILED ((PRLibrary*)1)
 
+#ifdef MOZ_DFB
+#include <directfb.h>
+#endif
+
+#ifdef MOZ_X11
+#include <gdk/gdkx.h>
 // prototypes from Xinerama.h
 typedef Bool (*_XnrmIsActive_fn)(Display *dpy);
 typedef XineramaScreenInfo* (*_XnrmQueryScreens_fn)(Display *dpy, int *number);
+#endif
+
+#include <gtk/gtk.h>
+
 
 static GdkFilterReturn
 root_window_event_filter(GdkXEvent *aGdkXEvent, GdkEvent *aGdkEvent,
                          gpointer aClosure)
 {
+  nsScreenManagerGtk *manager = static_cast<nsScreenManagerGtk*>(aClosure);
+#ifdef MOZ_X11
   XEvent *xevent = static_cast<XEvent*>(aGdkXEvent);
-  nsScreenManagerGtk *manager = static_cast<nsScreenManagerGtk*>(aClosure);
 
   // See comments in nsScreenGtk::Init below.
   switch (xevent->type) {
     case ConfigureNotify:
       manager->Init();
@@ -73,10 +81,28 @@ root_window_event_filter(GdkXEvent *aGdk
       }
       break;
     default:
       break;
   }
+#endif
+
+#ifdef MOZ_DFB
+  DFBWindowEvent * dfbEvent = static_cast<DFBWindowEvent *> (aGdkXEvent);
+
+  switch (dfbEvent->type)
+  {
+      case DWET_POSITION :
+      case DWET_SIZE :
+          manager->Init();
+      break;
+
+          /* TODO: Need to find out PropertyNotify equivalent in
+           * DFB.. */
+      default :
+      break;
+  }
+#endif
 
   return GDK_FILTER_CONTINUE;
 }
 
 nsScreenManagerGtk :: nsScreenManagerGtk ( )
@@ -95,13 +121,15 @@ nsScreenManagerGtk :: ~nsScreenManagerGt
     gdk_window_remove_filter(mRootWindow, root_window_event_filter, this);
     g_object_unref(mRootWindow);
     mRootWindow = nsnull;
   }
 
+#ifdef MOZ_X11
   if (mXineramalib && mXineramalib != SCREEN_MANAGER_LIBRARY_LOAD_FAILED) {
     PR_UnloadLibrary(mXineramalib);
   }
+#endif
 }
 
 
 // addref, release, QI
 NS_IMPL_ISUPPORTS1(nsScreenManagerGtk, nsIScreenManager)
@@ -126,19 +154,22 @@ nsScreenManagerGtk :: EnsureInit()
   gdk_window_set_events(mRootWindow,
                         GdkEventMask(gdk_window_get_events(mRootWindow) |
                                      GDK_STRUCTURE_MASK |
                                      GDK_PROPERTY_CHANGE_MASK));
   gdk_window_add_filter(mRootWindow, root_window_event_filter, this);
+#ifdef MOZ_X11
   mNetWorkareaAtom =
     XInternAtom(GDK_WINDOW_XDISPLAY(mRootWindow), "_NET_WORKAREA", False);
+#endif
 
   return Init();
 }
 
 nsresult
 nsScreenManagerGtk :: Init()
 {
+#ifdef MOZ_X11
   XineramaScreenInfo *screenInfo = NULL;
   int numScreens;
 
   if (!mXineramalib) {
     mXineramalib = PR_LoadLibrary("libXinerama.so.1");
@@ -160,12 +191,13 @@ nsScreenManagerGtk :: Init()
     }
   }
   // screenInfo == NULL if either Xinerama couldn't be loaded or
   // isn't running on the current display
   if (!screenInfo || numScreens == 1) {
+    numScreens = 1;
+#endif
     nsRefPtr<nsScreenGtk> screen;
-    numScreens = 1;
 
     if (mCachedScreenArray.Count() > 0) {
       screen = static_cast<nsScreenGtk*>(mCachedScreenArray[0]);
     } else {
       screen = new nsScreenGtk();
@@ -173,10 +205,11 @@ nsScreenManagerGtk :: Init()
         return NS_ERROR_OUT_OF_MEMORY;
       }
     }
 
     screen->Init(mRootWindow);
+#ifdef MOZ_X11
   }
   // If Xinerama is enabled and there's more than one screen, fill
   // in the info for all of the screens.  If that's not the case
   // then nsScreenGTK() defaults to the screen width + height
   else {
@@ -204,10 +237,11 @@ nsScreenManagerGtk :: Init()
   }
 
   if (screenInfo) {
     XFree(screenInfo);
   }
+#endif
 
   return NS_OK;
 }
 
 
diff --git a/widget/src/gtk2/nsScreenManagerGtk.h b/widget/src/gtk2/nsScreenManagerGtk.h
--- a/widget/src/gtk2/nsScreenManagerGtk.h
+++ b/widget/src/gtk2/nsScreenManagerGtk.h
@@ -43,11 +43,13 @@
 #include "nsIScreen.h"
 #include "nsCOMPtr.h"
 #include "nsCOMArray.h"
 #include "prlink.h"
 #include "gdk/gdk.h"
+#ifdef MOZ_X11
 #include <X11/Xlib.h>
+#endif
 
 //------------------------------------------------------------------------
 
 class nsScreenManagerGtk : public nsIScreenManager
 {
@@ -56,11 +58,13 @@ public:
   virtual ~nsScreenManagerGtk();
 
   NS_DECL_ISUPPORTS
   NS_DECL_NSISCREENMANAGER
 
+#ifdef MOZ_X11
   Atom NetWorkareaAtom() { return mNetWorkareaAtom; }
+#endif
   
   // For internal use, or reinitialization from change notification.
   nsresult Init();
 
 private:
@@ -71,9 +75,11 @@ private:
   nsCOMArray<nsIScreen> mCachedScreenArray;
 
   PRLibrary *mXineramalib;
 
   GdkWindow *mRootWindow;
+#ifdef MOZ_X11
   Atom mNetWorkareaAtom;
+#endif
 };
 
 #endif  // nsScreenManagerGtk_h___ 
diff --git a/widget/src/gtk2/nsWidgetFactory.cpp b/widget/src/gtk2/nsWidgetFactory.cpp
--- a/widget/src/gtk2/nsWidgetFactory.cpp
+++ b/widget/src/gtk2/nsWidgetFactory.cpp
@@ -42,14 +42,16 @@
 #include "nsAppShellSingleton.h"
 #include "nsBaseWidget.h"
 #include "nsLookAndFeel.h"
 #include "nsWindow.h"
 #include "nsTransferable.h"
+#include "nsHTMLFormatConverter.h"
+#ifdef MOZ_X11
 #include "nsClipboardHelper.h"
-#include "nsHTMLFormatConverter.h"
 #include "nsClipboard.h"
 #include "nsDragService.h"
+#endif
 #include "nsFilePicker.h"
 #include "nsSound.h"
 #include "nsBidiKeyboard.h"
 #include "nsNativeKeyBindings.h"
 #include "nsScreenManagerGtk.h"
@@ -63,13 +65,13 @@
 #include "nsIPrefService.h"
 #include "nsIPrefBranch.h"
 #include "nsImageToPixbuf.h"
 #include "nsPrintDialogGTK.h"
 
-#ifdef NS_OSSO
+#if defined(NS_OSSO)
 #include "nsIdleServiceOSSO.h"
-#else
+#elif defined(MOZ_X11)
 #include "nsIdleServiceGTK.h"
 #endif
 
 #ifdef NATIVE_THEME_SUPPORT
 #include "nsNativeThemeGTK.h"
@@ -90,24 +92,26 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsWindow)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsWindow)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsChildWindow)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsLookAndFeel)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsTransferable)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsBidiKeyboard)
+NS_GENERIC_FACTORY_CONSTRUCTOR(nsHTMLFormatConverter)
+#ifdef MOZ_X11
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsClipboardHelper)
-NS_GENERIC_FACTORY_CONSTRUCTOR(nsHTMLFormatConverter)
 NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsClipboard, Init)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsDragService)
+#endif
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsSound)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsScreenManagerGtk)
 #ifdef NATIVE_THEME_SUPPORT
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsNativeThemeGTK)
 #endif
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsImageToPixbuf)
 
-#ifdef NS_OSSO
+#if defined(NS_OSSO)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsIdleServiceOSSO)
-#else
+#elif defined(MOZ_X11)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsIdleServiceGTK)
 #endif
 
 #ifdef NS_PRINTING
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsDeviceContextSpecGTK)
@@ -223,10 +227,11 @@ static const nsModuleComponentInfo compo
       nsSoundConstructor },
   { "Transferable",
     NS_TRANSFERABLE_CID,
     "@mozilla.org/widget/transferable;1",
     nsTransferableConstructor },
+#ifdef MOZ_X11
   { "Gtk Clipboard",
     NS_CLIPBOARD_CID,
     "@mozilla.org/widget/clipboard;1",
     nsClipboardConstructor },
   { "Clipboard Helper",
@@ -235,10 +240,11 @@ static const nsModuleComponentInfo compo
     nsClipboardHelperConstructor },
   { "Gtk Drag Service",
     NS_DRAGSERVICE_CID,
     "@mozilla.org/widget/dragservice;1",
     nsDragServiceConstructor },
+#endif
   { "HTML Format Converter",
     NS_HTMLFORMATCONVERTER_CID,
     "@mozilla.org/widget/htmlformatconverter;1",
     nsHTMLFormatConverterConstructor },
   { "Gtk2 Bidi Keyboard",
@@ -293,21 +299,21 @@ static const nsModuleComponentInfo compo
 #endif 
   { "Image to gdk-pixbuf converter",
     NS_IMAGE_TO_PIXBUF_CID,
     "@mozilla.org/widget/image-to-gdk-pixbuf;1",
     nsImageToPixbufConstructor },
-#ifdef NS_OSSO
+#if defined(NS_OSSO)
   { "User Idle Service",
     NS_IDLE_SERVICE_CID,
     "@mozilla.org/widget/idleservice;1",
     nsIdleServiceOSSOConstructor },  
-#else
+#elif defined(MOZ_X11)
 { "User Idle Service",
     NS_IDLE_SERVICE_CID,
     "@mozilla.org/widget/idleservice;1",
     nsIdleServiceGTKConstructor },
-#endif //NS_OSSO
+#endif
 
 };
 
 PR_STATIC_CALLBACK(void)
 nsWidgetGtk2ModuleDtor(nsIModule *aSelf)
diff --git a/widget/src/gtk2/nsWindow.cpp b/widget/src/gtk2/nsWindow.cpp
--- a/widget/src/gtk2/nsWindow.cpp
+++ b/widget/src/gtk2/nsWindow.cpp
@@ -55,22 +55,23 @@
 
 #include "nsGtkKeyUtils.h"
 #include "nsGtkCursors.h"
 
 #include <gtk/gtkwindow.h>
+#ifdef MOZ_X11
 #include <gdk/gdkx.h>
+#include <X11/XF86keysym.h>
+#include "gtk2xtbin.h"
+#endif /* MOZ_X11 */
 #include <gdk/gdkkeysyms.h>
-#include <X11/XF86keysym.h>
 
 #include "nsWidgetAtoms.h"
 
 #ifdef MOZ_ENABLE_STARTUP_NOTIFICATION
 #define SN_API_NOT_YET_FROZEN
 #include <startup-notification-1.0/libsn/sn.h>
 #endif
-
-#include "gtk2xtbin.h"
 
 #include "nsIPrefService.h"
 #include "nsIPrefBranch.h"
 #include "nsIServiceManager.h"
 #include "nsIStringBundle.h"
@@ -106,13 +107,32 @@ static const char sAccessibilityKey [] =
 #include "nsImageToPixbuf.h"
 #include "nsIInterfaceRequestorUtils.h"
 #include "nsAutoPtr.h"
 
 #include "gfxPlatformGtk.h"
-#include "gfxXlibSurface.h"
 #include "gfxContext.h"
 #include "gfxImageSurface.h"
+
+#ifdef MOZ_X11
+#include "gfxXlibSurface.h"
+#endif
+
+#ifdef MOZ_DFB
+extern "C" {
+#ifdef MOZ_DIRECT_DEBUG
+#define DIRECT_ENABLE_DEBUG
+#endif
+
+#include <direct/debug.h>
+
+D_DEBUG_DOMAIN( ns_Window, "nsWindow", "nsWindow" );
+}
+#include "gfxDirectFBSurface.h"
+#define GDK_WINDOW_XWINDOW(_win) _win
+#else
+#define D_DEBUG_AT(x,y...)    do {} while (0)
+#endif
 
 #ifdef MOZ_ENABLE_GLITZ
 #include "gfxGlitzSurface.h"
 #include "glitz-glx.h"
 #endif
@@ -182,16 +202,18 @@ static nsWindow* GetFirstNSWindowForGDKW
 static nsWindow* GetFirstNSWindowForGDKWindow (GdkWindow *aGdkWindow);
 
 #ifdef __cplusplus
 extern "C" {
 #endif /* __cplusplus */
+#ifdef MOZ_X11
 static GdkFilterReturn plugin_window_filter_func (GdkXEvent *gdk_xevent,
                                                   GdkEvent *event,
                                                   gpointer data);
 static GdkFilterReturn plugin_client_message_filter (GdkXEvent *xevent,
                                                      GdkEvent *event,
                                                      gpointer data);
+#endif /* MOZ_X11 */
 #ifdef __cplusplus
 }
 #endif /* __cplusplus */
 
 static gboolean drag_motion_event_cb      (GtkWidget *aWidget,
@@ -218,14 +240,16 @@ static void    drag_data_received_event_
                                            guint aInfo,
                                            guint32 aTime,
                                            gpointer aData);
 
 static GdkModifierType gdk_keyboard_get_modifiers();
+#ifdef MOZ_X11
 static PRBool gdk_keyboard_get_modmap_masks(Display*  aDisplay,
                                             PRUint32* aCapsLockMask,
                                             PRUint32* aNumLockMask,
                                             PRUint32* aScrollLockMask);
+#endif /* MOZ_X11 */
 
 /* initialization static functions */
 static nsresult    initialize_prefs        (void);
 
 // this is the last window that had a drag event happen on it.
@@ -321,11 +345,13 @@ nsWindow::nsWindow()
     mRetryKeyboardGrab   = PR_FALSE;
     mActivatePending     = PR_FALSE;
     mTransientParent     = nsnull;
     mWindowType          = eWindowType_child;
     mSizeState           = nsSizeMode_Normal;
+#ifdef MOZ_X11
     mOldFocusWindow      = 0;
+#endif /* MOZ_X11 */
     mPluginType          = PluginType_NONE;
 
     if (!gGlobalsInitialized) {
         gGlobalsInitialized = PR_TRUE;
 
@@ -355,10 +381,20 @@ nsWindow::nsWindow()
     mIsTransparent = PR_FALSE;
     mTransparencyBitmap = nsnull;
 
     mTransparencyBitmapWidth  = 0;
     mTransparencyBitmapHeight = 0;
+
+#ifdef MOZ_DFB
+    mDFBCursorX     = 0;
+    mDFBCursorY     = 0;
+
+    mDFBCursorCount = 0;
+
+    mDFB            = NULL;
+    mDFBLayer       = NULL;
+#endif
 }
 
 nsWindow::~nsWindow()
 {
     LOG(("nsWindow::~nsWindow() [%p]\n", (void *)this));
@@ -366,10 +402,18 @@ nsWindow::~nsWindow()
         mLastDragMotionWindow = NULL;
     }
 
     delete[] mTransparencyBitmap;
     mTransparencyBitmap = nsnull;
+
+#ifdef MOZ_DFB
+    if (mDFBLayer)
+         mDFBLayer->Release( mDFBLayer );
+         
+    if (mDFB)
+         mDFB->Release( mDFB );
+#endif
 
     Destroy();
 }
 
 /* static */ void
@@ -456,14 +500,16 @@ nsWindow::Destroy(void)
     if (gFocusWindow == this) {
         LOGFOCUS(("automatically losing focus...\n"));
         gFocusWindow = nsnull;
     }
 
+#ifdef MOZ_X11
     // make sure that we remove ourself as the plugin focus window
     if (gPluginFocusWindow == this) {
         gPluginFocusWindow->LoseNonXEmbedPluginFocus();
     }
+#endif /* MOZ_X11 */
 
     if (mWindowGroup) {
         g_object_unref(G_OBJECT(mWindowGroup));
         mWindowGroup = nsnull;
     }
@@ -1226,10 +1272,17 @@ nsWindow::Scroll(PRInt32  aDx,
                  nsRect  *aClipRect)
 {
     if (!mDrawingarea)
         return NS_OK;
 
+    D_DEBUG_AT( ns_Window, "%s( %4d,%4d )\n", __FUNCTION__, aDx, aDy );
+
+    if (aClipRect) {
+         D_DEBUG_AT( ns_Window, "  -> aClipRect: %4d,%4d-%4dx%4d\n",
+                     aClipRect->x, aClipRect->y, aClipRect->width, aClipRect->height );
+    }
+
     moz_drawingarea_scroll(mDrawingarea, aDx, aDy);
 
     // Update bounds on our child windows
     for (nsIWidget* kid = mFirstChild; kid; kid = kid->GetNextSibling()) {
         nsRect bounds;
@@ -1279,11 +1332,15 @@ nsWindow::GetNativeData(PRUint32 aDataTy
     case NS_NATIVE_PLUGIN_PORT:
         return SetupPluginPort();
         break;
 
     case NS_NATIVE_DISPLAY:
+#ifdef MOZ_X11
         return GDK_DISPLAY();
+#else
+        return nsnull;
+#endif /* MOZ_X11 */
         break;
 
     case NS_NATIVE_GRAPHIC: {
         NS_ASSERTION(nsnull != mToolkit, "NULL toolkit, unable to get a GC");
         return (void *)static_cast<nsGTKToolkit *>(mToolkit)->GetSharedGC();
@@ -1557,10 +1614,11 @@ nsWindow::LoseFocus(void)
 (gdk_keyboard_get_modifiers() & GDK_LOCK_MASK)
 
 #define WANT_PAINT_FLASHING \
 (debug_WantPaintFlashing() && CAPS_LOCK_IS_ON)
 
+#ifdef MOZ_X11
 static void
 gdk_window_flash(GdkWindow *    aGdkWindow,
                  unsigned int   aTimes,
                  unsigned int   aInterval,  // Milliseconds
                  GdkRegion *    aRegion)
@@ -1616,10 +1674,11 @@ gdk_window_flash(GdkWindow *    aGdkWind
 
   gdk_gc_destroy(gc);
 
   gdk_region_offset(aRegion, -x, -y);
 }
+#endif /* MOZ_X11 */
 #endif // DEBUG
 
 gboolean
 nsWindow::OnExposeEvent(GtkWidget *aWidget, GdkEventExpose *aEvent)
 {
@@ -1659,10 +1718,32 @@ nsWindow::OnExposeEvent(GtkWidget *aWidg
     for (r = rects; r < r_end; ++r) {
         updateRegion->Union(r->x, r->y, r->width, r->height);
         LOGDRAW(("\t%d %d %d %d\n", r->x, r->y, r->width, r->height));
     }
 
+#ifdef MOZ_DFB
+    nsCOMPtr<nsIRenderingContext> rc = getter_AddRefs(GetRenderingContext());
+    if (NS_UNLIKELY(!rc)) {
+        g_free(rects);
+        return FALSE;
+    }
+
+    // do double-buffering and clipping here
+    nsRefPtr<gfxContext> ctx = rc->ThebesContext();
+
+    gfxPlatformGtk::GetPlatform()->SetGdkDrawable(ctx->OriginalSurface(), GDK_DRAWABLE(mDrawingarea->inner_window));
+
+    // clip to the update region
+    ctx->Save();
+    ctx->NewPath();
+    for (r = rects; r < r_end; ++r) {
+        ctx->Rectangle(gfxRect(r->x, r->y, r->width, r->height));
+    }
+    ctx->Clip();
+#endif
+
+#ifdef MOZ_X11
     nsCOMPtr<nsIRenderingContext> rc = getter_AddRefs(GetRenderingContext());
     if (NS_UNLIKELY(!rc)) {
         g_free(rects);
         return FALSE;
     }
@@ -1706,17 +1787,21 @@ nsWindow::OnExposeEvent(GtkWidget *aWidg
         // XGetGeometry on us in gdk_pixmap_foreign_new_for_display when we
         // paint native themes
         GdkDrawable* d = GDK_DRAWABLE(mDrawingarea->inner_window);
         gint depth = gdk_drawable_get_depth(d);
         bufferPixmap = gdk_pixmap_new(d, boundsRect.width, boundsRect.height, depth);
+
         if (bufferPixmap) {
             bufferPixmapSurface = GetSurfaceForGdkDrawable(GDK_DRAWABLE(bufferPixmap),
                                                            boundsRect.Size());
             if (bufferPixmapSurface && bufferPixmapSurface->CairoStatus()) {
                 bufferPixmapSurface = nsnull;
             }
             if (bufferPixmapSurface) {
+                gfxPlatformGtk::GetPlatform()->SetGdkDrawable(
+                        static_cast<gfxASurface *>(bufferPixmapSurface), 
+                        GDK_DRAWABLE(bufferPixmap));
                 bufferPixmapSurface->SetDeviceOffset(gfxPoint(-boundsRect.x, -boundsRect.y));
                 nsCOMPtr<nsIRenderingContext> newRC;
                 nsresult rv = GetDeviceContext()->
                     CreateRenderingContextInstance(*getter_AddRefs(newRC));
                 if (NS_FAILED(rv)) {
@@ -1742,20 +1827,23 @@ nsWindow::OnExposeEvent(GtkWidget *aWidg
     if (WANT_PAINT_FLASHING && aEvent->window)
         gdk_window_flash(aEvent->window, 1, 100, aEvent->region);
 #endif
 #endif
 
+#endif // MOZ_X11
+
     nsPaintEvent event(PR_TRUE, NS_PAINT, this);
     event.refPoint.x = aEvent->area.x;
     event.refPoint.y = aEvent->area.y;
     event.rect = nsnull;
     event.region = updateRegion;
     event.renderingContext = rc;
 
     nsEventStatus status;
     DispatchEvent(&event, status);
 
+#ifdef MOZ_X11
     // DispatchEvent can Destroy us (bug 378273), avoid doing any paint
     // operations below if that happened - it will lead to XError and exit().
     if (NS_LIKELY(!mIsDestroyed)) {
         if (status != nsEventStatus_eIgnore) {
             if (translucent) {
@@ -1807,10 +1895,15 @@ nsWindow::OnExposeEvent(GtkWidget *aWidg
             g_object_unref(G_OBJECT(bufferPixmap));
         }
 
         ctx->Restore();
     }
+#endif // MOZ_X11
+
+#ifdef MOZ_DFB
+    ctx->Restore();
+#endif
 
     g_free(rects);
 
     // check the return value!
     return TRUE;
@@ -1947,22 +2040,81 @@ nsWindow::OnLeaveNotifyEvent(GtkWidget *
 
     nsEventStatus status;
     DispatchEvent(&event, status);
 }
 
+#ifdef MOZ_DFB
 void
 nsWindow::OnMotionNotifyEvent(GtkWidget *aWidget, GdkEventMotion *aEvent)
 {
+    int cursorX = (int) aEvent->x_root;
+    int cursorY = (int) aEvent->y_root;
+
+    D_DEBUG_AT( ns_Window, "%s( %4d,%4d - [%d] )\n", __FUNCTION__, cursorX, cursorY, mDFBCursorCount );
+
+    D_ASSUME( mDFBLayer != NULL );
+
+    if (mDFBLayer)
+         mDFBLayer->GetCursorPosition( mDFBLayer, &cursorX, &cursorY );
+
+    mDFBCursorCount++;
+
+#if D_DEBUG_ENABLED
+    if (cursorX != (int) aEvent->x_root || cursorY != (int) aEvent->y_root)
+         D_DEBUG_AT( ns_Window, "  -> forward to %4d,%4d\n", cursorX, cursorY );
+#endif
+
+    if (cursorX == mDFBCursorX && cursorY == mDFBCursorY) {
+         D_DEBUG_AT( ns_Window, "  -> dropping %4d,%4d\n", cursorX, cursorY );
+
+         /* drop zero motion */
+         return;
+    }
+
+    mDFBCursorX = cursorX;
+    mDFBCursorY = cursorY;
+
+
     // when we receive this, it must be that the gtk dragging is over,
     // it is dropped either in or out of mozilla, clear the flag
     sIsDraggingOutOf = PR_FALSE;
 
+    nsMouseEvent event(PR_TRUE, NS_MOUSE_MOVE, this, nsMouseEvent::eReal);
+
+    nsRect windowRect;
+    ScreenToWidget(nsRect(nscoord(cursorX), nscoord(cursorY), 1, 1), windowRect);
+
+    event.refPoint.x = windowRect.x;
+    event.refPoint.y = windowRect.y;
+
+    event.isShift   = (aEvent->state & GDK_SHIFT_MASK)
+        ? PR_TRUE : PR_FALSE;
+    event.isControl = (aEvent->state & GDK_CONTROL_MASK)
+        ? PR_TRUE : PR_FALSE;
+    event.isAlt     = (aEvent->state & GDK_MOD1_MASK)
+        ? PR_TRUE : PR_FALSE;
+
+    event.time = aEvent->time;
+
+    nsEventStatus status;
+    DispatchEvent(&event, status);
+}
+#else
+void
+nsWindow::OnMotionNotifyEvent(GtkWidget *aWidget, GdkEventMotion *aEvent)
+{
+    // when we receive this, it must be that the gtk dragging is over,
+    // it is dropped either in or out of mozilla, clear the flag
+    sIsDraggingOutOf = PR_FALSE;
+
     // see if we can compress this event
     // XXXldb Why skip every other motion event when we have multiple,
     // but not more than that?
+    PRPackedBool synthEvent = PR_FALSE;
+#ifdef MOZ_X11
     XEvent xevent;
-    PRPackedBool synthEvent = PR_FALSE;
+    
     while (XCheckWindowEvent(GDK_WINDOW_XDISPLAY(aEvent->window),
                              GDK_WINDOW_XWINDOW(aEvent->window),
                              ButtonMotionMask, &xevent)) {
         synthEvent = PR_TRUE;
     }
@@ -1970,14 +2122,16 @@ nsWindow::OnMotionNotifyEvent(GtkWidget 
     // if plugins still keeps the focus, get it back
     if (gPluginFocusWindow && gPluginFocusWindow != this) {
         nsRefPtr<nsWindow> kungFuDeathGrip = gPluginFocusWindow;
         gPluginFocusWindow->LoseNonXEmbedPluginFocus();
     }
+#endif /* MOZ_X11 */
 
     nsMouseEvent event(PR_TRUE, NS_MOUSE_MOVE, this, nsMouseEvent::eReal);
 
     if (synthEvent) {
+#ifdef MOZ_X11
         event.refPoint.x = nscoord(xevent.xmotion.x);
         event.refPoint.y = nscoord(xevent.xmotion.y);
 
         event.isShift   = (xevent.xmotion.state & GDK_SHIFT_MASK)
             ? PR_TRUE : PR_FALSE;
@@ -1985,10 +2139,23 @@ nsWindow::OnMotionNotifyEvent(GtkWidget 
             ? PR_TRUE : PR_FALSE;
         event.isAlt     = (xevent.xmotion.state & GDK_MOD1_MASK)
             ? PR_TRUE : PR_FALSE;
 
         event.time = xevent.xmotion.time;
+#else
+        event.refPoint.x = nscoord(aEvent->x);
+        event.refPoint.y = nscoord(aEvent->y);
+
+        event.isShift   = (aEvent->state & GDK_SHIFT_MASK)
+            ? PR_TRUE : PR_FALSE;
+        event.isControl = (aEvent->state & GDK_CONTROL_MASK)
+            ? PR_TRUE : PR_FALSE;
+        event.isAlt     = (aEvent->state & GDK_MOD1_MASK)
+            ? PR_TRUE : PR_FALSE;
+
+        event.time = aEvent->time;
+#endif /* MOZ_X11 */
     }
     else {
         // XXX see OnScrollEvent()
         if (aEvent->window == mDrawingarea->inner_window) {
             event.refPoint.x = nscoord(aEvent->x);
@@ -2012,10 +2179,11 @@ nsWindow::OnMotionNotifyEvent(GtkWidget 
     }
 
     nsEventStatus status;
     DispatchEvent(&event, status);
 }
+#endif
 
 void
 nsWindow::InitButtonEvent(nsMouseEvent &aEvent,
                           GdkEventButton *aGdkEvent)
 {
@@ -2213,15 +2381,17 @@ void
 void
 nsWindow::OnContainerFocusOutEvent(GtkWidget *aWidget, GdkEventFocus *aEvent)
 {
     LOGFOCUS(("OnContainerFocusOutEvent [%p]\n", (void *)this));
 
+#ifdef MOZ_X11
     // plugin lose focus
     if (gPluginFocusWindow) {
         nsRefPtr<nsWindow> kungFuDeathGrip = gPluginFocusWindow;
         gPluginFocusWindow->LoseNonXEmbedPluginFocus();
     }
+#endif /* MOZ_X11 */
 
     // Figure out if the focus widget is the child of this window.  If
     // it is, send a focus out and deactivate event for it.
     if (!gFocusWindow)
         return;
@@ -2376,10 +2546,11 @@ nsWindow::OnKeyPressEvent(GtkWidget *aWi
         || aEvent->keyval == GDK_Meta_L
         || aEvent->keyval == GDK_Meta_R) {
         return TRUE;
     }
 
+#ifdef MOZ_X11
     // Look for specialized app-command keys
     switch (aEvent->keyval) {
         case XF86XK_Back:
             return DispatchCommandEvent(nsWidgetAtoms::Back);
         case XF86XK_Forward:
@@ -2393,10 +2564,11 @@ nsWindow::OnKeyPressEvent(GtkWidget *aWi
         case XF86XK_Favorites:
             return DispatchCommandEvent(nsWidgetAtoms::Bookmarks);
         case XF86XK_HomePage:
             return DispatchCommandEvent(nsWidgetAtoms::Home);
     }
+#endif /* MOZ_X11 */
 
     nsKeyEvent event(PR_TRUE, NS_KEY_PRESS, this);
     InitKeyEvent(event, aEvent);
     if (isKeyDownCancelled) {
       // If prevent default set for onkeydown, do the same for onkeypress
@@ -3248,12 +3420,17 @@ nsWindow::NativeCreate(nsIWidget        
     default:
         break;
     }
     // Disable the double buffer because it will make the caret crazy
     // For bug#153805 (Gtk2 double buffer makes carets misbehave)
+    // DirectFB's expose code depends on gtk double buffering
+    // XXX - I think this bug is probably dead, we can just use gtk's
+    // double-buffering everywhere
+#ifdef MOZ_X11
     if (mContainer)
         gtk_widget_set_double_buffered (GTK_WIDGET(mContainer),FALSE);
+#endif
 
     // label the drawing area with this object so we can find our way
     // home
     g_object_set_data(G_OBJECT(mDrawingarea->clip_window), "nsWindow",
                       this);
@@ -3393,19 +3570,36 @@ nsWindow::NativeCreate(nsIWidget        
         LOG(("nsWindow:: Create Toplevel Accessibility\n"));
         CreateRootAccessible();
     }
 #endif
 
+#ifdef MOZ_DFB
+    if (!mDFB) {
+         DirectFBCreate( &mDFB );
+
+         D_ASSUME( mDFB != NULL );
+
+         if (mDFB)
+              mDFB->GetDisplayLayer( mDFB, DLID_PRIMARY, &mDFBLayer );
+
+         D_ASSUME( mDFBLayer != NULL );
+
+         if (mDFBLayer)
+              mDFBLayer->GetCursorPosition( mDFBLayer, &mDFBCursorX, &mDFBCursorY );
+    }
+#endif
+
     return NS_OK;
 }
 
 NS_IMETHODIMP
 nsWindow::SetWindowClass(const nsAString &xulWinType)
 {
   if (!mShell)
     return NS_ERROR_FAILURE;
 
+#ifdef MOZ_X11
   nsXPIDLString brandName;
   GetBrandName(brandName);
 
   XClassHint *class_hint = XAllocClassHint();
   if (!class_hint)
@@ -3445,10 +3639,43 @@ nsWindow::SetWindowClass(const nsAString
                 GDK_WINDOW_XWINDOW(GTK_WIDGET(mShell)->window),
                 class_hint);
   nsMemory::Free(class_hint->res_class);
   nsMemory::Free(class_hint->res_name);
   XFree(class_hint);
+#else /* MOZ_X11 */
+
+  char *res_name;
+
+  res_name = ToNewCString(xulWinType);
+  if (!res_name)
+    return NS_ERROR_OUT_OF_MEMORY;
+
+  printf("WARN: res_name = '%s'\n", res_name);
+
+
+  const char *role = NULL;
+
+  // Parse res_name into a name and role. Characters other than
+  // [A-Za-z0-9_-] are converted to '_'. Anything after the first
+  // colon is assigned to role; if there's no colon, assign the
+  // whole thing to both role and res_name.
+  for (char *c = res_name; *c; c++) {
+    if (':' == *c) {
+      *c = 0;
+      role = c + 1;
+    }
+    else if (!isascii(*c) || (!isalnum(*c) && ('_' != *c) && ('-' != *c)))
+      *c = '_';
+  }
+  res_name[0] = toupper(res_name[0]);
+  if (!role) role = res_name;
+
+  gdk_window_set_role(GTK_WIDGET(mShell)->window, role);
+
+  nsMemory::Free(res_name);
+
+#endif /* MOZ_X11 */
   return NS_OK;
 }
 
 void
 nsWindow::NativeResize(PRInt32 aWidth, PRInt32 aHeight, PRBool  aRepaint)
@@ -3968,10 +4195,11 @@ nsWindow::SetupPluginPort(void)
         return nsnull;
 
     // we have to flush the X queue here so that any plugins that
     // might be running on separate X connections will be able to use
     // this window in case it was just created
+#ifdef MOZ_X11
     XWindowAttributes xattrs;
     XGetWindowAttributes(GDK_DISPLAY (),
                          GDK_WINDOW_XWINDOW(mDrawingarea->inner_window),
                          &xattrs);
     XSelectInput (GDK_DISPLAY (),
@@ -3982,10 +4210,11 @@ nsWindow::SetupPluginPort(void)
     gdk_window_add_filter(mDrawingarea->inner_window,
                           plugin_window_filter_func,
                           this);
 
     XSync(GDK_DISPLAY(), False);
+#endif /* MOZ_X11 */
 
     return (void *)GDK_WINDOW_XWINDOW(mDrawingarea->inner_window);
 }
 
 nsresult
@@ -4025,10 +4254,11 @@ nsWindow::SetPluginType(PluginType aPlug
 nsWindow::SetPluginType(PluginType aPluginType)
 {
     mPluginType = aPluginType;
 }
 
+#ifdef MOZ_X11
 void
 nsWindow::SetNonXEmbedPluginFocus()
 {
     if (gPluginFocusWindow == this || mPluginType!=PluginType_NONXEMBED) {
         return;
@@ -4119,10 +4349,11 @@ nsWindow::LoseNonXEmbedPluginFocus()
     mOldFocusWindow = 0;
     gdk_window_remove_filter(NULL, plugin_client_message_filter, this);
 
     LOGFOCUS(("nsWindow::LoseNonXEmbedPluginFocus end\n"));
 }
+#endif /* MOZ_X11 */
 
 
 gint
 nsWindow::ConvertBorderStyles(nsBorderStyle aStyle)
 {
@@ -4202,11 +4433,15 @@ nsWindow::HideWindowChrome(PRBool aShoul
     // For some window managers, adding or removing window decorations
     // requires unmapping and remapping our toplevel window.  Go ahead
     // and flush the queue here so that we don't end up with a BadWindow
     // error later when this happens (when the persistence timer fires
     // and GetWindowPos is called)
+#ifdef MOZ_X11
     XSync(GDK_DISPLAY(), False);
+#else
+    gdk_flush ();
+#endif /* MOZ_X11 */
 
     return NS_OK;
 }
 
 PRBool
@@ -4710,10 +4945,11 @@ focus_out_event_cb(GtkWidget *widget, Gd
     window->OnContainerFocusOutEvent(widget, event);
 
     return FALSE;
 }
 
+#ifdef MOZ_X11
 /* static */
 GdkFilterReturn
 plugin_window_filter_func(GdkXEvent *gdk_xevent, GdkEvent *event, gpointer data)
 {
     GtkWidget *widget;
@@ -4808,10 +5044,11 @@ plugin_client_message_filter(GdkXEvent *
         return_val = GDK_FILTER_REMOVE;
     }
 
     return return_val;
 }
+#endif /* MOZ_X11 */
 
 /* static */
 gboolean
 key_press_event_cb(GtkWidget *widget, GdkEventKey *event)
 {
@@ -5194,10 +5431,11 @@ gdk_keyboard_get_modifiers()
     gdk_window_get_pointer(NULL, NULL, NULL, &m);
 
     return m;
 }
 
+#ifdef MOZ_X11
 // Get the modifier masks for GDK_Caps_Lock, GDK_Num_Lock and GDK_Scroll_Lock.
 // Return PR_TRUE on success, PR_FALSE on error.
 static PRBool
 gdk_keyboard_get_modmap_masks(Display*  aDisplay,
                               PRUint32* aCapsLockMask,
@@ -5251,10 +5489,11 @@ gdk_keyboard_get_modmap_masks(Display*  
 
     XFreeModifiermap(xmodmap);
     XFree(xkeymap);
     return PR_TRUE;
 }
+#endif /* MOZ_X11 */
 
 #ifdef ACCESSIBILITY
 /**
  * void
  * nsWindow::CreateRootAccessible
@@ -5908,10 +6147,12 @@ NS_IMETHODIMP
 NS_IMETHODIMP
 nsWindow::GetToggledKeyState(PRUint32 aKeyCode, PRBool* aLEDState)
 {
     NS_ENSURE_ARG_POINTER(aLEDState);
 
+#ifdef MOZ_X11
+
     GdkModifierType modifiers = gdk_keyboard_get_modifiers();
     PRUint32 capsLockMask, numLockMask, scrollLockMask;
     PRBool foundMasks = gdk_keyboard_get_modmap_masks(
                           GDK_WINDOW_XDISPLAY(mDrawingarea->inner_window),
                           &capsLockMask, &numLockMask, &scrollLockMask);
@@ -5927,10 +6168,13 @@ nsWindow::GetToggledKeyState(PRUint32 aK
     if (mask == 0)
         return NS_ERROR_NOT_IMPLEMENTED;
 
     *aLEDState = (modifiers & mask) != 0;
     return NS_OK;
+#else
+    return NS_ERROR_NOT_IMPLEMENTED;
+#endif /* MOZ_X11 */
 }
 
 /* static */
 void
 IM_preedit_changed_cb(GtkIMContext *aContext,
@@ -6205,10 +6449,11 @@ IM_get_input_context(nsWindow *aWindow)
     return data->mDummyContext;
 }
 
 #endif
 
+#ifdef MOZ_X11
 /* static */ already_AddRefed<gfxASurface>
 nsWindow::GetSurfaceForGdkDrawable(GdkDrawable* aDrawable,
                                    const nsSize& aSize)
 {
     GdkVisual* visual = gdk_drawable_get_visual(aDrawable);
@@ -6219,85 +6464,44 @@ nsWindow::GetSurfaceForGdkDrawable(GdkDr
     gfxASurface* result = new gfxXlibSurface(xDisplay, xDrawable, xVisual,
                                        gfxIntSize(aSize.width, aSize.height));
     NS_IF_ADDREF(result);
     return result;
 }
+#endif
 
 // return the gfxASurface for rendering to this widget
 gfxASurface*
 nsWindow::GetThebesSurface()
 {
-    // XXXvlad always create a new thebes surface for now,
-    // because the old clip doesn't get cleared otherwise.
-    // we should fix this at some point, and just reset
-    // the clip.
-    mThebesSurface = nsnull;
-
-    if (!mThebesSurface) {
-        GdkDrawable* d;
-        gint x_offset, y_offset;
-        gdk_window_get_internal_paint_info(mDrawingarea->inner_window,
-                &d, &x_offset, &y_offset);
-
-        gint width, height;
-        gdk_drawable_get_size(d, &width, &height);
-        // Owen Taylor says this is the right thing to do!
-        width = PR_MIN(32767, width);
-        height = PR_MIN(32767, height);
-
-        if (!gfxPlatform::UseGlitz()) {
-            mThebesSurface = new gfxXlibSurface
-                (GDK_WINDOW_XDISPLAY(d),
-                 GDK_WINDOW_XWINDOW(d),
-                 GDK_VISUAL_XVISUAL(gdk_drawable_get_visual(d)),
-                 gfxIntSize(width, height));
-
-            // if the surface creation is reporting an error, then
-            // we don't have a surface to give back
-            if (mThebesSurface && mThebesSurface->CairoStatus() != 0)
-                mThebesSurface = nsnull;
-        } else {
-#ifdef MOZ_ENABLE_GLITZ
-            glitz_surface_t *gsurf;
-            glitz_drawable_t *gdraw;
-
-            glitz_drawable_format_t *gdformat = glitz_glx_find_window_format (GDK_DISPLAY(),
-                                                                              gdk_x11_get_default_screen(),
-                                                                              0, NULL, 0);
-            if (!gdformat)
-                NS_ERROR("Failed to find glitz drawable format");
-
-            Display* dpy = GDK_WINDOW_XDISPLAY(d);
-            Window wnd = GDK_WINDOW_XWINDOW(d);
-            
-            gdraw =
-                glitz_glx_create_drawable_for_window (dpy,
-                                                      DefaultScreen(dpy),
-                                                      gdformat,
-                                                      wnd,
-                                                      width,
-                                                      height);
-            glitz_format_t *gformat =
-                glitz_find_standard_format (gdraw, GLITZ_STANDARD_RGB24);
-            gsurf =
-                glitz_surface_create (gdraw,
-                                      gformat,
-                                      width,
-                                      height,
-                                      0,
-                                      NULL);
-            glitz_surface_attach (gsurf, gdraw, GLITZ_DRAWABLE_BUFFER_FRONT_COLOR);
-
-
-            //fprintf (stderr, "## nsThebesDrawingSurface::Init Glitz DRAWABLE %p (DC: %p)\n", aWidget, aDC);
-            mThebesSurface = new gfxGlitzSurface (gdraw, gsurf, PR_TRUE);
-#endif
-        }
-
-        if (mThebesSurface) {
-            mThebesSurface->SetDeviceOffset(gfxPoint(-x_offset, -y_offset));
-        }
+    GdkDrawable* d;
+    gint x_offset, y_offset;
+    gdk_window_get_internal_paint_info(mDrawingarea->inner_window,
+                                       &d, &x_offset, &y_offset);
+
+#ifdef MOZ_X11
+    gint width, height;
+    gdk_drawable_get_size(d, &width, &height);
+    // Owen Taylor says this is the right thing to do!
+    width = PR_MIN(32767, width);
+    height = PR_MIN(32767, height);
+
+    mThebesSurface = new gfxXlibSurface
+        (GDK_WINDOW_XDISPLAY(d),
+         GDK_WINDOW_XWINDOW(d),
+         GDK_VISUAL_XVISUAL(gdk_drawable_get_visual(d)),
+         gfxIntSize(width, height));
+#endif
+#ifdef MOZ_DFB
+    mThebesSurface = new gfxDirectFBSurface(gdk_directfb_surface_lookup(d));
+#endif
+
+    // if the surface creation is reporting an error, then
+    // we don't have a surface to give back
+    if (mThebesSurface && mThebesSurface->CairoStatus() != 0) {
+        mThebesSurface = nsnull;
+    } else {
+        mThebesSurface->SetDeviceOffset(gfxPoint(-x_offset, -y_offset));
     }
 
     return mThebesSurface;
 }
 
diff --git a/widget/src/gtk2/nsWindow.h b/widget/src/gtk2/nsWindow.h
--- a/widget/src/gtk2/nsWindow.h
+++ b/widget/src/gtk2/nsWindow.h
@@ -54,11 +54,17 @@
 
 #include "gfxASurface.h"
 
 #include <gtk/gtk.h>
 
+#ifdef MOZ_DFB
+#include <gdk/gdkdirectfb.h>
+#endif /* MOZ_DFB */
+
+#ifdef MOZ_X11
 #include <gdk/gdkx.h>
+#endif /* MOZ_X11 */
 #include <gtk/gtkwindow.h>
 
 #ifdef ACCESSIBILITY
 #include "nsIAccessNode.h"
 #include "nsIAccessible.h"
@@ -254,16 +260,20 @@ public:
         PluginType_XEMBED,     /* the plugin support xembed */
         PluginType_NONXEMBED   /* the plugin does not support xembed */
     };
 
     void               SetPluginType(PluginType aPluginType);
+#ifdef MOZ_X11
     void               SetNonXEmbedPluginFocus(void);
     void               LoseNonXEmbedPluginFocus(void);
+#endif /* MOZ_X11 */
 
     void               ThemeChanged(void);
 
+#ifdef MOZ_X11
     Window             mOldFocusWindow;
+#endif /* MOZ_X11 */
 
     static guint32     mLastButtonPressTime;
     static guint32     mLastButtonReleaseTime;
 
     NS_IMETHOD         BeginResizeDrag   (nsGUIEvent* aEvent, PRInt32 aHorizontal, PRInt32 aVertical);
@@ -400,10 +410,18 @@ private:
     PRInt32             mTransparencyBitmapWidth;
     PRInt32             mTransparencyBitmapHeight;
 
     nsRefPtr<gfxASurface> mThebesSurface;
 
+#ifdef MOZ_DFB
+    int                    mDFBCursorX;
+    int                    mDFBCursorY;
+    PRUint32               mDFBCursorCount;
+    IDirectFB             *mDFB;
+    IDirectFBDisplayLayer *mDFBLayer;
+#endif
+
 #ifdef ACCESSIBILITY
     nsCOMPtr<nsIAccessible> mRootAccessible;
     void                CreateRootAccessible();
     void                GetRootAccessible(nsIAccessible** aAccessible);
     void                DispatchActivateEvent(void);
diff --git a/widget/src/windows/nsAppShell.cpp b/widget/src/windows/nsAppShell.cpp
--- a/widget/src/windows/nsAppShell.cpp
+++ b/widget/src/windows/nsAppShell.cpp
@@ -140,10 +140,11 @@ nsAppShell::ProcessNextNativeEvent(PRBoo
     if (PeekKeyAndIMEMessage(&msg, NULL) ||
         ::PeekMessageW(&msg, NULL, WM_MOUSEFIRST, WM_MOUSELAST, PM_REMOVE) || 
         ::PeekMessageW(&msg, NULL, 0, 0, PM_REMOVE)) {
       gotMessage = PR_TRUE;
       if (msg.message == WM_QUIT) {
+        ::PostQuitMessage(msg.wParam);
         Exit();
       } else {
         ::TranslateMessage(&msg);
         ::DispatchMessageW(&msg);
       }
diff --git a/widget/src/windows/nsWindow.cpp b/widget/src/windows/nsWindow.cpp
--- a/widget/src/windows/nsWindow.cpp
+++ b/widget/src/windows/nsWindow.cpp
@@ -290,14 +290,12 @@ PRInt32    nsWindow::sIMEAttributeArrayS
 PRInt32    nsWindow::sIMEAttributeArraySize    = 0;
 PRUint32*  nsWindow::sIMECompClauseArray       = NULL;
 PRInt32    nsWindow::sIMECompClauseArrayLength = 0;
 PRInt32    nsWindow::sIMECompClauseArraySize   = 0;
 long       nsWindow::sIMECursorPosition        = 0;
-PRUnichar* nsWindow::sIMEReconvertUnicode      = NULL;
 
 RECT*      nsWindow::sIMECompCharPos           = nsnull;
-PRInt32    nsWindow::sIMECaretHeight           = 0;
 
 PRBool nsWindow::sIsInEndSession = PR_FALSE;
 
 BOOL nsWindow::sIsRegistered       = FALSE;
 BOOL nsWindow::sIsPopupClassRegistered = FALSE;
@@ -744,12 +742,10 @@ nsWindow::~nsWindow()
       delete sIMECompUnicode;
     if (sIMEAttributeArray) 
       delete [] sIMEAttributeArray;
     if (sIMECompClauseArray) 
       delete [] sIMECompClauseArray;
-    if (sIMEReconvertUnicode)
-      nsMemory::Free(sIMEReconvertUnicode);
 
     NS_IF_RELEASE(gCursorImgContainer);
 
     if (sIsOleInitialized) {
       ::OleFlushClipboard();
@@ -6481,11 +6477,10 @@ nsWindow::HandleTextEvent(HIMC hIMEConte
       }
       sIMECompCharPos[sIMECursorPosition].left = cursorPosition.x;
       sIMECompCharPos[sIMECursorPosition].top = cursorPosition.y;
       sIMECompCharPos[sIMECursorPosition].bottom = cursorPosition.YMost();
     }
-    sIMECaretHeight = cursorPosition.height;
   } else {
     // for some reason we don't know yet, theReply may contain invalid result
     // need more debugging in nsCaret to find out the reason
     // the best we can do now is to ignore the invalid result
   }
@@ -6499,15 +6494,10 @@ nsWindow::HandleStartComposition(HIMC hI
   // 2. WM_IME_STARTCOMPOSITION
   // We call this function at both step #1 and #2.
   // However, the composition start event should occur only once.
   if (sIMEIsComposing)
     return PR_TRUE;
-
-  if (sIMEReconvertUnicode) {
-    nsMemory::Free(sIMEReconvertUnicode);
-    sIMEReconvertUnicode = NULL;
-  }
 
   nsCompositionEvent event(PR_TRUE, NS_COMPOSITION_START, this);
   nsPoint point(0, 0);
   CANDIDATEFORM candForm;
 
@@ -6547,11 +6537,10 @@ nsWindow::HandleStartComposition(HIMC hI
       memset(sIMECompCharPos, -1, sizeof(RECT)*IME_MAX_CHAR_POS);
       sIMECompCharPos[0].left = cursorPosition.x;
       sIMECompCharPos[0].top = cursorPosition.y;
       sIMECompCharPos[0].bottom = cursorPosition.YMost();
     }
-    sIMECaretHeight = cursorPosition.height;
   } else {
     // for some reason we don't know yet, theReply may contain invalid result
     // need more debugging in nsCaret to find out the reason
     // the best we can do now is to ignore the invalid result
   }
@@ -6580,11 +6569,10 @@ nsWindow::HandleEndComposition(void)
 
   InitEvent(event,&point);
   DispatchWindowEvent(&event);
   PR_FREEIF(sIMECompCharPos);
   sIMECompCharPos = nsnull;
-  sIMECaretHeight = 0;
   sIMEIsComposing = PR_FALSE;
 }
 
 static PRUint32 PlatformToNSAttr(PRUint8 aAttr)
 {
@@ -7040,148 +7028,111 @@ PRBool nsWindow::OnIMEReconvert(LPARAM a
 {
 #ifdef DEBUG_IME
   printf("OnIMEReconvert\n");
 #endif
 
-  PRBool           result  = PR_FALSE;
+  *oResult = 0;
   RECONVERTSTRING* pReconv = (RECONVERTSTRING*) aData;
-  int              len = 0;
+
+  nsQueryContentEvent selection(PR_TRUE, NS_QUERY_SELECTED_TEXT, this);
+  nsPoint point(0, 0);
+  InitEvent(selection, &point);
+  DispatchWindowEvent(&selection);
+  if (!selection.mSucceeded)
+    return PR_FALSE;
 
   if (!pReconv) {
-
-    //
-    // When reconvert, it must return need size to reconvert.
-    //
-    if (sIMEReconvertUnicode) {
-      nsMemory::Free(sIMEReconvertUnicode);
-      sIMEReconvertUnicode = NULL;
-    }
-
-    // Get reconversion string
-    nsReconversionEvent event(PR_TRUE, NS_RECONVERSION_QUERY, this);
-    nsPoint point(0, 0);
-
-    InitEvent(event, &point);
-    event.theReply.mReconversionString = NULL;
-    DispatchWindowEvent(&event);
-
-    sIMEReconvertUnicode = event.theReply.mReconversionString;
-
-    // Return need size
-
-    if (sIMEReconvertUnicode) {
-      len = nsCRT::strlen(sIMEReconvertUnicode);
-      *oResult = sizeof(RECONVERTSTRING) + len * sizeof(WCHAR);
-
-      result = PR_TRUE;
-    }
-  } else {
-
-    //
-    // Fill reconvert struct
-    //
-
-    len = nsCRT::strlen(sIMEReconvertUnicode);
+    // Return need size to reconvert.
+    if (selection.mReply.mString.IsEmpty())
+      return PR_FALSE;
+    PRUint32 len = selection.mReply.mString.Length();
     *oResult = sizeof(RECONVERTSTRING) + len * sizeof(WCHAR);
-
-    if (pReconv->dwSize < *oResult) {
-      *oResult = 0;
-      return PR_FALSE;
-    }
-
-    DWORD tmpSize = pReconv->dwSize;
-    ::ZeroMemory(pReconv, tmpSize);
-    pReconv->dwSize            = tmpSize;
-    pReconv->dwVersion         = 0;
-    pReconv->dwStrLen          = len;
-    pReconv->dwStrOffset       = sizeof(RECONVERTSTRING);
-    pReconv->dwCompStrLen      = len;
-    pReconv->dwCompStrOffset   = 0;
-    pReconv->dwTargetStrLen    = len;
-    pReconv->dwTargetStrOffset = 0;
-
-    ::CopyMemory((LPVOID) (aData + sizeof(RECONVERTSTRING)),
-                 sIMEReconvertUnicode, len * sizeof(WCHAR));
-
-    result = PR_TRUE;
-  }
-
-  return result;
+    return PR_TRUE;
+  }
+
+  // Fill reconvert struct
+  PRUint32 len = selection.mReply.mString.Length();
+  PRUint32 needSize = sizeof(RECONVERTSTRING) + len * sizeof(WCHAR);
+
+  if (pReconv->dwSize < needSize)
+    return PR_FALSE;
+
+  *oResult = needSize;
+
+  DWORD tmpSize = pReconv->dwSize;
+  ::ZeroMemory(pReconv, tmpSize);
+  pReconv->dwSize            = tmpSize;
+  pReconv->dwVersion         = 0;
+  pReconv->dwStrLen          = len;
+  pReconv->dwStrOffset       = sizeof(RECONVERTSTRING);
+  pReconv->dwCompStrLen      = len;
+  pReconv->dwCompStrOffset   = 0;
+  pReconv->dwTargetStrLen    = len;
+  pReconv->dwTargetStrOffset = 0;
+
+  ::CopyMemory((LPVOID) (aData + sizeof(RECONVERTSTRING)),
+               selection.mReply.mString.get(), len * sizeof(WCHAR));
+  return PR_TRUE;
 }
 
 //==========================================================================
 PRBool nsWindow::OnIMEQueryCharPosition(LPARAM aData, LRESULT *oResult)
 {
 #ifdef DEBUG_IME
   printf("OnIMEQueryCharPosition\n");
 #endif
+
+  PRUint32 len = sIMEIsComposing ? sIMECompUnicode->Length() : 0;
+  *oResult = FALSE;
   IMECHARPOSITION* pCharPosition = (IMECHARPOSITION*)aData;
   if (!pCharPosition ||
       pCharPosition->dwSize < sizeof(IMECHARPOSITION) ||
-      ::GetFocus() != mWnd) {
-    *oResult = FALSE;
-    return PR_FALSE;
-  }
-
-  if (!sIMEIsComposing) {  // Including |!sIMECompUnicode| and |!sIMECompUnicode->IsEmpty|.
-    if (pCharPosition->dwCharPos != 0) {
-      *oResult = FALSE;
+      ::GetFocus() != mWnd ||
+      pCharPosition->dwCharPos > len)
+    return PR_FALSE;
+
+  nsPoint point(0, 0);
+
+  nsQueryContentEvent selection(PR_TRUE, NS_QUERY_SELECTED_TEXT, this);
+  InitEvent(selection, &point);
+  DispatchWindowEvent(&selection);
+  if (!selection.mSucceeded)
+    return PR_FALSE;
+
+  PRUint32 offset = selection.mReply.mOffset + pCharPosition->dwCharPos;
+  PRBool useCaretRect = selection.mReply.mString.IsEmpty();
+
+  nsRect r;
+  if (!useCaretRect) {
+    nsQueryContentEvent charRect(PR_TRUE, NS_QUERY_CHARACTER_RECT, this);
+    charRect.InitForQueryCharacterRect(offset);
+    InitEvent(charRect, &point);
+    DispatchWindowEvent(&charRect);
+    if (charRect.mSucceeded)
+      r = charRect.mReply.mRect;
+    else
+      useCaretRect = PR_TRUE;
+  }
+
+  if (useCaretRect) {
+    nsQueryContentEvent caretRect(PR_TRUE, NS_QUERY_CARET_RECT, this);
+    caretRect.InitForQueryCaretRect(offset);
+    InitEvent(caretRect, &point);
+    DispatchWindowEvent(&caretRect);
+    if (!caretRect.mSucceeded)
       return PR_FALSE;
-    }
-    nsPoint point(0, 0);
-    nsQueryCaretRectEvent event(PR_TRUE, NS_QUERYCARETRECT, this);
-    InitEvent(event, &point);
-    DispatchWindowEvent(&event);
-    // The active widget doesn't support this event.
-    if (!event.theReply.mRectIsValid) {
-      *oResult = FALSE;
-      return PR_FALSE;
-    }
-
-    nsRect screenRect;
-    ResolveIMECaretPos(nsnull, event.theReply.mCaretRect, screenRect);
-    pCharPosition->pt.x = screenRect.x;
-    pCharPosition->pt.y = screenRect.y;
-
-    pCharPosition->cLineHeight = event.theReply.mCaretRect.height;
-
-    ::GetWindowRect(mWnd, &pCharPosition->rcDocument);
-
-    *oResult = TRUE;
-    return PR_TRUE;
-  }
-
-  // If the char positions are not cached, we should not return the values by LPARAM.
-  // Because in this case, the active widget is not editor.
-  if (!sIMECompCharPos) {
-    *oResult = FALSE;
-    return PR_FALSE;
-  }
-
-  long charPosition;
-  if (pCharPosition->dwCharPos > sIMECompUnicode->Length()) {
-    *oResult = FALSE;
-    return PR_FALSE;
-  }
-  charPosition = pCharPosition->dwCharPos;
-
-  // We only support insertion at the cursor position or at the leftmost position.
-  // Because sIMECompCharPos may be broken by user converting the string.
-  // But leftmost position and cursor position is always correctly.
-  if ((charPosition != 0 && charPosition != sIMECursorPosition) ||
-      charPosition > IME_MAX_CHAR_POS) {
-    *oResult = FALSE;
-    return PR_FALSE;
-  }
-  POINT pt;
-  pt.x = sIMECompCharPos[charPosition].left;
-  pt.y = sIMECompCharPos[charPosition].top;
-  ::ClientToScreen(mWnd, &pt);
-  pCharPosition->pt = pt;
-
-  pCharPosition->cLineHeight = sIMECaretHeight;
-
+    r = caretRect.mReply.mRect;
+  }
+
+  nsRect screenRect;
+  ResolveIMECaretPos(nsnull, r, screenRect);
+  pCharPosition->pt.x = screenRect.x;
+  pCharPosition->pt.y = screenRect.y;
+
+  pCharPosition->cLineHeight = r.height;
+
+  // XXX Should we create "query focused content rect event"?
   ::GetWindowRect(mWnd, &pCharPosition->rcDocument);
 
   *oResult = TRUE;
   return PR_TRUE;
 }
diff --git a/widget/src/windows/nsWindow.h b/widget/src/windows/nsWindow.h
--- a/widget/src/windows/nsWindow.h
+++ b/widget/src/windows/nsWindow.h
@@ -393,15 +393,13 @@ protected:
   static PRInt32    sIMEAttributeArraySize;
   static PRUint32*  sIMECompClauseArray;
   static PRInt32    sIMECompClauseArrayLength;
   static PRInt32    sIMECompClauseArraySize;
   static long       sIMECursorPosition;
-  static PRUnichar* sIMEReconvertUnicode; // reconvert string
 
   // For describing composing frame
   static RECT*      sIMECompCharPos;
-  static PRInt32    sIMECaretHeight;
 
   static PRBool     sIsInEndSession;
 
   nsSize        mLastSize;
   static        nsWindow* gCurrentWindow;
diff --git a/widget/src/xpwidgets/nsBaseWidget.cpp b/widget/src/xpwidgets/nsBaseWidget.cpp
--- a/widget/src/xpwidgets/nsBaseWidget.cpp
+++ b/widget/src/xpwidgets/nsBaseWidget.cpp
@@ -860,10 +860,16 @@ nsBaseWidget::SetWindowTitlebarColor(nsc
 nsBaseWidget::SetWindowTitlebarColor(nscolor aColor, PRBool aActive)
 {
   return NS_ERROR_NOT_IMPLEMENTED;
 }
 
+PRBool
+nsBaseWidget::ShowsResizeIndicator(nsIntRect* aResizerRect)
+{
+  return PR_FALSE;
+}
+
 
 /**
  * Modifies aFile to point at an icon file with the given name and suffix.  The
  * suffix may correspond to a file extension with leading '.' if appropriate.
  * Returns true if the icon file exists and can be read.
diff --git a/widget/src/xpwidgets/nsBaseWidget.h b/widget/src/xpwidgets/nsBaseWidget.h
--- a/widget/src/xpwidgets/nsBaseWidget.h
+++ b/widget/src/xpwidgets/nsBaseWidget.h
@@ -131,10 +131,11 @@ public:
   NS_IMETHOD              GetLastInputEventTime(PRUint32& aTime);
   NS_IMETHOD              SetIcon(const nsAString &anIconSpec);
   NS_IMETHOD              BeginSecureKeyboardInput();
   NS_IMETHOD              EndSecureKeyboardInput();
   NS_IMETHOD              SetWindowTitlebarColor(nscolor aColor, PRBool aActive);
+  virtual PRBool          ShowsResizeIndicator(nsIntRect* aResizerRect);
   virtual void            ConvertToDeviceCoordinates(nscoord  &aX,nscoord &aY) {}
   virtual void            FreeNativeData(void * data, PRUint32 aDataType) {}
   NS_IMETHOD              BeginResizeDrag(nsGUIEvent* aEvent, PRInt32 aHorizontal, PRInt32 aVertical);
   virtual nsresult        ActivateNativeMenuItemAt(const nsAString& indexString) { return NS_ERROR_NOT_IMPLEMENTED; }
   virtual nsresult        ForceNativeMenuReload() { return NS_ERROR_NOT_IMPLEMENTED; }
diff --git a/xpcom/analysis/final.js b/xpcom/analysis/final.js
--- a/xpcom/analysis/final.js
+++ b/xpcom/analysis/final.js
@@ -1,10 +1,10 @@ function process_type(c)
 function process_type(c)
 {
   if ((c.kind == 'class' || c.kind == 'struct') && !c.isIncomplete) {
     for each (let base in c.bases)
-      if (isFinal(base))
+      if (isFinal(base.type))
         error("Class '" + c.name + "' derives from final class '" + base.name + "'.", c.loc);
   }
 }
 
 function isFinal(c)
diff --git a/xpcom/analysis/stack.js b/xpcom/analysis/stack.js
--- a/xpcom/analysis/stack.js
+++ b/xpcom/analysis/stack.js
@@ -14,11 +14,11 @@ function isStack(c)
   {
     if (hasAttribute(c, 'NS_stack'))
       return true;
 
     for each (let base in c.bases)
-      if (isStack(base))
+      if (isStack(base.type))
         return true;
 
     for each (let member in c.members) {
       if (member.isFunction)
         continue;
diff --git a/xpcom/ds/nsPersistentProperties.cpp b/xpcom/ds/nsPersistentProperties.cpp
--- a/xpcom/ds/nsPersistentProperties.cpp
+++ b/xpcom/ds/nsPersistentProperties.cpp
@@ -43,10 +43,11 @@
 #include "nsUnicharInputStream.h"
 #include "pratom.h"
 #include "nsEnumeratorUtils.h"
 #include "nsReadableUtils.h"
 #include "nsPrintfCString.h"
+#include "nsDependentString.h"
 
 #define PL_ARENA_CONST_ALIGN_MASK 3
 #include "nsPersistentProperties.h"
 #include "nsIProperties.h"
 #include "nsISupportsArray.h"
@@ -95,10 +96,393 @@ static const struct PLDHashTableOps prop
   PL_DHashClearEntryStub,
   PL_DHashFinalizeStub,
   nsnull,
 };
 
+//
+// parser stuff
+//
+enum EParserState {
+  eParserState_AwaitingKey,
+  eParserState_Key,
+  eParserState_AwaitingValue,
+  eParserState_Value,
+  eParserState_Comment
+};
+
+enum EParserSpecial {
+  eParserSpecial_None,          // not parsing a special character
+  eParserSpecial_Escaped,       // awaiting a special character
+  eParserSpecial_Unicode        // parsing a \Uxxx value
+};
+
+class nsPropertiesParser
+{
+public:
+  nsPropertiesParser(nsIPersistentProperties* aProps) :
+    mHaveMultiLine(PR_FALSE), mState(eParserState_AwaitingKey),
+    mProps(aProps) {}
+
+  void FinishValueState(nsAString& aOldValue) {
+    static const char trimThese[] = " \t";
+    mKey.Trim(trimThese, PR_FALSE, PR_TRUE);
+
+    // This is really ugly hack but it should be fast
+    PRUnichar backup_char;
+    if (mMinLength)
+    {
+      backup_char = mValue[mMinLength-1];
+      mValue.SetCharAt('x', mMinLength-1);
+    }
+    mValue.Trim(trimThese, PR_FALSE, PR_TRUE);
+    if (mMinLength)
+      mValue.SetCharAt(backup_char, mMinLength-1);
+
+    mProps->SetStringProperty(NS_ConvertUTF16toUTF8(mKey), mValue, aOldValue);
+    mSpecialState = eParserSpecial_None;
+    WaitForKey();
+  }
+
+  EParserState GetState() { return mState; }
+
+  static NS_METHOD SegmentWriter(nsIUnicharInputStream* aStream,
+                                 void* aClosure,
+                                 const PRUnichar *aFromSegment,
+                                 PRUint32 aToOffset,
+                                 PRUint32 aCount,
+                                 PRUint32 *aWriteCount);
+
+  nsresult ParseBuffer(const PRUnichar* aBuffer, PRUint32 aBufferLength);
+
+private:
+  PRBool ParseValueCharacter(
+    PRUnichar c,                  // character that is just being parsed
+    const PRUnichar* cur,         // pointer to character c in the buffer
+    const PRUnichar* &tokenStart, // string copying is done in blocks as big as
+                                  // possible, tokenStart points to the beginning
+                                  // of this block
+    nsAString& oldValue);         // when duplicate property is found, new value
+                                  // is stored into hashtable and the old one is
+                                  // placed in this variable
+
+  void WaitForKey() {
+    mState = eParserState_AwaitingKey;
+  }
+
+  void EnterKeyState() {
+    mKey.Truncate();
+    mState = eParserState_Key;
+  }
+
+  void WaitForValue() {
+    mState = eParserState_AwaitingValue;
+  }
+
+  void EnterValueState() {
+    mValue.Truncate();
+    mMinLength = 0;
+    mState = eParserState_Value;
+    mSpecialState = eParserSpecial_None;
+  }
+
+  void EnterCommentState() {
+    mState = eParserState_Comment;
+  }
+
+  nsAutoString mKey;
+  nsAutoString mValue;
+
+  PRUint32  mUnicodeValuesRead; // should be 4!
+  PRUnichar mUnicodeValue;      // currently parsed unicode value
+  PRBool    mHaveMultiLine;     // is TRUE when last processed characters form
+                                // any of following sequences:
+                                //  - "\\\r"
+                                //  - "\\\n"
+                                //  - "\\\r\n"
+                                //  - any sequence above followed by any
+                                //    combination of ' ' and '\t'
+  PRBool    mMultiLineCanSkipN; // TRUE if "\\\r" was detected
+  PRUint32  mMinLength;         // limit right trimming at the end to not trim
+                                // escaped whitespaces
+  EParserState mState;
+  // if we see a '\' then we enter this special state
+  EParserSpecial mSpecialState;
+  nsIPersistentProperties* mProps;
+};
+
+inline PRBool IsWhiteSpace(PRUnichar aChar)
+{
+  return (aChar == ' ') || (aChar == '\t') ||
+         (aChar == '\r') || (aChar == '\n');
+}
+
+inline PRBool IsEOL(PRUnichar aChar)
+{
+  return (aChar == '\r') || (aChar == '\n');
+}
+
+
+PRBool nsPropertiesParser::ParseValueCharacter(
+    PRUnichar c, const PRUnichar* cur, const PRUnichar* &tokenStart,
+    nsAString& oldValue)
+{
+  switch (mSpecialState) {
+
+    // the normal state - look for special characters
+  case eParserSpecial_None:
+    switch (c) {
+    case '\\':
+      if (mHaveMultiLine)
+        // there is nothing to append to mValue yet
+        mHaveMultiLine = PR_FALSE;
+      else
+        mValue += Substring(tokenStart, cur);
+
+      mSpecialState = eParserSpecial_Escaped;
+      break;
+
+    case '\n':
+      // if we detected multiline and got only "\\\r" ignore next "\n" if any
+      if (mHaveMultiLine && mMultiLineCanSkipN) {
+        // but don't allow another '\n' to be skipped
+        mMultiLineCanSkipN = PR_FALSE;
+        // Now there is nothing to append to the mValue since we are skipping
+        // whitespaces at the beginning of the new line of the multiline
+        // property. Set tokenStart properly to ensure that nothing is appended
+        // if we find regular line-end or the end of the buffer.
+        tokenStart = cur+1;
+        break;
+      }
+      // no break
+
+    case '\r':
+      // we're done! We have a key and value
+      mValue += Substring(tokenStart, cur);
+      FinishValueState(oldValue);
+      mHaveMultiLine = PR_FALSE;
+      break;
+
+    default:
+      // there is nothing to do with normal characters,
+      // but handle multilines correctly
+      if (mHaveMultiLine) {
+        if (c == ' ' || c == '\t') {
+          // don't allow another '\n' to be skipped
+          mMultiLineCanSkipN = PR_FALSE;
+          // Now there is nothing to append to the mValue since we are skipping
+          // whitespaces at the beginning of the new line of the multiline
+          // property. Set tokenStart properly to ensure that nothing is appended
+          // if we find regular line-end or the end of the buffer.
+          tokenStart = cur+1;
+          break;
+        }
+        mHaveMultiLine = PR_FALSE;
+        tokenStart = cur;
+      }
+      break; // from switch on (c)
+    }
+    break; // from switch on (mSpecialState)
+
+    // saw a \ character, so parse the character after that
+  case eParserSpecial_Escaped:
+    // probably want to start parsing at the next token
+    // other characters, like 'u' might override this
+    tokenStart = cur+1;
+    mSpecialState = eParserSpecial_None;
+
+    switch (c) {
+
+      // the easy characters - \t, \n, and so forth
+    case 't':
+      mValue += PRUnichar('\t');
+      mMinLength = mValue.Length();
+      break;
+    case 'n':
+      mValue += PRUnichar('\n');
+      mMinLength = mValue.Length();
+      break;
+    case 'r':
+      mValue += PRUnichar('\r');
+      mMinLength = mValue.Length();
+      break;
+    case '\\':
+      mValue += PRUnichar('\\');
+      break;
+
+      // switch to unicode mode!
+    case 'u':
+    case 'U':
+      mSpecialState = eParserSpecial_Unicode;
+      mUnicodeValuesRead = 0;
+      mUnicodeValue = 0;
+      break;
+
+      // a \ immediately followed by a newline means we're going multiline
+    case '\r':
+    case '\n':
+      mHaveMultiLine = PR_TRUE;
+      mMultiLineCanSkipN = (c == '\r');
+      mSpecialState = eParserSpecial_None;
+      break;
+
+    default:
+      // don't recognize the character, so just append it
+      mValue += c;
+      break;
+    }
+    break;
+
+    // we're in the middle of parsing a 4-character unicode value
+    // like \u5f39
+  case eParserSpecial_Unicode:
+
+    if(('0' <= c) && (c <= '9'))
+      mUnicodeValue =
+        (mUnicodeValue << 4) | (c - '0');
+    else if(('a' <= c) && (c <= 'f'))
+      mUnicodeValue =
+        (mUnicodeValue << 4) | (c - 'a' + 0x0a);
+    else if(('A' <= c) && (c <= 'F'))
+      mUnicodeValue =
+        (mUnicodeValue << 4) | (c - 'A' + 0x0a);
+    else {
+      // non-hex character. Append what we have, and move on.
+      mValue += mUnicodeValue;
+      mMinLength = mValue.Length();
+      mSpecialState = eParserSpecial_None;
+
+      // leave tokenStart at this unknown character, so it gets appended
+      tokenStart = cur;
+
+      // ensure parsing this non-hex character again
+      return PR_FALSE;
+    }
+
+    if (++mUnicodeValuesRead >= 4) {
+      tokenStart = cur+1;
+      mSpecialState = eParserSpecial_None;
+      mValue += mUnicodeValue;
+      mMinLength = mValue.Length();
+    }
+
+    break;
+  }
+
+  return PR_TRUE;
+}
+
+NS_METHOD nsPropertiesParser::SegmentWriter(nsIUnicharInputStream* aStream,
+                                            void* aClosure,
+                                            const PRUnichar *aFromSegment,
+                                            PRUint32 aToOffset,
+                                            PRUint32 aCount,
+                                            PRUint32 *aWriteCount)
+{
+  nsPropertiesParser *parser = 
+    static_cast<nsPropertiesParser *>(aClosure);
+  
+  parser->ParseBuffer(aFromSegment, aCount);
+
+  *aWriteCount = aCount;
+  return NS_OK;
+}
+
+nsresult nsPropertiesParser::ParseBuffer(const PRUnichar* aBuffer,
+                                         PRUint32 aBufferLength)
+{
+  const PRUnichar* cur = aBuffer;
+  const PRUnichar* end = aBuffer + aBufferLength;
+
+  // points to the start/end of the current key or value
+  const PRUnichar* tokenStart = nsnull;
+
+  // if we're in the middle of parsing a key or value, make sure
+  // the current token points to the beginning of the current buffer
+  if (mState == eParserState_Key ||
+      mState == eParserState_Value) {
+    tokenStart = aBuffer;
+  }
+
+  nsAutoString oldValue;
+
+  while (cur != end) {
+
+    PRUnichar c = *cur;
+
+    switch (mState) {
+    case eParserState_AwaitingKey:
+      if (c == '#' || c == '!')
+        EnterCommentState();
+
+      else if (!IsWhiteSpace(c)) {
+        // not a comment, not whitespace, we must have found a key!
+        EnterKeyState();
+        tokenStart = cur;
+      }
+      break;
+
+    case eParserState_Key:
+      if (c == '=' || c == ':') {
+        mKey += Substring(tokenStart, cur);
+        WaitForValue();
+      }
+      break;
+
+    case eParserState_AwaitingValue:
+      if (IsEOL(c)) {
+        // no value at all! mimic the normal value-ending
+        EnterValueState();
+        FinishValueState(oldValue);
+      }
+
+      // ignore white space leading up to the value
+      else if (!IsWhiteSpace(c)) {
+        tokenStart = cur;
+        EnterValueState();
+
+        // make sure to handle this first character
+        if (ParseValueCharacter(c, cur, tokenStart, oldValue))
+          cur++;
+        // If the character isn't consumed, don't do cur++ and parse
+        // the character again. This can happen f.e. for char 'X' in sequence
+        // "\u00X". This character can be control character and must be
+        // processed again.
+        continue;
+      }
+      break;
+
+    case eParserState_Value:
+      if (ParseValueCharacter(c, cur, tokenStart, oldValue))
+        cur++;
+      // See few lines above for reason of doing this
+      continue;
+
+    case eParserState_Comment:
+      // stay in this state till we hit EOL
+      if (c == '\r' || c== '\n')
+        WaitForKey();
+      break;
+    }
+
+    // finally, advance to the next character
+    cur++;
+  }
+
+  // if we're still parsing the value and are in eParserSpecial_None, then
+  // append whatever we have..
+  if (mState == eParserState_Value && tokenStart &&
+      mSpecialState == eParserSpecial_None) {
+    mValue += Substring(tokenStart, cur);
+  }
+  // if we're still parsing the key, then append whatever we have..
+  else if (mState == eParserState_Key && tokenStart) {
+    mKey += Substring(tokenStart, cur);
+  }
+
+  return NS_OK;
+}
+
 nsPersistentProperties::nsPersistentProperties()
 : mIn(nsnull)
 {
   mSubclass = static_cast<nsIPersistentProperties*>(this);
   mTable.ops = nsnull;
@@ -144,153 +528,44 @@ NS_IMPL_THREADSAFE_ISUPPORTS2(nsPersiste
 NS_IMPL_THREADSAFE_ISUPPORTS2(nsPersistentProperties, nsIPersistentProperties, nsIProperties)
 
 NS_IMETHODIMP
 nsPersistentProperties::Load(nsIInputStream *aIn)
 {
-  PRInt32  c;
-  nsresult ret = nsSimpleUnicharStreamFactory::GetInstance()->
-    CreateInstanceFromUTF8Stream(aIn, &mIn);
+  nsresult rv = nsSimpleUnicharStreamFactory::GetInstance()->
+    CreateInstanceFromUTF8Stream(aIn, getter_AddRefs(mIn));
 
-  if (ret != NS_OK) {
-    NS_WARNING("NS_NewUTF8ConverterStream failed");
+  if (rv != NS_OK) {
+    NS_WARNING("Error creating UnicharInputStream");
     return NS_ERROR_FAILURE;
   }
-  c = Read();
-  while (1) {
-    c = SkipWhiteSpace(c);
-    if (c < 0) {
-      break;
-    }
-    else if ((c == '#') || (c == '!')) {
-      c = SkipLine(c);
-      continue;
-    }
-    else {
-      nsAutoString key;
-      while ((c >= 0) && (c != '=') && (c != ':')) {
-        key.Append(PRUnichar(c));
-        c = Read();
-      }
-      if (c < 0) {
-        break;
-      }
-      static const char trimThese[] = " \t";
-      key.Trim(trimThese, PR_FALSE, PR_TRUE);
-      c = Read();
-      nsAutoString value, tempValue;
-      while ((c >= 0) && (c != '\r') && (c != '\n')) {
-        if (c == '\\') {
-          c = Read();
-          switch(c) {
-            case '\r':
-            case '\n':
-              // Only skip first EOL characters and then next line's
-              // whitespace characters. Skipping all EOL characters
-              // and all upcoming whitespace is too agressive.
-              if (c == '\r')
-                c = Read();
-              if (c == '\n')
-                c = Read();
-              while (c == ' ' || c == '\t')
-                c = Read();
-              continue;
-            default:
-              tempValue.Append((PRUnichar) '\\');
-              tempValue.Append((PRUnichar) c);
-          } // switch(c)
-        } else {
-          tempValue.Append((PRUnichar) c);
-        }
-        c = Read();
-      }
-      tempValue.Trim(trimThese, PR_TRUE, PR_TRUE);
 
-      PRUint32 state  = 0;
-      PRUnichar uchar = 0;
-      for (PRUint32 i = 0; i < tempValue.Length(); ++i) {
-        PRUnichar ch = tempValue[i];
-        switch(state) {
-          case 0:
-           if (ch == '\\') {
-             ++i;
-             if (i == tempValue.Length())
-               break;
-             ch = tempValue[i];
-             switch(ch) {
-               case 'u':
-               case 'U':
-                 state = 1;
-                 uchar=0;
-                 break;
-               case 't':
-                 value.Append(PRUnichar('\t'));
-                 break;
-               case 'n':
-                 value.Append(PRUnichar('\n'));
-                 break;
-               case 'r':
-                 value.Append(PRUnichar('\r'));
-                 break;
-               default:
-                 value.Append(ch);
-             } // switch(ch)
-           } else {
-             value.Append(ch);
-           }
-           continue;
-         case 1:
-         case 2:
-         case 3:
-         case 4:
-           if (('0' <= ch) && (ch <= '9')) {
-               uchar = (uchar << 4) | (ch - '0');
-              state++;
-              continue;
-           }
-           if (('a' <= ch) && (ch <= 'f')) {
-              uchar = (uchar << 4) | (ch - 'a' + 0x0a);
-              state++;
-              continue;
-           }
-           if (('A' <= ch) && (ch <= 'F')) {
-              uchar = (uchar << 4) | (ch - 'A' + 0x0a);
-              state++;
-              continue;
-           }
-           // if not hex digit, fall through
-         case 5:
-           value.Append((PRUnichar) uchar);
-           state = 0;
-           --i;
-           break;
-        }
-      }
-      if (state != 0) {
-        value.Append((PRUnichar) uchar);
-        state = 0;
-      }
-      
-      nsAutoString oldValue;
-      mSubclass->SetStringProperty(NS_ConvertUTF16toUTF8(key), value, oldValue);
-    }
+  nsPropertiesParser parser(mSubclass);
+
+  PRUint32 nProcessed;
+  // If this 4096 is changed to some other value, make sure to adjust
+  // the bug121341.properties test file accordingly.
+  while (NS_SUCCEEDED(rv = mIn->ReadSegments(nsPropertiesParser::SegmentWriter, &parser, 4096, &nProcessed)) &&
+         nProcessed != 0);
+  mIn = nsnull;
+  if (NS_FAILED(rv))
+    return rv;
+
+  // We may have an unprocessed value at this point
+  // if the last line did not have a proper line ending.
+  if (parser.GetState() == eParserState_Value) {
+    nsAutoString oldValue;  
+    parser.FinishValueState(oldValue);
   }
-  mIn->Close();
-  NS_RELEASE(mIn);
 
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsPersistentProperties::SetStringProperty(const nsACString& aKey,
                                           const nsAString& aNewValue,
                                           nsAString& aOldValue)
 {
-#if 0
-  cout << "will add " << aKey.get() << "=" <<
-    NS_LossyConvertUCS2ToASCII(aNewValue).get() << endl;
-#endif
-
   const nsAFlatCString&  flatKey = PromiseFlatCString(aKey);
   PropertyTableEntry *entry =
     static_cast<PropertyTableEntry*>
                (PL_DHashTableOperate(&mTable, flatKey.get(), PL_DHASH_ADD));
 
@@ -368,64 +643,19 @@ nsPersistentProperties::Enumerate(nsISim
   if (NS_FAILED(rv))
     return rv;
 
   // We know the necessary size; we can avoid growing it while adding elements
   if (!propArray->SizeTo(mTable.entryCount))
-   return NS_ERROR_OUT_OF_MEMORY;
+    return NS_ERROR_OUT_OF_MEMORY;
 
   // Step through hash entries populating a transient array
   PRUint32 n =
     PL_DHashTableEnumerate(&mTable, AddElemToArray, (void *)propArray);
   if (n < mTable.entryCount)
-      return NS_ERROR_OUT_OF_MEMORY;
+    return NS_ERROR_OUT_OF_MEMORY;
 
   return NS_NewArrayEnumerator(aResult, propArray);
-}
-
-
-PRInt32
-nsPersistentProperties::Read()
-{
-  PRUnichar  c;
-  PRUint32  nRead;
-  nsresult  ret;
-
-  ret = mIn->Read(&c, 1, &nRead);
-  if (ret == NS_OK && nRead == 1) {
-    return c;
-  }
-
-  return -1;
-}
-
-#define IS_WHITE_SPACE(c) \
-  (((c) == ' ') || ((c) == '\t') || ((c) == '\r') || ((c) == '\n'))
-
-PRInt32
-nsPersistentProperties::SkipWhiteSpace(PRInt32 c)
-{
-  while (IS_WHITE_SPACE(c)) {
-    c = Read();
-  }
-
-  return c;
-}
-
-PRInt32
-nsPersistentProperties::SkipLine(PRInt32 c)
-{
-  while ((c >= 0) && (c != '\r') && (c != '\n')) {
-    c = Read();
-  }
-  if (c == '\r') {
-    c = Read();
-  }
-  if (c == '\n') {
-    c = Read();
-  }
-
-  return c;
 }
 
 ////////////////////////////////////////////////////////////////////////////////
 // XXX Some day we'll unify the nsIPersistentProperties interface with
 // nsIProperties, but until now...
@@ -448,11 +678,17 @@ nsPersistentProperties::Undefine(const c
 }
 
 NS_IMETHODIMP
 nsPersistentProperties::Has(const char* prop, PRBool *result)
 {
-  return NS_ERROR_NOT_IMPLEMENTED;
+  PropertyTableEntry *entry =
+    static_cast<PropertyTableEntry*>
+               (PL_DHashTableOperate(&mTable, prop, PL_DHASH_LOOKUP));
+
+  *result = (entry && PL_DHASH_ENTRY_IS_BUSY(entry));
+
+  return NS_OK;
 }
 
 NS_IMETHODIMP
 nsPersistentProperties::GetKeys(PRUint32 *count, char ***keys)
 {
@@ -460,11 +696,10 @@ nsPersistentProperties::GetKeys(PRUint32
 }
 
 ////////////////////////////////////////////////////////////////////////////////
 // PropertyElement
 ////////////////////////////////////////////////////////////////////////////////
-
 
 NS_METHOD
 nsPropertyElement::Create(nsISupports *aOuter, REFNSIID aIID, void **aResult)
 {
   if (aOuter)
diff --git a/xpcom/ds/nsPersistentProperties.h b/xpcom/ds/nsPersistentProperties.h
--- a/xpcom/ds/nsPersistentProperties.h
+++ b/xpcom/ds/nsPersistentProperties.h
@@ -40,12 +40,13 @@
 
 #include "nsIPersistentProperties2.h"
 #include "pldhash.h"
 #include "plarena.h"
 #include "nsString.h"
+#include "nsCOMPtr.h"
 
-class nsIUnicharInputStream;
+#include "nsIUnicharInputStream.h"
 
 
 class nsPersistentProperties : public nsIPersistentProperties
 {
 public:
@@ -54,32 +55,25 @@ public:
 
   NS_DECL_ISUPPORTS
   NS_DECL_NSIPROPERTIES
   NS_DECL_NSIPERSISTENTPROPERTIES
 
-
-  // nsPersistentProperties methods:
-  PRInt32 Read();
-  PRInt32 SkipLine(PRInt32 c);
-  PRInt32 SkipWhiteSpace(PRInt32 c);
-
   static NS_METHOD
   Create(nsISupports *aOuter, REFNSIID aIID, void **aResult);
 
 private:
   ~nsPersistentProperties();
 
 protected:
-  nsIUnicharInputStream* mIn;
-  PRUint32 mBufferPos;
-  PRUint32 mBufferLength;
+  nsCOMPtr<nsIUnicharInputStream> mIn;
+
   nsIPersistentProperties* mSubclass;
   struct PLDHashTable mTable;
   PLArenaPool mArena;
 };
 
-class nsPropertyElement : public nsIPropertyElement 
+class nsPropertyElement : public nsIPropertyElement
 {
 public:
   nsPropertyElement()
   {
   }
diff --git a/xpcom/io/nsLocalFileUnix.cpp b/xpcom/io/nsLocalFileUnix.cpp
--- a/xpcom/io/nsLocalFileUnix.cpp
+++ b/xpcom/io/nsLocalFileUnix.cpp
@@ -278,16 +278,25 @@ nsLocalFile::nsLocalFileConstructor(nsIS
     return inst->QueryInterface(aIID, aInstancePtr);
 }
 
 nsresult 
 nsLocalFile::FillStatCache() {
+#ifdef HAVE_STAT64
+    if (stat64(mPath.get(), &mCachedStat) == -1) {
+        // try lstat it may be a symlink
+        if (lstat64(mPath.get(), &mCachedStat) == -1) {
+            return NSRESULT_FOR_ERRNO();
+        }
+    }
+#else
     if (stat(mPath.get(), &mCachedStat) == -1) {
         // try lstat it may be a symlink
         if (lstat(mPath.get(), &mCachedStat) == -1) {
             return NSRESULT_FOR_ERRNO();
         }
     }
+#endif
     mHaveCachedStat = PR_TRUE;
     return NS_OK;
 }
 
 NS_IMETHODIMP
@@ -1107,13 +1116,16 @@ nsLocalFile::GetFileSize(PRInt64 *aFileS
         (mCachedStat.st_fab_rfm != FAB$C_STMCR)) {
         return NS_ERROR_FAILURE;
     }
 #endif
 
-    /* XXX autoconf for and use stat64 if available */
     if (!S_ISDIR(mCachedStat.st_mode)) {
+#ifdef HAVE_STAT64
+        *aFileSize = mCachedStat.st_size;
+#else
         LL_UI2L(*aFileSize, (PRUint32)mCachedStat.st_size);
+#endif
     }
     return NS_OK;
 }
 
 NS_IMETHODIMP
@@ -1134,15 +1146,21 @@ nsLocalFile::GetFileSizeOfLink(PRInt64 *
 nsLocalFile::GetFileSizeOfLink(PRInt64 *aFileSize)
 {
     CHECK_mPath();
     NS_ENSURE_ARG(aFileSize);
 
+#ifdef HAVE_LSTAT64
+    struct stat64 sbuf;
+    if (lstat64(mPath.get(), &sbuf) == -1)
+        return NSRESULT_FOR_ERRNO();
+    *aFileSize = sbuf.st_size;
+#else
     struct stat sbuf;
     if (lstat(mPath.get(), &sbuf) == -1)
         return NSRESULT_FOR_ERRNO();
-    /* XXX autoconf for and use lstat64 if available */
     LL_UI2L(*aFileSize, (PRUint32)sbuf.st_size);
+#endif
     return NS_OK;
 }
 
 NS_IMETHODIMP
 nsLocalFile::GetDiskSpaceAvailable(PRInt64 *aDiskSpaceAvailable)
diff --git a/xpcom/io/nsLocalFileUnix.h b/xpcom/io/nsLocalFileUnix.h
--- a/xpcom/io/nsLocalFileUnix.h
+++ b/xpcom/io/nsLocalFileUnix.h
@@ -111,11 +111,15 @@ private:
 private:
     nsLocalFile(const nsLocalFile& other);
     ~nsLocalFile() {}
 
 protected:
+#ifdef HAVE_STAT64
+    struct stat64 mCachedStat;
+#else
     struct stat  mCachedStat;
+#endif
     nsCString    mPath;
     PRPackedBool mHaveCachedStat;
 
     void LocateNativeLeafName(nsACString::const_iterator &,
                               nsACString::const_iterator &);
diff --git a/xpcom/tests/unit/data/bug121341-2.properties b/xpcom/tests/unit/data/bug121341-2.properties
new file mode 100644
--- /dev/null
+++ b/xpcom/tests/unit/data/bug121341-2.properties
@@ -0,0 +1,9 @@
+# this file contains invalid UTF-8 sequence
+# no property should be loaded
+
+1 = test
+
+# property with invalid UTF-8 sequence (0xa0)
+2 = ab
+
+3 = test2
diff --git a/xpcom/tests/unit/data/bug121341.properties b/xpcom/tests/unit/data/bug121341.properties
new file mode 100644
--- /dev/null
+++ b/xpcom/tests/unit/data/bug121341.properties
@@ -0,0 +1,68 @@
+# simple check
+1=abc
+# test whitespace trimming in key and value
+  2	=   xy	
+# test parsing of escaped values
+3 = \u1234\t\r\n\uAB\
+\u1\n
+# test multiline properties
+4 = this is \
+multiline property
+5 = this is \
+	   another multiline property
+# property with DOS EOL
+6 = test\u0036
+# test multiline property with with DOS EOL
+7 = yet another multi\
+    line propery
+# trimming should not trim escaped whitespaces
+8 =	\ttest5\u0020	
+# another variant of #8
+9 =     \ test6\t	    
+# test UTF-8 encoded property/value
+10ab = cd
+# next property should test unicode escaping at the boundary of parsing buffer
+# buffer size is expected to be 4096 so add comments to get to this offset
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+################################################################################
+###############################################################################
+11 = \uABCD
diff --git a/xpcom/tests/unit/test_bug121341.js b/xpcom/tests/unit/test_bug121341.js
new file mode 100644
--- /dev/null
+++ b/xpcom/tests/unit/test_bug121341.js
@@ -0,0 +1,62 @@
+function run_test() {
+  var ios = Components.classes["@mozilla.org/network/io-service;1"].
+            getService(Components.interfaces.nsIIOService);
+                      
+  var dataFile = do_get_file("xpcom/tests/unit/data/bug121341.properties");
+
+  var channel = ios.newChannelFromURI(ios.newFileURI(dataFile, null, null));
+  var inp = channel.open();
+
+  var properties = Components.classes["@mozilla.org/persistent-properties;1"].
+                   createInstance(Components.interfaces.nsIPersistentProperties);
+  properties.load(inp);
+
+  var value;
+
+  value = properties.getStringProperty("1");
+  do_check_eq(value, "abc");
+
+  value = properties.getStringProperty("2");
+  do_check_eq(value, "xy");
+
+  value = properties.getStringProperty("3");
+  do_check_eq(value, "\u1234\t\r\n\u00AB\u0001\n");
+
+  value = properties.getStringProperty("4");
+  do_check_eq(value, "this is multiline property");
+
+  value = properties.getStringProperty("5");
+  do_check_eq(value, "this is another multiline property");
+
+  value = properties.getStringProperty("6");
+  do_check_eq(value, "test\u0036");
+
+  value = properties.getStringProperty("7");
+  do_check_eq(value, "yet another multiline propery");
+
+  value = properties.getStringProperty("8");
+  do_check_eq(value, "\ttest5\u0020");
+
+  value = properties.getStringProperty("9");
+  do_check_eq(value, " test6\t");
+
+  value = properties.getStringProperty("10a\u1234b");
+  do_check_eq(value, "c\uCDEFd");
+
+  value = properties.getStringProperty("11");
+  do_check_eq(value, "\uABCD");
+
+  dataFile = do_get_file("xpcom/tests/unit/data/bug121341-2.properties");
+
+  channel = ios.newChannelFromURI(ios.newFileURI(dataFile, null, null));
+  inp = channel.open();
+
+  var properties2 = Components.classes["@mozilla.org/persistent-properties;1"].
+                    createInstance(Components.interfaces.nsIPersistentProperties);
+  try {
+    properties2.load(inp);
+    do_throw("load() didn't fail");
+  }
+  catch (e) {
+  }
+}
diff --git a/xpcom/threads/nsTimerImpl.cpp b/xpcom/threads/nsTimerImpl.cpp
--- a/xpcom/threads/nsTimerImpl.cpp
+++ b/xpcom/threads/nsTimerImpl.cpp
@@ -453,11 +453,13 @@ void nsTimerImpl::Fire()
            ("[this=%p] Took %dms to fire timer callback\n",
             this, PR_IntervalToMilliseconds(PR_IntervalNow() - now)));
   }
 #endif
 
-  if (mType == TYPE_REPEATING_SLACK) {
+  // Reschedule REPEATING_SLACK timers, but make sure that we aren't armed
+  // already (which can happen if the callback reinitialized the timer).
+  if (mType == TYPE_REPEATING_SLACK && !mArmed) {
     SetDelayInternal(mDelay); // force mTimeout to be recomputed.
     if (gThread)
       gThread->AddTimer(this);
   }
 }
diff --git a/xulrunner/installer/Makefile.in b/xulrunner/installer/Makefile.in
--- a/xulrunner/installer/Makefile.in
+++ b/xulrunner/installer/Makefile.in
@@ -128,16 +128,28 @@ install:: $(pkg_config_files)
 	@echo pkg_config_file: $(pkg_config_files)
 	$(SYSINSTALL) $(IFLAGS1) $^ $(DESTDIR)$(libdir)/pkgconfig
 
 GARBAGE += $(MOZILLA_VERSION).system.conf $(pkg_config_files)
 
+GARBAGE += debian/changelog
 
 DEBDESTDIR=debian/$(MOZ_BUILD_APP)
 
+GRE_MILESTONE = $(shell $(PYTHON) $(topsrcdir)/config/printconfigsetting.py $(LIBXUL_DIST)/bin/platform.ini Build Milestone)
+GRE_BUILDID = $(shell $(PYTHON) $(topsrcdir)/config/printconfigsetting.py $(LIBXUL_DIST)/bin/platform.ini Build BuildID)
+MOZ_DEB_TIMESTAMP = "$(shell date  +"%a, %d  %b %Y %T %z" )"
+
+DEFINES += -DGRE_MILESTONE=$(GRE_MILESTONE) -DGRE_BUILDID=$(GRE_BUILDID) -DMOZ_DEB_TIMESTAMP=$(MOZ_DEB_TIMESTAMP)
+
 
 ifeq ($(OS_TARGET),Linux)
-deb: 
+debian/changelog: $(srcdir)/debian/changelog.in 
+	mkdir -p debian
+	$(PYTHON) $(topsrcdir)/config/Preprocessor.py \
+        $(AUTOMATION_PPARGS) $(DEFINES) $(ACDEFINES) $^ > $@
+
+deb: debian/changelog
 	$(NSINSTALL)  $(topsrcdir)/$(MOZ_BUILD_APP)/installer/debian .
 	rm -rf $(DEBDESTDIR)/usr/local/*
 	$(NSINSTALL) -D $(DEBDESTDIR)/usr/local
 	cd $(DEBDESTDIR)/usr/local; cat ../../../../$(DEPTH)/dist/$(PKG_BASENAME)$(PKG_SUFFIX) | $(UNMAKE_PACKAGE)
 	$(NSINSTALL) -D $(DEBDESTDIR)/usr/share/dbus-1/services/
diff --git a/xulrunner/installer/debian/changelog.in b/xulrunner/installer/debian/changelog.in
--- a/xulrunner/installer/debian/changelog.in
+++ b/xulrunner/installer/debian/changelog.in
@@ -1,5 +1,6 @@ xulrunner (@MOZ_APP_VERSION@)  unstable;
-xulrunner (@MOZ_APP_VERSION@)  unstable; urgency=low
+#filter substitution
+xulrunner (@GRE_MILESTONE@-@GRE_BUILDID@)  unstable; urgency=low
 
   * Mozilla Nightly (Closes: #nnnn)  <nnnn is the bug number of your ITP>
 
  -- Mozilla xulrunner  <blassey@mozilla.com>  @MOZ_DEB_TIMESTAMP@
