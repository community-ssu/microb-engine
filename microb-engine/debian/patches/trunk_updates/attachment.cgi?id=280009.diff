#Bug 381074  Hang with display: table-caption, large padding and left float inside it 
Index: nsUnitConversion.h
===================================================================
RCS file: /cvsroot/mozilla/xpcom/ds/nsUnitConversion.h,v
retrieving revision 3.16
diff -p -u -8 -r3.16 nsUnitConversion.h
--- mozilla/xpcom/ds/nsUnitConversion.h	2 Jul 2007 05:22:51 -0000	3.16
+++ mozilla/xpcom/ds/nsUnitConversion.h	7 Sep 2007 02:03:55 -0000
@@ -83,19 +83,37 @@ inline PRInt32 NSToIntRound(float aValue
   return NS_lroundf(aValue);
 }
 
 /* 
  * App Unit/Pixel conversions
  */
 inline nscoord NSFloatPixelsToAppUnits(float aPixels, PRInt32 aAppUnitsPerPixel)
 {
-  nscoord r = NSToCoordRound(aPixels * aAppUnitsPerPixel);
-  VERIFY_COORD(r);
-  return r;
+  float product = aPixels * aAppUnitsPerPixel;
+  nscoord result;
+
+#ifdef NS_COORD_IS_FLOAT
+  // No need to bounds-check if converting float to float
+  result = NSToCoordRound(product);
+#else
+  // Bounds-check before converting out of float, to avoid overflow
+  if (product >= nscoord_MAX) {
+    NS_WARNING("Overflowed nscoord_MAX in conversion to nscoord");
+    result = nscoord_MAX;
+  } else if (product <= nscoord_MIN) {
+    NS_WARNING("Overflowed nscoord_MIN in conversion to nscoord");
+    result = nscoord_MIN;
+  } else {
+    result = NSToCoordRound(product);
+  }
+#endif
+
+  VERIFY_COORD(result);
+  return result;
 }
 
 inline nscoord NSIntPixelsToAppUnits(PRInt32 aPixels, PRInt32 aAppUnitsPerPixel)
 {
   // The cast to nscoord makes sure we don't overflow if we ever change
   // nscoord to float
   nscoord r = aPixels * (nscoord)aAppUnitsPerPixel;
   VERIFY_COORD(r);
