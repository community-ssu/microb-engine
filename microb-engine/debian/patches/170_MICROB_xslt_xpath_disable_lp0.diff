# Patches for microb-engine
# Oleg Romashin <ext-oleg.2.romashin@nokia.com>
# DP: Building mozilla without XSLT/XPATH support

Index: configure.in
===================================================================
--- configure.in.orig
+++ configure.in
@@ -4068,16 +4068,18 @@
 MOZ_JAVAXPCOM=
 MOZ_JSDEBUGGER=1
 MOZ_JSLOADER=1
 MOZ_LDAP_XPCOM=
 MOZ_LIBART_CFLAGS=
 MOZ_LIBART_LIBS=
 MOZ_MAIL_NEWS=
 MOZ_MATHML=1
+MOZ_XSLT=1
+MOZ_XPATH=1
 MOZ_MOCHITEST=1
 MOZ_MORK=1
 MOZ_MORKREADER=
 MOZ_AUTH_EXTENSION=1
 MOZ_NO_ACTIVEX_SUPPORT=1
 MOZ_NO_INSPECTOR_APIS=
 MOZ_NO_XPCOM_OBSOLETE=
 MOZ_NO_FAST_LOAD=
@@ -7203,16 +7205,42 @@
    fi
 fi
 
 AC_SUBST(MOZ_TREE_CAIRO)
 AC_SUBST(MOZ_CAIRO_CFLAGS)
 AC_SUBST(MOZ_CAIRO_LIBS)
 
 dnl ========================================================
+dnl disable xpath services
+dnl ========================================================
+MOZ_ARG_DISABLE_BOOL(xpath,
+[  --disable-xpath           Disable XPATH],
+    MOZ_XPATH= )
+if test "$MOZ_XPATH"; then
+  AC_DEFINE(MOZ_XPATH)
+fi
+
+AC_SUBST(MOZ_XPATH)
+
+dnl ========================================================
+dnl disable xslt services
+dnl ========================================================
+MOZ_ARG_DISABLE_BOOL(xslt,
+[  --disable-xslt           Disable XSLT],
+    MOZ_XSLT= )
+if test "$MOZ_XSLT"; then
+if test "$MOZ_XPATH"; then
+  AC_DEFINE(MOZ_XSLT)
+fi
+fi
+
+AC_SUBST(MOZ_XSLT)
+
+dnl ========================================================
 dnl disable xul
 dnl ========================================================
 MOZ_ARG_DISABLE_BOOL(xul,
 [  --disable-xul           Disable XUL],
     MOZ_XUL= )
 if test "$MOZ_XUL"; then
   AC_DEFINE(MOZ_XUL)
 else
Index: config/autoconf.mk.in
===================================================================
--- config/autoconf.mk.in.orig
+++ config/autoconf.mk.in
@@ -188,16 +188,18 @@
 ENABLE_STRIP	= @ENABLE_STRIP@
 
 ClientWallet=1
 CookieManagement=1
 SingleSignon=1
 
 MOZ_OJI		= @MOZ_OJI@
 MOZ_PLUGINS	= @MOZ_PLUGINS@
+MOZ_XSLT        = @MOZ_XSLT@
+MOZ_XPATH       = @MOZ_XPATH@
 
 MOZ_POST_DSO_LIB_COMMAND = @MOZ_POST_DSO_LIB_COMMAND@
 MOZ_POST_PROGRAM_COMMAND = @MOZ_POST_PROGRAM_COMMAND@
 
 MOZ_BUILD_ROOT             = @MOZ_BUILD_ROOT@
 
 MOZ_XUL                    = @MOZ_XUL@
 MOZ_RDF                    = @MOZ_RDF@
Index: content/xslt/Makefile.in
===================================================================
--- content/xslt/Makefile.in.orig
+++ content/xslt/Makefile.in
@@ -37,15 +37,17 @@
 
 DEPTH = ../..
 topsrcdir	= @top_srcdir@
 srcdir		= @srcdir@
 VPATH		= @srcdir@
 
 include $(DEPTH)/config/autoconf.mk
 
-DIRS = public src
+DIRS = public
+
+DIRS += src
 
 ifdef ENABLE_TESTS
 DIRS += tests/buster
 endif
 
 include $(topsrcdir)/config/rules.mk
Index: content/xslt/src/Makefile.in
===================================================================
--- content/xslt/src/Makefile.in.orig
+++ content/xslt/src/Makefile.in
@@ -37,15 +37,21 @@
 
 DEPTH           = ../../..
 topsrcdir       = @top_srcdir@
 srcdir          = @srcdir@
 VPATH           = @srcdir@
 
 include $(DEPTH)/config/autoconf.mk
 
+ifdef MOZ_XSLT
 DIRS            = base xml xpath xslt 
+else
+ifdef MOZ_XPATH
+DIRS            = base xpath
+endif
+endif
 
 ifdef MOZ_XSLT_STANDALONE
 DIRS += main
 endif
 
 include $(topsrcdir)/config/rules.mk
Index: layout/build/Makefile.in
===================================================================
--- layout/build/Makefile.in.orig
+++ layout/build/Makefile.in
@@ -132,32 +132,44 @@
 	../xul/base/src/$(LIB_PREFIX)gkxulbase_s.$(LIB_SUFFIX) \
 	$(DEPTH)/content/base/src/$(LIB_PREFIX)gkconbase_s.$(LIB_SUFFIX) \
 	$(DEPTH)/content/canvas/src/$(LIB_PREFIX)gkconcvs_s.$(LIB_SUFFIX) \
 	$(DEPTH)/content/events/src/$(LIB_PREFIX)gkconevents_s.$(LIB_SUFFIX) \
 	$(DEPTH)/content/html/content/src/$(LIB_PREFIX)gkconhtmlcon_s.$(LIB_SUFFIX) \
 	$(DEPTH)/content/html/document/src/$(LIB_PREFIX)gkconhtmldoc_s.$(LIB_SUFFIX) \
 	$(DEPTH)/content/xml/content/src/$(LIB_PREFIX)gkconxmlcon_s.$(LIB_SUFFIX) \
 	$(DEPTH)/content/xml/document/src/$(LIB_PREFIX)gkconxmldoc_s.$(LIB_SUFFIX) \
-	$(DEPTH)/content/xslt/src/base/$(LIB_PREFIX)txbase_s.$(LIB_SUFFIX) \
-	$(DEPTH)/content/xslt/src/xml/$(LIB_PREFIX)txxml_s.$(LIB_SUFFIX) \
-	$(DEPTH)/content/xslt/src/xpath/$(LIB_PREFIX)txxpath_s.$(LIB_SUFFIX) \
-	$(DEPTH)/content/xslt/src/xslt/$(LIB_PREFIX)txxslt_s.$(LIB_SUFFIX) \
 	$(DEPTH)/content/xbl/src/$(LIB_PREFIX)gkconxbl_s.$(LIB_SUFFIX) \
 	$(DEPTH)/content/xul/document/src/$(LIB_PREFIX)gkconxuldoc_s.$(LIB_SUFFIX) \
 	$(DEPTH)/view/src/$(LIB_PREFIX)gkview_s.$(LIB_SUFFIX) \
 	$(DEPTH)/dom/src/base/$(LIB_PREFIX)jsdombase_s.$(LIB_SUFFIX) \
 	$(DEPTH)/dom/src/events/$(LIB_PREFIX)jsdomevents_s.$(LIB_SUFFIX) \
 	$(DEPTH)/dom/src/jsurl/$(LIB_PREFIX)jsurl_s.$(LIB_SUFFIX) \
 	$(DEPTH)/dom/src/storage/$(LIB_PREFIX)jsdomstorage_s.$(LIB_SUFFIX) \
 	$(DEPTH)/dom/src/offline/$(LIB_PREFIX)jsdomoffline_s.$(LIB_SUFFIX) \
 	$(DEPTH)/editor/libeditor/text/$(LIB_PREFIX)texteditor_s.$(LIB_SUFFIX) \
 	$(DEPTH)/editor/libeditor/base/$(LIB_PREFIX)editorbase_s.$(LIB_SUFFIX) \
 	$(NULL)
 
+ifdef MOZ_XSLT
+SHARED_LIBRARY_LIBS += \
+	$(DEPTH)/content/xslt/src/base/$(LIB_PREFIX)txbase_s.$(LIB_SUFFIX) \
+	$(DEPTH)/content/xslt/src/xml/$(LIB_PREFIX)txxml_s.$(LIB_SUFFIX) \
+	$(DEPTH)/content/xslt/src/xpath/$(LIB_PREFIX)txxpath_s.$(LIB_SUFFIX) \
+	$(DEPTH)/content/xslt/src/xslt/$(LIB_PREFIX)txxslt_s.$(LIB_SUFFIX) \
+	$(NULL)
+else
+ifdef MOZ_XPATH
+SHARED_LIBRARY_LIBS += \
+	$(DEPTH)/content/xslt/src/base/$(LIB_PREFIX)txbase_s.$(LIB_SUFFIX) \
+	$(DEPTH)/content/xslt/src/xpath/$(LIB_PREFIX)txxpath_s.$(LIB_SUFFIX) \
+	$(NULL)
+endif
+endif
+
 ifdef NS_PRINTING
 SHARED_LIBRARY_LIBS += \
 		../printing/$(LIB_PREFIX)gkprinting_s.$(LIB_SUFFIX) \
 		$(NULL)
 endif
 
 ifdef MOZ_XUL
 SHARED_LIBRARY_LIBS += \
@@ -261,20 +273,16 @@
 		   -I$(srcdir)/../style \
 		   -I$(srcdir)/../xul/content/src \
 		   -I$(srcdir)/../xul/base/src \
 		   -I$(srcdir)/../inspector/src \
 		   -I$(topsrcdir)/content/base/src \
 		   -I$(topsrcdir)/content/html/content/src \
 		   -I$(topsrcdir)/content/html/document/src \
 		   -I$(topsrcdir)/content/html/style/src \
-		   -I$(topsrcdir)/content/xslt/src/base \
-		   -I$(topsrcdir)/content/xslt/src/xml \
-		   -I$(topsrcdir)/content/xslt/src/xpath \
-		   -I$(topsrcdir)/content/xslt/src/xslt \
 		   -I$(topsrcdir)/content/xul/content/src \
 		   -I$(topsrcdir)/content/xul/document/src \
 		   -I$(topsrcdir)/content/xul/templates/src \
 		   -I$(topsrcdir)/content/events/src \
 		   -I$(topsrcdir)/content/xbl/src \
 		   -I$(topsrcdir)/view/src \
 		   -I$(topsrcdir)/dom/src/base \
 		   -I$(topsrcdir)/dom/src/jsurl \
@@ -283,16 +291,30 @@
 		   -I. \
 		   -I$(topsrcdir)/editor/libeditor/base \
 		   -I$(topsrcdir)/editor/libeditor/text \
 		   -I$(topsrcdir)/editor/libeditor/html \
 		   -I$(topsrcdir)/editor/txtsvc/src \
 		   -I$(topsrcdir)/editor/composer/src \
 		   $(NULL)
 
+ifdef MOZ_XSLT
+LOCAL_INCLUDES	+= -I$(topsrcdir)/content/xslt/src/base \
+ 		   -I$(topsrcdir)/content/xslt/src/xml \
+ 		   -I$(topsrcdir)/content/xslt/src/xpath \
+ 		   -I$(topsrcdir)/content/xslt/src/xslt \
+$(NULL)
+else
+ifdef MOZ_XPATH
+LOCAL_INCLUDES	+= -I$(topsrcdir)/content/xslt/src/base \
+ 		   -I$(topsrcdir)/content/xslt/src/xpath \
+ 		   $(NULL)
+endif
+endif
+
 ifdef MOZ_MATHML
 LOCAL_INCLUDES	+= -I$(srcdir)/../mathml/content/src
 endif
 
 ifdef MOZ_SVG
 LOCAL_INCLUDES	+= -I$(topsrcdir)/content/svg/content/src
 endif
 
Index: layout/build/nsLayoutModule.cpp
===================================================================
--- layout/build/nsLayoutModule.cpp.orig
+++ layout/build/nsLayoutModule.cpp
@@ -99,25 +99,29 @@
 #include "nsIFrameTraversal.h"
 #ifndef MOZ_CAIRO_GFX
 #include "nsISelectionImageService.h"
 #endif
 #include "nsLayoutCID.h"
 #include "nsILanguageAtomService.h"
 #include "nsStyleSheetService.h"
 
+#ifdef MOZ_XSLT
 // Transformiix stuff
-#include "nsXPathEvaluator.h"
 #include "txMozillaXSLTProcessor.h"
 #include "txNodeSetAdaptor.h"
-#include "nsXPath1Scheme.h"
+#endif
 
+#ifdef MOZ_XPATH
+#include "nsXPath1Scheme.h"
+#include "nsXPathEvaluator.h"
 #include "nsDOMParser.h"
 #include "nsDOMSerializer.h"
 #include "nsXMLHttpRequest.h"
+#endif
 
 // view stuff
 #include "nsViewsCID.h"
 #include "nsViewManager.h"
 #include "nsContentCreatorFunctions.h"
 
 // DOM includes
 #include "nsDOMException.h"
@@ -259,34 +263,41 @@
 PR_STATIC_CALLBACK(nsresult) Initialize(nsIModule* aSelf);
 static void Shutdown();
 
 #ifdef MOZ_XTF
 #include "nsIXTFService.h"
 #include "nsIXMLContentBuilder.h"
 #endif
 
+#ifdef MOZ_XSLT
 // Transformiix
-/* {0C351177-0159-4500-86B0-A219DFDE4258} */
-#define TRANSFORMIIX_XPATH1_SCHEME_CID \
-{ 0xc351177, 0x159, 0x4500, { 0x86, 0xb0, 0xa2, 0x19, 0xdf, 0xde, 0x42, 0x58 } }
-
 /* 5d5d92cd-6bf8-11d9-bf4a-000a95dc234c */
 #define TRANSFORMIIX_NODESET_CID \
 { 0x5d5d92cd, 0x6bf8, 0x11d9, { 0xbf, 0x4a, 0x0, 0x0a, 0x95, 0xdc, 0x23, 0x4c } }
 
 #define TRANSFORMIIX_NODESET_CONTRACTID \
 "@mozilla.org/transformiix-nodeset;1"
 
+#endif
+
+#ifdef MOZ_XPATH
+/* {0C351177-0159-4500-86B0-A219DFDE4258} */
+#define TRANSFORMIIX_XPATH1_SCHEME_CID \
+{ 0xc351177, 0x159, 0x4500, { 0x86, 0xb0, 0xa2, 0x19, 0xdf, 0xde, 0x42, 0x58 } }
+
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsXPath1SchemeProcessor)
+NS_GENERIC_AGGREGATED_CONSTRUCTOR_INIT(nsXPathEvaluator, Init)
+#endif
 
+#ifdef MOZ_XSLT
 // Factory Constructor
 NS_GENERIC_FACTORY_CONSTRUCTOR(txMozillaXSLTProcessor)
-NS_GENERIC_AGGREGATED_CONSTRUCTOR_INIT(nsXPathEvaluator, Init)
 NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(txNodeSetAdaptor, Init)
+#endif /* MOZ_XSLT */
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsDOMSerializer)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsXMLHttpRequest)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsDOMParser)
 
 //-----------------------------------------------------------------------------
 
 // Per bug 209804, it is necessary to observe the "xpcom-shutdown" event and
 // perform shutdown of the layout modules at that time instead of waiting for
@@ -1290,37 +1301,40 @@
     nsnull,
     CreatePluginDocument },
 
   { "Style sheet service",
     NS_STYLESHEETSERVICE_CID,
     NS_STYLESHEETSERVICE_CONTRACTID,
     nsStyleSheetServiceConstructor },
 
-  // transformiix
-
-  { "XSLTProcessor",
-    TRANSFORMIIX_XSLT_PROCESSOR_CID,
-    TRANSFORMIIX_XSLT_PROCESSOR_CONTRACTID,
-    txMozillaXSLTProcessorConstructor },
-
+#ifdef MOZ_XPATH
   { "XPathEvaluator",
     TRANSFORMIIX_XPATH_EVALUATOR_CID,
     NS_XPATH_EVALUATOR_CONTRACTID,
     nsXPathEvaluatorConstructor },
 
   { "XPath1 XPointer Scheme Processor",
     TRANSFORMIIX_XPATH1_SCHEME_CID,
     NS_XPOINTER_SCHEME_PROCESSOR_BASE "xpath1",
     nsXPath1SchemeProcessorConstructor },
+#endif
+
+#ifdef MOZ_XSLT
+  // transformiix
+  { "XSLTProcessor",
+    TRANSFORMIIX_XSLT_PROCESSOR_CID,
+    TRANSFORMIIX_XSLT_PROCESSOR_CONTRACTID,
+    txMozillaXSLTProcessorConstructor },
 
   { "Transformiix NodeSet",
     TRANSFORMIIX_NODESET_CID,
     TRANSFORMIIX_NODESET_CONTRACTID,
     txNodeSetAdaptorConstructor },
+#endif /* MOZ_XSLT */
 
   { "XML Serializer",
     NS_XMLSERIALIZER_CID,
     NS_XMLSERIALIZER_CONTRACTID,
     nsDOMSerializerConstructor },
 
   { "XMLHttpRequest",
     NS_XMLHTTPREQUEST_CID,
Index: layout/build/nsLayoutStatics.cpp
===================================================================
--- layout/build/nsLayoutStatics.cpp.orig
+++ layout/build/nsLayoutStatics.cpp
@@ -70,17 +70,19 @@
 #include "nsRepeatService.h"
 #include "nsSpaceManager.h"
 #include "nsSprocketLayout.h"
 #include "nsStackLayout.h"
 #include "nsStyleSet.h"
 #include "nsTextControlFrame.h"
 #include "nsTextTransformer.h"
 #include "nsXBLWindowKeyHandler.h"
+#ifdef MOZ_XSLT
 #include "txMozillaXSLTProcessor.h"
+#endif
 #include "nsDOMStorage.h"
 #include "nsCellMap.h"
 #include "nsTextFrameTextRunCache.h"
 #include "nsCCUncollectableMarker.h"
 
 #ifdef MOZ_XUL
 #include "nsXULContentUtils.h"
 #include "nsXULElement.h"
@@ -200,21 +202,23 @@
 #endif
   rv = nsTextTransformer::Initialize();
   if (NS_FAILED(rv)) {
     NS_ERROR("Could not initialize nsTextTransformer");
     return rv;
   }
   nsDOMAttribute::Initialize();
 
+#ifdef MOZ_XSLT
   rv = txMozillaXSLTProcessor::Init();
   if (NS_FAILED(rv)) {
     NS_ERROR("Could not initialize txMozillaXSLTProcessor");
     return rv;
   }
+#endif
 
   rv = nsDOMStorageManager::Initialize();
   if (NS_FAILED(rv)) {
     NS_ERROR("Could not initialize nsDOMStorageManager");
     return rv;
   }
 
   rv = nsCCUncollectableMarker::Init();
@@ -225,17 +229,19 @@
 
   return NS_OK;
 }
 
 void
 nsLayoutStatics::Shutdown()
 {
   nsDOMStorageManager::Shutdown();
+#ifdef MOZ_XSLT
   txMozillaXSLTProcessor::Shutdown();
+#endif
   nsDOMAttribute::Shutdown();
   nsDOMEventRTTearoff::Shutdown();
   nsEventListenerManager::Shutdown();
   nsContentList::Shutdown();
   nsComputedDOMStyle::Shutdown();
   CSSLoaderImpl::Shutdown();
   nsTextFrameTextRunCache::Shutdown();
   nsCSSRendering::Shutdown();
