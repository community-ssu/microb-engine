# Building of jemalloc with old gcc 3.4.4 and -O2 is broken
# Added support for old codesourcery toolchain and used in jemalloc makefile
# bug 463925
Index: mozilla/config/autoconf.mk.in
===================================================================
--- mozilla.orig/config/autoconf.mk.in
+++ mozilla/config/autoconf.mk.in
@@ -559,16 +559,18 @@ MOZ_DEMANGLE_SYMBOLS = @MOZ_DEMANGLE_SYM
 CM_BLDTYPE=dbg
 AWT_11=1
 MOZ_BITS=32
 OS_TARGET=@OS_TARGET@
 OS_ARCH=@OS_ARCH@
 OS_RELEASE=@OS_RELEASE@
 OS_TEST=@OS_TEST@
 
+OLD_CODESOURCERY=@OLD_CODESOURCERY@
+
 # For Solaris build
 SOLARIS_SUNPRO_CC = @SOLARIS_SUNPRO_CC@
 SOLARIS_SUNPRO_CXX = @SOLARIS_SUNPRO_CXX@
 
 # For AIX build
 AIX_OBJMODEL = @AIX_OBJMODEL@
 
 # For OS/2 build
Index: mozilla/configure.in
===================================================================
--- mozilla.orig/configure.in
+++ mozilla/configure.in
@@ -2001,16 +2001,26 @@ case "$target" in
         MOZ_OPTIMIZE_FLAGS="-O2"
         MOZ_DEBUG_FLAGS="-g -fno-inline"
     elif test "$GNU_CC" || test "$GNU_CXX"; then
         GCC_VERSION=`$CC -v 2>&1 | awk '/^gcc version/ { print $3 }'`
         case $GCC_VERSION in
         4.1.*|4.2.*)
             # -Os is broken on gcc 4.1.x and 4.2.x, we need to tweak it to get good results.
             MOZ_OPTIMIZE_SIZE_TWEAK="-finline-limit=50"
+        ;;
+        3.4.4*)
+            dnl ========================================================
+            dnl = Maemo 2008 toolchain support
+            dnl ========================================================
+            if test `echo "$CXX_VERSION" | grep -c 2005q3-2` -ne 0; then
+                OLD_CODESOURCERY=1
+                AC_DEFINE(OLD_CODESOURCERY)
+                AC_SUBST(OLD_CODESOURCERY)
+            fi
         esac
         MOZ_OPTIMIZE_FLAGS="-Os -freorder-blocks -fno-reorder-functions $MOZ_OPTIMIZE_SIZE_TWEAK"
         MOZ_DEBUG_FLAGS="-g -fno-inline"  # most people on linux use gcc/gdb,
                                           # and that combo is not yet good at
                                           # debugging inlined functions (even
                                           # when using DWARF2 as the debugging
                                           # format)
     fi
Index: mozilla/memory/jemalloc/Makefile.in
===================================================================
--- mozilla.orig/memory/jemalloc/Makefile.in
+++ mozilla/memory/jemalloc/Makefile.in
@@ -93,16 +93,20 @@ $(MOZ_CRT_DLL): \
 # never updated the sample.def files; could probably fix if someone
 # were ever bored enough. :-)
 	rm -f $(addsuffix .lib, $(addprefix $(CRT_OBJ_DIR)/build/intel/, $(MOZ_CRT_STATIC_LIBS)))
 	rm -f $(addsuffix .pdb, $(addprefix $(CRT_OBJ_DIR)/build/intel/, $(MOZ_CRT_STATIC_LIBS)))
 
 else # Not Windows
 
 MODULE_OPTIMIZE_FLAGS = -O2
+ifdef OLD_CODESOURCERY
+MODULE_OPTIMIZE_FLAGS = -Os
+MOZ_OPTIMIZE_FLAGS += -Os
+endif
 ifeq ($(OS_ARCH),SunOS)
 ifndef GNU_CC
 MODULE_OPTIMIZE_FLAGS = -xO5
 endif
 endif
 
 LIBRARY_NAME	= jemalloc
 
