## Patches for microb-engine
## Oleg Romashin <oleg.romashin@nokia.com>
##
## DP: Building mozilla without XSLT/XPATH support
# After discussing with Benjamin about this, he sad it is very bad Idea, and he don't
# want to make available Gecko building without xslt

Index: mozilla/configure.in
===================================================================
--- mozilla.orig/configure.in
+++ mozilla/configure.in
@@ -4323,16 +4323,18 @@
 MOZ_IMG_ENCODERS_DEFAULT="png jpeg"
 MOZ_IPCD=
 MOZ_JAVAXPCOM=
 MOZ_JSDEBUGGER=1
 MOZ_JSLOADER=1
 MOZ_LIBART_CFLAGS=
 MOZ_LIBART_LIBS=
 MOZ_MATHML=1
+MOZ_XSLT=1
+MOZ_XPATH=1
 MOZ_MOCHITEST=1
 MOZ_MORK=1
 MOZ_MORKREADER=
 MOZ_AUTH_EXTENSION=1
 MOZ_NO_ACTIVEX_SUPPORT=1
 MOZ_NO_INSPECTOR_APIS=
 MOZ_NO_XPCOM_OBSOLETE=
 MOZ_NO_FAST_LOAD=
@@ -7526,16 +7528,42 @@
     PKG_CHECK_MODULES(LCMS, lcms >= $LCMS_VERSION)
 fi
 
 AC_SUBST(MOZ_NATIVE_LCMS)
 AC_SUBST(LCMS_CFLAGS)
 AC_SUBST(LCMS_LIBS)
 
 dnl ========================================================
+dnl disable xpath services
+dnl ========================================================
+MOZ_ARG_DISABLE_BOOL(xpath,
+[  --disable-xpath           Disable XPATH],
+    MOZ_XPATH= )
+if test "$MOZ_XPATH"; then
+  AC_DEFINE(MOZ_XPATH)
+fi
+
+AC_SUBST(MOZ_XPATH)
+
+dnl ========================================================
+dnl disable xslt services
+dnl ========================================================
+MOZ_ARG_DISABLE_BOOL(xslt,
+[  --disable-xslt           Disable XSLT],
+    MOZ_XSLT= )
+if test "$MOZ_XSLT"; then
+if test "$MOZ_XPATH"; then
+  AC_DEFINE(MOZ_XSLT)
+fi
+fi
+
+AC_SUBST(MOZ_XSLT)
+
+dnl ========================================================
 dnl disable xul
 dnl ========================================================
 MOZ_ARG_DISABLE_BOOL(xul,
 [  --disable-xul           Disable XUL],
     MOZ_XUL=,
     MOZ_XUL=1 )
 if test "$MOZ_XUL"; then
   AC_DEFINE(MOZ_XUL)
Index: mozilla/config/autoconf.mk.in
===================================================================
--- mozilla.orig/config/autoconf.mk.in
+++ mozilla/config/autoconf.mk.in
@@ -196,16 +196,18 @@
 PKG_SKIP_STRIP	= @PKG_SKIP_STRIP@
 
 ClientWallet=1
 CookieManagement=1
 SingleSignon=1
 
 MOZ_OJI		= @MOZ_OJI@
 MOZ_PLUGINS	= @MOZ_PLUGINS@
+MOZ_XSLT        = @MOZ_XSLT@
+MOZ_XPATH       = @MOZ_XPATH@
 
 MOZ_POST_DSO_LIB_COMMAND = @MOZ_POST_DSO_LIB_COMMAND@
 MOZ_POST_PROGRAM_COMMAND = @MOZ_POST_PROGRAM_COMMAND@
 
 MOZ_BUILD_ROOT             = @MOZ_BUILD_ROOT@
 
 MOZ_XUL                    = @MOZ_XUL@
 MOZ_RDF                    = @MOZ_RDF@
Index: mozilla/content/xslt/src/Makefile.in
===================================================================
--- mozilla.orig/content/xslt/src/Makefile.in
+++ mozilla/content/xslt/src/Makefile.in
@@ -37,15 +37,21 @@
 
 DEPTH           = ../../..
 topsrcdir       = @top_srcdir@
 srcdir          = @srcdir@
 VPATH           = @srcdir@
 
 include $(DEPTH)/config/autoconf.mk
 
+ifdef MOZ_XSLT
 DIRS            = base xml xpath xslt 
+else
+ifdef MOZ_XPATH
+DIRS            = base xpath
+endif
+endif
 
 ifdef MOZ_XSLT_STANDALONE
 DIRS += main
 endif
 
 include $(topsrcdir)/config/rules.mk
Index: mozilla/layout/build/Makefile.in
===================================================================
--- mozilla.orig/layout/build/Makefile.in
+++ mozilla/layout/build/Makefile.in
@@ -120,35 +120,46 @@
 	../xul/base/src/$(LIB_PREFIX)gkxulbase_s.$(LIB_SUFFIX) \
 	$(DEPTH)/content/base/src/$(LIB_PREFIX)gkconbase_s.$(LIB_SUFFIX) \
 	$(DEPTH)/content/canvas/src/$(LIB_PREFIX)gkconcvs_s.$(LIB_SUFFIX) \
 	$(DEPTH)/content/events/src/$(LIB_PREFIX)gkconevents_s.$(LIB_SUFFIX) \
 	$(DEPTH)/content/html/content/src/$(LIB_PREFIX)gkconhtmlcon_s.$(LIB_SUFFIX) \
 	$(DEPTH)/content/html/document/src/$(LIB_PREFIX)gkconhtmldoc_s.$(LIB_SUFFIX) \
 	$(DEPTH)/content/xml/content/src/$(LIB_PREFIX)gkconxmlcon_s.$(LIB_SUFFIX) \
 	$(DEPTH)/content/xml/document/src/$(LIB_PREFIX)gkconxmldoc_s.$(LIB_SUFFIX) \
-	$(DEPTH)/content/xslt/src/base/$(LIB_PREFIX)txbase_s.$(LIB_SUFFIX) \
-	$(DEPTH)/content/xslt/src/xml/$(LIB_PREFIX)txxml_s.$(LIB_SUFFIX) \
-	$(DEPTH)/content/xslt/src/xpath/$(LIB_PREFIX)txxpath_s.$(LIB_SUFFIX) \
-	$(DEPTH)/content/xslt/src/xslt/$(LIB_PREFIX)txxslt_s.$(LIB_SUFFIX) \
 	$(DEPTH)/content/xbl/src/$(LIB_PREFIX)gkconxbl_s.$(LIB_SUFFIX) \
 	$(DEPTH)/content/xul/document/src/$(LIB_PREFIX)gkconxuldoc_s.$(LIB_SUFFIX) \
 	$(DEPTH)/view/src/$(LIB_PREFIX)gkview_s.$(LIB_SUFFIX) \
 	$(DEPTH)/dom/src/base/$(LIB_PREFIX)jsdombase_s.$(LIB_SUFFIX) \
 	$(DEPTH)/dom/src/events/$(LIB_PREFIX)jsdomevents_s.$(LIB_SUFFIX) \
 	$(DEPTH)/dom/src/json/$(LIB_PREFIX)json_s.$(LIB_SUFFIX) \
 	$(DEPTH)/dom/src/jsurl/$(LIB_PREFIX)jsurl_s.$(LIB_SUFFIX) \
 	$(DEPTH)/dom/src/storage/$(LIB_PREFIX)jsdomstorage_s.$(LIB_SUFFIX) \
 	$(DEPTH)/dom/src/offline/$(LIB_PREFIX)jsdomoffline_s.$(LIB_SUFFIX) \
  	$(DEPTH)/dom/src/geolocation/$(LIB_PREFIX)jsdomgeolocation_s.$(LIB_SUFFIX) \
 	$(DEPTH)/dom/src/threads/$(LIB_PREFIX)domthreads_s.$(LIB_SUFFIX) \
 	$(DEPTH)/editor/libeditor/text/$(LIB_PREFIX)texteditor_s.$(LIB_SUFFIX) \
 	$(DEPTH)/editor/libeditor/base/$(LIB_PREFIX)editorbase_s.$(LIB_SUFFIX) \
 	$(NULL)
 
+ifdef MOZ_XSLT
+SHARED_LIBRARY_LIBS += \
+	$(DEPTH)/content/xslt/src/base/$(LIB_PREFIX)txbase_s.$(LIB_SUFFIX) \
+	$(DEPTH)/content/xslt/src/xml/$(LIB_PREFIX)txxml_s.$(LIB_SUFFIX) \
+	$(DEPTH)/content/xslt/src/xpath/$(LIB_PREFIX)txxpath_s.$(LIB_SUFFIX) \
+	$(DEPTH)/content/xslt/src/xslt/$(LIB_PREFIX)txxslt_s.$(LIB_SUFFIX)
+else
+ifdef MOZ_XPATH
+SHARED_LIBRARY_LIBS += \
+	$(DEPTH)/content/xslt/src/base/$(LIB_PREFIX)txbase_s.$(LIB_SUFFIX) \
+	$(DEPTH)/content/xslt/src/xpath/$(LIB_PREFIX)txxpath_s.$(LIB_SUFFIX) \
+	$(NULL)
+endif
+endif
+
 ifdef MOZ_MEDIA
 SHARED_LIBRARY_LIBS 	+= \
 	$(DEPTH)/content/media/video/src/$(LIB_PREFIX)gkconvideo_s.$(LIB_SUFFIX) \
 	$(NULL)
 endif
 
 ifdef MOZ_OGG
 SHARED_LIBRARY_LIBS 	+= \
@@ -276,20 +287,16 @@
 		   -I$(srcdir)/../tables \
 		   -I$(srcdir)/../style \
 		   -I$(srcdir)/../xul/content/src \
 		   -I$(srcdir)/../xul/base/src \
 		   -I$(topsrcdir)/content/base/src \
 		   -I$(topsrcdir)/content/html/content/src \
 		   -I$(topsrcdir)/content/html/document/src \
 		   -I$(topsrcdir)/content/html/style/src \
-		   -I$(topsrcdir)/content/xslt/src/base \
-		   -I$(topsrcdir)/content/xslt/src/xml \
-		   -I$(topsrcdir)/content/xslt/src/xpath \
-		   -I$(topsrcdir)/content/xslt/src/xslt \
 		   -I$(topsrcdir)/content/xul/content/src \
 		   -I$(topsrcdir)/content/xul/document/src \
 		   -I$(topsrcdir)/content/xul/templates/src \
 		   -I$(topsrcdir)/content/events/src \
 		   -I$(topsrcdir)/content/xbl/src \
 		   -I$(topsrcdir)/view/src \
 		   -I$(topsrcdir)/dom/src/base \
 		   -I$(topsrcdir)/dom/src/json \
@@ -301,16 +308,30 @@
 		   -I. \
 		   -I$(topsrcdir)/editor/libeditor/base \
 		   -I$(topsrcdir)/editor/libeditor/text \
 		   -I$(topsrcdir)/editor/libeditor/html \
 		   -I$(topsrcdir)/editor/txtsvc/src \
 		   -I$(topsrcdir)/editor/composer/src \
 		   $(NULL)
 
+ifdef MOZ_XSLT
+LOCAL_INCLUDES	+= -I$(topsrcdir)/content/xslt/src/base \
+ 		   -I$(topsrcdir)/content/xslt/src/xml \
+ 		   -I$(topsrcdir)/content/xslt/src/xpath \
+ 		   -I$(topsrcdir)/content/xslt/src/xslt \
+$(NULL)
+else
+ifdef MOZ_XPATH
+LOCAL_INCLUDES	+= -I$(topsrcdir)/content/xslt/src/base \
+ 		   -I$(topsrcdir)/content/xslt/src/xpath \
+ 		   $(NULL)
+endif
+endif
+
 ifdef MOZ_MATHML
 LOCAL_INCLUDES	+= -I$(srcdir)/../mathml/content/src
 endif
 
 ifdef MOZ_SVG
 LOCAL_INCLUDES	+= -I$(topsrcdir)/content/svg/content/src
 endif
 
Index: mozilla/layout/build/nsLayoutStatics.cpp
===================================================================
--- mozilla.orig/layout/build/nsLayoutStatics.cpp
+++ mozilla/layout/build/nsLayoutStatics.cpp
@@ -69,17 +69,19 @@
 #include "nsRange.h"
 #include "nsRepeatService.h"
 #include "nsSpaceManager.h"
 #include "nsSprocketLayout.h"
 #include "nsStackLayout.h"
 #include "nsStyleSet.h"
 #include "nsTextControlFrame.h"
 #include "nsXBLWindowKeyHandler.h"
+#ifdef MOZ_XSLT
 #include "txMozillaXSLTProcessor.h"
+#endif
 #include "nsDOMStorage.h"
 #include "nsCellMap.h"
 #include "nsTextFrameTextRunCache.h"
 #include "nsCCUncollectableMarker.h"
 #include "nsTextFragment.h"
 #include "nsCSSRuleProcessor.h"
 #include "nsXMLHttpRequest.h"
 #include "nsIFocusEventSuppressor.h"
@@ -212,21 +214,23 @@
   nsTextServicesDocument::RegisterAtoms();
 #endif
 
 #ifdef DEBUG
   nsFrame::DisplayReflowStartup();
 #endif
   nsDOMAttribute::Initialize();
 
+#ifdef MOZ_XSLT
   rv = txMozillaXSLTProcessor::Startup();
   if (NS_FAILED(rv)) {
     NS_ERROR("Could not initialize txMozillaXSLTProcessor");
     return rv;
   }
+#endif
 
   rv = nsDOMStorageManager::Initialize();
   if (NS_FAILED(rv)) {
     NS_ERROR("Could not initialize nsDOMStorageManager");
     return rv;
   }
 
 #ifndef DEBUG_CC
@@ -267,17 +271,19 @@
 
 void
 nsLayoutStatics::Shutdown()
 {
 #ifdef MOZ_XUL
   nsXULPopupManager::Shutdown();
 #endif
   nsDOMStorageManager::Shutdown();
+#ifdef MOZ_XSLT
   txMozillaXSLTProcessor::Shutdown();
+#endif
   nsDOMAttribute::Shutdown();
   nsDOMEventRTTearoff::Shutdown();
   nsEventListenerManager::Shutdown();
   nsContentList::Shutdown();
   nsComputedDOMStyle::Shutdown();
   CSSLoaderImpl::Shutdown();
   nsCSSRuleProcessor::FreeSystemMetrics();
   nsTextFrameTextRunCache::Shutdown();
Index: mozilla/layout/build/nsLayoutModule.cpp
===================================================================
--- mozilla.orig/layout/build/nsLayoutModule.cpp
+++ mozilla/layout/build/nsLayoutModule.cpp
@@ -96,21 +96,26 @@
 #include "nsSyncLoadService.h"
 #include "nsBox.h"
 #include "nsIFrameTraversal.h"
 #include "nsLayoutCID.h"
 #include "nsILanguageAtomService.h"
 #include "nsStyleSheetService.h"
 #include "nsXULPopupManager.h"
 
+#ifdef MOZ_XSLT
 // Transformiix stuff
-#include "nsXPathEvaluator.h"
 #include "txMozillaXSLTProcessor.h"
 #include "txNodeSetAdaptor.h"
+#endif
+
+#ifdef MOZ_XPATH
 #include "nsXPath1Scheme.h"
+#include "nsXPathEvaluator.h"
+#endif
 
 #include "nsDOMParser.h"
 #include "nsDOMSerializer.h"
 #include "nsXMLHttpRequest.h"
 
 // view stuff
 #include "nsViewsCID.h"
 #include "nsViewManager.h"
@@ -264,33 +269,39 @@
 #ifdef MOZ_XTF
 #include "nsIXTFService.h"
 #include "nsIXMLContentBuilder.h"
 #endif
 
 #include "nsGeolocation.h"
 
 // Transformiix
-/* {0C351177-0159-4500-86B0-A219DFDE4258} */
-#define TRANSFORMIIX_XPATH1_SCHEME_CID \
-{ 0xc351177, 0x159, 0x4500, { 0x86, 0xb0, 0xa2, 0x19, 0xdf, 0xde, 0x42, 0x58 } }
-
+#ifdef MOZ_XSLT
 /* 5d5d92cd-6bf8-11d9-bf4a-000a95dc234c */
 #define TRANSFORMIIX_NODESET_CID \
 { 0x5d5d92cd, 0x6bf8, 0x11d9, { 0xbf, 0x4a, 0x0, 0x0a, 0x95, 0xdc, 0x23, 0x4c } }
 
 #define TRANSFORMIIX_NODESET_CONTRACTID \
 "@mozilla.org/transformiix-nodeset;1"
+#endif
+
+#ifdef MOZ_XPATH
+/* {0C351177-0159-4500-86B0-A219DFDE4258} */
+#define TRANSFORMIIX_XPATH1_SCHEME_CID \
+{ 0xc351177, 0x159, 0x4500, { 0x86, 0xb0, 0xa2, 0x19, 0xdf, 0xde, 0x42, 0x58 } }
 
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsXPath1SchemeProcessor)
+NS_GENERIC_AGGREGATED_CONSTRUCTOR_INIT(nsXPathEvaluator, Init)
+#endif
 
+#ifdef MOZ_XSLT
 // Factory Constructor
 NS_GENERIC_FACTORY_CONSTRUCTOR(txMozillaXSLTProcessor)
-NS_GENERIC_AGGREGATED_CONSTRUCTOR_INIT(nsXPathEvaluator, Init)
 NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(txNodeSetAdaptor, Init)
+#endif /* MOZ_XSLT */
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsDOMSerializer)
 NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsXMLHttpRequest, Init)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsDOMParser)
 NS_GENERIC_FACTORY_SINGLETON_CONSTRUCTOR(nsDOMStorageManager,
                                          nsDOMStorageManager::GetInstance)
 
 //-----------------------------------------------------------------------------
 
@@ -1282,37 +1293,40 @@
     nsnull,
     CreatePluginDocument },
 
   { "Style sheet service",
     NS_STYLESHEETSERVICE_CID,
     NS_STYLESHEETSERVICE_CONTRACTID,
     nsStyleSheetServiceConstructor },
 
-  // transformiix
-
-  { "XSLTProcessor",
-    TRANSFORMIIX_XSLT_PROCESSOR_CID,
-    TRANSFORMIIX_XSLT_PROCESSOR_CONTRACTID,
-    txMozillaXSLTProcessorConstructor },
-
+#ifdef MOZ_XPATH
   { "XPathEvaluator",
     TRANSFORMIIX_XPATH_EVALUATOR_CID,
     NS_XPATH_EVALUATOR_CONTRACTID,
     nsXPathEvaluatorConstructor },
 
   { "XPath1 XPointer Scheme Processor",
     TRANSFORMIIX_XPATH1_SCHEME_CID,
     NS_XPOINTER_SCHEME_PROCESSOR_BASE "xpath1",
     nsXPath1SchemeProcessorConstructor },
+#endif
+
+#ifdef MOZ_XSLT
+  // transformiix
+  { "XSLTProcessor",
+    TRANSFORMIIX_XSLT_PROCESSOR_CID,
+    TRANSFORMIIX_XSLT_PROCESSOR_CONTRACTID,
+    txMozillaXSLTProcessorConstructor },
 
   { "Transformiix NodeSet",
     TRANSFORMIIX_NODESET_CID,
     TRANSFORMIIX_NODESET_CONTRACTID,
     txNodeSetAdaptorConstructor },
+#endif /* MOZ_XSLT */
 
   { "XML Serializer",
     NS_XMLSERIALIZER_CID,
     NS_XMLSERIALIZER_CONTRACTID,
     nsDOMSerializerConstructor },
 
   { "XMLHttpRequest",
     NS_XMLHTTPREQUEST_CID,
