--- extensions/spatialnavigation/src/nsSpatialNavigation.cpp	2008-02-22 07:58:14.000000000 -0700
+++ /home/petejc/src/microb_latest/microb-engine/scratch_build/build-tree/mozilla/extensions/spatialnavigation/src/nsSpatialNavigation.cpp	2008-03-26 11:11:50.000000000 -0600
@@ -37,6 +37,7 @@
 #include "nsSpatialNavigationPrivate.h"
 #include "nsGUIEvent.h"
 #include "nsIDOMHTMLImageElement.h"
+#include "nsIDOMNSHTMLAnchorElement.h"
 
 // #define DEBUG_romaxa 1
 
@@ -64,6 +65,10 @@
   mNavigationFramesState = PR_FALSE;
   mKeyPressedState = 0;
   mKeyWasDown = PR_FALSE;
+  mSelectPopup = PR_FALSE;
+  mSelectPopupCount = 0;
+  mSelectControlSelected = PR_FALSE;
+  mSelectNavCount = 0;
 }
 
 // #ifdef DEBUG_romaxa
@@ -87,9 +92,14 @@
   nsCOMPtr<nsIDOMHTMLAnchorElement> link(do_QueryInterface(content));
   if (link)
   {
+    nsCOMPtr<nsIDOMNSHTMLAnchorElement> nslink(do_QueryInterface(link));
+
+    nsAutoString text;
+    if (nslink) nslink->GetText(text);
+
     nsAutoString href;
     link->GetHref(href);
-    printf("<%s href=\"%s\">\n", NS_ConvertUTF16toUTF8(str).get(), NS_ConvertUTF16toUTF8(href).get());
+    printf("<%s href=\"%s\">%s</a>\n", NS_ConvertUTF16toUTF8(str).get(), NS_ConvertUTF16toUTF8(href).get(), NS_ConvertUTF16toUTF8(text).get());
   } 
     else
   {
@@ -147,45 +157,61 @@
 {
   mKeyWasDown = PR_TRUE;
   mKeyPressedCount = 0;
-  if (!mService->mEnabled)
-    return NS_OK;
 
-/*if (!mKeyPressedState) {
+  if (!mService->mEnabled) return NS_OK;
+
+/****************
+  if (!mKeyPressedState) 
+  {
     aEvent->StopPropagation();
     aEvent->PreventDefault();
-  }*/
+  }
+****************/
+
   return HandleKey(aEvent, PR_FALSE);
+
+  return NS_OK;
 }
 
 NS_IMETHODIMP
 nsSpatialNavigation::KeyPress(nsIDOMEvent* aEvent)
 {
-  if (!mService->mEnabled)
-    return NS_OK;
+  if (!mService->mEnabled) return NS_OK;
+
   mKeyPressedCount++;
+
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsSpatialNavigation::KeyUp(nsIDOMEvent* aEvent)
 {
-  if (!mService->mEnabled) {
+  if (mSelectPopupCount == 1)
+  {
+    mSelectPopupCount = 0;;
+    return NS_OK;
+  }
+
+  if (!mService->mEnabled) 
+  {
     mKeyWasDown = PR_FALSE;
     return NS_OK;
   }
 
-  if (mKeyPressedCount > 1) {
-    if (mKeyPressedState == 0) {
-      mKeyPressedState = 1;
-    }
+  if (mKeyPressedCount > 1) 
+  {
+    if (mKeyPressedState == 0) mKeyPressedState = 1;
     
     mKeyPressedCount = 0;
     mKeyWasDown = PR_FALSE;
+
     return NS_OK;
   }
+
   mKeyPressedCount = 0;
   nsresult rv = HandleKey(aEvent, PR_TRUE);
   mKeyWasDown = PR_FALSE;
+
   return rv;
 }
 
@@ -240,7 +266,7 @@
     designMode = DMode.EqualsLiteral("on");
     if (designMode) return NS_OK;
   }
-  
+
   if (targetContent->IsNodeOfType(nsINode::eHTML_FORM_CONTROL)) 
   {
       nsCOMPtr<nsIFormControl> formControl(do_QueryInterface(targetContent));
@@ -256,8 +282,65 @@
           return NS_OK;
         }
       }
-      if (formControlType == NS_FORM_SELECT && !mKeyWasDown && aReal)
-        return NS_OK;
+
+      if (formControlType == NS_FORM_SELECT)
+      {
+        PRUint32 keyCode;
+        nsCOMPtr<nsIDOMKeyEvent> keyEvent(do_QueryInterface(aEvent));
+  
+        if (!keyEvent) return NS_ERROR_FAILURE;
+
+        if (NS_FAILED(keyEvent->GetKeyCode(&keyCode)))
+          return NS_ERROR_FAILURE;
+
+        nsCOMPtr<nsIDOMHTMLSelectElement> element = do_QueryInterface(mLastContent);
+        if (element)
+        {
+          PRInt32 size  = 0;
+          PRUint32 len  = 0;
+          PRInt32 index = 0;
+
+          element->GetSize(&size);
+          element->GetLength(&len);
+          element->GetSelectedIndex(&index);
+
+          if (keyCode == nsIDOMKeyEvent::DOM_VK_RETURN)
+          {
+            mSelectControlSelected = !mSelectControlSelected;
+
+            if (size < 2) 
+            {
+              mSelectPopup = !mSelectPopup;
+              ++mSelectPopupCount;
+            }
+          }
+
+        if (mSelectPopup) return NS_OK;
+
+          if (mSelectControlSelected)
+          {
+            if (mSelectNavCount == len || mSelectNavCount < 0)
+            {
+              mSelectControlSelected = PR_FALSE;
+              mSelectNavCount = 0;
+            } 
+              else if (!mSelectPopup)
+            {
+              if (keyCode == nsIDOMKeyEvent::DOM_VK_DOWN) ++mSelectNavCount;
+          
+              if (keyCode == nsIDOMKeyEvent::DOM_VK_UP) --mSelectNavCount;
+
+              element->SetSelectedIndex(mSelectNavCount);
+
+              return NS_OK;
+            }
+          } 
+            else if (size > 1 && index < 0 && !mSelectControlSelected)
+          {
+            element->SetSelectedIndex(-1);
+          }
+        }
+      }
   }
   else if (mService->mIgnoreTextFields && targetContent->IsNodeOfType(nsINode::eHTML)) 
   {
@@ -279,7 +362,7 @@
 
   if (NS_FAILED(keyEvent->GetKeyCode(&keyCode)))
   return NS_ERROR_FAILURE;
-  
+
   if (keyCode == nsIDOMKeyEvent::DOM_VK_RETURN && !aReal && formControlType != NS_FORM_TEXTAREA) {
     nsCOMPtr<nsIContent> focusedContent;
     getFocusedContent(0, getter_AddRefs(focusedContent));
@@ -469,6 +552,7 @@
     aEvent->PreventDefault();
     return aReal?Down():NS_OK;
   }
+
   return NS_OK;
 }
 
@@ -641,7 +725,7 @@
 
     // make sure the frame is targetable for focus
     if (!isTargetable(focusDocuments, frame)) continue;
-  
+
     // RECT !!
     frameRect = makeRectRelativeToGlobalView(frame);
 
@@ -677,8 +761,10 @@
 
     if (str.Equals(NS_LITERAL_STRING("IFRAME"))) continue;
 
+    PRBool isInView = IsPartiallyVisible(aPresContext->PresShell(), frame, PR_FALSE);
+
     // if target takes precedence then use it - distance is not always the shortest for a precedent target
-    if (takesSuperPrecedence(aDirection, aFocusedRect, frameRect))
+    if (isInView && takesSuperPrecedence(aDirection, aFocusedRect, frameRect))
     {
       // reset distance as we are now in super precedence mode
       if (!superPrecedent) *aDSoFar = LL_MaxInt();
@@ -698,7 +784,7 @@
     if (superPrecedent) continue;
 
     // if target takes precedence then use it - distance is not always the shortest for a precedent target
-    if (takesPrecedence(aDirection, aFocusedRect, frameRect))
+    if (isInView && takesPrecedence(aDirection, aFocusedRect, frameRect))
     {
       precedent = PR_TRUE;
 
@@ -805,8 +891,6 @@
               aContent);
 
 
-  // debug_content(*aContent);
-
   if ( (hhElement || iFrameElement) && mNavigationFramesState)
   {
     mNavigationFramesState = PR_FALSE;
@@ -1137,22 +1221,27 @@
 
   nsPresContext* presContext = getPresContext(c);
   nsCOMPtr<nsIPresShell> presShell = presContext->PresShell();
-  //#ifdef OLDER_LAYOUT  
+  
   if (mService->mOrderLayout) 
   {
     // Google Spreadsheets works ugly with this call
-    presContext->EventStateManager()->SetContentState(c, NS_EVENT_STATE_FOCUS);  
+    // presContext->EventStateManager()->SetContentState(c, NS_EVENT_STATE_FOCUS);  
     presShell->ScrollContentIntoView(c, 
                                      NS_PRESSHELL_SCROLL_IF_NOT_VISIBLE,
                                      NS_PRESSHELL_SCROLL_IF_NOT_VISIBLE);
+
     presContext->EventStateManager()->MoveCaretToFocus();
   }
-  //#else
+
   nsCOMPtr<nsIDOMNSHTMLElement> nsElement = do_QueryInterface(element);
+
+  mLastContent = do_QueryInterface(nsElement);
+
   if (nsElement) 
     nsElement->Focus();
-  //#endif
 
+  return;
+  
   nsIFrame* focusedFrame;
   getFrameForContent(c, &focusedFrame);
   nsRect rect = makeRectRelativeToGlobalView(focusedFrame);
--- extensions/spatialnavigation/src/nsSpatialNavigationPrivate.h	2008-02-22 07:58:14.000000000 -0700
+++ /home/petejc/src/microb_latest/microb-engine/scratch_build/build-tree/mozilla/extensions/spatialnavigation/src/nsSpatialNavigationPrivate.h	2008-03-25 14:49:29.000000000 -0600
@@ -173,6 +173,12 @@
   PRUint32 mKeyPressedCount;
   PRUint16 mKeyPressedState;
   PRBool mKeyWasDown;
+
+  PRBool mSelectControlSelected;
+  PRBool mSelectPopup;
+  PRInt32 mSelectPopupCount;
+  PRInt32 mSelectNavCount;
+  nsCOMPtr<nsIContent> mLastContent;
 };
 
 
--- extensions/spatialnavigation/src/nsSpatialNavigationUtils.cpp	2008-02-22 07:58:14.000000000 -0700
+++ /home/petejc/src/microb_latest/microb-engine/scratch_build/build-tree/mozilla/extensions/spatialnavigation/src/nsSpatialNavigationUtils.cpp	2008-03-25 10:42:33.000000000 -0600
@@ -420,6 +420,16 @@
 
   PRBool disabled = PR_FALSE;
   
+  nsCOMPtr<nsIDOMNode> node;
+  node = do_QueryInterface(currentContent);
+  if (node)
+  {
+    nsAutoString str;
+    node->GetNodeName(str);
+
+    if (str.LowerCaseEqualsLiteral("option")) return PR_FALSE;
+  }
+
   nsCOMPtr<nsIDOMHTMLSelectElement> selectElement = do_QueryInterface(currentContent);
   if (selectElement && NS_SUCCEEDED(selectElement->GetDisabled(&disabled)))
     return !disabled;
@@ -1037,8 +1047,6 @@
   NS_IF_ADDREF(*aWindow = window);
 }
 
-
-
 PRBool IsPartiallyVisible(nsIPresShell* shell, nsIFrame* frame, PRBool aForce)
 {
    // We need to know if at least a kMinPixels around the object is visible
