Index: mozilla/content/html/content/src/nsHTMLInputElement.cpp
===================================================================
--- mozilla.orig/content/html/content/src/nsHTMLInputElement.cpp
+++ mozilla/content/html/content/src/nsHTMLInputElement.cpp
@@ -105,16 +105,17 @@
 #include "nsILocalFile.h"
 #include "nsIFileStreams.h"
 #include "nsNetUtil.h"
 
 // input type=image
 #include "nsImageLoadingContent.h"
 #include "nsIDOMWindowInternal.h"
 
+#include "nsIViewManager.h"
 // XXX align=left, hspace, vspace, border? other nav4 attrs
 
 static NS_DEFINE_CID(kXULControllersCID,  NS_XULCONTROLLERS_CID);
 //
 // Accessors for mBitField
 //
 #define BF_DISABLED_CHANGED 0
 #define BF_HANDLING_CLICK 1
@@ -1133,19 +1134,79 @@
 {
   if (ShouldFocus(this)) {
     SetElementFocus(PR_FALSE);
   }
 
   return NS_OK;
 }
 
+static NS_IMETHODIMP
+SetSpecialFocus(nsIContent *aContent)
+{
+  nsCOMPtr<nsIPrefBranch> prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID);
+  PRBool enabled = PR_FALSE;
+  NS_ENSURE_TRUE(prefBranch, NS_OK);
+
+  nsresult rv = prefBranch->GetBoolPref("browser.display.jsfocus_for_visible_area", &enabled);
+  NS_ENSURE_SUCCESS(rv, NS_OK);
+
+  nsIDocument *doc = aContent->GetDocument();
+  NS_ENSURE_TRUE(doc, NS_OK);
+
+  nsCOMPtr<nsIPresShell> presShell = doc->GetPrimaryShell();
+  NS_ENSURE_TRUE(presShell, NS_OK);
+
+  nsPresContext *presContext = presShell->GetPresContext();
+  NS_ENSURE_TRUE(presContext, NS_OK);
+
+  nsRect varea = presContext->GetVisibleArea();
+  varea.y = presContext->AppUnitsToDevPixels(varea.y);
+  varea.height = presContext->AppUnitsToDevPixels(varea.height);
+
+
+  nsIFrame* frame = nsnull;
+  frame = presShell->GetPrimaryFrameFor(aContent);
+  NS_ENSURE_TRUE(frame, NS_OK);
+
+  nsRect frameRect;
+  frameRect.SetRect(0,0,0,0);
+  nsPoint offset;
+  frameRect = frame->GetRect();
+  PRInt32 frame_height = presContext->AppUnitsToDevPixels(frameRect.height);
+  nsIView* view = nsnull;
+  frame->GetOffsetFromView(offset, &view);
+  NS_ENSURE_TRUE(view, NS_OK);
+  nsIView* rootView = nsnull;
+  nsIViewManager* viewManager = view->GetViewManager();
+  NS_ASSERTION(viewManager, "View must have a viewmanager");
+  viewManager->GetRootView(rootView);
+
+  while (view) {
+    offset  += view->GetPosition();
+    if (view == rootView) {
+      break;
+    }
+    view = view->GetParent();
+  }
+
+  frameRect.MoveTo(offset);
+  frameRect.y = presContext->AppUnitsToDevPixels(frameRect.y);
+  frameRect.height = presContext->AppUnitsToDevPixels(frameRect.height);
+  if (frameRect.y>=0 && (frameRect.y+frameRect.height)<=(varea.y+varea.height))
+    return NS_OK;
+
+  return NS_ERROR_FAILURE;
+}
+
 NS_IMETHODIMP
 nsHTMLInputElement::Focus()
-{
+{
+  nsresult rv = SetSpecialFocus(this);
+  NS_ENSURE_SUCCESS(rv, NS_OK);
   if (ShouldFocus(this)) {
     SetElementFocus(PR_TRUE);
   }
 
   return NS_OK;
 }
 
 void
