## Patches for microb-engine
## Oleg Romashin <oleg.romashin@nokia.com>
##
## DP: Additional strips for toolkit libxul library

Index: mozilla/extensions/spatialnavigation/src/Makefile.in
===================================================================
--- mozilla.orig/extensions/spatialnavigation/src/Makefile.in
+++ mozilla/extensions/spatialnavigation/src/Makefile.in
@@ -43,16 +43,20 @@
 include $(DEPTH)/config/autoconf.mk
 
 MODULE       = snav
 LIBRARY_NAME = snav
 IS_COMPONENT = 1
 
 MOZILLA_INTERNAL_API = 1
 
+#ifdef MOZ_MICROB
+#MINIMO=1
+#FORCE_STATIC_LIB=1
+#endif
 
 ifdef MINIMO
 MODULE_NAME  = snav
 EXPORT_LIBRARY = 1
 else
 ifdef MOZ_XUL_APP
 XPI_NAME               = snav
 endif
Index: mozilla/toolkit/components/Makefile.in
===================================================================
--- mozilla.orig/toolkit/components/Makefile.in
+++ mozilla/toolkit/components/Makefile.in
@@ -89,16 +89,22 @@
 
 ifdef MOZ_THUNDERBIRD
 DIRS += autocomplete/public
 else
 DIRS +=	\
 	cookie \
 	$(NULL)
 
+ifdef MOZ_MICROB
+DIRS += \
+	history/public \
+	$(NULL)
+endif
+
 ifdef MOZ_XUL
 DIRS += \
 	autocomplete \
 	satchel \
 	$(NULL)
 endif # MOZ_XUL
 
 ifdef MOZ_SUITE
Index: mozilla/toolkit/library/libxul-config.mk
===================================================================
--- mozilla.orig/toolkit/library/libxul-config.mk
+++ mozilla/toolkit/library/libxul-config.mk
@@ -103,30 +103,27 @@
 
 # component libraries
 COMPONENT_LIBS += \
 	xpconnect \
 	necko \
 	uconv \
 	i18n \
 	chardet \
-	jar$(VERSION_NUMBER) \
 	pref \
 	caps \
 	htmlpars \
 	imglib2 \
 	gklayout \
 	docshell \
 	embedcomponents \
 	webbrwsr \
 	nsappshell \
 	txmgr \
 	chrome \
-	commandlines \
-	toolkitcomps \
 	pipboot \
 	pipnss \
 	$(NULL)
 
 ifdef MOZ_XMLEXTRAS
 COMPONENT_LIBS += \
 	xmlextras \
 	$(NULL)
@@ -140,16 +137,22 @@
 endif
 
 ifdef MOZ_XPFE_COMPONENTS
 DEFINES += -DMOZ_XPFE_COMPONENTS
 COMPONENT_LIBS += \
 	mozfind \
 	appcomps \
 	$(NULL)
+else
+ifdef MOZ_MICROB
+COMPONENT_LIBS += \
+	appcomps \
+	$(NULL)
+endif
 endif
 
 ifdef MOZ_PERF_METRICS
 EXTRA_DSO_LIBS  += mozutil_s
 endif
 
 ifdef MOZ_XPINSTALL
 DEFINES += -DMOZ_XPINSTALL
@@ -252,16 +255,24 @@
 	$(NULL)
 ifdef MOZ_STORAGE
 COMPONENT_LIBS += \
   satchel \
   $(NULL)
 endif
 endif
 
+ifndef MOZ_MICROB
+COMPONENT_LIBS += \
+ 	jar$(VERSION_NUMBER) \
+ 	commandlines \
+ 	toolkitcomps \
+ 	$(NULL)
+endif
+
 ifdef MOZ_MATHML
 COMPONENT_LIBS += ucvmath
 endif
 
 ifdef MOZ_ENABLE_GTK2
 COMPONENT_LIBS += widget_gtk2
 ifdef MOZ_PREF_EXTENSIONS
 COMPONENT_LIBS += system-pref
Index: mozilla/xpfe/components/Makefile.in
===================================================================
--- mozilla.orig/xpfe/components/Makefile.in
+++ mozilla/xpfe/components/Makefile.in
@@ -62,28 +62,28 @@
 # the jar.mn file that lives parallel to this Makefile. The jar.mn is responsible
 # for the packaging of a large number of chrome files these apps don't need. 
 DEFINES += -DSUPPRESS_CHROME
 endif
 
 DIRS = \
         find \
         filepicker \
+        directory \
         $(NULL)
 
 ifdef MOZ_RDF
 DIRS += \
         intl \
         windowds \
         $(NULL)
 endif
 
 ifdef MOZ_HAVE_BROWSER
 DIRS += \
-        directory \
         resetPref \
         $(NULL)
 
 ifndef MOZ_PHOENIX
 ifndef MOZ_XULRUNNER
 DIRS += \
         related \
         autocomplete \
Index: mozilla/xpfe/components/build/Makefile.in
===================================================================
--- mozilla.orig/xpfe/components/build/Makefile.in
+++ mozilla/xpfe/components/build/Makefile.in
@@ -85,19 +85,21 @@
 endif
 
 # General includes
 SHARED_LIBRARY_LIBS += ../directory/$(LIB_PREFIX)directory_s.$(LIB_SUFFIX)
 LOCAL_INCLUDES += -I$(srcdir)/../directory
 
 # Non-Mac Browser requirements
 ifneq ($(MOZ_BUILD_APP),macbrowser)
+ifndef MOZ_MICROB
 SHARED_LIBRARY_LIBS += ../../browser/src/$(LIB_PREFIX)mozbrwsr_s.$(LIB_SUFFIX)
 LOCAL_INCLUDES += -I$(srcdir)/../../browser/src
 endif
+endif
 
 # Suite specific includes
 ifdef MOZ_SUITE
 REQUIRES += downloadmanager
 
 SHARED_LIBRARY_LIBS += \
 	../download-manager/src/$(LIB_PREFIX)downloadmanager_s.$(LIB_SUFFIX) \
 	../related/src/$(LIB_PREFIX)related_s.$(LIB_SUFFIX) \
Index: mozilla/xpfe/components/build/nsModule.cpp
===================================================================
--- mozilla.orig/xpfe/components/build/nsModule.cpp
+++ mozilla/xpfe/components/build/nsModule.cpp
@@ -56,17 +56,17 @@
 #endif
 
 #if defined(XP_WIN)
 #include "nsWindowsHooks.h"
 #endif // Windows
 
 #endif // MOZ_SUITE
 
-#if !defined(MOZ_MACBROWSER)
+#if !defined(MOZ_MACBROWSER) && !defined(MOZ_MICROB)
 #include "nsBrowserStatusFilter.h"
 #include "nsBrowserInstance.h"
 #endif
 #include "nsCURILoader.h"
 #include "nsXPFEComponentsCID.h"
 
 #if !defined(MOZ_PLACES)
 // {9491C382-E3C4-11D2-BDBE-0050040A9B44}
@@ -78,17 +78,17 @@
 #endif
 
 #ifdef MOZ_RDF
 // Factory constructors
 NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsHTTPIndex, Init)
 #endif
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsDirectoryViewerFactory)
 
-#if !defined(MOZ_MACBROWSER)
+#if !defined(MOZ_MACBROWSER) && !defined(MOZ_MICROB)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsBrowserStatusFilter)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsBrowserInstance)
 #endif
 
 #ifdef MOZ_SUITE
 NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(RelatedLinksHandlerImpl, Init)
 NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsDownloadManager, Init)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsDownloadProxy)
@@ -98,17 +98,17 @@
 #endif
 
 #if defined(XP_WIN)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsWindowsHooks)
 #endif // Windows
 
 #endif // MOZ_SUITE
 
-#if (!defined(MOZ_XUL_APP)) && !defined(MOZ_MACBROWSER)
+#if (!defined(MOZ_XUL_APP)) && !defined(MOZ_MACBROWSER) && !defined(MOZ_MICROB)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsBrowserContentHandler)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsChromeStartupHandler)
 #endif
 
 
 static NS_METHOD
 RegisterProc(nsIComponentManager *aCompMgr,
              nsIFile *aPath,
@@ -172,30 +172,30 @@
 
 #ifdef XP_WIN
     { NS_IWINDOWSHOOKS_CLASSNAME, NS_IWINDOWSHOOKS_CID,
       NS_IWINDOWSHOOKS_CONTRACTID, nsWindowsHooksConstructor },
 #endif // XP_WIN
 
 #endif // MOZ_SUITE
 
-#if !defined(MOZ_MACBROWSER)
+#if !defined(MOZ_MACBROWSER) && !defined(MOZ_MICROB)
     { NS_BROWSERSTATUSFILTER_CLASSNAME,
       NS_BROWSERSTATUSFILTER_CID,
       NS_BROWSERSTATUSFILTER_CONTRACTID,
       nsBrowserStatusFilterConstructor
     },
     { "nsBrowserInstance",
       NS_BROWSERINSTANCE_CID,
       NS_BROWSERINSTANCE_CONTRACTID,
       nsBrowserInstanceConstructor
     },
 #endif
 
-#if (!defined(MOZ_XUL_APP)) && !defined(MOZ_MACBROWSER)
+#if (!defined(MOZ_XUL_APP)) && !defined(MOZ_MACBROWSER) && !defined(MOZ_MICROB)
   { "Browser Content Handler",
     NS_BROWSERCONTENTHANDLER_CID,
     NS_CONTENT_HANDLER_CONTRACTID_PREFIX"text/html",
     nsBrowserContentHandlerConstructor
   },
   { "Browser Content Handler",
     NS_BROWSERCONTENTHANDLER_CID,
     NS_CONTENT_HANDLER_CONTRACTID_PREFIX"application/vnd.mozilla.xul+xml",
Index: mozilla/toolkit/library/nsStaticXULComponents.cpp
===================================================================
--- mozilla.orig/toolkit/library/nsStaticXULComponents.cpp
+++ mozilla/toolkit/library/nsStaticXULComponents.cpp
@@ -194,19 +194,24 @@
     MODULE(nsWindowDataSourceModule)
 #else
 #define RDFAPP_MODULES
 #endif
 #define APPLICATION_MODULES \
     MODULE(application) \
     MODULE(nsFindComponent)
 #else
+#ifdef MOZ_MICROB
+#define APPLICATION_MODULES \
+    MODULE(application)
+#else
 #define APPLICATION_MODULES
 #define RDFAPP_MODULES
 #endif
+#endif
 
 #ifdef MOZ_XPINSTALL
 #define XPINSTALL_MODULES \
     MODULE(nsSoftwareUpdate)
 #else
 #define XPINSTALL_MODULES
 #endif
 
@@ -256,16 +261,25 @@
 #define XULENABLED_MODULES                   \
     MODULE(tkAutoCompleteModule)             \
     MODULE(PKI)
 #endif
 #else
 #define XULENABLED_MODULES
 #endif
 
+#ifndef MOZ_MICROB
+#define STD_MODULES                          \
+    MODULE(CommandLineModule)                \
+    MODULE(nsToolkitCompsModule)             \
+    MODULE(nsJarModule)
+#else
+#define STD_MODULES
+#endif
+
 #ifdef MOZ_SPELLCHECK
 #define SPELLCHECK_MODULE MODULE(mozSpellCheckerModule)
 #else
 #define SPELLCHECK_MODULE
 #endif
 
 #ifdef MOZ_XMLEXTRAS
 #define XMLEXTRAS_MODULE MODULE(nsXMLExtrasModule)
@@ -279,17 +293,16 @@
     MODULE(nsUConvModule)                    \
     MODULE(nsI18nModule)                     \
     MODULE(nsChardetModule)                  \
     UNIVERSALCHARDET_MODULE                  \
     MODULE(necko)                            \
     PERMISSIONS_MODULES                      \
     AUTH_MODULE                              \
     IPC_MODULE                               \
-    MODULE(nsJarModule)                      \
     MODULE(nsPrefModule)                     \
     MODULE(nsSecurityManagerModule)          \
     RDF_MODULE                               \
     RDFAPP_MODULES                           \
     MODULE(nsParserModule)                   \
     GFX_MODULES                              \
     WIDGET_MODULES                           \
     MODULE(nsImageLib2Module)                \
@@ -303,22 +316,21 @@
     OJI_MODULES                              \
     ACCESS_MODULES                           \
     MODULE(appshell)                         \
     MODULE(nsTransactionManagerModule)       \
     COMPOSER_MODULE                          \
     MODULE(nsChromeModule)                   \
     APPLICATION_MODULES                      \
     MODULE(Apprunner)                        \
-    MODULE(CommandLineModule)                \
     FILEVIEW_MODULE                          \
     STORAGE_MODULE                           \
     PLACES_MODULES                           \
     XULENABLED_MODULES                       \
-    MODULE(nsToolkitCompsModule)             \
+    STD_MODULES                              \
     XREMOTE_MODULES                          \
     XPINSTALL_MODULES                        \
     JSDEBUGGER_MODULES                       \
     MODULE(BOOT)                             \
     MODULE(NSS)                              \
     SYSTEMPREF_MODULES                       \
     SPELLCHECK_MODULE                        \
     XMLEXTRAS_MODULE                         \
