diff -ruN -U 8 -p mozilla.orig/extensions/permissions/nsContentBlocker.cpp mozilla/extensions/permissions/nsContentBlocker.cpp
--- mozilla.orig/extensions/permissions/nsContentBlocker.cpp	2007-06-16 11:20:56.000000000 -0400
+++ mozilla/extensions/permissions/nsContentBlocker.cpp	2007-06-16 11:19:17.000000000 -0400
@@ -40,22 +40,26 @@
 #include "nsIServiceManager.h"
 #include "nsIDocShellTreeItem.h"
 #include "nsIPrefService.h"
 #include "nsIPrefBranch.h"
 #include "nsIDocShell.h"
 #include "nsString.h"
 #include "nsContentPolicyUtils.h"
 #include "nsIObjectLoadingContent.h"
+#include "nsNetCID.h"
+#include "nsICacheService.h"
+#include "imgICache.h"
 
 // Possible behavior pref values
 // Those map to the nsIPermissionManager values where possible
 #define BEHAVIOR_ACCEPT nsIPermissionManager::ALLOW_ACTION
 #define BEHAVIOR_REJECT nsIPermissionManager::DENY_ACTION
 #define BEHAVIOR_NOFOREIGN 3
+#define BEHAVIOR_ONLYCACHE 4
 
 // From nsIContentPolicy
 static const char *kTypeString[NUMBER_OF_TYPES] = {"other", 
                                                    "script",
                                                    "image",
                                                    "stylesheet",
                                                    "object",
                                                    "document",
@@ -131,17 +135,17 @@ nsContentBlocker::PrefChanged(nsIPrefBra
 {
   PRInt32 val;
 
 #define PREF_CHANGED(_P) (!aPref || !strcmp(aPref, _P))
 
   for(PRUint32 i = 0; i < NUMBER_OF_TYPES; ++i) {
     if (PREF_CHANGED(kTypeString[i]) &&
         NS_SUCCEEDED(aPrefBranch->GetIntPref(kTypeString[i], &val)))
-      mBehaviorPref[i] = LIMIT(val, 1, 3, 1);
+      mBehaviorPref[i] = LIMIT(val, 1, 4, 1);
   }
 
 }
 
 // nsIContentPolicy Implementation
 NS_IMETHODIMP 
 nsContentBlocker::ShouldLoad(PRUint32          aContentType,
                              nsIURI           *aContentLocation,
@@ -280,17 +284,17 @@ nsContentBlocker::TestPermission(nsIURI 
   switch (permission) {
   case BEHAVIOR_ACCEPT:
     *aPermission = PR_TRUE;
     break;
   case BEHAVIOR_REJECT:
     *aPermission = PR_FALSE;
     break;
 
-  case BEHAVIOR_NOFOREIGN:
+  case BEHAVIOR_NOFOREIGN: {
     // Third party checking
 
     // Need a requesting uri for third party checks to work.
     if (!aFirstURI)
       return NS_OK;
 
     PRBool trustedSource = PR_FALSE;
     rv = aFirstURI->SchemeIs("chrome", &trustedSource);
@@ -342,17 +346,29 @@ nsContentBlocker::TestPermission(nsIURI 
     // |firstUri| there is a dot. That means both url are in the same domain
     if ((firstHost.Length() > tail.Length() && 
          firstHost.CharAt(firstHost.Length() - tail.Length() - 1) != '.') || 
         !tail.Equals(firstTail)) {
       *aPermission = PR_FALSE;
     }
     break;
   }
-  
+  case BEHAVIOR_ONLYCACHE:
+    nsresult rv;
+    nsCOMPtr<imgICache> cacheService = do_GetService("@mozilla.org/image/cache;1", &rv);
+    NS_ENSURE_SUCCESS(rv, rv);
+    nsCOMPtr<nsIProperties> entryProp;
+    rv = cacheService->FindEntryProperties(aCurrentURI, getter_AddRefs(entryProp)); 
+    if (entryProp)
+        *aPermission = PR_TRUE;
+    else
+        *aPermission = PR_FALSE;
+    break;
+  }
+      
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsContentBlocker::Observe(nsISupports     *aSubject,
                           const char      *aTopic,
                           const PRUnichar *aData)
 {
--- mozilla/extensions/permissions/Makefile.in.orig	2006-05-25 18:45:17.000000000 +0300
+++ mozilla/extensions/permissions/Makefile.in	2007-06-17 19:51:52.000000000 +0300
@@ -53,20 +53,22 @@ LIBXUL_LIBRARY = 1
 
 REQUIRES	= xpcom \
 		  string \
 		  necko \
 		  dom \
 		  widget \
 		  content \
 		  layout \
 		  pref \
 		  docshell \
+		  imglib2 \
+		  nkcache \
 		  $(NULL)
 
 CPPSRCS		= \
 		  nsModuleFactory.cpp \
 		  nsContentBlocker.cpp \
 		  $(NULL)
 
 EXTRA_DSO_LDOPTS = \
 		$(MOZ_COMPONENT_LIBS) \
 		$(NULL)
--- mozilla/extensions/permissions/nsContentBlocker.cpp.orig	2007-07-03 11:15:23.000000000 +0300
+++ mozilla/extensions/permissions/nsContentBlocker.cpp	2007-07-03 12:31:34.000000000 +0300
@@ -348,25 +348,27 @@ nsContentBlocker::TestPermission(nsIURI 
          firstHost.CharAt(firstHost.Length() - tail.Length() - 1) != '.') || 
         !tail.Equals(firstTail)) {
       *aPermission = PR_FALSE;
     }
     break;
   }
   case BEHAVIOR_ONLYCACHE:
     nsresult rv;
     nsCOMPtr<imgICache> cacheService = do_GetService("@mozilla.org/image/cache;1", &rv);
     NS_ENSURE_SUCCESS(rv, rv);
+#ifndef DEBUG
     nsCOMPtr<nsIProperties> entryProp;
     rv = cacheService->FindEntryProperties(aCurrentURI, getter_AddRefs(entryProp)); 
     if (entryProp)
         *aPermission = PR_TRUE;
     else
+#endif
         *aPermission = PR_FALSE;
     break;
   }
       
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsContentBlocker::Observe(nsISupports     *aSubject,
                           const char      *aTopic,
